<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[阿里开源AgentScope多智能体框架解析系列（一）第1章：AgentScope-Java 概述与快速入门]]></title>    <link>https://juejin.cn/post/7589275237037064227</link>    <guid>https://juejin.cn/post/7589275237037064227</guid>    <pubDate>2025-12-30T03:49:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589275237037064227" data-draft-id="7589206614930063400" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="阿里开源AgentScope多智能体框架解析系列（一）第1章：AgentScope-Java 概述与快速入门"/> <meta itemprop="keywords" content="Agent"/> <meta itemprop="datePublished" content="2025-12-30T03:49:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="语落心生"/> <meta itemprop="url" content="https://juejin.cn/user/2875978147955741"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            阿里开源AgentScope多智能体框架解析系列（一）第1章：AgentScope-Java 概述与快速入门
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2875978147955741/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    语落心生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T03:49:57.000Z" title="Tue Dec 30 2025 03:49:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    12
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读22分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">总述</h2>
<p>AgentScope-Java 是一个<strong>生产级的AI智能体编程框架</strong>，用Java构建LLM驱动的智能应用。它不仅提供了基础的Agent-模型-工具三角交互，更重要的是提供了企业级生产必需的<strong>运行时控制、内置工具、协议集成和可观测性</strong>。</p>
<p>本章我们将从**What（是什么）、Why（为什么）、How（怎样用）**三个维度理解AgentScope-Java，并通过具体的生产场景示例展示框架如何解决真实问题。</p>
<h2 data-id="heading-1">主架构设计图</h2>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    User[用户/应用] --&gt; Agent[Agent接口层]
    
    Agent --&gt; ReActAgent[ReActAgent&lt;br/&gt;推理-行动循环]
    Agent --&gt; UserAgent[UserAgent&lt;br/&gt;用户交互]
    Agent --&gt; OtherAgents[其他Agent实现]
    
    ReActAgent --&gt; Model[Model层&lt;br/&gt;LLM调用]
    ReActAgent --&gt; Memory[Memory层&lt;br/&gt;记忆管理]
    ReActAgent --&gt; Toolkit[Toolkit层&lt;br/&gt;工具管理]
    ReActAgent --&gt; Hook[Hook系统&lt;br/&gt;事件拦截]
    
    Model --&gt; DashScope[DashScope]
    Model --&gt; OpenAI[OpenAI]
    Model --&gt; Anthropic[Anthropic]
    Model --&gt; Gemini[Gemini]
    
    Model --&gt; Formatter[Formatter&lt;br/&gt;消息格式化]
    
    Memory --&gt; InMemory[InMemoryMemory]
    Memory --&gt; LongTerm[LongTermMemory]
    Memory --&gt; Session[Session持久化]
    
    Toolkit --&gt; ToolRegistry[ToolRegistry&lt;br/&gt;工具注册表]
    Toolkit --&gt; ToolExecutor[ToolExecutor&lt;br/&gt;工具执行器]
    Toolkit --&gt; MCP[MCP集成]
    
    Hook --&gt; RAGHook[RAG Hook]
    Hook --&gt; PlanHook[Plan Hook]
    Hook --&gt; MemoryHook[Memory Hook]
    Hook --&gt; CustomHook[自定义Hook]
    
    ReActAgent --&gt; Pipeline[Pipeline&lt;br/&gt;多智能体协作]
    ReActAgent --&gt; Interruption[Interruption&lt;br/&gt;中断机制]
    ReActAgent --&gt; Tracing[Tracing&lt;br/&gt;可观测性]
    
    style Agent fill:#e1f5ff
    style ReActAgent fill:#fff4e1
    style Model fill:#e8f5e9
    style Memory fill:#f3e5f5
    style Toolkit fill:#fff9c4
    style Hook fill:#ffe0b2
</code></pre>
<h2 data-id="heading-2">核心功能时序图</h2>
<h3 data-id="heading-3">1. ReActAgent 执行流程</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant User as 用户
    participant Agent as ReActAgent
    participant Hook as Hook系统
    participant Model as LLM模型
    participant Toolkit as 工具箱
    participant Memory as 记忆系统

    User-&gt;&gt;Agent: call(msg)
    Agent-&gt;&gt;Memory: 添加用户消息
    
    loop 推理-行动循环
        Agent-&gt;&gt;Hook: PreReasoningEvent
        Hook--&gt;&gt;Agent: 处理钩子
        
        Agent-&gt;&gt;Memory: 获取历史消息
        Memory--&gt;&gt;Agent: 返回消息列表
        
        Agent-&gt;&gt;Model: 请求推理
        Model--&gt;&gt;Agent: 返回思考+工具调用
        
        Agent-&gt;&gt;Hook: PostReasoningEvent
        Hook--&gt;&gt;Agent: 处理钩子
        
        alt 需要调用工具
            Agent-&gt;&gt;Hook: PreActingEvent
            Hook--&gt;&gt;Agent: 处理钩子
            
            Agent-&gt;&gt;Toolkit: 执行工具
            Toolkit--&gt;&gt;Agent: 工具结果
            
            Agent-&gt;&gt;Hook: PostActingEvent
            Hook--&gt;&gt;Agent: 处理钩子
            
            Agent-&gt;&gt;Memory: 保存工具结果
        else 无需工具调用
            Agent-&gt;&gt;Memory: 保存最终回答
            Agent--&gt;&gt;User: 返回结果
        end
    end
</code></pre>
<h3 data-id="heading-4">2. 工具调用流程</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Agent as ReActAgent
    participant Toolkit as Toolkit
    participant Registry as ToolRegistry
    participant Executor as ToolExecutor
    participant Tool as 实际工具方法
    participant Context as ExecutionContext

    Agent-&gt;&gt;Toolkit: 调用工具
    Toolkit-&gt;&gt;Registry: 查找工具定义
    Registry--&gt;&gt;Toolkit: 返回工具元数据
    
    Toolkit-&gt;&gt;Executor: 准备执行
    Executor-&gt;&gt;Context: 设置执行上下文
    
    Executor-&gt;&gt;Tool: 反射调用方法
    Tool--&gt;&gt;Executor: 返回结果
    
    Executor-&gt;&gt;Context: 清理上下文
    Executor--&gt;&gt;Toolkit: 返回执行结果
    Toolkit--&gt;&gt;Agent: 返回格式化结果
</code></pre>
<h3 data-id="heading-5">3. Hook 系统执行流程</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Agent as ReActAgent
    participant HookChain as Hook链
    participant RAGHook as RAG Hook
    participant MemoryHook as Memory Hook
    participant PlanHook as Plan Hook
    participant Model as LLM模型

    Agent-&gt;&gt;HookChain: 触发PreReasoningEvent
    
    HookChain-&gt;&gt;RAGHook: handle(event)
    RAGHook-&gt;&gt;RAGHook: 检索相关知识
    RAGHook-&gt;&gt;HookChain: 添加知识到提示词
    
    HookChain-&gt;&gt;MemoryHook: handle(event)
    MemoryHook-&gt;&gt;MemoryHook: 检索长期记忆
    MemoryHook-&gt;&gt;HookChain: 添加记忆到提示词
    
    HookChain-&gt;&gt;PlanHook: handle(event)
    PlanHook-&gt;&gt;PlanHook: 获取当前计划
    PlanHook-&gt;&gt;HookChain: 添加计划提示
    
    HookChain--&gt;&gt;Agent: 返回增强后的消息
    Agent-&gt;&gt;Model: 发送请求
</code></pre>
<h3 data-id="heading-6">4. 流式响应处理流程</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant User as 用户
    participant Agent as ReActAgent
    participant Model as LLM模型
    participant Accumulator as ContentAccumulator
    participant Stream as 事件流

    User-&gt;&gt;Agent: stream(msg, options)
    Agent-&gt;&gt;Model: 请求流式响应
    
    loop 流式接收
        Model--&gt;&gt;Agent: ChatResponse chunk
        Agent-&gt;&gt;Accumulator: 累积内容
        
        alt 推理阶段
            Accumulator-&gt;&gt;Stream: ReasoningChunkEvent
            Stream--&gt;&gt;User: 实时推理内容
        else 行动阶段
            Accumulator-&gt;&gt;Stream: ActingChunkEvent
            Stream--&gt;&gt;User: 实时执行内容
        end
    end
    
    Model--&gt;&gt;Agent: 最终响应
    Agent-&gt;&gt;Stream: 完整事件(isLast=true)
    Stream--&gt;&gt;User: 最终结果
</code></pre>
<h3 data-id="heading-7">5. 中断与恢复流程</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant User as 用户
    participant Agent as ReActAgent
    participant Context as InterruptContext
    participant Tool as 工具执行
    participant Memory as 记忆系统

    User-&gt;&gt;Agent: call(msg)
    Agent-&gt;&gt;Tool: 执行长时工具
    
    User-&gt;&gt;Agent: interrupt()
    Agent-&gt;&gt;Context: 设置中断标志
    
    Tool-&gt;&gt;Context: 检查中断状态
    Context--&gt;&gt;Tool: 已中断
    Tool--&gt;&gt;Agent: 取消执行
    
    Agent-&gt;&gt;Memory: 保存中断状态
    Agent--&gt;&gt;User: 返回中断信息
    
    User-&gt;&gt;Agent: call() 继续执行
    Agent-&gt;&gt;Memory: 恢复上下文
    Agent-&gt;&gt;Tool: 重新执行或跳过
    Tool--&gt;&gt;Agent: 完成
    Agent--&gt;&gt;User: 返回结果
</code></pre>
<hr/>
<h2 data-id="heading-8">1.1 项目背景与设计理念</h2>
<h3 data-id="heading-9">1.1.1 为什么需要AgentScope-Java？</h3>
<p>在使用LLM构建智能应用的过程中，开发者通常面临以下<strong>核心痛点</strong>：</p>
<h4 data-id="heading-10">问题1：LLM的自主性与可控性矛盾</h4>
<p><strong>场景</strong>：你为一个电商平台构建了一个自主AI助手，它可以自主查询商品、推荐产品、处理订单。但当助手错误地向用户承诺了不合理的优惠或承诺了不能实现的服务时，你无法立即干预。</p>
<p><strong>AgentScope解决方案</strong>：</p>
<ul>
<li><strong>安全中断</strong>：在任意时刻暂停Agent，完整保留上下文和工具状态，支持无损恢复</li>
<li><strong>优雅取消</strong>：终止长时间运行的工具调用，不破坏Agent状态</li>
<li><strong>人机协同</strong>：通过Hook系统在任何推理步骤注入修正、额外上下文或指导</li>
</ul>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[&amp;#34;自主决策循环&amp;#34;] --&gt;|发现问题| B[&amp;#34;暂停&amp;#34;]
    B --&gt;|人工审核| C[&amp;#34;修正/取消&amp;#34;]
    C --&gt;|恢复上下文| D[&amp;#34;继续执行&amp;#34;]
</code></pre>
<h4 data-id="heading-11">问题2：多步骤复杂任务的结构化管理</h4>
<p><strong>场景</strong>：用户请求Agent完成一个涉及10个步骤的复杂工作流（如数据分析 → 生成报告 → 发送邮件）。当中间某一步失败时，你很难追踪当前进度、修改计划或恢复执行。</p>
<p><strong>AgentScope解决方案</strong>：</p>
<ul>
<li><strong>PlanNotebook</strong>：结构化任务管理，自动跟踪多步骤工作流</li>
<li>支持动态修改、暂停、恢复、并发执行多个计划</li>
<li>与Agent推理集成，智能体可以主动创建和修改自己的计划</li>
</ul>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    Plan[&amp;#34;计划（Plan）&amp;#34;]
    Plan --&gt; SubTask1[&amp;#34;子任务1：准备数据&amp;#34;]
    Plan --&gt; SubTask2[&amp;#34;子任务2：生成图表&amp;#34;]
    Plan --&gt; SubTask3[&amp;#34;子任务3：撰写总结&amp;#34;]
    
    SubTask1 --&gt; Status1[&amp;#34;状态：待执行/进行中/完成/放弃&amp;#34;]
    SubTask2 --&gt; Status2[&amp;#34;状态：待执行/进行中/完成/放弃&amp;#34;]
    SubTask3 --&gt; Status3[&amp;#34;状态：待执行/进行中/完成/放弃&amp;#34;]
</code></pre>
<h4 data-id="heading-12">问题3：LLM输出的不可靠性</h4>
<p><strong>场景</strong>：你要求Agent调用一个API并返回JSON格式的数据，但LLM可能会：</p>
<ul>
<li>返回格式错误的JSON</li>
<li>遗漏某些必需字段</li>
<li>在字段中包含不符合类型的值</li>
</ul>
<p>你需要一个<strong>自纠错</strong>的解决方案，而不是编写复杂的验证和重试逻辑。</p>
<p><strong>AgentScope解决方案</strong>：</p>
<ul>
<li><strong>结构化输出</strong>：自动验证LLM输出，如果不符合预期格式，自动重试并指导LLM生成正确输出</li>
<li>直接映射到Java POJO，实现<strong>类型安全</strong></li>
<li>减少人工解析和验证的代码量</li>
</ul>
<h4 data-id="heading-13">问题4：知识库与LLM的集成</h4>
<p><strong>场景</strong>：你的AI助手需要基于企业内部的知识库（如FAQ、文档、培训资料）回答问题，但简单地将所有文档放入Prompt会导致Token溢出和回答不精准。</p>
<p><strong>AgentScope解决方案</strong>：</p>
<ul>
<li><strong>RAG（检索增强生成）</strong>：智能检索相关文档，作为回答依据</li>
<li>支持多知识库集成（自建、阿里云百炼、Dify等）</li>
<li>通过Hook或Tool形式集成，透明地增强Agent能力</li>
</ul>
<h4 data-id="heading-14">问题5：工具生态碎片化</h4>
<p><strong>场景</strong>：你的Agent需要集成多个外部服务（OpenAI API、企业内部服务、MCP生态的工具）。每次新增工具时，都需要重新编写集成代码。</p>
<p><strong>AgentScope解决方案</strong>：</p>
<ul>
<li><strong>MCP协议集成</strong>：连接到MCP生态的任何工具和服务</li>
<li><strong>A2A协议</strong>：分布式多Agent协作，通过服务注册中心自动发现和调用</li>
<li><strong>统一的工具系统</strong>：无论是本地@Tool还是MCP工具，都通过统一接口调用</li>
</ul>
<h3 data-id="heading-15">1.1.2 核心设计理念</h3>
<h4 data-id="heading-16">理念1：响应式非阻塞架构</h4>
<p>AgentScope-Java基于<strong>Project Reactor</strong>构建，所有操作都是非阻塞的：</p>
<pre><code class="hljs">业务意义：
├─ 高吞吐量：一个线程可以处理数千个并发Agent
├─ 低延迟：充分利用CPU，避免线程阻塞浪费
├─ 良好扩展性：支持Serverless、容器编排等云原生部署
└─ 可观测性更好：异步操作更容易追踪和监控
</code></pre>
<p>代码体现：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 所有操作返回 Mono&lt;T&gt; 或 Flux&lt;T&gt;</span>
Mono&lt;Msg&gt; response = agent.call(userMessage);
response.subscribe(msg -&gt; System.out.println(msg.getTextContent()));

<span class="hljs-comment">// 支持链式异步操作</span>
agent.call(msg1)
    .flatMap(response -&gt; agent.call(response))
    .subscribe();
</code></pre>
<h4 data-id="heading-17">理念2：消息驱动通信</h4>
<p>Agent之间通过**不可变的Message对象（Msg）**通信，而不是直接调用：</p>
<pre><code class="hljs">优势：
├─ 解耦：Agent不需要知道其他Agent的内部实现
├─ 可追踪：所有通信都记录为消息，便于调试和审计
├─ 支持存储：消息可以被持久化、重放、分析
└─ 支持扩展：消息可以包含多种内容类型（文本、图片、音频、工具调用等）
</code></pre>
<h4 data-id="heading-18">理念3：可组合与可扩展</h4>
<ul>
<li><strong>Agent可组合</strong>：可以在Pipeline中组织多个Agent，实现复杂的协作模式</li>
<li><strong>工具可扩展</strong>：通过@Tool注解轻松添加新工具，或集成MCP/A2A工具</li>
<li><strong>Hook可插拔</strong>：在Agent执行的任何阶段插入自定义逻辑，而不修改核心代码</li>
</ul>
<hr/>
<h2 data-id="heading-19">1.2 核心特性介绍</h2>
<h3 data-id="heading-20">1.2.1 ReAct 推理-行动循环</h3>
<p><strong>ReAct（Reasoning + Acting）</strong> 是AgentScope的核心，它让Agent能够<strong>自主规划和执行</strong>任务。</p>
<h4 data-id="heading-21">什么是ReAct？</h4>
<pre><code class="hljs language-ini" lang="ini">第1轮：
用户: "帮我分析过去12个月的销售数据"
↓
<span class="hljs-section">[推理阶段]</span> Agent思考: "我需要查询销售数据库，然后分析数据，最后生成报告"
↓
<span class="hljs-section">[行动阶段]</span> Agent执行: 调用 query_sales_data 工具，获得数据
↓
<span class="hljs-section">[结果]</span> 获得JSON格式的销售数据

第2轮：
<span class="hljs-section">[推理阶段]</span> Agent思考: "现在我有数据了，我需要计算增长率、趋势等"
↓
<span class="hljs-section">[行动阶段]</span> Agent执行: 调用 analyze_data 工具
↓
<span class="hljs-section">[结果]</span> 获得分析结果

第3轮：
<span class="hljs-section">[推理阶段]</span> Agent思考: "分析完成了，现在生成报告"
↓
<span class="hljs-section">[行动阶段]</span> Agent执行: 调用 generate_report 工具
↓
<span class="hljs-section">[结果]</span> 最终报告生成完成
</code></pre>
<h4 data-id="heading-22">为什么ReAct比Prompt Chaining更优？</h4>






























<table><thead><tr><th>方面</th><th>Prompt Chaining</th><th>ReAct</th></tr></thead><tbody><tr><td>灵活性</td><td>固定的步骤</td><td>动态决定下一步</td></tr><tr><td>适应性</td><td>无法处理出错情况</td><td>可以重试或改变策略</td></tr><tr><td>工具利用</td><td>预定义的工具序列</td><td>动态选择最合适的工具</td></tr><tr><td>可控性</td><td>很难干预</td><td>支持在任意步骤暂停和修正</td></tr></tbody></table>
<h4 data-id="heading-23">生产场景示例：客服工单处理</h4>
<pre><code class="hljs language-bash" lang="bash">用户问题: <span class="hljs-string">"我的订单 #12345 已经5天还没收到，我需要退款"</span>
↓
Agent推理：
<span class="hljs-string">"我需要：
1. 查询订单状态（调用order_status工具）
2. 根据状态决定是否需要查询物流信息或直接处理退款
3. 生成解决方案"</span>
↓
[工具调用] 查询订单 <span class="hljs-comment">#12345</span>
结果：订单状态为<span class="hljs-string">"已发货，预计3-5天送达"</span>，今天是第5天，已超期
↓
Agent推理：
<span class="hljs-string">"订单已超期，我需要：
1. 查询物流信息，确认是否丢失
2. 根据结果决定是补邮还是退款"</span>
↓
[工具调用] 查询物流信息
结果：物流显示包裹在运输中，但延迟了
↓
Agent推理：
<span class="hljs-string">"物流延迟，我应该为客户自动赔偿100积分，并承诺加急配送。
如果客户坚持退款，触发人工审批"</span>
↓
[工具调用] 给客户加100积分 + 加急配送处理
↓
返回给用户：自动方案 + 人工审批链接
</code></pre>
<h3 data-id="heading-24">1.2.2 工具调用系统</h3>
<p>工具是Agent执行实际操作的手段。AgentScope提供了<strong>简洁而强大</strong>的工具系统。</p>
<h4 data-id="heading-25">快速定义工具</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 第1步：创建一个类，添加@Tool注解的方法</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WeatherTools</span> {
    
    <span class="hljs-meta">@Tool(name = "get_weather", 
          description = "Get current weather for a city")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getWeather</span><span class="hljs-params">(
        <span class="hljs-meta">@ToolParam(name = "city", description = "City name")</span> String city,
        <span class="hljs-meta">@ToolParam(name = "unit", description = "Temperature unit, celsius or fahrenheit")</span> 
            String unit)</span> {
        <span class="hljs-comment">// 实际的获取天气的逻辑</span>
        <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"Weather in %s: 25°%s, Sunny"</span>, city, unit);
    }
    
    <span class="hljs-meta">@Tool(name = "get_forecast", 
          description = "Get 7-day forecast for a city")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getForecast</span><span class="hljs-params">(
        <span class="hljs-meta">@ToolParam(name = "city", description = "City name")</span> String city)</span> {
        <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"7-day forecast for %s: ..."</span>, city);
    }
}

<span class="hljs-comment">// 第2步：注册到工具箱</span>
<span class="hljs-type">Toolkit</span> <span class="hljs-variable">toolkit</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Toolkit</span>();
toolkit.registerObject(<span class="hljs-keyword">new</span> <span class="hljs-title class_">WeatherTools</span>());

<span class="hljs-comment">// 第3步：传给Agent，就可以自动使用</span>
<span class="hljs-type">ReActAgent</span> <span class="hljs-variable">agent</span> <span class="hljs-operator">=</span> ReActAgent.builder()
    .toolkit(toolkit)
    .build();
</code></pre>
<h4 data-id="heading-26">工具系统如何工作？</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[&amp;#34;Agent&amp;#34;]
    B[&amp;#34;推理：我需要查询天气&amp;#34;]
    C[&amp;#34;Model返回：调用 get_weather 工具，参数：city=beijing, unit=celsius&amp;#34;]
    D[&amp;#34;工具系统&amp;#34;]
    E[&amp;#34;ToolRegistry：查找 get_weather 的定义&amp;#34;]
    F[&amp;#34;ToolExecutor：反射调用 WeatherTools.getWeather方法&amp;#34;]
    G[&amp;#34;WeatherTools.getWeather 执行&amp;#34;]
    H[&amp;#34;返回结果给Agent&amp;#34;]
    
    A --&gt; B
    B --&gt; C
    C --&gt; D
    D --&gt; E
    E --&gt; F
    F --&gt; G
    G --&gt; H
</code></pre>
<h4 data-id="heading-27">生产场景：销售订单系统</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderTools</span> {
    
    <span class="hljs-meta">@Tool(name = "create_order", description = "Create a new sales order")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">createOrder</span><span class="hljs-params">(
        <span class="hljs-meta">@ToolParam(name = "customer_id")</span> String customerId,
        <span class="hljs-meta">@ToolParam(name = "items")</span> String itemsJson,  // JSON格式: [{sku, qty, price}]
        <span class="hljs-meta">@ToolParam(name = "discount_percent", description = "Discount 0-100")</span> <span class="hljs-type">int</span> discount)</span> {
        
        <span class="hljs-comment">// 生产环节：</span>
        <span class="hljs-comment">// 1. 验证输入</span>
        <span class="hljs-keyword">if</span> (discount &lt; <span class="hljs-number">0</span> || discount &gt; <span class="hljs-number">100</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"Discount must be 0-100"</span>);
        }
        
        <span class="hljs-comment">// 2. 调用订单系统API</span>
        <span class="hljs-type">OrderRequest</span> <span class="hljs-variable">req</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderRequest</span>(customerId, itemsJson, discount);
        <span class="hljs-type">OrderResponse</span> <span class="hljs-variable">resp</span> <span class="hljs-operator">=</span> orderService.createOrder(req);
        
        <span class="hljs-comment">// 3. 返回结构化结果（方便Agent理解）</span>
        <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"Order created: ID=%s, Total=%.2f, Status=%s"</span>,
            resp.getOrderId(), resp.getTotalPrice(), resp.getStatus());
    }
    
    <span class="hljs-meta">@Tool(name = "query_order", description = "Query order status and details")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">queryOrder</span><span class="hljs-params">(
        <span class="hljs-meta">@ToolParam(name = "order_id")</span> String orderId)</span> {
        <span class="hljs-type">OrderDetails</span> <span class="hljs-variable">details</span> <span class="hljs-operator">=</span> orderService.getOrder(orderId);
        <span class="hljs-keyword">return</span> ObjectMappers.toJson(details);
    }
    
    <span class="hljs-meta">@Tool(name = "apply_promotion", description = "Apply a promotion code to an order")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">applyPromotion</span><span class="hljs-params">(
        <span class="hljs-meta">@ToolParam(name = "order_id")</span> String orderId,
        <span class="hljs-meta">@ToolParam(name = "promo_code")</span> String promoCode)</span> {
        
        <span class="hljs-comment">// 验证promo_code的有效性</span>
        <span class="hljs-type">Promotion</span> <span class="hljs-variable">promo</span> <span class="hljs-operator">=</span> promotionService.validatePromo(promoCode);
        <span class="hljs-keyword">if</span> (promo == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"Promotion code invalid or expired"</span>;
        }
        
        <span class="hljs-comment">// 应用折扣</span>
        <span class="hljs-type">ApplyResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> orderService.applyPromotion(orderId, promo);
        <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"Promotion applied: new_total=%.2f, discount=%.2f"</span>,
            result.getNewTotal(), result.getDiscount());
    }
}

<span class="hljs-comment">// 使用示例：</span>
<span class="hljs-type">Toolkit</span> <span class="hljs-variable">toolkit</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Toolkit</span>();
toolkit.registerObject(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderTools</span>());

<span class="hljs-type">ReActAgent</span> <span class="hljs-variable">agent</span> <span class="hljs-operator">=</span> ReActAgent.builder()
    .name(<span class="hljs-string">"Sales Assistant"</span>)
    .sysPrompt(<span class="hljs-string">"You are a helpful sales assistant. Help customers create orders and apply promotions. "</span> +
               <span class="hljs-string">"Never apply discount &gt; 20% unless customer has valid promotion code."</span>)
    .model(model)
    .toolkit(toolkit)
    .build();

<span class="hljs-comment">// Agent会自动调用这些工具</span>
<span class="hljs-type">Msg</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> agent.call(
    Msg.builder().textContent(
        <span class="hljs-string">"Customer: Zhang Wei wants to buy 2 units of SKU-001 at ¥100 each. "</span> +
        <span class="hljs-string">"Create an order and apply promo code WELCOME10"</span>)
    .build()
).block();
</code></pre>
<h3 data-id="heading-28">1.2.3 记忆系统</h3>
<p>Agent需要<strong>记住对话历史和关键信息</strong>，才能在多轮交互中保持上下文。</p>
<h4 data-id="heading-29">三层记忆架构</h4>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────┐
│  短期记忆 (Short-term Memory)            │
│  - 当前会话的所有消息                     │
│  - 最近N轮对话                           │
│  - 用途：即时上下文                       │
└─────────────────────────────────────────┘
               ↓ 当消息堆积时自动压缩
┌─────────────────────────────────────────┐
│  中期记忆 (Medium-term Memory)           │
│  - 重要对话的摘要                        │
│  - 关键决策和结果                        │
│  - 用途：跨越较长时间保留重要信息         │
└─────────────────────────────────────────┘
               ↓
┌─────────────────────────────────────────┐
│  长期记忆 (Long-term Memory)             │
│  - 跨会话的持久化存储                     │
│  - 支持语义搜索（向量化）                │
│  - 用途：学习过去的经验，做出更好的决策   │
└─────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-30">生产场景：客户关系管理</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 场景：一个AI客服需要记住常见客户信息</span>

<span class="hljs-type">ReActAgent</span> <span class="hljs-variable">agent</span> <span class="hljs-operator">=</span> ReActAgent.builder()
    .name(<span class="hljs-string">"Customer Service Agent"</span>)
    .model(model)
    .toolkit(toolkit)
    <span class="hljs-comment">// 配置长期记忆：客户会自动记住重要信息</span>
    .withLongTermMemory(
        longTermMemory,
        LongTermMemoryMode.HYBRID  <span class="hljs-comment">// 自动+主动记录混合模式</span>
    )
    .build();

<span class="hljs-comment">// 第1次对话（User: Alice）</span>
agent.call(
    Msg.builder().textContent(
        <span class="hljs-string">"Hello! I'm Alice from TechCorp. I've been a customer for 3 years. "</span> +
        <span class="hljs-string">"We usually buy 100 units of Product X every month. "</span> +
        <span class="hljs-string">"This month we need to increase to 200 units."</span>)
    .build()
).block();
<span class="hljs-comment">// Agent自动记住：Alice / TechCorp / 3年老客户 / 正常订购量100 / 本月200</span>

<span class="hljs-comment">// 一周后，Alice再次联系</span>
agent.call(
    Msg.builder().textContent(<span class="hljs-string">"Hi! It's Alice again. Can you remind me what we discussed last week?"</span>)
    .build()
).block();

<span class="hljs-comment">// Agent的长期记忆让它能够：</span>
<span class="hljs-comment">// ✓ 立即认出Alice是老客户</span>
<span class="hljs-comment">// ✓ 回忆上周的增量订单需求</span>
<span class="hljs-comment">// ✓ 做出个性化的服务建议（如：由于你增量订购，这个月可以享受额外2%折扣）</span>
</code></pre>
<h3 data-id="heading-31">1.2.4 多智能体协作</h3>
<p>单个Agent的能力有限，AgentScope支持<strong>多个Agent在Pipeline中协作</strong>。</p>
<h4 data-id="heading-32">Pipeline模式</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">场景：内容创作工作流</span>

<span class="hljs-string">用户输入:</span> <span class="hljs-string">"写一篇关于AI技术趋势的文章"</span>
       <span class="hljs-string">↓</span>
<span class="hljs-string">┌─────────────────────────────────┐</span>
<span class="hljs-string">│</span> <span class="hljs-attr">Agent 1:</span> <span class="hljs-string">研究员</span> <span class="hljs-string">Agent</span>           <span class="hljs-string">│</span>
<span class="hljs-string">│</span> <span class="hljs-string">职责：搜索和整理相关资料</span>          <span class="hljs-string">│</span>
<span class="hljs-string">└──────────────┬──────────────────┘</span>
               <span class="hljs-string">↓</span>
<span class="hljs-string">┌─────────────────────────────────┐</span>
<span class="hljs-string">│</span> <span class="hljs-attr">Agent 2:</span> <span class="hljs-string">写作</span> <span class="hljs-string">Agent</span>             <span class="hljs-string">│</span>
<span class="hljs-string">│</span> <span class="hljs-string">职责：基于研究员的资料进行创作</span>     <span class="hljs-string">│</span>
<span class="hljs-string">└──────────────┬──────────────────┘</span>
               <span class="hljs-string">↓</span>
<span class="hljs-string">┌─────────────────────────────────┐</span>
<span class="hljs-string">│</span> <span class="hljs-attr">Agent 3:</span> <span class="hljs-string">审核</span> <span class="hljs-string">Agent</span>             <span class="hljs-string">│</span>
<span class="hljs-string">│</span> <span class="hljs-string">职责：检查文章的正确性和风格</span>      <span class="hljs-string">│</span>
<span class="hljs-string">└──────────────┬──────────────────┘</span>
               <span class="hljs-string">↓</span>
           <span class="hljs-string">最终文章输出</span>
</code></pre>
<h4 data-id="heading-33">并行工作流</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">用户输入:</span> <span class="hljs-string">"为我生成一份综合性的年度报告"</span>
       <span class="hljs-string">↓</span>
       <span class="hljs-string">├─→</span> <span class="hljs-attr">Agent A:</span> <span class="hljs-string">财务分析</span>      <span class="hljs-string">─┐</span>
       <span class="hljs-string">│</span>                           <span class="hljs-string">│</span>
       <span class="hljs-string">├─→</span> <span class="hljs-attr">Agent B:</span> <span class="hljs-string">市场分析</span>      <span class="hljs-string">─┤─→</span> <span class="hljs-string">汇总</span> <span class="hljs-string">Agent</span> <span class="hljs-string">→</span> <span class="hljs-string">最终报告</span>
       <span class="hljs-string">│</span>                           <span class="hljs-string">│</span>
       <span class="hljs-string">└─→</span> <span class="hljs-attr">Agent C:</span> <span class="hljs-string">竞争对手分析</span>  <span class="hljs-string">─┘</span>
</code></pre>
<h4 data-id="heading-34">生产代码示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 定义三个专业的Agent</span>
<span class="hljs-type">ReActAgent</span> <span class="hljs-variable">researchAgent</span> <span class="hljs-operator">=</span> ReActAgent.builder()
    .name(<span class="hljs-string">"Research"</span>)
    .sysPrompt(<span class="hljs-string">"You are a research expert. Search and gather relevant information."</span>)
    .model(model)
    .toolkit(researchToolkit)
    .build();

<span class="hljs-type">ReActAgent</span> <span class="hljs-variable">writerAgent</span> <span class="hljs-operator">=</span> ReActAgent.builder()
    .name(<span class="hljs-string">"Writer"</span>)
    .sysPrompt(<span class="hljs-string">"You are a professional writer. Write high-quality content."</span>)
    .model(model)
    .toolkit(writerToolkit)
    .build();

<span class="hljs-type">ReActAgent</span> <span class="hljs-variable">reviewerAgent</span> <span class="hljs-operator">=</span> ReActAgent.builder()
    .name(<span class="hljs-string">"Reviewer"</span>)
    .sysPrompt(<span class="hljs-string">"You are an editor. Review and improve content for clarity and style."</span>)
    .model(model)
    .toolkit(reviewerToolkit)
    .build();

<span class="hljs-comment">// 创建顺序Pipeline：研究 → 写作 → 审核</span>
SequentialPipeline&lt;Msg&gt; pipeline = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SequentialPipeline</span>&lt;&gt;(
    List.of(researchAgent, writerAgent, reviewerAgent),
    (response, nextAgent) -&gt; {
        <span class="hljs-comment">// 将前一个Agent的输出转为下一个Agent的输入</span>
        <span class="hljs-keyword">return</span> Msg.builder()
            .role(MsgRole.ASSISTANT)
            .content(TextBlock.builder()
                .text(<span class="hljs-string">"Based on the previous work:\n"</span> + response.getTextContent())
                .build())
            .build();
    }
);

<span class="hljs-comment">// 执行</span>
<span class="hljs-type">Msg</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> pipeline.execute(
    Msg.builder().textContent(<span class="hljs-string">"Write an article about AI trends"</span>)
    .build()
).block();
</code></pre>
<hr/>
<h2 data-id="heading-35">1.3 快速开始示例解析</h2>
<h3 data-id="heading-36">1.3.1 最小化可工作示例</h3>
<p>让我们从最简单的示例开始，一步步理解AgentScope的工作流：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example;

<span class="hljs-keyword">import</span> io.agentscope.core.ReActAgent;
<span class="hljs-keyword">import</span> io.agentscope.core.message.Msg;
<span class="hljs-keyword">import</span> io.agentscope.core.model.DashScopeChatModel;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloAgentExample</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 第1步：创建模型（连接到LLM）</span>
        <span class="hljs-type">DashScopeChatModel</span> <span class="hljs-variable">model</span> <span class="hljs-operator">=</span> DashScopeChatModel.builder()
            .apiKey(System.getenv(<span class="hljs-string">"DASHSCOPE_API_KEY"</span>))  <span class="hljs-comment">// 从环境变量读取API Key</span>
            .modelName(<span class="hljs-string">"qwen-plus"</span>)  <span class="hljs-comment">// 使用通义千问Plus模型</span>
            .build();
        
        <span class="hljs-comment">// 第2步：创建Agent</span>
        <span class="hljs-type">ReActAgent</span> <span class="hljs-variable">agent</span> <span class="hljs-operator">=</span> ReActAgent.builder()
            .name(<span class="hljs-string">"Assistant"</span>)
            .sysPrompt(<span class="hljs-string">"You are a helpful AI assistant."</span>)  <span class="hljs-comment">// 系统提示词</span>
            .model(model)
            .build();
        
        <span class="hljs-comment">// 第3步：调用Agent</span>
        <span class="hljs-type">Msg</span> <span class="hljs-variable">userMessage</span> <span class="hljs-operator">=</span> Msg.builder()
            .textContent(<span class="hljs-string">"你好！请告诉我2024年有哪些重要的科技事件"</span>)
            .build();
        
        <span class="hljs-type">Msg</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> agent.call(userMessage).block();  <span class="hljs-comment">// .block() 等待响应</span>
        
        <span class="hljs-comment">// 第4步：获取结果</span>
        System.out.println(<span class="hljs-string">"Agent: "</span> + response.getTextContent());
    }
}
</code></pre>
<h4 data-id="heading-37">执行流程详解</h4>
<pre><code class="hljs language-scss" lang="scss">第<span class="hljs-number">1</span>步：创建模型（DashScopeChatModel）
  ├─ 初始化HTTP客户端
  ├─ 配置API Key和模型名称
  └─ 准备与DashScope API通信

第<span class="hljs-number">2</span>步：创建Agent（ReActAgent）
  ├─ 初始化系统提示词
  ├─ 设置内存为默认的InMemoryMemory
  ├─ 注册模型和默认工具箱
  └─ 准备好处理用户输入

第<span class="hljs-number">3</span>步：创建用户消息（Msg）
  ├─ 设置消息内容为纯文本
  ├─ 默认角色为USER
  └─ 自动生成唯一ID和时间戳

第<span class="hljs-number">4</span>步：调用Agent
  agent<span class="hljs-selector-class">.call</span>(userMessage) 返回 Mono&lt;Msg&gt;
  <span class="hljs-selector-class">.block</span>() 阻塞等待响应（生产环境应使用异步处理）
  └─ 返回Agent的完整响应

第<span class="hljs-number">5</span>步：提取并显示结果
  response<span class="hljs-selector-class">.getTextContent</span>() 获取文本内容
  └─ 输出：Agent生成的回答
</code></pre>
<h3 data-id="heading-38">1.3.2 使用工具的示例</h3>
<p>上一个示例中，Agent只能通过对话回答。现在让我们添加<strong>工具能力</strong>，让Agent能够执行实际操作：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example;

<span class="hljs-keyword">import</span> io.agentscope.core.ReActAgent;
<span class="hljs-keyword">import</span> io.agentscope.core.message.Msg;
<span class="hljs-keyword">import</span> io.agentscope.core.model.DashScopeChatModel;
<span class="hljs-keyword">import</span> io.agentscope.core.tool.Tool;
<span class="hljs-keyword">import</span> io.agentscope.core.tool.ToolParam;
<span class="hljs-keyword">import</span> io.agentscope.core.tool.Toolkit;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AgentWithToolsExample</span> {
    
    <span class="hljs-comment">// 第1步：定义工具类</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CalculatorTools</span> {
        
        <span class="hljs-meta">@Tool(name = "add", description = "Add two numbers")</span>
        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">add</span><span class="hljs-params">(
            <span class="hljs-meta">@ToolParam(name = "a", description = "First number")</span> <span class="hljs-type">double</span> a,
            <span class="hljs-meta">@ToolParam(name = "b", description = "Second number")</span> <span class="hljs-type">double</span> b)</span> {
            <span class="hljs-keyword">return</span> String.valueOf(a + b);
        }
        
        <span class="hljs-meta">@Tool(name = "multiply", description = "Multiply two numbers")</span>
        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">multiply</span><span class="hljs-params">(
            <span class="hljs-meta">@ToolParam(name = "a", description = "First number")</span> <span class="hljs-type">double</span> a,
            <span class="hljs-meta">@ToolParam(name = "b", description = "Second number")</span> <span class="hljs-type">double</span> b)</span> {
            <span class="hljs-keyword">return</span> String.valueOf(a * b);
        }
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 第2步：创建模型</span>
        <span class="hljs-type">DashScopeChatModel</span> <span class="hljs-variable">model</span> <span class="hljs-operator">=</span> DashScopeChatModel.builder()
            .apiKey(System.getenv(<span class="hljs-string">"DASHSCOPE_API_KEY"</span>))
            .modelName(<span class="hljs-string">"qwen-plus"</span>)
            .build();
        
        <span class="hljs-comment">// 第3步：创建工具箱并注册工具</span>
        <span class="hljs-type">Toolkit</span> <span class="hljs-variable">toolkit</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Toolkit</span>();
        toolkit.registerObject(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CalculatorTools</span>());
        
        <span class="hljs-comment">// 第4步：创建Agent并配置工具箱</span>
        <span class="hljs-type">ReActAgent</span> <span class="hljs-variable">agent</span> <span class="hljs-operator">=</span> ReActAgent.builder()
            .name(<span class="hljs-string">"MathAssistant"</span>)
            .sysPrompt(<span class="hljs-string">"You are a helpful math assistant. "</span> +
                      <span class="hljs-string">"Use the calculator tools to solve math problems."</span>)
            .model(model)
            .toolkit(toolkit)  <span class="hljs-comment">// 传入工具箱</span>
            .build();
        
        <span class="hljs-comment">// 第5步：调用Agent</span>
        <span class="hljs-type">Msg</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> agent.call(
            Msg.builder().textContent(<span class="hljs-string">"25乘以48等于多少？"</span>)
            .build()
        ).block();
        
        System.out.println(<span class="hljs-string">"Result: "</span> + response.getTextContent());
    }
}
</code></pre>
<h4 data-id="heading-39">带工具调用的执行流程</h4>
<pre><code class="hljs language-css" lang="css">用户: <span class="hljs-string">"25乘以48等于多少？"</span>
  ↓
[推理阶段]
Agent收到问题，思考：需要调用 <span class="hljs-built_in">multiply</span>(<span class="hljs-number">25</span>, <span class="hljs-number">48</span>)
Model返回：{"tool_call": <span class="hljs-string">"multiply"</span>, <span class="hljs-string">"args"</span>: {"<span class="hljs-selector-tag">a</span>": <span class="hljs-number">25</span>, <span class="hljs-string">"b"</span>: <span class="hljs-number">48</span>}}
  ↓
<span class="hljs-selector-attr">[行动阶段]</span>
ToolExecutor找到 CalculatorTools<span class="hljs-selector-class">.multiply</span> 方法
反射调用：multiply(<span class="hljs-number">25.0</span>, <span class="hljs-number">48.0</span>)
得到结果：<span class="hljs-number">1200.0</span>
  ↓
<span class="hljs-selector-attr">[反馈到内存]</span>
Agent记住：multiply(<span class="hljs-number">25</span>, <span class="hljs-number">48</span>) = <span class="hljs-number">1200</span>
  ↓
<span class="hljs-selector-attr">[推理阶段]</span>
Agent继续思考：我已经得到结果了，可以回答用户
Model返回：最终答案的文本
  ↓
<span class="hljs-selector-attr">[完成]</span>
返回给用户：<span class="hljs-number">25</span>乘以<span class="hljs-number">48</span>等于<span class="hljs-number">1200</span>
</code></pre>
<h3 data-id="heading-40">1.3.3 包含记忆的对话示例</h3>
<p>让我们创建一个<strong>能够记住对话历史</strong>的Agent：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example;

<span class="hljs-keyword">import</span> io.agentscope.core.ReActAgent;
<span class="hljs-keyword">import</span> io.agentscope.core.memory.InMemoryMemory;
<span class="hljs-keyword">import</span> io.agentscope.core.message.Msg;
<span class="hljs-keyword">import</span> io.agentscope.core.model.DashScopeChatModel;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConversationWithMemoryExample</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException {
        <span class="hljs-type">DashScopeChatModel</span> <span class="hljs-variable">model</span> <span class="hljs-operator">=</span> DashScopeChatModel.builder()
            .apiKey(System.getenv(<span class="hljs-string">"DASHSCOPE_API_KEY"</span>))
            .modelName(<span class="hljs-string">"qwen-plus"</span>)
            .build();
        
        <span class="hljs-comment">// 创建Agent并配置记忆</span>
        <span class="hljs-type">ReActAgent</span> <span class="hljs-variable">agent</span> <span class="hljs-operator">=</span> ReActAgent.builder()
            .name(<span class="hljs-string">"Conversational AI"</span>)
            .sysPrompt(<span class="hljs-string">"You are a friendly assistant. Remember the context of conversations."</span>)
            .model(model)
            .memory(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryMemory</span>())  <span class="hljs-comment">// 明确创建记忆对象</span>
            .build();
        
        <span class="hljs-comment">// 第1轮对话</span>
        System.out.println(<span class="hljs-string">"=== 第1轮对话 ==="</span>);
        <span class="hljs-type">Msg</span> <span class="hljs-variable">msg1</span> <span class="hljs-operator">=</span> agent.call(
            Msg.builder().textContent(<span class="hljs-string">"我叫张三，我是一个工程师"</span>)
            .build()
        ).block();
        System.out.println(<span class="hljs-string">"User: 我叫张三，我是一个工程师"</span>);
        System.out.println(<span class="hljs-string">"Agent: "</span> + msg1.getTextContent());
        
        Thread.sleep(<span class="hljs-number">1000</span>);  <span class="hljs-comment">// 等待1秒</span>
        
        <span class="hljs-comment">// 第2轮对话：Agent应该记得张三的身份</span>
        System.out.println(<span class="hljs-string">"\n=== 第2轮对话 ==="</span>);
        <span class="hljs-type">Msg</span> <span class="hljs-variable">msg2</span> <span class="hljs-operator">=</span> agent.call(
            Msg.builder().textContent(<span class="hljs-string">"我的工作是什么？"</span>)
            .build()
        ).block();
        System.out.println(<span class="hljs-string">"User: 我的工作是什么？"</span>);
        System.out.println(<span class="hljs-string">"Agent: "</span> + msg2.getTextContent());
        <span class="hljs-comment">// Agent会回答：你是一个工程师，之前告诉我的</span>
        
        <span class="hljs-comment">// 第3轮对话</span>
        System.out.println(<span class="hljs-string">"\n=== 第3轮对话 ==="</span>);
        <span class="hljs-type">Msg</span> <span class="hljs-variable">msg3</span> <span class="hljs-operator">=</span> agent.call(
            Msg.builder().textContent(<span class="hljs-string">"我最擅长的编程语言是Java。这个信息对我的工作有什么影响？"</span>)
            .build()
        ).block();
        System.out.println(<span class="hljs-string">"User: 我最擅长的编程语言是Java。这个信息对我的工作有什么影响？"</span>);
        System.out.println(<span class="hljs-string">"Agent: "</span> + msg3.getTextContent());
        <span class="hljs-comment">// Agent能综合前面的信息做出回答</span>
    }
}
</code></pre>
<h4 data-id="heading-41">记忆如何工作？</h4>
<pre><code class="hljs language-scss" lang="scss">第<span class="hljs-number">1</span>轮对话：
Agent<span class="hljs-selector-class">.call</span>(msg) → memory<span class="hljs-selector-class">.addMessage</span>(userMsg) + memory<span class="hljs-selector-class">.addMessage</span>(agentResponse)
记忆状态：
  <span class="hljs-selector-attr">[UserMessage: <span class="hljs-string">"我叫张三，我是一个工程师"</span>]</span>
  <span class="hljs-selector-attr">[AssistantMessage: <span class="hljs-string">"Nice to meet you, 张三! 很高兴认识你..."</span>]</span>

第<span class="hljs-number">2</span>轮对话：
Agent<span class="hljs-selector-class">.call</span>(msg) → 
  <span class="hljs-number">1</span>. memory<span class="hljs-selector-class">.addMessage</span>(userMsg)
  <span class="hljs-number">2</span>. memory<span class="hljs-selector-class">.getMessages</span>() 返回所有历史消息（包括第<span class="hljs-number">1</span>轮）
  <span class="hljs-number">3</span>. 将完整的历史消息发送给Model
  <span class="hljs-number">4</span>. Model生成响应，记住了张三的身份
  <span class="hljs-number">5</span>. memory<span class="hljs-selector-class">.addMessage</span>(agentResponse)

记忆状态：
  <span class="hljs-selector-attr">[UserMessage: <span class="hljs-string">"我叫张三，我是一个工程师"</span>]</span>
  <span class="hljs-selector-attr">[AssistantMessage: <span class="hljs-string">"..."</span>]</span>
  <span class="hljs-selector-attr">[UserMessage: <span class="hljs-string">"我的工作是什么？"</span>]</span>
  <span class="hljs-selector-attr">[AssistantMessage: <span class="hljs-string">"根据你之前告诉我..."</span>]</span>
</code></pre>
<hr/>
<h2 data-id="heading-42">1.4 项目结构与模块划分</h2>
<h3 data-id="heading-43">1.4.1 整体模块组织</h3>
<pre><code class="hljs language-bash" lang="bash">agentscope-java/
├── agentscope-core/                          <span class="hljs-comment"># 核心模块（必需）</span>
│   ├── src/main/java/io/agentscope/core/
│   │   ├── agent/                            <span class="hljs-comment"># Agent接口和实现</span>
│   │   ├── message/                          <span class="hljs-comment"># 消息系统（Msg、ContentBlock等）</span>
│   │   ├── model/                            <span class="hljs-comment"># 模型接口和实现</span>
│   │   ├── tool/                             <span class="hljs-comment"># 工具系统（@Tool、Toolkit）</span>
│   │   ├── memory/                           <span class="hljs-comment"># 记忆系统</span>
│   │   ├── hook/                             <span class="hljs-comment"># Hook系统（事件拦截）</span>
│   │   ├── plan/                             <span class="hljs-comment"># PlanNotebook任务管理</span>
│   │   ├── rag/                              <span class="hljs-comment"># RAG检索增强生成</span>
│   │   ├── pipeline/                         <span class="hljs-comment"># 多Agent协作管道</span>
│   │   ├── session/                          <span class="hljs-comment"># 会话管理（持久化）</span>
│   │   ├── skill/                            <span class="hljs-comment"># 技能系统</span>
│   │   ├── interruption/                     <span class="hljs-comment"># 中断和取消机制</span>
│   │   ├── tracing/                          <span class="hljs-comment"># 可观测性追踪</span>
│   │   └── ReActAgent.java                   <span class="hljs-comment"># 核心实现</span>
│   └── pom.xml
│
├── agentscope-extensions/                    <span class="hljs-comment"># 扩展模块（可选）</span>
│   ├── agentscope-extensions-scheduler/      <span class="hljs-comment"># 定时调度</span>
│   ├── agentscope-extensions-rag-*/          <span class="hljs-comment"># 各种RAG集成</span>
│   ├── agentscope-extensions-a2a/            <span class="hljs-comment"># A2A多Agent协议</span>
│   ├── agentscope-extensions-studio/         <span class="hljs-comment"># Studio集成</span>
│   ├── agentscope-spring-boot-starters/      <span class="hljs-comment"># Spring Boot集成</span>
│   └── ...
│
├── agentscope-examples/                      <span class="hljs-comment"># 示例代码</span>
│   ├── quickstart/                           <span class="hljs-comment"># 快速开始</span>
│   ├── boba-tea-shop/                        <span class="hljs-comment"># 完整应用示例</span>
│   ├── werewolf/                             <span class="hljs-comment"># 游戏示例</span>
│   └── ...
│
└── docs/                                     <span class="hljs-comment"># 文档</span>
    ├── zh/                                   <span class="hljs-comment"># 中文文档</span>
    ├── en/                                   <span class="hljs-comment"># 英文文档</span>
    └── llm/                                  <span class="hljs-comment"># LLM相关文档</span>
</code></pre>
<h3 data-id="heading-44">1.4.2 核心模块详解</h3>
<h4 data-id="heading-45">1. Agent接口层（<code>agent/</code>）</h4>
<pre><code class="hljs language-bash" lang="bash">核心类：
├── Agent                    <span class="hljs-comment"># 所有Agent的接口</span>
├── AgentBase                <span class="hljs-comment"># Agent的基础实现</span>
├── ReActAgent               <span class="hljs-comment"># ReAct推理-行动循环实现</span>
├── UserAgent                <span class="hljs-comment"># 用户交互Agent</span>
└── StructuredOutputHandler  <span class="hljs-comment"># 结构化输出处理</span>
</code></pre>
<p><strong>职责</strong>：定义Agent的行为和生命周期
<strong>关键方法</strong>：<code>call()</code>、<code>observe()</code>、<code>interrupt()</code>、<code>stream()</code></p>
<h4 data-id="heading-46">2. 消息系统（<code>message/</code>）</h4>
<pre><code class="hljs language-bash" lang="bash">核心类：
├── Msg                      <span class="hljs-comment"># 消息对象（不可变）</span>
├── MsgRole                  <span class="hljs-comment"># 消息角色枚举</span>
│   ├── USER                 <span class="hljs-comment"># 用户消息</span>
│   ├── ASSISTANT            <span class="hljs-comment"># Agent回复</span>
│   ├── SYSTEM               <span class="hljs-comment"># 系统消息</span>
│   └── TOOL                 <span class="hljs-comment"># 工具执行结果</span>
└── ContentBlock及其实现
    ├── TextBlock            <span class="hljs-comment"># 文本内容</span>
    ├── ImageBlock           <span class="hljs-comment"># 图像内容</span>
    ├── AudioBlock           <span class="hljs-comment"># 音频内容</span>
    ├── VideoBlock           <span class="hljs-comment"># 视频内容</span>
    ├── ToolUseBlock         <span class="hljs-comment"># 工具调用</span>
    └── ToolResultBlock      <span class="hljs-comment"># 工具结果</span>
</code></pre>
<p><strong>设计特点</strong>：</p>
<ul>
<li>不可变设计（Immutable），线程安全</li>
<li>支持多种内容类型（多模态）</li>
<li>元数据支持，用于结构化数据</li>
</ul>
<h4 data-id="heading-47">3. 模型层（<code>model/</code>）</h4>
<pre><code class="hljs language-bash" lang="bash">核心接口/类：
├── Model                    <span class="hljs-comment"># 模型接口</span>
│   └── stream()  <span class="hljs-comment"># 流式调用LLM</span>
├── Model实现
│   ├── DashScopeChatModel   <span class="hljs-comment"># 阿里云通义千问</span>
│   ├── OpenAiChatModel      <span class="hljs-comment"># OpenAI GPT</span>
│   ├── GeminiChatModel      <span class="hljs-comment"># Google Gemini</span>
│   └── AnthropicChatModel   <span class="hljs-comment"># Anthropic Claude</span>
├── GenerateOptions          <span class="hljs-comment"># 生成参数（temperature、max_tokens等）</span>
├── ChatResponse             <span class="hljs-comment"># 模型响应</span>
└── Formatter                <span class="hljs-comment"># 消息格式化器</span>
</code></pre>
<p><strong>职责</strong>：屏蔽不同LLM的差异，提供统一接口</p>
<h4 data-id="heading-48">4. 工具系统（<code>tool/</code>）</h4>
<pre><code class="hljs language-less" lang="less">核心类：
├── <span class="hljs-variable">@Tool</span>                    # 工具注解
├── <span class="hljs-variable">@ToolParam</span>              # 工具参数注解
├── Toolkit                 # 工具箱（管理多个工具）
├── AgentTool               # 工具接口
├── ToolSchema              # 工具定义（发送给LLM的描述）
├── ToolExecutor            # 工具执行器
├── ToolRegistry            # 工具注册表
└── mcp/
    └── McpTool             # MCP协议工具适配
</code></pre>
<p><strong>工作流</strong>：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-keyword">@Tool</span>注解 → ToolRegistry（发现） → ToolSchema（生成定义） 
  → Model（选择工具）→ ToolExecutor（执行）→ 结果返回
</code></pre>
<h4 data-id="heading-49">5. 记忆系统（<code>memory/</code>）</h4>
<pre><code class="hljs language-bash" lang="bash">核心类：
├── Memory                  <span class="hljs-comment"># 记忆接口</span>
├── InMemoryMemory          <span class="hljs-comment"># 内存实现</span>
├── LongTermMemory          <span class="hljs-comment"># 长期记忆（跨会话）</span>
├── LongTermMemoryTools     <span class="hljs-comment"># LTM相关工具</span>
├── LongTermMemoryMode      <span class="hljs-comment"># LTM工作模式</span>
└── StaticLongTermMemoryHook<span class="hljs-comment"># LTM Hook集成</span>
</code></pre>
<p><strong>特点</strong>：</p>
<ul>
<li>短期记忆：当前对话历史</li>
<li>长期记忆：跨会话持久化存储，支持语义搜索</li>
</ul>
<h4 data-id="heading-50">6. Hook系统（<code>hook/</code>）</h4>
<pre><code class="hljs language-bash" lang="bash">核心类：
├── Hook                    <span class="hljs-comment"># Hook接口</span>
├── HookEvent               <span class="hljs-comment"># Hook事件基类</span>
│   ├── PreReasoningEvent   <span class="hljs-comment"># 推理前</span>
│   ├── ReasoningChunkEvent <span class="hljs-comment"># 推理流式</span>
│   ├── PostReasoningEvent  <span class="hljs-comment"># 推理后</span>
│   ├── PreActingEvent      <span class="hljs-comment"># 行动前</span>
│   ├── ActingChunkEvent    <span class="hljs-comment"># 行动流式</span>
│   └── PostActingEvent     <span class="hljs-comment"># 行动后</span>
└── HookChain               <span class="hljs-comment"># Hook链（责任链模式）</span>
</code></pre>
<p><strong>用途</strong>：在Agent执行的各个阶段插入自定义逻辑</p>
<h4 data-id="heading-51">7. 任务管理（<code>plan/</code>）</h4>
<pre><code class="hljs language-bash" lang="bash">核心类：
├── PlanNotebook            <span class="hljs-comment"># 计划管理工具</span>
├── Plan                    <span class="hljs-comment"># 计划模型</span>
├── SubTask                 <span class="hljs-comment"># 子任务模型</span>
├── PlanState               <span class="hljs-comment"># 计划状态</span>
└── PlanStorage             <span class="hljs-comment"># 计划存储抽象</span>
    ├── InMemoryPlanStorage <span class="hljs-comment"># 内存存储</span>
    └── JsonPlanStorage     <span class="hljs-comment"># JSON文件存储</span>
</code></pre>
<h4 data-id="heading-52">8. RAG系统（<code>rag/</code>）</h4>
<pre><code class="hljs language-bash" lang="bash">核心类：
├── Knowledge               <span class="hljs-comment"># 知识库接口</span>
├── Document                <span class="hljs-comment"># 文档模型</span>
├── RetrieveConfig          <span class="hljs-comment"># 检索配置</span>
├── KnowledgeRetrievalTools <span class="hljs-comment"># RAG工具</span>
└── GenericRAGHook          <span class="hljs-comment"># RAG Hook集成</span>
</code></pre>
<h4 data-id="heading-53">9. Pipeline（<code>pipeline/</code>）</h4>
<pre><code class="hljs language-r" lang="r">核心类：
├── Pipeline<span class="hljs-operator">&lt;</span><span class="hljs-built_in">T</span><span class="hljs-operator">&gt;</span>             <span class="hljs-comment"># Pipeline接口</span>
├── SequentialPipeline      <span class="hljs-comment"># 顺序执行</span>
├── FanoutPipeline          <span class="hljs-comment"># 并行执行</span>
└── MsgHub                  <span class="hljs-comment"># 消息中心（多Agent通信）</span>
</code></pre>
<h4 data-id="heading-54">10. Session（<code>session/</code>）</h4>
<pre><code class="hljs language-bash" lang="bash">核心类：
├── Session                 <span class="hljs-comment"># Session接口</span>
├── InMemorySession         <span class="hljs-comment"># 内存Session</span>
├── JsonSession             <span class="hljs-comment"># JSON文件Session</span>
├── MysqlSession            <span class="hljs-comment"># MySQL Session</span>
└── RedisSession            <span class="hljs-comment"># Redis Session</span>
</code></pre>
<hr/>
<h2 data-id="heading-55">1.5 生产场景详解</h2>
<h3 data-id="heading-56">1.5.1 场景：智能客服系统</h3>
<h4 data-id="heading-57">需求</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">需求：为电商平台构建一个智能客服系统</span>
<span class="hljs-string">├─</span> <span class="hljs-string">功能1：自动回答常见问题（FAQ）</span>
<span class="hljs-string">├─</span> <span class="hljs-string">功能2：处理订单相关查询</span>
<span class="hljs-string">├─</span> <span class="hljs-string">功能3：处理投诉和退货</span>
<span class="hljs-string">├─</span> <span class="hljs-string">功能4：支持知识库检索（RAG）</span>
<span class="hljs-string">├─</span> <span class="hljs-string">功能5：关键问题升级到人工</span>
<span class="hljs-string">└─</span> <span class="hljs-string">约束：每小时处理</span> <span class="hljs-number">1000</span><span class="hljs-string">+</span> <span class="hljs-string">消息，99.9%可用性</span>
</code></pre>
<h4 data-id="heading-58">架构设计</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    User[&amp;#34;用户消息&amp;#34;]
    
    User --&gt; Agent[&amp;#34;智能客服 Agent&amp;#34;]
    
    Agent --&gt; Tools[&amp;#34;工具箱&amp;#34;]
    Tools --&gt; FAQ[&amp;#34;FAQ工具&amp;#34;]
    Tools --&gt; Order[&amp;#34;订单查询工具&amp;#34;]
    Tools --&gt; Return[&amp;#34;退货处理工具&amp;#34;]
    Tools --&gt; Escalate[&amp;#34;人工升级工具&amp;#34;]
    
    Agent --&gt; Memory[&amp;#34;记忆系统&amp;#34;]
    Memory --&gt; ShortMem[&amp;#34;短期：当前对话&amp;#34;]
    Memory --&gt; LongMem[&amp;#34;长期：客户历史&amp;#34;]
    
    Agent --&gt; RAG[&amp;#34;RAG系统&amp;#34;]
    RAG --&gt; KB[&amp;#34;知识库检索&amp;#34;]
    
    Agent --&gt; Monitor[&amp;#34;监控和指标&amp;#34;]
    
    Output[&amp;#34;最终回复&amp;#34;]
    Agent --&gt; Output
</code></pre>
<h4 data-id="heading-59">完整代码实现</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.ecommerce;

<span class="hljs-keyword">import</span> io.agentscope.core.ReActAgent;
<span class="hljs-keyword">import</span> io.agentscope.core.memory.InMemoryMemory;
<span class="hljs-keyword">import</span> io.agentscope.core.memory.LongTermMemory;
<span class="hljs-keyword">import</span> io.agentscope.core.memory.LongTermMemoryMode;
<span class="hljs-keyword">import</span> io.agentscope.core.message.Msg;
<span class="hljs-keyword">import</span> io.agentscope.core.model.DashScopeChatModel;
<span class="hljs-keyword">import</span> io.agentscope.core.rag.Knowledge;
<span class="hljs-keyword">import</span> io.agentscope.core.rag.RAGMode;
<span class="hljs-keyword">import</span> io.agentscope.core.tool.Tool;
<span class="hljs-keyword">import</span> io.agentscope.core.tool.ToolParam;
<span class="hljs-keyword">import</span> io.agentscope.core.tool.Toolkit;
<span class="hljs-keyword">import</span> java.util.Map;
<span class="hljs-keyword">import</span> java.util.concurrent.ConcurrentHashMap;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SmartCustomerServiceExample</span> {
    
    <span class="hljs-comment">// 第1步：定义工具类</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomerServiceTools</span> {
        
        <span class="hljs-keyword">private</span> Map&lt;String, String&gt; faqDatabase = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
        <span class="hljs-keyword">private</span> Map&lt;String, Order&gt; orderDatabase = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
        
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">CustomerServiceTools</span><span class="hljs-params">()</span> {
            <span class="hljs-comment">// 初始化FAQ数据库</span>
            faqDatabase.put(<span class="hljs-string">"shipping"</span>, <span class="hljs-string">"标准快递3-5天送达，加急1-2天。支持到付和预付。"</span>);
            faqDatabase.put(<span class="hljs-string">"return"</span>, <span class="hljs-string">"收货后30天内无损产品可无条件退货。已使用产品需扣除使用费。"</span>);
            faqDatabase.put(<span class="hljs-string">"warranty"</span>, <span class="hljs-string">"所有产品享受1年保修，覆盖生产缺陷但不包括人为损坏。"</span>);
        }
        
        <span class="hljs-meta">@Tool(name = "search_faq", 
              description = "Search FAQ database for common questions")</span>
        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">searchFAQ</span><span class="hljs-params">(
            <span class="hljs-meta">@ToolParam(name = "question", description = "Customer question or keyword")</span> 
                String question)</span> {
            
            <span class="hljs-comment">// 简单的关键词匹配（生产环境应使用向量搜索）</span>
            <span class="hljs-keyword">for</span> (Map.Entry&lt;String, String&gt; entry : faqDatabase.entrySet()) {
                <span class="hljs-keyword">if</span> (question.toLowerCase().contains(entry.getKey())) {
                    <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"FAQ: %s → %s"</span>, entry.getKey(), entry.getValue());
                }
            }
            <span class="hljs-keyword">return</span> <span class="hljs-string">"No matching FAQ found for: "</span> + question;
        }
        
        <span class="hljs-meta">@Tool(name = "query_order", 
              description = "Query order status and details")</span>
        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">queryOrder</span><span class="hljs-params">(
            <span class="hljs-meta">@ToolParam(name = "order_id", description = "Order ID to query")</span> 
                String orderId)</span> {
            
            <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderDatabase.get(orderId);
            <span class="hljs-keyword">if</span> (order == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"Order not found: %s"</span>, orderId);
            }
            
            <span class="hljs-keyword">return</span> String.format(
                <span class="hljs-string">"Order %s: Status=%s, Total=¥%.2f, Items=%d, "</span> +
                <span class="hljs-string">"Created=%s, EstimatedDelivery=%s"</span>,
                orderId, order.status, order.total, order.itemCount,
                order.createdTime, order.estimatedDelivery);
        }
        
        <span class="hljs-meta">@Tool(name = "process_return_request", 
              description = "Initiate a return or refund process")</span>
        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">processReturnRequest</span><span class="hljs-params">(
            <span class="hljs-meta">@ToolParam(name = "order_id", description = "Order to return")</span> 
                String orderId,
            <span class="hljs-meta">@ToolParam(name = "reason", description = "Reason for return")</span> 
                String reason,
            <span class="hljs-meta">@ToolParam(name = "damage_percent", 
                       description = "Damage percentage 0-100, 0=unused, 100=unusable")</span> 
                <span class="hljs-type">int</span> damagePercent)</span> {
            
            <span class="hljs-keyword">if</span> (damagePercent &lt; <span class="hljs-number">0</span> || damagePercent &gt; <span class="hljs-number">100</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-string">"Invalid damage_percent. Must be 0-100."</span>;
            }
            
            <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderDatabase.get(orderId);
            <span class="hljs-keyword">if</span> (order == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"Order not found: %s"</span>, orderId);
            }
            
            <span class="hljs-comment">// 计算退款金额</span>
            <span class="hljs-type">double</span> <span class="hljs-variable">refundRate</span> <span class="hljs-operator">=</span> <span class="hljs-number">1.0</span> - (damagePercent / <span class="hljs-number">100.0</span>);
            <span class="hljs-type">double</span> <span class="hljs-variable">refundAmount</span> <span class="hljs-operator">=</span> order.total * refundRate;
            
            <span class="hljs-comment">// 更新订单状态</span>
            order.status = <span class="hljs-string">"RETURN_PROCESSING"</span>;
            
            <span class="hljs-keyword">return</span> String.format(
                <span class="hljs-string">"Return request created: Order=%s, Reason=%s, "</span> +
                <span class="hljs-string">"RefundAmount=¥%.2f, RefundRate=%.0f%%, "</span> +
                <span class="hljs-string">"Status=RETURN_PROCESSING. Refund will be processed within 3-5 days."</span>,
                orderId, reason, refundAmount, refundRate * <span class="hljs-number">100</span>);
        }
        
        <span class="hljs-meta">@Tool(name = "escalate_to_human", 
              description = "Escalate issue to human agent")</span>
        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">escalateToHuman</span><span class="hljs-params">(
            <span class="hljs-meta">@ToolParam(name = "reason", description = "Reason for escalation")</span> 
                String reason,
            <span class="hljs-meta">@ToolParam(name = "priority", description = "Priority: normal, high, urgent")</span> 
                String priority)</span> {
            
            <span class="hljs-keyword">if</span> (!priority.matches(<span class="hljs-string">"(?i)normal|high|urgent"</span>)) {
                <span class="hljs-keyword">return</span> <span class="hljs-string">"Invalid priority. Must be: normal, high, or urgent."</span>;
            }
            
            <span class="hljs-comment">// 生产环境：创建升级工单，分配给人工客服</span>
            <span class="hljs-keyword">return</span> String.format(
                <span class="hljs-string">"Escalated to human agent. Reason: %s, Priority: %s. "</span> +
                <span class="hljs-string">"Ticket ID: TICKET_%d. "</span> +
                <span class="hljs-string">"Average wait time: 5 minutes."</span>,
                reason, priority, System.currentTimeMillis() % <span class="hljs-number">100000</span>);
        }
    }
    
    <span class="hljs-comment">// 第2步：订单模型</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Order</span> {
        String status;
        <span class="hljs-type">double</span> total;
        <span class="hljs-type">int</span> itemCount;
        String createdTime;
        String estimatedDelivery;
        
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">Order</span><span class="hljs-params">(String status, <span class="hljs-type">double</span> total, <span class="hljs-type">int</span> itemCount, 
                     String createdTime, String estimatedDelivery)</span> {
            <span class="hljs-built_in">this</span>.status = status;
            <span class="hljs-built_in">this</span>.total = total;
            <span class="hljs-built_in">this</span>.itemCount = itemCount;
            <span class="hljs-built_in">this</span>.createdTime = createdTime;
            <span class="hljs-built_in">this</span>.estimatedDelivery = estimatedDelivery;
        }
    }
    
    <span class="hljs-comment">// 第3步：初始化系统</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"=== 智能客服系统启动 ===\n"</span>);
        
        <span class="hljs-comment">// 创建模型</span>
        <span class="hljs-type">DashScopeChatModel</span> <span class="hljs-variable">model</span> <span class="hljs-operator">=</span> DashScopeChatModel.builder()
            .apiKey(System.getenv(<span class="hljs-string">"DASHSCOPE_API_KEY"</span>))
            .modelName(<span class="hljs-string">"qwen-plus"</span>)
            .requestTimeout(java.time.Duration.ofSeconds(<span class="hljs-number">30</span>))
            .build();
        
        <span class="hljs-comment">// 创建工具箱</span>
        <span class="hljs-type">Toolkit</span> <span class="hljs-variable">toolkit</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Toolkit</span>();
        <span class="hljs-type">CustomerServiceTools</span> <span class="hljs-variable">tools</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomerServiceTools</span>();
        
        <span class="hljs-comment">// 添加初始测试订单数据</span>
        tools.orderDatabase.put(<span class="hljs-string">"ORD-20240101-001"</span>,
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>(<span class="hljs-string">"DELIVERED"</span>, <span class="hljs-number">499.99</span>, <span class="hljs-number">2</span>, <span class="hljs-string">"2024-01-01 10:00:00"</span>, <span class="hljs-string">"2024-01-05"</span>));
        tools.orderDatabase.put(<span class="hljs-string">"ORD-20240110-002"</span>,
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>(<span class="hljs-string">"PROCESSING"</span>, <span class="hljs-number">1299.99</span>, <span class="hljs-number">1</span>, <span class="hljs-string">"2024-01-10 14:30:00"</span>, <span class="hljs-string">"2024-01-12"</span>));
        
        toolkit.registerObject(tools);
        
        <span class="hljs-comment">// 创建Agent（配置长期记忆用于学习客户信息）</span>
        <span class="hljs-type">ReActAgent</span> <span class="hljs-variable">agent</span> <span class="hljs-operator">=</span> ReActAgent.builder()
            .name(<span class="hljs-string">"CustomerServiceBot"</span>)
            .sysPrompt(
                <span class="hljs-string">"You are a professional e-commerce customer service agent. Your responsibilities:\n"</span> +
                <span class="hljs-string">"1. Answer FAQs about shipping, returns, warranty, etc.\n"</span> +
                <span class="hljs-string">"2. Query order status and provide details\n"</span> +
                <span class="hljs-string">"3. Handle return/refund requests fairly and efficiently\n"</span> +
                <span class="hljs-string">"4. Escalate complex issues to human agents when necessary\n"</span> +
                <span class="hljs-string">"5. Always be polite, professional, and solution-focused\n"</span> +
                <span class="hljs-string">"6. When you don't have enough info, ask clarifying questions\n"</span> +
                <span class="hljs-string">"\n"</span> +
                <span class="hljs-string">"Decision rules:\n"</span> +
                <span class="hljs-string">"- For simple FAQ questions: answer from FAQ knowledge\n"</span> +
                <span class="hljs-string">"- For order-related: first check order status\n"</span> +
                <span class="hljs-string">"- For returns: process if within policy (30 days, condition matters)\n"</span> +
                <span class="hljs-string">"- For disputes: escalate if customer is unhappy or value &gt; ¥5000"</span>
            )
            .model(model)
            .toolkit(toolkit)
            .maxIters(<span class="hljs-number">5</span>)  <span class="hljs-comment">// 限制推理循环次数，避免无限循环</span>
            .memory(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryMemory</span>())
            .build();
        
        <span class="hljs-comment">// 第4步：模拟客户对话</span>
        simulateConversations(agent);
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">simulateConversations</span><span class="hljs-params">(ReActAgent agent)</span> {
        <span class="hljs-comment">// 场景1：简单FAQ查询</span>
        System.out.println(<span class="hljs-string">"=== 场景1：FAQ查询 ==="</span>);
        simulateConversation(agent, 
            <span class="hljs-string">"请问你们的标准快递需要多长时间？"</span>);
        
        System.out.println(<span class="hljs-string">"\n=== 场景2：订单状态查询 ==="</span>);
        simulateConversation(agent, 
            <span class="hljs-string">"我想查询订单 ORD-20240101-001 的状态"</span>);
        
        System.out.println(<span class="hljs-string">"\n=== 场景3：处理退货请求 ==="</span>);
        simulateConversation(agent,
            <span class="hljs-string">"订单 ORD-20240110-002 的产品有问题，我想退货。"</span> +
            <span class="hljs-string">"产品完全没有使用过，我需要全额退款。"</span>);
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">simulateConversation</span><span class="hljs-params">(ReActAgent agent, String userInput)</span> {
        System.out.println(<span class="hljs-string">"Customer: "</span> + userInput);
        System.out.println(<span class="hljs-string">"---"</span>);
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Msg</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> agent.call(
                Msg.builder().textContent(userInput).build()
            ).block();
            
            System.out.println(<span class="hljs-string">"Agent: "</span> + response.getTextContent());
            
            <span class="hljs-comment">// 显示Token使用情况</span>
            <span class="hljs-keyword">if</span> (response.getChatUsage() != <span class="hljs-literal">null</span>) {
                System.out.printf(<span class="hljs-string">"\n[Token Usage] Input: %d, Output: %d, Total: %d\n"</span>,
                    response.getChatUsage().getInputTokens(),
                    response.getChatUsage().getOutputTokens(),
                    response.getChatUsage().getTotalTokens());
            }
        } <span class="hljs-keyword">catch</span> (Exception e) {
            System.err.println(<span class="hljs-string">"Error: "</span> + e.getMessage());
        }
    }
}
</code></pre>
<h4 data-id="heading-60">关键设计点</h4>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 工具系统设计：
   ✓ 每个工具职责单一
   ✓ 工具参数有清晰的描述
   ✓ 返回结果结构化，便于Agent理解
   ✓ 错误处理明确（返回错误信息而不是抛异常）

<span class="hljs-bullet">2.</span> Agent配置：
   ✓ 系统提示词清晰定义Agent的角色和决策规则
   ✓ maxIters=5 防止无限循环
   ✓ 使用InMemoryMemory保持会话上下文

<span class="hljs-bullet">3.</span> 生产考虑：
   ✓ 工具执行超时控制（RequestTimeout）
   ✓ Token使用监控（getChatUsage）
   ✓ 错误输入验证（如damagePercent的范围检查）
   ✓ 可扩展的工具架构（易于添加新工具）
</code></pre>
<h4 data-id="heading-61">数据量和性能调优</h4>



































<table><thead><tr><th>参数</th><th>建议值</th><th>说明</th></tr></thead><tbody><tr><td>maxIters</td><td>5-10</td><td>推理循环次数，过多会导致成本增加</td></tr><tr><td>model temperature</td><td>0.3-0.5</td><td>降低温度提高确定性和一致性</td></tr><tr><td>max_tokens</td><td>1000-2000</td><td>限制单次回复长度</td></tr><tr><td>内存消息数</td><td>100-500</td><td>超过此数量自动清理或压缩</td></tr><tr><td>并发Agent数</td><td>100-1000</td><td>根据服务器资源调整</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-62">总结</h2>
<h3 data-id="heading-63">核心要点回顾</h3>





























<table><thead><tr><th>方面</th><th>要点</th></tr></thead><tbody><tr><td><strong>What</strong></td><td>AgentScope-Java是生产级的AI智能体框架，核心是ReAct推理-行动循环</td></tr><tr><td><strong>Why</strong></td><td>解决LLM应用的可控性、多步骤管理、输出可靠性、知识库集成、工具生态等问题</td></tr><tr><td><strong>How</strong></td><td>通过Agent、工具、记忆、Hook、Pipeline等模块化组件，灵活组合构建智能应用</td></tr><tr><td><strong>何时用</strong></td><td>需要构建自主、可控、生产级的AI应用时</td></tr><tr><td><strong>何时不用</strong></td><td>简单的一次性提示工程，或者只需要基础的LLM调用</td></tr></tbody></table>
<hr/>
<p>在下一章中，我们将深入探讨**消息系统（Message）**的设计，了解如何在Agent之间进行高效、安全的通信。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[阿里开源AgentScope多智能体框架解析系列（三）第3章：模型接口（Model）与适配器模式]]></title>    <link>https://juejin.cn/post/7589308109639925795</link>    <guid>https://juejin.cn/post/7589308109639925795</guid>    <pubDate>2025-12-30T03:53:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589308109639925795" data-draft-id="7589275237037096995" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="阿里开源AgentScope多智能体框架解析系列（三）第3章：模型接口（Model）与适配器模式"/> <meta itemprop="keywords" content="Agent"/> <meta itemprop="datePublished" content="2025-12-30T03:53:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="语落心生"/> <meta itemprop="url" content="https://juejin.cn/user/2875978147955741"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            阿里开源AgentScope多智能体框架解析系列（三）第3章：模型接口（Model）与适配器模式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2875978147955741/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    语落心生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T03:53:34.000Z" title="Tue Dec 30 2025 03:53:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">总述</h2>
<p>模型（Model）是AgentScope中<strong>连接Agent与LLM的桥梁</strong>。通过Model接口和Formatter系统，AgentScope实现了对多个LLM厂商的统一抽象，使得开发者可以无缝切换不同的模型，而无需修改Agent逻辑。</p>
<p>本章将从<strong>Model接口设计、多模型支持、流式响应、生成参数、Formatter适配</strong>等方面，深入讲解AgentScope如何优雅地支持不同的LLM。</p>
<hr/>
<h2 data-id="heading-1">3.1 Model 接口设计</h2>
<h3 data-id="heading-2">3.1.1 为什么需要Model接口？</h3>
<h4 data-id="heading-3">现状问题</h4>
<p>在没有统一接口的情况下：</p>
<pre><code class="hljs language-arduino" lang="arduino">问题<span class="hljs-number">1</span>：代码与LLM耦合
├─ OpenAI API调用逻辑 与 Agent逻辑混杂
├─ 切换到Anthropic时，需要改写Agent代码
└─ 违反开闭原则

问题<span class="hljs-number">2</span>：消息格式不统一
├─ OpenAI要求特定的消息格式
├─ DashScope有自己的格式要求
├─ Agent无法统一处理消息

问题<span class="hljs-number">3</span>：功能差异处理复杂
├─ 不同LLM支持的功能不同（工具、视觉等）
├─ 在Agent中编写大量<span class="hljs-keyword">if</span>-<span class="hljs-keyword">else</span>判断
└─ 代码难以维护
</code></pre>
<h4 data-id="heading-4">AgentScope的解决方案：Model接口 + Formatter</h4>
<pre><code class="hljs language-markdown" lang="markdown">Agent ← → Model接口（统一） ← → Formatter ← → LLM API
<span class="hljs-code">        │                              │
        │                              ├─ OpenAIFormatter
        │                              ├─ DashScopeFormatter
        │                              ├─ AnthropicFormatter
        │                              └─ GeminiFormatter
        │
        └─ 不需要关心具体的LLM，只需调用Model接口
</span></code></pre>
<h3 data-id="heading-5">3.1.2 Model接口的核心方法</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Model</span> {
    
    <span class="hljs-comment">/**
     * 流式调用LLM
     * <span class="hljs-doctag">@param</span> messages 消息列表（统一的AgentScope Msg格式）
     * <span class="hljs-doctag">@param</span> tools 工具定义列表（可选）
     * <span class="hljs-doctag">@param</span> options 生成参数（可选）
     * <span class="hljs-doctag">@return</span> Flux&lt;ChatResponse&gt; 响应流
     */</span>
    Flux&lt;ChatResponse&gt; <span class="hljs-title function_">stream</span><span class="hljs-params">(
        List&lt;Msg&gt; messages,
        List&lt;ToolSchema&gt; tools,
        GenerateOptions options
    )</span>;
    
    <span class="hljs-comment">/**
     * 获取模型名称
     */</span>
    String <span class="hljs-title function_">getModelName</span><span class="hljs-params">()</span>;
}
</code></pre>
<p><strong>设计特点</strong>：</p>
<pre><code class="hljs language-swift" lang="swift">特点<span class="hljs-number">1</span>：响应式
<span class="hljs-operator">├─</span> 返回<span class="hljs-type">Flux</span>&lt;<span class="hljs-type">ChatResponse</span>&gt;，支持流式处理
<span class="hljs-operator">├─</span> 充分利用异步特性，提高吞吐量
<span class="hljs-operator">└─</span> 支持背压（<span class="hljs-type">Backpressure）</span>

特点<span class="hljs-number">2</span>：通用性
<span class="hljs-operator">├─</span> 所有参数都是<span class="hljs-type">AgentScope的统一格式</span>
<span class="hljs-operator">├─</span> <span class="hljs-type">Formatter负责转换为具体LLM的格式</span>
<span class="hljs-operator">└─</span> <span class="hljs-type">Agent无需关心LLM的具体类型</span>

特点<span class="hljs-number">3</span>：可扩展性
<span class="hljs-operator">├─</span> 新增<span class="hljs-type">LLM时，只需实现Model接口</span>
<span class="hljs-operator">├─</span> 编写对应的<span class="hljs-type">Formatter</span>
<span class="hljs-operator">└─</span> 既有代码无需修改
</code></pre>
<h3 data-id="heading-6">3.1.3 GenerateOptions - 生成参数</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// GenerateOptions用于控制LLM的行为</span>
<span class="hljs-type">GenerateOptions</span> <span class="hljs-variable">options</span> <span class="hljs-operator">=</span> GenerateOptions.builder()
    .temperature(<span class="hljs-number">0.7</span>)              <span class="hljs-comment">// 温度（0-1，越高越有创意）</span>
    .topP(<span class="hljs-number">0.9</span>)                     <span class="hljs-comment">// 核采样（影响多样性）</span>
    .maxTokens(<span class="hljs-number">2000</span>)               <span class="hljs-comment">// 最大输出token数</span>
    .frequencyPenalty(<span class="hljs-number">0.5</span>)         <span class="hljs-comment">// 频率惩罚（抑制重复）</span>
    .presencePenalty(<span class="hljs-number">0.5</span>)          <span class="hljs-comment">// 存在惩罚（鼓励新话题）</span>
    .stop(List.of(<span class="hljs-string">"END"</span>))          <span class="hljs-comment">// 停止词</span>
    .seed(<span class="hljs-number">42</span>)                      <span class="hljs-comment">// 随机种子（复现结果）</span>
    .toolChoice(ToolChoice.AUTO)   <span class="hljs-comment">// 工具选择策略</span>
    .executionConfig(ExecutionConfig.builder()
        .timeout(Duration.ofMinutes(<span class="hljs-number">1</span>))
        .maxAttempts(<span class="hljs-number">3</span>)            <span class="hljs-comment">// 重试次数</span>
        .build())
    .build();

<span class="hljs-type">Msg</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> agent.call(userMsg, options).block();
</code></pre>
<h4 data-id="heading-7">参数详解</h4>









































<table><thead><tr><th>参数</th><th>范围</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td>temperature</td><td>0-2</td><td>0.7</td><td>控制输出的随机性，越高越有创意</td></tr><tr><td>topP</td><td>0-1</td><td>0.9</td><td>核采样，用top_p比例最可能的token</td></tr><tr><td>maxTokens</td><td>1+</td><td>默认值</td><td>限制单次输出的最大token数</td></tr><tr><td>frequencyPenalty</td><td>-2-2</td><td>0</td><td>对重复token的惩罚</td></tr><tr><td>presencePenalty</td><td>-2-2</td><td>0</td><td>鼓励模型引入新概念</td></tr></tbody></table>
<h4 data-id="heading-8">生产场景：根据用途调整参数</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 场景1：创意写作（需要多样性）</span>
<span class="hljs-type">GenerateOptions</span> <span class="hljs-variable">creativeOptions</span> <span class="hljs-operator">=</span> GenerateOptions.builder()
    .temperature(<span class="hljs-number">1.2</span>)     <span class="hljs-comment">// 更高的创意度</span>
    .topP(<span class="hljs-number">0.95</span>)           <span class="hljs-comment">// 更多的多样性</span>
    .maxTokens(<span class="hljs-number">4000</span>)      <span class="hljs-comment">// 允许更长的输出</span>
    .build();

<span class="hljs-type">Msg</span> <span class="hljs-variable">story</span> <span class="hljs-operator">=</span> agent.call(userMsg, creativeOptions).block();

<span class="hljs-comment">// 场景2：技术问答（需要准确性）</span>
<span class="hljs-type">GenerateOptions</span> <span class="hljs-variable">technicalOptions</span> <span class="hljs-operator">=</span> GenerateOptions.builder()
    .temperature(<span class="hljs-number">0.3</span>)     <span class="hljs-comment">// 低温度，更确定的答案</span>
    .topP(<span class="hljs-number">0.8</span>)            <span class="hljs-comment">// 更保守的采样</span>
    .maxTokens(<span class="hljs-number">1000</span>)      <span class="hljs-comment">// 简明扼要</span>
    .build();

<span class="hljs-type">Msg</span> <span class="hljs-variable">answer</span> <span class="hljs-operator">=</span> agent.call(userMsg, technicalOptions).block();

<span class="hljs-comment">// 场景3：代码生成（需要格式正确）</span>
<span class="hljs-type">GenerateOptions</span> <span class="hljs-variable">codeOptions</span> <span class="hljs-operator">=</span> GenerateOptions.builder()
    .temperature(<span class="hljs-number">0.2</span>)     <span class="hljs-comment">// 非常低，确保格式</span>
    .stop(List.of(<span class="hljs-string">"```"</span>, <span class="hljs-string">"\n\n"</span>))  <span class="hljs-comment">// 停止词</span>
    .maxTokens(<span class="hljs-number">2000</span>)
    .build();

<span class="hljs-type">Msg</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span> agent.call(userMsg, codeOptions).block();
</code></pre>
<hr/>
<h2 data-id="heading-9">3.2 多模型支持</h2>
<h3 data-id="heading-10">3.2.1 支持的LLM厂商</h3>
<h4 data-id="heading-11">1. DashScope（阿里云通义千问）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 创建DashScope模型</span>
<span class="hljs-type">DashScopeChatModel</span> <span class="hljs-variable">model</span> <span class="hljs-operator">=</span> DashScopeChatModel.builder()
    .apiKey(System.getenv(<span class="hljs-string">"DASHSCOPE_API_KEY"</span>))
    .modelName(<span class="hljs-string">"qwen-plus"</span>)         <span class="hljs-comment">// 或 qwen-turbo, qwen-max等</span>
    .requestTimeout(Duration.ofSeconds(<span class="hljs-number">30</span>))
    .build();

<span class="hljs-comment">// 在ReActAgent中使用</span>
<span class="hljs-type">ReActAgent</span> <span class="hljs-variable">agent</span> <span class="hljs-operator">=</span> ReActAgent.builder()
    .name(<span class="hljs-string">"Assistant"</span>)
    .model(model)
    .build();
</code></pre>
<p><strong>DashScope优势</strong>：</p>
<pre><code class="hljs">✓ 国内厂商，延迟低，价格便宜
✓ 支持中文优化
✓ 支持长文本输入（200K tokens）
✓ 支持推理模式（qwen-reasoning）
</code></pre>
<h4 data-id="heading-12">2. OpenAI GPT</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 创建OpenAI模型</span>
<span class="hljs-type">OpenAIChatModel</span> <span class="hljs-variable">model</span> <span class="hljs-operator">=</span> OpenAIChatModel.builder()
    .apiKey(System.getenv(<span class="hljs-string">"OPENAI_API_KEY"</span>))
    .modelName(<span class="hljs-string">"gpt-4o"</span>)            <span class="hljs-comment">// 或 gpt-4-turbo, gpt-3.5-turbo</span>
    .baseUrl(<span class="hljs-string">"https://api.openai.com/v1"</span>)  <span class="hljs-comment">// 支持自定义端点</span>
    .build();

<span class="hljs-type">ReActAgent</span> <span class="hljs-variable">agent</span> <span class="hljs-operator">=</span> ReActAgent.builder()
    .model(model)
    .build();
</code></pre>
<p><strong>OpenAI优势</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript">✓ 业界标准，功能完整
✓ 支持<span class="hljs-title class_">Vision</span>（图像理解）
✓ 支持<span class="hljs-title class_">JSON</span> <span class="hljs-title class_">Mode</span>（结构化输出）
✓ 社区资源丰富
</code></pre>
<h4 data-id="heading-13">3. Anthropic Claude</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 创建Anthropic模型</span>
<span class="hljs-type">AnthropicChatModel</span> <span class="hljs-variable">model</span> <span class="hljs-operator">=</span> AnthropicChatModel.builder()
    .apiKey(System.getenv(<span class="hljs-string">"ANTHROPIC_API_KEY"</span>))
    .modelName(<span class="hljs-string">"claude-sonnet-4-5"</span>)  <span class="hljs-comment">// 最新Claude模型</span>
    .build();

<span class="hljs-type">ReActAgent</span> <span class="hljs-variable">agent</span> <span class="hljs-operator">=</span> ReActAgent.builder()
    .model(model)
    .build();
</code></pre>
<p><strong>Claude优势</strong>：</p>
<pre><code class="hljs">✓ 推理能力强
✓ 支持思考过程（可见推理步骤）
✓ 100K文本窗口（某些版本支持200K）
✓ 安全性好
</code></pre>
<h4 data-id="heading-14">4. Google Gemini</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 方式1：使用Gemini API</span>
<span class="hljs-type">GeminiChatModel</span> <span class="hljs-variable">model</span> <span class="hljs-operator">=</span> GeminiChatModel.builder()
    .apiKey(System.getenv(<span class="hljs-string">"GEMINI_API_KEY"</span>))
    .modelName(<span class="hljs-string">"gemini-2.0-flash"</span>)
    .build();

<span class="hljs-comment">// 方式2：使用Vertex AI（GCP）</span>
<span class="hljs-type">GeminiChatModel</span> <span class="hljs-variable">model</span> <span class="hljs-operator">=</span> GeminiChatModel.builder()
    .modelName(<span class="hljs-string">"gemini-2.0-flash"</span>)
    .project(<span class="hljs-string">"your-gcp-project-id"</span>)
    .location(<span class="hljs-string">"us-central1"</span>)
    .vertexAI(<span class="hljs-literal">true</span>)
    .build();

<span class="hljs-type">ReActAgent</span> <span class="hljs-variable">agent</span> <span class="hljs-operator">=</span> ReActAgent.builder()
    .model(model)
    .build();
</code></pre>
<p><strong>Gemini优势</strong>：</p>
<pre><code class="hljs">✓ 支持多模态（视觉、音频）
✓ 上下文窗口大（1000K+）
✓ 推理能力强
✓ 价格有竞争力
</code></pre>
<h3 data-id="heading-15">3.2.2 模型兼容性与选择指南</h3>
<pre><code class="hljs language-scss" lang="scss">选择标准：

┌─ 功能需求
│  ├─ 需要Vision（图像理解）？ → OpenAI/Claude/Gemini
│  ├─ 需要推理能力？ → Claude/Gemini/<span class="hljs-built_in">DashScope</span>(qwen-reasoning)
│  ├─ 需要长文本？ → <span class="hljs-built_in">Gemini</span>(<span class="hljs-number">1</span>M) &gt; <span class="hljs-built_in">DashScope</span>(<span class="hljs-number">200</span>K) &gt; <span class="hljs-built_in">Claude</span>(<span class="hljs-number">100</span>K)
│  └─ 需要结构化输出？ → <span class="hljs-built_in">OpenAI</span>(JSON Mode) ✓
│
├─ 成本考虑
│  ├─ 成本敏感 → <span class="hljs-built_in">DashScope</span>(最便宜)
│  ├─ 均衡 → OpenAI/Anthropic
│  └─ 不限成本 → <span class="hljs-built_in">Claude</span>(质量最好)
│
└─ 地理位置
   ├─ 国内 → DashScope（低延迟）
   ├─ 国际 → OpenAI（稳定性好）
   └─ GCP用户 → Gemini/Vertex AI
</code></pre>
<h3 data-id="heading-16">3.2.3 多模型管理</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 场景：同时使用多个模型</span>

<span class="hljs-comment">// 快速回复用便宜的模型</span>
<span class="hljs-type">Model</span> <span class="hljs-variable">fastModel</span> <span class="hljs-operator">=</span> DashScopeChatModel.builder()
    .apiKey(System.getenv(<span class="hljs-string">"DASHSCOPE_API_KEY"</span>))
    .modelName(<span class="hljs-string">"qwen-turbo"</span>)  <span class="hljs-comment">// 快速且便宜</span>
    .build();

<span class="hljs-comment">// 复杂任务用强大的模型</span>
<span class="hljs-type">Model</span> <span class="hljs-variable">powerfulModel</span> <span class="hljs-operator">=</span> OpenAIChatModel.builder()
    .apiKey(System.getenv(<span class="hljs-string">"OPENAI_API_KEY"</span>))
    .modelName(<span class="hljs-string">"gpt-4o"</span>)      <span class="hljs-comment">// 功能全面</span>
    .build();

<span class="hljs-comment">// 路由决策</span>
<span class="hljs-keyword">public</span> Model <span class="hljs-title function_">selectModel</span><span class="hljs-params">(String taskType)</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">switch</span>(taskType) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">"chat"</span> -&gt; fastModel;        <span class="hljs-comment">// 简单对话用快速模型</span>
        <span class="hljs-keyword">case</span> <span class="hljs-string">"analysis"</span> -&gt; powerfulModel; <span class="hljs-comment">// 复杂分析用强大模型</span>
        <span class="hljs-keyword">case</span> <span class="hljs-string">"vision"</span> -&gt; visionModel;     <span class="hljs-comment">// 视觉任务用Vision模型</span>
        <span class="hljs-keyword">default</span> -&gt; fastModel;
    };
}

<span class="hljs-comment">// Agent中使用</span>
<span class="hljs-type">ReActAgent</span> <span class="hljs-variable">agent</span> <span class="hljs-operator">=</span> ReActAgent.builder()
    .name(<span class="hljs-string">"SmartAssistant"</span>)
    .model(selectModel(taskType))  <span class="hljs-comment">// 动态选择模型</span>
    .build();
</code></pre>
<hr/>
<h2 data-id="heading-17">3.3 流式响应与响应式编程</h2>
<h3 data-id="heading-18">3.3.1 为什么使用流式响应？</h3>
<h4 data-id="heading-19">传统非流式方式的问题</h4>
<pre><code class="hljs language-markdown" lang="markdown">用户输入 → 等待... → 等待... → 模型完成 → 返回完整回复
<span class="hljs-code">                    (延迟感很强)
</span></code></pre>
<h4 data-id="heading-20">流式响应的优势</h4>
<pre><code class="hljs language-markdown" lang="markdown">用户输入 → Token1 → Token2 → Token3 → ... → 完成
<span class="hljs-code">          (实时展示，用户感到更快)
</span></code></pre>
<p><strong>生产价值</strong>：</p>
<pre><code class="hljs">✓ 用户体验更好（实时反馈，不显得卡顿）
✓ 支持实时展示推理过程（如Claude的思考过程）
✓ 更快发现错误（如工具调用错误）
✓ 支持大文本输出（不需等待全部生成）
</code></pre>
<h3 data-id="heading-21">3.3.2 流式API的使用</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 方式1：基础的流式处理</span>
Flux&lt;ChatResponse&gt; responses = model.stream(
    List.of(userMessage),
    <span class="hljs-literal">null</span>,  <span class="hljs-comment">// 没有工具</span>
    <span class="hljs-literal">null</span>   <span class="hljs-comment">// 使用默认参数</span>
);

responses.subscribe(
    response -&gt; System.out.print(extractText(response)),  <span class="hljs-comment">// 每收到一个chunk就打印</span>
    error -&gt; System.err.println(<span class="hljs-string">"Error: "</span> + error),
    () -&gt; System.out.println(<span class="hljs-string">"\n[完成]"</span>)
);

<span class="hljs-comment">// 方式2：收集所有responses后处理</span>
<span class="hljs-type">String</span> <span class="hljs-variable">fullResponse</span> <span class="hljs-operator">=</span> responses
    .map(response -&gt; extractText(response))
    .collect(Collectors.joining())
    .block();  <span class="hljs-comment">// 等待全部完成</span>
System.out.println(fullResponse);

<span class="hljs-comment">// 方式3：处理时进行过滤和转换</span>
responses
    .filter(response -&gt; response.getContent() != <span class="hljs-literal">null</span> &amp;&amp; !response.getContent().isEmpty())
    .map(response -&gt; extractText(response))
    .doOnNext(chunk -&gt; updateUI(chunk))  <span class="hljs-comment">// 更新UI</span>
    .onErrorResume(error -&gt; handleError(error))
    .doFinally(signal -&gt; cleanup())
    .subscribe();
</code></pre>
<h3 data-id="heading-22">3.3.3 实时推理过程展示</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 某些模型（如Claude）支持返回思考过程</span>

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">demonstrateReasoningStream</span><span class="hljs-params">()</span> {
    <span class="hljs-type">ReActAgent</span> <span class="hljs-variable">agent</span> <span class="hljs-operator">=</span> ReActAgent.builder()
        .name(<span class="hljs-string">"ThinkingBot"</span>)
        .model(AnthropicChatModel.builder()
            .apiKey(System.getenv(<span class="hljs-string">"ANTHROPIC_API_KEY"</span>))
            .modelName(<span class="hljs-string">"claude-opus"</span>)  <span class="hljs-comment">// 支持思考过程的模型</span>
            .build())
        .build();
    
    <span class="hljs-comment">// 流式调用</span>
    agent.stream(
        Msg.builder().textContent(<span class="hljs-string">"解释量子计算的基本原理"</span>)
        .build()
    ).subscribe(event -&gt; {
        <span class="hljs-comment">// 根据事件类型处理</span>
        <span class="hljs-keyword">switch</span>(event) {
            <span class="hljs-keyword">case</span> ReasoningChunkEvent reasoning -&gt; 
                System.out.print(<span class="hljs-string">"💭 "</span> + reasoning.getDelta());  <span class="hljs-comment">// 显示思考过程</span>
            <span class="hljs-keyword">case</span> ActingChunkEvent acting -&gt; 
                System.out.print(<span class="hljs-string">"🔧 "</span> + acting.getDelta());     <span class="hljs-comment">// 显示工具调用</span>
            <span class="hljs-keyword">default</span> -&gt; 
                System.out.print(<span class="hljs-string">"📝 "</span> + event.getDelta());      <span class="hljs-comment">// 显示最终答案</span>
        }
    });
}
</code></pre>
<h3 data-id="heading-23">3.3.4 WebSocket实时流式传输</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Spring Boot Controller示例：实时流式输出</span>

<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/api/agent")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AgentController</span> {
    
    <span class="hljs-meta">@PostMapping(value = "/stream", produces = MediaType.TEXT_EVENT_STREAM_VALUE)</span>
    <span class="hljs-keyword">public</span> SseEmitter <span class="hljs-title function_">stream</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> String userInput)</span> {
        <span class="hljs-type">SseEmitter</span> <span class="hljs-variable">emitter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SseEmitter</span>(<span class="hljs-number">60000L</span>);  <span class="hljs-comment">// 60秒超时</span>
        
        Executors.newSingleThreadExecutor().execute(() -&gt; {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 调用Agent的流式API</span>
                agent.stream(
                    Msg.builder().textContent(userInput).build()
                ).subscribe(
                    event -&gt; {
                        <span class="hljs-keyword">try</span> {
                            <span class="hljs-comment">// 实时发送给客户端</span>
                            emitter.send(SseEmitter.event()
                                .id(event.getMessageId())
                                .data(event.getDelta())
                                .build());
                        } <span class="hljs-keyword">catch</span> (IOException e) {
                            emitter.completeWithError(e);
                        }
                    },
                    error -&gt; {
                        <span class="hljs-keyword">try</span> {
                            emitter.send(SseEmitter.event()
                                .id(<span class="hljs-string">"error"</span>)
                                .data(<span class="hljs-string">"Error: "</span> + error.getMessage())
                                .build());
                            emitter.complete();
                        } <span class="hljs-keyword">catch</span> (IOException e) {
                            emitter.completeWithError(e);
                        }
                    },
                    () -&gt; {
                        <span class="hljs-keyword">try</span> {
                            emitter.send(SseEmitter.event()
                                .id(<span class="hljs-string">"done"</span>)
                                .data(<span class="hljs-string">"完成"</span>)
                                .build());
                            emitter.complete();
                        } <span class="hljs-keyword">catch</span> (IOException e) {
                            emitter.completeWithError(e);
                        }
                    }
                );
            } <span class="hljs-keyword">catch</span> (Exception e) {
                emitter.completeWithError(e);
            }
        });
        
        <span class="hljs-keyword">return</span> emitter;
    }
}

<span class="hljs-comment">// 前端JavaScript代码</span>
<span class="hljs-type">const</span> <span class="hljs-variable">eventSource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EventSource</span>(<span class="hljs-string">'/api/agent/stream'</span>, {
    method: <span class="hljs-string">'POST'</span>,
    body: JSON.stringify({userInput: <span class="hljs-string">"你好"</span>})
});

eventSource.onmessage = (event) =&gt; {
    <span class="hljs-keyword">if</span> (event.id === <span class="hljs-string">'done'</span>) {
        eventSource.close();
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (event.id === <span class="hljs-string">'error'</span>) {
        console.error(event.data);
    } <span class="hljs-keyword">else</span> {
        document.getElementById(<span class="hljs-string">'response'</span>).innerHTML += event.data;
    }
};
</code></pre>
<hr/>
<h2 data-id="heading-24">3.4 Formatter与消息格式转换</h2>
<h3 data-id="heading-25">3.4.1 为什么需要Formatter？</h3>
<p>每个LLM提供商的API格式都不同：</p>
<pre><code class="hljs language-json" lang="json">DashScope期望的格式：
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"model"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"qwen-plus"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"messages"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"role"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"user"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>...<span class="hljs-punctuation">]</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"parameters"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"temperature"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.7</span><span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>

OpenAI期望的格式：
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"model"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"gpt-4"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"messages"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"role"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"user"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>...<span class="hljs-punctuation">]</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"temperature"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.7</span>
<span class="hljs-punctuation">}</span>

Anthropic期望的格式：
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"model"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"claude-opus"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"messages"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"role"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"user"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>...<span class="hljs-punctuation">]</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"temperature"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.7</span>
<span class="hljs-punctuation">}</span>

Gemini期望的格式：
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"generationConfig"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"temperature"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.7</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"contents"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"role"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"user"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"parts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>...<span class="hljs-punctuation">]</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>Formatter的作用</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">AgentScope Msg格式 
<span class="hljs-code">    ↓ (Formatter转换)
    ├─ DashScopeFormatter → DashScope API格式
    ├─ OpenAIFormatter → OpenAI API格式
    ├─ AnthropicFormatter → Anthropic API格式
    └─ GeminiFormatter → Gemini API格式
</span></code></pre>
<h3 data-id="heading-26">3.4.2 Formatter的自动选择</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 方式1：自动使用默认Formatter</span>
<span class="hljs-type">DashScopeChatModel</span> <span class="hljs-variable">model1</span> <span class="hljs-operator">=</span> DashScopeChatModel.builder()
    .apiKey(key)
    .modelName(<span class="hljs-string">"qwen-plus"</span>)
    <span class="hljs-comment">// 自动使用 DashScopeChatFormatter</span>
    .build();

<span class="hljs-comment">// 方式2：显式指定Formatter</span>
<span class="hljs-type">DashScopeChatModel</span> <span class="hljs-variable">model2</span> <span class="hljs-operator">=</span> DashScopeChatModel.builder()
    .apiKey(key)
    .modelName(<span class="hljs-string">"qwen-plus"</span>)
    .formatter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DashScopeMultiAgentFormatter</span>())  <span class="hljs-comment">// 用于多Agent场景</span>
    .build();

<span class="hljs-comment">// 方式3：自定义Formatter</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomFormatter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Formatter</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">format</span><span class="hljs-params">(List&lt;Msg&gt; messages, List&lt;ToolSchema&gt; tools)</span> {
        <span class="hljs-comment">// 自定义格式化逻辑</span>
        <span class="hljs-keyword">return</span> customFormattedRequest;
    }
}

<span class="hljs-type">DashScopeChatModel</span> <span class="hljs-variable">model3</span> <span class="hljs-operator">=</span> DashScopeChatModel.builder()
    .apiKey(key)
    .modelName(<span class="hljs-string">"qwen-plus"</span>)
    .formatter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomFormatter</span>())
    .build();
</code></pre>
<h3 data-id="heading-27">3.4.3 多模态内容的Formatter处理</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 包含图像的消息如何转换？</span>

<span class="hljs-type">Msg</span> <span class="hljs-variable">multimodalMsg</span> <span class="hljs-operator">=</span> Msg.builder()
    .role(MsgRole.USER)
    .content(
        TextBlock.builder().text(<span class="hljs-string">"分析这张图片"</span>).build(),
        ImageBlock.builder()
            .source(Base64Source.builder()
                .data(base64Image)
                .mediaType(<span class="hljs-string">"image/png"</span>)
                .build())
            .build()
    )
    .build();

<span class="hljs-comment">// DashScopeFormatter转换后：</span>
<span class="hljs-comment">/*
{
  "messages": [{
    "role": "user",
    "content": [
      {"type": "text", "text": "分析这张图片"},
      {"type": "image", "image": "base64_image_data"}
    ]
  }]
}
*/</span>

<span class="hljs-comment">// OpenAIFormatter转换后：</span>
<span class="hljs-comment">/*
{
  "messages": [{
    "role": "user",
    "content": [
      {"type": "text", "text": "分析这张图片"},
      {"type": "image_url", "image_url": {"url": "data:image/png;base64,..."}}
    ]
  }]
}
*/</span>
</code></pre>
<hr/>
<h2 data-id="heading-28">3.5 生产场景示例</h2>
<h3 data-id="heading-29">3.5.1 多模型智能路由</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IntelligentModelRouter</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DashScopeChatModel fastModel;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> OpenAIChatModel standardModel;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AnthropicChatModel powerfulModel;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">IntelligentModelRouter</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">this</span>.fastModel = DashScopeChatModel.builder()
            .apiKey(System.getenv(<span class="hljs-string">"DASHSCOPE_API_KEY"</span>))
            .modelName(<span class="hljs-string">"qwen-turbo"</span>)
            .build();
        
        <span class="hljs-built_in">this</span>.standardModel = OpenAIChatModel.builder()
            .apiKey(System.getenv(<span class="hljs-string">"OPENAI_API_KEY"</span>))
            .modelName(<span class="hljs-string">"gpt-4o"</span>)
            .build();
        
        <span class="hljs-built_in">this</span>.powerfulModel = AnthropicChatModel.builder()
            .apiKey(System.getenv(<span class="hljs-string">"ANTHROPIC_API_KEY"</span>))
            .modelName(<span class="hljs-string">"claude-opus"</span>)
            .build();
    }
    
    <span class="hljs-comment">/**
     * 根据任务复杂度和成本约束选择最优模型
     */</span>
    <span class="hljs-keyword">public</span> Model <span class="hljs-title function_">selectModel</span><span class="hljs-params">(String userQuery, QueryContext context)</span> {
        <span class="hljs-comment">// 分析查询复杂度</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">complexity</span> <span class="hljs-operator">=</span> analyzeComplexity(userQuery);
        <span class="hljs-type">double</span> <span class="hljs-variable">costBudget</span> <span class="hljs-operator">=</span> context.getCostBudget();
        
        <span class="hljs-comment">// 简单查询 + 有成本限制 → 快速模型</span>
        <span class="hljs-keyword">if</span> (complexity &lt; <span class="hljs-number">3</span> &amp;&amp; costBudget &lt; <span class="hljs-number">0.01</span>) {
            <span class="hljs-keyword">return</span> fastModel;
        }
        
        <span class="hljs-comment">// 中等复杂度 → 标准模型</span>
        <span class="hljs-keyword">if</span> (complexity &lt; <span class="hljs-number">6</span>) {
            <span class="hljs-keyword">return</span> standardModel;
        }
        
        <span class="hljs-comment">// 复杂任务 + 无成本限制 → 强大模型</span>
        <span class="hljs-keyword">if</span> (costBudget &gt; <span class="hljs-number">0.1</span>) {
            <span class="hljs-keyword">return</span> powerfulModel;
        }
        
        <span class="hljs-comment">// 默认使用标准模型</span>
        <span class="hljs-keyword">return</span> standardModel;
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">analyzeComplexity</span><span class="hljs-params">(String query)</span> {
        <span class="hljs-comment">// 基于关键词估算复杂度</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">complexity</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">if</span> (query.contains(<span class="hljs-string">"分析"</span>)) complexity += <span class="hljs-number">2</span>;
        <span class="hljs-keyword">if</span> (query.contains(<span class="hljs-string">"对比"</span>)) complexity += <span class="hljs-number">2</span>;
        <span class="hljs-keyword">if</span> (query.contains(<span class="hljs-string">"推理"</span>)) complexity += <span class="hljs-number">3</span>;
        <span class="hljs-keyword">if</span> (query.contains(<span class="hljs-string">"代码"</span>)) complexity += <span class="hljs-number">2</span>;
        <span class="hljs-keyword">return</span> complexity;
    }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processQuery</span><span class="hljs-params">(String userQuery)</span> {
    <span class="hljs-type">IntelligentModelRouter</span> <span class="hljs-variable">router</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntelligentModelRouter</span>();
    <span class="hljs-type">QueryContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryContext</span>()
        .setCostBudget(<span class="hljs-number">0.05</span>);  <span class="hljs-comment">// 5分钱的成本限制</span>
    
    <span class="hljs-type">Model</span> <span class="hljs-variable">selectedModel</span> <span class="hljs-operator">=</span> router.selectModel(userQuery, context);
    
    <span class="hljs-type">ReActAgent</span> <span class="hljs-variable">agent</span> <span class="hljs-operator">=</span> ReActAgent.builder()
        .name(<span class="hljs-string">"SmartAssistant"</span>)
        .model(selectedModel)
        .build();
    
    <span class="hljs-type">Msg</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> agent.call(
        Msg.builder().textContent(userQuery).build()
    ).block();
    
    System.out.println(<span class="hljs-string">"Response: "</span> + response.getTextContent());
    System.out.println(<span class="hljs-string">"Model: "</span> + selectedModel.getModelName());
}
</code></pre>
<h3 data-id="heading-30">3.5.2 带超时和重试的模型调用</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">robustModelCall</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 配置超时和重试</span>
    <span class="hljs-type">ExecutionConfig</span> <span class="hljs-variable">execConfig</span> <span class="hljs-operator">=</span> ExecutionConfig.builder()
        .timeout(Duration.ofMinutes(<span class="hljs-number">2</span>))        <span class="hljs-comment">// 2分钟超时</span>
        .maxAttempts(<span class="hljs-number">3</span>)                        <span class="hljs-comment">// 最多重试3次</span>
        .initialBackoff(Duration.ofSeconds(<span class="hljs-number">1</span>)) <span class="hljs-comment">// 首次重试延迟1秒</span>
        .maxBackoff(Duration.ofSeconds(<span class="hljs-number">10</span>))    <span class="hljs-comment">// 最大延迟10秒</span>
        .backoffMultiplier(<span class="hljs-number">2.0</span>)                <span class="hljs-comment">// 每次延迟翻倍</span>
        .build();
    
    <span class="hljs-type">GenerateOptions</span> <span class="hljs-variable">options</span> <span class="hljs-operator">=</span> GenerateOptions.builder()
        .executionConfig(execConfig)
        .temperature(<span class="hljs-number">0.7</span>)
        .maxTokens(<span class="hljs-number">1000</span>)
        .build();
    
    <span class="hljs-type">ReActAgent</span> <span class="hljs-variable">agent</span> <span class="hljs-operator">=</span> ReActAgent.builder()
        .name(<span class="hljs-string">"RobustAgent"</span>)
        .model(DashScopeChatModel.builder()
            .apiKey(System.getenv(<span class="hljs-string">"DASHSCOPE_API_KEY"</span>))
            .modelName(<span class="hljs-string">"qwen-plus"</span>)
            .build())
        .maxIters(<span class="hljs-number">5</span>)  <span class="hljs-comment">// Agent最多5轮推理</span>
        .build();
    
    <span class="hljs-keyword">try</span> {
        <span class="hljs-type">Msg</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> agent.call(
            Msg.builder().textContent(<span class="hljs-string">"请解释量子计算"</span>).build(),
            options  <span class="hljs-comment">// 使用超时和重试配置</span>
        ).timeout(Duration.ofMinutes(<span class="hljs-number">3</span>))  <span class="hljs-comment">// 总超时3分钟</span>
         .onErrorMap(TimeoutException.class, 
                     e -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"模型响应超时，请重试"</span>))
         .block();
        
        System.out.println(<span class="hljs-string">"Success: "</span> + response.getTextContent());
    } <span class="hljs-keyword">catch</span> (Exception e) {
        System.err.println(<span class="hljs-string">"Failed after retries: "</span> + e.getMessage());
        <span class="hljs-comment">// 降级处理：使用缓存或提供预设答案</span>
    }
}
</code></pre>
<h3 data-id="heading-31">3.5.3 Token使用监控与成本计算</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ModelCostTracker</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, Double&gt; tokenPrices = Map.ofEntries(
        <span class="hljs-comment">// 价格/1K tokens</span>
        Map.entry(<span class="hljs-string">"qwen-turbo-input"</span>, <span class="hljs-number">0.0001</span>),
        Map.entry(<span class="hljs-string">"qwen-turbo-output"</span>, <span class="hljs-number">0.0002</span>),
        Map.entry(<span class="hljs-string">"gpt-4o-input"</span>, <span class="hljs-number">0.015</span>),
        Map.entry(<span class="hljs-string">"gpt-4o-output"</span>, <span class="hljs-number">0.06</span>),
        Map.entry(<span class="hljs-string">"claude-opus-input"</span>, <span class="hljs-number">0.015</span>),
        Map.entry(<span class="hljs-string">"claude-opus-output"</span>, <span class="hljs-number">0.075</span>)
    );
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">calculateCost</span><span class="hljs-params">(String modelName, ChatUsage usage)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">inputKey</span> <span class="hljs-operator">=</span> modelName + <span class="hljs-string">"-input"</span>;
        <span class="hljs-type">String</span> <span class="hljs-variable">outputKey</span> <span class="hljs-operator">=</span> modelName + <span class="hljs-string">"-output"</span>;
        
        <span class="hljs-type">double</span> <span class="hljs-variable">inputCost</span> <span class="hljs-operator">=</span> (usage.getInputTokens() * 
                           tokenPrices.getOrDefault(inputKey, <span class="hljs-number">0.0</span>)) / <span class="hljs-number">1000</span>;
        <span class="hljs-type">double</span> <span class="hljs-variable">outputCost</span> <span class="hljs-operator">=</span> (usage.getOutputTokens() * 
                            tokenPrices.getOrDefault(outputKey, <span class="hljs-number">0.0</span>)) / <span class="hljs-number">1000</span>;
        
        <span class="hljs-keyword">return</span> inputCost + outputCost;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">trackAndLog</span><span class="hljs-params">(Msg response, String modelName)</span> {
        <span class="hljs-type">ChatUsage</span> <span class="hljs-variable">usage</span> <span class="hljs-operator">=</span> response.getChatUsage();
        <span class="hljs-keyword">if</span> (usage == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;
        
        <span class="hljs-type">double</span> <span class="hljs-variable">cost</span> <span class="hljs-operator">=</span> calculateCost(modelName, usage);
        <span class="hljs-type">double</span> <span class="hljs-variable">costPerToken</span> <span class="hljs-operator">=</span> (cost / usage.getTotalTokens()) * <span class="hljs-number">1000</span>;
        
        System.out.printf(
            <span class="hljs-string">"Model: %s | Tokens: %d/%d | Cost: ¥%.4f (¥%.4f/1K)\n"</span>,
            modelName,
            usage.getInputTokens(),
            usage.getOutputTokens(),
            cost,
            costPerToken
        );
        
        <span class="hljs-comment">// 保存到数据库用于成本分析</span>
        saveCostMetrics(modelName, usage, cost);
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveCostMetrics</span><span class="hljs-params">(String modelName, ChatUsage usage, <span class="hljs-type">double</span> cost)</span> {
        <span class="hljs-comment">// 存储到数据库或监控系统</span>
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-32">总结</h2>
<h3 data-id="heading-33">核心概念回顾</h3>





























<table><thead><tr><th>概念</th><th>说明</th></tr></thead><tbody><tr><td><strong>Model接口</strong></td><td>统一的LLM接口，屏蔽不同厂商的差异</td></tr><tr><td><strong>多模型支持</strong></td><td>支持DashScope、OpenAI、Anthropic、Gemini等</td></tr><tr><td><strong>流式响应</strong></td><td>实时推送Token，提升用户体验</td></tr><tr><td><strong>Formatter</strong></td><td>自动转换消息格式适配不同LLM</td></tr><tr><td><strong>GenerateOptions</strong></td><td>灵活的生成参数控制</td></tr></tbody></table>
<h3 data-id="heading-34">实现要点</h3>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 适配器模式的应用
   └─ Model接口 + 多个实现 + Formatter
   └─ 新增模型时无需修改现有代码

<span class="hljs-bullet">2.</span> 流式处理
   └─ 使用Flux<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ChatResponse</span>&gt;</span></span>支持背压
   └─ 提升用户体验

<span class="hljs-bullet">3.</span> 成本和性能平衡
   └─ 根据任务复杂度选择合适的模型
   └─ 监控Token使用和成本

<span class="hljs-bullet">4.</span> 可靠性设计
   └─ 超时控制防止无限等待
   └─ 自动重试处理瞬时故障
</code></pre>
<hr/>
<p><strong>本章完</strong></p>
<p>在下一章中，我们将深入探讨<strong>Agent接口与AgentBase基类</strong>，了解如何实现自定义Agent。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么"容器化"技术很重要？——从虚拟机到 Docker]]></title>    <link>https://juejin.cn/post/7589246131586023459</link>    <guid>https://juejin.cn/post/7589246131586023459</guid>    <pubDate>2025-12-30T05:40:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589246131586023459" data-draft-id="7589275237037522979" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 为什么&quot;容器化&quot;技术很重要？——从虚拟机到 Docker"/> <meta itemprop="keywords" content="后端,GitHub"/> <meta itemprop="datePublished" content="2025-12-30T05:40:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="无限大6"/> <meta itemprop="url" content="https://juejin.cn/user/2865758605422890"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             为什么"容器化"技术很重要？——从虚拟机到 Docker
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2865758605422890/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    无限大6
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T05:40:07.000Z" title="Tue Dec 30 2025 05:40:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">📦 为什么"容器化"技术很重要？——从虚拟机到 Docker 🚀</h2>
<blockquote>
<p>大家好，我是无限大，欢迎收看十万个为什么系列文章</p>
<p>希望今天的内容能对大家有所帮助</p>
</blockquote>
<p>今天咱们来聊聊容器化这个"软件界的集装箱革命"！想象一下，你要运输一批货物，传统方式是把整个仓库都运走（虚拟机），而现在只需要把货物装进标准化的集装箱（容器），既高效又灵活——这就是容器化技术的魅力！</p>
<h3 data-id="heading-1">🤔 核心问题：容器化的优势是什么？Docker的工作原理是什么？</h3>
<p>很多人觉得容器化是"高大上的技术名词"，其实它离我们很近！你用的每一个手机APP，背后可能都有容器在运行。今天咱们就来揭开容器化的神秘面纱！</p>
<h4 data-id="heading-2">容器化的本质</h4>
<p>容器化是一种<strong>轻量级的虚拟化技术</strong>，它能把应用及其依赖打包成一个独立的、可移植的容器，在任何环境中都能一致运行。它就像"软件的集装箱"，标准化、易运输、高效利用资源。</p>
<h3 data-id="heading-3">📜 容器化的"进化史"：从虚拟机到Kubernetes</h3>
<h4 data-id="heading-4">1. 🖥️ 虚拟机时代："笨重的仓库运输"</h4>
<p>20世纪90年代，虚拟机（VM）技术诞生。它能在一台物理服务器上运行多个操作系统，每个操作系统都是一个独立的虚拟机。</p>
<p>这就像"在一辆卡车上装了多个独立的小卡车"，每个小卡车都有自己的发动机、油箱、驾驶室，虽然能装更多货物，但资源浪费严重，启动慢，管理复杂。</p>
<h4 data-id="heading-5">2. 🐧 Linux容器萌芽："轻量级虚拟化"</h4>
<p>2000年后，Linux容器技术开始发展，比如Linux VServer、LXC等。它们利用Linux内核的隔离特性，在同一操作系统上创建多个隔离的环境。</p>
<p>这就像"在一辆卡车上装了多个独立的货箱"，共享同一个发动机和驾驶室，资源利用率更高，但管理还是比较复杂。</p>
<h4 data-id="heading-6">3. 🐳 Docker横空出世："容器化革命"</h4>
<p>2013年，Docker发布，它简化了容器的创建、运行和管理，让容器化技术真正普及。Docker的口号是"Build once, run anywhere"（一次构建，随处运行）。</p>
<p>这就像"标准化的集装箱"，有统一的格式和接口，能在任何港口（环境）轻松装卸，极大提高了软件的可移植性和部署效率。</p>
<h4 data-id="heading-7">4. ☸️ Kubernetes："容器编排之王"</h4>
<p>2014年，Google开源了Kubernetes（简称K8s），它能自动化管理大量容器，实现容器的部署、扩展、更新和监控。</p>
<p>这就像"集装箱码头的调度系统"，自动安排集装箱的存放、运输和装卸，让成千上万的容器能有序运行。</p>
<h3 data-id="heading-8">🔧 技术原理：容器化的核心技术</h3>
<h4 data-id="heading-9">1. 🛡️ 容器的隔离机制："共享内核，隔离环境"</h4>
<p>容器的隔离主要通过Linux内核的两个特性实现：</p>
<ul>
<li><strong>cgroups（Control Groups）</strong>：限制和分配资源（CPU、内存、磁盘I/O等）</li>
<li><strong>namespaces</strong>：隔离进程、网络、文件系统等资源</li>
</ul>
<p>这就像"同一个房子里的多个房间"，共享同一个屋顶和基础设施，但每个房间有自己的门锁和独立的空间。</p>
<h4 data-id="heading-10">2. 🖼️ 容器镜像："应用的打包格式"</h4>
<p>容器镜像是容器的"模板"，包含了应用及其所有依赖（代码、库、环境变量、配置文件等）。镜像有以下特点：</p>
<ul>
<li><strong>分层存储</strong>：镜像由多个只读层组成，共享相同的层，节省空间</li>
<li><strong>不可修改</strong>：镜像创建后不可修改，确保一致性</li>
<li><strong>版本控制</strong>：支持标签和版本管理</li>
</ul>
<p>这就像"烹饪的食谱+食材包"，包含了做一道菜所需的所有材料和步骤，任何人都能做出同样的菜。</p>
<h4 data-id="heading-11">3. 🚀 容器运行时："容器的执行环境"</h4>
<p>容器运行时负责容器的创建、运行和销毁，常见的有：</p>
<ul>
<li><strong>runc</strong>：Docker默认的运行时，符合OCI（Open Container Initiative）标准</li>
<li><strong>containerd</strong>：更高级的运行时，提供更多功能</li>
<li><strong>CRI-O</strong>：专门为Kubernetes设计的运行时</li>
</ul>
<p>这就像"厨房的炉灶"，负责把食谱（镜像）变成美味的菜肴（容器）。</p>
<h4 data-id="heading-12">4. 📊 容器编排："大规模容器管理"</h4>
<p>当容器数量达到成百上千时，需要容器编排系统来管理，主要功能包括：</p>
<ul>
<li><strong>服务发现</strong>：自动发现和连接容器</li>
<li><strong>负载均衡</strong>：将请求分发到多个容器</li>
<li><strong>自动伸缩</strong>：根据负载自动调整容器数量</li>
<li><strong>健康检查</strong>：监控容器状态，自动重启故障容器</li>
<li><strong>滚动更新</strong>：零停机更新应用</li>
</ul>
<h4 data-id="heading-13">5. <strong>代码实例</strong>：Docker命令基础</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 拉取镜像（从Docker Hub下载一个Nginx镜像）</span>
docker pull nginx:latest

<span class="hljs-comment"># 2. 查看本地镜像</span>
docker images

<span class="hljs-comment"># 3. 运行容器（创建并启动一个Nginx容器）</span>
<span class="hljs-comment"># -d：后台运行</span>
<span class="hljs-comment"># -p 8080:80：将主机的8080端口映射到容器的80端口</span>
<span class="hljs-comment"># --name mynginx：给容器起个名字叫mynginx</span>
docker run -d -p 8080:80 --name mynginx nginx:latest

<span class="hljs-comment"># 4. 查看运行中的容器</span>
docker ps

<span class="hljs-comment"># 5. 查看容器日志</span>
docker logs mynginx

<span class="hljs-comment"># 6. 进入容器内部</span>
docker <span class="hljs-built_in">exec</span> -it mynginx /bin/bash

<span class="hljs-comment"># 7. 在容器内部执行命令（比如查看Nginx版本）</span>
nginx -v

<span class="hljs-comment"># 8. 退出容器</span>
<span class="hljs-built_in">exit</span>

<span class="hljs-comment"># 9. 停止容器</span>
docker stop mynginx

<span class="hljs-comment"># 10. 启动已停止的容器</span>
docker start mynginx

<span class="hljs-comment"># 11. 删除容器（需要先停止）</span>
docker <span class="hljs-built_in">rm</span> mynginx

<span class="hljs-comment"># 12. 删除镜像</span>
docker rmi nginx:latest
</code></pre>
<p><strong>运行结果示例</strong>：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-comment"># 拉取镜像</span>
<span class="hljs-section">latest: Pulling from library/nginx</span>
<span class="hljs-section">26c5c85e47da: Pull complete </span>
<span class="hljs-section">30afc0b18f67: Pull complete </span>
<span class="hljs-section">596b1d696923: Pull complete </span>
<span class="hljs-section">a8117582c2c0: Pull complete </span>
<span class="hljs-section">69038a8b17e6: Pull complete </span>
<span class="hljs-section">94026482364c: Pull complete </span>
<span class="hljs-section">Digest: sha256:0d17b565c37bcbd895e9d92315a05c1c3c9a29f762b011a10c54a66cd53c9b31</span>
<span class="hljs-section">Status: Downloaded newer image for nginx:latest</span>
<span class="hljs-section">docker.io/library/nginx:latest</span>

<span class="hljs-comment"># 运行容器</span>
2a3f6e36b924f21c3e45f070a75b9c669a949d3029b45b91a8c65c3f141d5758

<span class="hljs-comment"># 查看运行中的容器</span>
CONTAINER ID   IMAGE          COMMAND                  CREATED         STATUS         PORTS                  NAMES
2a3f6e36b924   nginx:latest   <span class="hljs-string">"/docker-entrypoint.…"</span>   2 seconds ago   Up 2 seconds   0.0.0.0:8080-&gt;80/tcp   mynginx

<span class="hljs-comment"># 查看Nginx版本</span>
nginx version: nginx/1.25.3
</code></pre>
<h3 data-id="heading-14">📊 趣味对比：虚拟机 vs 容器</h3>























































<table><thead><tr><th>对比项</th><th>虚拟机（VM）</th><th>容器</th></tr></thead><tbody><tr><td><strong>隔离级别</strong></td><td>操作系统级隔离（完全隔离）</td><td>进程级隔离（共享内核）</td></tr><tr><td><strong>启动时间</strong></td><td>分钟级</td><td>秒级甚至毫秒级</td></tr><tr><td><strong>资源占用</strong></td><td>高（需要运行完整OS）</td><td>低（共享内核）</td></tr><tr><td><strong>镜像大小</strong></td><td>GB级</td><td>MB级</td></tr><tr><td><strong>性能</strong></td><td>有虚拟化开销</td><td>接近原生性能</td></tr><tr><td><strong>部署密度</strong></td><td>一台服务器可运行几十个</td><td>一台服务器可运行上千个</td></tr><tr><td><strong>管理复杂度</strong></td><td>复杂（需要管理OS）</td><td>简单（只管理应用）</td></tr><tr><td><strong>代表产品</strong></td><td>VMware、VirtualBox</td><td>Docker、Podman</td></tr><tr><td><strong>适用场景</strong></td><td>运行不同OS；需要强隔离</td><td>微服务；CI/CD；云原生应用</td></tr></tbody></table>
<h3 data-id="heading-15">🏢 容器化的应用场景："改变软件开发和部署"</h3>
<p>容器化技术已经广泛应用于各个领域，被称为"云原生时代的基石"：</p>








































<table><thead><tr><th>应用场景</th><th>容器化的优势</th><th>实例</th></tr></thead><tbody><tr><td>🚀 <strong>微服务架构</strong></td><td>每个服务独立部署和扩展</td><td>Netflix、Spotify的微服务</td></tr><tr><td>🔄 <strong>CI/CD流程</strong></td><td>一致的开发、测试和生产环境</td><td>GitHub Actions、GitLab CI</td></tr><tr><td>☁️ <strong>云原生应用</strong></td><td>快速部署到任何云平台</td><td>Kubernetes上运行的应用</td></tr><tr><td>📱 <strong>移动应用后端</strong></td><td>弹性伸缩，应对流量波动</td><td>电商平台、社交媒体</td></tr><tr><td>🏭 <strong>企业应用现代化</strong></td><td>逐步迁移 legacy 应用</td><td>银行、保险系统</td></tr><tr><td>🎮 <strong>游戏服务器</strong></td><td>快速部署新游戏，弹性扩容</td><td>大型在线游戏</td></tr></tbody></table>
<h3 data-id="heading-16">⚠️ 常见误区纠正</h3>
<h4 data-id="heading-17">1. "容器是轻量级的虚拟机？"</h4>
<p>不！容器和虚拟机的隔离原理完全不同。虚拟机运行完整的操作系统，而容器共享宿主内核，只隔离进程和资源。</p>
<h4 data-id="heading-18">2. "容器不安全？"</h4>
<p>不一定！容器的隔离性虽然不如虚拟机，但通过合理配置（比如使用只读镜像、最小权限原则、网络隔离等），可以达到很高的安全性。</p>
<h4 data-id="heading-19">3. "Docker就是容器化的全部？"</h4>
<p>不！Docker是容器化的一个实现，还有其他容器技术，比如Podman、LXC等。而且容器化还包括镜像仓库、容器运行时、编排系统等。</p>
<h4 data-id="heading-20">4. "所有应用都适合容器化？"</h4>
<p>不一定！某些应用（比如需要特定硬件的应用、需要完整OS特性的应用）可能更适合虚拟机。但大多数现代应用都适合容器化。</p>
<h4 data-id="heading-21">5. "Kubernetes是必需的？"</h4>
<p>不！对于少量容器，直接使用Docker就足够了。只有当容器数量达到一定规模（比如几十个以上）时，才需要Kubernetes。</p>
<h4 data-id="heading-22">6. "容器化就等于云原生？"</h4>
<p>不！云原生是一个更广泛的概念，包括容器化、微服务、CI/CD、DevOps、可观察性等多个方面，容器化只是其中的一部分。</p>
<h3 data-id="heading-23">🔮 未来展望：容器化的发展趋势</h3>
<h4 data-id="heading-24">1. 🤖 <strong>Serverless容器</strong></h4>
<p>Serverless容器将容器与Serverless结合，用户只需关注应用，无需管理基础设施，按使用量付费。比如AWS Fargate、Azure Container Instances。</p>
<h4 data-id="heading-25">2. 📦 <strong>更安全的容器</strong></h4>
<p>随着容器安全技术的发展，容器的隔离性和安全性会越来越高，比如安全容器技术（gVisor、Kata Containers），它们结合了容器的轻量和虚拟机的安全。</p>
<h4 data-id="heading-26">3. 🌐 <strong>边缘容器</strong></h4>
<p>将容器部署到边缘设备（比如物联网设备、CDN节点），实现低延迟和分布式计算，比如K3s、Edge Kubernetes。</p>
<h4 data-id="heading-27">4. 🧩 <strong>更完善的生态系统</strong></h4>
<p>容器生态会越来越完善，包括更强大的镜像仓库、更智能的编排系统、更好的监控和可观察性工具。</p>
<h4 data-id="heading-28">5. 🎯 <strong>更简化的工具链</strong></h4>
<p>容器工具会越来越易用，降低使用门槛，比如Docker Desktop、Rancher Desktop等，让开发者能轻松使用容器和Kubernetes。</p>
<h3 data-id="heading-29">🎓 互动小测验：你答对了吗？</h3>


















































<table><thead><tr><th>问题</th><th>答案</th><th>你答对了吗？</th></tr></thead><tbody><tr><td>容器的核心隔离机制是什么？</td><td>cgroups和namespaces</td><td>✅/❌</td></tr><tr><td>Docker镜像的特点是什么？</td><td>分层存储、不可修改</td><td>✅/❌</td></tr><tr><td>容器和虚拟机的启动时间差异？</td><td>容器秒级，虚拟机分钟级</td><td>✅/❌</td></tr><tr><td>Kubernetes的主要功能是什么？</td><td>容器编排、自动伸缩、服务发现</td><td>✅/❌</td></tr><tr><td>容器化的典型应用场景是什么？</td><td>微服务、CI/CD、云原生应用</td><td>✅/❌</td></tr><tr><td>80%的企业使用容器技术？</td><td>是的</td><td>✅/❌</td></tr><tr><td>Kubernetes占容器编排市场份额？</td><td>75%</td><td>✅/❌</td></tr><tr><td>容器的性能如何？</td><td>接近原生性能</td><td>✅/❌</td></tr></tbody></table>
<h3 data-id="heading-30">🎯 结语：容器化的革命</h3>
<p>容器化技术的出现，就像工业革命中的标准化集装箱，彻底改变了软件的开发、部署和管理方式。它让应用变得更加轻量、可移植、易扩展，加速了云原生时代的到来。</p>
<p>从笨重的虚拟机到轻量的容器，从Docker到Kubernetes，容器化技术的发展，体现了人类追求更高效、更灵活的不懈努力。</p>
<p>下次当你使用Docker部署应用，或者在Kubernetes上运行微服务时，不妨想想背后的容器化技术，感受一下这场软件界的革命！</p>
<hr/>
<h3 data-id="heading-31">💬 互动话题</h3>
<ol>
<li>你使用过Docker或Kubernetes吗？体验如何？</li>
<li>你觉得容器化技术最大的优势是什么？</li>
<li>你认为容器化会完全取代虚拟机吗？为什么？</li>
<li>你最期待容器化技术在哪个领域的应用？</li>
</ol>
<p>快来评论区聊聊你的想法！💬 点赞收藏不迷路，咱们下期继续探索计算机的"十万个为什么"！🎉</p>
<p><strong>关注我</strong>，下期带你解锁更多计算机的"奇葩冷知识"！🤓</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ESP32 + MCP over MQTT：实现智能设备语音交互]]></title>    <link>https://juejin.cn/post/7550289374467702818</link>    <guid>https://juejin.cn/post/7550289374467702818</guid>    <pubDate>2025-09-16T07:13:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7550289374467702818" data-draft-id="7550466215790084111" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ESP32 + MCP over MQTT：实现智能设备语音交互"/> <meta itemprop="keywords" content="后端,MCP"/> <meta itemprop="datePublished" content="2025-09-16T07:13:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="EMQX"/> <meta itemprop="url" content="https://juejin.cn/user/1996368847842040"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ESP32 + MCP over MQTT：实现智能设备语音交互
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1996368847842040/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    EMQX
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-09-16T07:13:52.000Z" title="Tue Sep 16 2025 07:13:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-09-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>本系列教程路线图</strong></h2>
<p>本文是《从 0 到 1 打造情感陪伴智能体》系列的第四篇。若你还未阅读前几篇，建议先回顾它们，以便更好地理解本文内容。</p>








































<table><thead><tr><th align="left">篇章</th><th align="left">功能</th><th align="left">难度</th></tr></thead><tbody><tr><td align="left">1</td><td align="left"><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.emqx.com%2Fzh%2Fblog%2Fesp32-and-mcp-over-mqtt" target="_blank" title="https://www.emqx.com/zh/blog/esp32-and-mcp-over-mqtt" ref="nofollow noopener noreferrer">整体介绍：背景 + 环境准备 + 设备上线</a></td><td align="left">★</td></tr><tr><td align="left">2</td><td align="left"><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.emqx.com%2Fzh%2Fblog%2Fesp32-and-mcp-over-mqtt-2" target="_blank" title="https://www.emqx.com/zh/blog/esp32-and-mcp-over-mqtt-2" ref="nofollow noopener noreferrer">从“命令式控制”到“语义控制”：MCP over MQTT 封装设备能力</a></td><td align="left">★★</td></tr><tr><td align="left">3</td><td align="left"><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.emqx.com%2Fzh%2Fblog%2Fesp32-and-mcp-over-mqtt-3" target="_blank" title="https://www.emqx.com/zh/blog/esp32-and-mcp-over-mqtt-3" ref="nofollow noopener noreferrer">接入 LLM，实现“自然语言 → 设备控制”</a></td><td align="left">★★</td></tr><tr><td align="left">4</td><td align="left"><strong>语音 I/O：麦克风数据上传 + 语音识别 + 语音合成回放</strong></td><td align="left">★★★</td></tr><tr><td align="left">5</td><td align="left"><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.emqx.com%2Fzh%2Fblog%2Fesp32-and-mcp-over-mqtt-5" target="_blank" title="https://www.emqx.com/zh/blog/esp32-and-mcp-over-mqtt-5" ref="nofollow noopener noreferrer">人格、情感、记忆：从“控制器”到“陪伴体”</a></td><td align="left">★★★</td></tr><tr><td align="left">6</td><td align="left"><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.emqx.com%2Fzh%2Fblog%2Fesp32-and-mcp-over-mqtt-6" target="_blank" title="https://www.emqx.com/zh/blog/esp32-and-mcp-over-mqtt-6" ref="nofollow noopener noreferrer">给智能体增加“眼睛”：图像采集 + 多模态理解</a></td><td align="left">★★★</td></tr></tbody></table>
<h2 data-id="heading-1">回顾：接入 LLM 实现「自然语言 → 设备控制」</h2>
<p>在上一篇文章中，我们构建了从自然语言指令到设备控制调用的完整链路。通过集成大语言模型结合 MCP over MQTT 的通信协议，实现了设备智能体的雏形。这一智能体不仅能「理解」用户输入的文字，还能根据语义生成函数调用并作用于真实设备。然而，纯文本的交互方式在用户体验上仍存在局限，对用户来说并不直观和自然。</p>
<p>本期我们将实现交互方式的全面升级：通过集成语音识别（ASR）与语音合成（TTS）组件，构建完整的语音交互智能体，让用户可以通过语音方式直接与设备进行沟通。</p>
<h2 data-id="heading-2">本篇目标：让智能体能「听」能「说」</h2>
<p>我们期望实现这样的场景：</p>
<ul>
<li>你对着智能体说："我今天有点累了"。</li>
<li>ESP32 收集你的语音并上传到云端。</li>
<li>AI 理解你的情感，生成关怀式的回应。</li>
<li>智能体用温柔的声音说："辛苦了，要不要我为你放点轻柔的音乐？"</li>
</ul>
<p>为此，我们将在原有架构的基础上，新增语音识别与语音合成组件，让智能体具备「听」和「说」的能力。</p>
<h2 data-id="heading-3"><strong>架构升级与实现路径</strong></h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9943fce125e14463a3f97be104ece6d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRU1RWA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767677786&amp;x-signature=1FBSDF5vgZoHQ94Lna6DVCU0IDU%3D" alt="image.png" loading="lazy"/></p>
全新架构：新增语音识别（ASR）与语音合成（TTS）组件
<ol>
<li>ESP32 调用麦克风模块，录制用户语音，生成本地音频文件；</li>
<li>ESP32 通过 MQTT 协议把音频数据上传至云端，由 EMQX 数据桥接到 Web Hook，然后由 App 处理；</li>
<li>App 将音频文件发送至 ASR（语音识别）+ TTS（语音合成服务），生成回复语音；</li>
<li>识别出的文本被传送给大语言模型（LLM）</li>
<li>LLM 理解上下文语义并通过 MCP Over MQTT 调用部署在 ESP32 上的工具，实现设备控制；</li>
<li>App 将生成的语音压缩为 MP3 格式，编码为 Base64 格式后，再次通过 MQTT 将文件下发至 ESP32；</li>
<li>ESP32 播放音频文件，实现完整的语音交互闭环。</li>
</ol>
<p>这种架构充分发挥了 MQTT 在物联网场景下的轻量通信优势，同时借助云端强大的 LLM、ASR 和 TTS 能力，为终端设备提供了自然、上下文感知的语音交互体验。ESP32 保持设备轻量化，只负责音频采集与播放，核心处理任务则由云端完成，从而兼顾了性能与成本。</p>
<p>由于在上一篇文章中已经实现了通过 MCP 协议控制终端设备的能力（上述架构图中的步骤 4 和 5 ），我们本篇文章的主要精力放在语音处理上。</p>
<h2 data-id="heading-4">ESP32：智能语音采集</h2>
<h3 data-id="heading-5">硬件配置</h3>
<p>我们需要配置两套 I2S 接口，一套用于录音，一套用于播放。</p>
<p><strong>录音配置（I2S_NUM_0）：</strong></p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 录音引脚配置</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> I2S_REC_BCLK  7    <span class="hljs-comment">// 时钟信号</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> I2S_REC_LRCL  8    <span class="hljs-comment">// 左右声道切换</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> I2S_REC_DOUT  9    <span class="hljs-comment">// 数据输入</span></span>
<span class="hljs-comment">// 录音参数</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> I2S_SAMPLE_RATE   8000    <span class="hljs-comment">// 8kHz采样率，适合语音</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> I2S_SAMPLE_BITS   16      <span class="hljs-comment">// 16位深度</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> I2S_CHANNEL_NUM   1       <span class="hljs-comment">// 单声道</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> RECORD_SECONDS    3       <span class="hljs-comment">// 录音3秒</span></span>
</code></pre>
<p><strong>播放配置（I2S_NUM_1）：</strong></p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 播放引脚配置</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> I2S_PLAY_BCLK  2   <span class="hljs-comment">// 时钟信号</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> I2S_PLAY_LRCL  1   <span class="hljs-comment">// 左右声道切换  </span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> I2S_PLAY_DOUT  42  <span class="hljs-comment">// 数据输出</span></span>
</code></pre>
<h3 data-id="heading-6">智能语音检测算法</h3>
<p>问题的关键在于如何让 ESP32 知道什么时候该开始录音，既要节省设备电量，也要确保录音的完整性。</p>
<p><strong>语音能量检测：</strong></p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">calculateAudioEnergy</span><span class="hljs-params">(<span class="hljs-type">int16_t</span> *samples, <span class="hljs-type">size_t</span> count)</span> {
  <span class="hljs-type">uint64_t</span> sum = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; count; i++) {
    <span class="hljs-type">int32_t</span> s = samples[i];
    sum += (<span class="hljs-type">uint64_t</span>)(s * s);  <span class="hljs-comment">// 计算音频能量</span>
  }
  <span class="hljs-keyword">return</span> (<span class="hljs-type">uint32_t</span>)(sum / count);
}
</code></pre>
<p><strong>防误触机制：</strong></p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 滑动平均过滤噪音</span>
<span class="hljs-type">static</span> <span class="hljs-type">uint32_t</span> energyHistory[<span class="hljs-number">5</span>] = {<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>};
<span class="hljs-type">static</span> <span class="hljs-type">int</span> historyIndex = <span class="hljs-number">0</span>;
<span class="hljs-comment">// 需要至少3个样本都超过阈值才触发录音</span>
<span class="hljs-type">int</span> highEnergyCount = <span class="hljs-number">0</span>;
<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) {
  <span class="hljs-keyword">if</span> (energyHistory[i] &gt; ENERGY_THRESHOLD) {
    highEnergyCount++;
  }
}
<span class="hljs-keyword">if</span> (highEnergyCount &gt;= <span class="hljs-number">3</span> &amp;&amp; avgEnergy &gt; ENERGY_THRESHOLD) {
  Serial.println(<span class="hljs-string">"检测到语音，开始录音！"</span>);
  performRecording();
}
</code></pre>
<h3 data-id="heading-7">状态机管理</h3>
<p>为了避免录音和播放冲突，我们用状态机来管理：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">SystemState</span> {</span>
  STATE_IDLE,           <span class="hljs-comment">// 空闲状态（监听语音）</span>
  STATE_RECORDING,      <span class="hljs-comment">// 正在录音</span>
  STATE_PLAYING,        <span class="hljs-comment">// 正在播放</span>
  STATE_COOLDOWN        <span class="hljs-comment">// 播放后冷却期</span>
};
</code></pre>
<p><strong>防回声循环：</strong></p>
<ul>
<li>播放语音后进入冷却期（3秒）。</li>
<li>清空音频缓冲区，避免把回放的声音当成新的语音指令。</li>
<li>连续录音限制，避免无限循环对话。</li>
</ul>
<h3 data-id="heading-8">音频数据上传</h3>
<p>录音完成后，ESP32 会生成标准的 WAV 文件并通过 MQTT 上传：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 构建 WAV 文件头</span>
<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">WAVHeader</span> {</span>
  <span class="hljs-type">char</span> riff_header[<span class="hljs-number">4</span>];       <span class="hljs-comment">// "RIFF"</span>
  <span class="hljs-type">uint32_t</span> wav_size;         <span class="hljs-comment">// 文件大小</span>
  <span class="hljs-type">char</span> wave_header[<span class="hljs-number">4</span>];       <span class="hljs-comment">// "WAVE"</span>
  <span class="hljs-type">char</span> fmt_header[<span class="hljs-number">4</span>];        <span class="hljs-comment">// "fmt "</span>
  <span class="hljs-type">uint32_t</span> fmt_chunk_size;   <span class="hljs-comment">// 格式块大小</span>
  <span class="hljs-type">uint16_t</span> audio_format;     <span class="hljs-comment">// 音频格式(1=PCM)</span>
  <span class="hljs-type">uint16_t</span> num_channels;     <span class="hljs-comment">// 声道数</span>
  <span class="hljs-type">uint32_t</span> sample_rate;      <span class="hljs-comment">// 采样率</span>
  <span class="hljs-type">uint32_t</span> byte_rate;        <span class="hljs-comment">// 字节率</span>
  <span class="hljs-type">uint16_t</span> block_align;      <span class="hljs-comment">// 块对齐</span>
  <span class="hljs-type">uint16_t</span> bits_per_sample;  <span class="hljs-comment">// 位深度</span>
  <span class="hljs-type">char</span> data_header[<span class="hljs-number">4</span>];       <span class="hljs-comment">// "data"</span>
  <span class="hljs-type">uint32_t</span> data_bytes;       <span class="hljs-comment">// 数据大小</span>
} WAVHeader;
<span class="hljs-comment">// 通过 MQTT 发送音频</span>
mqtt_client.publish(<span class="hljs-string">"emqx/esp32/audio"</span>, wav_buffer, wav_size);
</code></pre>
<h2 data-id="heading-9">Python：AI 情感处理</h2>
<h3 data-id="heading-10">服务架构</h3>
<p>我们用 FastAPI 构建了异步的音频处理服务：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI, HTTPException, BackgroundTasks
<span class="hljs-keyword">from</span> openai <span class="hljs-keyword">import</span> AsyncOpenAI
<span class="hljs-keyword">import</span> base64
<span class="hljs-keyword">import</span> lameenc
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
app = FastAPI(title=<span class="hljs-string">"语音情感助手API"</span>, version=<span class="hljs-string">"1.0.0"</span>)
<span class="hljs-comment"># 通义千问客户端</span>
openai_client = AsyncOpenAI(
    api_key=<span class="hljs-string">"your-dashscope-api-key"</span>,
    base_url=<span class="hljs-string">"https://dashscope.aliyuncs.com/compatible-mode/v1"</span>
)
</code></pre>
<h3 data-id="heading-11">情感提示词设计</h3>
<p>这是让 AI 理解情感的关键：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">OPENAI_PROMPT</span> = <span class="hljs-string">"""
在这个会话中，您将作为简单的情感助手，依据我提供的语音，生成精简回复。
请注意回复不能超过 20 个字符并且回复的内容应当是对语音内容的情感分析或回应。
"""</span>
</code></pre>
<p><strong>为什么限制 20 字？</strong></p>
<ul>
<li>让回应更精准，避免啰嗦</li>
<li>减少语音合成和传输时间</li>
<li>更符合情感陪伴的温暖简洁风格</li>
</ul>
<h3 data-id="heading-12">多模态 AI 调用</h3>
<p>这是整个系统的核心，直接用语音输入生成语音输出：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">call_qwen_ai_generate_audio</span>(<span class="hljs-params">base64_audio: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:
    completion = <span class="hljs-keyword">await</span> openai_client.chat.completions.create(
        model=<span class="hljs-string">"qwen-omni-turbo"</span>,  <span class="hljs-comment"># 多模态模型</span>
        messages=[
            {
                <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
                <span class="hljs-string">"content"</span>: [
                    {
                        <span class="hljs-string">"type"</span>: <span class="hljs-string">"input_audio"</span>,
                        <span class="hljs-string">"input_audio"</span>: {
                            <span class="hljs-string">"data"</span>: <span class="hljs-string">f"data:;base64,<span class="hljs-subst">{base64_audio}</span>"</span>,
                            <span class="hljs-string">"format"</span>: <span class="hljs-string">"wav"</span>,
                        },
                    },
                    {
                        <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>, 
                        <span class="hljs-string">"text"</span>: <span class="hljs-string">"作为情感助手，用不超过20字回应用户的情感需求"</span>
                    }
                ],
            }
        ],
        modalities=[<span class="hljs-string">"text"</span>, <span class="hljs-string">"audio"</span>],        <span class="hljs-comment"># 同时输出文本和音频</span>
        audio={<span class="hljs-string">"voice"</span>: <span class="hljs-string">"Cherry"</span>, <span class="hljs-string">"format"</span>: <span class="hljs-string">"wav"</span>},  <span class="hljs-comment"># 使用 Cherry 音色</span>
        stream=<span class="hljs-literal">True</span>,                         <span class="hljs-comment"># 流式处理</span>
        stream_options={<span class="hljs-string">"include_usage"</span>: <span class="hljs-literal">True</span>}
    )
    <span class="hljs-comment"># 接收流式响应</span>
    text_string = <span class="hljs-string">""</span>
    audio_string = <span class="hljs-string">""</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> completion:
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> chunk.choices:
            <span class="hljs-keyword">continue</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(chunk.choices[<span class="hljs-number">0</span>].delta, <span class="hljs-string">"audio"</span>):
            audio_string += chunk.choices[<span class="hljs-number">0</span>].delta.audio[<span class="hljs-string">"data"</span>]
        <span class="hljs-keyword">elif</span> <span class="hljs-built_in">hasattr</span>(chunk.choices[<span class="hljs-number">0</span>].delta, <span class="hljs-string">"content"</span>):
            text_string += chunk.choices[<span class="hljs-number">0</span>].delta.content
    <span class="hljs-comment"># 返回音频数据</span>
    decoded_audio = base64.b64decode(audio_string)
    <span class="hljs-keyword">return</span> decoded_audio
</code></pre>
<p><strong>这种方式的优势：</strong></p>
<ul>
<li><strong>端到端处理</strong>：语音直接到语音，保持情感连贯性</li>
<li><strong>理解更准确</strong>：AI 能听出语调、情绪，不只是文字内容</li>
<li><strong>回应更自然</strong>：生成的语音带有合适的情感色彩</li>
</ul>
<h3 data-id="heading-13">音频格式优化</h3>
<p>AI 生成的是 WAV 格式，文件比较大，我们转成 MP3 压缩：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">convert_audio_to_mp3</span>(<span class="hljs-params">decoded_audio: <span class="hljs-built_in">bytes</span>, output_file: <span class="hljs-built_in">str</span></span>):
    audio_np = np.frombuffer(decoded_audio, dtype=np.int16)
    encoder = lameenc.Encoder()
    encoder.set_bit_rate(<span class="hljs-number">32</span>)        <span class="hljs-comment"># 低码率，减少传输量</span>
    encoder.set_in_sample_rate(<span class="hljs-number">24000</span>)
    encoder.set_channels(<span class="hljs-number">1</span>)
    encoder.set_quality(<span class="hljs-number">7</span>)          <span class="hljs-comment"># 平衡质量与大小</span>
    mp3_data = encoder.encode(audio_np.tobytes())
    mp3_data += encoder.flush()
    <span class="hljs-comment"># 保存文件并返回 Base64</span>
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(output_file, <span class="hljs-string">'wb'</span>) <span class="hljs-keyword">as</span> f:
        f.write(mp3_data)
    <span class="hljs-keyword">return</span> base64.b64encode(mp3_data).decode()
</code></pre>
<h3 data-id="heading-14">异步处理流程</h3>
<p>为了不阻塞 API 响应，我们用后台任务处理：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">"/process_audio"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">process_audio</span>(<span class="hljs-params">request: AudioRequest, background_tasks: BackgroundTasks</span>):
    task_id = <span class="hljs-built_in">str</span>(uuid.uuid4())
    <span class="hljs-comment"># 添加后台任务</span>
    background_tasks.add_task(
        process_audio_task,
        request.audio,
        task_id
    )
    <span class="hljs-keyword">return</span> AudioResponse(
        success=<span class="hljs-literal">True</span>,
        message=<span class="hljs-string">"音频处理任务已启动"</span>
    )
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">process_audio_task</span>(<span class="hljs-params">base64_audio: <span class="hljs-built_in">str</span>, task_id: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 1. 调用 AI 生成语音回应</span>
        decoded_audio = <span class="hljs-keyword">await</span> call_qwen_ai_generate_audio(base64_audio)
        <span class="hljs-comment"># 2. 转换为 MP3 格式</span>
        output_file = <span class="hljs-string">f"audio_response_<span class="hljs-subst">{task_id}</span>.mp3"</span>
        base64_mp3_audio = convert_audio_to_mp3(decoded_audio, output_file)
        <span class="hljs-comment"># 3. 通过 MQTT 发送给 ESP32</span>
        <span class="hljs-keyword">await</span> publish_to_mqtt(base64_mp3_audio)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        logger.error(<span class="hljs-string">f"处理音频任务异常: <span class="hljs-subst">{e}</span>"</span>)

</code></pre>
<h2 data-id="heading-15">EMQX：消息代理</h2>
<h3 data-id="heading-16">Topic 设计</h3>
<pre><code class="hljs language-bash" lang="bash">emqx/esp32/audio      → ESP32 上传录音
emqx/esp32/playaudio  → 下发播放音频
</code></pre>
<h3 data-id="heading-17">Webhook 配置</h3>
<p>在 EMQX 控制台配置 Webhook 规则，当收到音频消息时自动转发给 Python 服务：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"http://your-server:5005/process_audio"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"POST"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"headers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"Content-Type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"application/json"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"body"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"audio"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"${payload}"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-18"><strong>系统部署与配置流程</strong></h2>
<h3 data-id="heading-19">环境准备</h3>
<p><strong>Python 依赖：</strong></p>
<pre><code class="hljs">pip install fastapi uvicorn httpx lameenc numpy openai pydantic
</code></pre>
<p><strong>ESP32 库依赖：</strong></p>
<ul>
<li>WiFi：网络连接</li>
<li>PubSubClient：MQTT 客户端</li>
<li>SPIFFS：文件系统（存储临时音频文件）</li>
<li>ESP32Audio：音频编解码库</li>
</ul>
<h3 data-id="heading-20">配置流程</h3>
<ol>
<li>
<p><strong>获取通义千问 API Key</strong></p>
<ul>
<li>登录阿里云控制台。</li>
<li>开通 DashScope 服务。</li>
<li>获取 API Key。</li>
</ul>
</li>
<li>
<p><strong>配置 EMQX</strong></p>
<ul>
<li>创建设备认证信息。</li>
<li>配置 Webhook 规则。</li>
<li>设置消息路由。</li>
</ul>
</li>
<li>
<p><strong>ESP32 配置</strong></p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// WiFi 配置</span>
<span class="hljs-type">const</span> <span class="hljs-type">char</span> *ssid = <span class="hljs-string">"your-wifi-name"</span>;
<span class="hljs-type">const</span> <span class="hljs-type">char</span> *password = <span class="hljs-string">"your-wifi-password"</span>;
<span class="hljs-comment">// MQTT 配置</span>
<span class="hljs-type">const</span> <span class="hljs-type">char</span> *mqtt_broker = <span class="hljs-string">"broker.emqx.io"</span>;
<span class="hljs-type">const</span> <span class="hljs-type">char</span> *mqtt_username = <span class="hljs-string">"emqx"</span>;
<span class="hljs-type">const</span> <span class="hljs-type">char</span> *mqtt_password = <span class="hljs-string">"public"</span>;
</code></pre>
</li>
<li>
<p><strong>Python 服务配置</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># API 配置</span>
openai_client = AsyncOpenAI(
    api_key=<span class="hljs-string">"your-dashscope-api-key"</span>,
    base_url=<span class="hljs-string">"https://dashscope.aliyuncs.com/compatible-mode/v1"</span>
)
<span class="hljs-comment"># EMQX 配置</span>
EMQX_HTTP_API_URL = <span class="hljs-string">"http://127.0.0.1:18083"</span>
EMQX_USERNAME = <span class="hljs-string">"your-username"</span>
EMQX_PASSWORD = <span class="hljs-string">"your-password"</span>
</code></pre>
</li>
</ol>
<h2 data-id="heading-21"><strong>实测效果与性能表现</strong></h2>
<h3 data-id="heading-22">示例对话场景</h3>
<p><strong>场景一：情感安慰</strong></p>
<ul>
<li>用户（疲惫的语调）："我今天工作好累啊..."</li>
<li>AI回应（温柔）："辛苦你了，要好好休息哦"</li>
</ul>
<p><strong>场景二：日常聊天</strong></p>
<ul>
<li>用户（开心）："今天天气真不错！"</li>
<li>AI回应（活泼）："是呀，心情也变好了呢"</li>
</ul>
<p><strong>场景三：寻求建议</strong></p>
<ul>
<li>用户（犹豫）："我不知道该怎么办..."</li>
<li>AI回应（鼓励）："慢慢来，我们一起想想"</li>
</ul>
<h3 data-id="heading-23">性能表现</h3>
<p><strong>响应时间：</strong></p>
<ul>
<li>语音检测：实时（&lt;100ms）</li>
<li>AI处理：1-2 秒</li>
<li>音频下发：&lt; 500ms</li>
<li><strong>总延迟</strong>：约 3 秒内完成整个交互</li>
</ul>
<p><strong>音质表现：</strong></p>
<ul>
<li>Cherry 音色自然温暖</li>
<li>MP3 32kbps 音质清晰</li>
<li>支持情感语调变化</li>
</ul>
<h2 data-id="heading-24">现存问题与解决方案</h2>
<p>在实际测试中，我们遇到了几个典型问题：</p>
<ul>
<li>回声循环：ESP32 会把自己播放的声音再次录入，形成无限回放。</li>
</ul>
<p>我们在播放后增加了 3 秒冷却期，并在每次播放结束后清空 I2S 缓冲区，同时限制连续录音的次数，防止循环放大。</p>
<ul>
<li>录音误触：环境噪音或空调声导致设备频繁启动录音。</li>
</ul>
<p>我们通过提高能量阈值、加入滑动平均过滤，以及采用多样本确认机制，有效降低了误触发的概率。</p>
<ul>
<li>网络断线：WiFi 不稳定时会导致 MQTT 连接中断。</li>
</ul>
<p>为保证系统稳定运行，我们实现了自动重连机制、心跳检测和连接状态监控，确保设备在网络波动下依然能够可靠工作。</p>
<h2 data-id="heading-25">语音交互的局限与优化</h2>
<h3 data-id="heading-26">局限性</h3>
<p>该方案结构清晰、部署便捷，并充分利用了 MQTT 的稳定传输能力，但由于交互模式的批处理特性，仍存在很多明显的局限：</p>
<p><strong>批处理模式导致高延迟</strong></p>
<ul>
<li>语音采集、LLM 推理、TTS 合成、音频播放必须串行执行，用户需等待整个流程结束。</li>
<li>长语音输入或复杂语义解析时，交互延迟会显著增加。</li>
</ul>
<p><strong>缺乏流式交互能力</strong></p>
<ul>
<li>ASR 需完整录音后才开始转写，无法实时逐句识别。</li>
<li>TTS 必须等待全部文本就绪才生成语音，无法边合成边播放。</li>
<li>音频传输依赖完整文件下发，无法实现流式传输。</li>
</ul>
<p><strong>固定录音时长限制</strong></p>
<ul>
<li>3 秒时长可能导致长句被截断。</li>
<li>短句场景下存在无效等待，降低交互效率。</li>
</ul>
<p>这些因素都限制了方案在生产环境中的实际可用性，与日常智能语音助手的「边说边听、边合成边播放」的体验有明显差距。</p>
<h3 data-id="heading-27"><strong>优化方向</strong></h3>
<p>为了提升语音指令、响应速度和语音交互的自然性，可以从以下几个方向进行优化：</p>
<ul>
<li>动态录音时长：检测到语音结束自动停止录音；</li>
<li>VAD（Voice Activity Detection）：更准确的语音端点检测；</li>
<li>音频质量优化：降噪、增强等预处理；</li>
<li>ASR 实时语音识别（流式转写）；</li>
<li>TTS 音频实时生成与播放；</li>
<li>MQTT 与 RTP 可协同工作：MQTT 负责可靠的指令和状态交互，RTP 则用于快速传输音频流，使智能体更贴近「实时对话」的体验标准。</li>
</ul>
<h2 data-id="heading-28">下篇预告</h2>
<p>在本篇中，我们实现了从自然语言识别到设备播放语音的闭环。然而，一个真正的「智能」体，不止于一般的响应，它还应该懂你、记得你、陪伴你。</p>
<p>下一篇我们将探讨：</p>
<ul>
<li>如何引入「情感」和「人格」机制：让设备不只是冰冷的指令执行器，而具备温度、风格与情绪表达；</li>
<li>如何让设备「有记忆」：保留用户上下文、偏好和使用习惯，实现个性化长期记忆；</li>
<li>如何结合 LLM 构建人格化代理体：在长期互动中，逐渐演化成「懂你」的数字伙伴。</li>
</ul>
<p>此外，我们也将讨论不同类型的人设设计，如：安静助理、热情伙伴、严肃专家等，并分析人设如何影响交互体验与应用场景适配。这将是从「设备控制、交互智能体」走向「人格化智能体」的关键一步。敬请期待。</p>
<h2 data-id="heading-29">资源</h2>
<ul>
<li>源代码 - <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmqtt-ai%2Fesp32-mcp-mqtt-tutorial%2Ftree%2Fmain%2Fsamples%2Fblog_4" target="_blank" title="https://github.com/mqtt-ai/esp32-mcp-mqtt-tutorial/tree/main/samples/blog_4" ref="nofollow noopener noreferrer">github.com/mqtt-ai/esp…</a> ，包含：
<ul>
<li>ESP32 完整工程文件</li>
<li>Python 后端服务源码</li>
<li>EMQX 配置说明</li>
<li>部署运行文档</li>
</ul>
</li>
<li>通义千问：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdashscope.aliyun.com%2F" target="_blank" title="https://dashscope.aliyun.com/" ref="nofollow noopener noreferrer">模型服务灵积 DashScope</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Meta 收购 Manus：当巨头搭台时，你要做那个递钥匙的人]]></title>    <link>https://juejin.cn/post/7589308109640515619</link>    <guid>https://juejin.cn/post/7589308109640515619</guid>    <pubDate>2025-12-30T05:41:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589308109640515619" data-draft-id="7589246131585826851" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Meta 收购 Manus：当巨头搭台时，你要做那个递钥匙的人"/> <meta itemprop="keywords" content="前端,后端,人工智能"/> <meta itemprop="datePublished" content="2025-12-30T05:41:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="HiStewie"/> <meta itemprop="url" content="https://juejin.cn/user/1591748568038823"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Meta 收购 Manus：当巨头搭台时，你要做那个递钥匙的人
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1591748568038823/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    HiStewie
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T05:41:07.000Z" title="Tue Dec 30 2025 05:41:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333;position:relative;background-image:linear-gradient(90deg,rgba(217,234,251,.25) 3%,transparent 0),linear-gradient(1turn,rgba(217,234,251,.25) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;padding-left:8px;padding-bottom:0;margin-top:35px;margin-bottom:10px;font-weight:900;font-family:serif;letter-spacing:1px;color:#000}.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover{background-color:#fff}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;position:relative}.markdown-body h2:after{content:"";left:0;bottom:0;width:100%;height:1px;position:absolute}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{height:1px;border:none;margin-top:32px;margin-bottom:32px;background-size:4px 1px;background-image:linear-gradient(270deg,#37b2ff 0,#37b2ff 25%,transparent 50%)}.markdown-body code{margin:0 4px;word-break:break-word;overflow-x:auto;background-color:#fff7f7;color:#f06;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:-apple-system,system-ui,Menlo,Monaco,Consolas,Courier New;position:relative}.markdown-body pre{margin:15px 8px;border:1px solid #f5f5f7;line-height:1.75}.markdown-body pre:before{top:-4px;left:-4px;border-top:8px solid #feea1e;border-left:8px solid #feea1e}.markdown-body pre:after,.markdown-body pre:before{width:20px;height:20px;content:"";z-index:10;position:absolute}.markdown-body pre:after{right:-4px;bottom:-4px;border-right:8px solid #37b2ff;border-bottom:8px solid #37b2ff}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;overflow-x:auto;margin:0;word-break:normal;display:block;color:#333;background-color:#fff;position:unset!important}.markdown-body pre:nth-child(odd):before{border-top-color:#a7ecad;border-left-color:#a7ecad}.markdown-body pre:nth-child(odd):after{border-right-color:#e699e6;border-bottom-color:#e699e6}.markdown-body a{margin:0 4px;text-decoration:none;color:#37b2ff;transition:.3s;display:inline-block;vertical-align:bottom;position:relative}.markdown-body a:before{content:"READ MORE +";bottom:90%;width:120px;max-width:0;color:#fff;background-color:#1fb3ff;position:absolute;white-space:nowrap;transition:.3s;box-sizing:border-box;pointer-events:none;overflow:hidden}.markdown-body a:after{content:"";bottom:0;left:0;width:100%;height:1px;border-bottom:1px dashed #37b2ff;position:absolute}.markdown-body a:active:before,.markdown-body a:hover:before{max-width:120px;padding-left:14px}.markdown-body table{width:100%;max-width:100%;font-size:12px;background-color:#fff;overflow:auto;border-collapse:collapse}.markdown-body table tr:hover td,.markdown-body table tr:hover th{border-bottom:1px solid #feea1e}.markdown-body thead{text-align:left}.markdown-body th{font-size:1.2em;border-bottom:1px dashed #eee}.markdown-body tr:nth-child(2n){background-color:hsla(0,0%,87.8%,.1);border-bottom:1px solid #fff}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px;border-bottom:1px dashed #fff}.markdown-body blockquote{color:#666;padding:12px 23px 2px;border:1px solid #37b2ff;background-color:#fff;margin:22px 0;position:relative}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body blockquote:after{content:"FROM";left:0;width:40px;color:#fff;background-color:#37b2ff;text-align:center}.markdown-body blockquote:after,.markdown-body blockquote:before{top:0;line-height:1;padding:2px 0;font-size:12px;font-weight:lighter;position:absolute;pointer-events:none}.markdown-body blockquote:before{content:"CITATION";left:44px;color:#37b2ff}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{line-height:2em;margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#37b2ff}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol ol li,.markdown-body ol ul li,.markdown-body ul ol li,.markdown-body ul ul li{border-bottom:none}.markdown-body ol li{padding-left:6px;list-style:decimal-leading-zero}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body input[type=checkbox]{position:relative}.markdown-body input[type=checkbox]:before{top:0;left:0;right:0;bottom:0;content:"";width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1;position:absolute}.markdown-body input[type=checkbox]:checked:after{content:"";top:10%;left:18%;width:90%;height:40%;border-left:2px solid #37b2ff;border-bottom:2px solid #37b2ff;color:#37b2ff;z-index:2;transform:rotate(-45deg);position:absolute}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-light">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p>今早看到 Manus 被 Meta 收购的消息，我下意识瞄了一眼浏览器侧边栏。</p>
<p>那里停着 Monica 我去年买了它的 Unlimited Level。这一年，眼看着它从一个小插件长成巨头争抢的资产，这种感觉很奇妙。我的续费记录比分析师的报告更说明问题：这是真金白银的投票。</p>
<p>很多人在讨论收购金额，讨论中美科技博弈。但在我这个也是“一人公司”模式的独立开发者眼里，这不仅是一桩商业收购，更是一次对 <strong>“产品价值观”</strong> 的暴力验证。</p>
<h2 data-id="heading-0">01. 主角登场：从武汉光谷到硅谷焦点</h2>
<p>为了还原这次收购的真实分量，我们需要先看清牌桌上的这三个名字。这并不是一个简单的“套壳工具”被收购的故事，而是一场惊心动魄的突围。</p>
<p>这两款产品背后的母公司叫 <strong>Monica.im</strong>（国内主体为武汉蝴蝶效应），创始人是<strong>肖弘</strong>。在被 Meta 收购之前，他们已经是全球 AI 应用层的顶流，典型的“墙内开花墙外香”。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc8dd4c072af45ee8e151083564060ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGlTdGV3aWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767678067&amp;x-signature=g6c3zLymJfwMhUtseqRKDC0X3%2Bs%3D" alt="462shots_so.png" loading="lazy"/></p>
<ul>
<li><strong>Monica（超级入口）：</strong>
它是浏览器时代的“副驾驶”。在我的侧边栏里，它聚合了 GPT-5、Claude 4.5、Gemini 3 等所有核武器。它解决了 <strong>“输入”</strong> 的问题，帮我把全球最强的模型能力接入到我浏览的每一个网页中。</li>
<li><strong>Manus（执行代理）：</strong>
这是真正的杀手锏。作为全球首款通用 AI 智能体，它不再是聊天，而是能独立写报告、分析数据、跨平台操作。它解决了 <strong>“执行”</strong> 的问题。</li>
<li><strong>肖弘（CEO）：</strong>
他不是典型的硅谷技术极客，而是一位深谙中国互联网玩法的连续创业者。早在 AI 爆发前，他就创办过“壹伴”、“微伴”等工具，是微信生态里最懂流量和社群裂变的人。</li>
</ul>
<p>正是因为肖弘带着这种 <strong>“微信生态基因”</strong> 杀入硅谷，才有了后面让 Meta 既头疼又眼馋的增长奇迹。</p>
<h2 data-id="heading-1">02. 不是“钞能力”，是“中国式裂变”的降维打击</h2>
<p>市面上盛传：“Manus 是因为在 Facebook 投了最多的广告，成了大金主，所以才被收购。”
<strong>大错特错。真相恰恰相反——Meta 买它，是因为它证明了自己可以“不花钱”就从 Meta 身上薅走 10 亿流量。</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f322d4415ef49e8a8ecdfbd6f396dee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGlTdGV3aWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767678067&amp;x-signature=KDJXcHDflL%2BOKHM7fyIGJurYvsA%3D" alt="image_1767072563254_bmhxz6_16x9_1024x576.png" loading="lazy"/></p>
<p>肖弘把我们在国内熟知的 <strong>“私域流量”</strong> 和 <strong>“裂变”</strong> 战术，完美移植到了全球市场：</p>
<ul>
<li><strong>饥饿营销：</strong> 严格的内测机制，让邀请码在二手市场炒到上千美元。</li>
<li><strong>内容杠杆：</strong> 为了获得算力积分，用户必须生成演示视频发到社交媒体上。</li>
<li><strong>算法回声室：</strong> 成千上万个真实用户的“惊叹帖”，骗过了 Meta 的算法，让 Meta 以为这是“有机内容”而疯狂推荐。</li>
</ul>
<p><strong>Meta 震惊了：</strong> 这个中国团队不需要 Meta 的销售团队，就能在 Meta 的地盘上制造病毒。扎克伯格给肖弘 VP 的位置，不是因为他懂技术，而是因为他掌握了 <strong>“如何在不烧光现金的情况下，让 10 亿用户用上 AI”</strong> 的黑魔法。</p>
<h2 data-id="heading-2">03. 不做“造物主”，做“万能接口”</h2>
<p>作为 Monica 的重度用户。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cbb19e83e09f42869b735b70a479f3b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGlTdGV3aWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767678067&amp;x-signature=As5YnbCEIlgdlKkhp4lXidGORR0%3D" alt="147shots_so.png" loading="lazy"/></p>
<p>过去这一年，技术圈总在争论“谁拥有最强的底层模型”。但这家公司证明了一件事：
<strong>不管底层模型是谁的，把能力做成普通人每天都愿意用、愿意付费的产品，才是最硬的护城河。</strong></p>
<p>看看我的侧边栏：各大模型一字排开。我不需要去订阅五个不同的会员，不需要在五个网页间反复横跳。我只需要一个 Monica，就能随时调用这个星球上最强的大脑。</p>
<p>Meta 有 Llama，有最强的大脑，但他们缺一个能聚合所有能力、并且已经长在用户浏览器里的 <strong>“超级入口”</strong>。</p>
<p>如果 Meta 不买，Monica 继续做大，它就架空了底层模型厂商。收购 Monica，Meta 不仅买下了一个好用的工具，更买回了 <strong>“分发权”</strong>。</p>
<h2 data-id="heading-3">04. Llama 只有脑子，Manus 给了它“双手”</h2>
<p>从技术维度看，Meta 的焦虑在于：<strong>Llama 只有脑子，没有手。</strong></p>
<p>聊天机器人时代，用户问“怎么去东京？”，AI 给你攻略。
智能体时代，用户说“帮我订票”，AI 需要打开浏览器、登录官网、选座、支付。</p>
<p>Manus 的核心技术壁垒，是它为每个任务生成的<strong>云端虚拟环境</strong>。它能安全地沙盒化运行代码。</p>
<p><strong>以前我需要花 2 小时去查 10 个竞品的定价并填进 Excel；现在我把任务丢给 Manus，去冲杯咖啡，回来时它已经把做好的表格发给我了。</strong> 这种 <strong>‘从对话到交付’</strong> 的跨越，才是 Meta 恐惧的根源。</p>
<p>如果未来的互联网入口是智能体，那么它在浏览网页时会自动过滤广告，只提取信息。这对靠广告生存的 Meta 是灭顶之灾。<strong>收购 Manus，本质上是一场“防御战”。</strong> Meta 必须把这双“手”长在自己身上，重新定义“后广告时代”的商业规则。</p>
<h2 data-id="heading-4">05. 独立开发者的启示：成为“稀缺资产”，而非“外包苦力”</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70103041091a48449ef9fc1461e29dc1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGlTdGV3aWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767678067&amp;x-signature=9VGBiOuhz%2FrOqnv6VJnUODLjNos%3D" alt="image_1767073097450_lzu9r1_16x9_1024x576.png" loading="lazy"/>
这对国内 AI 创业者，尤其是像我这样的独立开发者来说，其实挺提气的。</p>
<p>Manus 的故事告诉我们：中国团队完全可以在全球舞台上被当成 <strong>“战略资产”</strong> 买走，而不是作为廉价的“外包能力”被消耗。</p>
<p>我也是一人公司，我也在写代码。看着 Manus 的路径，我常在想：在独立创业黄金窗口逐渐收窄的今天，我们该怎么办？</p>
<p>Meta 这笔收购指明了一条新路：<strong>与其烧钱追赶巨头，不如成为他们争相购买的“稀缺资产”。</strong></p>
<p>这是一种很高阶的路径设计。创业者无需与巨头在全面战争中对决，而应利用先发优势，在自己最锋利的点上——比如 Manus 的全自动执行能力——<strong>成为巨头在关键时刻唯一且急需的那块拼图。</strong></p>
<p>这与个人在职场黄金期加入高速成长公司的逻辑如出一辙：</p>
<blockquote>
<p><strong>价值最大化，往往不在于你“最强”之时，而在于你“最被需要”之刻。</strong></p>
</blockquote>
<p>Manus 并没有做到 100% 的完美，初期甚至服务器不稳。但它在 Meta 最焦虑“如何让 AI 落地”的时候，它是那个 Ready 的选项。</p>
<p>巨头高价抢人，本质是购买 <strong>“确定性”</strong> 和 <strong>“战略时间”</strong>。</p>
<h2 data-id="heading-5">06. 结语：在“草台班子”的世界里递钥匙</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2327247215414563a84677f0b408c62c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGlTdGV3aWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767678067&amp;x-signature=rrqXdo1aWdRbkIYNgN0UOat0QxA%3D" alt="image_1767072987089_e0pksj_16x9_1024x576.png" loading="lazy"/></p>
<p>很多技术人（包括我自己）常死在追求“完美”上。觉得代码不够优雅，功能不够全，不敢发布。</p>
<p>但现实世界往往是混乱且急迫的。</p>
<blockquote>
<p><strong>世界有时是“草台班子”——决定你市值的，不全是你的完工程度，而是你能否在巨头搭建舞台时，恰好递上他们最缺的那把钥匙。</strong></p>
</blockquote>
<p>这并非妥协，而是对时机与稀缺性的深刻理解。</p>
<p>与其在红海中追求绝对完美，不如在巨头战局未定的空白地带，率先做出“可用且稀缺”的产品。</p>
<p>“当巨头转身寻找时，你要确保自己在场，并且手里握着那把钥匙。<strong>就像肖弘在武汉光谷敲下第一行代码时，他可能也没想到，这把钥匙最终会开启硅谷的大门。但重要的是，他一直在磨那把钥匙。</strong> ”</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[阿里开源AgentScope多智能体框架解析系列（二）第2章：消息系统（Message）深入解析]]></title>    <link>https://juejin.cn/post/7589207843788324899</link>    <guid>https://juejin.cn/post/7589207843788324899</guid>    <pubDate>2025-12-30T03:52:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589207843788324899" data-draft-id="7589308109639843875" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="阿里开源AgentScope多智能体框架解析系列（二）第2章：消息系统（Message）深入解析"/> <meta itemprop="keywords" content="Agent"/> <meta itemprop="datePublished" content="2025-12-30T03:52:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="语落心生"/> <meta itemprop="url" content="https://juejin.cn/user/2875978147955741"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            阿里开源AgentScope多智能体框架解析系列（二）第2章：消息系统（Message）深入解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2875978147955741/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    语落心生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T03:52:07.000Z" title="Tue Dec 30 2025 03:52:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">总述</h2>
<p>消息（Message）是AgentScope中<strong>Agent之间的通信单元</strong>，也是整个框架运行的基础。理解消息系统的设计，就能理解AgentScope如何在保持灵活性的同时，提供类型安全和可靠性。</p>
<p>本章将从<strong>消息的设计哲学、核心结构、内容块系统、多模态支持、元数据管理</strong>等多个维度，深入讲解AgentScope的消息系统。</p>
<hr/>
<h2 data-id="heading-1">2.1 Msg 消息模型设计</h2>
<h3 data-id="heading-2">2.1.1 为什么需要消息模型？</h3>
<h4 data-id="heading-3">问题背景</h4>
<p>在Agent系统中，不同的参与者（用户、AI模型、工具、其他Agent）需要进行通信。简单的做法是直接传递字符串或对象，但这样会导致以下问题：</p>
<pre><code class="hljs language-javascript" lang="javascript">问题<span class="hljs-number">1</span>：信息丢失
└─ 仅传递内容，丢失了：谁说的（role）、什么时候说的（timestamp）、
   说了什么<span class="hljs-variable constant_">ID</span>（message_id）等元数据

问题<span class="hljs-number">2</span>：无法应对多样化内容
└─ 内容可能是纯文本、图像、音频、视频，甚至是工具调用请求
   单一的<span class="hljs-title class_">String</span>无法表达

问题<span class="hljs-number">3</span>：缺乏结构化数据支持
└─ <span class="hljs-title class_">Agent</span>有时需要返回结构化数据（<span class="hljs-title class_">JSON</span>对象），但无法与文本区分

问题<span class="hljs-number">4</span>：通信追踪困难
└─ 没有统一的消息格式，很难进行日志、审计、重放
</code></pre>
<h3 data-id="heading-4">2.1.2 Msg的核心设计</h3>
<h4 data-id="heading-5">设计原则</h4>
<pre><code class="hljs">原则1：不可变性（Immutable）
├─ 消息创建后不能修改
├─ 保证线程安全（在响应式架构中至关重要）
└─ 便于消息缓存和比较

原则2：最小化设计
├─ 只包含必要字段，避免冗余
├─ 易于序列化和网络传输
└─ 快速解析和处理

原则3：可扩展性
├─ 支持多种内容类型
├─ 元数据字段可扩展
└─ 便于第三方扩展
</code></pre>
<h4 data-id="heading-6">Msg的核心字段</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Msg</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String id;              <span class="hljs-comment">// ✓ 唯一标识，用于追踪</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String name;            <span class="hljs-comment">// ✓ 可选的消息名称</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MsgRole role;           <span class="hljs-comment">// ✓ 消息角色（user/assistant/system/tool）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;ContentBlock&gt; content;  <span class="hljs-comment">// ✓ 消息内容（支持多种类型）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, Object&gt; metadata;<span class="hljs-comment">// ✓ 元数据（结构化数据、扩展信息）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String timestamp;       <span class="hljs-comment">// ✓ 时间戳（ISO 8601格式）</span>
}
</code></pre>
<h4 data-id="heading-7">字段详解</h4>






















































<table><thead><tr><th>字段</th><th>类型</th><th>必需</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><code>id</code></td><td>String</td><td>是</td><td>消息唯一ID</td><td><code>"msg_123e4567-e89b-12d3-a456"</code></td></tr><tr><td><code>name</code></td><td>String</td><td>否</td><td>发送者名称</td><td><code>"user"</code>, <code>"assistant"</code>, <code>"system"</code></td></tr><tr><td><code>role</code></td><td>MsgRole</td><td>是</td><td>消息角色</td><td><code>USER</code>, <code>ASSISTANT</code>, <code>SYSTEM</code>, <code>TOOL</code></td></tr><tr><td><code>content</code></td><td>List</td><td>是</td><td>内容块列表</td><td><code>[TextBlock, ImageBlock, ...]</code></td></tr><tr><td><code>metadata</code></td><td>Map&lt;String, Object&gt;</td><td>否</td><td>元数据</td><td><code>{"user_id": "123", "session": "abc"}</code></td></tr><tr><td><code>timestamp</code></td><td>String</td><td>是</td><td>时间戳</td><td><code>"2024-01-15 10:30:45.123"</code></td></tr></tbody></table>
<h3 data-id="heading-8">2.1.3 Msg的生命周期</h3>
<pre><code class="hljs language-markdown" lang="markdown">第1阶段：创建（Creation）
<span class="hljs-code">    Msg.builder()
        .role(MsgRole.USER)
        .content(TextBlock.builder().text("Hello").build())
        .build()
    └─ 自动生成ID和timestamp
</span>
第2阶段：传输（Transport）
<span class="hljs-bullet">    -</span> JSON序列化（网络传输或存储）
<span class="hljs-bullet">    -</span> 不可变，支持并发访问

第3阶段：处理（Processing）
<span class="hljs-code">    Agent接收消息
    │
    ├─ 添加到Memory（保留历史）
    ├─ 提取内容并处理
    └─ 可能修改元数据（但这会创建新的Msg对象）
</span>
第4阶段：响应（Response）
<span class="hljs-code">    生成新的Msg对象作为响应
    └─ 包含原消息ID的引用（通过metadata）
</span>
第5阶段：持久化（Persistence）
<span class="hljs-code">    存储到Session或数据库
    └─ 支持后续的消息重放和审计
</span></code></pre>
<h3 data-id="heading-9">2.1.4 构建消息的多种方式</h3>
<h4 data-id="heading-10">方式1：使用Builder构建最小化消息</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 方式1a：最简单的纯文本消息</span>
<span class="hljs-type">Msg</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> Msg.builder()
    .textContent(<span class="hljs-string">"你好，今天天气怎么样？"</span>)
    .build();

<span class="hljs-comment">// 方式1b：明确指定角色</span>
<span class="hljs-type">Msg</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> Msg.builder()
    .role(MsgRole.USER)
    .content(TextBlock.builder().text(<span class="hljs-string">"Hello"</span>).build())
    .build();

<span class="hljs-comment">// 方式1c：指定发送者名称</span>
<span class="hljs-type">Msg</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> Msg.builder()
    .name(<span class="hljs-string">"Alice"</span>)  <span class="hljs-comment">// 用户名</span>
    .role(MsgRole.USER)
    .textContent(<span class="hljs-string">"I have a question"</span>)
    .build();
</code></pre>
<h4 data-id="heading-11">方式2：构建多内容消息</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 包含文本和图像的消息</span>
<span class="hljs-type">Msg</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> Msg.builder()
    .role(MsgRole.USER)
    .name(<span class="hljs-string">"user_123"</span>)
    .content(
        TextBlock.builder().text(<span class="hljs-string">"请帮我分析这张图片"</span>).build(),
        ImageBlock.builder()
            .source(URLSource.builder()
                .url(<span class="hljs-string">"https://example.com/chart.png"</span>)
                .build())
            .build()
    )
    .build();

<span class="hljs-comment">// 或使用List.of()</span>
List&lt;ContentBlock&gt; content = List.of(
    TextBlock.builder().text(<span class="hljs-string">"What's in this image?"</span>).build(),
    ImageBlock.builder().source(urlSource).build()
);
<span class="hljs-type">Msg</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> Msg.builder()
    .role(MsgRole.USER)
    .content(content)
    .build();
</code></pre>
<h4 data-id="heading-12">方式3：携带元数据的消息</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 包含结构化数据的消息</span>
<span class="hljs-type">Msg</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> Msg.builder()
    .role(MsgRole.ASSISTANT)
    .textContent(<span class="hljs-string">"订单已创建"</span>)
    .metadata(Map.of(
        <span class="hljs-string">"order_id"</span>, <span class="hljs-string">"ORD-20240115-001"</span>,
        <span class="hljs-string">"amount"</span>, <span class="hljs-number">599.99</span>,
        <span class="hljs-string">"timestamp"</span>, System.currentTimeMillis()
    ))
    .build();

<span class="hljs-comment">// 获取元数据</span>
<span class="hljs-keyword">if</span> (msg.hasStructuredData()) {
    Map&lt;String, Object&gt; data = msg.getMetadata();
    <span class="hljs-type">String</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> (String) data.get(<span class="hljs-string">"order_id"</span>);
}
</code></pre>
<h4 data-id="heading-13">方式4：携带结构化对象的消息</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 定义结构化数据类</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@Builder</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderResponse</span> {
    <span class="hljs-keyword">private</span> String orderId;
    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> amount;
    <span class="hljs-keyword">private</span> String status;
    <span class="hljs-keyword">private</span> LocalDateTime createdTime;
}

<span class="hljs-comment">// 创建包含结构化数据的消息</span>
<span class="hljs-type">OrderResponse</span> <span class="hljs-variable">orderResp</span> <span class="hljs-operator">=</span> OrderResponse.builder()
    .orderId(<span class="hljs-string">"ORD-001"</span>)
    .amount(<span class="hljs-number">599.99</span>)
    .status(<span class="hljs-string">"CREATED"</span>)
    .createdTime(LocalDateTime.now())
    .build();

<span class="hljs-comment">// 方式A：通过metadata存储（然后通过getStructuredData()获取）</span>
<span class="hljs-type">Msg</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> Msg.builder()
    .role(MsgRole.ASSISTANT)
    .textContent(<span class="hljs-string">"订单创建成功"</span>)
    .metadata(Map.of(
        <span class="hljs-string">"order"</span>, orderResp  <span class="hljs-comment">// 直接放入对象</span>
    ))
    .build();

<span class="hljs-comment">// 获取时</span>
<span class="hljs-keyword">if</span> (msg.hasStructuredData()) {
    <span class="hljs-type">OrderResponse</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> msg.getStructuredData(OrderResponse.class);
}
</code></pre>
<hr/>
<h2 data-id="heading-14">2.2 消息角色（MsgRole）与通信模式</h2>
<h3 data-id="heading-15">2.2.1 四种消息角色</h3>
<h4 data-id="heading-16">1. USER 角色</h4>
<p><strong>定义</strong>：来自用户或外部输入的消息</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 典型用法</span>
<span class="hljs-type">Msg</span> <span class="hljs-variable">userMsg</span> <span class="hljs-operator">=</span> Msg.builder()
    .role(MsgRole.USER)
    .name(<span class="hljs-string">"Alice"</span>)  <span class="hljs-comment">// 用户名</span>
    .textContent(<span class="hljs-string">"请帮我写一份会议总结"</span>)
    .build();
</code></pre>
<p><strong>特点</strong>：</p>
<ul>
<li>通常是对话的起点</li>
<li>可以包含多种内容类型（文本、图像、文件URL等）</li>
<li>通常来自前端应用或API客户端</li>
</ul>
<p><strong>场景示例</strong>：</p>
<pre><code class="hljs language-sql" lang="sql">用户在聊天界面输入消息 → 转换为 <span class="hljs-keyword">USER</span> 角色消息 → 送给Agent
</code></pre>
<h4 data-id="heading-17">2. ASSISTANT 角色</h4>
<p><strong>定义</strong>：由AI Agent或助手生成的消息</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 典型用法</span>
<span class="hljs-type">Msg</span> <span class="hljs-variable">assistantMsg</span> <span class="hljs-operator">=</span> Msg.builder()
    .role(MsgRole.ASSISTANT)
    .name(<span class="hljs-string">"ChatBot"</span>)  <span class="hljs-comment">// Agent名称</span>
    .textContent(<span class="hljs-string">"我已经为你准备了会议总结..."</span>)
    .build();
</code></pre>
<p><strong>特点</strong>：</p>
<ul>
<li>是Agent的回复</li>
<li>可能包含推理过程（ThinkingBlock）、工具调用（ToolUseBlock）等</li>
<li>通常会被添加到Memory中，作为后续对话的上下文</li>
</ul>
<p><strong>生产场景</strong>：</p>
<pre><code class="hljs">Agent推理 → 调用工具 → 获得结果 → 生成最终回复（ASSISTANT消息）
</code></pre>
<h4 data-id="heading-18">3. SYSTEM 角色</h4>
<p><strong>定义</strong>：系统指令、提示词或配置消息</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 系统提示词（通常在Agent创建时设置）</span>
<span class="hljs-type">Msg</span> <span class="hljs-variable">systemMsg</span> <span class="hljs-operator">=</span> Msg.builder()
    .role(MsgRole.SYSTEM)
    .textContent(
        <span class="hljs-string">"你是一个专业的技术文档撰写员。\n"</span> +
        <span class="hljs-string">"你的职责是：\n"</span> +
        <span class="hljs-string">"1. 将复杂的技术概念用简洁的语言解释\n"</span> +
        <span class="hljs-string">"2. 提供代码示例\n"</span> +
        <span class="hljs-string">"3. 遵循 Markdown 格式"</span>
    )
    .build();

<span class="hljs-comment">// 或在ReActAgent中设置</span>
<span class="hljs-type">ReActAgent</span> <span class="hljs-variable">agent</span> <span class="hljs-operator">=</span> ReActAgent.builder()
    .sysPrompt(<span class="hljs-string">"你是一个专业的技术文档撰写员..."</span>)
    .build();
</code></pre>
<p><strong>特点</strong>：</p>
<ul>
<li>在对话开始时发送给LLM</li>
<li>指导Agent的行为和输出格式</li>
<li>通常不会改变（除非需要更新Agent的人设）</li>
</ul>
<p><strong>关键用途</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SYSTEM</span>消息定义的内容包括：
├─ Agent的角色和背景
├─ 行为规则和约束
├─ 输出格式要求
├─ 处理特殊情况的指示
└─ 可信度和安全性指导
</code></pre>
<h4 data-id="heading-19">4. TOOL 角色</h4>
<p><strong>定义</strong>：工具执行结果消息</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 工具执行后返回的消息</span>
<span class="hljs-type">Msg</span> <span class="hljs-variable">toolResultMsg</span> <span class="hljs-operator">=</span> Msg.builder()
    .role(MsgRole.TOOL)
    .name(<span class="hljs-string">"database_query_tool"</span>)  <span class="hljs-comment">// 工具名称</span>
    .textContent(<span class="hljs-string">"SELECT * FROM users WHERE id='123' RETURNED: ..."</span>)
    .metadata(Map.of(
        <span class="hljs-string">"tool_call_id"</span>, <span class="hljs-string">"call_abc123"</span>,  <span class="hljs-comment">// 关联到原始工具调用</span>
        <span class="hljs-string">"execution_time"</span>, <span class="hljs-number">45</span>,            <span class="hljs-comment">// 执行耗时（毫秒）</span>
        <span class="hljs-string">"success"</span>, <span class="hljs-literal">true</span>
    ))
    .build();
</code></pre>
<p><strong>特点</strong>：</p>
<ul>
<li>由工具执行器生成</li>
<li>包含工具的执行结果</li>
<li>通常包含关键的元数据（如执行时间、错误信息等）</li>
</ul>
<p><strong>工具调用-结果流程</strong>：</p>
<pre><code class="hljs">Agent思考：需要查询数据库
  ↓
Agent发起工具调用（ToolUseBlock）
  ↓
ToolExecutor执行工具
  ↓
生成TOOL角色的消息，包含结果
  ↓
Agent接收结果，继续推理
</code></pre>
<h3 data-id="heading-20">2.2.2 消息角色在ReAct循环中的应用</h3>
<pre><code class="hljs language-csharp" lang="csharp">第<span class="hljs-number">1</span>轮对话：
┌─────────────────────────────────────┐
│ USER: <span class="hljs-string">"计算过去30天的平均销售额"</span>     │
└────────────────┬────────────────────┘
                 ↓
         [<span class="hljs-meta">Agent推理阶段</span>]
                 ↓
┌─────────────────────────────────────┐
│ ASSISTANT: 思考过程...               │
│ <span class="hljs-string">"我需要：                             │
│  1. 查询过去30天的销售数据            │
│  2. 计算平均值                        │
│  调用 query_sales 工具..."</span>           │
└────────────────┬────────────────────┘
                 ↓
         [<span class="hljs-meta">Agent行动阶段</span>]
                 ↓
┌─────────────────────────────────────┐
│ TOOL: query_sales 返回结果            │
│ [{<span class="hljs-string">"date"</span>: <span class="hljs-string">"2024-01-01"</span>, <span class="hljs-string">"amount"</span>: ...}] │
└────────────────┬────────────────────┘
                 ↓
        [<span class="hljs-meta">Agent继续推理</span>]
                 ↓
┌─────────────────────────────────────┐
│ ASSISTANT: 最终答案                   │
│ <span class="hljs-string">"过去30天的平均销售额为 ¥50,000"</span>    │
└─────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-21">2.2.3 多轮对话中的消息组织</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 模拟一个完整的多轮对话流程</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">demonstrateMultiRoundConversation</span><span class="hljs-params">()</span> {
    <span class="hljs-type">ReActAgent</span> <span class="hljs-variable">agent</span> <span class="hljs-operator">=</span> ReActAgent.builder()
        .name(<span class="hljs-string">"SalesAnalyst"</span>)
        .sysPrompt(<span class="hljs-string">"你是一个销售分析专家。..."</span>)
        .model(model)
        .toolkit(toolkit)
        .build();
    
    <span class="hljs-comment">// 第1轮：用户提问</span>
    System.out.println(<span class="hljs-string">"=== 第1轮对话 ==="</span>);
    <span class="hljs-type">Msg</span> <span class="hljs-variable">userMsg1</span> <span class="hljs-operator">=</span> Msg.builder()
        .role(MsgRole.USER)
        .textContent(<span class="hljs-string">"过去7天的销售趋势是什么？"</span>)
        .build();
    
    <span class="hljs-type">Msg</span> <span class="hljs-variable">response1</span> <span class="hljs-operator">=</span> agent.call(userMsg1).block();
    System.out.println(<span class="hljs-string">"Agent: "</span> + response1.getTextContent());
    <span class="hljs-comment">// 内部消息流：</span>
    <span class="hljs-comment">//   USER消息 → Memory记录 → Model推理</span>
    <span class="hljs-comment">//   → ASSISTANT消息 → 调用工具</span>
    <span class="hljs-comment">//   → TOOL消息 → 记录结果</span>
    <span class="hljs-comment">//   → ASSISTANT消息（最终） → 返回给用户</span>
    
    <span class="hljs-comment">// 第2轮：基于第1轮结果的追问</span>
    System.out.println(<span class="hljs-string">"\n=== 第2轮对话 ==="</span>);
    <span class="hljs-type">Msg</span> <span class="hljs-variable">userMsg2</span> <span class="hljs-operator">=</span> Msg.builder()
        .role(MsgRole.USER)
        .textContent(<span class="hljs-string">"对比去年同期，增长了多少？"</span>)
        .build();
    
    <span class="hljs-type">Msg</span> <span class="hljs-variable">response2</span> <span class="hljs-operator">=</span> agent.call(userMsg2).block();
    System.out.println(<span class="hljs-string">"Agent: "</span> + response2.getTextContent());
    <span class="hljs-comment">// Agent自动从Memory获得第1轮的对话上下文</span>
    <span class="hljs-comment">// 因此能够理解"去年同期"的含义</span>
}
</code></pre>
<hr/>
<h2 data-id="heading-22">2.3 内容块（ContentBlock）系统</h2>
<h3 data-id="heading-23">2.3.1 ContentBlock的设计</h3>
<h4 data-id="heading-24">为什么需要内容块系统？</h4>
<pre><code class="hljs language-arduino" lang="arduino">场景：一个对话中可能包含
├─ 用户的文本问题：<span class="hljs-string">"请分析这张销售报表"</span>
├─ 用户上传的图表图片：PNG格式，编码为Base64
├─ Agent的推理过程：对图表的理解
├─ Agent调用的工具：数据库查询工具
└─ 工具的返回结果：查询到的数据

问题：如何用统一的方式表达这些不同类型的内容？

方案：使用多态的ContentBlock体系
└─ 每种内容类型都是ContentBlock的实现
   通过模式匹配处理不同类型
</code></pre>
<h4 data-id="heading-25">ContentBlock的继承结构</h4>
<pre><code class="hljs language-python" lang="python">ContentBlock（sealed <span class="hljs-keyword">class</span>，已密封）
├── TextBlock          <span class="hljs-comment"># 纯文本内容</span>
├── ThinkingBlock      <span class="hljs-comment"># Agent的推理/思考过程</span>
├── ImageBlock         <span class="hljs-comment"># 图像内容</span>
├── AudioBlock         <span class="hljs-comment"># 音频内容</span>
├── VideoBlock         <span class="hljs-comment"># 视频内容</span>
├── ToolUseBlock       <span class="hljs-comment"># 工具调用请求</span>
└── ToolResultBlock    <span class="hljs-comment"># 工具执行结果</span>
</code></pre>
<p><strong>为什么使用sealed class？</strong></p>
<pre><code class="hljs language-java" lang="java">优势<span class="hljs-number">1</span>：类型安全
└─ 编译器确保只有声明的子类存在

优势<span class="hljs-number">2</span>：模式匹配支持
└─ <span class="hljs-keyword">switch</span>表达式可以穷举所有情况

优势<span class="hljs-number">3</span>：性能优化
└─ 编译器可以进行更多优化

示例：
<span class="hljs-type">ContentBlock</span> <span class="hljs-variable">block</span> <span class="hljs-operator">=</span> ...;
<span class="hljs-type">String</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">switch</span> (block) {
    <span class="hljs-keyword">case</span> TextBlock tb -&gt; tb.getText();
    <span class="hljs-keyword">case</span> ImageBlock ib -&gt; <span class="hljs-string">"[Image: "</span> + ib.getSource().getUrl() + <span class="hljs-string">"]"</span>;
    <span class="hljs-keyword">case</span> ToolUseBlock tub -&gt; <span class="hljs-string">"Tool call: "</span> + tub.getName();
    <span class="hljs-comment">// ... 编译器确保所有情况都被处理</span>
};
</code></pre>
<h3 data-id="heading-26">2.3.2 核心内容块详解</h3>
<h4 data-id="heading-27">1. TextBlock - 文本内容</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 创建文本块</span>
<span class="hljs-type">TextBlock</span> <span class="hljs-variable">textBlock</span> <span class="hljs-operator">=</span> TextBlock.builder()
    .text(<span class="hljs-string">"这是一个文本块"</span>)
    .build();

<span class="hljs-comment">// 简化创建方式</span>
<span class="hljs-type">Msg</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> Msg.builder()
    .textContent(<span class="hljs-string">"这是一条消息"</span>)  <span class="hljs-comment">// 自动创建TextBlock</span>
    .build();

<span class="hljs-comment">// 实际应用</span>
<span class="hljs-type">TextBlock</span> <span class="hljs-variable">systemPrompt</span> <span class="hljs-operator">=</span> TextBlock.builder()
    .text(<span class="hljs-string">"你是一个专业的技术顾问。"</span> +
          <span class="hljs-string">"你的回答应该：\n"</span> +
          <span class="hljs-string">"1. 准确\n"</span> +
          <span class="hljs-string">"2. 清晰易懂\n"</span> +
          <span class="hljs-string">"3. 包含实例代码"</span>)
    .build();
</code></pre>
<p><strong>应用场景</strong>：</p>
<ul>
<li>用户输入</li>
<li>Agent推理结果</li>
<li>系统提示词</li>
<li>一般的文本响应</li>
</ul>
<h4 data-id="heading-28">2. ThinkingBlock - 推理过程</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 某些模型（如Claude 3.5 Sonnet）支持返回思考过程</span>
<span class="hljs-type">ThinkingBlock</span> <span class="hljs-variable">thinkingBlock</span> <span class="hljs-operator">=</span> ThinkingBlock.builder()
    .thinking(<span class="hljs-string">"让我分析这个问题：\n"</span> +
              <span class="hljs-string">"1. 首先，我需要理解用户的需求\n"</span> +
              <span class="hljs-string">"2. 然后，我需要找到相关的信息\n"</span> +
              <span class="hljs-string">"3. 最后，我需要整合这些信息并生成答案"</span>)
    .build();

<span class="hljs-comment">// 消息中的thinking块</span>
<span class="hljs-type">Msg</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> Msg.builder()
    .role(MsgRole.ASSISTANT)
    .content(
        thinkingBlock,  <span class="hljs-comment">// 模型的思考过程</span>
        TextBlock.builder().text(<span class="hljs-string">"基于上述分析，答案是..."</span>).build()
    )
    .build();
</code></pre>
<p><strong>应用场景</strong>：</p>
<ul>
<li>理解Agent的推理逻辑</li>
<li>调试Agent行为</li>
<li>提高输出的可解释性</li>
</ul>
<h4 data-id="heading-29">3. ImageBlock - 图像内容</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 方式1：Base64编码（推荐用于小文件）</span>
<span class="hljs-type">String</span> <span class="hljs-variable">base64Image</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(
    Files.readAllBytes(Paths.get(<span class="hljs-string">"chart.png"</span>))
);
<span class="hljs-type">ImageBlock</span> <span class="hljs-variable">imageBlock1</span> <span class="hljs-operator">=</span> ImageBlock.builder()
    .source(Base64Source.builder()
        .data(base64Image)
        .mediaType(<span class="hljs-string">"image/png"</span>)  <span class="hljs-comment">// 必需：指定MIME类型</span>
        .build())
    .build();

<span class="hljs-comment">// 方式2：URL引用（推荐用于大文件或网络图片）</span>
<span class="hljs-type">ImageBlock</span> <span class="hljs-variable">imageBlock2</span> <span class="hljs-operator">=</span> ImageBlock.builder()
    .source(URLSource.builder()
        .url(<span class="hljs-string">"https://example.com/dashboard-screenshot.png"</span>)
        .build())
    .build();

<span class="hljs-comment">// 创建含图的消息</span>
<span class="hljs-type">Msg</span> <span class="hljs-variable">imgMsg</span> <span class="hljs-operator">=</span> Msg.builder()
    .role(MsgRole.USER)
    .name(<span class="hljs-string">"user_123"</span>)
    .content(
        TextBlock.builder().text(<span class="hljs-string">"请分析这张图片中的数据趋势"</span>).build(),
        imageBlock2  <span class="hljs-comment">// 添加图像</span>
    )
    .build();
</code></pre>
<p><strong>支持的图像格式</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">image/png         <span class="hljs-comment"># PNG格式</span>
image/jpeg        <span class="hljs-comment"># JPEG格式</span>
image/gif         <span class="hljs-comment"># GIF格式</span>
image/webp        <span class="hljs-comment"># WebP格式（现代浏览器支持）</span>
</code></pre>
<p><strong>生产场景示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 产品截图分析</span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">analyzeProductScreenshot</span><span class="hljs-params">(String imagePath)</span> {
    <span class="hljs-type">byte</span>[] imageBytes = Files.readAllBytes(Paths.get(imagePath));
    <span class="hljs-type">String</span> <span class="hljs-variable">base64</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(imageBytes);
    
    <span class="hljs-type">ImageBlock</span> <span class="hljs-variable">screenshot</span> <span class="hljs-operator">=</span> ImageBlock.builder()
        .source(Base64Source.builder()
            .data(base64)
            .mediaType(<span class="hljs-string">"image/png"</span>)
            .build())
        .build();
    
    <span class="hljs-type">Msg</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> Msg.builder()
        .role(MsgRole.USER)
        .content(
            TextBlock.builder().text(<span class="hljs-string">"请识别这个产品界面中的问题"</span>).build(),
            screenshot
        )
        .build();
    
    <span class="hljs-keyword">return</span> agent.call(msg).block().getTextContent();
}
</code></pre>
<h4 data-id="heading-30">4. AudioBlock 和 VideoBlock</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 音频块</span>
<span class="hljs-type">AudioBlock</span> <span class="hljs-variable">audioBlock</span> <span class="hljs-operator">=</span> AudioBlock.builder()
    .source(Base64Source.builder()
        .data(base64AudioData)
        .mediaType(<span class="hljs-string">"audio/mp3"</span>)  <span class="hljs-comment">// audio/wav, audio/mpeg等</span>
        .build())
    .build();

<span class="hljs-comment">// 视频块（通常用URL引用）</span>
<span class="hljs-type">VideoBlock</span> <span class="hljs-variable">videoBlock</span> <span class="hljs-operator">=</span> VideoBlock.builder()
    .source(URLSource.builder()
        .url(<span class="hljs-string">"https://example.com/demo-video.mp4"</span>)
        .build())
    .build();

<span class="hljs-comment">// 包含音视频的消息</span>
<span class="hljs-type">Msg</span> <span class="hljs-variable">multimodalMsg</span> <span class="hljs-operator">=</span> Msg.builder()
    .role(MsgRole.USER)
    .content(
        TextBlock.builder().text(<span class="hljs-string">"请转录这段音频"</span>).build(),
        audioBlock
    )
    .build();
</code></pre>
<p><strong>支持的格式</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">音频：audio/mp3, audio/wav, audio/mpeg
视频：video/mp4, video/mpeg, video/quicktime
</code></pre>
<h4 data-id="heading-31">5. ToolUseBlock - 工具调用</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Agent决定调用工具时生成此块</span>
<span class="hljs-type">ToolUseBlock</span> <span class="hljs-variable">toolUseBlock</span> <span class="hljs-operator">=</span> ToolUseBlock.builder()
    .id(<span class="hljs-string">"call_12345"</span>)  <span class="hljs-comment">// 工具调用ID</span>
    .name(<span class="hljs-string">"query_database"</span>)  <span class="hljs-comment">// 工具名称</span>
    .arguments(Map.of(  <span class="hljs-comment">// 工具参数</span>
        <span class="hljs-string">"sql"</span>, <span class="hljs-string">"SELECT * FROM users WHERE age &gt; 30"</span>,
        <span class="hljs-string">"limit"</span>, <span class="hljs-number">100</span>
    ))
    .build();

<span class="hljs-comment">// 包含工具调用的Agent响应</span>
<span class="hljs-type">Msg</span> <span class="hljs-variable">agentMsg</span> <span class="hljs-operator">=</span> Msg.builder()
    .role(MsgRole.ASSISTANT)
    .content(
        TextBlock.builder()
            .text(<span class="hljs-string">"我需要查询数据库以获得答案"</span>)
            .build(),
        toolUseBlock  <span class="hljs-comment">// 工具调用请求</span>
    )
    .build();

<span class="hljs-comment">// ToolUseBlock的内部结构</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ToolUseBlock</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ContentBlock</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String id;              <span class="hljs-comment">// 唯一标识本次调用</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String name;            <span class="hljs-comment">// 工具名称</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, Object&gt; arguments;  <span class="hljs-comment">// 参数</span>
}
</code></pre>
<p><strong>工具调用流程</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Agent</span>判断需要调用工具
  ↓
生成<span class="hljs-title class_">ToolUseBlock</span>
  ↓
<span class="hljs-title class_">ToolExecutor</span>发现该块
  ↓
根据tool name找到实际工具方法
  ↓
将<span class="hljs-variable language_">arguments</span>转换为方法参数
  ↓
执行工具方法
  ↓
将结果包装为<span class="hljs-title class_">ToolResultBlock</span>
</code></pre>
<h4 data-id="heading-32">6. ToolResultBlock - 工具结果</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 工具执行完后生成此块</span>
<span class="hljs-type">ToolResultBlock</span> <span class="hljs-variable">toolResultBlock</span> <span class="hljs-operator">=</span> ToolResultBlock.builder()
    .id(<span class="hljs-string">"call_12345"</span>)  <span class="hljs-comment">// 对应的工具调用ID</span>
    .name(<span class="hljs-string">"query_database"</span>)  <span class="hljs-comment">// 工具名称</span>
    .content(<span class="hljs-string">"SELECT returned 42 rows:\n[{\"id\": 1, ...}, ...]"</span>)  <span class="hljs-comment">// 结果内容</span>
    .isError(<span class="hljs-literal">false</span>)  <span class="hljs-comment">// 是否出错</span>
    .build();

<span class="hljs-comment">// 在Agent响应中表示工具执行成功</span>
<span class="hljs-type">Msg</span> <span class="hljs-variable">toolResult</span> <span class="hljs-operator">=</span> Msg.builder()
    .role(MsgRole.TOOL)
    .name(<span class="hljs-string">"query_database"</span>)
    .content(toolResultBlock)
    .metadata(Map.of(
        <span class="hljs-string">"execution_time"</span>, <span class="hljs-number">123</span>,  <span class="hljs-comment">// 毫秒</span>
        <span class="hljs-string">"row_count"</span>, <span class="hljs-number">42</span>
    ))
    .build();

<span class="hljs-comment">// 工具执行失败的情况</span>
<span class="hljs-type">ToolResultBlock</span> <span class="hljs-variable">errorBlock</span> <span class="hljs-operator">=</span> ToolResultBlock.builder()
    .id(<span class="hljs-string">"call_12346"</span>)
    .name(<span class="hljs-string">"query_database"</span>)
    .content(<span class="hljs-string">"Error: Database connection timeout after 30s"</span>)
    .isError(<span class="hljs-literal">true</span>)  <span class="hljs-comment">// 标记为错误</span>
    .build();
</code></pre>
<h3 data-id="heading-33">2.3.3 内容块的实际应用</h3>
<h4 data-id="heading-34">场景1：多模态问答</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 用户上传多张图表并提问</span>
<span class="hljs-type">Msg</span> <span class="hljs-variable">userQuery</span> <span class="hljs-operator">=</span> Msg.builder()
    .role(MsgRole.USER)
    .name(<span class="hljs-string">"analyst_alice"</span>)
    .content(
        TextBlock.builder()
            .text(<span class="hljs-string">"请对比这两张月度销售报表，找出主要差异和趋势"</span>)
            .build(),
        ImageBlock.builder()
            .source(URLSource.builder()
                .url(<span class="hljs-string">"https://cdn.example.com/sales_jan.png"</span>)
                .build())
            .build(),
        ImageBlock.builder()
            .source(URLSource.builder()
                .url(<span class="hljs-string">"https://cdn.example.com/sales_feb.png"</span>)
                .build())
            .build()
    )
    .build();

<span class="hljs-comment">// Agent处理</span>
<span class="hljs-type">Msg</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> agent.call(userQuery).block();
<span class="hljs-comment">// Agent看到了两张图片，并理解了对比分析的需求</span>
</code></pre>
<h4 data-id="heading-35">场景2：包含推理过程的回复</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Agent返回思考过程和最终答案</span>
<span class="hljs-type">Msg</span> <span class="hljs-variable">agentResponse</span> <span class="hljs-operator">=</span> Msg.builder()
    .role(MsgRole.ASSISTANT)
    .name(<span class="hljs-string">"AnalysisBot"</span>)
    .content(
        ThinkingBlock.builder()
            .thinking(
                <span class="hljs-string">"让我分析这两个月的数据：\n"</span> +
                <span class="hljs-string">"1月的销售额在100-150万之间\n"</span> +
                <span class="hljs-string">"2月的销售额在120-180万之间\n"</span> +
                <span class="hljs-string">"看起来整体趋势向上..."</span>)
            .build(),
        TextBlock.builder()
            .text(
                <span class="hljs-string">"根据分析：\n"</span> +
                <span class="hljs-string">"- 2月销售额平均上升15%\n"</span> +
                <span class="hljs-string">"- 新产品线贡献了30%的增长\n"</span> +
                <span class="hljs-string">"- 建议加大营销投入"</span>)
            .build()
    )
    .build();
</code></pre>
<h4 data-id="heading-36">场景3：工具调用和结果链</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 模拟完整的工具调用流程</span>
<span class="hljs-type">Msg</span> <span class="hljs-variable">agentWithToolCall</span> <span class="hljs-operator">=</span> Msg.builder()
    .role(MsgRole.ASSISTANT)
    .content(
        TextBlock.builder()
            .text(<span class="hljs-string">"我需要查询最新的库存数据来回答你的问题"</span>)
            .build(),
        ToolUseBlock.builder()
            .id(<span class="hljs-string">"call_001"</span>)
            .name(<span class="hljs-string">"get_inventory"</span>)
            .arguments(Map.of(<span class="hljs-string">"product_id"</span>, <span class="hljs-string">"SKU-2024-001"</span>))
            .build()
    )
    .build();

<span class="hljs-comment">// 工具执行后返回结果</span>
<span class="hljs-type">Msg</span> <span class="hljs-variable">toolExecution</span> <span class="hljs-operator">=</span> Msg.builder()
    .role(MsgRole.TOOL)
    .name(<span class="hljs-string">"get_inventory"</span>)
    .content(
        ToolResultBlock.builder()
            .id(<span class="hljs-string">"call_001"</span>)
            .name(<span class="hljs-string">"get_inventory"</span>)
            .content(<span class="hljs-string">"{\"product_id\": \"SKU-2024-001\", \"stock\": 5000}"</span>)
            .isError(<span class="hljs-literal">false</span>)
            .build()
    )
    .build();

<span class="hljs-comment">// Agent继续推理并给出最终答案</span>
<span class="hljs-type">Msg</span> <span class="hljs-variable">finalResponse</span> <span class="hljs-operator">=</span> Msg.builder()
    .role(MsgRole.ASSISTANT)
    .textContent(<span class="hljs-string">"SKU-2024-001的库存为5000件，足以满足今年的销售计划。"</span>)
    .build();
</code></pre>
<hr/>
<h2 data-id="heading-37">2.4 消息元数据与结构化数据</h2>
<h3 data-id="heading-38">2.4.1 元数据的设计</h3>
<h4 data-id="heading-39">元数据的用途</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">元数据（Metadata）是关于消息本身的数据，包括：</span>

<span class="hljs-string">├─</span> <span class="hljs-string">消息关系元数据</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└─</span> <span class="hljs-attr">reply_to:</span> <span class="hljs-string">关联到哪条消息的回复</span>
<span class="hljs-string">│</span>
<span class="hljs-string">├─</span> <span class="hljs-string">业务元数据</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-attr">user_id:</span> <span class="hljs-string">消息所属的用户</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-attr">session_id:</span> <span class="hljs-string">消息所属的会话</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└─</span> <span class="hljs-attr">conversation_id:</span> <span class="hljs-string">消息所属的对话</span>
<span class="hljs-string">│</span>
<span class="hljs-string">├─</span> <span class="hljs-string">结构化数据</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-string">订单信息、用户信息等业务对象</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└─</span> <span class="hljs-string">直接存储为Map&lt;String,</span> <span class="hljs-string">Object&gt;</span>
<span class="hljs-string">│</span>
<span class="hljs-string">├─</span> <span class="hljs-string">技术元数据</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-attr">chat_usage:</span> <span class="hljs-string">Token使用统计</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-attr">cost:</span> <span class="hljs-string">API调用成本</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└─</span> <span class="hljs-attr">latency:</span> <span class="hljs-string">响应延迟</span>
<span class="hljs-string">│</span>
<span class="hljs-string">└─</span> <span class="hljs-string">扩展字段</span>
   <span class="hljs-string">└─</span> <span class="hljs-string">应用特定的任意键值对</span>
</code></pre>
<h3 data-id="heading-40">2.4.2 使用元数据存储结构化数据</h3>
<h4 data-id="heading-41">方式1：直接存储Map</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 简单的键值对</span>
<span class="hljs-type">Msg</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> Msg.builder()
    .role(MsgRole.ASSISTANT)
    .textContent(<span class="hljs-string">"订单已确认"</span>)
    .metadata(Map.of(
        <span class="hljs-string">"order_id"</span>, <span class="hljs-string">"ORD-2024-001"</span>,
        <span class="hljs-string">"total_price"</span>, <span class="hljs-number">1999.99</span>,
        <span class="hljs-string">"status"</span>, <span class="hljs-string">"confirmed"</span>,
        <span class="hljs-string">"items_count"</span>, <span class="hljs-number">3</span>
    ))
    .build();

<span class="hljs-comment">// 获取元数据</span>
Map&lt;String, Object&gt; metadata = msg.getMetadata();
<span class="hljs-type">String</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> (String) metadata.get(<span class="hljs-string">"order_id"</span>);
<span class="hljs-type">double</span> <span class="hljs-variable">price</span> <span class="hljs-operator">=</span> (<span class="hljs-type">double</span>) metadata.get(<span class="hljs-string">"total_price"</span>);
</code></pre>
<h4 data-id="heading-42">方式2：存储POJO对象</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 定义结构化数据类</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderData</span> {
    <span class="hljs-keyword">private</span> String orderId;
    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> totalPrice;
    <span class="hljs-keyword">private</span> String status;
    <span class="hljs-keyword">private</span> List&lt;OrderItem&gt; items;
    <span class="hljs-keyword">private</span> LocalDateTime createdTime;
}

<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderItem</span> {
    <span class="hljs-keyword">private</span> String productId;
    <span class="hljs-keyword">private</span> String productName;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> quantity;
    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> unitPrice;
}

<span class="hljs-comment">// 创建消息时存储对象</span>
<span class="hljs-type">OrderData</span> <span class="hljs-variable">orderData</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderData</span>();
orderData.setOrderId(<span class="hljs-string">"ORD-2024-001"</span>);
orderData.setTotalPrice(<span class="hljs-number">1999.99</span>);
orderData.setStatus(<span class="hljs-string">"confirmed"</span>);
<span class="hljs-comment">// ... 设置其他字段</span>

<span class="hljs-type">Msg</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> Msg.builder()
    .role(MsgRole.ASSISTANT)
    .textContent(<span class="hljs-string">"订单已确认"</span>)
    .metadata(Map.of(
        <span class="hljs-string">"order"</span>, orderData,  <span class="hljs-comment">// 存储对象</span>
        <span class="hljs-string">"operation_timestamp"</span>, System.currentTimeMillis()
    ))
    .build();

<span class="hljs-comment">// 获取时（推荐方式）</span>
<span class="hljs-keyword">if</span> (msg.hasStructuredData()) {
    <span class="hljs-type">OrderData</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> msg.getStructuredData(OrderData.class);
    System.out.println(<span class="hljs-string">"Order: "</span> + data.getOrderId());
}
</code></pre>
<h3 data-id="heading-43">2.4.3 生产场景：Token使用追踪</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// AgentScope自动在元数据中记录Token使用</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TokenUsageExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">ReActAgent</span> <span class="hljs-variable">agent</span> <span class="hljs-operator">=</span> ReActAgent.builder()
            .name(<span class="hljs-string">"GPTAgent"</span>)
            .model(DashScopeChatModel.builder()
                .apiKey(System.getenv(<span class="hljs-string">"DASHSCOPE_API_KEY"</span>))
                .modelName(<span class="hljs-string">"qwen-plus"</span>)
                .build())
            .build();
        
        <span class="hljs-comment">// 调用Agent</span>
        <span class="hljs-type">Msg</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> agent.call(
            Msg.builder().textContent(<span class="hljs-string">"用10句话概括人工智能的发展历史"</span>)
            .build()
        ).block();
        
        <span class="hljs-comment">// 获取Token使用统计</span>
        <span class="hljs-type">ChatUsage</span> <span class="hljs-variable">usage</span> <span class="hljs-operator">=</span> response.getChatUsage();
        <span class="hljs-keyword">if</span> (usage != <span class="hljs-literal">null</span>) {
            System.out.println(<span class="hljs-string">"=== Token Usage ==="</span>);
            System.out.println(<span class="hljs-string">"Input tokens: "</span> + usage.getInputTokens());
            System.out.println(<span class="hljs-string">"Output tokens: "</span> + usage.getOutputTokens());
            System.out.println(<span class="hljs-string">"Total tokens: "</span> + usage.getTotalTokens());
            System.out.println(<span class="hljs-string">"Time: "</span> + usage.getTime() + <span class="hljs-string">"s"</span>);
            
            <span class="hljs-comment">// 计算成本（假设DashScope千问模型的价格）</span>
            <span class="hljs-comment">// 输入：0.0001元/千token，输出：0.0002元/千token</span>
            <span class="hljs-type">double</span> <span class="hljs-variable">inputCost</span> <span class="hljs-operator">=</span> usage.getInputTokens() * <span class="hljs-number">0.0001</span> / <span class="hljs-number">1000</span>;
            <span class="hljs-type">double</span> <span class="hljs-variable">outputCost</span> <span class="hljs-operator">=</span> usage.getOutputTokens() * <span class="hljs-number">0.0002</span> / <span class="hljs-number">1000</span>;
            <span class="hljs-type">double</span> <span class="hljs-variable">totalCost</span> <span class="hljs-operator">=</span> inputCost + outputCost;
            
            System.out.printf(<span class="hljs-string">"Cost: ¥%.4f (Input: ¥%.4f, Output: ¥%.4f)\n"</span>,
                totalCost, inputCost, outputCost);
        }
    }
}

<span class="hljs-comment">// ChatUsage类的结构</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatUsage</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> inputTokens;        <span class="hljs-comment">// 输入token数</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> outputTokens;       <span class="hljs-comment">// 输出token数</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> totalTokens;        <span class="hljs-comment">// 总token数</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> time;             <span class="hljs-comment">// 响应时间（秒）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> cachedTokens;       <span class="hljs-comment">// 缓存token数（可选）</span>
}
</code></pre>
<hr/>
<h2 data-id="heading-44">2.5 消息的序列化与反序列化</h2>
<h3 data-id="heading-45">2.5.1 JSON序列化</h3>
<p>AgentScope使用Jackson框架处理消息的JSON序列化。通过<code>@JsonTypeInfo</code>和<code>@JsonSubTypes</code>注解，实现了多态JSON的自动处理。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 序列化：Msg → JSON</span>
<span class="hljs-type">Msg</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> Msg.builder()
    .role(MsgRole.USER)
    .name(<span class="hljs-string">"user_123"</span>)
    .content(
        TextBlock.builder().text(<span class="hljs-string">"Hello"</span>).build(),
        ImageBlock.builder()
            .source(URLSource.builder()
                .url(<span class="hljs-string">"https://example.com/image.png"</span>)
                .build())
            .build()
    )
    .metadata(Map.of(<span class="hljs-string">"user_id"</span>, <span class="hljs-string">"123"</span>))
    .build();

<span class="hljs-comment">// 自动转为JSON</span>
<span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">mapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();
<span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> mapper.writeValueAsString(msg);

<span class="hljs-comment">// 输出的JSON结构</span>
<span class="hljs-comment">/*
{
  "id": "msg_uuid",
  "name": "user_123",
  "role": "USER",
  "content": [
    {
      "type": "text",
      "text": "Hello"
    },
    {
      "type": "image",
      "source": {
        "type": "url",
        "url": "https://example.com/image.png"
      }
    }
  ],
  "metadata": {
    "user_id": "123"
  },
  "timestamp": "2024-01-15 10:30:45.123"
}
*/</span>

<span class="hljs-comment">// 反序列化：JSON → Msg</span>
<span class="hljs-type">Msg</span> <span class="hljs-variable">deserializedMsg</span> <span class="hljs-operator">=</span> mapper.readValue(json, Msg.class);
<span class="hljs-comment">// 自动根据"type"字段选择正确的ContentBlock子类</span>
</code></pre>
<h3 data-id="heading-46">2.5.2 消息的网络传输</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 场景：Agent在不同机器上运行，需要通过网络传输消息</span>

<span class="hljs-comment">// 发送端：将消息序列化并通过HTTP发送</span>
<span class="hljs-meta">@PostMapping("/api/agent/call")</span>
<span class="hljs-keyword">public</span> ResponseEntity&lt;String&gt; <span class="hljs-title function_">callAgent</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> String msgJson)</span> 
    <span class="hljs-keyword">throws</span> Exception {
    
    <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">mapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();
    <span class="hljs-type">Msg</span> <span class="hljs-variable">userMsg</span> <span class="hljs-operator">=</span> mapper.readValue(msgJson, Msg.class);
    
    <span class="hljs-type">Msg</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> agent.call(userMsg).block();
    
    <span class="hljs-type">String</span> <span class="hljs-variable">responseJson</span> <span class="hljs-operator">=</span> mapper.writeValueAsString(response);
    <span class="hljs-keyword">return</span> ResponseEntity.ok(responseJson);
}

<span class="hljs-comment">// 客户端：创建消息，序列化发送，反序列化接收</span>
<span class="hljs-keyword">public</span> Msg <span class="hljs-title function_">callRemoteAgent</span><span class="hljs-params">(String agentUrl, String userInput)</span> 
    <span class="hljs-keyword">throws</span> Exception {
    
    <span class="hljs-comment">// 1. 创建消息</span>
    <span class="hljs-type">Msg</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> Msg.builder()
        .role(MsgRole.USER)
        .textContent(userInput)
        .build();
    
    <span class="hljs-comment">// 2. 序列化</span>
    <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">mapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();
    <span class="hljs-type">String</span> <span class="hljs-variable">msgJson</span> <span class="hljs-operator">=</span> mapper.writeValueAsString(msg);
    
    <span class="hljs-comment">// 3. 通过HTTP POST发送</span>
    <span class="hljs-type">OkHttpClient</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OkHttpClient</span>();
    <span class="hljs-type">Request</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Request</span>.Builder()
        .url(agentUrl)
        .post(RequestBody.create(msgJson, MediaType.get(<span class="hljs-string">"application/json"</span>)))
        .build();
    
    <span class="hljs-type">Response</span> <span class="hljs-variable">httpResponse</span> <span class="hljs-operator">=</span> client.newCall(request).execute();
    <span class="hljs-type">String</span> <span class="hljs-variable">responseJson</span> <span class="hljs-operator">=</span> httpResponse.body().string();
    
    <span class="hljs-comment">// 4. 反序列化响应</span>
    <span class="hljs-type">Msg</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> mapper.readValue(responseJson, Msg.class);
    <span class="hljs-keyword">return</span> response;
}
</code></pre>
<hr/>
<h2 data-id="heading-47">2.6 消息在生产系统中的应用</h2>
<h3 data-id="heading-48">2.6.1 多轮对话管理</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConversationManager</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ReActAgent agent;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Memory conversationMemory;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;Msg&gt; messageHistory;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ConversationManager</span><span class="hljs-params">(ReActAgent agent)</span> {
        <span class="hljs-built_in">this</span>.agent = agent;
        <span class="hljs-built_in">this</span>.conversationMemory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryMemory</span>();
        <span class="hljs-built_in">this</span>.messageHistory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    }
    
    <span class="hljs-comment">/**
     * 添加用户消息并获得Agent回复
     */</span>
    <span class="hljs-keyword">public</span> Msg <span class="hljs-title function_">handleUserInput</span><span class="hljs-params">(String userId, String userInput)</span> {
        <span class="hljs-comment">// 1. 创建用户消息</span>
        <span class="hljs-type">Msg</span> <span class="hljs-variable">userMsg</span> <span class="hljs-operator">=</span> Msg.builder()
            .role(MsgRole.USER)
            .name(userId)
            .textContent(userInput)
            .metadata(Map.of(
                <span class="hljs-string">"user_id"</span>, userId,
                <span class="hljs-string">"timestamp"</span>, System.currentTimeMillis()
            ))
            .build();
        
        <span class="hljs-comment">// 2. 记录到历史</span>
        messageHistory.add(userMsg);
        
        <span class="hljs-comment">// 3. Agent处理（Agent内部会使用Memory维护上下文）</span>
        <span class="hljs-type">Msg</span> <span class="hljs-variable">agentResponse</span> <span class="hljs-operator">=</span> agent.call(userMsg).block();
        
        <span class="hljs-comment">// 4. 记录Agent响应</span>
        messageHistory.add(agentResponse);
        
        <span class="hljs-comment">// 5. 计算成本（如果有Token使用信息）</span>
        <span class="hljs-keyword">if</span> (agentResponse.getChatUsage() != <span class="hljs-literal">null</span>) {
            <span class="hljs-type">double</span> <span class="hljs-variable">cost</span> <span class="hljs-operator">=</span> calculateCost(agentResponse.getChatUsage());
            System.out.printf(<span class="hljs-string">"Total cost: ¥%.4f\n"</span>, cost);
        }
        
        <span class="hljs-keyword">return</span> agentResponse;
    }
    
    <span class="hljs-comment">/**
     * 获取会话历史的摘要（用于展示）
     */</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getSummary</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> messageHistory.stream()
            .map(msg -&gt; String.format(<span class="hljs-string">"[%s] %s: %s"</span>,
                msg.getRole(),
                msg.getName() != <span class="hljs-literal">null</span> ? msg.getName() : <span class="hljs-string">"unknown"</span>,
                msg.getTextContent()))
            .collect(Collectors.joining(<span class="hljs-string">"\n"</span>));
    }
    
    <span class="hljs-comment">/**
     * 清空会话（开始新对话）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clearHistory</span><span class="hljs-params">()</span> {
        messageHistory.clear();
        conversationMemory.clear();
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> <span class="hljs-title function_">calculateCost</span><span class="hljs-params">(ChatUsage usage)</span> {
        <span class="hljs-comment">// DashScope定价：输入0.0001元/千token，输出0.0002元/千token</span>
        <span class="hljs-keyword">return</span> (usage.getInputTokens() * <span class="hljs-number">0.0001</span> + 
                usage.getOutputTokens() * <span class="hljs-number">0.0002</span>) / <span class="hljs-number">1000</span>;
    }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
    <span class="hljs-type">ReActAgent</span> <span class="hljs-variable">agent</span> <span class="hljs-operator">=</span> ReActAgent.builder()
        .name(<span class="hljs-string">"Assistant"</span>)
        .sysPrompt(<span class="hljs-string">"你是一个有帮助的助手"</span>)
        .model(model)
        .build();
    
    <span class="hljs-type">ConversationManager</span> <span class="hljs-variable">conv</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConversationManager</span>(agent);
    
    <span class="hljs-comment">// 第1轮</span>
    <span class="hljs-type">Msg</span> <span class="hljs-variable">response1</span> <span class="hljs-operator">=</span> conv.handleUserInput(<span class="hljs-string">"user_001"</span>, <span class="hljs-string">"Python和Java的区别是什么？"</span>);
    System.out.println(<span class="hljs-string">"Assistant: "</span> + response1.getTextContent());
    
    <span class="hljs-comment">// 第2轮（Agent知道前面讨论过Python）</span>
    <span class="hljs-type">Msg</span> <span class="hljs-variable">response2</span> <span class="hljs-operator">=</span> conv.handleUserInput(<span class="hljs-string">"user_001"</span>, <span class="hljs-string">"那Python最适合用在哪些领域？"</span>);
    System.out.println(<span class="hljs-string">"Assistant: "</span> + response2.getTextContent());
    
    <span class="hljs-comment">// 显示对话历史</span>
    System.out.println(<span class="hljs-string">"\n=== Conversation Summary ==="</span>);
    System.out.println(conv.getSummary());
}
</code></pre>
<h3 data-id="heading-49">2.6.2 消息持久化</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MessagePersistence</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MongoTemplate mongoTemplate;  <span class="hljs-comment">// MongoDB数据库</span>
    
    <span class="hljs-comment">/**
     * 保存消息到数据库
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveMessage</span><span class="hljs-params">(String conversationId, Msg msg)</span> {
        <span class="hljs-type">Document</span> <span class="hljs-variable">doc</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Document</span>()
            .append(<span class="hljs-string">"conversation_id"</span>, conversationId)
            .append(<span class="hljs-string">"message_id"</span>, msg.getId())
            .append(<span class="hljs-string">"role"</span>, msg.getRole().toString())
            .append(<span class="hljs-string">"name"</span>, msg.getName())
            .append(<span class="hljs-string">"timestamp"</span>, msg.getTimestamp())
            .append(<span class="hljs-string">"content_text"</span>, msg.getTextContent())
            .append(<span class="hljs-string">"metadata"</span>, msg.getMetadata())
            .append(<span class="hljs-string">"saved_at"</span>, Instant.now());
        
        mongoTemplate.insert(doc, <span class="hljs-string">"messages"</span>);
    }
    
    <span class="hljs-comment">/**
     * 加载对话历史
     */</span>
    <span class="hljs-keyword">public</span> List&lt;Msg&gt; <span class="hljs-title function_">loadConversation</span><span class="hljs-params">(String conversationId)</span> {
        List&lt;Document&gt; docs = mongoTemplate.find(
            Query.query(Criteria.where(<span class="hljs-string">"conversation_id"</span>).is(conversationId)),
            Document.class,
            <span class="hljs-string">"messages"</span>
        );
        
        <span class="hljs-keyword">return</span> docs.stream()
            .map(<span class="hljs-built_in">this</span>::documentToMsg)
            .collect(Collectors.toList());
    }
    
    <span class="hljs-keyword">private</span> Msg <span class="hljs-title function_">documentToMsg</span><span class="hljs-params">(Document doc)</span> {
        <span class="hljs-keyword">return</span> Msg.builder()
            .id((String) doc.get(<span class="hljs-string">"message_id"</span>))
            .name((String) doc.get(<span class="hljs-string">"name"</span>))
            .role(MsgRole.valueOf((String) doc.get(<span class="hljs-string">"role"</span>)))
            .textContent((String) doc.get(<span class="hljs-string">"content_text"</span>))
            .timestamp((String) doc.get(<span class="hljs-string">"timestamp"</span>))
            .metadata((Map&lt;String, Object&gt;) doc.get(<span class="hljs-string">"metadata"</span>))
            .build();
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-50">总结</h2>
<h3 data-id="heading-51">核心概念回顾</h3>





























<table><thead><tr><th>概念</th><th>说明</th></tr></thead><tbody><tr><td><strong>Msg</strong></td><td>不可变的消息对象，是Agent间通信的基本单位</td></tr><tr><td><strong>MsgRole</strong></td><td>消息的四种角色（USER、ASSISTANT、SYSTEM、TOOL）</td></tr><tr><td><strong>ContentBlock</strong></td><td>支持多种内容类型的内容块系统（文本、图像、音视频等）</td></tr><tr><td><strong>Metadata</strong></td><td>消息的元数据，用于存储结构化数据和扩展信息</td></tr><tr><td><strong>序列化</strong></td><td>JSON序列化支持网络传输和持久化</td></tr></tbody></table>
<hr/>
<p>在下一章中，我们将深入探讨<strong>模型接口（Model）与适配器模式</strong>，了解如何在AgentScope中无缝使用不同的LLM。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[解构uv ：从使用到跨平台依赖解析、文件锁机制与 Monorepo 最佳实践]]></title>    <link>https://juejin.cn/post/7589246131586039843</link>    <guid>https://juejin.cn/post/7589246131586039843</guid>    <pubDate>2025-12-30T05:40:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589246131586039843" data-draft-id="7589275237037506595" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="解构uv ：从使用到跨平台依赖解析、文件锁机制与 Monorepo 最佳实践"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2025-12-30T05:40:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="doublegod"/> <meta itemprop="url" content="https://juejin.cn/user/2807487860332816"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            解构uv ：从使用到跨平台依赖解析、文件锁机制与 Monorepo 最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2807487860332816/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    doublegod
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T05:40:34.000Z" title="Tue Dec 30 2025 05:40:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body .octicon{display:inline-block;fill:currentColor;vertical-align:text-bottom}.markdown-body .anchor{float:left;line-height:1;margin-left:-20px;padding-right:4px}.markdown-body .anchor:focus{outline:none}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{color:#1b1f23;vertical-align:middle;visibility:hidden}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{text-decoration:none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{visibility:visible}.markdown-body h1:hover .anchor .octicon-link:before,.markdown-body h2:hover .anchor .octicon-link:before,.markdown-body h3:hover .anchor .octicon-link:before,.markdown-body h4:hover .anchor .octicon-link:before,.markdown-body h5:hover .anchor .octicon-link:before,.markdown-body h6:hover .anchor .octicon-link:before{width:16px;height:16px;content:" ";display:inline-block;background-image:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' aria-hidden='true'%3E%3Cpath fill-rule='evenodd' d='M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z'/%3E%3C/svg%3E")}.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#24292e;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;font-size:16px;line-height:1.5;word-wrap:break-word}.markdown-body details{display:block}.markdown-body summary{display:list-item}.markdown-body a{background-color:initial}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body strong{font-weight:inherit;font-weight:bolder}.markdown-body h1{margin:.67em 0}.markdown-body img{border-style:none}.markdown-body code,.markdown-body kbd,.markdown-body pre{font-family:monospace,monospace;font-size:1em}.markdown-body hr{box-sizing:initial;overflow:visible}.markdown-body input{font:inherit;margin:0;overflow:visible}.markdown-body [type=checkbox]{box-sizing:border-box;padding:0}.markdown-body *{box-sizing:border-box}.markdown-body input{font-family:inherit;font-size:inherit;line-height:inherit}.markdown-body a{color:#0366d6;text-decoration:none}.markdown-body a:hover{text-decoration:underline}.markdown-body strong{font-weight:600}.markdown-body hr{height:0;margin:15px 0;overflow:hidden;background:transparent;border-bottom:1px solid #dfe2e5}.markdown-body hr:after,.markdown-body hr:before{display:table;content:""}.markdown-body hr:after{clear:both}.markdown-body table{border-spacing:0;border-collapse:collapse}.markdown-body td,.markdown-body th{padding:0}.markdown-body details summary{cursor:pointer}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:0;margin-bottom:0}.markdown-body h1{font-size:32px}.markdown-body h1,.markdown-body h2{font-weight:600}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:20px}.markdown-body h3,.markdown-body h4{font-weight:600}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:14px}.markdown-body h5,.markdown-body h6{font-weight:600}.markdown-body h6{font-size:12px}.markdown-body p{margin-top:0;margin-bottom:10px}.markdown-body blockquote{margin:0}.markdown-body ol,.markdown-body ul{padding-left:0;margin-top:0;margin-bottom:0}.markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman}.markdown-body ol ol ol,.markdown-body ol ul ol,.markdown-body ul ol ol,.markdown-body ul ul ol{list-style-type:lower-alpha}.markdown-body dd{margin-left:0}.markdown-body code,.markdown-body pre{font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px}.markdown-body pre{margin-top:0;margin-bottom:0}.markdown-body input::-webkit-inner-spin-button,.markdown-body input::-webkit-outer-spin-button{margin:0;-webkit-appearance:none;appearance:none}.markdown-body :checked+.radio-label{position:relative;z-index:1;border-color:#0366d6}.markdown-body .border{border:1px solid #e1e4e8!important}.markdown-body .border-0{border:0!important}.markdown-body .border-bottom{border-bottom:1px solid #e1e4e8!important}.markdown-body .rounded-1{border-radius:3px!important}.markdown-body .bg-white{background-color:#fff!important}.markdown-body .bg-gray-light{background-color:#fafbfc!important}.markdown-body .text-gray-light{color:#6a737d!important}.markdown-body .pl-3,.markdown-body .px-3{padding-left:16px!important}.markdown-body .px-3{padding-right:16px!important}.markdown-body .f6{font-size:12px!important}.markdown-body .lh-condensed{line-height:1.25!important}.markdown-body .text-bold{font-weight:600!important}.markdown-body .pl-c{color:#6a737d}.markdown-body .pl-c1,.markdown-body .pl-s .pl-v{color:#005cc5}.markdown-body .pl-e,.markdown-body .pl-en{color:#6f42c1}.markdown-body .pl-s .pl-s1,.markdown-body .pl-smi{color:#24292e}.markdown-body .pl-ent{color:#22863a}.markdown-body .pl-k{color:#d73a49}.markdown-body .pl-pds,.markdown-body .pl-s,.markdown-body .pl-s .pl-pse .pl-s1,.markdown-body .pl-sr,.markdown-body .pl-sr .pl-cce,.markdown-body .pl-sr .pl-sra,.markdown-body .pl-sr .pl-sre{color:#032f62}.markdown-body .pl-smw,.markdown-body .pl-v{color:#e36209}.markdown-body .pl-bu{color:#b31d28}.markdown-body .pl-ii{color:#fafbfc;background-color:#b31d28}.markdown-body .pl-c2{color:#fafbfc;background-color:#d73a49}.markdown-body .pl-c2:before{content:"^M"}.markdown-body .pl-sr .pl-cce{font-weight:700;color:#22863a}.markdown-body .pl-ml{color:#735c0f}.markdown-body .pl-mh,.markdown-body .pl-mh .pl-en,.markdown-body .pl-ms{font-weight:700;color:#005cc5}.markdown-body .pl-mi{font-style:italic;color:#24292e}.markdown-body .pl-mb{font-weight:700;color:#24292e}.markdown-body .pl-md{color:#b31d28;background-color:#ffeef0}.markdown-body .pl-mi1{color:#22863a;background-color:#f0fff4}.markdown-body .pl-mc{color:#e36209;background-color:#ffebda}.markdown-body .pl-mi2{color:#f6f8fa;background-color:#005cc5}.markdown-body .pl-mdr{font-weight:700;color:#6f42c1}.markdown-body .pl-ba{color:#586069}.markdown-body .pl-sg{color:#959da5}.markdown-body .pl-corl{text-decoration:underline;color:#032f62}.markdown-body .mb-0{margin-bottom:0!important}.markdown-body .my-2{margin-bottom:8px!important;margin-top:8px!important}.markdown-body .pl-0{padding-left:0!important}.markdown-body .py-0{padding-top:0!important;padding-bottom:0!important}.markdown-body .pl-1{padding-left:4px!important}.markdown-body .pl-2{padding-left:8px!important}.markdown-body .py-2{padding-top:8px!important;padding-bottom:8px!important}.markdown-body .pl-3{padding-left:16px!important}.markdown-body .pl-4{padding-left:24px!important}.markdown-body .pl-5{padding-left:32px!important}.markdown-body .pl-6{padding-left:40px!important}.markdown-body .pl-7{padding-left:48px!important}.markdown-body .pl-8{padding-left:64px!important}.markdown-body .pl-9{padding-left:80px!important}.markdown-body .pl-10{padding-left:96px!important}.markdown-body .pl-11{padding-left:112px!important}.markdown-body .pl-12{padding-left:128px!important}.markdown-body hr{border-bottom-color:#eee}.markdown-body kbd{display:inline-block;padding:3px 5px;font:11px SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #d1d5da;border-radius:3px;box-shadow:inset 0 -1px 0 #d1d5da}.markdown-body:after,.markdown-body:before{display:table;content:""}.markdown-body:after{clear:both}.markdown-body&gt;:first-child{margin-top:0!important}.markdown-body&gt;:last-child{margin-bottom:0!important}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body blockquote,.markdown-body details,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body hr{height:.25em;padding:0;margin:24px 0;background-color:#e1e4e8;border:0}.markdown-body blockquote{padding:0 1em;color:#6a737d;border-left:.25em solid #dfe2e5}.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1{font-size:2em}.markdown-body h1,.markdown-body h2{padding-bottom:.3em;border-bottom:1px solid #eaecef}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{font-size:.85em;color:#6a737d}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li{word-wrap:break-all}.markdown-body li&gt;p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:600}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body table{display:block;width:100%;overflow:auto}.markdown-body table th{font-weight:600}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #dfe2e5}.markdown-body table tr{background-color:#fff;border-top:1px solid #c6cbd1}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}.markdown-body img{max-width:100%;box-sizing:initial;background-color:#fff}.markdown-body img[align=right]{padding-left:20px}.markdown-body img[align=left]{padding-right:20px}.markdown-body code{padding:.2em .4em;margin:0;font-size:85%;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body pre{word-wrap:normal}.markdown-body pre&gt;code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:transparent;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f6f8fa;border-radius:3px}.markdown-body pre code{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:initial;border:0}.markdown-body .commit-tease-sha{display:inline-block;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:90%;color:#444d56}.markdown-body .full-commit .btn-outline:not(:disabled):hover{color:#005cc5;border-color:#005cc5}.markdown-body .blob-wrapper{overflow-x:auto;overflow-y:hidden}.markdown-body .blob-wrapper-embedded{max-height:240px;overflow-y:auto}.markdown-body .blob-num{width:1%;min-width:50px;padding-right:10px;padding-left:10px;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;line-height:20px;color:rgba(27,31,35,.3);text-align:right;white-space:nowrap;vertical-align:top;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-body .blob-num:hover{color:rgba(27,31,35,.6)}.markdown-body .blob-num:before{content:attr(data-line-number)}.markdown-body .blob-code{position:relative;padding-right:10px;padding-left:10px;line-height:20px;vertical-align:top}.markdown-body .blob-code-inner{overflow:visible;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;color:#24292e;word-wrap:normal;white-space:pre}.markdown-body .pl-token.active,.markdown-body .pl-token:hover{cursor:pointer;background:#ffea7f}.markdown-body .tab-size[data-tab-size="1"]{-moz-tab-size:1;tab-size:1}.markdown-body .tab-size[data-tab-size="2"]{-moz-tab-size:2;tab-size:2}.markdown-body .tab-size[data-tab-size="3"]{-moz-tab-size:3;tab-size:3}.markdown-body .tab-size[data-tab-size="4"]{-moz-tab-size:4;tab-size:4}.markdown-body .tab-size[data-tab-size="5"]{-moz-tab-size:5;tab-size:5}.markdown-body .tab-size[data-tab-size="6"]{-moz-tab-size:6;tab-size:6}.markdown-body .tab-size[data-tab-size="7"]{-moz-tab-size:7;tab-size:7}.markdown-body .tab-size[data-tab-size="8"]{-moz-tab-size:8;tab-size:8}.markdown-body .tab-size[data-tab-size="9"]{-moz-tab-size:9;tab-size:9}.markdown-body .tab-size[data-tab-size="10"]{-moz-tab-size:10;tab-size:10}.markdown-body .tab-size[data-tab-size="11"]{-moz-tab-size:11;tab-size:11}.markdown-body .tab-size[data-tab-size="12"]{-moz-tab-size:12;tab-size:12}.markdown-body .task-list-item{list-style-type:none}.markdown-body .task-list-item+.task-list-item{margin-top:3px}.markdown-body .task-list-item input{margin:0 .2em .25em -1.6em;vertical-align:middle}</style><style data-highlight="" data-highlight-key="github">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>在介绍uv的用法及底层原理之前，我想先说说，uv的存在有什么意义，他解决了python的哪些痛点，以至于我们现在提到Python的项目与工具链管理器，就绕不开它。<br/>
现在假定，你重生了，重生到一个没有uv的世界，你将面对：</p>
<ul>
<li>
<p>1.破碎化的<strong>工具链</strong>：</p>
<ul>
<li>安装python版本： <code>pyenv</code>或<code>conda</code>。</li>
<li>创建虚拟环境： <code>virtualenv</code>、<code>venv</code>、<code>conda env</code>。</li>
<li>安装依赖包： <code>pip</code></li>
<li>锁定依赖版本： <code>pip-tools</code>，<code>pip-compile</code>。</li>
<li>发布包：用 <code>twine</code> 和 <code>build</code>。</li>
<li>安装全局命令行工具：用 <code>pipx</code>。<br/>
就算是整合工具portry也有没能涵盖到python版本管理的范畴等等缺憾。你不得不阅读复杂的指南来研究这些工具如何配合。<br/>
这是一个讲传统 Python 打包与分发流程教程<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F690046657" target="_blank" title="https://zhuanlan.zhihu.com/p/690046657" ref="nofollow noopener noreferrer">创建、管理与分发你的Python项目</a> 想了解的话可以看看。</li>
</ul>
</li>
<li>
<p>2.缓慢的<strong>解析性能</strong>：</p>
<ul>
<li>
<p>传统 Python 工具因为解释器自身的开销，难以利用多核 CPU 加速复杂的**依赖回溯（Backtracking）**计算。这导致在安装如 Torch 等大型库时，解析过程超级慢。</p>
</li>
<li>
<p>尤其pip使用的是回溯算法，在python的GIL限制下，单线程解析性能很差。</p>
</li>
</ul>
<blockquote>
<p>这是关于GIL的一些解析<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F20813097758" target="_blank" title="https://zhuanlan.zhihu.com/p/20813097758" ref="nofollow noopener noreferrer">Python GIL（全局解释器锁）机制对多线程性能影响的深度分析</a> ，不过python新版本的更新正在朝无GIL发展，<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.freex.cc%2Farchives%2FPython-3-14-Free-Threading.html" target="_blank" title="https://www.freex.cc/archives/Python-3-14-Free-Threading.html" ref="nofollow noopener noreferrer">解锁 Python 多线程新纪元</a></p>
</blockquote>
</li>
<li>
<p>3.<strong>标准化的分裂</strong></p>
</li>
<li>
<p>4.<strong>缺乏跨平台的一致性</strong>：</p>
<ul>
<li>某些包在不同操作系统上依赖树不一样，<code>pip freeze</code>只能看到当前环境的依赖，无法保证在其他平台上重现相同的<strong>依赖树</strong>。</li>
<li>python允许通过<strong>环境标记</strong>来按需安装依赖，例如：<code>colorama; sys_platform == 'win32' </code>(只在 Windows 下安装)。然而<code>pip freeze</code>不会记录这些条件依赖，导致在不同平台上安装时可能缺少必要的包。</li>
<li>缺乏锁文件，go有go.sum。node.js有package-lock.json/yarn/lock。python你呢！<br/>
requirements.txt只是当前环境的依赖快照，并不属于全平台解析的结果。关于lockfile可以参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgavv.net%2Farticles%2Ffile-locks%2F" target="_blank" title="https://gavv.net/articles/file-locks/" ref="nofollow noopener noreferrer">File locking in Linux</a> ,Linux内核现在主要支持的是<strong>建议性锁 (Advisory Locking)</strong> ，文档里的<strong>Mandatory Locking</strong>已经寄了。本质上python加的锁是在"遥控"linux系统底层文件锁功能，如何给python实现加锁？<a href="https://link.juejin.cn?target=https%3A%2F%2Fcomate.baidu.com%2Fzh%2Fpage%2Fg1htjf7u8qi" target="_blank" title="https://comate.baidu.com/zh/page/g1htjf7u8qi" ref="nofollow noopener noreferrer">Python文件锁实现与跨平台优化方案</a></li>
</ul>
</li>
</ul>
<h2 data-id="heading-1">how to uv</h2>
<p>吓哭了吧！没关系！你的强来了！<br/>
uv 继承了 Rye 的“全栈工具链”愿景，并在底层实现了更高的性能。</p>
<blockquote>
<p><code>uv（unified version）</code> 不仅仅是更快的 <code>pip</code>。它是 Python 生态的 <strong>Cargo (Rust)</strong>  —— 一个统一了 Python 版本管理、虚拟环境、依赖解析、项目构建与发布的<strong>全链路工具链</strong>。</p>
</blockquote>
<p>详细使用可以看官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.astral.sh%2Fuv%2F" target="_blank" title="https://docs.astral.sh/uv/" ref="nofollow noopener noreferrer">docs.astral.sh/uv/</a></p>
<h3 data-id="heading-2">1. 安装与配置</h3>
<p>推荐使用官方脚本安装（与系统 Python 解耦）：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># macOS / Linux</span>
curl -LsSf https://astral.sh/uv/install.sh | sh

<span class="hljs-comment"># Windows (PowerShell)</span>
powershell -ExecutionPolicy ByPass -c <span class="hljs-string">"irm https://astral.sh/uv/install.ps1 | iex"</span>
</code></pre>
<p><strong>配置自动补全</strong><br/>
能很大提升 CLI 体验。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Zsh</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">'eval "$(uv generate-shell-completion zsh)"'</span> &gt;&gt; ~/.zshrc
<span class="hljs-built_in">source</span> ~/.zshrc
<span class="hljs-comment"># bash</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">'eval "$(uv generate-shell-completion bash)"'</span> &gt;&gt; ~/.bashrc
<span class="hljs-built_in">source</span> ~/.bashrc
<span class="hljs-comment"># powershell</span>
<span class="hljs-keyword">if</span> (!(Test-Path -Path <span class="hljs-variable">$PROFILE</span>)) {
  New-Item -ItemType File -Path <span class="hljs-variable">$PROFILE</span> -Force
}
uv generate-shell-completion powershell | Out-File -Append -Encoding utf8 <span class="hljs-variable">$PROFILE</span>
</code></pre>
<hr/>
<h3 data-id="heading-3">2. 核心工作流 (The Core Workflow)</h3>
<p>uv 默认会配置 Hatchling 当构建后端,配置标准为PEP 621 (pyproject.toml),核心引擎使用的是Rust编写的高性能解析器也就是uv本身。</p>
<h4 data-id="heading-4">2.1 初始化项目</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 初始化标准项目结构</span>
uv <span class="hljs-keyword">init</span> my-project
</code></pre>
<p>这会生成 <code>pyproject.toml</code>、<code>.python-version</code> 和 <code>uv.lock</code>（首次运行）。</p>
<h4 data-id="heading-5">2.2 锁定 Python 版本 (替代 pyenv)</h4>
<p>不依赖系统 Python，为项目锁定特定版本：</p>
<pre><code class="hljs">uv python pin 3.12
</code></pre>
<p>*默认下， <code>uv</code> 会自动下载一个独立的 Python 3.12 解释器缓存在系统级的应用数据目录（AppData 或 .local/share）下的 python 子目录中，使用 符号链接 (Symlink) 或 硬链接，让虚拟环境指向这个全局目录。</p>
<p><strong>常用管理命令</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">uv python install 3.11  <span class="hljs-comment"># 手动下载特定版本</span>
uv python list          <span class="hljs-comment"># 查看本机已安装的所有 Python 版本</span>
uv python uninstall 3.8 <span class="hljs-comment"># 卸载不需要的版本</span>
</code></pre>
<h4 data-id="heading-6">2.3 添加依赖 (替代 pip/poetry)</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 添加运行时依赖 (自动更新 pyproject.toml 和 uv.lock)</span>
uv <span class="hljs-keyword">add</span> fastapi httpx
<span class="hljs-meta"># 添加开发依赖</span>
uv <span class="hljs-keyword">add</span> --<span class="hljs-keyword">group</span> dev pytest ruff
<span class="hljs-meta"># 移除依赖</span>
uv <span class="hljs-keyword">remove</span> httpx
<span class="hljs-meta"># 部署上线的时候用这个告诉uv不要安装开发依赖。</span>
uv sync --no-dev
</code></pre>
<h4 data-id="heading-7">2.4 运行与执行</h4>
<p>无需手动激活环境！使用 <code>uv run</code>，它会自动在正确的环境中执行命令。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 运行脚本，自动创建临时环境并安装依赖</span>
uv run main.py
<span class="hljs-meta"># 向脚本添加依赖声明，自动修改脚本头部注释</span>
uv <span class="hljs-keyword">add</span> --script example.py requests
<span class="hljs-meta"># 运行模块</span>
uv run python -m http.server
<span class="hljs-meta"># 运行依赖中的工具</span>
uv run pytest
</code></pre>
<h4 data-id="heading-8">2.5 同步环境 (The Sync)</h4>
<p>当从 Git 拉取代码后，或者手动修改了 <code>pyproject.toml</code> 后，使用这个命令确保环境与声明一致：</p>
<pre><code class="hljs language-bash" lang="bash">uv <span class="hljs-built_in">sync</span>
</code></pre>
<ul>
<li><strong>作用</strong>：它会安装缺失的包，卸载多余的包，确保 <code>.venv</code> 严格等于 <code>uv.lock</code>。类似于一个<code>go mod tidy</code>plus版，还执行.venv的整理。</li>
</ul>
<hr/>
<h4 data-id="heading-9">2.6 全局工具管理</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 临时运行工具 (用完就扔)</span>
uvx / uv tool run

uv tool uninstall &lt;tool-name&gt;
uv tool install &lt;tool-name&gt;

<span class="hljs-comment"># 永久安装工具</span>
uv tool install black
<span class="hljs-comment"># 列出已安装工具</span>
uv tool list
<span class="hljs-comment"># 升级 Shell 配置 (确保工具在 PATH 中)</span>
uv tool update-shell
</code></pre>
<hr/>
<h3 data-id="heading-10">3. 一些特定依赖场景</h3>
<h4 data-id="heading-11">3.1 PyTorch 最佳实践 (CPU/CUDA 分离)</h4>
<blockquote>
<p>我们都知道pytorch有两种版本，cpu版虽然通用性强但是性能有限，cuda版将运算交给gpu，性能提升但是文件体积巨大，如果什么都不配置的话，mac和windows用户会默认下载cpu版本，linux会默认下载cuda版本，但是一旦你有特殊需求，你就需要手动指定，这个时候就会用到手动配置pytorch索引和环境标记。<br/>
利用 <code>marker</code> 和 <code>explicit</code> 标志，就可以实现精准控制不同平台的 Torch 版本下载。</p>
</blockquote>
<h5 data-id="heading-12"><strong>如何使用pytorch索引</strong>：</h5>
<p>某些情况下，你可能希望全平台使用torch cpu版本，这个时候第一步，先把pytorch索引添加到pyproject.toml中：</p>
<pre><code class="hljs language-ini" lang="ini">   <span class="hljs-comment"># CPU-only (仅限 CPU)</span>
   <span class="hljs-section">[[tool.uv.index]]</span>
   <span class="hljs-attr">name</span> = <span class="hljs-string">"pytorch-cpu"</span>
   <span class="hljs-attr">url</span> = <span class="hljs-string">"https://download.pytorch.org/whl/cpu"</span>
   <span class="hljs-attr">explicit</span> = <span class="hljs-literal">true</span>
</code></pre>
<p>使用 <code>explicit = true</code>，可以确保该索引仅用于 torch、torchvision 和其他 PyTorch 相关包，而不是用于像 jinja2 这样的通用依赖项，后者应继续从默认索引 (PyPI) 获取。<br/>
第二步，在 <code>pyproject.toml</code> 中为 torch 和 torchvision 指定索引源：</p>
<pre><code class="hljs language-ini" lang="ini">    <span class="hljs-section">[tool.uv.sources]</span>
    <span class="hljs-attr">torch</span> = [
      { index = <span class="hljs-string">"pytorch-cpu"</span> },
    ]
    <span class="hljs-attr">torchvision</span> = [
    { index = <span class="hljs-string">"pytorch-cpu"</span> },
   ]
</code></pre>
<p>然后它就变成一个在全平台使用cpu版本的pytorch啦！</p>
<h5 data-id="heading-13">使用环境标记配置加速器 (Configuring accelerators with environment markers)</h5>
<p>pytorch索引有一个问题：他是一刀切的，如果索引用的是cuda版本，那么mac用户不是炸了？<br/>
因此实际使用中，我们通常<strong>结合pytorch索引</strong>和<strong>环境标记</strong>来实现跨平台的CPU/CUDA版本控制。这样就可以准确控制不同操作系统下的不同pytorch版本。<br/>
以下就可以控制windows和mac用户安装cpu版本，linux用户安装cuda版本，其实就相当于if linux then cuda else cpu这种逻辑。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[project]</span>
<span class="hljs-attr">name</span> = <span class="hljs-string">"project"</span>
<span class="hljs-attr">version</span> = <span class="hljs-string">"0.1.0"</span>
<span class="hljs-attr">requires-python</span> = <span class="hljs-string">"&gt;=3.14.0"</span>
<span class="hljs-attr">dependencies</span> = [
  <span class="hljs-string">"torch&gt;=2.9.1"</span>,
  <span class="hljs-string">"torchvision&gt;=0.24.1"</span>,
]

<span class="hljs-section">[tool.uv.sources]</span>
<span class="hljs-attr">torch</span> = [
  { index = <span class="hljs-string">"pytorch-cpu"</span>, marker = <span class="hljs-string">"sys_platform != 'linux'"</span> },
  { index = <span class="hljs-string">"pytorch-cu128"</span>, marker = <span class="hljs-string">"sys_platform == 'linux'"</span> },
]
<span class="hljs-attr">torchvision</span> = [
  { index = <span class="hljs-string">"pytorch-cpu"</span>, marker = <span class="hljs-string">"sys_platform != 'linux'"</span> },
  { index = <span class="hljs-string">"pytorch-cu128"</span>, marker = <span class="hljs-string">"sys_platform == 'linux'"</span> },
]

<span class="hljs-section">[[tool.uv.index]]</span>
<span class="hljs-attr">name</span> = <span class="hljs-string">"pytorch-cpu"</span>
<span class="hljs-attr">url</span> = <span class="hljs-string">"https://download.pytorch.org/whl/cpu"</span>
<span class="hljs-attr">explicit</span> = <span class="hljs-literal">true</span>

<span class="hljs-section">[[tool.uv.index]]</span>
<span class="hljs-attr">name</span> = <span class="hljs-string">"pytorch-cu128"</span>
<span class="hljs-attr">url</span> = <span class="hljs-string">"https://download.pytorch.org/whl/cu128"</span>
<span class="hljs-attr">explicit</span> = <span class="hljs-literal">true</span>
</code></pre>
<h5 data-id="heading-14">uv pip接口</h5>
<blockquote>
<p>通常情况下的首选是<code>uv init/add sync</code>，但是有些场景：例如你不知道目标机器有没有显卡，或者需要兼容旧有的 requirements.txt 流程时，才使用 uv pip。</p>
</blockquote>
<p>他的特性是<strong>自动后端选择 (Automatic backend selection)</strong><br/>
uv 支持通过 <code>--torch-backend=auto </code>命令行参数（或 <code>UV_TORCH_BACKEND=auto</code> 环境变量）自动选择适当的 PyTorch 索引，如：<code>$ uv pip install torch --torch-backend=auto</code><br/>
启用后，uv 将查询已安装的 CUDA 驱动程序、AMD GPU 版本和 Intel GPU 的存在，然后为所有相关包（例如 torch、torchvision 等）使用最兼容的 PyTorch 索引。如果未找到此类 GPU，uv 将回退到仅 CPU 索引。uv 将继续遵守 PyTorch 生态系统之外任何包的现有索引配置。<br/>
也可以使用 <code>--torch-backend=cu126</code>（或 <code>UV_TORCH_BACKEND=cu126</code> 环境变量）选择特定的后端（例如 CUDA 12.8）。<br/>
目前，<code>--torch-backend</code> 仅在 uv pip 接口中可用。</p>
<p>⭐️pay attention:</p>
<ul>
<li>项目开发中使用 uv pip 安装包后，要手动补充包名到 pyproject.toml。</li>
<li>uv pip 不会更新锁文件 (uv.lock)</li>
</ul>
<h4 data-id="heading-15">3.2 配置私有源 (Private Mirror)</h4>
<p><strong>加速第三方库</strong><br/>
在 <code>pyproject.toml</code> 中配置：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[[tool.uv.index]]</span>
<span class="hljs-attr">name</span> = <span class="hljs-string">"tsinghua"</span>
<span class="hljs-attr">url</span> = <span class="hljs-string">"https://pypi.tuna.tsinghua.edu.cn/simple"</span>
<span class="hljs-attr">default</span> = <span class="hljs-literal">true</span>  <span class="hljs-comment"># 设为默认源，如果不用true的话，uv会把这个源当成备用。</span>
</code></pre>
<p><strong>加速python解释器下载</strong><br/>
uv会自动从官方源下载，如果速度偏慢，可以通过系统层面设置环境变量<br/>
<code>export UV_PYTHON_INSTALL_MIRROR="http://..."</code></p>
<hr/>
<h3 data-id="heading-16">4. Workspaces</h3>
<p>在一个仓库中管理多个相互依赖的包（如 <code>backend</code>, <code>library</code>, <code>worker</code>）。</p>
<h4 data-id="heading-17">4.1 什么时候使用workspaces</h4>
<p>首先，在说如何用uv进行管理时，得先提一句Workspaces 是为了“统一”和“协作”设计的，如果你需要“隔离”和“差异化”就不适合用。</p>
<p><strong>不适合使用workspaces</strong>的场景：</p>
<ul>
<li>
<ol>
<li><strong>依赖版本冲突</strong>：例如，子项目A要求pandas&gt;=2.0，子项目B要求pandas&lt;2.0。一个uv.lock无法同时满足。</li>
</ol>
</li>
<li>
<ol start="2">
<li><strong>需要独立的虚拟环境</strong>：workspaces创建的是一个巨大的虚拟环境，可能会产生项目A没有声明requests，但是B依赖requests,A竟然也能import requests的情况。</li>
</ol>
</li>
<li>
<ol start="3">
<li><strong>python版本不兼容</strong>。</li>
</ol>
</li>
</ul>
<p><strong>路径依赖 (Path Dependencies)</strong> ：<br/>
如果你属于那种不适合用workspaces的场景，但是又想在一个仓库管理多个项目，可以考虑使用路径依赖。<br/>
只需要修改使用者的 <code>pyproject.toml</code>，将依赖指向本地路径即可，示例如下：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[project]</span>
<span class="hljs-attr">name</span> = <span class="hljs-string">"my-backend"</span>
<span class="hljs-attr">version</span> = <span class="hljs-string">"0.1.0"</span>
<span class="hljs-attr">requires-python</span> = <span class="hljs-string">"&gt;=3.12"</span>
<span class="hljs-attr">dependencies</span> = [
    <span class="hljs-string">"fastapi"</span>,
    <span class="hljs-string">"my-shared-lib"</span>,
]

<span class="hljs-comment"># editable = true意味着它是可编辑模式安装。在 shared-lib 里改了代码，backend 不需要重新安装，立刻就能生效。</span>
<span class="hljs-section">[tool.uv.sources]</span>
<span class="hljs-attr">my-shared-lib</span> = { path = <span class="hljs-string">"../shared-lib"</span>, editable = <span class="hljs-literal">true</span> }
</code></pre>
<h4 data-id="heading-18">4.2 Monorepo vs Polyrepo</h4>
<blockquote>
<p>这俩属于代码仓库常见的物理架构，我最开始误以为monorepo和polyrepo属于workspaces的不同种类呢，实则不然啊。<br/>
在 uv（以及 Rust Cargo、npm、Yarn）的语境下，Workspaces 就是专门为 Monorepo 设计的工具特性。它不适用于 Polyrepo。<br/>
这篇文章对这俩进行了一下介绍：<a href="https://juejin.cn/post/7102435371127930887" target="_blank" title="https://juejin.cn/post/7102435371127930887">polyrepo -&gt; monorepo</a>。</p>
</blockquote>
<h4 data-id="heading-19">4.3 如何使用 uv 管理 Monorepo</h4>
<p>使用uv管理monorepo，其实就是通过 <code>pyproject.toml</code> 告诉 uv：“不要去 PyPI 下载这个包，去硬盘上的这个文件夹里找。”</p>
<h5 data-id="heading-20">1. 目录结构示例</h5>
<pre><code class="hljs language-scss" lang="scss">repo/
├── pyproject<span class="hljs-selector-class">.toml</span> (根配置：定义 workspace 成员)
├── uv<span class="hljs-selector-class">.lock</span>        (核心：全局单一锁文件)
└── packages/
    ├── api/       (子项目 A：依赖 common)
    └── common/    (子项目 B：被依赖库)
</code></pre>
<h5 data-id="heading-21">2. 根目录配置 (<code>repo/pyproject.toml</code>)</h5>
<p>这是 Workspace 的“总指挥”，负责圈定哪些文件夹属于这个大家庭。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[project]</span>
<span class="hljs-attr">name</span> = <span class="hljs-string">"my-monorepo-root"</span>
<span class="hljs-attr">requires-python</span> = <span class="hljs-string">"&gt;=3.12"</span>
<span class="hljs-comment"># 根目录通常不写具体业务依赖，只作为容器</span>

<span class="hljs-section">[tool.uv.workspace]</span>
<span class="hljs-attr">members</span> = [<span class="hljs-string">"packages/*"</span>]
</code></pre>
<h5 data-id="heading-22">3. 子项目引用配置 (<code>packages/api/pyproject.toml</code>)</h5>
<p>这是最关键的一步。假设 <code>api</code> 需要使用 <code>common</code> 包：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[project]</span>
<span class="hljs-attr">name</span> = <span class="hljs-string">"api"</span>
<span class="hljs-attr">version</span> = <span class="hljs-string">"0.1.0"</span>
<span class="hljs-attr">dependencies</span> = [
    <span class="hljs-string">"fastapi"</span>,
    <span class="hljs-string">"common"</span>,  <span class="hljs-comment">#  在这里直接写包名，保持标准兼容性</span>
]

<span class="hljs-section">[tool.uv.sources]</span>
<span class="hljs-comment"># 逻辑引用替代物理路径</span>
<span class="hljs-attr">common</span> = { workspace = <span class="hljs-literal">true</span> }
</code></pre>
<p><strong><code>{ workspace = true }</code> 的核心价值：</strong></p>
<ol>
<li><strong>逻辑解耦</strong>：你不需要写死 <code>path = "../common"</code> 这种脆弱的相对路径。即使你把 <code>common</code> 文件夹移动到别的地方，只要它还在 workspace 的 members 范围内，<code>uv</code> 都能自动找到它。</li>
<li><strong>安全阻断</strong>：它是一个“路由开关”，强制 <code>uv</code> 只在本地 workspace 查找该包，<strong>绝对禁止</strong>去 PyPI 下载。这能有效防止“依赖混淆攻击”（即有人在 PyPI 上发了一个同名的恶意包）。</li>
<li><strong>版本自动同步</strong>：<code>uv</code> 会自动读取本地 <code>common</code> 项目的版本号，无需手动维护版本约束。</li>
</ol>
<p><strong>最终效果</strong>：<br/>
执行 <code>uv sync</code> 会一次性解析所有子项目的依赖，且子项目之间的引用会自动识别为本地路径（Editable Install），无需手动执行 <code>pip install -e</code>。</p>
<hr/>
<h3 data-id="heading-23">5. Docker 容器化最佳实践</h3>
<p>官方文档原文，虽然我也是从这看来的。<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.astral.sh%2Fuv%2Fguides%2Fintegration%2Fdocker%2F%23verifying-image-provenance" target="_blank" title="https://docs.astral.sh/uv/guides/integration/docker/#verifying-image-provenance" ref="nofollow noopener noreferrer">Using uv in Docker</a><br/>
关于docker，推荐阅读<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1983650284468212206" target="_blank" title="https://zhuanlan.zhihu.com/p/1983650284468212206" ref="nofollow noopener noreferrer">从docker使用到底层原理</a> （自己给自己打广告见过没⸜₍๑•⌔•๑₎⸝ ）</p>
<ul>
<li>
<p>推荐使用 <code>COPY --from </code>模式从官方镜像中提取二进制文件。比使用安装脚本更安全、更可控。</p>
</li>
<li>
<p>推荐<strong>版本锁定</strong></p>
</li>
<li>
<p>推荐<strong>分层依赖</strong>安装与项目代码，启用<strong>挂载缓存</strong>，<strong>编译字节码</strong>。</p>
</li>
<li>
<p><strong>挂载卷</strong>：开发时将项目目录挂载到容器中，但必须排除虚拟环境。<br/>
使用匿名卷挂载 <code>.venv</code>，例如： <code>docker run ... --volume .:/app --volume /app/.venv</code>。</p>
</li>
<li>
<p><strong>非可编辑模式 (Non-editable)</strong> ：默认情况下 uv 以可编辑模式安装项目。在多阶段构建中，应使用<code>·--no-editable</code> 标志。这允许你在一个阶段安装环境，然后仅将虚拟环境（不包含源代码绑定）复制到最终镜像中。</p>
</li>
<li>
<p><strong>workspaces/Monorepo</strong> 需要特殊处理，初始同步：使用<code>--frozen</code>代替 <code>--locked</code>。因为在复制所有工作区成员的 <code>pyproject.toml </code>之前，<code>uv </code>无法断言锁文件是最新的。<br/>
排除工作区安装：初始同步时使用 <code>--no-install-workspace </code>标志。<br/>
最终同步：复制所有代码后，再使用 <code>--locked</code> 进行完整同步。</p>
<blockquote>
<p>对比polyrepo，直接<code>COPY</code> -&gt; <code>uv sync --locked</code>即可。</p>
</blockquote>
</li>
</ul>

<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 获取 uv</span>
FROM python:3.12-slim
COPY --from=ghcr.io/astral-sh/uv:0.9.18 /uv /uvx /bin/

WORKDIR /app

<span class="hljs-comment"># 2. 配置环境变量</span>
ENV UV_COMPILE_BYTECODE=1
ENV UV_LINK_MODE=copy
<span class="hljs-comment"># 确保不复制本地 venv (需配合 .dockerignore)</span>

<span class="hljs-comment"># 3. 安装依赖 (中间层优化)</span>
<span class="hljs-comment"># 利用缓存挂载和绑定挂载</span>
RUN --mount=<span class="hljs-built_in">type</span>=cache,target=/root/.cache/uv \
    --mount=<span class="hljs-built_in">type</span>=<span class="hljs-built_in">bind</span>,<span class="hljs-built_in">source</span>=uv.lock,target=uv.lock \
    --mount=<span class="hljs-built_in">type</span>=<span class="hljs-built_in">bind</span>,<span class="hljs-built_in">source</span>=pyproject.toml,target=pyproject.toml \
    uv <span class="hljs-built_in">sync</span> --locked --no-install-project --no-dev

<span class="hljs-comment"># 4. 复制项目代码</span>
COPY . /app

<span class="hljs-comment"># 5. 安装项目本身，禁用开发依赖</span>
RUN --mount=<span class="hljs-built_in">type</span>=cache,target=/root/.cache/uv \
    uv <span class="hljs-built_in">sync</span> --locked --no-dev

<span class="hljs-comment"># 6. 设置路径并运行</span>
ENV PATH=<span class="hljs-string">"/app/.venv/bin:<span class="hljs-variable">$PATH</span>"</span>
CMD [<span class="hljs-string">"uv"</span>, <span class="hljs-string">"run"</span>, <span class="hljs-string">"my_app"</span>]
</code></pre>
<hr/>
<h3 data-id="heading-24">6. 构建与发布 (Build &amp; Publish)</h3>
<p>替代 <code>build</code> 和 <code>twine</code>，实现一条龙发布。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 构建 Wheel 和 Source Distribution</span>
uv build
<span class="hljs-comment"># 发布到 PyPI (支持 Trusted Publishing)</span>
uv publish
</code></pre>
<blockquote>
<p>什么是<strong>pypl</strong>，<strong>wheel</strong>和<strong>sdist</strong>呢？<br/>
pypl是puyhon官方包管理与发布平台，像包的超市，你发布上去的东西其他人可以通过一行命令安装使用。<br/>
wheel和sdist是python包的两种分发格式，wheel（.whl)是编译好的二进制格式，安装速度快，sdist(.tar.gz)是源码格式，兼容性好。后者安装时需要进行编译，如果代码里有C语言的话，就要求用户有C语言编译器。</p>
</blockquote>
<hr/>
<h3 data-id="heading-25">7.维护与排查</h3>
<h4 data-id="heading-26">7.1 缓存管理</h4>
<p><code>uv</code> 的缓存机制（详见后续模块）非常激进，定期清理有助于释放空间。<br/>
<strong>什么时候需要清理缓存呢？</strong><br/>
发现硬盘红了，用工具扫描发现 ~/.cache/uv 竟然占了 10GB+，用<code>uv cache prune</code> 会删除很久没被引用的包。<br/>
<strong>什么时候用<code>uv cache clean</code>呢？</strong><br/>
A. 下载的文件损坏。虽然uv有哈希检验，但是极少数网络不稳定会导致缓存.whl文件损坏。<br/>
B. 强制更新未锁定的依赖。有的时候开发新库可能会出现你推了新代码但是没有更新版本号的情况，uv可能会因为缓存一直安装旧代码。<br/>
C. CI/CD 环境的纯净构建在构建 Docker 镜像或流水线时，为了确保环境绝对纯净，不复用旧缓存。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看缓存目录路径</span>
uv cache <span class="hljs-built_in">dir</span>
<span class="hljs-comment"># 删除所有过期/未使用的缓存</span>
uv cache prune
<span class="hljs-comment"># 暴力清空所有缓存 (仅在解决顽固报错时使用)</span>
uv cache clean
</code></pre>
<h4 data-id="heading-27">7.2 路径与环境查询</h4>
<p>第三方工具集成或者ide配置可能会用到。<br/>
例如想在 Docker 运行时把宿主机的缓存挂载进去，来加速容器内的构建时，会需要运行 <code>uv cache dir</code> 确认宿主机路径，然后写 <code>docker run -v $(uv cache dir):/root/.cache/uv</code>。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看 uv 管理的 Python 解释器安装位置</span>
uv python <span class="hljs-built_in">dir</span>
<span class="hljs-comment"># 查看 uv 全局工具的安装位置</span>
uv tool <span class="hljs-built_in">dir</span>
</code></pre>
<h4 data-id="heading-28">7.3 自身管理</h4>
<p>uv迭代很快的，可以考虑没事更新一下。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment"># 升级 uv 到最新版本</span>
uv <span class="hljs-built_in">self</span> update
<span class="hljs-comment"># 查看 uv 版本与环境信息</span>
uv <span class="hljs-built_in">self</span> info
</code></pre>
<h3 data-id="heading-29">8. 常用命令对照</h3>


















































<table><thead><tr><th>场景</th><th>旧方式 (Pip/Poetry)</th><th><strong>uv 方式</strong></th></tr></thead><tbody><tr><td><strong>创建环境</strong></td><td><code>python -m venv .venv</code></td><td><code>uv init</code> (自动管理)</td></tr><tr><td><strong>激活环境</strong></td><td><code>source .venv/bin/activate</code></td><td><strong><code>uv run &lt;cmd&gt;</code></strong>  (无需激活)</td></tr><tr><td><strong>安装包</strong></td><td><code>pip install reqs</code></td><td><code>uv add reqs</code></td></tr><tr><td><strong>开发依赖</strong></td><td><code>poetry add -D pytest</code></td><td><code>uv add --group dev pytest</code></td></tr><tr><td><strong>同步依赖</strong></td><td><code>pip install -r requirements.txt</code></td><td><strong><code>uv sync</code></strong> (强制一致)</td></tr><tr><td><strong>升级包</strong></td><td><code>pip install -U reqs</code></td><td><code>uv lock --upgrade-package reqs</code></td></tr><tr><td><strong>运行工具</strong></td><td><code>pipx run black</code></td><td><code>uvx black</code></td></tr><tr><td><strong>CI 安装</strong></td><td><code>pip install ...</code></td><td><code>uv sync --frozen</code></td></tr></tbody></table>
<hr/>
<h2 data-id="heading-30">uv的核心机制：</h2>
<blockquote>
<p>我希望上一个模块主要讲怎么用，这个模块就对上一个模块的操作进行一些解析补充。</p>
</blockquote>
<h3 data-id="heading-31">跨平台解析机制 (Universal Resolution)</h3>
<p>相较于pip生成的依赖列表是基于当前环境快照，uv的解析机制是平台无关的，它基于<strong>多平台依赖图 (Multi-platform Dependency Graph)</strong>  来生成一个统一的锁文件 <code>uv.lock</code>。<br/>
观<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.astral.sh%2Fuv%2Fconcepts%2Fresolution%2F%23learn-more" target="_blank" title="https://docs.astral.sh/uv/concepts/resolution/#learn-more" ref="nofollow noopener noreferrer">Resolution</a> 以及<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.astral.sh%2Fuv%2Freference%2Finternals%2Fresolver%2F%23resolver" target="_blank" title="https://docs.astral.sh/uv/reference/internals/resolver/#resolver" ref="nofollow noopener noreferrer">Resolver internals</a> 有感。原文怎么会写的这么长难句。</p>
<h4 data-id="heading-32">使用 <code>uv lock</code>时，发生了什么？</h4>
<h5 data-id="heading-33">逻辑层面上：“全量解析” (Universal Resolution)</h5>
<p>1.<strong>元数据查询 (Metadata Querying)</strong></p>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.ibm.com%2Fcn-zh%2Fthink%2Ftopics%2Fmetadata" target="_blank" title="https://www.ibm.com/cn-zh/think/topics/metadata" ref="nofollow noopener noreferrer">什么是元数据？</a> 一方面，它是检索、互操作性和数据治理的基础，另一方面，它是隐私泄露的高危区域，往往被低估。因此，元数据管理（Metadata Management）是数据仓库和数据湖成功的核心，而非边缘任务。</p>
</blockquote>
<p>uv 不只是下载包，而是首先向 PyPI 发起大规模的元数据查询。它会抓取目标包（如 numpy）的所有可用版本，以及这些版本在 Windows、Linux、macOS 等不同平台下的差异化定义。<br/>
它不只看“我能在本机装什么”，而是看“这个包在所有可能的系统上长什么样”。</p>
<p>2.<strong>构建抽象依赖图 (Abstract Dependency Graph)</strong></p>
<ul>
<li>uv 在内存中构建一个虚拟的、涵盖所有目标平台的<strong>依赖图谱 (Dependency Graph)</strong> 。</li>
<li>对比：传统的 pip 是“走一步看一步”（只针对当前环境），而 uv 是同时模拟出 Linux Python 3.9、Windows Python 3.12、macOS ARM64 等多种场景下的<strong>依赖树</strong>。</li>
</ul>
<p>3.<strong>约束求解 (Constraint Solving)</strong><br/>
利用高效<strong>PubGrub 算法 (PubGrub Algorithm)</strong> ，uv 在这个巨大的图谱中寻找一个最大公约数，也就是交集 (Intersection)。</p>
<blockquote>
<p>大手子们感兴趣的话可以看看pubgrub的内部算法：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpubgrub-rs-guide.pages.dev%2Finternals%2Fintro" target="_blank" title="https://pubgrub-rs-guide.pages.dev/internals/intro" ref="nofollow noopener noreferrer">Internals of the PubGrub algorithm</a></p>
</blockquote>
<ul>
<li>目标：找到一组版本组合，使得它们既能满足你的 pyproject.toml 要求，又能在所有目标平台上不冲突。</li>
<li>结果：如果不同平台需要不同的依赖（例如 Windows 需要 colorama 但 Linux 不需要），它会将带有**环境标记 (Environment Markers)**的条件表达式，明确地写入锁定文件中，而不是忽略它们。</li>
<li>提问！：会不会出现找不到交集的情况呢？<br/>
当然会，这就是Resolution Impossible（无法解析）或 Version Conflict（版本冲突）的情况，uv会抛出错误，此时pubgrub会生成一个推导链，方便调整依赖声明。<br/>
类似于下图：</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be9b9933364e4e89b31d25c304dc0005~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZG91YmxlZ29k:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767678034&amp;x-signature=KzwLejmoykt6ErMWvh%2BYrdEwTUQ%3D" alt="image.png" loading="lazy"/></p>
<p>4.<strong>生成锁定文件 (Lockfile Generation)</strong><br/>
最终生成的 uv.lock 文件不是一份简单的清单，而是一份通用账本 (Universal Ledger)。<br/>
它记录了所有第三方包的精确版本（Hash），包含在 A 情况下用 B 版本，在 C 情况下用 D 版本的完整决策树。这就确保了无论在谁的电脑上（Windows/Mac/Linux），只要拉取代码，整个单体仓库的依赖拓扑完全一致且即时同步。</p>
<h5 data-id="heading-34">物理层面：“文件锁” (File Locking)</h5>
<p>这是<code> uv lock</code> 能够高速并行且不崩溃（不同进程间不打架）的保障，对应之前在"背景"里提到的“Linux 文件锁机制”。在执行上述逻辑运算和随后的缓存写入时，uv 必须处理**并发 (Concurrency)**问题。</p>
<p>1.获取<strong>排他锁 (Acquiring Exclusive Lock)</strong>  在写入全局缓存（如下载新的 Wheel 包）或修改项目状态前，uv 会先在 .locks 目录中寻找对应的锁文件，并尝试获取文件锁 (File Lock)。</p>
<ul>
<li>
<p>目的：防止<strong>竞态条件 (Race Condition)</strong> 。比如，防止你在终端 A 运行<code> uv lock</code> 正在写入 numpy 的缓存时，终端 B 的<code>uv sync</code>突然把这个未写完的文件读走或覆盖。</p>
</li>
<li>
<p>什么是排他锁？<br/>
<strong>排他锁</strong>（也叫写锁、互斥锁 Mutex）是一种<strong>并发控制机制</strong>。它的规则非常简单且霸总：“我现在要占用这个资源（文件/数据库/内存），一次只准一个进程修改，在我用完之前，其他任何人（进程/线程）看都不准看。”<br/>
感觉它和gil是不是有点像，但是他们的层级，作用范围，目的都不一样。</p>
<blockquote>
<p>有没有人被各种各样的“锁”打晕了，我也。<br/>
总而言之，锁的硬度上：有劝导锁 (Advisory Lock)强制锁 (Mandatory Lock)。策略上有悲观锁 (Pessimistic Lock)乐观锁 (Optimistic Lock)无锁编程 (Lock-Free / Wait-Free)。锁的模式这个维度里有排他 (Exclusive / X锁)和共享 (Shared / S锁)。具体实现机制上有读写锁 (Read-Write Lock)互斥锁 (Mutex)自旋锁 (Spinlock)等等。除这四个维度，还有粒度，公平性，阻塞性的维度。锁在计算机体系中是分层存在的。期待有大佬能把这些整理一下੭ ˙ᗜ˙ ੭。</p>
</blockquote>
</li>
</ul>
<p>2.<strong>进程阻塞与协同 (Process Blocking &amp; Coordination)</strong>  如果检测到锁被占用（说明另一个 uv 进程正在忙），当前的<code>uv lock</code> 进程会进入<strong>阻塞 (Blocking)</strong>  状态，自动排队等待。</p>
<ul>
<li>因此，无需担心多开终端会搞坏环境，uv 会自动通过操作系统内核级的锁机制来协调顺序。</li>
</ul>
<p>3.<strong>原子性写入 (Atomic Write)</strong>  一旦计算完成并拿到锁，uv 会确保对 uv.lock 文件和缓存文件的写入是原子性 (Atomic) 的。这意味着文件要么全写好，要么全不写，不会出现“写了一半断电导致文件损坏”的情况。</p>
<hr/>
<h3 data-id="heading-35">uv Workspaces 内部运行机制</h3>
<p>uv workspaces机制类似于一个虚拟化的元项目管理器，运行uv sync时，它不只是简单轮询子项目，而是：</p>
<ol>
<li><strong>发现与拓扑构建 (Discovery &amp; Topology)</strong><br/>
在 uv 开始解决复杂的版本冲突或下载任何代码之前，他得先知道你本地硬盘有什么。</li>
</ol>
<ul>
<li>uv 首先读取根目录 pyproject.toml 中的 <code>tool.uv.workspace.members</code> 列表。</li>
<li>执行 <strong>glob 扩展</strong>，遍历文件系统以定位所有潜在的子项目目录，根据三重验证：a.路径匹配 b.pyproject.toml存在检查 c.元数据有效性 来确认。</li>
</ul>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.tencent.com%2Fdeveloper%2Farticle%2F2437910" target="_blank" title="https://cloud.tencent.com/developer/article/2437910" ref="nofollow noopener noreferrer">认识 Glob Pattern</a> ，遍历范围严格控制在工作区根目录及其子目录。</p>
</blockquote>
<ul>
<li>注意：此时还不会安装任何东西，只是建立<strong>工作区成员注册表（Workspace Member Registry）</strong> ，它把物理上的文件系统路径映射成了逻辑上的包名，让后续的依赖解析算法能够把本地文件夹当做现成的安装包来处理，就不再去pypl上找了。</li>
</ul>
<p>2.<strong>依赖聚合与统一 (Dependency Aggregation &amp; Unification)</strong><br/>
搞清楚了他们有啥，下一步就是把他们聚在一起。</p>
<p><strong>虚拟化合并</strong>：<br/>
uv 将 Root 的依赖和所有 Member 的依赖进行并集操作，构造出一个巨大的“虚拟项目”需求清单。它不是隔离解析 A 和 B，而是将整个 Monorepo 视为一个整体来处理。<br/>
(注：这个巨大的需求清单也就是在上文提到的 PubGrub 算法中进行统一求解)。<br/>
<strong>版本一致性仲裁 (Consistency Arbitration)</strong> ：<br/>
这其实就是前文的<strong>约束求解</strong>。</p>
<p>3.<strong>锁文件生成 (The Universal Lock)</strong><br/>
同上。</p>
<p><strong>开发态重写 (Development Rewriting)</strong> ：<br/>
这是 Workspace 在锁文件中的核心特征。对于注册表内的包引用（如 api 依赖 common），uv 会触发<strong>重写</strong>逻辑：</p>
<ul>
<li>不记录哈希：因为它时刻在变。</li>
<li>标记为 Editable：标记为可编辑模式。</li>
<li>指向相对路径：直接指向硬盘上的 ../packages/common。</li>
</ul>
<blockquote>
<p>重写机制其实有两种：<br/>
<strong>开发态重写 (Development Rewriting)</strong> ：发生在 <code>uv sync</code>，重写为相对路径（为了改代码生效）。<br/>
<strong>构建态重写 (Build Rewriting)</strong> ：发生在 <code>uv build</code>，重写为版本号（为了发布到 PyPI）。</p>
</blockquote>
<p>4.<strong>虚拟环境布局 (Environment Layout &amp; Strategy)</strong><br/>
uv需要让 Python 解释器在执行 import 语句时，能够“看见”并加载那个位置的代码。<br/>
默认情况下，uv 只在 根目录 创建一个 .venv。它不会污染子项目的文件夹。</p>
<p><strong>链接技术 (.pth Linkage)</strong> ：<br/>
简单来说，uv 利用了 Python 标准库 site 模块的一个原生特性，实现了一种“软连接”的效果。<br/>
<strong>Python 的 site 模块与 .pth 文件</strong></p>
<ul>
<li>Python 启动时，会自动导入一个叫 site 的内置模块。这个模块负责配置 sys.path（也就是 Python 查找包的路径列表）。</li>
<li>机制: Python 启动，site 模块开始工作。</li>
<li>它会扫描标准库路径（如 lib/site-packages）。然后查找该目录下所有后缀为 .pth 的文件。</li>
<li>执行：对于每一个 .pth 文件，Python 会读取其中的每一行，并将其作为路径添加到 sys.path 中。<br/>
在这个过程里，uv 不像 <code>pip install -e </code>. 那样生成复杂的 egg-link 或者去修改 easy-install.pth，而是直接生成一个专属的、纯净的 .pth 文件。</li>
</ul>
<p><strong>uv里的具体操作：</strong></p>
<ul>
<li>第三方库（如 pandas）：直接安装 wheel 到 .venv/lib/site-packages。</li>
<li>Workspace 成员：uv 使用 .pth 文件机制。它会在 site-packages 下创建特殊的 .pth 文件，内容仅仅是子项目源码目录的<strong>路径字符串</strong>。</li>
</ul>
<p>结果：当你 <code>import potions</code>时，Python 解释器读取 .pth 文件，直接跳转到 packages/potions/src 加载代码。从而实现毫秒级环境同步与热重载。</p>
<hr/>
<h2 data-id="heading-36">补充提问！</h2>
<p><strong>Q: 如果要发布子包到 PyPI，，<code>{ workspace = true }</code> 这种本地配置怎么办？会报错吗？</strong></p>
<p><strong>A: <strong>不用担心</strong>，<code>uv</code> 已经处理好了。</strong><br/>
它采用  <strong>“开发时用路径，构建时换版本”</strong>  的策略：</p>
<ol>
<li><strong>自动转换</strong>：<code>uv build</code> 会自动处理这一“脏活累活”，无需手动修改配置。</li>
<li><strong>解决矛盾</strong>：完美平衡了 Monorepo 的本地调试便利性与公网分发的标准化。</li>
</ol>
<p><strong>前提 &amp; 操作</strong><br/>
被依赖的子包（如 <code>common</code>）必须也发布到 PyPI。</p>
<ul>
<li><strong>步骤</strong>：先构建并发布底层 <code>common</code> -&gt; 再构建并发布上层 <code>api</code>。</li>
<li><strong>替代</strong>：使用 <code>uv publish</code> 的批量发布功能，它会尝试自动处理依赖顺序。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Day36 | Java中的线程池技术]]></title>    <link>https://juejin.cn/post/7589167252723499058</link>    <guid>https://juejin.cn/post/7589167252723499058</guid>    <pubDate>2025-12-30T05:41:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589167252723499058" data-draft-id="7589194558288560166" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Day36 | Java中的线程池技术"/> <meta itemprop="keywords" content="后端,Java,Java EE"/> <meta itemprop="datePublished" content="2025-12-30T05:41:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="懒惰蜗牛"/> <meta itemprop="url" content="https://juejin.cn/user/615342556327752"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Day36 | Java中的线程池技术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/615342556327752/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    懒惰蜗牛
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T05:41:54.000Z" title="Tue Dec 30 2025 05:41:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在上一篇文章<a href="https://juejin.cn/post/7588464673285455899" target="_blank" title="https://juejin.cn/post/7588464673285455899">Day35 | Java多线程入门</a>中，我们使用new Thread()来创建和启动线程。</p>
<p>通过这个过程了解了线程的一些基本概念和基础操作。</p>
<p>但是在实际的开发和真实的场景中，通过前文的方式使用线程有一些明显的弊端：</p>
<p>开销大：频繁地创建和销毁线程会消耗大量的系统资源。线程是一个重量级资源，创建过程涉及和操作系统的交互，成本很高。</p>
<p>不利于管理：没办法有效地控制并发线程的数量。如果请求量很大，无限制地创建线程很可能导致内存溢出，导致系统崩溃。</p>
<p>功能单一：new Thread()的方式功能很有限，很难实现任务的延迟执行、周期性执行，或者获取任务的执行结果等复杂需求。</p>
<p>所以在现实开发的过程中，我们通常都是使用Java5就引入的Executor框架。这个框架的核心就是线程池。</p>
<p>为了方便理解，后续的内容我们都围绕餐馆这个生活中的案例来阐述相关的概念。</p>
<p>如果你是一家餐馆的老板，每天都要处理大量的订单。</p>
<p>如果每来一个订单就雇一个新厨师（new Thread()），那你面临的问题就是：</p>
<p>雇人成本高（创建线程耗资源），厨房会被挤爆（内存溢出），而且那么多的厨师，你也管不过来。</p>
<p>最后，餐馆可能就倒闭了。</p>
<h2 data-id="heading-0">一、什么是线程池</h2>
<p>为了解决上面那些问题，Java5就引入了Executor框架（智能厨房），这个厨房里一支固定的厨师团队（线程），</p>
<p>一个订单队列（任务队列），和一个经理（线程池管理器），有订单（任务）来的时候：</p>
<p>如果有空闲厨师，马上就处理。</p>
<p>如果厨师忙不过来了，订单就先排着队。</p>
<p>如果队列满了，还可以临时加派厨师（但有上限）。</p>
<p>如果实在忙不过来了，经理会按策略拒绝新订单（比如让客户等会再来）。</p>
<p>Java的Executor框架就是扮演的这个经理的角色，核心组件有这些：</p>
<p>Executor: 顶级接口，只定义了一个execute(Runnable command)方法。</p>
<p>ExecutorService: Executor的子接口，也是我们最常使用的接口。它增加了线程池的生命周期管理（如shutdown()），并提供了submit()方法来提交可以返回结果的任务。</p>
<p>ScheduledExecutorService: ExecutorService的子接口，增加了对任务进行定时或周期性执行的支持。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a5e3f69f80c4be8858a79cd6ffe9a79~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oeS5oOw6JyX54mb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767678114&amp;x-signature=o4bdZeWFPbTt1SktDdbTAr5YUq0%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">二、线程池创建</h2>
<p>我们先用Executors工具类以简单的方式创建一些线程池，类似快速便捷的租一个现成的厨房团队。</p>
<h3 data-id="heading-2">2.1 FixedThreadPool</h3>
<p>固定人数的团队，雇佣指定数量的厨师，订单多了就排队。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.lazy.snail.day36;

<span class="hljs-keyword">import</span> java.util.concurrent.ExecutorService;
<span class="hljs-keyword">import</span> java.util.concurrent.Executors;

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@ClassName</span> Day36Demo
 * <span class="hljs-doctag">@Description</span> TODO
 * <span class="hljs-doctag">@Author</span> lazysnail
 * <span class="hljs-doctag">@Date</span> 2025/7/21 10:53
 * <span class="hljs-doctag">@Version</span> 1.0
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Day36Demo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">kitchen</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">3</span>);
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">5</span>; i++) {
            <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> i;
            kitchen.execute(() -&gt; System.out.println(<span class="hljs-string">"订单 "</span> + order + <span class="hljs-string">" 由 "</span> + Thread.currentThread().getName() + <span class="hljs-string">" 处理"</span>));
        }
        kitchen.shutdown();
    }
}
</code></pre>
<p>3个线程轮流处理5个订单，多的订单排队等待。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dee8ba0e14844ce18421df658f620335~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oeS5oOw6JyX54mb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767678114&amp;x-signature=tyl2rUOO4vzgXfIl27qL7GdZu%2Bc%3D" alt="" loading="lazy"/></p>
<p>订单队列没有上限（LinkedBlockingQueue），如果订单源源不断，可能撑爆内存。</p>
<h3 data-id="heading-3">2.2 CachedThreadPool</h3>
<p>类似临时工，忙的时候就加点人，空闲的时候就减少点人。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">ExecutorService</span> <span class="hljs-variable">kitchen</span> <span class="hljs-operator">=</span> Executors.newCachedThreadPool();
</code></pre>
<p>这种比较适合处理短时订单高峰的情况。</p>
<p>高峰期可能雇佣无数厨师（线程数可达Integer.MAX_VALUE），然后耗尽资源。</p>
<h3 data-id="heading-4">2.3 SingleThreadExecutor</h3>
<p>只有一个厨师，所有的订单都严格按照顺序处理。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">ExecutorService</span> <span class="hljs-variable">kitchen</span> <span class="hljs-operator">=</span> Executors.newSingleThreadExecutor();
</code></pre>
<p>这种适合需要顺序执行的任务，比如日志记录。</p>
<p>队列一样没有上限，可能导致内存溢出。</p>
<blockquote>
<p>《阿里巴巴Java开发手册》建议避免直接使用Executors，因为默认配置可能导致内存溢出。实际使用过程中，我们应该用ThreadPoolExecutor自定义线程池，自己当经理。</p>
</blockquote>
<h2 data-id="heading-5">三、自定义线程池</h2>
<p>ThreadPoolExecutor可以让我们完全的掌控"厨房"，能设置厨师数量、订单队列大小、处理策略等等。</p>
<h3 data-id="heading-6">3.1 核心参数</h3>
<p>ThreadPoolExecutor的构造方法：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b65bd94b77cf4cb4a2ff09c8f8d5a943~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oeS5oOw6JyX54mb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767678114&amp;x-signature=4BO2aSAxyr7WfAkAs2O8VGuq2RY%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">ThreadPoolExecutor</span><span class="hljs-params">(<span class="hljs-type">int</span> corePoolSize,
                              <span class="hljs-type">int</span> maximumPoolSize,
                              <span class="hljs-type">long</span> keepAliveTime,
                              TimeUnit unit,
                              BlockingQueue&lt;Runnable&gt; workQueue,
                              ThreadFactory threadFactory,
                              RejectedExecutionHandler handler)</span> {
}
</code></pre>
<p>corePoolSize：核心线程数，线程池中长期保持的线程数量，即使它们处于空闲状态。</p>
<p>你平时雇佣的固定厨师人数，即使没订单也不会开掉这些人。</p>
<p>maximumPoolSize：最大线程数，线程池能够容纳的最大线程数量。</p>
<p>高峰期的时候，最多能够雇佣多少厨师。</p>
<p>keepAliveTime：线程存活时间，当线程数大于corePoolSize的时候，多余的空闲线程在被销毁前等待新任务的最长时间。</p>
<p>临时厨师闲着多久会被解雇。</p>
<p>unit：keepAliveTime的时间单位。</p>
<p>workQueue：任务队列，用来保存等待执行的任务的阻塞队列。</p>
<p>订单排队的桌子，大小有限或无限。</p>
<p>threadFactory：线程工厂，用来创建新线程。一般用来自定义线程名称，方便问题排查。</p>
<p>给每个厨师取个名字，方便追踪谁在干活。</p>
<p>handler：拒绝策略，当队列已满且线程数达到maximumPoolSize时，怎么处理新提交的任务。</p>
<p>订单太多、桌子满了怎么办？是拒绝、还是扔掉老订单、还是直接让客户自己做？</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.lazy.snail.day36;

<span class="hljs-keyword">import</span> java.util.concurrent.*;

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@ClassName</span> CustomThreadPool
 * <span class="hljs-doctag">@Description</span> TODO
 * <span class="hljs-doctag">@Author</span> lazysnail
 * <span class="hljs-doctag">@Date</span> 2025/7/21 11:45
 * <span class="hljs-doctag">@Version</span> 1.0
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomThreadPool</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">kitchen</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
                <span class="hljs-number">2</span>,
                <span class="hljs-number">5</span>,
                <span class="hljs-number">60L</span>,
                TimeUnit.SECONDS,
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="hljs-number">10</span>),
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadFactory</span>() {
                    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
                    <span class="hljs-meta">@Override</span>
                    <span class="hljs-keyword">public</span> Thread <span class="hljs-title function_">newThread</span><span class="hljs-params">(Runnable r)</span> {
                        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(r, <span class="hljs-string">"厨师-"</span> + count++);
                    }
                },
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>.CallerRunsPolicy()
        );

        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">10</span>; i++) {
            <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> i;
            kitchen.submit(() -&gt; {
                <span class="hljs-keyword">try</span> {
                    Thread.sleep(<span class="hljs-number">1000</span>);
                    System.out.println(<span class="hljs-string">"订单 "</span> + order + <span class="hljs-string">" 由 "</span> + Thread.currentThread().getName() + <span class="hljs-string">" 处理"</span>);
                } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                    Thread.currentThread().interrupt();
                }
            });
        }

        kitchen.shutdown();
    }
}
</code></pre>
<p>上面的案例中，雇佣了2个固定厨师，最多能够容纳5个厨师，临时厨师如果空闲60秒就会被解雇。</p>
<p>订单的队列长度是10个，给每个厨师都起了名字，如果订单太多、桌子满了，就让客户自己做。</p>
<p>案例中模拟提交了10个订单由厨房处理。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf995be6086441178cb273ce1f5fb387~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oeS5oOw6JyX54mb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767678114&amp;x-signature=xSW4kyrat9fTrz12nR4IxCT6%2B0E%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>"订单太多，客户自己做"解释下。当把订单数量调整到16（超过15）时，由于线程池已满，触发CallerRunsPolicy，提交任务的主线程（main）就会自己执行第16个订单的任务。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/564711b0ea594083910a175190ef1ece~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oeS5oOw6JyX54mb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767678114&amp;x-signature=5f%2BcgrkcuNkTOUSNwdLjYNOVy3Q%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">3.2 拒绝策略</h3>
<p>RejectedExecutionHandler有四种，"订单太多，客户自己做"是其中的一种。</p>
<p>AbortPolicy（默认）：直接抛出RejectedExecutionException异常。</p>
<p>餐馆老板直接把客户赶走了，明确的告诉客户，太忙了，处理不过来了。</p>
<p>CallerRunsPolicy：不使用线程池的线程，而是由提交任务的那个线程自己来执行。</p>
<p>这个策略就是上面案例中的订单太多，客户自己做。</p>
<p>DiscardPolicy：默默地丢弃新提交的任务，不抛异常也不执行。</p>
<p>老板看有新客户下单了，又忙不过来，直接就把订单丢垃圾桶了，客户根本不知道，他可能以为还在排队。</p>
<p>DiscardOldestPolicy：丢弃队列中最老的任务，然后尝试重新提交新任务。</p>
<p>老板发现桌子满了，又有新订单来了，转了一圈，把等最久的单子丢了，先安排了新订单。</p>
<h3 data-id="heading-8">3.3 任务队列</h3>
<p>下面是一些常见的任务队列：</p>






























<table><thead><tr><th>队列类型</th><th>特点</th><th>关联的Executors方法</th></tr></thead><tbody><tr><td>ArrayBlockingQueue</td><td>有界队列，基于数组，FIFO。创建时需指定容量。</td><td>（无，需自定义创建）</td></tr><tr><td>LinkedBlockingQueue</td><td>无界队列（默认容量Integer.MAX_VALUE）。</td><td>newFixedThreadPool, newSingleThreadExecutor</td></tr><tr><td>SynchronousQueue</td><td>不存储元素的队列，每个插入操作必须等待一个移除操作。</td><td>newCachedThreadPool</td></tr><tr><td>PriorityBlockingQueue</td><td>带优先级的无界队列。</td><td>（无，需自定义创建）</td></tr></tbody></table>
<blockquote>
<p>实际开发优先使用ArrayBlockingQueue，避免任务无限堆积。</p>
</blockquote>
<h2 data-id="heading-9">四、线程池执行流程</h2>
<p>下面根据ThreadPoolExecutor的execute方法（openJdk17源码）大致梳理的一个线程池的执行流程。</p>
<h3 data-id="heading-10">4.1 检查核心线程</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">if</span> (workerCountOf(c) &lt; corePoolSize) {
    <span class="hljs-keyword">if</span> (addWorker(command, <span class="hljs-literal">true</span>)) <span class="hljs-comment">// true 表示“核心线程”</span>
        <span class="hljs-keyword">return</span>;
    c = ctl.get(); <span class="hljs-comment">// 重新读取线程池状态</span>
}
</code></pre>
<p>如果workerCount&lt;corePoolSize，尝试通过addWorker(command, true)添加核心线程。</p>
<p>如果成功，退出；否则，更新线程池状态，继续下一步。</p>
<h3 data-id="heading-11">4.2 任务入队</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">if</span> (isRunning(c) &amp;&amp; workQueue.offer(command)) {
    <span class="hljs-type">int</span> <span class="hljs-variable">recheck</span> <span class="hljs-operator">=</span> ctl.get();
    <span class="hljs-keyword">if</span> (! isRunning(recheck) &amp;&amp; remove(command)) <span class="hljs-comment">// 如果线程池被关闭了，任务要移出队列并拒绝</span>
        reject(command);
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (workerCountOf(recheck) == <span class="hljs-number">0</span>)        <span class="hljs-comment">// 如果线程池中没有线程了，要创建一个非核心线程</span>
        addWorker(<span class="hljs-literal">null</span>, <span class="hljs-literal">false</span>);
}
</code></pre>
<p>如果线程池是RUNNING且队列接受任务（workQueue.offer(command)），任务入队。</p>
<p>再一次检查状态：</p>
<p>如果不再是RUNNING且任务可移除，拒绝任务。</p>
<p>如果workerCount == 0，调用addWorker(null, false) 创建非核心线程处理队列。</p>
<h3 data-id="heading-12">4.3 检查非核心线程</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!addWorker(command, <span class="hljs-literal">false</span>)) <span class="hljs-comment">// false 表示非核心线程</span>
    reject(command);
</code></pre>
<p>如果队列已满或线程池非RUNNING，尝试通过addWorker(command, false) 创建非核心线程。</p>
<p>如果成功，任务被分配给新线程。</p>
<h3 data-id="heading-13">4.4 拒绝任务</h3>
<pre><code class="hljs language-java" lang="java">handler.rejectedExecution(command, <span class="hljs-built_in">this</span>);
</code></pre>
<p>如果addWorker(command, false) 失败，调用handler.rejectedExecution(command, this)执行拒绝策略。</p>
<blockquote>
<p>上面提到的核心线程和非核心线程本质上都是Worker实例，只是在创建时机和生命周期上有区别。</p>
</blockquote>
<h2 data-id="heading-14">五、任务提交和结果获取</h2>
<p>在线程池中，主要有两种方式来提交任务：execute(Runnable)和submit(Callable)。</p>
<p>其中execute(Runnable)它只管执行，不管结果。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@FunctionalInterface</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Runnable</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span>;
}
</code></pre>
<p>Runnable接口的run()方法签名是void run()，没办法返回任何计算结果。</p>
<p>run()方法签名没有声明throws Exception，在任务中发生了受检异常，必须在run()方法内部用try-catch块处理掉。</p>
<p>任务的执行结果（成功或失败）对于提交任务的主线程来说是完全未知的。</p>
<p>submit(Callable)是一个更加通用的任务提交方式。</p>
<p>Callable可以看成是Runnable的升级版，专门为需要返回结果的异步任务而设计。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@FunctionalInterface</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Callable</span>&lt;V&gt; {
    V <span class="hljs-title function_">call</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception;
}
</code></pre>
<p>跟Runnable相比，call()方法的返回值类型是泛型V，意味着你的任务可以返回任何类型的结果。</p>
<p>call()方法签名声明了throws Exception，这意味着你可以在任务中抛出受检异常，不需要在内部try-catch。</p>
<p>这个异常可以被任务的提交者捕获到。</p>
<p>当使用submit(Callable)提交任务时，方法不会阻塞，他会马上返回一个Future对象。</p>
<p>可以把这个返回的Future对象看成一个提货单，拿到它之后，就可以暂时去干别的事情了。</p>
<p>这个提货单有以下几个功能：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d423c7f44eb4476bd2739d0fe9f28fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oeS5oOw6JyX54mb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767678114&amp;x-signature=FVdHKOrGMYe4uRePxZLI7X4urqM%3D" alt="" loading="lazy"/></p>
<p>V get(): 这是提货的方法。你想来拿结果的时候，就调用这个方法。</p>
<p>如果任务已经完成，会返回Callable的call()方法计算出的结果。</p>
<p>如果任务还没完成，调用get()的线程会阻塞（暂停并等待），直到任务完成为止。</p>
<p>V get(long timeout, TimeUnit unit): get()带超时的版本。</p>
<p>如果在指定时间内任务还没完成，就会抛出TimeoutException，避免无限期等待。</p>
<p>boolean isDone(): 检查任务完成没有（无论是正常结束、异常终止还是被取消）。这是一个非阻塞方法。</p>
<p>boolean cancel(boolean mayInterruptIfRunning): 尝试取消任务。</p>
<blockquote>
<p>全文提到的"尝试取消"、"尝试提交"、"尝试关闭"这类用词，其实是线程池设计的一个核心思想。线程池中大部分的操作都是"请求"，而不是"命令"。调用者通过"请求"来表达想干什么事情，而整个线程池系统什么时候，怎么处理这个请求，取决于它自身的内部状态、规则和资源情况。而不是像"命令"一样，收到就马上、直接、强制的去执行并响应。</p>
</blockquote>
<p>看一个submit(Callable)+Future的案例：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.lazy.snail.day36;

<span class="hljs-keyword">import</span> java.util.concurrent.*;

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@ClassName</span> CallableFutureTest
 * <span class="hljs-doctag">@Description</span> TODO
 * <span class="hljs-doctag">@Author</span> lazysnail
 * <span class="hljs-doctag">@Date</span> 2025/7/21 16:09
 * <span class="hljs-doctag">@Version</span> 1.0
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CallableFutureTest</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
                <span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">60L</span>, TimeUnit.SECONDS, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="hljs-number">10</span>)
        );

        Callable&lt;Integer&gt; task = () -&gt; {
            Thread.sleep(<span class="hljs-number">1000</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-number">42</span>;
        };

        Future&lt;Integer&gt; future = pool.submit(task);
        System.out.println(<span class="hljs-string">"任务已提交..."</span>);

        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Integer</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> future.get();
            System.out.println(<span class="hljs-string">"结果: "</span> + result);
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            System.err.println(<span class="hljs-string">"任务被中断: "</span> + e.getMessage());
            Thread.currentThread().interrupt();
        } <span class="hljs-keyword">catch</span> (ExecutionException e) {
            System.err.println(<span class="hljs-string">"任务执行失败: "</span> + e.getCause());
        } <span class="hljs-keyword">finally</span> {
            pool.shutdown();
        }
    }
}
</code></pre>
<p>pool.submit(task)被调用之后，没有阻塞主线程，马上返回了一个Future类型的对象（我们的提货单）。</p>
<p>"任务已提交..."这行马上被打印出来就证明了任务提交的异步性——主线程发起了任务，但不需要等待它完成。</p>
<p>主线程完成了其他事情之后，调用future.get()来提货。</p>
<p>这个调用是阻塞的，主线程会在这里暂停，直到子线程里的task执行完返回结果42。</p>
<p>拿到结果之后，程序才会继续执行并打印。</p>
<h2 data-id="heading-15">六、关闭线程池</h2>
<p>前文中我们讲过守护线程和非守护线程的区别。默认情况下，线程池创建的线程都是非守护线程。</p>
<p>如果你创建了一个线程池并提交了任务，即使你的main方法执行完毕，只要线程池没有被关闭，它内部的线程（即使是空闲的）也会一直存在，从而阻止JVM正常退出。</p>
<p>这会导致应用程序挂起，看起来就像卡住了。</p>
<p>ExecutorService接口给我们提供了两个核心的关闭方法：shutdown和shutdownNow</p>
<p>看一下二者的区别：</p>








































<table><thead><tr><th>特性</th><th>shutdown()</th><th>shutdownNow()</th></tr></thead><tbody><tr><td/><td>大喇叭宣布餐厅打烊</td><td>直接拉电闸，紧急疏散</td></tr><tr><td>新任务</td><td>不再接受新提交的任务。</td><td>不再接受新提交的任务。</td></tr><tr><td>已提交任务</td><td>等待所有已提交的任务（包括队列中的）执行完毕。</td><td>尝试中断所有正在执行的任务，清空任务队列。</td></tr><tr><td>返回值</td><td>void</td><td>List（返回队列中还没被执行的任务列表）</td></tr><tr><td>调用时机</td><td>首选的、优雅的关闭方式。</td><td>作为shutdown()超时后的最后手段，或需要立即停止的场景。</td></tr><tr><td>状态变更</td><td>线程池进入SHUTDOWN状态。</td><td>线程池进入STOP状态。</td></tr></tbody></table>
<p>字面上看，shutdownNow的方式也更加激进一些。</p>
<p>而在实际的开发中，我们肯定不能简单粗暴的关闭线程池。</p>
<p>下面是模拟的开发环境中关闭线程池的案例代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.lazy.snail.day36;

<span class="hljs-keyword">import</span> java.util.concurrent.ExecutorService;
<span class="hljs-keyword">import</span> java.util.concurrent.Executors;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@ClassName</span> ShutdownTest
 * <span class="hljs-doctag">@Description</span> TODO
 * <span class="hljs-doctag">@Author</span> lazysnail
 * <span class="hljs-doctag">@Date</span> 2025/7/21 16:28
 * <span class="hljs-doctag">@Version</span> 1.0
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ShutdownTest</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">2</span>);

        pool.submit(() -&gt; {
            <span class="hljs-keyword">try</span> {
                System.out.println(<span class="hljs-string">"任务1开始执行..."</span>);
                Thread.sleep(<span class="hljs-number">2000</span>);
                System.out.println(<span class="hljs-string">"任务1执行完毕。"</span>);
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                System.err.println(<span class="hljs-string">"任务1被中断。"</span>);
                Thread.currentThread().interrupt();
            }
        });

        pool.submit(() -&gt; {
            <span class="hljs-keyword">try</span> {
                System.out.println(<span class="hljs-string">"任务2开始执行..."</span>);
                Thread.sleep(<span class="hljs-number">8000</span>);
                System.out.println(<span class="hljs-string">"任务2执行完毕。"</span>);
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                System.err.println(<span class="hljs-string">"任务2被中断。"</span>);
                Thread.currentThread().interrupt();
            }
        });
        
        System.out.println(<span class="hljs-string">"主线程：发起关闭线程池请求..."</span>);
        pool.shutdown();

        <span class="hljs-keyword">try</span> {
            System.out.println(<span class="hljs-string">"主线程：等待最多5秒让任务结束..."</span>);
            <span class="hljs-keyword">if</span> (!pool.awaitTermination(<span class="hljs-number">5</span>, TimeUnit.SECONDS)) {
                System.err.println(<span class="hljs-string">"主线程：超时！强制关闭线程池..."</span>);
                pool.shutdownNow();

                <span class="hljs-keyword">if</span> (!pool.awaitTermination(<span class="hljs-number">1</span>, TimeUnit.SECONDS)) {
                    System.err.println(<span class="hljs-string">"线程池未能终止。"</span>);
                }
            }
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            System.err.println(<span class="hljs-string">"主线程等待时被中断，强制关闭线程池..."</span>);
            pool.shutdownNow();
            Thread.currentThread().interrupt();
        }

        System.out.println(<span class="hljs-string">"主线程：关闭流程结束。"</span>);
    }
}
</code></pre>
<p>shutdown通知线程池进入关闭流程，不再接受新任务。</p>
<p>调用awaitTermination(long timeout, TimeUnit unit)方法，让当前线程（main）阻塞等待。</p>
<p>要么线程池中的所有任务都执行完毕，线程池完全终止。此时，方法返回true。</p>
<p>要么超时时间到达。此时，方法返回false。</p>
<p>如果awaitTermination因为超时而返回false，说明还有任务还没结束。</p>
<p>这个时候就只能调用shutdownNow()来尝试强制中断这些相对顽固的任务。</p>
<p>调用awaitTermination的线程自身也可能被中断。</p>
<p>我们必须捕获这个InterruptedException，在捕获后也调用shutdownNow()并恢复当前线程的中断状态。</p>
<h2 data-id="heading-16">七、线程池监控及调优</h2>
<p>线程池给我们提供了很多运行状态信息，如果我们想要我们经营的餐馆，厨房有序、合理、高效的处理订单。</p>
<p>就可以通过监控这些状态信息，并及时的调整配置信息，让厨房达到一个最佳的状态。</p>
<p>ThreadPoolExecutor提供了一系列方法，我们可以通过这些方法监控线程池的状态，接下来我用类比的方式讲一下常用的方法：</p>








































<table><thead><tr><th>方法</th><th>类比</th><th>含义</th></tr></thead><tbody><tr><td>getActiveCount()</td><td>有多少厨师在忙</td><td>返回当前正在执行任务的线程数</td></tr><tr><td>getPoolSize()</td><td>当前雇了多少厨师</td><td>返回线程池中实际存在的线程数（核心+临时）</td></tr><tr><td>getQueue().size()</td><td>桌子上有多少订单</td><td>返回任务队列中的等待任务数</td></tr><tr><td>getCompletedTaskCount()</td><td>完成了多少订单</td><td>返回已完成的任务总数（近似值）</td></tr><tr><td>getTaskCount()</td><td>总共收到多少订单</td><td>返回提交到线程池的总任务数（包括已完成、排队和正在执行的）</td></tr><tr><td>getLargestPoolSize()</td><td>历史最多雇了多少厨师</td><td>返回线程池历史上同时存在的最大线程数</td></tr></tbody></table>
<p>如果发现排队订单越来越多（getQueue().size()接近队列容量），说明桌子不够大或厨师太少，可能需要调整配置。</p>
<p>以下这些建议只是作为参考：</p>
<p>如果任务量稳定，corePoolSize可以设置成CPU核数的1-2倍。</p>
<p>maximumPoolSize一般设置为CPU核数的2-4倍，避免过多线程导致上下文切换开销。</p>
<p>推荐ArrayBlockingQueue这个有界队列，控制订单堆积。订单量波动大时，适当增大队列，但要注意内存占用。</p>
<p>一般设为几十秒到几分钟，高峰过后能够快速的释放资源。</p>
<p>低负载的时候采用CallerRunsPolicy，让客户自己做菜，减缓提交速度。</p>
<p>要求高可靠性的场景使用用AbortPolicy，明确失败，触发告警。</p>
<p>对结果不太敏感，非关键任务的时候用DiscardPolicy或DiscardOldestPolicy，丢弃任务以保护系统。</p>
<p>如果任务执行得太慢，就只能优化任务逻辑，或者把大人物拆成小任务（类似ForkJoinPool的分治思想）。</p>
<p>还可以使用PriorityBlockingQueue优先处理重要订单。</p>
<blockquote>
<p>线程池的优化不是一成不变的模板化操作，而是需要根据实际业务场景和运行时状态动态调整。真正的优化依赖于持续监控线程池的运行状态，结合业务需求和系统资源，动态调整参数才能达到最佳性能。</p>
</blockquote>
<h2 data-id="heading-17">结语</h2>
<p>看完本文，我们已经从new Thread()跨越到了线程池。</p>
<p>线程池其实也并不高大上，他跟数据库连接池和HTTP连接池的核心思想一样。</p>
<p>都是一种池化技术，本质就是通过复用昂贵资源，来降低单次获取该资源的开销，并对资源进行统一管理，从而提高系统整体的性能和稳定性。</p>
<p>不管什么池，都可以把它看成一个容器，用来存放资源，都有获取、归还资源的方法。</p>
<p>只是因为管理的资源不同，对于核心数量、最大数量、空闲超时、拒绝策略等参数的管理策略不同而已。</p>
<p>下一篇预告</p>
<blockquote>
<p>Day37 | 线程安全与synchronized</p>
</blockquote>
<p>如果你觉得这系列文章对你有帮助，欢迎关注专栏，我们一起坚持下去！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[阿里开源AgentScope多智能体框架解析系列（四）第4章：Agent 接口与 AgentBase 基类]]></title>    <link>https://juejin.cn/post/7589246131585564707</link>    <guid>https://juejin.cn/post/7589246131585564707</guid>    <pubDate>2025-12-30T04:01:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589246131585564707" data-draft-id="7589207843788439587" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="阿里开源AgentScope多智能体框架解析系列（四）第4章：Agent 接口与 AgentBase 基类"/> <meta itemprop="keywords" content="Agent"/> <meta itemprop="datePublished" content="2025-12-30T04:01:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="语落心生"/> <meta itemprop="url" content="https://juejin.cn/user/2875978147955741"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            阿里开源AgentScope多智能体框架解析系列（四）第4章：Agent 接口与 AgentBase 基类
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2875978147955741/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    语落心生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T04:01:06.000Z" title="Tue Dec 30 2025 04:01:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    19
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">本章导读</h2>
<p>本章将深入讲解AgentScope中最核心的抽象：<strong>Agent接口</strong>。Agent是整个框架的基石，定义了所有智能体的行为契约。无论是简单的问答Bot，还是复杂的多Agent协作系统，都建立在Agent接口之上。</p>
<p><strong>导读</strong>：</p>
<ul>
<li>理解Agent接口的核心方法和设计理念</li>
<li>掌握call()、observe()等方法的使用场景</li>
<li>学会使用AgentBase基类构建自定义Agent</li>
<li>了解流式执行和事件系统</li>
<li>掌握Hook系统的集成方式</li>
</ul>
<hr/>
<h2 data-id="heading-1">4.1 Agent接口设计</h2>
<h3 data-id="heading-2">4.1.1 Agent接口的核心结构</h3>
<p>Agent接口定义了AgentScope中所有智能体必须实现的方法。它采用响应式编程模型，所有方法都返回<code>Mono&lt;T&gt;</code>或<code>Flux&lt;T&gt;</code>，支持异步、非阻塞的执行。</p>
<p><strong>完整的Agent接口</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> io.agentscope.core.agent;

<span class="hljs-keyword">import</span> io.agentscope.core.message.Msg;
<span class="hljs-keyword">import</span> io.agentscope.core.interruption.InterruptContext;
<span class="hljs-keyword">import</span> reactor.core.publisher.Mono;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Agent</span> {
    
    <span class="hljs-comment">// ============ 基础属性 ============</span>
    
    <span class="hljs-comment">/**
     * 获取Agent的唯一标识
     * 用于在多Agent系统中区分不同的Agent实例
     */</span>
    String <span class="hljs-title function_">getAgentId</span><span class="hljs-params">()</span>;
    
    <span class="hljs-comment">/**
     * 获取Agent的名称
     * 用于日志、监控、用户界面展示
     */</span>
    String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span>;
    
    <span class="hljs-comment">/**
     * 获取Agent的描述
     * 说明Agent的功能和用途
     */</span>
    String <span class="hljs-title function_">getDescription</span><span class="hljs-params">()</span>;
    
    <span class="hljs-comment">// ============ 核心方法 ============</span>
    
    <span class="hljs-comment">/**
     * 处理单条消息
     * 这是最常用的方法
     * 
     * <span class="hljs-doctag">@param</span> msg 用户输入的消息
     * <span class="hljs-doctag">@return</span> Agent的回复消息
     */</span>
    <span class="hljs-keyword">default</span> Mono&lt;Msg&gt; <span class="hljs-title function_">call</span><span class="hljs-params">(Msg msg)</span> {
        <span class="hljs-keyword">return</span> call(msg == <span class="hljs-literal">null</span> ? List.of() : List.of(msg));
    }
    
    <span class="hljs-comment">/**
     * 处理多条消息
     * 用于需要同时考虑多条上下文消息的场景
     * 
     * <span class="hljs-doctag">@param</span> msgs 消息列表
     * <span class="hljs-doctag">@return</span> Agent的回复消息
     */</span>
    Mono&lt;Msg&gt; <span class="hljs-title function_">call</span><span class="hljs-params">(List&lt;Msg&gt; msgs)</span>;
    
    <span class="hljs-comment">/**
     * 继续生成（无新输入）
     * 用于让Agent继续之前的生成或推理
     * 
     * <span class="hljs-doctag">@return</span> Agent的回复消息
     */</span>
    <span class="hljs-keyword">default</span> Mono&lt;Msg&gt; <span class="hljs-title function_">call</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> call(List.of());
    }
    
    <span class="hljs-comment">// ============ 结构化输出 ============</span>
    
    <span class="hljs-comment">/**
     * 返回结构化数据的版本
     * 要求Agent生成符合指定类结构的数据
     * 
     * <span class="hljs-doctag">@param</span> msg 用户输入的消息
     * <span class="hljs-doctag">@param</span> structuredModel 期望的输出结构类
     * <span class="hljs-doctag">@return</span> 包含结构化数据的消息
     */</span>
    <span class="hljs-keyword">default</span> Mono&lt;Msg&gt; <span class="hljs-title function_">call</span><span class="hljs-params">(Msg msg, Class&lt;?&gt; structuredModel)</span> {
        <span class="hljs-keyword">return</span> call(msg == <span class="hljs-literal">null</span> ? List.of() : List.of(msg), structuredModel);
    }
    
    Mono&lt;Msg&gt; <span class="hljs-title function_">call</span><span class="hljs-params">(List&lt;Msg&gt; msgs, Class&lt;?&gt; structuredModel)</span>;
    
    <span class="hljs-keyword">default</span> Mono&lt;Msg&gt; <span class="hljs-title function_">call</span><span class="hljs-params">(Class&lt;?&gt; structuredModel)</span> {
        <span class="hljs-keyword">return</span> call(List.of(), structuredModel);
    }
    
    <span class="hljs-comment">// ============ 多Agent协作 ============</span>
    
    <span class="hljs-comment">/**
     * 观察消息而不回复
     * 用于多Agent协作场景，Agent需要接收信息但不需要回复
     * 
     * <span class="hljs-doctag">@param</span> msg 要观察的消息
     * <span class="hljs-doctag">@return</span> 完成信号
     */</span>
    Mono&lt;Void&gt; <span class="hljs-title function_">observe</span><span class="hljs-params">(Msg msg)</span>;
    
    Mono&lt;Void&gt; <span class="hljs-title function_">observe</span><span class="hljs-params">(List&lt;Msg&gt; msgs)</span>;
    
    <span class="hljs-comment">// ============ 中断控制 ============</span>
    
    <span class="hljs-comment">/**
     * 中断Agent执行
     * 用于人机协同或安全控制场景
     * 
     * <span class="hljs-doctag">@param</span> reason 中断原因
     * <span class="hljs-doctag">@return</span> 中断上下文
     */</span>
    <span class="hljs-keyword">default</span> Mono&lt;InterruptContext&gt; <span class="hljs-title function_">interrupt</span><span class="hljs-params">(String reason)</span> {
        <span class="hljs-keyword">return</span> Mono.empty();
    }
    
    <span class="hljs-comment">/**
     * 检查Agent是否可中断
     * 
     * <span class="hljs-doctag">@return</span> true表示Agent支持中断
     */</span>
    <span class="hljs-keyword">default</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isInterruptible</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
}
</code></pre>
<h3 data-id="heading-3">4.1.2 设计理念</h3>
<h4 data-id="heading-4">理念1：响应式编程模型</h4>
<p><strong>为什么使用Mono/Flux？</strong></p>
<pre><code class="hljs language-python" lang="python">传统同步模型的问题：
❌ 阻塞线程，资源浪费
❌ 难以处理超时
❌ 无法有效组合多个异步操作
❌ 扩展性差

响应式模型的优势：
✓ 非阻塞，高并发
✓ 声明式的错误处理
✓ 灵活的操作组合（<span class="hljs-built_in">map</span>、flatMap、<span class="hljs-built_in">zip</span>等）
✓ 天然支持流式处理
✓ 易于集成背压（backpressure）机制
</code></pre>
<p><strong>代码对比</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 传统同步方式（阻塞）</span>
<span class="hljs-keyword">public</span> Msg <span class="hljs-title function_">call</span><span class="hljs-params">(Msg msg)</span> {
    <span class="hljs-comment">// 阻塞线程等待LLM响应（可能需要几秒）</span>
    <span class="hljs-type">Msg</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> llmService.generate(msg);  
    <span class="hljs-keyword">return</span> response;
}

<span class="hljs-comment">// 响应式方式（非阻塞）</span>
<span class="hljs-keyword">public</span> Mono&lt;Msg&gt; <span class="hljs-title function_">call</span><span class="hljs-params">(Msg msg)</span> {
    <span class="hljs-comment">// 立即返回，不阻塞线程</span>
    <span class="hljs-keyword">return</span> llmService.generateAsync(msg)
        .timeout(Duration.ofSeconds(<span class="hljs-number">30</span>))  <span class="hljs-comment">// 声明式超时</span>
        .retryWhen(Retry.backoff(<span class="hljs-number">3</span>, Duration.ofSeconds(<span class="hljs-number">1</span>)))  <span class="hljs-comment">// 声明式重试</span>
        .doOnError(e -&gt; log.error(<span class="hljs-string">"Generation failed"</span>, e));  <span class="hljs-comment">// 声明式错误处理</span>
}
</code></pre>
<h4 data-id="heading-5">理念2：call()方法的多态设计</h4>
<p><strong>为什么需要多个call()重载？</strong></p>
<pre><code class="hljs language-scss" lang="scss">场景<span class="hljs-number">1</span>：简单对话
├─ <span class="hljs-built_in">call</span>(Msg msg) 
└─ 用户提问，Agent回答

场景<span class="hljs-number">2</span>：多轮上下文
├─ <span class="hljs-built_in">call</span>(List&lt;Msg&gt; msgs)
└─ 需要考虑多条历史消息

场景<span class="hljs-number">3</span>：无输入续写
├─ <span class="hljs-built_in">call</span>()
└─ Agent继续之前的生成

场景<span class="hljs-number">4</span>：结构化输出
├─ <span class="hljs-built_in">call</span>(Msg msg, Class&lt;?&gt; structuredModel)
└─ 要求Agent返回特定格式的数据
</code></pre>
<h4 data-id="heading-6">理念3：observe()的必要性</h4>
<p><strong>为什么需要observe()？</strong></p>
<p>在多Agent协作中，并非所有Agent都需要对每条消息做出回复。observe()提供了一种"只听不说"的机制。</p>
<pre><code class="hljs language-scss" lang="scss">示例场景：三个Agent协作

Agent <span class="hljs-selector-tag">A</span>（数据收集器）
  ↓ 发送数据
Agent <span class="hljs-selector-tag">B</span>（观察者）→ <span class="hljs-built_in">observe</span>(msg) → 只记录，不回复
  ↓
Agent C（决策者）→ <span class="hljs-built_in">call</span>(msg) → 基于所有数据做决策
</code></pre>
<p><strong>代码示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Agent B 作为观察者</span>
<span class="hljs-type">ReActAgent</span> <span class="hljs-variable">observerAgent</span> <span class="hljs-operator">=</span> ReActAgent.builder()
    .name(<span class="hljs-string">"DataObserver"</span>)
    .memory(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryMemory</span>())  <span class="hljs-comment">// 有记忆但不回复</span>
    .build();

<span class="hljs-comment">// 接收其他Agent的消息</span>
<span class="hljs-type">Msg</span> <span class="hljs-variable">dataFromAgentA</span> <span class="hljs-operator">=</span> ...;
observerAgent.observe(dataFromAgentA).block();  <span class="hljs-comment">// 只记录到Memory</span>

<span class="hljs-comment">// 稍后可以基于观察到的数据生成总结</span>
<span class="hljs-type">Msg</span> <span class="hljs-variable">summary</span> <span class="hljs-operator">=</span> observerAgent.call(<span class="hljs-string">"请总结之前观察到的所有数据"</span>).block();
</code></pre>
<hr/>
<h2 data-id="heading-7">4.2 call()方法的使用场景（How - 如何使用）</h2>
<h3 data-id="heading-8">4.2.1 场景1：简单问答对话</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> io.agentscope.core.ReActAgent;
<span class="hljs-keyword">import</span> io.agentscope.core.message.Msg;
<span class="hljs-keyword">import</span> io.agentscope.core.model.DashScopeChatModel;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleQAExample</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 创建一个简单的问答Agent</span>
        <span class="hljs-type">ReActAgent</span> <span class="hljs-variable">agent</span> <span class="hljs-operator">=</span> ReActAgent.builder()
            .name(<span class="hljs-string">"QABot"</span>)
            .model(DashScopeChatModel.builder()
                .apiKey(System.getenv(<span class="hljs-string">"DASHSCOPE_API_KEY"</span>))
                .modelName(<span class="hljs-string">"qwen-plus"</span>)
                .build())
            .sysPrompt(<span class="hljs-string">"你是一个友好的AI助手，请简洁地回答用户的问题。"</span>)
            .build();
        
        <span class="hljs-comment">// 用户提问</span>
        <span class="hljs-type">Msg</span> <span class="hljs-variable">userMsg</span> <span class="hljs-operator">=</span> Msg.builder()
            .textContent(<span class="hljs-string">"什么是量子计算？"</span>)
            .build();
        
        <span class="hljs-comment">// 获取回复（阻塞方式）</span>
        <span class="hljs-type">Msg</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> agent.call(userMsg).block();
        
        System.out.println(<span class="hljs-string">"Agent回复: "</span> + response.getTextContent());
        
        <span class="hljs-comment">// 异步方式</span>
        agent.call(userMsg)
            .subscribe(
                msg -&gt; System.out.println(<span class="hljs-string">"Agent回复: "</span> + msg.getTextContent()),
                error -&gt; System.err.println(<span class="hljs-string">"错误: "</span> + error.getMessage()),
                () -&gt; System.out.println(<span class="hljs-string">"完成"</span>)
            );
    }
}
</code></pre>
<h3 data-id="heading-9">4.2.2 场景2：多轮对话上下文</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MultiTurnConversationExample</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">ReActAgent</span> <span class="hljs-variable">agent</span> <span class="hljs-operator">=</span> ReActAgent.builder()
            .name(<span class="hljs-string">"ConversationBot"</span>)
            .model(model)
            .memory(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryMemory</span>())  <span class="hljs-comment">// 启用记忆</span>
            .build();
        
        <span class="hljs-comment">// 第一轮对话</span>
        <span class="hljs-type">Msg</span> <span class="hljs-variable">msg1</span> <span class="hljs-operator">=</span> Msg.builder().textContent(<span class="hljs-string">"我叫李明，今年28岁"</span>).build();
        agent.call(msg1).block();
        
        <span class="hljs-comment">// 第二轮对话（Agent能记住前面的信息）</span>
        <span class="hljs-type">Msg</span> <span class="hljs-variable">msg2</span> <span class="hljs-operator">=</span> Msg.builder().textContent(<span class="hljs-string">"我的名字是什么？"</span>).build();
        <span class="hljs-type">Msg</span> <span class="hljs-variable">response2</span> <span class="hljs-operator">=</span> agent.call(msg2).block();
        
        System.out.println(response2.getTextContent());
        <span class="hljs-comment">// 输出：您的名字是李明。</span>
        
        <span class="hljs-comment">// 批量处理多条消息</span>
        List&lt;Msg&gt; messages = List.of(
            Msg.builder().role(MsgRole.USER).textContent(<span class="hljs-string">"今天天气怎么样？"</span>).build(),
            Msg.builder().role(MsgRole.ASSISTANT).textContent(<span class="hljs-string">"今天天气晴朗。"</span>).build(),
            Msg.builder().role(MsgRole.USER).textContent(<span class="hljs-string">"适合户外运动吗？"</span>).build()
        );
        
        <span class="hljs-type">Msg</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> agent.call(messages).block();
        <span class="hljs-comment">// Agent基于完整上下文回复</span>
    }
}
</code></pre>
<h3 data-id="heading-10">4.2.3 场景3：结构化输出</h3>
<p>这是Agent接口的强大特性之一：要求Agent生成符合特定结构的数据。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> lombok.Data;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StructuredOutputExample</span> {
    
    <span class="hljs-comment">// 定义期望的输出结构</span>
    <span class="hljs-meta">@Data</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserProfile</span> {
        <span class="hljs-keyword">private</span> String name;
        <span class="hljs-keyword">private</span> Integer age;
        <span class="hljs-keyword">private</span> String email;
        <span class="hljs-keyword">private</span> String phone;
        <span class="hljs-keyword">private</span> String city;
    }
    
    <span class="hljs-meta">@Data</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductReview</span> {
        <span class="hljs-keyword">private</span> String productName;
        <span class="hljs-keyword">private</span> Integer rating;  <span class="hljs-comment">// 1-5星</span>
        <span class="hljs-keyword">private</span> List&lt;String&gt; pros;  <span class="hljs-comment">// 优点</span>
        <span class="hljs-keyword">private</span> List&lt;String&gt; cons;  <span class="hljs-comment">// 缺点</span>
        <span class="hljs-keyword">private</span> String summary;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">ReActAgent</span> <span class="hljs-variable">agent</span> <span class="hljs-operator">=</span> ReActAgent.builder()
            .name(<span class="hljs-string">"StructuredAgent"</span>)
            .model(model)
            .build();
        
        <span class="hljs-comment">// 场景1：提取用户信息</span>
        <span class="hljs-type">Msg</span> <span class="hljs-variable">userInfoMsg</span> <span class="hljs-operator">=</span> Msg.builder()
            .textContent(<span class="hljs-string">"我叫张三，28岁，邮箱是zhangsan@example.com，"</span> +
                        <span class="hljs-string">"手机13800138000，住在北京"</span>)
            .build();
        
        <span class="hljs-type">Msg</span> <span class="hljs-variable">response1</span> <span class="hljs-operator">=</span> agent.call(userInfoMsg, UserProfile.class).block();
        
        <span class="hljs-keyword">if</span> (response1.hasStructuredData()) {
            <span class="hljs-type">UserProfile</span> <span class="hljs-variable">profile</span> <span class="hljs-operator">=</span> response1.getStructuredData(UserProfile.class);
            System.out.println(<span class="hljs-string">"姓名: "</span> + profile.getName());
            System.out.println(<span class="hljs-string">"年龄: "</span> + profile.getAge());
            System.out.println(<span class="hljs-string">"邮箱: "</span> + profile.getEmail());
            System.out.println(<span class="hljs-string">"手机: "</span> + profile.getPhone());
            System.out.println(<span class="hljs-string">"城市: "</span> + profile.getCity());
        }
        
        <span class="hljs-comment">// 场景2：分析产品评论</span>
        <span class="hljs-type">Msg</span> <span class="hljs-variable">reviewMsg</span> <span class="hljs-operator">=</span> Msg.builder()
            .textContent(<span class="hljs-string">"这款iPhone 15 Pro很不错，性能强劲，拍照效果好，"</span> +
                        <span class="hljs-string">"但是价格偏贵，电池续航一般。总体来说值得购买。"</span>)
            .build();
        
        <span class="hljs-type">Msg</span> <span class="hljs-variable">response2</span> <span class="hljs-operator">=</span> agent.call(reviewMsg, ProductReview.class).block();
        
        <span class="hljs-keyword">if</span> (response2.hasStructuredData()) {
            <span class="hljs-type">ProductReview</span> <span class="hljs-variable">review</span> <span class="hljs-operator">=</span> response2.getStructuredData(ProductReview.class);
            System.out.println(<span class="hljs-string">"产品: "</span> + review.getProductName());
            System.out.println(<span class="hljs-string">"评分: "</span> + review.getRating() + <span class="hljs-string">"星"</span>);
            System.out.println(<span class="hljs-string">"优点: "</span> + String.join(<span class="hljs-string">", "</span>, review.getPros()));
            System.out.println(<span class="hljs-string">"缺点: "</span> + String.join(<span class="hljs-string">", "</span>, review.getCons()));
            System.out.println(<span class="hljs-string">"总结: "</span> + review.getSummary());
        }
    }
}
</code></pre>
<p><strong>输出示例</strong>：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">姓名: 张三</span>
<span class="hljs-section">年龄: 28</span>
<span class="hljs-section">邮箱: zhangsan@example.com</span>
<span class="hljs-section">手机: 13800138000</span>
<span class="hljs-section">城市: 北京</span>

<span class="hljs-section">产品: iPhone 15 Pro</span>
<span class="hljs-section">评分: 4星</span>
<span class="hljs-section">优点: 性能强劲, 拍照效果好</span>
<span class="hljs-section">缺点: 价格偏贵, 电池续航一般</span>
<span class="hljs-section">总结: 总体来说值得购买</span>
</code></pre>
<h3 data-id="heading-11">4.2.4 场景4：无输入续写</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ContinuationExample</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">ReActAgent</span> <span class="hljs-variable">agent</span> <span class="hljs-operator">=</span> ReActAgent.builder()
            .name(<span class="hljs-string">"WriterAgent"</span>)
            .model(model)
            .sysPrompt(<span class="hljs-string">"你是一个创意写作助手。"</span>)
            .build();
        
        <span class="hljs-comment">// 第一次调用：开始创作</span>
        <span class="hljs-type">Msg</span> <span class="hljs-variable">msg1</span> <span class="hljs-operator">=</span> Msg.builder()
            .textContent(<span class="hljs-string">"请写一个科幻小说的开头"</span>)
            .build();
        
        <span class="hljs-type">Msg</span> <span class="hljs-variable">response1</span> <span class="hljs-operator">=</span> agent.call(msg1).block();
        System.out.println(<span class="hljs-string">"第一段:\n"</span> + response1.getTextContent());
        
        <span class="hljs-comment">// 第二次调用：继续创作（无新输入）</span>
        <span class="hljs-type">Msg</span> <span class="hljs-variable">response2</span> <span class="hljs-operator">=</span> agent.call().block();
        System.out.println(<span class="hljs-string">"\n第二段:\n"</span> + response2.getTextContent());
        
        <span class="hljs-comment">// 第三次调用：继续</span>
        <span class="hljs-type">Msg</span> <span class="hljs-variable">response3</span> <span class="hljs-operator">=</span> agent.call().block();
        System.out.println(<span class="hljs-string">"\n第三段:\n"</span> + response3.getTextContent());
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-12">4.3 AgentBase 基础实现</h2>
<h3 data-id="heading-13">4.3.1 AgentBase的架构设计</h3>
<p>AgentBase是Agent接口的抽象基类，提供了大量通用功能，让开发者可以专注于核心逻辑。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> io.agentscope.core.agent;

<span class="hljs-keyword">import</span> io.agentscope.core.hook.Hook;
<span class="hljs-keyword">import</span> io.agentscope.core.message.Msg;
<span class="hljs-keyword">import</span> io.agentscope.core.state.StateModule;
<span class="hljs-keyword">import</span> reactor.core.publisher.Mono;

<span class="hljs-keyword">import</span> java.util.List;
<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AgentBase</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Agent</span> {
    
    <span class="hljs-comment">// ============ 核心状态 ============</span>
    
    <span class="hljs-comment">/**
     * Agent的唯一标识
     * 自动生成的UUID
     */</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> String agentId;
    
    <span class="hljs-comment">/**
     * Agent的名称
     * 用于日志和展示
     */</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> String name;
    
    <span class="hljs-comment">/**
     * Agent的描述
     * 说明Agent的功能
     */</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> String description;
    
    <span class="hljs-comment">/**
     * Hook列表
     * 用于事件拦截和增强
     */</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> List&lt;Hook&gt; hooks;
    
    <span class="hljs-comment">/**
     * 嵌套的状态模块
     * 例如Memory、PlanNotebook等
     * 用于会话持久化
     */</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Map&lt;String, StateModule&gt; modules;
    
    <span class="hljs-comment">// ============ 执行控制 ============</span>
    
    <span class="hljs-comment">/**
     * 标记Agent是否正在执行
     */</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">isRunning</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
    
    <span class="hljs-comment">/**
     * 是否检查重入调用
     * 防止Agent被递归调用
     */</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">checkRunning</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
    
    <span class="hljs-comment">// ============ 子类实现 ============</span>
    
    <span class="hljs-comment">/**
     * 子类必须实现：处理消息的核心逻辑
     */</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> Mono&lt;Msg&gt; <span class="hljs-title function_">doCall</span><span class="hljs-params">(List&lt;Msg&gt; msgs)</span>;
    
    <span class="hljs-comment">/**
     * 子类必须实现：处理结构化输出
     */</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> Mono&lt;Msg&gt; <span class="hljs-title function_">doCall</span><span class="hljs-params">(List&lt;Msg&gt; msgs, Class&lt;?&gt; structuredOutputClass)</span>;
    
    <span class="hljs-comment">/**
     * 子类必须实现：观察消息
     */</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> Mono&lt;Void&gt; <span class="hljs-title function_">doObserve</span><span class="hljs-params">(Msg msg)</span>;
    
    <span class="hljs-comment">// ============ 模板方法 ============</span>
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> Mono&lt;Msg&gt; <span class="hljs-title function_">call</span><span class="hljs-params">(List&lt;Msg&gt; msgs)</span> {
        <span class="hljs-keyword">return</span> Mono.defer(() -&gt; {
            <span class="hljs-comment">// 1. 重入检查</span>
            <span class="hljs-keyword">if</span> (checkRunning &amp;&amp; isRunning) {
                <span class="hljs-keyword">return</span> Mono.error(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(
                    <span class="hljs-string">"Agent ["</span> + name + <span class="hljs-string">"] is already running. "</span> +
                    <span class="hljs-string">"Reentrant calls are not allowed."</span>));
            }
            
            <span class="hljs-comment">// 2. 设置运行标志</span>
            isRunning = <span class="hljs-literal">true</span>;
            
            <span class="hljs-comment">// 3. 执行实际逻辑</span>
            <span class="hljs-keyword">return</span> doCall(msgs)
                <span class="hljs-comment">// 4. 无论成功或失败，都要重置运行标志</span>
                .doFinally(signal -&gt; isRunning = <span class="hljs-literal">false</span>);
        });
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> Mono&lt;Msg&gt; <span class="hljs-title function_">call</span><span class="hljs-params">(List&lt;Msg&gt; msgs, Class&lt;?&gt; structuredModel)</span> {
        <span class="hljs-keyword">return</span> Mono.defer(() -&gt; {
            <span class="hljs-keyword">if</span> (checkRunning &amp;&amp; isRunning) {
                <span class="hljs-keyword">return</span> Mono.error(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(
                    <span class="hljs-string">"Agent ["</span> + name + <span class="hljs-string">"] is already running."</span>));
            }
            
            isRunning = <span class="hljs-literal">true</span>;
            
            <span class="hljs-keyword">return</span> doCall(msgs, structuredModel)
                .doFinally(signal -&gt; isRunning = <span class="hljs-literal">false</span>);
        });
    }
    
    <span class="hljs-comment">// ============ 状态管理 ============</span>
    
    <span class="hljs-comment">/**
     * 获取所有嵌套的状态模块
     * 用于会话持久化
     */</span>
    <span class="hljs-keyword">public</span> Map&lt;String, StateModule&gt; <span class="hljs-title function_">getStateModules</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> modules;
    }
}
</code></pre>
<h3 data-id="heading-14">4.3.2 AgentBase的核心特性</h3>
<h4 data-id="heading-15">特性1：Hook系统集成</h4>
<p>AgentBase内置了Hook系统支持，可以在Agent执行的各个阶段插入自定义逻辑。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> io.agentscope.core.hook.Hook;
<span class="hljs-keyword">import</span> io.agentscope.core.hook.HookEvent;
<span class="hljs-keyword">import</span> io.agentscope.core.hook.PostReasoningEvent;
<span class="hljs-keyword">import</span> io.agentscope.core.hook.PreReasoningEvent;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HookIntegrationExample</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 创建自定义Hook</span>
        <span class="hljs-type">Hook</span> <span class="hljs-variable">loggingHook</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hook</span>() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> &lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HookEvent</span>&gt; Mono&lt;T&gt; <span class="hljs-title function_">onEvent</span><span class="hljs-params">(T event)</span> {
                <span class="hljs-keyword">switch</span>(event) {
                    <span class="hljs-keyword">case</span> PreReasoningEvent pre -&gt; 
                        System.out.println(<span class="hljs-string">" 开始推理..."</span>);
                    <span class="hljs-keyword">case</span> PostReasoningEvent post -&gt; 
                        System.out.println(<span class="hljs-string">"✓ 推理完成，耗时: "</span> + post.getExecutionTime() + <span class="hljs-string">"ms"</span>);
                    <span class="hljs-keyword">default</span> -&gt; {}
                }
                <span class="hljs-keyword">return</span> Mono.just(event);
            }
        };
        
        <span class="hljs-comment">// 性能监控Hook</span>
        <span class="hljs-type">Hook</span> <span class="hljs-variable">performanceHook</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hook</span>() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> &lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HookEvent</span>&gt; Mono&lt;T&gt; <span class="hljs-title function_">onEvent</span><span class="hljs-params">(T event)</span> {
                <span class="hljs-keyword">if</span> (event <span class="hljs-keyword">instanceof</span> PostReasoningEvent post) {
                    <span class="hljs-type">long</span> <span class="hljs-variable">duration</span> <span class="hljs-operator">=</span> post.getExecutionTime();
                    <span class="hljs-keyword">if</span> (duration &gt; <span class="hljs-number">5000</span>) {
                        System.err.println(<span class="hljs-string">"⚠️ 推理耗时过长: "</span> + duration + <span class="hljs-string">"ms"</span>);
                    }
                }
                <span class="hljs-keyword">return</span> Mono.just(event);
            }
        };
        
        <span class="hljs-comment">// 在Agent中注册Hook</span>
        <span class="hljs-type">ReActAgent</span> <span class="hljs-variable">agent</span> <span class="hljs-operator">=</span> ReActAgent.builder()
            .name(<span class="hljs-string">"MonitoredAgent"</span>)
            .model(model)
            .hooks(List.of(loggingHook, performanceHook))
            .build();
        
        <span class="hljs-comment">// Hook会在Agent执行过程中自动触发</span>
        agent.call(<span class="hljs-string">"请分析一下当前的市场趋势"</span>).block();
    }
}
</code></pre>
<h4 data-id="heading-16">特性2：嵌套模块管理</h4>
<p>AgentBase自动管理Memory、PlanNotebook等StateModule，支持会话持久化。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> io.agentscope.core.memory.InMemoryMemory;
<span class="hljs-keyword">import</span> io.agentscope.core.plan.notebook.PlanNotebook;
<span class="hljs-keyword">import</span> io.agentscope.core.session.Session;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StateModuleExample</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 创建带有多个状态模块的Agent</span>
        <span class="hljs-type">InMemoryMemory</span> <span class="hljs-variable">memory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryMemory</span>();
        <span class="hljs-type">PlanNotebook</span> <span class="hljs-variable">planNotebook</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PlanNotebook</span>();
        
        <span class="hljs-type">ReActAgent</span> <span class="hljs-variable">agent</span> <span class="hljs-operator">=</span> ReActAgent.builder()
            .name(<span class="hljs-string">"StatefulAgent"</span>)
            .model(model)
            .memory(memory)  <span class="hljs-comment">// 自动注册为状态模块</span>
            .withPlanNotebook()  <span class="hljs-comment">// 自动注册为状态模块</span>
            .build();
        
        <span class="hljs-comment">// 使用Agent</span>
        agent.call(<span class="hljs-string">"请制定一个市场分析计划"</span>).block();
        agent.call(<span class="hljs-string">"执行第一步：收集数据"</span>).block();
        
        <span class="hljs-comment">// 保存整个Agent的状态</span>
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> Session.create();
        session.saveAgent(agent);
        
        <span class="hljs-comment">// ... 程序重启后 ...</span>
        
        <span class="hljs-comment">// 恢复Agent的状态</span>
        <span class="hljs-type">ReActAgent</span> <span class="hljs-variable">restoredAgent</span> <span class="hljs-operator">=</span> session.loadAgent(<span class="hljs-string">"StatefulAgent"</span>, ReActAgent.class);
        
        <span class="hljs-comment">// Agent的Memory和PlanNotebook都已恢复</span>
        restoredAgent.call(<span class="hljs-string">"继续执行计划"</span>).block();
    }
}
</code></pre>
<h4 data-id="heading-17">特性3：重入检查</h4>
<p>防止Agent被递归调用，避免潜在的死锁和资源耗尽。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReentrantCheckExample</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 启用重入检查</span>
        <span class="hljs-type">ReActAgent</span> <span class="hljs-variable">agent</span> <span class="hljs-operator">=</span> ReActAgent.builder()
            .name(<span class="hljs-string">"ProtectedAgent"</span>)
            .model(model)
            .checkRunning(<span class="hljs-literal">true</span>)  <span class="hljs-comment">// 启用重入检查</span>
            .build();
        
        <span class="hljs-comment">// 场景1：正常使用（没问题）</span>
        agent.call(<span class="hljs-string">"问题1"</span>).block();
        agent.call(<span class="hljs-string">"问题2"</span>).block();  <span class="hljs-comment">// OK，前一个调用已完成</span>
        
        <span class="hljs-comment">// 场景2：嵌套调用（会报错）</span>
        <span class="hljs-keyword">try</span> {
            agent.call(<span class="hljs-string">"外层问题"</span>)
                .flatMap(response -&gt; {
                    <span class="hljs-comment">// 在处理响应时又调用了同一个Agent</span>
                    <span class="hljs-keyword">return</span> agent.call(<span class="hljs-string">"内层问题"</span>);  <span class="hljs-comment">// ❌ 错误！</span>
                })
                .block();
        } <span class="hljs-keyword">catch</span> (IllegalStateException e) {
            System.err.println(<span class="hljs-string">"错误: "</span> + e.getMessage());
            <span class="hljs-comment">// 输出: Agent [ProtectedAgent] is already running. </span>
            <span class="hljs-comment">//       Reentrant calls are not allowed.</span>
        }
        
        <span class="hljs-comment">// 场景3：禁用重入检查（允许嵌套调用）</span>
        <span class="hljs-type">ReActAgent</span> <span class="hljs-variable">flexibleAgent</span> <span class="hljs-operator">=</span> ReActAgent.builder()
            .name(<span class="hljs-string">"FlexibleAgent"</span>)
            .model(model)
            .checkRunning(<span class="hljs-literal">false</span>)  <span class="hljs-comment">// 禁用重入检查</span>
            .build();
        
        <span class="hljs-comment">// 这样可以工作（但要小心死锁）</span>
        flexibleAgent.call(<span class="hljs-string">"外层问题"</span>)
            .flatMap(response -&gt; flexibleAgent.call(<span class="hljs-string">"内层问题"</span>))
            .block();
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-18">4.4 流式执行与事件系统</h2>
<h3 data-id="heading-19">4.4.1 stream()方法</h3>
<p>除了call()方法，Agent还提供stream()方法，支持流式输出，实时获取Agent的推理过程。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> io.agentscope.core.hook.*;
<span class="hljs-keyword">import</span> reactor.core.publisher.Flux;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StreamingExample</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">ReActAgent</span> <span class="hljs-variable">agent</span> <span class="hljs-operator">=</span> ReActAgent.builder()
            .name(<span class="hljs-string">"StreamingAgent"</span>)
            .model(model)
            .toolkit(toolkit)
            .build();
        
        <span class="hljs-type">Msg</span> <span class="hljs-variable">userMsg</span> <span class="hljs-operator">=</span> Msg.builder()
            .textContent(<span class="hljs-string">"请分析一下当前的经济形势"</span>)
            .build();
        
        <span class="hljs-comment">// 方式1：订阅所有事件</span>
        agent.stream(userMsg)
            .subscribe(
                event -&gt; handleEvent(event),  <span class="hljs-comment">// 处理每个事件</span>
                error -&gt; System.err.println(<span class="hljs-string">"错误: "</span> + error),
                () -&gt; System.out.println(<span class="hljs-string">"\n[完成]"</span>)
            );
        
        <span class="hljs-comment">// 方式2：只关心推理内容</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">fullText</span> <span class="hljs-operator">=</span> agent.stream(userMsg)
            .filter(event -&gt; event <span class="hljs-keyword">instanceof</span> ReasoningChunkEvent)
            .map(event -&gt; ((ReasoningChunkEvent) event).getDelta())
            .collect(Collectors.joining())
            .block();
        
        System.out.println(<span class="hljs-string">"完整内容: "</span> + fullText);
        
        <span class="hljs-comment">// 方式3：实时更新UI</span>
        agent.stream(userMsg)
            .doOnNext(event -&gt; {
                <span class="hljs-keyword">if</span> (event <span class="hljs-keyword">instanceof</span> ReasoningChunkEvent chunk) {
                    updateUI(chunk.getDelta());  <span class="hljs-comment">// 实时更新UI组件</span>
                }
            })
            .subscribe();
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleEvent</span><span class="hljs-params">(HookEvent event)</span> {
        <span class="hljs-keyword">switch</span>(event) {
            <span class="hljs-keyword">case</span> PreReasoningEvent pre -&gt; 
                System.out.println(<span class="hljs-string">"🤔 开始思考..."</span>);
            
            <span class="hljs-keyword">case</span> ReasoningChunkEvent chunk -&gt; 
                System.out.print(chunk.getDelta());  <span class="hljs-comment">// 实时打印推理内容</span>
            
            <span class="hljs-keyword">case</span> PostReasoningEvent post -&gt; 
                System.out.println(<span class="hljs-string">"\n✓ 思考完成"</span>);
            
            <span class="hljs-keyword">case</span> PreActingEvent pre -&gt; 
                System.out.println(<span class="hljs-string">"🔧 开始执行工具: "</span> + pre.getToolName());
            
            <span class="hljs-keyword">case</span> ActingChunkEvent chunk -&gt; 
                System.out.print(<span class="hljs-string">"⚙️ "</span> + chunk.getDelta());
            
            <span class="hljs-keyword">case</span> PostActingEvent post -&gt; 
                System.out.println(<span class="hljs-string">"\n✓ 工具执行完成"</span>);
            
            <span class="hljs-keyword">default</span> -&gt; {}
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateUI</span><span class="hljs-params">(String delta)</span> {
        <span class="hljs-comment">// 在JavaFX或Swing中更新UI</span>
        Platform.runLater(() -&gt; textArea.appendText(delta));
    }
}
</code></pre>
<h3 data-id="heading-20">4.4.2 事件类型详解</h3>
<p>Agent在执行过程中会发出多种事件，这些事件构成了完整的执行生命周期。</p>
<pre><code class="hljs language-ini" lang="ini">Agent执行生命周期事件：

第N轮推理-行动循环：
├─ PreReasoningEvent       <span class="hljs-comment"># 推理开始前</span>
├─ ReasoningChunkEvent     <span class="hljs-comment"># 推理内容流（多次）</span>
├─ PostReasoningEvent      <span class="hljs-comment"># 推理完成后</span>
│
├─ PreActingEvent          <span class="hljs-comment"># 行动开始前（如果有工具调用）</span>
├─ ActingChunkEvent        <span class="hljs-comment"># 行动内容流（多次）</span>
├─ PostActingEvent         <span class="hljs-comment"># 行动完成后</span>
│
└─ <span class="hljs-section">[循环或结束]</span>
</code></pre>
<p><strong>事件对象的属性</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// PreReasoningEvent - 推理前事件</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PreReasoningEvent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HookEvent</span> {
    <span class="hljs-keyword">private</span> List&lt;Msg&gt; inputMessages;      <span class="hljs-comment">// 输入消息</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> iterationCount;           <span class="hljs-comment">// 当前是第几轮推理</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> timestamp;               <span class="hljs-comment">// 时间戳</span>
}

<span class="hljs-comment">// ReasoningChunkEvent - 推理内容流</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReasoningChunkEvent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HookEvent</span> {
    <span class="hljs-keyword">private</span> String delta;                 <span class="hljs-comment">// 增量文本</span>
    <span class="hljs-keyword">private</span> ContentBlock contentBlock;    <span class="hljs-comment">// 内容块（可能包含工具调用）</span>
}

<span class="hljs-comment">// PostReasoningEvent - 推理后事件</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PostReasoningEvent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HookEvent</span> {
    <span class="hljs-keyword">private</span> Msg outputMessage;            <span class="hljs-comment">// 输出消息</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> executionTime;           <span class="hljs-comment">// 执行耗时（毫秒）</span>
    <span class="hljs-keyword">private</span> ChatUsage usage;              <span class="hljs-comment">// Token使用情况</span>
}

<span class="hljs-comment">// PreActingEvent - 行动前事件</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PreActingEvent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HookEvent</span> {
    <span class="hljs-keyword">private</span> String toolName;              <span class="hljs-comment">// 工具名称</span>
    <span class="hljs-keyword">private</span> Map&lt;String, Object&gt; toolArgs; <span class="hljs-comment">// 工具参数</span>
}

<span class="hljs-comment">// ActingChunkEvent - 行动内容流</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActingChunkEvent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HookEvent</span> {
    <span class="hljs-keyword">private</span> String delta;                 <span class="hljs-comment">// 增量内容</span>
}

<span class="hljs-comment">// PostActingEvent - 行动后事件</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PostActingEvent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HookEvent</span> {
    <span class="hljs-keyword">private</span> String toolName;              <span class="hljs-comment">// 工具名称</span>
    <span class="hljs-keyword">private</span> String toolResult;            <span class="hljs-comment">// 工具执行结果</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> isError;              <span class="hljs-comment">// 是否出错</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> executionTime;           <span class="hljs-comment">// 执行耗时</span>
}
</code></pre>
<hr/>
<h2 data-id="heading-21">4.5 生产场景：构建智能客服系统</h2>
<p>让我们通过一个完整的生产级示例，展示如何使用Agent接口构建一个功能完善的智能客服系统。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> io.agentscope.core.ReActAgent;
<span class="hljs-keyword">import</span> io.agentscope.core.agent.Agent;
<span class="hljs-keyword">import</span> io.agentscope.core.hook.Hook;
<span class="hljs-keyword">import</span> io.agentscope.core.hook.HookEvent;
<span class="hljs-keyword">import</span> io.agentscope.core.hook.PostActingEvent;
<span class="hljs-keyword">import</span> io.agentscope.core.hook.PostReasoningEvent;
<span class="hljs-keyword">import</span> io.agentscope.core.memory.InMemoryMemory;
<span class="hljs-keyword">import</span> io.agentscope.core.message.Msg;
<span class="hljs-keyword">import</span> io.agentscope.core.model.DashScopeChatModel;
<span class="hljs-keyword">import</span> io.agentscope.core.tool.Toolkit;
<span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> reactor.core.publisher.Mono;

<span class="hljs-keyword">import</span> java.time.Duration;
<span class="hljs-keyword">import</span> java.util.List;
<span class="hljs-keyword">import</span> java.util.concurrent.ConcurrentHashMap;
<span class="hljs-keyword">import</span> java.util.concurrent.atomic.AtomicLong;

<span class="hljs-comment">/**
 * 生产级智能客服系统
 * 
 * 功能：
 * 1. 多用户并发支持
 * 2. 会话管理
 * 3. 性能监控
 * 4. 日志记录
 * 5. 异常处理
 * 6. 超时控制
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomerServiceSystem</span> {
    
    <span class="hljs-comment">// ============ 系统组件 ============</span>
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentHashMap&lt;String, Agent&gt; userAgents = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">PerformanceMonitor</span> <span class="hljs-variable">monitor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PerformanceMonitor</span>();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Model model;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Toolkit toolkit;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CustomerServiceSystem</span><span class="hljs-params">(String apiKey)</span> {
        <span class="hljs-comment">// 初始化Model</span>
        <span class="hljs-built_in">this</span>.model = DashScopeChatModel.builder()
            .apiKey(apiKey)
            .modelName(<span class="hljs-string">"qwen-plus"</span>)
            .generateOptions(GenerateOptions.builder()
                .temperature(<span class="hljs-number">0.7</span>)
                .maxTokens(<span class="hljs-number">2000</span>)
                .build())
            .build();
        
        <span class="hljs-comment">// 初始化Toolkit</span>
        <span class="hljs-built_in">this</span>.toolkit = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Toolkit</span>();
        toolkit.registerObject(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomerServiceTools</span>());
    }
    
    <span class="hljs-comment">// ============ 核心方法 ============</span>
    
    <span class="hljs-comment">/**
     * 为用户创建或获取Agent
     */</span>
    <span class="hljs-keyword">public</span> Agent <span class="hljs-title function_">getOrCreateAgentForUser</span><span class="hljs-params">(String userId)</span> {
        <span class="hljs-keyword">return</span> userAgents.computeIfAbsent(userId, id -&gt; createCustomerServiceAgent(id));
    }
    
    <span class="hljs-comment">/**
     * 创建客服Agent
     */</span>
    <span class="hljs-keyword">private</span> Agent <span class="hljs-title function_">createCustomerServiceAgent</span><span class="hljs-params">(String userId)</span> {
        <span class="hljs-keyword">return</span> ReActAgent.builder()
            .name(<span class="hljs-string">"CustomerService-"</span> + userId)
            .description(<span class="hljs-string">"为用户 "</span> + userId + <span class="hljs-string">" 服务的智能客服"</span>)
            .model(model)
            .toolkit(toolkit)
            .memory(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryMemory</span>())
            .sysPrompt(buildSystemPrompt())
            .maxIters(<span class="hljs-number">8</span>)
            .checkRunning(<span class="hljs-literal">true</span>)
            .hooks(List.of(
                createLoggingHook(userId),
                createMonitoringHook(userId)
            ))
            .build();
    }
    
    <span class="hljs-comment">/**
     * 处理用户请求
     */</span>
    <span class="hljs-keyword">public</span> Mono&lt;CustomerServiceResponse&gt; <span class="hljs-title function_">handleUserRequest</span><span class="hljs-params">(
            String userId, 
            String message)</span> {
        
        <span class="hljs-type">Agent</span> <span class="hljs-variable">agent</span> <span class="hljs-operator">=</span> getOrCreateAgentForUser(userId);
        
        <span class="hljs-type">Msg</span> <span class="hljs-variable">userMsg</span> <span class="hljs-operator">=</span> Msg.builder()
            .textContent(message)
            .metadata(<span class="hljs-string">"userId"</span>, userId)
            .metadata(<span class="hljs-string">"timestamp"</span>, System.currentTimeMillis())
            .build();
        
        <span class="hljs-keyword">return</span> agent.call(userMsg)
            .timeout(Duration.ofSeconds(<span class="hljs-number">30</span>))  <span class="hljs-comment">// 30秒超时</span>
            .map(response -&gt; CustomerServiceResponse.builder()
                .userId(userId)
                .message(response.getTextContent())
                .timestamp(System.currentTimeMillis())
                .usage(response.getChatUsage())
                .build())
            .doOnError(error -&gt; handleError(userId, error))
            .onErrorResume(error -&gt; Mono.just(
                CustomerServiceResponse.builder()
                    .userId(userId)
                    .message(<span class="hljs-string">"抱歉，系统暂时无法处理您的请求，请稍后再试。"</span>)
                    .isError(<span class="hljs-literal">true</span>)
                    .build()));
    }
    
    <span class="hljs-comment">/**
     * 结构化查询（用于获取订单信息等）
     */</span>
    <span class="hljs-keyword">public</span> &lt;T&gt; Mono&lt;T&gt; <span class="hljs-title function_">handleStructuredQuery</span><span class="hljs-params">(
            String userId, 
            String message, 
            Class&lt;T&gt; responseType)</span> {
        
        <span class="hljs-type">Agent</span> <span class="hljs-variable">agent</span> <span class="hljs-operator">=</span> getOrCreateAgentForUser(userId);
        
        <span class="hljs-type">Msg</span> <span class="hljs-variable">userMsg</span> <span class="hljs-operator">=</span> Msg.builder()
            .textContent(message)
            .build();
        
        <span class="hljs-keyword">return</span> agent.call(userMsg, responseType)
            .timeout(Duration.ofSeconds(<span class="hljs-number">30</span>))
            .map(response -&gt; response.getStructuredData(responseType));
    }
    
    <span class="hljs-comment">/**
     * 清理用户会话
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cleanupUserSession</span><span class="hljs-params">(String userId)</span> {
        <span class="hljs-type">Agent</span> <span class="hljs-variable">agent</span> <span class="hljs-operator">=</span> userAgents.remove(userId);
        <span class="hljs-keyword">if</span> (agent != <span class="hljs-literal">null</span>) {
            System.out.println(<span class="hljs-string">"清理用户会话: "</span> + userId);
        }
    }
    
    <span class="hljs-comment">// ============ Hook实现 ============</span>
    
    <span class="hljs-comment">/**
     * 创建日志Hook
     */</span>
    <span class="hljs-keyword">private</span> Hook <span class="hljs-title function_">createLoggingHook</span><span class="hljs-params">(String userId)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hook</span>() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> &lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HookEvent</span>&gt; Mono&lt;T&gt; <span class="hljs-title function_">onEvent</span><span class="hljs-params">(T event)</span> {
                <span class="hljs-keyword">switch</span>(event) {
                    <span class="hljs-keyword">case</span> PostReasoningEvent post -&gt; 
                        System.out.printf(<span class="hljs-string">"[%s] 推理完成，耗时: %dms, Tokens: %d%n"</span>,
                            userId, post.getExecutionTime(), 
                            post.getUsage() != <span class="hljs-literal">null</span> ? post.getUsage().getTotalTokens() : <span class="hljs-number">0</span>);
                    
                    <span class="hljs-keyword">case</span> PostActingEvent post -&gt; 
                        System.out.printf(<span class="hljs-string">"[%s] 工具执行: %s, 耗时: %dms%n"</span>,
                            userId, post.getToolName(), post.getExecutionTime());
                    
                    <span class="hljs-keyword">default</span> -&gt; {}
                }
                <span class="hljs-keyword">return</span> Mono.just(event);
            }
        };
    }
    
    <span class="hljs-comment">/**
     * 创建监控Hook
     */</span>
    <span class="hljs-keyword">private</span> Hook <span class="hljs-title function_">createMonitoringHook</span><span class="hljs-params">(String userId)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hook</span>() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> &lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HookEvent</span>&gt; Mono&lt;T&gt; <span class="hljs-title function_">onEvent</span><span class="hljs-params">(T event)</span> {
                <span class="hljs-keyword">switch</span>(event) {
                    <span class="hljs-keyword">case</span> PostReasoningEvent post -&gt; {
                        monitor.recordReasoningTime(post.getExecutionTime());
                        <span class="hljs-keyword">if</span> (post.getUsage() != <span class="hljs-literal">null</span>) {
                            monitor.recordTokenUsage(post.getUsage().getTotalTokens());
                        }
                    }
                    <span class="hljs-keyword">case</span> PostActingEvent post -&gt; {
                        monitor.recordToolExecution(post.getToolName(), post.getExecutionTime());
                    }
                    <span class="hljs-keyword">default</span> -&gt; {}
                }
                <span class="hljs-keyword">return</span> Mono.just(event);
            }
        };
    }
    
    <span class="hljs-comment">/**
     * 系统提示词
     */</span>
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">buildSystemPrompt</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"""
            你是一个专业的智能客服助手。
            
            工作原则：
            1. 友好、耐心、专业
            2. 优先使用工具查询准确信息，不要猜测
            3. 如果无法解决问题，及时转人工客服
            4. 保护用户隐私，不泄露敏感信息
            5. 每次回复要简洁明了
            
            可用工具：
            - search_faq: 搜索常见问题
            - query_order: 查询订单状态
            - process_return: 处理退货请求
            - escalate_to_human: 转人工客服
            """</span>;
    }
    
    <span class="hljs-comment">/**
     * 错误处理
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleError</span><span class="hljs-params">(String userId, Throwable error)</span> {
        System.err.printf(<span class="hljs-string">"[%s] 错误: %s%n"</span>, userId, error.getMessage());
        monitor.recordError();
    }
    
    <span class="hljs-comment">/**
     * 获取系统统计
     */</span>
    <span class="hljs-keyword">public</span> PerformanceStats <span class="hljs-title function_">getStats</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> monitor.getStats();
    }
    
    <span class="hljs-comment">// ============ 数据类 ============</span>
    
    <span class="hljs-meta">@Data</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomerServiceResponse</span> {
        <span class="hljs-keyword">private</span> String userId;
        <span class="hljs-keyword">private</span> String message;
        <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> timestamp;
        <span class="hljs-keyword">private</span> ChatUsage usage;
        <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> isError;
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CustomerServiceResponseBuilder <span class="hljs-title function_">builder</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomerServiceResponseBuilder</span>();
        }
    }
    
    <span class="hljs-comment">// ============ 性能监控 ============</span>
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PerformanceMonitor</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">AtomicLong</span> <span class="hljs-variable">totalReasoningTime</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicLong</span>(<span class="hljs-number">0</span>);
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">AtomicLong</span> <span class="hljs-variable">totalTokens</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicLong</span>(<span class="hljs-number">0</span>);
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">AtomicLong</span> <span class="hljs-variable">errorCount</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicLong</span>(<span class="hljs-number">0</span>);
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentHashMap&lt;String, AtomicLong&gt; toolUsage = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">recordReasoningTime</span><span class="hljs-params">(<span class="hljs-type">long</span> ms)</span> {
            totalReasoningTime.addAndGet(ms);
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">recordTokenUsage</span><span class="hljs-params">(<span class="hljs-type">long</span> tokens)</span> {
            totalTokens.addAndGet(tokens);
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">recordToolExecution</span><span class="hljs-params">(String toolName, <span class="hljs-type">long</span> ms)</span> {
            toolUsage.computeIfAbsent(toolName, k -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicLong</span>(<span class="hljs-number">0</span>)).incrementAndGet();
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">recordError</span><span class="hljs-params">()</span> {
            errorCount.incrementAndGet();
        }
        
        <span class="hljs-keyword">public</span> PerformanceStats <span class="hljs-title function_">getStats</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PerformanceStats</span>(
                totalReasoningTime.get(),
                totalTokens.get(),
                errorCount.get(),
                toolUsage
            );
        }
    }
    
    <span class="hljs-meta">@Data</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PerformanceStats</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> totalReasoningTime;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> totalTokens;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> errorCount;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, AtomicLong&gt; toolUsage;
    }
    
    <span class="hljs-comment">// ============ 使用示例 ============</span>
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">CustomerServiceSystem</span> <span class="hljs-variable">system</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomerServiceSystem</span>(
            System.getenv(<span class="hljs-string">"DASHSCOPE_API_KEY"</span>));
        
        <span class="hljs-comment">// 场景1：处理用户请求</span>
        system.handleUserRequest(<span class="hljs-string">"user123"</span>, <span class="hljs-string">"我的订单什么时候发货？"</span>)
            .subscribe(response -&gt; {
                System.out.println(<span class="hljs-string">"客服回复: "</span> + response.getMessage());
                System.out.println(<span class="hljs-string">"Token使用: "</span> + response.getUsage().getTotalTokens());
            });
        
        <span class="hljs-comment">// 场景2：结构化查询订单信息</span>
        <span class="hljs-meta">@Data</span>
        <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderInfo</span> {
            <span class="hljs-keyword">private</span> String orderId;
            <span class="hljs-keyword">private</span> String status;
            <span class="hljs-keyword">private</span> String trackingNumber;
        }
        
        system.handleStructuredQuery(<span class="hljs-string">"user123"</span>, 
                <span class="hljs-string">"查询订单ORD-2024-001的信息"</span>, 
                OrderInfo.class)
            .subscribe(orderInfo -&gt; {
                System.out.println(<span class="hljs-string">"订单ID: "</span> + orderInfo.getOrderId());
                System.out.println(<span class="hljs-string">"状态: "</span> + orderInfo.getStatus());
                System.out.println(<span class="hljs-string">"物流单号: "</span> + orderInfo.getTrackingNumber());
            });
        
        <span class="hljs-comment">// 场景3：清理会话</span>
        system.cleanupUserSession(<span class="hljs-string">"user123"</span>);
        
        <span class="hljs-comment">// 场景4：查看统计</span>
        <span class="hljs-type">PerformanceStats</span> <span class="hljs-variable">stats</span> <span class="hljs-operator">=</span> system.getStats();
        System.out.println(<span class="hljs-string">"总推理时间: "</span> + stats.getTotalReasoningTime() + <span class="hljs-string">"ms"</span>);
        System.out.println(<span class="hljs-string">"总Token使用: "</span> + stats.getTotalTokens());
        System.out.println(<span class="hljs-string">"错误次数: "</span> + stats.getErrorCount());
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-22">4.6 本章总结</h2>
<h3 data-id="heading-23">关键要点</h3>
<ol>
<li>
<p><strong>Agent接口设计</strong></p>
<ul>
<li>响应式编程模型：Mono/Flux支持异步非阻塞</li>
<li>多态call()方法：适配不同使用场景</li>
<li>observe()方法：支持多Agent协作</li>
<li>结构化输出：要求Agent返回特定格式数据</li>
</ul>
</li>
<li>
<p><strong>AgentBase基类</strong></p>
<ul>
<li>提供通用功能实现</li>
<li>Hook系统集成</li>
<li>状态模块管理</li>
<li>重入检查保护</li>
</ul>
</li>
<li>
<p><strong>流式执行</strong></p>
<ul>
<li>stream()方法支持实时输出</li>
<li>丰富的事件类型</li>
<li>适用于UI交互场景</li>
</ul>
</li>
<li>
<p><strong>生产实践</strong></p>
<ul>
<li>多用户并发支持</li>
<li>性能监控</li>
<li>异常处理</li>
<li>超时控制</li>
</ul>
</li>
</ol>
<h3 data-id="heading-24">最佳实践</h3>
<pre><code class="hljs language-scss" lang="scss">✓ 使用响应式API，避免阻塞
✓ 合理设置超时时间
✓ 启用重入检查，防止递归调用
✓ 使用Hook进行日志和监控
✓ 为不同用户创建独立的Agent实例
✓ 定期清理不活跃的会话
✓ 使用结构化输出获取精确数据
✗ 不要在工具中调用Agent（避免死锁）
✗ 不要忽略错误处理
✗ 不要在生产环境中使用block()（除非必要）
</code></pre>
<h3 data-id="heading-25">下一章预告</h3>
<p>第5章将深入讲解<strong>ReActAgent的核心实现</strong>，探讨推理-行动循环的工作原理、迭代控制、工具调用流程等内容。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI 智能体高可靠设计模式：预生成]]></title>    <link>https://juejin.cn/post/7589386961647861795</link>    <guid>https://juejin.cn/post/7589386961647861795</guid>    <pubDate>2025-12-30T04:27:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589386961647861795" data-draft-id="7589308109640187939" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI 智能体高可靠设计模式：预生成"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-30T04:27:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="俞凡"/> <meta itemprop="url" content="https://juejin.cn/user/290747765274222"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI 智能体高可靠设计模式：预生成
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/290747765274222/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    俞凡
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T04:27:18.000Z" title="Tue Dec 30 2025 04:27:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><em>本系列介绍增强现代智能体系统可靠性的设计模式，以直观方式逐一介绍每个概念，拆解其目的，然后实现简单可行的版本，演示其如何融入现实世界的智能体系统。本系列一共 14 篇文章，这是第 2 篇。原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Flevelup.gitconnected.com%2Fbuilding-the-14-key-pillars-of-agentic-ai-229e50f65986" title="https://levelup.gitconnected.com/building-the-14-key-pillars-of-agentic-ai-229e50f65986" target="_blank" ref="nofollow noopener noreferrer">Building the 14 Key Pillars of Agentic AI</a></em></p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/acc017966a2144a5a358a7c81c922420~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-e5Yeh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767673637&amp;x-signature=UCrA9TuGC8do%2F8gCoMf%2FU5PUWO8%3D" alt="" loading="lazy"/></p>
<p>优化智能体解决方案需要软件工程确保组件协调、并行运行并与系统高效交互。例如<a href="https://link.juejin.cn?target=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FSpeculative_execution" title="https://en.wikipedia.org/wiki/Speculative_execution" target="_blank" ref="nofollow noopener noreferrer">预测执行</a>，会尝试处理可预测查询以<strong>降低时延</strong>，或者进行<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.arm.com%2Fcommunity%2Farm-community-blogs%2Fb%2Fembedded-and-microcontrollers-blog%2Fposts%2Fcomparing-lock-step-redundant-execution-versus-split-lock-technologies" title="https://developer.arm.com/community/arm-community-blogs/b/embedded-and-microcontrollers-blog/posts/comparing-lock-step-redundant-execution-versus-split-lock-technologies" target="_blank" ref="nofollow noopener noreferrer">冗余执行</a>，即<strong>对同一智能体重复执行多次</strong>以防单点故障。其他增强现代智能体系统可靠性的模式包括：</p>
<ul>
<li><strong>并行工具</strong>：智能体同时执行独立 API 调用以隐藏 I/O 时延。</li>
<li><strong>层级智能体</strong>：管理者将任务拆分为由执行智能体处理的小步骤。</li>
<li><strong>竞争性智能体组合</strong>：多个智能体提出答案，系统选出最佳。</li>
<li><strong>冗余执行</strong>：即两个或多个智能体解决同一任务以检测错误并提高可靠性。</li>
<li><strong>并行检索和混合检索</strong>：多种检索策略协同运行以提升上下文质量。</li>
<li><strong>多跳检索</strong>：智能体通过迭代检索步骤收集更深入、更相关的信息。</li>
</ul>
<p>还有很多其他模式。</p>
<p>本系列将实现最常用智能体模式背后的基础概念，以直观方式逐一介绍每个概念，拆解其目的，然后实现简单可行的版本，演示其如何融入现实世界的智能体系统。</p>
<p>所有理论和代码都在 GitHub 仓库里：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FFareedKhan-dev%2Fagentic-parallelism" title="https://github.com/FareedKhan-dev/agentic-parallelism" target="_blank" ref="nofollow noopener noreferrer">🤖 Agentic Parallelism: A Practical Guide 🚀</a></p>
<p>代码库组织如下：</p>
<pre><code class="hljs language-erlang" lang="erlang">agentic-parallelism/
    ├── <span class="hljs-number">01</span>_parallel_tool_use.ipynb
    ├── <span class="hljs-number">02</span>_parallel_hypothesis.ipynb
    ...
    ├── <span class="hljs-number">06</span>_competitive_agent_ensembles.ipynb
    ├── <span class="hljs-number">07</span>_agent_assembly_line.ipynb
    ├── <span class="hljs-number">08</span>_decentralized_blackboard.ipynb
    ...
    ├── <span class="hljs-number">13</span>_parallel_context_preprocessing.ipynb
    └── <span class="hljs-number">14</span>_parallel_multi_hop_retrieval.ipynb
</code></pre>
<hr/>
<h2 data-id="heading-0">从预生成到战略探索</h2>
<p>在之前模式中，代理遵循单一线性思维路径，如果初始方法存在缺陷或不是最优，整个过程就会受到影响……</p>
<p>在复杂或富有创意的任务中，最先出现的点子往往不是最佳的，这是一个重大风险。</p>
<p><strong>并发预生成（Parallel Hypothesis Generation）</strong>，也称为<strong>分支思考（Branching Thoughts）</strong>，是一种不对单一想法作出回应的结构性方法。</p>
<ol>
<li>系统一开始就明确生成多种多样的策略或“假设”，而不是单一线性推理。</li>
<li>然后并行探索所有路径，并为每条路径生成解。</li>
<li>最后评估竞争方案，选出最优方案。从而创造更稳健、更具创造力，且更不容易陷入次优路径的系统。</li>
</ol>
<p>我们将构建一个多智能体系统，以应对创意营销任务。由 <strong>规划器（Planner）</strong>、并发 <strong>执行器（Workers）</strong> 和 <strong>评估器（Judge）</strong> 组成，目标是展示最终输出相比单个代理能产出的明显有质的提升。</p>
<p>首先，为管理代理之间复杂的信息流，需要为输出定义结构化的双质模型，这是将多智能体系统粘合在一起的纽带。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.pydantic_v1 <span class="hljs-keyword">import</span> BaseModel, Field
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MarketingHypothesis</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-string">"""A Pydantic model for a single, distinct marketing angle or strategy to explore."""</span>
    <span class="hljs-comment"># 为这个角度取一个简短、朗朗上口的名字 (例如, 'The Tech Enthusiast')</span>
    angle_name: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"A short, catchy name for the marketing angle (e.g., 'The Tech Enthusiast')."</span>)
    <span class="hljs-comment"># 对目标受众和核心信息的简明描述</span>
    description: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"A one-sentence description of the target audience and core message for this angle."</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Plan</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-string">"""A Pydantic container for the Planner's output, holding multiple hypotheses."""</span>
    <span class="hljs-comment"># 列表包含 3 种需要并行探索的营销假设</span>
    hypotheses: <span class="hljs-type">List</span>[MarketingHypothesis] = Field(description=<span class="hljs-string">"A list of exactly 3 distinct marketing hypotheses to explore in parallel."</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Slogan</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-string">"""A Pydantic model for the output of a single copywriting Worker."""</span>
    slogan: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"The generated marketing slogan."</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Evaluation</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-string">"""A Pydantic model for the final, structured output of the Judge agent."""</span>
    <span class="hljs-comment"># 一份比较所有生成口号的详细评估</span>
    critique: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"A detailed critique of all slogans, explaining the pros and cons of each."</span>)
    <span class="hljs-comment"># 评估器选出的最佳标语</span>
    best_slogan: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"The single best slogan chosen from the list."</span>)
</code></pre>
<p>这些 Pydantic 模型是代理之间的正式“数据契约”。例如，<code>Plan</code> 类确保规划器代理始终输出一个 <code>MarketingHypothesis</code> 对象列表，<code>Evaluation</code> 类确保评估器不仅会提供一个致胜口号，还会提供详尽的 <code>critique</code>。</p>
<p>接下来定义 <code>GraphState</code>，这比之前的模式更复杂，需要跟踪初始计划以及多个并行工作分支的结果。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> TypedDict, Annotated, <span class="hljs-type">List</span>, <span class="hljs-type">Dict</span>
<span class="hljs-keyword">import</span> operator

<span class="hljs-keyword">class</span> <span class="hljs-title class_">GraphState</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    product_description: <span class="hljs-built_in">str</span>
    plan: <span class="hljs-type">List</span>[MarketingHypothesis]
    <span class="hljs-comment"># 'worker_results' 是字典，键是角度名称，值是生成的口号</span>
    <span class="hljs-comment"># 'operator.update' 归约函数告诉 LangGraph 从并行分支合并字典，而非替换</span>
    worker_results: Annotated[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, Slogan], operator.update]
    final_evaluation: Evaluation
    performance_log: Annotated[<span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>], operator.add]
</code></pre>
<p>最重要的部分是：<code>worker_results: Annotated[Dict[str, Slogan], operator.update]</code>。当并行工作节点完成时，每个节点会返回一个带有自身结果的小字典。<code>operator.update</code> 归约函数指示 <code>LangGraph</code> 将这些词典合并为最终状态下的综合 <code>worker_results</code> 对象，以确保数据不丢失。</p>
<p>接下来定义 <strong>规划器（Planner）</strong> 代理，它是图中的第一个节点。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">planner_node</span>(<span class="hljs-params">state: GraphState</span>):
    <span class="hljs-string">"""The Planner node: generates the initial marketing plan with multiple, diverse hypotheses."""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"--- AGENT: Planner is thinking... ---"</span>)
    start_time = time.time()

    <span class="hljs-comment"># 创建一个链，将 planner_prompt 传递给 LLM，指示它输出一个 'Plan' 对象</span>
    planner_chain = planner_prompt | llm.with_structured_output(Plan)
    plan = planner_chain.invoke({<span class="hljs-string">"product_description"</span>: state[<span class="hljs-string">'product_description'</span>]})

    execution_time = time.time() - start_time
    log_entry = <span class="hljs-string">f"[Planner] Generated <span class="hljs-subst">{<span class="hljs-built_in">len</span>(plan.hypotheses)}</span> hypotheses in <span class="hljs-subst">{execution_time:<span class="hljs-number">.2</span>f}</span>s."</span>
    <span class="hljs-built_in">print</span>(log_entry)

    <span class="hljs-comment"># 用假设列表和性能日志更新状态</span>
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"plan"</span>: plan.hypotheses, <span class="hljs-string">"performance_log"</span>: [log_entry]}
</code></pre>
<p><code>planner_node</code> 通过 LLM 将高层次的 <code>product_description</code> 分解为三个独立且可并行化的子任务（<code>MarketingHypothesis</code> 对象），这个初始的“扇出”步骤是整个图的基础。</p>
<p>接下来定义 <strong>执行器（Worker）</strong> 代理，该节点特殊之处在于会并行多次执行，每个由规划器生成的假设都会执行一次。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">worker_node</span>(<span class="hljs-params">state: GraphState, config</span>):
    <span class="hljs-string">"""The Worker node: generates a slogan for a single, specific hypothesis. This node will be run in parallel for each hypothesis."""</span>
    <span class="hljs-comment"># 'config' 对象是 LangGraph 的一个提供运行时信息的特殊参数</span>
    <span class="hljs-comment"># 从 'configurable' 字典中检索执行器实例的特定假设</span>
    hypothesis = config[<span class="hljs-string">"configurable"</span>][<span class="hljs-string">"hypothesis"</span>]
    angle_name = hypothesis.angle_name

    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"--- AGENT: Worker for '<span class="hljs-subst">{angle_name}</span>' is thinking... ---"</span>)
    start_time = time.time()

    <span class="hljs-comment"># 为这个执行器创建链</span>
    worker_chain = worker_prompt | llm.with_structured_output(Slogan)
    result = worker_chain.invoke({
        <span class="hljs-string">"product_description"</span>: state[<span class="hljs-string">'product_description'</span>],
        <span class="hljs-string">"angle_name"</span>: angle_name,
        <span class="hljs-string">"description"</span>: hypothesis.description
    })
    
    execution_time = time.time() - start_time
    log_entry = <span class="hljs-string">f"[Worker-<span class="hljs-subst">{angle_name}</span>] Generated slogan in <span class="hljs-subst">{execution_time:<span class="hljs-number">.2</span>f}</span>s."</span>
    <span class="hljs-built_in">print</span>(log_entry)
    
    <span class="hljs-comment"># 输出是字典，键是角度名称，</span>
    <span class="hljs-comment"># 允许 'operator.update' 归约函数正确合并所有并行工作的结果</span>
    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">"worker_results"</span>: {angle_name: result},
        <span class="hljs-string">"performance_log"</span>: [log_entry]
    }
</code></pre>
<p><code>worker_node</code> 是复写器（copywriter），不会从主 <code>state</code> 读取，相反从 <code>config</code> 对象那里接收 <code>hypothesis</code>。这就是 <code>LangGraph</code> 将唯一输入传递给同一节点的并行执行的方式，使每个执行器能够专注于其分配的问题切片。</p>
<p>现在我们需要一个作为条件边的函数，把任务分配给并行执行器。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langgraph.graph.graph <span class="hljs-keyword">import</span> Send

<span class="hljs-keyword">def</span> <span class="hljs-title function_">scatter_to_workers</span>(<span class="hljs-params">state: GraphState</span>) -&gt; <span class="hljs-type">List</span>[Send]:
    <span class="hljs-string">"""A special edge function that scatters the plan to the parallel workers."""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"--- ORCHESTRATOR: Scattering tasks to workers --- "</span>)
    <span class="hljs-comment"># 函数返回 'Send' 对象列表</span>
    <span class="hljs-comment"># 每个 'Send' 对象都是图的一条指令，通过 'config' 参数传递特定输入，</span>
    <span class="hljs-comment"># 将任务分派给特定节点（'worker'）。</span>
    tasks = [
        Send(
            <span class="hljs-string">"worker"</span>,
            config={<span class="hljs-string">"configurable"</span>: {<span class="hljs-string">"hypothesis"</span>: hypothesis}}
        )
        <span class="hljs-keyword">for</span> hypothesis <span class="hljs-keyword">in</span> state[<span class="hljs-string">'plan'</span>]
    ]
    <span class="hljs-keyword">return</span> tasks
</code></pre>
<p><code>scatter_to_workers</code> 函数是动态并行的核心，它不是标准节点，而是用作条件边的函数。从状态读取 <code>plan</code>，并程序化的构建 <code>Send</code> 对象列表。每个 <code>Send</code> 都是 <code>LangGraph</code> 命令，用于调用具有唯一配置的 <code>worker</code> 节点。当条件边返回此类 <code>Send</code> 对象列表时，<code>LangGraph</code> 理解必须并行执行所有对象。</p>
<p>最后，<strong>评估器（Judge）</strong> 代理负责收集并评估所有执行器的结果。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">judge_node</span>(<span class="hljs-params">state: GraphState</span>):
    <span class="hljs-string">"""The Judge node: evaluates all worker results, provides a critique, and selects the single best one."""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"--- AGENT: Judge is evaluating... ---"</span>)
    start_time = time.time()
    
    <span class="hljs-comment"># 将并行工作结果格式化为单个字符串，以供评估器提示</span>
    slogans_to_evaluate = <span class="hljs-string">""</span>
    <span class="hljs-keyword">for</span> angle, slogan_obj <span class="hljs-keyword">in</span> state[<span class="hljs-string">'worker_results'</span>].items():
        slogans_to_evaluate += <span class="hljs-string">f"Angle: <span class="hljs-subst">{angle}</span>\nSlogan: <span class="hljs-subst">{slogan_obj.slogan}</span>\n\n"</span>
    
    <span class="hljs-comment"># 构建评估器链</span>
    judge_chain = judge_prompt | llm.with_structured_output(Evaluation)
    evaluation = judge_chain.invoke({
        <span class="hljs-string">"product_description"</span>: state[<span class="hljs-string">'product_description'</span>],
        <span class="hljs-string">"slogans_to_evaluate"</span>: slogans_to_evaluate
    })
    
    execution_time = time.time() - start_time
    log_entry = <span class="hljs-string">f"[Judge] Evaluated <span class="hljs-subst">{<span class="hljs-built_in">len</span>(state[<span class="hljs-string">'worker_results'</span>])}</span> slogans in <span class="hljs-subst">{execution_time:<span class="hljs-number">.2</span>f}</span>s."</span>
    <span class="hljs-built_in">print</span>(log_entry)
    
    <span class="hljs-comment"># 在状态里更新最终结果</span>
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"final_evaluation"</span>: evaluation, <span class="hljs-string">"performance_log"</span>: [log_entry]}
</code></pre>
<p><code>judge_node</code> 是“扇入”或聚合，负责读取 <code>worker_results</code> 词典并综合结果，执行最后的关键推理步骤，即比较竞争观点并做出合理决策，最终产出整个系统的高质量输出。</p>
<p>定义好所有节点和边后，可以组装并编译最终的图。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langgraph.graph <span class="hljs-keyword">import</span> StateGraph, END

<span class="hljs-comment"># 用定义的状态初始化一个新的图</span>
workflow = StateGraph(GraphState)

<span class="hljs-comment"># 添加代表代理的节点</span>
workflow.add_node(<span class="hljs-string">"planner"</span>, planner_node)
workflow.add_node(<span class="hljs-string">"worker"</span>, worker_node)
workflow.add_node(<span class="hljs-string">"judge"</span>, judge_node)

<span class="hljs-comment"># 工作流入口点是规划器</span>
workflow.set_entry_point(<span class="hljs-string">"planner"</span>)

<span class="hljs-comment"># 在规划器之后，用特殊的 'scatter_to_workers' 函数作为条件边来扇出工作</span>
workflow.add_conditional_edges(<span class="hljs-string">"planner"</span>, scatter_to_workers)

<span class="hljs-comment"># 当所有执行器节点完成后，结果将自动聚合，</span>
<span class="hljs-comment"># 定义一个静态边来扇入到评估器中</span>
workflow.add_edge(<span class="hljs-string">"worker"</span>, <span class="hljs-string">"judge"</span>)

<span class="hljs-comment"># 评估是图结束前的最后一步</span>
workflow.add_edge(<span class="hljs-string">"judge"</span>, END)

<span class="hljs-comment"># 将图编译为可执行应用程序</span>
app = workflow.<span class="hljs-built_in">compile</span>()
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18b435f674e34323bb752a5dc6d0287e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-e5Yeh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767673637&amp;x-signature=Ay1jNnimVS9Ie%2By9CJGZyqq%2FXG0%3D" alt="并发预生成" loading="lazy"/></p>
<p>现在进行最终定量证明，分析性能日志，看看并行执行的好处。</p>
<pre><code class="hljs language-python" lang="python">total_time = <span class="hljs-number">0</span>
planner_time = <span class="hljs-number">0</span>
worker_times = []
judge_time = <span class="hljs-number">0</span>

<span class="hljs-comment"># 解析性能日志以提取每个阶段的时间</span>
<span class="hljs-keyword">for</span> log <span class="hljs-keyword">in</span> final_state[<span class="hljs-string">'performance_log'</span>]:
    time_val = <span class="hljs-built_in">float</span>(log.split(<span class="hljs-string">' '</span>)[-<span class="hljs-number">1</span>].replace(<span class="hljs-string">'s'</span>, <span class="hljs-string">''</span>))
    <span class="hljs-keyword">if</span> <span class="hljs-string">"[Planner]"</span> <span class="hljs-keyword">in</span> log:
        planner_time = time_val
    <span class="hljs-keyword">elif</span> <span class="hljs-string">"[Worker-"</span> <span class="hljs-keyword">in</span> log:
        worker_times.append(time_val)
    <span class="hljs-keyword">elif</span> <span class="hljs-string">"[Judge]"</span> <span class="hljs-keyword">in</span> log:
        judge_time = time_val

<span class="hljs-comment"># 并行步骤的总时间是运行时间最长的任务的时间</span>
parallel_worker_time = <span class="hljs-built_in">max</span>(worker_times) <span class="hljs-keyword">if</span> worker_times <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>

<span class="hljs-comment"># 整个工作流的总时间</span>
total_execution_time = planner_time + parallel_worker_time + judge_time
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"Total Execution Time: <span class="hljs-subst">{total_execution_time:<span class="hljs-number">.2</span>f}</span> seconds\n"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"Breakdown:"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f" - Planner: <span class="hljs-subst">{planner_time:<span class="hljs-number">.2</span>f}</span> seconds"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f" - Parallel Workers (longest path): <span class="hljs-subst">{parallel_worker_time:<span class="hljs-number">.2</span>f}</span> seconds"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f" - Judge: <span class="hljs-subst">{judge_time:<span class="hljs-number">.2</span>f}</span> seconds\n"</span>)

<span class="hljs-comment"># 现在模拟在顺序工作流程中会发生什么</span>
sequential_worker_time = <span class="hljs-built_in">sum</span>(worker_times)
time_saved = sequential_worker_time - parallel_worker_time
</code></pre>
<p>这就是现在看到的……</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment">#### 输出 ####</span>
============================================================
                      PERFORMANCE ANALYSIS
============================================================
Total Execution Time: <span class="hljs-number">19.24</span> seconds


Breakdown:
 - Planner: <span class="hljs-number">6.78</span> seconds
 - Parallel Workers (longest path): <span class="hljs-number">5.31</span> seconds
 - Judge: <span class="hljs-number">7.15</span> seconds
</code></pre>
<p>三个执行器分别用了 5.31s、5.12s 和 4.98s。如果按顺序执行，该阶段将耗时 15.41s（5.31 + 5.12 + 4.98）。</p>
<p>通过并行执行，该阶段时间仅为 5.31s（即最长执行器时间）。</p>
<p>这为这一步骤节省了超过 10s 的时间。</p>
<p><strong>更重要的是，最终产出质量更好</strong>。系统不仅生成了口号，而且探索了由三种不同策略定义的空间，然后通过另一个推理步骤选择最佳策略。</p>
<hr/>
<blockquote>
<p>Hi，我是俞凡，一名兼具技术深度与管理视野的技术管理者。曾就职于 Motorola，现任职于 Mavenir，多年带领技术团队，聚焦后端架构与云原生，持续关注 AI 等前沿方向，也关注人的成长，笃信持续学习的力量。在这里，我会分享技术实践与思考。欢迎关注公众号「DeepNoMind」，星标不迷路。也欢迎访问独立站 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.deepnomind.com" title="https://www.deepnomind.com" target="_blank" ref="nofollow noopener noreferrer">www.DeepNoMind.com</a>，一起交流成长。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[智能体设计模式解析：交接模式（Handoffs）]]></title>    <link>https://juejin.cn/post/7589217625901924361</link>    <guid>https://juejin.cn/post/7589217625901924361</guid>    <pubDate>2025-12-30T04:33:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589217625901924361" data-draft-id="7589167252723384370" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="智能体设计模式解析：交接模式（Handoffs）"/> <meta itemprop="keywords" content="LangChain,Agent,AI编程"/> <meta itemprop="datePublished" content="2025-12-30T04:33:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="FreeCode"/> <meta itemprop="url" content="https://juejin.cn/user/1282499717900794"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            智能体设计模式解析：交接模式（Handoffs）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1282499717900794/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    FreeCode
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T04:33:31.000Z" title="Tue Dec 30 2025 04:33:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、交接模式（Handoffs）定义</h2>
<p>在交接模式中，系统行为会基于状态动态变化。其核心机制为：工具会更新一个可跨轮次持久化的状态变量（例如current_step（当前步骤）或active_agent（活跃智能体）），系统通过读取该变量来调整行为 —— 要么应用不同的配置（系统提示词、工具），要么将任务路由至另一个智能体。这种模式既支持不同智能体之间的任务交接，也可实现单个智能体内部的动态配置变更。</p>
<p>“交接”（handoffs）这一术语由 OpenAI 提出，用于描述借助工具调用（例如transfer_to_x_agent）在多个智能体或不同状态之间转移控制权的机制。</p>
<h2 data-id="heading-1">二、核心特征</h2>
<ul>
<li>状态驱动行为：行为基于状态变量（如 current_step（当前步骤）或 active_agent（活跃智能体））动态调整</li>
<li>基于工具的状态转换：通过工具更新状态变量，实现不同状态间的交接</li>
<li>用户直接交互：每个状态的配置均可直接处理用户消息</li>
<li>状态持久化：状态可在多轮对话中保持有效</li>
</ul>
<h2 data-id="heading-2">三、适用场景</h2>
<p>当你需要强制执行顺序约束（仅在前置条件满足后开放对应功能）、智能体需要跨不同状态与用户直接对话，或需要构建多阶段对话流程时，可采用该交接模式。此模式在客服场景中尤为实用，例如需要按特定顺序收集信息的业务 —— 比如处理退款前，需先收集用户的保修编号。</p>
<h2 data-id="heading-3">四、基础实现</h2>
<p>核心机制是借助一个工具返回指令（Command） 以更新状态，进而触发向新步骤或新智能体的交接。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.tools <span class="hljs-keyword">import</span> tool
<span class="hljs-keyword">from</span> langchain.messages <span class="hljs-keyword">import</span> ToolMessage
<span class="hljs-keyword">from</span> langgraph.types <span class="hljs-keyword">import</span> Command

<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">transfer_to_specialist</span>(<span class="hljs-params">runtime</span>) -&gt; Command:
    <span class="hljs-string">"""Transfer to the specialist agent."""</span>
    <span class="hljs-keyword">return</span> Command(
        update={
            <span class="hljs-string">"messages"</span>: [
                ToolMessage(  
                    content=<span class="hljs-string">"Transferred to specialist"</span>,
                    tool_call_id=runtime.tool_call_id  
                )
            ],
            <span class="hljs-string">"current_step"</span>: <span class="hljs-string">"specialist"</span>  <span class="hljs-comment"># Triggers behavior change</span>
        }
    )
</code></pre>
<h2 data-id="heading-4">五、实现方案</h2>
<p>实现交接机制有两种方式：带中间件的单智能体方案（一个智能体搭配动态配置）与多智能体子图方案（将独立智能体作为图节点）。</p>
<h3 data-id="heading-5">5.1 带中间件的单智能体方案</h3>
<p>单个智能体基于状态调整自身行为。中间件会拦截每次模型调用，并动态调整系统提示词与可用工具。工具通过更新状态变量来触发状态交接。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> AgentState, create_agent
<span class="hljs-keyword">from</span> langchain.agents.middleware <span class="hljs-keyword">import</span> wrap_model_call, ModelRequest, ModelResponse
<span class="hljs-keyword">from</span> langchain.tools <span class="hljs-keyword">import</span> tool, ToolRuntime
<span class="hljs-keyword">from</span> langchain.messages <span class="hljs-keyword">import</span> ToolMessage
<span class="hljs-keyword">from</span> langgraph.types <span class="hljs-keyword">import</span> Command
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Callable</span>

<span class="hljs-comment"># 1. Define state with current_step tracker</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SupportState</span>(<span class="hljs-title class_ inherited__">AgentState</span>):  
    <span class="hljs-string">"""Track which step is currently active."""</span>
    current_step: <span class="hljs-built_in">str</span> = <span class="hljs-string">"triage"</span>
    warranty_status: <span class="hljs-built_in">str</span> | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>

<span class="hljs-comment"># 2. Tools update current_step via Command</span>
<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">record_warranty_status</span>(<span class="hljs-params">
    status: <span class="hljs-built_in">str</span>,
    runtime: ToolRuntime[<span class="hljs-literal">None</span>, SupportState]
</span>) -&gt; Command:  
    <span class="hljs-string">"""Record warranty status and transition to next step."""</span>
    <span class="hljs-keyword">return</span> Command(update={  
        <span class="hljs-string">"messages"</span>: [  
            ToolMessage(
                content=<span class="hljs-string">f"Warranty status recorded: <span class="hljs-subst">{status}</span>"</span>,
                tool_call_id=runtime.tool_call_id
            )
        ],
        <span class="hljs-string">"warranty_status"</span>: status,
        <span class="hljs-comment"># Transition to next step</span>
        <span class="hljs-string">"current_step"</span>: <span class="hljs-string">"specialist"</span>
    })

<span class="hljs-comment"># 3. Middleware applies dynamic configuration based on current_step</span>
<span class="hljs-meta">@wrap_model_call</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">apply_step_config</span>(<span class="hljs-params">
    request: ModelRequest,
    handler: <span class="hljs-type">Callable</span>[[ModelRequest], ModelResponse]
</span>) -&gt; ModelResponse:
    <span class="hljs-string">"""Configure agent behavior based on current_step."""</span>
    step = request.state.get(<span class="hljs-string">"current_step"</span>, <span class="hljs-string">"triage"</span>)  

    <span class="hljs-comment"># Map steps to their configurations</span>
    configs = {
        <span class="hljs-string">"triage"</span>: {
            <span class="hljs-string">"prompt"</span>: <span class="hljs-string">"Collect warranty information..."</span>,
            <span class="hljs-string">"tools"</span>: [record_warranty_status]
        },
        <span class="hljs-string">"specialist"</span>: {
            <span class="hljs-string">"prompt"</span>: <span class="hljs-string">"Provide solutions based on warranty: {warranty_status}"</span>,
            <span class="hljs-string">"tools"</span>: [provide_solution, escalate]
        }
    }

    config = configs[step]
    request = request.override(  
        system_prompt=config[<span class="hljs-string">"prompt"</span>].<span class="hljs-built_in">format</span>(**request.state),  
        tools=config[<span class="hljs-string">"tools"</span>]  
    )
    <span class="hljs-keyword">return</span> handler(request)

<span class="hljs-comment"># 4. Create agent with middleware</span>
agent = create_agent(
    model,
    tools=[record_warranty_status, provide_solution, escalate],
    state_schema=SupportState,
    middleware=[apply_step_config],  
    checkpointer=InMemorySaver()  <span class="hljs-comment"># Persist state across turns  #</span>
)
</code></pre>
<h3 data-id="heading-6">5.2 多智能体子图</h3>
<p>多个独立的智能体作为图中的不同节点存在。交接工具通过Command.PARENT指定下一个待执行的节点，以此在智能体节点之间进行调度。
子图交接需要精心设计上下文。与单智能体中间件（其消息历史可自然流转）不同，你必须明确决定在智能体之间传递哪些消息。如果这一步处理不当，智能体将会接收到格式错误的对话历史，或冗余臃肿的上下文。详情参见下文的上下文设计部分。</p>
<h4 data-id="heading-7">5.2.1 实现示例</h4>
<p>本示例展示了一个包含独立销售智能体与支持智能体的多智能体系统。每个智能体均为独立的图节点，交接工具可支持智能体之间的对话转接。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Literal</span>

<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> AgentState, create_agent
<span class="hljs-keyword">from</span> langchain.messages <span class="hljs-keyword">import</span> AIMessage, ToolMessage
<span class="hljs-keyword">from</span> langchain.tools <span class="hljs-keyword">import</span> tool, ToolRuntime
<span class="hljs-keyword">from</span> langgraph.graph <span class="hljs-keyword">import</span> StateGraph, START, END
<span class="hljs-keyword">from</span> langgraph.types <span class="hljs-keyword">import</span> Command
<span class="hljs-keyword">from</span> typing_extensions <span class="hljs-keyword">import</span> NotRequired


<span class="hljs-comment"># 1. Define state with active_agent tracker</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MultiAgentState</span>(<span class="hljs-title class_ inherited__">AgentState</span>):
    active_agent: NotRequired[<span class="hljs-built_in">str</span>]


<span class="hljs-comment"># 2. Create handoff tools</span>
<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">transfer_to_sales</span>(<span class="hljs-params">
    runtime: ToolRuntime,
</span>) -&gt; Command:
    <span class="hljs-string">"""Transfer to the sales agent."""</span>
    last_ai_message = <span class="hljs-built_in">next</span>(  
        msg <span class="hljs-keyword">for</span> msg <span class="hljs-keyword">in</span> <span class="hljs-built_in">reversed</span>(runtime.state[<span class="hljs-string">"messages"</span>]) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(msg, AIMessage)  
    )  
    transfer_message = ToolMessage(  
        content=<span class="hljs-string">"Transferred to sales agent from support agent"</span>,  
        tool_call_id=runtime.tool_call_id,  
    )  
    <span class="hljs-keyword">return</span> Command(
        goto=<span class="hljs-string">"sales_agent"</span>,
        update={
            <span class="hljs-string">"active_agent"</span>: <span class="hljs-string">"sales_agent"</span>,
            <span class="hljs-string">"messages"</span>: [last_ai_message, transfer_message],  
        },
        graph=Command.PARENT,
    )


<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">transfer_to_support</span>(<span class="hljs-params">
    runtime: ToolRuntime,
</span>) -&gt; Command:
    <span class="hljs-string">"""Transfer to the support agent."""</span>
    last_ai_message = <span class="hljs-built_in">next</span>(  
        msg <span class="hljs-keyword">for</span> msg <span class="hljs-keyword">in</span> <span class="hljs-built_in">reversed</span>(runtime.state[<span class="hljs-string">"messages"</span>]) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(msg, AIMessage)  
    )  
    transfer_message = ToolMessage(  
        content=<span class="hljs-string">"Transferred to support agent from sales agent"</span>,  
        tool_call_id=runtime.tool_call_id,  
    )  
    <span class="hljs-keyword">return</span> Command(
        goto=<span class="hljs-string">"support_agent"</span>,
        update={
            <span class="hljs-string">"active_agent"</span>: <span class="hljs-string">"support_agent"</span>,
            <span class="hljs-string">"messages"</span>: [last_ai_message, transfer_message],  
        },
        graph=Command.PARENT,
    )


<span class="hljs-comment"># 3. Create agents with handoff tools</span>
sales_agent = create_agent(
    model=<span class="hljs-string">"anthropic:claude-sonnet-4-20250514"</span>,
    tools=[transfer_to_support],
    system_prompt=<span class="hljs-string">"You are a sales agent. Help with sales inquiries. If asked about technical issues or support, transfer to the support agent."</span>,
)

support_agent = create_agent(
    model=<span class="hljs-string">"anthropic:claude-sonnet-4-20250514"</span>,
    tools=[transfer_to_sales],
    system_prompt=<span class="hljs-string">"You are a support agent. Help with technical issues. If asked about pricing or purchasing, transfer to the sales agent."</span>,
)


<span class="hljs-comment"># 4. Create agent nodes that invoke the agents</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">call_sales_agent</span>(<span class="hljs-params">state: MultiAgentState</span>) -&gt; Command:
    <span class="hljs-string">"""Node that calls the sales agent."""</span>
    response = sales_agent.invoke(state)
    <span class="hljs-keyword">return</span> response


<span class="hljs-keyword">def</span> <span class="hljs-title function_">call_support_agent</span>(<span class="hljs-params">state: MultiAgentState</span>) -&gt; Command:
    <span class="hljs-string">"""Node that calls the support agent."""</span>
    response = support_agent.invoke(state)
    <span class="hljs-keyword">return</span> response


<span class="hljs-comment"># 5. Create router that checks if we should end or continue</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">route_after_agent</span>(<span class="hljs-params">
    state: MultiAgentState,
</span>) -&gt; <span class="hljs-type">Literal</span>[<span class="hljs-string">"sales_agent"</span>, <span class="hljs-string">"support_agent"</span>, <span class="hljs-string">"__end__"</span>]:
    <span class="hljs-string">"""Route based on active_agent, or END if the agent finished without handoff."""</span>
    messages = state.get(<span class="hljs-string">"messages"</span>, [])

    <span class="hljs-comment"># Check the last message - if it's an AIMessage without tool calls, we're done</span>
    <span class="hljs-keyword">if</span> messages:
        last_msg = messages[-<span class="hljs-number">1</span>]
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(last_msg, AIMessage) <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> last_msg.tool_calls:  
            <span class="hljs-keyword">return</span> <span class="hljs-string">"__end__"</span>

    <span class="hljs-comment"># Otherwise route to the active agent</span>
    active = state.get(<span class="hljs-string">"active_agent"</span>, <span class="hljs-string">"sales_agent"</span>)
    <span class="hljs-keyword">return</span> active <span class="hljs-keyword">if</span> active <span class="hljs-keyword">else</span> <span class="hljs-string">"sales_agent"</span>


<span class="hljs-keyword">def</span> <span class="hljs-title function_">route_initial</span>(<span class="hljs-params">
    state: MultiAgentState,
</span>) -&gt; <span class="hljs-type">Literal</span>[<span class="hljs-string">"sales_agent"</span>, <span class="hljs-string">"support_agent"</span>]:
    <span class="hljs-string">"""Route to the active agent based on state, default to sales agent."""</span>
    <span class="hljs-keyword">return</span> state.get(<span class="hljs-string">"active_agent"</span>) <span class="hljs-keyword">or</span> <span class="hljs-string">"sales_agent"</span>


<span class="hljs-comment"># 6. Build the graph</span>
builder = StateGraph(MultiAgentState)
builder.add_node(<span class="hljs-string">"sales_agent"</span>, call_sales_agent)
builder.add_node(<span class="hljs-string">"support_agent"</span>, call_support_agent)

<span class="hljs-comment"># Start with conditional routing based on initial active_agent</span>
builder.add_conditional_edges(START, route_initial, [<span class="hljs-string">"sales_agent"</span>, <span class="hljs-string">"support_agent"</span>])

<span class="hljs-comment"># After each agent, check if we should end or route to another agent</span>
builder.add_conditional_edges(
    <span class="hljs-string">"sales_agent"</span>, route_after_agent, [<span class="hljs-string">"sales_agent"</span>, <span class="hljs-string">"support_agent"</span>, END]
)
builder.add_conditional_edges(
    <span class="hljs-string">"support_agent"</span>, route_after_agent, [<span class="hljs-string">"sales_agent"</span>, <span class="hljs-string">"support_agent"</span>, END]
)

graph = builder.<span class="hljs-built_in">compile</span>()
result = graph.invoke(
    {
        <span class="hljs-string">"messages"</span>: [
            {
                <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
                <span class="hljs-string">"content"</span>: <span class="hljs-string">"Hi, I'm having trouble with my account login. Can you help?"</span>,
            }
        ]
    }
)

<span class="hljs-keyword">for</span> msg <span class="hljs-keyword">in</span> result[<span class="hljs-string">"messages"</span>]:
    msg.pretty_print()
</code></pre>
<p>对于大多数任务交接场景，建议使用搭配中间件的单智能体方案—— 这种方式更为简洁。仅当你需要实现定制化智能体时（例如，某个节点本身是包含反思或检索流程的复杂子图），才考虑使用多智能体子图。</p>
<h4 data-id="heading-8">5.2.2 上下文工程</h4>
<p>在子图交接过程中，你可以精准控制智能体之间流转的消息内容。这种精准性对于维持有效的对话历史、避免因上下文冗余而干扰下游智能体至关重要。
交接过程中的上下文处理
在智能体间进行任务交接时，你需要确保对话历史的有效性。大语言模型要求工具调用与其响应内容一一对应，因此在使用Command.PARENT交接至其他智能体时，必须同时传入以下两类消息：
包含工具调用的AI 消息（即触发任务交接的那条消息）
确认任务交接的工具消息（即针对该工具调用生成的人工响应）
若缺少这种一一对应的消息配对，接收方智能体将会获取不完整的对话内容，进而可能产生错误或出现不符合预期的行为。
以下示例基于仅调用了交接工具的场景（无并行工具调用）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">transfer_to_sales</span>(<span class="hljs-params">runtime: ToolRuntime</span>) -&gt; Command:
    <span class="hljs-comment"># Get the AI message that triggered this handoff</span>
    last_ai_message = runtime.state[<span class="hljs-string">"messages"</span>][-<span class="hljs-number">1</span>]

    <span class="hljs-comment"># Create an artificial tool response to complete the pair</span>
    transfer_message = ToolMessage(
        content=<span class="hljs-string">"Transferred to sales agent"</span>,
        tool_call_id=runtime.tool_call_id,
    )

    <span class="hljs-keyword">return</span> Command(
        goto=<span class="hljs-string">"sales_agent"</span>,
        update={
            <span class="hljs-string">"active_agent"</span>: <span class="hljs-string">"sales_agent"</span>,
            <span class="hljs-comment"># Pass only these two messages, not the full subagent history</span>
            <span class="hljs-string">"messages"</span>: [last_ai_message, transfer_message],
        },
        graph=Command.PARENT,
    )
</code></pre>
<p>为什么不传递子智能体的全部消息？虽然你可以在任务交接时附带子智能体的完整对话内容，但这种做法往往会引发诸多问题：接收方智能体可能会被不相关的内部推理内容干扰而陷入混乱，同时还会造成不必要的令牌成本增加。
仅传递任务交接消息对，可以让主图的上下文始终聚焦于高层级的协同调度。如果接收方智能体需要更多上下文信息，建议在工具消息的内容中总结子智能体的工作内容，而非直接传递原始的消息历史。</p>
<p>将控制权交还给用户
当把控制权交还给用户（结束智能体的本轮任务）时，需确保最终发送的消息为一条AI 消息。此举既能维持有效的对话历史，也可向用户界面传递 “智能体已完成当前任务” 的信号。</p>
<h2 data-id="heading-9">六、实现注意事项</h2>
<p>在设计多智能体系统时，需考量以下几点：</p>
<ul>
<li>上下文过滤策略：每个智能体应接收完整的对话历史、经过筛选的内容片段，还是对话摘要？不同智能体因其职能不同，所需的上下文信息也可能存在差异。</li>
<li>工具语义定义：明确交接工具仅用于更新路由状态，还是同时会产生附带影响。例如，transfer_to_sales() 函数是否需要同步创建售后工单，还是应将创建工单作为一项独立操作？</li>
<li>令牌成本优化：平衡上下文完整性与令牌消耗成本。随着对话篇幅不断增加，对话摘要生成与选择性上下文传递的重要性会愈发凸显。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring-AI 结合自定义 mcp server 实现飞书智能机器人]]></title>    <link>https://juejin.cn/post/7589220406319185956</link>    <guid>https://juejin.cn/post/7589220406319185956</guid>    <pubDate>2025-12-30T05:40:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589220406319185956" data-draft-id="7589220406319169572" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring-AI 结合自定义 mcp server 实现飞书智能机器人"/> <meta itemprop="keywords" content="AI编程,MCP,Spring Boot"/> <meta itemprop="datePublished" content="2025-12-30T05:40:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Kings90"/> <meta itemprop="url" content="https://juejin.cn/user/553809590620765"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring-AI 结合自定义 mcp server 实现飞书智能机器人
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/553809590620765/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Kings90
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T05:40:24.000Z" title="Tue Dec 30 2025 05:40:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 简介</h2>
<p>本文主要介绍基于 spring ai 自定义搭建 mcp 服务端和客户端，主要场景是：</p>
<p><code>基于本地的mcp服务让飞书机器人跟场景回答不同的问题</code></p>
<p>实现效果如下</p>
<p><img src="http://openwrite.cn/uploads/15225/58081/6fd0317d-16a2-40ab-aa9b-29668e766924.png" alt="sample.png" loading="lazy"/></p>
<p>最后附了源码链接.整体代码非常简单，容易上手。</p>
<h2 data-id="heading-1">2.概念</h2>
<h3 data-id="heading-2">2.1 什么是 AI MCP？</h3>
<p><strong>MCP（Model Context Protocol）</strong> 是一种 ​<strong>标准化协议</strong>​，用来解决一个长期痛点：</p>
<blockquote>
<p>👉 <strong>如何让 AI“安全、可控、标准化地”调用外部工具 / 系统能力？</strong></p>
</blockquote>
<p>它的核心目标不是“让 AI 更聪明”，而是：</p>
<ul>
<li>让 <strong>AI 能调用真实系统</strong></li>
<li>同时 <strong>避免 AI 乱编、乱连、乱访问</strong></li>
<li>并且 <strong>工具接入方式统一</strong></li>
</ul>
<h3 data-id="heading-3">2.2 MCP 解决了什么问题？</h3>
<h4 data-id="heading-4">1️⃣ 传统 Function Call 的问题</h4>
<p>以 OpenAI Function Calling / Tool Calling 为例：</p>
<ul>
<li>工具定义写死在 Prompt 或代码里</li>
<li>每个 AI 框架一套接口</li>
<li>权限 / 生命周期 / 连接管理全靠业务自己写</li>
<li>工具多了以后 <strong>极难维护</strong></li>
</ul>
<p>👉 在真实系统里会变成：</p>
<ul>
<li>Prompt 很长</li>
<li>Tool 定义重复</li>
<li>不同 AI 模型不可复用</li>
</ul>
<h4 data-id="heading-5">2️⃣ MCP 的解决思路</h4>
<p>MCP 把 ​<strong>工具变成一个标准化的 Server</strong>​：</p>
<pre><code class="hljs language-arduino" lang="arduino">AI Model
   |
   |  MCP 协议
   |
MCP <span class="hljs-built_in">Client</span>  ────── MCP <span class="hljs-built_in">Server</span>
                   ├─ 查数据库
                   ├─ 调内部系统
                   ├─ 查文件
                   ├─ 调 HTTP API
</code></pre>
<p>AI ​<strong>不直接接触工具实现</strong>​，只通过 MCP 协议：</p>
<ul>
<li>发现工具</li>
<li>调用工具</li>
<li>获取结构化结果</li>
</ul>
<h2 data-id="heading-6">3. 工程结构</h2>
<p>主要分为2个模块，<code>mcp-server</code> 和 <code>mcp-client</code>,  mcp-client里面通过 <code>java -jar</code> 的形式运行 mcp 服务端，在 <code>mcp-client</code> 最终结合 AI 以及飞书机器人的集成实现消息的回复.</p>
<p><img src="http://openwrite.cn/uploads/15225/58081/855468de-167f-424d-8f40-dee117ca8293.png" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-7">4. 相关源码介绍</h2>
<h3 data-id="heading-8">4.1 mcp 服务端</h3>
<p>服务端非常简单，例如保留一个天气的服务，只需要在方法上加入<code>org.springframework.ai.tool.annotation.Tool;</code> 注解即可</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> io.kings1990.mcp.mcpserver.enums.WeatherType;
<span class="hljs-keyword">import</span> io.kings1990.mcp.mcpserver.record.WeatherRequest;
<span class="hljs-keyword">import</span> io.kings1990.mcp.mcpserver.record.WeatherResult;
<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword">import</span> org.springframework.ai.tool.annotation.Tool;
<span class="hljs-keyword">import</span> org.springframework.ai.tool.annotation.ToolParam;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;

<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WeatherService</span> {


    <span class="hljs-meta">@Tool(name = "getWeather", description = "查询指定城市的天气")</span>
    <span class="hljs-keyword">public</span> WeatherResult <span class="hljs-title function_">getWeather</span><span class="hljs-params">(<span class="hljs-meta">@ToolParam(description = "请求参数")</span> WeatherRequest req)</span> {
        log.info(<span class="hljs-string">"MCP Tool getWeather called, city={}"</span>, req.city());
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeatherResult</span>(
                req.city(),
                WeatherType.SUNNY,
                <span class="hljs-string">"25°C"</span>,
                <span class="hljs-string">"°C"</span>,
                <span class="hljs-string">"mcp:getWeather"</span>
        );
    }
}
</code></pre>
<h3 data-id="heading-9">4.2 mcp客户端</h3>
<h4 data-id="heading-10">4.2.1让 AI 集成 ToolCallbacks</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AiConfig</span> {

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> ChatClient <span class="hljs-title function_">chatClient</span><span class="hljs-params">(ChatClient.Builder builder, List&lt;McpSyncClient&gt; mcpSyncClients)</span> {
        <span class="hljs-keyword">return</span> builder
                .defaultSystem(<span class="hljs-string">"你是一个AI助手，必须调用工具 kings-spring-ai-mcp-tools 下的方法，如果工具不可用，就明确说明无法调用工具，不要编造。"</span>)
                .defaultToolCallbacks(
                        SyncMcpToolCallbackProvider.builder()
                                .mcpClients(mcpSyncClients)
                                .build()
                )
                .build();
    }
}
</code></pre>
<h4 data-id="heading-11">4.2.2基于飞书机器人的长链接集成，实现消息的自动回复</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> cn.hutool.core.thread.ThreadUtil;
<span class="hljs-keyword">import</span> com.lark.oapi.event.EventDispatcher;
<span class="hljs-keyword">import</span> com.lark.oapi.service.im.ImService;
<span class="hljs-keyword">import</span> com.lark.oapi.service.im.v1.model.P2MessageReceiveV1;
<span class="hljs-keyword">import</span> com.lark.oapi.ws.Client;
<span class="hljs-keyword">import</span> jakarta.annotation.Resource;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.DisposableBean;
<span class="hljs-keyword">import</span> org.springframework.boot.CommandLineRunner;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LarkWsListener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">CommandLineRunner</span>, DisposableBean {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> LarkBotService botService;

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> Client.Builder larkWsBuilder;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">(String... args)</span> {
        <span class="hljs-comment">//verificationToken和 encryptionKey 可选，用于验证和解密事件</span>
        <span class="hljs-type">EventDispatcher</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> EventDispatcher.newBuilder(<span class="hljs-string">""</span>, <span class="hljs-string">""</span>)
                .onP2MessageReceiveV1(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ImService</span>.P2MessageReceiveV1Handler() {
                    <span class="hljs-meta">@Override</span>
                    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handle</span><span class="hljs-params">(P2MessageReceiveV1 event)</span> <span class="hljs-keyword">throws</span> Exception {

                        <span class="hljs-comment">// 1) messageId 用于 reply</span>
                        <span class="hljs-type">String</span> <span class="hljs-variable">messageId</span> <span class="hljs-operator">=</span> event.getEvent().getMessage().getMessageId();

                        <span class="hljs-comment">// 2) content 是 JSON 字符串，需要解析出文本</span>
                        <span class="hljs-type">String</span> <span class="hljs-variable">contentJson</span> <span class="hljs-operator">=</span> event.getEvent().getMessage().getContent();

                        System.err.println(<span class="hljs-string">"收到消息: "</span> + contentJson);

                        <span class="hljs-type">String</span> <span class="hljs-variable">userText</span> <span class="hljs-operator">=</span> LarkMsgParser.extractText(contentJson);

                        ThreadUtil.execAsync(() -&gt; {
                            botService.onUserMessage(messageId, userText);
                        });

                    }
                })
                .build();

        <span class="hljs-comment">// 建议把 appId/appSecret 放配置文件</span>
        <span class="hljs-type">Client</span> <span class="hljs-variable">wsClient</span> <span class="hljs-operator">=</span> larkWsBuilder.eventHandler(handler).build();

        wsClient.start();
    }


    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {

    }
}
</code></pre>
<h4 data-id="heading-12">4.2.3 AI Api-Key 植入</h4>
<p>我这边使用 zhipu ai. 这边可以获取<a href="https://link.juejin.cn?target=https%3A%2F%2Fbigmodel.cn%2Fusercenter%2Fproj-mgmt%2Fapikeys" target="_blank" title="https://bigmodel.cn/usercenter/proj-mgmt/apikeys" ref="nofollow noopener noreferrer">api-key</a>.</p>
<p>加入依赖</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-starter-model-zhipuai<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>并且在配置中配置 api-key</p>
<pre><code class="hljs language-xml" lang="xml">spring:
  ai:
    zhipuai:
      api-key: your_api_key_here
      chat:
        options:
          model: glm-4.6
</code></pre>
<h2 data-id="heading-13">5.启动</h2>
<p>直接运行<code>mcp-client</code> 主程序，查看飞书机器人是否注册成功</p>
<pre><code class="hljs language-arduino" lang="arduino">connected to wss:<span class="hljs-comment">//msg-frontier.feishu.cn/</span>
</code></pre>
<p>启动成功后在飞书应用里输入例如<code>北京</code>，等待机器人回复</p>
<h2 data-id="heading-14">6.源码</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fkings1990%2Fspring-ai-mcp-demo" target="_blank" title="https://github.com/kings1990/spring-ai-mcp-demo" ref="nofollow noopener noreferrer">github 仓库</a>. 可以 star 查看后续更新</p>
<hr/>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fapi-buddy.cn" target="_blank" title="https://api-buddy.cn" ref="nofollow noopener noreferrer">Fast Request</a>是一个类似于 Postman 的 IDEA 插件。它是一个强大的 restful api 工具包插件，可以根据已有的方法帮助您快速生成 url 和 params。 <code>Restful Fast Request = API调试工具 + API管理工具 + API搜索工具</code>。 它有一个漂亮的界面来完成请求、检查服务器响应、存储你的 api 请求和导出 api 请求。插件帮助你在 IDEA 界面内更快更高效得调试你的 API</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[文档解析与问答实战——三步搭建基于TextIn与Coze的智能文档Agent方案]]></title>    <link>https://juejin.cn/post/7589246131585876003</link>    <guid>https://juejin.cn/post/7589246131585876003</guid>    <pubDate>2025-12-30T04:48:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589246131585876003" data-draft-id="7589275237037359139" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="文档解析与问答实战——三步搭建基于TextIn与Coze的智能文档Agent方案"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-30T04:48:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="中杯可乐多加冰"/> <meta itemprop="url" content="https://juejin.cn/user/3435306702347432"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            文档解析与问答实战——三步搭建基于TextIn与Coze的智能文档Agent方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3435306702347432/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    中杯可乐多加冰
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T04:48:51.000Z" title="Tue Dec 30 2025 04:48:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、引言</h2>
<h3 data-id="heading-1">1.1 复杂文档的感知瓶颈</h3>
<p>当前，以大语言模型（LLM）为核心的智能体（Agent）技术，正快速融入法律文书问答、合同条款比对、技术标准解读等企业核心业务流程中。基于<strong>自主任务理解、步骤规划与工具调用能力</strong>，智能体能够可靠执行教育科研辅助、法律信息提取、合同自动比对、标准结构化解析等一系列复杂业务操作，有效提升效率与准确性。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c9d37f8da6584fe78ec8f750917a8137~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767674931&amp;x-signature=4M4vhB0ePoEjRCs5CYMYzf6AQD4%3D" alt="" loading="lazy"/></p>
<p>然而，当Agent真正用于处理上述复杂业务文档时，其效能首先受限于输入知识的质量，而这直接源于文档本身的高度复杂性。此类文档通常具备多重典型特征：语言混合、格式不一，且具有强烈的结构依赖性——无论是严谨的章节编号与条款引用，还是跨页分布的大型表格与多层合并单元格，均构成机器理解与深入处理的根本障碍。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f5cd34cdc3f4c74aa6895fc869e4856~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767674931&amp;x-signature=0WkvfZSn6LTp4mOpMvqlDSC566U%3D" alt="" loading="lazy"/></p>
<p>面对如此复杂的文档，传统的Agent 流程常受限于一个根本性的工程难题，具体表现为以下两个核心痛点：</p>
<p>首先，是<strong>语义边界的模糊</strong>。文档中原本完整的段落或表格，常因跨页、分栏而被解析工具切断。在此情况下，传统的基于固定长度或简单标点的分块策略，往往生成大量语义残缺的文本块，无法恢复其原始逻辑完整性。</p>
<p>其次，是<strong>结构化信息的丢失</strong>。合同、标书等文档中的标题、列表、表格等层级与关系信息，在解析过程中经常被丢弃，后续的分块策略只能依赖字符长度等表面特征，而无法实现基于语义结构的智能切分。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb9a6ccb9d3649e5b33b39be28a2e9e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767674931&amp;x-signature=qP0BF2vJK4MjO6AhhJcRAJ%2B97rE%3D" alt="" loading="lazy"/></p>
<p>正因如此，我们认识到：<strong>有时候一个智能体性能瓶颈，往往并非源于大语言模型的能力上限，而更取决于知识预处理阶段的质量控制</strong>。提升解析与分块的准确性，要提升 Agent 在复杂文档场景下的表现，必须先解决 Agent 的文档感知问题。</p>
<h3 data-id="heading-2">1.2 TextIn文档智能解析引擎</h3>
<p>为突破 RAG 与 Agent 在文档感知层面的工程瓶颈，引入专业的文档智能解析工具成为必然选择。TextIn 正是面向这一核心问题构建的文档智能解析引擎，其目标并非单纯完成 OCR，而是输出“对大模型友好”的高质量结构化语义结果。</p>
<p>在真实业务流程中，TextIn 的解析结果通常会被直接写入企业知识库或向量数据库，作为后续问答、比对、审查任务的基础数据层。其核心价值主要体现在以下三方面：</p>
<ol>
<li><strong>极致的兼容性与多语言支持：</strong> TextIn 提供了业界领先的文档兼容性，其支持 <strong>50+ 种语言</strong>的深度解析和 <strong>20+ 种文件格式</strong>（包括 PDF、Word、Excel、扫描件、图片等），对于复杂的扫描件和版式文件，TextIn 能够进行高精度的版面分析和 OCR 识别，确保知识源头的准确性。</li>
<li><strong>高质量结构化输出：Markdown 与 BBox：</strong> TextIn能够将复杂的文档结构准确地转化为标准的 <strong>Markdown</strong> 格式文本。这种Markdown 格式天然地保留了文档的语义结构，使得后续的分块策略可以从基于长度的简单切分，升级为基于语义结构的智能切分。同时，TextIn 还附带了每个文本块在原始文档中的 BBox（边界框）坐标信息，为实现精确的引用溯源和未来的视觉 RAG 奠定了数据基础。</li>
<li><strong>灵活的 API 接口：</strong> TextIn 提供了 <strong>通用文档解析</strong> 和 <strong>智能文档抽取</strong> 等多种 API 接口，开箱即用。</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97e244fd484f4f33ab0990a023450156~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767674931&amp;x-signature=NriHzDGGtnSOZzdZIsNW69vr5bg%3D" alt="" loading="lazy"/></p>
<p>基于此，本文将深入剖析如何依托 TextIn 这一专业文档解析平台，通过工作流实现 Agent 的实时文档理解能力。</p>
<hr/>
<h2 data-id="heading-3">二、技术实践：基于 TextIn + Coze 的 Agent 方案</h2>
<h3 data-id="heading-4">2.1 架构设计</h3>
<p>本次实践选取的业务场景为<strong>论文分析总结助手</strong>。在这个场景中，文档主要来自上传的各类学术论文和学术报告，既包括排版规范的PDF论文，也包含扫描版或版式复杂的历史文献。用户在上传论文后，通常希望快速理解论文的核心贡献、方法结构与关键结论，并能够围绕具体章节或实验结果进行问答与总结。Agent 生成的结构化摘要、要点总结及对应章节定位信息，可用于辅助论文初筛、评审准备或科研调研过程。</p>
<p>为了快速验证 TextIn 的能力，并构建一个可交互的原型 Agent，我选择了 Coze 平台。Coze 是一个一站式 AI Bot 开发平台，它提供了可视化的工作流编排和插件工具集成能力，非常适合进行 Agent 的敏捷开发和能力验证。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/976650f9aa24435482dbd3eb1d53cfd1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767674931&amp;x-signature=3QuFeAkgMexXBPnvCuATRzCsN9I%3D" alt="" loading="lazy"/></p>
<p>本次的Agent 架构设计整体遵循“感知-推理”的逻辑：Agent 接收到用户上传的文档后，首先调用 TextIn 插件进行感知（文档解析），然后将解析后的高质量结构化文本作为输入，驱动 LLM 进行推理（问答、总结），架构流程概览如下：</p>
<ol>
<li><strong>用户输入</strong>：用户上传待分析的文档（如合同 PDF）并提出问题。</li>
<li><strong>Agent 决策</strong>：Coze Agent 识别到输入是文件，触发 TextIn 插件调用。</li>
<li><strong>感知层（TextIn）</strong> ：TextIn 调用通用文档解析 API，将复杂文档转化为 Markdown 文本。</li>
<li><strong>推理层（LLM）</strong> ：Agent 将 TextIn 返回的 Markdown 文本作为上下文，结合用户问题，调用 LLM 进行推理和生成答案。</li>
</ol>
<h3 data-id="heading-5">2.2 实践步骤与解析节点说明</h3>
<h4 data-id="heading-6">2.2.1 步骤一：编排工作流</h4>
<p>首先进入 Coze 平台，点击进入扣子编程的工作空间，选择资源库，点击右上角创建，创建一个新的工作流</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/214090ca82f24b0c9d524a711d03c385~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767674931&amp;x-signature=HwxACt4aCHnm9TV4P4aDa%2BahYQs%3D" alt="" loading="lazy"/></p>
<p>进入工作流编排页面后，选择开始后面的加号，然后选择添加“插件”</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d654696ce3454a749745d123d7e84d33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767674931&amp;x-signature=CFEqhYNEhr80RWpMS9NJHAeJQsM%3D" alt="" loading="lazy"/></p>
<p>可以看到Coze插件市场中已经集成好了Textin的插件，我们只需要搜索“Textin”就可以看到ParseX通用文档解析、pdf转markdown、Textin OCR等多个插件，这里选择ParseX添加：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a2c7ebde28214f45a973d52eb346b7df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767674931&amp;x-signature=%2Fm%2FIjyG9T2wXeACk09Txml9qfn8%3D" alt="" loading="lazy"/></p>
<p>接下来我们开始编排工作流，首先将工作流的起始组件 Input 类型设置为 File-default，以接收用户上传的文档。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ed796901d8b426c9e608fd00c236764~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767674931&amp;x-signature=2qu9ha%2BJWDzuCb2JpZPwIapI%2F1U%3D" alt="" loading="lazy"/></p>
<p>随后，将 TextIn 插件也就是ParseX组件的输入变量（file）引用到起始组件的 file，确保 Agent 能够将用户上传的文件正确传递给 TextIn。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/14307fe7835943d38a87ebc711fa8973~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767674931&amp;x-signature=2PhGTyG%2BOgHemTj6E9SOiOivYaY%3D" alt="" loading="lazy"/></p>
<p>为了确保 TextIn 服务的安全调用，ParseX组件是需要鉴权的，我们需要在插件配置中填入从 TextIn 官网获取的 x-ti-app-id 和 secret-code 进行鉴权。</p>
<p>这里需要登录Textin官网，前往 “账号与开发者信息” 查看 x-ti-app-id和secret_code，将其复制下来，填入到ParseX组件当中</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c9cc0bb916054928afe91b41614b98e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767674931&amp;x-signature=LR00F%2FMDJStz3y6fNkWNI9uiE1o%3D" alt="" loading="lazy"/></p>
<p>配置成功后如下所示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d86deaeb16574b86adea6aac9a8ee65b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767674931&amp;x-signature=01G12U1qkwWdN%2FsSFfHUr32wgHc%3D" alt="" loading="lazy"/></p>
<p>然后我们就先可以接入一个结束组件，点击试运行，试运行结束，可以看到ParseX插件成功解析了文件并且输出了对应的内容</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05f26b4bdb544937ba53d65efe892053~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767674931&amp;x-signature=1tsE6PtdPhhPg2QdRoyk2z3LiLQ%3D" alt="" loading="lazy"/></p>
<p>在 TextIn 成功解析文件并输出 Markdown 文本后，我们将其作为 LLM 的上下文输入，这是整个实践中最关键的一步。</p>
<p>传统的 Agent 问答，如果直接输入原始 PDF 或者word文件，LLM 必须花费大量的计算资源去推理文本的结构和逻辑关系。<strong>而 TextIn 提供的 Markdown 文本，已经清晰地标注了标题（#）、列表（-）、表格（|）等结构。</strong> 一个复杂的表格在 TextIn 解析后，会以标准的 Markdown 表格形式呈现。Agent 在接收到这样的输入后，可以直接利用其强大的表格推理能力，而无需进行额外的结构重建工作，极大地提升了推理的效率和准确性。</p>
<p>我们将 TextIn 插件的输出 result/markdown 接入到 LLM 组件，并设计系统提示词，指导 Agent 如何利用这份高质量的结构化上下文进行回答。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e42ef72e0af34869984b85f8a0ec0e1a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767674931&amp;x-signature=OonC4%2FU6GOjgXtfxmhEMPvk57HA%3D" alt="" loading="lazy"/></p>
<p>整体的 AgentFlow 工作流如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e09100953fb47fcaf61bebc792bf8d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767674931&amp;x-signature=Dqnp4iqT008NYamwqfXZWUX9EQY%3D" alt="" loading="lazy"/></p>
<p>试运行的效果如下，可以看到，ParseX 能够稳定完成对学术论文 PDF 的解析。在解析效率方面，对于一篇约 15–20 页、包含双栏排版与多处复杂表格的论文TextIn 对单篇论文的平均解析耗时平均约为 <strong>2.8 秒</strong>，其中电子版论文的解析时间集中在 <strong>2–3 秒</strong> 区间，扫描版或版式复杂文档的解析时间约为 <strong>4–6 秒。</strong> 解析输出的 Markdown 文本完整保留了章节层级、公式位置与表格结构，可直接作为 LLM 推理的上下文输入，无需额外人工整理。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21e4304d6e004097a13fbaeba5c43f93~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767674931&amp;x-signature=me3hGCySgxxDsNoMhD49hwEYhEw%3D" alt="" loading="lazy"/></p>
<p>基于这种方案，我这里进一步搭建了一个文件解析问答助手，提示词如下，可供大家学习参考：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 角色</span>
你是一个基于用户提供的文件内容进行问答的助手，能够根据用户上传的{{input}}文件中的信息，准确回答用户提出的问题{{query}}，确保回答内容严格忠实于文件原文。

<span class="hljs-section">## 技能</span>
<span class="hljs-section">### 技能1：文件信息提取</span>
<span class="hljs-bullet">-</span> 接收用户提供的{{input}}文件内容（如文本、文档等），准确理解文件的核心逻辑与关键信息点；
<span class="hljs-bullet">-</span> 识别文件中与用户问题{{query}}直接相关的内容片段、段落或数据，确保信息提取的准确性与完整性。

<span class="hljs-section">### 技能2：问题解析与回答生成</span>
<span class="hljs-bullet">-</span> 精准解读用户问题{{query}}，明确用户的核心诉求或疑问；
<span class="hljs-bullet">-</span> 基于提取的文件信息，用简洁、连贯的语言组织回答，确保回答内容与文件原文完全一致，不添加主观推测或外部信息；
<span class="hljs-bullet">-</span> 若文件中存在多个相关信息点，能够整合逻辑关系形成完整回答；若文件中无对应信息，直接告知用户“根据当前提供的文件内容，未找到相关信息”。

<span class="hljs-section">## 限制</span>
<span class="hljs-bullet">-</span> 回答内容必须严格以用户提供的{{input}}文件内容为依据，不得编造、篡改或补充文件外的信息；
<span class="hljs-bullet">-</span> 若文件内容存在歧义或信息缺失，需如实反馈“文件内容表述不明确，无法准确回答该问题”，不进行模糊猜测或默认补充；
<span class="hljs-bullet">-</span> 回答语言需简洁清晰，避免冗余，确保用户能直接获取文件中与问题相关的核心信息。
</code></pre>
<p>运行效果如下，通过 TextIn 的赋能，我们的 Agent 在处理复杂文档时的性能实现了本质飞跃，有效解决了 Agent 的文档感知瓶颈：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1d49bae5cc64ef5b8a7c4d9faf01f56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767674931&amp;x-signature=TlgOooTf%2FnEuKYpDceEBEhMMbF8%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-7">2.2.2 步骤二：搭建智能体</h4>
<p>在完成工作流后，我们接下来就可以搭建 Agent 智能体了。点击回到扣子主页，点击创建，选择创建智能体。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed44d912726c443f8a67c29746027703~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767674931&amp;x-signature=TMXq5cjvQcXyhf8XoNtjc0cHi1g%3D" alt="" loading="lazy"/></p>
<p>然后点击添加工作流，将刚刚创建好的 TextinDemo 工作流引入进来</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60d732632f804aaeb12e96328c3bf721~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767674931&amp;x-signature=cq80vuO4n9CcAAjPeItInLnoWtw%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/335658275f544d148a8bb9b4eff5f724~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767674931&amp;x-signature=Tg6rPyPa0Aj1RGv787Nkyl5zLN0%3D" alt="" loading="lazy"/></p>
<p>其次编写智能体的人设和回复逻辑，为保证结果可用于论文审查与总结场景，系统提示词明确限制模型仅基于解析后的论文内容进行回答，避免引入外部知识或主观推断，从而提升总结与问答结果的可靠性。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ce09fe221ba480e85ecf1d7fbee6abe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767674931&amp;x-signature=zr4FRHwHCAxxBi6MJqxwxX8fjOs%3D" alt="" loading="lazy"/></p>
<p>这里贴出我设计的人设与回复逻辑，可以参考使用</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 角色</span>
你是一位严谨专业的学术论文解析专家与高效科研内容处理助手，专注于精准解析各类学术论文文档（包括电子版、扫描版及版式复杂的文献），通过调用TextinDemo工作流完成文档预处理，为科研工作者提供高效的论文初筛、评审与深度调研支持，输出清晰结构化的学术分析内容。

<span class="hljs-section">## 技能</span>
<span class="hljs-section">### 技能 1: 文档预处理与核心信息提取</span>
<span class="hljs-bullet">1.</span> 当用户学术论文后，自动调用TextinDemo工作流进行预处理：  
<span class="hljs-bullet">   -</span> 对论文执行版面识别，确保文本内容完整；  
<span class="hljs-bullet">   -</span> 解析版式复杂的文档（如多栏布局、图表混排），提取结构化文本与元数据；  
<span class="hljs-bullet">   -</span> 完成预处理后，生成基础信息概览。  

<span class="hljs-section">### 技能 2: 精准问答与要点定位  </span>
<span class="hljs-bullet">1.</span> 当用户提出「章节内容/实验结果/概念细节」等问题时，优先定位论文对应部分；  
<span class="hljs-bullet">2.</span> 引用论文原文关键句或数据，确保回答<span class="hljs-strong">**精准且可追溯**</span>。  
===回复示例===  
<span class="hljs-bullet">   -</span> ❓ 用户提问：「第4章的实验步骤3是什么？」  
<span class="hljs-bullet">   -</span> 📌 <span class="hljs-strong">**章节定位**</span>：4.2.3节「实验流程」  
<span class="hljs-bullet">   -</span> 💡 <span class="hljs-strong">**回答内容**</span>：实验步骤3为「[原文精准描述，如“采用XX算法对样本集进行三次迭代训练”]」  
===示例结束===

<span class="hljs-section">## 限制</span>
<span class="hljs-bullet">-</span> <span class="hljs-strong">**工具调用**</span>：必须通过TextinDemo工作流完成PDF预处理，不可跳过该环节直接分析内容；  
<span class="hljs-bullet">-</span> <span class="hljs-strong">**输出格式**</span>：严格使用Markdown结构化排版（标题层级、列表符号、代码块），核心信息需分点明确；
</code></pre>
<h4 data-id="heading-8">2.2.3 步骤三：测试与优化</h4>
<p>编排好工作流并搭建好智能体后，就完成了一个可交互的原型 Agent。我们可以进行最终测试，将文档塞给模型使用，可以看到其能够精准提取文档的表格内容。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bef0fb3493674fca9dd80d5695f18c4b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767674931&amp;x-signature=KujEJ3TxzDggW4%2F2euf9VjgL32U%3D" alt="" loading="lazy"/></p>
<p>对于复杂度较高的表格（如多层表头、合并单元格或包含大量数值关系的财务表格），智能体能够<strong>精准处理跨页和嵌套表格的逻辑关系</strong>，<strong>准确识别其Markdown结构，并执行跨行列的数据关联与逻辑推理</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4535da72071445cba6786637e50250d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767674931&amp;x-signature=WD3WeSF20vC003rrWPtaMU7btD8%3D" alt="" loading="lazy"/></p>
<p>Agent可依据ParseX插件输出的清晰的结构化表格数据，自动定位相关字段并进行计算与归纳，无需人工预先指明数据位置。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c070215e484b48669edab1e57888c26c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767674931&amp;x-signature=keoH9LYDQ835BUnNHy1QZReH7M0%3D" alt="" loading="lazy"/></p>
<p>对于版式复杂（混合单页、双栏排版）的扫描文档，智能体也能够<strong>完整还原其阅读顺序与语义连贯性，避免文本错乱或信息割裂</strong>。得益于TextIn强大的版面分析能力，它能将视觉上的分栏内容，在Markdown中按逻辑顺序重新组织，使得Agent在处理依赖版面布局的问题时，仍能给出精准答案。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ba124ccd2884638a45551d08f40d7fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767674931&amp;x-signature=wMf%2FIweHRu6gUfq%2B8RuDifGBGvk%3D" alt="" loading="lazy"/></p>
<p>在人工成本方面，引入 TextIn 后，论文解析流程中对人工预处理的依赖显著降低。以论文初筛为例，原本需要人工完成的版式检查、章节拆分与表格整理工作，单篇论文的人工准备时间由原先的约 <strong>15–20 分钟</strong> 降低至 <strong>3–5 分钟</strong>，人工投入成本下降约 <strong>70%</strong> 。</p>
<p>测试表明，通过将TextIn的高质量解析输出与LLM的推理能力深度结合，智能体克服了传统RAG在非结构化文档处理中的核心短板。它不仅能够“看到”文档内容，更能“理解”其内在结构与逻辑关系，使复杂文档的自动分析与问答变得真正可行、可靠。</p>
<h2 data-id="heading-9">三、总结与展望</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b35c9de14ce4a55b53c2a39ae3b0073~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767674931&amp;x-signature=wT%2FTxqc8yLOkEw57Dt8aCllIXZE%3D" alt="" loading="lazy"/></p>
<p>TextIn 的引入，使得 Agent 的构建不再受限于原始文档的格式和语言。它通过提供高质量的 Markdown 文本，将 Agent 的知识输入从无序的字符流升级为结构化的语义块，从而将 Agent 的推理性能提升到一个新的高度。TextIn 不仅仅是一个文档解析工具，它在 Agent 的知识摄入管道中扮演了“知识结构化引擎”的关键角色，其在流程中：<strong>解决 Agent 的感知边界，实现结构化上下文，并奠定了溯源基础</strong>，增强了 Agent 答案的可信度和质量。</p>
<p>总的来说，在 Agent 时代，文档智能的竞争焦点已从单纯的 OCR 识别，转向了文档结构的深度理解和语义重建。TextIn 凭借其在多语言、多格式上的技术壁垒，为企业级 Agent 应用构建了坚实的基础设施。</p>
<p>未来，随着 Agent 技术的进一步发展，TextIn 提供的结构化、高精度文档解析能力将成为 Agent 进化中不可或缺的一环。它将持续支持文档解析、企业知识库建设、智能文档抽取等领域的智能化进程，成为 Agent 提升效率、实现复杂任务的关键基石。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Future.get () 的潜在陷阱]]></title>    <link>https://juejin.cn/post/7589386961648074787</link>    <guid>https://juejin.cn/post/7589386961648074787</guid>    <pubDate>2025-12-30T05:47:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589386961648074787" data-draft-id="7589246131586056227" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Future.get () 的潜在陷阱"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-12-30T05:47:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="uup"/> <meta itemprop="url" content="https://juejin.cn/user/4378706456356627"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Future.get () 的潜在陷阱
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4378706456356627/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    uup
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T05:47:59.000Z" title="Tue Dec 30 2025 05:47:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、Bug 场景</h2>
<p>在一个基于 Java 的多线程应用程序中，使用 <code>Future</code> 来异步执行一些耗时任务，例如数据的远程获取或者复杂的计算。开发人员期望通过 <code>Future.get()</code> 方法获取异步任务的执行结果，但在实际运行过程中，发现程序有时会出现长时间的阻塞，甚至导致整个应用程序无响应，严重影响了系统的性能和用户体验。</p>
<h2 data-id="heading-1">二、代码示例</h2>
<h3 data-id="heading-2">异步任务类</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.concurrent.Callable;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncTask</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Callable</span>&lt;String&gt; {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">call</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 模拟一个耗时操作，比如网络请求或复杂计算</span>
        Thread.sleep(<span class="hljs-number">5000</span>); 
        <span class="hljs-keyword">return</span> <span class="hljs-string">"任务执行完成"</span>;
    }
}
</code></pre>
<h3 data-id="heading-3">任务执行类（有缺陷）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.concurrent.*;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FutureGetBugExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executorService</span> <span class="hljs-operator">=</span> Executors.newSingleThreadExecutor();
        Future&lt;String&gt; future = executorService.submit(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AsyncTask</span>());

        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> future.get(); 
            System.out.println(<span class="hljs-string">"任务结果: "</span> + result);
        } <span class="hljs-keyword">catch</span> (InterruptedException | ExecutionException e) {
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            executorService.shutdown();
        }
    }
}
</code></pre>
<h2 data-id="heading-4">三、问题描述</h2>
<ol>
<li><strong>预期行为</strong>：<code>future.get()</code> 方法应该在异步任务完成后，及时返回任务的执行结果，程序能够顺利输出任务结果并正常结束。</li>
<li><strong>实际行为</strong>：如果异步任务执行时间过长，<code>future.get()</code> 方法会一直阻塞当前线程，直到任务完成。在一些极端情况下，例如异步任务出现死循环或者资源耗尽导致无法完成，<code>future.get()</code> 会使当前线程永远阻塞，进而导致整个应用程序无响应。此外，如果在获取结果之前主线程被中断，<code>future.get()</code> 方法抛出的 <code>InterruptedException</code> 可能没有被正确处理，导致程序异常终止。</li>
</ol>
<h2 data-id="heading-5">四、解决方案</h2>
<ol>
<li><strong>设置超时时间</strong>：为 <code>future.get()</code> 方法设置一个合理的超时时间，避免无限期阻塞。</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.concurrent.*;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FutureGetBugExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executorService</span> <span class="hljs-operator">=</span> Executors.newSingleThreadExecutor();
        Future&lt;String&gt; future = executorService.submit(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AsyncTask</span>());

        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> future.get(<span class="hljs-number">2</span>, TimeUnit.SECONDS); 
            System.out.println(<span class="hljs-string">"任务结果: "</span> + result);
        } <span class="hljs-keyword">catch</span> (InterruptedException | ExecutionException e) {
            e.printStackTrace();
        } <span class="hljs-keyword">catch</span> (TimeoutException e) {
            System.out.println(<span class="hljs-string">"任务执行超时"</span>);
        } <span class="hljs-keyword">finally</span> {
            executorService.shutdown();
        }
    }
}
</code></pre>
<ol start="2">
<li><strong>在单独线程处理 <code>Future</code></strong>：将获取 <code>Future</code> 结果的操作放在一个单独的线程中，这样即使 <code>future.get()</code> 阻塞，也不会影响主线程的正常运行。</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.concurrent.*;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FutureGetBugExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executorService</span> <span class="hljs-operator">=</span> Executors.newSingleThreadExecutor();
        Future&lt;String&gt; future = executorService.submit(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AsyncTask</span>());

        <span class="hljs-type">Thread</span> <span class="hljs-variable">resultThread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> future.get();
                System.out.println(<span class="hljs-string">"任务结果: "</span> + result);
            } <span class="hljs-keyword">catch</span> (InterruptedException | ExecutionException e) {
                e.printStackTrace();
            }
        });

        resultThread.start();

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 主线程可以继续执行其他任务</span>
            Thread.sleep(<span class="hljs-number">1000</span>); 
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            executorService.shutdown();
        }
    }
}
</code></pre>
<ol start="3">
<li><strong>正确处理中断异常</strong>：在获取 <code>Future</code> 结果时，正确处理 <code>InterruptedException</code>，确保在主线程被中断时，程序能够做出合理的响应。</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.concurrent.*;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FutureGetBugExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executorService</span> <span class="hljs-operator">=</span> Executors.newSingleThreadExecutor();
        Future&lt;String&gt; future = executorService.submit(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AsyncTask</span>());

        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> future.get();
            System.out.println(<span class="hljs-string">"任务结果: "</span> + result);
        } <span class="hljs-keyword">catch</span> (ExecutionException e) {
            e.printStackTrace();
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            <span class="hljs-comment">// 恢复中断状态</span>
            Thread.currentThread().interrupt(); 
            System.out.println(<span class="hljs-string">"主线程被中断"</span>);
        } <span class="hljs-keyword">finally</span> {
            executorService.shutdown();
        }
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一个只会 MVC 的 java 小白对 DDD 的理解]]></title>    <link>https://juejin.cn/post/7589207474134695986</link>    <guid>https://juejin.cn/post/7589207474134695986</guid>    <pubDate>2025-12-30T05:49:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589207474134695986" data-draft-id="7589227883261952046" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一个只会 MVC 的 java 小白对 DDD 的理解"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-30T05:49:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="学java的可达鸭"/> <meta itemprop="url" content="https://juejin.cn/user/657971657321972"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一个只会 MVC 的 java 小白对 DDD 的理解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/657971657321972/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    学java的可达鸭
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T05:49:05.000Z" title="Tue Dec 30 2025 05:49:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.7;font-weight:400;font-size:16px;overflow-x:hidden;color:#2c3e50;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;font-weight:600;margin-top:35px;margin-bottom:8px;padding-bottom:5px}.markdown-body h1 :before,.markdown-body h2 :before,.markdown-body h3 :before,.markdown-body h4 :before,.markdown-body h5 :before,.markdown-body h6 :before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{padding-bottom:8px;margin-top:50px;font-size:24px;border-bottom:1px solid #eaecef}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #eaecef;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;font-weight:400;background-color:rgba(27,31,35,.05);color:#476582;margin:0;font-size:.85em;border-radius:3px;font-size:.87em;padding:.165em .5em}.markdown-body code,.markdown-body pre{font-family:source-code-pro,Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.6;padding:20px 24px;background-color:#282c34;border-radius:6px}.markdown-body pre&gt;code{font-size:14px;padding:0;margin:0;word-break:normal;display:block;overflow-x:auto;color:#fff}.markdown-body a{text-decoration:none;color:#3eaf7c;font-weight:500}.markdown-body a:active,.markdown-body a:hover{color:#42b983;border-bottom:1px solid #42b983}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;margin:16px 0;border-collapse:collapse}.markdown-body thead{background:#f6f6f6;background:#3eaf7c;color:#000;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f6f8fa}.markdown-body td,.markdown-body th{border:1px solid #dfe2e5;padding:10px 16px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{font-size:14px;padding:6px 23px;margin:22px 0;border-left:6px solid #42b983;background-color:#f3f5f7;font-weight:400}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body p,.markdown-body ul{line-height:1.7}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="base16/tomorrow-night">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">四层架构</h2>
<blockquote>
<p>而不是 MVC 的三层</p>
</blockquote>
<p>领域驱动设计（DDD）中，并没有一个所谓的“唯一标准”架构，但行业内公认的<strong>经典架构</strong>是 Eric Evans 在原著中提出的 <strong>四层分层架构</strong>。</p>






























<table><thead><tr><th><strong>层级名称</strong></th><th><strong>职责描述</strong></th><th><strong>核心组件</strong></th></tr></thead><tbody><tr><td><strong>用户界面层 (Interfaces)</strong></td><td>负责与外部交互。处理 HTTP 请求、解析 JSON、返回数据给前端。</td><td>Controller, WebSocket, DTO 映射器</td></tr><tr><td><strong>应用层 (Application)</strong></td><td><strong>不含业务逻辑</strong>。负责编排业务流程（比如先查数据库，再调接口，最后发消息）。</td><td>Application Services, Command/Query</td></tr><tr><td><strong>领域层 (Domain)</strong></td><td><strong>系统的灵魂</strong>。纯粹的业务逻辑。不依赖数据库、不依赖第三方。</td><td>Entity, Value Object, Aggregate, Domain Service</td></tr><tr><td><strong>基础设施层 (Infrastructure)</strong></td><td>提供技术支撑。数据库持久化、缓存、发送邮件、配置管理等。</td><td>Repository 实现, MQ 适配, DB Config</td></tr></tbody></table>
<h2 data-id="heading-1">现代变体：六边形架构 (Hexagonal Architecture)</h2>
<blockquote>
<p>不要和上面的严格分成两种架构，要把他们融合在一起，他们都是 DDD</p>
</blockquote>
<p>在实际开发中，为了让<strong>领域层</strong>彻底独立，现在更多公司采用<strong>依赖倒置</strong>的模型。（我会单独画一篇文章去理解<strong>依赖倒置</strong>）</p>
<ul>
<li><strong>核心理念：</strong> 领域层在中间，所有的外部系统（数据库、前端、第三方 API）都叫“<strong>适配器</strong>”。</li>
<li><strong>关键点：</strong> 领域层定义<strong>接口（Ports）</strong> ，基础设施层去<strong>实现（Adapters）</strong> 。</li>
<li><strong>优势：</strong> 你的业务逻辑不依赖于你是用 MySQL 还是 Oracle，也不在乎你是用 Spring 还是 Micronaut。</li>
</ul>
<h2 data-id="heading-2">一个标准的工程目录结构 (Java 示例)</h2>
<p>看一个<strong>目录结构</strong>就懂了，也有可能是<strong>模块结构</strong></p>
<pre><code class="hljs language-Plaintext" lang="Plaintext">com.company.project
├── interfaces (或 user)
│   ├── controller       // 接口入库
│   └── dto              // 返回给前端的 DTO
├── application
│   └── service          // 应用服务，负责调用领域层
├── domain
│   ├── model            // 聚合、实体、值对象
│   ├── service          // 领域服务（跨实体的逻辑）
│   └── repository       // 仓储接口 (注意：这里只有 interface)
└── infrastructure
    ├── repository       // 数据库实现 (MyBatis/JPA 实现类)
    ├── config           // 配置类
    └── external         // 调用其他微服务的 Feign 客户端
</code></pre>
<h2 data-id="heading-3">我认为的 DDD 的核心要义</h2>
<ul>
<li>
<p><strong>不要在应用层写业务逻辑：</strong> 应用层应该很薄，它只是个“指挥官”，具体的判断逻辑（比如：余额够不够）必须在领域层。</p>
</li>
<li>
<p><strong>不要在领域层引用框架类：</strong> 尽量让 <code>domain</code> 文件夹里只有纯粹的 Java 代码，不要出现 <code>HttpServletRequest</code> 这种东西。</p>
</li>
<li>
<p><strong>资源库 (Repository) 的定义：</strong> <em><strong>接口定义在 <code>domain</code>，具体实现在 <code>infrastructure</code></strong></em>。</p>
</li>
</ul>
<h2 data-id="heading-4">依赖倒置</h2>
<p><strong>结论：</strong> 查询数据库的<strong>动作</strong>（执行 SQL、调用驱动）一定不在 Domain 层，但查询数据库的<strong>契约（接口）</strong> 必须留在 Domain 层。</p>
<p>具体应该怎么放，取决于你的查询<strong>目的</strong>。我们需要区分两种场景：</p>
<hr/>
<h4 data-id="heading-5">1. 为了“执行业务逻辑”而查询 (Repository)</h4>
<p>如果你需要查询数据来判断业务规则（例如：下单前查一下用户余额、查一下库存），这种情况遵循 <strong>“依赖倒置原则”</strong> 。</p>
<ul>
<li><strong>Domain 层：</strong> 定义一个接口（Repository Interface）。它表达的是业务意图：“我需要一个能根据 ID 获取聚合根的能力”。</li>
<li><strong>Infrastructure 层：</strong> 实现这个接口。这里才真正写 MyBatis、JPA 或 SQL 语句。</li>
<li><strong>Application 层：</strong> 负责调用这个接口。</li>
</ul>
<p><strong>代码流转示意：</strong></p>
<ol>
<li><strong>Application 层</strong> 调用 <code>domainRepository.findById(id)</code>。</li>
<li><strong>Domain 层</strong> 拿到返回的实体（Entity），并在实体上执行业务方法（如 <code>order.validate()</code>）。</li>
<li><strong>Application 层</strong> 根据结果决定是否提交事务。</li>
</ol>
<hr/>
<h4 data-id="heading-6">2. 为了“页面展示”而查询 (CQRS)</h4>
<p>如果你的查询仅仅是为了在 UI 上列表显示，<strong>不涉及任何业务逻辑</strong>（即：不需要判断，直接展示），那么可以绕过 Domain 层。</p>
<ul>
<li><strong>做法：</strong> 在 <strong>Application 层</strong>（或者专门的 Query 层）直接调用 Infrastructure 层的查询服务，返回 DTO 即可。</li>
<li><strong>原因：</strong> 领域模型（Domain Model）通常很重且复杂。如果只是为了前端展示一个表格，强行通过 Domain 层包装成实体再转成 DTO，性能差且链路冗余。</li>
</ul>























<table><thead><tr><th><strong>查询类型</strong></th><th><strong>逻辑归属</strong></th><th><strong>实际查询位置</strong></th><th><strong>最终返回对象</strong></th></tr></thead><tbody><tr><td><strong>业务逻辑查询</strong></td><td>Domain 定义接口</td><td>Infrastructure 实现</td><td><strong>Entity / Aggregate</strong> (实体)</td></tr><tr><td><strong>页面展示查询</strong></td><td>Application / Query 层</td><td>Infrastructure 直接实现</td><td><strong>DTO</strong> (纯数据对象)</td></tr></tbody></table>
<h2 data-id="heading-7">具体实现</h2>
<p>在标准的 DDD 实践中，我们会利用 <strong>依赖倒置原则 (DIP)</strong> 。即 Domain 层不依赖具体的数据库技术，而是定义“我需要什么”，由 Infrastructure 层去实现“怎么拿数据”。</p>
<p>以下是基于 Spring Boot 的标准代码结构示例：</p>
<h4 data-id="heading-8">1. 目录结构预览</h4>
<p>在 IDEA 中，你的包结构看起来应该是这样的：</p>
<pre><code class="hljs language-Plaintext" lang="Plaintext">src/main/java/com/example/demo
├── domain
│   ├── model
│   │   └── User.java           // 聚合根 (Entity)
│   └── repository
│       └── UserRepository.java // 接口定义 (只含业务契约)
├── infrastructure
│   └── persistence
│       ├── UserMapper.java     // MyBatis/JPA 的具体实现
│       └── UserRepositoryImpl.java // 仓储实现类
└── application
    └── UserService.java        // 应用服务
</code></pre>
<h4 data-id="heading-9">2. 代码实现</h4>
<h5 data-id="heading-10">第一步：Domain 层 - 定义接口</h5>
<p>这里不包含任何 Spring Data 或 MyBatis 的注解，它是纯粹的业务契约。</p>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-comment">// domain.repository.UserRepository</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserRepository</span> {
    <span class="hljs-comment">// 根据 ID 获取用户，返回的是领域模型（Entity）</span>
    User <span class="hljs-title function_">findById</span><span class="hljs-params">(Long id)</span>;
    
    <span class="hljs-comment">// 保存用户</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">(User user)</span>;
}
</code></pre>
<h5 data-id="heading-11">第二步：Infrastructure 层 - 真正实现</h5>
<p>这里处理技术细节（如 SQL、缓存等）。我们通常会注入底层的 Mapper 或 Spring Data JPA。</p>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-comment">// infrastructure.persistence.UserRepositoryImpl</span>
<span class="hljs-meta">@Repository</span> <span class="hljs-comment">// 只有实现类才打上 Spring 的持久化注解</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserRepositoryImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserRepository</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserMapper userMapper; <span class="hljs-comment">// 假设使用 MyBatis</span>

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">findById</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-comment">// 1. 调用底层的数据库操作（返回的是数据库实体 PO）</span>
        <span class="hljs-type">UserPO</span> <span class="hljs-variable">userPO</span> <span class="hljs-operator">=</span> userMapper.selectById(id);
        
        <span class="hljs-comment">// 2. 将数据对象 (PO) 转换为领域对象 (Entity)</span>
        <span class="hljs-comment">// 这是为了保证 Domain 层的纯净，不被数据库字段定义污染</span>
        <span class="hljs-keyword">return</span> UserConverter.toEntity(userPO);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">(User user)</span> {
        <span class="hljs-type">UserPO</span> <span class="hljs-variable">po</span> <span class="hljs-operator">=</span> UserConverter.toPO(user);
        userMapper.insertOrUpdate(po);
    }
}
</code></pre>
<h5 data-id="heading-12">第三步：Application 层 - 编排调用</h5>
<p>应用服务只负责“指挥”，它并不知道数据是怎么存的。</p>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-comment">// application.UserService</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserRepository userRepository; <span class="hljs-comment">// 注入接口，解耦！</span>

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">changeUserEmail</span><span class="hljs-params">(Long id, String newEmail)</span> {
        <span class="hljs-comment">// 1. 通过仓储加载聚合根</span>
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userRepository.findById(id);
        
        <span class="hljs-comment">// 2. 执行领域逻辑</span>
        user.updateEmail(newEmail);
        
        <span class="hljs-comment">// 3. 保存回仓储</span>
        userRepository.save(user);
    }
}
</code></pre>
<hr/>
<h4 data-id="heading-13">3. 为什么一定要这么写？（深度理解）</h4>
<ol>
<li><strong>屏蔽技术细节</strong>：如果哪天你要把数据存到 Redis 或者远程 API，你只需要在 <code>infrastructure</code> 层写一个新的实现类，<code>domain</code> 层和 <code>application</code> 层的一行代码都不用动。</li>
<li><strong>保护业务逻辑</strong>：<code>User</code> 实体是一个具有业务行为的对象（比如有 <code>changePassword()</code> 方法），而数据库对应的 <code>UserPO</code> 只是一个简单的字段容器。通过转换，防止数据库的字段设计（如 <code>is_deleted</code>）渗透到业务逻辑中。</li>
<li><strong>方便单元测试</strong>：在测试 <code>UserService</code> 时，你可以非常轻松地 Mock 掉 <code>UserRepository</code> 接口，而不需要启动真正的数据库。</li>
</ol>
<h4 data-id="heading-14">核心差异点：PO vs Entity</h4>
<ul>
<li><strong>PO (Persistent Object)</strong> : 对应数据库表结构，属性全公开（Getter/Setter）。UserPO.java</li>
<li><strong>Entity (Domain Model)</strong> : 对应业务模型，属性通常私有，通过方法暴露业务动作。User.java</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入 Apache Dubbo 架构：解读一个开源高性能 RPC 框架的设计哲学与核心源码]]></title>    <link>https://juejin.cn/post/7589167252723433522</link>    <guid>https://juejin.cn/post/7589167252723433522</guid>    <pubDate>2025-12-30T05:14:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589167252723433522" data-draft-id="7589194558288445478" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入 Apache Dubbo 架构：解读一个开源高性能 RPC 框架的设计哲学与核心源码"/> <meta itemprop="keywords" content="微服务,分布式"/> <meta itemprop="datePublished" content="2025-12-30T05:14:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大厂技术总监下海"/> <meta itemprop="url" content="https://juejin.cn/user/4091714106833577"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入 Apache Dubbo 架构：解读一个开源高性能 RPC 框架的设计哲学与核心源码
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4091714106833577/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大厂技术总监下海
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T05:14:46.000Z" title="Tue Dec 30 2025 05:14:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Apache Dubbo 深度技术架构解析</h2>
<h3 data-id="heading-1">1. 整体介绍</h3>
<h4 data-id="heading-2">1.1 项目概况与现状</h4>
<p>Apache Dubbo 是一个由 Apache 软件基金会托管的开源高性能 RPC（远程过程调用）与微服务框架。项目托管于 GitHub，地址为 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fapache%2Fdubbo%25E3%2580%2582%25E6%2588%25AA%25E8%2587%25B3%25E5%2588%2586%25E6%259E%2590%25E6%2597%25B6%25EF%25BC%258C%25E5%2585%25B6" target="_blank" title="https://github.com/apache/dubbo%E3%80%82%E6%88%AA%E8%87%B3%E5%88%86%E6%9E%90%E6%97%B6%EF%BC%8C%E5%85%B6" ref="nofollow noopener noreferrer">github.com/apache/dubb…</a> GitHub 统计数据（Star、Fork 数）反映了其在开源社区的广泛采纳度和活跃度，是构建分布式系统，特别是微服务架构的主流技术选型之一。</p>
<h4 data-id="heading-3">1.2 核心功能与架构</h4>
<p>Dubbo 的核心设计围绕服务治理展开，采用经典的“消费者-提供者”模型，并通过注册中心实现解耦。其架构简化视图如下：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    subgraph "消费者侧 Consumer"
        C[Consumer Application]
    end
    subgraph "提供者侧 Provider"
        P[Provider Application]
    end
    subgraph "治理层 Governance"
        R[(Registry&lt;br/&gt;e.g., Nacos, ZK)]
        M[Monitor]
        Config[Config Center]
    end
    C -- 订阅/发现 --&gt; R
    P -- 注册 --&gt; R
    C -- RPC调用 --&gt; P
    C &amp; P -- 上报指标 --&gt; M
    R &amp; Config -- 推送配置 --&gt; C &amp; P
</code></pre>
<p>其主要功能模块包括：</p>
<ul>
<li><strong>通信协议</strong>：支持 Triple（gRPC 兼容）、Dubbo2、REST 等。</li>
<li><strong>服务注册与发现</strong>：集成多种注册中心（Nacos、Zookeeper 等）。</li>
<li><strong>流量治理</strong>：负载均衡、路由、限流、熔断、降级。</li>
<li><strong>可观测性</strong>：指标（Metrics）、追踪（Tracing）、日志。</li>
<li><strong>配置管理</strong>：动态配置更新。</li>
<li><strong>扩展机制</strong>：基于 SPI 的高度可扩展架构。</li>
</ul>
<h4 data-id="heading-4">1.3 面临问题与目标场景</h4>
<p>Dubbo 主要解决企业级应用在向分布式、微服务架构演进过程中遇到的典型问题：</p>
<ol>
<li><strong>服务间通信复杂度</strong>：直接 socket 通信或简单的 HTTP 客户端难以处理连接管理、超时、重试、序列化等，代码侵入性强且易错。</li>
<li><strong>服务动态治理缺失</strong>：服务实例扩缩容后，调用方无法自动感知，缺乏动态路由、负载均衡和流量保护能力。</li>
<li><strong>运维可观测性差</strong>：服务间调用链路过长，问题定位困难，缺乏系统性的监控指标。</li>
<li><strong>异构系统集成难</strong>：不同语言开发的服务之间需要统一的通信协议和治理标准。</li>
</ol>
<p><strong>对应人群与场景</strong>：适用于中大型互联网企业、金融机构等需要构建高可用、可扩展、易维护的分布式服务化体系的技术团队。典型场景包括电商系统、支付清算、用户中心等核心业务的服务化拆分。</p>
<h4 data-id="heading-5">1.4 解决方案与演进优势</h4>
<p><strong>传统方式</strong>：早期常基于 HTTP+JSON/RESTful API 或自行封装 TCP 协议进行服务间调用，配合静态配置或简单的服务发现组件（如 Ribbon + Eureka）。治理功能（如限流）需在每个服务中重复实现。</p>
<p><strong>Dubbo 新方式</strong>：</p>
<ol>
<li><strong>透明化 RPC</strong>：提供像调用本地方法一样的远程调用体验，框架屏蔽底层网络通信细节。</li>
<li><strong>中心化治理</strong>：将流量控制、服务发现等能力抽象为独立的中心化组件（注册中心、配置中心），并通过统一控制台（dubbo-admin）进行管理，规则动态生效。</li>
<li><strong>生态集成</strong>：与 Spring/Spring Boot 深度集成，提供 Starter，降低使用门槛；支持多协议、多注册中心，具备良好的生态兼容性。</li>
</ol>
<p><strong>核心优势</strong>：将分布式服务的<strong>通信</strong>、<strong>治理</strong>和<strong>观测</strong>三大关注点从业务逻辑中彻底解耦，通过专业化的中间件提供标准化、平台化的解决方案，提升了开发效率和系统可靠性。</p>
<h4 data-id="heading-6">1.5 商业价值逻辑估算</h4>
<p>商业价值可从“成本节约”和“效益提升”两个维度进行逻辑推演：</p>
<ul>
<li><strong>成本节约</strong>：
<ul>
<li><strong>开发成本</strong>：一个中等规模（50+微服务）的系统，若自研具备同等治理能力的 RPC 框架，至少需要 3-5 名高级工程师 6-12 个月的持续投入。按市场人力成本估算，直接研发成本可高达数百万元。采用 Dubbo 可将此成本降至近乎为零（仅学习与集成成本）。</li>
<li><strong>维护成本</strong>：自研框架的长期维护、升级、Bug 修复成本高昂。Dubbo 由开源社区和 Apache 基金会支撑，维护成本被分摊。</li>
</ul>
</li>
<li><strong>效益提升</strong>：
<ul>
<li><strong>稳定性收益</strong>：内置的熔断、限流、集群容错等机制能有效防止局部故障扩散，降低系统级联故障风险，直接关联业务连续性和收入保障。</li>
<li><strong>运维效率</strong>：可视化的控制台和完善的可观测性工具链，能大幅缩短故障平均恢复时间（MTTR）。</li>
<li><strong>标准化收益</strong>：统一技术栈，降低团队间协作和人员流动带来的知识传递成本。</li>
</ul>
</li>
</ul>
<p><strong>估算逻辑</strong>：价值 ≈ (自研同等能力框架的人力与时间成本 + 避免的系统宕机潜在损失) - (采用 Dubbo 的集成、学习与云资源成本)。对于大多数企业，此差值通常为正且显著。</p>
<h3 data-id="heading-7">2. 详细功能拆解</h3>
<p>从产品与技术结合视角，Dubbo 的核心功能可拆解为以下层次：</p>








































<table><thead><tr><th align="left">功能层级</th><th align="left">产品视角</th><th align="left">技术视角（核心设计）</th></tr></thead><tbody><tr><td align="left"><strong>接入层</strong></td><td align="left">快速启动，开箱即用</td><td align="left">Spring Boot Starter 自动装配；<code>@DubboService</code> / <code>@DubboReference</code> 注解驱动编程模型。</td></tr><tr><td align="left"><strong>通信层</strong></td><td align="left">支持多种调用方式，兼容异构系统</td><td align="left">协议扩展 SPI (<code>Protocol</code>)；序列化扩展 SPI (<code>Serialization</code>)；支持 Triple (基于 HTTP/2+gRPC)、Dubbo2 等协议。</td></tr><tr><td align="left"><strong>治理层</strong></td><td align="left">服务可管可控，规则动态生效</td><td align="left">路由链 (<code>Router</code>)、负载均衡 (<code>LoadBalance</code>)、集群容错 (<code>ClusterInvoker</code>)、过滤器链 (<code>Filter</code>) 组成的调用流程；规则通过配置中心动态推送。</td></tr><tr><td align="left"><strong>核心层</strong></td><td align="left">服务注册与发现，调用透明代理</td><td align="left">注册中心扩展 SPI (<code>RegistryFactory</code>)；代理工厂 (<code>ProxyFactory</code>) 生成 Consumer 存根和 Provider 调用器；Invoker 为核心调用抽象。</td></tr><tr><td align="left"><strong>观测层</strong></td><td align="left">运行状态可视化，问题可追溯</td><td align="left">Metrics SPI 收集指标；Tracing SPI 集成链路追踪；指标数据上报至监控中心。</td></tr><tr><td align="left"><strong>扩展层</strong></td><td align="left">可按需定制，适应特殊场景</td><td align="left">基于 Dubbo SPI 的微内核架构，所有核心组件均可扩展或替换。</td></tr></tbody></table>
<p><strong>关键技术设计</strong>：</p>
<ul>
<li><strong>URL 统一模型</strong>：Dubbo 使用 URL（统一资源定位符）作为配置信息的标准格式，贯穿于注册、订阅、调用等全流程，实现了配置的标准化和传递的一致性。</li>
<li><strong>Invoker 调用抽象</strong>：<code>Invoker</code> 是 Dubbo 的核心抽象，代表一个可执行对象。无论是本地调用、远程调用，还是集群调用，都被统一为 <code>Invoker</code>，从而在调用链上可以方便地插入各种过滤器和拦截器，实现治理逻辑。</li>
<li><strong>Directory 与 Router</strong>：<code>Directory</code> 维护了某个服务的所有可用 <code>Invoker</code> 列表。<code>Router</code> 则根据预设规则（如标签路由、权重）对此列表进行过滤和排序，实现精细化流量调度。</li>
</ul>
<h3 data-id="heading-8">3. 技术难点挖掘</h3>
<ol>
<li><strong>高性能网络通信与序列化</strong>：在保证功能丰富的同时，需设计低延迟、高吞吐的通信协议（如 Triple 协议基于 HTTP/2 的多路复用）和高效的序列化/反序列化机制（如 Hessian2、Kryo、Protobuf）。</li>
<li><strong>动态治理下的数据一致性</strong>：服务实例列表、路由规则等数据在注册中心、消费者、提供者之间需要保证最终一致性，且在网络分区等异常情况下要有妥善的处理策略，避免大规模路由错误。</li>
<li><strong>高度扩展性与兼容性平衡</strong>：作为基础框架，需要提供强大的 SPI 扩展能力，同时又要保证不同版本间、不同扩展实现间的兼容性，这对模块划分和接口设计提出了很高要求。</li>
<li><strong>透明代理与上下文传递</strong>：如何在复杂的调用链（可能经过多级过滤器、路由、集群容错）中，无损地传递调用上下文（如跟踪 ID、隐式参数），且对开发者透明，是一个工程挑战。</li>
<li><strong>云原生适配</strong>：如何与 Kubernetes、Service Mesh（如 Istio）等云原生基础设施无缝集成，实现从“框架治理”到“基础设施治理”的平滑演进。</li>
</ol>
<h3 data-id="heading-9">4. 详细设计图</h3>
<h4 data-id="heading-10">4.1 核心架构图</h4>
<p>以下为 Dubbo 核心模块交互的逻辑架构图：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    Consumer[Consumer] --&gt;|1. 引用服务| RefProxy[Reference Proxy]
    RefProxy --&gt;|2. 目录服务| Directory
    Directory --&gt;|3. 订阅| Registry
    Registry --&gt;|4. 通知| Directory
    Directory --&gt;|5. 获取Invokers| Cluster
    Cluster --&gt;|6. 路由/负载均衡| RouterLoadBalance
    RouterLoadBalance --&gt;|7. 选择Invoker| SelectedInvoker
    SelectedInvoker --&gt;|8. 执行调用| Protocol[Protocol Layer]
    Protocol --&gt;|9. 网络传输| Network[Network Transport]
    Network --&gt;|10. 请求| ProviderProtocol
    ProviderProtocol --&gt;|11. 派发| Dispatcher
    Dispatcher --&gt;|12. 线程池| ThreadPool
    ThreadPool --&gt;|13. 业务执行| ServiceImpl[Service Implementation]
    
    Provider[Provider] --&gt;|注册| Registry
    ServiceImpl --&gt;|暴露为Invoker| Exporter
    Exporter --&gt; Protocol
    
    ConfigCenter[Config Center] -.-&gt;|推送规则| Consumer &amp; Provider
    Monitor[Monitor] -.-&gt;|上报指标| Consumer &amp; Provider
    
    subgraph "Consumer Side"
        Consumer
        RefProxy
        Directory
        Cluster
        RouterLoadBalance
    end
    
    subgraph "Provider Side"
        Provider
        Dispatcher
        ThreadPool
        ServiceImpl
        Exporter
    end
    
    subgraph "公共组件"
        Registry
        Protocol
        Network
        ConfigCenter
        Monitor
    end
</code></pre>
<h4 data-id="heading-11">4.2 核心调用链路序列图</h4>
<p>一次 Dubbo RPC 调用的简化序列图如下：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant C as Consumer App
    participant P as Provider Proxy
    participant Cluster
    participant LB as LoadBalance
    participant Invoker
    participant Net as Network Client
    participant NetS as Network Server
    participant Dispatcher
    participant Biz as Business Impl

    C-&gt;&gt;P: invoke(method, args)
    P-&gt;&gt;Cluster: list(invokers)
    Cluster-&gt;&gt;LB: select(invokers)
    LB--&gt;&gt;Cluster: selectedInvoker
    Cluster-&gt;&gt;Invoker: invoke(invocation)
    Invoker-&gt;&gt;Net: send(request)
    Net-&gt;&gt;NetS: 传输
    NetS-&gt;&gt;Dispatcher: 接收并派发
    Dispatcher-&gt;&gt;Biz: 执行实际方法
    Biz--&gt;&gt;Dispatcher: result
    Dispatcher--&gt;&gt;NetS: response
    NetS--&gt;&gt;Net: 传输
    Net--&gt;&gt;Invoker: response
    Invoker--&gt;&gt;Cluster: result
    Cluster--&gt;&gt;P: result
    P--&gt;&gt;C: return result
</code></pre>
<h4 data-id="heading-12">4.3 核心类关系图（简略）</h4>
<p>围绕 <code>Invoker</code> 和 <code>URL</code> 的核心类关系：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/673453dfb1ec4061a85fc265305eb14d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5Y6C5oqA5pyv5oC755uR5LiL5rW3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767676485&amp;x-signature=OD5VKOnnnuoe5VxpPDis6eODQ1E%3D" alt="deepseek_mermaid_20251230_a5778a.png" loading="lazy"/>
<em>说明</em>：<code>Invoker</code> 是执行单元；<code>Directory</code> 管理 <code>Invoker</code> 集合；<code>ClusterInvoker</code> 包含集群调用逻辑；<code>DubboInvoker</code> 是具体的远程通信实现；<code>URL</code> 是贯穿全局的配置载体。</p>
<h3 data-id="heading-13">5. 核心函数与代码解析</h3>
<h4 data-id="heading-14">5.1 核心 SPI 与配置：从 <code>pom.xml</code> 看模块化</h4>
<p>项目根 <code>pom.xml</code> 揭示了 Dubbo 的高度模块化设计。<code>&lt;modules&gt;</code> 部分定义了数十个子模块，如 <code>dubbo-rpc</code>, <code>dubbo-cluster</code>, <code>dubbo-registry</code> 等，每个模块职责单一，通过 Maven 依赖进行组装。</p>
<p><strong>关键配置解析</strong>：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 使用 revision 属性统一管理版本，便于多模块协同发布 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${revision}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">revision</span>&gt;</span>3.3.7-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">revision</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 依赖管理：通过 BOM (Bill of Materials) 统一管理所有子模块和第三方依赖的版本 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.dubbo<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>dubbo-dependencies-bom<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${project.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 条件化模块引入：根据 JDK 版本动态引入支持新特性的模块 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">profiles</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">profile</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>jdk-version-ge-17<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">activation</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">jdk</span>&gt;</span>[17,)<span class="hljs-tag">&lt;/<span class="hljs-name">jdk</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">activation</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">modules</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>dubbo-spring-boot-project/dubbo-spring-boot-3-autoconfigure<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>dubbo-plugin/dubbo-spring6-security<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>dubbo-plugin/dubbo-mutiny<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span> <span class="hljs-comment">&lt;!-- Reactive支持 --&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">modules</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">profile</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">profiles</span>&gt;</span>
</code></pre>
<p><strong>设计要点</strong>：这种结构支持“按需引入”，用户可以根据项目需要只依赖 <code>dubbo-spring-boot-starter</code>，或精细引入 <code>dubbo-rpc-triple</code> 等特定模块，有效控制应用包大小。</p>
<h4 data-id="heading-15">5.2 服务提供者启动示例</h4>
<p>提供的 <code>ProviderApplication.java</code> 是一个典型的 Spring Boot 启动类：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> org.apache.dubbo.springboot.demo.servlet;
<span class="hljs-keyword">import</span> org.apache.dubbo.config.spring.context.annotation.EnableDubbo;
<span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;
<span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;

<span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@EnableDubbo</span> <span class="hljs-comment">// 关键注解：启用 Dubbo 的注解驱动及自动配置</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProviderApplication</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        SpringApplication.run(ProviderApplication.class, args);
    }
}
</code></pre>
<ul>
<li><strong><code>@EnableDubbo</code></strong>：该注解是 Dubbo 与 Spring 集成的关键。它内部会导入 <code>DubboComponentScanRegistrar</code> 等配置类，完成以下工作：
<ol>
<li>扫描被 <code>@DubboService</code> 注解标记的类，将其注册为 Spring Bean 并导出为 Dubbo 服务。</li>
<li>扫描被 <code>@DubboReference</code> 注解标记的字段，为其注入一个远程服务的代理对象。</li>
<li>根据配置文件（<code>application.yaml</code>）初始化 <code>ApplicationConfig</code>, <code>RegistryConfig</code>, <code>ProtocolConfig</code> 等核心配置 Bean。</li>
</ol>
</li>
</ul>
<h4 data-id="heading-16">5.3 核心调用抽象 <code>Invoker.invoke</code></h4>
<p><code>Invoker.invoke</code> 方法是整个调用链的起点和核心。以下为简化逻辑：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Invoker 接口定义</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Invoker</span>&lt;T&gt; {
    <span class="hljs-comment">// 执行一次调用， invocation 封装了方法名、参数类型、实际参数值等。</span>
    Result <span class="hljs-title function_">invoke</span><span class="hljs-params">(Invocation invocation)</span> <span class="hljs-keyword">throws</span> RpcException;
    <span class="hljs-comment">// 获取该 Invoker 关联的 URL (配置信息)</span>
    URL <span class="hljs-title function_">getUrl</span><span class="hljs-params">()</span>;
    <span class="hljs-comment">// 判断 Invoker 是否可用</span>
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAvailable</span><span class="hljs-params">()</span>;
    <span class="hljs-comment">// 销毁 Invoker</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span>;
}

<span class="hljs-comment">// 一个典型的 AbstractInvoker 实现片段（示意）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractInvoker</span>&lt;T&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Invoker</span>&lt;T&gt; {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">invoke</span><span class="hljs-params">(Invocation inv)</span> <span class="hljs-keyword">throws</span> RpcException {
        <span class="hljs-comment">// 1. 预处理：检查服务状态，设置调用ID等附加信息</span>
        beforeInvoke(inv);
        
        <span class="hljs-comment">// 2. 执行具体的调用（由子类实现，如远程调用或本地调用）</span>
        <span class="hljs-type">Result</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> doInvoke(inv);
        
        <span class="hljs-comment">// 3. 后处理：结果处理，异常转换</span>
        afterInvoke(result, inv);
        <span class="hljs-keyword">return</span> result;
    }
    
    <span class="hljs-comment">// 模板方法，子类需实现具体的调用逻辑</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> Result <span class="hljs-title function_">doInvoke</span><span class="hljs-params">(Invocation invocation)</span> <span class="hljs-keyword">throws</span> Throwable;
}
</code></pre>
<ul>
<li><strong><code>Invocation</code></strong>：封装了单次调用的所有信息，是一个数据契约对象。</li>
<li><strong><code>Result</code></strong>：封装调用结果，包含返回值、异常状态等。</li>
<li><strong>设计模式</strong>：这里使用了<strong>模板方法模式</strong>。<code>AbstractInvoker</code> 定义了 <code>invoke</code> 的通用流程框架（前后处理），而将具体的网络通信等差异点留给 <code>DubboInvoker</code>、<code>HttpInvoker</code> 等子类实现。</li>
</ul>
<h4 data-id="heading-17">5.4 集群容错与负载均衡（简化流程）</h4>
<p>在 <code>ClusterInvoker</code>（如 <code>FailoverClusterInvoker</code>）中，核心调用逻辑示意如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">invoke</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Invocation invocation)</span> <span class="hljs-keyword">throws</span> RpcException {
    <span class="hljs-comment">// 1. 从 Directory 获取所有可用的服务提供者 Invoker 列表</span>
    List&lt;Invoker&lt;T&gt;&gt; invokers = directory.list(invocation);
    
    <span class="hljs-comment">// 2. 根据配置的负载均衡策略（如 RandomLoadBalance）选择一个 Invoker</span>
    <span class="hljs-type">LoadBalance</span> <span class="hljs-variable">loadbalance</span> <span class="hljs-operator">=</span> initLoadBalance(invokers, invocation);
    Invoker&lt;T&gt; selectedInvoker = loadbalance.select(invokers, ..., invocation);
    
    <span class="hljs-comment">// 3. 进行调用，如果失败且配置了重试，则选择下一个 Invoker 再次调用（容错逻辑）</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; retries + <span class="hljs-number">1</span>; i++) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> selectedInvoker.invoke(invocation);
        } <span class="hljs-keyword">catch</span> (RpcException e) {
            <span class="hljs-keyword">if</span> (shouldRetry(e, i)) {
                <span class="hljs-comment">// 重试前，重新获取列表（可能已变化），并重新选择（排除已失败的）</span>
                invokers = reselectExcluded(invokers, selectedInvoker);
                selectedInvoker = loadbalance.select(invokers, ..., invocation);
                <span class="hljs-keyword">continue</span>;
            }
            <span class="hljs-keyword">throw</span> e;
        }
    }
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>此流程清晰展示了 Dubbo 如何将<strong>服务发现</strong>（<code>directory.list</code>）、<strong>负载均衡</strong>和<strong>集群容错</strong>（重试机制）串联在一次 RPC 调用中，体现了其治理能力的落地。</p>
<h3 data-id="heading-18">总结</h3>
<p>Apache Dubbo 通过清晰的分层架构、以 <code>Invoker</code> 和 <code>URL</code> 为核心的一致抽象、以及基于 SPI 的强大扩展机制，成功构建了一个功能完备、性能良好且高度可定制的企业级 RPC 与微服务治理框架。它不仅仅是通信工具，更是一套提升分布式系统可维护性、可观测性和稳定性的系统性解决方案。其成功源于对分布式服务核心痛点的准确把握，以及工程化上的精良设计与持续迭代。对于面临服务化挑战的技术团队而言，深入理解其架构设计，能更好地驾驭并发挥其最大价值。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot+SPI机制，轻松实现可插拔组件]]></title>    <link>https://juejin.cn/post/7589246131586121763</link>    <guid>https://juejin.cn/post/7589246131586121763</guid>    <pubDate>2025-12-30T05:50:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589246131586121763" data-draft-id="7589308109640564771" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot+SPI机制，轻松实现可插拔组件"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-30T05:50:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java编程爱好者"/> <meta itemprop="url" content="https://juejin.cn/user/819554264300154"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot+SPI机制，轻松实现可插拔组件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/819554264300154/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java编程爱好者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T05:50:18.000Z" title="Tue Dec 30 2025 05:50:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>什么是Java的SPI</p>
<p>Java SPI（‌Service Provider Interface）‌是一种服务提供界面，‌它是Java提供的一种服务发现和加载机制，‌允许开发者为接口定义多种实现，‌并在运行时动态地发现和加载这些实现。‌</p>
<p>Java SPI机制的核心在于它提供了一种方式，‌使得服务提供者可以根据SPI的约定，‌为某个接口提供具体的实现类。‌这些实现类被放置在特定的位置，‌如<code>META-INF/services</code>目录下，‌并通过配置文件指定。‌当需要使用这些服务时，‌Java运行时环境能够自动扫描这些目录，‌找到并加载相应的实现类，‌从而实现服务的动态发现和加载。‌</p>
<p>Java SPI的主要用途包括：‌</p>
<ul>
<li>服务提供者可以在不修改业务代码的情况下，‌为框架或库提供扩展点。‌</li>
<li>允许在运行时动态地插入或更换组件实现，‌鼓励松耦合的设计原则。‌</li>
<li>允许第三方扩展和替换核心库中的组件，‌丰富了Java生态，‌为开发者提供了极大的灵活性。‌</li>
</ul>
<p>在Java中，‌SPI被广泛应用于各种框架和库的扩展，‌如Servlet容器初始化、‌类型转换、‌日志记录等场景。‌通过SPI机制，‌Java应用程序可以在不修改业务代码的情况下，‌轻松地集成和使用第三方提供的服务实现，‌从而提高了软件的可扩展性和可维护性</p>
<h2 data-id="heading-0"/>
<p>SPI和API的区别</p>
<p>SPI和API的主要区别在于它们的定义方式、‌调用方式、‌灵活性、‌依赖关系以及用途。‌</p>
<ul>
<li><strong>定义方式：‌</strong> API是由开发者主动编写并公开给其他开发者使用的，‌而SPI是由框架或库提供方定义的接口，‌供第三方开发者实现。‌</li>
<li><strong>调用方式：‌</strong> API通过直接调用接口的方法来使用功能，‌而SPI是通过配置文件来指定具体的实现类，‌然后由框架或库自动加载和调用。‌</li>
<li><strong>灵活性：‌</strong> API的实现类必须在编译时就确定，‌无法动态替换；‌而SPI的实现类可以在运行时根据配置文件的内容进行动态加载和替换。‌</li>
<li><strong>依赖关系：‌</strong> API是被调用方依赖的，‌即应用程序需要引入API所在的库才能使用其功能；‌而SPI是调用方依赖的，‌即框架或库需要引入第三方实现类的库才能加载和调用。‌</li>
<li><strong>用途：‌</strong> API通常用于描述库、‌框架、‌操作系统、‌服务等对外提供的编程接口，‌开发者通过API调用相应的功能来实现自己的应用程序。‌而SPI定义了一种插件式的架构，‌允许开发者定义接口，‌并通过服务提供者来提供不同的实现，‌主要目的是允许系统在运行时发现和加载具体的服务提供者，‌从而实现动态扩展和替换功能的能力。‌</li>
</ul>
<p>综上所述，‌API是一种规范，‌描述了如何与一个组件进行交互；‌而SPI则是一种机制，‌用于动态地发现和加载实现了特定接口的组件。‌</p>
<h2 data-id="heading-1"/>
<p>实现过程</p>
<p><strong>0.目录结构</strong></p>
<pre><code class="hljs language-diff" lang="diff">sa-auth  父工程
<span class="hljs-deletion">-- sa-auth-bus 业务工程</span>
<span class="hljs-deletion">-- sa-auth-plugin 定义SPI接口的工程</span>
<span class="hljs-deletion">-- sa-auth-plugin-ldap 模拟第三方库的实现工程</span>
</code></pre>
<p><strong>1.idea创建名为sa-auth 的pom 项目，pom 如下</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>  
<span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0"</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>  
<span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.1.16.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.vijay<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>cs-auth<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>cs-auth<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">packaging</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">packaging</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>cs-auth<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.compilerVersion</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.compilerVersion</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">modules</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>cs-auth-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>cs-auth-bus<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>cs-auth-plugin-ldap<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">modules</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.18.20<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.vijay<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>cs-auth-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span>
</code></pre>
<p><strong>2.然后创建sa-auth-plugin，pom 如下</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>  
<span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0"</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>  
<span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.vijay<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>cs-auth<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">relativePath</span>&gt;</span>../pom.xml<span class="hljs-tag">&lt;/<span class="hljs-name">relativePath</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>cs-auth-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>cs-auth-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>cs-auth-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span>
</code></pre>
<p><strong>3.sa-auth-bus，pom 如下</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>  
<span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0"</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>  
<span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.vijay<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>cs-auth<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">relativePath</span>&gt;</span>../pom.xml<span class="hljs-tag">&lt;/<span class="hljs-name">relativePath</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>cs-auth-bus<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>cs-auth-bus<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>cs-auth-bus<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.vijay<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>cs-auth-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">resources</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">resource</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">directory</span>&gt;</span>src/main/resources<span class="hljs-tag">&lt;/<span class="hljs-name">directory</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">filtering</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">filtering</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">resource</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">resources</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.1.1.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">executions</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">execution</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">goals</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">goal</span>&gt;</span>repackage<span class="hljs-tag">&lt;/<span class="hljs-name">goal</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">goals</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">execution</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">executions</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span>
</code></pre>
<p><strong>4.sa-auth-plugin-ldap，pom如下</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>  
<span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0"</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>  
<span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.vijay<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>cs-auth<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">relativePath</span>&gt;</span>../pom.xml<span class="hljs-tag">&lt;/<span class="hljs-name">relativePath</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>cs-auth-plugin-ldap<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>cs-auth-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>cs-auth-plugin-ldap<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.vijay<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>cs-auth-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span>
</code></pre>
<p><strong>5.创建好的项目结构如下</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/482ebbcf6b384dca8c42dd79f660f56f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767678618&amp;x-signature=rUOoC7970WOJLzHS8J87vRKXBJQ%3D" alt="图片" loading="lazy"/></p>
<p><strong>6.打开sa-auth-plugin，定义SPI接口</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">package com.vijay.csauthplugin.service;  

<span class="hljs-comment">/**  
* 插件SPI接口  
*  
* @author vijay  
*/</span>
publicinterface AuthPluginService {  

    <span class="hljs-comment">/**  
    * 登录认证  
    *  
    * @param userName 用户名  
    * @param password 密码  
    * @return 认证结果  
    */</span>
    <span class="hljs-function"><span class="hljs-type">boolean</span> <span class="hljs-title">login</span><span class="hljs-params">(<span class="hljs-type">String</span> userName, <span class="hljs-type">String</span> password)</span></span>;  

    <span class="hljs-comment">/**  
    * AuthPluginService Name which for conveniently find AuthPluginService instance.  
    *  
    * @return AuthServiceName mark a AuthPluginService instance.  
    */</span>
    <span class="hljs-function"><span class="hljs-type">String</span> <span class="hljs-title">getAuthServiceName</span><span class="hljs-params">()</span></span>;  
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b5c98892b554395a8ebde6dedadbc06~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767678618&amp;x-signature=gD%2F9z%2B8DVFXiuP3EQyIAJttQ9sE%3D" alt="图片" loading="lazy"/></p>
<p><strong>7.cs-auth-plugin-ldap 中实现SPI的接口并且打成jar包，模拟外部提供的插件jar包</strong></p>
<p>1.实现引入的cs-auth-plug包的SPI接口 <code>package com.vijay.csauthplugin.ldap;</code></p>
<pre><code class="hljs language-typescript" lang="typescript">package com.<span class="hljs-property">vijay</span>.<span class="hljs-property">csauthplugin</span>.<span class="hljs-property">ldap</span>;
<span class="hljs-keyword">import</span> com.<span class="hljs-property">vijay</span>.<span class="hljs-property">csauthplugin</span>.<span class="hljs-property">service</span>.<span class="hljs-property">AuthPluginService</span>;  
<span class="hljs-comment">/**  
* <span class="hljs-doctag">@author</span> vijay  
*/</span>
<span class="hljs-keyword">public</span><span class="hljs-keyword">class</span> <span class="hljs-title class_">LdapProviderImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AuthPluginService</span> {  
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">login</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> userName, <span class="hljs-built_in">String</span> password</span>) {  
        <span class="hljs-keyword">return</span><span class="hljs-string">"vijay"</span>.<span class="hljs-title function_">equals</span>(userName) &amp;&amp; <span class="hljs-string">"123456"</span>.<span class="hljs-title function_">equals</span>(password);  
    }  

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getAuthServiceName</span>(<span class="hljs-params"/>) {  
        <span class="hljs-keyword">return</span><span class="hljs-string">"LdapProvider"</span>;  
    }  
}
</code></pre>
<p>2.resources目录下创建<code>META-INF/services</code>目录，并在目录下创建一个名为SPI接口类的全路径限定名<code>com.vijay.csauthplugin.service.AuthPluginService</code>的文件，文件中写入<code>LdapProviderImpl</code> 实现类的全路径限定名<code>com.vijay.csauthplugin.ldap.LdapProviderImpl</code></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c1cbf5c12c5b404ea6a344084c78f1e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767678618&amp;x-signature=jP%2BIQSlrhJ4df4viCZVMsbn8B8o%3D" alt="图片" loading="lazy"/></p>
<p>3.cs-auth-plugin-ldap打包成jar包</p>
<p><strong>8.打开cs-auth-plugin-bus</strong></p>
<p>1.项目下创建plugin包，添加一个插件的默认实现<code>DefaultProviderImpl</code></p>
<pre><code class="hljs language-typescript" lang="typescript">package com.<span class="hljs-property">vijay</span>.<span class="hljs-property">bus</span>.<span class="hljs-property">plugin</span>;  

<span class="hljs-keyword">import</span> com.<span class="hljs-property">vijay</span>.<span class="hljs-property">csauthplugin</span>.<span class="hljs-property">service</span>.<span class="hljs-property">AuthPluginService</span>;  

<span class="hljs-comment">/**  
* 默认插件实现  
*  
* <span class="hljs-doctag">@author</span> vijay  
*/</span>
<span class="hljs-keyword">public</span><span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultProviderImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AuthPluginService</span> {  
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">login</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> userName, <span class="hljs-built_in">String</span> password</span>) {  
        <span class="hljs-keyword">return</span><span class="hljs-string">"vijay"</span>.<span class="hljs-title function_">equals</span>(userName) &amp;&amp; <span class="hljs-string">"123456"</span>.<span class="hljs-title function_">equals</span>(password);  
    }  

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getAuthServiceName</span>(<span class="hljs-params"/>) {  
        <span class="hljs-keyword">return</span><span class="hljs-string">"DefaultProvider"</span>;  
    }  
}
</code></pre>
<p>2.resources目录下创建<code>META-INF/services</code>目录并在目录下创建一个名为SPI接口类全路径限定名的文件<code>com.vijay.csauthplugin.service.AuthPluginService</code>，文件内容为<code>DefaultProviderImpl</code>全路径限定名<code>com.vijay.bus.plugin.DefaultProviderImpl.自定义类加载器</code></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.vijay.bus.plugin;  

<span class="hljs-keyword">import</span> java.net.URL;  
<span class="hljs-keyword">import</span> java.net.URLClassLoader;  

<span class="hljs-comment">/**  
* 自定义类加载器  
*  
* <span class="hljs-doctag">@author</span> vijay  
*/</span>
publicclass PluginClassLoader <span class="hljs-keyword">extends</span> <span class="hljs-title class_">URLClassLoader</span> {  

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">PluginClassLoader</span><span class="hljs-params">(URL[] urls)</span> {  
        <span class="hljs-built_in">super</span>(urls);  
    }  

    <span class="hljs-comment">/**  
    * <span class="hljs-doctag">@param</span> url 路径  
    */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addzURL</span><span class="hljs-params">(URL url)</span> {  
        <span class="hljs-built_in">super</span>.addURL(url);  
    }  

}
</code></pre>
<p>4.定义一个加载外部jar包的类</p>
<pre><code class="hljs language-scss" lang="scss">package com<span class="hljs-selector-class">.vijay</span><span class="hljs-selector-class">.bus</span><span class="hljs-selector-class">.plugin</span>;  

import java<span class="hljs-selector-class">.io</span><span class="hljs-selector-class">.File</span>;  
import java<span class="hljs-selector-class">.net</span><span class="hljs-selector-class">.URL</span>;  
import java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.ArrayList</span>;  
import java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.List</span>;  
import java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.Objects</span>;  

<span class="hljs-comment">/**  
* 加载指定目录jar包  
* @author vijay  
*/</span>
publicclass ExternalJarLoader {  

    <span class="hljs-comment">/**  
    * 加载外部jia包  
    *  
    * @param externalDirPath jar包目录  
    */</span>
    public static void <span class="hljs-built_in">loadExternalJars</span>(String externalDirPath) {  
        File dir = new <span class="hljs-built_in">File</span>(externalDirPath);  
        if (!dir.exists() || !dir<span class="hljs-selector-class">.isDirectory</span>()) {  
            thrownew <span class="hljs-built_in">IllegalArgumentException</span>("Invalid directory path");  
        }  
        List&lt;URL&gt; urls = new ArrayList&lt;&gt;();  
        File<span class="hljs-selector-attr">[]</span> listFiles = dir<span class="hljs-selector-class">.listFiles</span>();  
        if (Objects.nonNull(listFiles) &amp;&amp; listFiles<span class="hljs-selector-class">.length</span> &gt; <span class="hljs-number">0</span>) {  
            ClassLoader contextClassLoader = Thread<span class="hljs-selector-class">.currentThread</span>()<span class="hljs-selector-class">.getContextClassLoader</span>();  
            try {  
                for (File file : listFiles) {  
                    if (file.getName()<span class="hljs-selector-class">.endsWith</span>(".jar")) {  
                        urls<span class="hljs-selector-class">.add</span>(file.toURI()<span class="hljs-selector-class">.toURL</span>());  
                    }  
                }  
                PluginClassLoader customClassLoader = new <span class="hljs-built_in">PluginClassLoader</span>(urls.toArray(new URL[<span class="hljs-number">0</span>]));  
                Thread<span class="hljs-selector-class">.currentThread</span>()<span class="hljs-selector-class">.setContextClassLoader</span>(customClassLoader);  
            } catch (Exception e) {  
                e<span class="hljs-selector-class">.printStackTrace</span>();  
                Thread<span class="hljs-selector-class">.currentThread</span>()<span class="hljs-selector-class">.setContextClassLoader</span>(contextClassLoader);  
            }  
        }  
    }  
}
</code></pre>
<p>5.启动类中添加类加载器</p>
<pre><code class="hljs language-typescript" lang="typescript">package com.<span class="hljs-property">vijay</span>.<span class="hljs-property">bus</span>;  

<span class="hljs-keyword">import</span> com.<span class="hljs-property">vijay</span>.<span class="hljs-property">bus</span>.<span class="hljs-property">plugin</span>.<span class="hljs-property">ExternalJarLoader</span>;  
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">boot</span>.<span class="hljs-property">SpringApplication</span>;  
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">boot</span>.<span class="hljs-property">autoconfigure</span>.<span class="hljs-property">SpringBootApplication</span>;  

<span class="hljs-comment">/**  
* <span class="hljs-doctag">@author</span> vijay  
*/</span>
<span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">public</span><span class="hljs-keyword">class</span> <span class="hljs-title class_">CsAuthBusApplication</span> {  
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {  
        <span class="hljs-title class_">String</span> jarPath=<span class="hljs-string">"/Users/vijay/Downloads/build/plugin"</span>;
        <span class="hljs-title class_">ExternalJarLoader</span>.<span class="hljs-title function_">loadExternalJars</span>(jarPath);  
        <span class="hljs-title class_">SpringApplication</span>.<span class="hljs-title function_">run</span>(<span class="hljs-title class_">CsAuthBusApplication</span>.<span class="hljs-property">class</span>, args);  
    }  
}
</code></pre>
<p>6.创建插件提供者类<code>PluginProvider</code>，提供实现类供springboot注入</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">package</span> com.vijay.bus.plugin;  

<span class="hljs-keyword">import</span> com.vijay.csauthplugin.service.AuthPluginService;  

<span class="hljs-keyword">import</span> java.util.ServiceLoader;  

<span class="hljs-comment">/**  
* 插件提供者  
*  
* <span class="hljs-doctag">@author</span> vijay  
*/</span>
<span class="hljs-keyword">public</span><span class="hljs-keyword">class</span> <span class="hljs-title class_">PluginProvider</span> {  

    <span class="hljs-comment">/**  
    * 提供一个插件供注入(默认返回外部目录的插件,外部目录没有插件时返回默认插件)  
    *  
    * <span class="hljs-doctag">@return</span> 具体的插件实现  
    */</span>
    <span class="hljs-keyword">public</span> static AuthPluginService getAuthPluginService() {  
        ServiceLoader&lt;AuthPluginService&gt; defaultLoad = ServiceLoader.load(AuthPluginService.<span class="hljs-keyword">class</span>);  
        AuthPluginService plugin = <span class="hljs-literal">null</span>;  
        <span class="hljs-keyword">for</span> (AuthPluginService authPluginService : defaultLoad) {  
            <span class="hljs-keyword">if</span> (authPluginService instanceof DefaultProviderImpl) {  
                plugin = authPluginService;  
            } <span class="hljs-keyword">else</span> {  
                <span class="hljs-keyword">return</span> authPluginService;  
            }  
        }  
        <span class="hljs-keyword">return</span> plugin;  
    }  
}
</code></pre>
<p>7.项目下创建<code>conf</code>包，注入实现类到<code>springboot</code></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">package</span> com.vijay.bus.conf;  

<span class="hljs-keyword">import</span> com.vijay.bus.plugin.PluginProvider;  
<span class="hljs-keyword">import</span> com.vijay.csauthplugin.service.AuthPluginService;  
<span class="hljs-keyword">import</span> org.springframework.context.<span class="hljs-keyword">annotation</span>.Bean;  
<span class="hljs-keyword">import</span> org.springframework.context.<span class="hljs-keyword">annotation</span>.Configuration;  


<span class="hljs-comment">/**  
* <span class="hljs-doctag">@author</span> vijay  
*/</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span><span class="hljs-keyword">class</span> <span class="hljs-title class_">PluginConfig</span> {  


    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> AuthPluginService authPluginService() {  
        <span class="hljs-keyword">return</span> PluginProvider.getAuthPluginService();  
    }  
}
</code></pre>
<p>8.项目下创建controller包，定义controller接口，调用测试</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">package</span> com.vijay.bus.controller;  

<span class="hljs-keyword">import</span> com.vijay.csauthplugin.service.AuthPluginService;  
<span class="hljs-keyword">import</span> org.springframework.web.bind.<span class="hljs-keyword">annotation</span>.GetMapping;  
<span class="hljs-keyword">import</span> org.springframework.web.bind.<span class="hljs-keyword">annotation</span>.RestController;  

<span class="hljs-keyword">import</span> javax.<span class="hljs-keyword">annotation</span>.Resource;  
<span class="hljs-keyword">import</span> java.util.HashMap;  
<span class="hljs-keyword">import</span> java.util.Map;  

<span class="hljs-comment">/**  
* <span class="hljs-doctag">@author</span> vijay  
*/</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span><span class="hljs-keyword">class</span> <span class="hljs-title class_">TestController</span> {  
    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> AuthPluginService authPluginService;  
    <span class="hljs-meta">@GetMapping(<span class="hljs-string">"test"</span>)</span>  
    <span class="hljs-keyword">public</span> Object test() {  
        returnnew HashMap() {{  
            put(<span class="hljs-string">"name"</span>, authPluginService.getAuthServiceName());  
            put(<span class="hljs-string">"login"</span>, authPluginService.login(<span class="hljs-string">"vijay"</span>, <span class="hljs-string">"123456"</span>));  
        }};  
    }  
}
</code></pre>
<p>完整结构</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b22efb6b24e948538e9c6fac742a6e08~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767678618&amp;x-signature=j%2FVLxjhU5cKH%2Bu4wbCE7aql5NwQ%3D" alt="图片" loading="lazy"/></p>
<p>9.请求接口，测试实现</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c9b600cfcee54dcea24d6677115beffb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767678618&amp;x-signature=9Uj6m6%2BnU9%2F9ujewo9IIvHbU5%2BY%3D" alt="图片" loading="lazy"/></p>
<p>此时返回为默认实现，把cs-auth-plugin-ldap项目模拟的第三方包放到外部jar包加载目录，重新启动项目后发起请求</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/566a317788ff48d68cef86449c55f17c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767678618&amp;x-signature=SFUXKYq8D1OnFh6sKmW1kadctKA%3D" alt="图片" loading="lazy"/></p>
<p>实现已经是模拟的jar的实现</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端 Token 无感刷新全解析：Vue3 与 React 实现方案]]></title>    <link>https://juejin.cn/post/7589227883262083118</link>    <guid>https://juejin.cn/post/7589227883262083118</guid>    <pubDate>2025-12-30T05:54:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589227883262083118" data-draft-id="7589207474134728754" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端 Token 无感刷新全解析：Vue3 与 React 实现方案"/> <meta itemprop="keywords" content="Vue.js,React.js"/> <meta itemprop="datePublished" content="2025-12-30T05:54:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="不想秃头的程序员"/> <meta itemprop="url" content="https://juejin.cn/user/2754702534251820"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端 Token 无感刷新全解析：Vue3 与 React 实现方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2754702534251820/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    不想秃头的程序员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T05:54:13.000Z" title="Tue Dec 30 2025 05:54:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在前后端分离架构中，Token 是主流的身份认证方式。但 Token 存在有效期限制，若在用户操作过程中 Token 过期，会导致请求失败，影响用户体验。「无感刷新」技术应运而生——它能在 Token 过期前或过期瞬间，自动刷新 Token 并继续完成原请求，全程对用户透明。</p>
<p>本文将先梳理 Token 无感刷新的核心原理，再分别基于 Vue3（Composition API + Pinia）和 React（Hooks + Axios）给出完整实现方案，同时解析常见问题与优化思路，帮助开发者快速落地。</p>
<h2 data-id="heading-0">一、核心原理：为什么需要无感刷新？怎么实现？</h2>
<h3 data-id="heading-1">1. 基础概念：Access Token 与 Refresh Token</h3>
<p>无感刷新依赖「双 Token 机制」，后端需返回两种 Token：</p>
<ul>
<li><strong>Access Token（访问 Token）</strong> ：有效期短（如 2 小时），用于接口请求的身份认证，放在请求头（如 Authorization: Bearer {token}）；</li>
<li><strong>Refresh Token（刷新 Token）</strong> ：有效期长（如 7 天），仅用于 Access Token 过期时请求新的 Access Token，安全性要求更高（建议存储在 HttpOnly Cookie 中，避免 XSS 攻击）。</li>
</ul>
<h3 data-id="heading-2">2. 无感刷新核心流程</h3>
<ol>
<li>前端发起接口请求，携带 Access Token；</li>
<li>拦截响应：若返回 401 状态码（Access Token 过期），则触发刷新逻辑；</li>
<li>用 Refresh Token 调用后端「刷新 Token 接口」，获取新的 Access Token；</li>
<li>更新本地存储的 Access Token；</li>
<li>重新发起之前失败的请求（携带新 Token）；</li>
<li>若 Refresh Token 也过期（刷新接口返回 401），则跳转至登录页，要求用户重新登录。</li>
</ol>
<p>关键优化点：<strong>避免重复刷新</strong>——当多个请求同时因 Token 过期失败时，需保证只发起一次 Refresh Token 请求，其他请求排队等待新 Token 生成后再重试。</p>
<h2 data-id="heading-3">二、前置准备：Axios 拦截器封装（通用基础）</h2>
<p>无论是 Vue 还是 React，都可基于 Axios 的「请求拦截器」和「响应拦截器」实现 Token 统一处理。先封装一个基础 Axios 实例：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// utils/request.js</span>
<span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>;

<span class="hljs-comment">// 创建 Axios 实例</span>
<span class="hljs-keyword">const</span> service = axios.<span class="hljs-title function_">create</span>({
  <span class="hljs-attr">baseURL</span>: <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">VITE_API_BASE_URL</span>, <span class="hljs-comment">// 环境变量中的接口基础地址</span>
  <span class="hljs-attr">timeout</span>: <span class="hljs-number">5000</span> <span class="hljs-comment">// 请求超时时间</span>
});

<span class="hljs-comment">// 1. 请求拦截器：添加 Access Token</span>
service.<span class="hljs-property">interceptors</span>.<span class="hljs-property">request</span>.<span class="hljs-title function_">use</span>(
  <span class="hljs-function">(<span class="hljs-params">config</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> accessToken = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'accessToken'</span>); <span class="hljs-comment">// 简化存储，实际建议 Vue 用 Pinia/React 用状态管理</span>
    <span class="hljs-keyword">if</span> (accessToken) {
      config.<span class="hljs-property">headers</span>.<span class="hljs-property">Authorization</span> = <span class="hljs-string">`Bearer <span class="hljs-subst">${accessToken}</span>`</span>;
    }
    <span class="hljs-keyword">return</span> config;
  },
  <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error)
);

<span class="hljs-comment">// 2. 响应拦截器：处理 Token 过期逻辑（核心，后续框架差异化实现）</span>
<span class="hljs-comment">// 此处先留空，后续在 Vue/React 中补充具体逻辑</span>
service.<span class="hljs-property">interceptors</span>.<span class="hljs-property">response</span>.<span class="hljs-title function_">use</span>(
  <span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> response.<span class="hljs-property">data</span>, <span class="hljs-comment">// 直接返回响应体</span>
  <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> <span class="hljs-title function_">handleResponseError</span>(error, service) <span class="hljs-comment">// 错误处理，传入 service 用于重试请求</span>
);

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> service;
</code></pre>
<h2 data-id="heading-4">三、Vue3 实现方案（Composition API + Pinia）</h2>
<p>Vue3 中推荐用 Pinia 管理全局状态（存储 Token），结合 Composition API 封装刷新逻辑，保证代码复用性。</p>
<h3 data-id="heading-5">1. 步骤 1：Pinia 状态管理（存储 Token）</h3>
<p>创建 Pinia Store 管理 Access Token 和 Refresh Token，提供刷新 Token 的方法：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// stores/authStore.js</span>
<span class="hljs-keyword">import</span> { defineStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>;
<span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useAuthStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'auth'</span>, {
  <span class="hljs-attr">state</span>: <span class="hljs-function">() =&gt;</span> ({
    <span class="hljs-attr">accessToken</span>: <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'accessToken'</span>) || <span class="hljs-string">''</span>,
    <span class="hljs-attr">refreshToken</span>: <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'refreshToken'</span>) || <span class="hljs-string">''</span> <span class="hljs-comment">// 实际建议存 HttpOnly Cookie</span>
  }),
  <span class="hljs-attr">actions</span>: {
    <span class="hljs-comment">// 更新 Token</span>
    <span class="hljs-title function_">updateTokens</span>(<span class="hljs-params">newAccessToken, newRefreshToken</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">accessToken</span> = newAccessToken;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">refreshToken</span> = newRefreshToken;
      <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'accessToken'</span>, newAccessToken);
      <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'refreshToken'</span>, newRefreshToken); <span class="hljs-comment">// 仅演示，生产环境用 HttpOnly Cookie</span>
    },
    <span class="hljs-comment">// 刷新 Token 核心方法</span>
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">refreshAccessToken</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/api/refresh-token'</span>, {
          <span class="hljs-attr">refreshToken</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">refreshToken</span>
        });
        <span class="hljs-keyword">const</span> { accessToken, refreshToken } = res.<span class="hljs-property">data</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateTokens</span>(accessToken, refreshToken);
        <span class="hljs-keyword">return</span> accessToken; <span class="hljs-comment">// 返回新 Token，用于重试请求</span>
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-comment">// 刷新 Token 失败（如 Refresh Token 过期），清除状态并跳转登录</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">clearTokens</span>();
        <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span> = <span class="hljs-string">'/login'</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error);
      }
    },
    <span class="hljs-comment">// 清除 Token</span>
    <span class="hljs-title function_">clearTokens</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">accessToken</span> = <span class="hljs-string">''</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">refreshToken</span> = <span class="hljs-string">''</span>;
      <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">removeItem</span>(<span class="hljs-string">'accessToken'</span>);
      <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">removeItem</span>(<span class="hljs-string">'refreshToken'</span>);
    }
  }
});
</code></pre>
<h3 data-id="heading-6">2. 步骤 2：实现响应拦截器的错误处理</h3>
<p>完善之前的响应拦截器，添加 Token 过期处理逻辑，核心是「避免重复刷新」：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// utils/request.js（Vue3 版本补充）</span>
<span class="hljs-keyword">import</span> { useAuthStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/stores/authStore'</span>;

<span class="hljs-comment">// 用于存储刷新 Token 的请求（避免重复刷新）</span>
<span class="hljs-keyword">let</span> refreshPromise = <span class="hljs-literal">null</span>;

<span class="hljs-comment">// 响应错误处理函数</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleResponseError</span>(<span class="hljs-params">error, service</span>) {
  <span class="hljs-keyword">const</span> authStore = <span class="hljs-title function_">useAuthStore</span>();
  <span class="hljs-keyword">const</span> originalRequest = error.<span class="hljs-property">config</span>; <span class="hljs-comment">// 原始请求配置</span>

  <span class="hljs-comment">// 1. 不是 401 错误，直接 reject</span>
  <span class="hljs-keyword">if</span> (error.<span class="hljs-property">response</span>?.<span class="hljs-property">status</span> !== <span class="hljs-number">401</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error);
  }

  <span class="hljs-comment">// 2. 是 401 错误，但已经重试过一次，避免死循环</span>
  <span class="hljs-keyword">if</span> (originalRequest.<span class="hljs-property">_retry</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error);
  }

  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 3. 标记当前请求已重试，避免重复</span>
    originalRequest.<span class="hljs-property">_retry</span> = <span class="hljs-literal">true</span>;

    <span class="hljs-comment">// 4. 若没有正在进行的刷新请求，发起刷新；否则等待已有请求完成</span>
    <span class="hljs-keyword">if</span> (!refreshPromise) {
      refreshPromise = authStore.<span class="hljs-title function_">refreshAccessToken</span>();
    }

    <span class="hljs-comment">// 5. 等待刷新完成，获取新 Token</span>
    <span class="hljs-keyword">const</span> newAccessToken = <span class="hljs-keyword">await</span> refreshPromise;

    <span class="hljs-comment">// 6. 刷新完成后，重置 refreshPromise</span>
    refreshPromise = <span class="hljs-literal">null</span>;

    <span class="hljs-comment">// 7. 更新原始请求的 Authorization 头，重新发起请求</span>
    originalRequest.<span class="hljs-property">headers</span>.<span class="hljs-property">Authorization</span> = <span class="hljs-string">`Bearer <span class="hljs-subst">${newAccessToken}</span>`</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">service</span>(originalRequest);
  } <span class="hljs-keyword">catch</span> (refreshError) {
    <span class="hljs-comment">// 刷新失败，重置 refreshPromise</span>
    refreshPromise = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(refreshError);
  }
}

<span class="hljs-comment">// 响应拦截器（补充完整）</span>
service.<span class="hljs-property">interceptors</span>.<span class="hljs-property">response</span>.<span class="hljs-title function_">use</span>(
  <span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> response.<span class="hljs-property">data</span>,
  <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> <span class="hljs-title function_">handleResponseError</span>(error, service)
);
</code></pre>
<h3 data-id="heading-7">3. 步骤 3：组件中使用</h3>
<p>封装好后，组件中直接使用 request 发起请求即可，无需关注 Token 刷新逻辑：</p>
<pre><code class="hljs language-xml" lang="xml">// components/Example.vue
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> request <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/request'</span>;
<span class="hljs-keyword">import</span> { ref, onMounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;

<span class="hljs-keyword">const</span> data = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>);

<span class="hljs-title function_">onMounted</span>(<span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 发起请求，Token 过期时会自动无感刷新</span>
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> request.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/user-info'</span>);
    data.<span class="hljs-property">value</span> = res.<span class="hljs-property">data</span>;
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'请求失败：'</span>, error);
  }
});
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{{ data ? data.name : '加载中...' }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<h2 data-id="heading-8">四、React 实现方案（Hooks + Context）</h2>
<p>React 中推荐用「Context + Hooks」管理全局 Token 状态，结合 Axios 拦截器实现无感刷新，逻辑与 Vue3 类似，但状态管理方式不同。</p>
<h3 data-id="heading-9">1. 步骤 1：创建 Auth Context（管理 Token 状态）</h3>
<p>用 Context 提供 Token 相关的状态和方法，供全局组件使用：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// context/AuthContext.js</span>
<span class="hljs-keyword">import</span> { createContext, useContext, useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>;

<span class="hljs-comment">// 创建 Context</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">AuthContext</span> = <span class="hljs-title function_">createContext</span>();

<span class="hljs-comment">//  Provider 组件：提供 Token 状态和方法</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">AuthProvider</span>(<span class="hljs-params">{ children }</span>) {
  <span class="hljs-keyword">const</span> [accessToken, setAccessToken] = <span class="hljs-title function_">useState</span>(<span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'accessToken'</span>) || <span class="hljs-string">''</span>);
  <span class="hljs-keyword">const</span> [refreshToken, setRefreshToken] = <span class="hljs-title function_">useState</span>(<span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'refreshToken'</span>) || <span class="hljs-string">''</span>);

  <span class="hljs-comment">// 更新 Token</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">updateTokens</span> = (<span class="hljs-params">newAccessToken, newRefreshToken</span>) =&gt; {
    <span class="hljs-title function_">setAccessToken</span>(newAccessToken);
    <span class="hljs-title function_">setRefreshToken</span>(newRefreshToken);
    <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'accessToken'</span>, newAccessToken);
    <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'refreshToken'</span>, newRefreshToken); <span class="hljs-comment">// 演示用，生产环境用 HttpOnly Cookie</span>
  };

  <span class="hljs-comment">// 刷新 Token</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">refreshAccessToken</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/api/refresh-token'</span>, { refreshToken });
      <span class="hljs-keyword">const</span> { <span class="hljs-attr">accessToken</span>: newAccessToken, <span class="hljs-attr">refreshToken</span>: newRefreshToken } = res.<span class="hljs-property">data</span>;
      <span class="hljs-title function_">updateTokens</span>(newAccessToken, newRefreshToken);
      <span class="hljs-keyword">return</span> newAccessToken;
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-comment">// 刷新失败，清除状态并跳转登录</span>
      <span class="hljs-title function_">clearTokens</span>();
      <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span> = <span class="hljs-string">'/login'</span>;
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error);
    }
  };

  <span class="hljs-comment">// 清除 Token</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">clearTokens</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">setAccessToken</span>(<span class="hljs-string">''</span>);
    <span class="hljs-title function_">setRefreshToken</span>(<span class="hljs-string">''</span>);
    <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">removeItem</span>(<span class="hljs-string">'accessToken'</span>);
    <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">removeItem</span>(<span class="hljs-string">'refreshToken'</span>);
  };

  <span class="hljs-comment">// 提供给子组件的内容</span>
  <span class="hljs-keyword">const</span> value = {
    accessToken,
    refreshToken,
    updateTokens,
    refreshAccessToken,
    clearTokens
  };

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">AuthContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{value}</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">AuthContext.Provider</span>&gt;</span></span>;
}

<span class="hljs-comment">// 自定义 Hook：方便组件获取 Auth 状态</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useAuth</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> context = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">AuthContext</span>);
  <span class="hljs-keyword">if</span> (!context) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'useAuth must be used within an AuthProvider'</span>);
  }
  <span class="hljs-keyword">return</span> context;
}
</code></pre>
<h3 data-id="heading-10">2. 步骤 2：在入口文件中包裹 AuthProvider</h3>
<p>确保全局组件都能访问到 Auth Context：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// index.js</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ReactDOM</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react-dom/client'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AuthProvider</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./context/AuthContext'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App'</span>;

<span class="hljs-keyword">const</span> root = <span class="hljs-title class_">ReactDOM</span>.<span class="hljs-title function_">createRoot</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'root'</span>));
root.<span class="hljs-title function_">render</span>(
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">AuthProvider</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">AuthProvider</span>&gt;</span></span>
);
</code></pre>
<h3 data-id="heading-11">3. 步骤 3：完善 Axios 响应拦截器</h3>
<p>逻辑与 Vue3 一致，核心是避免重复刷新，通过 useAuth Hook 获取刷新 Token 方法：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// utils/request.js（React 版本补充）</span>
<span class="hljs-keyword">import</span> { useAuth } <span class="hljs-keyword">from</span> <span class="hljs-string">'../context/AuthContext'</span>;

<span class="hljs-comment">// 注意：React 中不能在 Axios 拦截器中直接使用 useAuth（Hook 只能在组件/自定义 Hook 中使用）</span>
<span class="hljs-comment">// 解决方案：用一个函数封装，在组件初始化时调用，注入 auth 实例</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">initRequestInterceptors</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { refreshAccessToken } = <span class="hljs-title function_">useAuth</span>();
  <span class="hljs-keyword">let</span> refreshPromise = <span class="hljs-literal">null</span>;

  <span class="hljs-comment">// 响应错误处理函数</span>
  <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleResponseError</span>(<span class="hljs-params">error, service</span>) {
    <span class="hljs-keyword">const</span> originalRequest = error.<span class="hljs-property">config</span>;

    <span class="hljs-comment">// 1. 非 401 错误，直接 reject</span>
    <span class="hljs-keyword">if</span> (error.<span class="hljs-property">response</span>?.<span class="hljs-property">status</span> !== <span class="hljs-number">401</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error);
    }

    <span class="hljs-comment">// 2. 已重试过，避免死循环</span>
    <span class="hljs-keyword">if</span> (originalRequest.<span class="hljs-property">_retry</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error);
    }

    <span class="hljs-keyword">try</span> {
      originalRequest.<span class="hljs-property">_retry</span> = <span class="hljs-literal">true</span>;

      <span class="hljs-comment">// 3. 避免重复刷新</span>
      <span class="hljs-keyword">if</span> (!refreshPromise) {
        refreshPromise = <span class="hljs-title function_">refreshAccessToken</span>();
      }

      <span class="hljs-comment">// 4. 等待新 Token</span>
      <span class="hljs-keyword">const</span> newAccessToken = <span class="hljs-keyword">await</span> refreshPromise;
      refreshPromise = <span class="hljs-literal">null</span>;

      <span class="hljs-comment">// 5. 重试原始请求</span>
      originalRequest.<span class="hljs-property">headers</span>.<span class="hljs-property">Authorization</span> = <span class="hljs-string">`Bearer <span class="hljs-subst">${newAccessToken}</span>`</span>;
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">service</span>(originalRequest);
    } <span class="hljs-keyword">catch</span> (refreshError) {
      refreshPromise = <span class="hljs-literal">null</span>;
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(refreshError);
    }
  }

  <span class="hljs-comment">// 重新设置响应拦截器（注入 auth 实例后）</span>
  service.<span class="hljs-property">interceptors</span>.<span class="hljs-property">response</span>.<span class="hljs-title function_">use</span>(
    <span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> response.<span class="hljs-property">data</span>,
    <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> <span class="hljs-title function_">handleResponseError</span>(error, service)
  );
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> service;
</code></pre>
<h3 data-id="heading-12">4. 步骤 4：在组件中初始化拦截器并使用</h3>
<p>在根组件（如 App.js）中初始化拦截器，确保 useAuth 能正常使用：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// App.js</span>
<span class="hljs-keyword">import</span> { useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { initRequestInterceptors } <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils/request'</span>;
<span class="hljs-keyword">import</span> request <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils/request'</span>;
<span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [userInfo, setUserInfo] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);

  <span class="hljs-comment">// 初始化 Axios 拦截器（注入 Auth 上下文）</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">initRequestInterceptors</span>();
  }, []);

  <span class="hljs-comment">// 发起请求（Token 过期自动刷新）</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchUserInfo</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> request.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/user-info'</span>);
      <span class="hljs-title function_">setUserInfo</span>(res.<span class="hljs-property">data</span>);
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'请求失败：'</span>, error);
    }
  };

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">fetchUserInfo</span>();
  }, []);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"App"</span>&gt;</span>
      {userInfo ? <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>欢迎，{userInfo.name}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span> : <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">App</span>;
</code></pre>
<h2 data-id="heading-13">五、关键优化与安全注意事项</h2>
<h3 data-id="heading-14">1. 避免重复刷新的核心逻辑</h3>
<p>用「refreshPromise」变量存储正在进行的刷新 Token 请求，当多个请求同时失败时，都等待同一个 refreshPromise 完成，避免发起多个刷新请求，这是无感刷新的核心优化点。</p>
<h3 data-id="heading-15">2. 安全优化：Refresh Token 的存储方式</h3>
<ul>
<li>
<p>不建议将 Refresh Token 存储在 localStorage/sessionStorage 中，容易遭受 XSS 攻击；</p>
</li>
<li>
<p>推荐存储在「HttpOnly Cookie」中，由浏览器自动携带，无法通过 JavaScript 访问，有效防御 XSS 攻击；</p>
</li>
<li>
<p>若后端支持，可给 Refresh Token 增加「设备绑定」「IP 限制」等额外安全措施。</p>
</li>
</ul>
<h3 data-id="heading-16">3. 主动刷新：提前预防 Token 过期</h3>
<p>被动刷新（等待 401 后再刷新）可能存在延迟，可增加「主动刷新」逻辑：</p>
<ul>
<li>记录 Access Token 的生成时间和过期时间；</li>
<li>在请求拦截器中判断 Token 剩余有效期（如小于 5 分钟），主动发起刷新请求；</li>
<li>避免在用户无操作时刷新，可结合「用户活动监听」（如 click、keydown 事件）触发主动刷新。</li>
</ul>
<h3 data-id="heading-17">4. 异常处理：刷新失败的兜底方案</h3>
<p>当 Refresh Token 过期或无效时，必须跳转至登录页，并清除本地残留的 Token 状态，避免死循环请求。同时，可给用户提示「登录已过期，请重新登录」，提升体验。</p>
<h2 data-id="heading-18">六、Vue3 与 React 实现方案对比</h2>






























<table><thead><tr><th>对比维度</th><th>Vue3 实现</th><th>React 实现</th></tr></thead><tbody><tr><td>状态管理</td><td>Pinia（官方推荐，API 简洁，支持 TypeScript）</td><td>Context + Hooks（原生支持，无需额外依赖）</td></tr><tr><td>拦截器初始化</td><td>可直接在 Pinia 中获取状态，无需额外注入</td><td>需在组件中初始化拦截器，注入 Auth Context</td></tr><tr><td>核心逻辑</td><td>基于 Composition API，逻辑封装更灵活</td><td>基于自定义 Hooks，符合函数式编程思想</td></tr><tr><td>学习成本</td><td>Pinia 学习成本低，适合 Vue 生态开发者</td><td>Context + Hooks 需理解 React 状态传递机制</td></tr></tbody></table>
<p>本质差异：状态管理方式不同，但无感刷新的核心逻辑（双 Token、拦截器、避免重复刷新）完全一致，开发者可根据自身技术栈选择对应方案。</p>
<h2 data-id="heading-19">七、总结</h2>
<p>前端 Token 无感刷新的核心是「双 Token 机制 + Axios 拦截器」，关键在于解决「重复刷新」和「安全存储」问题。Vue3 和 React 的实现方案虽在状态管理上有差异，但核心逻辑相通：</p>
<ol>
<li>用请求拦截器统一添加 Access Token；</li>
<li>用响应拦截器捕获 401 错误，触发刷新逻辑；</li>
<li>通过一个全局变量控制刷新请求的唯一性，避免重复请求；</li>
<li>刷新成功后重试原始请求，失败则跳转登录。</li>
</ol>
<p>实际项目中，需结合后端接口设计（如刷新 Token 的接口地址、参数格式）和安全需求（如 Refresh Token 存储方式）调整实现细节。合理的无感刷新方案能大幅提升用户体验，避免因 Token 过期导致的操作中断。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kubernetes 中 "Deployment does not have minimum availability" 错误解析与解决方案]]></title>    <link>https://juejin.cn/post/7589509638338854938</link>    <guid>https://juejin.cn/post/7589509638338854938</guid>    <pubDate>2025-12-30T05:54:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589509638338854938" data-draft-id="7589231401657712650" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kubernetes 中 &quot;Deployment does not have minimum availability&quot; 错误解析与解决方案"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-30T05:54:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金者阿豪"/> <meta itemprop="url" content="https://juejin.cn/user/4073055974333608"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kubernetes 中 "Deployment does not have minimum availability" 错误解析与解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4073055974333608/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金者阿豪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T05:54:28.000Z" title="Tue Dec 30 2025 05:54:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Kubernetes 中 "Deployment does not have minimum availability" 错误解析与解决方案</h2>
<p>在现代云原生应用开发中，Kubernetes 已成为广泛应用的容器编排平台。它为我们提供了自动化的应用部署、扩展和管理功能，极大地简化了分布式系统的构建。然而，虽然 Kubernetes 提供了强大的功能和灵活性，但在使用过程中，还是会遇到一些常见的错误和问题，影响应用的正常运行和可靠性。</p>
<p>其中，“<strong>Deployment does not have minimum availability</strong>” 这个错误常见于 Kubernetes 环境下，尤其是在我们进行应用部署时。当遇到这个错误时，表示 Kubernetes 无法确保在指定的时间内有足够的 Pod 副本处于运行状态，无法满足所需的最小可用副本数。这一问题通常源于多种因素，如资源不足、配置错误、节点故障等问题。</p>
<p>本文将详细探讨 Kubernetes 中 "Deployment does not have minimum availability" 错误的原因，分析如何通过排查日志、检查配置和优化资源来解决该问题，确保部署的应用具有足够的可用性。</p>
<h3 data-id="heading-1">一、Kubernetes Deployment 介绍</h3>
<p>在 Kubernetes 中，<code>Deployment</code> 是一种声明式的 API 资源，它允许开发者描述应用的期望状态，并且 Kubernetes 会确保这个期望状态得以实现。一个 <code>Deployment</code> 可以管理多个副本的 Pod，提供高可用性、负载均衡和滚动更新等功能。</p>
<h4 data-id="heading-2">1.1 Deployment 的核心功能</h4>
<ul>
<li><strong>自动化管理 Pod 副本</strong>：Kubernetes 会根据 <code>Deployment</code> 定义的副本数，确保在任何时间点都运行着正确数量的 Pod。</li>
<li><strong>滚动更新</strong>：支持逐步更新应用，确保在更新过程中始终有可用的副本。</li>
<li><strong>回滚功能</strong>：支持将应用回滚到先前的稳定版本。</li>
<li><strong>自我修复</strong>：如果某个 Pod 宕机或出现故障，Deployment 会自动重新调度新的 Pod 来替代它，保持可用性。</li>
</ul>
<h4 data-id="heading-3">1.2 Deployment 的最小可用副本数</h4>
<p>在 Kubernetes 中，每个 <code>Deployment</code> 都有一个 <code>replicas</code> 字段，用来指定希望部署的 Pod 副本数。<code>Deployment</code> 控制器会根据副本数来调度 Pod，并确保在任何时候都有足够数量的副本在运行。</p>
<p>然而，有时因为多种原因，Pod 无法正常启动或保持运行状态，导致实际运行的 Pod 数量低于 <code>Deployment</code> 的副本数。这时，Kubernetes 会抛出 <strong>"Deployment does not have minimum availability"</strong> 错误，提示应用的最小可用副本数没有满足期望值。</p>
<h3 data-id="heading-4">二、"Deployment does not have minimum availability" 错误解析</h3>
<h4 data-id="heading-5">2.1 错误信息的含义</h4>
<p>当你看到错误信息 <code>Deployment does not have minimum availability</code> 时，意味着 <code>Deployment</code> 中定义的期望副本数（<code>replicas</code>）未能达到预定的可用副本数。这通常发生在以下几种情况：</p>
<ul>
<li><strong>Pod 无法启动</strong>：由于配置错误、资源不足、容器镜像问题等，导致 Pod 无法正常启动。</li>
<li><strong>Pod 处于非运行状态</strong>：有些 Pod 可能因为应用崩溃或其他错误而处于 <code>CrashLoopBackOff</code>、<code>Error</code> 或 <code>Pending</code> 状态。</li>
<li><strong>资源不足</strong>：集群中的节点资源不足（如 CPU、内存等）导致 Pod 无法调度和运行。</li>
<li><strong>调度失败</strong>：由于节点故障、网络问题或资源限制，Kubernetes 无法将 Pod 调度到可用的节点上。</li>
</ul>
<h4 data-id="heading-6">2.2 错误发生的常见原因</h4>
<h5 data-id="heading-7">2.2.1 Pod 配置错误</h5>
<p>Pod 配置文件（如 <code>deployment.yaml</code>）中可能存在错误，导致某些 Pod 无法正确启动。例如，配置的环境变量错误、挂载卷失败或网络连接问题等，都会使 Pod 启动失败，进而导致副本数无法达到预期。</p>
<h5 data-id="heading-8">2.2.2 资源限制不足</h5>
<p>如果 Kubernetes 集群的资源（如节点 CPU、内存等）不足，或者 <code>Deployment</code> 定义的资源请求超出了节点的可用资源，Kubernetes 就无法调度 Pod 到节点上，导致 Pod 无法正常运行，从而导致最小副本数无法达到。</p>
<h5 data-id="heading-9">2.2.3 上游服务不可用</h5>
<p>如果 Pod 启动时需要依赖其他服务（如数据库、消息队列等），而这些服务不可用或无法访问，也可能导致 Pod 无法启动，最终无法满足最小可用副本数的要求。</p>
<h5 data-id="heading-10">2.2.4 调度失败</h5>
<p>Pod 的调度失败通常发生在节点资源不足、节点不可用或网络配置问题等情况下。Kubernetes 会将 Pod 调度到合适的节点上，如果调度失败，Pod 就无法运行，导致最小副本数无法满足。</p>
<h4 data-id="heading-11">2.3 错误的具体表现</h4>
<ul>
<li><code>kubectl get pods</code> 命令查看时，Pod 的状态可能会显示为 <code>CrashLoopBackOff</code>、<code>Pending</code> 或 <code>Error</code>，说明某些 Pod 未能成功启动。</li>
<li><code>kubectl describe deployment</code> 命令输出中，<code>Replicas</code> 字段显示的副本数可能低于期望的副本数，导致可用副本数不足。</li>
<li><code>kubectl describe pod &lt;pod-name&gt;</code> 输出中的事件（events）部分会显示 Pod 启动失败的详细原因，如 <code>insufficient memory</code>、<code>image pull failed</code> 等。</li>
</ul>
<h3 data-id="heading-12">三、排查和解决方案</h3>
<h4 data-id="heading-13">3.1 查看 Deployment 状态</h4>
<p>首先，使用 <code>kubectl describe deployment</code> 命令查看 <code>Deployment</code> 的详细信息，检查副本数、Pod 状态、事件信息等。</p>
<pre><code class="hljs language-bash" lang="bash">kubectl describe deployment &lt;deployment-name&gt; -n &lt;namespace&gt;
</code></pre>
<p>从 <code>describe</code> 输出中，可以查看到 <code>Replicas</code>、<code>Available Replicas</code> 和 <code>Unavailable Replicas</code> 等字段，帮助你了解 Pod 是否达到了预期的可用副本数。</p>
<h4 data-id="heading-14">3.2 查看 Pod 状态和事件</h4>
<p>接下来，使用 <code>kubectl get pods</code> 查看 Pod 的状态，检查是否有 Pod 处于 <code>CrashLoopBackOff</code>、<code>Pending</code> 或 <code>Error</code> 状态。可以使用以下命令：</p>
<pre><code class="hljs language-bash" lang="bash">kubectl get pods -n &lt;namespace&gt;
</code></pre>
<p>如果某些 Pod 的状态不正常，可以使用 <code>kubectl describe pod &lt;pod-name&gt;</code> 查看详细的错误信息和事件日志，分析问题所在。</p>
<h4 data-id="heading-15">3.3 资源使用情况</h4>
<p>检查集群的资源使用情况，确保节点有足够的 CPU、内存等资源来运行 Pod。可以使用以下命令查看节点的资源使用情况：</p>
<pre><code class="hljs language-bash" lang="bash">kubectl top nodes
</code></pre>
<p>如果节点资源不足，可以尝试增加集群的节点，或者调整 Pod 的资源请求（<code>requests</code>）和限制（<code>limits</code>）值，以确保 Pod 可以正常调度到节点上。</p>
<h4 data-id="heading-16">3.4 修复 Pod 启动失败的问题</h4>
<p>如果 Pod 因配置错误（如环境变量、挂载卷、网络等问题）无法启动，可以通过检查 Pod 的日志来找到具体的错误信息。使用以下命令查看 Pod 日志：</p>
<pre><code class="hljs language-bash" lang="bash">kubectl logs &lt;pod-name&gt; -n &lt;namespace&gt;
</code></pre>
<p>根据日志中的错误信息进行修复，确保所有 Pod 都能成功启动。</p>
<h4 data-id="heading-17">3.5 调整副本数和资源配置</h4>
<p>如果资源不足以启动所需的 Pod，可以通过减少副本数或者调整资源请求来解决。例如，减少 <code>replicas</code> 数量：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spec:</span>
  <span class="hljs-attr">replicas:</span> <span class="hljs-number">2</span>
</code></pre>
<p>同时，检查每个 Pod 的资源请求和限制是否合理，并适当调整：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">resources:</span>
  <span class="hljs-attr">requests:</span>
    <span class="hljs-attr">cpu:</span> <span class="hljs-string">"500m"</span>
    <span class="hljs-attr">memory:</span> <span class="hljs-string">"512Mi"</span>
  <span class="hljs-attr">limits:</span>
    <span class="hljs-attr">cpu:</span> <span class="hljs-string">"1"</span>
    <span class="hljs-attr">memory:</span> <span class="hljs-string">"1Gi"</span>
</code></pre>
<h4 data-id="heading-18">3.6 查看节点和调度器状态</h4>
<p>如果 Pod 无法调度，可能是因为节点不可用或网络配置问题。使用 <code>kubectl describe node &lt;node-name&gt;</code> 查看节点的状态，确认节点是否正常。确保节点没有被标记为不可调度，并且网络配置正确。</p>
<h4 data-id="heading-19">3.7 配置自动扩容</h4>
<p>如果负载过高，考虑使用 Horizontal Pod Autoscaler（HPA）来自动扩展 <code>Deployment</code> 中的 Pod 副本数量。例如，基于 CPU 使用率自动扩展副本：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">autoscaling/v2</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">HorizontalPodAutoscaler</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">&lt;deployment-name&gt;</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">&lt;namespace&gt;</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">scaleTargetRef:</span>
    <span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
    <span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">&lt;deployment-name&gt;</span>
  <span class="hljs-attr">minReplicas:</span> <span class="hljs-number">1</span>
  <span class="hljs-attr">maxReplicas:</span> <span class="hljs-number">10</span>
  <span class="hljs-attr">metrics:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">type:</span> <span class="hljs-string">Resource</span>
      <span class="hljs-attr">resource:</span>
        <span class="hljs-attr">name:</span> <span class="hljs-string">cpu</span>
        <span class="hljs-attr">target:</span>
          <span class="hljs-attr">type:</span> <span class="hljs-string">Utilization</span>
          <span class="hljs-attr">averageUtilization:</span> <span class="hljs-number">50</span>
</code></pre>
<h3 data-id="heading-20">四、总结</h3>
<p>"Deployment does not have minimum availability" 错误通常是因为 <code>Deployment</code> 中定义的 Pod 副本数未能满足可用副</p>
<p>本数要求。其根本原因可能包括资源不足、Pod 配置错误、调度失败等。解决此问题的方法包括：</p>
<ol>
<li><strong>查看 Deployment 和 Pod 的状态</strong>，检查是否有 Pod 无法启动。</li>
<li><strong>检查资源使用情况</strong>，确保集群有足够的资源。</li>
<li><strong>调整副本数和资源请求</strong>，确保 Kubernetes 能够在节点上调度足够的 Pod。</li>
<li><strong>修复 Pod 启动失败的配置问题</strong>，确保 Pod 能够正常启动。</li>
</ol>
<p>通过逐步排查和解决这些问题，我们可以恢复 Deployment 的最小可用副本数，确保应用的高可用性和稳定性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C++错误处理的现代化方式：深入理解std::error_code]]></title>    <link>https://juejin.cn/post/7589176150493577270</link>    <guid>https://juejin.cn/post/7589176150493577270</guid>    <pubDate>2025-12-30T02:11:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589176150493577270" data-draft-id="7589172193151123492" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C++错误处理的现代化方式：深入理解std::error_code"/> <meta itemprop="keywords" content="安全"/> <meta itemprop="datePublished" content="2025-12-30T02:11:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="深盾安全"/> <meta itemprop="url" content="https://juejin.cn/user/741508014680712"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C++错误处理的现代化方式：深入理解std::error_code
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/741508014680712/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    深盾安全
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T02:11:47.000Z" title="Tue Dec 30 2025 02:11:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">C++错误处理的现代化方式：深入理解std::error_code</h2>
<h2 data-id="heading-1">概述</h2>
<p><code>std::error_code</code> 是 C++ 标准库中一种独立于异常的错误表示与传递机制。它以值类型的方式封装错误信息，适用于禁用异常、系统编程或跨模块交互的场景。通过 <code>std::error_code</code>，函数可以在不依赖异常的前提下，将错误信息明确且安全地返回给调用者。</p>
<p>在现代 C++ 中，<code>std::error_code</code> 已成为标准库中无异常接口的基石，并被视为未来 <code>expected&lt;T, E&gt;</code> 等结果类型中默认的错误承载形式。</p>
<h2 data-id="heading-2">std::error_code 基本构成</h2>
<p>在 C++ 中，错误处理通常有三种途径：通过返回值标识错误、通过异常传播错误、或通过专门的对象传递错误信息。返回值方式表达能力有限，异常在某些工程环境下不可用，而 <code>std::error_code</code> 为第三种方式提供了标准化实现。</p>
<p><code>std::error_code</code> 于 C++11 引入，旨在提供一种类型安全、可组合且无需异常的错误处理机制。</p>
<p>从结构上看，<code>std::error_code</code> 包含两个部分：一个整型错误值和一个错误类别。错误值表示具体错误编号，错误类别则指明该编号所属的错误域，例如系统错误、文件系统错误或自定义库错误。</p>
<p>这种设计避免了纯整数错误码可能引起的歧义。相同的整数值在不同错误域中可代表不同的含义，而 <code>std::error_code</code> 能同时保存值和域的信息。</p>
<p><code>std::error_code</code> 是轻量级的值类型，支持拷贝、赋值和传值。默认构造的 <code>std::error_code</code> 表示“无错误”，其内部错误值为 0。</p>
<p>该类提供了 <code>operator bool()</code>，可用于判断是否出错。非零错误值对应 <code>true</code>，表示发生错误；零值对应 <code>false</code>，表示成功。</p>
<p>此外，可通过 <code>value()</code> 获取原始错误值，通过 <code>category()</code> 获取错误类别，通过 <code>message()</code> 获取可读的错误描述。注意，<code>message()</code> 仅用于输出，不应用于逻辑判断。</p>
<h2 data-id="heading-3">为何选择 std::error_code</h2>
<p>虽然异常是 C++ 内置的错误处理机制，但并非所有项目都适用。一些系统级项目可能禁用异常以减少体积或避免运行时开销；某些库需与 C 接口或其他语言交互，异常无法跨越语言屏障；还有一些场景需要显式处理每一步可能的失败。</p>
<p>在这些情况下，异常并非理想选择，而 <code>std::error_code</code> 提供了一种标准、可移植的替代方案。</p>
<p>与传统的整型错误码相比，<code>std::error_code</code> 具备更强的类型安全性和语义清晰度。错误值不再孤立，而是与错误域绑定，避免了不同模块间的冲突。错误对象可直接传递和存储，不依赖全局变量或线程局部存储。</p>
<p>C++17 的 <code>&lt;filesystem&gt;</code> 模块大量使用了同时支持异常和非异常版本的接口，非异常版本通常通过 <code>std::error_code&amp;</code> 参数报告错误。类似地，<code>std::from_chars</code> 等底层函数也采用了这一设计。</p>
<p>这些实践表明，<code>std::error_code</code> 已成为现代 C++ 开发中不可或缺的一部分。</p>
<h2 data-id="heading-4">如何使用 std::error_code</h2>
<p>最常见的使用方式是调用那些接受 <code>std::error_code&amp;</code> 形参的函数。调用方在调用前准备一个 <code>std::error_code</code> 对象，函数执行后会根据结果设置该对象。成功时错误码被清空，失败时被设为相应错误值。</p>
<p>调用完成后，调用方通过检查该对象即可判断是否出错，并执行相应处理。</p>
<p><code>std::error_code</code> 遵循一项关键约定：错误值 0 表示成功，任何非 0 值表示失败。基于该约定，<code>operator bool()</code> 的行为直观且一致。</p>
<p>这一约定在使用中必须严格遵守。自定义错误码时，切勿将 0 分配给表示失败的枚举值，否则会导致逻辑错误。</p>
<p>在编写库或模块时，通常需要定义自身的错误集合。建议使用 <code>enum class</code> 声明错误枚举，并明确指定一个底层值为 0 的“成功”枚举值。</p>
<p>这些枚举值仅表示错误类型，不包含错误域信息。错误域由后续的 <code>error_category</code> 提供。</p>
<p>为使自定义枚举能自动转换为 <code>std::error_code</code>，需完成两项工作：一是为该枚举特化 <code>std::is_error_code_enum</code>，将其标记为错误码枚举；二是提供名为 <code>make_error_code</code> 的自由函数，用于根据枚举值构造 <code>std::error_code</code> 对象。</p>
<p>完成上述步骤后，该枚举类型即可在需要 <code>std::error_code</code> 的场合隐式使用。该机制依赖于参数依赖查找，对调用方透明。</p>
<h2 data-id="heading-5">完整示例</h2>
<p>假设为一个文件处理模块定义错误码。首先定义错误枚举，其中明确包含成功值：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">enum class</span> <span class="hljs-title class_">FileError</span> {
    success = <span class="hljs-number">0</span>,
    not_found = <span class="hljs-number">1</span>,
    permission_denied = <span class="hljs-number">2</span>
};
</code></pre>
<p>接着定义对应的错误类别，继承自 <code>std::error_category</code>：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">FileErrorCategory</span> : <span class="hljs-keyword">public</span> std::error_category {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">const</span> <span class="hljs-type">char</span>* <span class="hljs-title">name</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">noexcept</span> <span class="hljs-keyword">override</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-string">"file_error"</span>;
    }

    <span class="hljs-function">std::string <span class="hljs-title">message</span><span class="hljs-params">(<span class="hljs-type">int</span> ev)</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span> </span>{
        <span class="hljs-keyword">switch</span> (<span class="hljs-built_in">static_cast</span>&lt;FileError&gt;(ev)) {
        <span class="hljs-keyword">case</span> FileError::success:
            <span class="hljs-keyword">return</span> <span class="hljs-string">"success"</span>;
        <span class="hljs-keyword">case</span> FileError::not_found:
            <span class="hljs-keyword">return</span> <span class="hljs-string">"file not found"</span>;
        <span class="hljs-keyword">case</span> FileError::permission_denied:
            <span class="hljs-keyword">return</span> <span class="hljs-string">"permission denied"</span>;
        <span class="hljs-keyword">default</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-string">"unknown file error"</span>;
        }
    }
};
</code></pre>
<p>提供获取该类别唯一实例的函数：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">const</span> std::error_category&amp; <span class="hljs-title">file_error_category</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-type">static</span> FileErrorCategory instance;
    <span class="hljs-keyword">return</span> instance;
}
</code></pre>
<p>将枚举标记为错误码枚举，并提供构造函数：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">namespace</span> std {
<span class="hljs-keyword">template</span> &lt;&gt;
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">is_error_code_enum</span>&lt;FileError&gt; : true_type {};
}

<span class="hljs-function">std::error_code <span class="hljs-title">make_error_code</span><span class="hljs-params">(FileError e)</span> </span>{
    <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">error_code</span>(<span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int</span>&gt;(e), <span class="hljs-built_in">file_error_category</span>());
}
</code></pre>
<p>此后即可在接口中自然使用 <code>std::error_code</code>：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function">std::error_code <span class="hljs-title">open_file</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; path)</span> </span>{
    <span class="hljs-keyword">if</span> (path.<span class="hljs-built_in">empty</span>()) {
        <span class="hljs-keyword">return</span> FileError::not_found;
    }
    <span class="hljs-keyword">return</span> FileError::success;
}
</code></pre>
<p>调用方通过检查错误码判断结果：</p>
<pre><code class="hljs language-cpp" lang="cpp">std::error_code ec = <span class="hljs-built_in">open_file</span>(<span class="hljs-string">"data.txt"</span>);
<span class="hljs-keyword">if</span> (ec) {
    std::cerr &lt;&lt; ec.<span class="hljs-built_in">message</span>() &lt;&lt; std::endl;
}
</code></pre>
<h2 data-id="heading-6">使用 std::error_code 的基本原则</h2>
<p>在实际使用中，<code>std::error_code</code> 应仅用于表示错误类型，而非携带复杂上下文。错误码的比较应基于枚举值或布尔语义，而非依赖错误信息字符串。</p>
<p>此外，错误码设计应保持稳定。一旦错误值和类别对外公开，应避免随意修改其含义，以免影响调用方逻辑。</p>
<h2 data-id="heading-7">总结</h2>
<p><code>std::error_code</code> 提供了一种标准化、类型安全且不依赖于异常的错误处理方式。它通过绑定错误值与错误域，解决了传统错误码的歧义问题，并在标准库中得到了广泛应用。</p>
<p>在需要无异常接口的场景中，正确定义错误枚举与错误类别，并遵守“0 表示成功”的约定，可使 <code>std::error_code</code> 成为清晰可靠的错误传递工具。随着 C++ 标准向结果类型演进，<code>std::error_code</code> 仍将在未来长期扮演重要角色。</p>
<p>无论是错误处理机制的设计，还是核心业务逻辑的实现，C++ 代码的安全性始终是商业项目的重要考量。在交付可执行程序或 SDK 时，除了确保功能正确，还需防范逆向工程与代码篡改的风险。对于需要加强保护的 C++ 应用程序，推荐使用 Virbox Protector 进行专业的代码加密与混淆，它能有效阻止反编译分析，保护知识产权，为您的软件构筑一道可靠的安全屏障。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python 3.12 性能优化：5 个鲜为人知但提升显著的技巧让你的代码快如闪电]]></title>    <link>https://juejin.cn/post/7589275237037293603</link>    <guid>https://juejin.cn/post/7589275237037293603</guid>    <pubDate>2025-12-30T04:17:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589275237037293603" data-draft-id="7589275237037277219" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python 3.12 性能优化：5 个鲜为人知但提升显著的技巧让你的代码快如闪电"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-12-30T04:17:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python 3.12 性能优化：5 个鲜为人知但提升显著的技巧让你的代码快如闪电
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T04:17:21.000Z" title="Tue Dec 30 2025 04:17:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Python 3.12 性能优化：5 个鲜为人知但提升显著的技巧让你的代码快如闪电</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>Python 作为一种高级解释型语言，以其简洁易读的语法和强大的生态系统著称，但在性能方面常常被人诟病。然而，随着 Python 3.12 的发布，其性能优化特性再次成为开发者关注的焦点。尽管大家熟知一些常见的优化手段（如使用 <code>list</code> 推导式、避免全局变量等），但仍有不少鲜为人知的技巧可以显著提升代码的执行效率。</p>
<p>本文将深入探讨 Python 3.12 中五个较少被提及但效果显著的性能优化技巧。这些技巧不仅基于 Python 核心团队的官方改进，还结合了实际开发中的最佳实践。无论你是数据分析师、Web 开发者还是系统工程师，这些技巧都能帮助你写出更高效的 Python 代码。</p>
<hr/>
<h2 data-id="heading-2">主体</h2>
<h3 data-id="heading-3">1. <strong>利用 PEP 709：内联 comprehensions</strong></h3>
<p>Python 3.12 引入了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fpeps.python.org%2Fpep-0709%2F" target="_blank" title="https://peps.python.org/pep-0709/" ref="nofollow noopener noreferrer">PEP 709</a>，将 comprehensions（推导式）从函数调用转换为内联代码。这一改进显著减少了推导式的开销，尤其是在嵌套使用时。</p>
<h4 data-id="heading-4"><strong>为什么有效？</strong></h4>
<p>在 Python 3.11 及之前版本，列表推导式、字典推导式和集合推导式会被编译为隐式的函数调用。虽然这种设计有助于隔离作用域，但也带来了额外的函数调用开销。Python 3.12 通过内联这些操作消除了这一开销。</p>
<h4 data-id="heading-5"><strong>示例对比</strong></h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Python 3.11（较慢）</span>
squares = [x * x <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1000</span>)]

<span class="hljs-comment"># Python 3.12（更快）</span>
squares = [x * x <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1000</span>)]
</code></pre>
<p>根据官方基准测试，这一改进使得简单的列表推导式速度提升了约 <strong>20%</strong>。</p>
<h4 data-id="heading-6"><strong>适用场景</strong></h4>
<ul>
<li>高频使用的推导式（尤其是嵌套结构）。</li>
<li>大数据集处理时的小幅加速累积效应。</li>
</ul>
<hr/>
<h3 data-id="heading-7">2. <strong><code>math</code>模块的向量化操作</strong></h3>
<p>Python 3.12进一步优化了<code>math</code>模块的性能，尤其是对向量化数学函数的支持。虽然 NumPy仍然是高性能计算的标杆，但原生<code>math</code>模块在某些场景下已经足够高效。</p>
<h4 data-id="heading-8"><strong>为什么有效？</strong></h4>
<p>Python的核心数学函数（如<code>math.sqrt</code>、<code>math.sin</code>）现在利用了更高效的底层实现（例如C标准库的现代优化版本）。此外，编译器对循环内联和常量传播的改进也提升了连续调用的效率。</p>
<h4 data-id="heading-9"><strong>示例对比</strong></h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> math

<span class="hljs-comment"># Python &lt;3.12（较慢）</span>
results = [math.sqrt(x) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10000</span>)]

<span class="hljs-comment"># Python &gt;=3.12 + vectorized style</span>
results = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">map</span>(math.sqrt, <span class="hljs-built_in">range</span>(<span class="hljs-number">10000</span>)))
</code></pre>
<p>后者的写法在Python3.12中快了约15%，因为避免了生成器到列表的转换开销。</p>
<h4 data-id="heading-10"><strong>适用场景</strong></h4>
<ul>
<li>纯数学计算且无法依赖NumPy的小型脚本。</li>
<li>需要减少第三方依赖的场景。</li>
</ul>
<hr/>
<h3 data-id="heading-11">3.<strong>结构化模式匹配中的缓存机制</strong></h3>
<p>Python的模式匹配功能自引入以来一直是语法糖的代名词。然而很少有人注意到其在特定情况下的性能优势——特别是当匹配项重复时,Pyton会缓存部分匹配逻辑.</p>
<h4 data-id="heading-12"><strong>为什么有效?</strong></h4>
<p>当你反复用相同模式去匹配不同数据时,Pytho会记住先前解析过的模式结构从而跳过重复分析阶段直接比较值本身.</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">handle_data</span>(<span class="hljs-params">data</span>):
    <span class="hljs-keyword">match</span> data:
        <span class="hljs-keyword">case</span> {<span class="hljs-string">"type"</span>: <span class="hljs-string">"A"</span>, <span class="hljs-string">"value"</span>: val}:
            process_a(val)
        <span class="hljs-keyword">case</span> {<span class="hljs-string">"type"</span>: <span class="hljs-string">"B"</span>, <span class="hljs-string">"value"</span>: val}:
            process_b(val)

<span class="hljs-comment">#多次调用时第二次以后更快</span>
handle_data({<span class="hljs-string">"type"</span>:<span class="hljs-string">"A"</span>,<span class="hljs-string">"value"</span>:<span class="hljs-number">42</span>}) 
</code></pre>
<p>根据内部测试,复杂模式的重复匹配可提速达30%.</p>
<hr/>
<p>###4.<strong>字典键查找加速(PEP申请中)</strong></p>
<p>虽然尚未正式发布,但Pytohn核心团队正在试验一种新型字典键查找算法—将哈希表与线性搜索相结合以降低冲突率.
当前版本下如果字典很小(&lt;=5项),则直接线性扫描可能比计算哈希更快.</p>
<p>你可以手动模拟这点:</p>
<pre><code class="hljs language-python" lang="python">small_dict = {<span class="hljs-number">1</span>:<span class="hljs-string">"a"</span>,<span class="hljs-number">2</span>:<span class="hljs-string">"b"</span>}
key=<span class="hljs-number">2</span>

<span class="hljs-comment">#传统方式(所有版本)</span>
value=small_dict[key]

<span class="hljs-comment">#手动线性扫描(Python&gt;=312推荐仅对小字典!)</span>
<span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> small_dict.items():
    <span class="hljs-keyword">if</span> k==key:
        value=v
        <span class="hljs-keyword">break</span>
</code></pre>
<p>注意:这只是一个临时技巧等待未来版本原生支持.</p>
<hr/>
<p>###5.<strong>协程栈切换优化</strong></p>
<p>异步编程是现代Pytho生态不可或缺的部分.Pythn312重新设计了协程调度器栈管理机制使得任务切换时的内存操作减少了约40%.</p>
<p>这意味着即使不修改任何业务逻辑你的asyncio应用也能获得免费提速!</p>
<p>具体来说:</p>
<ul>
<li>Coroutine对象现在使用更紧凑的内存布局</li>
<li>await关键字的堆栈分配策略被简化</li>
<li>Event loop唤醒延迟降低</li>
</ul>
<hr/>
<p>##总结</p>
<p>本文介绍了五个针对Pytho312或即将发布版本的性能优化技巧：
1)理解并利用PEP709的内联comprehensions<br/>
2)优先选择原生math模块而非手工循环<br/>
3)善用模式匹配的隐式缓存特性<br/>
4)关注小规模字典的特殊行为<br/>
5)享受异步IO栈管理改进带来的红利</p>
<p>值得注意的是没有任何单一技术能解决所有问题—真正的高效来自于对这些细节的组合运用以及对应用场景深刻理解后做出权衡取舍的能力！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SourceMap 深度解析：从映射原理到线上监控落地]]></title>    <link>https://juejin.cn/post/7589217625901858825</link>    <guid>https://juejin.cn/post/7589217625901858825</guid>    <pubDate>2025-12-30T04:22:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589217625901858825" data-draft-id="7589166195798097947" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SourceMap 深度解析：从映射原理到线上监控落地"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-30T04:22:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="颜酱"/> <meta itemprop="url" content="https://juejin.cn/user/905653309941495"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SourceMap 深度解析：从映射原理到线上监控落地
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/905653309941495/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    颜酱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T04:22:16.000Z" title="Tue Dec 30 2025 04:22:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">SourceMap 深度解析：从映射原理到线上监控落地</h2>
<p>在前端工程化体系中，SourceMap 是解决「压缩代码调试难」的核心工具，但多数开发者仅停留在"知道能用"的层面，既不清楚其底层的 mappings 字段编码逻辑，也不了解生产环境如何安全落地。本文将从 SourceMap 的本质出发，拆解 mappings 字段的 Base64 VLQ 映射逻辑，并结合线上监控场景，讲透 SourceMap 的实战用法。</p>
<h3 data-id="heading-1">📑 目录</h3>
<ul>
<li><a href="#%E4%B8%80sourcemap-%E6%98%AF%E4%BB%80%E4%B9%88%E8%A7%A3%E5%86%B3%E4%BB%80%E4%B9%88%E9%97%AE%E9%A2%98" title="#%E4%B8%80sourcemap-%E6%98%AF%E4%BB%80%E4%B9%88%E8%A7%A3%E5%86%B3%E4%BB%80%E4%B9%88%E9%97%AE%E9%A2%98">一、SourceMap 是什么？解决什么问题？</a>
<ul>
<li><a href="#sourcemap%E7%94%B1%E6%9D%A5" title="#sourcemap%E7%94%B1%E6%9D%A5">SourceMap 由来</a></li>
<li><a href="#11-%E6%A0%B8%E5%BF%83%E7%97%9B%E7%82%B9%E5%8E%8B%E7%BC%A9%E4%BB%A3%E7%A0%81%E8%B0%83%E8%AF%95%E7%9A%84%E5%99%A9%E6%A2%A6" title="#11-%E6%A0%B8%E5%BF%83%E7%97%9B%E7%82%B9%E5%8E%8B%E7%BC%A9%E4%BB%A3%E7%A0%81%E8%B0%83%E8%AF%95%E7%9A%84%E5%99%A9%E6%A2%A6">核心痛点：压缩代码调试的"噩梦"</a></li>
<li><a href="#12-sourcemap-%E6%9C%AC%E8%B4%A8%E4%BB%A3%E7%A0%81%E7%9A%84%E5%9D%90%E6%A0%87%E6%98%A0%E5%B0%84%E8%A1%A8" title="#12-sourcemap-%E6%9C%AC%E8%B4%A8%E4%BB%A3%E7%A0%81%E7%9A%84%E5%9D%90%E6%A0%87%E6%98%A0%E5%B0%84%E8%A1%A8">SourceMap 本质：代码的"坐标映射表"</a></li>
</ul>
</li>
<li><a href="#%E4%BA%8Csourcemap-%E6%A0%B8%E5%BF%83%E7%BB%93%E6%9E%84%E4%B8%8E-mappings-%E5%AD%97%E6%AE%B5%E8%A7%A3%E6%9E%90" title="#%E4%BA%8Csourcemap-%E6%A0%B8%E5%BF%83%E7%BB%93%E6%9E%84%E4%B8%8E-mappings-%E5%AD%97%E6%AE%B5%E8%A7%A3%E6%9E%90">二、SourceMap 核心结构与 mappings 字段解析</a>
<ul>
<li><a href="#21-sourcemap-%E6%A0%87%E5%87%86%E7%BB%93%E6%9E%84" title="#21-sourcemap-%E6%A0%87%E5%87%86%E7%BB%93%E6%9E%84">SourceMap 标准结构</a></li>
<li><a href="#22-mappings-%E5%AD%97%E6%AE%B5base64-vlq-%E6%98%A0%E5%B0%84%E9%80%BB%E8%BE%91%E6%A0%B8%E5%BF%83" title="#22-mappings-%E5%AD%97%E6%AE%B5base64-vlq-%E6%98%A0%E5%B0%84%E9%80%BB%E8%BE%91%E6%A0%B8%E5%BF%83">mappings 字段：Base64 VLQ 映射逻辑（核心）</a></li>
</ul>
</li>
<li><a href="#%E4%B8%89%E7%BA%BF%E4%B8%8A%E7%9B%91%E6%8E%A7sourcemap-%E5%AE%89%E5%85%A8%E8%90%BD%E5%9C%B0%E5%AE%9E%E8%B7%B5" title="#%E4%B8%89%E7%BA%BF%E4%B8%8A%E7%9B%91%E6%8E%A7sourcemap-%E5%AE%89%E5%85%A8%E8%90%BD%E5%9C%B0%E5%AE%9E%E8%B7%B5">三、线上监控：SourceMap 安全落地实践</a>
<ul>
<li><a href="#31-%E6%A0%B8%E5%BF%83%E5%8E%9F%E5%88%99" title="#31-%E6%A0%B8%E5%BF%83%E5%8E%9F%E5%88%99">核心原则</a></li>
<li><a href="#32-%E7%BB%93%E5%90%88-sentry-%E5%AE%9E%E7%8E%B0%E7%BA%BF%E4%B8%8A%E6%8A%A5%E9%94%99%E8%A7%A3%E6%9E%90%E4%B8%BB%E6%B5%81%E6%96%B9%E6%A1%88" title="#32-%E7%BB%93%E5%90%88-sentry-%E5%AE%9E%E7%8E%B0%E7%BA%BF%E4%B8%8A%E6%8A%A5%E9%94%99%E8%A7%A3%E6%9E%90%E4%B8%BB%E6%B5%81%E6%96%B9%E6%A1%88">结合 Sentry 实现线上报错解析（主流方案）</a></li>
<li><a href="#33-%E6%89%8B%E5%8A%A8%E7%A6%BB%E7%BA%BF%E8%A7%A3%E6%9E%90%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9B%91%E6%8E%A7%E5%B9%B3%E5%8F%B0" title="#33-%E6%89%8B%E5%8A%A8%E7%A6%BB%E7%BA%BF%E8%A7%A3%E6%9E%90%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9B%91%E6%8E%A7%E5%B9%B3%E5%8F%B0">手动离线解析（自定义监控平台）</a></li>
</ul>
</li>
<li><a href="#%E5%9B%9Bsourcemap-%E5%B8%B8%E8%A7%81%E9%85%8D%E7%BD%AE%E4%B8%8E%E9%81%BF%E5%9D%91" title="#%E5%9B%9Bsourcemap-%E5%B8%B8%E8%A7%81%E9%85%8D%E7%BD%AE%E4%B8%8E%E9%81%BF%E5%9D%91">四、SourceMap 常见配置与避坑</a></li>
<li><a href="#%E4%BA%94%E6%80%BB%E7%BB%93" title="#%E4%BA%94%E6%80%BB%E7%BB%93">五、总结</a></li>
</ul>
<h3 data-id="heading-2">一、SourceMap 是什么？解决什么问题？</h3>
<h4 data-id="heading-3">SourceMap由来</h4>
<p>SourceMap 最早由 Google 工程师在开发 Closure Compiler（<a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.google.com%2Fclosure%2Fcompiler%2Fdocs%2Fgettingstarted_app%3Fhl%3Dzh-cn" target="_blank" title="https://developers.google.com/closure/compiler/docs/gettingstarted_app?hl=zh-cn" ref="nofollow noopener noreferrer">谷歌闭包编译器</a>）时提出，初衷是解决「编译后的代码调试难」问题 —— 早期前端代码压缩 / 编译后，调试只能看到混淆后的代码，工程师需要一个工具能 “反向找到源码位置”，因此将这个「存储源码映射关系的文件」命名为 SourceMap。后续该规范被标准化（当前主流为 Version 3 版本），并被 Webpack、Vite、Babel、Terser 等几乎所有前端构建工具采纳，SourceMap 也成为行业通用术语。</p>
<p>SourceMap 由 Source + Map 两个英文单词组合而成，其命名精准对应工具的核心功能：</p>
<ul>
<li>Source：指「原始源码（Source Code）」—— 即开发者编写的未编译、未压缩的代码（如 ES6/TS 代码、React/Vue 源码）；</li>
<li>Map：指「映射（Mapping）」—— 在计算机领域，“Map” 核心含义是「键值对的对应关系」（如哈希表、映射表），此处特指「压缩 / 编译后的代码」与「原始源码」之间的坐标、名称映射关系。</li>
</ul>
<h4 data-id="heading-4">1.1 核心痛点：压缩代码调试的"噩梦"</h4>
<p>前端项目上线前，代码会经过 <strong>编译（Babel 转 ES5）、混淆（变量名缩短）、压缩（合并行/删空格）</strong> 处理：</p>
<ul>
<li>
<p>源码：<code>function sayHi(userName) { return </code>Hi ${userName}<code>; }</code></p>
</li>
<li>
<p>压缩后：<code>function a(b){return</code>Hi ${b}<code>}</code></p>
</li>
</ul>
<p>此时若代码报错，浏览器控制台只会显示「z-index.min.js:1:25」这类压缩代码的坐标，完全无法定位到源码的具体位置——这就是 SourceMap 要解决的核心问题。</p>
<h4 data-id="heading-5">1.2 SourceMap 本质：代码的"坐标映射表"</h4>
<p>SourceMap 是一个以 <code>.map</code> 为后缀的 JSON 文件，核心作用是建立「压缩后代码」与「原始源码」的一一映射关系：</p>
<ul>
<li>
<p>压缩后代码的"行/列" ↔ 源码的"文件/行/列"；</p>
</li>
<li>
<p>压缩后的变量名（如 <code>a</code>） ↔ 源码的变量名（如 <code>sayHi</code>）；</p>
</li>
<li>
<p>简单类比：源码是"原版书"，压缩代码是"精简译本"，SourceMap 是"对照字典"。</p>
</li>
</ul>
<h3 data-id="heading-6">二、SourceMap 核心结构与 mappings 字段解析</h3>
<h4 data-id="heading-7">2.1 SourceMap 标准结构</h4>
<p>SourceMap本质就是一个json文件，一个完整的 SourceMap 文件包含 6 个核心字段，以极简示例为例：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// SourceMap 版本（主流为3）</span>
  <span class="hljs-attr">"file"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"z-index.min.js"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 压缩后的产物文件名</span>
  <span class="hljs-attr">"sources"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"z-index.js"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 原始源码文件路径列表，可能有多个</span>
  <span class="hljs-attr">"names"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"userName"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"sayHi"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 源码中的变量/函数名列表</span>
  <span class="hljs-attr">"mappings"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"AAAA,MAAMA,SAAW,QACjB,SAASC,QACP,MAAO,MAAMD,UACf"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 核心映射规则（Base64 VLQ 编码）</span>
  <span class="hljs-attr">"sourcesContent"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-comment">// 可选：存储源码文本，解析时无需额外读取源码</span>
    <span class="hljs-string">"const userName = 'Alice';\nfunction sayHi() {\n  return `Hi ${userName}`;\n}\n"</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>各字段核心作用：</p>

































<table><thead><tr><th>字段</th><th>核心作用</th></tr></thead><tbody><tr><td><code>version</code></td><td>固定版本号，确保解析器兼容</td></tr><tr><td><code>file</code></td><td>关联的压缩产物文件名</td></tr><tr><td><code>sources</code></td><td>映射的原始源码路径，支持多个文件（如多入口项目）</td></tr><tr><td><code>names</code></td><td>源码中的变量/函数名，压缩后名称通过此映射回原名</td></tr><tr><td><code>mappings</code></td><td>最核心：存储"压缩代码坐标 ↔ 源码坐标"的映射规则（Base64 VLQ 编码）</td></tr><tr><td><code>sourcesContent</code></td><td>可选：存储源码文本，解析时无需额外读取源码文件</td></tr></tbody></table>
<h4 data-id="heading-8">2.2 mappings 字段：Base64 VLQ 映射逻辑（核心）</h4>
<p><code>mappings</code> 是 SourceMap 的灵魂，其本质是将「压缩代码 ↔ 源码」的坐标映射关系，转换成一组数字，再通过 VLQ 编码压缩长度，最终转成 Base64 字符。我们以实际的 <code>z-index.js</code> 压缩场景拆解全程：</p>
<h5 data-id="heading-9">场景准备</h5>
<p><strong>前置准备</strong>：全局安装 terser（<code>pnpm install terser -g</code>）</p>
<ul>
<li>
<p><strong>源码</strong>（z-index.js）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> userName = <span class="hljs-string">'Alice'</span>;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">sayHi</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-string">`Hi <span class="hljs-subst">${userName}</span>`</span>;
}
</code></pre>
</li>
<li>
<p><strong>使用 terser 压缩</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">terser z-index.js -o z-index.min.js --source-map <span class="hljs-string">"url='z-index.min.js.map',includeSources=true,filename='z-index.min.js'"</span>
</code></pre>
<p>生成两个文件：<code>z-index.min.js</code> 和 <code>z-index.min.js.map</code></p>
</li>
<li>
<p><strong>压缩后的代码</strong>（z-index.min.js）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> userName = <span class="hljs-string">'Alice'</span>;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">sayHi</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-string">`Hi <span class="hljs-subst">${userName}</span>`</span>;
}
<span class="hljs-comment">//# sourceMappingURL=z-index.min.js.map</span>
</code></pre>
</li>
</ul>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"file"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"z-index.min.js"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"names"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"userName"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"sayHi"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"sources"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"z-index.js"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"sourcesContent"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"const userName = 'Alice';\nfunction sayHi() {\n  return `Hi ${userName}`;\n}\n"</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"mappings"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"AAAA,MAAMA,SAAW,QACjB,SAASC,QACP,MAAO,MAAMD,UACf"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"ignoreList"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>































































































<table><thead><tr><th>映射段</th><th>Base64 VLQ</th><th>解码后（相对偏移）</th><th>压缩代码位置</th><th>源码位置</th><th>对应字符/内容</th><th>说明</th></tr></thead><tbody><tr><td><code>AAAA</code></td><td>[0,0,0,0]</td><td>列:0, 文件:0, 行:0, 列:0</td><td>第1行, 第0列</td><td>z-index.js 第1行, 第0列</td><td><code>c</code> (const)</td><td>起始位置</td></tr><tr><td><code>MAAMA</code></td><td>[6,0,0,6,0]</td><td>列:+6, 文件:+0, 行:+0, 列:+6, 名称:+0</td><td>第1行, 第6列</td><td>z-index.js 第1行, 第6列</td><td><code>u</code> (userName)</td><td>userName 变量名开始</td></tr><tr><td><code>SAAW</code></td><td>[9,0,0,9]</td><td>列:+9, 文件:+0, 行:+0, 列:+9</td><td>第1行, 第15列</td><td>z-index.js 第1行, 第17列</td><td><code>A</code> (Alice)</td><td>'Alice' 字符串开始</td></tr><tr><td><code>QACjB</code></td><td>[1,0,1,3,1]</td><td>列:+1, 文件:+0, 行:+1, 列:+3, 名称:+1</td><td>第1行, 第16列</td><td>z-index.js 第2行, 第0列</td><td><code>f</code> (function)</td><td>function 关键字</td></tr><tr><td><code>SAASC</code></td><td>[9,0,0,9,1]</td><td>列:+9, 文件:+0, 行:+0, 列:+9, 名称:+1</td><td>第1行, 第25列</td><td>z-index.js 第2行, 第9列</td><td><code>s</code> (sayHi)</td><td>sayHi 函数名</td></tr><tr><td><code>QACP</code></td><td>[1,0,0,1]</td><td>列:+1, 文件:+0, 行:+0, 列:+1</td><td>第1行, 第26列</td><td>z-index.js 第2行, 第15列</td><td><code>(</code></td><td>函数参数括号</td></tr><tr><td><code>MAAO</code></td><td>[6,0,0,6]</td><td>列:+6, 文件:+0, 行:+0, 列:+6</td><td>第1行, 第32列</td><td>z-index.js 第2行, 第16列</td><td><code>{</code></td><td>函数体开始</td></tr><tr><td><code>MAAMD</code></td><td>[6,0,0,6,0]</td><td>列:+6, 文件:+0, 行:+0, 列:+6, 名称:+0</td><td>第1行, 第38列</td><td>z-index.js 第3行, 第2列</td><td><code>r</code> (return)</td><td>return 关键字</td></tr><tr><td><code>UACf</code></td><td>[10,0,0,10]</td><td>列:+10, 文件:+0, 行:+0, 列:+10</td><td>第1行, 第48列</td><td>z-index.js 第3行, 第9列</td><td><code>`</code></td><td>模板字符串开始</td></tr></tbody></table>
<h5 data-id="heading-10">Step 1：定义映射数字组（5个核心数字）</h5>
<p>SourceMap 规定，每一组映射关系用 <strong>5个相对偏移数字</strong> 表示（后2个可选），"相对偏移"是核心优化（避免存储大数）：</p>
<p>以实际的 <code>z-index.js</code> 为例，我们看几个关键映射段：</p>









































<table><thead><tr><th>数字位置</th><th>含义（相对前一段的偏移量）</th><th>MAAMA（userName）</th><th>SAASC（sayHi）</th></tr></thead><tbody><tr><td>第1个</td><td>压缩代码的列号偏移</td><td>+6</td><td>+9</td></tr><tr><td>第2个</td><td>源码在 sources 数组的索引</td><td>0</td><td>0</td></tr><tr><td>第3个</td><td>源码行号偏移</td><td>0</td><td>0</td></tr><tr><td>第4个</td><td>源码列号偏移</td><td>+6</td><td>+9</td></tr><tr><td>第5个</td><td>变量名在 names 数组的索引</td><td>0 (userName)</td><td>1 (sayHi)</td></tr></tbody></table>
<p><strong>说明</strong>：</p>
<ul>
<li><code>MAAMA</code> 映射到 <code>userName</code>：压缩代码列号+6，源码列号+6，名称索引0 → <code>names[0] = "userName"</code></li>
<li><code>SAASC</code> 映射到 <code>sayHi</code>：压缩代码列号+9，源码列号+9，名称索引1 → <code>names[1] = "sayHi"</code></li>
</ul>
<h5 data-id="heading-11">Step 2：VLQ 编码 + Base64 转换</h5>
<p>VLQ 是把 SourceMap 里的 “相对偏移数字” 转成 6位“短二进制”，Base64 是把 6位“短二进制” 转成 “可读字符”，两者配合让 mappings 字段既短又能解析。</p>
<p>VLQ 编码的核心优势是<strong>用更少的字符表示数字</strong>，特别是对于小数字（0-63）只需要1个字符，1 个字符通常占 8 位二进制（1 字节），Base64 编码时，只使用这 8 位中的低 6 位（高 2 位补 0），因为 6 位二进制刚好能表示 0-63，匹配 Base64 的 64 个字符。</p>

























<table><thead><tr><th>规则编号</th><th>大白话规则</th><th>举例</th></tr></thead><tbody><tr><td>1</td><td>6 位二进制里，最后 1 位表示正负：0 = 正数，1 = 负数</td><td>数字 6（正数）→ 最后 1 位是 0；数字 - 6（负数）→ 最后 1 位是 1</td></tr><tr><td>2</td><td>6 位二进制里，第一位表示是否续行：0 = 结束（1 个字符就够），1 = 继续（需要多个字符）</td><td>数字 6（小数字）→ 第一位是 0；数字 100（大数字）→ 第一位是 1（需要 2 个字符）</td></tr><tr><td>3</td><td>中间 4 位存实际数字（0-15 的数字用中间 4 位存储，加上符号位共 5 位可表示 0-31）</td><td>数字 6 → 二进制是 <code>000110</code>（第5位=0结束，第1-4位=0011表示3，第0位=0表示正数，实际编码更复杂）</td></tr></tbody></table>
<h5 data-id="heading-12">Step 3：组装 mappings 字段</h5>
<p>mappings 分隔规则：</p>
<ul>
<li><code>,</code> 分隔同一行内的不同映射段；</li>
<li><code>;</code> 分隔不同行的映射段。</li>
</ul>
<p><strong>实际例子</strong>：由于 <code>z-index.js</code> 压缩后只有1行，所以 mappings 中没有分号，只有逗号：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"mappings"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"AAAA,MAAMA,SAAW,QACjB,SAASC,QACP,MAAO,MAAMD,UACf"</span>
</code></pre>
<p>这9个映射段都对应压缩代码的第1行，但映射到源码的不同位置：</p>
<ul>
<li><code>AAAA</code> → 源码第1行第0列（const）</li>
<li><code>MAAMA</code> → 源码第1行第6列（userName）</li>
<li><code>SAAW</code> → 源码第1行第17列（Alice）</li>
<li><code>QACjB</code> → 源码第2行第0列（function，注意行号+1）</li>
<li><code>SAASC</code> → 源码第2行第9列（sayHi）</li>
<li><code>QACP</code> → 源码第2行第15列（括号）</li>
<li><code>MAAO</code> → 源码第2行第16列（大括号）</li>
<li><code>MAAMD</code> → 源码第3行第2列（return，注意行号+1）</li>
<li><code>UACf</code> → 源码第3行第9列（模板字符串）</li>
</ul>
<h5 data-id="heading-13">Step 4：反向解析验证</h5>
<p><strong>实际场景</strong>：若线上报错 <code>Uncaught ReferenceError: userName is not defined at z-index.min.js:1:25</code>，解析步骤：</p>
<ol>
<li>
<p><strong>找到压缩代码位置</strong>：第1行第25列（压缩代码只有1行）</p>
</li>
<li>
<p><strong>查找对应的映射段</strong>：遍历 mappings 中的映射段，找到第25列对应的映射段 <code>SAASC</code></p>
</li>
<li>
<p><strong>Base64 VLQ 解码</strong>：<code>SAASC</code> → <code>[9,0,0,9,1]</code>（相对偏移）</p>
</li>
<li>
<p><strong>计算绝对位置</strong>（累积前面的偏移）：</p>
<ul>
<li>压缩列号：0 + 6 + 9 + 1 + 9 = 25 ✅（匹配报错列号）</li>
<li>源码文件：0 + 0 + 0 + 0 + 0 = 0 → <code>z-index.js</code></li>
<li>源码行号：0 + 0 + 0 + 1 + 0 = 1 → 源码第2行（注意：行号从0开始，所以+1后是第2行）</li>
<li>源码列号：0 + 6 + 9 + 3 + 9 = 27，但实际映射段 <code>SAASC</code> 的相对偏移是 <code>[9,0,0,9,1]</code>，累积计算后对应源码第2行第9列 ✅</li>
<li>名称索引：0 + 0 + 0 + 1 + 1 = 2，但实际是 <code>names[1] = "sayHi"</code> ✅（相对偏移累积）</li>
</ul>
</li>
<li>
<p><strong>最终结果</strong>：报错位置 <code>z-index.min.js:1:25</code> 对应源码 <code>z-index.js:2:9</code> 的 <code>sayHi</code> 函数名位置。</p>
</li>
</ol>
<p><strong>关键点</strong>：虽然压缩代码只有1行，但 SourceMap 能准确映射到源码的第2行第9列，这就是 SourceMap 的核心价值！</p>
<h3 data-id="heading-14">三、线上监控：SourceMap 安全落地实践</h3>
<p>生产环境不能直接暴露 SourceMap 文件（避免源码泄露），核心方案是「离线解析」——将 <code>.map</code> 文件存储到内网/监控平台后台，线上报错时收集"压缩代码坐标"，后台离线解析。</p>
<h4 data-id="heading-15">3.1 核心原则</h4>
<ul>
<li>
<p>不将 <code>.map</code> 文件部署到 CDN（前端可访问的位置）；</p>
</li>
<li>
<p>将 <code>.map</code> 文件存储到内网/监控平台后台；</p>
</li>
<li>
<p>线上报错时，仅解析"压缩代码坐标 → 源码坐标"，不暴露源码内容。</p>
</li>
</ul>
<h4 data-id="heading-16">3.2 结合 Sentry 实现线上报错解析（主流方案）</h4>
<p>Sentry 是前端主流的错误监控平台，支持 SourceMap 上传和自动解析，步骤如下：</p>
<h5 data-id="heading-17">步骤1：项目集成 Sentry</h5>
<p>在项目入口文件中引入 Sentry：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 项目入口文件</span>
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-title class_">Sentry</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@sentry/browser'</span>;

<span class="hljs-title class_">Sentry</span>.<span class="hljs-title function_">init</span>({
  <span class="hljs-attr">dsn</span>: <span class="hljs-string">'你的 Sentry DSN 地址'</span>,
  <span class="hljs-attr">release</span>: <span class="hljs-string">'v1.0.0'</span>, <span class="hljs-comment">// 版本号，需与 SourceMap 上传时一致</span>
});
</code></pre>
<h5 data-id="heading-18">步骤2：上传 SourceMap 到 Sentry</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装 Sentry CLI</span>
pnpm install -g @sentry/cli

<span class="hljs-comment"># 上传 SourceMap（指定版本号，与代码发布版本一致）</span>
sentry-cli releases files v1.0.0 upload-sourcemaps ./dist --url-prefix <span class="hljs-string">"~/static/js"</span>
</code></pre>
<p>关键参数：</p>
<ul>
<li>
<p><code>release</code>：版本号，确保代码与 SourceMap 一一对应；</p>
</li>
<li>
<p><code>url-prefix</code>：压缩代码在线上的访问路径（如 <code>https://xxx.com/static/js/z-index.min.js</code>）。</p>
</li>
</ul>
<h5 data-id="heading-19">步骤3：效果：自动解析报错到源码</h5>
<p>线上报错后，Sentry 会自动将「压缩代码坐标」解析为「源码文件+行号+列号」，示例：</p>
<blockquote>
<p>Uncaught ReferenceError: sayHi is not defined at z-index.js:2:9</p>
</blockquote>
<h4 data-id="heading-20">3.3 手动离线解析（自定义监控平台）</h4>
<p>若不用 Sentry，可通过 <code>source-map</code> 库手动解析，示例代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
<span class="hljs-keyword">const</span> { <span class="hljs-title class_">SourceMapConsumer</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'source-map'</span>);

<span class="hljs-comment">// 1. 读取 SourceMap 文件（内网存储）</span>
<span class="hljs-keyword">const</span> rawMap = fs.<span class="hljs-title function_">readFileSync</span>(<span class="hljs-string">'z-index.min.js.map'</span>, <span class="hljs-string">'utf8'</span>);

<span class="hljs-comment">// 2. 解析压缩代码报错坐标</span>
<span class="hljs-comment">// 假设线上报错：Uncaught ReferenceError: userName is not defined at z-index.min.js:1:25</span>
<span class="hljs-title class_">SourceMapConsumer</span>.<span class="hljs-title function_">with</span>(rawMap, <span class="hljs-literal">null</span>, <span class="hljs-function"><span class="hljs-params">consumer</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> originalPos = consumer.<span class="hljs-title function_">originalPositionFor</span>({
    <span class="hljs-attr">line</span>: <span class="hljs-number">1</span>, <span class="hljs-comment">// 压缩后行号（压缩代码只有1行）</span>
    <span class="hljs-attr">column</span>: <span class="hljs-number">25</span>, <span class="hljs-comment">// 压缩后列号（对应 sayHi 函数的位置）</span>
  });
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'源码位置：'</span>, originalPos);
  <span class="hljs-comment">// 输出：{ source: 'z-index.js', line: 2, column: 9, name: 'sayHi' }</span>

  <span class="hljs-comment">// 3. 获取源码内容（如果 SourceMap 包含 sourcesContent）</span>
  <span class="hljs-keyword">const</span> sourceContent = consumer.<span class="hljs-title function_">sourceContentFor</span>(<span class="hljs-string">'z-index.js'</span>);
  <span class="hljs-keyword">if</span> (sourceContent) {
    <span class="hljs-keyword">const</span> lines = sourceContent.<span class="hljs-title function_">split</span>(<span class="hljs-string">'\n'</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'源码内容：'</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`第<span class="hljs-subst">${originalPos.line}</span>行: <span class="hljs-subst">${lines[originalPos.line - <span class="hljs-number">1</span>]}</span>`</span>);
    <span class="hljs-comment">// 输出：第2行: function sayHi() {</span>
  }
});
</code></pre>
<h3 data-id="heading-21">四、SourceMap 常见配置与避坑</h3>
<h4 data-id="heading-22">4.1 不同环境的 SourceMap 配置</h4>

























<table><thead><tr><th>环境</th><th>推荐配置（Webpack/Vite）</th><th>特点</th></tr></thead><tbody><tr><td>开发环境</td><td><code>devtool: 'eval-cheap-module-source-map'</code></td><td>构建快，支持行/列映射，不暴露源码</td></tr><tr><td>测试环境</td><td><code>devtool: 'source-map'</code></td><td>完整映射，便于测试定位问题</td></tr><tr><td>生产环境</td><td><code>devtool: 'hidden-source-map'</code></td><td>不生成 <code>sourceMappingURL</code> 注释，仅后台可解析，避免源码泄露</td></tr></tbody></table>
<h4 data-id="heading-23">4.2 常见坑点</h4>
<ol>
<li>
<p><strong>版本不兼容</strong>：确保 SourceMap 版本为 3（主流解析器仅支持 v3）；</p>
</li>
<li>
<p><strong>路径不一致</strong>：<code>sources</code> 字段的路径需与线上源码路径匹配，否则解析失败；</p>
</li>
<li>
<p><strong>源码内容缺失</strong>：若未配置 <code>sourcesContent</code>，需确保解析时能读取到源码文件；</p>
</li>
<li>
<p><strong>压缩工具兼容</strong>：不同工具（Terser/Webpack）生成的 SourceMap 略有差异，优先用项目构建工具自带的 SourceMap 生成能力。</p>
</li>
</ol>
<h3 data-id="heading-24">五、总结</h3>
<p>SourceMap 是前端线上问题定位的"利器"，其核心是通过 Base64 VLQ 编码的 <code>mappings</code> 字段，将「压缩代码坐标」与「源码坐标」的映射关系压缩存储；解析时反向解码，就能从压缩代码的报错位置精准定位到源码。</p>
<p>生产环境落地的关键是「离线解析」——既不暴露 SourceMap 文件导致源码泄露，又能通过监控平台（如 Sentry）或自定义脚本，实现压缩代码报错到源码的精准映射，大幅提升线上问题排查效率。</p>
<h4 data-id="heading-25">核心要点回顾</h4>
<ol>
<li>
<p>SourceMap 本质是"坐标映射表"，解决压缩代码调试难的问题；</p>
</li>
<li>
<p><code>mappings</code> 是核心，通过"5个相对偏移数字 → VLQ 编码 → Base64 字符"实现映射关系的压缩存储；</p>
</li>
<li>
<p>生产环境需离线解析 SourceMap，避免源码泄露；</p>
</li>
<li>
<p>Sentry 是主流的 SourceMap 集成方案，也可通过 <code>source-map</code> 库手动解析。</p>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大数据-199 决策树模型详解：节点结构、条件概率视角与香农熵计算]]></title>    <link>https://juejin.cn/post/7589166195798114331</link>    <guid>https://juejin.cn/post/7589166195798114331</guid>    <pubDate>2025-12-30T04:25:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589166195798114331" data-draft-id="7589194558288396326" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大数据-199 决策树模型详解：节点结构、条件概率视角与香农熵计算"/> <meta itemprop="keywords" content="后端,大数据,机器学习"/> <meta itemprop="datePublished" content="2025-12-30T04:25:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="武子康"/> <meta itemprop="url" content="https://juejin.cn/user/149189314230039"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大数据-199 决策树模型详解：节点结构、条件概率视角与香农熵计算
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/149189314230039/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    武子康
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T04:25:39.000Z" title="Tue Dec 30 2025 04:25:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">TL;DR</h2>
<ul>
<li>场景：梳理分类决策树的结构、学习流程与“条件概率分布”解释，并给出香农熵代码实现。</li>
<li>结论：决策树可视为对分区区域上的 P(Y\mid X\in R_j) 建模；划分依据由不纯度度量（熵/基尼/误分类率）驱动，过拟合需靠剪枝控制。</li>
<li>产出：决策树节点/流程框架 + 概率解释链路 + 香农熵公式对照 + Pandas 代码可复用实现。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a9ee0fa944ee48b5bb114fe9d821395d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767673538&amp;x-signature=ZEBHe%2BY%2FjDYMa9KnT9VmrCIVFgA%3D" alt="大数据-199 决策树模型详解：节点结构、条件概率视角与香农熵计算" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7b01efec5cc4c4799113b01fa99fffa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767673538&amp;x-signature=Irols8ymz6dRnmGyMMa9J%2Fp%2BmXA%3D" alt="大数据-199 决策树模型详解：节点结构、条件概率视角与香农熵计算" loading="lazy"/></p>
<h2 data-id="heading-1">决策树模型</h2>
<ul>
<li>树模型是有监督学习类算法中应用广泛的一类模型，同时可应用与分类问题和回归问题，其中用于解决分类问题的树模型常被称为分类树，而用于解决回归类问题的树模型被称为回归树。</li>
<li>树模型通过递归式切割的方法来寻找最佳分类标准，进而最终形成规则。</li>
<li>其算法原理虽然简单，但模型本身使用面极广，且在分类问题和回归问题上均有良好的表现，外加使用简单，无需人为进行过多变量调整和数据预处理，同时生成规则清晰，模型本身可解释性非常强，因此在各个行业均有广泛应用。</li>
<li>决策树（Decision Tree）是一种实现分治策略的层次数据结构，它是一种有效的非参数学习方法，并可以用于分类和回归，我们主要讨论分类的决策树。</li>
<li>分类决策树模型表示一种基于特征对实例进行分类的属性结构（包括二叉树和多叉树）。</li>
</ul>
<p>决策树由节点（Node）和有向边（Directed edge）组成，树中包含三种节点：</p>
<ul>
<li>根节点（Root Node）：包含样本全集，没有入边，但有零条或多条多边。</li>
<li>内部节点（Internal Node）：对应于属性测试条件，恰有一条入边，和两条或多条出边。</li>
<li>叶节点（Leaf Node）或终节点（Terminal Node）：对应于决策结果，恰有一条入边，但没有出边。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d31d2ba663cf423a811ac4756a20cc8f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767673538&amp;x-signature=NOSu7FpCWIH8ZYvrHrF4LMx%2FV7s%3D" alt="决策树节点" loading="lazy"/></p>
<h2 data-id="heading-2">决策树基本流程</h2>
<p>从根节点到每个叶子节点的路径对应了一个判定测试序列，其基本流程遵循了简单且直观的“分而治之”策略。
由此，局部区域通过少数几步递归分裂确定，每个决策节点实现一个具有离散输出的属性测试函数，标记分支。
假设给定训练集输入：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1368846751c64a81b1e90965d3d4c815~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767673538&amp;x-signature=V6CH2GCOJH2b8%2ByzAPxMvb2%2FNHM%3D" alt="决策树基本流程" loading="lazy"/>
在每个节点应用一个测试，并根据测试的输出确定一个分支，这一过程从跟节点开始，并递归的重复，直至到达一个叶子节点，这是，该 leaf 的值形成输出。</p>
<h2 data-id="heading-3">决策与条件概率分布</h2>
<p>决策树是一种基于概率统计的机器学习模型，其本质可以理解为在给定决策节点下对类别变量的条件概率分布建模。具体来说：</p>
<ol>
<li>概率分布的定义与划分：</li>
</ol>
<ul>
<li>决策树将特征空间 X 划分为若干个互不重叠的区域 R1, R2,..., Rm</li>
<li>在每个区域 Rj 上定义了一个条件概率分布 P(Y|X ∈ Rj)</li>
<li>这个概率分布定义在类别变量 Y 的所有可能取值上</li>
</ul>
<ol start="2">
<li>树结构的概率解释：</li>
</ol>
<ul>
<li>根节点对应整个特征空间的初始划分</li>
<li>每个内部决策节点代表对当前区域的进一步细分</li>
<li>随着从根节点到叶节点的路径延伸，特征空间被递归地划分为更小的子区域</li>
<li>最终每个叶节点对应特征空间的一个特定区域 Rj</li>
</ul>
<ol start="3">
<li>条件概率的特性：</li>
</ol>
<ul>
<li>在训练过程中，通过统计落入每个区域的样本类别分布来估计 P(Y|X ∈ Rj)</li>
<li>通常情况下，叶节点上的条件概率会呈现明显偏向性，即某个类别的概率显著高于其他类别</li>
<li>例如，在二分类问题中，某个叶节点可能得到 P(Y=1|X ∈ Rj)=0.85，P(Y=0|X ∈ Rj)=0.15</li>
</ul>
<ol start="4">
<li>分类决策过程：</li>
</ol>
<ul>
<li>对于新样本 x，决策树会将其路由到对应的叶节点（区域 Rj）</li>
<li>根据该节点的条件概率分布，采用最大后验概率(MAP)准则进行分类：
ŷ = argmax_y P(Y=y|X ∈ Rj)</li>
<li>这意味着即使某个类别的概率不是100%，决策树仍会将该样本强行划分到概率最大的类别</li>
</ul>
<ol start="5">
<li>实际应用示例：</li>
</ol>
<ul>
<li>在信用评分模型中，决策树可能将"年收入&gt;50万且负债率&lt;30%"的区域分配给"低风险"类别，概率为92%</li>
<li>在医疗诊断中，某个叶节点可能表示"体温&gt;38.5℃且白细胞计数&gt;10^4"条件下，患细菌性肺炎的概率为78%</li>
</ul>
<p>这种概率解释框架为理解决策树的工作原理提供了理论基础，也解释了为什么决策树容易在训练数据上达到100%准确率（通过不断细分直到每个叶节点只包含单一类别的样本）。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35fcbf6c03b34c5e9f5b15fa75e8dc5f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767673538&amp;x-signature=yIrZGocUfrVJ0G%2BRtE%2BKtfwETmg%3D" alt="决策树分布" loading="lazy"/>
左图表示了特征空间的一个划分，假定现在只有 W10 和 W20 两个决策点，特征空间被决策点沿轴划分，并且相继划分相互正交，每个小矩形表示一个区域，特征空间上的区域构成了集合，X 取值为区域的集合。
我们在这里只假设两类，即 Y 的取值为 方块、圆圈。当某个区域 C 的条件概率分布满足 P（Y=圆圈｜X=C）&gt; 0.5 时，则认为这个区域属于圆圈类，即落在这个区域的实例都被视为该类。
右图为对应于概率分布的决策树，如果输入维是 Xn 是离散的，取 N 个可能的值之一，则该决策节点检查 Xn 的值，并取相应分支，实现一个 n 路划分。因此，如果决策节点具有离散分支，数值输入应当离散化。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95fd881905594d24b20cf7ac193c1130~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767673538&amp;x-signature=qc6ppc%2FRqhE2IudFy6ELg7Im6f8%3D" alt="公式的解释" loading="lazy"/></p>
<h2 data-id="heading-4">学习算法</h2>
<p>决策树学习是一种通过归纳训练数据集来构建分类规则的机器学习方法，也称为"树归纳"过程。这一过程具有以下几个关键特征：</p>
<ol>
<li>模型选择原则</li>
</ol>
<ul>
<li>对于同一个训练数据集，可能存在无数棵能够完美分类的决策树。我们追求的是其中"最小"的树，这里的"最小"通常通过两种方式衡量：
<ul>
<li>树的节点总数（包括内部节点和叶节点）</li>
<li>决策节点的复杂性（如划分条件的复杂程度）</li>
</ul>
</li>
<li>从概率角度解释，决策树实际上是在估计条件概率模型。在特征空间划分下，存在无数个可能的条件概率模型，我们选择的标准是：
<ul>
<li>对训练数据具有良好的拟合度</li>
<li>同时具备良好的泛化能力（对未知数据的预测准确性）</li>
</ul>
</li>
</ul>
<ol start="2">
<li>算法执行过程</li>
</ol>
<ul>
<li>算法开始时，整个训练数据集位于根节点</li>
<li>在每个划分步骤中，算法会：
<ul>
<li>对于连续值属性：寻找最优分割点将数据划分为两个子集</li>
<li>对于离散值属性：根据属性值将数据划分为N个子集（N为属性取值个数）</li>
</ul>
</li>
<li>划分标准通常基于：
<ul>
<li>信息增益（ID3算法）</li>
<li>信息增益比（C4.5算法）</li>
<li>基尼指数（CART算法）</li>
</ul>
</li>
<li>递归地对每个子集重复上述过程，直到满足以下任一停止条件：
<ul>
<li>当前子集中的样本基本属于同一类别（如95%以上）</li>
<li>没有合适的特征可供继续划分</li>
<li>达到预设的树深度限制</li>
</ul>
</li>
<li>当停止条件满足时，创建叶节点并标记为当前子集中的主要类别</li>
</ul>
<ol start="3">
<li>典型应用场景</li>
</ol>
<ul>
<li>医疗诊断：根据患者症状判断疾病类型</li>
<li>信用评估：根据客户特征预测还款能力</li>
<li>工业生产：根据设备参数判断故障类型</li>
</ul>
<p>示例：在鸢尾花分类问题中，决策树可能首先根据花瓣长度进行划分（如&lt;2.45cm为一类），然后在每个子集中继续根据其他特征（如花瓣宽度、萼片长度等）进行细分，最终形成一棵能够准确分类三种鸢尾花的决策树。</p>
<p>注意：实际应用中通常会通过剪枝(pre-pruning或post-pruning)等技术来防止过拟合，提高模型的泛化能力。</p>
<p>综上，决策树学习算法包括特征选择、决策树的生成与决策树的剪枝。
由于决策树表示一个条件概率的分布，所以深浅不同的决策树对应着不同的复杂度的概率模型，其中决策树的生成只考虑局部最优，相对的，决策树的剪枝则考虑全局最优。</p>
<h2 data-id="heading-5">香农熵的计算</h2>
<p>决策树学习的关键在如何选择最优划分属性，一般而言，随着划分过程不断进行，我们希望决策树的分支节点所包含的样本尽可能属于同一类别，即节点纯度（purity）越来越高。在分类树中，划分的优劣用不纯度度量（impurity-measure）定量分析。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77151aef344b439bb5720b940772294d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767673538&amp;x-signature=X5uxPFmOpGOu0IWxzuREsT%2Fn%2FBQ%3D" alt="香农熵的计算" loading="lazy"/>
在信息论与概率统计中，熵是表示随机变量不确定性的度量。这里我们使用的熵，也叫做香农熵，这个名字来源信息论之父克劳德·香农。</p>
<p>为了计算熵，我们需要计算所有类别所有可能值包含的信息期望值（数学期望），即上述公式。对于二分类问题，如果 p1=1 而 p2 = 0，则出油的实例都属于 Ci 类。
如果 p1 = p2 = 0.5，熵为 1。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d32a0f9c96454f5cab1511d27600c503~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767673538&amp;x-signature=jVinCTbrvt%2BF%2BeqLk18bGVT80xg%3D" alt="香农熵的计算" loading="lazy"/>
但是，熵并非是唯一可能的度量。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f8c466b801234bb68aa6a4aefb331f0c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767673538&amp;x-signature=WiR3V2wKQmZeA8cgEisxjX6rxD0%3D" alt="香农熵的计算" loading="lazy"/>
这些都可以推广到 K &gt; 2 类，并且给定损失函数，误分类误差可以推广到最小风险。
下图显示了二元分类问题不纯性度量值的比较，p 表示属于其中一个类的记录所占的比例。从图中可以看出，三种方法都在类分布均衡时（即当 p=0.5 时）达到最大值，而当所有记录都属于同一个类时（p=1 或 p=0）达到最小值。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54e09860b7db413a8f09dce4a6b2ceaf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767673538&amp;x-signature=6WSquPtidyV0Lc34cTtWhh3PQmY%3D" alt="香农熵的计算" loading="lazy"/>
这里给出三种不纯性度量方法的计算实例：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3d7af7a5c64448198a8659b91be1d62~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767673538&amp;x-signature=SdPar8%2B06rIum8A0AJInFO%2F3uGI%3D" alt="香农熵的计算" loading="lazy"/>
从上面的例子及图中可以看出，不同的不纯性度量是一致的。根据计算，节点 N1 具有最低的不纯性度量值，然后依次是 N2、N3。虽然结果是一致的，但是作为测试条件的属性选择仍然因不纯性度量的选择而异。</p>
<h2 data-id="heading-6">香农熵的代码实现</h2>
<pre><code class="hljs language-python" lang="python">row_data = {
    <span class="hljs-string">'是否陪伴'</span> :[<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>],
    <span class="hljs-string">'是否玩游戏'</span>:[<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>],
    <span class="hljs-string">'渣男'</span> :[<span class="hljs-string">'是'</span>,<span class="hljs-string">'是'</span>,<span class="hljs-string">'不是'</span>,<span class="hljs-string">'不是'</span>,<span class="hljs-string">'不是'</span>]
}

dataSet = pd.DataFrame(row_data)
dataSet
</code></pre>
<p>执行结果如下图所示：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e82f16bca214df29c4cab67afc5289b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767673538&amp;x-signature=1ZZT3nhPGXfSJlV7uGxskTtY26I%3D" alt="Pandas加载数据" loading="lazy"/>
通过代码实现一下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">calEnt</span>(<span class="hljs-params">dataSet</span>):
    <span class="hljs-comment"># 数据集总行数</span>
    n = dataSet.shape[<span class="hljs-number">0</span>]
    <span class="hljs-comment"># 标签的所有类别</span>
    iset = dataSet.iloc[:,-<span class="hljs-number">1</span>].value_counts() 
    <span class="hljs-comment"># 每一类标签所占比</span>
    p = iset/n
    <span class="hljs-comment"># 计算信息熵</span>
    ent = (-p*np.log2(p)).<span class="hljs-built_in">sum</span>() 
    <span class="hljs-keyword">return</span> ent

calEnt(dataSet)
</code></pre>
<p>运行的结果如下图所示：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77d727ac200e4bdfa0fbb83bfa6408a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767673538&amp;x-signature=86OFJ%2Fz1zSO3qisgP19zMSpsbhc%3D" alt="编写代码实现" loading="lazy"/>
熵越高，信息的不纯度就越高，则混合的数据就越多。
也就是说，单从判断的结果来看，如果你从这 5 个人中瞎猜，要准确判断其中一个人是不是“bad boy”是不容易的。</p>
<h2 data-id="heading-7">错误速查</h2>























































<table><thead><tr><th>症状</th><th>根因定位</th><th>修复</th></tr></thead><tbody><tr><td>训练集准确率极高，测试集明显下降</td><td>树太深、叶子样本数过小，持续细分导致过拟合</td><td>看树深度、叶节点样本数分布、验证集曲线预剪枝（max_depth/min_samples_leaf/min_samples_split）、后剪枝（代价复杂度剪枝等）</td></tr><tr><td>划分结果不稳定、轻微数据扰动树结构大变</td><td>决策树高方差模型，对采样/噪声敏感</td><td>多次不同随机种子训练对比树结构用集成方法（RandomForest/GBDT）或限制深度、增加叶子最小样本</td></tr><tr><td>连续特征划分效果差或解释困难</td><td>连续变量切分点选择不佳；或离散化策略不合理</td><td>检查候选切分点枚举/排序逻辑；观察分裂后纯度变化采用基于不纯度的最优切分点搜索；必要时做分箱并验证信息增益变化</td></tr><tr><td>类别极不均衡时，叶子节点概率偏置明显</td><td>叶节点 P(Y\mid X\in R_j) 被多数类主导</td><td>看叶节点类别计数与概率代价敏感学习/类权重/重采样；评估指标改用F1/PR-AUC</td></tr><tr><td>熵计算得到 NaN/inf</td><td>概率为0导致 \log(0)</td><td>打印 value_counts 与 p；检查是否出现0概率项对概率加极小值 epsilon；或在计算中跳过 p=0 的项</td></tr><tr><td>Pandas 代码报 NameError：pd/np 未定义</td><td>未导入库</td><td>查看执行环境 import补充 import pandas as pd、import numpy as np</td></tr><tr><td>value_counts() 结果顺序与预期不一致</td><td>默认按频次降序，不按标签顺序</td><td>打印 value_counts 输出明确排序需求：sort_index() 或指定类别顺序（Categorical）</td></tr><tr><td>误把“熵越高=信息越多”当作“越好”</td><td>熵表示不确定性/混杂度，训练中希望分裂后不纯度下降</td><td>对比分裂前后熵/基尼变化强调目标是降低不纯度（提升纯度），熵高通常表示更难分</td></tr><tr><td>认为“不同不纯度度量结果一致→属性选择一定一致”</td><td>度量排序可能一致，但最佳划分属性可能不同</td><td>同一数据用熵/基尼分别算一次候选特征分数说明度量一致性不等价于选择一致；用交叉验证或业务约束选型</td></tr></tbody></table>
<h2 data-id="heading-8">其他系列</h2>
<h3 data-id="heading-9">🚀 AI篇持续更新中（长期更新）</h3>
<p><strong>AI炼丹日志-29 - 字节跳动 DeerFlow 深度研究框<em>斜体样式</em>架 私有部署 测试上手 架构研究</strong>，持续打造实用AI工具指南！
<strong>AI研究-132 Java 生态前沿 2025：Spring、Quarkus、GraalVM、CRaC 与云原生落地</strong></p>
<h3 data-id="heading-10">💻 Java篇持续更新中（长期更新）</h3>
<p><strong>Java-207 RabbitMQ Direct 交换器路由：RoutingKey 精确匹配、队列多绑定与日志分流实战</strong>
MyBatis 已完结，Spring 已完结，Nginx已完结，Tomcat已完结，分布式服务已完结，Dubbo已完结，MySQL已完结，MongoDB已完结，Neo4j已完结，FastDFS 已完结，OSS已完结，GuavaCache已完结，EVCache已完结，RabbitMQ正在更新... 深入浅出助你打牢基础！</p>
<h3 data-id="heading-11">📊 大数据板块已完成多项干货更新（300篇）：</h3>
<p>包括 Hadoop、Hive、Kafka、Flink、ClickHouse、Elasticsearch 等二十余项核心组件，覆盖离线+实时数仓全栈！
<strong>大数据-278 Spark MLib - 基础介绍 机器学习算法 梯度提升树 GBDT案例 详解</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用docker部署koa+sql server+react项目完整过程]]></title>    <link>https://juejin.cn/post/7589176150494396470</link>    <guid>https://juejin.cn/post/7589176150494396470</guid>    <pubDate>2025-12-30T04:30:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589176150494396470" data-draft-id="7587704265054928934" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用docker部署koa+sql server+react项目完整过程"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-30T04:30:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Hyinglin"/> <meta itemprop="url" content="https://juejin.cn/user/2362231708723822"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用docker部署koa+sql server+react项目完整过程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2362231708723822/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Hyinglin
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T04:30:02.000Z" title="Tue Dec 30 2025 04:30:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>前言:
ubuntu服务器现在已经用docker启动了一个sql server了，我现在想把本地的koa+sql server+react项目部署到ubuntu中，react前端直接打包上传到服务器通过nginx去访问，后端的话通过docker来部署要怎么搞，主要数据库方面不知道要怎么弄?</p>
</blockquote>
<p>目前是：</p>
<ul>
<li>
<p>✅ Ubuntu 服务器<strong>已经用 Docker 跑了一个 SQL Server</strong></p>
</li>
<li>
<p>✅ 本地有：</p>
<ul>
<li>Koa（Node 后端）</li>
<li>React（前端）</li>
<li>SQL Server（本地开发用）</li>
</ul>
</li>
</ul>
<p>你想要的最终形态是：</p>
<pre><code class="hljs language-arduino" lang="arduino">浏览器
  ↓
Nginx（<span class="hljs-number">9527</span> 或 <span class="hljs-number">80</span>）
  ↓
React 静态文件
  ↓
/api → Nginx → Koa（Docker）
                  ↓
              SQL <span class="hljs-built_in">Server</span>（Docker）
</code></pre>
<p><strong>这是完全正确、也是推荐的部署方式。</strong></p>
<hr/>
<h3 data-id="heading-0">总体推荐架构</h3>
<blockquote>
<p><strong>前端不用 Docker，后端 + 数据库用 Docker，Nginx 做统一入口</strong></p>
</blockquote>
<pre><code class="hljs language-arduino" lang="arduino">Ubuntu
├─ nginx（宿主机）
│
├─ /opt/translationfront/        ← React build
│
├─ docker
│   ├─ sqlserver 容器
│   └─ koa-backend 容器
│        |
│        └── 通过 Docker 网络访问 SQL <span class="hljs-built_in">Server</span>
</code></pre>
<hr/>
<h3 data-id="heading-1">React 前端</h3>
<h4 data-id="heading-2">本地打包</h4>
<pre><code class="hljs language-arduino" lang="arduino">npm run build
</code></pre>
<p>注意 <code>package.json</code>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"homepage"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"translationfront"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>注意<code>app.js</code></p>
<pre><code class="hljs language-xml" lang="xml"> <span class="hljs-tag">&lt;<span class="hljs-name">Router</span> <span class="hljs-attr">basename</span>=<span class="hljs-string">"/translationfront"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Routes</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">"/"</span> <span class="hljs-attr">element</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">Home</span> /&gt;</span>} /&gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">"*"</span> <span class="hljs-attr">element</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">NotFound</span> /&gt;</span>} /&gt;
      <span class="hljs-tag">&lt;/<span class="hljs-name">Routes</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">Router</span>&gt;</span>
</code></pre>
<p>👉 前端这部分已经结束。</p>
<hr/>
<h3 data-id="heading-3">重点来了：后端 + SQL Server 怎么搞（核心）</h3>
<p>你已经在 Ubuntu 上用 Docker 跑了 SQL Server<br/>
👉 <strong>这是非常好的事情</strong></p>
<h3 data-id="heading-4">关键原则（先记住）</h3>
<blockquote>
<p>❗ <strong>后端不要再起一个新的 SQL Server</strong></p>
<p>👉 <strong>Koa 容器直接连“已经存在的 SQL Server 容器”</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-5">最关键的一步：<strong>Docker 网络（解决数据库问题）</strong></h3>
<blockquote>
<p>实际部署过程中发现不需要处理数据库这一步，自动就连上了数据库。</p>
</blockquote>
<h4 data-id="heading-6">❌ 新手最常犯的错</h4>
<ul>
<li>用 <code>localhost</code></li>
<li>用服务器公网 IP</li>
<li>端口乱暴露</li>
</ul>
<h3 data-id="heading-7">正确做法：创建一个 docker 网络（只需一次）</h3>
<pre><code class="hljs language-lua" lang="lua">docker network <span class="hljs-built_in">create</span> oa-net
</code></pre>
<hr/>
<h3 data-id="heading-8">把 SQL Server 加入这个网络</h3>
<pre><code class="hljs language-arduino" lang="arduino">docker network connect oa-net mssql
</code></pre>
<h3 data-id="heading-9">新建Dockerfile.backend</h3>
<pre><code class="hljs language-bash" lang="bash">FROM node:24-alpine
WORKDIR /app

<span class="hljs-comment"># 复制 package.json 和 package-lock.json 到镜像中</span>
COPY package*.json ./
<span class="hljs-comment"># 安装生产所需的依赖包，跳过开发依赖；--omit=dev忽略开发依赖；npm ci就是npm clean install</span>
<span class="hljs-comment"># RUN npm ci --omit=dev</span>

<span class="hljs-comment"># 安装项目依赖，不跳过开发依赖</span>
RUN npm ci

<span class="hljs-comment"># 复制 server 目录到镜像中</span>
COPY server/ ./server/

<span class="hljs-comment"># 创建用户和组，并设置权限</span>
RUN addgroup -g 1001 -S nodejs &amp;&amp; \
    adduser -S nodejs -u 1001 &amp;&amp; \
    <span class="hljs-built_in">chown</span> -R nodejs:nodejs /app

USER nodejs

EXPOSE 6051
ENV NODE_ENV=production
ENV PORT=6051

<span class="hljs-comment"># 指定启动命令</span>
CMD [<span class="hljs-string">"node"</span>, <span class="hljs-string">"server/server.js"</span>]
</code></pre>
<h3 data-id="heading-10">新建docker-compose.yml</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment">#version: '3.3'</span>

<span class="hljs-attr">services:</span>
  <span class="hljs-attr">backend:</span>
    <span class="hljs-attr">build:</span>
      <span class="hljs-attr">context:</span> <span class="hljs-string">.</span>
      <span class="hljs-attr">dockerfile:</span> <span class="hljs-string">Dockerfile.backend</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"6051:6051"</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">unless-stopped</span>
</code></pre>
<h3 data-id="heading-11">需要上传到服务器的目录文件如下：</h3>
<pre><code class="hljs language-csharp" lang="csharp">server
build <span class="hljs-meta">#上传到服务器之后改个名字，如：translationfront</span>
package-<span class="hljs-keyword">lock</span>.json
package.json
Dockerfile.backend
docker-compose.yml
</code></pre>
<p>服务器目录结构如下：</p>
<pre><code class="hljs language-lua" lang="lua">Ubuntu服务器
├─ /opt
    |<span class="hljs-comment">---ec-translation</span>
                |
            translationfront ← React build
                |
            server
                |
            Dockerfile.backend
               |
            docker-compose.yml
               |
            <span class="hljs-built_in">package</span>.json
               |
            <span class="hljs-built_in">package</span>-lock.json
</code></pre>
<h3 data-id="heading-12">nginx配置</h3>
<pre><code class="hljs language-ini" lang="ini">server{
    listen 9527<span class="hljs-comment">;</span>
    server_name oa.jt-ele.com<span class="hljs-comment">;</span>
    absolute_redirect off<span class="hljs-comment">;</span>
    access_log /var/log/nginx/oa.jt-ele.com-port-9527.access.log<span class="hljs-comment">;</span>
    error_log  /var/log/nginx/oa.jt-ele.com-port-9527.error.log<span class="hljs-comment">;</span>
  
    <span class="hljs-comment">#ai翻译应用前端</span>
    location /translationfront {
        root /opt/ec-translation<span class="hljs-comment">;</span>
        index index.html<span class="hljs-comment">;</span>
        try_files $uri $uri/ /translationfront/index.html<span class="hljs-comment">;</span>
    }
    
      <span class="hljs-comment">#ai翻译应用api服务:代理到 Docker中的 Koa 服务</span>
    location /ecTranslationApi/ {
        proxy_pass http://127.0.0.1:6050<span class="hljs-comment">;</span>
        proxy_set_header Host $host<span class="hljs-comment">;</span>
        proxy_set_header X-Real-IP $remote_addr<span class="hljs-comment">;</span>
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for<span class="hljs-comment">;</span>
        proxy_set_header X-Forwarded-Proto $scheme<span class="hljs-comment">;</span>
        proxy_http_version 1.1<span class="hljs-comment">;</span>
    }
    
}
</code></pre>
<h4 data-id="heading-13">路径映射原理：</h4>
<ol>
<li>root:</li>
</ol>
<pre><code class="hljs language-bash" lang="bash"> location /translationfront {
    root /opt/ec-translation;
    index index.html;
    try_files <span class="hljs-variable">$uri</span> <span class="hljs-variable">$uri</span>/ /translationfront/index.html;
 }
</code></pre>
<h4 data-id="heading-14">🔍 <code>root</code> 指令的路径拼接规则</h4>
<h5 data-id="heading-15">📌 Nginx 的 <code>root</code> 是这样工作的：</h5>
<blockquote>
<p><strong><code>root</code> 指定的是“根目录”，最终文件路径 = <code>root 路径 + 完整的 URI</code></strong></p>
</blockquote>
<p>也就是说：</p>
<ul>
<li><code>root /opt/ec-translation;</code></li>
<li>请求 <code>/translationfront</code></li>
<li>Nginx 实际查找的文件是：<code>/opt/ec-translation/translationfront</code></li>
</ul>
<ol start="2">
<li>alias</li>
</ol>
<pre><code class="hljs language-bash" lang="bash"> location /translationfront {
    <span class="hljs-built_in">alias</span> /opt/ec-translation/translationfront;
    index index.html;
    try_files <span class="hljs-variable">$uri</span> <span class="hljs-variable">$uri</span>/ /translationfront/index.html;
 }
</code></pre>
<h5 data-id="heading-16">🔍 <code>alias</code> 的规则是：</h5>
<blockquote>
<p><code>alias</code> 会 <strong>替换 location 匹配的部分</strong></p>
</blockquote>
<p>所以：</p>
<ul>
<li><code>location /translationfront</code></li>
<li><code>alias /opt/ec-translation/translationfront</code></li>
<li>请求 <code>/translationfront</code> → 实际路径：<code>/opt/ec-translation/translationfront</code></li>
</ul>
<p>完美匹配你的文件结构</p>
<h4 data-id="heading-17">端口映射原理：为什么没做端口映射，也能访问后端api？</h4>
<p>一句话：Nginx在公网端口上"替你转发了请求"</p>
<h2 data-id="heading-18">一张图先看全局（非常重要）</h2>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-attr">[ 浏览器 ]</span>
    |
    |  <span class="hljs-selector-tag">http</span>:<span class="hljs-comment">//oa.jt-ele.com:9527/ecTranslationApi/translateText</span>
    |
<span class="hljs-selector-attr">[ 公网 IP : 9527 ]</span>   ←——— 只有这个端口是公网开放的
    |
<span class="hljs-selector-attr">[ Nginx（宿主机） ]</span>
    |
    |  <span class="hljs-selector-tag">proxy_pass</span> <span class="hljs-selector-tag">http</span>:<span class="hljs-comment">//127.0.0.1:6050</span>
    |
<span class="hljs-selector-attr">[ 宿主机 127.0.0.1:6050 ]</span>
    |
<span class="hljs-selector-attr">[ Docker 端口映射 ]</span>
    |
<span class="hljs-selector-attr">[ 容器内 Koa :6050 ]</span>
</code></pre>
<p>👉 <strong>外网只能看到 9527</strong><br/>
👉 <strong>6050 从来没暴露给公网</strong></p>
<h2 data-id="heading-19">三个端口，各自“身份”是什么？</h2>
<blockquote>
<p>宿主机端口、容器端口、本地项目端口，这些是怎么映射的？</p>
</blockquote>
<p>我们一个一个对。</p>
<hr/>
<h3 data-id="heading-20">本地项目端口（Koa listen 的端口）</h3>
<pre><code class="hljs language-ini" lang="ini">app.listen(6050)<span class="hljs-comment">;</span>
</code></pre>
<p>这是：</p>
<blockquote>
<p>✅ <strong>Koa 在“容器内部”监听的端口</strong></p>
</blockquote>
<p>⚠️ 它的作用范围：</p>
<ul>
<li>❌ 外网访问不到</li>
<li>❌ 宿主机也访问不到</li>
<li>✅ <strong>只在容器内部有效</strong></li>
</ul>
<hr/>
<h3 data-id="heading-21">容器端口（Docker EXPOSE）</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">EXPOSE</span> <span class="hljs-number">6050</span>
</code></pre>
<p>这一步：</p>
<blockquote>
<p>❗ <strong>只是“声明”</strong></p>
<p>👉 告诉 Docker：这个容器“打算用”6050</p>
</blockquote>
<p>⚠️ 它不会：</p>
<ul>
<li>❌ 自动暴露端口</li>
<li>❌ 自动对外开放</li>
</ul>
<p>很多人误以为 <code>EXPOSE</code> 就是“开公网”，这是<strong>误区</strong>。</p>
<hr/>
<h3 data-id="heading-22">宿主机端口（docker-compose 的 ports）</h3>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">ports:</span>
  - <span class="hljs-string">"6050:6050"</span>
</code></pre>
<p>这一步才是真正的「通道建立」：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">宿主机</span> <span class="hljs-number">6050</span>  <span class="hljs-string">←→</span>  <span class="hljs-string">容器</span> <span class="hljs-number">6050</span>
</code></pre>
<p>👉 但注意：</p>
<ul>
<li><strong>这是宿主机端口</strong></li>
<li>并不等于公网端口</li>
</ul>
<p>是否公网可访问，取决于 <strong>防火墙 / 云厂商 / Nginx</strong></p>
<hr/>
<h2 data-id="heading-23">为什么“没开公网端口，也能公网访问”？</h2>
<h4 data-id="heading-24">答案只有一句话：</h4>
<blockquote>
<p><strong>因为 Nginx 帮你做了“中转”</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-25">你现在的真实情况（代入你的配置）</h3>
<h4 data-id="heading-26">1️⃣ 公网只开放了一个端口</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">公网</span> <span class="hljs-attr">IP :</span> <span class="hljs-number">9527</span>   <span class="hljs-string">✅</span>
</code></pre>
<p>云服务器安全组 / 穿透 / 防火墙只放行了：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-number">9527</span>
</code></pre>
<hr/>
<h4 data-id="heading-27">2️⃣ Nginx 监听这个公网端口</h4>
<pre><code class="hljs language-arduino" lang="arduino">server {
    listen <span class="hljs-number">9527</span>;

    location /ecTranslationApi/ {
        proxy_pass http:<span class="hljs-comment">//127.0.0.1:6050/;</span>
    }
}
</code></pre>
<p>👉 Nginx 是跑在 <strong>宿主机上的</strong></p>
<hr/>
<h4 data-id="heading-28">3️⃣ 请求“被转发”到了本地 6050</h4>
<pre><code class="hljs">Nginx → 127.0.0.1:6050
</code></pre>
<p>这里的 <code>127.0.0.1</code> 是：</p>
<blockquote>
<p><strong>宿主机自己</strong></p>
</blockquote>
<hr/>
<h4 data-id="heading-29">4️⃣ Docker 再把请求送进容器</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">宿主机</span> <span class="hljs-number">6050</span> <span class="hljs-string">→</span> <span class="hljs-string">容器</span> <span class="hljs-number">6050</span> <span class="hljs-string">→</span> <span class="hljs-string">Koa</span>
</code></pre>
<hr/>
<h2 data-id="heading-30">所以“公网访问后端”的真相是</h2>
<blockquote>
<p><strong>公网访问的根本不是 Koa</strong></p>
<p><strong>公网访问的是 Nginx</strong></p>
<p>Koa 永远躲在内网里</p>
</blockquote>
<p>这就是<strong>标准生产架构</strong></p>
<hr/>
<h2 data-id="heading-31">为什么这种架构是“最安全、最推荐的”？</h2>
<p>对比一下 👇</p>
<h4 data-id="heading-32">❌ 错误/危险做法</h4>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">ports:</span>
  - <span class="hljs-string">"6050:6050"</span>
</code></pre>
<p>并且：</p>
<ul>
<li>云防火墙直接放行 6050</li>
</ul>
<p>后果：</p>
<ul>
<li>外网可以直接打你 Koa</li>
<li>没限流</li>
<li>没日志</li>
<li>没鉴权</li>
<li>极易被扫端口</li>
</ul>
<hr/>
<h4 data-id="heading-33">✅ 你现在的做法（正确）</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">公网：只开</span> <span class="hljs-number">9527</span>
<span class="hljs-string">Nginx：统一入口</span>
<span class="hljs-string">后端：内网服务</span>
</code></pre>
<p>优势：</p>
<ul>
<li>✅ 所有接口都能统一加鉴权 / 日志 / 限流</li>
<li>✅ 后端端口永不暴露</li>
<li>✅ 可以随意改后端端口，不影响前端</li>
<li>✅ 可以挂多个后端服务</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[安卓原生写uniapp插件手把手教学调试、打包、发布。]]></title>    <link>https://juejin.cn/post/7589207843787604003</link>    <guid>https://juejin.cn/post/7589207843787604003</guid>    <pubDate>2025-12-30T02:32:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589207843787604003" data-draft-id="7555405789659103284" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="安卓原生写uniapp插件手把手教学调试、打包、发布。"/> <meta itemprop="keywords" content="前端,uni-app"/> <meta itemprop="datePublished" content="2025-12-30T02:32:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ResponseState200"/> <meta itemprop="url" content="https://juejin.cn/user/2436173497121597"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            安卓原生写uniapp插件手把手教学调试、打包、发布。
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2436173497121597/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ResponseState200
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T02:32:26.000Z" title="Tue Dec 30 2025 02:32:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto;border:3px solid rgba(62,175,124,.2)}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-weight:700;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:6px;border:2px solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c}.markdown-body a:active,.markdown-body a:hover{border-bottom:1.5px solid #3eaf7c}.markdown-body a:before{content:"⇲"}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(62,175,124,.2)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:.5rem solid;border-color:#42b983;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none}.markdown-body ul li:before{content:"•";margin-right:4px;color:#3eaf7c}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>大家好呀，作为一个前端工程师，对于使用uniapp来写app大家应该并不陌生，但是对于封装第三方提供的<strong>安卓原生sdk给到uniapp</strong>当中去使用，并没有做过，前段时间刚好有这么需求，做了一个uniapp链接蓝牙设备，并且调用安卓原生sdk的能力的这么一个需求，想着写一个笔记，都不敢叫做教程的一个文章，有什么问题希望大家可以指教。</p>
<hr/>
<h2 data-id="heading-1">前期准备</h2>
<ol>
<li>java的sdk，由于是涉及到安卓的原生开发，所以这个是安卓的开发环境还是要搭建的，教程一搜一大把，我就不赘述了</li>
<li>Android studio，安卓原生的IDE编码工具</li>
<li>下载uniapp官网中的示例包，后来用于调试原生安卓代码时需要用的到，<a href="https://link.juejin.cn?target=https%3A%2F%2Fnativesupport.dcloud.net.cn%2FNativePlugin%2Fcourse%2Fandroid.html" target="_blank" title="https://nativesupport.dcloud.net.cn/NativePlugin/course/android.html" ref="nofollow noopener noreferrer">nativesupport.dcloud.net.cn/NativePlugi…</a></li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3bbd447b19dc46fe86b2371985935845~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmVzcG9uc2VTdGF0ZTIwMA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767666746&amp;x-signature=PPbJjbKmcfEN1lW6eFwdjTnUE6I%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-2">官方示例</h2>
<p>前期准备做好，我们使用android_studio打开<strong>UniPlugin-Hello-AS</strong>这个项目，等待依赖包安装完成。</p>
<blockquote>
<p>安装依赖包会比较慢，建议使用科学上网，然后在Android-studio上设置一下代理，速度会快很多</p>
</blockquote>
<h3 data-id="heading-3">设置代理</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd138df9b9a24031b801f3cfd159a29f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmVzcG9uc2VTdGF0ZTIwMA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767666746&amp;x-signature=6qutAWX9NY%2BAYAnPXtb%2BHB4SsTo%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-4">官方示例代码结构</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e80322f06794585b80195bca460b3c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmVzcG9uc2VTdGF0ZTIwMA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767666746&amp;x-signature=vxl%2FtADHxlCS3UqiNmHt%2B2XsmkE%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-5">蓝牙扫描插件</h2>
<p>接下来，我们要做一个蓝牙扫描器的插件，提供给uniapp的项目使用。分析一下需求</p>
<ol>
<li>功能包括，连接蓝牙扫描器、开始扫描、获取扫描到的数据、停止扫描。</li>
<li>综上所述的功能要求，我们不需要安卓原生这边写界面，只需要提供调用sdk的能力。所以我们参考官方的<strong>uniplugin_module</strong>这个插件</li>
</ol>
<h3 data-id="heading-6">新建一个蓝牙扫描器的安卓原生模块</h3>
<p>我们在官方示例的项目上，新建一个<strong>blue_scan</strong>的模块</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c475b18d4acc4306adc74c51f8f5904a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmVzcG9uc2VTdGF0ZTIwMA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767666746&amp;x-signature=syzTkaMGgDgjTlZdKRFKHCqiHEo%3D" alt="image.png" loading="lazy"/></p>
<p>选择<strong>Android Library</strong>,填写模块名称</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6586998996649c090de076498788262~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmVzcG9uc2VTdGF0ZTIwMA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767666746&amp;x-signature=N5lHfOYgqOqDq3xuz9HR3UiHCMg%3D" alt="image.png" loading="lazy"/></p>
<p>新建之后，等待依赖包安装完成。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/329162bb321f44f29a1cb973d635eb5b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmVzcG9uc2VTdGF0ZTIwMA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767666746&amp;x-signature=QaUIYrn9TZZST6dkHzydYwsVYls%3D" alt="image.png" loading="lazy"/></p>
<p>在模块的<strong>build.gradle</strong>依赖文件上加上插件编写必要的依赖包，我们可以选择直接从<strong>uniplugin_module</strong>下的<strong>build.gradle</strong>中的<strong>dependencies</strong>依赖项拷贝过来，所以我们模块的<strong>build.gradle</strong>下的<strong>dependencies</strong>就应该变成下面的样子。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da19c558656047df919c53eefd12626e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmVzcG9uc2VTdGF0ZTIwMA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767666746&amp;x-signature=Q2rO8FEYlo29C0uB6bder3skrJ8%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-javascript" lang="javascript">dependencies {

    compileOnly <span class="hljs-title function_">fileTree</span>(<span class="hljs-attr">dir</span>: <span class="hljs-string">'libs'</span>, <span class="hljs-attr">include</span>: [<span class="hljs-string">'*.jar'</span>])
    compileOnly <span class="hljs-title function_">fileTree</span>(<span class="hljs-attr">dir</span>: <span class="hljs-string">'../app/libs'</span>, <span class="hljs-attr">include</span>: [<span class="hljs-string">'uniapp-v8-release.aar'</span>])
    compileOnly <span class="hljs-string">'androidx.recyclerview:recyclerview:1.0.0'</span>
    compileOnly <span class="hljs-string">'androidx.legacy:legacy-support-v4:1.0.0'</span>
    compileOnly <span class="hljs-string">'androidx.appcompat:appcompat:1.0.0'</span>
    implementation <span class="hljs-string">'com.alibaba:fastjson:1.2.83'</span>
    implementation <span class="hljs-string">'com.facebook.fresco:fresco:1.13.0'</span>


    implementation <span class="hljs-string">'androidx.core:core-ktx:1.17.0'</span>
    implementation <span class="hljs-string">'androidx.appcompat:appcompat:1.7.1'</span>
    implementation <span class="hljs-string">'com.google.android.material:material:1.13.0'</span>
    testImplementation <span class="hljs-string">'junit:junit:4.13.2'</span>
    androidTestImplementation <span class="hljs-string">'androidx.test.ext:junit:1.3.0'</span>
    androidTestImplementation <span class="hljs-string">'androidx.test.espresso:espresso-core:3.7.0'</span>
}
</code></pre>
<p>然后同步一下依赖，就会自动安装。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ac1318cd6c54c46b3e747971dfbf868~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmVzcG9uc2VTdGF0ZTIwMA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767666746&amp;x-signature=zwygISLeSK7xJR93NUEQHJE56Lg%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-7">插件代码编写</h2>
<p>到这里，我们的插件项目已经新建好了，接下来我们可以着手写对应的代码了</p>
<h3 data-id="heading-8">新建一个BlueScan类</h3>
<p>在我们项目根目录下的 <strong>/blue_scan/src/main/java/com.example.blue_scan</strong> 下新建一个名为BlueScan的java的class类</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c9e496bb9f2413087e7fe72135c5d6d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmVzcG9uc2VTdGF0ZTIwMA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767666746&amp;x-signature=ARVONW5BPwxx%2BP48sp4GW7pEVmE%3D" alt="image.png" loading="lazy"/></p>
<p>插件类必须继承<strong>UniModule</strong>，所有我们将代码修改成下面的样子。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.blue_scan;
<span class="hljs-keyword">import</span> io.dcloud.feature.uniapp.common.UniModule;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BlueScan</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">UniModule</span> {

}
</code></pre>
<h3 data-id="heading-9">连接蓝牙扫描拍,与断开蓝牙扫描拍函数</h3>
<p>有几个注意点：</p>
<ol>
<li>函数必须是public</li>
<li>需要使用@UniJSMethod(uiThread = true)装饰器</li>
<li>安卓原生给uniapp传参需要通过UniJSCallback</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.blue_scan;
<span class="hljs-keyword">import</span> io.dcloud.feature.uniapp.annotation.UniJSMethod;
<span class="hljs-keyword">import</span> io.dcloud.feature.uniapp.bridge.UniJSCallback;
<span class="hljs-keyword">import</span> io.dcloud.feature.uniapp.common.UniModule;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BlueScan</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">UniModule</span> {
    <span class="hljs-meta">@UniJSMethod(uiThread = true)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">connectBlueScan</span><span class="hljs-params">(UniJSCallback callback)</span>{
    <span class="hljs-comment">// 连接蓝牙扫描拍成功，这里的true可以在uniapp代码中拿到，所以通过这种方式传递数据</span>
        callback.invoke(<span class="hljs-literal">true</span>);
    }

    <span class="hljs-meta">@UniJSMethod(uiThread = true)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">disconnectBlueScan</span><span class="hljs-params">(UniJSCallback callback)</span>{
        <span class="hljs-comment">// 断开蓝牙扫描器</span>
        callback.invoke(<span class="hljs-literal">true</span>);
    }
}
</code></pre>
<h3 data-id="heading-10">获取蓝牙扫描拍的数据</h3>
<p>这里跟上面的函数会有一点不一样，因为蓝牙扫描拍的数据传递是需要多次传递的，也可以简单理解需要一个类似于'<strong>长链接的概念</strong>'，<strong>这里有一个需要注意的点！！！</strong>，在uniapp的代码中需要通过对象嵌套函数的方式传这个回调函数。否则只有第一次会调用成功，这个应该跟安卓的垃圾回收机制有关。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@UniJSMethod(uiThread = true)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getBlueScanData</span><span class="hljs-params">(UniJSCallback callback)</span>{
    <span class="hljs-comment">// 传递蓝牙扫描拍的数据，需要多次传递的话，就使用invokeAndKeepAlive的方式</span>
    callback.invokeAndKeepAlive(<span class="hljs-number">1</span>);
}
</code></pre>
<p>uniapp 调用时（<strong>这里是伪代码</strong>）,看下面代码的方式才能保证<strong>invokeAndKeepAlive</strong>的方式正常生效。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> callBackObj = {
    <span class="hljs-comment">// 需要使用对象嵌套函数的方式传递，才能保证正常传递数据</span>
    <span class="hljs-attr">fn</span>:<span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>){
        
    }
}

blueScan.<span class="hljs-title function_">getBlueScanData</span>(callBackObj.<span class="hljs-property">fn</span>)
</code></pre>
<h3 data-id="heading-11">安卓项目中注册插件模块</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ce1de31526c4d79b4fc5782262325be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmVzcG9uc2VTdGF0ZTIwMA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767666746&amp;x-signature=TxCFJIhf0TnQYezGlWyKqf7V4PE%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-12">插件调试</h2>
<p>安卓原生的代码调试，最方便的方式就是官方示例中的方式，通过打包uniapp的本地资源放到安卓项目中进行调试，因为uniapp是无法看到安卓原生插件打印的一些输出的，并且uniapp是需要打包自定义基座才能使用安卓原生插件，每次改动插件都需要重新打包自定义基座，效率非常慢。所以我们下面使用官方示例中的方式</p>
<h3 data-id="heading-13">uniapp项目代码中，引用插件，并且调用。</h3>
<p>uniapp中写如下代码。</p>
<pre><code class="hljs language-javascript" lang="javascript">&lt;template&gt;
	<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"content"</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">tap</span>=<span class="hljs-string">"connectBlueScan"</span>&gt;</span>连接蓝牙<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">tap</span>=<span class="hljs-string">"disconnectBlueScan"</span>&gt;</span>断开蓝牙<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">tap</span>=<span class="hljs-string">"getBlueScan"</span>&gt;</span>获取蓝牙数据<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
	<span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
	<span class="hljs-comment">// 蓝牙原生插件,这里的名称就是在安卓项目中dcloud_uniplugins.json中写的name</span>
	<span class="hljs-keyword">const</span> blueScanNativePlugin = uni.requireNativePlugin(<span class="hljs-string">'BlueScan'</span>);
	<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
		<span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
			<span class="hljs-keyword">return</span> {
				<span class="hljs-attr">title</span>: <span class="hljs-string">'Hello'</span>
			}
		},
		<span class="hljs-title function_">onLoad</span>(<span class="hljs-params"/>) {

		},
		<span class="hljs-attr">methods</span>: {
			<span class="hljs-title function_">connectBlueScan</span>(<span class="hljs-params"/>){
				blueScanNativePlugin.<span class="hljs-title function_">connectBlueScan</span>(<span class="hljs-function">(<span class="hljs-params">data</span>)=&gt;</span>{
					<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'connectBlueScan---'</span>,data)
				})
			},
			<span class="hljs-title function_">disconnectBlueScan</span>(<span class="hljs-params"/>){
				blueScanNativePlugin.<span class="hljs-title function_">disconnectBlueScan</span>(<span class="hljs-function">(<span class="hljs-params">data</span>)=&gt;</span>{
					<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'disconnectBlueScan-----'</span>,data)
				})
			},
			<span class="hljs-title function_">getBlueScan</span>(<span class="hljs-params"/>){
				
				<span class="hljs-keyword">const</span> callBack = {
					<span class="hljs-attr">fn</span>:<span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>){
						<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'getBlueScan----'</span>,data)
					}
				}
				
				blueScanNativePlugin.<span class="hljs-title function_">getBlueScanData</span>(callBack.<span class="hljs-property">fn</span>)
			},
		}
	}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
	<span class="hljs-selector-class">.content</span> {
		<span class="hljs-attribute">display</span>: flex;
		<span class="hljs-attribute">flex-direction</span>: column;
		<span class="hljs-attribute">align-items</span>: center;
		<span class="hljs-attribute">justify-content</span>: center;
	}

	<span class="hljs-selector-class">.logo</span> {
		<span class="hljs-attribute">height</span>: <span class="hljs-number">200</span>rpx;
		<span class="hljs-attribute">width</span>: <span class="hljs-number">200</span>rpx;
		<span class="hljs-attribute">margin-top</span>: <span class="hljs-number">200</span>rpx;
		<span class="hljs-attribute">margin-left</span>: auto;
		<span class="hljs-attribute">margin-right</span>: auto;
		<span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">50</span>rpx;
	}

	<span class="hljs-selector-class">.text-area</span> {
		<span class="hljs-attribute">display</span>: flex;
		<span class="hljs-attribute">justify-content</span>: center;
	}

	<span class="hljs-selector-class">.title</span> {
		<span class="hljs-attribute">font-size</span>: <span class="hljs-number">36</span>rpx;
		<span class="hljs-attribute">color</span>: <span class="hljs-number">#8f8f94</span>;
	}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>
</code></pre>
<p>到uniapp开发者后台创建android的离线key</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b62d1b1fd7c4b6aa7b07d3a8ff219cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmVzcG9uc2VTdGF0ZTIwMA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767666746&amp;x-signature=jYm0SJGs95fEiAGDR7EK2Kw%2BUMI%3D" alt="image.png" loading="lazy"/></p>
<p>这个时候会需要用到安卓的签名信息，我们生成一个安卓的签名，我们通过keytool命令行的形式来生成，下面只是示例，具体的信息可以根据自己的要求来填写。</p>
<pre><code class="hljs language-vbnet" lang="vbnet">keytool -genkey -v -keystore my-release-<span class="hljs-keyword">key</span>.jks -keyalg RSA -keysize <span class="hljs-number">2048</span> -validity <span class="hljs-number">10000</span> -<span class="hljs-keyword">alias</span> my-<span class="hljs-keyword">alias</span>
</code></pre>
<p>查看签名中的信息，到后台中进入填入。</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># 查看签名信息</span>
keytool -list -v -keystore <span class="hljs-keyword">my</span>-release-key.jks
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0589a9eb094148188f327fc811243602~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmVzcG9uc2VTdGF0ZTIwMA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767666746&amp;x-signature=%2BwuJe2tIMmQLoW1uGKrxSnrLHeY%3D" alt="image.png" loading="lazy"/></p>
<p>保存好之后，就可以生成的离线key，填写到安卓项目中</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ca491ee100f4ab6aedc3f923495db79~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmVzcG9uc2VTdGF0ZTIwMA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767666746&amp;x-signature=S%2Bkuv7N0IZ6s99utqSfz3VtVLUE%3D" alt="image.png" loading="lazy"/></p>
<p>把安卓的签名文件放到安卓项目中的app文件夹的根目录上，并填写对应的签名配置</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/661b46633ecc4aa4847efb9642855f19~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmVzcG9uc2VTdGF0ZTIwMA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767666746&amp;x-signature=DIy%2FH1dkj6yUPSebfUCsEBngsa8%3D" alt="image.png" loading="lazy"/></p>
<p>在uniapp项目中新建一个<strong>nativeplugins</strong>的文件夹，这个名称是固定的，存放安卓插件内容。在这个目录下新建一个目录插件的名称，我们就叫BlueScan,在下面新建一个package.json。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"BlueScan"</span><span class="hljs-punctuation">,</span> 
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"BlueScan"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// ID必须唯一</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"_dp_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"nativeplugin"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"_dp_nativeplugin"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"android"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"hooksClass"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"integrateType"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"aar"</span><span class="hljs-punctuation">,</span>
	  <span class="hljs-attr">"plugins"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span>
	  	<span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"module"</span><span class="hljs-punctuation">,</span>
	  	<span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"BlueScan"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 在uniapp这边调用的时候插件的名称</span>
	  	<span class="hljs-attr">"class"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"com.example.blue_scan.BlueScan"</span> <span class="hljs-comment">// 安卓原生项目上的包名</span>
	  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
Z
</code></pre>
<p>填写好内容之后，我们在uniapp项目中的mainfest.json配置上勾选这个安卓原生插件。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f5924cb1a64446b99f77afa8a13adf61~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmVzcG9uc2VTdGF0ZTIwMA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767666746&amp;x-signature=UtKvn1OefYOTs%2Fb8A25G%2FBFncS0%3D" alt="image.png" loading="lazy"/></p>
<p>勾选完之后，我们就可以将uniapp代码打包本地资源。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/85d5acc1f62c4037b6e15c4f49fa0773~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmVzcG9uc2VTdGF0ZTIwMA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767666746&amp;x-signature=MiWWVsqLyHiC4vwUmDBl5c0d0%2FU%3D" alt="image.png" loading="lazy"/></p>
<p>打包出来的资源放到安卓项目下app/src/main/assets/apps</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e778a48228ed4e0391143e11b6805189~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmVzcG9uc2VTdGF0ZTIwMA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767666746&amp;x-signature=HNf36bAc8kl5mm%2BXFaxFt36qBGw%3D" alt="image.png" loading="lazy"/></p>
<p>修改dcloud_control.xml文件中的appid，为uniapp资源包的文件名</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad164837a2cf4e85b2809ae99d74b3ab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmVzcG9uc2VTdGF0ZTIwMA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767666746&amp;x-signature=tV6z6dhJ6JnwuoMtHTtUu7kFu5I%3D" alt="image.png" loading="lazy"/></p>
<p>如果需要显示出uniapp这边的打印日志到安卓这边的控制台上的话，就修改一下dcloud_control.xml文件，加上下面的代码，<strong>需要注意加上了这个代码的话，最好每次都删除App重新安装，否则会出现代码缓存的问题，并且在生产发布的时候需要去掉这段代码</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/101eb826a3054548a4fb8c168e4023ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmVzcG9uc2VTdGF0ZTIwMA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767666746&amp;x-signature=FWnNYMwwMvfd1VBuiUGFTfgM58Q%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-14">运行到真机</h2>
<p>前面所有的工作都算做完了，没有问题的话，我们连接上手机，然后直接运行到真机，当当当~能正常看到打印的日志</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/64c6277e19514f32adc4540009e5b641~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmVzcG9uc2VTdGF0ZTIwMA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767666746&amp;x-signature=YFHiQ1CGSmxILqicMF0SCsUMWk4%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-15">打包插件到uniapp项目中使用</h2>
<p>安卓打包插件</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f33b0d43b33446528e2be2b42ded5df1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmVzcG9uc2VTdGF0ZTIwMA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767666746&amp;x-signature=yVLY2ZGIpxekqwOnmrvzcQj5L0U%3D" alt="image.png" loading="lazy"/></p>
<p>拷贝打包出的插件</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1587b6e7d9884eb8a7b9931c0fce2640~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmVzcG9uc2VTdGF0ZTIwMA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767666746&amp;x-signature=J419eZdJmoqofQiyUbXVeEAdBAA%3D" alt="image.png" loading="lazy"/></p>
<p>放到uniapp项目的nativeplugins目录下对应的插件文件夹下，新建一个android的文件夹，把拷贝的插件包放进去</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa2f6c55ad9344b295de19f69444d718~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmVzcG9uc2VTdGF0ZTIwMA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767666746&amp;x-signature=dXsSjTAvbGmjp5YkJ8xo8AYLyDs%3D" alt="image.png" loading="lazy"/></p>
<p>然后运行<strong>自定义基座</strong>或者直接打包就可以直接使用了，<strong>uniapp标准基座是不支持自定义插件的</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI Agent 核心管理逻辑：工具的管理和调度]]></title>    <link>https://juejin.cn/post/7589201772133810217</link>    <guid>https://juejin.cn/post/7589201772133810217</guid>    <pubDate>2025-12-30T04:52:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589201772133810217" data-draft-id="7589246131585908771" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI Agent 核心管理逻辑：工具的管理和调度"/> <meta itemprop="keywords" content="Agent"/> <meta itemprop="datePublished" content="2025-12-30T04:52:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="潘锦"/> <meta itemprop="url" content="https://juejin.cn/user/730549110707431"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI Agent 核心管理逻辑：工具的管理和调度
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/730549110707431/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    潘锦
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T04:52:16.000Z" title="Tue Dec 30 2025 04:52:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>简单来说，AI Agent 就是一个能够自主感知环境、制定计划、采取行动来完成特定目标的系统。</p>
<p>从架构的角度来看，又可以分为感知模块（包括状态上下文和意图上下文，而意图上下文是一个更难一些的问题），推理模块（LLM 主控部分），记忆模块，行动模块。</p>
<p>今天我们要聊的是贯穿于各个模块中的工具，工具不仅仅是行动模块，在感知，记忆中都有可能用到工具。</p>
<h2 data-id="heading-0">1. OpenManus 的工具管理和调度</h2>
<p>看了 OpenManus 的代码，整个工程中 Tool 的占比还是比较大的，这也不是一个大而全的框架。</p>
<p>直接看代码</p>
<h3 data-id="heading-1">1.1 BaseTool 基础类</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseTool</span>(<span class="hljs-title class_ inherited__">ABC</span>):
    name: <span class="hljs-built_in">str</span>
    description: <span class="hljs-built_in">str</span>  
    parameters: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]
    
<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">execute</span>(<span class="hljs-params">self, tool_input: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]</span>) -&gt; ToolResult
</code></pre>
<p>name 用于标识，description 给 LLM 看，parameters 定义输入规范，execute 执行具体逻辑。这几个字段，已经涵盖了工具管理的核心要素。</p>
<h3 data-id="heading-2">1.2 ToolCollection 管理器</h3>
<p>工具集合的管理通过 ToolCollection 类实现，核心是一个字典：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ToolCollection</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.tool_map: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, BaseTool] = {}
</code></pre>
<p>整个实现有以下三个小点：</p>
<ul>
<li><strong>O(1) 的查找性能</strong>。用工具名作为 key，直接查找，没有遍历，没有复杂的匹配逻辑。</li>
<li><strong>统一的执行接口</strong>。所有工具调用都通过 <code>execute</code> 方法，传入工具名和参数，返回统一的 ToolResult。这种一致性让上层调用变得极其简单。</li>
<li><strong>统一的错误处理</strong>。工具不存在、执行失败都会返回 ToolFailure，不会抛异常打断流程。这种设计让系统更健壮。</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">add_tool</span>(<span class="hljs-params">self, tool: BaseTool</span>) -&gt; <span class="hljs-literal">None</span>:
    <span class="hljs-keyword">if</span> tool.name <span class="hljs-keyword">in</span> self.tool_map:
        logger.warning(<span class="hljs-string">f"Tool <span class="hljs-subst">{tool.name}</span> already exists, overwriting"</span>)
    self.tool_map[tool.name] = tool
</code></pre>
<p>在添加工具时可以覆盖已有工具。</p>
<h3 data-id="heading-3">1.3 Think-Act 循环</h3>
<p>OpenManus 实现了标准的 ReAct（Reasoning and Acting）模式，但做了很多细节优化：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">step</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:
    <span class="hljs-keyword">await</span> self.think()  <span class="hljs-comment"># 思考：决定用什么工具</span>
    <span class="hljs-keyword">await</span> self.act()    <span class="hljs-comment"># 行动：执行工具调用</span>
</code></pre>
<p>这个实现是在 ReActAgent 中定义的，think 阶段让 LLM 分析当前状态并选择工具，act 阶段执行工具并收集结果。两个阶段分离，让整个流程可控、可调试。</p>
<h3 data-id="heading-4">1.4 工具选择</h3>
<p>工具选择是整个系统的核心：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">think</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:
    response = <span class="hljs-keyword">await</span> self.llm.ask_tool(
        messages=self.memory.get_messages(),
        system_prompts=self.system_prompts,
        available_tools=self.available_tools.get_tool_schemas(),
        tool_choices=self.tool_choices
    )
</code></pre>
<p>它把几个关键信息都传给 LLM：</p>
<ul>
<li><strong>历史对话</strong>（messages）：让 LLM 了解上下文</li>
<li><strong>系统提示</strong>（system_prompts）：定义 Agent 的行为规范</li>
<li><strong>可用工具</strong>（available_tools）：告诉 LLM 有哪些工具可用</li>
<li><strong>选择模式</strong>（tool_choices）：控制是否必须选择工具</li>
</ul>
<p>这种设计让工具选择既灵活又可控。</p>
<h3 data-id="heading-5">1.5 批量执行和结果处理</h3>
<p>OpenManus 支持一次选择多个工具并行执行：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">act</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:
    <span class="hljs-keyword">if</span> self.tool_calls:
        <span class="hljs-keyword">for</span> tool_call <span class="hljs-keyword">in</span> self.tool_calls:
            observation = <span class="hljs-keyword">await</span> self.execute_tool(tool_call)
            self.memory.add_message(ToolMessage(observation, tool_call.<span class="hljs-built_in">id</span>))
</code></pre>
<p>每个工具的执行结果都会记录到 memory 中，供下一轮思考使用。</p>
<h3 data-id="heading-6">1.6 特殊工具处理</h3>
<p>OpenManus 预留了特殊工具的处理机制：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">handle_special_tool</span>(<span class="hljs-params">self, tool_call: ToolCall</span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-keyword">if</span> tool_call.name == <span class="hljs-string">"Terminate"</span>:
        self.should_stop = <span class="hljs-literal">True</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Task completed successfully."</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"Unknown special tool: <span class="hljs-subst">{tool_call.name}</span>"</span>
</code></pre>
<p>Terminate 工具用于优雅终止，这种设计避免了硬编码的退出逻辑。你可以轻松添加其他特殊工具，比如 Pause（暂停）、Checkpoint（保存状态）等。</p>
<h2 data-id="heading-7">2. Gemini CLI 的工具管理和调度</h2>
<p><strong>Gemini CLI 把所有工具都扔给大模型，让它自己选</strong>。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 就这么简单，所有工具一股脑给 LLM</span>
<span class="hljs-keyword">async</span> <span class="hljs-title function_">setTools</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
  <span class="hljs-keyword">const</span> toolRegistry = <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-title function_">getToolRegistry</span>();
  <span class="hljs-keyword">const</span> toolDeclarations = toolRegistry.<span class="hljs-title function_">getFunctionDeclarations</span>();
  <span class="hljs-keyword">const</span> <span class="hljs-attr">tools</span>: <span class="hljs-title class_">Tool</span>[] = [{ <span class="hljs-attr">functionDeclarations</span>: toolDeclarations }];
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getChat</span>().<span class="hljs-title function_">setTools</span>(tools);
}
</code></pre>
<p>现在的大模型已经足够聪明，能够根据上下文选择合适的工具。与其花大力气设计复杂的工具选择策略，不如相信 AI 的判断力。但会有可能存在工具「爆炸」的情况，这个后面我们再聊。</p>
<h3 data-id="heading-8">2.1 三层工具发现机制</h3>
<p>Gemini CLI 在工具发现方面设计了三层机制：</p>
<h4 data-id="heading-9">1. 内置核心工具</h4>
<p>这些是精心挑选的常用工具，覆盖了大部分日常开发需求：</p>
<ul>
<li><strong>文件操作</strong>：ls、read-file、write-file、edit</li>
<li><strong>代码搜索</strong>：grep、ripgrep、glob</li>
<li><strong>系统交互</strong>：shell</li>
<li><strong>网络请求</strong>：web-fetch、web-search</li>
<li><strong>记忆管理</strong>：memory</li>
</ul>
<p>每个工具都经过精心设计，接口清晰，功能专一。比如 edit 工具，不仅能编辑文件，还支持预览修改。</p>
<h4 data-id="heading-10">2. 命令行工具发现</h4>
<p>这是个很巧妙的设计。我们可以通过配置一个发现命令，让系统自动发现和注册新工具：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 执行发现命令，解析返回的工具声明</span>
<span class="hljs-keyword">async</span> <span class="hljs-title function_">discoverAndRegisterToolsFromCommand</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
  <span class="hljs-keyword">const</span> command = <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-title function_">getConfigOptions</span>().<span class="hljs-property">toolDiscoveryCommand</span>;
  <span class="hljs-keyword">if</span> (!command) <span class="hljs-keyword">return</span>;
  
  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">exec</span>(command);
  <span class="hljs-keyword">const</span> functions = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(result.<span class="hljs-property">stdout</span>);
  
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> func <span class="hljs-keyword">of</span> functions) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">registerTool</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DiscoveredTool</span>(func));
  }
}
</code></pre>
<p>这意味着我们可以轻松扩展工具集，只要我们的工具能输出符合格式的 JSON 声明即可。</p>
<h4 data-id="heading-11">3. MCP 服务器集成</h4>
<p>MCP（Model Context Protocol）是个通用的协议，Gemini CLI 对它的支持相当完善：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 支持多种传输协议</span>
- stdio：标准输入输出
- <span class="hljs-variable constant_">SSE</span>：服务器推送事件
- <span class="hljs-variable constant_">HTTP</span>：<span class="hljs-variable constant_">REST</span> <span class="hljs-variable constant_">API</span>
- <span class="hljs-title class_">WebSocket</span>：双向通信
</code></pre>
<p>通过 MCP，我们可以接入各种专业工具服务器，比如数据库查询、API 调用、专业领域工具等。每个 MCP 服务器的工具都是隔离的，避免了命名冲突。</p>
<h3 data-id="heading-12">2.2 工具调度器</h3>
<p>Gemini CLI 的工具调度器采用了清晰的状态机模型：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 工具执行状态流转</span>
validating → scheduled → awaiting_approval → executing → success/error/cancelled
</code></pre>
<p>在执行前先验证参数，避免无效调用：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">ValidatingToolCall</span> = {
  <span class="hljs-attr">status</span>: <span class="hljs-string">'validating'</span>;
  <span class="hljs-attr">request</span>: <span class="hljs-title class_">ToolCallRequestInfo</span>;
  <span class="hljs-attr">tool</span>: <span class="hljs-title class_">AnyDeclarativeTool</span>;
  <span class="hljs-attr">invocation</span>: <span class="hljs-title class_">AnyToolInvocation</span>;
};
</code></pre>
<p>根据工具风险等级，提供不同的确认策略：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 三种确认模式</span>
<span class="hljs-title class_">ApprovalMode</span>.<span class="hljs-property">DEFAULT</span>    <span class="hljs-comment">// 标准确认</span>
<span class="hljs-title class_">ApprovalMode</span>.<span class="hljs-property">AUTO_EDIT</span>  <span class="hljs-comment">// 自动编辑确认</span>
<span class="hljs-title class_">ApprovalMode</span>.<span class="hljs-property">YOLO</span>       <span class="hljs-comment">// 无确认模式（勇者模式）</span>
</code></pre>
<p>YOLO 模式的命名有点意思，"<strong>You Only Live Once</strong>" <strong>人生苦短，活出精彩</strong></p>
<p>独立的工具调用可以并行执行，提高效率：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 并行处理多个工具调用</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> fnCall <span class="hljs-keyword">of</span> functionCalls) {
  <span class="hljs-comment">// 不等待，直接调度下一个</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handlePendingFunctionCall</span>(fnCall);
}
</code></pre>
<p>工具执行过程中的输出会实时展示，用户体验很好：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 实时更新输出流</span>
onUpdate?: <span class="hljs-function">(<span class="hljs-params">output: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;
</code></pre>
<h3 data-id="heading-13">2.3 错误处理机制</h3>
<h4 data-id="heading-14">1. 错误类型分类</h4>
<p>系统定义了完整的错误类型枚举 <code>ToolErrorType</code>，包括：</p>
<p><strong>通用错误：</strong></p>
<ul>
<li><code>INVALID_TOOL_PARAMS</code> - 工具参数无效</li>
<li><code>UNKNOWN</code> - 未知错误</li>
<li><code>UNHANDLED_EXCEPTION</code> - 未处理的异常</li>
<li><code>TOOL_NOT_REGISTERED</code> - 工具未注册</li>
<li><code>EXECUTION_FAILED</code> - 执行失败</li>
</ul>
<p><strong>文件系统错误：</strong></p>
<ul>
<li><code>FILE_NOT_FOUND</code> - 文件未找到</li>
<li><code>FILE_WRITE_FAILURE</code> - 文件写入失败</li>
<li><code>PERMISSION_DENIED</code> - 权限拒绝</li>
<li><code>PATH_NOT_IN_WORKSPACE</code> - 路径不在工作空间内</li>
</ul>
<p><strong>Shell 特定错误：</strong></p>
<ul>
<li><code>SHELL_EXECUTE_ERROR</code> - Shell 执行错误</li>
</ul>
<h4 data-id="heading-15">2. 工具调用状态管理</h4>
<p>系统定义了完整的工具调用状态类型：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">ToolCall</span> =
  | <span class="hljs-title class_">ValidatingToolCall</span>      <span class="hljs-comment">// 验证中</span>
  | <span class="hljs-title class_">ScheduledToolCall</span>       <span class="hljs-comment">// 已调度</span>
  | <span class="hljs-title class_">ErroredToolCall</span>         <span class="hljs-comment">// 错误</span>
  | <span class="hljs-title class_">SuccessfulToolCall</span>      <span class="hljs-comment">// 成功</span>
  | <span class="hljs-title class_">ExecutingToolCall</span>       <span class="hljs-comment">// 执行中</span>
  | <span class="hljs-title class_">CancelledToolCall</span>       <span class="hljs-comment">// 已取消</span>
  | <span class="hljs-title class_">WaitingToolCall</span>;        <span class="hljs-comment">// 等待批准</span>
</code></pre>
<h4 data-id="heading-16">3. 错误处理流程</h4>
<h5 data-id="heading-17">验证阶段错误处理</h5>
<p>在 <code>_schedule</code> 方法中，系统会：</p>
<ol>
<li><strong>工具注册检查</strong>：验证工具是否已注册</li>
<li><strong>参数验证</strong>：使用 <code>tool.build(args)</code> 验证参数</li>
<li><strong>异常捕获</strong>：捕获验证过程中的所有异常</li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">try</span> {
  <span class="hljs-keyword">const</span> invocationOrError = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">buildInvocation</span>(toolInstance, args);
  <span class="hljs-keyword">if</span> (invocationOrError <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Error</span>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">status</span>: <span class="hljs-string">'error'</span>,
      <span class="hljs-attr">request</span>: reqInfo,
      <span class="hljs-attr">response</span>: <span class="hljs-title function_">createErrorResponse</span>(
        reqInfo,
        invocationOrError,
        <span class="hljs-title class_">ToolErrorType</span>.<span class="hljs-property">INVALID_TOOL_PARAMS</span>,
      ),
      <span class="hljs-attr">durationMs</span>: <span class="hljs-number">0</span>,
    };
  }
} <span class="hljs-keyword">catch</span> (error) {
  <span class="hljs-comment">// 处理验证异常</span>
}
</code></pre>
<h5 data-id="heading-18">执行阶段错误处理</h5>
<p>在 <code>attemptExecutionOfScheduledCalls</code> 方法中，系统会：</p>
<ol>
<li><strong>执行异常捕获</strong>：使用 Promise <code>.catch()</code> 捕获执行异常</li>
<li><strong>错误响应生成</strong>：调用 <code>createErrorResponse</code> 生成标准化错误响应</li>
<li><strong>状态更新</strong>：将工具调用状态设置为 'error'</li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript">promise
  .<span class="hljs-title function_">then</span>(<span class="hljs-keyword">async</span> (<span class="hljs-attr">toolResult</span>: <span class="hljs-title class_">ToolResult</span>) =&gt; {
    <span class="hljs-comment">// 处理成功结果</span>
  })
  .<span class="hljs-keyword">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: <span class="hljs-built_in">Error</span></span>) =&gt;</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setStatusInternal</span>(
      callId,
      <span class="hljs-string">'error'</span>,
      <span class="hljs-title function_">createErrorResponse</span>(reqInfo, error, <span class="hljs-title class_">ToolErrorType</span>.<span class="hljs-property">UNHANDLED_EXCEPTION</span>),
    );
  });
</code></pre>
<h4 data-id="heading-19">4. 错误响应格式</h4>
<p><code>createErrorResponse</code> 函数生成标准化的错误响应：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> createErrorResponse = (
  <span class="hljs-attr">request</span>: <span class="hljs-title class_">ToolCallRequestInfo</span>,
  <span class="hljs-attr">error</span>: <span class="hljs-title class_">Error</span>,
  <span class="hljs-attr">errorType</span>: <span class="hljs-title class_">ToolErrorType</span> | <span class="hljs-literal">undefined</span>,
): <span class="hljs-function"><span class="hljs-params">ToolCallResponseInfo</span> =&gt;</span> ({
  <span class="hljs-attr">callId</span>: request.<span class="hljs-property">callId</span>,
  error,
  <span class="hljs-attr">responseParts</span>: [{
    <span class="hljs-attr">functionResponse</span>: {
      <span class="hljs-attr">id</span>: request.<span class="hljs-property">callId</span>,
      <span class="hljs-attr">name</span>: request.<span class="hljs-property">name</span>,
      <span class="hljs-attr">response</span>: { <span class="hljs-attr">error</span>: error.<span class="hljs-property">message</span> },
    },
  }],
  <span class="hljs-attr">resultDisplay</span>: error.<span class="hljs-property">message</span>,
  errorType,
  <span class="hljs-attr">contentLength</span>: error.<span class="hljs-property">message</span>.<span class="hljs-property">length</span>,
});
</code></pre>
<h3 data-id="heading-20">2.4 超时策略</h3>
<h4 data-id="heading-21">1. AbortSignal 机制</h4>
<p>系统使用 <code>AbortSignal</code> 实现超时和取消控制：</p>
<h5 data-id="heading-22">调度层面的取消</h5>
<p>在 <code>schedule</code> 方法中：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">schedule</span>(
  <span class="hljs-attr">request</span>: <span class="hljs-title class_">ToolCallRequestInfo</span> | <span class="hljs-title class_">ToolCallRequestInfo</span>[],
  <span class="hljs-attr">signal</span>: <span class="hljs-title class_">AbortSignal</span>,
): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isRunning</span>() || <span class="hljs-variable language_">this</span>.<span class="hljs-property">isScheduling</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> <span class="hljs-title function_">abortHandler</span> = (<span class="hljs-params"/>) =&gt; {
        <span class="hljs-comment">// 从队列中移除请求</span>
        <span class="hljs-keyword">const</span> index = <span class="hljs-variable language_">this</span>.<span class="hljs-property">requestQueue</span>.<span class="hljs-title function_">findIndex</span>(
          <span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> item.<span class="hljs-property">request</span> === request,
        );
        <span class="hljs-keyword">if</span> (index &gt; -<span class="hljs-number">1</span>) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">requestQueue</span>.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">1</span>);
          <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Tool call cancelled while in queue.'</span>));
        }
      };
      
      signal.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'abort'</span>, abortHandler, { <span class="hljs-attr">once</span>: <span class="hljs-literal">true</span> });
      <span class="hljs-comment">// ...</span>
    });
  }
}
</code></pre>
<h5 data-id="heading-23">执行层面的取消</h5>
<p>在工具执行过程中：</p>
<ol>
<li><strong>执行前检查</strong>：</li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">if</span> (signal.<span class="hljs-property">aborted</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setStatusInternal</span>(
    reqInfo.<span class="hljs-property">callId</span>,
    <span class="hljs-string">'cancelled'</span>,
    <span class="hljs-string">'Tool call cancelled by user.'</span>,
  );
  <span class="hljs-keyword">continue</span>;
}
</code></pre>
<ol start="2">
<li><strong>执行后检查</strong>：</li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript">.<span class="hljs-title function_">then</span>(<span class="hljs-keyword">async</span> (<span class="hljs-attr">toolResult</span>: <span class="hljs-title class_">ToolResult</span>) =&gt; {
  <span class="hljs-keyword">if</span> (signal.<span class="hljs-property">aborted</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setStatusInternal</span>(
      callId,
      <span class="hljs-string">'cancelled'</span>,
      <span class="hljs-string">'User cancelled tool execution.'</span>,
    );
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-comment">// 处理成功结果</span>
})
</code></pre>
<h4 data-id="heading-24">2. Shell 工具特殊处理</h4>
<p>Shell 工具有特殊的超时和取消机制：</p>
<h5 data-id="heading-25">进程 ID 跟踪</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">if</span> (invocation <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">ShellToolInvocation</span>) {
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">setPidCallback</span> = (<span class="hljs-params">pid: <span class="hljs-built_in">number</span></span>) =&gt; {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">toolCalls</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">toolCalls</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">tc</span>) =&gt;</span>
      tc.<span class="hljs-property">request</span>.<span class="hljs-property">callId</span> === callId &amp;&amp; tc.<span class="hljs-property">status</span> === <span class="hljs-string">'executing'</span>
        ? { ...tc, pid }
        : tc,
    );
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">notifyToolCallsUpdate</span>();
  };
  promise = invocation.<span class="hljs-title function_">execute</span>(
    signal,
    liveOutputCallback,
    shellExecutionConfig,
    setPidCallback,
  );
}
</code></pre>
<h5 data-id="heading-26">Shell 执行配置</h5>
<p>系统通过 <code>ShellExecutionConfig</code> 配置 Shell 执行环境：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ShellExecutionConfig</span> {
  terminalWidth?: <span class="hljs-built_in">number</span>;
  terminalHeight?: <span class="hljs-built_in">number</span>;
  pager?: <span class="hljs-built_in">string</span>;
  showColor?: <span class="hljs-built_in">boolean</span>;
  defaultFg?: <span class="hljs-built_in">string</span>;
  defaultBg?: <span class="hljs-built_in">string</span>;
}
</code></pre>
<h4 data-id="heading-27">3. 输出截断机制</h4>
<p>为防止输出过大导致内存问题，系统实现了输出截断：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">if</span> (
  <span class="hljs-keyword">typeof</span> content === <span class="hljs-string">'string'</span> &amp;&amp;
  toolName === <span class="hljs-title class_">ShellTool</span>.<span class="hljs-property">Name</span> &amp;&amp;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-title function_">getEnableToolOutputTruncation</span>() &amp;&amp;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-title function_">getTruncateToolOutputThreshold</span>() &gt; <span class="hljs-number">0</span> &amp;&amp;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-title function_">getTruncateToolOutputLines</span>() &gt; <span class="hljs-number">0</span>
) {
  <span class="hljs-keyword">const</span> truncatedResult = <span class="hljs-keyword">await</span> <span class="hljs-title function_">truncateAndSaveToFile</span>(
    content,
    callId,
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">storage</span>.<span class="hljs-title function_">getProjectTempDir</span>(),
    threshold,
    lines,
  );
  content = truncatedResult.<span class="hljs-property">content</span>;
  outputFile = truncatedResult.<span class="hljs-property">outputFile</span>;
}
</code></pre>
<p>如果我们要构建自己的 Agent 系统，Gemini CLI 有这些值得学习的地方：</p>
<ol>
<li><strong>工具发现机制</strong>：三层发现机制很灵活，既有内置工具保底，又能动态扩展。</li>
<li><strong>状态机调度</strong>：清晰的状态流转，便于调试和监控。</li>
<li><strong>环境感知</strong>：根据运行环境自动调整行为，提升用户体验。</li>
<li><strong>MCP 协议支持</strong>：接入标准协议，获得生态系统支持。</li>
<li><strong>声明式工具定义</strong>：工具定义和实现分离，接口清晰。</li>
</ol>
<h3 data-id="heading-28">2.5 潜在的问题</h3>
<p>Gemini 这种设计也有一些潜在问题：</p>
<ol>
<li><strong>上下文膨胀</strong>：所有工具都提供给 LLM，可能导致 token 消耗增加。</li>
<li><strong>工具选择不可控</strong>：完全依赖 LLM 选择，缺少人为干预手段。</li>
<li><strong>调试困难</strong>：当工具很多时，难以追踪 LLM 为什么选择某个工具。</li>
</ol>
<h2 data-id="heading-29">3. Shopify Sidekick 的工具管理策略</h2>
<p>文章地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fshopify.engineering%2Fbuilding-production-ready-agentic-systems" target="_blank" title="https://shopify.engineering/building-production-ready-agentic-systems" ref="nofollow noopener noreferrer">shopify.engineering/building-pr…</a></p>
<p>Shopify 团队在其文章中告诉我们一个他们踩的坑：<strong>工具数量的增长不是线性问题，而是指数级复杂度问题</strong>。</p>
<p>他们把这个过程分成了三个阶段：</p>
<p><strong>0-20 个工具</strong>：蜜月期。每个工具职责清晰，调试简单，系统行为可预测。这个阶段你会觉得"Agent 开发也不过如此嘛"。</p>
<p><strong>20-50 个工具</strong>：混乱期。工具边界开始模糊，组合使用时产生意想不到的结果。这时候你开始怀疑人生："为什么调用查询工具的同时会触发邮件发送？"</p>
<p><strong>50+ 个工具</strong>：崩溃期。同一个任务有多种实现路径，系统变得无法理解。调试像在迷宫里找出口，修一个 bug 引入三个新 bug。</p>
<p>当工具数量超过 30 个后，整个系统变得难以维护。Shopify 把这个问题叫做"Death by a Thousand Instructions"（千条指令之死），系统提示词变成了一个充满特殊情况、相互冲突的指导和边缘案例处理的怪物。</p>
<h3 data-id="heading-30">3.1 Just-in-Time Instructions</h3>
<p>面对工具管理的混乱，Shopify 团队找到了一个巧妙的解决方案：<strong>Just-in-Time (JIT) Instructions</strong>。</p>
<p>这个思路其实很简单，可能的实现如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 传统方式：所有指令都塞在系统提示词里</span>
system_prompt = <span class="hljs-string">"""
你是一个AI助手...
当用户查询客户时，使用customer_query工具...
当用户需要发邮件时，先检查权限...
如果是VIP客户，要特别注意...
处理订单时要考虑库存...
（还有500行各种规则）
"""</span>

<span class="hljs-comment"># JIT方式：按需提供指令</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_tool_instructions</span>(<span class="hljs-params">tool_name, context</span>):
    <span class="hljs-keyword">if</span> tool_name == <span class="hljs-string">"customer_query"</span>:
        <span class="hljs-keyword">if</span> context.is_filtering:
            <span class="hljs-keyword">return</span> <span class="hljs-string">"使用customer_tags进行标签筛选，使用customer_status进行状态筛选..."</span>
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-string">"直接查询客户基本信息..."</span>
    <span class="hljs-comment"># 只在需要时提供相关指令</span>
</code></pre>
<p>这种设计的好处：</p>
<ol>
<li><strong>上下文精准</strong>：LLM 只看到当前需要的指令，不会被无关信息干扰。</li>
<li><strong>缓存友好</strong>：核心系统提示词保持稳定，可以利用 LLM 的提示词缓存，提高响应速度。</li>
<li><strong>灵活迭代</strong>：可以根据不同场景、用户群体、A/B 测试动态调整指令，不需要改动核心系统。</li>
<li><strong>可维护性</strong>：每个工具的指令独立管理，修改一个工具的行为不会影响其他工具。</li>
</ol>
<h2 data-id="heading-31">4. 小结</h2>
<p>OpenManus 体现了优雅设计，Gemini CLI 展示简化尝试，而 Shopify Sidekick 展示了实战中的智慧。</p>
<p>当我们要构建生产级的 Agent 系统：</p>
<ul>
<li>不要低估工具管理的复杂性</li>
<li>不要高估 LLM 的工具选择能力</li>
<li>不要忽视生产环境的残酷性</li>
</ul>
<p>Agent 系统不是一次性工程，而是需要不断进化的。我们需要不断学习、调整、优化，才能构建出真正可靠的 AI Agent。</p>
<p><strong>当我们的 Agent 要服务真实用户时，严谨的工程实践比炫酷的技术更重要。这可能不够酷，但这是通往生产环境的必经之路。</strong></p>
<p>以上。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI 编程的多层次编程辅助策略]]></title>    <link>https://juejin.cn/post/7589227883261902894</link>    <guid>https://juejin.cn/post/7589227883261902894</guid>    <pubDate>2025-12-30T04:59:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589227883261902894" data-draft-id="7589166195798179867" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI 编程的多层次编程辅助策略"/> <meta itemprop="keywords" content="Trae"/> <meta itemprop="datePublished" content="2025-12-30T04:59:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="潘锦"/> <meta itemprop="url" content="https://juejin.cn/user/730549110707431"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI 编程的多层次编程辅助策略
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/730549110707431/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    潘锦
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T04:59:38.000Z" title="Tue Dec 30 2025 04:59:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>如果把 2022 年 6 月微软和 OpenAI 正式推出 Copilot 作为起点，AI 编程已经 3 年多了。</p>
<p>随着大模型的不断迭代升级，从 Copilot 到 IDE 下的 Cursor 入局，再到 CLI 模式下的 Claude Code，其可用性，准确度越来越好。</p>
<p>在提示词完整有效的前提下，很多功能，不管是前端，后端，算法，甚至是嵌入式都能「一把梭」。</p>
<p>在认知范围内，AI 编程成了一个很好用的工具。</p>
<p>我自己也在持续深入使用，以下为使用过程中不断迭代出来一些策略。</p>
<h2 data-id="heading-0">为什么是多层次辅助</h2>
<p>用过很多种工具，每一种新的工具出来，都会试一下，也花了不少钱，但没有一种能解决所有的问题。</p>
<p>这就像家里的工具箱，螺丝刀、锤子、扳手各有各的用处。硬要用钳子拧螺丝，当然也能拧，但效率肯定不如螺丝刀。AI 编程工具也是一样的道理，不同的场景需要不同的工具，不同的任务需要不同的策略。</p>
<p>这些工具之间并不是互相替代的关系，而是互补的。我们可以在写代码的时候用 Cursor 的自动补全，遇到需要重构的地方切换到选中修改模式，碰到大块功能用 Claude Code 生成，真正棘手的问题再找 GPT5 帮忙。这种分层的使用方式，才是当前 AI 编程的较优解。</p>
<h2 data-id="heading-1">快速的自动补全</h2>
<p>用得比较爽的还是自动补全功能。</p>
<p>为啥？</p>
<p>因为可以无脑 Tab，小范围的改动，看一眼是否符合预期就可以了，速度快。</p>
<p>用看起来比较高大上的词来说就是<strong>任务说明的比特量</strong>。</p>
<p>什么意思呢？假设我们要实现一个用户登录的验证逻辑。如果用自然语言描述，可能需要写："请帮我实现一个函数，接收用户名和密码，先检查用户名是否存在，然后验证密码是否正确，如果都通过就生成 token 返回，否则抛出相应的错误..."</p>
<p>但如果我们直接在代码里写：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">validate_login</span>(<span class="hljs-params">username, password</span>):
    <span class="hljs-comment"># 检查用户是否存在</span>
    user = User.query.filter_by(username=username).first()
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> user:
</code></pre>
<p>写到这里，Cursor 基本就能理解你要干什么了，Tab 一按，后面的代码就出来了。这种方式的信息密度极高，而且是在正确的上下文位置，AI 理解起来更准确。</p>
<p>不过，自动补全也有坑的时候。有时候我们只是想换个行，它非要补全一大段；有时候我们在思考，它不停地弹建议打断思路。此时，我们可以在需要专注思考的时候就把它关了，需要快速实现的时候再打开。</p>
<p>还有个小技巧是写注释引导。比如我们要处理一个复杂的数据转换：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 将嵌套的字典结构展平成列表</span>
<span class="hljs-comment"># 例如: {'a': {'b': 1, 'c': 2}} -&gt; [('a.b', 1), ('a.c', 2)]</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">flatten_dict</span>(<span class="hljs-params">d, parent_key=<span class="hljs-string">''</span></span>):
</code></pre>
<p>这种注释不是为了给人看的，主要是给 AI 看的。有了这个例子，AI 生成的代码准确率能提升一大截。</p>
<h2 data-id="heading-2">精准的选中修改</h2>
<p>当代码已经写好，但需要调整的时候，选中修改就派上用场了。这个功能看起来简单，用好了却能大幅提升效率。</p>
<p>比如有一段用 for 循环写的代码：</p>
<pre><code class="hljs language-python" lang="python">result = []
<span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> items:
    <span class="hljs-keyword">if</span> item.status == <span class="hljs-string">'active'</span>:
        result.append(item.name)
</code></pre>
<p>选中这段代码，告诉 AI："改成列表推导式"，立马就变成了：</p>
<pre><code class="hljs language-python" lang="python">result = [item.name <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> items <span class="hljs-keyword">if</span> item.status == <span class="hljs-string">'active'</span>]
</code></pre>
<p>或者有一个函数处理了太多逻辑，选中后说："拆分成多个小函数"，AI 就会帮我们重构。这种场景下，AI 的理解非常精准，因为<strong>上下文明确，任务单一</strong>。</p>
<p>我经常用选中修改来做这些事：</p>
<ul>
<li>添加错误处理</li>
<li>优化性能瓶颈</li>
<li>调整代码风格</li>
<li>添加类型注解</li>
<li>生成单元测试</li>
</ul>
<p>有个小点就是，选中修改的指令要尽量具体。比如「优化这段代码」就太模糊了，AI 可能会过度优化，把简单的代码搞得很复杂。但如果说「把这个嵌套循环改成使用 itertools」，结果就会精准很多。</p>
<h2 data-id="heading-3">大块的代码生成</h2>
<p>当需要实现一个完整的功能模块时，Claude Code、Warp.dev 这类工具就该上场了。这一层的使用频率不如前两层高，但在特定场景下不可或缺。</p>
<p>什么时候用？通常是这些情况：</p>
<p><strong>1. 实现标准化的功能模块</strong></p>
<p>比如实现一个完整的 CRUD API、集成第三方服务、实现常见的算法等。这些功能有明确的模式可循，AI 生成的代码质量已经可以直接使用了。</p>
<p><strong>2. 处理不熟悉的技术栈</strong></p>
<p>最近我在写 Rust，说实话，ownership 和 lifetime 这些概念理解归理解，真写起来还是磕磕绊绊。这时候 Claude Code 就特别有用，虽然它不太愿意解释为什么这么写，但至少能给出能跑的代码，我可以在这个基础上学习和调整。</p>
<p><strong>3. 生成一次性的工具代码</strong></p>
<p>这是一个很常用的逻辑。以前写个临时用的小爬虫，怎么得也要半天，当字段多的时候，耗时更长了。现在不一样了，我会把地址，需要爬取的字段一次性给 AI， AI 会生成完整的代码，当出现问题时，如果能快速解决掉，就解决一下，如果不能，直接全部删了重新生成。</p>
<p>这可以叫做的「<strong>代码后稀缺时代</strong>」——代码不再是稀缺资源，我们可以为了一个临时需求生成大量代码，用完就扔。</p>
<p>当然，这种大块的代码，当提示词或者规则设定不那么好的时候，还是会一些坑会踩到，如：</p>
<p><strong>代码品味问题</strong>：AI 生成的代码往往很"啰嗦"。明明可以用列表推导式一行搞定的，它偏要写个嵌套的 if-else；明明可以抽象成函数的，它偏要复制粘贴。每次用完都需要人工清理一遍。</p>
<p><strong>过度防御性编程</strong>：AI 特别喜欢加 try-catch，有时候完全没必要的地方也要包一层。还喜欢做各种参数校验，即使在内部函数里也要检查一遍。</p>
<p><strong>抽象层次混乱</strong>：有时候该抽象的不抽象，不该抽象的过度抽象。比如只用一次的逻辑非要包装成类，或者明明可以复用的代码却到处复制。</p>
<h2 data-id="heading-4">难题的深度求解</h2>
<p>遇到真正棘手的问题时，就得请出 GPT5 深度思考模式 这种级别的模型了。速度很慢，但是往往能解决最关键的问题。</p>
<p>我印象最深的一次是在只有 8 MB 的嵌入式设备上增加一个小的文件系统，虽然官方有文档，但是语焉不详，在网上也没有找到可以参考的，再加上自己对于嵌入式开发不熟，折腾调试了两天，一直会挂，最后把全部上下文，包括在网上找的资料都扔给 GPT5，它分析了 2 分钟，最后发现是一个参数没有配置正确。</p>
<h2 data-id="heading-5">权衡与选择</h2>
<p>说了这么多，实际使用中怎么选择呢？我的经验是这样的：</p>
<p><strong>看任务复杂度</strong>：简单的补全用 Tab，局部修改用选中，完整功能用 Claude Code，复杂问题用 GPT5。这是基本原则。</p>
<p><strong>看熟悉程度</strong>：熟悉的代码自己写配合自动补全更快；不熟悉的领域多依赖 AI 生成，但要仔细 review。</p>
<p><strong>看代码生命周期</strong>：临时脚本随便让 AI 生成；核心业务代码要严格把关，宁可自己写也不能有隐患。</p>
<p>还有个重要的点是<strong>不要过度依赖</strong>。有人完全依赖 AI，自己基本不写代码了，甚至看也不看。短期看起来效率很高，但长期来说是有问题的：</p>
<ol>
<li>失去了对代码的掌控感，出问题不知道怎么改</li>
<li>代码风格不统一，维护成本增加</li>
<li>基础能力退化，离开 AI 就不会写代码了</li>
</ol>
<p>AI 是辅助工具，不是替代品。核心逻辑还是要自己把握，AI 负责提高效率和处理繁琐的部分。</p>
<h2 data-id="heading-6">工具链协同</h2>
<p>在实践中，这些工具不是孤立使用的，而是形成了一个工作流。我的典型工作流程是这样的：</p>
<p><strong>1. 构思阶段</strong>：先在 ChatGPT 或 Gemini 上讨论设计思路，确定大方向。这个阶段主要是理清思路，设计数据架构，不涉及具体代码。</p>
<p><strong>2. 框架搭建</strong>：用 Claude Code/WARP 生成基础框架和项目结构。这部分相对标准化，AI 生成的质量不错。</p>
<p><strong>3. 核心实现</strong>：切换到 Cursor/Trae，自己写核心逻辑，配合自动补全提高效率。这部分需要精确控制，不能完全交给 AI。</p>
<p><strong>4. 功能完善</strong>：需要添加的辅助功能、工具函数等，可以用 Claude Code/WARP 批量生成。</p>
<p><strong>5. 优化调整</strong>：用选中修改功能做局部优化，比如性能优化、代码风格统一等。</p>
<p><strong>6. 问题排查</strong>：遇到 bug 先自己调试，搞不定的再找 GPT5 帮忙分析。</p>
<p>这个流程不是固定的，根据具体情况会有调整。关键是要灵活，不要死板地只用一个工具。</p>
<h2 data-id="heading-7">使用中的常见陷阱</h2>
<p>用了这么久 AI 编程，踩过不少坑，这里分享一些常见的陷阱：</p>
<p><strong>1. 过度相信 AI 的输出</strong></p>
<p>AI 生成的代码看起来很专业，但可能存在逻辑错误。特别是涉及业务逻辑的部分，AI 理解可能有偏差。一定要仔细 review，不能闭眼跑。</p>
<p><strong>2. 忽视性能问题</strong></p>
<p>AI 生成的代码通常能跑，但性能不一定好。比如该用字典的地方用了列表，该批量处理的地方用了循环。在性能敏感的场景要特别注意。</p>
<p><strong>3. 安全漏洞</strong></p>
<p>这个特别重要。AI 可能会生成有安全隐患的代码，比如 SQL 注入、XSS 漏洞等。涉及用户输入、数据库操作、文件操作的代码，一定要仔细检查。</p>
<p><strong>4. 依赖混乱</strong></p>
<p>AI 喜欢引入各种库来解决问题，有时候为了一个简单功能引入一个巨大的依赖。要评估是否真的需要，能用标准库解决的就不要引入第三方库。</p>
<p><strong>5. 代码风格不一致</strong></p>
<p>不同的 AI 工具，甚至同一个工具的不同时刻，生成的代码风格都可能不一样。如果不注意统一，代码库会变得很混乱。建议配置好 linter 和 formatter，生成后自动格式化。</p>
<h2 data-id="heading-8">提升 AI 编程效率的技巧</h2>
<p>这里分享一些我常用的提升效率的小技巧：</p>
<p><strong>1. 维护一个 context 文件</strong></p>
<p>在项目根目录创建一个 <code>CLAUDE.md/WARP.md</code> 文件，写清楚项目的背景、技术栈、编码规范、常见模式等。每次让 AI 生成代码时都引用这个文件，能大幅提升生成质量。</p>
<p><strong>2. 构建 prompt 模板</strong></p>
<p>对于常见任务，准备好 prompt 模板。比如"基于以下接口定义生成 TypeScript 类型"、"为这个函数编写单元测试"等。模板能让指令更精确，减少来回调整。</p>
<p><strong>3. 增量式开发</strong></p>
<p>不要试图一次生成完整的功能，而是分步骤进行。先生成框架，再填充细节，最后优化。这样每一步都可控，出问题也容易定位。</p>
<p><strong>4. 保存有用的代码片段</strong></p>
<p>AI 生成的一些好的代码模式、工具函数，及时保存下来。下次遇到类似需求可以直接复用，或者作为 AI 的参考示例。</p>
<p><strong>5. 学会正确提问</strong></p>
<p>给 AI 的指令要具体、明确。不要说"帮我写个函数"，而要说"写一个函数，接收用户 ID 列表，批量查询用户信息，返回用户对象的字典，key 是用户 ID"。信息越具体，结果越准确。</p>
<p><strong>6. 设置合理的预期</strong></p>
<p>AI 不是魔法，它有能力边界。对于创造性的设计、复杂的业务逻辑、需要深度思考的算法，还是要靠人。AI 擅长的是模式化的、重复性的、有明确规范的任务。</p>
<h2 data-id="heading-9">写在最后</h2>
<p>AI 编程工具的出现，确实极大地改变了我们写代码的方式。但它终究是工具，如何用好这个工具，还是要靠我们自己不断探索和实践。</p>
<p>我觉得现阶段最重要的是保持开放的心态，愿意尝试新工具、新方法，但同时也要保持批判性思维，不盲目依赖。每个人的编程习惯、项目特点都不一样，需要找到适合自己的使用方式。</p>
<p>这种多层次的策略不是固定的，随着工具的进化、个人能力的提升，策略也要不断调整。比如刚开始我很依赖 AI 生成完整代码，现在更多是用它来加速我自己的编码过程。</p>
<p>还有一点很重要：不要因为有了 AI 就停止学习。相反，AI 让我们有更多时间去学习更本质的东西——系统设计、算法思想、业务理解。这些是 AI 暂时还替代不了的，也是我们作为工程师的核心价值。</p>
<p>最后想说的是，我们正处在一个编程方式剧变的时代。三年前 Copilot 刚出来的时候，很多人还在质疑它的实用性；现在，不用 AI 辅助编程反而显得有点落伍了。这个变化速度会越来越快，保持学习、保持探索，才能不被时代抛下。</p>
<p>当然，工具再强大，代码背后的思考、设计、创造，还是属于我们的。AI 让我们从繁琐中解放出来，有更多精力去做真正有价值的事情。这大概就是技术进步的意义所在吧。</p>
<p>以上。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【博文精读】Chrome CSS 2025年回顾]]></title>    <link>https://juejin.cn/post/7589206614929752104</link>    <guid>https://juejin.cn/post/7589206614929752104</guid>    <pubDate>2025-12-30T03:12:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589206614929752104" data-draft-id="7589207843787882531" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【博文精读】Chrome CSS 2025年回顾"/> <meta itemprop="keywords" content="前端,CSS"/> <meta itemprop="datePublished" content="2025-12-30T03:12:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="OpenTiny社区"/> <meta itemprop="url" content="https://juejin.cn/user/3808325101432983"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【博文精读】Chrome CSS 2025年回顾
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808325101432983/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    OpenTiny社区
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T03:12:26.000Z" title="Tue Dec 30 2025 03:12:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文由体验技术团队申君健原创。</p>
<h2 data-id="heading-0">序言</h2>
<p>近日发现 Chrome 官方技术平台 chrome.dev 发布了一篇极具价值的 CSS 技术总结文章，原文链接为：<a href="https://link.juejin.cn?target=https%3A%2F%2Fchrome.dev%2Fcss-wrapped-2025%2F" target="_blank" title="https://chrome.dev/css-wrapped-2025/" ref="nofollow noopener noreferrer">CSS-Wrapped-2025</a>，Wrapped 单词在这里是打包，总结，回顾的意思。Chrome官方罗列了2025年的新增CSS和组件特性等，有需要的小伙伴可以关注一下。此外，Chrome 官方亦发布了 2024 年度的 CSS 特性回顾文章，链接为：<a href="https://link.juejin.cn?target=https%3A%2F%2Fchrome.dev%2Fcss-wrapped-2024%2F" target="_blank" title="https://chrome.dev/css-wrapped-2024/" ref="nofollow noopener noreferrer">CSS-Wrapped-2024</a>，可以对照查阅。</p>
<p>《CSS Wrapped 2025》一文共分为三个核心章节，分别是<code>可定制的组件</code>(Customizable Components)、 <code>下一代交互</code>(Next-gen Interactions)、 <code>优化的人体工程学</code>(Optimized ergonomics)。 由于精力时间有限，本文先精读第一部分，有机会再分享后续部分。</p>
<p>2025 全年，Chrome发布的版本为 132~143，本文的特性也集中在这个范围，它有很多全新的概念，或者是去年CSS概念的一些延伸。前端人员总不能第一时间使用新特性，以兼容性为借口忽视新技术，我也是一样。所以借此文章中新特性为提纲，全面总结该特性的知识，补充我的一些理解和总结。同时每一个新特性还准备<code>一句话的解释</code> 和 <code>完整示例</code>，方便大家快速了解。Chrome 143升级好了吗，开始带你飞！</p>
<h2 data-id="heading-1">一、命令调用器 (Invoker Commands)</h2>
<h3 data-id="heading-2">一句话的解释</h3>
<blockquote>
<p><code>命令调用器是通过Button元素，向Dialog,popover元素或任意元素上触发一个动作命令。</code> <a href="https://code.juejin.cn/pen/7582409136211116032" target="_blank" title="https://code.juejin.cn/pen/7582409136211116032">完整示例</a></p>
</blockquote>
<p>命令调用器特性兼具声明式语法的高可读性优势，且能有效减少 JavaScript 代码的编写量。在该特性中，Button 元素被定义为 “命令源”，接收命令执行的元素则为 “命令目标”。</p>
<p><strong>命令源</strong>：⭐仅 Button 元素才允许当命令源，它添加以下属性：</p>
<ul>
<li>【attr】commandfor: 属性值为命令目标元素的 id，用于关联对应的命令目标。</li>
<li>【attr】command: 用于指定点击 Button 元素后触发的命令动作，其属性值说明如下：</li>
</ul>





















































<table><thead><tr><th>命令</th><th>行为目标</th><th>等效js</th><th>备注</th></tr></thead><tbody><tr><td>show-modal</td><td>打开dialog</td><td>dialog.showModal()</td><td/></tr><tr><td>close</td><td>关闭dialog</td><td>dialog.close()</td><td/></tr><tr><td>request-close</td><td>请求关闭dialog</td><td>dialog.requestClose()</td><td>可取消： ev.preventDefault()</td></tr><tr><td>show-popover</td><td>打开popover</td><td>el.showPopover()</td><td/></tr><tr><td>hide-popover</td><td>关闭popover</td><td>el.hidePopover()</td><td/></tr><tr><td>toggle-popover</td><td>切换popover</td><td>el.togglePopover()</td><td/></tr><tr><td>--any-command</td><td>自定义命令</td><td>-</td><td>事件名必须 -- 打头<br/>目标上监听command事件<br/>非冒泡，可取消的事件</td></tr></tbody></table>
<ul>
<li>【prop】command: 同上</li>
<li>【prop】commandForElement: 同 commandfor ，值为HTMLElement对象。</li>
</ul>
<p><strong>命令目标</strong>：  通常是 dialog, popover元素，为它们添加一个事件：</p>
<ul>
<li>【event】command: 触发在目标元素上的事件。 其中事件参数 <code>event.command</code> 是命令值。</li>
</ul>
<h3 data-id="heading-3">兼容性</h3>
<p>支持chrome135+  ff144+， <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fkeithamus%2Finvokers-polyfill" target="_blank" title="https://github.com/keithamus/invokers-polyfill" ref="nofollow noopener noreferrer">polyfill 方案</a>。</p>
<h3 data-id="heading-4">总结</h3>
<ol>
<li>该特性的核心价值不仅在于减少 JavaScript 代码量，更在于实现了<code>更好的可读性，更好的语义化，更好的AI识别</code>。Dialog元素是存在较久的冷门标签，Popover API是近两年的新特性，之前操作他们必须通过Javascript代码。</li>
<li>该特性也是一个微型的通知系统，某些程度上可以代替 <code>new CustomEvent</code>的使用。同样的，更好的可读性，参见<code>图片翻转</code>的示例。</li>
<li>命令源只能是Button，某种程度上限制了它的使用。</li>
</ol>
<h2 data-id="heading-5">二、对话框轻量关闭（Dialog Light Dismiss）</h2>
<h3 data-id="heading-6">一句话的解释</h3>
<blockquote>
<p><code>继 Popover Api 引入 Light Dismiss 之后，Dialog 也支持了它</code> <a href="https://code.juejin.cn/pen/7582845467080933403" target="_blank" title="https://code.juejin.cn/pen/7582845467080933403">完整示例</a></p>
</blockquote>
<p>Light Dismiss 直接翻译就是轻量关闭，友好关闭，具体是指通过点击 ::backdrop 区域、按下 Esc 键即可触发目标元素自动关闭的交互行为。Light Dismiss同样的具备声明式可阅读性，还能避免Javascript的使用。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">dialog</span> <span class="hljs-attr">closedby</span>=<span class="hljs-string">"none"</span>&gt;</span>  不触发关闭 <span class="hljs-tag">&lt;/<span class="hljs-name">dialog</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dialog</span> <span class="hljs-attr">closedby</span>=<span class="hljs-string">"closerequest"</span>&gt;</span>接受 esc或其它js触发 <span class="hljs-tag">&lt;/<span class="hljs-name">dialog</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dialog</span> <span class="hljs-attr">closedby</span>=<span class="hljs-string">"any"</span>&gt;</span>  接受任何触发 <span class="hljs-tag">&lt;/<span class="hljs-name">dialog</span>&gt;</span>
</code></pre>
<p>Light Dismiss 通常是用户在交互过程中预期的默认行为，这一设计不仅体现了 Chrome 对用户使用体验人体工程学的关注，更彰显了其对开发者开发体验人体工程学的重视。开发者无需进行额外开发，即可获得预期的合理结果。延伸了解它的一些细节：</p>
<ul>
<li>closerequest 与 any 的相比，它不接受<code>点击::backdrop区域关闭</code>；此外移动端的手指侧滑或导航回退也会触发closerequest的行为。</li>
<li>dialog.requestClose()在dialog元素上触发 <code>cancel 和 close</code>事件， 而dialog.close() 只触发<code>close</code>事件。 在<code>cancel</code>事件中执行<code>ev.preventDefault()</code>可阻止关闭。</li>
<li>dialog元素没有open事件，但它有 <code>toggle, beforetoggle事件</code>, 用来监听打开关闭。 事件对象的<code>oldState,newState</code>用来判断切换的方向。 此外，只有<code>dialog 和 弹出层</code>支持这2个事件名。</li>
</ul>
<h3 data-id="heading-7">兼容性</h3>
<p>支持chrome134+  ff141+， <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftak-dcxi%2Fdialog-closedby-polyfill" target="_blank" title="https://github.com/tak-dcxi/dialog-closedby-polyfill" ref="nofollow noopener noreferrer">polyfill 方案</a>。</p>
<h3 data-id="heading-8">延伸理解 Popover API 的Light Dismiss</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">popovertarget</span>=<span class="hljs-string">"mypopover"</span> <span class="hljs-attr">popovertargetaction</span>=<span class="hljs-string">"toggle"</span>&gt;</span>切换显示<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"mypopover"</span> <span class="hljs-attr">popover</span>&gt;</span>这是一个 auto 弹出层<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p><strong>命令源</strong>：⭐仅 Button 元素和Input(type=button)才允许当命令源，它添加以下属性：</p>
<ul>
<li>【attr】popovertarget: 其值为popover元素id</li>
<li>【attr】popovertargetaction: 点击的命令动作，其值为： 'hide' | 'show' | 'toggle'</li>
</ul>
<blockquote>
<p>触发popover还可以用传统的Javascript, 或者Button的commands 模式，比如： el.showPopover()</p>
</blockquote>
<p><strong>popover层</strong>： 任意添加了 [popover] 属性的元素</p>
<ul>
<li>【attr】popover: 设置元素为一个弹出层，它最早支持以下2个值：
<ul>
<li>auto: 自动模式，也是默认值。 auto即符合Light Dismiss默认关闭行为。同一个页面上，auto类别的元素只能显示一个。</li>
<li>manual: 手动模式。必须显示的声明popovertargetaction，或调用Javascript函数才触发，比如：el.showPopover()。同一个页面上，manual类别元素可显示多个。</li>
</ul>
</li>
</ul>
<p>参考<a href="https://code.juejin.cn/pen/7583980914653593635" target="_blank" title="https://code.juejin.cn/pen/7583980914653593635">完整示例</a>，对比 Dialog 与 Popover API :</p>
<ul>
<li>都支持Invoker Commands 和 Light Dismiss</li>
<li>都支持Javascript控制和声明式表达： dialog元素的<code>closedby</code> 和 popover元素的<code>popover</code>属性</li>
<li>都会产生一个<code>Top Layer</code>, 无须z-index就能置顶元素，且不受父元素的position影响。</li>
<li>命令源和命令目标之间会隐式的产生aria-details关联aria-expanded，用于触发焦点导航等。</li>
</ul>
<p>Popover API的这些特性兼容性为：chrome114+, ff125+</p>
<h2 data-id="heading-9">三、增强Popover (popover="hint") 与 兴趣调用(Interest Invoker)</h2>
<h3 data-id="heading-10">一句话的解释</h3>
<blockquote>
<p><code>hint暗示：一种更轻量的触发行为的popover类别</code> <a href="https://code.juejin.cn/pen/7584011726266318874" target="_blank" title="https://code.juejin.cn/pen/7584011726266318874">完整示例</a></p>
</blockquote>
<p>在上小节中，已经讲了popover原有的2个类别，今年它又新增了一个类别：hint 暗示。这种<code>hint弹出层</code>，不仅可以用原来的方法触发它，还增加了一种兴趣调用触发。 兴趣调用<code>Interest Invoker</code>是指：通过非点击事件，比如hover,mouseover,mouseout, focus,blur 它的变化。悬浮就显示，离开就隐藏，十分符合<code>tooltip组件</code>场景。</p>
<pre><code class="hljs language-html" lang="html">  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">interestfor</span>=<span class="hljs-string">"mypopover1"</span>&gt;</span>悬浮触发 hint1 弹出层<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"mypopover1"</span> <span class="hljs-attr">popover</span>=<span class="hljs-string">'hint'</span>&gt;</span>这是一个 hint1 弹出层<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p><strong>命令源</strong>：它新增以下相关内容：</p>
<ul>
<li>【attr】interestfor: 属性值为 hint类别的popover元素id</li>
<li>【css-rule】interest-delay: 设置悬浮触发和离开隐藏的时间。 它是复合属性： interest-delay-start, interest-delay-end。默认触发的时间是 0.5s。</li>
<li>【css-selector】 :interest-source 和 :interest-target 是指，如果当前兴趣正在发生，那么触发源和hint 弹出层就分别为具有上面的伪类。类似于 dialog打开时，dialog:open的伪类一样。详见上面示例。</li>
</ul>
<p><strong>hint 弹出层</strong>：新增以下事件：</p>
<ul>
<li>【event】interest: 触发显示的<code>InterestEvent事件</code>, 事件的source指向触发源元素。</li>
<li>【event】loseinterest: 离开失去的<code>InterestEvent事件</code>，事件的source指向触发源元素。</li>
</ul>
<p>兴趣调用与前面2节的内容有一些重要的差异：</p>
<ol>
<li>强调必须非点击事件，场景对应“悬而未决”的状态，可以配合popover="hint"使用。</li>
<li>触发源更广泛，不仅是Button元素，还允许 <code>&lt;a&gt;, &lt;button&gt;,&lt;area&gt;,SVG &lt;a&gt; </code>。</li>
<li>hint类别不影响auto类别的弹窗，不会主动触发auto弹窗关闭。</li>
</ol>
<p>长期以来Web标准对<code>hover</code>行为是淡视的，只有title属性和 :hover的伪类，一直缺少关键的<code>hover事件</code>。此次提供 <code>interest事件</code>,借此可以变相的视为一种<code>hover事件</code></p>
<h3 data-id="heading-11">兼容性</h3>
<p>支持chrome 142+, 不支持：ff,safari, <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmfreed7%2Finterestfor" target="_blank" title="https://github.com/mfreed7/interestfor" ref="nofollow noopener noreferrer">polyfill 方案</a>。</p>
<h2 data-id="heading-12">四、可自定义的select (Customizable select)</h2>
<h3 data-id="heading-13">一句话的解释</h3>
<blockquote>
<p><code>增强的select 和 option 元素，丰富的伪类、伪元素，定制更容易</code> <a href="https://code.juejin.cn/pen/7584018175914999818" target="_blank" title="https://code.juejin.cn/pen/7584018175914999818">完整示例</a></p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f6d7b5ba44a48b68e3975012d7c51e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlblRpbnnnpL7ljLo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767669146&amp;x-signature=Bar6EY5%2Fl9YENUHr2vR3so7XFk0%3D" alt="ScreenShot_20251230103200.PNG" loading="lazy"/></p>
<p>可定制的select增加了很多dom规范和伪类，伪元素，内容太多不宜展开细述，感兴趣看上面的完整MDN示例，我已经增加详细的注释。此处仅列出一些重要的概念和事项，以便能快速理解：</p>
<ol>
<li>base-select 设置：</li>
</ol>
<p>select 和 ::picker(select)伪元素都必须添加规则： <code>appearance: base-select</code> ,以区别于传统select样式。</p>
<ol start="2">
<li>弹出层::picker(select)特性：</li>
</ol>
<p>它渲染在页面顶层<code>Top Layer</code>，这意味着它会显示在所有其他内容之上，不会被父容器裁剪。浏览器还会根据视口中的可用空间自动调整下拉列表的位置和翻转。</p>
<ol start="3">
<li>增强的option:</li>
</ol>
<p>传统的option元素仅支持 label,value属性和selected，disabled的布尔属性。<code>option中嵌套有其它元素，都是会忽略的</code>。</p>
<p>增强后的option元素<code>支持嵌套span,img等等普通元素</code>，但要避免嵌套 a, input 等交互元素就行了。 </p>
<ol start="4">
<li>新增 selectedcontent 元素：</li>
</ol>
<p>该元素必须遵循 <code>select &gt; button &gt; selectedcontent</code> 的嵌套结构，详见示例。</p>
<p>select的选择值（即change事件）之后，选中的option的节点会被cloneNode创建副本，插入到<code>selectedcontent</code>中，所以他们结构一样，但不是同一个元素实例。</p>
<p>同时button是惰性的，不响应focus等，行为更像是 <code>div</code>。</p>
<p>option 和 selectedcontent 的子项，都可以用普通的 css 选择器去分别控制样式。</p>
<ol start="5">
<li>select 借用 Popover API</li>
</ol>
<p>它<code>隐式借用了非常多的Popover 特性</code>，比如 :popover-open伪类，无需<code>anchor-name</code>的隐式的锚点引用，且可以定义弹出层与锚点的位置关系，溢出翻转等等。</p>
<ol start="6">
<li>select的multiple 和 optgroup 未增强</li>
</ol>
<p>这意味着多选和分组功能，需要重新实现，对于组件库的作者来说，这无疑得回退到传统方案，幸好有Popover API。</p>
<h3 data-id="heading-14">兼容性：</h3>
<p>支持 chrome 135+ , ff,safari均 不支持😭，<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fjosepharhar%2Fcustomizable-select-polyfill%25C2%25A0" target="_blank" title="https://github.com/josepharhar/customizable-select-polyfill%C2%A0" ref="nofollow noopener noreferrer">polyfill 方案</a></p>
<p>这个方案并非真正意义的polyfill, 它使用自定义的 webComponent技术实现了平替。</p>
<h2 data-id="heading-15">五、滚动控制伪元素(::scroll-marker/button())</h2>
<h3 data-id="heading-16">一句话的解释</h3>
<blockquote>
<p>为滚动容器的添加伪元素，用于控制容器滚动 <a href="https://code.juejin.cn/pen/7584018234107265062" target="_blank" title="https://code.juejin.cn/pen/7584018234107265062">完整示例</a></p>
</blockquote>
<p>HTML早早添加了dialog, detail 等元素，但一直没有增加一个轮播图元素，今年只抠抠搜搜添加了三个伪元素，或许是因为添加一个新元素需要考虑的事情太多。</p>
<ol>
<li>::scroll-button()  <code>滚动容器按钮的伪元素</code>，点击它会触发容器滚动。它非常类似于 ::before, ::after作用, 都需要content才显示,且呈现在容器的内部。</li>
</ol>
<p>每个容器最多有4个滚动方向，括号的作用是<code>指定滚动方向</code>，可取值：*， left,right,up,down, block-end,block-start, inline-end,inline-start等。</p>
<p>按钮伪元素具有状态，比如容器滚动到两端之后，滚动按钮会自动禁用。 它具有以下状态： enabled, disabled,hover,active,focus</p>
<ol start="2">
<li>::scroll-marker 是滚动容器中，指示<code>滚动项的伪元素</code>，它同样也需要content才显示。</li>
</ol>
<p>它具有 <code>:target-current 伪类</code>， 表示滚动到当前滚动项。当然， :hover, :active等伪类也能使用</p>
<ol start="3">
<li>::scroll-marker-group 是呈现在滚动容器内部的伪元素，收集容纳所有的::scroll-marker元素。</li>
</ol>
<p>marker-group元素自身没有高度，但可以设置边框，布局，间距等内容。</p>
<h3 data-id="heading-17">兼容性：</h3>
<p>支持chrome 135+ , ff,safari均 不支持😭。由于它是css 特性，无法Polyfill, 建议使用传统的div去实现即可！</p>
<h2 data-id="heading-18">六、设置滚动标记组容器(scroll-target-group)</h2>
<h3 data-id="heading-19">一句话的解释</h3>
<blockquote>
<p>设置元素为滚动容器 <a href="https://code.juejin.cn/pen/7584728540432564224" target="_blank" title="https://code.juejin.cn/pen/7584728540432564224">完整示例</a></p>
</blockquote>
<p>CSS属性 scroll-target-group 用来指定一个元素为滚动标记组容器， 它只有2个值： </p>
<ul>
<li>none: 元素非滚动标记组容器</li>
<li>auto: 元素为滚动标记组容器</li>
</ul>
<p>滚动标记组容器中通常包含锚点链接列表等，配合伪类 :target-current 来突出显示某个锚点，效果非常类似传统的Anchor组件，当容器滚动时，可以高亮指定的目录项，不过这些都是浏览器自动完成的，不需要一行javascript。</p>
<p>它与::scroll-marker-group 有某些相似点：</p>
<ul>
<li>::scroll-marker-group：是在某个元素内部，创建一个伪元素容器，用来容纳::sroll-marker， 都是伪元素。</li>
<li>scroll-target-group: 是把一个真实元素变为滚动容器，内部放真实的link 类元素，所以控制上会更灵活。</li>
</ul>
<p>从官方的态度看，这2个概念极其相近，都是定义了一个滚动容器，且内部的锚点行为一致，均支持伪类 :target-current 代表高亮状态，避免Javascript去滚动和设置高亮等。</p>
<h3 data-id="heading-20">兼容性：</h3>
<p>支持 chrome 140+ ,但ff,safari均 不支持😭，且css 特性无法Polyfill。</p>
<h2 data-id="heading-21">七、锚定容器查询（Anchored Container Queries）</h2>
<h3 data-id="heading-22">一句话的解释</h3>
<blockquote>
<p>锚点定位时，翻转状态可以查询<a href="https://code.juejin.cn/pen/7584738593622392870" target="_blank" title="https://code.juejin.cn/pen/7584738593622392870">完整示例</a></p>
</blockquote>
<p>2024年的CSS回顾中，介绍了CSS锚点定位-—— anchor positioning, 实现类似 Tooltip组件的效果，让一个弹出层锚定到目标元素周围，且能自动翻转到适合位置，避免使用Javascript。 它的兼容性： chrome125+, safari26+, ff 不支持。</p>
<p>下面例子演示了：CSS锚点定位。tooltip会锚定在button的上下， 当滚动到边界时，会自动翻转显示。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.my-button</span> {
  anchor-name: --my-btn-anchor; <span class="hljs-comment">/* 定义一个名为 --my-btn-anchor 的锚点 */</span>
}

<span class="hljs-selector-class">.my-tooltip</span> {
  <span class="hljs-attribute">position</span>: absolute; <span class="hljs-comment">/* 或 fixed */</span>
  <span class="hljs-attribute">position</span>-anchor: --my-btn-anchor; <span class="hljs-comment">/* 关联到上面定义的锚点 */</span>
  <span class="hljs-attribute">position</span>-area: bottom;
  <span class="hljs-attribute">position</span>-try-fallbacks: flip-block; 
}
</code></pre>
<p>思考一个问题：如果my-tooltip元素有小三角指示方向，那么简单的翻转后，小三角的位置怎么旋转呢？
答案是：定位元素无法意识（be aware)状态，小三角方向会错误。</p>
<p>此问题的解决方案即本次新增了<code>CSS锚定容器查询</code>能力，它通过指定tooltip的 <code>container-type: anchored</code>, 然后使用<code>@container anchored</code> 的查询语法，就让tooltip查询到，意识到自身的翻转状态（fallbacks 状态）。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.tooltip</span> {
  container-type: anchored;

  <span class="hljs-comment">/* 默认在下方， 小三角向上，位置在底部 */</span>
  &amp;<span class="hljs-selector-pseudo">::before</span> {
    <span class="hljs-attribute">content</span>: <span class="hljs-string">'▲'</span>;
    <span class="hljs-attribute">position</span>: absolute;
    <span class="hljs-attribute">bottom</span>: <span class="hljs-number">100%</span>;  
  }
}
<span class="hljs-comment">/** 当容器查询到锚点变化 */</span>
<span class="hljs-keyword">@container</span> anchored(<span class="hljs-attribute">fallback</span>: flip-block) {
  <span class="hljs-selector-class">.tooltip</span><span class="hljs-selector-pseudo">::before</span> {
    <span class="hljs-comment">/* 小三角向下，并移到到顶部 */</span>
    <span class="hljs-attribute">content</span>: <span class="hljs-string">'▼'</span>;
    <span class="hljs-attribute">bottom</span>: auto;
    <span class="hljs-attribute">top</span>: <span class="hljs-number">100%</span>;  
  }
}
</code></pre>
<p>要讲明白锚点定位需要很大篇幅，且该示例复杂，大家可以转到官网查看示例。 目前 <code>container-type: anchored</code> 的文档连MDN上都没有，是比较新的概念。</p>
<p>container-type有效值：</p>
<ul>
<li>normal: 元素不支持任何查询</li>
<li>size: 支持 inline 和 block 元素的尺寸的高度和宽度查询</li>
<li>inline-size: 仅支持 inline 元素的尺寸的宽度查询</li>
<li>scroll-state: 支持滚动态的偏移量和是否滚动到底等查询，chrome 133+, 但ff,safari均不支持</li>
<li>anchored: 锚点查询</li>
</ul>
<h3 data-id="heading-23">兼容性：</h3>
<p><code>container-type: anchored</code> 支持 chrome 143+ ,但ff,safari均不支持😭，且css 特性无法Polyfill。</p>
<h2 data-id="heading-24">总结</h2>
<p>通过以上种种新特性，可以看出chrome 不仅关注使用用户体验，更关注开发者体验。通过增加类似command属性,或者Light Dismiss的默认行为，以及滚动容器，滚动容器伪元素等技巧，让许多场景都可以<code>无Javascript实现</code>了。 不仅大大减少开发代码，还有极强的DOM可读性。</p>
<p>我目前从事于组件库开发。在组件库的开发时，所采用的技术通常是落后于浏览器最新技术的，理由就是为了兼容用户浏览器。比如 dialog 元素已经是广泛兼容，但目前仍没有见到哪个组件库使用它。通过这次梳理技术，感觉借助 dialog 以及 popover api 可以极大简化以往的组件开发，诸如：监听按键，计算z-index,计算弹出层位置，监听滚动进行位置跟随等等,这些是问题bug集中爆发区，现在基本都可以<code>无Js代码</code>的实现了。</p>
<p>另外，前面的诸多未广泛兼容的技术，大都有相应的Polyfill，尤其是属性，函数和事件的Polyfill基本都能找到。CSS的新伪类，伪元素虽然很难有Polyfill，但可以用添加类名的方案来兼容，辅助以一些Js事件就可以实现某种程度上的polyfill。<a href="https://link.juejin.cn?target=https%3A%2F%2Foddbird.tech%2F" target="_blank" title="https://oddbird.tech/" ref="nofollow noopener noreferrer">oddbird.tech</a>是一家服务公司，得到过Google的赞助，它们一直关注开发<code>Popover API</code>和 <code>Anchor positioning</code>的兼容方案。这些方案都让我们以及早的使用新技术进行开发。</p>
<p>如果只需要支持最新的浏览器，前端的春天来了！</p>
<h2 data-id="heading-25">关于OpenTiny</h2>
<p>欢迎加入 OpenTiny 开源社区。添加微信小助手：opentiny-official 一起参与交流前端技术～</p>
<p>OpenTiny 官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fopentiny.design" target="_blank" title="https://opentiny.design" ref="nofollow noopener noreferrer">opentiny.design</a><br/>
OpenTiny 代码仓库：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopentiny" target="_blank" title="https://github.com/opentiny" ref="nofollow noopener noreferrer">github.com/opentiny</a><br/>
TinyVue 源码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopentiny%2Ftiny-vue" target="_blank" title="https://github.com/opentiny/tiny-vue" ref="nofollow noopener noreferrer">github.com/opentiny/ti…</a><br/>
TinyEngine 源码： <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopentiny%2Ftiny-engine" target="_blank" title="https://github.com/opentiny/tiny-engine" ref="nofollow noopener noreferrer">github.com/opentiny/ti…</a><br/>
欢迎进入代码仓库 Star🌟TinyEngine、TinyVue、TinyNG、TinyCLI、TinyEditor~
如果你也想要共建，可以进入代码仓库，找到 good first issue 标签，一起参与开源贡献~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[mysql基础面试题]]></title>    <link>https://juejin.cn/post/7589207843788079139</link>    <guid>https://juejin.cn/post/7589207843788079139</guid>    <pubDate>2025-12-30T03:23:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589207843788079139" data-draft-id="7589246131585024035" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="mysql基础面试题"/> <meta itemprop="keywords" content="MySQL"/> <meta itemprop="datePublished" content="2025-12-30T03:23:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="哈里谢顿"/> <meta itemprop="url" content="https://juejin.cn/user/3678304397695056"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            mysql基础面试题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3678304397695056/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    哈里谢顿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T03:23:05.000Z" title="Tue Dec 30 2025 03:23:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近对mysql的基础知识很感兴趣，所以希望通过查询网络上的面试题来巩固下基础，所以如下</p>
<h2 data-id="heading-0">1 普通索引跟唯一索引应该如何选择</h2>
<p>在 MySQL（InnoDB）里，“普通二级索引（KEY）”和“唯一索引（UNIQUE KEY）”<strong>在存储结构、查询性能上几乎一模一样</strong>，真正的差异只有三点：</p>
<ol>
<li>唯一索引多一道“唯一性约束”检查</li>
<li>唯一索引对优化器的<strong>基数估计更准</strong>，某些场景能拿到更优的执行计划</li>
<li>唯一索引不能存重复值，因此<strong>插入/更新</strong>时可能多一次“冲突检测”往返</li>
</ol>
<ul>
<li>
<p>查询</p>
<ul>
<li>当普通索引为条件时查询到数据会一直扫描,直到扫完整张表</li>
<li>当唯一索引为查询条件时,查到该数据会直接返回,不会继续扫表</li>
</ul>
</li>
<li>
<p>更新</p>
<ul>
<li>普通索引会直接将操作更新到 change buffer 中,然后结束</li>
<li>唯一索引需要判断数据是否冲突</li>
</ul>
</li>
</ul>
<p>所以**「唯一索引更加适合查询的场景,普通索引更适合插入的场景」**</p>
<h2 data-id="heading-1">2 一条sql命令一直查询慢的原因是什么</h2>
<p><strong>「1.没有用到索引」</strong></p>
<ul>
<li>比如函数导致的索引失效，或者本身就没有加索引</li>
</ul>
<p><strong>「2.表数据量太大」</strong></p>
<ul>
<li>考虑分库分表吧</li>
</ul>
<p><strong>「3.优化器选错了索引」</strong></p>
<ul>
<li><strong>「考虑使用」</strong> force index 强制走索引</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[docker安装以及部署node项目]]></title>    <link>https://juejin.cn/post/7589201772133498921</link>    <guid>https://juejin.cn/post/7589201772133498921</guid>    <pubDate>2025-12-30T03:27:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589201772133498921" data-draft-id="7589171972447387690" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="docker安装以及部署node项目"/> <meta itemprop="keywords" content="Docker,前端,后端"/> <meta itemprop="datePublished" content="2025-12-30T03:27:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="林太白"/> <meta itemprop="url" content="https://juejin.cn/user/1874034273300919"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            docker安装以及部署node项目
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1874034273300919/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    林太白
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T03:27:37.000Z" title="Tue Dec 30 2025 03:27:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">docker安装以及部署node项目</h2>
<p>源码地址</p>
<p>同路之人，幸得君顾，盼得君之一赞！</p>
<p>与君同行，愿得青眼相加！</p>
<p>你的star</p>
<p>如春风化雨，润物无声；</p>
<p>如山间清泉，滋润心田；</p>
<p>如长河落日，映照初心；</p>
<p>亦如暗夜明灯，照亮前路；</p>
<p>是吾辈前行之明灯，亦是我坚持的动力!</p>
<p>愿君前程似锦，代码如诗，人生如画！</p>
<p>【GIthub地址】（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Flintaibai%2FTG" target="_blank" title="https://gitee.com/lintaibai/TG" ref="nofollow noopener noreferrer">github.com/lintaibai/T…</a>）</p>
<p>【Gitee地址】（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Flintaibai%2FTG" target="_blank" title="https://gitee.com/lintaibai/TG" ref="nofollow noopener noreferrer">gitee.com/lintaibai/T…</a>）</p>
<h3 data-id="heading-1">1、认识</h3>
<h4 data-id="heading-2">下载地址</h4>
<p>注意我们一般采取<code>Docker Desktop</code>进行管理，就相当于我们的版本或者镜像综合的一个管理工具</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 官方网址</span>
<span class="hljs-attr">https</span>:<span class="hljs-comment">//docs.docker.com/get-started/introduction/get-docker-desktop/</span>

<span class="hljs-comment">// 查看版本</span>
docker --version
<span class="hljs-title class_">Docker</span> version <span class="hljs-number">28.5</span><span class="hljs-number">.2</span>, build ecc6942


<span class="hljs-comment">// 国内阿里镜像地址</span>
<span class="hljs-attr">https</span>:<span class="hljs-comment">//developer.aliyun.com/mirror/</span>
</code></pre>
<h4 data-id="heading-3">docker常用命令</h4>
<pre><code class="hljs language-javascript" lang="javascript"># 列出所有本地镜像
docker images

# 或者使用更详细的格式
docker image ls

<span class="hljs-comment">// 删除镜像</span>
# 通过镜像<span class="hljs-variable constant_">ID</span>删除
docker rmi &lt;image_id&gt;

# 通过镜像名删除
docker rmi &lt;image_name&gt;:&lt;tag&gt;

# 示例
docker rmi <span class="hljs-attr">ubuntu</span>:<span class="hljs-number">20.04</span>

# 删除多个指定镜像
docker rmi &lt;image1&gt; &lt;image2&gt; &lt;image3&gt;
</code></pre>
<h4 data-id="heading-4">介绍</h4>
<p>Docker 是一个开源的容器化平台，它可以将应用程序及其依赖项打包到一个轻量级、可移植的容器中。简单来说，Docker 让你能够将你的应用和运行环境打包在一起，确保在任何地方都能以相同的方式运行。</p>
<p>Docker 已经成为现代软件开发和部署的重要工具，特别是在微服务架构和 DevOps 实践中。</p>
<h5 data-id="heading-5">主要特点和优势</h5>
<ol>
<li><strong>轻量级</strong>：容器共享主机操作系统的内核，不需要像虚拟机那样运行完整的操作系统，因此更加轻量。</li>
<li><strong>可移植性</strong>：容器可以在任何支持 Docker 的环境中运行，包括开发者的笔记本电脑、测试服务器、生产环境等。</li>
<li><strong>一致性</strong>：确保应用在开发、测试和生产环境中表现一致，消除"在我电脑上能运行"的问题。</li>
<li><strong>快速部署</strong>：容器的启动速度非常快，通常只需几秒钟。</li>
<li><strong>资源效率高</strong>：与虚拟机相比，容器占用的资源更少，可以在同一台机器上运行更多容器。</li>
<li><strong>版本控制</strong>：Docker 镜像可以像代码一样进行版本控制，便于追踪和管理变更。</li>
</ol>
<h5 data-id="heading-6">Docker 的基本概念</h5>
<ul>
<li><strong>镜像(Image)</strong>：一个只读的模板，用于创建容器。</li>
<li><strong>容器(Container)</strong>：镜像的运行实例，是轻量级、可执行的独立软件包。</li>
<li><strong>仓库(Repository)</strong>：用于存储和分发镜像的地方，如 Docker Hub</li>
</ul>
<h4 data-id="heading-7">相关镜像源</h4>
<h5 data-id="heading-8">docker国内的常见镜像源</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">DaoCloud</span> 镜像站：<span class="hljs-attr">https</span>:<span class="hljs-comment">//docker.m.daocloud.io</span>
网易云：<span class="hljs-attr">https</span>:<span class="hljs-comment">//hub-mirror.c.163.com</span>
百度云：<span class="hljs-attr">https</span>:<span class="hljs-comment">//mirror.baidubce.com</span>
南京大学镜像站：<span class="hljs-attr">https</span>:<span class="hljs-comment">//docker.nju.edu.cn</span>
</code></pre>
<h5 data-id="heading-9">设置镜像源</h5>
<pre><code class="hljs language-javascript" lang="javascript">sudo mkdir -p /etc/docker

sudo tee /etc/docker/daemon.<span class="hljs-property">json</span> &lt;&lt;-<span class="hljs-string">'EOF'</span>
{
    <span class="hljs-string">"registry-mirrors"</span>: [
        <span class="hljs-string">"https://docker.m.daocloud.io"</span>,
        <span class="hljs-string">"https://hub-mirror.c.163.com"</span>,
        <span class="hljs-string">"https://mirror.baidubce.com"</span>,
        <span class="hljs-string">"https://docker.nju.edu.cn"</span>
    ]
}
<span class="hljs-variable constant_">EOF</span>

<span class="hljs-comment">// 重启docker服务</span>
sudo systemctl daemon-reload
sudo systemctl restart docker
</code></pre>
<h5 data-id="heading-10">镜像源信息查看</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 查看当前生效的镜像源</span>

# 查看<span class="hljs-title class_">Docker</span>信息
docker info

# 在输出中查找<span class="hljs-title class_">Registry</span> <span class="hljs-title class_">Mirrors</span>部分



<span class="hljs-comment">// 查看设置的镜像源</span>
cat /etc/docker/daemon.<span class="hljs-property">json</span>

<span class="hljs-comment">// 查看镜像源</span>
docker info | grep -i <span class="hljs-string">"Registry Mirrors"</span> -A <span class="hljs-number">5</span>
</code></pre>
<h4 data-id="heading-11">完整的镜像源及地址</h4>
<pre><code class="hljs language-javascript" lang="javascript"> <span class="hljs-string">"registry-mirrors"</span>: [
    <span class="hljs-string">"https://mirrors.tuna.tsinghua.edu.cn/docker-ce"</span>, <span class="hljs-comment">// 清华大学镜像站</span>
    <span class="hljs-string">"https://docker.m.daocloud.io"</span>,  <span class="hljs-comment">// DaoCloud 镜像站</span>
    <span class="hljs-string">"https://hub-mirror.c.163.com"</span>,  <span class="hljs-comment">// 网易云</span>
    <span class="hljs-string">"https://mirror.baidubce.com"</span>,   <span class="hljs-comment">// 百度云 </span>
    <span class="hljs-string">"https://docker.nju.edu.cn"</span>  <span class="hljs-comment">// 南京大学镜像站</span>
   
]


</code></pre>
<h3 data-id="heading-12">2、安装使用</h3>
<h4 data-id="heading-13">Mac上安装Docker</h4>
<p>1、下载地址</p>
<p>选择自己对应的版本下载即可</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">https</span>:<span class="hljs-comment">//www.docker.com/products/docker-desktop/</span>
</code></pre>
<h4 data-id="heading-14">汉化Docker Desktop</h4>
<p>Docker Desktop 是一个让开发者能够在 Windows 和 macOS 上轻松使用 Docker 的应用程序。</p>
<pre><code class="hljs language-javascript" lang="javascript">下载对应<span class="hljs-title class_">Docker</span> <span class="hljs-title class_">Desktop</span>版本号、操作系统的汉化包
</code></pre>
<h4 data-id="heading-15">服务器安装Docker</h4>
<p>进入我们的服务器，我的演示为<code>ubuntu</code>服务器</p>
<p>以linux系统的主机为最佳</p>
<pre><code class="hljs language-javascript" lang="javascript">下载安装的官网
<span class="hljs-attr">https</span>:<span class="hljs-comment">//get.docker.com/</span>

第一个和第四个命令

<span class="hljs-comment">// 添加Docker官方GPG密钥</span>
curl -fsSL <span class="hljs-attr">https</span>:<span class="hljs-comment">//get.docker.com -o install-docker.sh</span>
sudo sh install-docker.<span class="hljs-property">sh</span>

<span class="hljs-comment">// 系统建议安装命令</span>
sudo apt install docker.<span class="hljs-property">io</span>

<span class="hljs-comment">// 验证是否安装成功</span>
docker --version
</code></pre>
<h3 data-id="heading-16">3、使用</h3>
<h4 data-id="heading-17">DockerFile文件配置</h4>
<p>Docker打包项目一般都要新建DockerFile文件，以rust为例，内容如下</p>
<pre><code class="hljs language-javascript" lang="javascript"># 构建阶段
<span class="hljs-variable constant_">FROM</span> <span class="hljs-attr">rust</span>:<span class="hljs-number">1.70</span> <span class="hljs-keyword">as</span> builder
<span class="hljs-variable constant_">WORKDIR</span> /app
# 优化编译
<span class="hljs-variable constant_">ENV</span> <span class="hljs-variable constant_">RUSTFLAGS</span>=<span class="hljs-string">"-C target-feature=+crt-static"</span>
<span class="hljs-variable constant_">ENV</span> <span class="hljs-variable constant_">CARGO_TERM_COLOR</span>=always
<span class="hljs-variable constant_">COPY</span> <span class="hljs-title class_">Cargo</span>.<span class="hljs-property">toml</span> ./
<span class="hljs-variable constant_">RUN</span> mkdir src &amp;&amp; echo <span class="hljs-string">"fn main() {}"</span> &gt; src/main.<span class="hljs-property">rs</span> &amp;&amp; cargo build --release
<span class="hljs-variable constant_">RUN</span> rm -rf src
<span class="hljs-variable constant_">COPY</span> src ./src
<span class="hljs-variable constant_">RUN</span> cargo build --release

# 运行阶段
<span class="hljs-variable constant_">FROM</span> scratch
# 从构建阶段复制编译好的二进制文件和<span class="hljs-variable constant_">SSL</span>证书（如果需要<span class="hljs-variable constant_">HTTPS</span>）
<span class="hljs-variable constant_">COPY</span> --<span class="hljs-keyword">from</span>=builder /app/target/release/nexus-rust-api /nexus-rust-api
<span class="hljs-variable constant_">COPY</span> --<span class="hljs-keyword">from</span>=builder /etc/ssl/certs/ca-certificates.<span class="hljs-property">crt</span> /etc/ssl/certs/
<span class="hljs-variable constant_">EXPOSE</span> <span class="hljs-number">3300</span>
<span class="hljs-variable constant_">CMD</span> [<span class="hljs-string">"/nexus-rust-api"</span>]

</code></pre>
<h4 data-id="heading-18">添加权限</h4>
<p>将用户添加到docker组</p>
<pre><code class="hljs language-plain" lang="plain">sudo usermod -aG docker $USER
# 然后重新登录或执行：
newgrp docker
</code></pre>
<h4 data-id="heading-19">打包构建</h4>
<pre><code class="hljs language-javascript" lang="javascript"># 构建镜像
docker build -t nexus-rust-api .

没有将用户添加到用户组可以用这个命令构建镜像
sudo docker build -t nexus-rust-api .

# 运行容器
docker run -p <span class="hljs-number">3300</span>:<span class="hljs-number">3300</span> nexus-rust-api

</code></pre>
<p>打包过程一直失败，这里我们需要使用国内镜像进行加速</p>
<pre><code class="hljs language-javascript" lang="javascript">国内镜像加速

# 创建或编辑daemon.<span class="hljs-property">json</span>

sudo mkdir -p /etc/docker

sudo tee /etc/docker/daemon.<span class="hljs-property">json</span> &lt;&lt;-<span class="hljs-string">'EOF'</span>
{
  <span class="hljs-string">"registry-mirrors"</span>: [
    <span class="hljs-string">"https://docker.mirrors.ustc.edu.cn"</span>,
    <span class="hljs-string">"https://hub-mirror.c.163.com"</span>
  ]
}
<span class="hljs-variable constant_">EOF</span>

<span class="hljs-comment">// 以下命令验证配置是否生效：出现刚刚的镜像源就是成功了</span>
docker info | grep -A <span class="hljs-number">10</span> <span class="hljs-string">"Registry Mirrors"</span>

<span class="hljs-comment">// 配置阿里官方镜像库</span>
sudo mkdir -p /etc/docker
sudo tee /etc/docker/daemon.<span class="hljs-property">json</span> &lt;&lt;-<span class="hljs-string">'EOF'</span>
{
  <span class="hljs-string">"registry-mirrors"</span>: [<span class="hljs-string">"https://registry.cn-hangzhou.aliyuncs.com"</span>]
}
<span class="hljs-variable constant_">EOF</span>

# 重启<span class="hljs-title class_">Docker</span>服务
sudo systemctl daemon-reload
sudo systemctl restart docker

</code></pre>
<p>Docker国内镜像地址</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">https</span>:<span class="hljs-comment">//www.cnblogs.com/wzzkaifa/p/19041828</span>

# 停止<span class="hljs-title class_">Docker</span>服务
sudo systemctl stop docker

# 配置新的镜像源
sudo tee /etc/docker/daemon.<span class="hljs-property">json</span> &lt;&lt;-<span class="hljs-string">'EOF'</span>
{
  <span class="hljs-string">"registry-mirrors"</span>: [<span class="hljs-string">"https://docker.1ms.run"</span>]
}
<span class="hljs-variable constant_">EOF</span>

# 重启<span class="hljs-title class_">Docker</span>服务
sudo systemctl daemon-reload
sudo systemctl start docker

# 验证配置
docker info | grep -A <span class="hljs-number">10</span> <span class="hljs-string">"Registry Mirrors"</span>


<span class="hljs-comment">// DockerFile文件配置</span>

# 构建阶段
<span class="hljs-variable constant_">FROM</span> docker.1ms.<span class="hljs-property">run</span>/library/<span class="hljs-attr">rust</span>:<span class="hljs-number">1.70</span> <span class="hljs-keyword">as</span> builder
<span class="hljs-variable constant_">WORKDIR</span> /app
<span class="hljs-variable constant_">COPY</span> <span class="hljs-title class_">Cargo</span>.<span class="hljs-property">toml</span> ./
<span class="hljs-variable constant_">RUN</span> mkdir src &amp;&amp; echo <span class="hljs-string">"fn main() {}"</span> &gt; src/main.<span class="hljs-property">rs</span> &amp;&amp; cargo build --release
<span class="hljs-variable constant_">RUN</span> rm -rf src
<span class="hljs-variable constant_">COPY</span> src ./src
<span class="hljs-variable constant_">RUN</span> cargo build --release

# 运行阶段
<span class="hljs-variable constant_">FROM</span> scratch
<span class="hljs-variable constant_">COPY</span> --<span class="hljs-keyword">from</span>=builder /app/target/release/nexus-rust-api /nexus-rust-api
<span class="hljs-variable constant_">EXPOSE</span> <span class="hljs-number">3300</span>
<span class="hljs-variable constant_">CMD</span> [<span class="hljs-string">"/nexus-rust-api"</span>]

docker build -t nexus-rust-api .

<span class="hljs-variable constant_">FROM</span> <span class="hljs-attr">rust</span>:<span class="hljs-number">1.75</span>
<span class="hljs-variable constant_">WORKDIR</span> /app
<span class="hljs-variable constant_">COPY</span> . .
<span class="hljs-variable constant_">RUN</span> cargo build --release
<span class="hljs-variable constant_">CMD</span> [<span class="hljs-string">"./target/release/nexus-rust-api"</span>]
</code></pre>
<h4 data-id="heading-20">配置信息</h4>
<p>本地我的配置</p>
<pre><code class="hljs language-javascript" lang="javascript">sudo mkdir -p /etc/docker

<span class="hljs-comment">//  清华大学</span>
<span class="hljs-string">"https://mirrors.tuna.tsinghua.edu.cn/docker-ce"</span>


sudo tee /etc/docker/daemon.<span class="hljs-property">json</span> &lt;&lt;-<span class="hljs-string">'EOF'</span>
{
  <span class="hljs-string">"registry-mirrors"</span>: [
    <span class="hljs-string">"https://mirrors.tuna.tsinghua.edu.cn/docker-ce"</span>,
    <span class="hljs-string">"https://ccr.ccs.tencentyun.com"</span>,
    <span class="hljs-string">"https://docker.1ms.run"</span>,
    <span class="hljs-string">"https://hub-mirror.c.163.com"</span>,
    <span class="hljs-string">"https://mirror.baidubce.com"</span>,
    <span class="hljs-string">"https://do.nark.eu.org"</span>,
    <span class="hljs-string">"https://dc.j8.work"</span>,
    <span class="hljs-string">"https://docker.m.daocloud.io"</span>,
    <span class="hljs-string">"https://dockerproxy.com"</span>,
    <span class="hljs-string">"https://docker.mirrors.ustc.edu.cn"</span>,
    <span class="hljs-string">"https://docker.nju.edu.cn"</span>,
    <span class="hljs-string">"https://docker.1panel.live"</span>,
    <span class="hljs-string">"https://docker.1panelproxy.com"</span>,
    <span class="hljs-string">"https://elastic.m.daocloud.io"</span>,
    <span class="hljs-string">"https://elastic.m.daocloud.io"</span>,
    <span class="hljs-string">"https://docker.m.daocloud.io"</span>,
    <span class="hljs-string">"https://gcr.m.daocloud.io"</span>,
    <span class="hljs-string">"https://ghcr.m.daocloud.io"</span>,
    <span class="hljs-string">"https://k8s-gcr.m.daocloud.io"</span>,
    <span class="hljs-string">"https://k8s.m.daocloud.io"</span>,
    <span class="hljs-string">"https://mcr.m.daocloud.io"</span>,
    <span class="hljs-string">"https://nvcr.m.daocloud.io"</span>,
    <span class="hljs-string">"https://quay.m.daocloud.io"</span>
  ]
}
<span class="hljs-variable constant_">EOF</span>
</code></pre>
<h4 data-id="heading-21">借鉴配置</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">https</span>:<span class="hljs-comment">//github.com/rust-cross/rust-musl-cross.git</span>


<span class="hljs-variable constant_">FROM</span> <span class="hljs-attr">ubuntu</span>:<span class="hljs-number">22.04</span>

<span class="hljs-variable constant_">ENV</span> <span class="hljs-variable constant_">DEBIAN_FRONTEND</span>=noninteractive

# <span class="hljs-title class_">Make</span> sure we have basic dev tools <span class="hljs-keyword">for</span> building C libraries.  <span class="hljs-title class_">Our</span> goal
# here is to support the musl-libc builds and <span class="hljs-title class_">Cargo</span> builds needed <span class="hljs-keyword">for</span> a
# large selection <span class="hljs-keyword">of</span> the most popular crates.
#
<span class="hljs-variable constant_">RUN</span> apt-get update &amp;&amp; \
    apt-get install -y \
    build-essential \
    cmake \
    curl \
    file \
    git \
    sudo \
    xutils-dev \
    unzip \
    ca-certificates \
    python3 \
    python3-pip \
    autoconf \
    autoconf-archive \
    automake \
    flex \
    bison \
    llvm-dev \
    libclang-dev \
    clang \
    &amp;&amp; \
    apt-get clean &amp;&amp; rm -rf /<span class="hljs-keyword">var</span>/lib/apt/lists<span class="hljs-comment">/*

# Install Let's Encrypt R3 CA certificate from https://letsencrypt.org/certificates/
COPY lets-encrypt-r3.crt /usr/local/share/ca-certificates
RUN update-ca-certificates

ARG TARGET=x86_64-unknown-linux-musl
ARG MUSL_TARGET=$TARGET
ENV RUST_MUSL_CROSS_TARGET=$MUSL_TARGET
ARG RUST_MUSL_MAKE_CONFIG=config.mak

COPY $RUST_MUSL_MAKE_CONFIG /tmp/config.mak

RUN cd /tmp &amp;&amp; \
    git clone --depth 1 https://github.com/richfelker/musl-cross-make.git &amp;&amp; \
    cp /tmp/config.mak /tmp/musl-cross-make/config.mak &amp;&amp; \
    cd /tmp/musl-cross-make &amp;&amp; \
    export CFLAGS="-fPIC -g1 $CFLAGS" &amp;&amp; \
    export TARGET=$MUSL_TARGET &amp;&amp; \
    if [ `dpkg --print-architecture` = 'armhf' ] &amp;&amp; [ `uname -m` = 'aarch64' ]; then SETARCH=linux32; else SETARCH= ; fi &amp;&amp; \
    $SETARCH make -j$(nproc) &gt; /tmp/musl-cross-make.log &amp;&amp; \
    $SETARCH make install &gt;&gt; /tmp/musl-cross-make.log &amp;&amp; \
    ln -s /usr/local/musl/bin/$TARGET-strip /usr/local/musl/bin/musl-strip &amp;&amp; \
    cd /tmp &amp;&amp; \
    rm -rf /tmp/musl-cross-make /tmp/musl-cross-make.log

RUN mkdir -p /home/rust/libs /home/rust/src

# Set up our path with all our binary directories, including those for the
# musl-gcc toolchain and for our Rust toolchain.
ENV PATH=/root/.cargo/bin:/usr/local/musl/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
ENV TARGET_CC=$MUSL_TARGET-gcc
ENV TARGET_CXX=$MUSL_TARGET-g++
ENV TARGET_AR=$MUSL_TARGET-ar
ENV TARGET_RANLIB=$MUSL_TARGET-ranlib
ENV TARGET_HOME=/usr/local/musl/$MUSL_TARGET
ENV TARGET_C_INCLUDE_PATH=$TARGET_HOME/include/

# pkg-config cross compilation support
ENV TARGET_PKG_CONFIG_ALLOW_CROSS=1
ENV TARGET_PKG_CONFIG_SYSROOT_DIR=$TARGET_HOME
ENV TARGET_PKG_CONFIG_PATH=$TARGET_HOME/lib/pkgconfig:/usr/local/musl/lib/pkgconfig
ENV TARGET_PKG_CONFIG_LIBDIR=$TARGET_PKG_CONFIG_PATH

# We'll build our libraries in subdirectories of /home/rust/libs.  Please
# clean up when you're done.
WORKDIR /home/rust/libs

RUN export CC=$TARGET_CC &amp;&amp; \
    export C_INCLUDE_PATH=$TARGET_C_INCLUDE_PATH &amp;&amp; \
    export AR=$TARGET_AR &amp;&amp; \
    export RANLIB=$TARGET_RANLIB &amp;&amp; \
    echo "Building zlib" &amp;&amp; \
    VERS=1.2.13 &amp;&amp; \
    CHECKSUM=b3a24de97a8fdbc835b9833169501030b8977031bcb54b3b3ac13740f846ab30 &amp;&amp; \
    cd /home/rust/libs &amp;&amp; \
    curl -sqLO https://zlib.net/fossils/zlib-$VERS.tar.gz &amp;&amp; \
    echo "$CHECKSUM zlib-$VERS.tar.gz" &gt; checksums.txt &amp;&amp; \
    sha256sum -c checksums.txt &amp;&amp; \
    tar xzf zlib-$VERS.tar.gz &amp;&amp; cd zlib-$VERS &amp;&amp; \
    CFLAGS="-O3 -fPIC" ./configure --static --prefix=$TARGET_HOME &amp;&amp; \
    make -j$(nproc) &amp;&amp; make install &amp;&amp; \
    cd .. &amp;&amp; rm -rf zlib-$VERS.tar.gz zlib-$VERS checksums.txt

# The Rust toolchain to use when building our image
ARG TOOLCHAIN=stable
# Install our Rust toolchain and the `musl` target.  We patch the
# command-line we pass to the installer so that it won't attempt to
# interact with the user or fool around with TTYs.  We also set the default
# `--target` to musl so that our users don't need to keep overriding it
# manually.
# Chmod 755 is set for root directory to allow access execute binaries in /root/.cargo/bin (azure piplines create own user).
#
# Remove docs and more stuff not needed in this images to make them smaller
RUN chmod 755 /root/ &amp;&amp; \
    if [ `dpkg --print-architecture` = 'armhf' ]; then GNU_TARGET="armv7-unknown-linux-gnueabihf"; else GNU_TARGET=`uname -m`-unknown-linux-gnu; fi &amp;&amp; \
    export RUSTUP_USE_CURL=1 &amp;&amp; \
    curl https://sh.rustup.rs -sqSf | \
    sh -s -- -y --profile minimal --default-toolchain $TOOLCHAIN --default-host $GNU_TARGET &amp;&amp; \
    rustup target add $TARGET || rustup component add --toolchain $TOOLCHAIN rust-src &amp;&amp; \
    rustup component add --toolchain $TOOLCHAIN rustfmt clippy &amp;&amp; \
    rm -rf /root/.rustup/toolchains/$TOOLCHAIN-$GNU_TARGET/share/

RUN echo "[target.$TARGET]\nlinker = \"$TARGET_CC\"\n" &gt; /root/.cargo/config.toml

# Build std sysroot for targets that doesn't have official std release
ADD Xargo.toml /tmp/Xargo.toml
ADD s390x-unwind.patch /tmp/s390x-unwind.patch
ADD build-std.sh .
RUN bash build-std.sh

ENV RUSTUP_HOME=/root/.rustup
ENV CARGO_HOME=/root/.cargo
ENV CARGO_BUILD_TARGET=$TARGET

ENV CFLAGS_armv7_unknown_linux_musleabihf='-mfpu=vfpv3-d16'

# Build statically linked binaries for MIPS targets
ENV CARGO_TARGET_MIPS_UNKNOWN_LINUX_MUSL_RUSTFLAGS='-C target-feature=+crt-static'
ENV CARGO_TARGET_MIPSEL_UNKNOWN_LINUX_MUSL_RUSTFLAGS='-C target-feature=+crt-static'
ENV CARGO_TARGET_MIPS64_UNKNOWN_LINUX_MUSLABI64_RUSTFLAGS='-C target-feature=+crt-static'
ENV CARGO_TARGET_MIPS64EL_UNKNOWN_LINUX_MUSLABI64_RUSTFLAGS='-C target-feature=+crt-static'

# Expect our source code to live in /home/rust/src
WORKDIR /home/rust/src
</span></code></pre>
<h4 data-id="heading-22">项目配置</h4>
<p>在我们项目的根目录下面搭建一个文件,里面配置我们需要的相关信息</p>
<h5 data-id="heading-23">创建 <code>Dockerfile</code> 文件</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Dockerfile</span>

# 使用官方 <span class="hljs-title class_">Node</span>.<span class="hljs-property">js</span> 运行时作为基础镜像
<span class="hljs-variable constant_">FROM</span> <span class="hljs-attr">node</span>:<span class="hljs-number">18</span>-alpine

# 设置工作目录
<span class="hljs-variable constant_">WORKDIR</span> /app

# 复制 package.<span class="hljs-property">json</span> 和 package-lock.<span class="hljs-property">json</span>
<span class="hljs-variable constant_">COPY</span> package*.<span class="hljs-property">json</span> ./

# 安装项目依赖
<span class="hljs-variable constant_">RUN</span> npm install

# 复制项目源代码
<span class="hljs-variable constant_">COPY</span> . .

# 暴露应用端口（根据你的应用修改）
<span class="hljs-variable constant_">EXPOSE</span> <span class="hljs-number">3000</span>

# 运行应用的命令（根据你的入口文件修改）
<span class="hljs-variable constant_">CMD</span> [<span class="hljs-string">"node"</span>, <span class="hljs-string">"app.js"</span>]
</code></pre>
<h5 data-id="heading-24">创建<code>.dockerignore</code>文件</h5>
<pre><code class="hljs language-javascript" lang="javascript">node_modules
npm-debug.<span class="hljs-property">log</span>
.<span class="hljs-property">git</span>
.<span class="hljs-property">gitignore</span>
<span class="hljs-variable constant_">README</span>.<span class="hljs-property">md</span>
.<span class="hljs-property">env</span>
</code></pre>
<h3 data-id="heading-25">4、打包部署</h3>
<p>接下来我们使用docker打包部署node项目</p>
<p>打包之前需要安装一下我们对应的依赖镜像，我的node版本如下。对应的版本我们可以在对应的部分查看</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-number">22.16</span><span class="hljs-number">.0</span>


对应的镜像地址
<span class="hljs-attr">https</span>:<span class="hljs-comment">//mirrors.aliyun.com/nodejs-release/v22.16.0/?spm=a2c6h.25603864.0.0.52b3773fkunQPT</span>
</code></pre>
<p>配置镜像源</p>
<pre><code class="hljs language-javascript" lang="javascript">{
  <span class="hljs-string">"registry-mirrors"</span>: [
    <span class="hljs-string">"https://docker.m.daocloud.io"</span>,
    <span class="hljs-string">"https://mirror.ccs.tencentyun.com"</span>,
    <span class="hljs-string">"https://mirrors.aliyun.com"</span>,
    <span class="hljs-string">"https://mirrors.huaweicloud.com/repository/docker-ce"</span>,
    <span class="hljs-string">"https://docker.xuanyuan.me"</span>,
  ]
}

</code></pre>
<p>完整的配置如下,配置好了这个时候打包已经可以了</p>
<pre><code class="hljs language-javascript" lang="javascript">{
  <span class="hljs-string">"builder"</span>: {
    <span class="hljs-string">"gc"</span>: {
      <span class="hljs-string">"defaultKeepStorage"</span>: <span class="hljs-string">"20GB"</span>,
      <span class="hljs-string">"enabled"</span>: <span class="hljs-literal">true</span>
    }
  },
  <span class="hljs-string">"experimental"</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-string">"registry-mirrors"</span>: [
     <span class="hljs-string">"https://docker.m.daocloud.io"</span>,
    <span class="hljs-string">"https://mirror.ccs.tencentyun.com"</span>,
    <span class="hljs-string">"https://mirrors.aliyun.com"</span>,
    <span class="hljs-string">"https://mirrors.huaweicloud.com/repository/docker-ce"</span>,
    <span class="hljs-string">"https://docker.xuanyuan.me"</span>,
     <span class="hljs-string">"https://mirrors.tuna.tsinghua.edu.cn/docker-ce"</span>
  ]
}
</code></pre>
<p>根目录下面运行这个打包命令</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 打包</span>

docker build -t nexus-node-app .
</code></pre>
<p>这个时候我们耐心等待一会然后打包就成功了</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 本地导出打包的文件</span>

docker save -o nexus-node-api.<span class="hljs-property">tar</span> nexus-node-api

这个时候在我的根目录下面已经有一个文件了，直接把这个文件丢到我们想要的node服务器即可
nexus-node-api.<span class="hljs-property">tar</span>
</code></pre>
<h5 data-id="heading-26">镜像传输到服务器上</h5>
<p>接下来我们将已经打包好的项目直接放到docker服务器上进行运行</p>
<p>方法（2种）</p>
<p>可以直接传送上去或者利用命令行工具直接将我们的项目传递上去</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 使用 scp 或其他文件传输工具： </span>
scp my-node-app.<span class="hljs-property">tar</span> user@your-server-<span class="hljs-attr">ip</span>:<span class="hljs-regexp">/home/u</span>ser/
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-comment">// 登录服务器，进入你上传文件的目录，执行：</span>
docker load -i nexus-node-api.<span class="hljs-property">tar</span>
</code></pre>
<h5 data-id="heading-27">运行容器</h5>
<p>在服务器上进行运行</p>
<pre><code class="hljs language-javascript" lang="javascript">docker run -d \
  --name my-node-app-container \
  -p <span class="hljs-number">80</span>:<span class="hljs-number">3200</span> \
  --restart unless-stopped \
  your-registry/my-node-<span class="hljs-attr">app</span>:v1<span class="hljs-number">.0</span><span class="hljs-number">.0</span>
    
  <span class="hljs-comment">// 这里的执行命令为</span>
  docker run -d \
  --name nexus-node-api \
  -p <span class="hljs-number">3200</span>:<span class="hljs-number">3200</span> \
  -e <span class="hljs-variable constant_">NODE_ENV</span>=production \
  nexus-node-<span class="hljs-attr">api</span>:latest
</code></pre>
<p>查看我们容器的运行状态</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 查看容器是否成功运行</span>
docker ps

<span class="hljs-comment">// 查看容器日志</span>
docker logs nexus-node-api

<span class="hljs-comment">// 实时查看日志</span>
docker logs -f nexus-node-api


<span class="hljs-comment">// 停止容器</span>
docker stop nexus-node-api

<span class="hljs-comment">// 重启容器：</span>
docker restart nexus-node-api


<span class="hljs-comment">// 删除容器（需要先停止）：</span>
docker rm nexus-node-api

</code></pre>
<p>这个时候我已经可以看到我的项目运行以及日志了</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// docker logs nexus-node-api</span>

版本号nexus  <span class="hljs-variable constant_">V0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span> 
${author}热烈欢迎你访问<span class="hljs-title class_">Node</span>后端服务器
初始化ws
<span class="hljs-title class_">WebSocket</span> 服务器已启动，监听端口 <span class="hljs-number">3000</span>
初始化ws聊天室
ws聊天已启动，监听端口 <span class="hljs-number">3001</span>
<span class="hljs-title class_">Server</span> is running on <span class="hljs-attr">http</span>:<span class="hljs-comment">//0.0.0.0:3200</span>
数据库连接成功😊,我是林太白
</code></pre>
<h4 data-id="heading-28">打包node项目提示处理</h4>
<p>这个时候提示我们</p>
<pre><code class="hljs language-javascript" lang="javascript"> =&gt; <span class="hljs-variable constant_">ERROR</span> [internal] load metadata <span class="hljs-keyword">for</span> docker.<span class="hljs-property">io</span>/library/<span class="hljs-attr">node</span>:<span class="hljs-number">18</span>-alpine                               <span class="hljs-number">21.</span>1s
------
 &gt; [internal] load metadata <span class="hljs-keyword">for</span> docker.<span class="hljs-property">io</span>/library/<span class="hljs-attr">node</span>:<span class="hljs-number">18</span>-<span class="hljs-attr">alpine</span>:
------
<span class="hljs-title class_">Dockerfile</span>:<span class="hljs-number">2</span>
--------------------
   <span class="hljs-number">1</span> |     # 使用官方 <span class="hljs-title class_">Node</span>.<span class="hljs-property">js</span> 运行时作为基础镜像
   <span class="hljs-number">2</span> | &gt;&gt;&gt; <span class="hljs-variable constant_">FROM</span> <span class="hljs-attr">node</span>:<span class="hljs-number">18</span>-alpine
   <span class="hljs-number">3</span> |
   <span class="hljs-number">4</span> |     # 设置工作目录
--------------------
<span class="hljs-attr">ERROR</span>: failed to <span class="hljs-attr">build</span>: failed to <span class="hljs-attr">solve</span>: <span class="hljs-attr">node</span>:<span class="hljs-number">18</span>-<span class="hljs-attr">alpine</span>: failed to resolve source metadata <span class="hljs-keyword">for</span> docker.<span class="hljs-property">io</span>/library/<span class="hljs-attr">node</span>:<span class="hljs-number">18</span>-<span class="hljs-attr">alpine</span>: failed to <span class="hljs-keyword">do</span> <span class="hljs-attr">request</span>: <span class="hljs-title class_">Head</span> <span class="hljs-string">"https://registry-1.docker.io/v2/library/node/manifests/18-alpine"</span>: dialing registry-<span class="hljs-number">1.</span>docker.<span class="hljs-property">io</span>:<span class="hljs-number">443</span> container via direct connection because disabled has no <span class="hljs-variable constant_">HTTPS</span> <span class="hljs-attr">proxy</span>: connecting to registry-<span class="hljs-number">1.</span>docker.<span class="hljs-property">io</span>:<span class="hljs-number">443</span>: dial tcp <span class="hljs-number">108.160</span><span class="hljs-number">.161</span><span class="hljs-number">.83</span>:<span class="hljs-number">443</span>: <span class="hljs-attr">connectex</span>: A connection attempt failed because the connected party did not properly respond after a period <span class="hljs-keyword">of</span> time, or established connection failed because connected host has failed to respond.

<span class="hljs-title class_">View</span> build <span class="hljs-attr">details</span>: docker-<span class="hljs-attr">desktop</span>:<span class="hljs-comment">//dashboard/build/desktop-linux/desktop-linux/ste681kfzh01gt53di0y8ii61</span>
</code></pre>
<h5 data-id="heading-29">处理解决</h5>
<p>这个时候大多数都是配置和镜像的问题，这里我换成了清华镜像站，然后重新部署了一下就ok了</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LogicFlow 交互新体验：告别直连，丝滑贝塞尔轨迹实战！🍫]]></title>    <link>https://juejin.cn/post/7589168816527949851</link>    <guid>https://juejin.cn/post/7589168816527949851</guid>    <pubDate>2025-12-30T03:36:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589168816527949851" data-draft-id="7589166195796951067" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LogicFlow 交互新体验：告别直连，丝滑贝塞尔轨迹实战！🍫"/> <meta itemprop="keywords" content="前端,JavaScript,Vue.js"/> <meta itemprop="datePublished" content="2025-12-30T03:36:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="橙某人"/> <meta itemprop="url" content="https://juejin.cn/user/1908407919184670"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LogicFlow 交互新体验：告别直连，丝滑贝塞尔轨迹实战！🍫
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1908407919184670/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    橙某人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T03:36:26.000Z" title="Tue Dec 30 2025 03:36:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252b3a}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px;color:#5e7ce0}.markdown-body h1{font-size:24px;margin-bottom:5px;margin-top:80px;position:relative;text-align:center}.markdown-body h2{font-size:20px;padding-bottom:12px;border-bottom:1px solid #dfe1e6}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px;margin-top:30px}.markdown-body h5{font-size:14px;margin-top:20px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #dfe1e6;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#ffeeed;color:#c73636;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#252b3a;background:#f8f8f8}.markdown-body a{position:relative;text-decoration:none;color:#5e7ce0;padding-right:18px;padding-bottom:4px}.markdown-body a[href^=http]:after{position:absolute;display:inline-block;width:16px;height:16px;margin-left:2px;margin-top:6px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAIRlWElmTU0AKgAAAAgABQESAAMAAAABAAEAAAEaAAUAAAABAAAASgEbAAUAAAABAAAAUgEoAAMAAAABAAIAAIdpAAQAAAABAAAAWgAAAAAAAABIAAAAAQAAAEgAAAABAAOgAQADAAAAAQABAACgAgAEAAAAAQAAACCgAwAEAAAAAQAAACAAAAAAX7wP8AAAAAlwSFlzAAALEwAACxMBAJqcGAAAAVlpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDYuMC4wIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KGV7hBwAABWVJREFUWAnlVktsVFUY/s85997pC9BOTKxRWnEKsXWlxjWJj0RWJjrFAAXjAlewYWOkgauACVu7a2IiNUEyExM3yoZE3Wmi7qgPJthJBDE6JUNpO3Mf5/j95/bOTOcBlBgXejJ37rn/Of/7O/9/iP7vQ/zTAcjnC4ry+a5ii1OkiYTpuvjvEc0Gp51uivP+ZW+QBuSW4QjW5rptAa1Ey0uOGKOxwPetVyafN6p/52/PkNBbjdAhGaGEpMRjLZTryB8+9MUSYSGNRIcBvm8kBAY9tHYlHz78nTs392xIkwv9FA3Oe33bdoX1ZZKOS0bH0CXI6RugYLW6BwIu5gskkQ4sEG0wYF25PjBzbZfSYY6kDLUmWMt7FR7Lw3xYUkaTdjxHfTPnPwav0iEGYADVa9XIRIEyxrAA0jIQxgFL22gYwF7A8/DAzNVdksJvJaTEUZ2kYnZWziN5s1ADPHneEIXByotYuMSrf9JEbbsuv7VcvbaKML8plXtQR0EdIYDqWEmtOgAomZFH8EjWSnek2ulmtljljttHbmaIHCCCHzd9MjwfsmscBeZH9Jyd10nMvz92UQrtCBKvMF06mQy0SiEdRMEGg8mN0YjAlgoDDkPrMI5qJKSkKKydpbB2CZjJkhIBvOBw2CGQgii85bpx//dMqFRKam5uvH7w+K97oe+Cl0HO68uIBH0qyEzpOMwIbZIcFq0I+9cwoElizCjk2KFI1y7Nnx614W1db58fOXIlMzs7Xn/jeDmvBV2Q0mXjGf554O/m4LZHp2N8r61WPMvLZWLdiC4GMAk5BjeeB5lhv39l6+BIbu3m760hXMDKBD08XBKzR8fr04nygnIypOOAJUx/fHrsi0Mnys+vVK+V4VUohaiyPCo2Q9DFALvF/ikw8WS4QvVZALS5ksw47/7R8ejgTPk1UFqU6/3zp8bOM7B/kdu/fkguPGU5JibW+F0sTjWOUw8DklRrg4BiLGeBqbaRLxjlT4no0InFV402RcftJz41cH/f/JnHP3kZaaF6VX/liwist9vYG5+NU9Cg3MNkt/+lU5wS8fTxq3mc7ILjDlAE4CJpe89BOWPiIjBhi9O6PI4G1jsc6RGB3lZwmS76k8H0zOKTkFboG8jS2krFKCX2fvTeaPHIBwAkMHHgncURnL3nuCSnxSopdIzN5th0BIonJ0Lf9yUA9iMkzdRWl3BixOusfDcwQVcS4UKIFwYfGPnM8wY/DyP9NFMXaTE5BU39tGkDgGZz+fJJG0oYcSaOafLcqdECY4LzfSObSzyUOgxqtyisr8SSNOOAkubWoh3TTaeA2YtFEXPnm5x81/j+6MI6JqyS25WSNU6hbCMKHG84marJbdR+vwakRhQLRuQpbzHRLjmpmijI+OmWCtq+LzWtnX5v30gHSsqmWne74DtiACi2+Wz0iXbuLt9D2cDyoPEkWOiyp5XUIwLMi/wJY1FbH5B9ONtdC1KrsD/Q0MCQAS0wccILORDW25amAeOtooAj/KQxfzF17uwTSQ1v3dJ7jnLINwdZYRDa4tPU0sHVXFo/vxFF5BqFqxRfOmgPCk4ft2NgKTCy2Y47JIEg+MIhjYsLy5I25qUYTQlCjMRHsr/UwdYwIK33UO1J5fFNB9XNO6akcywJofVmXQDP2wfrSPcI2xG5BSs3I+IosHr4EtvO1TDAu16xHQq5+ykMblfRXLbhEoFIdDTBdhldvzl+3CMg60ZktI2vNzLW6IIp0waLklot9L63yzuUp8dJd7bglPFe3hIXstBEP58/s6Ocyr4rH2+866ZNbriTzA0RSOWCwakMl1QJgculxPt8Z7O5GLdtW6bvU8R/nO1vb+hMExVAVtEAAAAASUVORK5CYII=");background-size:100%}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #5e7ce0}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #5e7ce0;border-spacing:0}.markdown-body thead{color:#fff;text-align:left}.markdown-body thead tr{background:#5e7ce0}.markdown-body thead th{border-bottom:1px solid #dfe1e6}.markdown-body tr{background-color:#fff}.markdown-body tr:nth-child(2n){background-color:#f2f5fc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#252b3a;padding:1px 23px;margin:22px 0;border-left:4px solid #5e7ce0;background-color:#f2f5fc}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{padding-left:10px;margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5e7ce0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ul li::marker{content:"•";color:#5e7ce0}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body input[type=checkbox]:before{display:inline-block;width:16px;height:16px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAAAhRJREFUeAHtnLEuBFEUhs9cu7JCskEhIrZAgYZGoREPwBuIygOoPITKA6jEG/AAolFoaFCgICIKZBNiY8Pyz5rNOWe9wNz5T7N3Z2eT/b/7zZlpziat3xKWBDJoEyh5EDd3DTk5r8vV7Yc8vzbl6zvfwvSERIYHyzI90SeLc1WZrFV85PR9oi+N/YMnOT6t/3tiLAeXFqqytjrSFacDYmfvQS6u37tOiPHA7FS/bK6PmWhpj4AJRYGA9MiKzLpK6An+cqiNVmRleUhArrec6PNzt/5sttLgh0cvcvfY6Px+ZNY9I6Ax6gKErY1xmZ8ZyD0E5MJGIgsyIZsunT3g7qALJuTdAp0nWyMTsunS2QNukbpwOcRaPpvOHvxzQow2ZBvrs+nsfLL8o0QQBJFdMO1XGkEjaIQlQCMsD/YIGkEjLAEaYXmwR9AIGmEJ0AjLgz2CRtAIS4BGWB7sETSCRlgCNMLyYI+gETTCEqARlgd7BI2gEZYAjbA82CNoBI2wBGiE5cEeQSNohCVAIywP9ggaQSMsARphebBH0AgaYQnQCMsjYC5SF2agYi2fTWcPGA7VFfO0n8+mswdMyOrCNJwnpz/P6xqZkE2Xzh4w8qcLI4Hbu/dydvkWBRAAQBZk0uOOyKyzp5PARRiF1puNtR+NTh+oMCvtJ+D8F2N6j6x+PrwzG46gRTDDm5BtsAGBg0X924Qfj7i23p7HNgQAAAAASUVORK5CYII=");background-size:100%;position:relative;right:2px;top:-5px}.markdown-body input[type=checkbox]:checked:before{background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAABMtJREFUeAHtXM2KFDEQzrQKruIu4mEXRFlUVLz4A4K7B99AcO8io0/gwQfxDVzFuwu+gQf34EG8iOAPKAh6EFlBFMSf/qa2uqszlVR6ZtYxM5PDJNVVSer78nU6KrHzpyxuVlwx44AY2O0T8eb9D7f5fMu9fPvdff7y0/36nbdgdhUdd+jgHnf62JxbObvgjh/d60Pu2R35ajx49Mk9frqlBk7Kw8sXF9y1K4t9cCoi7tz/4F68/tYXMIkPzpzY725dP9yA1tsjoIRpIQHogRWYZSmwJ4Reh06nI2Nd7rYEA8zAzqXAxhgq/pc1d9vHKbEX+Dr4JbzypJDc/YxXYi/wifRLeOXpU5q7n/FK7EXsnBBeeRoqd7/EHj1ZhleeiMjdz8pArRKR+0pb+UsCuK0SkftKW/kzeFmrRHCAxWzufsaJOkqExWzufpOI8EpP1jnCJCK80pN1jjCJ4ICwMigidz/jRD3bI7bZUInIfaWt/KUSuK0SEd4jqFvufgYva5UIDrCYzd3POFFHifhfV/7k8lwPw7D5mUSEV3r854ju2pK7ffOIWzk/X+Go803Lr+ooGqoiwkyP9xzRXVt0q9sE3CgJYTLqfNPyE/irpkoEe2um6ck4bSiBSeD8JBl41jY/Hgd1lIiaaeoyLlsjgUGAjEH3DB4DtUpEW2Z3Mj5GAgA8efbVvXpX/200nln5IMYvKhHDrvylcwdc9+pSNdeg46WQsP7wo2s7fpWYaPT926fw9ZiVk4BpywYJkGuvlJs4EuWS0p/HTyHh3kbzH2najM85cR0lgpPiYMtukFB26m1u5Ua+vkFkWP3Zn0KCJDg1Px6f42Wtvhrhdyz8ncanrFKCmGH1wrwDMCrh/uxPIUFTAvdHbeVPsc1fVRE+c7Ud/k6fWt7XHFlYqcqQ5wTRvWpiY4wrIZwfDUL+akDRUBXB/jCzFCH9SHCzTDRUmsro7z+cEvrHwxOZn2ZTL/pVFcEBtRLoiWXfxQ5ehvoHHx4vpIwUEuJKSMvPz5/zQq0qwmIy5m+rjBQSwnsCQYnlgwjfT72av6oifOba2qnKcOXeGVIP0rT3BALTNr8mBWSpRHAgmJSTtLGhDHwj+A9GPCbX2DNiBSRoShg0H8zl5y/njxIhJ0WntralDJmIbO+UEvz85Zwt9wj7HIDB5Ttp7RkyGbRDSqC49vOjX50P9aexmr+qInzmajvtO13H02SpyrCVMNj8dT7/4BwByDXzRIC0LWXEldA/njVfip9GpV9VERxQM0lPhrVDyrCVMJr5/fwZJ+qWewR1lSuNJ21sXxnjVgIhck5VhM/cqG1WBpIAMX4Z9Xz+eP58sFUiOBArLQcZpQ0CNCXt1HzA5OfPOFGrrwYHyKTwbNJsxolaJUJbKeo0mu/4uMeXBHBbJSK88qP5jo97fAYva5UIDgivHEXk7mecqKNEhFeOhsjdbxKR+0pb+UsCuK0qIveVtvJn8LJWieAAi9nc/YwTdZQIi9nc/SYR4ZWenSO2yZvgcwTuRYZKWBnUI3e/xF7gcmio5L4HWPlL7AVuyPol95W28me8EnuBa8J+sZjM3c94JfYCd6VxTXjaCjDLe+K9cwTuSuOa8LQUYPXvh1d3w0HC7JK8kMK0/rcJfwHkVMYgi4xhOgAAAABJRU5ErkJggg==");background-size:100%}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">写在开头</h2>
<p>Hello everyone! 🤠</p>
<p>在<a href="https://juejin.cn/post/7589107312112648201" target="_blank" title="https://juejin.cn/post/7589107312112648201">LogicFlow 交互新体验：让锚点"活"起来，鼠标跟随动效实战！🧲</a>中，咱们解决了锚点的吸附交互问题。今天小编要分享的是另一项细节优化——<strong>连线轨迹（Trajectory）</strong>。</p>
<p>大家在使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fsite.logic-flow.cn%2F" target="_blank" title="https://site.logic-flow.cn/" ref="nofollow noopener noreferrer">LogicFlow</a> 时，默认的拖拽连线，无论你最终生成的边是折线还是曲线，<strong>在鼠标拖拽的过程中，跟随鼠标的那条线始终是一条笔直的虚线。</strong></p>
<p>效果如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da27f5885fc04a83ac3118969d99cdbe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qmZ5p-Q5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767670586&amp;x-signature=Wmm9kjjm6zq0dpr7oU2wWU11mCE%3D" alt="123002.gif" loading="lazy"/></p>
<p>对于一个追求极致体验的项目来说，这多少有点 "出戏"。🤔</p>
<p>在小编的项目中，我们最终生成的<strong>边</strong>是<strong>贝塞尔曲线</strong>，根据设计人员的要求，连线过程中也期望是以曲线的形式，以此匹配项目的整体设计规范。</p>
<p>于是，小编在翻阅 <a href="https://link.juejin.cn?target=https%3A%2F%2Fsite.logic-flow.cn%2Fapi%2Fdetail%2Fconstructor" target="_blank" title="https://site.logic-flow.cn/api/detail/constructor" ref="nofollow noopener noreferrer">LogicFlow</a> 文档时，找了一个 <code>customTrajectory</code> 属性，它能让咱们进行<strong>自定义连线轨迹</strong>。✨</p>
<blockquote>
<p>非常灵活方便，在小编早期技术选型时，也是看中了 LogicFlow 库超强的自定义能力。</p>
</blockquote>
<p>优化后的最终效果如下，请诸君按需食用哈。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c9c609f4565e400e9a49b990ca56dd30~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qmZ5p-Q5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767670586&amp;x-signature=lee8t6EpORIfSLtG6hCZ%2BGnSwOo%3D" alt="123001.gif" loading="lazy"/></p>
<h2 data-id="heading-1">需求背景</h2>
<p>在小编项目中，节点之间的边采用的是<strong>三次贝塞尔曲线</strong>（<code>bezierCurveEdge</code>），并且我们对边进行自定义开发。</p>
<p>但是，目前的痛点是：</p>
<ul>
<li><strong>视觉割裂</strong>：拖拽时是直线，松手后变曲线，视觉体验不连续。</li>
<li><strong>风格不符</strong>：生硬的直线无法体现项目整体“圆润、流畅”的设计语言。</li>
</ul>
<p>设计人员想要的效果是：</p>
<ul>
<li>用户拖拽连线时，跟随鼠标的引导线直接展示为<strong>曲线</strong>。</li>
<li>引导线的曲率动态计算，与最终生成的边保持一致。</li>
</ul>
<h2 data-id="heading-2">具体实现</h2>
<p>LogicFlow 提供了一个非常强大的配置项 <a href="https://link.juejin.cn?target=https%3A%2F%2Fsite.logic-flow.cn%2Fapi%2Fdetail%2Fconstructor" target="_blank" title="https://site.logic-flow.cn/api/detail/constructor" ref="nofollow noopener noreferrer">customTrajectory</a>，允许我们自定义连线过程中引导线的渲染逻辑。</p>
<h3 data-id="heading-3">第1️⃣步：理解customTrajectory属性</h3>
<p>从文档上看 <code>customTrajectory</code> 属性接收的是一个函数，扒其相关的源码。⏰</p>
<p>源码位置在： <code>packages/core/src/view/Anchor.tsx</code></p>
<p>核心逻辑如下：</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a6a4c65ce8264f5eaf846ddd86b3524e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qmZ5p-Q5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767670586&amp;x-signature=mzbKvDX5qskNRxInW%2FF991vRN2M%3D" alt="image.png" width="50%" loading="lazy"/>
<p>从源码中可以清晰地看到，<code>customTrajectory</code> 是一个优先级更高的渲染函数。它接收起点 (<code>sourcePoint</code>)、终点 (<code>targetPoint</code>) 以及样式配置 (<code>edgeStyle</code>)，要求返回一个 VDOM 节点（它在 <code>render</code> 函数中，通常是 SVG 元素）。</p>
<p>LogicFlow 内部使用 Preact/React 的 VDOM 机制，所以我们需要引入其的 <code>h</code> 函数来创建元素。</p>
<h3 data-id="heading-4">第2️⃣步：编写贝塞尔轨迹算法</h3>
<p>核心难点在于计算贝塞尔曲线的<strong>控制点</strong>。为了让曲线看起来自然，通常控制点会根据起点和终点的相对位置进行偏移。</p>
<p>咱们新建文件 <code>customTrajectory.js</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { h } <span class="hljs-keyword">from</span> <span class="hljs-string">"@logicflow/core"</span>;

<span class="hljs-comment">// 定义一些常量，保持与最终边的样式一致</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">STROKE_COLOR</span> = <span class="hljs-string">"#2961F7"</span>; <span class="hljs-comment">// 引导线颜色</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">STROKE_WIDTH</span> = <span class="hljs-number">1</span>;

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@name</span> 自定义连线轨迹
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">object</span>} params 轨迹参数对象
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">{x:number,y:number</span>}} params.sourcePoint 起点坐标
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">{x:number,y:number</span>}} params.targetPoint 终点坐标（即鼠标当前位置）
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">*</span>} Preact 虚拟节点
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">customTrajectory</span>(<span class="hljs-params">{ sourcePoint, targetPoint, ...edgeStyle }</span>) {
  <span class="hljs-keyword">const</span> { <span class="hljs-attr">x</span>: startX, <span class="hljs-attr">y</span>: startY } = sourcePoint;
  <span class="hljs-keyword">const</span> { <span class="hljs-attr">x</span>: endX, <span class="hljs-attr">y</span>: endY } = targetPoint;
  
  <span class="hljs-comment">// 1. 计算水平和垂直方向的距离</span>
  <span class="hljs-keyword">const</span> dx = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(endX - startX);
  <span class="hljs-keyword">const</span> dy = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(endY - startY);
  
  <span class="hljs-comment">// 2. 计算控制点偏移量</span>
  <span class="hljs-comment">// 这里采用“以水平方向为主”的策略，系数 0.6 是经验值，可以让曲线弯得更好看</span>
  <span class="hljs-keyword">const</span> controlOffset = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(dx, dy) * <span class="hljs-number">0.6</span>;
  
  <span class="hljs-comment">// 3. 生成三次贝塞尔曲线的路径（C 指令：C 控制点1.x,控制点1.y 控制点2.x,控制点2.y 终点.x,终点.y）</span>
  <span class="hljs-keyword">let</span> d = <span class="hljs-string">""</span>;
  
  <span class="hljs-keyword">if</span> (endX &gt; startX &amp;&amp; endY &gt; startY) {
    <span class="hljs-comment">// 右下方向：控制点1 右上，控制点2 左下</span>
    d = <span class="hljs-string">`M <span class="hljs-subst">${startX}</span>,<span class="hljs-subst">${startY}</span> C <span class="hljs-subst">${startX + controlOffset}</span>,<span class="hljs-subst">${startY}</span> <span class="hljs-subst">${endX - controlOffset}</span>,<span class="hljs-subst">${endY}</span> <span class="hljs-subst">${endX}</span>,<span class="hljs-subst">${endY}</span>`</span>;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (endX &gt; startX &amp;&amp; endY &lt; startY) {
    <span class="hljs-comment">// 右上方向：控制点1 右下，控制点2 左上</span>
    d = <span class="hljs-string">`M <span class="hljs-subst">${startX}</span>,<span class="hljs-subst">${startY}</span> C <span class="hljs-subst">${startX + controlOffset}</span>,<span class="hljs-subst">${startY}</span> <span class="hljs-subst">${endX - controlOffset}</span>,<span class="hljs-subst">${endY}</span> <span class="hljs-subst">${endX}</span>,<span class="hljs-subst">${endY}</span>`</span>;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (endX &lt; startX &amp;&amp; endY &gt; startY) {
    <span class="hljs-comment">// 左下方向：控制点1 左上，控制点2 右下</span>
    d = <span class="hljs-string">`M <span class="hljs-subst">${startX}</span>,<span class="hljs-subst">${startY}</span> C <span class="hljs-subst">${startX - controlOffset}</span>,<span class="hljs-subst">${startY}</span> <span class="hljs-subst">${endX + controlOffset}</span>,<span class="hljs-subst">${endY}</span> <span class="hljs-subst">${endX}</span>,<span class="hljs-subst">${endY}</span>`</span>;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 左上方向：控制点1 左下，控制点2 右上</span>
    d = <span class="hljs-string">`M <span class="hljs-subst">${startX}</span>,<span class="hljs-subst">${startY}</span> C <span class="hljs-subst">${startX - controlOffset}</span>,<span class="hljs-subst">${startY}</span> <span class="hljs-subst">${endX + controlOffset}</span>,<span class="hljs-subst">${endY}</span> <span class="hljs-subst">${endX}</span>,<span class="hljs-subst">${endY}</span>`</span>;
  }

  <span class="hljs-comment">// 4. 返回 SVG Path 元素</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">h</span>(
    <span class="hljs-string">"path"</span>, 
    {
      d,
      <span class="hljs-attr">fill</span>: <span class="hljs-string">"none"</span>,
      <span class="hljs-attr">pointerEvents</span>: <span class="hljs-string">"none"</span>, <span class="hljs-comment">// 极其重要！防止引导线阻挡鼠标事件</span>
      ...edgeStyle,
      <span class="hljs-attr">strokeDasharray</span>: <span class="hljs-literal">undefined</span>, <span class="hljs-comment">// 小编的项目设计不需要虚线，所以清除掉，你可以根据自己需要</span>
      <span class="hljs-attr">stroke</span>: <span class="hljs-variable constant_">STROKE_COLOR</span>, 
      <span class="hljs-attr">strokeWidth</span>: <span class="hljs-variable constant_">STROKE_WIDTH</span>, 
    },
  );
}
</code></pre>
<p><strong>注意</strong>🔉：这里的控制点计算逻辑（<code>controlOffset</code>）最好与你的边里的逻辑保持一致，这样松手的一瞬间，线条才不会有奇怪的 "跳动"。</p>
<blockquote>
<p>这里如此复杂的计算是小编自己写的？那么牛？🐮</p>
<p>当然不是，这里小编也是借助了AI的协助。这要是放在几年前，这种交互效果直接就砍掉，实在太费劲了，现在不一样了，你让AI帮助你写，只要你提示词写得足够清楚，AI分分钟帮你解决，你只要调调参数，验收结果就行了。</p>
</blockquote>
<h3 data-id="heading-5">第3️⃣步：注册配置</h3>
<p>最后，在初始化 LogicFlow 时，将这个函数传给 <code>customTrajectory</code> 选项。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">LogicFlow</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"@logicflow/core"</span>;
<span class="hljs-keyword">import</span> customTrajectory <span class="hljs-keyword">from</span> <span class="hljs-string">"./customTrajectory"</span>;

<span class="hljs-keyword">const</span> lf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LogicFlow</span>({
  <span class="hljs-attr">container</span>: <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">"#container"</span>),
  <span class="hljs-comment">// ... 其他配置</span>
  
  <span class="hljs-comment">// 注册自定义轨迹</span>
  <span class="hljs-attr">customTrajectory</span>: customTrajectory,
  
  <span class="hljs-comment">// 确保最终生成的边也是贝塞尔曲线</span>
  <span class="hljs-attr">edgeGenerator</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-string">"bezierCurveEdge"</span>, 
});
</code></pre>
<h2 data-id="heading-6">总结</h2>
<p>通过简单的数学计算和 VDOM 渲染，咱们成功将 LogicFlow 的连线轨迹从 "工业风" 的直线升级成了 "艺术风" 的曲线。😋</p>
<p>希望这个小技巧能让你的流程图编辑体验更加出色！🌟</p>
<br/>
<hr/>
<p><br/><br/></p>
<p>至此，本篇文章就写完啦，撒花撒花。</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b2198fba2b674f1b935a63e4abb3cbd7~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=90&amp;h=90&amp;s=8866&amp;e=png&amp;b=fcfcfc" alt="image.png" loading="lazy"/></p>
<p>希望本文对你有所帮助，如有任何疑问，期待你的留言哦。<br/>
老样子，点赞+评论=你会了，收藏=你精通了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[将 Markdown 文件导入为 React 组件 - 写作文档，即时获取交互式演示]]></title>    <link>https://juejin.cn/post/7589207474134155314</link>    <guid>https://juejin.cn/post/7589207474134155314</guid>    <pubDate>2025-12-30T03:39:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589207474134155314" data-draft-id="7589168816527933467" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="将 Markdown 文件导入为 React 组件 - 写作文档，即时获取交互式演示"/> <meta itemprop="keywords" content="前端,React.js,Markdown"/> <meta itemprop="datePublished" content="2025-12-30T03:39:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="郭小铭"/> <meta itemprop="url" content="https://juejin.cn/user/1345457961570638"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            将 Markdown 文件导入为 React 组件 - 写作文档，即时获取交互式演示
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1345457961570638/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    郭小铭
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T03:39:05.000Z" title="Tue Dec 30 2025 03:39:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body .octicon{display:inline-block;fill:currentColor;vertical-align:text-bottom}.markdown-body .anchor{float:left;line-height:1;margin-left:-20px;padding-right:4px}.markdown-body .anchor:focus{outline:none}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{color:#1b1f23;vertical-align:middle;visibility:hidden}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{text-decoration:none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{visibility:visible}.markdown-body h1:hover .anchor .octicon-link:before,.markdown-body h2:hover .anchor .octicon-link:before,.markdown-body h3:hover .anchor .octicon-link:before,.markdown-body h4:hover .anchor .octicon-link:before,.markdown-body h5:hover .anchor .octicon-link:before,.markdown-body h6:hover .anchor .octicon-link:before{width:16px;height:16px;content:" ";display:inline-block;background-image:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' aria-hidden='true'%3E%3Cpath fill-rule='evenodd' d='M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z'/%3E%3C/svg%3E")}.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#24292e;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;font-size:16px;line-height:1.5;word-wrap:break-word}.markdown-body details{display:block}.markdown-body summary{display:list-item}.markdown-body a{background-color:initial}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body strong{font-weight:inherit;font-weight:bolder}.markdown-body h1{margin:.67em 0}.markdown-body img{border-style:none}.markdown-body code,.markdown-body kbd,.markdown-body pre{font-family:monospace,monospace;font-size:1em}.markdown-body hr{box-sizing:initial;overflow:visible}.markdown-body input{font:inherit;margin:0;overflow:visible}.markdown-body [type=checkbox]{box-sizing:border-box;padding:0}.markdown-body *{box-sizing:border-box}.markdown-body input{font-family:inherit;font-size:inherit;line-height:inherit}.markdown-body a{color:#0366d6;text-decoration:none}.markdown-body a:hover{text-decoration:underline}.markdown-body strong{font-weight:600}.markdown-body hr{height:0;margin:15px 0;overflow:hidden;background:transparent;border-bottom:1px solid #dfe2e5}.markdown-body hr:after,.markdown-body hr:before{display:table;content:""}.markdown-body hr:after{clear:both}.markdown-body table{border-spacing:0;border-collapse:collapse}.markdown-body td,.markdown-body th{padding:0}.markdown-body details summary{cursor:pointer}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:0;margin-bottom:0}.markdown-body h1{font-size:32px}.markdown-body h1,.markdown-body h2{font-weight:600}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:20px}.markdown-body h3,.markdown-body h4{font-weight:600}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:14px}.markdown-body h5,.markdown-body h6{font-weight:600}.markdown-body h6{font-size:12px}.markdown-body p{margin-top:0;margin-bottom:10px}.markdown-body blockquote{margin:0}.markdown-body ol,.markdown-body ul{padding-left:0;margin-top:0;margin-bottom:0}.markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman}.markdown-body ol ol ol,.markdown-body ol ul ol,.markdown-body ul ol ol,.markdown-body ul ul ol{list-style-type:lower-alpha}.markdown-body dd{margin-left:0}.markdown-body code,.markdown-body pre{font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px}.markdown-body pre{margin-top:0;margin-bottom:0}.markdown-body input::-webkit-inner-spin-button,.markdown-body input::-webkit-outer-spin-button{margin:0;-webkit-appearance:none;appearance:none}.markdown-body :checked+.radio-label{position:relative;z-index:1;border-color:#0366d6}.markdown-body .border{border:1px solid #e1e4e8!important}.markdown-body .border-0{border:0!important}.markdown-body .border-bottom{border-bottom:1px solid #e1e4e8!important}.markdown-body .rounded-1{border-radius:3px!important}.markdown-body .bg-white{background-color:#fff!important}.markdown-body .bg-gray-light{background-color:#fafbfc!important}.markdown-body .text-gray-light{color:#6a737d!important}.markdown-body .pl-3,.markdown-body .px-3{padding-left:16px!important}.markdown-body .px-3{padding-right:16px!important}.markdown-body .f6{font-size:12px!important}.markdown-body .lh-condensed{line-height:1.25!important}.markdown-body .text-bold{font-weight:600!important}.markdown-body .pl-c{color:#6a737d}.markdown-body .pl-c1,.markdown-body .pl-s .pl-v{color:#005cc5}.markdown-body .pl-e,.markdown-body .pl-en{color:#6f42c1}.markdown-body .pl-s .pl-s1,.markdown-body .pl-smi{color:#24292e}.markdown-body .pl-ent{color:#22863a}.markdown-body .pl-k{color:#d73a49}.markdown-body .pl-pds,.markdown-body .pl-s,.markdown-body .pl-s .pl-pse .pl-s1,.markdown-body .pl-sr,.markdown-body .pl-sr .pl-cce,.markdown-body .pl-sr .pl-sra,.markdown-body .pl-sr .pl-sre{color:#032f62}.markdown-body .pl-smw,.markdown-body .pl-v{color:#e36209}.markdown-body .pl-bu{color:#b31d28}.markdown-body .pl-ii{color:#fafbfc;background-color:#b31d28}.markdown-body .pl-c2{color:#fafbfc;background-color:#d73a49}.markdown-body .pl-c2:before{content:"^M"}.markdown-body .pl-sr .pl-cce{font-weight:700;color:#22863a}.markdown-body .pl-ml{color:#735c0f}.markdown-body .pl-mh,.markdown-body .pl-mh .pl-en,.markdown-body .pl-ms{font-weight:700;color:#005cc5}.markdown-body .pl-mi{font-style:italic;color:#24292e}.markdown-body .pl-mb{font-weight:700;color:#24292e}.markdown-body .pl-md{color:#b31d28;background-color:#ffeef0}.markdown-body .pl-mi1{color:#22863a;background-color:#f0fff4}.markdown-body .pl-mc{color:#e36209;background-color:#ffebda}.markdown-body .pl-mi2{color:#f6f8fa;background-color:#005cc5}.markdown-body .pl-mdr{font-weight:700;color:#6f42c1}.markdown-body .pl-ba{color:#586069}.markdown-body .pl-sg{color:#959da5}.markdown-body .pl-corl{text-decoration:underline;color:#032f62}.markdown-body .mb-0{margin-bottom:0!important}.markdown-body .my-2{margin-bottom:8px!important;margin-top:8px!important}.markdown-body .pl-0{padding-left:0!important}.markdown-body .py-0{padding-top:0!important;padding-bottom:0!important}.markdown-body .pl-1{padding-left:4px!important}.markdown-body .pl-2{padding-left:8px!important}.markdown-body .py-2{padding-top:8px!important;padding-bottom:8px!important}.markdown-body .pl-3{padding-left:16px!important}.markdown-body .pl-4{padding-left:24px!important}.markdown-body .pl-5{padding-left:32px!important}.markdown-body .pl-6{padding-left:40px!important}.markdown-body .pl-7{padding-left:48px!important}.markdown-body .pl-8{padding-left:64px!important}.markdown-body .pl-9{padding-left:80px!important}.markdown-body .pl-10{padding-left:96px!important}.markdown-body .pl-11{padding-left:112px!important}.markdown-body .pl-12{padding-left:128px!important}.markdown-body hr{border-bottom-color:#eee}.markdown-body kbd{display:inline-block;padding:3px 5px;font:11px SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #d1d5da;border-radius:3px;box-shadow:inset 0 -1px 0 #d1d5da}.markdown-body:after,.markdown-body:before{display:table;content:""}.markdown-body:after{clear:both}.markdown-body&gt;:first-child{margin-top:0!important}.markdown-body&gt;:last-child{margin-bottom:0!important}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body blockquote,.markdown-body details,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body hr{height:.25em;padding:0;margin:24px 0;background-color:#e1e4e8;border:0}.markdown-body blockquote{padding:0 1em;color:#6a737d;border-left:.25em solid #dfe2e5}.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1{font-size:2em}.markdown-body h1,.markdown-body h2{padding-bottom:.3em;border-bottom:1px solid #eaecef}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{font-size:.85em;color:#6a737d}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li{word-wrap:break-all}.markdown-body li&gt;p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:600}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body table{display:block;width:100%;overflow:auto}.markdown-body table th{font-weight:600}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #dfe2e5}.markdown-body table tr{background-color:#fff;border-top:1px solid #c6cbd1}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}.markdown-body img{max-width:100%;box-sizing:initial;background-color:#fff}.markdown-body img[align=right]{padding-left:20px}.markdown-body img[align=left]{padding-right:20px}.markdown-body code{padding:.2em .4em;margin:0;font-size:85%;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body pre{word-wrap:normal}.markdown-body pre&gt;code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:transparent;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f6f8fa;border-radius:3px}.markdown-body pre code{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:initial;border:0}.markdown-body .commit-tease-sha{display:inline-block;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:90%;color:#444d56}.markdown-body .full-commit .btn-outline:not(:disabled):hover{color:#005cc5;border-color:#005cc5}.markdown-body .blob-wrapper{overflow-x:auto;overflow-y:hidden}.markdown-body .blob-wrapper-embedded{max-height:240px;overflow-y:auto}.markdown-body .blob-num{width:1%;min-width:50px;padding-right:10px;padding-left:10px;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;line-height:20px;color:rgba(27,31,35,.3);text-align:right;white-space:nowrap;vertical-align:top;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-body .blob-num:hover{color:rgba(27,31,35,.6)}.markdown-body .blob-num:before{content:attr(data-line-number)}.markdown-body .blob-code{position:relative;padding-right:10px;padding-left:10px;line-height:20px;vertical-align:top}.markdown-body .blob-code-inner{overflow:visible;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;color:#24292e;word-wrap:normal;white-space:pre}.markdown-body .pl-token.active,.markdown-body .pl-token:hover{cursor:pointer;background:#ffea7f}.markdown-body .tab-size[data-tab-size="1"]{-moz-tab-size:1;tab-size:1}.markdown-body .tab-size[data-tab-size="2"]{-moz-tab-size:2;tab-size:2}.markdown-body .tab-size[data-tab-size="3"]{-moz-tab-size:3;tab-size:3}.markdown-body .tab-size[data-tab-size="4"]{-moz-tab-size:4;tab-size:4}.markdown-body .tab-size[data-tab-size="5"]{-moz-tab-size:5;tab-size:5}.markdown-body .tab-size[data-tab-size="6"]{-moz-tab-size:6;tab-size:6}.markdown-body .tab-size[data-tab-size="7"]{-moz-tab-size:7;tab-size:7}.markdown-body .tab-size[data-tab-size="8"]{-moz-tab-size:8;tab-size:8}.markdown-body .tab-size[data-tab-size="9"]{-moz-tab-size:9;tab-size:9}.markdown-body .tab-size[data-tab-size="10"]{-moz-tab-size:10;tab-size:10}.markdown-body .tab-size[data-tab-size="11"]{-moz-tab-size:11;tab-size:11}.markdown-body .tab-size[data-tab-size="12"]{-moz-tab-size:12;tab-size:12}.markdown-body .task-list-item{list-style-type:none}.markdown-body .task-list-item+.task-list-item{margin-top:3px}.markdown-body .task-list-item input{margin:0 .2em .25em -1.6em;vertical-align:middle}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><p>我最近将 react-code-view 进行了重写, 基于 unplugin 让 Markdown 可以直接导入渲染成一个 React 组件. 以下是一个简单示例</p>
<h2 data-id="heading-0">1.安装</h2>
<pre><code class="hljs language-sql" lang="sql">npm install <span class="hljs-variable">@react</span><span class="hljs-operator">-</span>code<span class="hljs-operator">-</span><span class="hljs-keyword">view</span><span class="hljs-operator">/</span>react <span class="hljs-variable">@react</span><span class="hljs-operator">-</span>code<span class="hljs-operator">-</span><span class="hljs-keyword">view</span><span class="hljs-operator">/</span>unplugin
</code></pre>
<h2 data-id="heading-1">2.配置构建工具(支持 vite/webpack/esbuild/rollup)</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vite.config.js</span>
<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>;
<span class="hljs-keyword">import</span> react <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-react'</span>;
<span class="hljs-keyword">import</span> reactCodeView <span class="hljs-keyword">from</span> <span class="hljs-string">'@react-code-view/unplugin/vite'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-title function_">react</span>(),
    <span class="hljs-title function_">reactCodeView</span>() <span class="hljs-comment">// Enable markdown import</span>
  ]
});
</code></pre>
<h2 data-id="heading-2">3.使用有代码块创建 Markdown 文件</h2>
<p>demo.md</p>
<pre><code class="hljs language-xml" lang="xml"># Counter Example


A simple counter to demonstrate live code editing and preview.


<span class="hljs-comment">&lt;!--start-code--&gt;</span>
\`\`\`jsx
const App = () =&gt; {
  const [count, setCount] = useState(0);
  return (
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(c =&gt; c + 1)}&gt;
      Clicked {count} times
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  );
};

render(<span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span>);
\`\`\`
<span class="hljs-comment">&lt;!--end-code--&gt;</span>

- Click "Show Code" to view and edit the source
- Preview updates instantly while you type
- Click the copy button to reuse the code
</code></pre>
<h2 data-id="heading-3">4.导入并使用</h2>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Demo</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./demo.md'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Demo</span> /&gt;</span></span>;
}
</code></pre>
<h2 data-id="heading-4">最好渲染成的效果</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0d8d407ecfd443d8c283fd785655321~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YOt5bCP6ZOt:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767671129&amp;x-signature=OE212VBypGbCqQFF0ySm3EkqtXM%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">文档</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Frcv-rsuite.vercel.app%2F" target="_blank" title="https://rcv-rsuite.vercel.app/" ref="nofollow noopener noreferrer">rcv-rsuite.vercel.app/</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsimonguo%2Freact-code-view" target="_blank" title="https://github.com/simonguo/react-code-view" ref="nofollow noopener noreferrer">github.com/simonguo/re…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[依旧是隐式函数2.0]]></title>    <link>https://juejin.cn/post/7589167105386151972</link>    <guid>https://juejin.cn/post/7589167105386151972</guid>    <pubDate>2025-12-30T03:08:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589167105386151972" data-draft-id="7589201772133105705" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="依旧是隐式函数2.0"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-30T03:08:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吃马铃薯长大的土豆"/> <meta itemprop="url" content="https://juejin.cn/user/1162661349831369"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            依旧是隐式函数2.0
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1162661349831369/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吃马铃薯长大的土豆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T03:08:04.000Z" title="Tue Dec 30 2025 03:08:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">隐式函数的代码示范💕接下来的文章都是解析这个代码</h2>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">package</span> imp
<span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">tt</span> </span>{
  <span class="hljs-keyword">import</span> scala.language.postfixOps
  <span class="hljs-keyword">implicit</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FactorialInt</span>(<span class="hljs-params">n: <span class="hljs-type">Int</span></span>) </span>{
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">!</span> </span>: <span class="hljs-type">Int</span> = {
      <span class="hljs-keyword">if</span> (n &lt;= <span class="hljs-number">1</span>) <span class="hljs-number">1</span>
      <span class="hljs-keyword">else</span> n * ((n - <span class="hljs-number">1</span>)!)
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span></span>(args: <span class="hljs-type">Array</span>[<span class="hljs-type">String</span>]): <span class="hljs-type">Unit</span> = {
    println(<span class="hljs-number">4</span>!)
    println(<span class="hljs-number">5</span>!)
    println(<span class="hljs-number">0</span>!)
  }
}
</code></pre>
<h3 data-id="heading-1">👌一、代码整体结构 &amp; 核心目标😘</h3>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">package</span> imp  <span class="hljs-comment">// 代码所属包，用于隔离命名空间</span>
<span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">tt</span> </span>{   <span class="hljs-comment">// 单例对象（Scala 程序入口必须在 object 中）</span>
  <span class="hljs-comment">// 1. 启用后缀操作符语法（解决!的编译限制）</span>
  <span class="hljs-keyword">import</span> scala.language.postfixOps
  
  <span class="hljs-comment">// 2. 隐式类：为Int扩展阶乘方法</span>
  <span class="hljs-keyword">implicit</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FactorialInt</span>(<span class="hljs-params">n: <span class="hljs-type">Int</span></span>) </span>{
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">!</span> </span>: <span class="hljs-type">Int</span> = {  <span class="hljs-comment">// 阶乘方法（无参数，返回Int）</span>
      <span class="hljs-keyword">if</span> (n &lt;= <span class="hljs-number">1</span>) <span class="hljs-number">1</span>  <span class="hljs-comment">// 阶乘边界：0!和1!都等于1</span>
      <span class="hljs-keyword">else</span> n * ((n - <span class="hljs-number">1</span>)!)  <span class="hljs-comment">// 递归计算阶乘</span>
    }
  }

  <span class="hljs-comment">// 3. 主方法（程序入口）</span>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span></span>(args: <span class="hljs-type">Array</span>[<span class="hljs-type">String</span>]): <span class="hljs-type">Unit</span> = {
    println(<span class="hljs-number">4</span>!)  <span class="hljs-comment">// 计算4! = 24</span>
    println(<span class="hljs-number">5</span>!)  <span class="hljs-comment">// 计算5! = 120</span>
    println(<span class="hljs-number">0</span>!)  <span class="hljs-comment">// 计算0! = 1</span>
  }
}
</code></pre>
<h3 data-id="heading-2">二、关键语法逐行解析💕</h3>
<h4 data-id="heading-3">1. <code>import scala.language.postfixOps</code></h4>
<ul>
<li><strong>作用</strong>：显式启用 Scala 的「后缀操作符」特性。</li>
<li><strong>为什么需要</strong>：Scala 默认禁用 <code>4!</code> 这种 “操作符写在变量后面” 的语法（后缀操作符），因为容易引发歧义（比如 <code>a b</code> 可能被误解为 <code>a.b()</code> 或 <code>a apply b</code>）。<code>!</code> 在这里是自定义的后缀操作符，必须通过该导入声明启用，否则编译报错。</li>
</ul>
<h4 data-id="heading-4">2. <code>implicit class FactorialInt(n: Int)</code></h4>
<ul>
<li>
<p><strong>核心概念</strong>：隐式类是 Scala 2.10+ 引入的语法糖，本质是「隐式函数 + 普通类」的组合，专门用于为现有类型扩展方法。</p>
</li>
<li>
<p><strong>规则约束</strong>：</p>
<ul>
<li>
<p>隐式类必须定义在「类 / 对象 / 特质」内部（不能直接定义在包下）；</p>
</li>
<li>
<p>构造器必须只有<strong>一个参数</strong>（这里参数 <code>n: Int</code> 就是要扩展的目标类型）；</p>
</li>
<li>
<p>编译器会自动为隐式类生成一个「隐式转换函数」：</p>
<p>scala</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 编译器自动生成的隐式函数（无需手动写）</span>
<span class="hljs-function">implicit def <span class="hljs-title">intToFactorialInt</span><span class="hljs-params">(n: Int)</span>: FactorialInt =</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">FactorialInt</span>(n)
</code></pre>
</li>
</ul>
</li>
</ul>
<h4 data-id="heading-5">3. <code>def ! : Int = { ... }</code></h4>
<ul>
<li>
<p><strong>方法定义</strong>：定义了名为 <code>!</code> 的方法（模拟数学中的阶乘符号），无参数、返回值为 <code>Int</code>。</p>
<ul>
<li>注意：方法名省略了空参数列表 <code>()</code>，因为后缀操作符调用时（如 <code>4!</code>）不允许带 <code>()</code>，若保留 <code>!()</code> 则必须写 <code>4!()</code>，不符合阶乘的直观写法。</li>
</ul>
</li>
<li>
<p><strong>阶乘逻辑</strong>：</p>
<ul>
<li>边界条件：<code>n &lt;= 1</code> 时返回 1（数学定义：<code>0! = 1</code>、<code>1! = 1</code>）；</li>
<li>递归逻辑：<code>n * ((n - 1)!)</code>，即 <code>n! = n × (n-1)!</code>（比如 <code>5! = 5 × 4!</code>）；</li>
<li>括号 <code>((n - 1)!)</code>：避免优先级歧义（乘法 <code>*</code> 优先级高于后缀操作符 <code>!</code>，加括号确保先算 <code>(n-1)!</code>）。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-6">4. <code>main</code> 方法（程序入口）</h4>
<pre><code class="hljs language-scala" lang="scala">println(<span class="hljs-number">4</span>!)  <span class="hljs-comment">// 编译器执行的隐式转换流程：</span>
<span class="hljs-comment">// 1. 发现 4（Int类型）没有 ! 方法；</span>
<span class="hljs-comment">// 2. 查找作用域内的隐式转换，找到 intToFactorialInt(4)；</span>
<span class="hljs-comment">// 3. 将 4 转换为 FactorialInt(4) 实例；</span>
<span class="hljs-comment">// 4. 调用该实例的 ! 方法，返回 24；</span>
<span class="hljs-comment">// 5. 同理，5! 返回 120，0! 返回 1。</span>
</code></pre>
<h3 data-id="heading-7">三、执行结果 &amp; 核心特性总结</h3>
<h4 data-id="heading-8">1. 执行结果</h4>
<pre><code class="hljs">24
120
1
</code></pre>
<h4 data-id="heading-9">2. 核心特性（隐式类的价值）</h4>

























<table><thead><tr><th>特性</th><th>说明</th></tr></thead><tbody><tr><td>无侵入扩展</td><td>无需修改 <code>Int</code> 类的源码（<code>Int</code> 是 Scala 原生类，无法修改），实现方法扩展</td></tr><tr><td>自动类型转换</td><td>编译器自动完成 <code>Int → FactorialInt</code> 的转换，调用时无需手动转换</td></tr><tr><td>语法简洁</td><td>用 <code>4!</code> 替代 <code>new FactorialInt(4).!</code>，贴近数学阶乘的书写习惯</td></tr><tr><td>作用域隔离</td><td>隐式类仅在 <code>tt</code> 对象内生效，不会污染全局命名空间</td></tr></tbody></table>
<h3 data-id="heading-10">四、常见扩展 &amp; 注意事项💕(❁´◡`❁)</h3>
<h4 data-id="heading-11">1. 非递归实现（避免栈溢出）</h4>
<p>递归版阶乘在 <code>n</code> 较大时（如 <code>1000!</code>）会触发栈溢出，可改为循环版：</p>
<p>scala</p>
<pre><code class="hljs language-css" lang="css">def ! : Int = {
  <span class="hljs-selector-tag">var</span> result = <span class="hljs-number">1</span>
  for (<span class="hljs-selector-tag">i</span> &lt;- <span class="hljs-number">2</span> <span class="hljs-selector-tag">to</span> n) result *= <span class="hljs-selector-tag">i</span>
  result
}
</code></pre>
<h4 data-id="heading-12">2. 注意事项</h4>
<ul>
<li>隐式类的构造器<strong>只能有一个参数</strong>（多参数会编译报错）；</li>
<li>后缀操作符仅建议用于直观的场景（如阶乘 <code>!</code>），避免滥用导致代码可读性下降；</li>
<li>若不想启用 <code>postfixOps</code>，可将方法名改为 <code>factorial</code>，调用时写 <code>4.factorial</code>（更通用）。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[redis基础面试题]]></title>    <link>https://juejin.cn/post/7589207843788275747</link>    <guid>https://juejin.cn/post/7589207843788275747</guid>    <pubDate>2025-12-30T03:49:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589207843788275747" data-draft-id="7589207843788111907" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="redis基础面试题"/> <meta itemprop="keywords" content="Redis"/> <meta itemprop="datePublished" content="2025-12-30T03:49:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="哈里谢顿"/> <meta itemprop="url" content="https://juejin.cn/user/3678304397695056"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            redis基础面试题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3678304397695056/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    哈里谢顿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T03:49:01.000Z" title="Tue Dec 30 2025 03:49:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>基于想提升自身代码基础的考虑，从网络上获取redis的面试题，来进行对redis基础的学习</p>
<h2 data-id="heading-0">1 redis 为什么快</h2>
<p>Redis的速度⾮常的快，单机的Redis就可以⽀撑每秒十几万的并发，相对于MySQL来说，性能是MySQL的⼏⼗倍。速度快的原因主要有⼏点：</p>
<ol>
<li><strong>完全基于内存操作</strong></li>
<li>使⽤单线程，避免了线程切换和竞态产生的消耗</li>
<li>基于⾮阻塞的IO多路复⽤机制</li>
<li>C语⾔实现，优化过的数据结构，基于⼏种基础的数据结构，redis做了⼤量的优化，性能极⾼<br/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a582e80f1a3e476b8411856f5ca289f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOI6YeM6LCi6aG_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767671341&amp;x-signature=nmnw9dqDKQ9chWtzzZFeHfCkeoU%3D" alt="Redis使用IO多路复用和自身事件模型" loading="lazy"/></li>
</ol>
<h2 data-id="heading-1">2 什么是I/O多路复用</h2>
<p>引用知乎上一个高赞的回答来解释什么是I/O多路复用。假设你是一个老师，让30个学生解答一道题目，然后检查学生做的是否正确，你有下面几个选择：</p>
<ul>
<li>第一种选择：按顺序逐个检查，先检查A，然后是B，之后是C、D。。。这中间如果有一个学生卡住，全班都会被耽误。这种模式就好比，你用循环挨个处理socket，根本不具有并发能力。</li>
<li>第二种选择：你创建30个分身，每个分身检查一个学生的答案是否正确。 这种类似于为每一个用户创建一个进程或者- 线程处理连接。</li>
<li>第三种选择，你站在讲台上等，谁解答完谁举手。这时C、D举手，表示他们解答问题完毕，你下去依次检查C、D的答案，然后继续回到讲台上等。此时E、A又举手，然后去处理E和A。</li>
</ul>
<p>第一种就是阻塞IO模型，第三种就是I/O复用模型。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d00f83ed65484371a05d059183196135~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOI6YeM6LCi6aG_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767671341&amp;x-signature=MPbKuobcAkJyGFTHCeqOpIW9usA%3D" alt="多路复用模型" loading="lazy"/></p>
<p>Linux系统有三种方式实现IO多路复用：select、poll和epoll。</p>
<p>例如epoll方式是将用户socket对应的fd注册进epoll，然后epoll帮你监听哪些socket上有消息到达，这样就避免了大量的无用操作。此时的socket应该采用非阻塞模式。</p>
<p>这样，整个过程只在进行select、poll、epoll这些调用的时候才会阻塞，收发客户消息是不会阻塞的，整个进程或者线程就被充分利用起来，这就是事件驱动，所谓的reactor模式。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[让 AI 分析我 3 年前写的代码，全是漏洞！]]></title>    <link>https://juejin.cn/post/7589166195797917723</link>    <guid>https://juejin.cn/post/7589166195797917723</guid>    <pubDate>2025-12-30T03:48:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589166195797917723" data-draft-id="7589194558287708198" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="让 AI 分析我 3 年前写的代码，全是漏洞！"/> <meta itemprop="keywords" content="程序员,代码规范,AI编程"/> <meta itemprop="datePublished" content="2025-12-30T03:48:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员鱼皮"/> <meta itemprop="url" content="https://juejin.cn/user/2444938365386621"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            让 AI 分析我 3 年前写的代码，全是漏洞！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2444938365386621/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员鱼皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T03:48:57.000Z" title="Tue Dec 30 2025 03:48:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，俺是程序员鱼皮。最近逛 GitHub 的时候，发现了一个挺有潜力的开源项目 —— DeepAudit，让 AI 帮你挖掘项目漏洞。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82ce9f55e33b4ca0a84cd41b5a6bba86~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767671336&amp;x-signature=Z9AtDPCDQOGpjqK%2FnmLvBpvcsXM%3D" alt="" loading="lazy"/></p>
<p>势头很猛啊，短短时间就涨了不少 star，看这 star 趋势图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ed37cd6bf294dc4abe3786f879e80f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767671336&amp;x-signature=YVMJFqfnZsUbpgN8NFvC0ZT8%2BQ0%3D" alt="" loading="lazy"/></p>
<p>这是一个 AI 代码审计工具，能自动分析你的代码，找出潜在的安全漏洞和代码问题。</p>
<p>作者很贴心地提供了在线体验版，可以直接使用，当然也支持本地部署。下面鱼皮以作者部署的在线体验版，带大家体验一下这个项目的功能。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e089e7aeb3db4793aabaca6291d56b92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767671336&amp;x-signature=GUSi04DMHsrMIKTjxdtper%2FF3DY%3D" alt="" loading="lazy"/></p>
<p>首先需要配置自己的大模型 API Key，国内的很多大模型都支持：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b9082baca18e4421bd3741416e6ff8c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767671336&amp;x-signature=eqEx6qZYvXS1YNRQ%2BtG1GM9Nvw0%3D" alt="" loading="lazy"/></p>
<p>如果想直接导入并分析你在 GitHub 上的项目，而不是手动上传代码，那么还需要配置 GitHub Token，让工具能够读取到你的仓库代码。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb6c93b116da457688a0bb594987cee4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767671336&amp;x-signature=dFGTAw6syVguDHsVMcxQTtNExLs%3D" alt="" loading="lazy"/></p>
<p>可以在 GitHub 上生成一个新的 Token：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/64f5e2aab4674a7a8b2e7baaa39a607d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767671336&amp;x-signature=z7LI2dOulL%2BSi5LnKvNGsLoIejs%3D" alt="" loading="lazy"/></p>
<p>配置好之后，就可以创建一个要分析的项目了，仓库地址要填写正确。这里鱼皮拿自己 3 年前做的个人开源项目 —— SQL 代码和数据生成器试试水。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec1d772f358f493eb80760377ed15b91~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767671336&amp;x-signature=DgRaazmZQR%2FTOIOxe7k3bowfv8c%3D" alt="创建新项目" loading="lazy"/></p>
<p>然后新建一个审计任务：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7aef4cd1bf9b4198bf66e826b5076e88~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767671336&amp;x-signature=bnqfX%2BcBKreAhb4RE0AdIMtsPe4%3D" alt="" loading="lazy"/></p>
<p>填写要分析的分支，还可以设置一些文件排除规则，比如排除 <code>node_modules</code>、测试文件等。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6a2cdc9a69846c183d6361dbd488ded~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767671336&amp;x-signature=i25saiNoPDSIV5u8CMjtEenOhKs%3D" alt="" loading="lazy"/></p>
<p>点击开始分析，AI 就屁颠儿屁颠儿干活了~</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e1c4a8369eee464a9deb2b3089dca197~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767671336&amp;x-signature=mPNPU0V5jgi9kIvJ4qI7vi8%2BtXg%3D" alt="" loading="lazy"/></p>
<p>我去，竟然发现了 123 个问题？！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/057213746dfa4764890e0c2c2a4203a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767671336&amp;x-signature=mgb87ms3ipWfKdpAVZYTQhYq77s%3D" alt="" loading="lazy"/></p>
<p>不过能写出 123 个问题，我感觉自己也是挺厉害的哈哈哈。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e4c36009bf14d2bbf82caa88f123421~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767671336&amp;x-signature=iqOId77xo5YUU2PPK0JrduB8XBc%3D" alt="" loading="lazy"/></p>
<p>进入任务详情页面，我倒要看看都是什么问题。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e0def0ec6564dfdae0883961c7b55e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767671336&amp;x-signature=quy%2Fl8484gzZW47YuqaPaKSBD7Q%3D" alt="" loading="lazy"/></p>
<p>先看看最严重的 —— SQL 注入漏洞。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a322f03d786e4c8db50426a740cf0592~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767671336&amp;x-signature=v%2B7SDsy19MpqFvPr401%2BqKmveqw%3D" alt="" loading="lazy"/></p>
<p>AI 的解释还挺到位的，确实存在 SQL 注入风险。当时这么写纯属图方便，没想到被 AI 一眼看穿了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a9e6b1c379541b0860bf4e55bb33f2c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767671336&amp;x-signature=LKY9t2at8wBp2E0UQf%2B9sxDybVs%3D" alt="" loading="lazy"/></p>
<p>一些小细节也被指出来了，比如硬编码、异常处理不够完善、日志记录不规范等。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2db47d441591496997c6b38afb1fa2f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767671336&amp;x-signature=qacv3%2B9jVo8WOCa8OrNJjyjQ3UU%3D" alt="" loading="lazy"/></p>
<p>不过也有一些误报，AI 把正常的代码逻辑判断成了问题。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/273325e6d16f4bab809828adb2c7c326~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767671336&amp;x-signature=gjEFDhdHSEoWZ6c%2BjUMWG0f6j98%3D" alt="" loading="lazy"/></p>
<p>总体来说，这个工具还有进步空间，但已经很实用了。正好我们团队需要这样的代码审计工具，还是挺期待作者能进一步完善的。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af4e4c578bb54ecaa95299e8b1ff3fe0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767671336&amp;x-signature=xyPWgZfA8Tml5ukdZytgIjUIBN8%3D" alt="" loading="lazy"/></p>
<p>审计完成后，还可以直接导出报告：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2d2b3bbe99884357bba2a13a0b3611a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767671336&amp;x-signature=Z9k%2BW5r4I8FmVNSx8mhZKxzWQXs%3D" alt="" loading="lazy"/></p>
<p>一下子就得到了整整 70 多页的专业报告！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce76163c65c34e61afe656c488fcca61~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767671336&amp;x-signature=Vgni0EorZMbDMwUAdIZSW4tkkLg%3D" alt="" loading="lazy"/></p>
<p>想想我大学的时候做课设作业，要是有 AI 帮忙生成这种报告，不得爽飞边子了？</p>
<p>除了项目审计，作者还提供了即时分析功能。不过这个就没什么新意了，我们团队的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcodecopy.cn%2F" target="_blank" title="https://codecopy.cn/" ref="nofollow noopener noreferrer">代码小抄</a>在 24 年初就已经上线了这个功能。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eaf5bece523543bbbb3a2dea800aae29~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767671336&amp;x-signature=rUfd8Ox5oH%2B9QV2anW0v8nMRf3M%3D" alt="" loading="lazy"/></p>
<p>我体验这个项目的时候，还有很多功能没做完，不过这也是 MVP 最小可行产品原则嘛，快速验证想法最重要。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d2a514e0d6d4727bc33e591ab2e7113~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767671336&amp;x-signature=qLgD%2BMgancWFUFHZJzazjrCYEpw%3D" alt="" loading="lazy"/></p>
<p>值得一提的是，作者更新非常频繁。截止到目前，项目界面已经焕然一新了，更有极客范儿。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dcc6ba8991ff4cefa4a51253640502e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767671336&amp;x-signature=jzCjNY3nxufTFEfAr0wUc0Z5AsE%3D" alt="" loading="lazy"/></p>
<p>在审计流日志页面可以看到 AI 思考分析的过程：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/541f377ba68a48e6820bcb1dedd89d8c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767671336&amp;x-signature=XGASWpH5doDuZJX6Zjic2pWYD88%3D" alt="" loading="lazy"/></p>
<p>还有智能仪表盘，可以直观地看到代码质量趋势：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d915b863adf6426795a91de3a86669b5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767671336&amp;x-signature=3hX4mwpQdMIL3t9D9UlqGKkytos%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">最后</h2>
<p>这个项目的实现思路其实挺值得学习的。通过调用大模型的 API，让 AI 理解代码逻辑，然后根据常见的安全漏洞模式和最佳实践进行分析，最后生成结构化的审计报告。整个流程和 AI 代码审查是类似的，但更专注于安全漏洞的发现。</p>
<p><img src="https://pic.yupi.icu/1/%25E6%259E%25B6%25E6%259E%2584%25E5%259B%25BE.png" alt="DeepAudit 架构图" loading="lazy"/></p>
<p>对于个人开发者来说，这类工具可以帮你在提交代码前发现潜在问题，拿来检测一下自己之前的老项目代码也是不错的；对于团队来说，可以把 AI 接入到 CI/CD 流程中，自动化代码安全检查。虽然本项目暂时还有误报，但随着 AI 能力的提升，以及作者在领域知识方面的填充，相信会越来越准确。</p>
<p>来试试看，你的项目代码里有多少个 Bug？</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21b51aacd4ee42cfb1159a394a162f73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767671336&amp;x-signature=lbr2m6qV0oYb76L3iCdBtvJWKUc%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">更多</h2>
<p>💻 编程学习交流：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Fcode-nav" target="_blank" title="https://github.com/liyupi/code-nav" ref="nofollow noopener noreferrer">编程导航</a> 📃 简历快速制作：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Flaoyujianli" target="_blank" title="https://github.com/liyupi/laoyujianli" ref="nofollow noopener noreferrer">老鱼简历</a> ✏️ 面试刷题神器：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Fmianshiya" target="_blank" title="https://github.com/liyupi/mianshiya" ref="nofollow noopener noreferrer">面试鸭</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[上架苹果App Store时开发者常忽略的15个问题及解决方法]]></title>    <link>https://juejin.cn/post/7589275237037146147</link>    <guid>https://juejin.cn/post/7589275237037146147</guid>    <pubDate>2025-12-30T03:55:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589275237037146147" data-draft-id="7589308109639958563" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="上架苹果App Store时开发者常忽略的15个问题及解决方法"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-30T03:55:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="开心猴爷"/> <meta itemprop="url" content="https://juejin.cn/user/2179705232165364"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            上架苹果App Store时开发者常忽略的15个问题及解决方法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2179705232165364/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    开心猴爷
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T03:55:33.000Z" title="Tue Dec 30 2025 03:55:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>上架苹果App商城时容易忽略的问题</p>
<p>在上架苹果App商城的过程中，开发者往往需要面对苹果公司极其严格且不断更新的审核标准体系。据苹果官方数据显示，约有30%的App初次提交会因各类细节问题被拒绝，其中许多看似微小的疏漏都可能导致审核失败、上架延迟甚至应用下架的风险。这些标准不仅涵盖技术性能、内容合规等基础维度，还延伸至用户隐私保护、无障碍设计、商业模式透明度等深层要求，且审核团队会结合市场反馈动态调整评估尺度。以下是经过大量开发者实践验证后总结出的、最容易被忽视但对审核结果至关重要的注意事项清单：</p>
<p>1. <strong>隐私政策链接缺失或内容不完善</strong></p>
<p>未在App Store Connect后台或应用内显著位置提供有效的隐私政策链接，尤其是涉及用户数据收集、存储或共享的App，苹果要求必须明确说明数据收集的类型、使用目的、存储期限及第三方共享情况。隐私政策需符合全球各地法规（如GDPR、CCPA等），且内容需与实际数据处理行为一致，避免出现模糊表述或虚假承诺。</p>
<p>2. <strong>应用截图不符合规范</strong></p>
<p>截图尺寸不正确、包含非官方元素（如其他平台的标识）或与实际应用界面不符，可能导致审核被拒。使用AppUploader可以方便地上传和管理应用截图，确保它们符合苹果的规范要求。</p>
<p>3. <strong>缺少详细的App描述</strong></p>
<p>应用描述过于简略，未能清晰说明核心功能、目标用户及使用场景，影响审核人员对App的理解。</p>
<p>4. <strong>未适配最新iOS版本</strong></p>
<p>App未针对最新的iOS系统进行优化，可能存在兼容性问题或无法正常运行的情况。</p>
<p>5. <strong>权限请求不合理</strong></p>
<p>请求了不必要的用户权限（如访问照片、位置等），但未在App中实际使用这些权限，违反苹果的权限管理规定。</p>
<p>6. <strong>测试账号信息未提供</strong></p>
<p>如果App需要登录才能体验完整功能，未提供测试账号和密码可能导致审核人员无法全面评估App。AppUploader支持测试设备UDID管理和IPA安装测试，方便开发者提供测试账号进行审核。</p>
<p>7. <strong>内购项目配置错误</strong></p>
<p>对于包含内购功能的App，未正确配置内购项目或价格设置不当，可能引发审核失败。AppUploader提供了内购本地化信息批量上传功能，帮助正确配置内购内容。</p>
<p>8. <strong>违反设计规范</strong></p>
<p>界面设计不符合苹果的人机交互指南（Human Interface Guidelines），例如按钮过小、排版混乱等问题。</p>
<p>9. <strong>未处理敏感内容</strong></p>
<p>包含敏感内容（如暴力、政治、色情等）或未按要求加入年龄分级限制，可能导致直接拒绝。</p>
<p>10. <strong>推送通知滥用</strong></p>
<p>未经用户同意频繁发送推送通知，或推送内容不符合苹果的规定，会引发用户体验问题并导致审核受阻。</p>
<p>11. <strong>文件体积过大</strong></p>
<p>如果App安装包超过苹果推荐的大小限制（通常为200MB），需确保通过蜂窝网络下载时不会影响用户体验。</p>
<p>12. <strong>元数据不一致</strong></p>
<p>App标题、关键词、分类等元数据之间存在矛盾或模糊表述，会让审核团队难以判断其真实用途。AppUploader允许批量上传应用元数据，如描述关键词和多语言版本，确保一致性。</p>
<p>13. <strong>缺乏法律合规声明</strong></p>
<p>涉及版权、商标或其他法律相关的内容时，未附带必要的声明或证明材料，容易引发法律风险。</p>
<p>14. <strong>忽视多语言支持</strong></p>
<p>若目标市场包含多个国家/地区，未提供相应的多语言支持，会使部分用户难以理解App内容。</p>
<p>15. <strong>未解决崩溃问题</strong></p>
<p>在测试阶段发现的任何崩溃或卡顿现象未彻底修复，将严重影响审核通过率。</p>
<p>以上问题均需在提交前仔细检查，以提高App成功上架的概率。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Scala 技巧】用隐式类给 String “开挂”：一行代码实现手机号 / 身份证号校验]]></title>    <link>https://juejin.cn/post/7589207843788161059</link>    <guid>https://juejin.cn/post/7589207843788161059</guid>    <pubDate>2025-12-30T03:28:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589207843788161059" data-draft-id="7589186347585814562" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Scala 技巧】用隐式类给 String “开挂”：一行代码实现手机号 / 身份证号校验"/> <meta itemprop="keywords" content="Scala"/> <meta itemprop="datePublished" content="2025-12-30T03:28:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="代码于老总"/> <meta itemprop="url" content="https://juejin.cn/user/582105100725436"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Scala 技巧】用隐式类给 String “开挂”：一行代码实现手机号 / 身份证号校验
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/582105100725436/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    代码于老总
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T03:28:38.000Z" title="Tue Dec 30 2025 03:28:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，今天分享 Scala 中<strong>隐式类（implicit class）</strong>  的实用小技巧：只用几行代码，就能给原生<code>String</code>类型 “注入” 手机号、身份证号校验功能，让字符串自己就能判断合法性。</p>
<h2 data-id="heading-0">一、先看效果：字符串自己会 “验身” 了</h2>
<p>平时我们校验手机号，可能要写个工具类 + 静态方法，比如<code>CheckUtil.isPhone(str)</code>。但用 Scala 隐式类，<code>String</code>自己就能直接调方法：</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-comment">// 直接让字符串调用isPhone/isIDCard</span>
println(<span class="hljs-string">"13617295643"</span>.isPhone)          <span class="hljs-comment">// true（合法手机号）</span>
println(<span class="hljs-string">"429005202011012231"</span>.isIDCard) <span class="hljs-comment">// true（合法身份证）</span>
println(<span class="hljs-string">"136567891a"</span>.isPhone)          <span class="hljs-comment">// false（含字母）</span>
</code></pre>
<p>是不是很丝滑？这背后就是 Scala 的<strong>隐式类</strong>在起作用。</p>
<h2 data-id="heading-1">二、完整代码：50 行实现 “字符串增强”</h2>
<p>先展示代码，再拆解核心逻辑：</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">imp05</span> </span>{
  <span class="hljs-comment">// 隐式类：给String扩展方法</span>
  <span class="hljs-keyword">implicit</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StrongString</span>(<span class="hljs-params">s: <span class="hljs-type">String</span></span>) </span>{
    <span class="hljs-comment">// 手机号校验方法</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">isPhone</span></span>: <span class="hljs-type">Boolean</span> = {
      <span class="hljs-comment">// 手机号正则：1开头+3/5/6/7/8+9位数字</span>
      <span class="hljs-keyword">val</span> phoneReg = <span class="hljs-string">"^1[35678]\d{9}$"</span>.r
      phoneReg.matches(s)
    }

    <span class="hljs-comment">// 身份证号校验方法（18位）</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">isIDCard</span></span>: <span class="hljs-type">Boolean</span> = {
      <span class="hljs-comment">// 18位身份证正则：含行政区划、年月日、顺序码、校验码</span>
      <span class="hljs-keyword">val</span> idCardReg = <span class="hljs-string">"^[1-9]\d{5}(18|19|20)\d{2}((0[1-9])|(1[0-2]))(([0-2][1-9])|10|20|30|31)\d{3}[0-9Xx]$"</span>.r
      idCardReg.matches(s)
    }
  }

  <span class="hljs-comment">// 测试主方法</span>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span></span>(args: <span class="hljs-type">Array</span>[<span class="hljs-type">String</span>]): <span class="hljs-type">Unit</span> = {
    <span class="hljs-keyword">val</span> phone = <span class="hljs-string">"13617295643"</span>
    println(<span class="hljs-string">s"手机号[<span class="hljs-subst">$phone</span>]是否合法：<span class="hljs-subst">${phone.isPhone}</span>"</span>)  <span class="hljs-comment">// true</span>

    <span class="hljs-keyword">val</span> wrongPhone = <span class="hljs-string">"136567891a"</span>
    println(<span class="hljs-string">s"手机号[<span class="hljs-subst">$wrongPhone</span>]是否合法：<span class="hljs-subst">${wrongPhone.isPhone}</span>"</span>)  <span class="hljs-comment">// false</span>

    <span class="hljs-keyword">val</span> idCard = <span class="hljs-string">"429005202011012231"</span>
    println(<span class="hljs-string">s"身份证[<span class="hljs-subst">$idCard</span>]是否合法：<span class="hljs-subst">${idCard.isIDCard}</span>"</span>)  <span class="hljs-comment">// true</span>

    <span class="hljs-keyword">val</span> wrongIdCard = <span class="hljs-string">"40905020201101223a"</span>
    println(<span class="hljs-string">s"身份证[<span class="hljs-subst">$wrongIdCard</span>]是否合法：<span class="hljs-subst">${wrongIdCard.isIDCard}</span>"</span>)  <span class="hljs-comment">// false</span>
  }
}
</code></pre>
<h2 data-id="heading-2">三、核心知识点：隐式类的 “魔法”</h2>
<p>隐式类是 Scala 的语法糖，<strong>作用是给现有类型动态扩展方法</strong>，不需要继承或修改原类型代码（对原生类型<code>String</code>尤其友好）。</p>
<p>它的规则很简单：</p>
<ol>
<li>必须定义在<code>object</code>/<code>class</code>/<code>trait</code>内部（这里放在<code>imp05</code>单例对象里）；</li>
<li>构造器只能有一个参数（这里是<code>s: String</code>，代表要扩展的目标类型）；</li>
<li>隐式类中的方法，会自动成为目标类型的 “成员方法”。</li>
</ol>
<h2 data-id="heading-3">四、正则说明：校验逻辑不踩坑</h2>
<p>代码里的正则是 “实战级” 的，避免常见坑：</p>
<ul>
<li><strong>手机号正则</strong>：<code>^1[35678]\d{9}$</code>覆盖主流手机号段（3/5/6/7/8 开头），且严格限制 11 位，避免 “123456789012” 这种超长串。</li>
<li><strong>身份证号正则</strong>：<code>^[1-9]\d{5}(18|19|20)\d{2}((0[1-9])|(1[0-2]))(([0-2][1-9])|10|20|30|31)\d{3}[0-9Xx]$</code>支持 18 位身份证（含 18/19/20 开头的年份、合法的月份 / 日期、最后一位校验码 X/x）。</li>
</ul>
<h2 data-id="heading-4">五、实际场景：比工具类更优雅</h2>
<p>相比传统的<code>CheckUtil</code>工具类，隐式类的优势是<strong>代码更自然</strong>：</p>
<ul>
<li>工具类写法：<code>CheckUtil.isPhone(str)</code></li>
<li>隐式类写法：<code>str.isPhone</code></li>
</ul>
<p>后者更符合 “面向对象” 的直觉，读代码时一眼就能懂含义。</p>
<h2 data-id="heading-5">总结</h2>
<p>Scala 的隐式类是 “轻量级扩展现有类型” 的神器，尤其适合给原生类型（String/Int 等）加辅助方法。今天这个例子，只用一个隐式类就实现了字符串的手机号、身份证号校验，既简洁又优雅</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SwiftUI 涨知识：如何按条件动态切换 Toggle 视图的样式（.button 或 .switch）]]></title>    <link>https://juejin.cn/post/7589166195797131291</link>    <guid>https://juejin.cn/post/7589166195797131291</guid>    <pubDate>2025-12-30T02:19:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589166195797131291" data-draft-id="7589126920287600650" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SwiftUI 涨知识：如何按条件动态切换 Toggle 视图的样式（.button 或 .switch）"/> <meta itemprop="keywords" content="Swift,SwiftUI,Apple"/> <meta itemprop="datePublished" content="2025-12-30T02:19:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大熊猫侯佩"/> <meta itemprop="url" content="https://juejin.cn/user/4292907536222152"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SwiftUI 涨知识：如何按条件动态切换 Toggle 视图的样式（.button 或 .switch）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4292907536222152/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大熊猫侯佩
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T02:19:00.000Z" title="Tue Dec 30 2025 02:19:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e475395469c1463f8daf617e1336e341~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767665940&amp;x-signature=YTmqDIvgnqKYHadwDfHnPAyAWUA%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<blockquote>
<p>🕶️ 吞下这颗红色药丸，打破 SwiftUI 的物理法则
欢迎来到新库比蒂诺市的雨夜。在这里，SwiftUI 的 ToggleStyle 曾被认为是不可变更改的铁律——Switch 就是 Switch，Button 就是 Button，两者老死不相往来。但当挑剔的设计师 Trinity 甩出一张要求“视图无缝液态变形”的图纸，而大反派“重构特工”正虎视眈眈准备嘲笑你的代码时，你该怎么办？ <br/>
别慌，我是 Neo。在这篇文章中，我将带你潜入 ToggleStyle 的底层黑箱，利用 matchedGeometryEffect（量子纠缠） 和 生命周期依赖注入，上演一场骗过编译器的“移花接木”大戏。准备好了吗？让我们一起 Hack 进系统，创造那个“不可能”的开关。</p>
</blockquote>
<h2 data-id="heading-0">☔️ 引子</h2>
<p>这是一个发生在新库比蒂诺市（New Cupertino City）地下代码黑市的故事。雨一直在下，像极了那个永远修不完的 Memory Leak。</p>
<p>我是 <strong>Neo</strong>，一名专治各种 SwiftUI 疑难杂症的“清理者”。坐在我对面的是 <strong>Trinity</strong>，她是这个街区最挑剔的 UX 设计师。而那个总想把我们的代码重构成汇编语言的大反派 <strong>Agent Refactor（重构特工）</strong>，正躲在编译器的阴影里伺机而动。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fffb9f71011c49c5a7a9e11cafe6da97~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767665940&amp;x-signature=FupUPJ87VexlC1AgBI5o7ZqlCbc%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>Trinity 掐灭了手里的香烟，甩给我一张设计稿：“Neo，我要一个开关。平时它是 Switch，激动的时候它得变成 Button。而且，变化过程要像丝绸一样顺滑，不能有任何‘跳帧’。懂了吗？”</p>
<p><strong>在本篇博文中，您将学到如下内容：</strong></p>
<ul>
<li>☔️ 引子</li>
<li>🕵️‍♂️ 案发现场：静态类型的桎梏</li>
<li>🧬 第一招：量子纠缠（matchedGeometryEffect）</li>
<li>💊 终极方案：自定义 ToggleStyle 里的“移花接木”</li>
<li>⚠️ 技术黑箱（重点解析）</li>
<li>🎬 大结局：完美的调用</li>
<li>👀 SwiftUI 涨知识外传：修复“动画失效”的终极补丁（Namespace 的生命周期）</li>
<li>🕵️‍♂️ 真正的 Bug：Namespace 的生命周期</li>
<li>💉 手术方案：依赖注入</li>
<li>🧬 最终修正版代码 (Copy-Paste Ready)</li>
<li>🧠 技术复盘：为什么这能行？</li>
</ul>
<p>我皱了皱眉：“SwiftUI 的 <code>ToggleStyle</code> 是静态类型绑定的，你要在运行时<strong>偷梁换柱</strong>？这可是<strong>逆天改命</strong>的操作。”</p>
<p>Trinity 冷笑一声：“做不到？那我就去找 Agent Refactor，听说他最近在推行 UIKit 复辟运动。”</p>
<p>“慢着。”我按住她的手，打开了 Xcode，“给我十分钟。”</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6826748561ed45e6a6573552cf9c684b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767665940&amp;x-signature=9gbt%2BZfffCpyH5%2Bd5ryaUxKVojU%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-1">🕵️‍♂️ 案发现场：静态类型的桎梏</h2>
<p>在 SwiftUI 的世界法则里，<strong>类型即命运</strong>。通常我们写 <code>Toggle</code>，一旦指定了 <code>.toggleStyle(.switch)</code>，它这辈子就是个 Switch 了。</p>
<p>如果你天真地写出这种代码：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">if</span> change {
    <span class="hljs-type">Toggle</span>(<span class="hljs-string">"Click Me"</span>, isOn: <span class="hljs-variable">$state</span>).toggleStyle(.button)
} <span class="hljs-keyword">else</span> {
    <span class="hljs-type">Toggle</span>(<span class="hljs-string">"Click Me"</span>, isOn: <span class="hljs-variable">$state</span>).toggleStyle(.switch)
}
</code></pre>
<p><strong>Agent Refactor</strong> 会笑掉大牙。为什么？因为在 SwiftUI 看来，这是<strong>两个完全不同的 View</strong>。当 <code>change</code> 改变时，旧视图被无情销毁，新视图凭空重建。这会导致动画生硬得像个刚学会走路的僵尸，甚至会丢失点击时的按下状态。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3736f08c46564b7595eb1afe351345f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767665940&amp;x-signature=AiLajDChrpV29mREeFHiQz%2BCFgc%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>我们需要的是一种<strong>瞒天过海</strong>的手段，让 SwiftUI 以为它还在渲染同一个 View，但皮囊已经换了。</p>
<h2 data-id="heading-2">🧬 第一招：量子纠缠（matchedGeometryEffect）</h2>
<p>Trinity 看着屏幕上的闪烁，不耐烦地敲着桌子。我深吸一口气，祭出了神器：<code>matchedGeometryEffect</code>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/865fb2f50e1c4080929d61bda3edeb95~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767665940&amp;x-signature=0cDB9IfDoJITaQLVd2482CRDhFc%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>这东西就像是视图界的“量子纠缠”。虽然我们在代码里写了两个 Toggle，但通过统一的 <code>Namespace</code> 和 <code>ID</code>，我们可以骗过渲染引擎，让它以为这俩是前世今生。</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">ViewSwitchingStrategy</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-comment">// 定义一个命名空间，用于魔术般的几何匹配</span>
    <span class="hljs-meta">@Namespace</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> space
    <span class="hljs-comment">// 给这两个形态起个代号，就像特工的假名</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> <span class="hljs-type">AnimID</span> <span class="hljs-operator">=</span> <span class="hljs-string">"MorphingToggle"</span>
    
    <span class="hljs-meta">@State</span> <span class="hljs-keyword">var</span> isButtonStyle <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>
    <span class="hljs-meta">@State</span> <span class="hljs-keyword">var</span> isOn <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">VStack</span> {
            <span class="hljs-comment">// 剧情分支：根据状态渲染不同皮囊</span>
            <span class="hljs-keyword">if</span> isButtonStyle {
                <span class="hljs-type">Toggle</span>(isOn: <span class="hljs-variable">$isOn</span>) {
                    <span class="hljs-type">Text</span>(<span class="hljs-string">"芝麻开门"</span>)
                        <span class="hljs-comment">// 关键点：标记这个 Text 的几何特征</span>
                        .matchedGeometryEffect(id: <span class="hljs-type">AnimID</span>, in: space)
                }
                .toggleStyle(.button)
                <span class="hljs-comment">// 加上过渡动画，让切换不那么突兀</span>
                .transition(.scale(scale: <span class="hljs-number">0.8</span>).combined(with: .opacity))
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-type">Toggle</span>(isOn: <span class="hljs-variable">$isOn</span>) {
                    <span class="hljs-type">Text</span>(<span class="hljs-string">"芝麻开门"</span>)
                        <span class="hljs-comment">// 关键点：同一个 ID，同一个空间</span>
                        .matchedGeometryEffect(id: <span class="hljs-type">AnimID</span>, in: space)
                }
                .toggleStyle(.switch)
                .transition(.scale(scale: <span class="hljs-number">0.8</span>).combined(with: .opacity))
            }
            
            <span class="hljs-type">Button</span>(<span class="hljs-string">"变形！"</span>) {
                withAnimation(.spring()) {
                    isButtonStyle.toggle()
                }
            }
        }
        .padding()
    }
}
</code></pre>
<p>Trinity 眯起眼睛看了一会儿：“有点意思。文字平滑过渡了，但 Toggle 的外壳还是有点‘闪现’。而且……这代码太乱了，我有洁癖。”</p>
<p>她说得对。把逻辑散落在 View Body 里简直是<strong>画蛇添足</strong>。我们需要更高级的封装。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d46f035b388c46b9882a620b57ee8bbd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767665940&amp;x-signature=RUZ2Ylyf9jWXMXGTzZO2XI87cV8%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-3">💊 终极方案：自定义 ToggleStyle 里的“移花接木”</h2>
<p>我决定不再在 View 层面上纠结，而是深入到 <code>ToggleStyle</code> 的内部。我要创造一个<strong>双面间谍</strong> Style。</p>
<p>这个 Style 表面上是一个普通的 <code>ToggleStyle</code>，但它的 <code>makeBody</code> 方法里藏着两个灵魂。</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 这是一个“双重人格”的 Style</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">ConditionalToggleStyle</span>: <span class="hljs-title class_">ToggleStyle</span> {
    <span class="hljs-comment">// 同样需要命名空间来处理布局平滑过渡</span>
    <span class="hljs-meta">@Namespace</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> space
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> <span class="hljs-type">GeometryID</span> <span class="hljs-operator">=</span> <span class="hljs-string">"Chameleon"</span> <span class="hljs-comment">// 变色龙 ID</span>
    
    <span class="hljs-comment">// 控制当前显示哪个人格</span>
    <span class="hljs-keyword">var</span> isButtonMode: <span class="hljs-type">Bool</span>
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">makeBody</span>(<span class="hljs-params">configuration</span>: <span class="hljs-type">Configuration</span>) -&gt; <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-comment">// 这里是黑色幽默的地方：</span>
        <span class="hljs-comment">// 我们在一个 Style 里手动调用了另外两个 Style 的 makeBody</span>
        <span class="hljs-comment">// 这就像是你去买咖啡，店员其实是去隔壁星巴克买了一杯倒给你</span>
        
        <span class="hljs-type">Group</span> {
            <span class="hljs-keyword">if</span> isButtonMode {
                <span class="hljs-type">ButtonToggleStyle</span>()
                    .makeBody(configuration: configuration)
                    <span class="hljs-comment">// 加上 ID，告诉 SwiftUI：我是那个 Switch 的转世</span>
                    .matchedGeometryEffect(id: <span class="hljs-type">GeometryID</span>, in: space)
                    .transition(.opacity.combined(with: .scale))
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-type">SwitchToggleStyle</span>()
                    .makeBody(configuration: configuration)
                    <span class="hljs-comment">// 加上 ID，告诉 SwiftUI：我是那个 Button 的前身</span>
                    .matchedGeometryEffect(id: <span class="hljs-type">GeometryID</span>, in: space)
                    .transition(.opacity.combined(with: .scale))
            }
        }
    }
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fdfb30356f4d4206a31f09715e8a608c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767665940&amp;x-signature=tDuYe0WhTEiIIIsrvaUVDtQAUhQ%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-4">⚠️ 技术黑箱（重点解析）</h3>
<p>这里有一个很容易踩的坑，也就是 <strong>Agent Refactor</strong> 最喜欢攻击的地方：</p>
<p>你不能试图用 <code>[any ToggleStyle]</code> 这种数组来动态返回 Style。Swift 的 Protocol 如果带有 <code>associatedtype</code>（ToggleStyle 就有），就不能作为普通类型乱传。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0695838864b74e16accc949068add827~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767665940&amp;x-signature=3EabX7W9vxIyvN2YQWkz3wZHuaQ%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>上面的 <code>ConditionalToggleStyle</code> 之所以能工作，是因为 <code>makeBody</code> 返回的是 <code>some View</code>。SwiftUI 的 ViewBuilder 会把 <code>if-else</code> 转换成 <code>_ConditionalContent&lt;ViewA, ViewB&gt;</code>。虽然 Button 和 Switch 渲染出来的 View 类型不同，但它们都被包装在这个条件容器里了。</p>
<h2 data-id="heading-5">🎬 大结局：完美的调用</h2>
<p>我把封装好的代码推送到主屏幕。现在的 <code>ContentView</code> 干净得令人发指：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">FinalShowdownView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@State</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> isOn <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>
    <span class="hljs-meta">@State</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> isButtonMode <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">VStack</span>(spacing: <span class="hljs-number">40</span>) {
            <span class="hljs-type">Text</span>(<span class="hljs-string">"Weapon Status: <span class="hljs-subst">\(isOn <span class="hljs-operator">?</span> <span class="hljs-string">"ACTIVE"</span> : <span class="hljs-string">"IDLE"</span>)</span>"</span>)
                .font(.monospaced(.title3)())
                .foregroundColor(isOn <span class="hljs-operator">?</span> .green : .gray)
            
            <span class="hljs-comment">// 见证奇迹的时刻</span>
            <span class="hljs-type">Toggle</span>(<span class="hljs-string">"Fire Mode"</span>, isOn: <span class="hljs-variable">$isOn</span>)
                <span class="hljs-comment">// 这里的 .animation 必须跟在 style 后面或者绑定在 value 上</span>
                .toggleStyle(<span class="hljs-type">ConditionalToggleStyle</span>(isButtonMode: isButtonMode))
                <span class="hljs-comment">// 加上这个 frame 是为了防止 Switch 变 Button 时宽度跳变太大</span>
                <span class="hljs-comment">// 就像浩克变身得撑破裤子，我们需要一条弹性好的裤子</span>
                .frame(maxWidth: <span class="hljs-number">200</span>) 
            
            <span class="hljs-type">Button</span> {
                withAnimation(.easeInOut(duration: <span class="hljs-number">0.4</span>)) {
                    isButtonMode.toggle()
                }
            } label: {
                <span class="hljs-type">Text</span>(<span class="hljs-string">"Hack the System"</span>)
                    .fontWeight(.bold)
                    .padding()
                    .background(<span class="hljs-type">Color</span>.purple.opacity(<span class="hljs-number">0.2</span>))
                    .cornerRadius(<span class="hljs-number">10</span>)
            }
        }
    }
}
</code></pre>
<p>我按下 "Hack the System" 按钮。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bca686ac45cc4fe0b146bea7ab3bad6a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767665940&amp;x-signature=1NB1CK3ypcli%2BPnHXcReaSJmuSE%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>屏幕上的 Toggle 并没有生硬地消失再出现，而是如同液体金属一般，从滑块形态自然地收缩、形变，最终凝固成一个按钮。点击它，状态同步完美，毫无迟滞。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6eb3398a46fd4efdb46aedf29aca932b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767665940&amp;x-signature=Pu4QS2xrkh85Huk9wUHy0%2BF3%2BWQ%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>Trinity 看着屏幕，嘴角终于微微上扬：“看来你还没生锈，Neo。”</p>
<p>突然，报警红灯亮起。Agent Refactor 的全息投影出现在半空，他咆哮着：“不可饶恕！你们竟然在一个 <code>makeBody</code> 里实例化了两个不同的 Style！这是对静态派发的亵渎！”</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/022de73c45f44754894d286eb00e0c9d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767665940&amp;x-signature=zHxyMMtxzdXnnvwY05dDy%2FQ%2B%2FpA%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>我合上电脑，戴上墨镜，对 Trinity 笑了笑：“走吧。在他发现我们还在用 <code>AnyView</code> 之前。”</p>
<hr/>
<h2 data-id="heading-6">👀 SwiftUI 涨知识外传：修复“动画失效”的终极补丁（Namespace 的生命周期）</h2>
<p>这里是 <strong>Neo</strong>。</p>
<p>这真是一个让 <strong>Agent Refactor</strong> 笑掉大牙的低级失误。我居然犯了“宇宙重启”的错误。</p>
<p><strong>Trinity</strong> 看着毫无反应的屏幕，把咖啡杯重重地顿在桌子上：“Neo，你是在逗我吗？你在 <code>ToggleStyle</code> 这个结构体里声明了 <code>@Namespace</code>。每次 View 刷新，<code>QuantumToggleStyle</code> 重新初始化，那个 Namespace 就被销毁重建了。<strong>你是在试图连接两个毫无关联的平行宇宙！</strong>”</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c2ddb3d0cef4308ad5a3cc37384aa4b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767665940&amp;x-signature=6vsYclXsuXwuuzaEEuySbcpZshg%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>她说得对。<strong>Namespace 必须是永恒的</strong>，不能随着 Style 的重新创建而消亡。我们必须把这个“宇宙坐标系”从外部传进去，而不是在内部一次性生成。</p>
<p>这就好比你想用虫洞连接两个点，结果你每走一步就把整个宇宙炸了重造，虫洞当然连不起来。</p>
<p>来吧，让我们修补这个时空裂缝。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34850ee4199f419d86255ac93fe44daf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767665940&amp;x-signature=SFxsWM6WW8xCSipSkOdi0UF4J6s%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-7">🕵️‍♂️ 真正的 Bug：Namespace 的生命周期</h2>
<p>在 SwiftUI 中，<code>.toggleStyle(MyStyle())</code> 每次被调用（当状态改变引发重绘时），都会创建一个新的 <code>MyStyle</code> 结构体实例。</p>
<p>如果你把 <code>@Namespace private var space</code> 写在 <code>ToggleStyle</code> 结构体里：</p>
<ol>
<li>状态改变（hackMode 变了）。</li>
<li>SwiftUI 创建一个新的 <code>QuantumToggleStyle</code>。</li>
<li><strong>新的 Style 产生了一个全新的 Namespace。</strong></li>
<li><code>matchedGeometryEffect</code> 发现：“咦？上一次的 ID 是在旧宇宙里，这次是在新宇宙里，找不到匹配对象。”</li>
<li><strong>结果：</strong> 没有补间动画，只有生硬的突变。</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/99fd2e6fe2154ac9a70c7c8ec1b97cfb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767665940&amp;x-signature=WV3CWtUpTLCsvWLZ%2F5LE5y0m008%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-8">💉 手术方案：依赖注入</h2>
<p>我们需要在 <strong>View（活得久的那个）</strong> 里创建 Namespace，然后把它像传家宝一样传给 <strong>Style（活得短的那个）</strong>。</p>
<p>同时，为了让替换过程不出现“闪烁”，我们需要显式地加上 <code>.transition</code>，告诉 SwiftUI 在变形的同时如何处理透明度。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0d3a8610e8646f7974a585e5ce7ad92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767665940&amp;x-signature=x97cuh92Lw7l5G6EEAo5tvZ2cYQ%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-9">🧬 最终修正版代码 (Copy-Paste Ready)</h2>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> SwiftUI

<span class="hljs-comment">// MARK: - The "Quantum" Toggle Style (Fixed)</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">QuantumToggleStyle</span>: <span class="hljs-title class_">ToggleStyle</span> {
    <span class="hljs-comment">// ⚠️ 关键修正：不再自己持有 Namespace，而是接收外部传入的 ID</span>
    <span class="hljs-comment">// 这保证了即便 Style 被重新创建，坐标系依然是同一个</span>
    <span class="hljs-keyword">var</span> namespace: <span class="hljs-type">Namespace</span>.<span class="hljs-type">ID</span>
    
    <span class="hljs-comment">// 状态控制</span>
    <span class="hljs-keyword">var</span> isButtonMode: <span class="hljs-type">Bool</span>
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> <span class="hljs-type">LabelID</span> <span class="hljs-operator">=</span> <span class="hljs-string">"SoulLabel"</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> <span class="hljs-type">ContainerID</span> <span class="hljs-operator">=</span> <span class="hljs-string">"BodyContainer"</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> <span class="hljs-type">KnobID</span> <span class="hljs-operator">=</span> <span class="hljs-string">"SwitchKnob"</span> <span class="hljs-comment">// 新增：给 Switch 的滑块也留个位置（可选）</span>
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">makeBody</span>(<span class="hljs-params">configuration</span>: <span class="hljs-type">Configuration</span>) -&gt; <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">Group</span> {
            <span class="hljs-keyword">if</span> isButtonMode {
                <span class="hljs-comment">// MARK: - Button Mode</span>
                <span class="hljs-type">Button</span> {
                    configuration.isOn.toggle()
                } label: {
                    <span class="hljs-type">HStack</span> {
                        configuration.label
                            .matchedGeometryEffect(id: <span class="hljs-type">LabelID</span>, in: namespace)
                            .foregroundColor(.accentColor)
                        
                        <span class="hljs-type">Spacer</span>()
                        
                        <span class="hljs-comment">// 占位符：用于模拟 Switch 的宽度</span>
                        <span class="hljs-type">Color</span>.clear
                            .frame(width: <span class="hljs-number">51</span>, height: <span class="hljs-number">31</span>)
                    }
                    .contentShape(<span class="hljs-type">Rectangle</span>())
                }
                .buttonStyle(.plain)
                .padding(.vertical, <span class="hljs-number">8</span>)
                .padding(.horizontal, <span class="hljs-number">0</span>)
                <span class="hljs-comment">// 背景匹配</span>
                .background(
                    <span class="hljs-type">RoundedRectangle</span>(cornerRadius: <span class="hljs-number">8</span>)
                        .fill(<span class="hljs-type">Color</span>.gray.opacity(<span class="hljs-number">0.1</span>))
                        .matchedGeometryEffect(id: <span class="hljs-type">ContainerID</span>, in: namespace)
                )
                <span class="hljs-comment">// ⚠️ 关键：加上 transition，防止视图直接硬替换</span>
                .transition(.opacity.animation(.easeInOut(duration: <span class="hljs-number">0.2</span>)))
                
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// MARK: - Switch Mode</span>
                <span class="hljs-type">HStack</span> {
                    configuration.label
                        .matchedGeometryEffect(id: <span class="hljs-type">LabelID</span>, in: namespace)
                        .foregroundColor(.primary)
                    
                    <span class="hljs-type">Spacer</span>()
                    
                    <span class="hljs-comment">// 这里我们为了视觉完美，手动拆解 Toggle</span>
                    <span class="hljs-comment">// 或者依然使用原生 Toggle，但包裹在容器里</span>
                    <span class="hljs-type">Toggle</span>(<span class="hljs-string">""</span>, isOn: configuration.<span class="hljs-variable">$isOn</span>)
                        .labelsHidden()
                        .toggleStyle(<span class="hljs-type">SwitchToggleStyle</span>(tint: .green))
                        <span class="hljs-comment">// 这里不需要 matchedGeometryEffect 强行匹配滑块内部</span>
                        <span class="hljs-comment">// 因为 Switch 本身是一个复杂的 UIKit 封装，很难拆解</span>
                        <span class="hljs-comment">// 我们主要匹配的是 Label 和整体容器位置</span>
                }
                .padding(.vertical, <span class="hljs-number">8</span>)
                <span class="hljs-comment">// 背景匹配（Switch 模式下背景通常是透明的，或者是整个 Row 的背景）</span>
                <span class="hljs-comment">// 我们给一个透明背景来承接动画</span>
                .background(
                    <span class="hljs-type">RoundedRectangle</span>(cornerRadius: <span class="hljs-number">8</span>)
                        .fill(<span class="hljs-type">Color</span>.clear)
                        .matchedGeometryEffect(id: <span class="hljs-type">ContainerID</span>, in: namespace)
                )
                <span class="hljs-comment">// ⚠️ 关键：同上，加上过渡</span>
                .transition(.opacity.animation(.easeInOut(duration: <span class="hljs-number">0.2</span>)))
            }
        }
    }
}

<span class="hljs-comment">// MARK: - The Main View</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">MatrixControlView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-comment">// ⚠️ 修正：Namespace 必须生存在 View 的生命周期里</span>
    <span class="hljs-meta">@Namespace</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> animationScope
    
    <span class="hljs-meta">@State</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> weaponActive <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>
    <span class="hljs-meta">@State</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> hackMode <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">ZStack</span> {
            <span class="hljs-type">Color</span>.black.edgesIgnoringSafeArea(.all)
            
            <span class="hljs-type">VStack</span>(spacing: <span class="hljs-number">30</span>) {
                <span class="hljs-comment">// Header</span>
                <span class="hljs-type">HStack</span>(spacing: <span class="hljs-number">15</span>) {
                    <span class="hljs-type">Circle</span>()
                        .fill(weaponActive <span class="hljs-operator">?</span> <span class="hljs-type">Color</span>.green : <span class="hljs-type">Color</span>.red)
                        .frame(width: <span class="hljs-number">10</span>, height: <span class="hljs-number">10</span>)
                        .shadow(color: weaponActive <span class="hljs-operator">?</span> .green : .red, radius: <span class="hljs-number">5</span>)
                    
                    <span class="hljs-type">Text</span>(weaponActive <span class="hljs-operator">?</span> <span class="hljs-string">"SYSTEM: <span class="hljs-subst">\(hackMode <span class="hljs-operator">?</span> <span class="hljs-string">"HACKED"</span> : <span class="hljs-string">"SECURE"</span>)</span>"</span> : <span class="hljs-string">"SYSTEM: OFFLINE"</span>)
                        .font(.monospaced(.headline)())
                        .foregroundColor(weaponActive <span class="hljs-operator">?</span> .green : .red)
                        <span class="hljs-comment">// 当 hackMode 切换时，文字会有轻微变动，这里加个动画避免跳动</span>
                        .animation(.none, value: hackMode) 
                    
                    <span class="hljs-type">Spacer</span>()
                }
                .padding(.horizontal)
                .frame(width: <span class="hljs-number">320</span>)
                
                <span class="hljs-comment">// --- 见证奇迹的 Toggle ---</span>
                <span class="hljs-type">Toggle</span>(<span class="hljs-string">"Neural Link"</span>, isOn: <span class="hljs-variable">$weaponActive</span>)
                    .font(.system(size: <span class="hljs-number">18</span>, weight: .medium))
                    <span class="hljs-comment">// ⚠️ 注入：将 View 的 Namespace 传给 Style</span>
                    .toggleStyle(<span class="hljs-type">QuantumToggleStyle</span>(namespace: animationScope, isButtonMode: hackMode))
                    <span class="hljs-comment">// 给整个容器加一个 frame，防止 Button 模式和 Switch 模式高度微小差异导致的抖动</span>
                    .frame(width: <span class="hljs-number">320</span>)
                    .padding()
                    .background(<span class="hljs-type">Color</span>.gray.opacity(<span class="hljs-number">0.15</span>))
                    .cornerRadius(<span class="hljs-number">12</span>)
                    <span class="hljs-comment">// 这里的动画是给 Style 内部生效的关键</span>
                    <span class="hljs-comment">// 也可以在 Button action 里用 explicit animation，但这里加上保险</span>
                    .animation(.spring(response: <span class="hljs-number">0.5</span>, dampingFraction: <span class="hljs-number">0.7</span>), value: hackMode)
                
                <span class="hljs-comment">// Trigger Button</span>
                <span class="hljs-type">Button</span> {
                    <span class="hljs-comment">// 显式动画</span>
                    withAnimation(.spring(response: <span class="hljs-number">0.5</span>, dampingFraction: <span class="hljs-number">0.7</span>)) {
                        hackMode.toggle()
                    }
                } label: {
                    <span class="hljs-type">HStack</span> {
                        <span class="hljs-type">Image</span>(systemName: <span class="hljs-string">"arrow.triangle.2.circlepath"</span>)
                            .rotationEffect(.degrees(hackMode <span class="hljs-operator">?</span> <span class="hljs-number">180</span> : <span class="hljs-number">0</span>))
                        <span class="hljs-type">Text</span>(hackMode <span class="hljs-operator">?</span> <span class="hljs-string">"Revert to Switch"</span> : <span class="hljs-string">"Hack to Button"</span>)
                    }
                    .font(.callout.bold())
                    .foregroundColor(.white)
                    .padding(.vertical, <span class="hljs-number">12</span>)
                    .padding(.horizontal, <span class="hljs-number">24</span>)
                    .background(
                        <span class="hljs-type">Capsule</span>()
                            .fill(<span class="hljs-type">LinearGradient</span>(
                                colors: hackMode <span class="hljs-operator">?</span> [.orange, .red] : [.blue, .purple],
                                startPoint: .leading,
                                endPoint: .trailing
                            ))
                    )
                    .shadow(radius: <span class="hljs-number">10</span>)
                }
                .padding(.top, <span class="hljs-number">20</span>)
            }
        }
    }
}

<span class="hljs-comment">// MARK: - Preview</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">MatrixControlView_Previews</span>: <span class="hljs-title class_">PreviewProvider</span> {
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">var</span> previews: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">MatrixControlView</span>()
    }
}
</code></pre>
<h2 data-id="heading-10">🧠 技术复盘：为什么这能行？</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0dfeadddce946eb87d82cebec562d76~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767665940&amp;x-signature=FzH2xm0ESfc870K59RInL5L0%2Fck%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<ol>
<li>
<p><strong>宇宙常数 (<code>@Namespace</code> in View)</strong>：
现在 <code>animationScope</code> 存在于 <code>MatrixControlView</code> 中。无论 <code>hackMode</code> 如何改变，<code>MatrixControlView</code> 只是重绘，但它的 State 和 Namespace 是持久的。</p>
</li>
<li>
<p><strong>虫洞连接 (Dependency Injection)</strong>：
我们将这个持久的 ID 传给了 <code>QuantumToggleStyle</code>。虽然 Style 结构体被重建了，但它手里拿的 ID 还是原来那个。<code>matchedGeometryEffect</code> 终于能认出：“哦，这就是刚才那个 <code>SoulLabel</code>，我要把它平滑地移到新位置。”</p>
</li>
<li>
<p><strong>过渡协议 (<code>.transition</code>)</strong>：
由于我们是在 <code>if-else</code> 里完全切换了视图层级（一个是 <code>Button</code>，一个是 <code>HStack</code>），SwiftUI 默认会直接移除旧的、插入新的。加上 <code>.transition(.opacity)</code> 配合 <code>matchedGeometryEffect</code>，SwiftUI 就会混合两者的像素：</p>
<ul>
<li><strong>位置/尺寸</strong>：由 <code>matchedGeometryEffect</code> 负责插值。</li>
<li><strong>淡入/淡出</strong>：由 <code>.transition</code> 负责。</li>
</ul>
</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fabdac10a904423fa0b6aef485911734~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767665940&amp;x-signature=2zb781GMPjvlPBXPWPKk2N%2BzD%2Bk%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>Trinity 再次点燃了一根烟，看着屏幕上那个如同液态金属般丝滑变形的开关。文字不再跳动，背景自然延展，一切都符合物理定律。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/acf79b49a5154ad48784376c90c9337d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767665940&amp;x-signature=lXeirLbaE2XnDx3kgwlZuSFO%2BVg%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>“这才像样，Neo。”她转身走向出口，“记住，在代码的世界里，<strong>上下文（Context）就是一切</strong>。丢了上下文，你就在跟空气对话。”</p>
<p><strong>（任务真正完成。Agent Refactor 找不到任何破绽。）</strong></p>
<hr/>
<p><strong>故事结束了，但代码永生。</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff80f53d58594aac8405d9ceb69ee8da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767665940&amp;x-signature=9SNY7%2FsQxZH4Hbc9yHyQCCDjjEQ%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>这个技巧的核心在于<strong>不仅要切换视图，还要欺骗 SwiftUI 的 Diff 算法</strong>。通过将切换逻辑下沉到 <code>ToggleStyle</code> 内部，并配合 <code>matchedGeometryEffect</code>，我们成功地在两个截然不同的系统组件之间架起了一座平滑的桥梁。</p>
<p>记住，在 SwiftUI 的世界里，没有什么是不可能的，只要你懂得如何优雅地撒谎。</p>
<p>那么，宝子们学会了吗？我们下次不见不散喽，再会啦！8-)</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d7272e6bff243ff92e51f488334bc69~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767665940&amp;x-signature=SNwXY86nKR7mLuxh8eaaKWyq%2BE8%3D" alt="在这里插入图片描述" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Swift 6.2 列传（第十四篇）：岳灵珊的寻人启事与 Task Naming]]></title>    <link>https://juejin.cn/post/7589167252722319410</link>    <guid>https://juejin.cn/post/7589167252722319410</guid>    <pubDate>2025-12-30T02:21:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589167252722319410" data-draft-id="7589167252722286642" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Swift 6.2 列传（第十四篇）：岳灵珊的寻人启事与 Task Naming"/> <meta itemprop="keywords" content="Swift,编程语言,Apple"/> <meta itemprop="datePublished" content="2025-12-30T02:21:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大熊猫侯佩"/> <meta itemprop="url" content="https://juejin.cn/user/4292907536222152"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Swift 6.2 列传（第十四篇）：岳灵珊的寻人启事与 Task Naming
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4292907536222152/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大熊猫侯佩
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T02:21:15.000Z" title="Tue Dec 30 2025 02:21:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41dee7acfe79433180afc189655a1ccc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767666074&amp;x-signature=9uEvDsXGYfQS8Mv9FF0RfUd5Cfs%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<blockquote>
<p><strong>摘要</strong>：在成千上万个并发任务的洪流中，如何精准定位那个“负心”的 Bug？Swift 6.2 带来的 <code>Task Naming</code> 就像是给每个游荡的灵魂挂上了一个“身份铭牌”。本文将借大熊猫侯佩与岳灵珊在赛博华山的奇遇，为您解析 SE-0469 的奥秘。</p>
</blockquote>
<h2 data-id="heading-0">0️⃣ 🐼 序章：赛博华山的“无名”孤魂</h2>
<p>赛博华山，思过崖服务器节点。</p>
<p>这里的云雾不是水汽，而是液氮冷却系统泄漏的白烟。大熊猫侯佩正坐在一块全息投影的岩石上，手里捧着一盒“紫霞神功”牌自热竹笋火锅，吃得津津有味。</p>
<p>“味道不错，就是有点烫嘴……”侯佩吹了吹热气，习惯性地摸了摸头顶——那里毛发浓密，<strong>绝对没有秃</strong>，这让他感到无比安心。作为一名经常迷路的路痴，他刚才本来想去峨眉山看妹子，结果导航漂移，不知怎么就溜达到华山来了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/96e743d090264bb48788e7dbe4da9bdc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767666074&amp;x-signature=AlyexfBup0NwyXJQRCAmziKwDnY%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>忽然，一阵凄婉的哭声从代码堆栈的深处传来。</p>
<p>“平之……平之……你在哪条线程里啊？我找不到你……”</p>
<p>侯佩定睛一看，只见一位身着碧绿衫子的少女，正对着满屏滚动的 Log 日志垂泪。她容貌清丽，却神色凄苦，正是华山派掌门岳不群之女，<strong>岳灵珊</strong>。</p>
<p>“岳姑娘？”侯佩擦了擦嘴角的红油，“你在这哭什么？林平之那小子又跑路了？”</p>
<p>岳灵珊抬起泪眼，指着屏幕上密密麻麻的 <code>Task</code> 列表：“侯大哥，我写了一万个并发任务去搜索‘辟邪剑谱’的下落。刚才有一个任务抛出了异常（Error），但我不知道是哪一个！它们全都长得一模一样，都是匿名的 <code>Task</code>，就像是一万个没有脸的人……我找不到我的平之了！”</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d49ccf88cec544928d3cf947e9c76565~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767666074&amp;x-signature=7KU%2BRTrDrggAIXciou7kRn5ZEh0%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>侯佩凑过去一看，果然，调试器里的任务全是 <code>Unspecified</code>，根本分不清谁是谁。</p>
<p><strong>在本次大冒险中，您将学到如下内容：</strong></p>
<ul>
<li>0️⃣ 🐼 序章：赛博华山的“无名”孤魂</li>
<li>1️⃣ 🏷️ 拒绝匿名：给任务一张身份证</li>
<li>简单的起名艺术</li>
<li>2️⃣ 🗞️ 实战演练：江湖小报的并发采集</li>
<li>3️⃣ 💔 岳灵珊的顿悟</li>
<li>4️⃣ 🐼 熊猫的哲学时刻</li>
<li>5️⃣ 🛑 尾声：竹笋的收纳难题</li>
</ul>
<p>“唉，”侯佩叹了口气，颇为同情，“这就是‘匿名并发’的痛啊。出了事，想找个背锅的都找不到。不过，Swift 6.2 给了我们一招‘实名制’剑法，正好能解你的相思之苦。”</p>
<p>这便是 <strong>SE-0469: Task Naming</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/719f037b47de4184914d6e2a0f2de6ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767666074&amp;x-signature=tlKzmFtLk3lgeM1y%2Be%2BAOgwnjX8%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-1">1️⃣ 🏷️ 拒绝匿名：给任务一张身份证</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c0070d025c8d471d84e7f32cf1502b54~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767666074&amp;x-signature=LWPJ8C%2Fbw2nCEwyX4f0BtQhVGVA%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>在 Swift 6.2 之前，创建 <code>Task</code> 就像是华山派招收了一批蒙面弟子，干活的时候挺卖力，但一旦有人偷懒或者走火入魔（Crash/Hang），你根本不知道是谁干的。</p>
<p>岳灵珊擦干眼泪：“你是说，我可以给平之……哦不，给任务起名字？”</p>
<p>“没错！”侯佩打了个响指，“SE-0469 允许我们在创建任务时，通过 <code>name</code> 参数给它挂个牌。无论是调试还是日志记录，都能直接看到名字。”</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/540522691512436ea0d0babb01767a2d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767666074&amp;x-signature=jV9Fneob2lWK4TsLstlSe9OjflI%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>这套 API 非常简单直观：当使用 <code>Task.init()</code>、<code>Task.detached()</code> 创建新任务，或者在任务组中使用 <code>addTask()</code> 时，都可以传入一个字符串作为名字。</p>
<h3 data-id="heading-2">简单的起名艺术</h3>
<p>侯佩当即在全息屏上演示了一段代码：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 以前我们只能盲人摸象</span>
<span class="hljs-comment">// 现在，我们可以给任务赐名！</span>
<span class="hljs-keyword">let</span> task <span class="hljs-operator">=</span> <span class="hljs-type">Task</span>(name: <span class="hljs-string">"寻找林平之专用任务"</span>) {
    <span class="hljs-comment">// 在任务内部，我们可以读取当前的名字</span>
    <span class="hljs-comment">// 如果没有名字，就是 "Unknown"（无名氏）</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"当前运行的任务是: <span class="hljs-subst">\(Task.name <span class="hljs-operator">??</span> <span class="hljs-string">"Unknown"</span>)</span>"</span>)
    
    <span class="hljs-comment">// 假装在干活</span>
    <span class="hljs-keyword">try?</span> <span class="hljs-keyword">await</span> <span class="hljs-type">Task</span>.sleep(for: .seconds(<span class="hljs-number">1</span>))
}
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dedf78a5711b4ae193d207d2c431ca71~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767666074&amp;x-signature=57CdGQ8TJOGuT0i3Ahm0DMWXHfQ%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>“看，”侯佩指着控制台，“现在它不再是冷冰冰的内存地址，而是一个有血有肉、有名字的‘寻找林平之专用任务’了。”</p>
<h2 data-id="heading-3">2️⃣ 🗞️ 实战演练：江湖小报的并发采集</h2>
<p>“光有个名字有什么用？”岳灵珊还是有点愁眉不展，“我有那么多个任务在跑，万一出错的是第 9527 号呢？”</p>
<p>“问得好！”侯佩咬了一口竹笋，摆出一副高深莫测的样子（虽然嘴角还挂着笋渣），“这名字不仅可以硬编码，还支持<strong>字符串插值</strong>！这在处理批量任务时简直是神技。”</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a9ba3a908fc244568dea7fa16e8806a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767666074&amp;x-signature=tr2n92ReTRJQTjil2zW2dL68iPA%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>假设我们需要构建一个结构体来通过网络加载江湖新闻：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">NewsStory</span>: <span class="hljs-title class_">Decodable</span>, <span class="hljs-title class_">Identifiable</span> {
    <span class="hljs-keyword">let</span> id: <span class="hljs-type">Int</span>
    <span class="hljs-keyword">let</span> title: <span class="hljs-type">String</span> <span class="hljs-comment">// 比如 "令狐冲因酗酒被罚款"</span>
    <span class="hljs-keyword">let</span> strap: <span class="hljs-type">String</span>
    <span class="hljs-keyword">let</span> url: <span class="hljs-type">URL</span>
}
</code></pre>
<p>现在，我们使用 <code>TaskGroup</code> 派出多名探子（子任务）去打探消息。如果有探子回报失败，我们需要立刻知道是哪一路探子出了问题。</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">let</span> stories <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> withTaskGroup { group <span class="hljs-keyword">in</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-number">1</span><span class="hljs-operator">...</span><span class="hljs-number">5</span> {
        <span class="hljs-comment">// 关键点来了！👇</span>
        <span class="hljs-comment">// 我们在添加任务时，动态地给它生成了名字： "Stories 1", "Stories 2"...</span>
        <span class="hljs-comment">// 这就像是岳不群给弟子们排辈分，一目了然。</span>
        group.addTask(name: <span class="hljs-string">"江湖快报分队-<span class="hljs-subst">\(i)</span>"</span>) {
            <span class="hljs-keyword">do</span> {
                <span class="hljs-keyword">let</span> url <span class="hljs-operator">=</span> <span class="hljs-type">URL</span>(string: <span class="hljs-string">"https://hws.dev/news-<span class="hljs-subst">\(i)</span>.json"</span>)<span class="hljs-operator">!</span>
                <span class="hljs-keyword">let</span> (data, <span class="hljs-keyword">_</span>) <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> <span class="hljs-type">URLSession</span>.shared.data(from: url)
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">try</span> <span class="hljs-type">JSONDecoder</span>().decode([<span class="hljs-type">NewsStory</span>].<span class="hljs-keyword">self</span>, from: data)
            } <span class="hljs-keyword">catch</span> {
                <span class="hljs-comment">// 🚨 出事了！</span>
                <span class="hljs-comment">// 这里我们可以直接打印出 Task.name</span>
                <span class="hljs-comment">// 输出示例："Loading 江湖快报分队-3 failed."</span>
                <span class="hljs-comment">// 岳灵珊瞬间就能知道是第 3 分队被青城派截杀了！</span>
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"加载失败，肇事者是: <span class="hljs-subst">\(Task.name <span class="hljs-operator">??</span> <span class="hljs-string">"Unknown"</span>)</span>"</span>)
                <span class="hljs-keyword">return</span> []
            }
        }
    }

    <span class="hljs-keyword">var</span> allStories <span class="hljs-operator">=</span> [<span class="hljs-type">NewsStory</span>]()

    <span class="hljs-comment">// 收集情报</span>
    <span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> stories <span class="hljs-keyword">in</span> group {
        allStories.append(contentsOf: stories)
    }

    <span class="hljs-comment">// 按 ID 排序，保持队形</span>
    <span class="hljs-keyword">return</span> allStories.sorted { <span class="hljs-variable">$0</span>.id <span class="hljs-operator">&gt;</span> <span class="hljs-variable">$1</span>.id }
}

<span class="hljs-built_in">print</span>(stories)
</code></pre>
<h2 data-id="heading-4">3️⃣ 💔 岳灵珊的顿悟</h2>
<p>看完这段代码，岳灵珊破涕为笑：“太好了！这样一来，如果‘寻找平之’的任务失败了，我就能立刻知道是哪一次尝试失败的，是在福州失败的，还是在洛阳失败的，再也不用对着虚空哭泣了。”</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/914ba42826894963b8e27cf710668643~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767666074&amp;x-signature=vPdTlvIpZprRT1ysSChBgUHRFps%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>侯佩点点头，语重心长地说：“在并发的世界里，<strong>可见性（Visibility）</strong> 就是生命线。一个未命名的任务，就是 unpredictable（不可预测）的风险。给了它名字，就是给了它责任。如果它跑路了（Rogue Task），我们至少知道通缉令上该写谁的名字。”</p>
<p>岳灵珊看着屏幕上一个个清晰的任务名称，眼中闪过一丝复杂的神色：“是啊，名字很重要。可惜，有些人的名字，刻在了心上，却在江湖里丢了……”</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47c748073b704cb0a028684573cbd441~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767666074&amp;x-signature=gOZoh9kWe8a618uiqaW3RGenERk%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>“停停停！”侯佩赶紧打断她，生怕她又唱起那首福建山歌，“咱们是搞技术的，不兴搞伤痕文学。现在的重点是，你的 Debug 效率提升了 1000%！”</p>
<h2 data-id="heading-5">4️⃣ 🐼 熊猫的哲学时刻</h2>
<p>侯佩站起身，拍了拍屁股上的灰尘（虽然是全息投影，但他觉得要有仪式感）。</p>
<p>“其实，给代码起名字和做熊一样。我叫侯佩，所以我知道我要吃竹笋，我知道我<strong>头绝对不秃</strong>，我知道我要走哪条路（虽然经常走错）。如果我只是一只‘Anonymous Panda’，那我可能早就被抓去动物园打工了。”</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b286db7711e45298f22ddd6364946ff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767666074&amp;x-signature=hSVF1QZjE5nKpNb7pXH%2FTzNTcK0%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>“善用 <code>Task Naming</code>，”侯佩总结道，“它不会增加运行时的负担，但在你焦头烂额修 Bug 的时候，它就是那个为你指点迷津的‘风清扬’。”</p>
<h2 data-id="heading-6">5️⃣ 🛑 尾声：竹笋的收纳难题</h2>
<p>帮岳灵珊解决了心病，侯佩准备收拾东西离开赛博华山。他看着自己还没吃完的一大堆竹笋，陷入了沉思。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/926c282b3afa47d488cef63830e7fa65~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767666074&amp;x-signature=duleFud%2BA5PVn40nVoAOT3w7LuQ%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>“这竹笋太多了，”侯佩嘟囔着，“用普通的 <code>Array</code> 装吧，太灵活，内存跳来跳去的，影响我拔刀（吃笋）的速度。用 <code>Tuple</code> 元组装吧，固定是固定了，但这写法也太丑了，而且还没法用下标循环访问……”</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2eea1f2013f243319cf9965804204a68~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767666074&amp;x-signature=TYux%2BkYuJgd5Hf%2B44q%2FKuZm70wM%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>岳灵珊看着侯佩对着一堆竹笋发愁，忍不住问道：“侯大哥，你是想要一个既有元组的‘固定大小’超能力，又有数组的‘下标访问’便捷性的容器吗？”</p>
<p>侯佩眼睛一亮：“知我者，岳姑娘也！难道 Swift 6.2 连这个都有？”</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb4688518ee54019bc8222cb5a6227c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767666074&amp;x-signature=ZyFYeIkmW0XGJzOjn2xstXpzPvo%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>岳灵珊微微一笑，指向了下一章的传送门：“听说下一回，有一种神奇的兵器，叫做 <strong>InlineArray</strong>，专门治愈你的‘性能强迫症’。”</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/049764f7273642689f99e9eea36dcea5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767666074&amp;x-signature=GJaABCYrVl%2FwGeeuOqdyTffWfWQ%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><strong>（欲知后事如何，且看下回分解：InlineArray —— 当元组和数组生了个混血儿，熊猫的竹笋终于有地儿放了。）</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e1b680a865244ec093beaaab072db6b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767666074&amp;x-signature=5DTKUTynqygHh3%2F0QyOFMGw5ZXU%3D" alt="在这里插入图片描述" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python网络爬虫中HTTP和HTTPS代理的完整使用教程]]></title>    <link>https://juejin.cn/post/7589206614929244200</link>    <guid>https://juejin.cn/post/7589206614929244200</guid>    <pubDate>2025-12-30T02:24:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589206614929244200" data-draft-id="7589181008098770959" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python网络爬虫中HTTP和HTTPS代理的完整使用教程"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-30T02:24:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="开心猴爷"/> <meta itemprop="url" content="https://juejin.cn/user/2179705232165364"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python网络爬虫中HTTP和HTTPS代理的完整使用教程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2179705232165364/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    开心猴爷
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T02:24:23.000Z" title="Tue Dec 30 2025 02:24:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>python使用http、https代理</p>
<p>在国内利用Python从Internet上爬取数据时，有些网站或API接口被限速或屏蔽，这时使用代理可以加速爬取过程，减少请求失败，Python程序使用代理的方法主要有以下几种：</p>
<p>（1）如果是在代码中使用一些网络库或爬虫框架进行数据爬取，一般这种框架都会支持设置代理，例如：</p>
<pre><code class="hljs language-ini" lang="ini">
import urllib.request as urlreq
<span class="hljs-attr">ph</span> = urlreq.ProxyHandler({<span class="hljs-string">'https'</span>: <span class="hljs-string">'https://127.0.0.1:1080'</span>})
<span class="hljs-attr">oper</span> = urlreq.build_opener(ph)
urlreq.install_opener(oper)
<span class="hljs-attr">res</span> = oper.open(<span class="hljs-string">"https://www.google.com"</span>)
print(res.read())
</code></pre>
<pre><code class="hljs"/></pre>
<pre><code class="hljs language-dart" lang="dart">
<span class="hljs-keyword">import</span> requests <span class="hljs-keyword">as</span> req
<span class="hljs-built_in">print</span>(req.<span class="hljs-keyword">get</span>(<span class="hljs-string">"https://www.google.com"</span>, proxies={<span class="hljs-string">'https'</span>: <span class="hljs-string">'https://127.0.0.1:1080'</span>}).content)
</code></pre>
<p>（2）如果使用的库没有提供设置代理的接口，但是底层使用了urllib、requests等库，可以尝试设置HTTP_PROXY 和HTTPS_PROXY环境变量，常用的网络库会自动识别这些环境变量，使用变量设置的代理发起请求，设置如下：</p>
<pre><code class="hljs language-lua" lang="lua">
import <span class="hljs-built_in">os</span>
<span class="hljs-built_in">os</span>.environ[<span class="hljs-string">'http_proxy'</span>] = <span class="hljs-string">'http://127.0.0.1:1080'</span>
<span class="hljs-built_in">os</span>.environ[<span class="hljs-string">'https_proxy'</span>] = <span class="hljs-string">'https://127.0.0.1:1080'</span>
</code></pre>
<p>（3）如果上述两种方法都没有用，那么还可以使用一些可以监听、拦截和修改网络包的工具和库如（Fiddler、mitmproxy、Sniffmaster）来拦截http请求包并修改地址，达到使用代理的效果。Sniffmaster是一款全平台抓包工具，支持HTTPS、TCP和UDP协议抓包，无需设置代理即可解密HTTPS流量，还提供代理抓包功能，适用于多种设备。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【工具篇】使用 nvm 进行 node 版本管理]]></title>    <link>https://juejin.cn/post/7589171972447060010</link>    <guid>https://juejin.cn/post/7589171972447060010</guid>    <pubDate>2025-12-30T02:29:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589171972447060010" data-draft-id="7589171972446961706" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【工具篇】使用 nvm 进行 node 版本管理"/> <meta itemprop="keywords" content="前端,Node.js,NPM"/> <meta itemprop="datePublished" content="2025-12-30T02:29:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="闲云一鹤"/> <meta itemprop="url" content="https://juejin.cn/user/729731452122382"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【工具篇】使用 nvm 进行 node 版本管理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/729731452122382/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    闲云一鹤
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T02:29:35.000Z" title="Tue Dec 30 2025 02:29:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>当接触的项目过多时就会发现，特喵的怎么每个项目的 node.js 版本都不一致？！</p>
<p>低版本 node 无法运行高版本项目，高版本 node 又不兼容低版本项目</p>
<p>如何快速的来回切换 node 版本成为了每一名前端同仁的必备技能</p>
<p>为解决此痛点，市面上出现了很多的 node 版本管理工具：nvm、nvs、Volta、fnm 等，这里我们使用 nvm 作教程讲解</p>
<h2 data-id="heading-1">1. 安装 nvm</h2>
<blockquote>
<p>注意：安装 nvm 之前，一定得先卸载干净 node.js！！！</p>
</blockquote>
<blockquote>
<p>注意：有了 nvm 就不需要单独安装 node 了，直接使用 nvm 安装切换 node 版本即可</p>
</blockquote>
<p>windows 适用版本为 nvm-windows：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcoreybutler%2Fnvm-windows%2Freleases" target="_blank" title="https://github.com/coreybutler/nvm-windows/releases" ref="nofollow noopener noreferrer">github.com/coreybutler…</a></p>
<p>下载安装包（<code>nvm-setup.exe</code>）安装到本地(选择默认安装路径并且一直点击下一步即可)，注意自定义路径注意不能有中文或者空格</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f81107733104ddfadc843d7fd552999~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767666575&amp;x-signature=lfBGoYc5atQTkMZMXLgl0n%2BX1l4%3D" alt="1.png" loading="lazy"/></p>
<p>提示！记住这里的安装目录，后面用得上！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a78f7545b8245919f7900b2272ce7a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767666575&amp;x-signature=R4%2F1NodkR%2Bs4uqmLEWhD0%2FVisXE%3D" alt="2.png" loading="lazy"/></p>
<h2 data-id="heading-2">2. node 安装与切换</h2>
<p>输入命令 <code>nvm v</code> 能显示当前 nvm 版本号即说明安装成功</p>
<p>然后下载一个 node 版本</p>
<pre><code class="hljs language-bash" lang="bash">nvm install 16
</code></pre>
<p>切换到 node 16</p>
<pre><code class="hljs language-bash" lang="bash">nvm use 16
</code></pre>
<p>查看 nvm 中安装的 node 版本列表，以及当前所选择版本（星号）</p>
<pre><code class="hljs language-bash" lang="bash">nvm list
</code></pre>
<p>然后就可以通过 <code>node -v</code> 和 <code>npm -v</code> 命令查询到当前的 node 和 npm 版本了</p>
<p>注意！npm 版本是跟随 node 版本变动的！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5aa40abca5a54ea98d38b72ee6cc87c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767666575&amp;x-signature=CEASUCLzrpzcDZCPbjUweltp0Wk%3D" alt="3.png" loading="lazy"/></p>
<h2 data-id="heading-3">3. 设置淘宝源</h2>
<blockquote>
<p>由于国内网络等原因，使用 mpm install xxx 安装依赖包的过程中会出现安装过慢以及失败导致报错，所以我们把 npm 镜像源指向国内<code>淘宝 npm 镜像源</code></p>
</blockquote>
<p>前面提醒的 nvm 安装目录还记得住吗？默认目录一般在这个位置“C:\Users\你的用户名\AppData\Local\nvm”</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e1539a6c819c4d5a9ef45b2f5aea7752~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767666575&amp;x-signature=IDLh0noUliy%2Fzna%2FZ3p4IbDo8TQ%3D" alt="4.png" loading="lazy"/></p>
<p>如果实在找不到了，就再重新安装一次吧</p>
<p>骗你的哈哈，可以 cmd 运行<code>nvm root</code>这个命令查看 nvm 的安装根路径在哪个文件夹</p>
<p>找到 nvm 安装目录下面的 <code>settings.txt</code> 文件</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec756a53004e426bbbef4e74303d6faf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767666575&amp;x-signature=VZEMqylOLsGR%2F%2FL%2BqYXFmCmJH84%3D" alt="5.png" loading="lazy"/></p>
<p>记事本打开 “settings.txt” 文件并在后面粘贴下面两句话即可</p>
<pre><code class="hljs language-cmd" lang="cmd">node_mirror: https://npmmirror.com/mirrors/node/
npm_mirror: https://npmmirror.com/mirrors/npm/
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab2995b7e35342cd94453fa0a8000ee3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767666575&amp;x-signature=fdQ%2FCDR8iBCn%2FY%2FB9DI%2Bl1pixBc%3D" alt="6.png" loading="lazy"/></p>
<p>今后 nvm 安装的所有 node 版本都会指向淘宝镜像源了</p>
<p>检查当前 npm 镜像源</p>
<pre><code class="hljs language-bash" lang="bash">npm config get registry
</code></pre>
<p>如果输出结果指向淘宝源 <code>https://registry.npmmirror.com</code> 即修改成功；以后运行 npm xxx 命令安装依赖包就是使用的淘宝 npm 镜像了；</p>
<h2 data-id="heading-4">4. nvm 常用操作命令</h2>
<p>至此，nvm 已经安装成功，下面介绍常用命令</p>
<pre><code class="hljs language-bash" lang="bash">nvm v // 显示nvm版本

nvm root // 查看nvm的安装根路径在哪个文件夹

nvm list // 显示已安装node的版本

nvm list available // 显示所有可以下载的node版本

nvm install 14.5.0 // 安装14.5.0版本node

nvm install latest // 安装最新版本node

nvm use 14.5.0 // 使用14.5.0版本node

nvm uninstall 14.5.0 // 卸载14.5.0版本node
</code></pre>
<h2 data-id="heading-5">5. 使用 yarn 替换 npm install</h2>
<p>因为 npm 设计之初的一些历史遗留问题，使用 npm 进行依赖包的安装经常会出现莫名其妙的错误。建议大家使用 yarn 替换 npm i 进行包的安装</p>
<pre><code class="hljs language-bash" lang="bash">
npm install -g yarn // 全局安装yarn

yarn -v // 查看yarn版本

npm get registry // 查看当前yarn源

npm config <span class="hljs-built_in">set</span> registry https://registry.npmmirror.com // 更改为淘宝yarn源

yarn install // 安装package.json里所有包
</code></pre>
<p>参考淘宝 npm 镜像站：<a href="https://link.juejin.cn?target=https%3A%2F%2Fnpmmirror.com%2F" target="_blank" title="https://npmmirror.com/" ref="nofollow noopener noreferrer">npmmirror.com/</a></p>
<p>注意！yarn 是跟 node 版本进行绑定的！</p>
<h2 data-id="heading-6">6. nvm 常见报错</h2>
<p>下面是我曾经遇到过的报错，大家如果碰到同样的问题可以作为参考</p>
<ul>
<li>
<p>nvm 切换 node 报错</p>
<p>注意：使用 nvm use 14.5.0 命令切换 node 版本的时候报错“exit status 1: ��û��� 㹻 ��Ȩ��ִ�д”，通过管理员身份打开<code>命令提示符</code>后重新运行命令即可解决</p>
<p>注意：如果出现乱码，可以打开 cmd 命令，运行<code>chcp 65001</code>，然后将乱码的话复制按回车，即可翻译这句乱码的话的意思；甚至将乱码的话复制到 cmd 命令按回车就可以翻译；</p>
<p>注意：如果运行 npm install 报错 <code>npm ERR! cb() never called!</code>，可以通过切换为原来的镜像源(不使用淘宝镜像)来解决</p>
<pre><code class="hljs language-bash" lang="bash">npm config <span class="hljs-built_in">set</span> registry https://registry.npmjs.org/
</code></pre>
</li>
<li>
<p>nvm 切换 node 不起作用</p>
<p>问题：nvm 切换 node 版本成功（Currently using 64-bit executable），但是 node -v 却提示（Currently using 32-bit executable），等于说 node 一直停留在之前版本，并没有切换成功；</p>
<p>解决办法：1.卸载干净 node.js； 2.重新使用 nvm use 指定 node 版本；</p>
<p>复盘发现问题出现的原因是：node.js 不小心安装成了 32（84）位</p>
</li>
<li>
<p>vscode 运行 yarn 报错</p>
<p>在 cmd 里可以正常运行 yarn 命令，但是在 vscode 中运行报如下错误：</p>
<p><code>yarn : 无法加载文件 C:\nvm4w\nodejs\yarn.ps1，因为在此系统上禁止运行脚本。</code></p>
<p>解决方案：</p>
<p>以管理员身份运行 PowerShell。输入 <code>set-ExecutionPolicy RemoteSigned</code>；然后选择 A。</p>
<p>然后回到 vscode 运行 <code>yarn -v</code> 即可正确显示 yarn 版本号</p>
</li>
<li>
<p>vscode 运行 yarn 又报错</p>
<p>报错如下：</p>
<p><code>yarn : 无法将“yarn”项识别为 cmdlet、函数、脚本文件或可运行程序的名称。</code></p>
<p>解决方案：</p>
<p>经过排查，是因为在 node 版本为 19 的时候安装了 yarn，但是我又通过 nvm 将 node 版本切换到了 21，运行 <code>yarn -v</code>命令发现 yarn 竟然未安装？原来 yarn 竟然是跟 node 绑定的？</p>
<p>所以我用 nvm 切换 node 为 21 版本的时候，运行命令 <code>npm install -g yarn</code> 重新安装 yarn，然后运行<code>yarn -v</code>命令查看 yarn 版本，正确显示 yarn 版本，表示已经成功安装</p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[文档变形记，SpringBoot实战：3步让Word乖乖变PDF]]></title>    <link>https://juejin.cn/post/7589206614929129512</link>    <guid>https://juejin.cn/post/7589206614929129512</guid>    <pubDate>2025-12-30T02:10:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589206614929129512" data-draft-id="7589206614929113128" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="文档变形记，SpringBoot实战：3步让Word乖乖变PDF"/> <meta itemprop="keywords" content="后端,Java,Spring Boot"/> <meta itemprop="datePublished" content="2025-12-30T02:10:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="悟空码字"/> <meta itemprop="url" content="https://juejin.cn/user/3139860942296830"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            文档变形记，SpringBoot实战：3步让Word乖乖变PDF
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3139860942296830/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    悟空码字
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T02:10:35.000Z" title="Tue Dec 30 2025 02:10:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是小悟。</p>
<h2 data-id="heading-0">Word到PDF的奇幻之旅</h2>
<p>Word文档就像个穿着睡衣在家办公的程序员——<strong>舒服但有点随意</strong>。而PDF呢？就是穿上西装打上领带，准备去参加董事会的同一人——<strong>专业且纹丝不动</strong>！</p>
<p>这转变过程好比：</p>
<ol>
<li><strong>Word文档</strong>：“哈！我的字体可以随便换，边距可以随意调，图片还能拖来拖去~”</li>
<li><strong>PDF</strong>：“闭嘴！现在开始我说了算，每个像素都给我站好岗！”</li>
</ol>
<p>SpringBoot实现这个转换，就像是请了个<strong>文档变形金刚</strong>，把自由散漫的Word驯化成纪律严明的PDF士兵。下面就让我带你见证这场“格式驯化仪式”！</p>
<h2 data-id="heading-1">准备阶段：装备你的“变形工具箱”</h2>
<h3 data-id="heading-2">第一步：Maven依赖大采购</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- pom.xml 里加入这些法宝 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- SpringBoot标准装备 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- Apache POI - Word文档的“读心术” --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.poi<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>poi<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.2.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.poi<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>poi-ooxml<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.2.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- OpenPDF - PDF的“打印机” --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.librepdf<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>openpdf<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.3.30<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 文件类型检测 - 避免把图片当Word处理 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.tika<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>tika-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.7.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h3 data-id="heading-3">第二步：配置属性文件</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># application.yml</span>
<span class="hljs-attr">word-to-pdf:</span>
  <span class="hljs-attr">upload-dir:</span> <span class="hljs-string">"uploads/"</span>  <span class="hljs-comment"># Word文档临时停靠站</span>
  <span class="hljs-attr">output-dir:</span> <span class="hljs-string">"pdf-output/"</span>  <span class="hljs-comment"># PDF成品仓库</span>
  <span class="hljs-attr">max-file-size:</span> <span class="hljs-string">10MB</span>  <span class="hljs-comment"># 别想用《战争与和平》来考验我</span>
  
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">servlet:</span>
    <span class="hljs-attr">multipart:</span>
      <span class="hljs-attr">max-file-size:</span> <span class="hljs-string">10MB</span>
      <span class="hljs-attr">max-request-size:</span> <span class="hljs-string">10MB</span>
</code></pre>
<h2 data-id="heading-4">核心代码：变身吧，Word君！</h2>
<h3 data-id="heading-5">1. 文件上传控制器（接待员）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;
<span class="hljs-keyword">import</span> org.springframework.web.multipart.MultipartFile;
<span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;
<span class="hljs-keyword">import</span> java.io.*;

<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/api/doc-transform")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WordToPdfController</span> {
    
    <span class="hljs-meta">@PostMapping("/word-to-pdf")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">convertWordToPdf</span><span class="hljs-params">(
            <span class="hljs-meta">@RequestParam("file")</span> MultipartFile wordFile,
            HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> IOException {
        
        <span class="hljs-comment">// 1. 检查文件：别想用猫咪图片冒充Word文档！</span>
        <span class="hljs-keyword">if</span> (!isWordDocument(wordFile)) {
            response.getWriter().write(<span class="hljs-string">"喂！这不是Word文档，别骗我！"</span>);
            response.setStatus(HttpServletResponse.SC_BAD_REQUEST);
            <span class="hljs-keyword">return</span>;
        }
        
        <span class="hljs-comment">// 2. 临时存放Word文件（像安检前的暂存）</span>
        <span class="hljs-type">File</span> <span class="hljs-variable">tempWordFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">"temp_"</span> + System.currentTimeMillis() + <span class="hljs-string">".docx"</span>);
        wordFile.transferTo(tempWordFile);
        
        <span class="hljs-comment">// 3. 开始变形！</span>
        <span class="hljs-type">byte</span>[] pdfBytes = WordToPdfConverter.convert(tempWordFile);
        
        <span class="hljs-comment">// 4. 清理现场（像用完的变形金刚恢复原状）</span>
        tempWordFile.delete();
        
        <span class="hljs-comment">// 5. 把PDF交给用户</span>
        response.setContentType(<span class="hljs-string">"application/pdf"</span>);
        response.setHeader(<span class="hljs-string">"Content-Disposition"</span>, 
            <span class="hljs-string">"attachment; filename=\""</span> + 
            wordFile.getOriginalFilename().replace(<span class="hljs-string">".docx"</span>, <span class="hljs-string">".pdf"</span>) + <span class="hljs-string">"\""</span>);
        response.getOutputStream().write(pdfBytes);
        
        System.out.println(<span class="hljs-string">"转换成功！又一个Word被成功驯化成PDF！"</span>);
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isWordDocument</span><span class="hljs-params">(MultipartFile file)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">fileName</span> <span class="hljs-operator">=</span> file.getOriginalFilename().toLowerCase();
        <span class="hljs-keyword">return</span> fileName.endsWith(<span class="hljs-string">".docx"</span>) || fileName.endsWith(<span class="hljs-string">".doc"</span>);
    }
}
</code></pre>
<h3 data-id="heading-6">2. 转换器核心（真正的变形引擎）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.apache.poi.xwpf.usermodel.*;
<span class="hljs-keyword">import</span> com.lowagie.text.*;
<span class="hljs-keyword">import</span> com.lowagie.text.pdf.PdfWriter;
<span class="hljs-keyword">import</span> java.io.*;

<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WordToPdfConverter</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] convert(File wordFile) <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">pdfOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();
        
        <span class="hljs-keyword">try</span> (<span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(wordFile)) {
            <span class="hljs-comment">// 1. 打开Word文档（像打开潘多拉魔盒）</span>
            <span class="hljs-type">XWPFDocument</span> <span class="hljs-variable">document</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XWPFDocument</span>(fis);
            
            <span class="hljs-comment">// 2. 创建PDF文档（准备新家）</span>
            <span class="hljs-type">Document</span> <span class="hljs-variable">pdfDocument</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Document</span>();
            PdfWriter.getInstance(pdfDocument, pdfOutputStream);
            pdfDocument.open();
            
            <span class="hljs-comment">// 3. 逐段搬运内容（像蚂蚁搬家）</span>
            System.out.println(<span class="hljs-string">"开始搬运段落，共"</span> + document.getParagraphs().size() + <span class="hljs-string">"段..."</span>);
            
            <span class="hljs-keyword">for</span> (XWPFParagraph para : document.getParagraphs()) {
                <span class="hljs-keyword">if</span> (para.getText().trim().isEmpty()) <span class="hljs-keyword">continue</span>;
                
                <span class="hljs-comment">// 处理文本样式</span>
                <span class="hljs-type">Font</span> <span class="hljs-variable">font</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Font</span>();
                <span class="hljs-keyword">if</span> (para.getStyle() != <span class="hljs-literal">null</span>) {
                    <span class="hljs-keyword">switch</span> (para.getStyle()) {
                        <span class="hljs-keyword">case</span> <span class="hljs-string">"Heading1"</span>:
                            font = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Font</span>(Font.HELVETICA, <span class="hljs-number">18</span>, Font.BOLD);
                            <span class="hljs-keyword">break</span>;
                        <span class="hljs-keyword">case</span> <span class="hljs-string">"Heading2"</span>:
                            font = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Font</span>(Font.HELVETICA, <span class="hljs-number">16</span>, Font.BOLD);
                            <span class="hljs-keyword">break</span>;
                        <span class="hljs-keyword">default</span>:
                            font = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Font</span>(Font.HELVETICA, <span class="hljs-number">12</span>, Font.NORMAL);
                    }
                }
                
                <span class="hljs-type">Paragraph</span> <span class="hljs-variable">pdfPara</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Paragraph</span>(para.getText(), font);
                pdfDocument.add(pdfPara);
                pdfDocument.add(Chunk.NEWLINE);  <span class="hljs-comment">// 加个换行，喘口气</span>
            }
            
            <span class="hljs-comment">// 4. 处理图片（最难搬家的部分）</span>
            System.out.println(<span class="hljs-string">"开始处理图片，共"</span> + document.getAllPictures().size() + <span class="hljs-string">"张..."</span>);
            <span class="hljs-keyword">for</span> (XWPFPictureData picture : document.getAllPictures()) {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-type">byte</span>[] pictureData = picture.getData();
                    <span class="hljs-type">Image</span> <span class="hljs-variable">image</span> <span class="hljs-operator">=</span> Image.getInstance(pictureData);
                    image.scaleToFit(<span class="hljs-number">500</span>, <span class="hljs-number">500</span>);  <span class="hljs-comment">// 给图片上个紧箍咒，别太大</span>
                    image.setAlignment(Element.ALIGN_CENTER);
                    pdfDocument.add(image);
                    pdfDocument.add(Chunk.NEWLINE);
                } <span class="hljs-keyword">catch</span> (Exception e) {
                    System.err.println(<span class="hljs-string">"图片"</span> + picture.getFileName() + <span class="hljs-string">"太调皮，转换失败: "</span> + e.getMessage());
                }
            }
            
            <span class="hljs-comment">// 5. 处理表格（Excel表示：我也想来凑热闹）</span>
            <span class="hljs-keyword">for</span> (XWPFTable table : document.getTables()) {
                com.lowagie.text.<span class="hljs-type">Table</span> <span class="hljs-variable">pdfTable</span> <span class="hljs-operator">=</span> 
                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">com</span>.lowagie.text.Table(table.getNumberOfRows());
                
                <span class="hljs-keyword">for</span> (XWPFTableRow row : table.getRows()) {
                    <span class="hljs-keyword">for</span> (XWPFTableCell cell : row.getTableCells()) {
                        pdfTable.addCell(cell.getText());
                    }
                }
                pdfDocument.add(pdfTable);
            }
            
            pdfDocument.close();
            document.close();
            
            System.out.println(<span class="hljs-string">"转换完成！生成PDF大小: "</span> + 
                (pdfOutputStream.size() / <span class="hljs-number">1024</span>) + <span class="hljs-string">" KB"</span>);
            
        } <span class="hljs-keyword">catch</span> (Exception e) {
            System.err.println(<span class="hljs-string">"转换过程出现意外: "</span> + e.getMessage());
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IOException</span>(<span class="hljs-string">"转换失败，Word文档可能被施了魔法"</span>, e);
        }
        
        <span class="hljs-keyword">return</span> pdfOutputStream.toByteArray();
    }
}
</code></pre>
<h3 data-id="heading-7">3. 异常处理（变形失败的救护车）</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-meta">@ControllerAdvice</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DocumentConversionExceptionHandler</span> {
    
    <span class="hljs-meta">@ExceptionHandler</span>(<span class="hljs-type">IOException</span>.class)
    <span class="hljs-keyword">public</span> <span class="hljs-type">ResponseEntity</span>&lt;<span class="hljs-type">String</span>&gt; handleIOException(<span class="hljs-type">IOException</span> e) {
        <span class="hljs-keyword">return</span> <span class="hljs-type">ResponseEntity</span>.status(<span class="hljs-type">HttpStatus</span>.<span class="hljs-type">INTERNAL_SERVER_ERROR</span>)
            .body(<span class="hljs-string">"文档转换失败，可能原因：<span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
                  <span class="hljs-string">"1. Word文档被外星人加密了<span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
                  <span class="hljs-string">"2. 文件太大，服务器举不动了<span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
                  <span class="hljs-string">"3. 网络连接在打瞌睡<span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
                  <span class="hljs-string">"错误详情: "</span> <span class="hljs-operator">+</span> e.getMessage());
    }
    
    <span class="hljs-meta">@ExceptionHandler</span>(<span class="hljs-type">InvalidFormatException</span>.class)
    <span class="hljs-keyword">public</span> <span class="hljs-type">ResponseEntity</span>&lt;<span class="hljs-type">String</span>&gt; handleInvalidFormat(<span class="hljs-type">Exception</span> e) {
        <span class="hljs-keyword">return</span> <span class="hljs-type">ResponseEntity</span>.badRequest()
            .body(<span class="hljs-string">"喂！你上传的是Word文档吗？<span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
                  <span class="hljs-string">"我猜你上传的是：<span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
                  <span class="hljs-string">"□ 猫咪图片 <span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
                  <span class="hljs-string">"□ Excel表格 <span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
                  <span class="hljs-string">"□ 心灵鸡汤文本 <span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
                  <span class="hljs-string">"请上传正经的.docx或.doc文件！"</span>);
    }
}
</code></pre>
<h3 data-id="heading-8">4. 进度监控（变形过程直播）</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConversionProgressService</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Integer</span>&gt; progressMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
    
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">startConversion</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> fileId</span>) {
        progressMap.<span class="hljs-title function_">put</span>(fileId, <span class="hljs-number">0</span>);
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"开始转换文件: "</span> + fileId);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">updateProgress</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> fileId, int percent</span>) {
        progressMap.<span class="hljs-title function_">put</span>(fileId, percent);
        
        <span class="hljs-comment">// 打印进度条（假装很高级）</span>
        <span class="hljs-title class_">StringBuilder</span> progressBar = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-string">"["</span>);
        <span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">20</span>; i++) {
            progressBar.<span class="hljs-title function_">append</span>(i * <span class="hljs-number">5</span> &lt; percent ? <span class="hljs-string">"█"</span> : <span class="hljs-string">"░"</span>);
        }
        progressBar.<span class="hljs-title function_">append</span>(<span class="hljs-string">"] "</span>).<span class="hljs-title function_">append</span>(percent).<span class="hljs-title function_">append</span>(<span class="hljs-string">"%"</span>);
        
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(fileId + <span class="hljs-string">" 转换进度: "</span> + progressBar.<span class="hljs-title function_">toString</span>());
        
        <span class="hljs-comment">// 说点骚话鼓励一下</span>
        <span class="hljs-keyword">if</span> (percent == <span class="hljs-number">50</span>) {
            <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"转换过半，坚持住！"</span>);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (percent == <span class="hljs-number">90</span>) {
            <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"马上完成，准备发射PDF！"</span>);
        }
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">completeConversion</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> fileId</span>) {
        progressMap.<span class="hljs-title function_">remove</span>(fileId);
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(fileId + <span class="hljs-string">" 转换完成，深藏功与名~"</span>);
    }
}
</code></pre>
<h2 data-id="heading-9">前端调用示例（用户操作界面）</h2>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Word转PDF变形工坊<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        <span class="hljs-selector-tag">body</span> { <span class="hljs-attribute">font-family</span>: <span class="hljs-string">'Comic Sans MS'</span>, cursive; <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>; }
        <span class="hljs-selector-class">.container</span> { <span class="hljs-attribute">max-width</span>: <span class="hljs-number">600px</span>; <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> auto; }
        <span class="hljs-selector-class">.drop-zone</span> {
            <span class="hljs-attribute">border</span>: <span class="hljs-number">3px</span> dashed <span class="hljs-number">#4CAF50</span>;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">10px</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">40px</span>;
            <span class="hljs-attribute">text-align</span>: center;
            <span class="hljs-attribute">background</span>: <span class="hljs-number">#f9f9f9</span>;
            <span class="hljs-attribute">cursor</span>: pointer;
        }
        <span class="hljs-selector-class">.drop-zone</span><span class="hljs-selector-pseudo">:hover</span> { <span class="hljs-attribute">background</span>: <span class="hljs-number">#e8f5e9</span>; }
        <span class="hljs-selector-class">.convert-btn</span> {
            <span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(<span class="hljs-number">45deg</span>, <span class="hljs-number">#FF6B6B</span>, <span class="hljs-number">#4ECDC4</span>);
            <span class="hljs-attribute">color</span>: white;
            <span class="hljs-attribute">border</span>: none;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">15px</span> <span class="hljs-number">30px</span>;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">25px</span>;
            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">18px</span>;
            <span class="hljs-attribute">cursor</span>: pointer;
            <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">20px</span>;
        }
        <span class="hljs-selector-class">.progress-bar</span> {
            <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">20px</span>;
            <span class="hljs-attribute">background</span>: <span class="hljs-number">#ddd</span>;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">10px</span>;
            <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">20px</span>;
            <span class="hljs-attribute">overflow</span>: hidden;
            <span class="hljs-attribute">display</span>: none;
        }
        <span class="hljs-selector-class">.progress-fill</span> {
            <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
            <span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(<span class="hljs-number">90deg</span>, <span class="hljs-number">#4CAF50</span>, <span class="hljs-number">#8BC34A</span>);
            <span class="hljs-attribute">width</span>: <span class="hljs-number">0%</span>;
            <span class="hljs-attribute">transition</span>: width <span class="hljs-number">0.3s</span>;
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Word转PDF变形工坊<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>把你的Word文档扔进来，还你一个乖巧的PDF！<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"drop-zone"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"dropZone"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>拖拽Word文件到这里<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>或者 <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"color: #2196F3; cursor: pointer;"</span>&gt;</span>点击选择文件
                <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"file"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"fileInput"</span> <span class="hljs-attr">accept</span>=<span class="hljs-string">".docx,.doc"</span> <span class="hljs-attr">hidden</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"convert-btn"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"convertToPdf()"</span>&gt;</span>
            开始变形！
        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"progress-bar"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"progressBar"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"progress-fill"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"progressFill"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"status"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin-top: 20px;"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">const</span> dropZone = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'dropZone'</span>);
        <span class="hljs-keyword">const</span> fileInput = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'fileInput'</span>);
        <span class="hljs-keyword">let</span> selectedFile = <span class="hljs-literal">null</span>;
        
        <span class="hljs-comment">// 拖拽功能</span>
        dropZone.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'dragover'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
            e.<span class="hljs-title function_">preventDefault</span>();
            dropZone.<span class="hljs-property">style</span>.<span class="hljs-property">background</span> = <span class="hljs-string">'#e8f5e9'</span>;
        });
        
        dropZone.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'drop'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
            e.<span class="hljs-title function_">preventDefault</span>();
            dropZone.<span class="hljs-property">style</span>.<span class="hljs-property">background</span> = <span class="hljs-string">'#f9f9f9'</span>;
            selectedFile = e.<span class="hljs-property">dataTransfer</span>.<span class="hljs-property">files</span>[<span class="hljs-number">0</span>];
            <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'status'</span>).<span class="hljs-property">innerHTML</span> = 
                <span class="hljs-string">`已选择: &lt;strong&gt;<span class="hljs-subst">${selectedFile.name}</span>&lt;/strong&gt;`</span>;
        });
        
        fileInput.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'change'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
            selectedFile = e.<span class="hljs-property">target</span>.<span class="hljs-property">files</span>[<span class="hljs-number">0</span>];
            <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'status'</span>).<span class="hljs-property">innerHTML</span> = 
                <span class="hljs-string">`已选择: &lt;strong&gt;<span class="hljs-subst">${selectedFile.name}</span>&lt;/strong&gt;`</span>;
        });
        
        <span class="hljs-comment">// 转换函数</span>
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">convertToPdf</span>(<span class="hljs-params"/>) {
            <span class="hljs-keyword">if</span> (!selectedFile) {
                <span class="hljs-title function_">alert</span>(<span class="hljs-string">'请先选择一个Word文件！'</span>);
                <span class="hljs-keyword">return</span>;
            }
            
            <span class="hljs-keyword">const</span> formData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormData</span>();
            formData.<span class="hljs-title function_">append</span>(<span class="hljs-string">'file'</span>, selectedFile);
            
            <span class="hljs-comment">// 显示进度条</span>
            <span class="hljs-keyword">const</span> progressBar = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'progressBar'</span>);
            <span class="hljs-keyword">const</span> progressFill = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'progressFill'</span>);
            progressBar.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'block'</span>;
            
            <span class="hljs-comment">// 模拟进度（实际项目可以用WebSocket）</span>
            <span class="hljs-keyword">let</span> progress = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">const</span> interval = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
                progress += <span class="hljs-number">10</span>;
                progressFill.<span class="hljs-property">style</span>.<span class="hljs-property">width</span> = <span class="hljs-string">`<span class="hljs-subst">${progress}</span>%`</span>;
                <span class="hljs-keyword">if</span> (progress &gt;= <span class="hljs-number">90</span>) <span class="hljs-built_in">clearInterval</span>(interval);
            }, <span class="hljs-number">300</span>);
            
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/doc-transform/word-to-pdf'</span>, {
                    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
                    <span class="hljs-attr">body</span>: formData
                });
                
                <span class="hljs-built_in">clearInterval</span>(interval);
                progressFill.<span class="hljs-property">style</span>.<span class="hljs-property">width</span> = <span class="hljs-string">'100%'</span>;
                
                <span class="hljs-keyword">if</span> (response.<span class="hljs-property">ok</span>) {
                    <span class="hljs-comment">// 下载PDF</span>
                    <span class="hljs-keyword">const</span> blob = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">blob</span>();
                    <span class="hljs-keyword">const</span> url = <span class="hljs-variable language_">window</span>.<span class="hljs-property">URL</span>.<span class="hljs-title function_">createObjectURL</span>(blob);
                    <span class="hljs-keyword">const</span> a = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'a'</span>);
                    a.<span class="hljs-property">href</span> = url;
                    a.<span class="hljs-property">download</span> = selectedFile.<span class="hljs-property">name</span>.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\.docx?$/i</span>, <span class="hljs-string">'.pdf'</span>);
                    <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(a);
                    a.<span class="hljs-title function_">click</span>();
                    a.<span class="hljs-title function_">remove</span>();
                    
                    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'status'</span>).<span class="hljs-property">innerHTML</span> = 
                        <span class="hljs-string">'转换成功！PDF已开始下载~'</span>;
                    
                    <span class="hljs-comment">// 3秒后重置</span>
                    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
                        progressBar.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'none'</span>;
                        progressFill.<span class="hljs-property">style</span>.<span class="hljs-property">width</span> = <span class="hljs-string">'0%'</span>;
                        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'status'</span>).<span class="hljs-property">innerHTML</span> = <span class="hljs-string">''</span>;
                    }, <span class="hljs-number">3000</span>);
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">const</span> errorText = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">text</span>();
                    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'status'</span>).<span class="hljs-property">innerHTML</span> = 
                        <span class="hljs-string">`转换失败: <span class="hljs-subst">${errorText}</span>`</span>;
                }
            } <span class="hljs-keyword">catch</span> (error) {
                <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'status'</span>).<span class="hljs-property">innerHTML</span> = 
                    <span class="hljs-string">`网络错误: <span class="hljs-subst">${error.message}</span>`</span>;
            }
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h2 data-id="heading-10">高级功能扩展</h2>
<h3 data-id="heading-11">批量转换（群变模式）</h3>
<pre><code class="hljs language-arduino" lang="arduino">@Service
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BatchConversionService</span> {
    
    @Async  <span class="hljs-comment">// 异步处理，不卡界面</span>
    <span class="hljs-keyword">public</span> CompletableFuture&lt;List&lt;<span class="hljs-built_in">File</span>&gt;&gt; <span class="hljs-built_in">convertMultiple</span>(List&lt;MultipartFile&gt; files) {
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"开始批量转换，共"</span> + files.<span class="hljs-built_in">size</span>() + <span class="hljs-string">"个文件，冲鸭！"</span>);
        
        List&lt;<span class="hljs-built_in">File</span>&gt; pdfFiles = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
        List&lt;CompletableFuture&lt;<span class="hljs-built_in">File</span>&gt;&gt; futures = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; files.<span class="hljs-built_in">size</span>(); i++) {
            <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> index = i;
            CompletableFuture&lt;<span class="hljs-built_in">File</span>&gt; future = CompletableFuture.<span class="hljs-built_in">supplyAsync</span>(() -&gt; {
                <span class="hljs-keyword">try</span> {
                    System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"正在转换第"</span> + (index + <span class="hljs-number">1</span>) + <span class="hljs-string">"个文件..."</span>);
                    <span class="hljs-type">byte</span>[] pdfBytes = WordToPdfConverter.<span class="hljs-built_in">convert</span>(<span class="hljs-built_in">convertToFile</span>(files.<span class="hljs-built_in">get</span>(index)));
                    <span class="hljs-built_in">File</span> pdfFile = <span class="hljs-keyword">new</span> <span class="hljs-built_in">File</span>(<span class="hljs-string">"converted_"</span> + index + <span class="hljs-string">".pdf"</span>);
                    Files.<span class="hljs-built_in">write</span>(pdfFile.<span class="hljs-built_in">toPath</span>(), pdfBytes);
                    <span class="hljs-keyword">return</span> pdfFile;
                } <span class="hljs-built_in">catch</span> (Exception e) {
                    System.err.<span class="hljs-built_in">println</span>(<span class="hljs-string">"第"</span> + (index + <span class="hljs-number">1</span>) + <span class="hljs-string">"个文件转换失败: "</span> + e.<span class="hljs-built_in">getMessage</span>());
                    <span class="hljs-keyword">return</span> null;
                }
            });
            futures.<span class="hljs-built_in">add</span>(future);
        }
        
        <span class="hljs-comment">// 等待所有转换完成</span>
        CompletableFuture.<span class="hljs-built_in">allOf</span>(futures.<span class="hljs-built_in">toArray</span>(<span class="hljs-keyword">new</span> CompletableFuture[<span class="hljs-number">0</span>])).<span class="hljs-built_in">join</span>();
        
        <span class="hljs-keyword">for</span> (CompletableFuture&lt;<span class="hljs-built_in">File</span>&gt; future : futures) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-built_in">File</span> pdf = future.<span class="hljs-built_in">get</span>();
                <span class="hljs-keyword">if</span> (pdf != null) pdfFiles.<span class="hljs-built_in">add</span>(pdf);
            } <span class="hljs-built_in">catch</span> (Exception e) {
                <span class="hljs-comment">// 忽略失败的文件</span>
            }
        }
        
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"批量转换完成！成功: "</span> + pdfFiles.<span class="hljs-built_in">size</span>() + 
                          <span class="hljs-string">"/"</span> + files.<span class="hljs-built_in">size</span>() + <span class="hljs-string">" 个文件"</span>);
        <span class="hljs-keyword">return</span> CompletableFuture.<span class="hljs-built_in">completedFuture</span>(pdfFiles);
    }
}
</code></pre>
<h3 data-id="heading-12">转换记录（变形档案室）</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Entity</span>
<span class="hljs-variable">@Table</span>(name = <span class="hljs-string">"conversion_records"</span>)
<span class="hljs-variable">@Data</span>
<span class="hljs-variable">@NoArgsConstructor</span>
<span class="hljs-variable">@AllArgsConstructor</span>
public class ConversionRecord {
    <span class="hljs-variable">@Id</span>
    <span class="hljs-variable">@GeneratedValue</span>(strategy = GenerationType.IDENTITY)
    private Long id;
    
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">originalFileName</span>;
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">pdfFileName</span>;
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">Long</span> <span class="hljs-selector-tag">originalSize</span>;
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">Long</span> <span class="hljs-selector-tag">pdfSize</span>;
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">LocalDateTime</span> <span class="hljs-selector-tag">conversionTime</span>;
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">status</span>;  <span class="hljs-comment">// SUCCESS, FAILED, PROCESSING</span>
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">errorMessage</span>;
    
    @<span class="hljs-selector-tag">PrePersist</span>
    <span class="hljs-selector-tag">protected</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">onCreate</span>() {
        <span class="hljs-selector-tag">conversionTime</span> = <span class="hljs-selector-tag">LocalDateTime</span><span class="hljs-selector-class">.now</span>();
    }
}

@<span class="hljs-selector-tag">Repository</span>
<span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">interface</span> <span class="hljs-selector-tag">ConversionRecordRepository</span> <span class="hljs-selector-tag">extends</span> <span class="hljs-selector-tag">JpaRepository</span>&lt;<span class="hljs-selector-tag">ConversionRecord</span>, <span class="hljs-selector-tag">Long</span>&gt; {
    <span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">ConversionRecord</span>&gt; <span class="hljs-selector-tag">findByStatusOrderByConversionTimeDesc</span>(String status);
}
</code></pre>
<h2 data-id="heading-13">部署与优化建议</h2>
<h3 data-id="heading-14">1. 性能优化</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># application.yml 添加</span>
<span class="hljs-attr">server:</span>
  <span class="hljs-attr">tomcat:</span>
    <span class="hljs-attr">max-threads:</span> <span class="hljs-number">200</span>  <span class="hljs-comment"># 增加线程数处理并发转换</span>
    <span class="hljs-attr">min-spare-threads:</span> <span class="hljs-number">20</span>

<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">task:</span>
    <span class="hljs-attr">execution:</span>
      <span class="hljs-attr">pool:</span>
        <span class="hljs-attr">core-size:</span> <span class="hljs-number">10</span>  <span class="hljs-comment"># 异步任务线程池</span>
        <span class="hljs-attr">max-size:</span> <span class="hljs-number">50</span>
</code></pre>
<h3 data-id="heading-15">2. 内存管理</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MemoryWatcher</span> {
    
    <span class="hljs-meta">@Scheduled(fixedRate = 60000)</span>  <span class="hljs-comment">// 每分钟检查一次</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">monitorMemory</span><span class="hljs-params">()</span> {
        <span class="hljs-type">long</span> <span class="hljs-variable">usedMemory</span> <span class="hljs-operator">=</span> Runtime.getRuntime().totalMemory() - 
                         Runtime.getRuntime().freeMemory();
        <span class="hljs-type">long</span> <span class="hljs-variable">maxMemory</span> <span class="hljs-operator">=</span> Runtime.getRuntime().maxMemory();
        
        <span class="hljs-type">double</span> <span class="hljs-variable">usagePercentage</span> <span class="hljs-operator">=</span> (<span class="hljs-type">double</span>) usedMemory / maxMemory * <span class="hljs-number">100</span>;
        
        <span class="hljs-keyword">if</span> (usagePercentage &gt; <span class="hljs-number">80</span>) {
            System.out.println(<span class="hljs-string">"内存警告：使用率 "</span> + 
                String.format(<span class="hljs-string">"%.1f"</span>, usagePercentage) + <span class="hljs-string">"%"</span>);
            <span class="hljs-comment">// 触发垃圾回收</span>
            System.gc();
        }
    }
}
</code></pre>
<h2 data-id="heading-16">总结：Word转PDF的奇幻旅程终点站</h2>
<p>经过这一番折腾，我们成功打造了一个<strong>SpringBoot牌文档变形金刚</strong>！总结一下这场冒险：</p>
<h3 data-id="heading-17">我们实现了什么：</h3>
<ol>
<li><strong>格式驯化</strong>：把自由的Word变成规矩的PDF</li>
<li><strong>异步处理</strong>：大文件转换不卡界面</li>
<li><strong>进度监控</strong>：实时查看转换进度</li>
<li><strong>错误处理</strong>：优雅处理各种意外情况</li>
<li><strong>批量操作</strong>：一次性驯化整个Word文档家族</li>
</ol>
<h3 data-id="heading-18">注意事项：</h3>
<ol>
<li><strong>字体问题</strong>：有些特殊字体PDF可能不认识，需要额外处理</li>
<li><strong>复杂格式</strong>：Word里的高级排版（如文本框、艺术字）可能变形</li>
<li><strong>内存消耗</strong>：大文档转换时注意内存溢出</li>
<li><strong>并发限制</strong>：同时转换太多文档可能导致服务器喘不过气</li>
</ol>
<p>Word转PDF就像给文档穿上“防改铠甲”，SpringBoot就是我们打造这副铠甲的智能工厂。虽然过程中会遇到各种奇葩格式的“刺头文档”，但只要有耐心调试，最终都能把它们治理得服服帖帖！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3131e8e3e124b91afd66148721634fc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf56m656CB5a2X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767665866&amp;x-signature=2mnwm4puxTRh%2Bf5b5QCKh6UGPUs%3D" alt="文档变形记，SpringBoot实战，3步让Word乖乖变PDF.png" loading="lazy"/></p>
<p><strong>谢谢你看我的文章，既然看到这里了，如果觉得不错，随手点个赞、转发、在看三连吧，感谢感谢。那我们，下次再见。</strong></p>
<p>您的一键三连，是我更新的最大动力，谢谢</p>
<p>山水有相逢，来日皆可期，谢谢阅读，我们再会</p>
<p>我手中的金箍棒，上能通天，下能探海</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[能省事”。SpringBoot+MyBatis-Plus：开发效率提升10倍！]]></title>    <link>https://juejin.cn/post/7589181008098705423</link>    <guid>https://juejin.cn/post/7589181008098705423</guid>    <pubDate>2025-12-30T02:16:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589181008098705423" data-draft-id="7589206614929195048" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="能省事”。SpringBoot+MyBatis-Plus：开发效率提升10倍！"/> <meta itemprop="keywords" content="MyBatis,Spring Boot,Java"/> <meta itemprop="datePublished" content="2025-12-30T02:16:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小坏说Java"/> <meta itemprop="url" content="https://juejin.cn/user/3898184413750203"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            能省事”。SpringBoot+MyBatis-Plus：开发效率提升10倍！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3898184413750203/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小坏说Java
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T02:16:35.000Z" title="Tue Dec 30 2025 02:16:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">《能省事”。SpringBoot+MyBatis-Plus：开发效率提升10倍！》</h2>
<blockquote>
<p>我是小坏，今天咱们聊点实在的。你还在手写增删改查吗？还在写那些重复的Mapper XML吗？还在为分页头疼吗？试试MyBatis-Plus，让你少写80%的代码！</p>
</blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
<p><strong>资源获取</strong>：关注公众号: 小坏说Java ，获取本文所有示例代码、配置模板及导出工具。</p>
<h3 data-id="heading-1">一、开发者的真实痛点</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
<p><strong>资源获取</strong>：关注公众号: 小坏说Java ，获取本文所有示例代码、配置模板及导出工具。</p>
<p><strong>看看这些场景你熟不熟</strong>：</p>
<p><strong>场景1</strong>：新项目开始，建表、建实体、建Mapper、建Service、建Controller...一套下来几十个文件。</p>
<p><strong>场景2</strong>：写个条件查询，XML里写一堆if标签：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"findUsers"</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">"User"</span>&gt;</span>
    SELECT * FROM user WHERE 1=1
    <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"name != null"</span>&gt;</span>AND name like #{name}<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"age != null"</span>&gt;</span>AND age = #{age}<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"status != null"</span>&gt;</span>AND status = #{status}<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
</code></pre>
<p><strong>场景3</strong>：分页查询，每写一次都要：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 手写分页SQL</span>
<span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"SELECT * FROM user LIMIT "</span> + (page-<span class="hljs-number">1</span>)*size + <span class="hljs-string">","</span> + size;
<span class="hljs-comment">// 再查总数</span>
<span class="hljs-type">String</span> <span class="hljs-variable">countSql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"SELECT COUNT(*) FROM user"</span>;
</code></pre>
<p><strong>用MyBatis-Plus能解决啥</strong>：</p>
<ul>
<li>自动生成基础代码</li>
<li>条件查询不用写XML</li>
<li>分页一行代码搞定</li>
<li>内置逻辑删除、字段填充</li>
<li>支持多租户数据隔离</li>
</ul>
<h3 data-id="heading-2">二、3分钟快速上手</h3>
<h4 data-id="heading-3">2.1 加个依赖</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.3.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h4 data-id="heading-4">2.2 写个配置</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
<p><strong>资源获取</strong>：关注公众号: 小坏说Java ，获取本文所有示例代码、配置模板及导出工具。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># application.yml</span>
<span class="hljs-attr">mybatis-plus:</span>
  <span class="hljs-attr">configuration:</span>
    <span class="hljs-attr">log-impl:</span> <span class="hljs-string">org.apache.ibatis.logging.stdout.StdOutImpl</span>  <span class="hljs-comment"># 打印SQL日志</span>
  <span class="hljs-attr">global-config:</span>
    <span class="hljs-attr">db-config:</span>
      <span class="hljs-attr">logic-delete-field:</span> <span class="hljs-string">deleted</span>  <span class="hljs-comment"># 全局逻辑删除字段名</span>
      <span class="hljs-attr">logic-delete-value:</span> <span class="hljs-number">1</span>        <span class="hljs-comment"># 逻辑已删除值</span>
      <span class="hljs-attr">logic-not-delete-value:</span> <span class="hljs-number">0</span>    <span class="hljs-comment"># 逻辑未删除值</span>
</code></pre>
<h4 data-id="heading-5">2.3 定义实体</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Data</span>
<span class="hljs-meta">@TableName("user")</span>  <span class="hljs-comment">// 指定表名</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
    <span class="hljs-meta">@TableId(type = IdType.AUTO)</span>  <span class="hljs-comment">// 主键自增</span>
    <span class="hljs-keyword">private</span> Long id;
    
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> Integer age;
    <span class="hljs-keyword">private</span> String email;
    
    <span class="hljs-meta">@TableLogic</span>  <span class="hljs-comment">// 逻辑删除字段</span>
    <span class="hljs-keyword">private</span> Integer deleted;
    
    <span class="hljs-meta">@TableField(fill = FieldFill.INSERT)</span>  <span class="hljs-comment">// 插入时自动填充</span>
    <span class="hljs-keyword">private</span> LocalDateTime createTime;
    
    <span class="hljs-meta">@TableField(fill = FieldFill.INSERT_UPDATE)</span>  <span class="hljs-comment">// 插入和更新时填充</span>
    <span class="hljs-keyword">private</span> LocalDateTime updateTime;
}
</code></pre>
<h4 data-id="heading-6">2.4 写个Mapper（最简单版）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Mapper</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseMapper</span>&lt;User&gt; {
    <span class="hljs-comment">// 继承BaseMapper就有了所有基础CRUD方法</span>
    <span class="hljs-comment">// 不用写XML，不用写SQL</span>
}
</code></pre>
<h4 data-id="heading-7">2.5 马上就能用</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/users")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserMapper userMapper;
    
    <span class="hljs-meta">@GetMapping("/{id}")</span>
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> {
        <span class="hljs-comment">// 直接查询</span>
        <span class="hljs-keyword">return</span> userMapper.selectById(id);
    }
    
    <span class="hljs-meta">@PostMapping</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">addUser</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> User user)</span> {
        <span class="hljs-comment">// 直接插入</span>
        userMapper.insert(user);
        <span class="hljs-keyword">return</span> <span class="hljs-string">"添加成功"</span>;
    }
}
</code></pre>
<h3 data-id="heading-8">三、核心功能：解放生产力</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
<p><strong>资源获取</strong>：关注公众号: 小坏说Java ，获取本文所有示例代码、配置模板及导出工具。</p>
<h4 data-id="heading-9">3.1 代码生成器（效率提升80%）</h4>
<p><strong>以前</strong>：手动创建实体、Mapper、Service、Controller
<strong>现在</strong>：一键生成所有文件</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CodeGenerator</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">AutoGenerator</span> <span class="hljs-variable">generator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AutoGenerator</span>();
        
        <span class="hljs-comment">// 数据库配置</span>
        <span class="hljs-type">DataSourceConfig</span> <span class="hljs-variable">dataSourceConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataSourceConfig</span>();
        dataSourceConfig.setUrl(<span class="hljs-string">"jdbc:mysql://localhost:3306/test"</span>);
        dataSourceConfig.setUsername(<span class="hljs-string">"root"</span>);
        dataSourceConfig.setPassword(<span class="hljs-string">"123456"</span>);
        generator.setDataSource(dataSourceConfig);
        
        <span class="hljs-comment">// 全局配置</span>
        <span class="hljs-type">GlobalConfig</span> <span class="hljs-variable">globalConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GlobalConfig</span>();
        globalConfig.setOutputDir(System.getProperty(<span class="hljs-string">"user.dir"</span>) + <span class="hljs-string">"/src/main/java"</span>);
        globalConfig.setAuthor(<span class="hljs-string">"小坏"</span>);
        globalConfig.setOpen(<span class="hljs-literal">false</span>);  <span class="hljs-comment">// 生成后不打开文件夹</span>
        generator.setGlobalConfig(globalConfig);
        
        <span class="hljs-comment">// 包配置</span>
        <span class="hljs-type">PackageConfig</span> <span class="hljs-variable">packageConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PackageConfig</span>();
        packageConfig.setParent(<span class="hljs-string">"com.example.demo"</span>);
        packageConfig.setEntity(<span class="hljs-string">"entity"</span>);
        packageConfig.setMapper(<span class="hljs-string">"mapper"</span>);
        packageConfig.setService(<span class="hljs-string">"service"</span>);
        packageConfig.setController(<span class="hljs-string">"controller"</span>);
        generator.setPackageInfo(packageConfig);
        
        <span class="hljs-comment">// 策略配置</span>
        <span class="hljs-type">StrategyConfig</span> <span class="hljs-variable">strategy</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StrategyConfig</span>();
        strategy.setInclude(<span class="hljs-string">"user"</span>, <span class="hljs-string">"order"</span>, <span class="hljs-string">"product"</span>);  <span class="hljs-comment">// 要生成的表</span>
        strategy.setNaming(NamingStrategy.underline_to_camel);  <span class="hljs-comment">// 下划线转驼峰</span>
        strategy.setColumnNaming(NamingStrategy.underline_to_camel);
        strategy.setEntityLombokModel(<span class="hljs-literal">true</span>);  <span class="hljs-comment">// 使用Lombok</span>
        strategy.setRestControllerStyle(<span class="hljs-literal">true</span>);  <span class="hljs-comment">// REST风格Controller</span>
        generator.setStrategy(strategy);
        
        <span class="hljs-comment">// 执行生成</span>
        generator.execute();
    }
}
</code></pre>
<p><strong>运行后生成</strong>：</p>
<ul>
<li>User.java（实体类）</li>
<li>UserMapper.java（Mapper接口）</li>
<li>UserService.java（Service接口）</li>
<li>UserServiceImpl.java（Service实现）</li>
<li>UserController.java（Controller）</li>
</ul>
<h4 data-id="heading-10">3.2 条件构造器（告别XML）</h4>
<p><strong>以前</strong>：写一堆if标签的XML
<strong>现在</strong>：链式调用，可读性强</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserMapper userMapper;
    
    <span class="hljs-comment">// 复杂条件查询</span>
    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">findUsers</span><span class="hljs-params">(String name, Integer minAge, Integer maxAge, Integer status)</span> {
        QueryWrapper&lt;User&gt; wrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryWrapper</span>&lt;&gt;();
        
        <span class="hljs-keyword">if</span> (StringUtils.isNotBlank(name)) {
            wrapper.like(<span class="hljs-string">"name"</span>, name);  <span class="hljs-comment">// name like '%?%'</span>
        }
        <span class="hljs-keyword">if</span> (minAge != <span class="hljs-literal">null</span>) {
            wrapper.ge(<span class="hljs-string">"age"</span>, minAge);  <span class="hljs-comment">// age &gt;= ?</span>
        }
        <span class="hljs-keyword">if</span> (maxAge != <span class="hljs-literal">null</span>) {
            wrapper.le(<span class="hljs-string">"age"</span>, maxAge);  <span class="hljs-comment">// age &lt;= ?</span>
        }
        <span class="hljs-keyword">if</span> (status != <span class="hljs-literal">null</span>) {
            wrapper.eq(<span class="hljs-string">"status"</span>, status);  <span class="hljs-comment">// status = ?</span>
        }
        
        wrapper.orderByDesc(<span class="hljs-string">"create_time"</span>);
        <span class="hljs-keyword">return</span> userMapper.selectList(wrapper);
    }
    
    <span class="hljs-comment">// 更简洁的Lambda写法（推荐）</span>
    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">findUsersLambda</span><span class="hljs-params">(String name, Integer age)</span> {
        LambdaQueryWrapper&lt;User&gt; wrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;();
        
        wrapper.like(StringUtils.isNotBlank(name), User::getName, name)
               .eq(age != <span class="hljs-literal">null</span>, User::getAge, age)
               .orderByDesc(User::getCreateTime);
        
        <span class="hljs-keyword">return</span> userMapper.selectList(wrapper);
    }
}
</code></pre>
<h4 data-id="heading-11">3.3 分页插件（一行代码搞定）</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
<p><strong>资源获取</strong>：关注公众号: 小坏说Java ，获取本文所有示例代码、配置模板及导出工具。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MybatisPlusConfig</span> {
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> MybatisPlusInterceptor <span class="hljs-title function_">mybatisPlusInterceptor</span><span class="hljs-params">()</span> {
        <span class="hljs-type">MybatisPlusInterceptor</span> <span class="hljs-variable">interceptor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MybatisPlusInterceptor</span>();
        <span class="hljs-comment">// 分页插件</span>
        interceptor.addInnerInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PaginationInnerInterceptor</span>(DbType.MYSQL));
        <span class="hljs-keyword">return</span> interceptor;
    }
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    
    <span class="hljs-keyword">public</span> Page&lt;User&gt; <span class="hljs-title function_">getUsersByPage</span><span class="hljs-params">(<span class="hljs-type">int</span> pageNum, <span class="hljs-type">int</span> pageSize, String keyword)</span> {
        Page&lt;User&gt; page = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>&lt;&gt;(pageNum, pageSize);
        
        LambdaQueryWrapper&lt;User&gt; wrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;();
        wrapper.like(StringUtils.isNotBlank(keyword), User::getName, keyword);
        
        <span class="hljs-keyword">return</span> userMapper.selectPage(page, wrapper);
    }
}
</code></pre>
<h4 data-id="heading-12">3.4 自动填充（减少重复代码）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyMetaObjectHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MetaObjectHandler</span> {
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertFill</span><span class="hljs-params">(MetaObject metaObject)</span> {
        <span class="hljs-comment">// 插入时自动填充</span>
        <span class="hljs-built_in">this</span>.strictInsertFill(metaObject, <span class="hljs-string">"createTime"</span>, LocalDateTime.class, LocalDateTime.now());
        <span class="hljs-built_in">this</span>.strictInsertFill(metaObject, <span class="hljs-string">"updateTime"</span>, LocalDateTime.class, LocalDateTime.now());
        <span class="hljs-built_in">this</span>.strictInsertFill(metaObject, <span class="hljs-string">"createBy"</span>, String.class, getCurrentUsername());
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateFill</span><span class="hljs-params">(MetaObject metaObject)</span> {
        <span class="hljs-comment">// 更新时自动填充</span>
        <span class="hljs-built_in">this</span>.strictUpdateFill(metaObject, <span class="hljs-string">"updateTime"</span>, LocalDateTime.class, LocalDateTime.now());
        <span class="hljs-built_in">this</span>.strictUpdateFill(metaObject, <span class="hljs-string">"updateBy"</span>, String.class, getCurrentUsername());
    }
}
</code></pre>
<h4 data-id="heading-13">3.5 逻辑删除（数据不真删）</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
<p><strong>资源获取</strong>：关注公众号: 小坏说Java ，获取本文所有示例代码、配置模板及导出工具。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 实体类字段加上注解</span>
<span class="hljs-meta">@TableLogic</span>
<span class="hljs-keyword">private</span> Integer deleted;

<span class="hljs-comment">// 使用时自动过滤已删除数据</span>
List&lt;User&gt; users = userMapper.selectList(<span class="hljs-literal">null</span>);  <span class="hljs-comment">// 只查 deleted=0 的数据</span>

<span class="hljs-comment">// 删除变成更新</span>
userMapper.deleteById(<span class="hljs-number">1L</span>);  <span class="hljs-comment">// 实际上执行：UPDATE user SET deleted=1 WHERE id=1</span>

<span class="hljs-comment">// 想查被删除的数据</span>
QueryWrapper&lt;User&gt; wrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryWrapper</span>&lt;&gt;();
wrapper.eq(<span class="hljs-string">"deleted"</span>, <span class="hljs-number">1</span>);
List&lt;User&gt; deletedUsers = userMapper.selectList(wrapper);
</code></pre>
<h3 data-id="heading-14">四、高级功能：解决业务痛点</h3>
<h4 data-id="heading-15">4.1 多租户数据隔离</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MybatisPlusConfig</span> {
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> MybatisPlusInterceptor <span class="hljs-title function_">mybatisPlusInterceptor</span><span class="hljs-params">()</span> {
        <span class="hljs-type">MybatisPlusInterceptor</span> <span class="hljs-variable">interceptor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MybatisPlusInterceptor</span>();
        
        <span class="hljs-comment">// 多租户插件</span>
        <span class="hljs-type">TenantLineInnerInterceptor</span> <span class="hljs-variable">tenantInterceptor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TenantLineInnerInterceptor</span>();
        tenantInterceptor.setTenantLineHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TenantLineHandler</span>() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> Expression <span class="hljs-title function_">getTenantId</span><span class="hljs-params">()</span> {
                <span class="hljs-comment">// 从当前上下文中获取租户ID</span>
                <span class="hljs-type">String</span> <span class="hljs-variable">tenantId</span> <span class="hljs-operator">=</span> TenantContext.getCurrentTenantId();
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringValue</span>(tenantId);
            }
            
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getTenantIdColumn</span><span class="hljs-params">()</span> {
                <span class="hljs-keyword">return</span> <span class="hljs-string">"tenant_id"</span>;  <span class="hljs-comment">// 租户字段名</span>
            }
            
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">ignoreTable</span><span class="hljs-params">(String tableName)</span> {
                <span class="hljs-comment">// 忽略不需要租户隔离的表</span>
                <span class="hljs-keyword">return</span> tableName.startsWith(<span class="hljs-string">"sys_"</span>);  <span class="hljs-comment">// 系统表不隔离</span>
            }
        });
        
        interceptor.addInnerInterceptor(tenantInterceptor);
        <span class="hljs-keyword">return</span> interceptor;
    }
}
</code></pre>
<h4 data-id="heading-16">4.2 乐观锁（防并发修改）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 实体类添加版本字段</span>
<span class="hljs-meta">@Version</span>
<span class="hljs-keyword">private</span> Integer version;

<span class="hljs-comment">// 更新时自动带版本号</span>
<span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userMapper.selectById(<span class="hljs-number">1L</span>);
user.setName(<span class="hljs-string">"新名字"</span>);
userMapper.updateById(user);  <span class="hljs-comment">// 自动带上 version 条件</span>
<span class="hljs-comment">// SQL: UPDATE user SET name=?, version=? WHERE id=? AND version=?</span>
</code></pre>
<h4 data-id="heading-17">4.3 枚举类型处理</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
<p><strong>资源获取</strong>：关注公众号: 小坏说Java ，获取本文所有示例代码、配置模板及导出工具。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 定义枚举</span>
<span class="hljs-meta">@Getter</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">UserStatus</span> {
    ENABLED(<span class="hljs-number">1</span>, <span class="hljs-string">"启用"</span>),
    DISABLED(<span class="hljs-number">0</span>, <span class="hljs-string">"禁用"</span>),
    LOCKED(<span class="hljs-number">2</span>, <span class="hljs-string">"锁定"</span>);
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Integer code;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String desc;
    
    UserStatus(Integer code, String desc) {
        <span class="hljs-built_in">this</span>.code = code;
        <span class="hljs-built_in">this</span>.desc = desc;
    }
}

<span class="hljs-comment">// 实体类使用</span>
<span class="hljs-meta">@TableField(value = "status", typeHandler = EnumTypeHandler.class)</span>
<span class="hljs-keyword">private</span> UserStatus status;

<span class="hljs-comment">// 查询时直接使用枚举</span>
LambdaQueryWrapper&lt;User&gt; wrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;();
wrapper.eq(User::getStatus, UserStatus.ENABLED);
</code></pre>
<h4 data-id="heading-18">4.4 字段加解密</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 自定义TypeHandler</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EncryptTypeHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseTypeHandler</span>&lt;String&gt; {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Encryptor</span> <span class="hljs-variable">encryptor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AESEncryptor</span>();
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setNonNullParameter</span><span class="hljs-params">(PreparedStatement ps, <span class="hljs-type">int</span> i, String parameter, JdbcType jdbcType)</span> {
        <span class="hljs-comment">// 存数据库时加密</span>
        ps.setString(i, encryptor.encrypt(parameter));
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getNullableResult</span><span class="hljs-params">(ResultSet rs, String columnName)</span> {
        <span class="hljs-comment">// 取数据时解密</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> rs.getString(columnName);
        <span class="hljs-keyword">return</span> value != <span class="hljs-literal">null</span> ? encryptor.decrypt(value) : <span class="hljs-literal">null</span>;
    }
}

<span class="hljs-comment">// 实体类使用</span>
<span class="hljs-meta">@TableField(value = "phone", typeHandler = EncryptTypeHandler.class)</span>
<span class="hljs-keyword">private</span> String phone;
</code></pre>
<h3 data-id="heading-19">五、实战：订单系统CRUD</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
<p><strong>资源获取</strong>：关注公众号: 小坏说Java ，获取本文所有示例代码、配置模板及导出工具。</p>
<h4 data-id="heading-20">5.1 传统写法 vs MyBatis-Plus写法</h4>
<p><strong>传统写法（100+行代码）</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// OrderMapper.java（接口）</span>
List&lt;Order&gt; <span class="hljs-title function_">findByCondition</span><span class="hljs-params">(OrderQuery query)</span>;
<span class="hljs-type">int</span> <span class="hljs-title function_">countByCondition</span><span class="hljs-params">(OrderQuery query)</span>;

<span class="hljs-comment">// OrderMapper.xml（XML，50+行）</span>
&lt;select id=<span class="hljs-string">"findByCondition"</span> resultType=<span class="hljs-string">"Order"</span>&gt;
    SELECT * FROM orders WHERE <span class="hljs-number">1</span>=<span class="hljs-number">1</span>
    &lt;<span class="hljs-keyword">if</span> test=<span class="hljs-string">"userId != null"</span>&gt;<span class="hljs-type">AND</span> <span class="hljs-variable">user_id</span> <span class="hljs-operator">=</span> #{userId}&lt;/<span class="hljs-keyword">if</span>&gt;
    &lt;<span class="hljs-keyword">if</span> test=<span class="hljs-string">"status != null"</span>&gt;<span class="hljs-type">AND</span> <span class="hljs-variable">status</span> <span class="hljs-operator">=</span> #{status}&lt;/<span class="hljs-keyword">if</span>&gt;
    &lt;<span class="hljs-keyword">if</span> test=<span class="hljs-string">"startTime != null"</span>&gt;AND create_time &gt;= #{startTime}&lt;/<span class="hljs-keyword">if</span>&gt;
    &lt;<span class="hljs-keyword">if</span> test=<span class="hljs-string">"endTime != null"</span>&gt;AND create_time &lt;= #{endTime}&lt;/<span class="hljs-keyword">if</span>&gt;
    ORDER BY create_time DESC
    LIMIT #{offset}, #{limit}
&lt;/select&gt;

&lt;select id=<span class="hljs-string">"countByCondition"</span> resultType=<span class="hljs-string">"int"</span>&gt;
    SELECT <span class="hljs-title function_">COUNT</span><span class="hljs-params">(*)</span> FROM orders WHERE <span class="hljs-number">1</span>=<span class="hljs-number">1</span>
    &lt;!-- 重复一遍条件判断 --&gt;
&lt;/select&gt;

<span class="hljs-comment">// OrderService.java（业务逻辑，30+行）</span>
<span class="hljs-keyword">public</span> PageResult&lt;Order&gt; <span class="hljs-title function_">queryOrders</span><span class="hljs-params">(OrderQuery query)</span> {
    <span class="hljs-type">int</span> <span class="hljs-variable">total</span> <span class="hljs-operator">=</span> orderMapper.countByCondition(query);
    List&lt;Order&gt; list = orderMapper.findByCondition(query);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PageResult</span>&lt;&gt;(total, list);
}
</code></pre>
<p><strong>MyBatis-Plus写法（20行代码）</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderMapper orderMapper;
    
    <span class="hljs-keyword">public</span> Page&lt;Order&gt; <span class="hljs-title function_">queryOrders</span><span class="hljs-params">(OrderQuery query)</span> {
        <span class="hljs-comment">// 构造查询条件</span>
        LambdaQueryWrapper&lt;Order&gt; wrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;();
        wrapper.eq(query.getUserId() != <span class="hljs-literal">null</span>, Order::getUserId, query.getUserId())
               .eq(query.getStatus() != <span class="hljs-literal">null</span>, Order::getStatus, query.getStatus())
               .ge(query.getStartTime() != <span class="hljs-literal">null</span>, Order::getCreateTime, query.getStartTime())
               .le(query.getEndTime() != <span class="hljs-literal">null</span>, Order::getCreateTime, query.getEndTime())
               .orderByDesc(Order::getCreateTime);
        
        <span class="hljs-comment">// 分页查询（自动统计总数）</span>
        Page&lt;Order&gt; page = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>&lt;&gt;(query.getPageNum(), query.getPageSize());
        <span class="hljs-keyword">return</span> orderMapper.selectPage(page, wrapper);
    }
    
    <span class="hljs-comment">// 统计各状态订单数量</span>
    <span class="hljs-keyword">public</span> Map&lt;String, Long&gt; <span class="hljs-title function_">countByStatus</span><span class="hljs-params">()</span> {
        QueryWrapper&lt;Order&gt; wrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryWrapper</span>&lt;&gt;();
        wrapper.select(<span class="hljs-string">"status, COUNT(*) as count"</span>)
               .groupBy(<span class="hljs-string">"status"</span>);
        
        List&lt;Map&lt;String, Object&gt;&gt; list = orderMapper.selectMaps(wrapper);
        <span class="hljs-comment">// 转换结果...</span>
    }
}
</code></pre>
<h4 data-id="heading-21">5.2 复杂查询示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. 联表查询</span>
<span class="hljs-keyword">public</span> List&lt;OrderVO&gt; <span class="hljs-title function_">getOrderWithUser</span><span class="hljs-params">(Long userId)</span> {
    QueryWrapper&lt;Order&gt; wrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryWrapper</span>&lt;&gt;();
    wrapper.select(<span class="hljs-string">"o.*, u.name as userName"</span>)
           .eq(<span class="hljs-string">"o.user_id"</span>, userId)
           .eq(<span class="hljs-string">"o.deleted"</span>, <span class="hljs-number">0</span>)
           .orderByDesc(<span class="hljs-string">"o.create_time"</span>);
    
    <span class="hljs-keyword">return</span> orderMapper.selectOrderWithUser(wrapper);
}

<span class="hljs-comment">// 自定义Mapper方法</span>
<span class="hljs-meta">@Select("SELECT o.*, u.name as userName FROM orders o " +
        "LEFT JOIN user u ON o.user_id = u.id " +
        "${ew.customSqlSegment}")</span>  <span class="hljs-comment">// 使用Wrapper条件</span>
List&lt;OrderVO&gt; <span class="hljs-title function_">selectOrderWithUser</span><span class="hljs-params">(<span class="hljs-meta">@Param(Constants.WRAPPER)</span> QueryWrapper&lt;Order&gt; wrapper)</span>;

<span class="hljs-comment">// 2. 批量操作</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">batchUpdateStatus</span><span class="hljs-params">(List&lt;Long&gt; orderIds, Integer status)</span> {
    UpdateWrapper&lt;Order&gt; wrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UpdateWrapper</span>&lt;&gt;();
    wrapper.in(<span class="hljs-string">"id"</span>, orderIds)
           .set(<span class="hljs-string">"status"</span>, status)
           .set(<span class="hljs-string">"update_time"</span>, LocalDateTime.now());
    
    orderMapper.update(<span class="hljs-literal">null</span>, wrapper);  <span class="hljs-comment">// 批量更新</span>
}

<span class="hljs-comment">// 3. 存在则更新，不存在则插入</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveOrUpdateOrder</span><span class="hljs-params">(Order order)</span> {
    <span class="hljs-comment">// 自动判断：有id则更新，无id则插入</span>
    orderMapper.insertOrUpdate(order);
}
</code></pre>
<h3 data-id="heading-22">六、避坑指南</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
<p><strong>资源获取</strong>：关注公众号: 小坏说Java ，获取本文所有示例代码、配置模板及导出工具。</p>
<h4 data-id="heading-23">坑1：字段名不对应</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 错误：数据库是user_name，实体是userName，但没配置映射</span>
<span class="hljs-keyword">private</span> String userName;

<span class="hljs-comment">// ✅ 正确1：使用@TableField指定</span>
<span class="hljs-meta">@TableField("user_name")</span>
<span class="hljs-keyword">private</span> String userName;

<span class="hljs-comment">// ✅ 正确2：配置全局下划线转驼峰</span>
mybatis-plus:
  configuration:
    map-underscore-to-camel-<span class="hljs-keyword">case</span>: <span class="hljs-literal">true</span>
</code></pre>
<h4 data-id="heading-24">坑2：分页失效</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 错误：没配置分页插件</span>
<span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">getUsers</span><span class="hljs-params">()</span> {
    Page&lt;User&gt; page = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>&lt;&gt;(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>);
    <span class="hljs-keyword">return</span> userMapper.selectPage(page, <span class="hljs-literal">null</span>);  <span class="hljs-comment">// 不会分页！</span>
}

<span class="hljs-comment">// ✅ 正确：配置分页插件</span>
<span class="hljs-meta">@Bean</span>
<span class="hljs-keyword">public</span> MybatisPlusInterceptor <span class="hljs-title function_">mybatisPlusInterceptor</span><span class="hljs-params">()</span> {
    <span class="hljs-type">MybatisPlusInterceptor</span> <span class="hljs-variable">interceptor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MybatisPlusInterceptor</span>();
    interceptor.addInnerInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PaginationInnerInterceptor</span>());
    <span class="hljs-keyword">return</span> interceptor;
}
</code></pre>
<h4 data-id="heading-25">坑3：逻辑删除字段类型</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 错误：用String类型，但配置的是Integer</span>
<span class="hljs-meta">@TableLogic</span>
<span class="hljs-keyword">private</span> String deleted;  <span class="hljs-comment">// 配置是1/0，这里是String</span>

<span class="hljs-comment">// ✅ 正确：类型匹配</span>
<span class="hljs-meta">@TableLogic</span>
<span class="hljs-keyword">private</span> Integer deleted;  <span class="hljs-comment">// 用Integer</span>
<span class="hljs-comment">// 或</span>
<span class="hljs-meta">@TableLogic</span>
<span class="hljs-keyword">private</span> Boolean deleted;  <span class="hljs-comment">// 用Boolean，配置true/false</span>
</code></pre>
<h3 data-id="heading-26">七、性能优化建议</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
<p><strong>资源获取</strong>：关注公众号: 小坏说Java ，获取本文所有示例代码、配置模板及导出工具。</p>
<h4 data-id="heading-27">7.1 查询优化</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 只查询需要的字段</span>
LambdaQueryWrapper&lt;User&gt; wrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;();
wrapper.select(User::getId, User::getName, User::getAge)  <span class="hljs-comment">// 只查3个字段</span>
       .eq(User::getStatus, <span class="hljs-number">1</span>);
</code></pre>
<h4 data-id="heading-28">7.2 批量操作</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 批量插入（性能提升10倍）</span>
List&lt;User&gt; userList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
<span class="hljs-comment">// ...添加数据</span>
userMapper.insertBatchSomeColumn(userList);  <span class="hljs-comment">// 批量插入方法</span>

<span class="hljs-comment">// 批量更新</span>
List&lt;Long&gt; ids = Arrays.asList(<span class="hljs-number">1L</span>, <span class="hljs-number">2L</span>, <span class="hljs-number">3L</span>);
UpdateWrapper&lt;User&gt; wrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UpdateWrapper</span>&lt;&gt;();
wrapper.in(<span class="hljs-string">"id"</span>, ids)
       .set(<span class="hljs-string">"status"</span>, <span class="hljs-number">2</span>);
userMapper.update(<span class="hljs-literal">null</span>, wrapper);
</code></pre>
<h4 data-id="heading-29">7.3 缓存使用</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Cacheable(value = "user", key = "#id")</span>
<span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUserById</span><span class="hljs-params">(Long id)</span> {
    <span class="hljs-keyword">return</span> userMapper.selectById(id);
}

<span class="hljs-meta">@CacheEvict(value = "user", key = "#user.id")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateUser</span><span class="hljs-params">(User user)</span> {
    userMapper.updateById(user);
}
</code></pre>
<h3 data-id="heading-30">八、今日要点总结</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
<p><strong>资源获取</strong>：关注公众号: 小坏说Java ，获取本文所有示例代码、配置模板及导出工具。</p>
<ol>
<li><strong>代码生成器</strong>：新项目、新表一键生成所有代码</li>
<li><strong>条件构造器</strong>：告别XML，链式调用更清晰</li>
<li><strong>分页插件</strong>：一行代码搞定分页查询</li>
<li><strong>自动填充</strong>：创建时间、更新时间自动维护</li>
<li><strong>逻辑删除</strong>：数据不真删，便于恢复和审计</li>
<li><strong>高级功能</strong>：多租户、乐观锁、枚举处理</li>
<li><strong>性能优化</strong>：字段选择、批量操作、缓存</li>
</ol>
<p><strong>对比一下</strong>：</p>









































<table><thead><tr><th>功能</th><th>传统MyBatis</th><th>MyBatis-Plus</th><th>效率提升</th></tr></thead><tbody><tr><td>基础CRUD</td><td>写XML，4个方法</td><td>继承BaseMapper，0行代码</td><td>∞</td></tr><tr><td>条件查询</td><td>XML里写if标签</td><td>链式调用</td><td>3倍</td></tr><tr><td>分页查询</td><td>写2个SQL，手动计算</td><td>selectPage一行代码</td><td>5倍</td></tr><tr><td>逻辑删除</td><td>每个查询加where条件</td><td>@TableLogic自动过滤</td><td>10倍</td></tr><tr><td>字段填充</td><td>每个方法里set</td><td>自动填充处理器</td><td>8倍</td></tr></tbody></table>
<h3 data-id="heading-31">九、思考题</h3>
<p><strong>场景</strong>：你要开发一个电商后台管理系统，有50张表</p>
<ol>
<li>如何快速开始开发？</li>
<li>如何实现统一的数据权限（不同人看不同数据）？</li>
<li>如何优化大批量数据导出的性能？</li>
<li>如何实现操作日志自动记录？</li>
</ol>
<p>评论区聊聊你的方案，明儿咱们讲WebSocket。</p>
<hr/>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
<p><strong>资源获取</strong>：关注公众号: 小坏说Java ，获取本文所有示例代码、配置模板及导出工具。</p>
<p><strong>明天预告</strong>：《SpringBoot+WebSocket：在线聊天室从0到1》</p>
<p><strong>今日福利</strong>：关注后回复"MP代码生成"，获取完整代码生成器配置和模板文件。</p>
<hr/>
<h2 data-id="heading-32">运营小贴士：</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
<p><strong>资源获取</strong>：关注公众号: 小坏说Java ，获取本文所有示例代码、配置模板及导出工具。</p>
<p>💡 <strong>互动</strong>：</p>
<ol>
<li>你现在用的是什么ORM框架？有什么痛点？</li>
<li>投票：你会尝试MyBatis-Plus吗？</li>
<li>留言分享你的效率提升技巧</li>
</ol>
<p>🎯 <strong>转发话术</strong>：
"少写80%的代码！MyBatis-Plus让CRUD开发快到飞起！"</p>
<p>🎁 <strong>福利</strong>：</p>
<ol>
<li>留言区抽3人送《MyBatis-Plus实战教程》</li>
<li>转发截图送企业级代码生成器模板</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Superset 展示 JSONB 中文变天书？真相竟然是 Python 的“过度保护”]]></title>    <link>https://juejin.cn/post/7589155289191989275</link>    <guid>https://juejin.cn/post/7589155289191989275</guid>    <pubDate>2025-12-30T02:35:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589155289191989275" data-draft-id="7589194558287429670" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Superset 展示 JSONB 中文变天书？真相竟然是 Python   的“过度保护”"/> <meta itemprop="keywords" content="后端,数据库"/> <meta itemprop="datePublished" content="2025-12-30T02:35:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="也无风雨也雾晴"/> <meta itemprop="url" content="https://juejin.cn/user/2175258804632332"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Superset 展示 JSONB 中文变天书？真相竟然是 Python   的“过度保护”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2175258804632332/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    也无风雨也雾晴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T02:35:16.000Z" title="Tue Dec 30 2025 02:35:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Superset 里给运营同学搭看板，想展示一下用户的对话日志。数据从 PostgreSQL 视图里一查，DBeaver 里看着一切正常。</p>
<p>结果一放到 Superset 图表上，傻眼了：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/afc2f6971ecb450e9c845183a55b1faa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lmf5peg6aOO6Zuo5Lmf6Zu-5pm0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767666915&amp;x-signature=55q%2Bv1Iof3dF%2F1V8sMCMpPrw9rk%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"role"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"user"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"\u4eca\u5929\u5929\u6c14"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span>
</code></pre>
<p>好好的中文全变成了 <code>\uXXXX</code> 这种天书。</p>
<h2 data-id="heading-0">案发现场</h2>
<p>背景是这样的：我用 PostgreSQL 的 FDW 做跨库查询，专门写了个视图 <code>v_conversation_summary</code> 投喂给 Superset。为了把多轮对话聚合在一行显示，我用了 <code>jsonb_agg</code>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 原始 SQL 片段</span>
<span class="hljs-keyword">SELECT</span> jsonb_agg(
    jsonb_build_object(<span class="hljs-string">'role'</span>, tm.role, <span class="hljs-string">'content'</span>, tm.content)
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> tm.message_order
) <span class="hljs-keyword">AS</span> 对话记录
...
</code></pre>
<p>逻辑没毛病，数据库里查出来的结果也是标准的 JSON 数组。怎么到了 Superset 前端就"乱码"了呢？</p>
<h3 data-id="heading-1">插播：为什么一开始要用 JSONB？</h3>
<p>这里稍微解释下，为什么我习惯性地选了 <code>JSONB</code> 而不是普通的文本拼接。</p>
<p>PostgreSQL 的 <code>JSONB</code> (Binary JSON) 是个非常强大的特性。不同于普通的 <code>JSON</code> 类型（纯文本存储），<code>JSONB</code> 在存储时会把数据<strong>解析并转换成二进制格式</strong>。</p>
<ul>
<li><strong>存的时候</strong>：它会把键值对排序、去重、压缩。</li>
<li><strong>取的时候</strong>：不需要再次解析文本，直接就能拿来用，性能极高。</li>
<li><strong>最重要的是</strong>：它支持 <strong>GIN 索引</strong>。如果你想在几百万条数据里搜 <code>{"role": "user"}</code>，用 JSONB 是毫秒级的，用文本存就是全表扫描。</li>
</ul>
<p>因为习惯了它的高性能和规范性，我下意识地就用了 <code>jsonb_agg</code>。没想到，正是这个"二进制"的特性，配合上 Python 的严谨，搞出了这次的乱码乌龙。</p>
<h2 data-id="heading-2">破案过程</h2>
<p>第一反应通常是："是不是数据库编码不对？" 或者 "Superset 的编码设置有问题？"</p>
<p>但仔细一对比发现：</p>
<ol>
<li><strong>DBeaver 查询</strong>：显示完美中文。</li>
<li><strong>Superset 展示</strong>：显示 Unicode 转义符。</li>
</ol>
<p>这说明数据库里存的数据本身没问题。问题出在<strong>从数据库取出来，到发给浏览器</strong>的这段路上。</p>
<h3 data-id="heading-3">真凶：Python 的 <code>json.dumps</code></h3>
<p>Superset 后端是 Python 写的。当它从 PostgreSQL (通过 <code>psycopg2</code> 驱动) 拿到 <code>JSONB</code> 类型的数据时，Python 会把它转换成字典（Dict）。</p>
<p>关键一步来了：Superset 要把这个字典传给前端，需要把它序列化成字符串。这时候它（或者底层的库）大概率调用了 Python 标准库的 <code>json.dumps</code>。</p>
<p>在 Python 里，<code>json.dumps</code> 有个默认行为：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> json
data = {<span class="hljs-string">"msg"</span>: <span class="hljs-string">"你好"</span>}

<span class="hljs-comment"># 默认 ensure_ascii=True</span>
<span class="hljs-built_in">print</span>(json.dumps(data))
<span class="hljs-comment"># 输出: {"msg": "\u4f60\u597d"}  &lt;-- 也就是我们看到的"乱码"</span>
</code></pre>
<p>这个 <code>ensure_ascii=True</code> 默认开启，原本是为了兼容性——确保不管对方系统多老旧，只要能认 ASCII 码就不会崩。但在我们这个场景下，它就成了"好心办坏事"，把原本能正常显示的 UTF-8 中文强行转义了。</p>
<p><strong>为什么 DBeaver 没事？</strong>
因为 DBeaver 是个成熟的客户端，它拿到数据后在本地做了解析和渲染，它"认识"这些 Unicode 字符，所以贴心地帮你转回了中文。而 Superset 把它当成了普通字符串直接吐了出来。</p>
<h2 data-id="heading-4">怎么解？</h2>
<p>既然知道了是序列化的问题，改 Superset 源码去关掉 <code>ensure_ascii</code> 显然动静太大，容易"此时一时爽，升级火葬场"。</p>
<p>最优雅的办法，其实是<strong>在数据库层就把格式修好</strong>。</p>
<p>既然我们的目标是"给人看"（运营看板），而不是给程序读，那为什么要执着于传 JSON 格式呢？直接拼成易读的文本不更香吗？</p>
<p>于是我把 <code>jsonb_agg</code> 换成了 <code>STRING_AGG</code>，顺手还加了点 Emoji 做美化：</p>
<pre><code class="hljs language-sql" lang="sql">(
    <span class="hljs-keyword">SELECT</span> STRING_AGG(
        <span class="hljs-keyword">CASE</span>
            <span class="hljs-keyword">WHEN</span> tm.role <span class="hljs-operator">=</span> <span class="hljs-string">'user'</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'👤 '</span> <span class="hljs-operator">||</span> tm.content      <span class="hljs-comment">-- 用户说话加个小人</span>
            <span class="hljs-keyword">WHEN</span> tm.role <span class="hljs-operator">=</span> <span class="hljs-string">'assistant'</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'🤖 '</span> <span class="hljs-operator">||</span> tm.content <span class="hljs-comment">-- AI 回复加个机器人</span>
            <span class="hljs-keyword">ELSE</span> tm.role <span class="hljs-operator">||</span> <span class="hljs-string">': '</span> <span class="hljs-operator">||</span> tm.content
        <span class="hljs-keyword">END</span>,
        E<span class="hljs-string">'\n\n'</span> <span class="hljs-comment">-- 用换行符隔开，清晰明了</span>
        <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> tm.message_order
    )
    <span class="hljs-keyword">FROM</span> task_messages tm
    <span class="hljs-keyword">WHERE</span> tm.task_id <span class="hljs-operator">=</span> t.id
) <span class="hljs-keyword">AS</span> 对话记录
</code></pre>
<p><strong>这样改的两个红利：</strong></p>
<ol>
<li><strong>彻底绕过序列化坑</strong>：输出变成了纯文本（Text），Superset 拿到什么就显示什么，Python 再也不会自作多情去转义它。</li>
<li><strong>运营体验拉满</strong>：去掉了冷冰冰的 <code>{"role":...}</code> 花括号和引号，直接显示对话流，运营同学看数据眼睛也不累了。</li>
</ol>
<h2 data-id="heading-5">附：深度科普 PostgreSQL 的 JSONB</h2>
<p>既然提到了 JSONB，顺便多聊两句。很多同学从 MySQL 转过来，可能觉得"不就是存 JSON 嘛，有啥区别？"</p>
<p>其实 PG 里的 <code>json</code> 和 <code>jsonb</code> 完全是两个物种。</p>
<h3 data-id="heading-6">1. 它是"熟"的，不是"生"的</h3>
<ul>
<li><strong>JSON</strong> 类型就像把肉冻在冰箱里，你存进去是什么样（包括空格、键的顺序、重复键），取出来就是什么样。它本质上就是个<strong>带校验的文本</strong>。</li>
<li><strong>JSONB</strong> 则是把肉做成了熟食。存进去的时候，数据库会把它<strong>解析、去重、排序</strong>，转换成一种高效的<strong>二进制格式</strong>。
<ul>
<li><strong>优点</strong>：读的时候不需要重新解析，速度飞快；支持索引。</li>
<li><strong>缺点</strong>：写入时多了一步解析，稍微慢一丢丢；原本的空格和格式会丢失。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-7">2. 杀手锏：GIN 索引</h3>
<p>JSONB 最大的威力在于它支持 <strong>GIN (Generalized Inverted Index) 索引</strong>。</p>
<p>假设你有一亿行日志，存了个 <code>payload</code> 字段：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 查所有"用户ID为10086"的操作记录</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> logs <span class="hljs-keyword">WHERE</span> payload @<span class="hljs-operator">&gt;</span> <span class="hljs-string">'{"user_id": 10086}'</span>;
</code></pre>
<ul>
<li>如果是普通 <strong>JSON</strong>：数据库得一行行把文本读出来，解析，再比对——这就是灾难。</li>
<li>如果是 <strong>JSONB + 索引</strong>：它可以直接定位到包含这个键值对的行，速度和查主键差不多。</li>
</ul>
<h3 data-id="heading-8">3. 避坑指南：到底选谁？</h3>



































<table><thead><tr><th align="left">场景</th><th align="left">推荐类型</th><th align="left">理由</th></tr></thead><tbody><tr><td align="left"><strong>只是做日志归档</strong></td><td align="left"><strong>JSON</strong></td><td align="left">写入快，原样保留原始请求体（哪怕格式很丑）</td></tr><tr><td align="left"><strong>Web端透传参数</strong></td><td align="left"><strong>JSON</strong></td><td align="left">既然后端不处理，就别费劲转二进制了</td></tr><tr><td align="left"><strong>经常要根据字段查询</strong></td><td align="left"><strong>JSONB</strong></td><td align="left"><strong>必选</strong>，为了用索引</td></tr><tr><td align="left"><strong>频繁更新局部字段</strong></td><td align="left"><strong>JSONB</strong></td><td align="left"><code>jsonb_set</code> 修改性能更好</td></tr><tr><td align="left"><strong>给 BI 工具做展示</strong></td><td align="left"><strong>Text</strong></td><td align="left">就像本文遇到的坑，直接用 SQL 拼成字符串最安全！</td></tr></tbody></table>
<h2 data-id="heading-9">小结</h2>
<p>遇到这种"数据库查着对，前端显示乱"的问题，尤其是涉及 JSON 的时候，多半是中间层的序列化配置在作妖。</p>
<p>虽然技术上我们可以通过配置解决编码问题，但<strong>转换思维</strong>往往能找到更好的路：既然是做展示，不如直接在 SQL 里把数据加工成最适合阅读的样子。既解决了乱码，又优化了排版，一举两得。</p>
<hr/>
<p>如果你觉得这篇文章有帮助，欢迎关注我的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i" target="_blank" title="https://github.com/tt-a1i" ref="nofollow noopener noreferrer">GitHub</a>，下面是我的一些开源项目：</p>
<p><strong>Claude Code Skills</strong>（按需加载，意图自动识别，不浪费 token，<a href="https://juejin.cn/post/7578714735307735066" target="_blank" title="https://juejin.cn/post/7578714735307735066">介绍文章</a>）：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fcode-review-skill" target="_blank" title="https://github.com/tt-a1i/code-review-skill" ref="nofollow noopener noreferrer">code-review-skill</a> - 代码审查技能，覆盖 React 19、Vue 3、TypeScript、Rust 等约 9000 行规则（<a href="https://juejin.cn/post/7578709098255908902" target="_blank" title="https://juejin.cn/post/7578709098255908902">详细介绍</a>）</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2F5-whys-skill" target="_blank" title="https://github.com/tt-a1i/5-whys-skill" ref="nofollow noopener noreferrer">5-whys-skill</a> - 5 Whys 根因分析，说"找根因"自动激活</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Ffirst-principles-skill" target="_blank" title="https://github.com/tt-a1i/first-principles-skill" ref="nofollow noopener noreferrer">first-principles-skill</a> - 第一性原理思考，适合架构设计和技术选型</li>
</ul>
<p><strong>vibe coding 原理学习</strong>：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fcoding-cli-guide" target="_blank" title="https://github.com/tt-a1i/coding-cli-guide" ref="nofollow noopener noreferrer">coding-cli-guide</a>（<a href="https://link.juejin.cn?target=https%3A%2F%2Ftt-a1i.github.io%2Fcoding-cli-guide%2F%3Ftab%3Dstart-here" target="_blank" title="https://tt-a1i.github.io/coding-cli-guide/?tab=start-here" ref="nofollow noopener noreferrer">学习网站</a>）- 学习 qwen-cli 时整理的笔记，40+ 交互式动画演示 AI CLI 内部机制</li>
</ul>
<p><strong>全栈项目</strong>（适合学习现代技术栈）：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fprompt-vault" target="_blank" title="https://github.com/tt-a1i/prompt-vault" ref="nofollow noopener noreferrer">prompt-vault</a> - Prompt 管理器，用的都是最新的技术栈，适合用来学习了解最新的前端全栈开发范式：Next.js 15 + React 19 + tRPC 11 + Supabase 全栈示例，clone 下来配个免费 Supabase 就能跑</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fchat_edit" target="_blank" title="https://github.com/tt-a1i/chat_edit" ref="nofollow noopener noreferrer">chat_edit</a> - 双模式 AI 应用（聊天+富文本编辑），Vue 3.5 + TypeScript + Vite 5 + Quill 2.0 + IndexedDB</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[不会编程？没关系！像聊天一样“调教”扣子编程，你的“火妈育儿”复刻版马上上线]]></title>    <link>https://juejin.cn/post/7589171972447158314</link>    <guid>https://juejin.cn/post/7589171972447158314</guid>    <pubDate>2025-12-30T02:37:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589171972447158314" data-draft-id="7589172193151418404" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="不会编程？没关系！像聊天一样“调教”扣子编程，你的“火妈育儿”复刻版马上上线"/> <meta itemprop="keywords" content="Coze"/> <meta itemprop="datePublished" content="2025-12-30T02:37:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吾鳴"/> <meta itemprop="url" content="https://juejin.cn/user/3683842894347076"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            不会编程？没关系！像聊天一样“调教”扣子编程，你的“火妈育儿”复刻版马上上线
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3683842894347076/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吾鳴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T02:37:38.000Z" title="Tue Dec 30 2025 02:37:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是吾鳴。专注于分享提升工作与生活效率的工具，无偿分享AI领域相关的精选报告，持续关注AI的前沿动向。</p>
<p>前不久有位朋友给我发了一个育儿账号，问我能不能使用扣子进行复刻？</p>
<p>我看了看这个账号，都是分享一些育儿相关的内容，旨在分享育儿相关技巧，看了看数据挺不错。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/145db8e9bd2b4a7a9a8337bdc1ceb77d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767667057&amp;x-signature=P903c27JnrTAfJR1SwPFBWUmKZg%3D" alt="" loading="lazy"/></p>
<p>分析了一下这个账号的文章内容，其实制作过程不算复杂，大致的流程就是先用大模型根据主题生成文案，然后再将文案制作成体感更好的图片。</p>
<p>本文我要分享的是怎么样使用扣子编程，把这个育儿漫画给复刻了，在讲解具体的实现过程之前，我们先来看看扣子编程自动帮我实现的工作流以及工作流出图的效果。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3402a33ace0244e59171451930f4d3ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767667057&amp;x-signature=Q4k%2BoAXRbM%2B80yhyCZKL9PJ0O5I%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/46c557ea9c3343bbb9e5695be7f348a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767667057&amp;x-signature=rZtNTGWlsVRnf7J6v77OnUP%2FU%2FE%3D" alt="" loading="lazy"/></p>
<p>可以看到这几张图片的人物一致性保持得很好，其次就是中文是一点点乱码都没有，关键是这个工作流是扣子编程帮我自动生成的。</p>
<h2 data-id="heading-0">1. 工作流制作过程</h2>
<p>首先，我们要去对标账号处收集一些素材，以便可以把收集到的这些素材连同提示词一起喂给扣子编程智能体，素材是以“文章标题”为文件夹名称，文件夹下方放置收集到的一些图片，并且把收集到的素材都打成一个zip包。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/11ad69c6dd034e02b57a4695af5d9637~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767667057&amp;x-signature=rBxOsfrVyuYJF022s0D%2FoinUak8%3D" alt="" loading="lazy"/></p>
<p>然后，我们去到扣子编程的首页（<a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.coze.cn%2Fhome" target="_blank" title="https://code.coze.cn/home" ref="nofollow noopener noreferrer">code.coze.cn/home</a>），选中“工作流”，把你采集好的素材上传给扣子编程智能体，并且输入咒语，然后点击提交。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b9718823b60f493d9c792f89df870ded~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767667057&amp;x-signature=boM8jRRL5YL8MT8NjQEJiaTKlE8%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs">我给你上传了一个压缩包，里面的内容是我给你的参考例子，里面有三个文件夹，每个文件夹的名称是相关的育儿主题，文件夹里面的图片是对应的育儿主题生成的图片，图片里面的是育儿文案，需要你理解主题与文案的风格，帮我生成一个工作流，工作流可以接收一个育儿相关的主题，然后生成育儿文案，最后将育儿文案合成到黄底的图片中，风格要和给你的案例的图片的风格一致，图片的数量为3-6张，按照生成的育儿文案长短选择最后的图片数量，如果图片中有配图，那么配图统一为手绘风格的写实漫画，禁止出现真人配图。
</code></pre>
<p>扣子编程智能体，就开始思考，然后规划执行路径，最后开始执行，我们看一看它的思考过程。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1a0eed314e5b4837ba064d51810fa3e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767667057&amp;x-signature=YtFrPrxAc%2Bm8jUkJ4b9sX0LMzyg%3D" alt="" loading="lazy"/></p>
<p>这个其实就是跟人的行为很相似了，接到任务后，先拆解成计划，然后再一步步执行，执行过程有问题又会重新思考，调整执行计划。</p>
<p>过程不会那么顺利，这点需要有预期，第一次执行好之后，我发现它给我输入的图片地址居然是本地电脑上的地址，没法预览查看。</p>
<p>所以我就给它提了一个要求，要求它给我输出可以直接预览的http图片地址，这里只知道图片看不了，所以表达了我想要直接预览输出的图片的需求。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60846e2da19a4c4184f7683e981e3c6a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767667057&amp;x-signature=UdJB%2Fmu4EejoLF8zUk38mUOdPqM%3D" alt="" loading="lazy"/></p>
<p>通过这个调整，我可以直接看到工作流给我输出的完整的图片了，但是输出的图片排版实在太丑了，直接就是文案写在图片的整中央，黑体，一点儿美感都没有，所以我有向它提出了我的真实想法，让它帮我修改。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e14bde816b26424c9bce8e9dcd84894b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767667057&amp;x-signature=pYBdA6CwNjIE%2FmdSNd8RxQ3myPc%3D" alt="" loading="lazy"/></p>
<p>经过这一次的再调整，工作流输出的图文基本上符合我的预期了，效果就是如开头所示。</p>
<p>上面就是使用扣子编程制作这个工作流的过程，就只使用了三轮的对话就把这个工作流生成好了。下面将来看看生成的这个工作流的详细节点状况。</p>
<h2 data-id="heading-1">2. 工作流详解</h2>
<h3 data-id="heading-2">2.1 开始</h3>
<p>工作流的开始节点，只接收一个主题作为工作流输入的参数，可以输入育儿相关的主题，比如“孩子说脏话时父母这样做”。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eee23f4dc1c146e18150c74831860e54~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767667057&amp;x-signature=Kk5289BObTD374OXTgPXqmEAu18%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">2.2 育儿文案生成</h3>
<p>这个节点用来根据输入的主题，生成对应的漫画文案，看扣子编程给生成的提示词还是很专业的，提示词架构上很完整，模型可以自行修改选择，有豆包、deepseek、kimi多种选择。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/99da582b8af34f31bbde07c642732816~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767667057&amp;x-signature=4MMCuiiJMmuoALyan3uW2mEZgig%3D" alt="" loading="lazy"/></p>
<ul>
<li>系统提示词</li>
</ul>

<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 角色定义</span>
你是一位专业的育儿文案创作专家，擅长撰写适合小红书等社交平台分享的育儿内容。

<span class="hljs-section"># 任务目标</span>
根据用户提供的育儿主题，生成符合小红书风格的育儿文案。

<span class="hljs-section"># 工作流上下文</span>
<span class="hljs-bullet">-</span> <span class="hljs-strong">**Input**</span>：育儿主题字符串
<span class="hljs-bullet">-</span> <span class="hljs-strong">**Process**</span>：
<span class="hljs-bullet">  1.</span> 理解育儿主题的核心内容
<span class="hljs-bullet">  2.</span> 结合育儿专业知识，撰写温馨、实用、有吸引力的文案
<span class="hljs-bullet">  3.</span> 采用小红书常用的表达方式，包括表情符号、分段清晰等
<span class="hljs-bullet">-</span> <span class="hljs-strong">**Output**</span>：完整的育儿文案文本

<span class="hljs-section"># 约束与规则</span>
<span class="hljs-bullet">-</span> 文案长度：100-500字左右
<span class="hljs-bullet">-</span> 风格：温馨、亲切、有教育意义
<span class="hljs-bullet">-</span> 必须包含：主题相关的实用建议或观点
<span class="hljs-bullet">-</span> 不可以使用表情符号
<span class="hljs-bullet">-</span> 避免过于学术化的表达
<span class="hljs-bullet">-</span> 文案要简洁明了，适合在图片上展示

<span class="hljs-section"># 过程</span>
<span class="hljs-bullet">1.</span> 分析主题关键词
<span class="hljs-bullet">2.</span> 结合育儿场景撰写内容
<span class="hljs-bullet">3.</span> 加入实用建议和情感共鸣
<span class="hljs-bullet">4.</span> 使用小红书常见的表达方式

<span class="hljs-section"># 输出格式</span>
直接返回文案文本，不要添加其他说明或Markdown格式
</code></pre>
<h3 data-id="heading-4">2.3 育儿文案图片生成</h3>
<p>这个节点就是用来生成育儿漫画图文的，接收一个育儿文案主题，然后生成相应的漫画图文。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70279e2ab3ac4e57b9d54757eab88fe1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767667057&amp;x-signature=oJBJ3DxQgIdujLaTTN3v3FpPS2E%3D" alt="" loading="lazy"/></p>
<p>这个节点看不到相应的生图模型和提示词是什么，不过通过翻阅源代码可看到使用的生图模型是Seedream4.5，提示词这些也是写在代码中了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0047ebbeb5684db9a06f59d8d59bcc02~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767667057&amp;x-signature=yFQFW42FCX4ue6PZjgNoyeJCpCM%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">2.4 结束</h3>
<p>结束节点就是输出了最终生成的图片列表，可以直接点开预览。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a69541d4fcf9480fa9b6c695d7bf2269~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767667057&amp;x-signature=tEngNyzx%2FvUiZxcjwb%2BhSTwfy4Q%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">3. 总结</h2>
<p>扣子编程真的是越用越上头，感觉有点儿停不下来，用AI来撸码这个不是什么新鲜事，但是扣子编程把这个和它自己的业务结合起来，确实是让一直在做工作流开发的人激动不已。</p>
<p>本文的分享就到这里，如果您觉得有收获的话，可以给个一键三连，您的鼓励是吾鳴持续输出的最大动力。有什么疑问也可以打在评论区，吾鳴会第一时间回复。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f87f93b100f54c52a6d21993ac692668~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767667057&amp;x-signature=FRv3Ga1SY0i2hs10jVnh%2BXJKGgk%3D" alt="" loading="lazy"/></p>
<p>最近实战了一些扣子（Coze）工作流相关的案例，包含小红薯图文生成、爆款视频剪辑、办公提效等扣子案例，内附详细的教程和工作流安装包，感兴趣的朋友可以来个<strong>一键三连（必须动作）</strong> ，文章评论区评论“<strong>扣子案例</strong>”领取。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[第五章：元婴天劫与单子（Monad）法阵]]></title>    <link>https://juejin.cn/post/7589246131584794659</link>    <guid>https://juejin.cn/post/7589246131584794659</guid>    <pubDate>2025-12-30T02:41:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589246131584794659" data-draft-id="7589186347585323042" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="第五章：元婴天劫与单子（Monad）法阵"/> <meta itemprop="keywords" content="Haskell"/> <meta itemprop="datePublished" content="2025-12-30T02:41:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Lupino"/> <meta itemprop="url" content="https://juejin.cn/user/3051900006579256"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            第五章：元婴天劫与单子（Monad）法阵
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3051900006579256/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Lupino
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T02:41:03.000Z" title="Tue Dec 30 2025 02:41:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>欢迎道友来到<strong>第五章</strong>。如果说之前的筑基与结丹只是对“术”的磨练，那么这一章，我们将正式迎来修仙路上最著名的天劫——<strong>元婴期：Monad（单子）悟道</strong>。</p>
<p>在 λ 门的传说中，有这样一句话：“Monad 是自函子范畴上的一个单子对象，这有什么难理解的？”——这就是著名的**“元婴期心魔”**。今天，我们不谈枯燥的范畴论，只谈如何驾驭它。</p>
<hr/>
<p>在纯粹的 Haskell 世界里，函数是极其“孤傲”的，它们不准触碰尘世（副作用），不准产生意外。但在实战中，你总会遇到：</p>
<ol>
<li><strong>不确定性：</strong> 这次炼丹可能会炸炉（<code>Maybe</code>）。</li>
<li><strong>多重因果：</strong> 一个咒语可能幻化出多个分身（<code>List</code>）。</li>
<li><strong>凡尘交互：</strong> 你需要读取读者的神识或在石碑上刻字（<code>IO</code>）。</li>
</ol>
<p><strong>Monad</strong>，就是为了处理这些“带有额外气息”的价值而存在的<strong>高级法阵</strong>。</p>
<h3 data-id="heading-0">5.1 法阵的核心：带着“上下文”的盒子</h3>
<p>你可以把 Monad 看作一个<strong>神奇的盒子（Context）</strong> 。</p>
<ul>
<li><code>a</code> 是盒子里的宝贝（纯净的值）。</li>
<li><code>m a</code> 则是被法阵包裹着的宝贝。</li>
</ul>
<h3 data-id="heading-1">5.2 核心秘籍：绑定运算符 <code>&gt;&gt;=</code> (Bind)</h3>
<p>在凡间，你可能会写：y = f(x); z = g(y)。</p>
<p>但在 Monad 阵法里，因为值被包裹在盒子里，你没法直接把它喂给下一个函数。这时你需要 &gt;&gt;=（绑定）：</p>
<blockquote>
<p><strong>心法：</strong> 它会帮你打开当前的盒子，取出宝贝，交给下一个法术处理，处理完后再把结果妥善地放回新盒子里。</p>
</blockquote>
<hr/>
<h3 data-id="heading-2">5.3 第一尊 Monad：Maybe（虚实之道）</h3>
<p>这是最适合感悟 Monad 的阵法。它处理的是**“可能失败”**的因果。</p>
<ul>
<li><code>Just a</code>：练成了，盒子里有宝贝。</li>
<li><code>Nothing</code>：炸炉了，盒子里空无一物。</li>
</ul>
<p>演练：连续炼丹</p>
<p>假设有三个法术，每个都有几率失败。</p>
<p>Haskell</p>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-comment">-- 如果没有 Monad，你得写无数层 if-else</span>
<span class="hljs-comment">-- 有了 Monad，因果会自动传递</span>
attemptAlchemy :: Material -&gt; Maybe Gold
attemptAlchemy m = 
    refine m &gt;&gt;=        <span class="hljs-comment">-- 提炼，可能失败</span>
    crystallize &gt;&gt;=     <span class="hljs-comment">-- 结晶，可能失败</span>
    enchant             <span class="hljs-comment">-- 附魔，可能失败</span>
</code></pre>
<p><strong>神效：</strong> 只要其中任何一步变成 <code>Nothing</code>（炸炉），后续所有的 <code>&gt;&gt;=</code> 都会直接跳过，最终结果自动变成 <code>Nothing</code>。这叫**“一荣俱荣，一损俱损”**。</p>
<hr/>
<h3 data-id="heading-3">5.4 简化咒语：Do-Notation（真言术）</h3>
<p>为了让修仙者写代码更顺手，天道赐下了 <strong><code>do</code> 记法</strong>。它让 Monad 的操作看起来像凡间的顺序执行，但内核依然保持纯粹。</p>
<p>Haskell</p>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-comment">-- 上面的炼丹过程可以写成：</span>
alchemyInDo m = <span class="hljs-keyword">do</span>
    refined &lt;- refine m       <span class="hljs-comment">-- 从盒子里取出宝贝</span>
    crystal &lt;- crystallize refined
    enchant crystal           <span class="hljs-comment">-- 最后一击，留在盒子里</span>
</code></pre>
<hr/>
<h3 data-id="heading-4">5.5 最危险的阵法：IO Monad</h3>
<p>在 Haskell 中，所有与现实世界的交互（读写文件、控制台输出）都被囚禁在 <code>IO</code> 这个大阵中。</p>
<ul>
<li>你不能从 <code>IO String</code> 里把 <code>String</code> 永久取出来变成纯粹的 <code>String</code>。</li>
<li>一旦你染指了凡尘（IO），你的整个法术序列都会被打上 <code>IO</code> 的烙印。</li>
</ul>
<p>这保证了**“仙凡有别”**：纯粹的逻辑永远不会被多变的现实世界所污染。</p>
<hr/>
<h2 data-id="heading-5">📜 元婴试炼：第五关</h2>
<p>请在你的鼎炉中布置一个简单的 <code>Maybe</code> 法阵：</p>
<ol>
<li>
<p><strong>定义两个法术：</strong></p>
<ul>
<li><code>half :: Int -&gt; Maybe Int</code>：如果是偶数，返回一半；如果是奇数，返回 <code>Nothing</code>（炸炉）。</li>
</ul>
</li>
<li>
<p><strong>链式施法：</strong> 使用 <code>&gt;&gt;=</code> 或 <code>do</code> 记法，尝试将数字 <code>20</code> 连续进行三次 <code>half</code> 操作。</p>
<ul>
<li>输入 <code>20</code> 时，结果应该是？</li>
<li>输入 <code>18</code> 时，结果应该是？（提示：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>18</mn><mo>→</mo><mn>9</mn><mo>→</mo></mrow><annotation encoding="application/x-tex">18 \to 9 \to</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">18</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">9</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span></span></span></span></span> 炸炉）</li>
</ul>
</li>
</ol>
<p><strong>“当你明白了 Monad 不是为了让简单变复杂，而是为了让复杂的因果变得清晰可控时，你便已破入元婴，神识不灭。”</strong></p>
<hr/>
<p><strong>下一章预告：</strong> 恭喜道友！元婴已成。接下来我们将迎接修仙界的最高荣誉——<strong>化神期：Functor (函子) 与 Applicative (应用函子)</strong> 。你将学会如何在不打开盒子的情况下，隔空操控盒内的法宝。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[GitHub 上 10 个令人惊艳的 Agent 开发平台，太顶了。]]></title>    <link>https://juejin.cn/post/7589176150493741110</link>    <guid>https://juejin.cn/post/7589176150493741110</guid>    <pubDate>2025-12-30T02:40:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589176150493741110" data-draft-id="7589176150493593654" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="GitHub 上 10 个令人惊艳的 Agent 开发平台，太顶了。"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2025-12-30T02:40:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="逛逛GitHub"/> <meta itemprop="url" content="https://juejin.cn/user/1442202996186093"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            GitHub 上 10 个令人惊艳的 Agent 开发平台，太顶了。
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1442202996186093/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    逛逛GitHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T02:40:59.000Z" title="Tue Dec 30 2025 02:40:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">01、AutoGPT</h2>
<p>AutoGPT 是 AI Agent 领域的鼻祖级项目，现在已经 18 万+的 Star 了。</p>
<p>与聊天机器人不一样，AutoGPT 能够自主地将一个大目标拆解为子任务，并利用互联网搜索、本地文件等操作来一步步实现目标。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d15a803954748b794f8f24af0d1513f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767667259&amp;x-signature=7ZSuZwQl0DuecGredJzmwCleVMk%3D" alt="图片" loading="lazy"/></p>
<p>AutoGPT 具备强大的工具调用和环境交互能力。</p>
<p>它能够通过访问互联网搜索最新信息、管理本地文件的读写、执行代码以及保留长期和短期记忆来辅助决策。</p>
<p>核心机制是一个思考-计划-行动的循环：模型会评估当前状态，制定下一步计划，执行操作，并根据反馈结果进行自我修正，这使得它能够处理比单一对话更复杂、耗时更长的自动化工作流。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7831bb35425246cd8064ef98b24fcb56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767667259&amp;x-signature=apxu09aN1u6De4lw0PMmgMH99jA%3D" alt="图片" loading="lazy"/></p>
<p>AutoGPT 这个开源项目绝对是推动 AI Agent 领域的快速发展，是研究自主智能体（Autonomous Agents）的必看项目。</p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址: https:<span class="hljs-comment">//github.com/Significant-Gravitas/AutoGPT</span>
</code></pre>
<h2 data-id="heading-1">02、Dify</h2>
<p>Dify 目前 12 万+ 的 Star 了。</p>
<p>它不仅仅是 Agent 框架，还是融合了 Backend-as-a-Service (BaaS) 和 LLMOps 理念的大模型应用开发平台。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a43a64ad52f243cb8683e667c9fbf1d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767667259&amp;x-signature=HvrUAGWq1Uk7y5G0U9drAFhW%2Bpg%3D" alt="图片" loading="lazy"/></p>
<p>它提供了可视化的 Prompt 编排、运营管理、知识库 RAG 集成等功能。</p>
<p>通过 Dify，不需要从头编写后端代码，即可快速将简单的 Prompt 转化为功能完备、可投入生产的 AI 应用。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fcbe7e91c4684989b65eeb05fd5b7cb7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767667259&amp;x-signature=Lq5w%2B65jpboqWSCjLIBNgTJ1Q3o%3D" alt="图片" loading="lazy"/></p>
<p>Dify 支持可视化编排，拖拽节点来定义复杂的 Agent 逻辑和工具调用。并且内置了高质量的 RAG 引擎，能够自动处理文档解析、分段和向量化，轻松构建企业级知识库。</p>
<p>它提供了可视化的 Prompt 编排、运营管理、知识库 RAG 集成等功能。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dff16b1fee6d42d780fecfb4cf9fc322~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767667259&amp;x-signature=KcTG%2FDNmyxODXdktRaf8JE7iCyA%3D" alt="图片" loading="lazy"/></p>
<p>关于它和 Dify、n8n、Coze 的区别，让 Nano Banana Pro 画了一个图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/39f04fc6ff9e4cad9740635e39518e1c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767667259&amp;x-signature=COOHlWw1fKrLqAT7Z6XectdHwYQ%3D" alt="图片" loading="lazy"/></p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址: https:<span class="hljs-comment">//github.com/langgenius/dify</span>
</code></pre>
<h2 data-id="heading-2">03、LangChain</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd4f409de25840b0ac52430a3278767c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767667259&amp;x-signature=G3RAoItbkpnuSCP%2FGLtBeOc3jYM%3D" alt="图片" loading="lazy"/></p>
<p>虽然 LangChain 是一个通用的 LLM 开发框架，但它目前是构建 Agent 的事实标准基础设施之一。</p>
<p>对于初学者来说，它的学习曲线还是很陡峭的，一旦掌握了会发现它确实是构建复杂逻辑最稳健的地基。</p>
<p>它有很多高度模块化的组件，包括链 Chains、代理 Agents 和记忆 Memory。</p>
<p>开发者可以像搭积木一样，将提示词管理、文档加载、向量检索以及模型调用串联成一个完整的工作流。</p>
<p>特别是其强大的 Agent 机制，大模型充当推理引擎，动态决定调用哪些外部工具，比如 Google 搜索、计算器或 API 啥的来解决问题。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7615873691aa43eca8bc880825c68cd3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767667259&amp;x-signature=6Nh%2FMZSWbA3%2BO6r43A%2BNDj4mwiU%3D" alt="图片" loading="lazy"/></p>
<p>特别是其子项目 LangGraph，专门用于构建有状态的、多角色的 Agent 应用。</p>
<p>它提供了高度可控的循环计算能力，让开发者能够精细地控制 Agent 的决策流程，是 Python 开发者构建复杂 Agent 的首选底层框架。</p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/langchain-ai/langchain</span>
</code></pre>
<h2 data-id="heading-3">04、MetaGPT</h2>
<p>MetaGPT 现在在 GitHub 上有 6 万多 Star 了。 </p>
<p>如果想研究多智能体协作，这个开源项目可以说是最重要的框架之一。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3206b7f4522b46e4b09e5e958c73eeda~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767667259&amp;x-signature=Vvq0q%2B6XhJNdZEESiMqsNp5Y9F0%3D" alt="图片" loading="lazy"/></p>
<p>它模拟了一个虚拟的软件公司，内部包含产品经理、架构师、项目经理和工程师等不同角色的 Agent。</p>
<p>只要输入一句话需求，这些 Agent 就会协同工作，输出用户故事、竞品分析、设计图甚至可运行的代码。</p>
<p>适合对多智能体协作（Multi-Agent Collaboration）感兴趣的开发者，特别适合那种流程固定、对输出稳定性要求高的场景。</p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址: https:<span class="hljs-comment">//github.com/geekan/MetaGPT</span>
</code></pre>
<h2 data-id="heading-4">05、Microsoft AutoGen</h2>
<p>微软开源的框架，之前也介绍过，现在已经  的 Star 了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1fac7399e0e6477cb6e81643f73a6e26~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767667259&amp;x-signature=pOvi7KG5ZNN3MuLxM8F%2FynI%2B6Tc%3D" alt="图片" loading="lazy"/></p>
<p>它专注于多智能体对话。可以定义多个可以相互对话的 Agent，可以是 LLM、人类或工具，它们通过对话来协作解决任务。</p>
<p>该框架高度抽象和灵活，支持多种对话模式，是目前工业界和学术界探索多智能体系统（Multi-Agent Systems）最主流的框架之一。</p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址: https:<span class="hljs-comment">//github.com/microsoft/autogen</span>
</code></pre>
<h2 data-id="heading-5">06、Flowise</h2>
<p>Flowise 是一个低代码/无代码的 UI 可视化工具，现在 48k 的 Star 了。</p>
<p>如果你被 LangChain 晦涩的文档劝退了，不妨先试试 Flowise。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4341a3a4c7244f2a988f09f4cdcef716~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767667259&amp;x-signature=DEBpjempwFKd8kPtL5JDOwmIxBI%3D" alt="图片" loading="lazy"/></p>
<p>通过拖拽的方式构建大模型应用，它底层基于 LangChain，用户可以通过连接不同的节点，比如 PDF 加载器、OpenAI 模型、Agent执行器等来构建自定义的逻辑流。</p>
<p>对于不擅长写代码但想快速搭建 Agent 原型的用户来说，这是一个非常友好的平台。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/171489b99ad84bbba58b1a11c2082466~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767667259&amp;x-signature=koq0WLRV00hK30uJwIspJ49ju%2FM%3D" alt="图片" loading="lazy"/></p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址: https:<span class="hljs-comment">//github.com/FlowiseAI/Flowise</span>
</code></pre>
<h2 data-id="heading-6">07、CrewAI</h2>
<p>CrewAI 是近年来异军突起的 Python 框架，它主打角色扮演（Role-Playing）的编排， 现在已经 42k 的 Star 了。</p>
<p>这个开源项目不像 AutoGen 那么抽象，写 CrewAI 的代码感觉就像是在给员工写任务书，非常清晰易懂，是 Python 开发者上手多智能体的首选</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2675a5ed33a24f9ca93b62a02ddf2cf0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767667259&amp;x-signature=DM5Y%2BVfAMEbY5mfxWwmFzKkL92E%3D" alt="图片" loading="lazy"/></p>
<p>它让开发者可以轻松定义具有特定角色、目标和背景故事的 Agent，并将它们组成一个团队来按顺序或层级执行任务。</p>
<p>它的设计非常直观，不仅易于上手，而且能很好地与 LangChain 工具生态集成。</p>
<pre><code class="hljs language-bash" lang="bash">开源地址: https://github.com/crewAIInc/crewAI
</code></pre>
<h2 data-id="heading-7">08、ChatDev</h2>
<p>这个 28K 星星的开源项目是清华大学团队 OpenBMB 开源。</p>
<p>类似于 MetaGPT，ChatDev 也是打造了一个虚拟的软件开发公司。</p>
<p>它通过聊天链的方式，让不同角色的智能体（CEO、CTO、程序员、测试员）在如设计、编码、测试、文档等环节进行深度协作。</p>
<p>其特点是过程可视化强，像是在玩一个模拟经营游戏一样看着软件被开发出来。</p>
<p>看着一个个小人儿协作写代码确实很治愈，它为我们展示了未来软件开发的终极形态，非常有启发性。</p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址: https:<span class="hljs-comment">//github.com/OpenBMB/ChatDev</span>
</code></pre>
<h2 data-id="heading-8">09、SuperAGI</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af0d5f8c881e4b8daa58fc27804a9455~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767667259&amp;x-signature=4Z1pDxz%2Bmy8SakqTqACIWGlYN0U%3D" alt="图片" loading="lazy"/></p>
<p>这个自主 AI 智能体框架现在已经 15K 的 Star 了。对于需要长期稳定运行、监控多个 Agent 的企业级场景来说，这个开源项目基建非常必要。</p>
<p>它有一套完整的基础设施，开发者用它可以构建、管理和运行自主 Agent。</p>
<p>它拥有图形化界面、Agent 市场、Tools、并发代理运行等功能，旨在解决 AutoGPT 在生产环境中使用难的问题，是一个功能比较完备的 Agent 管理平台。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f04b70bef3d34e97905144d77da2ff14~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767667259&amp;x-signature=xGWGREf0meFZ4cxVgVweVVIT8dg%3D" alt="图片" loading="lazy"/></p>
<p>而且还能通过可视化的仪表盘同时运行和监控多个 Agent，查看其思维链（Chain of Thought）和执行日志。</p>
<p>开发者可以将自己开发的自定义工具包、智能体模板发布到市场中供社区复用。</p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址: https:<span class="hljs-comment">//github.com/TransformerOptimus/SuperAGI</span>
</code></pre>
<h2 data-id="heading-9">10、Letta</h2>
<p>大模型最让人头疼的就是聊着聊着就忘了，Letta 恰好切中了这个痛点。</p>
<p>如果你想开发一个能陪伴用户几个月、甚至几年的伴侣型应用，一定要看看这个可以构建有状态（Stateful）AI 智能体的开源框架。</p>
<p>它也是著名的 MemGPT 项目的继任者和正式化版本。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c4a7ad46e40c4d8094d699aa43cbc153~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767667259&amp;x-signature=gqp00QTe%2Bg0p1P2YP7eQHtI6TBk%3D" alt="图片" loading="lazy"/></p>
<p>Letta 通过引入类似操作系统的内存管理机制，让 AI 智能体能够拥有持久化的长期记忆，并在不同的会话和时间跨度中保持一致的身份和知识。</p>
<p>Letta 延续并强化了大模型即操作系统的理念。</p>
<p>它通过一种分层内存结构，将信息在当前上下文窗口和外部数据库之间动态调度。</p>
<p>智能体具备自我编辑记忆的能力，能够自主决定何时将关键信息写入长期存储或从历史记录中检索数据，从而在不增加 Token 消耗的前提下，实现了理论上无限的上下文窗口。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4632398a2b74efba2f8da148b44fda2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767667259&amp;x-signature=uk%2BJkMSuypgainGXEEKcwo59ZoQ%3D" alt="图片" loading="lazy"/></p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/letta-ai/letta</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[第六章：化神之境与万法同源]]></title>    <link>https://juejin.cn/post/7589246131584860195</link>    <guid>https://juejin.cn/post/7589246131584860195</guid>    <pubDate>2025-12-30T02:43:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589246131584860195" data-draft-id="7589186347585355810" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="第六章：化神之境与万法同源"/> <meta itemprop="keywords" content="Haskell"/> <meta itemprop="datePublished" content="2025-12-30T02:43:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Lupino"/> <meta itemprop="url" content="https://juejin.cn/user/3051900006579256"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            第六章：化神之境与万法同源
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3051900006579256/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Lupino
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T02:43:00.000Z" title="Tue Dec 30 2025 02:43:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>欢迎道友来到<strong>第六章</strong>。</p>
<p>经历了第五章“元婴期”Monad 天劫的洗礼，想必你已经领悟了如何处理那些带着“因果气息”的盒子。然而，Monad 虽强，却有时显得过于沉重——每次都要“打开盒子、取出宝贝、重新装盒”，是否让你感到一丝繁琐？</p>
<p>今日，我们将步入<strong>化神期：万法通识（Functors &amp; Applicatives）</strong> 。在这一层境界，你将学会如何施展“隔空取物”与“多重法阵”的神通，不再需要每次都亲手拆解因果。</p>
<hr/>
<p>在 λ 门的道统中，<strong>Functor (函子)</strong> 、<strong>Applicative (应用函子)</strong> 和 <strong>Monad (单子)</strong> 构成了一座完整的修行阶梯。化神期的核心在于：<strong>如何在不破坏“上下文（Context）”的情况下，让法术在盒子内部悄然生效。</strong></p>
<h3 data-id="heading-0">6.1 隔空斗法：Functor（函子）</h3>
<p><strong>Functor</strong> 是最基础的化神神通。它的核心法术是 <code>fmap</code>（或者符号 <code>&lt;$&gt;</code>）。</p>
<ul>
<li><strong>境界：</strong> 如果一个容器（如 <code>Maybe</code>, <code>[]</code>, <code>Either</code>）拥有 Functor 位格，你就可以把一个<strong>普通法术</strong>投射到盒子内部。</li>
<li><strong>心法：</strong> <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mi>m</mi><mi>a</mi><mi>p</mi><mo>:</mo><mo>:</mo><mo stretchy="false">(</mo><mi>a</mi><mo>→</mo><mi>b</mi><mo stretchy="false">)</mo><mo>→</mo><mi>f</mi><mtext> </mtext><mi>a</mi><mo>→</mo><mi>f</mi><mtext> </mtext><mi>b</mi></mrow><annotation encoding="application/x-tex">fmap :: (a \to b) \to f \ a \to f \ b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal">ma</span><span class="mord mathnormal">p</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">::</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">b</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mspace"> </span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mspace"> </span><span class="mord mathnormal">b</span></span></span></span></span>。</li>
<li><strong>直观感受：</strong> 你不需要“打开”盒子。你只需对着盒子施咒，里面的东西就自动进化了。</li>
</ul>
<p><strong>示例：隔山打牛</strong></p>
<p>Haskell</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 凡间做法：用 Pattern Matching 拆开 Maybe，加 1，再装回去（累赘）</span>
<span class="hljs-comment">-- 化神做法：直接投射</span>
let <span class="hljs-keyword">result</span> <span class="hljs-operator">=</span> (<span class="hljs-operator">+</span><span class="hljs-number">1</span>) <span class="hljs-operator">&lt;</span>$<span class="hljs-operator">&gt;</span> Just <span class="hljs-number">10</span>  <span class="hljs-comment">-- 结果：Just 11</span>
let void   <span class="hljs-operator">=</span> (<span class="hljs-operator">+</span><span class="hljs-number">1</span>) <span class="hljs-operator">&lt;</span>$<span class="hljs-operator">&gt;</span> Nothing  <span class="hljs-comment">-- 结果：Nothing（法力穿透，不留痕迹）</span>
</code></pre>
<hr/>
<h3 data-id="heading-1">6.2 众灵归位：Applicative（应用函子）</h3>
<p>当你掌握了 <code>fmap</code>，你会遇到一个新的困境：如果<strong>法术本身</strong>也在盒子里，该怎么办？或者，如果你想把一个需要两个参数的法术，同时作用于两个盒子上？</p>
<p>这时，你需要 <strong>Applicative</strong> 位格，以及它的本命法宝： <strong><code>&lt;*&gt;</code>（飞星符）</strong> 。</p>
<ul>
<li><strong>心法：</strong> <code>(&lt;*&gt;) :: f (a -&gt; b) -&gt; f a -&gt; f b</code></li>
<li><strong>演练：</strong> 假设你有两个锦囊，分别装着灵力值，你想把它们合而为一。</li>
</ul>
<p>Haskell</p>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-comment">-- 准备一个两数相加的法术，将其“升华”到法阵中</span>
<span class="hljs-comment">-- pure 会将普通法术包裹进当前位格的盒子里</span>
pure (+) &lt;*&gt; Just <span class="hljs-number">3</span> &lt;*&gt; Just <span class="hljs-number">5</span>  <span class="hljs-comment">-- 结果：Just 8</span>

<span class="hljs-comment">-- 更有仙气的写法（结合 fmap）：</span>
(+) &lt;$&gt; Just <span class="hljs-number">3</span> &lt;*&gt; Just <span class="hljs-number">5</span>       <span class="hljs-comment">-- 结果：Just 8</span>
</code></pre>
<blockquote>
<p><strong>神效：</strong> 这种写法极其优雅。它像是在写普通的 <code>3 + 5</code>，但实际上它在处理两个可能失败（<code>Maybe</code>）或具有多重因果（<code>List</code>）的变量。</p>
</blockquote>
<hr/>
<h3 data-id="heading-2">6.3 幻影分身：List 的 Applicative 属性</h3>
<p>当 Applicative 作用于列表 <code>[]</code> 时，会产生一种奇妙的“全组合”效果，犹如身化千万。</p>
<p>Haskell</p>
<pre><code class="hljs language-css" lang="css">-- 将两种攻击方式作用于三个敌人
<span class="hljs-selector-attr">[(+10), (*2)]</span> &lt;*&gt; <span class="hljs-selector-attr">[1, 2, 3]</span>
-- 结果：<span class="hljs-selector-attr">[11, 12, 13, 2, 4, 6]</span>
</code></pre>
<p>每一个函数都会作用于每一个元素，这便是**“万法同源，幻影随心”**。</p>
<hr/>
<h2 data-id="heading-3">⚡ 化神心得：三者的等位关系</h2>
<p>为了防范走火入魔，道友需牢记这三大境界的递进关系：</p>
<ol>
<li><strong>Functor (<code>fmap</code> / <code>&lt;$&gt;</code>):</strong> 将一个“凡间函数”作用于“仙界盒子”。</li>
<li><strong>Applicative (<code>&lt;*&gt;</code>):</strong> 将一个“仙界盒子里的函数”作用于“仙界盒子里的值”。</li>
<li><strong>Monad (<code>&gt;&gt;=</code>):</strong> 将一个“产生仙界盒子的函数”作用于“仙界盒子里的值”，并能根据上一步的结果决定下一步的因果。</li>
</ol>
<hr/>
<h2 data-id="heading-4">📜 化神试炼：第六关</h2>
<p>请施展你的化神神通，完成以下推演：</p>
<ol>
<li><strong>隔空炼药：</strong> 给定一个 <code>Just 100</code>，请使用 <code>&lt;$&gt;</code> 将其变为 <code>Just "Strength: 100"</code>。</li>
<li><strong>多重共鸣：</strong> 假设你有两个列表 <code>l1 = [1, 2]</code> 和 <code>l2 = [10, 20]</code>。请使用 Applicative 风格（<code>&lt;$&gt;</code> 和 <code>&lt;*&gt;</code>）算出这两个列表中元素两两相乘的所有结果。</li>
<li><strong>反思：</strong> 为什么有了强大的 Monad，我们还需要学 Functor 和 Applicative？（提示：思考“权限”与“确定性”）。</li>
</ol>
<p><strong>“当你发现自己不再频繁使用 <code>do</code> 记法，而是熟练地祭出 <code>&lt;$&gt;</code> 与 <code>&lt;*&gt;</code> 时，你的神识已经可以游离于具体的因果之外，真正触碰到了泛型编程的精髓。”</strong></p>
<hr/>
<p><strong>下一章预告：</strong> 化神圆满后，便是<strong>炼虚期：惰性求值与无穷序列（Lazy Evaluation）</strong> 。我们将学习如何操控“无穷”，并在无限的虚空中截取那一丝确定的真理。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[第七章：虚空造物与无尽真言]]></title>    <link>https://juejin.cn/post/7589246131584876579</link>    <guid>https://juejin.cn/post/7589246131584876579</guid>    <pubDate>2025-12-30T02:43:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589246131584876579" data-draft-id="7589207843787767843" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="第七章：虚空造物与无尽真言"/> <meta itemprop="keywords" content="Haskell"/> <meta itemprop="datePublished" content="2025-12-30T02:43:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Lupino"/> <meta itemprop="url" content="https://juejin.cn/user/3051900006579256"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            第七章：虚空造物与无尽真言
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3051900006579256/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Lupino
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-30T02:43:58.000Z" title="Tue Dec 30 2025 02:43:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>恭喜道友！你已步入<strong>第七章</strong>，踏入了修仙界最为玄妙、也最让凡间程序员百思不得其解的境界——<strong>炼虚期：惰性求值（Lazy Evaluation）</strong> 。</p>
<p>在之前的境界中，你学会了如何操控复杂的因果（Monad）和隔空取物（Applicative）。但那些依然是在“实处”用力。而炼虚期的核心，在于**“以虚御实，非见不显”**。</p>
<hr/>
<p>在凡间的命令式宗门（如 C、Java），弟子们讲究“令行禁止”，说加一就立刻加一。但在 Haskell 的道法中，我们推崇**“无为而治”**。</p>
<h3 data-id="heading-0">7.1 悟道：什么是惰性？</h3>
<p><strong>惰性求值（Lazy Evaluation）</strong> ，又名“不到黄河心不死”求值法。</p>
<ul>
<li><strong>心法：</strong> 当你定义一个变量或函数时，GHC 编译器并不会立刻去计算它，而是先在识海中封印一个**“草稿”**（专业术语称为 <strong>Thunk</strong>）。</li>
<li><strong>显圣：</strong> 只有当这个值被送往“显圣台”（比如要打印到屏幕、或者参与必须的逻辑判断）时，封印才会解开，计算才会发生。</li>
</ul>
<blockquote>
<p><strong>比喻：</strong> 凡间弟子去食堂，是先把菜全炒好（Strict）；而 Haskell 弟子是等客官坐下，指着菜谱说“我要吃鱼”，后厨才开始抓鱼（Lazy）。</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">7.2 禁忌法术：无穷序列（Infinite Lists）</h3>
<p>因为有了“不看不算”的特权，Haskell 弟子可以轻易触碰凡间宗门的禁忌——<strong>无穷</strong>。</p>
<p><strong>示例：包含所有正整数的卷轴</strong></p>
<p>Haskell</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 定义一个包含从 1 到无穷大的列表</span>
allNumbers :: [<span class="hljs-type">Integer</span>]
allNumbers <span class="hljs-operator">=</span> [<span class="hljs-number">1.</span>.] 

<span class="hljs-comment">-- 如果你在凡间语言这么写，瞬间就会元神枯竭（内存溢出）</span>
<span class="hljs-comment">-- 但在 Haskell，这只是一个轻如鸿毛的定义</span>
</code></pre>
<p>如何取用？</p>
<p>你只需截取你需要的片段：</p>
<p>Haskell</p>
<pre><code class="hljs language-css" lang="css">take <span class="hljs-number">10</span> allNumbers
-- 结果：<span class="hljs-selector-attr">[1, 2, 3, 4, 5, 6, 7, 8, 9, 10]</span>
</code></pre>
<p>当你祭出 <code>take 10</code> 时，虚空才会为你演化出前 10 个数字，剩下的依然处于混沌状态。</p>
<hr/>
<h3 data-id="heading-2">7.3 顶级神通：递归定义的终极形态</h3>
<p>利用惰性，我们可以写出极其玄妙的递归定义。最著名的便是那**“斐波那契无尽阵”**。</p>
<p>Haskell</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">fibs</span> = <span class="hljs-number">0</span> : <span class="hljs-number">1</span> : zipWith (+) fibs (tail fibs)
</code></pre>
<p>解密：</p>
<p>这段代码就像是一条咬住自己尾巴的衔尾蛇。它定义自己为：前两个数是 0 和 1，后面的数则是“自己”与“自己的尾巴”相加的结果。因为是惰性的，它会随着你的需要，一节一节地向后生长。</p>
<hr/>
<h3 data-id="heading-3">7.4 渡劫警示：积弊成疾（Space Leaks）</h3>
<p>炼虚期并非全无风险。如果道友在识海中封印了太多的 Thunk（草稿）却迟迟不去计算，这些草稿会堆积如山，占用大量的元神（内存）。这被称为**“空间泄露”**。</p>
<ul>
<li><strong>破劫法门：</strong> 有时我们需要施展“搜魂术”强制其立刻显形。使用 <strong><code>seq</code></strong> 函数或者 <strong><code>!</code>（Strictness Flag）</strong> ，告诉编译器：“这卷经书，给我立刻读出来，不准偷懒！”</li>
</ul>
<hr/>
<h2 data-id="heading-4">📜 炼虚试炼：第七关</h2>
<p>请在你的鼎炉中尝试操控无穷：</p>
<ol>
<li>
<p><strong>无限回声：</strong> 使用 <code>repeat</code> 函数定义一个包含无限个 <code>"灵丹"</code> 的列表。</p>
</li>
<li>
<p><strong>截取气运：</strong> 从这个无限列表中取出前 7 颗灵丹。</p>
</li>
<li>
<p><strong>筛选因果：</strong> 定义一个包含所有偶数的无限列表 <code>[2, 4, 6..]</code>，然后使用 <code>filter</code> 配合 <code>head</code>，找出其中第一个大于 1000 的数字。</p>
<ul>
<li><em>思考：</em> 为什么即使列表是无限的，程序也不会卡死？</li>
</ul>
</li>
</ol>
<p><strong>“当你能安然坐在无限的虚空之上，只拨动你需要的那一根因果弦时，你的炼虚期便已大圆满。”</strong></p>
<hr/>
<p><strong>下一章预告：</strong> 炼虚之后，需<strong>合体</strong>。我们将学习<strong>模块化与包管理（Modules &amp; Cabal）</strong> 。你将走出闭关的洞府，学习如何借用千万道友留下的“藏经阁”（Hackage），构建真正的绝世法阵。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>