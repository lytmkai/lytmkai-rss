<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[Claude Code更新，新增异步子代理、即时压缩、自定义会话名和使用统计四大功能]]></title>    <link>https://juejin.cn/post/7582131164728737832</link>    <guid>https://juejin.cn/post/7582131164728737832</guid>    <pubDate>2025-12-11T04:13:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582131164728737832" data-draft-id="7582200865907441698" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Claude Code更新，新增异步子代理、即时压缩、自定义会话名和使用统计四大功能"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2025-12-11T04:13:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="子昕AI编程"/> <meta itemprop="url" content="https://juejin.cn/user/3273679891602858"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Claude Code更新，新增异步子代理、即时压缩、自定义会话名和使用统计四大功能
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3273679891602858/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    子昕AI编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T04:13:20.000Z" title="Thu Dec 11 2025 04:13:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是子昕。</p>
<p>Claude Code昨天发了2.0.64版本，加了几个挺实用的功能。</p>
<p>我看完更新说明，第一反应是：这几个更新都挺懂使用痛点的。</p>
<h2 data-id="heading-0">核心要点</h2>
<ul>
<li><strong>异步子代理</strong>：subagent和bash命令能后台跑了，不用等一个任务完才能开下一个</li>
<li><strong>即时压缩</strong>：对话压缩从等半天变成秒压</li>
<li><strong>自定义会话名称</strong>：用<code>/rename</code>给会话起名字</li>
<li><strong>使用统计</strong>：<code>/stats</code>看你每天用了多少，哪个模型用得最多</li>
</ul>
<p>前两个改变最明显，后两个是体验补完。</p>
<h2 data-id="heading-1">异步子代理：可以在后台持续跑了</h2>
<p>这个更新的关键词是<code>异步</code>和<code>后台</code>。</p>
<p>以前subagent干活时，你得等它做完才能继续。现在可以让subagent在后台运行，更重要的是，<strong>它能持续运行，不受主任务影响</strong>。</p>
<p><strong>怎么用</strong>：在提示词里明确告诉Claude使用后台agent。比如官方示例：“Using a background agent can you poll this issue for comments every 10 seconds”，agent就会在后台每10秒检查一次。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/99294f3324884de3bc5c181b72fea9a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2Q5piVQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766031200&amp;x-signature=icfe1V7Fji%2BgF0983hkviIR3fqQ%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e7163d59ab0465991de25b7ea2dd8a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2Q5piVQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766031200&amp;x-signature=cDMDf7Z9xZqusQAArGUvMMgnUuA%3D" alt="图片" loading="lazy"/></p>
<p><strong>适合的场景</strong>：</p>
<ul>
<li>让后台agent每隔一段时间监控错误日志，发现新错误立即通知</li>
<li>定期轮询某个API或文件的变化</li>
<li>监控测试运行状态，完成后汇报结果</li>
<li>长时间运行的任务（编译、部署）进度跟踪</li>
</ul>
<p>这个功能的价值在于：你可以继续做其他事，让agent在后台帮你盯着。不用人工反复检查。</p>
<p>关于subagent的更多用法和配置，可以看我之前写的文章。</p>
<h2 data-id="heading-2">即时压缩：终于不用干等了</h2>
<p>压缩功能之前就有，但体验很差，有时候要等2-5分钟。</p>
<p>这次更新后，几乎是秒完成。</p>
<p><strong>怎么用</strong>：还是老办法，输入<code>/compact</code>，但现在速度快得多。或者你什么都不做，系统也会在后台自动压缩摘要。</p>
<p><strong>适合的场景</strong>：</p>
<ul>
<li>长对话到100+轮时，定期压一下</li>
<li>感觉响应变慢了，可能是context太长了</li>
<li>一个项目持续好几天，中间想清理一下对话</li>
</ul>
<p>不过提醒一句：别过度依赖压缩。最好的做法是在上下文快用完之前，自己整理好文档和关键信息，重新开个会话。压缩只是辅助手段。</p>
<h2 data-id="heading-3">自定义会话名称：找对话方便了</h2>
<p>很简单的功能，但挺实用。</p>
<p>输入<code>/rename 你想要的名字</code>，当前会话就改名了。在/resume界面还加了快捷键：按R改名，按P预览。</p>
<p>以前会话名称可能是系统自动生成的，不太好辨识。现在可以自己改成有意义的名字，找起来方便多了。</p>
<h2 data-id="heading-4">使用统计：心里有个数</h2>
<p>输入<code>/stats</code>会显示一个可视化界面，告诉你：</p>
<ul>
<li>每天用了多少次Claude Code</li>
<li>总共开了多少会话</li>
<li>连续使用多少天</li>
<li>最常用的模型是哪个</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a0b9057ced14e89955d8ec3ca46c50c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2Q5piVQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766031200&amp;x-signature=g7HgolWyCvHx0bhiWIS7LwJQgNs%3D" alt="Overview" loading="lazy"/></p>
<p>Overview</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa2533ef63e94ea68a41afcb1e590efb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2Q5piVQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766031200&amp;x-signature=D%2BwdNIUsbbpeWEYrp7GC9BP8kPs%3D" alt="Models" loading="lazy"/></p>
<p>Models</p>
<p><strong>适合的场景</strong>：</p>
<ul>
<li>想知道自己用Claude Code的习惯</li>
<li>看看是不是过度依赖某个贵的模型</li>
<li>纯粹好奇自己的使用数据</li>
</ul>
<p>这个功能更多是“了解自己”，对日常开发影响不大，但看看数据挺有意思的。</p>
<h2 data-id="heading-5">简单说两句</h2>
<p>这几个更新都不算大功能，但都是在解决实际使用中的痛点：</p>
<p>异步让效率提升是实打实的，特别是需要多任务协作的场景。压缩速度提升也是，之前那个慢速度真的让人不想用。至于改名和统计，算是锦上添花，有比没有好。</p>
<p>如果你在用Claude Code，运行<code>claude update</code>就能更新到最新版。</p>
<p>更多内容，欢迎关注微信公众号「子昕AI编程」</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Node.js 编程实战：创建 HTTP/HTTPS 服务器全解析]]></title>    <link>https://juejin.cn/post/7582149417769304114</link>    <guid>https://juejin.cn/post/7582149417769304114</guid>    <pubDate>2025-12-11T07:23:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582149417769304114" data-draft-id="7582182817108082714" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Node.js 编程实战：创建 HTTP/HTTPS 服务器全解析"/> <meta itemprop="keywords" content="后端,Node.js,Trae"/> <meta itemprop="datePublished" content="2025-12-11T07:23:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员爱钓鱼"/> <meta itemprop="url" content="https://juejin.cn/user/2799775299157614"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Node.js 编程实战：创建 HTTP/HTTPS 服务器全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2799775299157614/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员爱钓鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T07:23:07.000Z" title="Thu Dec 11 2025 07:23:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>Node.js 的核心能力之一就是快速创建高性能的服务器。通过内置的 <code>http</code> 和 <code>https</code> 模块，你可以在几行代码内搭建功能完善的 Web 服务。本文将系统讲解如何在 Node.js 中创建 HTTP 与 HTTPS 服务器，包括基础用法、请求处理、HTTPS 证书配置，以及性能与安全优化实践。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">一、Node.js HTTP 服务器基础</h2>
<p>Node.js 内置的 <code>http</code> 模块让创建 HTTP 服务器非常简单。</p>
<h3 data-id="heading-1">1. 基本示例</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">"http"</span>);

<span class="hljs-keyword">const</span> server = http.<span class="hljs-title function_">createServer</span>(<span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-property">statusCode</span> = <span class="hljs-number">200</span>;
  res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">"Content-Type"</span>, <span class="hljs-string">"text/plain"</span>);
  res.<span class="hljs-title function_">end</span>(<span class="hljs-string">"Hello Node.js HTTP Server!"</span>);
});

server.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Server running at http://localhost:3000/"</span>);
});
</code></pre>
<p>说明：</p>
<ul>
<li><code>http.createServer</code> 返回一个服务器实例</li>
<li>回调函数 <code>(req, res)</code> 在每次请求到来时触发</li>
<li><code>req</code> 包含请求信息，<code>res</code> 用于发送响应</li>
<li><code>server.listen</code> 绑定端口并启动服务器</li>
</ul>
<hr/>
<h2 data-id="heading-2">二、处理请求与响应</h2>
<p>HTTP 请求包含方法、URL、头信息和请求体。响应也可以设置状态码、头信息及数据。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> server = http.<span class="hljs-title function_">createServer</span>(<span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (req.<span class="hljs-property">method</span> === <span class="hljs-string">"GET"</span> &amp;&amp; req.<span class="hljs-property">url</span> === <span class="hljs-string">"/"</span>) {
    res.<span class="hljs-title function_">writeHead</span>(<span class="hljs-number">200</span>, { <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"text/html"</span> });
    res.<span class="hljs-title function_">end</span>(<span class="hljs-string">"&lt;h1&gt;Welcome Home&lt;/h1&gt;"</span>);
  } <span class="hljs-keyword">else</span> {
    res.<span class="hljs-title function_">writeHead</span>(<span class="hljs-number">404</span>, { <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"text/plain"</span> });
    res.<span class="hljs-title function_">end</span>(<span class="hljs-string">"Page Not Found"</span>);
  }
});
</code></pre>
<p>技巧与建议：</p>
<ul>
<li>对请求进行路由判断，区分不同路径和方法</li>
<li>响应头要根据内容类型设置</li>
<li>大型项目可使用第三方框架如 Express 做路由和中间件管理</li>
</ul>
<hr/>
<h2 data-id="heading-3">三、Node.js HTTPS 服务器</h2>
<p>在实际生产环境中，HTTPS 已经是必须。Node.js 提供 <code>https</code> 模块支持加密传输。</p>
<h3 data-id="heading-4">1. 准备证书</h3>
<p>创建 HTTPS 服务器前，需要拥有：</p>
<ul>
<li><code>key.pem</code>：私钥文件</li>
<li><code>cert.pem</code>：证书文件（可以用自签名证书做测试）</li>
</ul>
<p>可以使用 OpenSSL 生成测试证书：</p>
<pre><code class="hljs language-bash" lang="bash">openssl req -nodes -new -x509 -keyout key.pem -out cert.pem
</code></pre>
<hr/>
<h3 data-id="heading-5">2. 创建 HTTPS 服务器</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> https = <span class="hljs-built_in">require</span>(<span class="hljs-string">"https"</span>);
<span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">"fs"</span>);

<span class="hljs-keyword">const</span> options = {
  <span class="hljs-attr">key</span>: fs.<span class="hljs-title function_">readFileSync</span>(<span class="hljs-string">"key.pem"</span>),
  <span class="hljs-attr">cert</span>: fs.<span class="hljs-title function_">readFileSync</span>(<span class="hljs-string">"cert.pem"</span>)
};

<span class="hljs-keyword">const</span> server = https.<span class="hljs-title function_">createServer</span>(options, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-title function_">writeHead</span>(<span class="hljs-number">200</span>, { <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"text/plain"</span> });
  res.<span class="hljs-title function_">end</span>(<span class="hljs-string">"Hello Node.js HTTPS Server!"</span>);
});

server.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3443</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"HTTPS Server running at https://localhost:3443/"</span>);
});
</code></pre>
<p>注意事项：</p>
<ul>
<li>HTTPS 必须提供证书和私钥</li>
<li>在生产环境中，请使用由可信 CA 签发的证书</li>
<li>端口一般为 443（HTTP 默认端口为 80）</li>
</ul>
<hr/>
<h2 data-id="heading-6">四、性能优化建议</h2>
<p>虽然 Node.js 的 <code>http</code> 和 <code>https</code> 模块足够轻量，但在高并发场景下，仍然可以优化：</p>
<ol>
<li><strong>开启 Keep-Alive</strong>
保持 TCP 连接，减少握手开销：</li>
</ol>
<pre><code class="hljs language-js" lang="js">res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">"Connection"</span>, <span class="hljs-string">"keep-alive"</span>);
</code></pre>
<ol start="2">
<li><strong>使用 gzip 压缩</strong>
减少传输数据量，提高响应速度：</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> zlib = <span class="hljs-built_in">require</span>(<span class="hljs-string">"zlib"</span>);
res.<span class="hljs-title function_">writeHead</span>(<span class="hljs-number">200</span>, { <span class="hljs-string">"Content-Encoding"</span>: <span class="hljs-string">"gzip"</span> });
res.<span class="hljs-title function_">end</span>(zlib.<span class="hljs-title function_">gzipSync</span>(<span class="hljs-string">"Hello World!"</span>));
</code></pre>
<ol start="3">
<li><strong>利用集群（cluster）提升 CPU 利用率</strong>
Node.js 单线程模型可以通过 cluster 模块启动多进程：</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> cluster = <span class="hljs-built_in">require</span>(<span class="hljs-string">"cluster"</span>);
<span class="hljs-keyword">const</span> os = <span class="hljs-built_in">require</span>(<span class="hljs-string">"os"</span>);

<span class="hljs-keyword">if</span> (cluster.<span class="hljs-property">isMaster</span>) {
  <span class="hljs-keyword">const</span> cpuCount = os.<span class="hljs-title function_">cpus</span>().<span class="hljs-property">length</span>;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; cpuCount; i++) {
    cluster.<span class="hljs-title function_">fork</span>();
  }
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// worker 进程启动 HTTP/HTTPS 服务器</span>
}
</code></pre>
<ol start="4">
<li><strong>使用缓存</strong>
对静态文件或接口数据使用内存缓存或 CDN，降低重复计算和 I/O 压力。</li>
</ol>
<hr/>
<h2 data-id="heading-7">五、常见应用场景</h2>
<ul>
<li>搭建静态文件服务器</li>
<li>提供 RESTful API 服务</li>
<li>接入 WebSocket 做实时通信</li>
<li>内网工具或微服务</li>
<li>HTTPS 接入支付、认证等安全场景</li>
</ul>
<p>Node.js 的 HTTP/HTTPS 服务器能力非常适合高并发和轻量服务场景。</p>
<hr/>
<h2 data-id="heading-8">六、总结</h2>
<p>通过本文，你应该掌握了：</p>
<ol>
<li>HTTP 服务器的创建与请求处理</li>
<li>HTTPS 服务器的证书配置和创建</li>
<li>异步请求处理与响应机制</li>
<li>高性能与安全优化策略</li>
</ol>
<p>Node.js 内置的 HTTP/HTTPS 模块简单高效，非常适合构建高性能微服务和 API。
理解这些基础，为使用 Express、Koa 等框架打下了坚实的底层基础。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C# Params Collections 详解：比 params T[] 更强大的新语法]]></title>    <link>https://juejin.cn/post/7582090790181879846</link>    <guid>https://juejin.cn/post/7582090790181879846</guid>    <pubDate>2025-12-11T00:10:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582090790181879846" data-draft-id="7582041304655413294" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C# Params Collections 详解：比 params T[] 更强大的新语法"/> <meta itemprop="keywords" content="C#,.NET"/> <meta itemprop="datePublished" content="2025-12-11T00:10:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="唐青枫"/> <meta itemprop="url" content="https://juejin.cn/user/3737995266234280"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C# Params Collections 详解：比 params T[] 更强大的新语法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3737995266234280/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    唐青枫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T00:10:11.000Z" title="Thu Dec 11 2025 00:10:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">简介</h3>
<p><code>Params Collections</code> 是 <code>C# 12</code> 中引入的新特性，它扩展了传统的 <code>params</code> 关键字功能，使其不仅支持数组，还能支持各种集合类型。这个特性使得方法能够接受可变数量的参数，并且这些参数可以自动转换为指定的集合类型。</p>
<p>关键特点：</p>
<ul>
<li>
<p>可变参数：调用者可以传递任意数量的参数（包括零个）。</p>
</li>
<li>
<p>类型安全：<code>params</code> 参数是强类型的，编译器确保参数类型匹配。</p>
</li>
<li>
<p>单一 <code>params</code> 参数：一个方法只能有一个 <code>params</code> 参数，且必须是最后一个参数。</p>
</li>
<li>
<p><code>C# 12</code> 扩展：支持非数组集合类型（如 <code>List</code>, <code>Span</code>），适合高性能或特定场景。</p>
</li>
</ul>
<h3 data-id="heading-1">核心特性</h3>
<h4 data-id="heading-2">支持任意集合类型</h4>
<ul>
<li>可指定 <code>List、Span、IReadOnlyCollection</code> 等作为参数类型</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">LogEntries</span>(<span class="hljs-params"><span class="hljs-keyword">params</span> List messages</span>)</span> { ... }
</code></pre>
<h4 data-id="heading-3">自动集合构造</h4>
<ul>
<li>编译器自动将离散参数转换为目标集合类型实例</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp">AnalyzeNumbers(<span class="hljs-number">10</span>, <span class="hljs-number">20</span>, <span class="hljs-number">30</span>); 
<span class="hljs-comment">// 等效于：</span>
AnalyzeNumbers(<span class="hljs-keyword">new</span> List { <span class="hljs-number">10</span>, <span class="hljs-number">20</span>, <span class="hljs-number">30</span> });
</code></pre>
<h4 data-id="heading-4">与现有 params 兼容</h4>
<ul>
<li>
<p>传统 <code>params T[]</code> 仍然有效</p>
</li>
<li>
<p>新语法不会破坏已有代码</p>
</li>
</ul>
<h3 data-id="heading-5">传统 params 关键字</h3>
<p>在 <code>C# 12</code> 之前，<code>params</code> 关键字只能用于数组：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 传统的 params 数组用法</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ProcessNumbers</span>(<span class="hljs-params"><span class="hljs-keyword">params</span> <span class="hljs-built_in">int</span>[] numbers</span>)</span>
{
    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> number <span class="hljs-keyword">in</span> numbers)
    {
        Console.WriteLine(number);
    }
}

<span class="hljs-comment">// 调用方式</span>
ProcessNumbers(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>);
</code></pre>
<h3 data-id="heading-6">Params Collections 的新特性</h3>
<p><code>C# 12</code> 扩展了 <code>params</code> 关键字，使其能够用于任何集合类型，只要该类型满足特定条件。</p>
<h4 data-id="heading-7">基本语法</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 使用 params 与集合类型</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ProcessNumbers</span>(<span class="hljs-params"><span class="hljs-keyword">params</span> List numbers</span>)</span>
{
    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> number <span class="hljs-keyword">in</span> numbers)
    {
        Console.WriteLine(number);
    }
}

<span class="hljs-comment">// 调用方式不变</span>
ProcessNumbers(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>);
</code></pre>
<h3 data-id="heading-8">支持的条件</h3>
<p>要使集合类型能够与 <code>params</code> 关键字一起使用，必须满足以下条件之一：</p>
<ul>
<li>
<p>集合类型必须有一个无参数的构造函数</p>
</li>
<li>
<p>集合类型必须有一个 <code>Add</code> 方法，用于添加元素</p>
</li>
<li>
<p>集合类型必须实现 <code>IEnumerable</code></p>
</li>
</ul>
<h4 data-id="heading-9">自定义集合与 params</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 自定义集合类</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">NumberCollection</span> : <span class="hljs-title">IEnumerable</span>
{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> List _numbers = <span class="hljs-keyword">new</span>();
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Add</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> number</span>)</span> =&gt; _numbers.Add(number);
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> IEnumerator <span class="hljs-title">GetEnumerator</span>()</span> =&gt; _numbers.GetEnumerator();
    
    IEnumerator IEnumerable.GetEnumerator() =&gt; GetEnumerator();
}

<span class="hljs-comment">// 使用自定义集合作为 params 参数</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ProcessNumbers</span>(<span class="hljs-params"><span class="hljs-keyword">params</span> NumberCollection numbers</span>)</span>
{
    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> number <span class="hljs-keyword">in</span> numbers)
    {
        Console.WriteLine(number);
    }
}

<span class="hljs-comment">// 调用</span>
ProcessNumbers(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>);
</code></pre>
<h3 data-id="heading-10">实际应用示例</h3>
<h4 data-id="heading-11">与 Span 和 ReadOnlySpan 结合使用</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 使用 Span 作为 params 参数</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ProcessData</span>(<span class="hljs-params"><span class="hljs-keyword">params</span> Span data</span>)</span>
{
    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; data.Length; i++)
    {
        data[i] *= <span class="hljs-number">2</span>;
    }
}

<span class="hljs-comment">// 调用</span>
<span class="hljs-built_in">int</span>[] array = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>];
ProcessData(array);
Console.WriteLine(<span class="hljs-built_in">string</span>.Join(&amp;<span class="hljs-meta">#34;, &amp;#34;, array)); // 输出: 2, 4, 6, 8, 10</span>
</code></pre>
<h4 data-id="heading-12">与 Immutable Collections 结合使用</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> System.Collections.Immutable;

<span class="hljs-comment">// 使用不可变集合作为 params 参数</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ProcessItems</span>(<span class="hljs-params"><span class="hljs-keyword">params</span> ImmutableArray items</span>)</span>
{
    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> item <span class="hljs-keyword">in</span> items)
    {
        Console.WriteLine(item);
    }
}

<span class="hljs-comment">// 调用</span>
ProcessItems(&amp;<span class="hljs-meta">#34;apple&amp;#34;, &amp;#34;banana&amp;#34;, &amp;#34;cherry&amp;#34;);</span>
</code></pre>
<h3 data-id="heading-13">高级用法</h3>
<h4 data-id="heading-14">泛型方法与 params 集合</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 泛型方法中使用 params 集合</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ProcessCollection</span>(<span class="hljs-params"><span class="hljs-keyword">params</span> List collection</span>)
    <span class="hljs-keyword">where</span> T : <span class="hljs-keyword">notnull</span></span>
{
    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> item <span class="hljs-keyword">in</span> collection)
    {
        Console.WriteLine(item);
    }
}

<span class="hljs-comment">// 调用</span>
ProcessCollection(&amp;<span class="hljs-meta">#34;a&amp;#34;, &amp;#34;b&amp;#34;, &amp;#34;c&amp;#34;); // 字符串列表</span>
ProcessCollection(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>);       <span class="hljs-comment">// 整数列表</span>
</code></pre>
<h4 data-id="heading-15">与模式匹配结合使用</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 使用模式匹配处理 params 集合</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">HandleValues</span>(<span class="hljs-params"><span class="hljs-keyword">params</span> <span class="hljs-built_in">int</span>[] values</span>)</span>
{
    <span class="hljs-keyword">switch</span> (values)
    {
        <span class="hljs-keyword">case</span> [<span class="hljs-keyword">var</span> first, .. <span class="hljs-keyword">var</span> middle, <span class="hljs-keyword">var</span> last]:
            Console.WriteLine($&amp;<span class="hljs-meta">#34;首: {first}, 尾: {last}, 中间有 {middle.Length} 个元素&amp;#34;);</span>
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> [<span class="hljs-keyword">var</span> single]:
            Console.WriteLine($&amp;<span class="hljs-meta">#34;单个值: {single}&amp;#34;);</span>
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> []:
            Console.WriteLine(&amp;<span class="hljs-meta">#34;空集合&amp;#34;);</span>
            <span class="hljs-keyword">break</span>;
    }
}

<span class="hljs-comment">// 调用</span>
HandleValues(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>); <span class="hljs-comment">// 输出: 首: 1, 尾: 5, 中间有 3 个元素</span>
HandleValues(<span class="hljs-number">42</span>);            <span class="hljs-comment">// 输出: 单个值: 42</span>
HandleValues();              <span class="hljs-comment">// 输出: 空集合</span>
</code></pre>
<h4 data-id="heading-16">与接口结合使用</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 使用接口作为 params 参数</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ProcessEnumerables</span>(<span class="hljs-params"><span class="hljs-keyword">params</span> IEnumerable[] collections</span>)</span>
{
    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> collection <span class="hljs-keyword">in</span> collections)
    {
        <span class="hljs-built_in">int</span> sum = collection.Sum();
        Console.WriteLine($&amp;<span class="hljs-meta">#34;集合总和: {sum}&amp;#34;);</span>
    }
}

<span class="hljs-comment">// 调用</span>
ProcessEnumerables(
    <span class="hljs-keyword">new</span> List { <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span> },
    <span class="hljs-keyword">new</span> <span class="hljs-built_in">int</span>[] { <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span> },
    <span class="hljs-keyword">new</span> HashSet { <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span> }
);
</code></pre>
<h4 data-id="heading-17">高性能求和（使用 <code>Span</code>）</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">decimal</span> <span class="hljs-title">Average</span>(<span class="hljs-params"><span class="hljs-keyword">params</span> Span numbers</span>)</span>
{
    <span class="hljs-keyword">if</span> (numbers.Length == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    <span class="hljs-built_in">decimal</span> sum = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> num <span class="hljs-keyword">in</span> numbers)
    {
        sum += num;
    }
    <span class="hljs-keyword">return</span> sum / numbers.Length;
}

Console.WriteLine(Average(<span class="hljs-number">1.5</span>m, <span class="hljs-number">2.5</span>m, <span class="hljs-number">3.5</span>m)); <span class="hljs-comment">// 输出: 2.5</span>
</code></pre>
<ul>
<li>
<p>使用 <code>Span</code> 避免数组分配，提高性能。</p>
</li>
<li>
<p>适合处理大量数值计算。</p>
</li>
</ul>
<h3 data-id="heading-18">适用场景</h3>
<ul>
<li>
<p>简化方法调用：允许调用者传递任意数量的参数，减少重载需求。</p>
</li>
<li>
<p>处理集合数据：适合处理列表、数组或序列，例如日志记录、字符串连接、数学计算。</p>
</li>
<li>
<p>高性能场景（<code>C# 12+</code>）：使用 <code>Span</code> 或 <code>ReadOnlySpan</code> 减少堆分配，优化性能。</p>
</li>
<li>
<p>与本机代码交互：<code>Span</code> 类型的 <code>params</code> 参数适合传递连续内存块。</p>
</li>
<li>
<p>灵活接口设计：为方法提供通用接口，支持不同数量的输入。</p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Compose 高级状态和附带效应]]></title>    <link>https://juejin.cn/post/7582231988146782259</link>    <guid>https://juejin.cn/post/7582231988146782259</guid>    <pubDate>2025-12-11T09:00:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582231988146782259" data-draft-id="7581648776302690313" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Compose 高级状态和附带效应"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-11T09:00:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Best_Jerry"/> <meta itemprop="url" content="https://juejin.cn/user/1099167360106999"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Compose 高级状态和附带效应
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1099167360106999/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Best_Jerry
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T09:00:47.000Z" title="Thu Dec 11 2025 09:00:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读24分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fcodelabs%2Fjetpack-compose-advanced-state-side-effects%3Fhl%3Dzh-cn%26continue%3Dhttps%253A%252F%252Fdeveloper.android.com%252Fcourses%252Fpathways%252Fjetpack-compose-for-android-developers-3%253Fhl%253Dzh-cn%2523codelab-https%253A%252F%252Fdeveloper.android.com%252Fcodelabs%252Fjetpack-compose-advanced-state-side-effects%230" target="_blank" title="https://developer.android.com/codelabs/jetpack-compose-advanced-state-side-effects?hl=zh-cn&amp;continue=https%3A%2F%2Fdeveloper.android.com%2Fcourses%2Fpathways%2Fjetpack-compose-for-android-developers-3%3Fhl%3Dzh-cn%23codelab-https%3A%2F%2Fdeveloper.android.com%2Fcodelabs%2Fjetpack-compose-advanced-state-side-effects#0" ref="nofollow noopener noreferrer">Jetpack Compose 中的高级状态和附带效应</a></p>
<p>了解与 Jetpack Compose 中的状态和附带效应 API 相关的高级概念。了解如何为复杂的有状态可组合项创建状态容器、通过 Compose 代码创建协程和调用挂起函数，以及针对不同的用例触发附带效应。</p>
<h2 data-id="heading-0">1. 简介</h2>
<p>在此 Codelab 中，您将学习与 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/jetpack/compose?hl=zh-cn" ref="nofollow noopener noreferrer">Jetpack Compose</a> 中的<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fstate%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/jetpack/compose/state?hl=zh-cn" ref="nofollow noopener noreferrer">状态</a>和<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fside-effects%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/jetpack/compose/side-effects?hl=zh-cn" ref="nofollow noopener noreferrer">附带效应</a> API 相关的高级概念。您将了解如何为逻辑并不简单的有状态可组合项创建状态容器，如何从 Compose 代码创建协程并调用挂起函数，以及如何触发附带效应以完成不同的用例。</p>
<h3 data-id="heading-1">学习内容</h3>
<ul>
<li>如何从 Compose 代码观察数据流以更新界面。</li>
<li>如何为有状态可组合项创建状态容器。</li>
<li>附带效应 API，如 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fpackage-summary%3Fhl%3Dzh-cn%23LaunchedEffect(kotlin.Any%2Ckotlin.coroutines.SuspendFunction1)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary?hl=zh-cn#LaunchedEffect(kotlin.Any,kotlin.coroutines.SuspendFunction1)" ref="nofollow noopener noreferrer"><code>LaunchedEffect</code></a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fpackage-summary%3Fhl%3Dzh-cn%23rememberUpdatedState(kotlin.Any)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary?hl=zh-cn#rememberUpdatedState(kotlin.Any)" ref="nofollow noopener noreferrer"><code>rememberUpdatedState</code></a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fpackage-summary%3Fhl%3Dzh-cn%23DisposableEffect(kotlin.Any%2Ckotlin.Function1)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary?hl=zh-cn#DisposableEffect(kotlin.Any,kotlin.Function1)" ref="nofollow noopener noreferrer"><code>DisposableEffect</code></a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fpackage-summary%3Fhl%3Dzh-cn%23produceState(kotlin.Any%2Ckotlin.coroutines.SuspendFunction1)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary?hl=zh-cn#produceState(kotlin.Any,kotlin.coroutines.SuspendFunction1)" ref="nofollow noopener noreferrer"><code>produceState</code></a> 和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fpackage-summary%3Fhl%3Dzh-cn%23derivedStateOf(kotlin.Function0)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary?hl=zh-cn#derivedStateOf(kotlin.Function0)" ref="nofollow noopener noreferrer"><code>derivedStateOf</code></a>。</li>
<li>如何使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fpackage-summary%3Fhl%3Dzh-cn%23rememberCoroutineScope(kotlin.Function0)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary?hl=zh-cn#rememberCoroutineScope(kotlin.Function0)" ref="nofollow noopener noreferrer"><code>rememberCoroutineScope</code></a> API 在可组合项中创建协程并调用挂起函数。</li>
</ul>
<h3 data-id="heading-2">构建内容</h3>
<p>在此 Codelab 中，您将从一个未完成的应用（即 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmaterial.io%2Fdesign%2Fmaterial-studies%2Fcrane.html" target="_blank" title="https://material.io/design/material-studies/crane.html" ref="nofollow noopener noreferrer">Crane 材料研究</a>应用）着手，并且将添加一些功能来改进该应用。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/218536e9496a435fb0681a2146737071~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmVzdF9KZXJyeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766048446&amp;x-signature=kqIGHfyp0F6%2F%2F%2FJJ5fFJJuqCOMM%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-3">2. 准备工作</h2>
<h3 data-id="heading-4">获取代码</h3>
<p>此 Codelab 的代码可以在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgooglecodelabs%2Fandroid-compose-codelabs" target="_blank" title="https://github.com/googlecodelabs/android-compose-codelabs" ref="nofollow noopener noreferrer">android-compose-codelabs GitHub 代码库</a>中找到。如需克隆该代码库，请运行以下命令：</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">$ </span><span class="bash">git <span class="hljs-built_in">clone</span> https://github.com/android/codelab-android-compose</span>
</code></pre>
<p>或者，您也能以 Zip 文件的形式下载该代码库：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fandroid%2Fcodelab-android-compose%2Farchive%2Fmain.zip" target="_blank" title="https://github.com/android/codelab-android-compose/archive/main.zip" ref="nofollow noopener noreferrer">file_download下载 ZIP 文件</a></p>
<h3 data-id="heading-5">查看示例应用</h3>
<p>您刚刚下载的代码包含提供的所有 Compose Codelab 的代码。为了完成此 Codelab，请在 Android Studio 中打开 <strong><code>AdvancedStateAndSideEffectsCodelab</code></strong> 项目。</p>
<blockquote>
<p>compose-codelabs 库包含开发者在线课程中所有 Codelab 的起始代码。</p>
<p>对于此 Codelab，请使用 <strong>AdvancedStateAndSideEffectsCodelab</strong> 项目。</p>
<ul>
<li><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6403907abaa41fab678e0688b3684a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmVzdF9KZXJyeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766048446&amp;x-signature=hEMriE4dN0WgBVdsYRGV959b%2FMs%3D" alt="android_studio_folder.png" loading="lazy"/> <strong>AdvancedStateAndSideEffectsCodelab</strong> - 该项目包含此 Codelab 的起始代码和完成后的代码。</li>
</ul>
<p>该项目在多个 git 分支中构建而成：</p>
<ul>
<li><strong>main</strong> - 该项目的起始代码；您将更改这些代码来完成此 Codelab。</li>
<li><strong>end</strong> - 包含此 Codelab 的解决方案。</li>
</ul>
</blockquote>
<p>我们建议您从 main 分支中的代码着手，按照自己的节奏逐步完成此 Codelab。</p>
<p>在本 Codelab 中，系统会为您显示需要添加到项目的代码段。在某些地方，您还需要移除在代码段的注释中明确提及的代码。</p>
<h3 data-id="heading-6">熟悉代码并运行示例应用</h3>
<p>先花点时间浏览一下项目结构，然后再运行应用。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0938746571fd46028bd2fbae0acdd71d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmVzdF9KZXJyeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766048446&amp;x-signature=wajQEIjQPPLXYQhdH224t6h55Ks%3D" alt="162c42b19dafa701.png" loading="lazy"/></p>
<p>从 main 分支运行应用时，您会看到某些功能（如抽屉式导航栏或加载航班目的地的功能）不起作用！这就是您在此 Codelab 的后续步骤中要改进的地方。</p>
<h3 data-id="heading-7">界面测试</h3>
<p>系统会对应用执行 <code>androidTest</code> 文件夹中提供的非常基本的界面测试。对于 <code>main</code> 和 <code>end</code> 分支，始终都应通过这些测试。</p>
<h3 data-id="heading-8">[可选] 在详情屏幕上显示地图</h3>
<p>完全没有必要按照相关说明在详情屏幕上显示城市地图。不过，如果您想要看到地图，那么需要获取个人 API 密钥，如<a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.google.com%2Fmaps%2Fdocumentation%2Fandroid-sdk%2Fget-api-key%3Fhl%3Dzh-cn" target="_blank" title="https://developers.google.com/maps/documentation/android-sdk/get-api-key?hl=zh-cn" ref="nofollow noopener noreferrer">“地图”文档</a>中所述。按如下方式在 <code>local.properties</code> 文件中添加该密钥：</p>
<pre><code class="hljs language-ini" lang="ini">// local.properties file
<span class="hljs-attr">google.maps.key</span>={insert_your_api_key_here}
</code></pre>
<blockquote>
<p>在 Google 信息中心内设置凭据时，务必将 <code>androidx.compose.samples.crane</code> 用作软件包名称，并将 <code>A0:BD:B3:B6:F0:C4:BE:90:C6:9D:5F:4C:1D:F0:90:80:7F:D7:FE:1F</code> 用作 SHA-1 证书指纹。</p>
</blockquote>
<h3 data-id="heading-9">此 Codelab 的解决方案</h3>
<p>如需使用 git 获取 <code>end</code> 分支，请使用以下命令：</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-variable">$ </span>git clone -b <span class="hljs-keyword">end</span> <span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/github.com/android</span><span class="hljs-regexp">/codelab-android-compose
</span></code></pre>
<p>或者，您也可以在此处下载解决方案代码：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fandroid%2Fcodelab-android-compose%2Farchive%2Fend.zip" target="_blank" title="https://github.com/android/codelab-android-compose/archive/end.zip" ref="nofollow noopener noreferrer">file_download下载最终代码</a></p>
<h2 data-id="heading-10">3. 界面状态生成流水线</h2>
<p>您可能已经注意到，从 <code>main</code> 分支运行应用时，航班目的地列表为空！</p>
<p>如要解决此问题，您必须完成以下两个步骤：</p>
<ul>
<li>在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Ftopic%2Flibraries%2Farchitecture%2Fviewmodel%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/topic/libraries/architecture/viewmodel?hl=zh-cn" ref="nofollow noopener noreferrer"><code>ViewModel</code></a> 中添加逻辑以生成<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Ftopic%2Farchitecture%2Fui-layer%2Fstateholders%3Fhl%3Dzh-cn%23elements-ui" target="_blank" title="https://developer.android.com/topic/architecture/ui-layer/stateholders?hl=zh-cn#elements-ui" ref="nofollow noopener noreferrer">界面状态</a>。在本示例中，即推荐目的地列表。</li>
<li>从界面取用该界面状态，这样就会在画面上显示界面。</li>
</ul>
<p>良好的应用架构会分层级，遵循基本的良好系统设计实践，例如关注点分离和可测试性。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Ftopic%2Farchitecture%2Fui-layer%2Fstate-production%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/topic/architecture/ui-layer/state-production?hl=zh-cn" ref="nofollow noopener noreferrer">界面状态生成</a>是指以下过程：应用访问数据层、应用业务规则（如果需要），以及公开要从界面取用的界面状态。</p>
<p>此应用中的数据层已实现。现在，您将生成状态（推荐目的地列表），以便界面可以取用该状态。</p>
<p>有几个 API 可用于生成界面状态。如要了解替代方案，请参阅<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Ftopic%2Farchitecture%2Fui-layer%2Fstate-production%3Fhl%3Dzh-cn%23output-types" target="_blank" title="https://developer.android.com/topic/architecture/ui-layer/state-production?hl=zh-cn#output-types" ref="nofollow noopener noreferrer">状态生成流水线中的输出类型</a>文档。一般而言，最好使用 Kotlin 的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fkotlinlang.org%2Fapi%2Fkotlinx.coroutines%2Fkotlinx-coroutines-core%2Fkotlinx.coroutines.flow%2F-state-flow%2F" target="_blank" title="https://kotlinlang.org/api/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/-state-flow/" ref="nofollow noopener noreferrer"><code>StateFlow</code></a> 生成界面状态。</p>
<p>如要生成界面状态，请按以下步骤操作：</p>
<ol>
<li>打开 <code>home/MainViewModel.kt</code>。</li>
<li>定义一个类型为 <a href="https://link.juejin.cn?target=https%3A%2F%2Fkotlinlang.org%2Fapi%2Fkotlinx.coroutines%2Fkotlinx-coroutines-core%2Fkotlinx.coroutines.flow%2F-mutable-state-flow%2F" target="_blank" title="https://kotlinlang.org/api/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/-mutable-state-flow/" ref="nofollow noopener noreferrer"><code>MutableStateFlow</code></a> 的私有 <code>_suggestedDestinations</code> 变量，用于表示推荐目的地列表，并将空列表设置为起始值。</li>
</ol>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _suggestedDestinations = MutableStateFlow&lt;List&lt;ExploreModel&gt;&gt;(emptyList())
</code></pre>
<ol start="3">
<li>定义第二个不可变变量 <code>suggestedDestinations</code>，类型为 <code>StateFlow</code>。这是可从界面取用的公开只读变量。建议您公开只读变量，并在内部使用可变变量。这样做可确保界面状态无法修改，除非通过 <code>ViewModel</code> 使其成为单一可信来源。扩展函数 <a href="https://link.juejin.cn?target=https%3A%2F%2Fkotlinlang.org%2Fapi%2Fkotlinx.coroutines%2Fkotlinx-coroutines-core%2Fkotlinx.coroutines.flow%2Fas-state-flow.html" target="_blank" title="https://kotlinlang.org/api/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/as-state-flow.html" ref="nofollow noopener noreferrer"><code>asStateFlow</code></a> 会将可变流转换为不可变流。</li>
</ol>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _suggestedDestinations = MutableStateFlow&lt;List&lt;ExploreModel&gt;&gt;(emptyList())

<span class="hljs-keyword">val</span> suggestedDestinations: StateFlow&lt;List&lt;ExploreModel&gt;&gt; = _suggestedDestinations.asStateFlow()
</code></pre>
<ol start="4">
<li>在 <code>ViewModel</code> 的 init 块中，添加来自 <code>destinationsRepository</code> 的调用，以便从数据层获取目的地。</li>
</ol>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _suggestedDestinations = MutableStateFlow&lt;List&lt;ExploreModel&gt;&gt;(emptyList())

<span class="hljs-keyword">val</span> suggestedDestinations: StateFlow&lt;List&lt;ExploreModel&gt;&gt; = _suggestedDestinations.asStateFlow()

<span class="hljs-keyword">init</span> {
    _suggestedDestinations.value = destinationsRepository.destinations
}
</code></pre>
<ol start="5">
<li>最后，取消注释在此类中找到的内部变量 <code>_suggestedDestinations</code> 使用情况，以便可通过来自界面的事件正确更新该变量。</li>
</ol>
<p>现在，<code>ViewModel</code> 能够生成界面状态。在下一步中，您将从界面取用此状态。</p>
<h2 data-id="heading-11">4. 从 ViewModel 安全地使用流</h2>
<p>航班目的地列表仍然为空。在上一步中，您在 <code>MainViewModel</code> 中生成了界面状态。现在，您将使用要在界面中显示并由 <code>MainViewModel</code> 公开的界面状态。</p>
<p>打开 <code>home/CraneHome.kt</code> 文件并查看 <code>CraneHomeContent</code> 可组合项。</p>
<p>被分配给一个记住的空列表的 <code>suggestedDestinations</code> 的定义上面有一条 TODO 注释。这就是屏幕上显示的内容：一个空列表！在此步骤中，您将解决该问题，并显示 <code>MainViewModel</code> 公开的推荐目的地。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2fa34cb764894f04ba0583dc19732ebe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmVzdF9KZXJyeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766048446&amp;x-signature=C9umu%2BSd9r5UJA%2FzEi%2FkfXYu8z8%3D" alt="image.png" loading="lazy"/></p>
<p>打开 <code>home/MainViewModel.kt</code> 并查看 <code>suggestedDestinations</code> <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fkotlin%2Fflow%2Fstateflow-and-sharedflow%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/kotlin/flow/stateflow-and-sharedflow?hl=zh-cn" ref="nofollow noopener noreferrer">StateFlow</a>，该 StateFlow 初始化为 <code>destinationsRepository.destinations</code>，并且会在调用 <code>updatePeople</code> 或 <code>toDestinationChanged</code> 函数时得到更新。</p>
<p>您希望每当有新项被发送到 <code>suggestedDestinations</code> 数据流时 <code>CraneHomeContent</code> 可组合项中的界面都会更新。您可以使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Flifecycle%2Fcompose%2Fpackage-summary%3Fhl%3Dzh-cn%23(kotlinx.coroutines.flow.Flow).collectAsStateWithLifecycle(kotlin.Any%2Candroidx.lifecycle.Lifecycle%2Candroidx.lifecycle.Lifecycle.State%2Ckotlin.coroutines.CoroutineContext)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/lifecycle/compose/package-summary?hl=zh-cn#(kotlinx.coroutines.flow.Flow).collectAsStateWithLifecycle(kotlin.Any,androidx.lifecycle.Lifecycle,androidx.lifecycle.Lifecycle.State,kotlin.coroutines.CoroutineContext)" ref="nofollow noopener noreferrer"><code>collectAsStateWithLifecycle()</code></a> 函数。<code>collectAsStateWithLifecycle()</code> 会以生命周期感知型方式从 <code>StateFlow</code> 收集值并通过 Compose 的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2FState%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/State?hl=zh-cn" ref="nofollow noopener noreferrer">State</a> API 表示最新值。这样会使读取该状态值的 Compose 代码在发出新项时重组。</p>
<p>如需开始使用 <code>collectAsStateWithLifecycle</code> API，请先在 <code>app/build.gradle</code> 中添加以下<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fandroidx%2Freleases%2Flifecycle%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/jetpack/androidx/releases/lifecycle?hl=zh-cn" ref="nofollow noopener noreferrer">依赖项</a>。变量 <code>lifecycle_version</code> 已在项目中使用适当版本进行定义。</p>
<pre><code class="hljs language-bash" lang="bash">dependencies {
    implementation <span class="hljs-string">"androidx.lifecycle:lifecycle-runtime-compose:<span class="hljs-variable">$lifecycle_version</span>"</span>
}
</code></pre>
<blockquote>
<p><strong>注意</strong>：如需详细了解 <code>collectAsStateWithLifecycle()</code> API，请参阅<a href="https://link.juejin.cn?target=https%3A%2F%2Fmedium.com%2Fandroiddevelopers%2Fconsuming-flows-safely-in-jetpack-compose-cde014d0d5a3" target="_blank" title="https://medium.com/androiddevelopers/consuming-flows-safely-in-jetpack-compose-cde014d0d5a3" ref="nofollow noopener noreferrer">在 Jetpack Compose 中安全地使用流</a>这篇博文。</p>
</blockquote>
<p>返回 <code>CraneHomeContent</code> 可组合项，并将分配 <code>suggestedDestinations</code> 的代码行替换为 <code>ViewModel</code> 的 <code>suggestedDestinations</code> 属性上的 <code>collectAsStateWithLifecycle</code> 调用：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> androidx.lifecycle.compose.collectAsStateWithLifecycle

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">CraneHomeContent</span><span class="hljs-params">(
    onExploreItemClicked: <span class="hljs-type">OnExploreItemClicked</span>,
    openDrawer: () -&gt; <span class="hljs-type">Unit</span>,
    modifier: <span class="hljs-type">Modifier</span> = Modifier,
    viewModel: <span class="hljs-type">MainViewModel</span> = viewModel()</span></span>,
) {
    <span class="hljs-keyword">val</span> suggestedDestinations <span class="hljs-keyword">by</span> viewModel.suggestedDestinations.collectAsStateWithLifecycle()
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>如果您运行应用，您会看到目的地列表已填充，并且每当您点按旅行人数时，目的地都会发生变化。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/215aaf4ff0dd4b2192a1bfd293b9768c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmVzdF9KZXJyeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766048446&amp;x-signature=7hq7zWN3WNYFxtSo0dQktRTKMfs%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>Compose 还为最热门的基于数据流的 Android 解决方案提供了 API：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Flivedata%2Fpackage-summary%3Fhl%3Dzh-cn%23observeAsState(androidx.lifecycle.LiveData)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/livedata/package-summary?hl=zh-cn#observeAsState(androidx.lifecycle.LiveData)" ref="nofollow noopener noreferrer"><code>LiveData.observeAsState()</code></a> 包含在 <code>androidx.compose.runtime:runtime-livedata:$composeVersion</code> 工件中。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Frxjava2%2Fpackage-summary%3Fhl%3Dzh-cn%23subscribeAsState(io.reactivex.Observable%2Ckotlin.Any)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/rxjava2/package-summary?hl=zh-cn#subscribeAsState(io.reactivex.Observable,kotlin.Any)" ref="nofollow noopener noreferrer"><code>Observable.subscribeAsState()</code></a> 包含在 <code>androidx.compose.runtime:runtime-rxjava2:$composeVersion</code> 或 <code>androidx.compose.runtime:runtime-rxjava3:$composeVersion</code> 工件中。</li>
</ul>
<p>如需了解详情，请参阅“状态”文档中的<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fstate%3Fhl%3Dzh-cn%23use-other-types-of-state-in-jetpack-compose" target="_blank" title="https://developer.android.com/jetpack/compose/state?hl=zh-cn#use-other-types-of-state-in-jetpack-compose" ref="nofollow noopener noreferrer">其他受支持的状态类型</a>页面。</p>
</blockquote>
<h2 data-id="heading-12">5. LaunchedEffect 和 rememberUpdatedState</h2>
<p>在该项目中，有一个目前未使用的 <code>home/LandingScreen.kt</code> 文件。您想要向应用添加一个着陆屏幕，它有可能会用于在后台加载需要的所有数据。</p>
<p>着陆屏幕将占据整个屏幕，并在屏幕中间显示应用的徽标。理想情况下，您会显示该屏幕，在所有数据加载完毕之后，您会通知调用方可以使用 <code>onTimeout</code> 回调关闭着陆屏幕。</p>
<p>建议使用 Kotlin 协程在 Android 中执行异步操作。应用在启动时通常会使用协程在后台加载内容。Jetpack Compose 提供了可让您在界面层中安全使用协程的 API。由于此应用不与后端进行通信，因此您将使用协程的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fkotlin.github.io%2Fkotlinx.coroutines%2Fkotlinx-coroutines-core%2Fkotlinx.coroutines%2Fdelay.html" target="_blank" title="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/delay.html" ref="nofollow noopener noreferrer"><code>delay</code></a> 函数来模拟在后台加载内容。</p>
<blockquote>
<p><strong>Compose 中的附带效应是指发生在可组合函数作用域之外的应用状态的变化。</strong> 例如，当用户点按一个按钮时打开一个新屏幕，或者在应用未连接到互联网时显示一条消息。</p>
</blockquote>
<p>Compose 中的附带效应是指发生在可组合函数作用域之外的应用状态的变化。将状态更改为显示/隐藏着陆屏幕的操作将发生在 <code>onTimeout</code> 回调中，由于在调用 <code>onTimeout</code> 之前您需要先使用协程加载内容，因此状态变化必须发生在协程的上下文中！</p>
<p>如需从可组合项内安全地调用挂起函数，请使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fpackage-summary%3Fhl%3Dzh-cn%23LaunchedEffect(kotlin.Any%2Ckotlin.coroutines.SuspendFunction1)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary?hl=zh-cn#LaunchedEffect(kotlin.Any,kotlin.coroutines.SuspendFunction1)" ref="nofollow noopener noreferrer"><code>LaunchedEffect</code></a> API，该 API 会在 Compose 中触发协程作用域限定的附带效应。</p>
<p>当 <code>LaunchedEffect</code> 进入组合时，它会启动一个协程，并将代码块作为参数传递。如果 <code>LaunchedEffect</code> 退出组合，协程将取消。</p>
<p>虽然接下来的代码不正确，但让我们看看如何使用此 API，并探讨为什么下面的代码是错误的。您将在此步骤的后面调用 <code>LandingScreen</code> 可组合项。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// home/LandingScreen.kt file</span>

<span class="hljs-keyword">import</span> androidx.compose.runtime.LaunchedEffect
<span class="hljs-keyword">import</span> kotlinx.coroutines.delay

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">LandingScreen</span><span class="hljs-params">(onTimeout: () -&gt; <span class="hljs-type">Unit</span>, modifier: <span class="hljs-type">Modifier</span> = Modifier)</span></span> {
    Box(modifier = modifier.fillMaxSize(), contentAlignment = Alignment.Center) {
        <span class="hljs-comment">// Start a side effect to load things in the background</span>
        <span class="hljs-comment">// and call onTimeout() when finished.</span>
        <span class="hljs-comment">// Passing onTimeout as a parameter to LaunchedEffect</span>
        <span class="hljs-comment">// is wrong! Don't do this. We'll improve this code in a sec.</span>
        LaunchedEffect(onTimeout) {
            delay(SplashWaitTime) <span class="hljs-comment">// Simulates loading things</span>
            onTimeout()
        }
        Image(painterResource(id = R.drawable.ic_crane_drawer), contentDescription = <span class="hljs-literal">null</span>)
    }
}
</code></pre>
<p>某些附带效应 API（如 <code>LaunchedEffect</code>）将可变数量的键作为形参，用于在其中一个键发生更改时<strong>重新开始</strong>执行效应。您发现错误了吗？我们不希望在此可组合函数的调用方传递不同的 <code>onTimeout</code> lambda 值时重启 <code>LaunchedEffect</code>。这会让 <code>delay</code> 再次启动，使得您无法满足相关要求。</p>
<p>接下来，让我们解决这个问题。如需在<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Flifecycle%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/jetpack/compose/lifecycle?hl=zh-cn" ref="nofollow noopener noreferrer">此可组合项的生命周期</a>内仅触发一次附带效应，请将常量用作键，例如 <code>LaunchedEffect(Unit) { ... }</code>。不过，现在又有一个问题。</p>
<p>如果 <code>onTimeout</code> 在附带效应正在进行时发生变化，效应结束时不一定会调用最后一个 <code>onTimeout</code>。如需保证调用最后一个 <code>onTimeout</code>，请使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fpackage-summary%3Fhl%3Dzh-cn%23rememberUpdatedState(kotlin.Any)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary?hl=zh-cn#rememberUpdatedState(kotlin.Any)" ref="nofollow noopener noreferrer"><code>rememberUpdatedState</code></a> API 记住 <code>onTimeout</code>。此 API 会捕获并更新最新值：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// home/LandingScreen.kt file</span>

<span class="hljs-keyword">import</span> androidx.compose.runtime.getValue
<span class="hljs-keyword">import</span> androidx.compose.runtime.rememberUpdatedState
<span class="hljs-keyword">import</span> kotlinx.coroutines.delay

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">LandingScreen</span><span class="hljs-params">(onTimeout: () -&gt; <span class="hljs-type">Unit</span>, modifier: <span class="hljs-type">Modifier</span> = Modifier)</span></span> {
    Box(modifier = modifier.fillMaxSize(), contentAlignment = Alignment.Center) {
        <span class="hljs-comment">// This will always refer to the latest onTimeout function that</span>
        <span class="hljs-comment">// LandingScreen was recomposed with</span>
        <span class="hljs-keyword">val</span> currentOnTimeout <span class="hljs-keyword">by</span> rememberUpdatedState(onTimeout)

        <span class="hljs-comment">// Create an effect that matches the lifecycle of LandingScreen.</span>
        <span class="hljs-comment">// If LandingScreen recomposes or onTimeout changes, </span>
        <span class="hljs-comment">// the delay shouldn't start again.</span>
        LaunchedEffect(<span class="hljs-built_in">Unit</span>) {
            delay(SplashWaitTime)
            currentOnTimeout()
        }

        Image(painterResource(id = R.drawable.ic_crane_drawer), contentDescription = <span class="hljs-literal">null</span>)
    }
}
</code></pre>
<p>当长期存在的 lambda 或对象表达式引用在组合期间计算的参数或值时，您应使用 <code>rememberUpdatedState</code>，这在使用 <code>LaunchedEffect</code> 时可能很常见。</p>
<h3 data-id="heading-13">显示着陆屏幕</h3>
<p>现在，您需要在应用打开后显示着陆屏幕。打开 <code>home/MainActivity.kt</code> 文件，并查看首次调用的 <code>MainScreen</code> 可组合项。</p>
<p>在 <code>MainScreen</code> 可组合项中，您只需添加一种内部状态，用来跟踪是否应显示着陆屏幕：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// home/MainActivity.kt file</span>

<span class="hljs-keyword">import</span> androidx.compose.runtime.getValue
<span class="hljs-keyword">import</span> androidx.compose.runtime.mutableStateOf
<span class="hljs-keyword">import</span> androidx.compose.runtime.remember
<span class="hljs-keyword">import</span> androidx.compose.runtime.setValue

<span class="hljs-meta">@Composable</span>
<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">MainScreen</span><span class="hljs-params">(onExploreItemClicked: <span class="hljs-type">OnExploreItemClicked</span>)</span></span> {
    Surface(color = MaterialTheme.colors.primary) {
        <span class="hljs-keyword">var</span> showLandingScreen <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-literal">true</span>) }
        <span class="hljs-keyword">if</span> (showLandingScreen) {
            LandingScreen(onTimeout = { showLandingScreen = <span class="hljs-literal">false</span> })
        } <span class="hljs-keyword">else</span> {
            CraneHome(onExploreItemClicked = onExploreItemClicked)
        }
    }
}
</code></pre>
<p>如果您现在运行应用，您应该会看到 <code>LandingScreen</code> 出现并在 2 秒后消失。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9911e5fd229b4bcb8e972604a49eb90f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmVzdF9KZXJyeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766048446&amp;x-signature=DI%2Fgq2wjmkvxjnyBEqzMVFTaKKI%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-14">6. rememberCoroutineScope</h2>
<p>在此步骤中，您将使抽屉式导航栏正常工作。目前，如果您尝试点按汉堡式菜单，什么都不会发生。</p>
<p>打开 <code>home/CraneHome.kt</code> 文件，并查看 <code>CraneHome</code> 可组合项，看看您需要在何处打开抽屉式导航栏：在 <code>openDrawer</code> 回调中！</p>
<p>在 <code>CraneHome</code> 中，有一个包含 <code>DrawerState</code> 的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fmaterial%2FScaffoldState%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/material/ScaffoldState?hl=zh-cn" ref="nofollow noopener noreferrer"><code>scaffoldState</code></a>。<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fmaterial%2FDrawerState%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/material/DrawerState?hl=zh-cn" ref="nofollow noopener noreferrer"><code>DrawerState</code></a> 具有以程序化方式打开和关闭抽屉式导航栏的方法。不过，如果您尝试在 <code>openDrawer</code> 回调中编写 <code>scaffoldState.drawerState.open()</code>，您会收到一条错误消息！这是因为，<code>open</code> 函数是一个<strong>挂起</strong>函数。我们再次进入协程的领域。</p>
<p>除了可让您从界面层安全调用协程的 API 之外，某些 Compose API 是挂起函数。用于打开抽屉式导航栏的 API 就是一个这样的例子。挂起函数除了能够运行异步代码之外，还可以帮助表示随着时间的推移出现的概念。打开抽屉式导航栏需要花些时间、进行移动，而且还有可能需要显示动画，这可以通过挂起函数完美地反映出来，挂起函数将在被调用的地方暂停协程的执行，直到它完成，然后再继续执行。</p>
<p>必须在协程中调用 <code>scaffoldState.drawerState.open()</code>。您可采取的行动 <code>openDrawer</code> 是一个简单的回调函数，因此：</p>
<ul>
<li>您不能简单地在其中调用挂起函数，因为 <code>openDrawer</code> 不在协程的上下文中执行。</li>
<li>您不能像之前一样使用 <code>LaunchedEffect</code>，因为不能在 <code>openDrawer</code> 中调用可组合项。我们不在组合中。</li>
</ul>
<p>您希望启动一个协程；应使用哪个作用域呢？理想情况下，您希望 <code>CoroutineScope</code> 能够遵循其调用点的生命周期。如果使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fpackage-summary%3Fhl%3Dzh-cn%23rememberCoroutineScope(kotlin.Function0)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary?hl=zh-cn#rememberCoroutineScope(kotlin.Function0)" ref="nofollow noopener noreferrer"><code>rememberCoroutineScope</code></a> API，则会返回一个 <code>CoroutineScope</code>，该 CoroutineScope 会绑定到它在组合中的调用点。一旦退出组合，作用域将自动取消。有了这个作用域，即使您不在组合中（例如，在 <code>openDrawer</code> 回调中），也可以启动协程。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// home/CraneHome.kt file</span>

<span class="hljs-keyword">import</span> androidx.compose.runtime.rememberCoroutineScope
<span class="hljs-keyword">import</span> kotlinx.coroutines.launch

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">CraneHome</span><span class="hljs-params">(
    onExploreItemClicked: <span class="hljs-type">OnExploreItemClicked</span>,
    modifier: <span class="hljs-type">Modifier</span> = Modifier,
)</span></span> {
    <span class="hljs-keyword">val</span> scaffoldState = rememberScaffoldState()
    Scaffold(
        scaffoldState = scaffoldState,
        modifier = Modifier.statusBarsPadding(),
        drawerContent = {
            CraneDrawer()
        }
    ) {
        <span class="hljs-keyword">val</span> scope = rememberCoroutineScope()
        CraneHomeContent(
            modifier = modifier,
            onExploreItemClicked = onExploreItemClicked,
            openDrawer = {
                scope.launch {
                    scaffoldState.drawerState.<span class="hljs-keyword">open</span>()
                }
            }
        )
    }
}
</code></pre>
<p>如果您运行应用，您会看到当您点按汉堡式菜单图标时，系统会打开抽屉式导航栏。</p>
<h3 data-id="heading-15">LaunchedEffect 与 rememberCoroutineScope</h3>
<p>在这种情况下无法使用 <code>LaunchedEffect</code>，因为您需要触发调用以在组合之外的常规回调中创建协程。</p>
<p>回顾一下使用 <code>LaunchedEffect</code> 的着陆屏幕步骤，您可以使用 <code>rememberCoroutineScope</code> 并调用 <code>scope.launch { delay(); onTimeout(); }</code> 而不使用 <code>LaunchedEffect</code> 吗？</p>
<p>您本来可以这样做，而且似乎可行，但这样并不正确。如<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fmental-model%3Fhl%3Dzh-cn%23any-order" target="_blank" title="https://developer.android.com/jetpack/compose/mental-model?hl=zh-cn#any-order" ref="nofollow noopener noreferrer">“Compose 编程思想”文档</a>中所述，Compose 可以随时调用可组合项。<code>LaunchedEffect</code> 可以保证当对该可组合项的调用使其进入组合时将会执行附带效应。如果您在 <code>LandingScreen</code> 的主体中使用 <code>rememberCoroutineScope</code> 和 <code>scope.launch</code>，则每次 Compose 调用 <code>LandingScreen</code> 时都会执行协程，而不管该调用是否使其进入组合。因此，您会浪费资源，而且不会在受控环境中执行此附带效应。</p>
<h2 data-id="heading-16">7. 创建状态容器</h2>
<p>您注意到了吗？如果您点按“Choose Destination”，您可以修改该字段，并根据搜索输入过滤城市。此外，您或许还注意到了，每当您修改“Choose Destination”时，文本样式都会发生变化。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d3b1750f3f840619a77730c387d81be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmVzdF9KZXJyeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766048446&amp;x-signature=HrS64TARh%2Fnkj691iSbShoTt6v8%3D" alt="image.png" loading="lazy"/></p>
<p>打开 <code>base/EditableUserInput.kt</code> 文件。<code>CraneEditableUserInput</code> 有状态可组合项接受一些参数，如 <code>hint</code> 和 <code>caption</code>，后者对应于图标旁边的可选文本。例如，当您搜索目的地时，会出现 <code>caption</code>“To”。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// base/EditableUserInput.kt file - code in the main branch</span>

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">CraneEditableUserInput</span><span class="hljs-params">(
    hint: <span class="hljs-type">String</span>,
    caption: <span class="hljs-type">String</span>? = <span class="hljs-literal">null</span>,
    <span class="hljs-meta">@DrawableRes</span> vectorImageId: <span class="hljs-type">Int</span>? = <span class="hljs-literal">null</span>,
    onInputChanged: (<span class="hljs-type">String</span>) -&gt; <span class="hljs-type">Unit</span>
)</span></span> {
    <span class="hljs-comment">// TODO Codelab: Encapsulate this state in a state holder</span>
    <span class="hljs-keyword">var</span> textState <span class="hljs-keyword">by</span> remember { mutableStateOf(hint) }
    <span class="hljs-keyword">val</span> isHint = { textState == hint }

    ...
}
</code></pre>
<h3 data-id="heading-17">原因</h3>
<p>用于更新 <code>textState</code> 以及确定显示的内容是否对应于提示的逻辑全部都在 <code>CraneEditableUserInput</code> 可组合项的主体中。这就带来了一些缺点：</p>
<ul>
<li><code>TextField</code> 的值未提升，因而无法从外部进行控制，这使得测试更加困难。</li>
<li>此可组合项的逻辑可能会变得更加复杂，并且内部状态可能会更容易不同步。</li>
</ul>
<p>通过创建负责此可组合项的内部状态的状态容器，您可以将所有状态变化集中在一个位置。这样，状态不同步就更难了，并且相关的逻辑全部归在一个类中。此外，此状态很容易向上提升，并且可以从此可组合项的调用方使用。</p>
<p>在这种情况下，提升状态是一种不错的做法，因为这是一个低级界面组件，可能会在应用的其他部分中重复使用。因此，它越灵活越可控，就越好。</p>
<h3 data-id="heading-18">创建状态容器</h3>
<p>由于 <code>CraneEditableUserInput</code> 是一个可重复使用的组件，您可以在同一文件中创建一个名为 <code>EditableUserInputState</code> 的常规类作为状态容器，如下所示：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// base/EditableUserInput.kt file</span>

<span class="hljs-keyword">import</span> androidx.compose.runtime.getValue
<span class="hljs-keyword">import</span> androidx.compose.runtime.mutableStateOf
<span class="hljs-keyword">import</span> androidx.compose.runtime.setValue

<span class="hljs-keyword">class</span> <span class="hljs-title class_">EditableUserInputState</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> hint: String, initialText: String) {

    <span class="hljs-keyword">var</span> text <span class="hljs-keyword">by</span> mutableStateOf(initialText)
       <span class="hljs-keyword">private</span> <span class="hljs-keyword">set</span>

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateText</span><span class="hljs-params">(newText: <span class="hljs-type">String</span>)</span></span> {
       text = newText
    }

    <span class="hljs-keyword">val</span> isHint: <span class="hljs-built_in">Boolean</span>
        <span class="hljs-keyword">get</span>() = text == hint
}
</code></pre>
<p>该类应具有以下特征：</p>
<ul>
<li><code>text</code> 是 <code>String</code> 类型的可变状态，就像在 <code>CraneEditableUserInput</code> 中一样。请务必使用 <code>mutableStateOf</code>，以便 Compose 跟踪值的更改，并在发生更改时重组。</li>
<li><code>text</code> 是具有私有 <code>set</code> 的 <code>var</code>，因此无法直接从类外部改变它。您可以公开 <code>updateText</code> 事件来对此变量进行修改，从而将该类设为单一可信来源，而不是公开此变量。</li>
<li>该类将 <code>initialText</code> 作为用于初始化 <code>text</code> 的依赖项。</li>
<li>用于判断 <code>text</code> 是否为提示的逻辑在按需执行检查的 <code>isHint</code> 属性中。</li>
</ul>
<p>如果将来逻辑变得更加复杂，您只需要对一个类进行更改：<code>EditableUserInputState</code>。</p>
<h3 data-id="heading-19">记住状态容器</h3>
<p>始终需要记住状态容器，以使其留在组合中，而不是每次都创建一个新的。最好在同一文件中创建一个执行此操作的方法，以移除样板并避免可能发生的任何错误。在 <code>base/EditableUserInput.kt</code> 文件中，添加以下代码：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// base/EditableUserInput.kt file</span>

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">rememberEditableUserInputState</span><span class="hljs-params">(hint: <span class="hljs-type">String</span>)</span></span>: EditableUserInputState =
    remember(hint) {
        EditableUserInputState(hint, hint)
    }
</code></pre>
<p>如果您只是使用 <code>remember</code> 记住此状态，它在 activity 重新创建后不会继续留存。**为了解决此问题，您可以改用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fsaveable%2Fpackage-summary%3Fhl%3Dzh-cn%23rememberSaveable(kotlin.Array%2Candroidx.compose.runtime.saveable.Saver%2Ckotlin.String%2Ckotlin.Function0)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/saveable/package-summary?hl=zh-cn#rememberSaveable(kotlin.Array,androidx.compose.runtime.saveable.Saver,kotlin.String,kotlin.Function0)" ref="nofollow noopener noreferrer"><strong><code>rememberSaveable</code></strong></a> API，它的行为方式与 <code>remember</code> 类似，但存储的值在 activity 和进程重新创建后会继续留存。在内部，它使用保存的实例状态机制。</p>
<p>对于可以存储在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fandroid%2Fos%2FBundle%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/reference/android/os/Bundle?hl=zh-cn" ref="nofollow noopener noreferrer"><code>Bundle</code></a> 内的对象，<code>rememberSaveable</code> 可以做所有这些工作，而无需任何额外的操作。对于您在项目中创建的 <code>EditableUserInputState</code> 类，却并非如此。因此，您需要告知 <code>rememberSaveable</code> 如何使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fsaveable%2Fpackage-summary%3Fhl%3Dzh-cn%23Saver(kotlin.Function2%2Ckotlin.Function1)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/saveable/package-summary?hl=zh-cn#Saver(kotlin.Function2,kotlin.Function1)" ref="nofollow noopener noreferrer"><code>Saver</code></a> 保存和恢复此类的实例。</p>
<h3 data-id="heading-20">创建自定义保存器</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fsaveable%2Fpackage-summary%3Fhl%3Dzh-cn%23Saver(kotlin.Function2%2Ckotlin.Function1)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/saveable/package-summary?hl=zh-cn#Saver(kotlin.Function2,kotlin.Function1)" ref="nofollow noopener noreferrer"><code>Saver</code></a> 描述了如何将对象转换为 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fsaveable%2FSaver%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/saveable/Saver?hl=zh-cn" ref="nofollow noopener noreferrer"><code>Saveable</code></a>（可保存）的内容。<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fsaveable%2Fpackage-summary%3Fhl%3Dzh-cn%23Saver(kotlin.Function2%2Ckotlin.Function1)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/saveable/package-summary?hl=zh-cn#Saver(kotlin.Function2,kotlin.Function1)" ref="nofollow noopener noreferrer"><code>Saver</code></a> 的实现需要替换两个函数：</p>
<ul>
<li><code>save</code> - 将原始值转换为可保存的值。</li>
<li><code>restore</code> - 将恢复的值转换为原始类的实例。</li>
</ul>
<p>在本例中，您可以使用一些现有的 Compose API，如 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fsaveable%2Fpackage-summary%3Fhl%3Dzh-cn%23listSaver(kotlin.Function2%2Ckotlin.Function1)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/saveable/package-summary?hl=zh-cn#listSaver(kotlin.Function2,kotlin.Function1)" ref="nofollow noopener noreferrer"><code>listSaver</code></a> 或 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fsaveable%2Fpackage-summary%3Fhl%3Dzh-cn%23mapSaver(kotlin.Function2%2Ckotlin.Function1)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/saveable/package-summary?hl=zh-cn#mapSaver(kotlin.Function2,kotlin.Function1)" ref="nofollow noopener noreferrer"><code>mapSaver</code></a>（用于存储要保存在 <code>List</code> 或 <code>Map</code> 中的值），以减少您需要编写的代码量，而不是为 <code>EditableUserInputState</code> 类创建 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fsaveable%2Fpackage-summary%3Fhl%3Dzh-cn%23Saver(kotlin.Function2%2Ckotlin.Function1)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/saveable/package-summary?hl=zh-cn#Saver(kotlin.Function2,kotlin.Function1)" ref="nofollow noopener noreferrer"><code>Saver</code></a> 的自定义实现。</p>
<p>最好将 <code>Saver</code> 定义放置在与其一起使用的类附近。由于需要被静态访问，因此请在 <code>companion object</code> 中为 <code>EditableUserInputState</code> 添加 <code>Saver</code>。在 <code>base/EditableUserInput.kt</code> 文件中，添加 <code>Saver</code> 的实现：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// base/EditableUserInput.kt file</span>

<span class="hljs-keyword">import</span> androidx.compose.runtime.saveable.Saver
<span class="hljs-keyword">import</span> androidx.compose.runtime.saveable.listSaver

<span class="hljs-keyword">class</span> <span class="hljs-title class_">EditableUserInputState</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> hint: String, initialText: String) {
    <span class="hljs-keyword">var</span> text <span class="hljs-keyword">by</span> mutableStateOf(initialText)

    <span class="hljs-keyword">val</span> isHint: <span class="hljs-built_in">Boolean</span>
        <span class="hljs-keyword">get</span>() = text == hint

    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-keyword">val</span> Saver: Saver&lt;EditableUserInputState, *&gt; = listSaver(
            save = { listOf(it.hint, it.text) },
            restore = {
                EditableUserInputState(
                    hint = it[<span class="hljs-number">0</span>],
                    initialText = it[<span class="hljs-number">1</span>],
                )
            }
        )
    }
}
</code></pre>
<p>在本例中，您将 <code>listSaver</code> 用作实现细节，在保存器中存储和恢复 <code>EditableUserInputState</code> 的实例。</p>
<p>现在，您可以在之前创建的 <code>rememberEditableUserInputState</code> 方法的 <code>rememberSaveable</code>（而不是 <code>remember</code>）中使用此保存器：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// base/EditableUserInput.kt file</span>
<span class="hljs-keyword">import</span> androidx.compose.runtime.saveable.rememberSaveable

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">rememberEditableUserInputState</span><span class="hljs-params">(hint: <span class="hljs-type">String</span>)</span></span>: EditableUserInputState =
    rememberSaveable(hint, saver = EditableUserInputState.Saver) {
        EditableUserInputState(hint, hint)
    }
</code></pre>
<p>这样，<code>EditableUserInput</code> 记住的状态就会在进程和 activity 重新创建后继续留存。</p>
<h3 data-id="heading-21">使用状态容器</h3>
<p>您将要使用 <code>EditableUserInputState</code> 而不是 <code>text</code> 和 <code>isHint</code>，但您不希望只将其用作 <code>CraneEditableUserInput</code> 中的内部状态，因为调用方可组合项无法控制状态。相反，您希望提升 <code>EditableUserInputState</code>，以便调用方可以控制 <code>CraneEditableUserInput</code> 的状态。**如果您提升状态，那么可组合项就可以在预览中使用，并且更容易进行测试，因为您能够从调用方修改其状态。</p>
<p>为此，您需要更改可组合函数的形参，并在需要时为其提供默认值。由于您可能希望允许 <code>CraneEditableUserInput</code> 带有空提示，因此添加一个默认实参：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">CraneEditableUserInput</span><span class="hljs-params">(
    state: <span class="hljs-type">EditableUserInputState</span> = rememberEditableUserInputState(<span class="hljs-string">""</span>)</span></span>,
    caption: String? = <span class="hljs-literal">null</span>,
    <span class="hljs-meta">@DrawableRes</span> vectorImageId: <span class="hljs-built_in">Int</span>? = <span class="hljs-literal">null</span>
) { <span class="hljs-comment">/* ... */</span> }
</code></pre>
<p>您或许已经注意到，<code>onInputChanged</code> 形参不存在了！由于状态可以提升，因此如果调用方想要知道输入是否发生了更改，它们可以控制状态并将该状态传入此函数。</p>
<p>接下来，您需要调整函数主体，以使用提升的状态，而不是之前使用的内部状态。重构后，函数应如下所示：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">CraneEditableUserInput</span><span class="hljs-params">(
    state: <span class="hljs-type">EditableUserInputState</span> = rememberEditableUserInputState(<span class="hljs-string">""</span>)</span></span>,
    caption: String? = <span class="hljs-literal">null</span>,
    <span class="hljs-meta">@DrawableRes</span> vectorImageId: <span class="hljs-built_in">Int</span>? = <span class="hljs-literal">null</span>
) {
    CraneBaseUserInput(
        caption = caption,
        tintIcon = { !state.isHint },
        showCaption = { !state.isHint },
        vectorImageId = vectorImageId
    ) {
        BasicTextField(
            value = state.text,
            onValueChange = { state.updateText(it) },
            textStyle = <span class="hljs-keyword">if</span> (state.isHint) {
                captionTextStyle.copy(color = LocalContentColor.current)
            } <span class="hljs-keyword">else</span> {
                MaterialTheme.typography.body1.copy(color = LocalContentColor.current)
            },
            cursorBrush = SolidColor(LocalContentColor.current)
        )
    }
}
</code></pre>
<h3 data-id="heading-22">状态容器调用方</h3>
<p>由于您更改了 <code>CraneEditableUserInput</code> 的 API，因此需要在调用它的所有位置进行检查，以确保传入适当的形参。</p>
<p>在项目中，您只在一个位置调用此 API，那就是在 <code>home/SearchUserInput.kt</code> 文件中。打开该文件并转到 <code>ToDestinationUserInput</code> 可组合函数；您应该会在该位置看到一个构建错误。由于提示现在是状态容器的一部分，并且您希望在组合中设置此 <code>CraneEditableUserInput</code> 实例的自定义提示，因此您需要记住 <code>ToDestinationUserInput</code> 级别的状态，并将其传入 <code>CraneEditableUserInput</code>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// home/SearchUserInput.kt file</span>

<span class="hljs-keyword">import</span> androidx.compose.samples.crane.base.rememberEditableUserInputState

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ToDestinationUserInput</span><span class="hljs-params">(onToDestinationChanged: (<span class="hljs-type">String</span>) -&gt; <span class="hljs-type">Unit</span>)</span></span> {
    <span class="hljs-keyword">val</span> editableUserInputState = rememberEditableUserInputState(hint = <span class="hljs-string">"Choose Destination"</span>)
    CraneEditableUserInput(
        state = editableUserInputState,
        caption = <span class="hljs-string">"To"</span>,
        vectorImageId = R.drawable.ic_plane
    )
}
</code></pre>
<h3 data-id="heading-23">snapshotFlow</h3>
<p>上面的代码缺少在输入更改时通知 <code>ToDestinationUserInput</code> 的调用方的功能。由于应用的结构，您不希望在层次结构中将 <code>EditableUserInputState</code> 提升到任何更高的级别。而且，您也不希望将其他可组合项（如 <code>FlySearchContent</code>）与此状态相结合。您如何从 <code>ToDestinationUserInput</code> 调用 <code>onToDestinationChanged</code> lambda 并且仍使此可组合项可重复使用呢？</p>
<p>您可以在每次输入更改时使用 <code>LaunchedEffect</code> 触发附带效应，并调用 <code>onToDestinationChanged</code> lambda：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// home/SearchUserInput.kt file</span>

<span class="hljs-keyword">import</span> androidx.compose.runtime.LaunchedEffect
<span class="hljs-keyword">import</span> androidx.compose.runtime.rememberUpdatedState
<span class="hljs-keyword">import</span> androidx.compose.runtime.snapshotFlow
<span class="hljs-keyword">import</span> kotlinx.coroutines.flow.collect
<span class="hljs-keyword">import</span> kotlinx.coroutines.flow.filter

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ToDestinationUserInput</span><span class="hljs-params">(onToDestinationChanged: (<span class="hljs-type">String</span>) -&gt; <span class="hljs-type">Unit</span>)</span></span> {
    <span class="hljs-keyword">val</span> editableUserInputState = rememberEditableUserInputState(hint = <span class="hljs-string">"Choose Destination"</span>)
    CraneEditableUserInput(
        state = editableUserInputState,
        caption = <span class="hljs-string">"To"</span>,
        vectorImageId = R.drawable.ic_plane
    )

    <span class="hljs-keyword">val</span> currentOnDestinationChanged <span class="hljs-keyword">by</span> rememberUpdatedState(onToDestinationChanged)
    LaunchedEffect(editableUserInputState) {
        snapshotFlow { editableUserInputState.text }
            .filter { !editableUserInputState.isHint }
            .collect {
                currentOnDestinationChanged(editableUserInputState.text)
            }
    }
}
</code></pre>
<p>您之前已经使用了 <code>LaunchedEffect</code> 和 <code>rememberUpdatedState</code>，但上面的代码还使用了一个新的 API！<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fpackage-summary%3Fhl%3Dzh-cn%23snapshotFlow(kotlin.Function0)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary?hl=zh-cn#snapshotFlow(kotlin.Function0)" ref="nofollow noopener noreferrer"><strong><code>snapshotFlow</code></strong></a> <strong>API</strong> 将 Compose <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2FState%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/State?hl=zh-cn" ref="nofollow noopener noreferrer"><code>State&lt;T&gt;</code></a> 对象转换为 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fkotlin%2Fflow%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/kotlin/flow?hl=zh-cn" ref="nofollow noopener noreferrer">Flow</a>。当在 <code>snapshotFlow</code> 内读取的状态发生变化时，Flow 会向收集器发出新值。在本例中，您将状态转换为 Flow，以使用 Flow 运算符的强大功能。这样，您就可以在 <code>text</code> 不是 <code>hint</code> 时使用 <code>filter</code> 进行过滤，并使用 <code>collect</code> 收集发出的项，以通知父项当前的目的地发生了变化。</p>
<h2 data-id="heading-24">8. DisposableEffect</h2>
<p>当您点按某个目的地时，系统会打开详情屏幕，您可以看到相应的城市在地图上的位置。该代码位于 <code>details/DetailsActivity.kt</code> 文件中。在 <code>CityMapView</code> 可组合项中，您调用了 <code>rememberMapViewWithLifecycle</code> 函数。如果您打开此函数（它位于 <code>details/MapViewUtils.kt</code> 文件中），您会看到它未关联到任何生命周期！它只是记住 <code>MapView</code> 并对其调用 <code>onCreate</code>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// details/MapViewUtils.kt file - code in the main branch</span>

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">rememberMapViewWithLifecycle</span><span class="hljs-params">()</span></span>: MapView {
    <span class="hljs-keyword">val</span> context = LocalContext.current
    <span class="hljs-comment">// TODO Codelab: DisposableEffect step. Make MapView follow the lifecycle</span>
    <span class="hljs-keyword">return</span> remember {
        MapView(context).apply {
            id = R.id.map
            onCreate(Bundle())
        }
    }
}
</code></pre>
<p>虽然应用运行良好，但这也是一个问题，因为 <code>MapView</code> 未遵循正确的生命周期。因此，它不知道应用何时转至后台、View 何时应暂停，等等。让我们来解决这一问题！</p>
<blockquote>
<p><strong>注意</strong>：如果您未看到地图，请查看“准备设置”步骤中的“[可选] 在详情屏幕上显示地图”部分。** **不过，对于本部分，没有必要在屏幕上看到地图。</p>
</blockquote>
<p>由于 <code>MapView</code> 是 View 而不是可组合项，因此您希望它遵循使用它的 Activity 的生命周期，以及组合的生命周期。这意味着，您需要创建一个 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fandroidx%2Flifecycle%2FLifecycleEventObserver%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/reference/androidx/lifecycle/LifecycleEventObserver?hl=zh-cn" ref="nofollow noopener noreferrer"><code>LifecycleEventObserver</code></a> 来监听生命周期事件并在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.google.com%2Fandroid%2Freference%2Fcom%2Fgoogle%2Fandroid%2Fgms%2Fmaps%2FMapView%3Fhl%3Dzh-cn" target="_blank" title="https://developers.google.com/android/reference/com/google/android/gms/maps/MapView?hl=zh-cn" ref="nofollow noopener noreferrer"><code>MapView</code></a> 上调用正确的方法。然后，您需要将此观察器添加到当前 activity 的生命周期。</p>
<p>首先创建一个函数，该函数返回 <code>LifecycleEventObserver</code>，在给定某个事件的情况下，它会在 <code>MapView</code> 中调用相应的方法：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// details/MapViewUtils.kt file</span>

<span class="hljs-keyword">import</span> androidx.lifecycle.Lifecycle
<span class="hljs-keyword">import</span> androidx.lifecycle.LifecycleEventObserver

<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getMapLifecycleObserver</span><span class="hljs-params">(mapView: <span class="hljs-type">MapView</span>)</span></span>: LifecycleEventObserver =
    LifecycleEventObserver { _, event -&gt;
        <span class="hljs-keyword">when</span> (event) {
            Lifecycle.Event.ON_CREATE -&gt; mapView.onCreate(Bundle())
            Lifecycle.Event.ON_START -&gt; mapView.onStart()
            Lifecycle.Event.ON_RESUME -&gt; mapView.onResume()
            Lifecycle.Event.ON_PAUSE -&gt; mapView.onPause()
            Lifecycle.Event.ON_STOP -&gt; mapView.onStop()
            Lifecycle.Event.ON_DESTROY -&gt; mapView.onDestroy()
            <span class="hljs-keyword">else</span> -&gt; <span class="hljs-keyword">throw</span> IllegalStateException()
        }
    }
</code></pre>
<p>现在，您需要将此观察器添加到当前的生命周期，您可以使用当前的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fandroidx%2Flifecycle%2FLifecycleOwner%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/reference/androidx/lifecycle/LifecycleOwner?hl=zh-cn" ref="nofollow noopener noreferrer"><code>LifecycleOwner</code></a> 与 <code>LocalLifecycleOwner</code> 组合局部函数来获取该生命周期。不过，仅仅添加观察器是不够的；您还需要能够将其移除！您需要一种附带效应，可以在效应退出组合时告知您，以便您可以执行一些清理代码。您寻找的附带效应 API 是 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fpackage-summary%3Fhl%3Dzh-cn%23DisposableEffect(kotlin.Any%2Ckotlin.Function1)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary?hl=zh-cn#DisposableEffect(kotlin.Any,kotlin.Function1)" ref="nofollow noopener noreferrer"><code>DisposableEffect</code></a>。</p>
<p><code>DisposableEffect</code> 适用于在键发生变化或可组合项退出组合后需要清理的附带效应。最终的 <code>rememberMapViewWithLifecycle</code> 代码正好起到这种作用。在项目中实现以下代码行：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// details/MapViewUtils.kt file</span>

<span class="hljs-keyword">import</span> androidx.compose.runtime.DisposableEffect
<span class="hljs-keyword">import</span> androidx.compose.ui.platform.LocalLifecycleOwner

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">rememberMapViewWithLifecycle</span><span class="hljs-params">()</span></span>: MapView {
    <span class="hljs-keyword">val</span> context = LocalContext.current
    <span class="hljs-keyword">val</span> mapView = remember {
        MapView(context).apply {
            id = R.id.map
        }
    }

    <span class="hljs-keyword">val</span> lifecycle = LocalLifecycleOwner.current.lifecycle
    DisposableEffect(key1 = lifecycle, key2 = mapView) {
        <span class="hljs-comment">// Make MapView follow the current lifecycle</span>
        <span class="hljs-keyword">val</span> lifecycleObserver = getMapLifecycleObserver(mapView)
        lifecycle.addObserver(lifecycleObserver)
        onDispose {
            lifecycle.removeObserver(lifecycleObserver)
        }
    }

    <span class="hljs-keyword">return</span> mapView
}
</code></pre>
<p>将观察器添加到了当前的 <code>lifecycle</code>，只要当前的生命周期发生变化或者此可组合项退出组合，就会将其移除。对于 <code>DisposableEffect</code> 中的 <code>key</code>，如果 <code>lifecycle</code> 或 <code>mapView</code> 发生变化，系统会移除观察器并再次将其添加到正确的 <code>lifecycle</code>。</p>
<p>通过您刚刚所做的更改，<code>MapView</code> 将始终遵循当前 <code>LifecycleOwner</code> 的 <code>lifecycle</code>，并且其行为就像在 View 环境中使用它时一样。</p>
<blockquote>
<p><strong>注意</strong>：此部分介绍了如何定义 <code>LifecycleEventObserver</code> 来响应 Compose 中的 <code>LifecycleOwner</code> 事件。您还学习了如何使用 <code>DisposableEffect</code> API 安全处置资源，以避免内存泄漏。相关示例使用了基于 View 的组件 <code>MapView</code>。在真实的 Compose 应用中，您可以使用新的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.google.com%2Fmaps%2Fdocumentation%2Fandroid-sdk%2Fmaps-compose%3Fhl%3Dzh-cn" target="_blank" title="https://developers.google.com/maps/documentation/android-sdk/maps-compose?hl=zh-cn" ref="nofollow noopener noreferrer">Maps for Compose 库</a>，该库会为您处理生命周期事件。</p>
</blockquote>
<h2 data-id="heading-25">9. produceState</h2>
<p>在本部分中，您将改进详情屏幕的启动方式。<code>details/DetailsActivity.kt</code> 文件中的 <code>DetailsScreen</code> 可组合项会从 ViewModel 同步获取 <code>cityDetails</code>，并在结果成功时调用 <code>DetailsContent</code>。</p>
<p>不过，<code>cityDetails</code> 在界面线程上的加载成本可能会变得越来越高，它可以使用协程将数据的加载工作移至其他线程。您将改进此代码，以添加一个加载屏幕，并在数据准备就绪时显示 <code>DetailsContent</code>。</p>
<p>为屏幕状态建模的一种方法是使用以下类，它涵盖了所有的可能性：要在屏幕上显示的数据，以及加载和错误信号。将 <code>DetailsUiState</code> 类添加到 <code>DetailsActivity.kt</code> 文件：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// details/DetailsActivity.kt file</span>

<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DetailsUiState</span>(
    <span class="hljs-keyword">val</span> cityDetails: ExploreModel? = <span class="hljs-literal">null</span>,
    <span class="hljs-keyword">val</span> isLoading: <span class="hljs-built_in">Boolean</span> = <span class="hljs-literal">false</span>,
    <span class="hljs-keyword">val</span> throwError: <span class="hljs-built_in">Boolean</span> = <span class="hljs-literal">false</span>
)
</code></pre>
<p>您可以使用一个数据流（即 <code>DetailsUiState</code> 类型的 <code>StateFlow</code>）映射屏幕需要显示的内容和 ViewModel 层中的 <code>UiState</code>，ViewModel 会在信息准备就绪时更新该数据流，而 Compose 会使用您已了解的 <code>collectAsStateWithLifecycle()</code> API 收集该数据流。</p>
<p>不过，为了本练习，您将实现一种替代方案。如果您希望将 <code>uiState</code> 映射逻辑移至 Compose 环境，您可以使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fpackage-summary%3Fhl%3Dzh-cn%23produceState(kotlin.Any%2Ckotlin.coroutines.SuspendFunction1)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary?hl=zh-cn#produceState(kotlin.Any,kotlin.coroutines.SuspendFunction1)" ref="nofollow noopener noreferrer"><code>produceState</code></a> API。</p>
<p><code>produceState</code> 可让您将非 Compose 状态转换为 Compose <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2FState%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/State?hl=zh-cn" ref="nofollow noopener noreferrer">状态</a>。它会启动一个作用域限定为组合的协程，该协程可使用 <code>value</code> 属性将值推送到返回的 <code>State</code>。与 <code>LaunchedEffect</code> 一样，<code>produceState</code> 也采用键来取消和重新开始计算。</p>
<p>对于您的用例，您可以使用 <code>produceState</code> 发出初始值为 <code>DetailsUiState(isLoading = true)</code> 的 <code>uiState</code> 更新，如下所示：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// details/DetailsActivity.kt file</span>

<span class="hljs-keyword">import</span> androidx.compose.runtime.produceState

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">DetailsScreen</span><span class="hljs-params">(
    onErrorLoading: () -&gt; <span class="hljs-type">Unit</span>,
    modifier: <span class="hljs-type">Modifier</span> = Modifier,
    viewModel: <span class="hljs-type">DetailsViewModel</span> = viewModel()</span></span>
) {

    <span class="hljs-keyword">val</span> uiState <span class="hljs-keyword">by</span> produceState(initialValue = DetailsUiState(isLoading = <span class="hljs-literal">true</span>)) {
        <span class="hljs-comment">// In a coroutine, this can call suspend functions or move</span>
        <span class="hljs-comment">// the computation to different Dispatchers</span>
        <span class="hljs-keyword">val</span> cityDetailsResult = viewModel.cityDetails
        value = <span class="hljs-keyword">if</span> (cityDetailsResult <span class="hljs-keyword">is</span> Result.Success&lt;ExploreModel&gt;) {
            DetailsUiState(cityDetailsResult.<span class="hljs-keyword">data</span>)
        } <span class="hljs-keyword">else</span> {
            DetailsUiState(throwError = <span class="hljs-literal">true</span>)
        }
    }

    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> ... </span>
}
</code></pre>
<p>接下来，根据 <code>uiState</code>，您会显示数据、显示加载屏幕或报告错误。下面是 <code>DetailsScreen</code> 可组合项的完整代码：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// details/DetailsActivity.kt file</span>

<span class="hljs-keyword">import</span> androidx.compose.foundation.layout.Box
<span class="hljs-keyword">import</span> androidx.compose.material.CircularProgressIndicator

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">DetailsScreen</span><span class="hljs-params">(
    onErrorLoading: () -&gt; <span class="hljs-type">Unit</span>,
    modifier: <span class="hljs-type">Modifier</span> = Modifier,
    viewModel: <span class="hljs-type">DetailsViewModel</span> = viewModel()</span></span>
) {
    <span class="hljs-keyword">val</span> uiState <span class="hljs-keyword">by</span> produceState(initialValue = DetailsUiState(isLoading = <span class="hljs-literal">true</span>)) {
        <span class="hljs-keyword">val</span> cityDetailsResult = viewModel.cityDetails
        value = <span class="hljs-keyword">if</span> (cityDetailsResult <span class="hljs-keyword">is</span> Result.Success&lt;ExploreModel&gt;) {
            DetailsUiState(cityDetailsResult.<span class="hljs-keyword">data</span>)
        } <span class="hljs-keyword">else</span> {
            DetailsUiState(throwError = <span class="hljs-literal">true</span>)
        }
    }

    <span class="hljs-keyword">when</span> {
        uiState.cityDetails != <span class="hljs-literal">null</span> -&gt; {
            DetailsContent(uiState.cityDetails!!, modifier.fillMaxSize())
        }
        uiState.isLoading -&gt; {
            Box(modifier.fillMaxSize()) {
                CircularProgressIndicator(
                    color = MaterialTheme.colors.onSurface,
                    modifier = Modifier.align(Alignment.Center)
                )
            }
        }
        <span class="hljs-keyword">else</span> -&gt; { onErrorLoading() }
    }
}
</code></pre>
<p>如果您运行应用，您会看到在显示城市详情之前如何出现了指示“正在加载”的旋转图标。</p>
<blockquote>
<p><strong>注意</strong>：<code>collectAsStateWithLifecycle()</code> API 会在后台使用 <code>produceState()</code> API。</p>
</blockquote>
<h2 data-id="heading-26">10. derivedStateOf</h2>
<p>您要对 Crane 做的最后一项改进是，每当您在航班目的地列表中滚动时，经过屏幕的第一个元素之后，都会显示一个用于“滚动至顶部”的按钮。点按该按钮会使您前往列表中的第一个元素。</p>
<p>打开包含此代码的 <code>base/ExploreSection.kt</code> 文件。<code>ExploreSection</code> 可组合项对应于您在 Scaffold 的背景幕中看到的内容。</p>
<p>如需计算用户是否已经过第一项，请使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Flists%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/jetpack/compose/lists?hl=zh-cn" ref="nofollow noopener noreferrer"><code>LazyColumn</code></a> 的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Ffoundation%2Flazy%2FLazyListState%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/foundation/lazy/LazyListState?hl=zh-cn" ref="nofollow noopener noreferrer"><code>LazyListState</code></a> 并检查 <code>listState.firstVisibleItemIndex &gt; 0</code>。</p>
<p>简单实现如下所示：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// DO NOT DO THIS - It's executed on every recomposition</span>
<span class="hljs-keyword">val</span> showButton = listState.firstVisibleItemIndex &gt; <span class="hljs-number">0</span>
</code></pre>
<p>该解决方案的效率并不高，因为每当 <code>firstVisibleItemIndex</code> 发生变化时，读取 <code>showButton</code> 的可组合函数都会重组，这种情况经常会在滚动时发生。不过，您希望该函数仅在条件在 <code>true</code> 和 <code>false</code> 之间变化时重组。</p>
<p>有一个 API 可让您做到这一点，那就是 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fpackage-summary%3Fhl%3Dzh-cn%23derivedStateOf(kotlin.Function0)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary?hl=zh-cn#derivedStateOf(kotlin.Function0)" ref="nofollow noopener noreferrer"><code>derivedStateOf</code></a> API。</p>
<p><code>listState</code> 是一个可观察的 Compose <code>State</code>。您的计算 <code>showButton</code> 也需要是一个 Compose <code>State</code>，因为您希望界面在其值发生变化时重组，并显示或隐藏按钮。</p>
<p>当您想要的某个 Compose <code>State</code> 衍生自另一个 <code>State</code> 时，请使用 <code>derivedStateOf</code>。每当内部状态发生变化时，系统都会执行 <code>derivedStateOf</code> 计算块，但只有当计算结果与上一项不同时，可组合函数才会重组。这样可以最大限度地减少读取 <code>showButton</code> 的函数的重组次数。</p>
<p>在这种情况下，使用 <code>derivedStateOf</code> API 是一种更好且更高效的替代方案。您还会使用 <code>remember</code> API 来封装调用，因此计算得出的值在重组后继续有效。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Show the button if the first visible item is past</span>
<span class="hljs-comment">// the first item. We use a remembered derived state to</span>
<span class="hljs-comment">// minimize unnecessary recompositions</span>
<span class="hljs-keyword">val</span> showButton <span class="hljs-keyword">by</span> remember {
    derivedStateOf {
        listState.firstVisibleItemIndex &gt; <span class="hljs-number">0</span>
    }
}
</code></pre>
<p>您应该已经熟悉 <code>ExploreSection</code> 可组合项的新代码。您使用 <code>Box</code> 将有条件地显示的 <code>Button</code> 放置在 <code>ExploreList</code> 的顶部。您会使用 <code>rememberCoroutineScope</code> 在 <code>Button</code> 的 <code>onClick</code> 回调内调用 <code>listState.scrollToItem</code> 挂起函数。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// base/ExploreSection.kt file</span>

<span class="hljs-keyword">import</span> androidx.compose.material.FloatingActionButton
<span class="hljs-keyword">import</span> androidx.compose.runtime.derivedStateOf
<span class="hljs-keyword">import</span> androidx.compose.runtime.getValue
<span class="hljs-keyword">import</span> androidx.compose.runtime.remember
<span class="hljs-keyword">import</span> androidx.compose.runtime.rememberCoroutineScope
<span class="hljs-keyword">import</span> androidx.compose.foundation.layout.navigationBarsPadding
<span class="hljs-keyword">import</span> kotlinx.coroutines.launch

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ExploreSection</span><span class="hljs-params">(
    modifier: <span class="hljs-type">Modifier</span> = Modifier,
    title: <span class="hljs-type">String</span>,
    exploreList: <span class="hljs-type">List</span>&lt;<span class="hljs-type">ExploreModel</span>&gt;,
    onItemClicked: <span class="hljs-type">OnExploreItemClicked</span>
)</span></span> {
    Surface(modifier = modifier.fillMaxSize(), color = Color.White, shape = BottomSheetShape) {
        Column(modifier = Modifier.padding(start = <span class="hljs-number">24.</span>dp, top = <span class="hljs-number">20.</span>dp, end = <span class="hljs-number">24.</span>dp)) {
            Text(
                text = title,
                style = MaterialTheme.typography.caption.copy(color = crane_caption)
            )
            Spacer(Modifier.height(<span class="hljs-number">8.</span>dp))
            Box(Modifier.weight(<span class="hljs-number">1f</span>)) {
                <span class="hljs-keyword">val</span> listState = rememberLazyListState()
                ExploreList(exploreList, onItemClicked, listState = listState)

                <span class="hljs-comment">// Show the button if the first visible item is past</span>
                <span class="hljs-comment">// the first item. We use a remembered derived state to</span>
                <span class="hljs-comment">// minimize unnecessary compositions</span>
                <span class="hljs-keyword">val</span> showButton <span class="hljs-keyword">by</span> remember {
                    derivedStateOf {
                        listState.firstVisibleItemIndex &gt; <span class="hljs-number">0</span>
                    }
                }
                <span class="hljs-keyword">if</span> (showButton) {
                    <span class="hljs-keyword">val</span> coroutineScope = rememberCoroutineScope()
                    FloatingActionButton(
                        backgroundColor = MaterialTheme.colors.primary,
                        modifier = Modifier
                            .align(Alignment.BottomEnd)
                            .navigationBarsPadding()
                            .padding(bottom = <span class="hljs-number">8.</span>dp),
                        onClick = {
                            coroutineScope.launch {
                                listState.scrollToItem(<span class="hljs-number">0</span>)
                            }
                        }
                    ) {
                        Text(<span class="hljs-string">"Up!"</span>)
                    }
                }
            }
        }
    }
}
</code></pre>
<p>如果您运行应用，您会看到一旦您滚动并经过屏幕的第一个元素，该按钮就会出现在底部。</p>
<blockquote>
<p><strong>注意</strong>：如需详细了解 <code>derivedStateOf()</code> API，请参阅<a href="https://link.juejin.cn?target=https%3A%2F%2Fmedium.com%2Fandroiddevelopers%2Fjetpack-compose-when-should-i-use-derivedstateof-63ce7954c11b" target="_blank" title="https://medium.com/androiddevelopers/jetpack-compose-when-should-i-use-derivedstateof-63ce7954c11b" ref="nofollow noopener noreferrer">何时应使用 derivedStateOf？</a>这篇博文。</p>
</blockquote>
<h2 data-id="heading-27">11. 总结</h2>
<p>您学习了如何创建状态容器、附带效应 API（如 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fpackage-summary%3Fhl%3Dzh-cn%23LaunchedEffect(kotlin.Any%2Ckotlin.coroutines.SuspendFunction1)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary?hl=zh-cn#LaunchedEffect(kotlin.Any,kotlin.coroutines.SuspendFunction1)" ref="nofollow noopener noreferrer"><code>LaunchedEffect</code></a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fpackage-summary%3Fhl%3Dzh-cn%23rememberUpdatedState(kotlin.Any)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary?hl=zh-cn#rememberUpdatedState(kotlin.Any)" ref="nofollow noopener noreferrer"><code>rememberUpdatedState</code></a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fpackage-summary%3Fhl%3Dzh-cn%23DisposableEffect(kotlin.Any%2Ckotlin.Function1)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary?hl=zh-cn#DisposableEffect(kotlin.Any,kotlin.Function1)" ref="nofollow noopener noreferrer"><code>DisposableEffect</code></a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fpackage-summary%3Fhl%3Dzh-cn%23produceState(kotlin.Any%2Ckotlin.coroutines.SuspendFunction1)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary?hl=zh-cn#produceState(kotlin.Any,kotlin.coroutines.SuspendFunction1)" ref="nofollow noopener noreferrer"><code>produceState</code></a> 和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fruntime%2Fpackage-summary%3Fhl%3Dzh-cn%23derivedStateOf(kotlin.Function0)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/runtime/package-summary?hl=zh-cn#derivedStateOf(kotlin.Function0)" ref="nofollow noopener noreferrer"><code>derivedStateOf</code></a>），以及如何在 Jetpack Compose 中使用协程。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【AI 编程实战】第 3 篇：后端小白也能写 API：AI 带我 1 小时搭完 Next.js 服务]]></title>    <link>https://juejin.cn/post/7582808491583619108</link>    <guid>https://juejin.cn/post/7582808491583619108</guid>    <pubDate>2025-12-12T08:09:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582808491583619108" data-draft-id="7582808491583258660" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【AI 编程实战】第 3 篇：后端小白也能写 API：AI 带我 1 小时搭完 Next.js 服务"/> <meta itemprop="keywords" content="前端,后端,AI编程"/> <meta itemprop="datePublished" content="2025-12-12T08:09:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="HashTang"/> <meta itemprop="url" content="https://juejin.cn/user/1117561754756488"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【AI 编程实战】第 3 篇：后端小白也能写 API：AI 带我 1 小时搭完 Next.js 服务
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1117561754756488/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    HashTang
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T08:09:43.000Z" title="Fri Dec 12 2025 08:09:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;display:inline-block;font-weight:700;background:#ef7060;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(239,112,96,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 50px);border-bottom:3px solid #ef7060}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #3e3e3e;margin-top:32px;margin-bottom:32px;height:1px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(27,31,35,.05);color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:JetBranins Mono,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px;background-color:#fdfdfd}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fdfdfd}.markdown-body a{text-decoration:none;font-weight:700;color:#ef7060;border-bottom:1px solid #ef7060}.markdown-body a:active,.markdown-body a:hover{color:#ef2d26}.markdown-body table tr td,.markdown-body table tr th{border:1px solid #ccc;padding:5px 10px}.markdown-body table{display:block!important;width:auto;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{background:#f0f0f0;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f8f8f8}.markdown-body blockquote{margin-inline-start:0;margin-inline-end:0;border-left:3px solid #ef7060;background:#fff9f9;padding:1px 20px;margin-top:20px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="vs2015">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1e1e1e;color:#dcdcdc}.hljs-keyword,.hljs-link,.hljs-literal,.hljs-name,.hljs-symbol{color:#569cd6}.hljs-link{text-decoration:underline}.hljs-built_in,.hljs-type{color:#4ec9b0}.hljs-class,.hljs-number{color:#b8d7a3}.hljs-meta-string,.hljs-string{color:#d69d85}.hljs-regexp,.hljs-template-tag{color:#9a5334}.hljs-formula,.hljs-function,.hljs-params,.hljs-subst,.hljs-title{color:#dcdcdc}.hljs-comment,.hljs-quote{color:#57a64a;font-style:italic}.hljs-doctag{color:#608b4e}.hljs-meta,.hljs-meta-keyword,.hljs-tag{color:#9b9b9b}.hljs-template-variable,.hljs-variable{color:#bd63c5}.hljs-attr,.hljs-attribute,.hljs-builtin-name{color:#9cdcfe}.hljs-section{color:gold}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-bullet,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-selector-tag{color:#d7ba7d}.hljs-addition{background-color:#144212}.hljs-addition,.hljs-deletion{display:inline-block;width:100%}.hljs-deletion{background-color:#600}</style><blockquote>
<p>后端 API 开发是很多前端开发者的"心理阴影"——数据库设计、ORM 操作、JWT 认证、错误处理……每一步都是坑。但有了 AI，这一切都变得简单起来。这是《<a href="https://juejin.cn/column/7579556047783624756" target="_blank" title="https://juejin.cn/column/7579556047783624756">AI 编程实战：TRAE SOLO 全栈开发指南</a>》专栏的第三篇文章，带你用 AI 快速搭建 Next.js 15 后端 API。</p>
</blockquote>
<h2 data-id="heading-0">一、开篇：前端开发者的后端焦虑</h2>
<h3 data-id="heading-1">1.1 后端开发的"噩梦"</h3>
<p>还记得小何吗？完成前端架构搭建后，他面临一个更大的挑战：<strong>后端 API 开发</strong>。</p>
<p>作为一个前端开发者，小何对后端并不陌生，但每次写后端代码时，总有一种"如履薄冰"的感觉：</p>
<pre><code class="hljs language-txt" lang="txt">数据库表怎么设计？字段类型怎么选？
ORM 怎么用？Prisma 和 TypeORM 有什么区别？
JWT 怎么生成？Token 过期怎么处理？
接口怎么设计才符合 RESTful 规范？
错误处理怎么统一？日志怎么记录？
</code></pre>
<p>传统方式下，小何需要：</p>









































<table><thead><tr><th>任务</th><th>预计时间</th></tr></thead><tbody><tr><td>学习 Next.js API</td><td>2 小时</td></tr><tr><td>数据库表设计</td><td>3 小时</td></tr><tr><td>Prisma 配置和学习</td><td>4 小时</td></tr><tr><td>JWT 认证实现</td><td>3 小时</td></tr><tr><td>登录注册 API</td><td>4 小时</td></tr><tr><td>响应格式统一</td><td>2 小时</td></tr><tr><td>错误处理和日志</td><td>2 小时</td></tr><tr><td><strong>总计</strong></td><td><strong>20 小时</strong></td></tr></tbody></table>
<p>实际上，因为各种问题，可能需要 <strong>3-4 天</strong>。</p>
<h3 data-id="heading-2">1.2 AI 辅助的后端开发</h3>
<p>有了 TRAE SOLO，小何的体验完全不同：</p>
<pre><code class="hljs language-txt" lang="txt">小何：帮我搭建 Next.js 15 后端 API，需要：
      1. MySQL 数据库，使用 Prisma ORM
      2. JWT 认证
      3. 微信小程序登录
      4. 统一的响应格式
      5. 日志记录

AI：好的，我来帮你搭建完整的后端架构：

    ✓ 分析项目结构，确定 Pages Router 模式
    ✓ 设计数据库表结构（用户、会员、账单等）
    ✓ 配置 Prisma ORM 连接 MySQL
    ✓ 实现 JWT 生成和验证
    ✓ 封装微信登录流程
    ✓ 统一响应格式（responseHelper）
    ✓ 配置 Winston 日志系统

    后端架构已生成，请查看...
</code></pre>
<p><strong>时间对比</strong>：</p>















































<table><thead><tr><th>任务</th><th>传统方式</th><th>AI 辅助</th><th>提升倍数</th></tr></thead><tbody><tr><td>数据库设计</td><td>3 小时</td><td>15 分钟</td><td><strong>12x</strong></td></tr><tr><td>Prisma 配置</td><td>4 小时</td><td>10 分钟</td><td><strong>24x</strong></td></tr><tr><td>JWT 认证</td><td>3 小时</td><td>10 分钟</td><td><strong>18x</strong></td></tr><tr><td>登录 API</td><td>4 小时</td><td>20 分钟</td><td><strong>12x</strong></td></tr><tr><td>响应格式统一</td><td>2 小时</td><td>5 分钟</td><td><strong>24x</strong></td></tr><tr><td><strong>总计</strong></td><td><strong>~20 小时</strong></td><td><strong>~1 小时</strong></td><td><strong>~20x</strong></td></tr></tbody></table>
<h2 data-id="heading-3">二、技术选型：为什么选择 Next.js 15 + Prisma</h2>
<h3 data-id="heading-4">2.1 Next.js 作为后端的优势</h3>
<pre><code class="hljs language-txt" lang="txt">小何：为什么后端要用 Next.js？不是应该用 Express 或 Koa 吗？

AI：Next.js 作为后端有独特优势：

    1. 全栈一体化
       - 前后端可以共享代码和类型
       - 部署更简单，一个服务搞定

    2. API Routes 开箱即用
       - 文件即路由，无需额外配置
       - 支持中间件、动态路由

    3. TypeScript 原生支持
       - 类型安全，减少运行时错误
       - 与 Prisma 完美配合

    4. 生态完善
       - 丰富的中间件和插件
       - 社区活跃，问题容易解决
</code></pre>
<h3 data-id="heading-5">2.2 Prisma vs TypeORM</h3>
<pre><code class="hljs language-txt" lang="txt">小何：Prisma 和 TypeORM 怎么选？

AI：（通过 MCP 查阅最新文档）

    ┌────────────────┬────────────────┬────────────────┐
    │     维度       │     Prisma     │    TypeORM     │
    ├────────────────┼────────────────┼────────────────┤
    │ 类型安全       │ ⭐⭐⭐⭐⭐     │ ⭐⭐⭐⭐       │
    │ 学习曲线       │ ⭐⭐⭐⭐⭐     │ ⭐⭐⭐         │
    │ 迁移管理       │ ⭐⭐⭐⭐⭐     │ ⭐⭐⭐⭐       │
    │ 查询直观性     │ ⭐⭐⭐⭐⭐     │ ⭐⭐⭐         │
    │ 性能           │ ⭐⭐⭐⭐       │ ⭐⭐⭐⭐       │
    │ 生态系统       │ ⭐⭐⭐⭐       │ ⭐⭐⭐⭐⭐     │
    └────────────────┴────────────────┴────────────────┘

    推荐：Prisma

    理由：
    1. Schema 定义直观，一目了然
    2. 自动生成类型，类型安全
    3. 迁移管理简单，prisma migrate 一键搞定
    4. 查询 API 简洁，链式调用友好
</code></pre>
<h3 data-id="heading-6">2.3 最终技术栈</h3>
<pre><code class="hljs language-txt" lang="txt">后端技术栈：
├── 框架：Next.js 15 (Pages Router)
├── 数据库：MySQL
├── ORM：Prisma 4.11
├── 认证：JWT (jsonwebtoken)
├── 加密：bcryptjs
├── 日志：Winston + daily-rotate-file
├── AI 集成：OpenAI SDK
├── 支付：微信支付 + 支付宝
├── 存储：腾讯云 COS
└── 类型共享：shared-types (workspace)
</code></pre>
<h2 data-id="heading-7">三、数据库设计：Prisma Schema</h2>
<h3 data-id="heading-8">3.1 用户表设计</h3>
<p>数据库设计是后端开发的第一步，也是最重要的一步。</p>
<p><strong>提示词</strong>：</p>
<pre><code class="hljs language-txt" lang="txt">帮我设计用户表，需要支持：
1. 微信小程序登录（openid）
2. 手机号登录
3. 性别、年龄段等用户属性
4. 免费使用次数限制
5. 注册来源和渠道追踪
</code></pre>
<p><strong>AI 生成的 Prisma Schema</strong>：</p>
<pre><code class="hljs language-prisma" lang="prisma">// prisma/schema.prisma

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "darwin", "darwin-arm64", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  user_id               String    @id @default(uuid())
  username              String
  email                 String?   @unique
  phone_number          String?
  openid                String?   // 微信 openid
  hashed_password       String
  email_verified        Boolean   @default(false)
  phone_verified        Boolean   @default(false)

  // 地理信息
  country               String?
  province              String?
  city                  String?
  isp                   String?

  // 用户属性
  verification_code     String?
  avatar                String?
  gender                Int?      // 1: 男, 2: 女
  age_group             Int?      // 1: 00后, 2: 05后, 3: 90后, 4: 80后, 5: 70后

  // 状态管理
  disabled_status       Int?      @default(0)
  disabled_time         DateTime?

  // 免费额度
  free_reply_total      Int       @default(3)
  free_reply_used       Int       @default(0)
  free_reply_reset_time DateTime?

  // 来源追踪
  register_source       Int       @default(1)  // 注册来源
  register_channel      Int       @default(1)  // 注册渠道
  latest_source         Int       @default(1)  // 最近来源
  latest_channel        Int       @default(1)  // 最近渠道

  // 时间戳
  code_send_time        DateTime?
  create_time           DateTime? @default(now())
  update_time           DateTime  @default(now()) @updatedAt
  operate_time          DateTime?

  // 索引
  @@unique([phone_number, deleted_status])
  @@index([register_source], name: "idx_users_register_source")
  @@index([latest_source], name: "idx_users_latest_source")
  @@map("users")
}
</code></pre>
<p><strong>设计要点解析</strong>：</p>
<ol>
<li><strong>UUID 主键</strong>：使用 <code>@default(uuid())</code> 而非自增 ID，分布式友好，自己玩的小项目推荐自增 ID</li>
<li><strong>软删除</strong>：<code>deleted_status</code> + <code>deleted_time</code>，数据可恢复</li>
<li><strong>来源追踪</strong>：<code>register_source/channel</code> 和 <code>latest_source/channel</code>，用于数据分析</li>
<li><strong>免费额度</strong>：<code>free_reply_total/used/reset_time</code>，实现每日免费次数限制</li>
</ol>
<h3 data-id="heading-9">3.2 会员表设计</h3>
<pre><code class="hljs language-prisma" lang="prisma">// 会员类型模型
model MembershipType {
  id              Int       @id @default(autoincrement())
  name            String    // 会员名称：月度会员、季度会员、年度会员
  price           Decimal   @db.Decimal(10, 2)
  duration_days   Int       // 会员时长（天）
  description     String?
  is_active       Boolean   @default(true)
  sort_order      Int       @default(0)
  create_time     DateTime  @default(now())
  update_time     DateTime  @default(now()) @updatedAt

  @@map("membership_types")
}

// 用户会员记录
model UserMembership {
  id              Int       @id @default(autoincrement())
  user_id         String
  membership_type Int       // 关联会员类型
  start_time      DateTime
  end_time        DateTime
  is_active       Boolean   @default(true)
  source          String    @default("purchase") // purchase/gift/invite
  order_id        String?   // 关联订单
  create_time     DateTime  @default(now())
  update_time     DateTime  @default(now()) @updatedAt

  @@index([user_id], name: "idx_user_membership_user_id")
  @@index([end_time], name: "idx_user_membership_end_time")
  @@map("user_memberships")
}
</code></pre>
<h3 data-id="heading-10">3.3 Prisma 初始化和迁移</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装 Prisma</span>
pnpm --filter xingdong-server add prisma @prisma/client

<span class="hljs-comment"># 初始化 Prisma</span>
pnpm --filter xingdong-server prisma init

<span class="hljs-comment"># 生成 Prisma Client</span>
pnpm --filter xingdong-server prisma generate

<span class="hljs-comment"># 创建迁移</span>
pnpm --filter xingdong-server prisma migrate dev --name init

<span class="hljs-comment"># 查看数据库</span>
pnpm --filter xingdong-server prisma studio
</code></pre>
<h2 data-id="heading-11">四、项目结构：分层架构设计</h2>
<h3 data-id="heading-12">4.1 目录结构</h3>
<p>AI 帮小何设计了清晰的分层架构：</p>
<pre><code class="hljs language-txt" lang="txt">apps/xindong-server/
├── prisma/
│   └── schema.prisma           # 数据库模型定义
├── src/
│   ├── constants/              # 常量定义
│   │   └── index.ts
│   ├── db/                     # 数据访问层 (DAL)
│   │   ├── user.ts             # 用户数据操作
│   │   ├── chat.ts             # 聊天数据操作
│   │   ├── membership.ts       # 会员数据操作
│   │   └── ...
│   ├── helper/                 # 辅助工具
│   │   ├── logger.ts           # 日志工具
│   │   └── responseHelper.ts   # 响应格式化
│   ├── pages/
│   │   └── api/                # API 路由
│   │       ├── auth/           # 认证相关
│   │       │   ├── login.ts
│   │       │   ├── wx-login.ts
│   │       │   └── register.ts
│   │       ├── chat/           # 聊天相关
│   │       ├── membership/     # 会员相关
│   │       └── upload/         # 文件上传
│   ├── service/                # 业务逻辑层
│   │   ├── auth.ts             # 认证服务
│   │   ├── chatService.ts      # 聊天服务
│   │   ├── membershipService.ts
│   │   └── ...
│   ├── type/                   # 类型定义
│   └── utils/                  # 工具函数
│       ├── auth/
│       │   └── auth.ts         # JWT 工具
│       ├── prismaProxy.ts      # Prisma 代理
│       └── logRequest.ts       # 请求日志
├── .env                        # 环境变量
└── package.json
</code></pre>
<p><strong>分层职责</strong>：</p>
<ol>
<li><strong>pages/api</strong>：接收请求、参数验证、调用 Service</li>
<li><strong>service</strong>：业务逻辑处理、调用多个 DB 方法</li>
<li><strong>db</strong>：纯数据操作、Prisma 查询封装</li>
<li><strong>helper</strong>：通用辅助功能（日志、响应格式化）</li>
<li><strong>utils</strong>：工具函数（加密、JWT、请求处理）</li>
</ol>
<h3 data-id="heading-13">4.2 Prisma 代理封装</h3>
<p>AI 生成了一个 Prisma 代理，自动记录所有数据库操作日志：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/utils/prismaProxy.ts</span>
<span class="hljs-keyword">import</span> logger <span class="hljs-keyword">from</span> <span class="hljs-string">'@/helper/logger'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">PrismaClient</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@prisma/client'</span>;

<span class="hljs-keyword">const</span> prisma = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrismaClient</span>();

<span class="hljs-keyword">function</span> <span class="hljs-title function_">handlePrismaError</span>(<span class="hljs-params">error: <span class="hljs-built_in">Error</span></span>) {
  logger.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Prisma error: <span class="hljs-subst">${error.message}</span>`</span>, { error });
}

<span class="hljs-keyword">const</span> <span class="hljs-attr">handler</span>: <span class="hljs-title class_">ProxyHandler</span>&lt;<span class="hljs-title class_">PrismaClient</span>&gt; = {
  <span class="hljs-title function_">get</span>(<span class="hljs-params">target, propKey</span>) {
    <span class="hljs-keyword">const</span> origMethod = target[propKey <span class="hljs-keyword">as</span> keyof <span class="hljs-title class_">PrismaClient</span>];

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> origMethod === <span class="hljs-string">'function'</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-variable language_">this</span>: PrismaClient, ...args: <span class="hljs-built_in">unknown</span>[]</span>) {
        <span class="hljs-keyword">const</span> boundMethod = (origMethod <span class="hljs-keyword">as</span> <span class="hljs-title class_">Function</span>).<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>);
        <span class="hljs-keyword">try</span> {
          <span class="hljs-comment">// 记录请求日志</span>
          logger.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Prisma request: <span class="hljs-subst">${propKey.toString()}</span> with args: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(args)}</span>`</span>);

          <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">boundMethod</span>(...args);
          <span class="hljs-keyword">if</span> (result <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Promise</span>) {
            <span class="hljs-keyword">return</span> result
              .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
                <span class="hljs-comment">// 如果响应包含 count 属性，则记录所影响的行数</span>
                <span class="hljs-keyword">if</span> (res &amp;&amp; <span class="hljs-keyword">typeof</span> res.<span class="hljs-property">count</span> === <span class="hljs-string">'number'</span>) {
                  logger.<span class="hljs-title function_">info</span>(<span class="hljs-string">`Prisma response: <span class="hljs-subst">${propKey.toString()}</span> affected rows: <span class="hljs-subst">${res.count}</span>`</span>);
                }
                <span class="hljs-keyword">return</span> res;
              })
              .<span class="hljs-title function_">catch</span>(handlePrismaError);
          }
          <span class="hljs-keyword">return</span> result;
        } <span class="hljs-keyword">catch</span> (error) {
          <span class="hljs-keyword">return</span> <span class="hljs-title function_">handlePrismaError</span>(error <span class="hljs-keyword">as</span> <span class="hljs-title class_">Error</span>);
        }
      };
    }

    <span class="hljs-keyword">return</span> target[propKey <span class="hljs-keyword">as</span> keyof <span class="hljs-title class_">PrismaClient</span>];
  },
};

<span class="hljs-keyword">const</span> prismaProxy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(prisma, handler);
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> prismaProxy;
</code></pre>
<p><strong>使用方式</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 在 db 层使用代理后的 prisma</span>
<span class="hljs-keyword">import</span> prisma <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/prismaProxy'</span>;

<span class="hljs-comment">// 所有操作自动记录日志</span>
<span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> prisma.<span class="hljs-property">user</span>.<span class="hljs-title function_">findUnique</span>({
  <span class="hljs-attr">where</span>: { <span class="hljs-attr">user_id</span>: userId },
});
</code></pre>
<h2 data-id="heading-14">五、JWT 认证：从生成到验证</h2>
<h3 data-id="heading-15">5.1 JWT 工具封装</h3>
<p><strong>提示词</strong>：</p>
<pre><code class="hljs language-txt" lang="txt">帮我封装 JWT 工具，需要：
1. 生成 Token（带过期时间）
2. 验证 Token
3. 密码哈希和验证
4. 使用 bcryptjs 加密
</code></pre>
<p><strong>AI 生成的代码</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/utils/auth/auth.ts</span>
<span class="hljs-keyword">import</span> jwt <span class="hljs-keyword">from</span> <span class="hljs-string">'jsonwebtoken'</span>;
<span class="hljs-keyword">import</span> bcrypt <span class="hljs-keyword">from</span> <span class="hljs-string">'bcryptjs'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">TOKEN_EXPIRE_IN</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/constants'</span>;

<span class="hljs-comment">// 密码哈希</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> hashPassword = <span class="hljs-keyword">async</span> (<span class="hljs-attr">password</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; =&gt; {
  <span class="hljs-keyword">const</span> salt = <span class="hljs-keyword">await</span> bcrypt.<span class="hljs-title function_">genSalt</span>(<span class="hljs-number">10</span>);
  <span class="hljs-keyword">return</span> bcrypt.<span class="hljs-title function_">hash</span>(password, salt);
};

<span class="hljs-comment">// 密码验证</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> verifyPassword = <span class="hljs-keyword">async</span> (
  <span class="hljs-attr">password</span>: <span class="hljs-built_in">string</span>,
  <span class="hljs-attr">hashedPassword</span>: <span class="hljs-built_in">string</span>,
): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">boolean</span>&gt; =&gt; {
  <span class="hljs-keyword">return</span> bcrypt.<span class="hljs-title function_">compare</span>(password, hashedPassword);
};

<span class="hljs-comment">// 生成 JWT</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> generateJWT = (<span class="hljs-attr">userId</span>: <span class="hljs-built_in">string</span>): <span class="hljs-function"><span class="hljs-params">string</span> =&gt;</span> {
  <span class="hljs-keyword">return</span> jwt.<span class="hljs-title function_">sign</span>({ userId }, process.<span class="hljs-property">env</span>.<span class="hljs-property">JWT_SECRET</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>, {
    <span class="hljs-attr">expiresIn</span>: <span class="hljs-variable constant_">TOKEN_EXPIRE_IN</span>, <span class="hljs-comment">// 例如 '7d'</span>
  });
};

<span class="hljs-comment">// 验证 JWT</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> verifyJWT = (<span class="hljs-attr">token</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">any</span>&gt; =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    jwt.<span class="hljs-title function_">verify</span>(token, process.<span class="hljs-property">env</span>.<span class="hljs-property">JWT_SECRET</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>, <span class="hljs-function">(<span class="hljs-params">err, decoded</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (err) {
        <span class="hljs-title function_">reject</span>(err);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-title function_">resolve</span>(decoded);
      }
    });
  });
};
</code></pre>
<h3 data-id="heading-16">5.2 认证中间件</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/utils/auth/authMiddleware.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">NextApiRequest</span>, <span class="hljs-title class_">NextApiResponse</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'next'</span>;
<span class="hljs-keyword">import</span> { verifyJWT } <span class="hljs-keyword">from</span> <span class="hljs-string">'./auth'</span>;
<span class="hljs-keyword">import</span> { sendUnauthorizedResponse } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/helper/responseHelper'</span>;
<span class="hljs-keyword">import</span> { getUserById } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/db/user'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AuthenticatedRequest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">NextApiRequest</span> {
  <span class="hljs-attr">userId</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">user</span>: <span class="hljs-built_in">any</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">withAuth</span> = (<span class="hljs-params">
  handler: (req: AuthenticatedRequest, res: NextApiResponse) =&gt; <span class="hljs-built_in">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt;,
</span>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span> (<span class="hljs-attr">req</span>: <span class="hljs-title class_">NextApiRequest</span>, <span class="hljs-attr">res</span>: <span class="hljs-title class_">NextApiResponse</span>) =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 从 Header 获取 Token</span>
      <span class="hljs-keyword">const</span> authHeader = req.<span class="hljs-property">headers</span>.<span class="hljs-property">authorization</span>;
      <span class="hljs-keyword">if</span> (!authHeader || !authHeader.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'Bearer '</span>)) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">sendUnauthorizedResponse</span>(res, <span class="hljs-string">'请先登录'</span>);
      }

      <span class="hljs-keyword">const</span> token = authHeader.<span class="hljs-title function_">substring</span>(<span class="hljs-number">7</span>);

      <span class="hljs-comment">// 验证 Token</span>
      <span class="hljs-keyword">const</span> decoded = <span class="hljs-keyword">await</span> <span class="hljs-title function_">verifyJWT</span>(token);
      <span class="hljs-keyword">if</span> (!decoded || !decoded.<span class="hljs-property">userId</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">sendUnauthorizedResponse</span>(res, <span class="hljs-string">'Token 无效'</span>);
      }

      <span class="hljs-comment">// 获取用户信息</span>
      <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getUserById</span>(decoded.<span class="hljs-property">userId</span>);
      <span class="hljs-keyword">if</span> (!user) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">sendUnauthorizedResponse</span>(res, <span class="hljs-string">'用户不存在'</span>);
      }

      <span class="hljs-comment">// 注入用户信息</span>
      (req <span class="hljs-keyword">as</span> <span class="hljs-title class_">AuthenticatedRequest</span>).<span class="hljs-property">userId</span> = decoded.<span class="hljs-property">userId</span>;
      (req <span class="hljs-keyword">as</span> <span class="hljs-title class_">AuthenticatedRequest</span>).<span class="hljs-property">user</span> = user;

      <span class="hljs-comment">// 调用原始处理函数</span>
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">handler</span>(req <span class="hljs-keyword">as</span> <span class="hljs-title class_">AuthenticatedRequest</span>, res);
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">sendUnauthorizedResponse</span>(res, <span class="hljs-string">'认证失败，请重新登录'</span>);
    }
  };
};
</code></pre>
<p><strong>使用方式</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// pages/api/user/profile.ts</span>
<span class="hljs-keyword">import</span> { withAuth, <span class="hljs-title class_">AuthenticatedRequest</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/auth/authMiddleware'</span>;
<span class="hljs-keyword">import</span> { sendSuccessResponse } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/helper/responseHelper'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">NextApiResponse</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'next'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handler</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">req: AuthenticatedRequest, res: NextApiResponse</span>) =&gt; {
  <span class="hljs-comment">// req.userId 和 req.user 已经可用</span>
  <span class="hljs-title function_">sendSuccessResponse</span>(res, <span class="hljs-string">'获取成功'</span>, {
    <span class="hljs-attr">user_id</span>: req.<span class="hljs-property">userId</span>,
    <span class="hljs-attr">username</span>: req.<span class="hljs-property">user</span>.<span class="hljs-property">username</span>,
  });
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">withAuth</span>(handler);
</code></pre>
<h2 data-id="heading-17">六、统一响应格式</h2>
<h3 data-id="heading-18">6.1 响应格式设计</h3>
<p>统一的响应格式是 API 开发的基本要求。AI 帮小何设计了清晰的响应结构：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/helper/responseHelper.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">NextApiResponse</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'next'</span>;
<span class="hljs-keyword">import</span> logger <span class="hljs-keyword">from</span> <span class="hljs-string">'./logger'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">UNAUTHORIZED_TIPS</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/constants'</span>;

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">JsonResponse</span> {
  <span class="hljs-attr">code</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span>;
  data?: <span class="hljs-built_in">any</span>;
}

<span class="hljs-comment">// 通用响应</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">sendResponse</span>(<span class="hljs-params">res: NextApiResponse, code: <span class="hljs-built_in">number</span>, message: <span class="hljs-built_in">string</span>, data: <span class="hljs-built_in">any</span> = <span class="hljs-literal">null</span></span>): <span class="hljs-built_in">void</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-attr">jsonResponse</span>: <span class="hljs-title class_">JsonResponse</span> = {
    code,
    message,
    data,
  };
  res.<span class="hljs-title function_">status</span>(code).<span class="hljs-title function_">json</span>(jsonResponse);
}

<span class="hljs-comment">// 成功响应</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">sendSuccessResponse</span>(<span class="hljs-params">
  res: NextApiResponse,
  message: <span class="hljs-built_in">string</span> = <span class="hljs-string">'数据获取成功'</span>,
  data: <span class="hljs-built_in">any</span> = <span class="hljs-literal">null</span>,
</span>): <span class="hljs-built_in">void</span> {
  <span class="hljs-title function_">sendResponse</span>(res, <span class="hljs-number">200</span>, message, data);
}

<span class="hljs-comment">// 错误响应（服务器错误）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">sendErrorResponse</span>(<span class="hljs-params">res: NextApiResponse, message: <span class="hljs-built_in">string</span>, data: <span class="hljs-built_in">any</span> = <span class="hljs-literal">null</span></span>): <span class="hljs-built_in">void</span> {
  <span class="hljs-title function_">sendResponse</span>(res, <span class="hljs-number">500</span>, message, data);
  logger.<span class="hljs-title function_">error</span>(message);
  logger.<span class="hljs-title function_">error</span>(data);
}

<span class="hljs-comment">// 警告响应（业务错误）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">sendWarnningResponse</span>(<span class="hljs-params">res: NextApiResponse, message: <span class="hljs-built_in">string</span>, data: <span class="hljs-built_in">any</span> = <span class="hljs-literal">null</span></span>): <span class="hljs-built_in">void</span> {
  <span class="hljs-title function_">sendResponse</span>(res, <span class="hljs-number">503</span>, message, data);
}

<span class="hljs-comment">// 未授权响应</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">sendUnauthorizedResponse</span>(<span class="hljs-params">
  res: NextApiResponse,
  message: <span class="hljs-built_in">string</span> = UNAUTHORIZED_TIPS,
</span>): <span class="hljs-built_in">void</span> {
  <span class="hljs-title function_">sendResponse</span>(res, <span class="hljs-number">401</span>, message);
}

<span class="hljs-comment">// 方法不允许</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">sendMethodNotAllowedResponse</span>(<span class="hljs-params">
  res: NextApiResponse,
  message: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Method Not Allowed'</span>,
</span>): <span class="hljs-built_in">void</span> {
  <span class="hljs-title function_">sendResponse</span>(res, <span class="hljs-number">405</span>, message);
}
</code></pre>
<h3 data-id="heading-19">6.2 响应码设计</h3>



































<table><thead><tr><th>状态码</th><th>含义</th><th>使用场景</th></tr></thead><tbody><tr><td>200</td><td>成功</td><td>请求成功处理</td></tr><tr><td>401</td><td>未授权</td><td>Token 无效或过期</td></tr><tr><td>405</td><td>方法不允许</td><td>GET 接口收到 POST 请求</td></tr><tr><td>500</td><td>服务器错误</td><td>代码异常、数据库错误</td></tr><tr><td>503</td><td>业务警告</td><td>参数错误、业务规则不满足</td></tr></tbody></table>
<p><strong>前端统一处理</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 前端 HTTP 拦截器</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleResponse</span> = (<span class="hljs-params">response: <span class="hljs-built_in">any</span></span>) =&gt; {
  <span class="hljs-keyword">const</span> { code, message, data } = response;

  <span class="hljs-keyword">switch</span> (code) {
    <span class="hljs-keyword">case</span> <span class="hljs-number">200</span>:
      <span class="hljs-keyword">return</span> data;
    <span class="hljs-keyword">case</span> <span class="hljs-number">401</span>:
      <span class="hljs-comment">// 跳转登录</span>
      uni.<span class="hljs-title function_">reLaunch</span>({ <span class="hljs-attr">url</span>: <span class="hljs-string">'/pages/login/login'</span> });
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(message);
    <span class="hljs-keyword">case</span> <span class="hljs-number">503</span>:
      <span class="hljs-comment">// 业务警告，显示 Toast</span>
      uni.<span class="hljs-title function_">showToast</span>({ <span class="hljs-attr">title</span>: message, <span class="hljs-attr">icon</span>: <span class="hljs-string">'none'</span> });
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(message);
    <span class="hljs-keyword">case</span> <span class="hljs-number">500</span>:
      <span class="hljs-comment">// 服务器错误</span>
      uni.<span class="hljs-title function_">showToast</span>({ <span class="hljs-attr">title</span>: <span class="hljs-string">'服务器开小差了'</span>, <span class="hljs-attr">icon</span>: <span class="hljs-string">'none'</span> });
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(message);
    <span class="hljs-attr">default</span>:
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(message || <span class="hljs-string">'未知错误'</span>);
  }
};
</code></pre>
<h2 data-id="heading-20">七、微信小程序登录实现</h2>
<h3 data-id="heading-21">7.1 登录流程设计</h3>
<p>微信小程序登录是"心动恋聊"的核心功能。AI 帮小何设计了完整的登录流程：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Client as 小程序端
    participant Server as 后端服务
    participant WX as 微信服务器

    Client-&gt;&gt;Client: 1. wx.login()
    Client-&gt;&gt;Client: 2. 返回 code

    Client-&gt;&gt;Server: 3. POST /api/auth/wx-login
    Note right of Client: { code, gender, age_group }

    Server-&gt;&gt;WX: 4. jscode2session
    WX--&gt;&gt;Server: 5. 返回 openid

    Server-&gt;&gt;Server: 6. 查找/创建用户
    Server-&gt;&gt;Server: 7. 生成 JWT

    Server--&gt;&gt;Client: 8. 返回 token + userInfo
</code></pre>
<h3 data-id="heading-22">7.2 登录 API 实现</h3>
<p><strong>提示词</strong>：</p>
<pre><code class="hljs language-txt" lang="txt">帮我实现微信小程序登录 API，需要：
1. 接收 wx.login 的 code
2. 调用微信服务器获取 openid
3. 新用户需要收集性别和年龄段
4. 老用户直接返回 token
5. 支持多来源（小程序、App）
6. 记录用户来源和渠道
</code></pre>
<p><strong>AI 生成的代码</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/pages/api/auth/wx-login.ts</span>
<span class="hljs-keyword">import</span> { sendErrorResponse, sendSuccessResponse } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/helper/responseHelper'</span>;
<span class="hljs-keyword">import</span> { generateJWT } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/auth/auth'</span>;
<span class="hljs-keyword">import</span> { getUserByOpenid, createUserByOpenid } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/db/user'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">NextApiRequest</span>, <span class="hljs-title class_">NextApiResponse</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'next'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handler</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">req: NextApiRequest, res: NextApiResponse</span>) =&gt; {
  <span class="hljs-keyword">if</span> (req.<span class="hljs-property">method</span> !== <span class="hljs-string">'POST'</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">sendErrorResponse</span>(res, <span class="hljs-string">'Method Not Allowed'</span>);
  }

  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> { code, gender, age_group } = req.<span class="hljs-property">body</span>;

    <span class="hljs-comment">// 1. 调用微信服务器获取 openid</span>
    <span class="hljs-keyword">const</span> wxLoginUrl = <span class="hljs-string">`https://api.weixin.qq.com/sns/jscode2session?appid=<span class="hljs-subst">${process.env.WX_APPID}</span>&amp;secret=<span class="hljs-subst">${process.env.WX_SECRET}</span>&amp;js_code=<span class="hljs-subst">${code}</span>&amp;grant_type=authorization_code`</span>;
    <span class="hljs-keyword">const</span> wxRes = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(wxLoginUrl);
    <span class="hljs-keyword">const</span> { openid } = <span class="hljs-keyword">await</span> wxRes.<span class="hljs-title function_">json</span>();

    <span class="hljs-comment">// 2. 查找或创建用户</span>
    <span class="hljs-keyword">let</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getUserByOpenid</span>(openid);
    <span class="hljs-keyword">let</span> isNewUser = <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">if</span> (!user) {
      <span class="hljs-comment">// 新用户需要提供性别和年龄</span>
      <span class="hljs-keyword">if</span> (!gender || !age_group) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">sendSuccessResponse</span>(res, <span class="hljs-string">'需要完善信息'</span>, { <span class="hljs-attr">needsRegistration</span>: <span class="hljs-literal">true</span>, openid });
      }
      user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">createUserByOpenid</span>(openid, gender, age_group);
      isNewUser = <span class="hljs-literal">true</span>;
    }

    <span class="hljs-comment">// 3. 生成 JWT Token</span>
    <span class="hljs-keyword">const</span> token = <span class="hljs-title function_">generateJWT</span>(user.<span class="hljs-property">user_id</span>);

    <span class="hljs-comment">// 4. 返回登录结果</span>
    <span class="hljs-title function_">sendSuccessResponse</span>(res, <span class="hljs-string">'登录成功'</span>, { token, ...user, isNewUser });
  } <span class="hljs-keyword">catch</span> (<span class="hljs-attr">error</span>: <span class="hljs-built_in">any</span>) {
    <span class="hljs-title function_">sendErrorResponse</span>(res, <span class="hljs-string">'登录失败'</span>, error.<span class="hljs-property">message</span>);
  }
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> handler;
</code></pre>
<h3 data-id="heading-23">7.3 登录服务层</h3>
<p>手机号登录的服务层封装，支持密码和验证码两种方式：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/service/auth.ts</span>
<span class="hljs-keyword">import</span> { getUserByPhoneNumber } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/db/user'</span>;
<span class="hljs-keyword">import</span> { checkCodeValid } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/service/checkCodeValid'</span>;
<span class="hljs-keyword">import</span> { generateJWT, verifyPassword } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/auth/auth'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">LoginCredentials</span>, <span class="hljs-title class_">LoginResult</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'shared-types'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthServiceError</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Error</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">
    message: <span class="hljs-built_in">string</span>,
    <span class="hljs-keyword">public</span> code: <span class="hljs-built_in">string</span>,
  </span>) {
    <span class="hljs-variable language_">super</span>(message);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = <span class="hljs-string">'AuthServiceError'</span>;
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loginUser</span>(<span class="hljs-params">credentials: LoginCredentials</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">LoginResult</span>&gt; {
  <span class="hljs-keyword">const</span> { phone_number, password, verification_code } = credentials;

  <span class="hljs-comment">// 从数据库获取用户</span>
  <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getUserByPhoneNumber</span>(phone_number!);
  <span class="hljs-keyword">if</span> (!user) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AuthServiceError</span>(<span class="hljs-string">'该用户不存在，请先注册'</span>, <span class="hljs-string">'USER_NOT_FOUND'</span>);
  }

  <span class="hljs-keyword">if</span> (password) {
    <span class="hljs-comment">// 密码登录</span>
    <span class="hljs-keyword">const</span> decodedPassword = <span class="hljs-title class_">Buffer</span>.<span class="hljs-title function_">from</span>(password, <span class="hljs-string">'base64'</span>).<span class="hljs-title function_">toString</span>();
    <span class="hljs-keyword">const</span> isPasswordValid = <span class="hljs-keyword">await</span> <span class="hljs-title function_">verifyPassword</span>(decodedPassword, user.<span class="hljs-property">hashed_password</span>);
    <span class="hljs-keyword">if</span> (!isPasswordValid) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AuthServiceError</span>(<span class="hljs-string">'手机号或密码输入有误'</span>, <span class="hljs-string">'INVALID_CREDENTIALS'</span>);
    }

    <span class="hljs-keyword">if</span> (!user.<span class="hljs-property">phone_verified</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AuthServiceError</span>(
        <span class="hljs-string">'手机号未验证通过，请先使用手机号+验证码的方式登录'</span>,
        <span class="hljs-string">'PHONE_UNVERIFIED'</span>,
      );
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 验证码登录</span>
    <span class="hljs-keyword">if</span> (!verification_code) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AuthServiceError</span>(<span class="hljs-string">'请输入验证码'</span>, <span class="hljs-string">'MISSING_VERIFICATION_CODE'</span>);
    }
    <span class="hljs-keyword">const</span> { valid, msg } = <span class="hljs-title function_">checkCodeValid</span>({ user, <span class="hljs-attr">code</span>: verification_code });
    <span class="hljs-keyword">if</span> (!valid) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AuthServiceError</span>(msg, <span class="hljs-string">'INVALID_VERIFICATION_CODE'</span>);
    }

    <span class="hljs-keyword">if</span> (!user.<span class="hljs-property">phone_verified</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AuthServiceError</span>(<span class="hljs-string">'请先注册完成后再登录'</span>, <span class="hljs-string">'USER_NOT_REGISTERED'</span>);
    }
  }

  <span class="hljs-comment">// 生成 JWT</span>
  <span class="hljs-keyword">const</span> token = <span class="hljs-keyword">await</span> <span class="hljs-title function_">generateJWT</span>(user.<span class="hljs-property">user_id</span>);

  <span class="hljs-keyword">return</span> {
    user,
    token,
  };
}
</code></pre>
<h2 data-id="heading-24">八、前后端类型共享：shared-types</h2>
<h3 data-id="heading-25">8.1 为什么需要类型共享</h3>
<p>前后端分离开发时，最常见的问题是<strong>接口对不上</strong>：</p>
<pre><code class="hljs language-txt" lang="txt">后端：{ user_id: "xxx" }
前端：{ userId: "xxx" }  // 拿不到数据

后端：{ gender: 1 }
前端：{ gender: "男" }  // 类型不匹配
</code></pre>
<p>解决方案：<strong>shared-types 包</strong>。</p>
<h3 data-id="heading-26">8.2 类型定义</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// packages/shared-types/enums.ts</span>

<span class="hljs-comment">/**
 * 性别枚举
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">GenderEnum</span> {
  <span class="hljs-variable constant_">MALE</span> = <span class="hljs-number">1</span>,
  <span class="hljs-variable constant_">FEMALE</span> = <span class="hljs-number">2</span>,
}

<span class="hljs-comment">/**
 * 年龄段枚举
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">AgeGroupEnum</span> {
  <span class="hljs-variable constant_">POST_00</span> = <span class="hljs-number">1</span>,  <span class="hljs-comment">// 00后</span>
  <span class="hljs-variable constant_">POST_05</span> = <span class="hljs-number">2</span>,  <span class="hljs-comment">// 05后</span>
  <span class="hljs-variable constant_">POST_90</span> = <span class="hljs-number">3</span>,  <span class="hljs-comment">// 90后</span>
  <span class="hljs-variable constant_">POST_80</span> = <span class="hljs-number">4</span>,  <span class="hljs-comment">// 80后</span>
  <span class="hljs-variable constant_">POST_70</span> = <span class="hljs-number">5</span>,  <span class="hljs-comment">// 70后</span>
}

<span class="hljs-comment">/**
 * 年龄段枚举映射（用于显示）
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">AgeGroupMap</span> = {
  [<span class="hljs-title class_">AgeGroupEnum</span>.<span class="hljs-property">POST_00</span>]: <span class="hljs-string">'00后'</span>,
  [<span class="hljs-title class_">AgeGroupEnum</span>.<span class="hljs-property">POST_05</span>]: <span class="hljs-string">'05后'</span>,
  [<span class="hljs-title class_">AgeGroupEnum</span>.<span class="hljs-property">POST_90</span>]: <span class="hljs-string">'90后'</span>,
  [<span class="hljs-title class_">AgeGroupEnum</span>.<span class="hljs-property">POST_80</span>]: <span class="hljs-string">'80后'</span>,
  [<span class="hljs-title class_">AgeGroupEnum</span>.<span class="hljs-property">POST_70</span>]: <span class="hljs-string">'70后'</span>,
};

<span class="hljs-comment">/**
 * 客户端来源枚举
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ClientSourceEnum</span> {
  <span class="hljs-variable constant_">MP_WEIXIN</span> = <span class="hljs-number">1</span>,  <span class="hljs-comment">// 微信小程序</span>
  <span class="hljs-variable constant_">ANDROID</span> = <span class="hljs-number">2</span>,    <span class="hljs-comment">// 安卓 App</span>
  <span class="hljs-variable constant_">HARMONY</span> = <span class="hljs-number">3</span>,    <span class="hljs-comment">// 鸿蒙</span>
}
</code></pre>
<h3 data-id="heading-27">8.3 在项目中使用</h3>
<p><strong>后端使用</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// apps/xingdong-server/src/service/auth.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">LoginCredentials</span>, <span class="hljs-title class_">LoginResult</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'shared-types'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loginUser</span>(<span class="hljs-params">credentials: LoginCredentials</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">LoginResult</span>&gt; {
  <span class="hljs-comment">// 类型自动推导，IDE 智能提示</span>
}
</code></pre>
<p><strong>前端使用</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// apps/unibest-mp/src/api/auth.ts</span>
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">WxLoginParams</span>, <span class="hljs-title class_">WxLoginResult</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'shared-types'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> apiWxLogin = (<span class="hljs-attr">params</span>: <span class="hljs-title class_">WxLoginParams</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">WxLoginResult</span>&gt; =&gt; {
  <span class="hljs-keyword">return</span> http.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/api/auth/wx-login'</span>, params);
};
</code></pre>
<p><strong>package.json 配置</strong>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"shared-types"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"workspace:*"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>Next.js 配置</strong>（重要！）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// next.config.js</span>
<span class="hljs-keyword">const</span> nextConfig = {
  <span class="hljs-attr">reactStrictMode</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">transpilePackages</span>: [<span class="hljs-string">'shared-types'</span>], <span class="hljs-comment">// 编译本地 TypeScript 包</span>
};
</code></pre>
<h2 data-id="heading-28">九、日志系统：Winston 配置</h2>
<h3 data-id="heading-29">9.1 日志配置</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/helper/logger.ts</span>
<span class="hljs-keyword">import</span> winston <span class="hljs-keyword">from</span> <span class="hljs-string">'winston'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">DailyRotateFile</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'winston-daily-rotate-file'</span>;
<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'path'</span>;

<span class="hljs-comment">// 日志目录</span>
<span class="hljs-keyword">const</span> logDir = path.<span class="hljs-title function_">join</span>(process.<span class="hljs-title function_">cwd</span>(), <span class="hljs-string">'logs'</span>);

<span class="hljs-comment">// 日志格式</span>
<span class="hljs-keyword">const</span> logFormat = winston.<span class="hljs-property">format</span>.<span class="hljs-title function_">combine</span>(
  winston.<span class="hljs-property">format</span>.<span class="hljs-title function_">timestamp</span>({ <span class="hljs-attr">format</span>: <span class="hljs-string">'YYYY-MM-DD HH:mm:ss'</span> }),
  winston.<span class="hljs-property">format</span>.<span class="hljs-title function_">errors</span>({ <span class="hljs-attr">stack</span>: <span class="hljs-literal">true</span> }),
  winston.<span class="hljs-property">format</span>.<span class="hljs-title function_">printf</span>(<span class="hljs-function">(<span class="hljs-params">{ timestamp, level, message, ...meta }</span>) =&gt;</span> {
    <span class="hljs-keyword">let</span> msg = <span class="hljs-string">`<span class="hljs-subst">${timestamp}</span> [<span class="hljs-subst">${level.toUpperCase()}</span>]: <span class="hljs-subst">${message}</span>`</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(meta).<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
      msg += <span class="hljs-string">` <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(meta)}</span>`</span>;
    }
    <span class="hljs-keyword">return</span> msg;
  }),
);

<span class="hljs-comment">// 创建 logger</span>
<span class="hljs-keyword">const</span> logger = winston.<span class="hljs-title function_">createLogger</span>({
  <span class="hljs-attr">level</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">LOG_LEVEL</span> || <span class="hljs-string">'info'</span>,
  <span class="hljs-attr">format</span>: logFormat,
  <span class="hljs-attr">transports</span>: [
    <span class="hljs-comment">// 控制台输出</span>
    <span class="hljs-keyword">new</span> winston.<span class="hljs-property">transports</span>.<span class="hljs-title class_">Console</span>({
      <span class="hljs-attr">format</span>: winston.<span class="hljs-property">format</span>.<span class="hljs-title function_">combine</span>(winston.<span class="hljs-property">format</span>.<span class="hljs-title function_">colorize</span>(), logFormat),
    }),
    <span class="hljs-comment">// 按日期滚动的文件日志</span>
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">DailyRotateFile</span>({
      <span class="hljs-attr">dirname</span>: logDir,
      <span class="hljs-attr">filename</span>: <span class="hljs-string">'app-%DATE%.log'</span>,
      <span class="hljs-attr">datePattern</span>: <span class="hljs-string">'YYYY-MM-DD'</span>,
      <span class="hljs-attr">maxSize</span>: <span class="hljs-string">'20m'</span>,
      <span class="hljs-attr">maxFiles</span>: <span class="hljs-string">'14d'</span>,
    }),
    <span class="hljs-comment">// 错误日志单独存放</span>
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">DailyRotateFile</span>({
      <span class="hljs-attr">dirname</span>: logDir,
      <span class="hljs-attr">filename</span>: <span class="hljs-string">'error-%DATE%.log'</span>,
      <span class="hljs-attr">datePattern</span>: <span class="hljs-string">'YYYY-MM-DD'</span>,
      <span class="hljs-attr">level</span>: <span class="hljs-string">'error'</span>,
      <span class="hljs-attr">maxSize</span>: <span class="hljs-string">'20m'</span>,
      <span class="hljs-attr">maxFiles</span>: <span class="hljs-string">'30d'</span>,
    }),
  ],
});

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> logger;
</code></pre>
<h3 data-id="heading-30">9.2 请求日志中间件</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/utils/logRequest.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">NextApiRequest</span>, <span class="hljs-title class_">NextApiResponse</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'next'</span>;
<span class="hljs-keyword">import</span> logger <span class="hljs-keyword">from</span> <span class="hljs-string">'@/helper/logger'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">logRequest</span> = (<span class="hljs-params">req: NextApiRequest, res: NextApiResponse</span>) =&gt; {
  <span class="hljs-keyword">const</span> { method, url, body, query } = req;

  logger.<span class="hljs-title function_">info</span>(<span class="hljs-string">`API Request: <span class="hljs-subst">${method}</span> <span class="hljs-subst">${url}</span>`</span>, {
    <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(body),
    <span class="hljs-attr">query</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(query),
    <span class="hljs-attr">ip</span>: req.<span class="hljs-property">headers</span>[<span class="hljs-string">'x-forwarded-for'</span>] || req.<span class="hljs-property">socket</span>.<span class="hljs-property">remoteAddress</span>,
    <span class="hljs-attr">userAgent</span>: req.<span class="hljs-property">headers</span>[<span class="hljs-string">'user-agent'</span>],
  });

  <span class="hljs-comment">// 记录响应时间</span>
  <span class="hljs-keyword">const</span> startTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
  res.<span class="hljs-title function_">on</span>(<span class="hljs-string">'finish'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> duration = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - startTime;
    logger.<span class="hljs-title function_">info</span>(<span class="hljs-string">`API Response: <span class="hljs-subst">${method}</span> <span class="hljs-subst">${url}</span> - <span class="hljs-subst">${res.statusCode}</span> (<span class="hljs-subst">${duration}</span>ms)`</span>);
  });
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> logRequest;
</code></pre>
<h2 data-id="heading-31">十、总结与下一步</h2>
<h3 data-id="heading-32">10.1 本篇完成的工作</h3>
<p>通过 AI 辅助，我们在 <strong>约 1 小时</strong> 内完成了：</p>





































<table><thead><tr><th>任务</th><th>完成情况</th></tr></thead><tbody><tr><td>✅ Prisma 数据库设计</td><td>用户、会员、账单等核心表</td></tr><tr><td>✅ 分层架构</td><td>API → Service → DB 清晰分离</td></tr><tr><td>✅ JWT 认证</td><td>生成、验证、中间件完整实现</td></tr><tr><td>✅ 微信登录</td><td>支持小程序、App 多端登录</td></tr><tr><td>✅ 统一响应格式</td><td>responseHelper 标准化</td></tr><tr><td>✅ 类型共享</td><td>shared-types 前后端类型一致</td></tr><tr><td>✅ 日志系统</td><td>Winston 按日期滚动、分级存储</td></tr></tbody></table>
<h3 data-id="heading-33">10.2 核心提示词模板</h3>
<p><strong>数据库设计</strong>：</p>
<pre><code class="hljs language-txt" lang="txt">帮我设计 [表名] 表，需要支持：
1. [功能点 1]
2. [功能点 2]
3. [功能点 3]
使用 Prisma Schema 语法
</code></pre>
<p><strong>API 开发</strong>：</p>
<pre><code class="hljs language-txt" lang="txt">帮我实现 [功能名称] API，需要：
1. [接口功能]
2. [参数要求]
3. [返回格式]
4. [错误处理]
</code></pre>
<p><strong>工具封装</strong>：</p>
<pre><code class="hljs language-txt" lang="txt">帮我封装 [工具名称]，需要：
1. [功能点 1]
2. [功能点 2]
示例用法：[使用场景]
</code></pre>
<h3 data-id="heading-34">10.3 下一篇预告</h3>
<p><strong>《【AI 编程实战】第 4 篇：用 AI 打造原子化 CSS 开发体系 - UnoCSS 实战》</strong></p>
<p>我们将学习：</p>
<ul>
<li>UnoCSS 高级配置</li>
<li>设计稿转代码技巧</li>
<li>主题定制和换肤</li>
<li>小程序端样式优化</li>
<li>响应式布局实践</li>
</ul>
<p><strong>关注我，不错过每一篇实战干货！</strong></p>
<hr/>
<blockquote>
<p>如果这篇文章对你有帮助，请点赞、收藏、转发，让更多人了解 AI 编程的强大！</p>
<p>有任何问题，欢迎在评论区留言，我们一起讨论。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一行代码实现智能异常检测：UModel PaaS API 架构设计与最佳实践]]></title>    <link>https://juejin.cn/post/7582156219059535935</link>    <guid>https://juejin.cn/post/7582156219059535935</guid>    <pubDate>2025-12-11T03:43:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582156219059535935" data-draft-id="7581995152190586922" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一行代码实现智能异常检测：UModel PaaS API 架构设计与最佳实践"/> <meta itemprop="keywords" content="云原生"/> <meta itemprop="datePublished" content="2025-12-11T03:43:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一行代码实现智能异常检测：UModel PaaS API 架构设计与最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T03:43:49.000Z" title="Thu Dec 11 2025 03:43:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：张鑫（千乘）</p>
<p>点击<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1jS2VBJEzE%2F" target="_blank" title="https://www.bilibili.com/video/BV1jS2VBJEzE/" ref="nofollow noopener noreferrer">此处</a>，查看视频演示！</p>
<p><strong>前文回顾：</strong></p>
<p>《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247580386%26idx%3D1%26sn%3D60829abde772d4544cf2d66c1a7b81a7%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247580386&amp;idx=1&amp;sn=60829abde772d4544cf2d66c1a7b81a7&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">基于 UModel 高效构建可观测场景统一实体搜索引擎</a>》</p>
<p>《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247580174%26idx%3D1%26sn%3Ddf8ad313c69dd0157057a46b81c7ab40%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247580174&amp;idx=1&amp;sn=df8ad313c69dd0157057a46b81c7ab40&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">构建数据资产“导航地图”：详解 UModel 数据发现与全链路分析能力</a>》</p>
<p>《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247580441%26idx%3D1%26sn%3D28b760dfa51d9a5085abda9660519067%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247580441&amp;idx=1&amp;sn=28b760dfa51d9a5085abda9660519067&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">打通可观测性的“任督二脉”：实体与关系的终极融合</a>》</p>
<h2 data-id="heading-0">背景</h2>
<p>基于 UModel 构建的可观测系统，访问可观测数据需要上层应用感知 EntitySet、DataSet、Storage、Filter 等多个概念，给 UI、算法、客户等使用方带来了较高的开发和维护成本。</p>
<h3 data-id="heading-1">典型场景：查询 APM 服务的请求量指标</h3>
<p>假设上层应用需要实现查询某个 APM 服务的请求量指标，开发者需要经历以下步骤：</p>
<h4 data-id="heading-2">开发者需要了解的知识</h4>
<ol>
<li><strong>实体关联：</strong> 服务实体关联哪个 MetricSet？</li>
<li><strong>存储路由：</strong> MetricSet 使用哪个 MetricStore？Region/Project/存储名称是什么？</li>
<li><strong>字段映射：</strong> Entity 的 <code>service_id</code> 对应存储的哪个字段（如 <code>acs_arms_service_id</code>）？</li>
<li><strong>查询语法：</strong> 如何编写 PromQL 表达式 <code>rate(arms_app_requests_count_raw{...}[1m])</code>？</li>
<li><strong>SPL 拼接：</strong> 如何组装成完整的查询语句？</li>
</ol>
<h4 data-id="heading-3">完整的开发步骤</h4>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">Step</span> <span class="hljs-number">1</span>: 查询 UModel 元数据
        ↓ 找到 service EntitySet 关联的 MetricSet
        ↓ 如果 DataLink 中包含 FilterByEntity，还需根据实体数据过滤
<span class="hljs-keyword">Step</span> <span class="hljs-number">2</span>: 解析 MetricSet 配置
        ↓ 根据 StorageLink 获取底层 MetricStore 连接信息
        ↓ 获取 Region/Project/MetricStore 名称
<span class="hljs-keyword">Step</span> <span class="hljs-number">3</span>: 查看字段映射
        ↓ 从 DataLink 中获取字段映射表
        ↓ 确认 service_id → acs_arms_service_id
<span class="hljs-keyword">Step</span> <span class="hljs-number">4</span>: 构造 PromQL 表达式
        ↓ 根据指标定义拼接查询表达式
        ↓ 处理聚合规则、时间窗口
<span class="hljs-keyword">Step</span> <span class="hljs-number">5</span>: 拼接并执行查询
        ↓ 使用正确的 label 和 MetricStore
        ↓ 拼接完整的 SPL 语句并执行
</code></pre>
<p><strong>最终查询语句示例：</strong></p>
<pre><code class="hljs language-ini" lang="ini">.metricstore with(<span class="hljs-attr">region</span>=<span class="hljs-string">'cn-hangzhou'</span>, project=<span class="hljs-string">'cms-xxx'</span>, metricstore=<span class="hljs-string">'metricstore-apm'</span>)
|prom-call promql_query_range('sum by (acs_arms_service_id) (rate(arms_app_requests_count_raw{<span class="hljs-attr">acs_arms_service_id</span>=&amp;<span class="hljs-comment">#34;xxx&amp;#34;}[1m]))','1m')</span>
</code></pre>
<h3 data-id="heading-4">痛点</h3>
<h4 data-id="heading-5">痛点 1：概念复杂，学习门槛高</h4>
<p><strong>问题描述：</strong></p>
<ul>
<li>开发者必须深入理解 UModel 架构：EntitySet、DataSet、DataLink、StorageLink、Filter 等多个概念</li>
<li>需要了解 DataSet 与 Storage 的关联关系、Filter 路由逻辑、字段映射规则</li>
<li>新人上手困难，老手也容易遗漏细节</li>
</ul>
<p><strong>影响：</strong> 开发效率低，维护成本高</p>
<h4 data-id="heading-6">痛点 2：复杂场景实现困难</h4>
<p><strong>问题描述：</strong></p>
<ul>
<li>存储路由查找：需要理解多个 MetricSet 之间的选择逻辑</li>
<li>字段映射处理：Entity 字段 → 存储字段的映射规则复杂</li>
<li>过滤条件筛选：FilterByEntity 规则匹配逻辑难以掌握</li>
<li>多次查询拼接：需要多次查询元数据，再构建数据查询</li>
</ul>
<p><strong>影响：</strong> 增加代码复杂度，出错概率高</p>
<h4 data-id="heading-7">痛点 3：底层存储语法逃不掉</h4>
<p><strong>问题描述：</strong></p>
<ul>
<li>MetricSet 可能由 MetricStore 或 LogStore 实现，查询方式完全不同（PromQL vs SPL）</li>
<li>不同存储提供商（ARMS MetricStore、Aliyun Prometheus）语法有差异</li>
<li>开发者仍需精通底层查询语言</li>
</ul>
<p><strong>影响：</strong> 同样的需求需要编写不同的代码，无法统一</p>
<h4 data-id="heading-8">痛点 4：多次查询交互，效率低</h4>
<p><strong>问题描述：</strong></p>
<ul>
<li>先查询 UModel Meta 获取配置 → 再根据 Meta 查询数据</li>
<li>需要自己处理数据拼接和关联</li>
<li>每个使用方都要实现类似逻辑，代码重复度高</li>
</ul>
<p><strong>影响：</strong> 集成成本高，查询延迟大，出错概率增加</p>
<h2 data-id="heading-9">目标与架构</h2>
<h3 data-id="heading-10">设计目标</h3>
<p>针对上述四大痛点，UModel PaaS API 的设计目标是屏蔽底层复杂性，统一访问接口，使上层应用更加专注业务逻辑实现：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9984af49c44c48b0afcc31e96cfd5319~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029429&amp;x-signature=XbhGfO0hwA05cH8CwyCpYyGGoCk%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-11">核心设计原则</h4>
<ul>
<li><strong>自动化处理：</strong> 自动路由、字段映射、查询转换</li>
<li><strong>统一 SPL 语法：</strong> 所有数据类型使用一致接口</li>
<li><strong>面向对象编程：</strong> 实体方法调用、关系导航</li>
<li><strong>AI 友好：</strong> 反射能力，支持 AI Agent 自主探索</li>
</ul>
<h3 data-id="heading-12">设计理念：两层抽象</h3>
<p>访问 UModel 数据时，需要单独通过 SPL 去访问指标、日志、链路等各种数据，<strong>每种数据都有不同的访问方式，没有统一的抽象。</strong></p>
<p>UModel PaaS API 采用<strong>两层抽象</strong>的设计思路：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f8522b6f41d74dcbb3ed0282b539cb6b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029429&amp;x-signature=uGJOUpgd856GZZJcjGWoRfC6myk%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-13">第一层抽象：Table 模式（表格化抽象）</h4>
<p>将所有数据——指标、日志、链路、性能剖析——统一抽象成<strong>表格结构</strong>，所有查询都是针对表格数据进行操作。</p>
<p><strong>价值：</strong> 统一了查询语言，开发者不需要关心底层是 PromQL 还是 SLS SPL，都用同一套 SPL 语法。</p>
<h4 data-id="heading-14">第二层抽象：Object 模式（对象级抽象）</h4>
<p>表格模式解决了数据访问的统一性，但还不够。我们还需要<strong>以实体为中心</strong>的抽象。</p>
<p>传统方式：查询一个服务的指标，需要知道这个服务关联哪个 MetricSet、字段如何映射、过滤条件怎么写…</p>
<p>Object 模式：只需要说“这个服务，给我它的指标”，系统自动处理字段映射、过滤条件、存储路由。</p>
<p><strong>价值：</strong> 面向对象的思想，把实体当成对象，把查询当成方法调用：<code>service.get_metric()</code>。</p>
<h4 data-id="heading-15">第三层能力：元数据查询（反射能力）</h4>
<p>提供动态能力发现、配置验证等高级功能，让 AI Agent 可以自主探索、自主决策。</p>
<p><strong>价值：</strong> AI Agent 能够通过反射能力动态发现实体的能力边界，实现真正的智能运维。</p>
<h3 data-id="heading-16">架构分层</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2ea6c34f60146fc9b4f7abe3d714181~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029429&amp;x-signature=TAw%2BSRBwdG9e%2F7h0v48s9gQB7tk%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-17">1. 存储层统一：EntityStore/LogStore/MetricStore → SPL</h4>
<p>自动完成存储路由、字段映射（<code>service_id → acs_arms_service_id</code>）、过滤、查询语法的转换。上层应用对存储切换无感知。</p>
<h4 data-id="heading-18">2. 数据层统一：Table 模式</h4>
<p>直接访问 DataSet，声明式查询，支持完整 SPL Pipeline。</p>
<pre><code class="hljs language-ini" lang="ini">.metric_set with(<span class="hljs-attr">domain</span>=<span class="hljs-string">'apm'</span>, name=<span class="hljs-string">'service.request'</span>, query=`service_id=<span class="hljs-string">'xxxx'</span>`) | stats avg(latency)
.log_set with(<span class="hljs-attr">domain</span>=<span class="hljs-string">'apm'</span>, name=<span class="hljs-string">'service.error_log'</span> query=`service_id=<span class="hljs-string">'xxx'</span>`) | where level=&amp;<span class="hljs-comment">#34;ERROR&amp;#34;</span>
</code></pre>
<h4 data-id="heading-19">3. 对象层统一：Object 模式</h4>
<p>以实体为中心，自动处理底层细节，支持动态能力发现和配置检查。</p>
<pre><code class="hljs language-java" lang="java"># 数据访问
.entity_set <span class="hljs-title function_">with</span><span class="hljs-params">(domain=<span class="hljs-string">'apm'</span>, name=<span class="hljs-string">'apm.service'</span>, ids=[<span class="hljs-string">'404e5d6be468f6dfaeef37a014322423'</span>])</span> 
| entity-call <span class="hljs-title function_">get_metric</span><span class="hljs-params">(<span class="hljs-string">'apm'</span>, <span class="hljs-string">'apm.metric.apm.service'</span>, <span class="hljs-string">'avg_request_latency_seconds'</span>, <span class="hljs-string">'range'</span>, <span class="hljs-string">''</span>, <span class="hljs-literal">false</span>)</span> 
# 能力发现（Agent 自主决策的关键）
.entity_set <span class="hljs-title function_">with</span><span class="hljs-params">(domain=<span class="hljs-string">'apm'</span>, name=<span class="hljs-string">'service'</span>)</span> | entity-call <span class="hljs-title function_">__list_method__</span><span class="hljs-params">()</span>
# 配置检查
.entity_set <span class="hljs-title function_">with</span><span class="hljs-params">(domain=<span class="hljs-string">'apm'</span>, name=<span class="hljs-string">'service'</span>)</span> | entity-call <span class="hljs-title function_">__inspect__</span><span class="hljs-params">()</span>
</code></pre>
<h2 data-id="heading-20">API 说明</h2>
<p>UModel PaaS API 提供三大核心能力，满足不同场景的查询需求：</p>
<ol>
<li><strong>Table 模式</strong> - 直接访问数据集，适合批量数据分析</li>
<li><strong>Object 模式</strong> - 以实体为中心，适合实体详情查询和关系分析</li>
<li><strong>元数据查询</strong> - 反射能力和配置验证，支持 AI Agent 和开发调试</li>
</ol>
<h3 data-id="heading-21">Table 模式</h3>
<p>Table 模式（Phase 1）提供直接访问 DataSet（MetricSet、LogSet、TraceSet 等）的能力，返回表格化的可观测数据，适用于不依赖实体关系的数据查询场景。</p>
<p>如：直接查询某个 MetricSet 中的指标数据，或查询某个 LogSet 中的日志，无需关联实体信息。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 读取 apm.metric.apm.service MetricSet对应的avg_request_latency_seconds的指标，</span>
<span class="hljs-comment"># 并对该指标进行异常检测</span>
.metric_set with(<span class="hljs-attr">domain</span>=<span class="hljs-string">'apm'</span>, name=<span class="hljs-string">'apm.metric.apm.service'</span>, metric=<span class="hljs-string">'avg_request_latency_seconds'</span>, source=<span class="hljs-string">'metrics'</span>)
| extend <span class="hljs-attr">r</span> = series_decompose_anomalies(__value__) 
| extend <span class="hljs-attr">anomaly_b</span> =r.anomalies_score_series , anomaly_type = r.anomalies_type_series , __anomaly_msg__ = r.error_msg  
| extend <span class="hljs-attr">x</span> = zip(anomaly_b, __ts__, anomaly_type, __value__) 
| extend <span class="hljs-attr">__anomaly_rst__</span> = filter(x, x-&gt; x.field0 &gt; <span class="hljs-number">0</span>) 
| project __entity_id__, __labels__, __anomaly_rst__, __anomaly_msg__
</code></pre>
<p><strong>核心特点：</strong></p>
<ul>
<li>直接访问：直达 DataSet，无需查询实体元数据</li>
<li>语法简洁：类似 SQL 的 SPL 语法，易于理解</li>
<li>全量数据：返回 DataSet 中符合条件的所有数据</li>
</ul>
<p><strong>语法：</strong> <code>. with(domain, name, ...) | </code>，更多参数说明请参考文档：Phase 1 Table 模式 <strong>[</strong> <strong>1]</strong> 。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4fb93a3641544b08be21948d29c9578c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029429&amp;x-signature=gZd8RqKCeDb%2FNt%2FGSoQCXR4TpdE%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-22">Object 模式</h3>
<p>Object 模式（Phase 2）提供<strong>以实体为中心的面向对象查询能力</strong>，自动处理实体与数据的关联关系、字段映射、关系查询等复杂逻辑，适用于需要实体上下文的业务场景。</p>
<p>如：查询某个具体服务的指标、日志、链路数据，或查询与该服务有调用关系的其他服务，系统自动完成字段映射和数据过滤。</p>
<pre><code class="hljs language-java" lang="java"># 查询特定服务的请求延迟指标，自动处理字段映射和 FilterByEntity
.entity_set <span class="hljs-title function_">with</span><span class="hljs-params">(domain=<span class="hljs-string">'apm'</span>, name=<span class="hljs-string">'apm.service'</span>, ids=[<span class="hljs-string">'21d5ed421ae93973d67a04af551b48b8'</span>])</span> 
| entity-call <span class="hljs-title function_">get_metric</span><span class="hljs-params">(<span class="hljs-string">'apm'</span>, <span class="hljs-string">'apm.metric.apm.service'</span>, <span class="hljs-string">'avg_request_latency_seconds'</span>, <span class="hljs-string">'range'</span>, <span class="hljs-string">'30s'</span>, <span class="hljs-literal">false</span>)</span>
| project __entity_id__, __ts__, __value__, __labels__
</code></pre>
<p><strong>核心优势：</strong></p>
<ul>
<li>零配置过滤：自动处理 FilterByEntity，无需手动拼接过滤条件</li>
<li>字段映射透明：自动转换 <code>service_id → acs_arms_service_id</code> 等映射</li>
<li>面向对象语义：<code>entity.get_metric()</code>，符合开发者思维习惯</li>
</ul>
<p><strong>语法：</strong> <code>.entity_set with(domain, name, id, query) | entity-call &lt;方法&gt;(&lt;参数&gt;) | </code>，更多参数说明请参考文档：Phase 2 Object 模式 <strong>[</strong> <strong>2]</strong> 。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83198ad240004e66bbe5dddcf6e03773~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029429&amp;x-signature=ArBD9CBq0HgBRZgKIUtM9dmwx%2Fw%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-23">元数据查询方法</h3>
<p>元数据查询方法提供动态发现和反射能力，用于查询实体的关联关系、数据集配置、支持的方法等元数据信息，既可以帮助开发者理解实体能力，也是实现 AI Agent 自主决策和配置验证的关键基础。</p>
<p>如：查询某个服务实体支持哪些方法（<code>__list_method__()</code>）、关联了哪些数据集（<code>list_data_set()</code>）、与哪些其他服务有调用关系（<code>list_related_entity_set()</code>）、配置是否正确（<code>__inspect__()</code>）。</p>
<pre><code class="hljs language-xml" lang="xml"># 动态发现实体支持的所有方法（反射能力）
.entity_set with(domain='apm', name='apm.service') 
| entity-call __list_method__()
# 返回：方法列表及参数定义
# [
#   {<span class="hljs-symbol">&amp;#34;</span>name<span class="hljs-symbol">&amp;#34;</span>: <span class="hljs-symbol">&amp;#34;</span>get_metric<span class="hljs-symbol">&amp;#34;</span>, <span class="hljs-symbol">&amp;#34;</span>params<span class="hljs-symbol">&amp;#34;</span>: [...], <span class="hljs-symbol">&amp;#34;</span>description<span class="hljs-symbol">&amp;#34;</span>: <span class="hljs-symbol">&amp;#34;</span>获取指标数据<span class="hljs-symbol">&amp;#34;</span>},
#   {<span class="hljs-symbol">&amp;#34;</span>name<span class="hljs-symbol">&amp;#34;</span>: <span class="hljs-symbol">&amp;#34;</span>list_related_entity_set<span class="hljs-symbol">&amp;#34;</span>, <span class="hljs-symbol">&amp;#34;</span>params<span class="hljs-symbol">&amp;#34;</span>: [...], <span class="hljs-symbol">&amp;#34;</span>description<span class="hljs-symbol">&amp;#34;</span>: <span class="hljs-symbol">&amp;#34;</span>查询关联实体<span class="hljs-symbol">&amp;#34;</span>},
#   ...
# ]
</code></pre>
<p><strong>核心价值：</strong></p>
<ul>
<li>反射能力：<code>__list_method__()</code> 让 AI Agent 能自主探索实体的能力边界</li>
<li>配置验证：<code>__inspect__()</code> 一键检查 DataSet、Link、字段映射等配置完整性</li>
<li>关系查询：<code>list_related_entity_set()</code> 快速获取拓扑关系，无需查询图数据库</li>
<li>能力发现：<code>list_data_set()</code> 了解实体关联的所有观测数据类型</li>
</ul>
<p><strong>语法：</strong> <code>.entity_set with(domain, name, id, query) | entity-call &lt;方法&gt;(&lt;参数&gt;)</code>，更多参数说明请参考文档：Phase 2 Object 模式。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e000ccd7c30345298f37a3475cf305a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029429&amp;x-signature=WY4FkW9Q00FxIFvlgF0ighH8Wqo%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-24">查询方式</h2>
<h3 data-id="heading-25">UI 方式</h3>
<p>登录云监控 2.0 控制台，点击实体探索 -&gt; SPL，输入 SPL，如下图所示：</p>
<p><code>.entity\_set with(domain='apm', name='apm.service', ids=['21d5ed421ae93973d67a04af551b48b8']) | entity-call get_metric('apm', 'apm.metric.apm.service', 'avg_request_latency_seconds', 'range', '', false)</code></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1db886c117b54ac090901b7124d42dea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029429&amp;x-signature=2R8tjeHaOoyHZ6OwIY1UZ9sGH1k%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-26">DryRun 模式</h4>
<p>DryRun 模式返回对应的 Query，不执行当前 Query，也支持手动设置运行模式。</p>
<pre><code class="hljs language-sql" lang="sql"># 开启dry_run模式
.<span class="hljs-keyword">set</span> umodel_paas_mode<span class="hljs-operator">=</span><span class="hljs-string">'dry_run'</span>;
.entity_set <span class="hljs-keyword">with</span>(domain<span class="hljs-operator">=</span><span class="hljs-string">'apm'</span>, name<span class="hljs-operator">=</span><span class="hljs-string">'apm.service'</span>) 
<span class="hljs-operator">|</span> entity<span class="hljs-operator">-</span><span class="hljs-keyword">call</span> get_metric(<span class="hljs-string">'apm'</span>, <span class="hljs-string">'apm.metric.apm.service'</span>, <span class="hljs-string">'avg_request_latency_seconds'</span>, <span class="hljs-string">'range'</span>, <span class="hljs-string">''</span>, <span class="hljs-literal">false</span>) 
</code></pre>
<p>UI 开启 DryRun 模式：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51e1724052c64023baefe3b68d746726~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029429&amp;x-signature=7ALJIVlQpqUnJfgVAISCSI6bN2A%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-27">SDK 方式</h3>
<p>通过阿里云 OpenAPI <strong>[</strong> <strong>3]</strong> 下载 SDK，代码如下：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main
<span class="hljs-keyword">import</span> (
&amp;#<span class="hljs-number">34</span>;fmt&amp;#<span class="hljs-number">34</span>;
	cms20240330 &amp;#<span class="hljs-number">34</span>;github.com/alibabacloud-<span class="hljs-keyword">go</span>/cms<span class="hljs-number">-20240330</span>/v3/client&amp;#<span class="hljs-number">34</span>;
	openapi &amp;#<span class="hljs-number">34</span>;github.com/alibabacloud-<span class="hljs-keyword">go</span>/darabonba-openapi/v2/client&amp;#<span class="hljs-number">34</span>;
&amp;#<span class="hljs-number">34</span>;github.com/alibabacloud-<span class="hljs-keyword">go</span>/tea/tea&amp;#<span class="hljs-number">34</span>;
	credential &amp;#<span class="hljs-number">34</span>;github.com/aliyun/credentials-<span class="hljs-keyword">go</span>/credentials&amp;#<span class="hljs-number">34</span>;
&amp;#<span class="hljs-number">34</span>;os&amp;#<span class="hljs-number">34</span>;
)
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CreateClient</span><span class="hljs-params">()</span></span> (_result *cms20240330.Client, _err <span class="hljs-type">error</span>) {
	credential, _err := credential.NewCredential(<span class="hljs-literal">nil</span>)
<span class="hljs-keyword">if</span> _err != <span class="hljs-literal">nil</span> {
<span class="hljs-keyword">return</span> _result, _err
	}
	config := &amp;openapi.Config{
		Credential: credential,
	}
	config.Endpoint = tea.String(&amp;#<span class="hljs-number">34</span>;cms.cn-hangzhou.aliyuncs.com&amp;#<span class="hljs-number">34</span>;)
	_result = &amp;cms20240330.Client{}
	_result, _err = cms20240330.NewClient(config)
<span class="hljs-keyword">return</span> _result, _err
}
<span class="hljs-function"><span class="hljs-keyword">func</span> _<span class="hljs-title">main</span><span class="hljs-params">(args [ ]*<span class="hljs-type">string</span>)</span></span> (_err <span class="hljs-type">error</span>) {
	client, _err := CreateClient()
<span class="hljs-keyword">if</span> _err != <span class="hljs-literal">nil</span> {
<span class="hljs-keyword">return</span> _err
	}
	getEntityStoreDataRequest := &amp;cms20240330.GetEntityStoreDataRequest{
		Query: tea.String(&amp;#<span class="hljs-number">34</span>;.entity_set with(domain=<span class="hljs-string">'apm'</span>, name=<span class="hljs-string">'apm.service'</span>, ids=[<span class="hljs-string">'21d5ed421ae93973d67a04af551b48b8'</span>]) | entity-call get_metric(<span class="hljs-string">'apm'</span>, <span class="hljs-string">'apm.metric.apm.service'</span>, <span class="hljs-string">'avg_request_latency_seconds'</span>, <span class="hljs-string">'range'</span>) &amp;#<span class="hljs-number">34</span>;),
		From:  tea.Int32(<span class="hljs-number">1762244123</span>),
		To:    tea.Int32(<span class="hljs-number">1762244724</span>),
	}
<span class="hljs-keyword">if</span> result, err := client.GetEntityStoreData(tea.String(&amp;#<span class="hljs-number">34</span>;o11y-demo-cn-hangzhou&amp;#<span class="hljs-number">34</span>;), getEntityStoreDataRequest); err != <span class="hljs-literal">nil</span> {
<span class="hljs-keyword">return</span> err
	} <span class="hljs-keyword">else</span> {
		fmt.Printf(&amp;#<span class="hljs-number">34</span>;length: %d&amp;#<span class="hljs-number">34</span>;, <span class="hljs-built_in">len</span>(result.Body.Data))
<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
	}
}
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
	err := _main(tea.StringSlice(os.Args[<span class="hljs-number">1</span>:]))
<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
<span class="hljs-built_in">panic</span>(err)
	}
}
</code></pre>
<p>参数说明：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d51de5612664ed49b17fff454ce33d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029429&amp;x-signature=%2FqQie1WvvWGaJ9O91K%2BqXGA46VU%3D" alt="图片" loading="lazy"/></p>
<p><strong>程序运行</strong></p>
<pre><code class="hljs language-ini" lang="ini">go build -o demo .
export <span class="hljs-attr">ALIBABA_CLOUD_ACCESS_KEY_SECRET</span>=
export <span class="hljs-attr">ALIBABA_CLOUD_ACCESS_KEY_ID</span>=
./demo
</code></pre>
<h2 data-id="heading-28">示例</h2>
<h3 data-id="heading-29">集成算子实现高阶能力：UModel 高阶查询  + 时序异常检测算子</h3>
<p>通过 UModel 高阶 API 集成 SLS 时序异常检测算子 <code>series_decompose_anomalies</code>，一行查询实现智能异常检测。</p>
<p>如：监控某个 APM 服务的请求延迟，当出现异常（突刺、趋势变化、平台变化）时触发告警。</p>
<pre><code class="hljs language-java" lang="java">.entity_set <span class="hljs-title function_">with</span><span class="hljs-params">(domain=<span class="hljs-string">'apm'</span>, name=<span class="hljs-string">'apm.service'</span>, ids=[<span class="hljs-string">'21d5ed421ae93973d67a04af551b48b8'</span>])</span> 
| entity-call <span class="hljs-title function_">get_metric</span><span class="hljs-params">(<span class="hljs-string">'apm'</span>, <span class="hljs-string">'apm.metric.apm.service'</span>, <span class="hljs-string">'avg_request_latency_seconds'</span>, <span class="hljs-string">'range'</span>, <span class="hljs-string">'30s'</span>, <span class="hljs-literal">false</span>)</span> 
| <span class="hljs-type">extend</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> series_decompose_anomalies(__value__) 
| <span class="hljs-type">extend</span> <span class="hljs-variable">anomaly_b</span> <span class="hljs-operator">=</span>r.anomalies_score_series , anomaly_type = r.anomalies_type_series , __anomaly_msg__ = r.error_msg  
| <span class="hljs-type">extend</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> zip(anomaly_b, __ts__, anomaly_type, __value__) 
| <span class="hljs-type">extend</span> <span class="hljs-variable">__anomaly_rst__</span> <span class="hljs-operator">=</span> filter(x, x-&gt; x.field0 &gt; <span class="hljs-number">0</span>) 
| project __entity_id__, __labels__, __anomaly_rst__, __anomaly_msg__
</code></pre>
<p><strong>返回结果</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c2de178290ed4df987dfe6746a9d4f04~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029429&amp;x-signature=D3i7AxES%2FMbVo8kVoKF%2FbaNWDWI%3D" alt="图片" loading="lazy"/></p>
<p><strong>支持的异常类型：</strong></p>
<ul>
<li><code>SPIKE_UP / SPIKE_DOWN</code> - 向上/向下突刺</li>
<li><code>TREND_SHIFT_UP</code> / <code>TREND_SHIFT_DOWN</code> - 趋势上升/下降</li>
<li><code>LEVEL_SHIFT_UP</code> / <code>LEVEL_SHIFT_DOWN</code> - 平台上升/下降</li>
</ul>
<p>如下图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f1c630c37914bcd9eb048e611252e69~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766029429&amp;x-signature=kpBUiMYsKPfl9O%2FH%2B1HS9SHlL3I%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-30">数据互联互通：关联自定义 LogStore</h3>
<p>在实际生产环境中，业务数据往往分散在多个存储中。例如：</p>
<ul>
<li>UModel 中存储了 APM 服务的拓扑关系、指标、链路、日志</li>
<li>业务系统的自定义日志存储在独立的 LogStore 中（如订单日志、支付日志、用户行为日志）</li>
</ul>
<p>通过 UModel 高阶 API + SPL join 能力，可以<strong>打通 UModel 实体数据与自定义业务数据</strong>，实现：</p>
<ol>
<li><strong>统一视角分析：</strong> 将应用性能问题与业务日志关联分析</li>
<li><strong>快速定位问题：</strong> 从服务异常快速定位到具体业务操作</li>
<li><strong>端到端追踪：</strong> 从业务请求到技术指标的全链路分析</li>
</ol>
<p><strong>典型场景：</strong></p>
<ul>
<li>某个 APM 服务出现延迟异常 → 关联业务订单日志 → 定位到具体慢查询的订单 ID</li>
<li>某个服务的错误日志激增 → 关联用户行为日志 → 分析是哪些用户操作触发了异常</li>
<li>分析服务调用链路 → 关联业务流程日志 → 追踪完整的业务流转路径</li>
</ul>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-vbnet" lang="vbnet"># 场景：关联自定义的logstore日志信息
# SPL: 
# <span class="hljs-number">1</span>. 从业务LogStore中找到失败的traceId以及msg
.<span class="hljs-keyword">let</span> failed_log = .logstore <span class="hljs-keyword">with</span>(project=‘xxx’, logstore=‘xxxx’, query=‘*<span class="hljs-comment">') </span>
                     | project trace_id, msg;
# <span class="hljs-number">2</span>. 查询服务的Trace数据
.<span class="hljs-keyword">let</span> service_traces = .entity_set <span class="hljs-keyword">with</span>(domain=<span class="hljs-comment">'apm', name='apm.service', ids=['xxxx']) </span>
                       | entity-<span class="hljs-keyword">call</span> get_trace(‘apm‘, ’apm.trace.common’);
$failed_log | <span class="hljs-keyword">join</span> $service_traces <span class="hljs-keyword">on</span> trace_id = $service_traces.traceId |  project msg
</code></pre>
<h3 data-id="heading-31">集成 AI Agent：通过反射能力实现自主决策</h3>
<p>将 UModel PaaS API 封装为 MCP Tools <strong>[</strong> <strong>4]</strong> ，通过反射能力（<code>__list_method__()</code>）让 AI Agent 具备自主探索和决策能力，实现智能运维分析。</p>
<p>如：用户问“为什么服务响应慢？”，Agent 通过动态发现可用方法，自主完成根因分析。</p>
<pre><code class="hljs language-less" lang="less"># <span class="hljs-selector-tag">Agent</span> 首先调用 <span class="hljs-selector-tag">__list_method__</span>() 动态发现实体支持的方法
<span class="hljs-selector-class">.entity_set</span> <span class="hljs-selector-tag">with</span>(domain=<span class="hljs-string">'apm'</span>, name=<span class="hljs-string">'apm.service'</span>) 
| <span class="hljs-selector-tag">entity-call</span> <span class="hljs-selector-tag">__list_method__</span>()
# 返回示例（<span class="hljs-selector-tag">Agent</span> 根据返回的方法列表自主决策下一步操作）:
# {
#   <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">methods</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;: <span class="hljs-selector-attr">[#     {&amp;#34;name&amp;#34;: &amp;#34;get_metric&amp;#34;, &amp;#34;params&amp;#34;: [...]</span>, <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">description</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;: <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;获取指标数据<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;},
#     {<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">name</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;: <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">get_log</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;, <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">params</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;: <span class="hljs-selector-attr">[...]</span>, <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">description</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;: <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;获取日志数据<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;},
#     {<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">name</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;: <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">get_trace</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;, <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">params</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;: <span class="hljs-selector-attr">[...]</span>, <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">description</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;: <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;获取链路数据<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;},
#     {<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">name</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;: <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">list_related_entity_set</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;, <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">params</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;: <span class="hljs-selector-attr">[...]</span>, <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;<span class="hljs-selector-tag">description</span><span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;: <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;查询关联实体<span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-id">#34</span>;}
#   ]
# }
</code></pre>
<p>演示 Demo：</p>
<p>点击<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fggm8MhyGXlRjpXNwxBUmJg" target="_blank" title="https://mp.weixin.qq.com/s/ggm8MhyGXlRjpXNwxBUmJg" ref="nofollow noopener noreferrer">此处</a>，查看Demo演示！</p>
<p><strong>相关链接：</strong></p>
<p>[1] Phase 1 Table 模式</p>
<p>[2] Phase 2 Object 模式</p>
<p>[3] 阿里云 OpenAPI</p>
<p>[4] MCP Tools</p>
<p>点击<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1jS2VBJEzE%2F" target="_blank" title="https://www.bilibili.com/video/BV1jS2VBJEzE/" ref="nofollow noopener noreferrer">此处</a>，查看视频演示！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[VSCode CMake Tools 功能解析、流程与最佳实践介绍]]></title>    <link>https://juejin.cn/post/7582438809377472554</link>    <guid>https://juejin.cn/post/7582438809377472554</guid>    <pubDate>2025-12-11T11:17:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582438809377472554" data-draft-id="7582397035942690822" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="VSCode CMake Tools 功能解析、流程与最佳实践介绍"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-11T11:17:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            VSCode CMake Tools 功能解析、流程与最佳实践介绍
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T11:17:39.000Z" title="Thu Dec 11 2025 11:17:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>CMake Tools 是由 Microsoft 开发的 VS Code 扩展，其核心定位是作为 CMake 与 IDE 界面之间的桥梁，通过自动化传统命令行开发中的多步骤操作（如配置、生成、构建流程）来提升开发效率。该工具不仅提供基础的项目管理功能，还包含详细的文档支持（如 FAQ 指南）以帮助用户解决使用过程中的疑问。</p>
<p>从用户需求适配角度，CMake Tools 实现了对不同技术水平开发者的覆盖：对于新手，其提供快速入门引导简化上手流程；对于专业开发者，则支持高级配置以满足复杂项目需求。这种双重支持体系使其成为跨场景 CMake 项目开发的高效工具。</p>
<p>获取该工具的标准流程需通过 VS Code 扩展面板完成。在扩展市场搜索 "cmake" 时，需注意选择 Microsoft 官方发布的 "CMake Tools"（描述为 "Extended CMake support..."），点击界面中的 "Install" 按钮即可完成安装。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/456ffdb5fe4e4d38aab82f00ebd21360~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5LqL5ryr6LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766056659&amp;x-signature=JZPy9i2ChGZ3MpfhzP9UUaW8RTk%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>核心价值总结：通过 IDE 集成实现 CMake 工作流自动化，消除命令行操作复杂性；兼顾新手友好性与专业扩展性；与 VS Code 生态深度融合，提供一致的开发体验。</p>
</blockquote>
<h2 data-id="heading-0">核心功能模块解析</h2>
<h3 data-id="heading-1">配置模块：智能缓存生成与命令行简化</h3>
<p>配置模块是 VS Code CMake Tools 的核心组件，其核心功能在于自动化 CMake 缓存生成逻辑。传统命令行模式下，开发者需手动执行 <code>cmake -S . -B build</code> 指定源代码目录（<code>-S</code>）和构建目录（<code>-B</code>），而工具通过图形化界面将这一过程简化为三个步骤：选择工具链（如 GCC、Clang 或 MSVC）、配置构建类型（<code>CMAKE_BUILD_TYPE</code>）、设置自定义参数。缓存生成过程中，工具会自动检测项目根目录下的 <code>CMakeLists.txt</code>，并根据用户配置生成 <code>CMakeCache.txt</code>，避免了命令行输入错误导致的配置失效问题。</p>
<p>关键配置参数对项目构建结果具有直接影响，例如：</p>
<ul>
<li><code>CMAKE_BUILD_TYPE</code>：控制编译优化级别与调试信息生成，取值范围包括 Debug（无优化，含调试符号）、Release（最高优化，无调试信息）、RelWithDebInfo（优化+调试符号）和 MinSizeRel（最小体积优化）。在开发阶段选择 Debug 可显著提升调试效率，而发布版本需切换至 Release 以获得最佳性能。</li>
<li><code>CMAKE_CXX_STANDARD</code>：指定 C++ 标准版本（如 11、14、17 或 20），工具会自动校验编译器兼容性并生成相应编译参数。</li>
</ul>
<h3 data-id="heading-2">构建模块：灵活目标管理与性能优化</h3>
<p>构建模块通过「多生成器支持」和「目标选择机制」提升开发效率。工具默认集成 Ninja、Makefiles、Visual Studio 等多种生成器，其中 Ninja 生成器凭借并行编译能力成为性能优化的关键——其基于依赖关系图的任务调度可充分利用多核 CPU，较传统 Make 构建速度提升 30%~50%。开发者可通过命令面板（<code>Ctrl+Shift+P</code>）执行 <code>CMake: Build</code> 并选择特定目标（如可执行文件、静态库或自定义目标），避免全项目重新编译。</p>
<p>性能优化实践：在大型项目中，建议：</p>
<ul>
<li>启用增量构建（默认开启），仅重新编译修改过的源文件；</li>
<li>配置 <code>CMAKE_CXX_FLAGS</code> 添加编译器特定优化（如 GCC 的 <code>-O3</code> 或 Clang 的 <code>-march=native</code>）；</li>
<li>使用 <code>ctest</code> 集成测试目标，通过 <code>CMake: Run Tests</code> 一键执行单元测试。</li>
</ul>
<h3 data-id="heading-3">调试模块：双模式适配与精准参数配置</h3>
<p>调试模块支持「启动调试（Launch）」和「附加调试（Attach）」两种模式，覆盖不同开发场景：</p>
<ul>
<li><strong>Launch 模式</strong>：适用于从零启动程序，需在 <code>launch.json</code> 中配置 <code>program</code>（可执行文件路径）和 <code>args</code>（命令行参数）。例如，调试路径为 <code>${workspaceFolder}/build/app</code> 的程序并传入 <code>--config debug</code> 参数，配置示例如下：</li>
</ul>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Launch App"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"cppdbg"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"request"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"launch"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"program"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"${workspaceFolder}/build/app"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"--config"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"debug"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"stopAtEntry"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"cwd"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"${workspaceFolder}"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li><strong>Attach 模式</strong>：用于调试已运行进程，需指定进程 ID（PID）或进程名称，适用于服务端程序或后台进程调试。</li>
</ul>
<p>工具通过「变量替换机制」（如 <code>${workspaceFolder}</code>、<code>${buildType}</code>）动态适配不同构建配置，确保调试器始终关联最新编译产物。同时，集成 GDB、LLDB 等调试器提供断点管理、变量监视和调用栈分析功能，实现代码编辑与调试的无缝衔接。</p>
<hr/>
<h2 data-id="heading-4">项目开发全流程实践</h2>
<p>VSCode CMake Tools 提供了从项目创建到路径配置的完整开发闭环，以下按「创建-配置-构建-调试-路径设置」流程详解实操步骤。</p>
<h3 data-id="heading-5">创建环节：项目初始化与模板选择</h3>
<p>通过命令面板（<code>Ctrl+Shift+P</code>）调用 <code>CMake: Quick Start</code> 命令启动项目向导，根据开发需求选择模板类型：</p>
<ul>
<li><strong>Executable</strong>：适用于构建可执行程序，自动生成包含 <code>main.cpp</code> 的基础工程结构</li>
<li><strong>Library</strong>：用于创建静态/动态库，生成包含头文件和实现文件的库项目框架</li>
</ul>
<p>向导完成后将自动生成初始 <code>CMakeLists.txt</code>，包含项目名称、版本号及语言标准等基础配置。</p>
<h3 data-id="heading-6">配置环节：缓存生成与问题排查</h3>
<p>配置过程是将 <code>CMakeLists.txt</code> 转换为构建系统文件的核心步骤，操作流程如下：</p>
<ol>
<li>打开命令面板（<code>Ctrl+Shift+P</code>）输入并执行 <code>CMake: Configure</code> 命令</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5633515f8d144d279ed5ddd390988b12~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5LqL5ryr6LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766056659&amp;x-signature=lXINON7vngQAYjR8Iny4cCOS89w%3D" alt="image.png" loading="lazy"/></p>
<ol start="2">
<li>首次配置需选择编译器（如 GCC、Clang 或 MSVC），后续配置将自动沿用</li>
<li>配置结果可通过 Output 面板（<code>Ctrl+Shift+U</code> 切换）的 CMake/Build 通道查看详细日志</li>
</ol>
<p>配置失败排查指南：</p>
<ul>
<li><strong>依赖缺失</strong>：日志中出现 "Could NOT find XXX" 提示时，需通过包管理器安装对应依赖</li>
<li><strong>语法错误</strong>：<code>CMakeLists.txt</code> 存在语法问题会导致 "Parse error"，可通过 VS Code 内置 CMake 语法高亮定位错误行</li>
<li><strong>路径问题</strong>：包含非 ASCII 字符或空格的项目路径可能引发配置异常，建议使用纯英文路径</li>
</ul>
<p>配置成功后将在 <code>build</code> 目录生成缓存文件（如 <code>CMakeCache.txt</code>），修改 <code>CMakeLists.txt</code> 后需重新执行配置命令更新缓存。</p>
<h3 data-id="heading-7">构建环节：编译优化与多配置管理</h3>
<p>构建操作通过命令面板（<code>Ctrl+Shift+P</code>）调用 <code>CMake: Build</code> 命令触发，关键配置包括：</p>
<ul>
<li><strong>并行任务数设置</strong>：建议配置为 CPU 核心数的 1.5 倍（通过 <code>CMake: Set Build Parallel Level</code> 命令调整），平衡编译速度与系统负载</li>
<li><strong>多配置生成器使用</strong>：对支持多配置的生成器（如 Visual Studio、Xcode），可通过状态栏的构建类型下拉菜单（默认为 Debug）快速切换 Debug/Release/RelWithDebInfo 模式，无需重复配置</li>
</ul>
<h3 data-id="heading-8">调试环节：两种调试模式对比</h3>























<table><thead><tr><th>调试方式</th><th>适用场景</th><th>配置复杂度</th><th>参数传递方式</th></tr></thead><tbody><tr><td>快速调试</td><td>临时调试验证</td><td>低</td><td>不支持自定义参数</td></tr><tr><td>launch.json 配置</td><td>复杂调试场景</td><td>高</td><td>通过 args 字段定义</td></tr></tbody></table>
<p>args 参数传递示例（<code>launch.json</code>）：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"0.2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"configurations"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"(gdb) Launch"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"cppdbg"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"request"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"launch"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"program"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"${command:cmake.launchTargetPath}"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"--input"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"data.txt"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"--verbose"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"stopAtEntry"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"cwd"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"${workspaceFolder}"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"environment"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"externalConsole"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"MIMode"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"gdb"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-9">Include 路径设置：自动同步与手动补充</h3>
<p>头文件路径管理采用双重机制确保 IntelliSense 正常工作：</p>
<ul>
<li><strong>自动同步</strong>：CMake 配置过程中会生成 <code>compile_commands.json</code>（需在 <code>CMakeLists.txt</code> 中设置 <code>set(CMAKE_EXPORT_COMPILE_COMMANDS ON)</code>），VS Code 会自动解析该文件同步 include 路径</li>
<li><strong>手动补充</strong>：当自动同步不完整时，可通过 <code>.vscode/c_cpp_properties.json</code> 手动添加路径：</li>
</ul>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"configurations"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Linux"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"includePath"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"${workspaceFolder}/**"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"/usr/local/include"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"${workspaceFolder}/third_party/include"</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"defines"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"compilerPath"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/usr/bin/gcc"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"cStandard"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"c17"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"cppStandard"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"c++20"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">4</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<blockquote>
<p>路径优先级规则：手动配置的 <code>includePath</code> 优先级高于 <code>compile_commands.json</code> 中的路径，存在冲突时以手动配置为准</p>
</blockquote>
<hr/>
<h2 data-id="heading-10">高级特性与定制化方案</h2>
<p>VSCode CMake Tools 的高级特性体系围绕「标准化-精准控制-场景切换」构建，通过三大核心组件解决传统配置模式下的环境一致性、工具链适配与多场景切换难题。</p>
<h3 data-id="heading-11">CMake Presets：层级化配置实现团队协作标准化</h3>
<p>其核心包含：</p>
<ul>
<li><code>configurePresets</code>：定义基础构建环境（如 CMake 版本、生成器类型）</li>
<li><code>buildPresets</code>：继承配置并添加编译参数（如并行任务数）</li>
<li><code>testPresets</code>：专注测试执行策略（如测试超时设置）</li>
</ul>
<p>这种结构化配置可通过版本控制系统共享，确保团队成员使用统一的构建环境，有效消除「在我机器上能运行」的协作障碍。</p>
<h3 data-id="heading-12">工具链管理（Kits）：双轨制适配方案</h3>
<ul>
<li><strong>自动发现模式</strong>：适用于标准开发环境（如桌面端 GCC/Clang），VSCode 会扫描系统路径并识别已安装编译器</li>
<li><strong>手动定义模式</strong>：针对嵌入式开发等特殊场景，支持通过 JSON 配置文件指定交叉编译工具链。例如为 ARM 嵌入式项目配置工具链时，可在 <code>kits.json</code> 中明确定义编译器路径与目标架构：</li>
</ul>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ARM GCC Embedded"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"compilers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"C"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"arm-none-eabi-gcc"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"CXX"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"arm-none-eabi-g++"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"cmakeSettings"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"CMAKE_SYSTEM_NAME"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Generic"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"CMAKE_SYSTEM_PROCESSOR"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"arm"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-13">Variants：YAML 配置实现构建场景动态切换</h3>
<p>核心依赖「filters」和「settings」字段的协同工作。以 Debug/Release 变体为例：</p>
<ul>
<li><code>filters</code> 字段通过正则表达式匹配特定构建类型</li>
<li><code>settings</code> 字段则动态调整对应参数：Debug 变体启用 <code>-O0</code> 优化和 <code>-g</code> 调试符号，Release 变体则采用 <code>-O3</code> 优化并禁用调试信息</li>
</ul>
<p>这种机制支持跨平台开发场景，如 Windows 环境自动关联 MSVC 工具链并启用 <code>/MD</code> 运行时库，Linux 环境则切换至 GCC 并配置 <code>-fPIC</code> 位置无关代码选项，实现同一套代码库在不同操作系统间的无缝构建过渡。</p>
<blockquote>
<p>关键价值：三大特性形成互补闭环——CMake Presets 解决配置标准化问题，Kits 实现工具链精准控制，Variants 则提供场景动态适配能力。在跨平台开发中，可通过组合使用实现「一次配置，多环境构建」，显著提升多平台项目的开发效率。</p>
</blockquote>
<hr/>
<h2 data-id="heading-14">最佳实践与效率优化</h2>
<h3 data-id="heading-15">配置管理：精准控制项目构建环境</h3>
<p>CMake 配置过程中，普通 Configure 操作会基于缓存文件 incremental 更新构建系统，而 Clean Configure 则会完全清除缓存并重新生成所有配置数据。当项目中发生 <code>CMakeLists.txt</code> 结构变更（如新增子目录、修改依赖关系、变更编译器设置）时，必须执行 Clean Configure 以避免缓存污染导致的构建异常。在 VS Code 中，可通过命令面板（<code>Ctrl+Shift+P</code>）运行 <code>CMake: Delete Cache and Reconfigure</code> 实现这一操作，确保配置变更被正确应用。</p>
<h3 data-id="heading-16">构建加速：从编译到链接的全流程优化</h3>
<p>构建效率优化需从工具链选择和并行策略两方面着手。Ninja 生成器相比传统 Make 工具具有更高效的依赖解析能力和任务调度机制，在多文件项目中可减少 30%-50% 的构建时间。配置方法是在 CMake 配置时指定生成器类型，通过 <code>settings.json</code> 设置：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"cmake.generator"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Ninja"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>对于 C/C++ 项目，集成 <code>ccache</code> 编译器缓存工具可大幅减少重复编译时间。在 <code>CMakeLists.txt</code> 中添加以下配置启用 ccache：</p>
<pre><code class="hljs language-cmake" lang="cmake">find_program(CCACHE_FOUND ccache)
if(CCACHE_FOUND)
  set(CMAKE_C_COMPILER_LAUNCHER ${CCACHE_FOUND})
  set(CMAKE_CXX_COMPILER_LAUNCHER ${CCACHE_FOUND})
endif(CCACHE_FOUND)
</code></pre>
<p>并行构建配置需同时优化 CMake 和生成器层面的任务数。在 <code>settings.json</code> 中设置：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"cmake.parallelJobs"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">8</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// CMake 配置阶段并行任务数</span>
  <span class="hljs-attr">"cmake.buildArgs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"-j8"</span><span class="hljs-punctuation">]</span>  <span class="hljs-comment">// 传递给 Ninja/Make 的并行构建参数</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>建议根据 CPU 核心数设置并行任务数（通常为核心数的 1-1.5 倍），避免过度并行导致的资源竞争。</p>
<h3 data-id="heading-17">调试验证：确保调试环境与构建目标一致性</h3>
<p>调试配置失败的常见原因为调试程序路径与 CMake 目标输出路径不匹配。验证方法：首先通过 <code>CMake: Build Target</code> 确认目标已成功构建，然后在 <code>launch.json</code> 中检查 <code>"program"</code> 字段是否指向正确的可执行文件路径。对于多配置项目（如 Windows 下的 Debug/Release），需使用变量引用确保路径动态适配：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"configurations"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"(gdb) Launch"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"cppdbg"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"request"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"launch"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"program"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"${command:cmake.launchTargetPath}"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"stopAtEntry"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"cwd"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"${workspaceFolder}"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"environment"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"externalConsole"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"MIMode"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"gdb"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"setupCommands"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Enable pretty-printing for gdb"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"-enable-pretty-printing"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"ignoreFailures"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>其中 <code>${command:cmake.launchTargetPath}</code> 变量会自动解析当前激活目标的输出路径，避免手动维护路径的繁琐和错误。</p>
<h3 data-id="heading-18">IntelliSense 同步：保持代码分析与项目配置一致</h3>
<p>当 CMake 配置变更后（如新增头文件路径、修改宏定义），IntelliSense 可能因缓存未更新导致代码分析异常。手动同步方法：打开命令面板（<code>Ctrl+Shift+P</code>），运行 <code>CMake: Refresh IntelliSense</code> 命令，VS Code 会重新生成 <code>compile_commands.json</code> 并更新 C/C++ 扩展的配置。对于大型项目，可在 <code>settings.json</code> 中启用自动同步：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"cmake.autoRefreshIntelliSense"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-19">跨平台开发：实现多环境一致构建体验</h3>
<p>跨平台项目需通过「工具链文件」统一管理编译器特性、系统库路径等平台相关配置。在项目根目录创建 <code>toolchains</code> 文件夹，为不同平台编写专用工具链文件（如 <code>toolchains/linux-gcc.cmake</code>、<code>toolchains/windows-msvc.cmake</code>），然后在配置时通过命令指定：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"cmake.configureArgs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"-DCMAKE_TOOLCHAIN_FILE=toolchains/linux-gcc.cmake"</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>同时，利用 VS Code 的「工作区信任机制」保护项目安全。首次打开项目时，在弹出的「工作区信任」对话框中选择「信任文件夹并启用所有功能」，确保 CMake Tools 能正常访问项目文件和执行构建命令。对于多人协作项目，可通过 <code>settings.json</code> 共享信任配置：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"security.workspace.trust.untrustedFiles"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"open"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<blockquote>
<p>关键提示：跨平台开发中，避免在 <code>CMakeLists.txt</code> 中硬编码平台相关路径（如 <code>/usr/local/lib</code>），应使用 CMake 内置变量（如 <code>${CMAKE_INSTALL_LIBDIR}</code>）和工具链文件抽象平台差异，确保构建脚本的可移植性。</p>
</blockquote>
<hr/>
<h2 data-id="heading-20">常见问题与解决方案</h2>
<h3 data-id="heading-21">IntelliSense 异常</h3>
<ul>
<li><strong>问题现象</strong>：代码补全失效、语法高亮异常或头文件引用报错。</li>
<li><strong>根本原因</strong>：CMake 配置解析错误或构建缓存过时，导致 IntelliSense 无法正确识别项目结构。</li>
<li><strong>解决步骤</strong>：
<ol>
<li>查看 Output 日志：打开 VS Code 底部状态栏的 Output 面板，切换至 CMake/Build 频道，检查是否存在 <code>CMakeLists.txt</code> 语法错误或依赖缺失提示。</li>
<li>验证项目配置：在 CMAKE: PROJECT OUTLINE 树状视图中，确认源文件与 <code>CMakeLists.txt</code> 的关联是否正确，确保 <code>add_executable</code> 或 <code>target_link_libraries</code> 等指令配置无误。</li>
<li>重建缓存：按下 <code>Ctrl+Shift+P</code> 调出命令面板，执行 <code>CMake: Rebuild CMake Cache</code> 命令刷新配置。</li>
</ol>
</li>
</ul>
<h3 data-id="heading-22">调试配置无效</h3>
<ul>
<li><strong>问题现象</strong>：启动调试后无反应或提示「程序路径不存在」。</li>
<li><strong>根本原因</strong>：<code>launch.json</code> 中 <code>program</code> 路径未正确关联构建产物，或缺少前置构建任务。</li>
<li><strong>解决步骤</strong>：
<ol>
<li>配置 <code>program</code> 路径：在 <code>launch.json</code> 中使用变量 <code>${command:cmake.launchTargetPath}</code> 自动定位当前激活目标的可执行文件路径，避免硬编码绝对路径。</li>
<li>设置 <code>preLaunchTask</code>：添加 <code>"preLaunchTask": "CMake: build"</code> 确保调试前自动构建项目，防止因产物缺失导致启动失败。</li>
<li>验证断点位置：确保断点位于可执行代码行（如 main 函数内），而非注释或空行。</li>
</ol>
</li>
</ul>
<h3 data-id="heading-23">Include 路径错误</h3>
<ul>
<li><strong>问题现象</strong>：编译器提示 <code>fatal error: 'xxx.h' file not found</code>。</li>
<li><strong>根本原因</strong>：头文件搜索路径未被正确添加至 IntelliSense 配置。</li>
<li><strong>解决步骤</strong>：
<ul>
<li><strong>UI 配置法</strong>：打开命令面板，执行 <code>C/C++: Edit Configurations (UI)</code>，在 Include path 中添加头文件所在目录（如 <code>${workspaceFolder}/include</code>）。</li>
<li><strong>手动编辑法</strong>：直接修改 <code>.vscode/c_cpp_properties.json</code>，在 <code>configurations[0].includePath</code> 数组中添加路径，并设置 <code>"compilerPath"</code> 为实际使用的编译器路径（如 <code>C:/MinGW/bin/gcc.exe</code>）。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-24">工具状态异常</h3>
<ul>
<li><strong>问题现象</strong>：CMake 扩展无响应或命令面板中 CMake 相关命令缺失。</li>
<li><strong>根本原因</strong>：扩展缓存损坏或安装文件完整性问题。</li>
<li><strong>解决步骤</strong>：
<ol>
<li>清理缓存：执行命令 <code>CMake: Clear CMake Cache</code> 清除构建缓存，路径通常为 <code>${workspaceFolder}/build/CMakeCache.txt</code>。</li>
<li>重装扩展：在 VS Code 扩展面板中卸载 CMake Tools，重启软件后重新安装最新版本，并确保依赖的 C/C++ Extension Pack 已同步更新。</li>
</ol>
</li>
</ul>
<blockquote>
<p>排查原则：所有问题均需优先检查 Output 日志与项目配置文件，避免盲目操作。对于路径相关错误，建议使用 <code>${workspaceFolder}</code> 等变量确保跨环境兼容性。</p>
</blockquote>
<hr/>
<h2 data-id="heading-25">总结与未来展望</h2>
<p>VSCode CMake Tools 作为连接 CMake 与 VS Code 生态的关键桥梁，通过配置管理、构建执行、调试集成等核心功能模块，有效简化了 C++ 项目的开发流程。其高级特性如 CMake Presets、Kits 和 Variants 支持高度定制化的开发需求，配合最佳实践与问题解决方案，进一步提升了开发效率与项目稳定性。</p>
<h3 data-id="heading-26">未来发展方向</h3>
<ul>
<li>跨平台扩展：增强 WebAssembly 等新兴平台支持</li>
<li>团队协作优化：开发配置共享与同步机制</li>
<li>智能辅助：引入 AI 驱动的 CMake 预设生成功能</li>
</ul>
<p>随着 CMake 标准的持续迭代和社区贡献的深入，VSCode CMake Tools 将继续深化其作为 C++ 开发基础设施的价值，为开发者提供更智能、更高效的集成开发体验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kingfisher 深度指南：Swift 生态下的高性能图片处理艺术]]></title>    <link>https://juejin.cn/post/7582401182934810639</link>    <guid>https://juejin.cn/post/7582401182934810639</guid>    <pubDate>2025-12-11T15:22:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582401182934810639" data-draft-id="7582401182934794255" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kingfisher 深度指南：Swift 生态下的高性能图片处理艺术"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2025-12-11T15:22:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="sweet丶"/> <meta itemprop="url" content="https://juejin.cn/user/3227821869921646"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kingfisher 深度指南：Swift 生态下的高性能图片处理艺术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3227821869921646/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    sweet丶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-11T15:22:21.000Z" title="Thu Dec 11 2025 15:22:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言：为什么需要专门的图片加载库？</h2>
<p>在移动应用开发中，图片加载是影响用户体验的核心环节之一。一个优秀的图片加载库需要解决多个复杂问题：异步下载、内存缓存、磁盘缓存、图片解码、动画支持、列表优化等。在 Swift 生态中，Kingfisher 凭借其现代化的设计理念和卓越的性能表现，成为了 iOS/macOS 开发者的首选。</p>
<h2 data-id="heading-1">一、Kingfisher 架构设计：模块化的艺术</h2>
<h3 data-id="heading-2">核心架构分层</h3>
<p>Kingfisher 采用了清晰的分层架构设计，每个模块都有明确的职责：</p>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────┐
│               使用层 (Usage Layer)           │
│  • UIImageView/NSImageView 扩展              │
│  • SwiftUI 的 KFImage                        │
│  • 丰富的选项配置系统                         │
└─────────────────────────────────────────────┘
                     │
┌─────────────────────────────────────────────┐
│             管理层 (Manager Layer)            │
│  • KingfisherManager：全局协调者              │
│  • ImageDownloader：下载管理                  │
│  • ImageCache：缓存管理                       │
└─────────────────────────────────────────────┘
                     │
┌─────────────────────────────────────────────┐
│             处理器层 (Processor Layer)        │
│  • ImageProcessor：图片处理流水线              │
│  • ImageModifier：图片修饰器                   │
│  • FormatIndicatedCacheSerializer：序列化器   │
└─────────────────────────────────────────────┘
                     │
┌─────────────────────────────────────────────┐
│             基础层 (Foundation Layer)         │
│  • 线程安全的数据结构                         │
│  • 高效的缓存算法实现                         │
│  • 低级别的图片解码操作                       │
└─────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-3">线程安全设计</h3>
<p>Kingfisher 在多线程设计上表现卓越：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// Kingfisher 内部使用 DispatchQueue 和锁保证线程安全</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SafeContainer</span>&lt;<span class="hljs-title class_">T</span>&gt; {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> storage: <span class="hljs-type">T</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> lock: <span class="hljs-type">DispatchQueue</span>
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">asyncExecute</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">block</span>: <span class="hljs-keyword">@escaping</span> (<span class="hljs-keyword">inout</span> <span class="hljs-type">T</span>) -&gt; <span class="hljs-type">Void</span>) {
        lock.async { [<span class="hljs-keyword">weak</span> <span class="hljs-keyword">self</span>] <span class="hljs-keyword">in</span>
            <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword">self</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span> <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> }
            block(<span class="hljs-operator">&amp;</span><span class="hljs-keyword">self</span>.storage)
        }
    }
}
</code></pre>
<h2 data-id="heading-4">二、图片加载全流程深度解析</h2>
<h3 data-id="heading-5">2.1 加载流程详解</h3>
<p>Kingfisher 的图片加载遵循一个精心设计的流程：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant UI as UIImageView
    participant KM as KingfisherManager
    participant MC as MemoryCache
    participant DC as DiskCache
    participant DN as Downloader
    participant IP as ImageProcessor
    
    UI-&gt;&gt;KM: kf.setImage(with: url)
    KM-&gt;&gt;MC: 查询内存缓存
    alt 内存命中
        MC--&gt;&gt;KM: 返回缓存的ImageData
        KM--&gt;&gt;UI: 直接显示图片
    else 内存未命中
        KM-&gt;&gt;DC: 查询磁盘缓存
        alt 磁盘命中
            DC--&gt;&gt;KM: 返回磁盘数据
            KM-&gt;&gt;IP: 解码和处理图片
            IP--&gt;&gt;KM: 处理后的图片
            KM-&gt;&gt;MC: 存入内存缓存
            KM--&gt;&gt;UI: 显示图片
        else 磁盘未命中
            KM-&gt;&gt;DN: 发起网络请求
            DN--&gt;&gt;KM: 下载图片数据
            KM-&gt;&gt;IP: 解码和处理图片
            IP--&gt;&gt;KM: 处理后的图片
            KM-&gt;&gt;DC: 存入磁盘缓存
            KM-&gt;&gt;MC: 存入内存缓存
            KM--&gt;&gt;UI: 显示图片
        end
    end
</code></pre>
<h3 data-id="heading-6">2.2 渐进式下载优化</h3>
<p>Kingfisher 支持渐进式 JPEG 下载，提供流畅的用户体验：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">let</span> options: <span class="hljs-type">KingfisherOptionsInfo</span> <span class="hljs-operator">=</span> [
    .progressiveJPEG(<span class="hljs-type">ImageProgressive</span>(
        isBlur: <span class="hljs-literal">true</span>,      <span class="hljs-comment">// 是否启用模糊效果</span>
        isFastestScan: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 是否使用最快扫描</span>
        scanInterval: <span class="hljs-number">0.1</span>   <span class="hljs-comment">// 扫描间隔</span>
    ))
]

imageView.kf.setImage(with: url, options: options)
</code></pre>
<h2 data-id="heading-7">三、缓存机制的卓越实现</h2>
<h3 data-id="heading-8">3.1 三级缓存策略</h3>
<p>Kingfisher 实现了高效的三级缓存策略：</p>
<ol>
<li><strong>处理器缓存（Processed Cache）</strong>：存储处理后的图片</li>
<li><strong>原始数据缓存（Original Cache）</strong>：存储原始下载数据</li>
<li><strong>内存缓存（Memory Cache）</strong>：使用 NSCache 实现</li>
</ol>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 自定义缓存配置示例</span>
<span class="hljs-keyword">let</span> cache <span class="hljs-operator">=</span> <span class="hljs-type">ImageCache</span>(name: <span class="hljs-string">"my_cache"</span>)

<span class="hljs-comment">// 配置内存缓存</span>
cache.memoryStorage.config.totalCostLimit <span class="hljs-operator">=</span> <span class="hljs-number">1024</span> <span class="hljs-operator">*</span> <span class="hljs-number">1024</span> <span class="hljs-operator">*</span> <span class="hljs-number">100</span>  <span class="hljs-comment">// 100MB</span>
cache.memoryStorage.config.countLimit <span class="hljs-operator">=</span> <span class="hljs-number">100</span>
cache.memoryStorage.config.expiration <span class="hljs-operator">=</span> .seconds(<span class="hljs-number">600</span>)  <span class="hljs-comment">// 10分钟</span>

<span class="hljs-comment">// 配置磁盘缓存</span>
cache.diskStorage.config.sizeLimit <span class="hljs-operator">=</span> <span class="hljs-number">1024</span> <span class="hljs-operator">*</span> <span class="hljs-number">1024</span> <span class="hljs-operator">*</span> <span class="hljs-number">500</span>  <span class="hljs-comment">// 500MB</span>
cache.diskStorage.config.expiration <span class="hljs-operator">=</span> .days(<span class="hljs-number">7</span>)  <span class="hljs-comment">// 7天</span>

<span class="hljs-comment">// 使用自定义缓存</span>
<span class="hljs-type">KingfisherManager</span>.shared.defaultOptions <span class="hljs-operator">=</span> [.targetCache(cache)]
</code></pre>
<h3 data-id="heading-9">3.2 智能缓存键生成</h3>
<p>Kingfisher 的缓存键生成策略非常智能：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 默认缓存键是 URL 的绝对字符串</span>
<span class="hljs-keyword">let</span> defaultCacheKey <span class="hljs-operator">=</span> url.cacheKey

<span class="hljs-comment">// 可以添加处理器标识</span>
<span class="hljs-keyword">let</span> processor <span class="hljs-operator">=</span> <span class="hljs-type">RoundCornerImageProcessor</span>(cornerRadius: <span class="hljs-number">20</span>)
<span class="hljs-keyword">let</span> processedCacheKey <span class="hljs-operator">=</span> url.cacheKey <span class="hljs-operator">+</span> processor.identifier

<span class="hljs-comment">// 自定义缓存键</span>
imageView.kf.setImage(
    with: url,
    options: [.cacheOriginalImage],
    completionHandler: { result <span class="hljs-keyword">in</span>
        <span class="hljs-comment">// 获取缓存键</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">case</span> .success(<span class="hljs-keyword">let</span> value) <span class="hljs-operator">=</span> result {
            <span class="hljs-keyword">let</span> cacheKey <span class="hljs-operator">=</span> value.cacheKey
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"缓存键: <span class="hljs-subst">\(cacheKey)</span>"</span>)
        }
    }
)
</code></pre>
<h2 data-id="heading-10">四、高级图片处理功能</h2>
<h3 data-id="heading-11">4.1 图片处理器链</h3>
<p>Kingfisher 支持处理器链，可以按顺序应用多个处理器：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">let</span> processor <span class="hljs-operator">=</span> <span class="hljs-type">DownsamplingImageProcessor</span>(size: <span class="hljs-type">CGSize</span>(width: <span class="hljs-number">300</span>, height: <span class="hljs-number">300</span>))
<span class="hljs-operator">|&gt;</span> <span class="hljs-type">RoundCornerImageProcessor</span>(cornerRadius: <span class="hljs-number">20</span>)
<span class="hljs-operator">|&gt;</span> <span class="hljs-type">BlurImageProcessor</span>(blurRadius: <span class="hljs-number">5</span>)
<span class="hljs-operator">|&gt;</span> <span class="hljs-type">TintImageProcessor</span>(tint: .red.withAlphaComponent(<span class="hljs-number">0.3</span>))

imageView.kf.setImage(
    with: url,
    options: [.processor(processor)]
)
</code></pre>
<h3 data-id="heading-12">4.2 自定义图片处理器</h3>
<p>创建自定义处理器非常灵活：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">WatermarkProcessor</span>: <span class="hljs-title class_">ImageProcessor</span> {
    <span class="hljs-keyword">let</span> identifier: <span class="hljs-type">String</span>
    <span class="hljs-keyword">let</span> watermark: <span class="hljs-type">UIImage</span>
    
    <span class="hljs-keyword">init</span>(<span class="hljs-params">watermark</span>: <span class="hljs-type">UIImage</span>) {
        <span class="hljs-keyword">self</span>.watermark <span class="hljs-operator">=</span> watermark
        <span class="hljs-keyword">self</span>.identifier <span class="hljs-operator">=</span> <span class="hljs-string">"com.myapp.watermark"</span>
    }
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">process</span>(<span class="hljs-params">item</span>: <span class="hljs-type">ImageProcessItem</span>, <span class="hljs-params">options</span>: <span class="hljs-type">KingfisherParsedOptionsInfo</span>) -&gt; <span class="hljs-type">KFCrossPlatformImage</span>? {
        <span class="hljs-keyword">switch</span> item {
        <span class="hljs-keyword">case</span> .image(<span class="hljs-keyword">let</span> image):
            <span class="hljs-keyword">return</span> drawWatermark(on: image)
        <span class="hljs-keyword">case</span> .data:
            <span class="hljs-comment">// 如果是数据，先解码再处理</span>
            <span class="hljs-keyword">return</span> (<span class="hljs-type">DefaultImageProcessor</span>.default <span class="hljs-operator">|&gt;</span> <span class="hljs-keyword">self</span>).process(item: item, options: options)
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">drawWatermark</span>(<span class="hljs-params">on</span> <span class="hljs-params">image</span>: <span class="hljs-type">KFCrossPlatformImage</span>) -&gt; <span class="hljs-type">KFCrossPlatformImage</span> {
        <span class="hljs-comment">// 绘制水印的实现</span>
        <span class="hljs-keyword">return</span> image
    }
}
</code></pre>
<h2 data-id="heading-13">五、SwiftUI 深度集成</h2>
<h3 data-id="heading-14">5.1 KFImage 的高级用法</h3>
<p>Kingfisher 为 SwiftUI 提供了原生的 KFImage 组件：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">AdvancedImageView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-keyword">let</span> url: <span class="hljs-type">URL</span>
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">KFImage</span>(url)
            .setProcessor(
                <span class="hljs-type">DownsamplingImageProcessor</span>(size: <span class="hljs-type">CGSize</span>(width: <span class="hljs-number">200</span>, height: <span class="hljs-number">200</span>))
                <span class="hljs-operator">|&gt;</span> <span class="hljs-type">RoundCornerImageProcessor</span>(cornerRadius: <span class="hljs-number">10</span>)
            )
            .loadDiskFileSynchronously()  <span class="hljs-comment">// 同步加载磁盘缓存</span>
            .cacheMemoryOnly()  <span class="hljs-comment">// 仅缓存到内存</span>
            .fade(duration: <span class="hljs-number">0.25</span>)  <span class="hljs-comment">// 渐变动画</span>
            .onSuccess { result <span class="hljs-keyword">in</span>
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"图片加载成功: <span class="hljs-subst">\(result.cacheType)</span>"</span>)
            }
            .onFailure { error <span class="hljs-keyword">in</span>
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"图片加载失败: <span class="hljs-subst">\(error)</span>"</span>)
            }
            .placeholder { progress <span class="hljs-keyword">in</span>
                <span class="hljs-comment">// 自定义占位符，支持进度显示</span>
                <span class="hljs-type">ProgressView</span>(value: progress.fractionCompleted)
                    .progressViewStyle(<span class="hljs-type">CircularProgressViewStyle</span>())
            }
            .resizable()
            .aspectRatio(contentMode: .fit)
            .frame(width: <span class="hljs-number">200</span>, height: <span class="hljs-number">200</span>)
    }
}
</code></pre>
<h3 data-id="heading-15">5.2 动画与过渡效果</h3>
<p>Kingfisher 支持丰富的动画效果：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 配置全局动画选项</span>
<span class="hljs-type">KingfisherManager</span>.shared.defaultOptions <span class="hljs-operator">=</span> [
    .transition(.fade(<span class="hljs-number">0.3</span>)),  <span class="hljs-comment">// 300ms 淡入效果</span>
    .forceTransition  <span class="hljs-comment">// 即使从缓存加载也使用过渡效果</span>
]

<span class="hljs-comment">// 单个请求的特殊配置</span>
imageView.kf.setImage(
    with: url,
    options: [
        .transition(.flipFromLeft(<span class="hljs-number">0.5</span>)),
        .forceTransition
    ]
)
</code></pre>
<h2 data-id="heading-16">六、性能优化最佳实践</h2>
<h3 data-id="heading-17">6.1 列表性能优化</h3>
<p>在 UITableView 或 UICollectionView 中使用 Kingfisher 时，需要特别注意性能：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomTableViewCell</span>: <span class="hljs-title class_">UITableViewCell</span> {
    <span class="hljs-keyword">@IBOutlet</span> <span class="hljs-keyword">weak</span> <span class="hljs-keyword">var</span> customImageView: <span class="hljs-type">UIImageView</span>!
    
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">prepareForReuse</span>() {
        <span class="hljs-keyword">super</span>.prepareForReuse()
        <span class="hljs-comment">// 取消未完成的下载任务</span>
        customImageView.kf.cancelDownloadTask()
        <span class="hljs-comment">// 可选：设置占位图</span>
        customImageView.image <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span>
    }
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">configure</span>(<span class="hljs-params">with</span> <span class="hljs-params">url</span>: <span class="hljs-type">URL</span>) {
        <span class="hljs-keyword">let</span> options: <span class="hljs-type">KingfisherOptionsInfo</span> <span class="hljs-operator">=</span> [
            .transition(.fade(<span class="hljs-number">0.2</span>)),
            .cacheOriginalImage,  <span class="hljs-comment">// 缓存原始图片</span>
            .backgroundDecode,    <span class="hljs-comment">// 后台解码</span>
            .scaleFactor(<span class="hljs-type">UIScreen</span>.main.scale),  <span class="hljs-comment">// 适配屏幕缩放</span>
            .keepCurrentImageWhileLoading  <span class="hljs-comment">// 加载时保持当前图片</span>
        ]
        
        customImageView.kf.setImage(
            with: url,
            placeholder: <span class="hljs-type">UIImage</span>(named: <span class="hljs-string">"placeholder"</span>),
            options: options
        )
    }
}

<span class="hljs-comment">// 在 tableView 中使用预加载</span>
<span class="hljs-keyword">let</span> prefetcher <span class="hljs-operator">=</span> <span class="hljs-type">ImagePrefetcher</span>(urls: imageURLs)
prefetcher.start()

<span class="hljs-comment">// 预加载单个图片</span>
<span class="hljs-type">ImagePrefetcher</span>(urls: [url]).start()
</code></pre>
<h3 data-id="heading-18">6.2 内存管理策略</h3>
<p>Kingfisher 提供了精细的内存控制：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 监听内存警告</span>
<span class="hljs-type">NotificationCenter</span>.default.addObserver(
    forName: <span class="hljs-type">UIApplication</span>.didReceiveMemoryWarningNotification,
    object: <span class="hljs-literal">nil</span>,
    queue: .main
) { <span class="hljs-keyword">_</span> <span class="hljs-keyword">in</span>
    <span class="hljs-comment">// 清除内存缓存</span>
    <span class="hljs-type">ImageCache</span>.default.clearMemoryCache()
    
    <span class="hljs-comment">// 或者只清除过期的缓存</span>
    <span class="hljs-type">ImageCache</span>.default.cleanExpiredMemoryCache()
}

<span class="hljs-comment">// 配置内存缓存行为</span>
<span class="hljs-type">ImageCache</span>.default.memoryStorage.config.cleanInterval <span class="hljs-operator">=</span> <span class="hljs-number">60</span>  <span class="hljs-comment">// 每60秒清理一次</span>
</code></pre>
<h3 data-id="heading-19">6.3 下载优先级控制</h3>
<p>在复杂场景中，可以控制下载优先级：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 设置下载优先级</span>
<span class="hljs-keyword">let</span> highPriorityOptions: <span class="hljs-type">KingfisherOptionsInfo</span> <span class="hljs-operator">=</span> [
    .downloadPriority(<span class="hljs-type">URLSessionTask</span>.highPriority)
]

<span class="hljs-keyword">let</span> lowPriorityOptions: <span class="hljs-type">KingfisherOptionsInfo</span> <span class="hljs-operator">=</span> [
    .downloadPriority(<span class="hljs-type">URLSessionTask</span>.lowPriority)
]

<span class="hljs-comment">// 关键图片使用高优先级</span>
importantImageView.kf.setImage(with: importantURL, options: highPriorityOptions)

<span class="hljs-comment">// 非关键图片使用低优先级</span>
thumbnailImageView.kf.setImage(with: thumbnailURL, options: lowPriorityOptions)
</code></pre>
<h2 data-id="heading-20">七、监控与调试</h2>
<h3 data-id="heading-21">7.1 性能监控</h3>
<p>Kingfisher 提供了丰富的监控点：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 启用调试日志</span>
<span class="hljs-type">Logging</span>.downloader <span class="hljs-operator">=</span> .debug

<span class="hljs-comment">// 自定义监控</span>
<span class="hljs-type">ImageDownloader</span>.default.delegate <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>

<span class="hljs-keyword">extension</span> <span class="hljs-title class_">YourClass</span>: <span class="hljs-title class_">ImageDownloaderDelegate</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">imageDownloader</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">downloader</span>: <span class="hljs-type">ImageDownloader</span>, <span class="hljs-params">willDownloadImageForURL</span> <span class="hljs-params">url</span>: <span class="hljs-type">URL</span>, <span class="hljs-params">with</span> <span class="hljs-params">request</span>: <span class="hljs-type">URLRequest</span>?) {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"即将下载: <span class="hljs-subst">\(url)</span>"</span>)
    }
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">imageDownloader</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">downloader</span>: <span class="hljs-type">ImageDownloader</span>, <span class="hljs-params">didFinishDownloadingImageForURL</span> <span class="hljs-params">url</span>: <span class="hljs-type">URL</span>, <span class="hljs-params">with</span> <span class="hljs-params">response</span>: <span class="hljs-type">URLResponse</span>?, <span class="hljs-params">error</span>: <span class="hljs-type">Error</span>?) {
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> error <span class="hljs-operator">=</span> error {
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"下载失败: <span class="hljs-subst">\(error)</span>"</span>)
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"下载成功: <span class="hljs-subst">\(url)</span>"</span>)
        }
    }
}
</code></pre>
<h3 data-id="heading-22">7.2 缓存状态检查</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 检查缓存状态</span>
<span class="hljs-keyword">let</span> cache <span class="hljs-operator">=</span> <span class="hljs-type">ImageCache</span>.default

<span class="hljs-comment">// 检查是否有缓存</span>
cache.isCached(forKey: <span class="hljs-string">"cache_key"</span>) { result <span class="hljs-keyword">in</span>
    <span class="hljs-keyword">switch</span> result {
    <span class="hljs-keyword">case</span> .memory:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"存在内存缓存"</span>)
    <span class="hljs-keyword">case</span> .disk:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"存在磁盘缓存"</span>)
    <span class="hljs-keyword">case</span> .none:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"无缓存"</span>)
    }
}

<span class="hljs-comment">// 获取缓存大小</span>
cache.calculateDiskStorageSize { result <span class="hljs-keyword">in</span>
    <span class="hljs-keyword">switch</span> result {
    <span class="hljs-keyword">case</span> .success(<span class="hljs-keyword">let</span> size):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"磁盘缓存大小: <span class="hljs-subst">\(Double(size) <span class="hljs-operator">/</span> <span class="hljs-number">1024</span> <span class="hljs-operator">/</span> <span class="hljs-number">1024</span>)</span> MB"</span>)
    <span class="hljs-keyword">case</span> .failure(<span class="hljs-keyword">let</span> error):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"计算缓存大小失败: <span class="hljs-subst">\(error)</span>"</span>)
    }
}
</code></pre>
<h2 data-id="heading-23">八、高级场景解决方案</h2>
<h3 data-id="heading-24">8.1 动图（GIF）支持</h3>
<p>Kingfisher 对动图提供了完整的支持：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 加载并播放 GIF</span>
imageView.kf.setImage(
    with: gifURL,
    options: [
        .processor(<span class="hljs-type">DefaultImageProcessor</span>.default),  <span class="hljs-comment">// 默认处理器支持 GIF</span>
        .cacheSerializer(<span class="hljs-type">FormatIndicatedCacheSerializer</span>.gif)  <span class="hljs-comment">// 指定 GIF 序列化器</span>
    ]
)

<span class="hljs-comment">// 控制 GIF 播放</span>
imageView.kf.setImage(with: gifURL) { result <span class="hljs-keyword">in</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">case</span> .success(<span class="hljs-keyword">let</span> value) <span class="hljs-operator">=</span> result {
        <span class="hljs-comment">// 手动控制动画</span>
        value.image.kf.startAnimating()
        
        <span class="hljs-comment">// 或者停止动画</span>
        value.image.kf.stopAnimating()
    }
}

<span class="hljs-comment">// 限制 GIF 内存使用</span>
<span class="hljs-keyword">let</span> options: <span class="hljs-type">KingfisherOptionsInfo</span> <span class="hljs-operator">=</span> [
    .onlyLoadFirstFrame,  <span class="hljs-comment">// 只加载第一帧，减少内存占用</span>
    .preloadAllAnimationData  <span class="hljs-comment">// 预加载所有动画数据</span>
]
</code></pre>
<h3 data-id="heading-25">8.2 图片编辑与处理</h3>
<p>Kingfisher 支持图片的实时编辑：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 创建可编辑的图片视图</span>
<span class="hljs-keyword">let</span> imageEditor <span class="hljs-operator">=</span> <span class="hljs-type">ImageEditorView</span>()

<span class="hljs-comment">// 应用多个编辑操作</span>
imageEditor.applyFilter(.blur(radius: <span class="hljs-number">2</span>))
imageEditor.applyFilter(.contrast(<span class="hljs-number">1.2</span>))
imageEditor.applyFilter(.saturation(<span class="hljs-number">0.8</span>))

<span class="hljs-comment">// 获取编辑后的图片</span>
<span class="hljs-keyword">let</span> editedImage <span class="hljs-operator">=</span> imageEditor.outputImage

<span class="hljs-comment">// 保存编辑结果到缓存</span>
<span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> editedImage <span class="hljs-operator">=</span> editedImage,
   <span class="hljs-keyword">let</span> url <span class="hljs-operator">=</span> originalURL {
    <span class="hljs-type">ImageCache</span>.default.store(editedImage, forKey: url.cacheKey <span class="hljs-operator">+</span> <span class="hljs-string">"_edited"</span>)
}
</code></pre>
<h3 data-id="heading-26">8.3 自定义下载器</h3>
<p>对于特殊需求，可以自定义下载器：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 创建自定义下载器</span>
<span class="hljs-keyword">let</span> customDownloader <span class="hljs-operator">=</span> <span class="hljs-type">ImageDownloader</span>(name: <span class="hljs-string">"custom"</span>)
customDownloader.downloadTimeout <span class="hljs-operator">=</span> <span class="hljs-number">30</span>  <span class="hljs-comment">// 30秒超时</span>
customDownloader.sessionConfiguration.httpMaximumConnectionsPerHost <span class="hljs-operator">=</span> <span class="hljs-number">1</span>  <span class="hljs-comment">// 每个主机1个连接</span>

<span class="hljs-comment">// 使用自定义下载器</span>
imageView.kf.setImage(
    with: url,
    options: [.downloader(customDownloader)]
)

<span class="hljs-comment">// 添加自定义请求修改器</span>
<span class="hljs-keyword">let</span> modifier <span class="hljs-operator">=</span> <span class="hljs-type">AnyModifier</span> { request <span class="hljs-keyword">in</span>
    <span class="hljs-keyword">var</span> r <span class="hljs-operator">=</span> request
    r.setValue(<span class="hljs-string">"Bearer token"</span>, forHTTPHeaderField: <span class="hljs-string">"Authorization"</span>)
    <span class="hljs-keyword">return</span> r
}

imageView.kf.setImage(
    with: url,
    options: [.requestModifier(modifier)]
)
</code></pre>
<h2 data-id="heading-27">九、扩展性与自定义</h2>
<h3 data-id="heading-28">9.1 插件系统</h3>
<p>Kingfisher 支持插件扩展：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 创建自定义插件</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">AnalyticsPlugin</span>: <span class="hljs-title class_">ImagePlugin</span> {
    <span class="hljs-keyword">var</span> identifier: <span class="hljs-type">String</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"com.myapp.analytics"</span>
    }
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">willDownloadImage</span>(<span class="hljs-params">for</span> <span class="hljs-params">url</span>: <span class="hljs-type">URL</span>, <span class="hljs-params">options</span>: <span class="hljs-type">KingfisherParsedOptionsInfo</span>) {
        <span class="hljs-type">Analytics</span>.track(event: <span class="hljs-string">"image_will_download"</span>, properties: [<span class="hljs-string">"url"</span>: url.absoluteString])
    }
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">didDownloadImage</span>(<span class="hljs-params">for</span> <span class="hljs-params">url</span>: <span class="hljs-type">URL</span>, <span class="hljs-params">result</span>: <span class="hljs-type">Result</span>&lt;<span class="hljs-type">ImageLoadingResult</span>, <span class="hljs-type">KingfisherError</span>&gt;, <span class="hljs-params">options</span>: <span class="hljs-type">KingfisherParsedOptionsInfo</span>) {
        <span class="hljs-keyword">switch</span> result {
        <span class="hljs-keyword">case</span> .success:
            <span class="hljs-type">Analytics</span>.track(event: <span class="hljs-string">"image_download_success"</span>, properties: [<span class="hljs-string">"url"</span>: url.absoluteString])
        <span class="hljs-keyword">case</span> .failure(<span class="hljs-keyword">let</span> error):
            <span class="hljs-type">Analytics</span>.track(event: <span class="hljs-string">"image_download_failed"</span>, properties: [
                <span class="hljs-string">"url"</span>: url.absoluteString,
                <span class="hljs-string">"error"</span>: error.localizedDescription
            ])
        }
    }
}

<span class="hljs-comment">// 使用插件</span>
<span class="hljs-keyword">let</span> plugin <span class="hljs-operator">=</span> <span class="hljs-type">AnalyticsPlugin</span>()
imageView.kf.setImage(
    with: url,
    options: [.plugin(plugin)]
)
</code></pre>
<h3 data-id="heading-29">9.2 自定义缓存序列化器</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">EncryptedCacheSerializer</span>: <span class="hljs-title class_">CacheSerializer</span> {
    <span class="hljs-keyword">let</span> encryptionKey: <span class="hljs-type">String</span>
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">data</span>(<span class="hljs-params">with</span> <span class="hljs-params">image</span>: <span class="hljs-type">KFCrossPlatformImage</span>, <span class="hljs-params">original</span>: <span class="hljs-type">Data</span>?) -&gt; <span class="hljs-type">Data</span>? {
        <span class="hljs-comment">// 加密图片数据</span>
        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> data <span class="hljs-operator">=</span> image.kf.data(format: .unknown) <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span> }
        <span class="hljs-keyword">return</span> encrypt(data: data, key: encryptionKey)
    }
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">image</span>(<span class="hljs-params">with</span> <span class="hljs-params">data</span>: <span class="hljs-type">Data</span>, <span class="hljs-params">options</span>: <span class="hljs-type">KingfisherParsedOptionsInfo</span>) -&gt; <span class="hljs-type">KFCrossPlatformImage</span>? {
        <span class="hljs-comment">// 解密图片数据</span>
        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> decryptedData <span class="hljs-operator">=</span> decrypt(data: data, key: encryptionKey),
              <span class="hljs-keyword">let</span> image <span class="hljs-operator">=</span> <span class="hljs-type">KFCrossPlatformImage</span>(data: decryptedData) <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
        }
        <span class="hljs-keyword">return</span> image
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">encrypt</span>(<span class="hljs-params">data</span>: <span class="hljs-type">Data</span>, <span class="hljs-params">key</span>: <span class="hljs-type">String</span>) -&gt; <span class="hljs-type">Data</span>? {
        <span class="hljs-comment">// 实现加密逻辑</span>
        <span class="hljs-keyword">return</span> data
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">decrypt</span>(<span class="hljs-params">data</span>: <span class="hljs-type">Data</span>, <span class="hljs-params">key</span>: <span class="hljs-type">String</span>) -&gt; <span class="hljs-type">Data</span>? {
        <span class="hljs-comment">// 实现解密逻辑</span>
        <span class="hljs-keyword">return</span> data
    }
}

<span class="hljs-comment">// 使用自定义序列化器</span>
<span class="hljs-keyword">let</span> serializer <span class="hljs-operator">=</span> <span class="hljs-type">EncryptedCacheSerializer</span>(encryptionKey: <span class="hljs-string">"my_secret_key"</span>)
imageView.kf.setImage(
    with: url,
    options: [.cacheSerializer(serializer)]
)
</code></pre>
<h2 data-id="heading-30">十、总结</h2>
<p>Kingfisher 作为 Swift 生态中最优秀的图片加载库之一，其成功源于多个方面：</p>
<ol>
<li><strong>现代化的 Swift 设计</strong>：充分利用 Swift 语言特性，提供类型安全的 API</li>
<li><strong>卓越的性能表现</strong>：三级缓存策略、后台解码、智能预加载等优化</li>
<li><strong>完整的平台支持</strong>：iOS、macOS、watchOS、tvOS 全平台支持</li>
<li><strong>强大的扩展性</strong>：插件系统、自定义处理器、序列化器等</li>
<li><strong>优秀的社区生态</strong>：活跃的维护、丰富的文档、大量的第三方扩展</li>
</ol>
<p>在实际项目中，建议：</p>
<ul>
<li>根据应用场景合理配置缓存策略</li>
<li>在列表视图中使用 <code>prepareForReuse</code> 取消未完成的任务</li>
<li>利用预加载提升用户体验</li>
<li>监控缓存大小和性能指标</li>
<li>根据业务需求自定义处理器和插件</li>
</ul>
<p>Kingfisher 不仅是一个图片加载库，更是 Swift 最佳实践的体现。通过深入理解其设计理念和实现细节，开发者可以构建出高性能、高可靠性的图片处理解决方案。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[第1章 世界静默，键盘独鸣]]></title>    <link>https://juejin.cn/post/7582601349579620352</link>    <guid>https://juejin.cn/post/7582601349579620352</guid>    <pubDate>2025-12-12T08:15:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582601349579620352" data-draft-id="7582769411993337908" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 第1章 世界静默，键盘独鸣"/> <meta itemprop="keywords" content="Redis"/> <meta itemprop="datePublished" content="2025-12-12T08:15:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端一课"/> <meta itemprop="url" content="https://juejin.cn/user/1169536102963917"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             第1章 世界静默，键盘独鸣
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1169536102963917/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端一课
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T08:15:39.000Z" title="Fri Dec 12 2025 08:15:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">第1章 世界静默，键盘独鸣</h2>
<p>褚云帆是被一阵刺耳的警报声吵醒的。</p>
<p>那声音像是用生锈的锯子切割金属，尖锐得能刺穿耳膜。他猛地从工位上抬起头，后颈传来一阵僵硬的酸痛——昨晚又通宵了。</p>
<p>眼前的世界模糊了几秒。</p>
<p>他习惯性地伸手去摸眼镜，手指触到冰凉的镜架。戴上。</p>
<p>视野清晰起来。</p>
<p>然后他愣住了。</p>
<p>深蓝科技开放式办公区的景象，和他记忆中任何一次加班后的清晨都不同。</p>
<p>太吵了。</p>
<p>不是键盘敲击声——那种清脆规律的“咔嗒咔嗒”早就消失了。取而代之的是一片混乱的、毫无节奏的敲打声，像是幼儿园小朋友在胡乱拍打玩具琴。</p>
<p>褚云帆揉了揉酸涩的眼睛。</p>
<p>他看见左侧工位的李工。</p>
<p>李工是公司十年的老程序员，秃顶，脾气暴躁，但代码写得极稳。此刻他正对着屏幕，双手悬在键盘上方，手指微微颤抖。他的嘴唇在动，好像在默念什么咒语。</p>
<p>然后他按下一个键。</p>
<p>“a”。</p>
<p>屏幕上跳出一个字母。</p>
<p>李工盯着那个“a”，额头渗出细密的汗珠。他深吸一口气，又按下一个键。</p>
<p>“s”。</p>
<p>“d”。</p>
<p>“f”。</p>
<p>他像是在玩打字游戏，但打出来的字母毫无意义。asdfasdfasdf——一行行重复的字符在屏幕上滚动。</p>
<p>“不对……”李工喃喃自语，“循环……for循环该怎么写来着？”</p>
<p>他的手指悬在键盘上，迟迟落不下去。</p>
<p>好像有什么东西卡住了。</p>
<p>褚云帆转过头。</p>
<p>整个办公区两百多个工位，所有人都在做同样的事——对着键盘发呆，然后敲出乱七八糟的字符。有人试图写注释，打出来的却是“#￥%……&amp;*（）”。有人想定义变量，屏幕上出现的是“int a = ;;;;;;;;;”。</p>
<p>分号。</p>
<p>无数个分号。</p>
<p>像是某种集体癔症。</p>
<p>“谁能写个循环？！”</p>
<p>一声咆哮从过道传来。</p>
<p>主管老王站在走廊中央，四十多岁的中年男人，此刻脸涨得通红。他手里举着一台平板电脑，屏幕上是半截代码——看起来像是某个脚本的开头，但语法完全错了。</p>
<p>“就一个简单的for循环！”老王的声音在发抖，“迭代数组！打印数字！这他妈是实习生第一天就该会的东西！”</p>
<p>没人回应。</p>
<p>只有键盘的胡乱敲击声。</p>
<p>老王走到最近的一个工位，抢过员工的键盘。他深吸一口气，手指放在键盘上。</p>
<p>然后僵住了。</p>
<p>他的嘴唇在动，好像在回忆什么。几秒钟后，他开始敲击。</p>
<p>for (i = 0; i &lt; 10; i++)</p>
<p>打到“i++”时，他停住了。</p>
<p>“加加……”老王盯着屏幕，“是i++还是++i？前置和后置有什么区别来着？”</p>
<p>他想了五秒钟。</p>
<p>然后删掉了整行。</p>
<p>重新打。</p>
<p>for (int i = 0; i &lt; 10; i = i + 1)</p>
<p>这次语法对了。</p>
<p>但老王盯着那行代码，眼神空洞。他好像不记得接下来该写什么了。大括号？语句块？打印函数？</p>
<p>他的手在颤抖。</p>
<p>最终，他敲下一个分号，结束了这行代码。</p>
<p>for (int i = 0; i &lt; 10; i = i + 1);</p>
<p>一个空循环。</p>
<p>毫无意义。</p>
<p>老王把键盘扔回桌上，发出“砰”的一声。他环顾四周，眼神里第一次出现了褚云帆从未见过的情绪。</p>
<p>恐惧。</p>
<p>“你们……”老王的声音低了下来，“你们都忘了吗？”</p>
<p>没人回答。</p>
<p>褚云帆低下头，看向自己的屏幕。</p>
<p>他的终端还开着。昨晚通宵重构的那个模块，代码还停留在编辑器中。三百多行，结构清晰，注释完整，是他花了六个小时精心打磨的。</p>
<p>他下意识地滚动鼠标。</p>
<p>代码正常显示。</p>
<p>没有乱码。</p>
<p>他愣了一下。</p>
<p>然后，几乎是出于本能——程序员的本能，那种写完代码总要测试一下的本能——他新建了一个文件。</p>
<p>手指放在键盘上。</p>
<p>肌肉记忆开始工作。</p>
<p>他甚至没有思考，指尖就动了起来。敲击声清脆、连贯、有节奏，和周围那片混乱的噪音形成鲜明对比。</p>
<p>print('Hello World')</p>
<p>回车。</p>
<p>屏幕下方，终端窗口弹出。</p>
<p>清晰的白色字体显示在黑色背景上：</p>
<p>Hello World</p>
<p>成功了。</p>
<p>褚云帆盯着那行字，看了三秒钟。</p>
<p>然后他猛地抬起头。</p>
<p>办公室里突然安静了。</p>
<p>不知道从什么时候开始，所有人都停下了手里的动作。键盘声消失了。说话声消失了。连呼吸声都好像变轻了。</p>
<p>两百多双眼睛，齐刷刷地看向他。</p>
<p>那些眼神很复杂。</p>
<p>有困惑。</p>
<p>有茫然。</p>
<p>但更多的是……一种褚云帆无法理解的东西。像是原始人看到同部落的人突然徒手生起了火。像是中世纪农民看到邻居念出了恶魔的文字。</p>
<p>怪物。</p>
<p>他们在看一个怪物。</p>
<p>褚云帆的后背瞬间被冷汗浸湿。</p>
<p>他几乎是条件反射地按下Ctrl+A，然后Delete。屏幕上的代码消失了。终端窗口关闭了。他抬起头，脸上挤出一个和周围人同样困惑的表情。</p>
<p>“怎么了？”他问，声音有点干涩，“你们……都看着我干嘛？”</p>
<p>没人说话。</p>
<p>李工张了张嘴，好像想说什么，但最终只是摇了摇头，转回了自己的屏幕。</p>
<p>老王盯着褚云帆看了几秒，眼神里的恐惧慢慢变成了怀疑。但他也没说什么，只是转身走回了自己的办公室，重重关上了门。</p>
<p>警报声还在响。</p>
<p>但已经没人管了。</p>
<p>褚云帆坐在工位上，心脏狂跳。他强迫自己深呼吸，一次，两次。手指在桌子下面微微颤抖。</p>
<p>不对劲。</p>
<p>太不对劲了。</p>
<p>他打开浏览器，点开新闻网站。</p>
<p>首页全是乱码。</p>
<p>不，不是乱码——是各种语法的碎片。中文里夹杂着英文单词，英文句子里混着编程语言的符号。像是整个网站的渲染引擎崩了。</p>
<p>他刷新。</p>
<p>还是这样。</p>
<p>他换了个网站。</p>
<p>同样的情况。</p>
<p>最终，他在一个极简的纯文本论坛上，看到了一条还能勉强阅读的消息：</p>
<p>【紧急通知：全球范围内出现未知技术故障。编程语言理解能力普遍异常。建议所有技术人员停止操作，等待进一步通知。】</p>
<p>下面跟了几百条回复。</p>
<p>“我连Hello World都写不出来了……”</p>
<p>“变量是什么？函数是什么？我好像做了个梦，梦里我会写代码，但醒来全忘了。”</p>
<p>“不是忘了！是脑子转不动！我看到for这个单词，知道它是循环，但就是想不起来该怎么用！”</p>
<p>“全球性的？不只是我们公司？”</p>
<p>“不只是我们国家。我刚问了国外的朋友，一样。”</p>
<p>褚云帆一条条往下翻。</p>
<p>手指越来越冷。</p>
<p>中午十二点，公司强制断网。</p>
<p>广播里传来行政总监的声音，听起来很疲惫：“全体同事请注意，接上级通知，即刻起停止所有技术相关工作。请大家……保持冷静。等待进一步安排。”</p>
<p>办公区一片死寂。</p>
<p>没人动。</p>
<p>大家就坐在工位上，盯着黑屏的显示器，或者盯着自己的手。好像只要多看一会儿，那些丢失的技能就会回来。</p>
<p>褚云帆站起来，走向茶水间。</p>
<p>路过李工工位时，他瞥了一眼屏幕。</p>
<p>李工在写文档。</p>
<p>用中文。</p>
<p>“如何打开终端：第一步，找到屏幕左下角的开始菜单。第二步，点击。第三步，在搜索框里输入‘cmd’。第四步……”</p>
<p>他写得很慢。</p>
<p>每一个字都要想很久。</p>
<p>好像这不是常识，而是某种需要详细记录的秘密知识。</p>
<p>茶水间里，几个同事在低声说话。</p>
<p>“你还能记得多少？”</p>
<p>“我……我记得if是判断。else是否则。但具体怎么写，我脑子里一片空白。”</p>
<p>“我也是。就好像有人把我大脑里关于编程的那部分，整个挖掉了。”</p>
<p>“不是挖掉。”另一个声音说，“是蒙上了一层雾。你知道雾后面有东西，但就是看不清。”</p>
<p>褚云帆接了一杯水。</p>
<p>水温很正常。</p>
<p>但他喝下去的时候，感觉喉咙发干。</p>
<p>下午两点，公司宣布提前下班。</p>
<p>“基础设施不稳定，”老王在群里发消息，“交通系统可能受影响，大家早点回家。”</p>
<p>没人欢呼。</p>
<p>大家沉默地收拾东西，沉默地离开工位。动作都很慢，好像还在消化今天发生的一切。</p>
<p>褚云帆背起包，走进电梯。</p>
<p>电梯里有六个人。</p>
<p>没人说话。</p>
<p>大家盯着楼层数字，眼神空洞。</p>
<p>电梯下到一楼，“叮”的一声开门。</p>
<p>褚云帆走出去，然后停住了脚步。</p>
<p>大厦外的景象，比他想象的更糟。</p>
<hr/>
<p>街道上，红绿灯在胡乱闪烁。</p>
<p>不是故障的那种闪烁——是毫无规律。红灯亮0.5秒，绿灯亮2秒，黄灯亮0.1秒，然后又跳回红灯。三个灯有时候会同时亮起，发出刺眼的光。</p>
<p>十字路口堵成了一团。</p>
<p>自动驾驶汽车停在路中间，有的在缓慢地原地转圈，有的在前后轻微挪动，像是失去了方向的昆虫。一辆公交车的电子屏上滚动着乱码，司机试图手动操作，但方向盘好像锁死了。</p>
<p>人行道上，人们拿着手机，脸上都是茫然。</p>
<p>“地图用不了了……”</p>
<p>“叫车软件显示服务器错误。”</p>
<p>“连扫码支付都不行了！刚才买瓶水，扫了五分钟都没反应！”</p>
<p>褚云帆站在大厦门口，看着这一切。</p>
<p>阳光很好。</p>
<p>天空很蓝。</p>
<p>但世界好像突然变成了一个劣质的、漏洞百出的程序。每一个模块都在报错，每一个函数都在崩溃。</p>
<p>他抬起左手，看了一眼手腕上的表。</p>
<p>那是一块老旧的电子表，表盘不是数字，而是一行不断跳动的代码。</p>
<p>是他自己改装的。</p>
<p>表盘上显示着：</p>
<p><code>while (true) { display_time(); sleep(1000); }</code></p>
<p>一个无限循环，每秒刷新一次时间。</p>
<p>此刻，代码正常滚动。</p>
<p>时间正常显示。</p>
<p>14:37:05。</p>
<p>褚云帆盯着那行代码，看了很久。</p>
<p>然后他抬起头，看向街道对面。</p>
<p>那里有一家咖啡馆，橱窗上贴着二维码，旁边写着“扫码点单，享受优惠”。一个年轻人正拿着手机对着二维码，反复调整角度，表情越来越烦躁。</p>
<p>“怎么扫不出来啊……”年轻人嘟囔。</p>
<p>褚云帆知道为什么。</p>
<p>扫码程序底层依赖图像识别库，识别库依赖算法，算法依赖代码。</p>
<p>代码写不出来了。</p>
<p>所以识别库无法更新，算法无法优化，程序最终会随着设备老化而逐渐失效。</p>
<p>就像现在。</p>
<p>就像整个世界。</p>
<p>他深吸一口气，把袖子拉下来，盖住手表。</p>
<p>然后迈开脚步，走进混乱的街道。</p>
<p>回家的路原本只需要二十分钟。</p>
<p>今天他走了一个小时。</p>
<p>因为要避开所有依赖智能调度的路口，要绕开那些在原地打转的自动驾驶汽车，要小心突然乱闪的交通信号灯。</p>
<p>路上，他看到了更多细节。</p>
<p>一家银行的ATM机，屏幕蓝屏，显示着一串错误代码。几个人围在旁边，试图理解那些代码的意思，但显然失败了。</p>
<p>一个外卖机器人卡在路边绿化带里，轮子空转，扬声器里反复播放：“路径规划错误，请稍候……路径规划错误，请稍候……”</p>
<p>便利店门口，电子广告牌上本该播放促销视频的区域，现在显示着一行行调试信息：</p>
<p><code>Segmentation fault (core dumped)</code></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[10GB vs 600MB：我们弃用 GitLab，选择了这个轻量级神器]]></title>    <link>https://juejin.cn/post/7582637280217858102</link>    <guid>https://juejin.cn/post/7582637280217858102</guid>    <pubDate>2025-12-12T08:17:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582637280217858102" data-draft-id="7582535649276821545" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="10GB vs 600MB：我们弃用 GitLab，选择了这个轻量级神器"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-12T08:17:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="勇哥Java实战"/> <meta itemprop="url" content="https://juejin.cn/user/3693987061329080"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            10GB vs 600MB：我们弃用 GitLab，选择了这个轻量级神器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3693987061329080/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    勇哥Java实战
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T08:17:45.000Z" title="Fri Dec 12 2025 08:17:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近在开发一个类似魔搭（ModelScope）的AI 模型托管平台，需要为每个项目提供独立的仓库服务。</p>
<p>最初的方案选择了业界熟知的 GitLab ，但很快就遇到了瓶颈：仅仅是基础的代码托管功能，GitLab全套服务（主进程、PostgreSQL 和 Redis ）在运行一段时间后，内存占用一度逼近 10GB。这对于我们的轻量级项目需求而言，无疑是一个难以承受的“资源黑洞”。</p>
<p><strong>最后我们选择了 Gitea 这个轻量级的自托管 Git 解决方案——它不仅将内存占用从10GB降低到 600MB左右，更重要的是提供了完整的API接口，让我们可以深度集成到自己的 AI 平台中。</strong></p>
<p>本文将带你快速使用 <strong>Docker 部署 Gitea</strong>，并演示如何创建仓库，以及如何通过 Gitea <strong>REST API</strong> 实现业务定制 。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bfec6295f82444c39f92a2fbe5eab738~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YuH5ZOlSmF2YeWunuaImA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766132265&amp;x-signature=mGJNmP47KuVhKFKq6m%2F098dSi88%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">1 部署前置准备</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3afac8ccd99b4d1383d7e4257f4999f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YuH5ZOlSmF2YeWunuaImA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766132265&amp;x-signature=3wLGgxxqjVcjibWBrJh2GHlduWY%3D" alt="" loading="lazy"/></p>

























<table><thead><tr><th>组件</th><th>是否必须</th><th>用途说明</th></tr></thead><tbody><tr><td><strong>数据库（MySQL / PostgreSQL / SQLite）</strong></td><td>✅ 必须</td><td>存储核心业务数据：用户、仓库、Issue、PR、权限、LFS 元信息等</td></tr><tr><td><strong>S3 / MinIO（对象存储）</strong></td><td>➖ 可选</td><td>用于存储仓库附件、LFS 大文件；没有时使用本地磁盘</td></tr><tr><td><strong>Redis</strong></td><td>➖ 可选</td><td>用作缓存、Session、队列后台，提升性能</td></tr></tbody></table>
<p>gitea 支持 sqlite 、mysql8 、pg12 ，因为 sqlite 只支持单进程/线程写，性能极差。</p>
<p>因为笔者使用 MySQL 最多也最熟悉，所以我们选择前置安装 MySQL 8 。安装完 MySQL 后 ，在数据库中新建数据库 gitea （此时，gitea 数据库并没有任何表）。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c709f0fd8e104b86bec5492677c38dd7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YuH5ZOlSmF2YeWunuaImA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766132265&amp;x-signature=nAlJuvPLI%2BzIZkXtRzal3s1%2F3mU%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">2 Docker 安装 Gitea</h2>
<p>接下来，运行如下命令，使用 Docker 安装 Gitea 。</p>
<pre><code class="hljs language-bash" lang="bash">docker run -d --name gitea \
-p 3000:3000 -p 222:22 \
-v /Users/zhangyong/docker/gitea/data:/data \
-v /etc/localtime:/etc/localtime:ro \
-v /etc/timezone:/etc/timezone:ro \
-e USER_UID=1000 \
-e USER_GID=1000 \
--restart always \
gitea/gitea:latest
</code></pre>
<p>安装完后第一次访问页面 <a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A3000" target="_blank" title="http://localhost:3000" ref="nofollow noopener noreferrer">http://localhost:3000</a> :</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/466b6ec6e6724cfdb2e20666e49ab49e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YuH5ZOlSmF2YeWunuaImA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766132265&amp;x-signature=0krxtc0OhgZn53EUdjmRSOvb6Rk%3D" alt="" loading="lazy"/></p>
<p>如图，我们配置了 数据库 Gitea ，然后点击立即安装 。</p>
<blockquote>
<p>配置选项将写入以下位置: /data/gitea/conf/app.ini</p>
</blockquote>
<p>安装完成之后，界面如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eea9a20d8f07490e9f9a402b38c50208~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YuH5ZOlSmF2YeWunuaImA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766132265&amp;x-signature=kZcSoRRJK4JeJjJ4lsOVsDufaVM%3D" alt="" loading="lazy"/></p>
<p>注册完 root 账号后，进入首页：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27619bddd35c47e6bd84e6a9c699460c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YuH5ZOlSmF2YeWunuaImA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766132265&amp;x-signature=CnVDxOI8fttr3NDZvIZS0VvWHWs%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">3 新建仓库</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70af6a7b9ec24426a192fc5289bc170f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YuH5ZOlSmF2YeWunuaImA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766132265&amp;x-signature=11sdf08WbvvzNUQQC977rUqWZNY%3D" alt="" loading="lazy"/></p>
<p>如图，创建仓库的界面和 Github 类似，输入仓库名，即可创建成功：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c5045d4b9654b33bd8f1adfcff1fe0d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YuH5ZOlSmF2YeWunuaImA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766132265&amp;x-signature=6M6ypGZh0dKcTJ3kwo33g20EPyQ%3D" alt="" loading="lazy"/></p>
<p>当我们想克隆 或者 推送仓库时，需要创建用户的 pat （ Access Token ）。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7cd25975bd8b4a2e9575a12c8996ee0d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YuH5ZOlSmF2YeWunuaImA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766132265&amp;x-signature=X3YNR68eZJezjSYSILpjeFNpVac%3D" alt="" loading="lazy"/></p>
<p>创建成功后，界面如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e09cc254670b4c859d49f04aa2a4770c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YuH5ZOlSmF2YeWunuaImA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766132265&amp;x-signature=0WOSJS9CGLii2MBr338zRpLUpVA%3D" alt="" loading="lazy"/></p>
<p>我们将令牌保存好，在克隆仓库时，或者 push 仓库时，需要使用该令牌。</p>
<h2 data-id="heading-3">4 调用 API</h2>
<p>如图，当我们访问：<a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A3000%2Fapi%2Fswagger%23%2Frepository" target="_blank" title="http://localhost:3000/api/swagger#/repository" ref="nofollow noopener noreferrer">http://localhost:3000/api/swagger#/repository</a> , 可以查看所有的 Gitea 开发 API 。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a942402ba7b54d9fad44bb24aaa56422~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YuH5ZOlSmF2YeWunuaImA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766132265&amp;x-signature=aHaNzvEVNB1f24p3gNK9wgU9tdA%3D" alt="" loading="lazy"/></p>
<p>如图，我们可以将所有的 Gitea API 封装成如下的 Java 服务：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29db174249ce4d3dba8292f8b0c7f604~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YuH5ZOlSmF2YeWunuaImA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766132265&amp;x-signature=KbRkA7gNh5Y4aho0cHmdMkx1FVY%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">5 总结</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/63cc142b758947578080af8fd3e2e6b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YuH5ZOlSmF2YeWunuaImA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766132265&amp;x-signature=IMQ023ID0EcudPdN69KIBnjwj%2B4%3D" alt="" loading="lazy"/></p>
<p>上图是笔者调研 Gitea 和 GItlab 的对比图，相比之下 ，Gitea 真是轻量级神器 ，能够完美适配公司业务的需求。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从JS云函数到MCP：打造跨平台AI Agent工具的工程实践]]></title>    <link>https://juejin.cn/post/7582599972950982683</link>    <guid>https://juejin.cn/post/7582599972950982683</guid>    <pubDate>2025-12-12T08:43:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582599972950982683" data-draft-id="7582422818311372851" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从JS云函数到MCP：打造跨平台AI Agent工具的工程实践"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-12T08:43:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="哔哩哔哩技术"/> <meta itemprop="url" content="https://juejin.cn/user/3030701626893405"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从JS云函数到MCP：打造跨平台AI Agent工具的工程实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3030701626893405/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    哔哩哔哩技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T08:43:39.000Z" title="Fri Dec 12 2025 08:43:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>构建 AI 工具生态这件事上，过去一年我们做了不少尝试。</p>
<p>回头看，会觉得这条路径像是在搭建一条越来越清晰的“能力生产线”：</p>
<blockquote>
<p>从写 JS → Agent Tool 工具 → 成为 MCP 工具 → 成为跨平台 Agent 能力。</p>
</blockquote>
<p>这篇文章我们就按这条演进路线，把底层逻辑、踩坑经验和最终的工程方案完整讲清楚。</p>
<h2 data-id="heading-0"><strong>一、先做简单介绍</strong></h2>
<p>我们做了一个“在线 JS 云函数平台”，它的本质是：把写一个 JS 函数，变成给 AI 赋予一个 Tool 新能力。</p>
<p>这套系统经历了三个阶段：</p>
<p><strong>1.  第一版：</strong> 只是 Flowise 里的一个 LangChain StructuredTool 扩展，能在工作流里被 Agent 调用。</p>
<blockquote>
<p><strong>Flowise</strong>（<em><a href="https://link.juejin.cn?target=https%3A%2F%2Fflowiseai.com%2F" target="_blank" title="https://flowiseai.com/" ref="nofollow noopener noreferrer">flowiseai.com/</a></em> ） 是一款开源、可视化的 AI 工作流工具，通过拖拽节点即可构建 LLM 应用或 Agent。它底层基于 LangChain 的 TypeScript 版本，因此天然具备模型调用、工具调用、链式处理、记忆与向量检索等能力。</p>
<p>当时我们在技术选型时使用 Flowise 做AI工作流平台有两个原因：</p>
<p>一是它基于 LangChain 的 TypeScript 版本——在早期 AI 框架还不成熟时，这是少数原生支持 TS 的方案；二是它提供了可拖拽的可视化工作流，能让我们快速搭建和验证 AI 原型。</p>
</blockquote>
<p><strong>2.  第二版：</strong> 演进为一个浏览器里的 云函数 IDE：在线写代码、调试、沙箱运行时、连内网 gRPC/HTTP/MySQL。</p>
<p><strong>3.  现在：</strong> 接上 MCP 协议，变成一个可以被「任何支持 MCP 的 Agent / Studio」跨平台调用的独立工具平台，并支持 SSE + Streamable HTTP 两种流式协议。</p>
<h2 data-id="heading-1"><strong>二、为什么我们需要“AI 工具能力层”？</strong></h2>
<p>在我们内部构建 AI 应用（客服、直播运营助手等）时，遇到几个非常典型的痛点。</p>
<h3 data-id="heading-2"><strong>1. 工具很多，但每接一次 AI，都要重写一遍工具</strong></h3>
<ul>
<li>想让 AI 查开播状态、查卡顿、查稿件、给用户发通知……</li>
<li>后端能力其实都有，但每接一个新智能体，就要：</li>
</ul>

<ul>
<li>在某个项目里再写一遍调用代码</li>
<li>手动写结构化参数 / 返回值</li>
<li>校验、鉴权</li>
</ul>

<ul>
<li>每个团队都重新写一遍</li>
</ul>
<h3 data-id="heading-3"><strong>2. AI 需要的是“能力”，而不是“接口”</strong></h3>
<p>业务接口往往是这样的：</p>
<pre><code class="hljs language-ini" lang="ini">GET /room/info?<span class="hljs-attr">roomid</span>=<span class="hljs-number">123</span>
</code></pre>
<p>但是用户却会说：“查一下imzerooo开播状态”</p>
<p>这中间的自然语言 → 参数的语义映射，很难靠简单规则完成。</p>
<p>如果让开发者直接暴露接口，AI 是很难用好的。</p>
<h3 data-id="heading-4"><strong>3. JSON 不是 AI 友好的输入格式</strong></h3>
<p>内网接口通常返回一大坨 JSON。LLM 解析 JSON 没问题，但：</p>
<ul>
<li>
<p>字段多、嵌套深 → 容易丢字段</p>
</li>
<li>
<p>字段名杂乱 → 模型记不住</p>
</li>
<li>
<p>文本内容多 → 容易产生幻觉</p>
</li>
</ul>
<p>AI 友好的格式是：</p>
<ul>
<li>Markdown 表格</li>
<li>简洁的自然语言</li>
<li>提炼过的信息</li>
</ul>
<p>而不是整包 JSON。</p>
<h3 data-id="heading-5"><strong>4. 工具没有做成“资产层”</strong></h3>
<p>以前的工具要么：</p>
<ul>
<li>绑死在某个 AI 工作流上</li>
<li>埋在某个项目里</li>
<li>放在某个业务脚本中</li>
</ul>
<p>无法像资产一样复用。</p>
<p>所以一切问题的核心其实是：</p>
<blockquote>
<p>缺少一个可以写工具、管理工具、发布工具、复用工具的统一能力层。</p>
</blockquote>
<p>而我们做的，就是让这件事：<strong>只需写一段 JS 函数</strong>。</p>
<h2 data-id="heading-6"><strong>三、第一版：StructuredTool——</strong> <strong>工具能力的萌芽</strong></h2>
<p>最初我们是在 Flowise 里写 StructuredTool 组件。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72ced04a48494603918827c4122ede20~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOU5ZOp5ZOU5ZOp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766133819&amp;x-signature=XtYbdQtaGdZM%2FUDGapbs6%2FslHaY%3D" alt="图片" loading="lazy"/></p>
<p>Flowise 底层基于 LangChain，所以我们写了很多 StructuredTool：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4c02f6d395f04297a837fc8d5cc1a732~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOU5ZOp5ZOU5ZOp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766133819&amp;x-signature=QEbEADudVWccw550Eu1boTTu7bo%3D" alt="截屏2025-12-12 15.43.12.png" loading="lazy"/></p>
<p>这一版有几个优点：</p>
<ul>
<li>
<p>工具能被 Agent 调用</p>
</li>
<li>
<p>参数有 schema</p>
</li>
<li>
<p>有一定的模块化</p>
</li>
</ul>
<p>但有几个局限：</p>
<ul>
<li>
<p>工具生命周期跟 Flowise 项目绑死</p>
</li>
<li>
<p>要写 TS、写 Node 项目，对效率很不友好</p>
</li>
<li>
<p>无法跨平台使用</p>
</li>
<li>
<p>JSON 处理还是要自己写</p>
</li>
<li>
<p>无法注入通用能力（如内网 SDK）</p>
</li>
</ul>
<p>于是我们开始考虑平台化。</p>
<h2 data-id="heading-7"><strong>四、第二版：在线 JS 云函数平台（NodeVM 运行时）</strong></h2>
<p>我们打造了一套全新的平台：在线 JS 云函数平台。</p>
<p>开发者不需要知道 Flowise、LangChain，也不用开Node 项目。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/222439794fe443fdae66e2b1fe4dc93d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOU5ZOp5ZOU5ZOp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766133819&amp;x-signature=m9boE%2FVLT8PyKrzwBwNFjhVuAg4%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-8"><strong>4.1 NodeVM：一个安全可控的 JS 执行沙箱</strong></h3>
<p>我们基于 vm2（NodeVM）做了一个“可控的 JS 执行环境”。</p>
<ul>
<li>
<p>运行时基于 StructureTool</p>
</li>
<li>
<p>NodeVM 作为安全隔离的执行环境</p>
</li>
<li>
<p>自动注入企业内部能力（统一上下文能力层）</p>
</li>
</ul>

<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/** 
 * 核心思路抽象版 
 */</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">NodeVM</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vm2'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">StructuredTool</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@langchain/core/tools'</span>
<span class="hljs-comment">//...</span>

classDynamicToolextendsStructuredTool { 
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">{ name, description, schema, code }</span>) { 
    <span class="hljs-variable language_">super</span>({ name, description, schema }) 
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">code</span> = code <span class="hljs-comment">// 用户在在线编辑器里写的 JS 代码 </span>
  }
  
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">_call</span>(<span class="hljs-params">args, runManager, flowContext</span>) {
    <span class="hljs-comment">// 1. 构建沙箱（所有注入能力都放在这里） </span>
    <span class="hljs-keyword">const</span> sandbox = { 
      <span class="hljs-comment">// 用户传入的参数转成 $xxx</span>
      ...<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">fromEntries</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(args).<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">[k, v]</span>) =&gt;</span> [<span class="hljs-string">`$<span class="hljs-subst">${k}</span>`</span>, v])),
      
      <span class="hljs-comment">// 内部上下文（cookie/env/session） </span>
      <span class="hljs-attr">$flow</span>: flowContext,  
      <span class="hljs-attr">$cookie</span>: flowContext.<span class="hljs-property">cookie</span>,
      
      <span class="hljs-comment">// 内网能力封装（gRPC/HTTP） </span>
      <span class="hljs-attr">$yuumi</span>: yuumi,
      
      <span class="hljs-comment">// 结果转换工具（用于把 JSON 转成更 AI 友好的 Markdown 表格）  </span>
      <span class="hljs-attr">$json2MarkdownTable</span>: json2MarkdownTable,
      
      <span class="hljs-comment">// 内部 AI 模型     </span>
      <span class="hljs-attr">$biliLLM</span>: biliLLMClient  
    }
    
    <span class="hljs-comment">// 2. 构建 NodeVM 沙箱 </span>
    <span class="hljs-keyword">const</span> vm = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NodeVM</span>({ 
      sandbox,   
      <span class="hljs-attr">console</span>: <span class="hljs-string">"inherit"</span>,    
      <span class="hljs-attr">require</span>: {      
        <span class="hljs-attr">builtin</span>: allowedBuiltinDeps,    
        <span class="hljs-attr">external</span>: allowedExternalDeps  
      }
    })
    
    <span class="hljs-comment">// 3. 执行开发者写的云函数代码 </span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> vm.<span class="hljs-title function_">run</span>(   
      <span class="hljs-string">`module.exports = async () =&gt; { <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.code}</span> }()`</span>,   
      __dirname   
    ) 
  }
}
</code></pre>
<p>它既能隔离风险，又能注入能力：</p>
<ul>
<li>
<p>禁止访问文件系统</p>
</li>
<li>
<p>禁止随意 require</p>
</li>
<li>
<p>只开放白名单依赖</p>
</li>
<li>
<p>内置 $yuumi（内网 gRPC/HTTP 调用）</p>
</li>
<li>
<p>内置 $json2MarkdownTable</p>
</li>
<li>
<p>内置 $cookie</p>
</li>
<li>
<p>内置 $flow（上下文）</p>
</li>
<li>
<p>内置 内部 AI 能力</p>
</li>
</ul>
<p>于是开发者传入的业务代码类似这样：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ed89f9e732048ab8bf56270f1d81638~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOU5ZOp5ZOU5ZOp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766133819&amp;x-signature=pdpqv7yiItuQv7bBXc%2FJTPLjNaw%3D" alt="截屏2025-12-12 16.15.57.png" loading="lazy"/></p>
<h3 data-id="heading-9"><strong>4.2 在线调试：monaco-editor+ Mock</strong> <strong>+ 沙箱日志</strong></h3>
<p>编辑器底层用的是 microsoft/monaco-editor，好处是：</p>
<ul>
<li>
<p>TypeScript / JS 语法高亮</p>
</li>
<li>
<p>可以做一些简单的智能提示</p>
</li>
<li>
<p>UI 很像 VSCode，大家上手成本低</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f3e93016c954b8480957446f806fd1c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOU5ZOp5ZOU5ZOp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766133819&amp;x-signature=TrJO7at%2FgD5xeQNthjhUgHARBpU%3D" alt="图片" loading="lazy"/></p>
<p>调试方面：</p>
<ul>
<li>
<p>提供了一个 参数 Mock 面板：可以填入调用时的 JSON</p>
</li>
<li>
<p>点击「运行」，平台会在沙箱里跑一遍你的函数，把：日志打印（console.log）、返回字符串、可能的异常，全都展示出来</p>
</li>
</ul>
<p>每次保存，我们都会生成一个版本：</p>
<ul>
<li>
<p>当前编辑的是“草稿”</p>
</li>
<li>
<p>发布的时候会把某个版本标记为发布</p>
</li>
<li>
<p>出现问题可以一键回滚到上一版</p>
</li>
</ul>
<p>最后，开发者只需要在编辑器里写一个 “普通 JS 函数”，但：</p>
<ul>
<li>
<p>安全隔离由 NodeVM 负责</p>
</li>
<li>
<p>内网调用靠 $yuumi</p>
</li>
<li>
<p>会话靠 $cookie</p>
</li>
<li>
<p>AI 友好的结果格式靠 $json2MarkdownTable</p>
</li>
</ul>
<h3 data-id="heading-10"><strong>4.3 Tool Arguments：为 AI 帮开发者“定义接口”</strong></h3>
<p>传统开发写接口参数：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">roomid:</span> <span class="hljs-type">string</span>
</code></pre>
<p>为此，我们提供了转为 Tool Arguments 的可视化配置：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b050b1bb0b048d1beff5ef23aa51a69~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOU5ZOp5ZOU5ZOp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766133819&amp;x-signature=wrqLT12vzLcwNyoGAqCWoZMoPjc%3D" alt="图片" loading="lazy"/></p>
<p>它会统一生成：</p>
<ul>
<li>MCP Tool 的 JSON Schema</li>
<li>StructuredTool 的 Zod Schema</li>
<li>NodeVM 内 $roomid 变量</li>
</ul>
<p>一次配置，全平台复用。</p>
<h3 data-id="heading-11"><strong>4.4 工具市场：企业内部的 Agent 工具仓库</strong></h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48e9a510bb8e4c23854d4c95e491e9c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOU5ZOp5ZOU5ZOp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766133819&amp;x-signature=YhlDZS1wc%2Ba51GW36m25sPM4K1c%3D" alt="图片" loading="lazy"/></p>
<p>我们提供了工具市场：</p>
<ul>
<li>各部门把工具上架</li>
<li>其他部门直接复用</li>
<li>工具行为一致，调用方式一致</li>
<li>避免重复开发</li>
</ul>
<p>工具从“项目资产”变成“企业能力”。</p>
<h2 data-id="heading-12"><strong>五、第三版：接入 MCP</strong> <strong>——让工具跨平台、跨模型、跨框架</strong></h2>
<p>做到第二版时，工具已经变得很好用了。但还缺一块：</p>
<blockquote>
<p>同一份工具定义，既能在 Flowise 里当 LangChain StructuredTool 用，又能在 MCP 里变成跨平台 ToolCall。</p>
</blockquote>
<h3 data-id="heading-13"><strong>5.1 MCP 是什么？以及一个常见误区</strong></h3>
<p>MCP 全称 Model Context Protocol，可以简单理解为：</p>
<blockquote>
<p>给“大模型 + 工具调用”定义了一个“统一插线板”</p>
</blockquote>
<p>它解决的是：</p>
<ul>
<li>
<p>大模型想调用一个外部工具</p>
</li>
<li>
<p>这个工具可能跑在本机、另一台服务器、甚至另一个团队的系统里</p>
</li>
<li>
<p>我们希望“调用方式”是统一、可描述、可流式的。</p>
</li>
</ul>
<h3 data-id="heading-14"><strong>5.2 一个常见误区：把旧接口一包就行了？</strong></h3>
<p>很多人第一反应是：</p>
<blockquote>
<p>那我把现在的业务 HTTP 接口包成一个 MCP 工具，不就行了吗？</p>
</blockquote>
<p>理论上可以，实践里有两个坑：</p>
<p><strong>1.  自然语言 ≠ 接口参数</strong></p>
<p>用户会说：“查一下未完成的任务”。但你的接口长这样：/tasks?status=1&amp;owner_id=xxx。中间这层 “自然语言 → status=1” 的映射，需要：</p>
<ul>
<li>prompt / few-shot</li>
<li>枚举表 / 映射关系</li>
<li>甚至分类模型。</li>
</ul>
<p>所以我们在 Tool Arguments 设置时一定要尽量贴近自然语言，比如 status 描述写成“任务的进度状态（未开始/进行中/已完成）”，而不是“1/2/3”。</p>
<p><strong>2.  JSON 返回 ≠ AI 可读</strong></p>
<p>很多内部接口返回一大坨嵌套 JSON，LLM 虽然能解析，但：</p>
<ul>
<li>容易“漏看”字段；</li>
<li>回答会很啰嗦或不稳定。</li>
<li>所以我们在云函数层统一规定：</li>
</ul>
<p><strong>返回给 AI 的一定是“人类可读”的文本/Markdown，</strong> JSON 只是中间态。</p>
<p>这就是前面 $json2MarkdownTable 那段代码存在的原因。</p>
<h3 data-id="heading-15"><strong>5.3 StructuredTool → MCP：我们是怎么做“代理层”的？</strong></h3>
<p>前面说了两件事：</p>
<ul>
<li>
<p>工具在平台内部用 LangChain StructuredTool + NodeVM 来执行</p>
</li>
<li>
<p>我们希望同一份工具定义，既能在 Flowise 里用，也能被任意支持 MCP 的 Agent / Studio 调用</p>
</li>
</ul>
<p><strong>createMCPServer：Express 里的一层 MCP 网关</strong></p>
<p>在服务端，我们做了一层很薄的 MCP 网关，挂在 Express 应用上：</p>
<pre><code class="hljs language-ruby" lang="ruby">export function createMCPServer({ app, <span class="hljs-title class_">AppDataSource</span> }: <span class="hljs-title class_">App</span>){
  <span class="hljs-regexp">//</span> 单个云函数 → <span class="hljs-variable constant_">MCP</span>-<span class="hljs-title class_">Streamable</span>HTTP  
  app.post(<span class="hljs-string">'/api/mcp/function-tool/:toolId'</span>, singleToolCreateStreamableHTTPServer)  
  /<span class="hljs-regexp">/ 多个云函数组合 → MCP-StreamableHTTP  app.post('/api</span><span class="hljs-regexp">/mcp/</span><span class="hljs-symbol">:mcpId<span class="hljs-string">', multipleToolCreateStreamableHTTPServer)
  
  // 会话后续请求复用
  app.get('</span>/api/mcp/function-tool/</span><span class="hljs-symbol">:id<span class="hljs-string">', handleSessionRequest) 
  app.delete('</span>/api/mcp/function-tool/</span><span class="hljs-symbol">:id<span class="hljs-string">', handleSessionRequest)  
  app.get('</span>/api/mcp/</span><span class="hljs-symbol">:mcpId<span class="hljs-string">', handleSessionRequest)
  app.delete('</span>/api/mcp/</span><span class="hljs-symbol">:mcpId<span class="hljs-string">', handleSessionRequest)
  
  const transports = { 
    streamable: {} as Record&lt;string, StreamableHTTPServerTransport&gt;  
  }
  
  // ... 省略 SSE 相关 ...
}
</span></span></code></pre>
<ul>
<li>对外就是几条 HTTP 路由；</li>
<li>对内维护一个 streamable 的 transport 池，用 sessionId 作为 key。</li>
</ul>
<p>这样，不同 AI Studio / Agent 只要知道某个 URL，就可以把它当 MCP 端点来用。</p>
<p><strong>Streamable HTTP：用 session 管住一条“长连接”</strong></p>
<p>StreamableHTTPServerTransport 是 MCP 官方 SDK 提供的一个传输实现，用来做 Streamable HTTP 模式。我们做的事情有两种情况：</p>
<ol>
<li>
<p>客户端第一次初始化（没有 sessionId）；</p>
</li>
<li>
<p>之后所有请求都带上 mcp-session-id 头，复用之前的 session。</p>
</li>
</ol>
<p>核心代码大概是这样：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createStreamableHTTP</span>(<span class="hljs-params">config: CreateMcpServerConfig</span>){  
  <span class="hljs-keyword">const</span> { req, res, username } = config
  <span class="hljs-keyword">const</span> sessionId = req.<span class="hljs-property">headers</span>[<span class="hljs-string">'mcp-session-id'</span>] <span class="hljs-keyword">as</span> string | <span class="hljs-literal">undefined</span> 
  <span class="hljs-keyword">let</span> <span class="hljs-attr">transport</span>: <span class="hljs-title class_">StreamableHTTPServerTransport</span>
  
  <span class="hljs-keyword">if</span> (sessionId &amp;&amp; transports.<span class="hljs-property">streamable</span>[sessionId]) {   
    <span class="hljs-comment">// ① 有 sessionId，复用之前的 transport   </span>
    transport = transports.<span class="hljs-property">streamable</span>[sessionId]  
  } elseif (!sessionId &amp;&amp; <span class="hljs-title function_">isInitializeRequest</span>(req.<span class="hljs-property">body</span>)) {  
    <span class="hljs-comment">// ② 首次初始化，请求体符合 MCP 初始化格式   </span>
    transport = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StreamableHTTPServerTransport</span>({  
      <span class="hljs-attr">sessionIdGenerator</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">randomUUID</span>(),  
      <span class="hljs-attr">onsessioninitialized</span>: <span class="hljs-function">(<span class="hljs-params">sessionId</span>) =&gt;</span> {   
        transports.<span class="hljs-property">streamable</span>[sessionId] = transport    
      }
   })
    
   <span class="hljs-comment">// 连接关闭时清理掉这个 session </span>
   transport.<span class="hljs-property">onclose</span> = <span class="hljs-function">() =&gt;</span> {    
     <span class="hljs-keyword">if</span> (transport.<span class="hljs-property">sessionId</span>) {  
       <span class="hljs-keyword">delete</span> transports.<span class="hljs-property">streamable</span>[transport.<span class="hljs-property">sessionId</span>] 
       opsLogger.<span class="hljs-title function_">info</span>(<span class="hljs-string">`[Streamable] 删除sessionId: username=<span class="hljs-subst">${username}</span> sessionId=<span class="hljs-subst">${transport.sessionId}</span>`</span>)    
     }
   }
   
   <span class="hljs-keyword">const</span> server = <span class="hljs-title function_">buildMcpServer</span>({  
     ...config,   
     <span class="hljs-attr">transport</span>: <span class="hljs-string">'streamable-http'</span>   
   })
   
   <span class="hljs-keyword">await</span> server.<span class="hljs-title function_">connect</span>(transport) 
 } <span class="hljs-keyword">else</span> { 
   <span class="hljs-comment">// 既不是初始化，又没有合法 sessionId：直接返回错误   </span>
   res.<span class="hljs-title function_">status</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_">json</span>({  
     <span class="hljs-attr">jsonrpc</span>: <span class="hljs-string">'2.0'</span>,   
     <span class="hljs-attr">error</span>: {   
       <span class="hljs-attr">code</span>: -<span class="hljs-number">32000</span>,  
       <span class="hljs-attr">message</span>: <span class="hljs-string">'Bad Request: No valid session ID provided'</span>    
     },
     <span class="hljs-attr">id</span>: <span class="hljs-literal">null</span>  
   })   
   <span class="hljs-keyword">return</span>  
  }
  
  <span class="hljs-keyword">await</span> transport.<span class="hljs-title function_">handleRequest</span>(req, res, req.<span class="hljs-property">body</span>)
}
</code></pre>
<p>配合一个统一的会话请求入口：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">async</span> function <span class="hljs-title">handleSessionRequest</span>(<span class="hljs-params">req: Request, res: Response</span>)</span>{  
  <span class="hljs-keyword">const</span> sessionId = req.headers[<span class="hljs-string">'mcp-session-id'</span>] <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span> | <span class="hljs-function">undefined  
  <span class="hljs-title">if</span> (<span class="hljs-params">!sessionId || !transports.streamable[sessionId]</span>)</span> { 
    res.status(<span class="hljs-number">400</span>).send(<span class="hljs-string">'Invalid or missing session ID'</span>)   
    <span class="hljs-keyword">return</span> 
  }
  
  <span class="hljs-keyword">const</span> transport = transports.streamable[sessionId]  
  <span class="hljs-keyword">await</span> transport.handleRequest(req, res)}
</code></pre>
<p>这样实现的好处是：客户端只需要记住一个 mcp-session-id，之后所有请求都可以复用同一条 Streamable HTTP 会话。</p>
<p><strong>buildMcpServer：真正把“工具注册到 MCP 协议”</strong></p>
<p>首先，用户可以将云函数平台创建的智能体工具代理到MCP协议上，一个MCP可以关联多个工具</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd6378fecd66456ab1223de01e0bfd3b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOU5ZOp5ZOU5ZOp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766133819&amp;x-signature=zwA6XxmY7bHCl9wLE6pJI17L0wg%3D" alt="图片" loading="lazy"/></p>
<p>接下来是最关键的一步：用官方 McpServer 把 Tool Registry 里的工具挂成 MCP Tool。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">buildMcpServer</span>(<span class="hljs-params">config: BuildMcpServerConfig</span>): <span class="hljs-title class_">McpServer</span> {
  <span class="hljs-keyword">const</span> { name, tools, cookie, env, id, <span class="hljs-keyword">type</span>, username, transport } = config
  
  <span class="hljs-keyword">const</span> server = <span class="hljs-keyword">new</span> <span class="hljs-title class_">McpServer</span>({  
    name, 
    <span class="hljs-attr">version</span>: <span class="hljs-string">'1.0.0'</span> 
  })
  
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> tool <span class="hljs-keyword">of</span> tools) { 
    <span class="hljs-comment">// 1）把数据库里的元信息，转成 DynamicStructuredTool 入参</span>
    <span class="hljs-keyword">const</span> obj = {      
      <span class="hljs-attr">name</span>: tool.<span class="hljs-property">name</span>,
      <span class="hljs-attr">description</span>: tool.<span class="hljs-property">description</span>,  
      <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>(<span class="hljs-title function_">convertSchemaToZod</span>(tool.<span class="hljs-property">schema</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span> | <span class="hljs-built_in">object</span>)),      
      <span class="hljs-attr">code</span>: tool.<span class="hljs-property">func</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>  
    }
    
    <span class="hljs-comment">// DynamicStructuredTool 内部就是一个“动态 StructuredTool” + NodeVM 沙箱</span>
    <span class="hljs-keyword">const</span> dynamicStructuredTool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicStructuredTool</span>(obj)
    
    <span class="hljs-comment">// Flow 信息：cookie + env（来自 MCP URL 上的 sign / 其它query)</span>
    dynamicStructuredTool.<span class="hljs-title function_">setFlowObject</span>({ 
      cookie,  
      <span class="hljs-attr">env</span>: <span class="hljs-keyword">typeof</span> env === <span class="hljs-string">'object'</span> &amp;&amp; <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(env).<span class="hljs-property">length</span> ? env : {}   
    })
    
    <span class="hljs-comment">// 2）把我们在 UI 里配置的 Tool Arguments schema，转成 MCP 需要的 zod 参数定义 </span>
    <span class="hljs-keyword">const</span> schemaParser = (tool.<span class="hljs-property">schema</span> ? <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(tool.<span class="hljs-property">schema</span>) : []) <span class="hljs-keyword">as</span> <span class="hljs-title class_">Schema</span>[]
    
    <span class="hljs-keyword">const</span> paramsSchema = schemaParser.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">res, cur</span>) =&gt;</span> {  
      <span class="hljs-keyword">if</span> (cur.<span class="hljs-property">required</span>) { 
        res[cur.<span class="hljs-property">property</span>] = z[cur.<span class="hljs-property">type</span>]({ <span class="hljs-attr">required_error</span>: <span class="hljs-string">`<span class="hljs-subst">${cur.property}</span> required`</span> })   
          .<span class="hljs-title function_">describe</span>(cur.<span class="hljs-property">description</span>) <span class="hljs-keyword">as</span> z.<span class="hljs-property">ZodTypeAny</span>   
      } <span class="hljs-keyword">else</span> {   
        res[cur.<span class="hljs-property">property</span>] = z[cur.<span class="hljs-property">type</span>]()   
          .<span class="hljs-title function_">describe</span>(cur.<span class="hljs-property">description</span>)     
          .<span class="hljs-title function_">optional</span>() <span class="hljs-keyword">as</span> z.<span class="hljs-property">ZodTypeAny</span>    
      }
      <span class="hljs-keyword">return</span> res   
    }, {} <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>)
    
    <span class="hljs-comment">// 3）用官方 server.tool() 方法注册 MCP Tool </span>
    server.<span class="hljs-title function_">tool</span>(tool.<span class="hljs-property">name</span>, tool.<span class="hljs-property">description</span>, paramsSchema, <span class="hljs-keyword">async</span> (args, _extra) =&gt; {   
      <span class="hljs-comment">// 注意：这里的 call() 对应的就是 LangChain StructuredTool._call()  </span>
      <span class="hljs-keyword">const</span> runnerResult = <span class="hljs-keyword">await</span> dynamicStructuredTool.<span class="hljs-title function_">call</span>({  
        ...args
      })
      
      <span class="hljs-comment">// 线上环境做一层使用上报（方便统计谁在用哪个 MCP）</span>
      <span class="hljs-keyword">if</span> (process.<span class="hljs-property">env</span>.<span class="hljs-property">DEPLOY_ENV</span> === <span class="hljs-string">'prod'</span>) {   
        <span class="hljs-title function_">reportMcpUse</span>({   
          id,  
          <span class="hljs-keyword">type</span>,   
          name,   
          username,  
          transport  
        })   
       }
       
       <span class="hljs-comment">// MCP 协议统一的返回格式：content[] 数组  </span>
       <span class="hljs-keyword">return</span> {    
         <span class="hljs-attr">content</span>: [{ <span class="hljs-attr">type</span>: <span class="hljs-string">'text'</span>, <span class="hljs-attr">text</span>: runnerResult }]  
       }
     })
   }
   
   <span class="hljs-keyword">return</span> server
 }
</code></pre>
<p>把Tool Registry 里的：</p>
<ul>
<li>
<p>name</p>
</li>
<li>
<p>description</p>
</li>
<li>
<p>schema（以数组 JSON 形式存）</p>
</li>
<li>
<p>func（在线编辑器里的 JS 代码）</p>
</li>
</ul>
<p>按 MCP 需要的格式做了一层映射：</p>
<ul>
<li>
<p>输入 → paramsSchema（zod 校验）</p>
</li>
<li>
<p>执行 → dynamicStructuredTool.call()</p>
</li>
<li>
<p>输出 → MCP 标准的 content[{ type: 'text', text: ... }]</p>
</li>
</ul>
<p>StructuredTool 内部：从 MCP 入参到 NodeVM 执行的最后一步</p>
<p>DynamicStructuredTool.call() 里面最终会走到 _call()，这一步就是前面介绍的 NodeVM 沙箱执行：</p>
<ul>
<li>
<p>把 MCP 传进来的参数变成 $xxx 变量</p>
</li>
<li>
<p>把 cookie / env、以及会话信息塞进 $flow</p>
</li>
<li>
<p>注入 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mi>u</mi><mi>u</mi><mi>m</mi><mi>i</mi><mtext>、</mtext></mrow><annotation encoding="application/x-tex">yuumi、</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord mathnormal">uu</span><span class="mord mathnormal">mi</span><span class="mord cjk_fallback">、</span></span></span></span></span>json2MarkdownTable、<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>i</mi><mi>l</mi><mi>i</mi><mi>I</mi><mi>n</mi><mi>d</mi><mi>e</mi><mi>x</mi><mtext>、</mtext></mrow><annotation encoding="application/x-tex">biliIndex、</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">bi</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal">x</span><span class="mord cjk_fallback">、</span></span></span></span></span>deepseek、$chatgpt 等能力</p>
</li>
<li>
<p>在受限依赖白名单下创建 NodeVM</p>
</li>
<li>
<p>以 module.exports = async function() { ${this.code} }() 的形式执行开发者写的 JS</p>
</li>
</ul>
<p>对于上层 MCP 调用方来说：</p>
<blockquote>
<p>调用了一个名字叫 QueryLiveRoomInfo 的 MCP 工具，传了一些参数，收到了一个文本/Markdown 结果</p>
</blockquote>
<p>而对于我们平台来说，这中间其实已经执行了一整套：</p>
<blockquote>
<p>MCP → McpServer.tool → DynamicStructuredTool → NodeVM → 内网服务的完整链路。</p>
</blockquote>
<p><strong>可复用可共享的MCP市场</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ed971fdf5df4a2ab0be5684d57c01e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOU5ZOp5ZOU5ZOp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766133819&amp;x-signature=Txis9r1N0n1kXq8%2F5QLbV1L1T%2Bs%3D" alt="图片" loading="lazy"/></p>
<p>对于 MCP 新手，我们在平台上还提供了“MCP 市场” 的入口，里面还提供了一键调试：</p>
<ul>
<li>
<p>不需要真的连上一个大模型</p>
</li>
<li>
<p>直接在浏览器里模拟一次 MCP ToolCall</p>
</li>
<li>
<p>看看云函数有没有跑对、返回是不是 AI 友好的格式</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6dce174203064e108bcdb39c92288af8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOU5ZOp5ZOU5ZOp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766133819&amp;x-signature=%2FV0T98v4oJyRcUTStOEOPSyN3tE%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-16"><strong>六、身份鉴权：MCP 是独立服务，安全必须先想清楚</strong></h2>
<p>MCP 本质上是一个“跨平台的服务访问入口”，如果不做鉴权，很容易变成无法管理。我们的做法大致是这样：</p>
<ol>
<li> 注册阶段就要带 sign：</li>
</ol>
<ul>
<li>每个 MCP 工具的注册地址必须带一个 sign 参数</li>
<li>sign 是基于内网规范签出的签名</li>
<li>没有合法签名，工具不会被注册成功</li>
</ul>
<ol start="2">
<li> 调用阶段统一 Proxy：</li>
</ol>
<ul>
<li>外部 Agent 调用 MCP Server</li>
<li>MCP Server 把调用转发给云函数平台的 Proxy 层</li>
<li>Proxy 层会：</li>
</ul>

<ul>
<li>校验 sign</li>
<li>注入对应的 $cookie / 会话</li>
<li>再去调真正的内网业务接口</li>
</ul>
<ol start="3">
<li> 业务侧拿到的是“处理后的内网协议”：</li>
</ol>
<ul>
<li>
<p>Proxy 会把 sign 解密、校验后，以内部统一格式透传给业务</p>
</li>
<li>
<p>避免在业务里掺杂各种外部协议细节</p>
</li>
</ul>
<p>这样，MCP 既可以对外暴露统一的工具接口，又仍然受控在内网的安全体系内</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e5f2ebf9d4142d4bc94d958b15b1ddc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOU5ZOp5ZOU5ZOp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766133819&amp;x-signature=l%2F1ltMpqyWMkMgGXyElyZedDkM4%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-17"><strong>七、结语：把“接 AI”变成“写一个云函数”</strong></h2>
<p>从 AI工作流 → StructuredTool → 云函数平台 → MCP 的这条路径，我们最终得到了：</p>
<ul>
<li>
<p>一个统一的工具定义方式：元信息</p>
</li>
<li>
<p>一个统一的执行方式：NodeVM</p>
</li>
<li>
<p>一个统一的调用协议：MCP</p>
</li>
<li>
<p>一个统一的共享方式：工具市场</p>
</li>
<li>
<p>一个统一的安全体系：sign + cookie</p>
</li>
</ul>
<p>也让我们真正做到了：</p>
<p>让业务同学不再关心“怎么接 AI”，而是只需要关心“我能给 AI 提供什么能力”。</p>
<p>把写一个 JS 函数，变成给 AI 加一个新能力。</p>
<p>未来我们还会继续提升运行时性能、正确性评估观测、深度研究等方向，把工具能力建设得更现代、更企业级。</p>
<p>-End-</p>
<p>作者丨Zerooo、Gengar</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么按 Ctrl+D 会退出终端？—— 从电传打字机到现代 macOS 的完整旅程]]></title>    <link>https://juejin.cn/post/7582786655472795691</link>    <guid>https://juejin.cn/post/7582786655472795691</guid>    <pubDate>2025-12-12T08:47:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582786655472795691" data-draft-id="7582637280218021942" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么按 Ctrl+D 会退出终端？—— 从电传打字机到现代 macOS 的完整旅程"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-12T08:47:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="shengjk1"/> <meta itemprop="url" content="https://juejin.cn/user/2647279732524957"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么按 Ctrl+D 会退出终端？—— 从电传打字机到现代 macOS 的完整旅程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2647279732524957/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    shengjk1
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T08:47:40.000Z" title="Fri Dec 12 2025 08:47:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="gruvbox-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#282828}.hljs-subst,.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#ebdbb2}.hljs-deletion,.hljs-formula,.hljs-keyword,.hljs-link,.hljs-selector-tag{color:#fb4934}.hljs-built_in,.hljs-emphasis,.hljs-name,.hljs-quote,.hljs-strong,.hljs-title,.hljs-variable{color:#83a598}.hljs-attr,.hljs-params,.hljs-template-tag,.hljs-type{color:#fabd2f}.hljs-builtin-name,.hljs-doctag,.hljs-literal,.hljs-number{color:#8f3f71}.hljs-code,.hljs-meta,.hljs-regexp,.hljs-selector-id,.hljs-template-variable{color:#fe8019}.hljs-addition,.hljs-meta-string,.hljs-section,.hljs-selector-attr,.hljs-selector-class,.hljs-string,.hljs-symbol{color:#b8bb26}.hljs-attribute,.hljs-bullet,.hljs-class,.hljs-function,.hljs-function .hljs-keyword,.hljs-meta-keyword,.hljs-selector-pseudo,.hljs-tag{color:#8ec07c}.hljs-comment{color:#928374}.hljs-link_label,.hljs-literal,.hljs-number{color:#d3869b}.hljs-comment,.hljs-emphasis{font-style:italic}.hljs-section,.hljs-strong,.hljs-tag{font-weight:700}</style><p>你好，我是 shengjk1，多年大厂经验，努力构建 通俗易懂的、好玩的编程语言教程。 欢迎关注！你会有如下收益：</p>
<ol>
<li>了解大厂经验</li>
<li>拥有和大厂相匹配的技术等</li>
</ol>
<p>希望看什么，评论或者私信告诉我！</p>
<p>你有没有想过：</p>
<blockquote>
<p><strong>为什么在终端里按 <code>Ctrl+D</code>，程序就会收到“文件结束”（EOF）信号并退出？</strong></p>
</blockquote>
<p>这看似简单的行为，背后却隐藏着一段跨越 <strong>60 年的操作系统演进史</strong>。从纸带打字机到 macOS 的 Terminal，从物理串口到内核中的 TTY 子系统，<code>Ctrl+D</code> 的故事，正是 Unix “一切皆文件”哲学的缩影。</p>
<p>本文将带你一步步揭开这个谜题。</p>
<hr/>
<h2 data-id="heading-0">一、起源：电传打字机与 ASCII 控制字符</h2>
<p>时间回到 1960 年代。那时没有显示器，程序员通过 <strong>电传打字机（Teletypewriter, 简称 TTY）</strong> 与计算机交互：</p>
<ul>
<li>有键盘用于输入</li>
<li>有打印头在纸上输出结果</li>
<li>通过串行线连接主机</li>
</ul>
<p>这些设备使用 <strong>ASCII 编码</strong>通信。其中，前 32 个字符是<strong>控制字符</strong>，不表示可见文字，而是用于控制设备行为。</p>
<p>其中第 4 个字符是：</p>
<blockquote>
<p><strong>EOT（End of Transmission）</strong>，ASCII 码为 <code>0x04</code></p>
</blockquote>
<p>在电报和早期通信协议中，EOT 表示“本次传输结束”。而在键盘上，如何输入 ASCII 4？<br/>
答案是：<strong><code>Ctrl + D</code></strong><br/>
（因为 <code>D</code> 是字母表第 4 个字母，<code>Ctrl + 字母</code> = 该字母序号对应的控制码）</p>
<p>于是，<code>Ctrl+D</code> 与 “结束” 建立了最初的联系。</p>
<hr/>
<h2 data-id="heading-1">二、原理：EOF 不是一个字符，而是一种行为</h2>
<p>很多人误以为 <code>Ctrl+D</code> 发送了一个叫 “EOF 字符” 的东西。<br/>
<strong>这是错的。</strong></p>
<p>真相是：</p>
<blockquote>
<p><strong><code>Ctrl+D</code> 是一个控制信号，它触发终端驱动（TTY）执行特定行为：</strong></p>
<ul>
<li>如果当前输入缓冲区<strong>非空</strong> → 立即将已有内容提交给程序（即使没按回车）</li>
<li>如果缓冲区<strong>为空</strong> → 向程序返回 <code>read()</code> = 0，表示 EOF</li>
</ul>
</blockquote>
<p>在 Java、Python、C 等语言中：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">String</span> <span class="hljs-variable">line</span> <span class="hljs-operator">=</span> reader.readLine(); <span class="hljs-comment">// 若用户直接按 Ctrl+D，line == null</span>
</code></pre>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">ssize_t</span> n = read(<span class="hljs-number">0</span>, buf, size); <span class="hljs-comment">// n == 0 表示 EOF</span>
</code></pre>
<p>所以，<strong>EOF 是 I/O 接口的语义，不是数据流中的一个字节</strong>。</p>
<hr/>
<h2 data-id="heading-2">三、图形时代：伪终端（PTY）登场</h2>
<p>进入 1980 年代后，图形界面兴起。我们不再使用物理 TTY，而是打开 <strong>Terminal Emulator</strong>（如 iTerm2、GNOME Terminal）。</p>
<p>问题来了：</p>
<blockquote>
<p><strong>如何让一个图形程序，模拟出传统 TTY 的行为？</strong></p>
</blockquote>
<p>答案是：<strong>伪终端（Pseudo-TTY, PTY）</strong></p>
<h3 data-id="heading-3">PTY 的结构</h3>
<p>内核提供一对虚拟设备：</p>
<ul>
<li><strong>Slave 端</strong>（如 <code>/dev/ttys003</code>）：给 shell 或你的程序使用，<strong>完全兼容传统 TTY</strong></li>
<li><strong>Master 端</strong>：给 Terminal Emulator 使用，用于收发原始字节流</li>
</ul>
<pre><code class="hljs language-lua" lang="lua">+<span class="hljs-comment">------------------+       +------------------+</span>
| Terminal         |       | Your Program     |
| Emulator         |       | (e.g., bash)     |
| (User Space)     |       | (User Space)     |
+<span class="hljs-comment">--------+---------+       +--------+---------+</span>
         |                            |
         | <span class="hljs-built_in">write</span>(master)              | <span class="hljs-built_in">read</span>(slave)
         ↓                            ↑
+<span class="hljs-comment">--------+----------------------------+---------+</span>
|            Kernel TTY Subsystem               |
|        +<span class="hljs-comment">--------------------------+           |</span>
|        | PTY Driver               |           |
|        | - Master <span class="hljs-keyword">end</span>             |           |
|        | - Slave <span class="hljs-keyword">end</span> (/dev/ttys003)|           |
|        +<span class="hljs-comment">--------------------------+           |</span>
+<span class="hljs-comment">------------------------------------------------+</span>
</code></pre>
<p>当你在 Terminal 中按 <code>Ctrl+D</code>：</p>
<ol>
<li>Terminal Emulator 将字节 <code>0x04</code> 写入 PTY master</li>
<li>内核 TTY 驱动收到后，<strong>在 slave 端触发 EOF 行为</strong></li>
<li>你的程序调用 <code>read()</code> 返回 0，<code>BufferedReader.readLine()</code> 返回 <code>null</code></li>
<li>程序退出循环，REPL 结束</li>
</ol>
<blockquote>
<p>✅ 整个过程对程序透明——它以为自己连着一台 VT100！</p>
</blockquote>
<hr/>
<h2 data-id="heading-4">四、一条 <code>Ctrl+D</code> 的旅程</h2>
<p>让我们完整走一遍 <code>Ctrl+D</code> 的生命周期：</p>
<ol>
<li><strong>你按下 <code>Ctrl+D</code></strong> → 键盘生成 ASCII <code>0x04</code>（EOT）</li>
<li><strong>Terminal Emulator</strong>（如 iTerm2）将 <code>0x04</code> 写入 PTY master 端</li>
<li><strong>内核 TTY 子系统</strong> 收到后，检查 slave 端输入缓冲区
<ul>
<li>若为空 → 标记下一次 <code>read()</code> 返回 0</li>
</ul>
</li>
<li><strong>你的程序</strong>（如 Java REPL）调用 <code>readLine()</code>
<ul>
<li>底层 <code>read()</code> 返回 0</li>
<li><code>readLine()</code> 返回 <code>null</code></li>
</ul>
</li>
<li><strong>程序判断 <code>line == null</code>，退出循环</strong></li>
<li><strong>REPL 结束，回到 shell</strong></li>
</ol>
<p>整个过程跨越了：</p>
<ul>
<li>用户空间（GUI）</li>
<li>系统调用（<code>write</code>, <code>read</code>）</li>
<li>内核 TTY 驱动</li>
<li>POSIX I/O 语义</li>
</ul>
<p>而这一切，始于一台会咔嗒作响的纸带打字机。</p>
<hr/>
<h2 data-id="heading-5">五、结语</h2>
<p><code>Ctrl+D</code> 看似微不足道，却是 Unix 设计哲学的完美体现：</p>
<blockquote>
<p><strong>用简单的抽象，解决复杂的兼容性问题，并经受住半个世纪的考验。</strong></p>
</blockquote>
<p>下次当你按下 <code>Ctrl+D</code> 退出 Python REPL 时，不妨想一想：<br/>
你正在与 1971 年的 Ken Thompson 握手。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[App HTTPS 抓包实战解析，从代理调试到真实网络流量观察的完整抓包思路]]></title>    <link>https://juejin.cn/post/7582785032851324991</link>    <guid>https://juejin.cn/post/7582785032851324991</guid>    <pubDate>2025-12-12T08:55:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582785032851324991" data-draft-id="7582561515817615423" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="App HTTPS 抓包实战解析，从代理调试到真实网络流量观察的完整抓包思路"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-12T08:55:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="开心猴爷"/> <meta itemprop="url" content="https://juejin.cn/user/2179705232165364"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            App HTTPS 抓包实战解析，从代理调试到真实网络流量观察的完整抓包思路
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2179705232165364/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    开心猴爷
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T08:55:41.000Z" title="Fri Dec 12 2025 08:55:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在移动应用开发、接口联调、线上问题排查以及网络性能分析中，<strong>App HTTPS 抓包</strong> 几乎是每个开发者都会遇到的需求。但真正上手之后，很多人会发现：
同样是 HTTPS，请求在浏览器里很好抓，到了 App 里却“消失”了。</p>
<p>常见现象包括：</p>
<ul>
<li>代理工具没有任何请求</li>
<li>只能看到 CONNECT，看不到内容</li>
<li>某些接口能抓，某些完全抓不到</li>
<li>WebView 和原生接口表现不一致</li>
<li>iOS / Android 行为差异明显</li>
<li>网络正常，但抓包工具毫无反应</li>
</ul>
<p>这并不是配置问题，而是 <strong>App HTTPS 抓包本身就比 Web 抓包复杂得多</strong>。本文将从工程角度系统拆解 App HTTPS 抓包的常见场景、失败原因和解决路径</p>
<hr/>
<h2 data-id="heading-0">一、为什么 App HTTPS 抓包比 Web 抓包难？</h2>
<hr/>
<h3 data-id="heading-1"><strong>App 并不一定走系统代理</strong></h3>
<p>很多 App：</p>
<ul>
<li>使用独立网络库</li>
<li>在启动时读取代理配置后自行处理</li>
<li>或直接忽略系统代理</li>
</ul>
<p>结果就是：
浏览器能被 Charles / Fiddler 抓到，而 App 完全无流量。</p>
<hr/>
<h3 data-id="heading-2"><strong>HTTPS 加密 + 安全策略更严格</strong></h3>
<p>相比浏览器，App 更常见：</p>
<ul>
<li>证书校验更严格</li>
<li>禁止自签证书</li>
<li>使用证书 Pinning</li>
</ul>
<p>这会导致代理抓包工具直接失效。</p>
<hr/>
<h3 data-id="heading-3"><strong>App 中的 WebView 行为不统一</strong></h3>
<ul>
<li>有的 WebView 走系统代理</li>
<li>有的使用独立网络栈</li>
<li>有的 SDK 内部完全接管请求</li>
</ul>
<p>这也是“同一个 App，不同页面抓包表现不同”的原因。</p>
<hr/>
<h3 data-id="heading-4"><strong>HTTP/3（QUIC）在 App 中越来越普遍</strong></h3>
<p>QUIC 使用 UDP 443：</p>
<ul>
<li>绕过 TCP 代理</li>
<li>Charles / Fiddler 无法处理</li>
<li>抓包表现为“什么都没有”</li>
</ul>
<hr/>
<h2 data-id="heading-5">二、常见 App HTTPS 抓包工具及其边界</h2>
<hr/>
<h3 data-id="heading-6"><strong>① 代理抓包工具（应用层）</strong></h3>
<p>代表工具：</p>
<ul>
<li>Charles</li>
<li>Fiddler</li>
<li>Proxyman</li>
</ul>
<p>适合：</p>
<ul>
<li>常规 API 调试</li>
<li>请求参数分析</li>
<li>响应内容查看</li>
</ul>
<p>局限：</p>
<ul>
<li>无法处理 Pinning</li>
<li>无法处理 QUIC</li>
<li>无法覆盖不走代理的 App</li>
</ul>
<hr/>
<h3 data-id="heading-7"><strong>② 协议分析工具（网络层）</strong></h3>
<p>工具：</p>
<ul>
<li>Wireshark</li>
<li>tcpdump</li>
</ul>
<p>能力：</p>
<ul>
<li>查看 TLS 握手</li>
<li>判断 TCP/UDP 行为</li>
<li>分析丢包、重传</li>
</ul>
<p>不足：</p>
<ul>
<li>噪音极多</li>
<li>难以按 App 过滤</li>
<li>不适合日常调试</li>
</ul>
<hr/>
<h3 data-id="heading-8"><strong>③ 底层数据流捕获工具（补抓层）</strong></h3>
<p>当代理完全抓不到 App HTTPS 请求时，就必须使用底层捕获工具。</p>
<p>这正是 <strong>抓包大师（Sniffmaster）</strong> 所在的工具层。</p>
<hr/>
<h2 data-id="heading-9">三、Sniffmaster 在 App HTTPS 抓包中的技术定位</h2>
<p>Sniffmaster 并不是代理工具，它提供的是 <strong>真实网络数据流捕获能力</strong>，用于弥补代理抓包的盲区。</p>
<h3 data-id="heading-10"><strong>核心能力概览</strong></h3>
<ul>
<li>捕获 HTTPS / HTTP</li>
<li>捕获 TCP / UDP</li>
<li>支持 QUIC / HTTP3 流量识别</li>
<li>支持 WebSocket、自定义协议</li>
<li>按 App 过滤流量，减少系统噪音</li>
<li>多格式查看（文本 / HEX / 二进制）</li>
<li>支持 JavaScript 拦截器（非 pinning 场景）</li>
<li>支持导出 pcap，用于 Wireshark 深度分析</li>
<li>跨平台支持 macOS / Windows / iOS</li>
</ul>
<p>在 App HTTPS 抓包中，它承担的是 <strong>“是否真的发出了请求”</strong> 和 <strong>“请求在网络层发生了什么”</strong> 的确认角色。</p>
<hr/>
<h2 data-id="heading-11">四、App HTTPS 抓包失败的典型场景与应对方式</h2>
<hr/>
<h3 data-id="heading-12"><strong>场景 1：代理工具完全抓不到包</strong></h3>
<p>可能原因：</p>
<ul>
<li>App 不走系统代理</li>
<li>使用私有网络栈</li>
<li>被 VPN 或安全组件接管</li>
</ul>
<p>应对方式：</p>
<ul>
<li>使用 Sniffmaster 捕获底层流量</li>
<li>按 App 名称过滤请求</li>
</ul>
<hr/>
<h3 data-id="heading-13"><strong>场景 2：只能看到 CONNECT，看不到 HTTPS 内容</strong></h3>
<p>可能原因：</p>
<ul>
<li>证书未完全信任</li>
<li>App 校验了证书链</li>
</ul>
<p>解决思路：</p>
<ul>
<li>若是证书问题，修正证书信任</li>
<li>若是 Pinning，只能分析 TLS 握手与流量行为</li>
</ul>
<hr/>
<h3 data-id="heading-14"><strong>场景 3：部分接口抓不到</strong></h3>
<p>常见原因：</p>
<ul>
<li>某些请求走 QUIC</li>
<li>某些走 TCP</li>
</ul>
<p>Sniffmaster 可帮助确认：</p>
<ul>
<li>是否存在 UDP 443</li>
<li>是否启用了 HTTP/3</li>
</ul>
<hr/>
<h3 data-id="heading-15"><strong>场景 4：WebView 请求消失</strong></h3>
<p>说明：</p>
<ul>
<li>WebView 没有走系统代理</li>
</ul>
<p>Sniffmaster 仍可捕获 WebView 产生的真实网络流量。</p>
<hr/>
<h3 data-id="heading-16"><strong>场景 5：返回异常，但后端无日志</strong></h3>
<p>通过底层抓包可以判断：</p>
<ul>
<li>请求是否真的发出</li>
<li>是否在网络层被重置</li>
<li>TLS 是否在握手阶段失败</li>
</ul>
<hr/>
<h2 data-id="heading-17">五、推荐的 App HTTPS 抓包完整流程（工程实践）</h2>
<hr/>
<h3 data-id="heading-18"><strong>Step 1：优先使用代理抓包</strong></h3>
<p>用于日常接口调试。</p>
<hr/>
<h3 data-id="heading-19"><strong>Step 2：代理抓不到时，不要反复折腾配置</strong></h3>
<p>直接判断：</p>
<ul>
<li>是否 Pinning</li>
<li>是否 QUIC</li>
<li>是否不走代理</li>
</ul>
<hr/>
<h3 data-id="heading-20"><strong>Step 3：使用 Sniffmaster 抓底层流量</strong></h3>
<p>操作思路：</p>
<ol>
<li>选择目标 App</li>
<li>开启数据流捕获</li>
<li>查看是否有 TCP / UDP 请求</li>
<li>识别 HTTPS / QUIC 行为</li>
<li>必要时导出 pcap</li>
</ol>
<hr/>
<h3 data-id="heading-21"><strong>Step 4：结合 Wireshark 做协议级分析</strong></h3>
<p>用于：</p>
<ul>
<li>TLS alert 判断</li>
<li>TCP 重传分析</li>
<li>QUIC 握手确认</li>
</ul>
<hr/>
<h2 data-id="heading-22">App HTTPS 抓包的合理工具组合</h2>

























<table><thead><tr><th>层级</th><th>工具</th><th>作用</th></tr></thead><tbody><tr><td>代理层</td><td>Charles / Fiddler</td><td>明文 HTTPS 调试</td></tr><tr><td>协议层</td><td>Wireshark</td><td>TLS / TCP / QUIC 分析</td></tr><tr><td>底层补抓层</td><td>抓包大师（Sniffmaster**）**</td><td>捕获真实 App 网络流量</td></tr></tbody></table>
<p>这是当前最稳妥的 App HTTPS 抓包体系。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HTML + CSS 终极面试全攻略（八股文 + 场景题 + 工程落地）]]></title>    <link>https://juejin.cn/post/7582777037863223346</link>    <guid>https://juejin.cn/post/7582777037863223346</guid>    <pubDate>2025-12-12T08:59:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582777037863223346" data-draft-id="7582763878674120731" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HTML + CSS 终极面试全攻略（八股文 + 场景题 + 工程落地）"/> <meta itemprop="keywords" content="前端,面试,JavaScript"/> <meta itemprop="datePublished" content="2025-12-12T08:59:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="豆苗学前端"/> <meta itemprop="url" content="https://juejin.cn/user/1935598759719400"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HTML + CSS 终极面试全攻略（八股文 + 场景题 + 工程落地）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1935598759719400/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    豆苗学前端
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T08:59:45.000Z" title="Fri Dec 12 2025 08:59:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>定位：不仅能回答“是什么”，还能讲清楚“为什么、怎么落地、踩过哪些坑”。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">目录</h2>
<ul>
<li><a href="#1-html-%E7%AF%87" title="#1-html-%E7%AF%87">1. HTML 篇</a>
<ul>
<li><a href="#11-%E8%AF%AD%E4%B9%89%E5%8C%96semantic-html" title="#11-%E8%AF%AD%E4%B9%89%E5%8C%96semantic-html">1.1 语义化（Semantic HTML）</a></li>
<li><a href="#12-%E5%9D%97%E7%BA%A7%E8%A1%8C%E5%86%85%E8%A1%8C%E5%86%85%E5%9D%97" title="#12-%E5%9D%97%E7%BA%A7%E8%A1%8C%E5%86%85%E8%A1%8C%E5%86%85%E5%9D%97">1.2 块级/行内/行内块</a></li>
<li><a href="#13-script-%E7%9A%84-async--defer-%E5%8C%BA%E5%88%AB" title="#13-script-%E7%9A%84-async--defer-%E5%8C%BA%E5%88%AB">1.3 <code>script</code> 的 <code>async</code> / <code>defer</code> 区别</a></li>
<li><a href="#14-meta-viewport" title="#14-meta-viewport">1.4 <code>meta viewport</code></a></li>
<li><a href="#15-img-%E7%9A%84-alt%E6%87%92%E5%8A%A0%E8%BD%BD%E4%B8%8E%E5%9B%BE%E7%89%87%E6%80%A7%E8%83%BD" title="#15-img-%E7%9A%84-alt%E6%87%92%E5%8A%A0%E8%BD%BD%E4%B8%8E%E5%9B%BE%E7%89%87%E6%80%A7%E8%83%BD">1.5 <code>img</code> 的 <code>alt</code>、懒加载与图片性能</a></li>
<li><a href="#16-%E8%A1%A8%E5%8D%95%E4%B8%8E%E5%8F%AF%E8%AE%BF%E9%97%AE%E6%80%A7a11y" title="#16-%E8%A1%A8%E5%8D%95%E4%B8%8E%E5%8F%AF%E8%AE%BF%E9%97%AE%E6%80%A7a11y">1.6 表单与可访问性（A11y）</a></li>
</ul>
</li>
<li><a href="#2-css-%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%8E%9F%E7%90%86%E7%AF%87" title="#2-css-%E5%9F%BA%E7%A1%80%E4%B8%8E%E5%8E%9F%E7%90%86%E7%AF%87">2. CSS 基础与原理篇</a>
<ul>
<li><a href="#21-%E9%80%89%E6%8B%A9%E5%99%A8%E4%BC%98%E5%85%88%E7%BA%A7specificity" title="#21-%E9%80%89%E6%8B%A9%E5%99%A8%E4%BC%98%E5%85%88%E7%BA%A7specificity">2.1 选择器优先级（Specificity）</a></li>
<li><a href="#22-%E7%9B%92%E6%A8%A1%E5%9E%8B%E4%B8%8E-box-sizing" title="#22-%E7%9B%92%E6%A8%A1%E5%9E%8B%E4%B8%8E-box-sizing">2.2 盒模型与 <code>box-sizing</code></a></li>
<li><a href="#23-bfc%E5%9D%97%E7%BA%A7%E6%A0%BC%E5%BC%8F%E5%8C%96%E4%B8%8A%E4%B8%8B%E6%96%87" title="#23-bfc%E5%9D%97%E7%BA%A7%E6%A0%BC%E5%BC%8F%E5%8C%96%E4%B8%8A%E4%B8%8B%E6%96%87">2.3 BFC（块级格式化上下文）</a></li>
<li><a href="#24-%E6%B5%AE%E5%8A%A8%E4%B8%8E%E6%B8%85%E9%99%A4%E6%B5%AE%E5%8A%A8" title="#24-%E6%B5%AE%E5%8A%A8%E4%B8%8E%E6%B8%85%E9%99%A4%E6%B5%AE%E5%8A%A8">2.4 浮动与清除浮动</a></li>
<li><a href="#25-positionrelativeabsolutefixedsticky" title="#25-positionrelativeabsolutefixedsticky">2.5 <code>position</code>：relative/absolute/fixed/sticky</a></li>
<li><a href="#26-flexflex-1%E5%8E%8B%E7%BC%A9%E6%BA%A2%E5%87%BA%E4%B8%8E-min-width-0" title="#26-flexflex-1%E5%8E%8B%E7%BC%A9%E6%BA%A2%E5%87%BA%E4%B8%8E-min-width-0">2.6 Flex：<code>flex: 1</code>、压缩、溢出与 <code>min-width: 0</code></a></li>
<li><a href="#27-grid%E4%BA%8C%E7%BB%B4%E5%B8%83%E5%B1%80%E5%8A%A0%E5%88%86%E9%A1%B9" title="#27-grid%E4%BA%8C%E7%BB%B4%E5%B8%83%E5%B1%80%E5%8A%A0%E5%88%86%E9%A1%B9">2.7 Grid：二维布局加分项</a></li>
<li><a href="#28-%E5%B8%B8%E8%A7%81%E5%B1%85%E4%B8%AD%E6%96%B9%E6%A1%88" title="#28-%E5%B8%B8%E8%A7%81%E5%B1%85%E4%B8%AD%E6%96%B9%E6%A1%88">2.8 常见居中方案</a></li>
<li><a href="#29-z-index-%E4%B8%8E%E5%B1%82%E5%8F%A0%E4%B8%8A%E4%B8%8B%E6%96%87stacking-context" title="#29-z-index-%E4%B8%8E%E5%B1%82%E5%8F%A0%E4%B8%8A%E4%B8%8B%E6%96%87stacking-context">2.9 <code>z-index</code> 与层叠上下文（Stacking Context）</a></li>
<li><a href="#210-%E7%BB%A7%E6%89%BF%E5%B1%82%E5%8F%A0%E8%AE%A1%E7%AE%97%E5%80%BCcss-%E4%B8%89%E6%9D%BF%E6%96%A7" title="#210-%E7%BB%A7%E6%89%BF%E5%B1%82%E5%8F%A0%E8%AE%A1%E7%AE%97%E5%80%BCcss-%E4%B8%89%E6%9D%BF%E6%96%A7">2.10 继承、层叠、计算值（CSS 三板斧）</a></li>
<li><a href="#211-%E5%93%8D%E5%BA%94%E5%BC%8F%E5%8D%95%E4%BD%8D%E4%B8%8E%E5%AA%92%E4%BD%93%E6%9F%A5%E8%AF%A2" title="#211-%E5%93%8D%E5%BA%94%E5%BC%8F%E5%8D%95%E4%BD%8D%E4%B8%8E%E5%AA%92%E4%BD%93%E6%9F%A5%E8%AF%A2">2.11 响应式单位与媒体查询</a></li>
<li><a href="#212-transition-vs-animation-%E4%B8%8E%E6%80%A7%E8%83%BD%E8%A6%81%E7%82%B9" title="#212-transition-vs-animation-%E4%B8%8E%E6%80%A7%E8%83%BD%E8%A6%81%E7%82%B9">2.12 <code>transition</code> vs <code>animation</code> 与性能要点</a></li>
</ul>
</li>
<li><a href="#3-%E5%B7%A5%E7%A8%8B%E5%8C%96%E4%B8%8E%E8%90%BD%E5%9C%B0%E5%85%AC%E5%8F%B8%E6%9C%80%E5%B8%B8%E7%94%A8" title="#3-%E5%B7%A5%E7%A8%8B%E5%8C%96%E4%B8%8E%E8%90%BD%E5%9C%B0%E5%85%AC%E5%8F%B8%E6%9C%80%E5%B8%B8%E7%94%A8">3. 工程化与落地（公司最常用）</a>
<ul>
<li><a href="#31-%E7%A7%BB%E5%8A%A8%E7%AB%AF%E9%80%82%E9%85%8D%E9%80%89%E5%9E%8Brem--vw--rpx--scale" title="#31-%E7%A7%BB%E5%8A%A8%E7%AB%AF%E9%80%82%E9%85%8D%E9%80%89%E5%9E%8Brem--vw--rpx--scale">3.1 移动端适配选型：<code>rem</code> / <code>vw</code> / <code>rpx</code> / <code>scale</code></a></li>
<li><a href="#32-h5vuereact-%E6%96%B9%E6%A1%88postcss-%E8%87%AA%E5%8A%A8%E8%BD%AC%E6%8D%A2%E6%8E%A8%E8%8D%90%E5%86%99-px" title="#32-h5vuereact-%E6%96%B9%E6%A1%88postcss-%E8%87%AA%E5%8A%A8%E8%BD%AC%E6%8D%A2%E6%8E%A8%E8%8D%90%E5%86%99-px">3.2 H5（Vue/React）方案：PostCSS 自动转换（推荐写 <code>px</code>）</a></li>
<li><a href="#33-uni-app--%E5%B0%8F%E7%A8%8B%E5%BA%8Frpx-%E4%B8%8E%E5%AE%89%E5%85%A8%E5%8C%BA" title="#33-uni-app--%E5%B0%8F%E7%A8%8B%E5%BA%8Frpx-%E4%B8%8E%E5%AE%89%E5%85%A8%E5%8C%BA">3.3 uni-app / 小程序：<code>rpx</code> 与安全区</a></li>
<li><a href="#34-pc-%E5%93%8D%E5%BA%94%E5%BC%8Fb-%E7%AB%AF%E5%AE%98%E7%BD%91%E7%89%88%E5%BF%83--%E6%96%AD%E7%82%B9--flexgrid" title="#34-pc-%E5%93%8D%E5%BA%94%E5%BC%8Fb-%E7%AB%AF%E5%AE%98%E7%BD%91%E7%89%88%E5%BF%83--%E6%96%AD%E7%82%B9--flexgrid">3.4 PC 响应式（B 端/官网）：版心 + 断点 + Flex/Grid</a></li>
<li><a href="#35-%E5%A4%A7%E5%B1%8F%E5%8F%AF%E8%A7%86%E5%8C%96%E5%AE%B9%E5%99%A8%E7%AD%89%E6%AF%94%E7%BC%A9%E6%94%BEtransform-scale" title="#35-%E5%A4%A7%E5%B1%8F%E5%8F%AF%E8%A7%86%E5%8C%96%E5%AE%B9%E5%99%A8%E7%AD%89%E6%AF%94%E7%BC%A9%E6%94%BEtransform-scale">3.5 大屏可视化：容器等比缩放（<code>transform: scale</code>）</a></li>
<li><a href="#36-%E7%A7%BB%E5%8A%A8%E7%AB%AF-1px-%E9%97%AE%E9%A2%98retina" title="#36-%E7%A7%BB%E5%8A%A8%E7%AB%AF-1px-%E9%97%AE%E9%A2%98retina">3.6 移动端 1px 问题（Retina）</a></li>
<li><a href="#37-%E9%9A%90%E8%97%8F%E5%85%83%E7%B4%A0displaynone--visibilityhidden--opacity0" title="#37-%E9%9A%90%E8%97%8F%E5%85%83%E7%B4%A0displaynone--visibilityhidden--opacity0">3.7 隐藏元素：<code>display:none</code> / <code>visibility:hidden</code> / <code>opacity:0</code></a></li>
<li><a href="#38-%E5%93%8D%E5%BA%94%E5%BC%8F%E5%B8%83%E5%B1%80-sop%E6%AD%A5%E9%AA%A4--%E4%B8%8D%E5%90%8C%E5%9C%BA%E6%99%AF%E6%96%B9%E6%A1%88" title="#38-%E5%93%8D%E5%BA%94%E5%BC%8F%E5%B8%83%E5%B1%80-sop%E6%AD%A5%E9%AA%A4--%E4%B8%8D%E5%90%8C%E5%9C%BA%E6%99%AF%E6%96%B9%E6%A1%88">3.8 响应式布局 SOP（步骤 + 不同场景方案）</a></li>
</ul>
</li>
<li><a href="#4-%E9%AB%98%E9%A2%91%E5%9C%BA%E6%99%AF%E9%A2%98%E9%9D%A2%E8%AF%95%E7%9B%B4%E6%8E%A5%E7%94%A8" title="#4-%E9%AB%98%E9%A2%91%E5%9C%BA%E6%99%AF%E9%A2%98%E9%9D%A2%E8%AF%95%E7%9B%B4%E6%8E%A5%E7%94%A8">4. 高频场景题（面试直接用）</a></li>
</ul>
<hr/>
<h2 data-id="heading-1">1. HTML 篇</h2>
<h3 data-id="heading-2">1.1 语义化（Semantic HTML）</h3>
<ul>
<li><strong>是什么</strong>
<ul>
<li>使用符合内容含义的标签（<code>header/nav/main/article/section/aside/footer</code>、<code>h1-h6</code>、<code>p</code>、<code>ul/li</code>、<code>figure/figcaption</code> 等）描述结构，而不是全用 <code>div/span</code>。</li>
</ul>
</li>
<li><strong>为什么（收益）</strong>
<ul>
<li><strong>SEO</strong>：搜索引擎更容易理解页面结构与权重。</li>
<li><strong>可访问性（A11y）</strong>：读屏软件更好解析；键盘导航更顺。</li>
<li><strong>可维护性</strong>：结构清晰，样式/脚本更容易定位。</li>
<li><strong>默认行为</strong>：例如 <code>button</code> 天然可聚焦、可键盘触发。</li>
</ul>
</li>
<li><strong>常见追问</strong>
<ul>
<li><strong><code>section</code> vs <code>div</code></strong>：<code>section</code> 表示主题分区（通常应该有标题），<code>div</code> 是无语义容器。</li>
<li><strong><code>em/strong</code> vs <code>i/b</code></strong>：前者强调语义，后者偏展示。</li>
</ul>
</li>
<li><strong>常见坑</strong>
<ul>
<li><code>div</code> 冒充按钮但缺少 <code>role="button"</code>、<code>tabindex="0"</code>、键盘事件。</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-3">1.2 块级/行内/行内块</h3>
<ul>
<li><strong>块级（block）</strong>：独占一行；可设置 <code>width/height/margin/padding</code>。</li>
<li><strong>行内（inline）</strong>：不独占一行；<code>width/height</code> 通常不生效；<code>margin-top/bottom</code> 通常不生效。</li>
<li><strong>行内块（inline-block）</strong>：不独占一行，但可设置 <code>width/height</code>。</li>
<li><strong>追问：<code>inline-block</code> 空白间隙怎么解决</strong>
<ul>
<li>删除标签间空白/换行；父元素 <code>font-size:0</code>；或者直接改用 <code>flex/grid</code>。</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-4">1.3 <code>script</code> 的 <code>async</code> / <code>defer</code> 区别</h3>
<ul>
<li><strong>无 <code>async/defer</code></strong>：下载+执行会阻塞 HTML 解析。</li>
<li><strong><code>defer</code></strong>：并行下载；等 DOM 解析完成后按顺序执行；适合业务脚本。</li>
<li><strong><code>async</code></strong>：并行下载；下载完立刻执行（可能打断解析）；顺序不保证；适合统计/埋点。</li>
<li><strong>追问</strong>
<ul>
<li><code>type="module"</code>：模块脚本默认行为更接近 <code>defer</code>（并行下载，解析后执行）。</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-5">1.4 <code>meta viewport</code></h3>
<p>常用写法：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span> /&gt;</span>
</code></pre>
<ul>
<li><strong>作用</strong>：控制移动端布局视口宽度与缩放，避免页面被缩小。</li>
<li><strong>工程提醒</strong>
<ul>
<li>不建议为了“防缩放”随意加 <code>user-scalable=no</code>（可访问性风险）。</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-6">1.5 <code>img</code> 的 <code>alt</code>、懒加载与图片性能</h3>
<ul>
<li><strong><code>alt</code></strong>：图片加载失败的替代文本；对 SEO/读屏重要。</li>
<li><strong>懒加载</strong>
<ul>
<li>原生：<code>loading="lazy"</code></li>
<li>更强控制：IntersectionObserver</li>
</ul>
</li>
<li><strong>响应式图片</strong>：<code>srcset/sizes</code>（按容器加载不同分辨率）。</li>
</ul>
<hr/>
<h3 data-id="heading-7">1.6 表单与可访问性（A11y）</h3>
<ul>
<li><strong><code>label</code> 与 <code>input</code> 绑定</strong>
<ul>
<li><code>label for="id"</code> + <code>input id="id"</code>，或 <code>label</code> 包裹 <code>input</code>。</li>
</ul>
</li>
<li><strong><code>button</code> 默认类型</strong>
<ul>
<li><code>form</code> 内默认 <code>type="submit"</code>，非提交按钮要显式写 <code>type="button"</code>。</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-8">2. CSS 基础与原理篇</h2>
<h3 data-id="heading-9">2.1 选择器优先级（Specificity）</h3>
<ul>
<li><strong>常见优先级从高到低</strong>
<ul>
<li><code>!important</code> &gt; 行内样式 &gt; <code>#id</code> &gt; <code>.class/[attr]/:pseudo-class</code> &gt; <code>tag/::pseudo-element</code> &gt; 通配 <code>*</code>/继承</li>
</ul>
</li>
<li><strong>同级规则</strong>
<ul>
<li>优先级相同：后写覆盖先写。</li>
</ul>
</li>
<li><strong>坑</strong>
<ul>
<li><code>:not()</code> 本身不加权重，但括号里的选择器会增加权重。</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-10">2.2 盒模型与 <code>box-sizing</code></h3>
<ul>
<li><strong>标准盒模型</strong>：<code>width/height</code> 只包含 <code>content</code>。</li>
<li><strong>工程推荐</strong>：全局 <code>box-sizing: border-box;</code>，布局更符合“视觉宽度”。</li>
</ul>
<hr/>
<h3 data-id="heading-11">2.3 BFC（块级格式化上下文）</h3>
<ul>
<li><strong>人话解释</strong>：BFC 是一个独立的渲染区域/布局“结界”，内部布局不会在某些方面影响外部。</li>
<li><strong>常见触发方式</strong>
<ul>
<li><code>overflow</code> 非 <code>visible</code></li>
<li><code>display: flow-root</code>（推荐）/<code>flex</code>/<code>grid</code>/<code>inline-block</code></li>
<li><code>position: absolute/fixed</code></li>
</ul>
</li>
<li><strong>经典用途</strong>
<ul>
<li>清除浮动造成的父元素高度塌陷</li>
<li>避免 margin 合并</li>
<li>两栏布局：让右侧自适应不被浮动覆盖</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-12">2.4 浮动与清除浮动</h3>
<ul>
<li><strong>塌陷原因</strong>：浮动元素脱离普通流，不撑开父元素高度。</li>
<li><strong>清除方式</strong>
<ul>
<li>伪元素 clearfix</li>
<li>触发 BFC：<code>overflow: hidden</code> 或 <code>display: flow-root</code></li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-13">2.5 <code>position</code>：relative/absolute/fixed/sticky</h3>
<ul>
<li><code>relative</code>：不脱离文档流；偏移相对自身原位置。</li>
<li><code>absolute</code>：脱离文档流；相对最近定位祖先。</li>
<li><code>fixed</code>：相对视口；注意某些场景会受祖先 <code>transform</code> 影响。</li>
<li><code>sticky</code>：滚动到阈值后吸顶；必须指定 <code>top/left/...</code>。</li>
</ul>
<hr/>
<h3 data-id="heading-14">2.6 Flex：<code>flex: 1</code>、压缩、溢出与 <code>min-width: 0</code></h3>
<ul>
<li><strong><code>flex: 1</code> 常见解释</strong>：<code>flex: 1 1 0%</code>，用于均分剩余空间。</li>
<li><strong>高频坑：长文本把布局撑爆</strong>
<ul>
<li>Flex 子项默认 <code>min-width: auto</code>，内容过长会撑开。</li>
<li><strong>工程解法</strong>：在需要截断/可滚动的子项上加 <code>min-width: 0</code>。</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-15">2.7 Grid：二维布局加分项</h3>
<ul>
<li>更适合二维栅格布局；常用 <code>repeat()</code>、<code>minmax()</code>、<code>fr</code>、<code>gap</code>。</li>
</ul>
<hr/>
<h3 data-id="heading-16">2.8 常见居中方案</h3>
<ul>
<li>Flex：</li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.parent</span> { <span class="hljs-attribute">display</span>: flex; <span class="hljs-attribute">justify-content</span>: center; <span class="hljs-attribute">align-items</span>: center; }
</code></pre>
<ul>
<li>Grid：</li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.parent</span> { <span class="hljs-attribute">display</span>: grid; place-items: center; }
</code></pre>
<ul>
<li>绝对定位 + transform：</li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.child</span> { <span class="hljs-attribute">position</span>: absolute; <span class="hljs-attribute">top</span>: <span class="hljs-number">50%</span>; <span class="hljs-attribute">left</span>: <span class="hljs-number">50%</span>; <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translate</span>(-<span class="hljs-number">50%</span>, -<span class="hljs-number">50%</span>); }
</code></pre>
<hr/>
<h3 data-id="heading-17">2.9 <code>z-index</code> 与层叠上下文（Stacking Context）</h3>
<ul>
<li><strong>结论</strong>：<code>z-index</code> 只在同一层叠上下文里比较。</li>
<li><strong>常见创建层叠上下文</strong>
<ul>
<li><code>position</code> 非 static + <code>z-index</code> 非 auto</li>
<li><code>transform</code> 非 none、<code>opacity &lt; 1</code> 等</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-18">2.10 继承、层叠、计算值（CSS 三板斧）</h3>
<ul>
<li><strong>继承</strong>：如 <code>color</code>、<code>font-*</code> 常继承；<code>margin/padding/border</code> 不继承。</li>
<li><strong>层叠</strong>：来源 + 权重 + 顺序共同决定。</li>
</ul>
<hr/>
<h3 data-id="heading-19">2.11 响应式单位与媒体查询</h3>
<ul>
<li>单位：<code>%/rem/em/vw/vh</code> 各有场景。</li>
<li>断点：<code>@media (max-width: 768px) { ... }</code> 等。</li>
</ul>
<hr/>
<h3 data-id="heading-20">2.12 <code>transition</code> vs <code>animation</code> 与性能要点</h3>
<ul>
<li><code>transition</code>：状态变化触发。</li>
<li><code>animation</code>：<code>@keyframes</code> 更复杂时间线。</li>
<li><strong>性能建议</strong>：优先动画 <code>transform/opacity</code>，避免高频动画 <code>top/left/width/height</code>。</li>
</ul>
<hr/>
<h2 data-id="heading-21">3. 工程化与落地（公司最常用）</h2>
<h3 data-id="heading-22">3.1 移动端适配选型：<code>rem</code> / <code>vw</code> / <code>rpx</code> / <code>scale</code></h3>
<ul>
<li><strong>核心结论</strong>
<ul>
<li>你不应该让开发“手写 rem/vw”，而是：<strong>代码里写 <code>px</code>，构建阶段自动转换</strong>。</li>
<li>场景选型：
<ul>
<li><strong>新 H5 项目</strong>：更偏向 <code>vw</code>（PostCSS 转换）</li>
<li><strong>老项目/兼容性要求极高</strong>：<code>rem</code>（动态 root + PostCSS 转换）</li>
<li><strong>uni-app/小程序</strong>：<code>rpx</code></li>
<li><strong>大屏可视化</strong>：容器等比缩放 <code>transform: scale()</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-23">3.2 H5（Vue/React）方案：PostCSS 自动转换（推荐写 <code>px</code>）</h3>
<h4 data-id="heading-24">方案 A：<code>vw</code>（推荐）+ <code>postcss-px-to-viewport</code></h4>
<ul>
<li><strong>典型配置（<code>postcss.config.js</code>）</strong></li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">plugins</span>: {
    <span class="hljs-string">'postcss-px-to-viewport'</span>: {
      <span class="hljs-attr">viewportWidth</span>: <span class="hljs-number">375</span>,
      <span class="hljs-attr">unitPrecision</span>: <span class="hljs-number">5</span>,
      <span class="hljs-attr">viewportUnit</span>: <span class="hljs-string">'vw'</span>,
      <span class="hljs-attr">selectorBlackList</span>: [<span class="hljs-string">'.ignore'</span>, <span class="hljs-string">'.hairlines'</span>],
      <span class="hljs-attr">minPixelValue</span>: <span class="hljs-number">1</span>,
      <span class="hljs-attr">mediaQuery</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">exclude</span>: [<span class="hljs-regexp">/node_modules/</span>],
    },
  },
}
</code></pre>
<ul>
<li><strong>公司里最常见的坑</strong>
<ul>
<li>UI 库（如 Vant）设计基准可能与业务设计稿不同（375 vs 750），不做隔离会导致 UI 库整体缩小/放大。</li>
<li>常见处理：<code>exclude</code> UI 库，或者使用支持动态 <code>viewportWidth</code> 的插件版本按路径区分。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-25">方案 B：<code>rem</code>（经典）+ <code>amfe-flexible</code> + <code>postcss-pxtorem</code></h4>
<ul>
<li><strong>核心点</strong>：动态设置 <code>html</code> 的 <code>font-size</code>，并在构建阶段将 <code>px</code> 转 <code>rem</code>。</li>
<li><strong>典型配置要点（按 UI 库/业务代码区分 rootValue）</strong></li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">plugins</span>: {
    <span class="hljs-string">'postcss-pxtorem'</span>: {
      <span class="hljs-title function_">rootValue</span>(<span class="hljs-params">{ file }</span>) {
        <span class="hljs-keyword">return</span> file.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">'vant'</span>) !== -<span class="hljs-number">1</span> ? <span class="hljs-number">37.5</span> : <span class="hljs-number">75</span>
      },
      <span class="hljs-attr">propList</span>: [<span class="hljs-string">'*'</span>],
      <span class="hljs-attr">selectorBlackList</span>: [<span class="hljs-string">'.norem'</span>],
    },
  },
}
</code></pre>
<hr/>
<h3 data-id="heading-26">3.3 uni-app / 小程序：<code>rpx</code> 与安全区</h3>
<ul>
<li><strong>单位</strong>：优先 <code>rpx</code>，常配合 750 设计稿心智最一致。</li>
<li><strong>布局</strong>：以 <code>flex</code> 为主，少用硬编码高度。</li>
<li><strong>安全区（底部 Home 指示条）</strong></li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.page</span> {
  <span class="hljs-attribute">padding-bottom</span>: <span class="hljs-built_in">env</span>(safe-area-inset-bottom);
}
</code></pre>
<hr/>
<h3 data-id="heading-27">3.4 PC 响应式（B 端/官网）：版心 + 断点 + Flex/Grid</h3>
<ul>
<li><strong>不要</strong>在 PC 全站做 rem/vw 等比缩放（屏幕跨度太大，体验不可控）。</li>
<li><strong>常见落地组合</strong>
<ul>
<li>版心：<code>max-width: 1200px/1440px; margin: 0 auto;</code></li>
<li>布局：Flex/Grid</li>
<li>断点：对关键布局重排</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-keyword">@media</span> screen <span class="hljs-keyword">and</span> (<span class="hljs-attribute">max-width</span>: <span class="hljs-number">992px</span>) {
  <span class="hljs-selector-class">.sidebar</span> { <span class="hljs-attribute">display</span>: none; }
}
</code></pre>
<hr/>
<h3 data-id="heading-28">3.5 大屏可视化：容器等比缩放（<code>transform: scale</code>）</h3>
<ul>
<li><strong>适用</strong>：强视觉还原、固定画布（如 1920x1080）。</li>
<li><strong>核心代码（监听 resize 计算 scale）</strong></li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">fitScreen</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> designW = <span class="hljs-number">1920</span>
  <span class="hljs-keyword">const</span> designH = <span class="hljs-number">1080</span>
  <span class="hljs-keyword">const</span> scaleX = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span> / designW
  <span class="hljs-keyword">const</span> scaleY = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span> / designH
  <span class="hljs-keyword">const</span> scale = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(scaleX, scaleY)
  <span class="hljs-keyword">const</span> el = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'screen'</span>)
  el.<span class="hljs-property">style</span>.<span class="hljs-property">transform</span> = <span class="hljs-string">`scale(<span class="hljs-subst">${scale}</span>)`</span>
  el.<span class="hljs-property">style</span>.<span class="hljs-property">transformOrigin</span> = <span class="hljs-string">'left top'</span>
}

<span class="hljs-title function_">fitScreen</span>()
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, fitScreen)
</code></pre>
<ul>
<li><strong>注意</strong>：如果涉及点击/拖拽坐标，需要按 <code>scale</code> 反算。</li>
</ul>
<hr/>
<h3 data-id="heading-29">3.6 移动端 1px 问题（Retina）</h3>
<ul>
<li><strong>现象</strong>：高 DPR 屏上 <code>1px</code> 视觉上变粗。</li>
<li><strong>常见落地</strong>：伪元素 + 缩放</li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.border-1px</span> {
  <span class="hljs-attribute">position</span>: relative;
}

<span class="hljs-selector-class">.border-1px</span><span class="hljs-selector-pseudo">::after</span> {
  <span class="hljs-attribute">content</span>: <span class="hljs-string">""</span>;
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">bottom</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">1px</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#ccc</span>;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">scaleY</span>(<span class="hljs-number">0.5</span>);
  <span class="hljs-attribute">transform-origin</span>: <span class="hljs-number">0</span> <span class="hljs-number">0</span>;
}
</code></pre>
<hr/>
<h3 data-id="heading-30">3.7 隐藏元素：<code>display:none</code> / <code>visibility:hidden</code> / <code>opacity:0</code></h3>
<ul>
<li><code>display: none</code>：不占位；触发 reflow；不可点击。</li>
<li><code>visibility: hidden</code>：占位；触发 repaint；不可点击。</li>
<li><code>opacity: 0</code>：占位；通常 repaint；仍可点击（除非配合 <code>pointer-events: none</code>）。</li>
</ul>
<hr/>
<h3 data-id="heading-31">3.8 响应式布局 SOP（步骤 + 不同场景方案）</h3>
<blockquote>
<p>你可以把这一节当成：面试回答模板 + 项目落地 SOP（标准操作流程）。</p>
</blockquote>
<h4 data-id="heading-32">3.8.1 先给结论：响应式不是一个技术点，是“策略组合”</h4>
<ul>
<li><strong>A. 等比缩放</strong>：页面整体按比例放大缩小
<ul>
<li>常见：大屏看板、强还原活动页</li>
</ul>
</li>
<li><strong>B. 响应式重排</strong>：不同宽度下布局结构变化
<ul>
<li>常见：PC 官网 / B 端</li>
</ul>
</li>
<li><strong>C. 流式自适应</strong>：布局不大改，但局部宽高、字体、间距自适应
<ul>
<li>常见：移动端业务 H5</li>
</ul>
</li>
</ul>
<h4 data-id="heading-33">3.8.2 落地步骤（SOP：从需求到上线）</h4>
<ul>
<li>
<p><strong>Step 1：明确输入条件（必须问清）</strong></p>
<ul>
<li>设计基准：设计稿宽度（<code>375</code> / <code>750</code> / <code>1200</code> / <code>1920x1080</code>）</li>
<li>目标设备：移动端 H5（WebView/浏览器）/ PC / 小程序（含 uni-app）/ 大屏</li>
<li>是否允许重排：是否能接受某些屏幕变成单列、某些模块折行</li>
<li>兼容性要求：最低 iOS/Android/浏览器版本</li>
<li>关键体验约束：固定底栏/弹窗、长列表、图表/Canvas 等</li>
</ul>
</li>
<li>
<p><strong>Step 2：先选布局骨架（优先级：Grid &gt; Flex &gt; 传统）</strong></p>
<ul>
<li>二维区域布局/栅格：优先 <code>grid</code></li>
<li>一维布局（横排/竖排）：优先 <code>flex</code></li>
<li>避免用 <code>float</code> 作为布局系统（除非老项目维护）</li>
</ul>
</li>
<li>
<p><strong>Step 3：确定“尺寸体系”（决定 rem/vw/px/clamp 的组合）</strong></p>
<ul>
<li>移动端 H5：推荐“写 <code>px</code> + PostCSS 自动转换为 <code>vw</code>/<code>rem</code>”</li>
<li>PC：以 <code>px</code> 为主 + 版心 + 断点（必要时少量 <code>%/fr</code>）</li>
<li>大屏：内部按设计稿 <code>px</code>，外层容器 <code>transform: scale()</code></li>
</ul>
</li>
<li>
<p><strong>Step 4：断点策略（不是越多越好）</strong></p>
<ul>
<li>移动端：通常少断点，更多靠流式布局；必要时单独考虑 Pad（<code>&gt;=768</code>）</li>
<li>PC：常用 3-5 个断点（如 <code>1200/992/768/576</code>）就够用</li>
<li>大屏：优先等比缩放，不建议靠大量断点救火</li>
</ul>
</li>
<li>
<p><strong>Step 5：上线前兜底（公司里最容易翻车的地方）</strong></p>
<ul>
<li>文本溢出：单行/多行省略号，Flex 子项记得 <code>min-width: 0</code></li>
<li>图片：<code>max-width: 100%</code>、必要时 <code>object-fit: cover</code></li>
<li>安全区：<code>env(safe-area-inset-bottom)</code></li>
<li>性能：动画只动 <code>transform/opacity</code>；长列表考虑虚拟列表</li>
</ul>
</li>
</ul>
<h4 data-id="heading-34">3.8.3 不同场景的“对口方案”（可直接落地）</h4>
<ul>
<li>
<p><strong>移动端 H5（业务页/内嵌页）</strong></p>
<ul>
<li>目标：流式自适应为主，不追求像素级完全一致</li>
<li>推荐：<code>flex/grid</code> + PostCSS（<code>px -&gt; vw</code>）+ <code>clamp()</code> 做上下限 + 安全区/1px/弹窗兜底</li>
</ul>
</li>
<li>
<p><strong>PC 官网 / B 端后台</strong></p>
<ul>
<li>目标：断点重排 + 版心控制阅读宽度</li>
<li>推荐：Grid 做栅格区域 + Flex 做组件内部；<code>max-width</code> 版心；关键断点重排（侧边栏折叠等）</li>
</ul>
</li>
<li>
<p><strong>uni-app / 小程序</strong></p>
<ul>
<li>目标：利用平台原生适配能力</li>
<li>推荐：<code>rpx + flex</code>；优先使用生态组件库，减少引入写死 <code>px</code> 的第三方 H5 样式</li>
</ul>
</li>
<li>
<p><strong>大屏可视化（DataV/看板）</strong></p>
<ul>
<li>目标：严格保真，不换行、不乱跑位</li>
<li>推荐：内部按设计稿 <code>px</code> 写，外层 <code>transform: scale()</code>，交互坐标按 scale 反算</li>
</ul>
</li>
</ul>
<h4 data-id="heading-35">3.8.4 面试一句话收尾（背下来）</h4>
<blockquote>
<p>“响应式我会先明确目标是等比缩放还是断点重排。移动端业务页用 Flex/Grid + PostCSS 的 vw（必要时 clamp）保证流式自适应；PC 端用版心 + 断点做结构重排；小程序用 rpx；大屏用容器 scale 保真。最后统一补齐文本溢出、安全区、1px、弹窗与性能兜底。”</p>
</blockquote>
<hr/>
<h2 data-id="heading-36">4. 高频场景题（面试直接用）</h2>
<h3 data-id="heading-37">4.1 三栏布局：两侧固定，中间自适应</h3>
<ul>
<li>
<p><strong>可背诵答案（30 秒版）</strong></p>
<ul>
<li>“我会优先用 flex：左右两栏固定宽度，中间一栏 <code>flex: 1</code> 占满剩余空间。中间为了防止长文本把布局撑爆，会显式加 <code>min-width: 0</code>，再配合 <code>overflow: hidden; text-overflow: ellipsis;</code> 或内部滚动。”</li>
</ul>
</li>
<li>
<p><strong>推荐实现（Flex）</strong></p>
</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"layout"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">aside</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"left"</span>&gt;</span>left<span class="hljs-tag">&lt;/<span class="hljs-name">aside</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">main</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"mid"</span>&gt;</span>middle middle middle ...<span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">aside</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"right"</span>&gt;</span>right<span class="hljs-tag">&lt;/<span class="hljs-name">aside</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.layout</span> {
  <span class="hljs-attribute">display</span>: flex;
}

<span class="hljs-selector-class">.left</span>,
<span class="hljs-selector-class">.right</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">200px</span>;
  <span class="hljs-attribute">flex</span>: <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">200px</span>;
}

<span class="hljs-selector-class">.mid</span> {
  <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span>;
  <span class="hljs-attribute">min-width</span>: <span class="hljs-number">0</span>; <span class="hljs-comment">/* 关键：允许在 flex 容器内缩小，避免长内容撑爆 */</span>
}
</code></pre>
<ul>
<li><strong>高频追问</strong>
<ul>
<li>为什么要 <code>min-width: 0</code>：Flex 子项默认 <code>min-width: auto</code>，内容过长会让它不愿意缩小。</li>
<li>不用 flex 你还有方案吗：Grid（更适合二维），以及老方案（float + BFC/定位）但现代不推荐。</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-38">4.2 弹窗 <code>z-index: 9999</code> 仍被遮住</h3>
<ul>
<li>
<p><strong>可背诵答案（30 秒版）</strong></p>
<ul>
<li>“<code>z-index</code> 只在同一个层叠上下文里比较。如果弹窗的祖先元素创建了层叠上下文（比如 <code>transform</code>、<code>opacity&lt;1</code>、<code>position+z-index</code>），那弹窗的 <code>z-index</code> 再大也只能在这个上下文里排队，盖不住别的上下文。工程上我通常把弹窗挂到 <code>body</code>（React Portal / Vue Teleport），从根层级统一管理。”</li>
</ul>
</li>
<li>
<p><strong>如何快速定位（排查路径）</strong></p>
<ul>
<li>检查弹窗及其祖先是否存在：
<ul>
<li><code>transform: translateZ(0)</code> / <code>transform: ...</code></li>
<li><code>opacity &lt; 1</code></li>
<li><code>position</code> 非 static 且 <code>z-index</code> 非 auto</li>
<li><code>filter</code>、<code>will-change</code> 等</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>工程落地建议</strong></p>
<ul>
<li><strong>组件库/业务统一方案</strong>：全站只有一个 <code>#modal-root</code>，所有弹窗都挂载到这里。</li>
<li><strong>管理策略</strong>：用“弹窗栈”管理层级（比如每开一个弹窗，z-index 递增）。</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-39">4.3 <code>position: sticky</code> 不生效</h3>
<ul>
<li>
<p><strong>可背诵答案（30 秒版）</strong></p>
<ul>
<li>“<code>sticky</code> 需要一个滚动容器，并且必须指定 <code>top/left/right/bottom</code> 其中一个阈值。常见失效原因是祖先设置了 <code>overflow: hidden/auto/scroll</code> 改变了滚动容器，或者容器高度不足导致根本触发不了吸附。”</li>
</ul>
</li>
<li>
<p><strong>常见失效清单（面试官最爱挖坑）</strong></p>
<ul>
<li>没写 <code>top</code>（最常见）</li>
<li>父级/祖先 <code>overflow</code> 非 <code>visible</code>（尤其 <code>overflow: hidden</code>）</li>
<li>滚动发生在另一个容器（不是你以为的 window）</li>
<li>sticky 元素所在容器高度不够（滚动距离不足）</li>
</ul>
</li>
<li>
<p><strong>参考代码</strong></p>
</li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.sticky</span> {
  <span class="hljs-attribute">position</span>: sticky;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">z-index</span>: <span class="hljs-number">10</span>;
}
</code></pre>
<hr/>
<h3 data-id="heading-40">4.4 回流（reflow）/重绘（repaint）与优化</h3>
<ul>
<li>
<p><strong>可背诵答案（60 秒版）</strong></p>
<ul>
<li>“回流是布局计算阶段（尺寸/位置变化导致 Layout 重新算），重绘是像素绘制阶段（颜色/阴影变化触发 Paint）。回流一定会引起重绘，重绘不一定回流。优化上：尽量减少触发布局的属性变化，把动画放到 <code>transform/opacity</code>，批量读写 DOM，避免强制同步布局（比如频繁读 <code>offsetHeight</code>）。长列表用虚拟列表，图片用懒加载。”</li>
</ul>
</li>
<li>
<p><strong>常见触发回流的操作（会被追问）</strong></p>
<ul>
<li>改几何属性：<code>width/height/padding/margin/top/left/border</code>（部分）</li>
<li>插入/删除 DOM 节点，改变字体大小</li>
<li>读取布局信息会触发“强制同步布局”：<code>offsetHeight/getBoundingClientRect</code>（在你前面有写操作时）</li>
</ul>
</li>
<li>
<p><strong>工程级优化清单</strong></p>
<ul>
<li>动画：只动 <code>transform/opacity</code>（必要时 <code>will-change</code>，但别滥用）</li>
<li>DOM：合并操作（改 class 而不是逐条改 style），读写分离</li>
<li>长列表：虚拟列表/分页渲染</li>
<li>新特性加分：<code>content-visibility: auto;</code>（对长页面有帮助）</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-41">4.5 两栏布局：左固定右自适应（最常用）</h3>
<ul>
<li><strong>Flex 推荐写法</strong></li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.wrap</span> { <span class="hljs-attribute">display</span>: flex; }
<span class="hljs-selector-class">.left</span> { <span class="hljs-attribute">width</span>: <span class="hljs-number">240px</span>; <span class="hljs-attribute">flex</span>: <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">240px</span>; }
<span class="hljs-selector-class">.right</span> { <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span>; <span class="hljs-attribute">min-width</span>: <span class="hljs-number">0</span>; }
</code></pre>
<ul>
<li><strong>追问点</strong>
<ul>
<li>右侧内容长导致撑开：同样用 <code>min-width: 0</code>。</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-42">4.6 文本溢出省略号：单行/多行</h3>
<ul>
<li><strong>单行省略号</strong></li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.ellipsis</span> {
  <span class="hljs-attribute">overflow</span>: hidden;
  <span class="hljs-attribute">text-overflow</span>: ellipsis;
  <span class="hljs-attribute">white-space</span>: nowrap;
}
</code></pre>
<ul>
<li><strong>多行省略号（常问，含兼容性）</strong></li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.clamp</span> {
  <span class="hljs-attribute">overflow</span>: hidden;
  <span class="hljs-attribute">display</span>: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-line-clamp: <span class="hljs-number">3</span>;
}
</code></pre>
<ul>
<li><strong>追问点</strong>
<ul>
<li>多行省略号是非标准方案（WebKit 私有），复杂场景可能要用 JS 计算。</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-43">4.7 图片底部为什么会有“缝隙”？怎么解决</h3>
<ul>
<li><strong>原因（面试点）</strong>
<ul>
<li><code>img</code> 默认是 inline 元素，会按基线对齐，基线下方留空给“下行字母”（descender）空间。</li>
</ul>
</li>
<li><strong>解决方案</strong>
<ul>
<li><code>img { display: block; }</code></li>
<li>或者父元素 <code>line-height: 0</code>（不推荐，影响可读性）</li>
<li>或 <code>vertical-align: middle/bottom;</code></li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-44">4.8 移动端底部安全区（iPhone 刘海屏/小白条）</h3>
<ul>
<li><strong>CSS 落地</strong></li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.footer</span> {
  <span class="hljs-attribute">padding-bottom</span>: <span class="hljs-built_in">env</span>(safe-area-inset-bottom);
}
</code></pre>
<ul>
<li><strong>追问点</strong>
<ul>
<li>除了 padding，还要做“固定底栏 + 占位”，避免内容被遮挡。</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-45">4.9 滚动穿透（弹窗打开后背景还能滚）怎么处理</h3>
<ul>
<li><strong>典型场景</strong>
<ul>
<li>移动端弹窗（mask）出现后，背景页面仍能滚动。</li>
</ul>
</li>
<li><strong>工程思路</strong>
<ul>
<li>Web：打开弹窗时锁住 body 滚动（记录滚动位置，关闭后恢复）。</li>
<li>iOS 上对 <code>position: fixed</code>/滚动容器要特别小心。</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-46">4.10 清除浮动有哪些方式？为什么现在更推荐 Flex/Grid</h3>
<ul>
<li>
<p><strong>可背诵答案（60 秒版）</strong></p>
<ul>
<li>“清除浮动本质是解决 <code>float</code> 脱离普通文档流导致的父元素高度塌陷。常见方案有三类：
<ol>
<li>经典 <code>clearfix</code> 伪元素清除；</li>
<li>让父容器触发 BFC（比如 <code>overflow: hidden</code>）；</li>
<li>更现代语义化的 <code>display: flow-root</code>。
但在新业务里我更倾向用 Flex/Grid 直接做布局，原因是 float 本身是为文字环绕设计的，不适合作为布局系统；Flex/Grid 更语义、更稳定、响应式更好，后期维护也不会出现各种清除浮动/塌陷的历史问题。”</li>
</ol>
</li>
</ul>
</li>
<li>
<p><strong>先把原理说清楚：为什么会“高度塌陷”</strong></p>
<ul>
<li>浮动元素会脱离普通流，父元素计算高度时只看普通流子元素，导致：
<ul>
<li>父容器高度变成 0（或只等于非浮动子元素高度）</li>
<li>后续兄弟元素上移/覆盖</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>方案 A：<code>clearfix</code>（经典方案，兼容性强）</strong></p>
</li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.clearfix</span><span class="hljs-selector-pseudo">::after</span> {
  <span class="hljs-attribute">content</span>: <span class="hljs-string">""</span>;
  <span class="hljs-attribute">display</span>: block;
  <span class="hljs-attribute">clear</span>: both;
}
</code></pre>
<ul>
<li>
<p><strong>优点</strong></p>
<ul>
<li>兼容性极好；不依赖布局上下文；老项目常见。</li>
</ul>
</li>
<li>
<p><strong>缺点</strong></p>
<ul>
<li>属于“历史包袱式”的补丁写法：你得记得给父容器加类名；结构不够语义化。</li>
</ul>
</li>
<li>
<p><strong>追问点</strong></p>
<ul>
<li>为什么 <code>clear: both</code> 有效：它会让伪元素排在浮动元素下方，从而撑开父容器高度。</li>
</ul>
</li>
<li>
<p><strong>方案 B：触发 BFC（常用但要注意副作用）</strong></p>
</li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.bfc</span> {
  <span class="hljs-attribute">overflow</span>: hidden; <span class="hljs-comment">/* 或 auto/scroll，非 visible */</span>
}
</code></pre>
<ul>
<li>
<p><strong>优点</strong></p>
<ul>
<li>一行代码解决塌陷；顺便能隔离 margin 合并等问题。</li>
</ul>
</li>
<li>
<p><strong>缺点 / 风险</strong></p>
<ul>
<li>可能裁剪溢出内容（比如阴影、下拉菜单、绝对定位的浮层）。</li>
<li>如果你用 <code>auto/scroll</code> 可能引入滚动条。</li>
</ul>
</li>
<li>
<p><strong>方案 C：<code>display: flow-root</code>（推荐写法：语义明确、无裁剪副作用）</strong></p>
</li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.flow-root</span> {
  <span class="hljs-attribute">display</span>: flow-root;
}
</code></pre>
<ul>
<li>
<p><strong>优点</strong></p>
<ul>
<li>直接创建新的 BFC，且不像 <code>overflow:hidden</code> 那样裁剪内容。</li>
<li>可读性强：看代码就知道“这是个独立的块级格式化上下文”。</li>
</ul>
</li>
<li>
<p><strong>缺点</strong></p>
<ul>
<li>老旧浏览器兼容性不如 clearfix（现代项目通常没问题）。</li>
</ul>
</li>
<li>
<p><strong>为什么现代更推荐 Flex/Grid（工程化理由）</strong></p>
<ul>
<li><strong>语义与目的匹配</strong>
<ul>
<li><code>float</code> 设计初衷是“文字环绕图片”，不是布局系统；拿 float 做布局会不断触发补丁需求。</li>
</ul>
</li>
<li><strong>更少的隐式规则/坑</strong>
<ul>
<li>float 布局经常伴随：清除浮动、塌陷、浮动覆盖、margin 合并等问题。</li>
<li>Flex/Grid 天然是布局模型，容器与子项职责清晰。</li>
</ul>
</li>
<li><strong>响应式更自然</strong>
<ul>
<li>Flex 的自适应、换行、对齐；Grid 的二维栅格与区域布局，做响应式更直观。</li>
</ul>
</li>
<li><strong>可维护性更好</strong>
<ul>
<li>代码更短、更一致；团队新人不需要背一堆历史兼容技巧。</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>加分回答：什么时候仍然会用 float？</strong></p>
<ul>
<li>文字环绕图片（比如富文本内容）</li>
<li>老项目维护（不大动结构的情况下，用 clearfix/BFC 快速止血）</li>
</ul>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[✨TRAE SOLO + Holopix AI | 复刻 GBA 游戏-"🐛口袋妖怪"]]></title>    <link>https://juejin.cn/post/7582755817671442442</link>    <guid>https://juejin.cn/post/7582755817671442442</guid>    <pubDate>2025-12-12T09:01:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582755817671442442" data-draft-id="7582763878674497563" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="✨TRAE SOLO + Holopix AI | 复刻 GBA 游戏-&quot;🐛口袋妖怪&quot;"/> <meta itemprop="keywords" content="Trae,AI编程,VibeCoding"/> <meta itemprop="datePublished" content="2025-12-12T09:01:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="coder_pig"/> <meta itemprop="url" content="https://juejin.cn/user/4142615541321928"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ✨TRAE SOLO + Holopix AI | 复刻 GBA 游戏-"🐛口袋妖怪"
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4142615541321928/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    coder_pig
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T09:01:55.000Z" title="Fri Dec 12 2025 09:01:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">1. 引言</h2>
<p>😄 不知不觉，今年已经用「<strong>AI编程工具</strong> + <strong>Holopix AI</strong> 」复刻了好几款游戏：<strong>塔防</strong>、<strong>转刀</strong>、<strong>射击</strong>、<strong>自走棋</strong>：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be82c5a809614f01b5003228b44b250a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=ijoInBbGsEeXfZ7m1wy4ZFrJehI%3D" alt="" loading="lazy"/></p>
<p>😶 但，都不是我喜欢的，我更怀念读书时的 "<strong>白月光</strong>" —— <strong>GBA《口袋妖怪(绿宝石)》</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f5c82d9fe5d4e2b8a2c1cef98fa8574~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=Mw6kQmRh6AQDCSpWEWnKkGNcisU%3D" alt="" loading="lazy"/></p>
<p>读初中那会，同学买了 <strong>GBA</strong>，软磨硬泡，才愿意晚上借我回家玩。🤡 有 "<strong>网瘾史</strong>"，父母不给玩游戏，等他们 "<strong>查房</strong>" 完，透过门缝看外面的灯关了，确认没动静后，才敢偷偷拿出来玩，有时没注意时间，一玩就是一个通宵，🤣 记得有次理发，钓🐟钓着钓着睡过去了。</p>
<p>唉，年轻真好啊，通宵几天都吃得消，现在不行了，晚上一两点睡，第二天起来浑身难受...</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10d96d9fc7964e92ba6344c1546f458a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=euC1F53J%2BI%2B03Pifdp8ELAZoowM%3D" alt="" loading="lazy"/></p>
<hr/>
<p><strong>AI</strong> 发展迅猛，今年的尾声，借助【<strong>TRAE SOLO + Holopix AI</strong>】来复刻这款游戏，试着找回当年那个 "<strong>无忧无虑</strong>" 的自己👶～</p>
<h2 data-id="heading-1">2. SOLO Time</h2>
<p>上节重构两项目用的 <strong>Agent</strong> 是 <strong>SOLO Coder</strong>，这节是 "<strong>创意快速落地</strong>"，所以用 <strong>SOLO Builder</strong>：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/878884a76ea44902a55f17113ab60a18~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=y4sLGP6vCesarzsQ4vzIkB7TG1I%3D" alt="" loading="lazy"/></p>
<p><strong>Vibe Coding</strong> 关键是 "<strong>文档先行</strong>" ❗️ 开发过程的每一步都要围绕 "<strong>文档</strong>" 进行，先让 <strong>AI</strong> 出 <strong>Plan</strong> 文档，你 <strong>审阅校对编辑</strong> 没问题后，才让 <strong>AI</strong> 照着文档开始干活。</p>
<p>这样做 "<strong>把控性</strong>" 更强，你能清楚知道 <strong>AI</strong> 要怎么做，而不是 "<strong>抽卡</strong>"，全靠 <strong>AI</strong> 自己发挥。产品开发的起点是 <strong>PRD</strong> (产品需求文档)，游戏则是 <strong>GDD</strong> (游戏设计文档)，先写 <strong>Prompt</strong> 让 <strong>Trae</strong> 对 "<strong>原始需求</strong>" 进行细化。</p>
<p><strong>SOLO Builder</strong> 模式没有 <strong>Plan</strong> 开关，需要在 <strong>Prompt</strong> 中写明生成 <strong>GDD</strong> 文档，不然它有时会直接开始 "<strong>堆代码</strong>"：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7cae3e828ad24d25925d28ce32c2ff91~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=rA51eH2QsYj%2BbCiUtHAOCstbpR4%3D" alt="" loading="lazy"/></p>
<p>生成结果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74485bbfeac74ab486132d1226c70074~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=4phjNO%2F2Sp0XF75BDErHI5eltGM%3D" alt="" loading="lazy"/></p>
<p>让我们确认几个 "<strong>立项目标</strong>"-复刻程度、技术栈选择、美术与资源，简单做下 "<strong>填空题</strong>"，<strong>Prompt</strong> 后面同样要加上 "<strong>先不要写代码，理解完需求，更新GDD文档</strong>"：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0977a1861f2346d3a4b5b2f77342302d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=cMO7RHp7L9eego863IJkOGsuV7Y%3D" alt="" loading="lazy"/></p>
<p>再次确认文档是否有误，比如：技术栈是否对味~</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1907142ca98143c8a6039822e5c19ad0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=npJqUDHKS4BJHlGTjrKEPBn%2FMOI%3D" alt="" loading="lazy"/></p>
<p>🤔 接着，直接让 <strong>Trae</strong> 按照这个 <strong>GDD</strong> 文档来干活吗？可以，但我倾向于再 "<strong>拆</strong>"，先做 "<strong>可行性的快速验证</strong>"，而不是直接一股脑干到头，这样省 <strong>Token</strong>，<strong>效率更佳</strong>，有不对的可以 <strong>快速调整</strong>：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd2dbd50b7b34c9c8ea2679145b207c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=c67OBzFIXO9AnbmI9ITm5tN1HU8%3D" alt="" loading="lazy"/></p>
<p>😏 不够，我还要玩更 "<strong>骚"</strong> 的 "<strong>多Agent并行</strong>"，把 <strong>Trae</strong> 的效率拉爆，写 <strong>Prompt</strong> 把 <strong>大任务</strong> 拆成多个 "<strong>可并行执行的小任务</strong>"，然后还是得生成 "<strong>文档</strong>"：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54bff0ec365644d0845376588aaa7057~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=7FacCzGrxj4gNzMCKAqC8UvaJ4U%3D" alt="" loading="lazy"/></p>
<hr/>
<p><strong>Trae</strong> 拆解成了 <strong>4</strong> 个小的 <strong>Task</strong>，并告知了我 "<strong>建议执行顺序</strong>"：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f0e7c6b3513a401a8feaaaaa8de22a16~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=QW0Xe9gkDJHRNOaI4o6CuMDMBPI%3D" alt="" loading="lazy"/></p>
<p>结构目录不是很好 (没分层)，让它调整一下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e57c6a3c13e74c749a2b43ce9c9e1c00~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=AeBiUL94ceZ7ZVlEiMOZPbJwk0Q%3D" alt="" loading="lazy"/></p>
<p>接着就是点击左上角的 " <strong>+ 新任务</strong>"，然后在每个 <strong>Agent</strong> 里写不同的 <strong>Prompt</strong>："执行xxx.md"：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b43683262bb4c44816f14ffeba9d9c7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=pHPcOmEzod%2F338BTZU4ZlWTGoZg%3D" alt="" loading="lazy"/></p>
<p>🤣 三架马车，并驾齐驱，何其壮观，<strong>泰裤辣</strong>！2333，就是 <strong>Token</strong> 烧得有点快...</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26e25d7371e04bc0ad7805709dd66af4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=%2BAIjBI3jjtbXSPQxmPmYVrPv9gc%3D" alt="" loading="lazy"/></p>
<p>😄 "<strong>简陋</strong>" 游戏雏形有了，接着，可以让 <strong>Trae</strong> 自检任务完成情况：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e15d39f04084b6eb641d1cc77880a33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=6TzK1EL3RU0GYpv%2BHMKzJHUAkW8%3D" alt="" loading="lazy"/></p>
<p>也可以让它基于 <strong>GDD</strong> 生成下一步的 <strong>Plan</strong>，然后就是重复上面的 "<strong>套路</strong>" 拆解任务分步执行，
💁‍♂️人靠衣裳马靠鞍，同时请出我们的老朋友「<a href="https://link.juejin.cn?target=https%3A%2F%2Fholopix.cn%3FinviteCode%3D563333" target="_blank" title="https://holopix.cn?inviteCode=563333" ref="nofollow noopener noreferrer"><strong>Holopix AI</strong></a>」来生成 <strong>UI素材</strong>，对游戏进行 "<strong>美化</strong>"~</p>
<h2 data-id="heading-2">3. Holopix AI 生成素材</h2>
<h3 data-id="heading-3">3.1. 定制一个 "GBA像素风" 模型</h3>
<p>😀 既然是想 "<strong>复刻</strong>"，那 "<strong>美术风格</strong>" 妥妥得搞成 "<strong>GBA像素风</strong>"，<strong>Holopix AI</strong> 提供了大量不同风格的 "<strong>预设模型</strong>"，随手搜了下 "<strong>像素</strong>"，都有 <strong>20+</strong> 种：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94f2cdbf9a1d44fa803362aab248a29f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=pIoNzleE%2FKXzw6Cf%2FfHJjxvIi8c%3D" alt="" loading="lazy"/></p>
<p>😃 不过，杰哥想更加 "<strong>原汁原味</strong>"，<a href="https://link.juejin.cn?target=https%3A%2F%2Fholopix.cn%2FlandingV2%3FinviteCode%3D563333" target="_blank" title="https://holopix.cn/landingV2?inviteCode=563333" ref="nofollow noopener noreferrer"><strong>Holopix AI</strong></a> ****是支持 "<strong>模型定制</strong>" 的，还记得上节 "<strong>坤坤自走棋</strong>"，我们用网上搜罗到的 "<strong>ikun小黄鸡</strong>" 图片作为素材，训练了一个专用用来生成小黄鸡的 "<strong>ikun</strong>" 模型吗？</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18caa5dcc6ee46459f3eb38bdf517046~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=lBGWq7p1agj8ZohYIIofbly7qT8%3D" alt="" loading="lazy"/></p>
<p>😄 这里我们 <strong>照葫芦画瓢</strong>，训练一个 "<strong>GBA像素风</strong>" 的模型，搜了下 "<strong>口袋妖怪素材</strong>"：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ac11bbbb6cb4ee68bf2ad2af30a3c78~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=%2BmnQZTl3dzZKS0mlhPqDU62BCuY%3D" alt="" loading="lazy"/></p>
<p>发现都是这样的 "<strong>精灵表</strong>" (纹理图集)，这是 2D<strong>游戏开发</strong> 的标准做法，为的是 "<strong>性能与效率</strong>"：</p>
<blockquote>
<p>GBA的图形芯片 (PPU) 没有 "加载图片" 的概念，它只能读取连续的显存块。开发者把所有角色动画帧拼成一张图，通过修改 <strong>UV坐标</strong> (读取位置) 来切换帧。切换动画帧只需改变内存偏移量，不消耗CPU，而且一张512x512的图集仅占256KB，而100张独立图片会因内存对齐浪费30%空间。</p>
</blockquote>
<p>即使今天硬件强大，"<strong>图集</strong>" 仍是最佳实践，表现在：</p>
<ul>
<li><strong>减少Draw Call</strong>：渲染100个独立图片=100次Draw Call；渲染1张图集=1次Draw Call。GPU批量渲染，帧率提升5-10倍。</li>
<li><strong>动画管理</strong>：动画软件能直接输出图集+坐标数据，游戏引擎可自动识别，无需手动切割和配置。</li>
<li><strong>动态合批</strong>：游戏引擎会将零散小图在运行时合并成图集 (VRAM)，提供预制图集可跳过这一步，启动更快。</li>
<li><strong>像素完美</strong>：独立图片导入时可能因压缩产生1像素透明边，图集一次导出，所有帧共用统一调色板，杜绝色差。</li>
</ul>
<p>😁 扯得有点远了，接着写 <strong>Prompt</strong> 让 <strong>TRAE</strong> 用 <strong>哈基米3</strong> 写脚本切下图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a41b500cde6f48e9b7db02b128c6ad46~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=VvCfzgp6AFrjGyEGcDjtnElzV9I%3D" alt="" loading="lazy"/></p>
<p>有点切歪了，问题不大，截图发它重新切，顺手 <strong>去掉蓝色背景</strong> + <strong>调整图片分辨率</strong> 为 <strong>256x256</strong>，这是 <strong>训练模型</strong> 用到素材图片的 "<strong>最小分辨率</strong>"：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6710488945bd4cd397eebcfa51493773~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=okPs5Mf371Hm4%2F5Pny0jpEfThgE%3D" alt="" loading="lazy"/></p>
<p>打开 <strong>Holopix AI</strong> 官网，点击左侧 "<strong>模型定制</strong>" → "<strong>开始模型训练</strong>"：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6897acfcc624440b7ee074b1cf0fbfc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=gRW9nrqVd3yZ8aiC%2B8yfTDjNcsU%3D" alt="" loading="lazy"/></p>
<p>训练类型选 "<strong>icon道具</strong>"，训练强度选 "<strong>低</strong>"，然后点击 <strong>上传图片</strong>：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd460c21c5834b50b0c9a6490335e944~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=LBIHsEc08QXiS5Pa8QhVmtDp%2BdU%3D" alt="" loading="lazy"/></p>
<p>选中我们的宝可梦素材 (最多200张)：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f21b35fc751c47b9853fecf046adbda8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=nty6%2F2CH1tykewb%2BBwZJ%2BQwU%2F2w%3D" alt="" loading="lazy"/></p>
<p>提交后，等模型训练完，会有消息通知，一般要 <strong>2-10h</strong>：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2f2e7f77ef849e697da59043ab75d9a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=fefd8p3ZcIcTFU1ct1YQWSz8aVA%3D" alt="" loading="lazy"/></p>
<p>收到成功通知后，可到 "<strong>模型定制</strong>" → "<strong>我的模型</strong>" 找到训练好的模型，点击 <strong>开始创作</strong>：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/526b694491cb4c818dbbd8381e326bcb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=JaqIjCtLMzAPLaoZD6S8XU%2FjREk%3D" alt="" loading="lazy"/></p>
<p>随便输几个描述词看看效果：皮卡丘、绿毛龟、绿色喷火龙，水箭龟：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c0a747114f4e436691de75f08076d7b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=JYItyTtoZuq%2FGBbEj8dbCFx%2BxhY%3D" alt="" loading="lazy"/></p>
<p>😳 卧槽，"<strong>DNA</strong>" 动了！然后，现在这个模型只有 "<strong>自己可见</strong>"，好东西肯定要分享的，接着发布一下模型：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/86a0070e0edc4a11868d5831982e9159~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=ndt%2BYc9RnohohzfNIFJREdgOY2Q%3D" alt="" loading="lazy"/></p>
<p>做下填空，然后 <strong>示例图</strong> 直接选 "<strong>从创作记录导入</strong>"，选几张还凑合的，点击发布，然后别人就能搜到你的模型了：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c2a5256cacf94dfa83ef10fc7f8469a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=b1SXEr3aqfUuJN%2BSvvVSy1LYn1s%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">3.2. 宝可梦 &amp; 道具 &amp; 角色</h3>
<p>😆 接着用我们上面训练的模型来生成 "<strong>宝可梦</strong>" 和 "<strong>道具</strong>"，生图 <strong>Prompt</strong> 可以让 <strong>Trae</strong> 生成一个素材清单：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/398d7e95c59d437aa52919a75cc506d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=9jnV5g20meCsskqtprf4qk1cmZc%3D" alt="" loading="lazy"/></p>
<p>不过这种批量生成 <strong>Prompt</strong> 的一般都比较 "<strong>简陋</strong>"，可以用 <strong>Holopix AI</strong> 提供的 "<strong>智能优化</strong>" 进行润色：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6704abb4122844f3847fba9bdd41a910~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=SXo1CcdDR6eb8Ya80LsEsLI04q8%3D" alt="" loading="lazy"/></p>
<p>接着就是重复 "<strong>抽卡</strong>"，选择中意的素材了，部分生成素材：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15e913b7004a49fbba65c99d578f40f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=y5jgPs5AhKeDcfqmQmGH4ueV26k%3D" alt="" loading="lazy"/></p>
<p>接着让 <strong>Trae</strong> 应用看下效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9523eaaec356470ca4ec94c49105717d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=HLufc3h3baqayQb9YRrwzDGP2tE%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">3.3. 建筑</h3>
<p>🤔 起始城镇 "<strong>主角的家</strong>" 和 "<strong>博士研究所</strong>" 分别占据 <strong>3x3</strong> 和 <strong>5x3</strong> 的格子，没法用像素块拼接...直接找个像素模型，这里用的「<strong>等距像素化建筑模型 | HOLO-V1</strong>」：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee4195845b42403abaa963374c41aed3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=TDLtwLQOSyUhUrm%2BDxsFQhCqCSo%3D" alt="" loading="lazy"/></p>
<p><strong>Prompt</strong> 直接输入 <strong>3x3的房子</strong>，让 <strong>Holopix AI</strong> 进行智能优化，接着翻译为英文，接着微调下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ab1dce044024e70ab7d1f27bf0525c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=4V7%2FC13Q0kki7tEOLJE%2BkvaFkmw%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">4. 最终效果</h2>
<p>把 <strong>Holopix AI</strong> 生成的素材全部应用上，加上反复跟 <strong>Trae Vibe</strong> 的最终效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e9f4dba9ba6845ebbd38e439e76a4eeb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=b1N7%2B9yirpcgo0ufjDDaGdcr6Gc%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef735d3af989433eada39aa1da7d1db9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=4FuXorImC7HFUm54Do2TeonX3yQ%3D" alt="" loading="lazy"/></p>
<p>💁‍♂️ 捣鼓了一早上，就复刻了 "<strong>口袋妖怪</strong>" 的 "<strong>基本玩法</strong>" (虽然有点简陋，还有各种BUG🤣)，归功于：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fholopix.cn%3FinviteCode%3D563333" target="_blank" title="https://holopix.cn?inviteCode=563333" ref="nofollow noopener noreferrer"><strong>Holopix AI</strong></a>：依旧保持稳定快速，高质量的游戏素材输出。</li>
<li><strong>Gemini 3 Pro</strong>：当之无愧编程能力最强的 "<strong>前端之王LLM</strong>"。</li>
<li><strong>TRAE SOLO</strong>：同时驱使 <strong>多 Agent</strong> 并行干活太爽了，😆 就是 <strong>Token</strong> 烧得飞快...</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c89f188b8d9415cbb5fdd8f8405829f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766134915&amp;x-signature=n79q5IHVkVfvR%2FkSJ8hyTc9pI4I%3D" alt="" loading="lazy"/></p>
<p>😏 <strong>AI</strong> 时代，人人都是 "<strong>创造家</strong>"，你有创意你就来，赶紧动手试试吧~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[鸿蒙技术干货9：deviceInfo 设备信息获取与位置提醒 APP 整合]]></title>    <link>https://juejin.cn/post/7582528397866401819</link>    <guid>https://juejin.cn/post/7582528397866401819</guid>    <pubDate>2025-12-12T07:44:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582528397866401819" data-draft-id="7582763878673907739" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="鸿蒙技术干货9：deviceInfo 设备信息获取与位置提醒 APP 整合"/> <meta itemprop="keywords" content="HarmonyOS"/> <meta itemprop="datePublished" content="2025-12-12T07:44:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="赵浩生"/> <meta itemprop="url" content="https://juejin.cn/user/4185170523982995"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            鸿蒙技术干货9：deviceInfo 设备信息获取与位置提醒 APP 整合
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4185170523982995/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    赵浩生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T07:44:01.000Z" title="Fri Dec 12 2025 07:44:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<p> 前两篇咱们分别搞定了通知服务（发送提醒）和地理位置服务（获取位置），这篇咱们先学习设备信息（deviceInfo）的核心用法，适配不同设备的硬件和系统特性，再将三大服务整合，完成 “位置提醒 APP” 的完整开发。让咱们从设备适配到功能闭环，一步步实现可直接复用的实战项目！</p>
<h2 data-id="heading-0">一、设备信息服务核心认知</h2>
<h3 data-id="heading-1">1. 设备信息的应用价值</h3>
<ul>
<li>设备适配：根据屏幕尺寸调整 UI 布局、根据系统版本适配 API；</li>
<li>功能优化：根据设备型号调整定位策略（如高端机支持高精度 GNSS）；</li>
<li>问题排查：记录设备信息用于日志分析，快速定位兼容性问题；</li>
<li>个性化服务：根据设备特性提供定制化功能（如平板端显示更多操作入口）。</li>
</ul>
<h3 data-id="heading-2">2. 核心 API 与可获取信息</h3>
<ul>
<li>
<p>核心模块：<code>@ohos.deviceInfo</code>（设备信息）、<code>@ohos.screen</code>（屏幕信息）</p>
</li>
<li>
<p>关键信息：</p>
<ul>
<li>设备基础信息：型号、厂商、设备 ID；</li>
<li>系统信息：系统版本、API 版本、设备类型；</li>
<li>屏幕信息：屏幕尺寸、分辨率、像素密度。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-3">二、设备信息获取实战</h2>
<h3 data-id="heading-4">1. 获取设备基础信息</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> deviceInfo <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.deviceInfo'</span>;

<span class="hljs-comment">/**
 * 获取设备基础信息
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getDeviceBaseInfo</span>(<span class="hljs-params"/>): {
  <span class="hljs-attr">deviceModel</span>: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 设备型号</span>
  <span class="hljs-attr">manufacturer</span>: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 设备厂商</span>
  <span class="hljs-attr">osVersion</span>: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 系统版本</span>
  <span class="hljs-attr">apiVersion</span>: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// API版本</span>
  <span class="hljs-attr">deviceType</span>: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 设备类型（phone/tablet/watch等）</span>
} {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">deviceModel</span>: deviceInfo.<span class="hljs-property">deviceModel</span>, <span class="hljs-comment">// 如：Mate 60 Pro</span>
    <span class="hljs-attr">manufacturer</span>: deviceInfo.<span class="hljs-property">manufacturer</span>, <span class="hljs-comment">// 如：Huawei</span>
    <span class="hljs-attr">osVersion</span>: deviceInfo.<span class="hljs-property">osVersion</span>, <span class="hljs-comment">// 如：4.0.0.188</span>
    <span class="hljs-attr">apiVersion</span>: deviceInfo.<span class="hljs-property">apiVersion</span>, <span class="hljs-comment">// 如：10</span>
    <span class="hljs-attr">deviceType</span>: deviceInfo.<span class="hljs-property">deviceType</span> <span class="hljs-comment">// 如：phone</span>
  };
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-5">2. 获取屏幕信息（适配 UI 布局）</h3>
<pre><code class="hljs language-ini" lang="ini">import screen from '@ohos.screen'<span class="hljs-comment">;</span>

/**
 * 获取屏幕信息
 */
export function getScreenInfo(): {
  screenWidth: number<span class="hljs-comment">; // 屏幕宽度（像素）</span>
  screenHeight: number<span class="hljs-comment">; // 屏幕高度（像素）</span>
  density: number<span class="hljs-comment">; // 像素密度</span>
  dpi: number<span class="hljs-comment">; // 屏幕DPI</span>
} {
  const <span class="hljs-attr">mainScreen</span> = screen.getDefaultScreen()<span class="hljs-comment">;</span>
  const <span class="hljs-attr">screenRect</span> = mainScreen.getRect()<span class="hljs-comment">;</span>
  const <span class="hljs-attr">density</span> = mainScreen.getDensity()<span class="hljs-comment">;</span>
  const <span class="hljs-attr">dpi</span> = mainScreen.getDpi()<span class="hljs-comment">;</span>
  
  return {
    screenWidth: screenRect.width,
    screenHeight: screenRect.height,
    density: density,
    dpi: dpi
  }<span class="hljs-comment">;</span>
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-6">3. 设备适配实战（根据设备类型调整功能）</h3>
<pre><code class="hljs language-ini" lang="ini">/**
 * 根据设备类型调整定位配置
 * 手机：高精度模式，平板：平衡模式，手表：低功耗模式
 */
export function getLocationConfigByDeviceType(): geoLocationManager.LocationRequest {
  const <span class="hljs-attr">deviceInfo</span> = getDeviceBaseInfo()<span class="hljs-comment">;</span>
  let priority: geoLocationManager.LocationRequestPriority<span class="hljs-comment">;</span>
  
  switch (deviceInfo.deviceType) {
    case 'phone':
      <span class="hljs-attr">priority</span> = geoLocationManager.LocationRequestPriority.HIGH_ACCURACY<span class="hljs-comment">;</span>
      break<span class="hljs-comment">;</span>
    case 'tablet':
      <span class="hljs-attr">priority</span> = geoLocationManager.LocationRequestPriority.BALANCED<span class="hljs-comment">;</span>
      break<span class="hljs-comment">;</span>
    case 'watch':
      <span class="hljs-attr">priority</span> = geoLocationManager.LocationRequestPriority.LOW_POWER<span class="hljs-comment">;</span>
      break<span class="hljs-comment">;</span>
    default:
      <span class="hljs-attr">priority</span> = geoLocationManager.LocationRequestPriority.BALANCED<span class="hljs-comment">;</span>
  }
  
  return {
    priority: priority,
    interval: <span class="hljs-attr">deviceInfo.deviceType</span> === <span class="hljs-string">'watch'</span> ? <span class="hljs-number">10000</span> : <span class="hljs-number">5000</span>, // 手表定位间隔 longer
    distance: 10,
    scenario: geoLocationManager.LocationScenario.NAVIGATION
  }<span class="hljs-comment">;</span>
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h2 data-id="heading-7">三、整合三大服务：位置提醒 APP 完整实现</h2>
<h3 data-id="heading-8">1. 项目核心流程</h3>
<ol>
<li>应用启动：获取设备信息，适配 UI 布局和定位策略；</li>
<li>权限申请：批量申请通知权限和定位权限；</li>
<li>设置目标：用户输入或选择目标位置（经纬度）；</li>
<li>定位监听：启动持续定位，实时计算与目标位置的距离；</li>
<li>提醒触发：到达目标区域，发送通知并停止定位；</li>
<li>点击跳转：用户点击通知，进入应用查看详情。</li>
</ol>
<h3 data-id="heading-9">2. 完整代码实现</h3>
<h4 data-id="heading-10">（1）全局工具类整合（utils/SystemServiceUtil.ets）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 整合前两篇的通知、定位工具方法，加上设备信息方法</span>
<span class="hljs-keyword">import</span> abilityAccessCtrl <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.abilityAccessCtrl'</span>;
<span class="hljs-keyword">import</span> notification <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.notification'</span>;
<span class="hljs-keyword">import</span> wantAgent <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.wantAgent'</span>;
<span class="hljs-keyword">import</span> geoLocationManager <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.geolocation'</span>;
<span class="hljs-keyword">import</span> deviceInfo <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.deviceInfo'</span>;
<span class="hljs-keyword">import</span> screen <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.screen'</span>;
<span class="hljs-keyword">import</span> common <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.app.ability.common'</span>;

<span class="hljs-comment">// 权限申请：批量申请通知和定位权限</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">requestAllPermissions</span>(<span class="hljs-params">context: common.UIAbilityContext</span>): <span class="hljs-title class_">Promise</span>&lt;boolean&gt; {
  <span class="hljs-keyword">const</span> permissions = [
    <span class="hljs-string">'ohos.permission.NOTIFICATION_CONTROLLER'</span>,
    <span class="hljs-string">'ohos.permission.APPROXIMATELY_LOCATION'</span>,
    <span class="hljs-string">'ohos.permission.LOCATION'</span>
  ];
  
  <span class="hljs-keyword">const</span> atManager = abilityAccessCtrl.<span class="hljs-title function_">createAtManager</span>();
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> authResults = <span class="hljs-keyword">await</span> atManager.<span class="hljs-title function_">checkAccessToken</span>(
      abilityAccessCtrl.<span class="hljs-title function_">createTokenID</span>(),
      permissions
    );
    
    <span class="hljs-keyword">const</span> needReqPerms = permissions.<span class="hljs-title function_">filter</span>(
      <span class="hljs-function">(<span class="hljs-params">perm, index</span>) =&gt;</span> authResults[index] !== abilityAccessCtrl.<span class="hljs-property">GrantStatus</span>.<span class="hljs-property">PERMISSION_GRANTED</span>
    );
    
    <span class="hljs-keyword">if</span> (needReqPerms.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    
    <span class="hljs-keyword">const</span> reqResult = <span class="hljs-keyword">await</span> atManager.<span class="hljs-title function_">requestPermissionsFromUser</span>(context, needReqPerms);
    <span class="hljs-keyword">return</span> reqResult.<span class="hljs-property">authResults</span>.<span class="hljs-title function_">every</span>(<span class="hljs-function"><span class="hljs-params">status</span> =&gt;</span> status === <span class="hljs-number">0</span>);
  } <span class="hljs-keyword">catch</span> (err) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`批量权限申请失败：<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }
}

<span class="hljs-comment">// 设备信息方法（同上篇）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getDeviceBaseInfo</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* 省略，复用前文代码 */</span> }
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getScreenInfo</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* 省略，复用前文代码 */</span> }
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getLocationConfigByDeviceType</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* 省略，复用前文代码 */</span> }

<span class="hljs-comment">// 通知方法（同上篇）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createLocationReminderNotification</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* 省略，复用前文代码 */</span> }
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">sendNotification</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* 省略，复用前文代码 */</span> }

<span class="hljs-comment">// 定位方法（同上篇）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">startContinuousLocation</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* 省略，复用前文代码 */</span> }
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">stopContinuousLocation</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* 省略，复用前文代码 */</span> }
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">isReachTargetArea</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* 省略，复用前文代码 */</span> }
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h4 data-id="heading-11">（2）主页面实现（pages/LocationReminderPage.ets）</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> common <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.app.ability.common'</span>;
<span class="hljs-keyword">import</span> {
  requestAllPermissions,
  getDeviceBaseInfo,
  getScreenInfo,
  getLocationConfigByDeviceType,
  createLocationReminderNotification,
  sendNotification,
  startContinuousLocation,
  stopContinuousLocation,
  isReachTargetArea
} <span class="hljs-keyword">from</span> <span class="hljs-string">'../utils/SystemServiceUtil'</span>;

<span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">LocationReminderPage</span> {
  <span class="hljs-keyword">private</span> context = <span class="hljs-title function_">getContext</span>(<span class="hljs-variable language_">this</span>) <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;
  <span class="hljs-meta">@State</span> <span class="hljs-attr">deviceInfoStr</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;
  <span class="hljs-meta">@State</span> <span class="hljs-attr">currentLocation</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'未获取位置'</span>;
  <span class="hljs-meta">@State</span> <span class="hljs-attr">targetLat</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'39.9042'</span>; <span class="hljs-comment">// 目标纬度默认值</span>
  <span class="hljs-meta">@State</span> <span class="hljs-attr">targetLng</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'116.4074'</span>; <span class="hljs-comment">// 目标经度默认值</span>
  <span class="hljs-meta">@State</span> <span class="hljs-attr">reminderRadius</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">100</span>; <span class="hljs-comment">// 提醒半径（米）</span>
  <span class="hljs-meta">@State</span> <span class="hljs-attr">isTracking</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;

  <span class="hljs-comment">// 页面加载时获取设备信息</span>
  <span class="hljs-title function_">aboutToAppear</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadDeviceInfo</span>();
  }

  <span class="hljs-comment">// 加载设备信息</span>
  <span class="hljs-title function_">loadDeviceInfo</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> deviceInfo = <span class="hljs-title function_">getDeviceBaseInfo</span>();
    <span class="hljs-keyword">const</span> screenInfo = <span class="hljs-title function_">getScreenInfo</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">deviceInfoStr</span> = <span class="hljs-string">`设备：<span class="hljs-subst">${deviceInfo.manufacturer}</span> <span class="hljs-subst">${deviceInfo.deviceModel}</span> | 系统：<span class="hljs-subst">${deviceInfo.osVersion}</span> | 屏幕：<span class="hljs-subst">${screenInfo.screenWidth}</span>x<span class="hljs-subst">${screenInfo.screenHeight}</span>`</span>;
  }

  <span class="hljs-comment">// 启动位置提醒</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">startReminder</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 1. 检查权限</span>
    <span class="hljs-keyword">const</span> allGranted = <span class="hljs-keyword">await</span> <span class="hljs-title function_">requestAllPermissions</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>);
    <span class="hljs-keyword">if</span> (!allGranted) {
      <span class="hljs-title class_">Toast</span>.<span class="hljs-title function_">show</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'部分权限未授予，无法启动提醒'</span> });
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// 2. 验证目标位置</span>
    <span class="hljs-keyword">const</span> targetLoc = {
      <span class="hljs-attr">latitude</span>: <span class="hljs-built_in">parseFloat</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">targetLat</span>),
      <span class="hljs-attr">longitude</span>: <span class="hljs-built_in">parseFloat</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">targetLng</span>)
    };
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isNaN</span>(targetLoc.<span class="hljs-property">latitude</span>) || <span class="hljs-built_in">isNaN</span>(targetLoc.<span class="hljs-property">longitude</span>)) {
      <span class="hljs-title class_">Toast</span>.<span class="hljs-title function_">show</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'目标位置格式错误'</span> });
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// 3. 启动持续定位（根据设备类型适配配置）</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isTracking</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-title class_">Toast</span>.<span class="hljs-title function_">show</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'位置提醒已启动，正在跟踪您的位置'</span> });
    
    <span class="hljs-title function_">startContinuousLocation</span>(<span class="hljs-function">(<span class="hljs-params">currentLoc</span>) =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentLocation</span> = <span class="hljs-string">`当前：纬度<span class="hljs-subst">${currentLoc.latitude.toFixed(<span class="hljs-number">6</span>)}</span>，经度<span class="hljs-subst">${currentLoc.longitude.toFixed(<span class="hljs-number">6</span>)}</span>`</span>;
      
      <span class="hljs-comment">// 4. 判断是否到达目标区域</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isReachTargetArea</span>(currentLoc, targetLoc, <span class="hljs-variable language_">this</span>.<span class="hljs-property">reminderRadius</span>)) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">sendReminderNotification</span>();
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">stopReminder</span>();
      }
    }, <span class="hljs-title function_">getLocationConfigByDeviceType</span>());
  }

  <span class="hljs-comment">// 发送提醒通知</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">sendReminderNotification</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> notification = <span class="hljs-keyword">await</span> <span class="hljs-title function_">createLocationReminderNotification</span>(
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>,
      <span class="hljs-string">'位置提醒'</span>,
      <span class="hljs-string">`您已到达目标区域（半径<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.reminderRadius}</span>米），点击查看详情`</span>
    );
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">sendNotification</span>(notification);
  }

  <span class="hljs-comment">// 停止位置提醒</span>
  <span class="hljs-title function_">stopReminder</span>(<span class="hljs-params"/>) {
    <span class="hljs-title function_">stopContinuousLocation</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isTracking</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-title class_">Toast</span>.<span class="hljs-title function_">show</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'位置提醒已停止'</span> });
  }

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">25</span> })
      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)
      .<span class="hljs-title function_">padding</span>(<span class="hljs-number">30</span>)
      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-params"><span class="hljs-string">'#f5f5f5'</span></span>) {
      
      <span class="hljs-comment">// 标题区域</span>
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'位置提醒APP'</span>)
        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">36</span>)
        .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)
        .<span class="hljs-title function_">textAlign</span>(<span class="hljs-title class_">TextAlign</span>.<span class="hljs-property">Center</span>)
        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
      
      <span class="hljs-comment">// 设备信息区域</span>
      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">deviceInfoStr</span>)
        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">16</span>)
        .<span class="hljs-title function_">color</span>(<span class="hljs-string">'#666'</span>)
        .<span class="hljs-title function_">textAlign</span>(<span class="hljs-title class_">TextAlign</span>.<span class="hljs-property">Center</span>)
        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
        .<span class="hljs-title function_">lineHeight</span>(<span class="hljs-number">24</span>)
      
      <span class="hljs-comment">// 目标位置输入区域</span>
      <span class="hljs-title class_">Column</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">15</span> })
        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
        .<span class="hljs-title function_">padding</span>(<span class="hljs-number">20</span>)
        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#ffffff'</span>)
        .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-params"><span class="hljs-number">12</span></span>) {
        <span class="hljs-title class_">Text</span>(<span class="hljs-string">'目标位置设置'</span>)
          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)
          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Medium</span>)
        
        <span class="hljs-title class_">Row</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">10</span> })
          .<span class="hljs-title function_">width</span>(<span class="hljs-params"><span class="hljs-string">'100%'</span></span>) {
          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'纬度：'</span>)
            .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">18</span>)
            .<span class="hljs-title function_">width</span>(<span class="hljs-string">'20%'</span>)
          <span class="hljs-title class_">TextInput</span>({ <span class="hljs-attr">text</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">targetLat</span> })
            .<span class="hljs-title function_">width</span>(<span class="hljs-string">'80%'</span>)
            .<span class="hljs-title function_">height</span>(<span class="hljs-number">45</span>)
            .<span class="hljs-title function_">padding</span>(<span class="hljs-number">10</span>)
            .<span class="hljs-title function_">border</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">'#eee'</span> })
            .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">8</span>)
            .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">18</span>)
            .<span class="hljs-title function_">onChange</span>(<span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">targetLat</span> = value)
        }
        
        <span class="hljs-title class_">Row</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">10</span> })
          .<span class="hljs-title function_">width</span>(<span class="hljs-params"><span class="hljs-string">'100%'</span></span>) {
          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'经度：'</span>)
            .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">18</span>)
            .<span class="hljs-title function_">width</span>(<span class="hljs-string">'20%'</span>)
          <span class="hljs-title class_">TextInput</span>({ <span class="hljs-attr">text</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">targetLng</span> })
            .<span class="hljs-title function_">width</span>(<span class="hljs-string">'80%'</span>)
            .<span class="hljs-title function_">height</span>(<span class="hljs-number">45</span>)
            .<span class="hljs-title function_">padding</span>(<span class="hljs-number">10</span>)
            .<span class="hljs-title function_">border</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">'#eee'</span> })
            .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">8</span>)
            .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">18</span>)
            .<span class="hljs-title function_">onChange</span>(<span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">targetLng</span> = value)
        }
        
        <span class="hljs-title class_">Row</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">10</span> })
          .<span class="hljs-title function_">width</span>(<span class="hljs-params"><span class="hljs-string">'100%'</span></span>) {
          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'提醒半径：'</span>)
            .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">18</span>)
            .<span class="hljs-title function_">width</span>(<span class="hljs-string">'30%'</span>)
          <span class="hljs-title class_">TextInput</span>({ <span class="hljs-attr">text</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">reminderRadius</span>.<span class="hljs-title function_">toString</span>() })
            .<span class="hljs-title function_">width</span>(<span class="hljs-string">'70%'</span>)
            .<span class="hljs-title function_">height</span>(<span class="hljs-number">45</span>)
            .<span class="hljs-title function_">padding</span>(<span class="hljs-number">10</span>)
            .<span class="hljs-title function_">border</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">'#eee'</span> })
            .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">8</span>)
            .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">18</span>)
            .<span class="hljs-title function_">onChange</span>(<span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">reminderRadius</span> = <span class="hljs-built_in">parseInt</span>(value) || <span class="hljs-number">100</span>)
          <span class="hljs-title class_">Text</span>(<span class="hljs-string">'米'</span>)
            .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">18</span>)
            .<span class="hljs-title function_">marginLeft</span>(<span class="hljs-number">10</span>)
        }
      }
      
      <span class="hljs-comment">// 当前位置显示</span>
      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentLocation</span>)
        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">18</span>)
        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
        .<span class="hljs-title function_">textAlign</span>(<span class="hljs-title class_">TextAlign</span>.<span class="hljs-property">Center</span>)
        .<span class="hljs-title function_">padding</span>(<span class="hljs-number">15</span>)
        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#ffffff'</span>)
        .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">12</span>)
      
      <span class="hljs-comment">// 操作按钮区域</span>
      <span class="hljs-title class_">Row</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">30</span> })
        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
        .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-params">FlexAlign.Center</span>) {
        <span class="hljs-title class_">Button</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">isTracking</span> ? <span class="hljs-string">'停止提醒'</span> : <span class="hljs-string">'启动提醒'</span>)
          .<span class="hljs-title function_">type</span>(<span class="hljs-title class_">ButtonType</span>.<span class="hljs-property">Capsule</span>)
          .<span class="hljs-title function_">width</span>(<span class="hljs-number">200</span>)
          .<span class="hljs-title function_">height</span>(<span class="hljs-number">60</span>)
          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)
          .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">isTracking</span> ? <span class="hljs-string">'#ff4d4f'</span> : <span class="hljs-string">'#2f54eb'</span>)
          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {
            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isTracking</span>) {
              <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">stopReminder</span>();
            } <span class="hljs-keyword">else</span> {
              <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">startReminder</span>();
            }
          })
      }
    }
  }
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h4 data-id="heading-12">（3）配置文件完善（module.json5）</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"package"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"com.example.locationreminder"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"LocationReminder"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"mainAbility"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MainAbility"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"requestPermissions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ohos.permission.NOTIFICATION_CONTROLLER"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"reason"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"用于发送位置到达提醒通知"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"usedScene"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"abilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"MainAbility"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"when"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"always"</span> <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ohos.permission.APPROXIMATELY_LOCATION"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"reason"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"用于获取大致位置，提供位置提醒服务"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"usedScene"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"abilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"MainAbility"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"when"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"inuse"</span> <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ohos.permission.LOCATION"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"reason"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"用于获取精准位置，提升提醒准确性"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"usedScene"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"abilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"MainAbility"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"when"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"inuse"</span> <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"abilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">".MainAbility"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"page"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"visible"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"skills"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
          <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"entities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"entity.system.home"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"actions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"action.system.home"</span><span class="hljs-punctuation">]</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h2 data-id="heading-13">四、APP 核心功能说明</h2>
<h3 data-id="heading-14">1. 设备适配能力</h3>
<ul>
<li>自动识别设备类型（手机 / 平板 / 手表），调整定位策略；</li>
<li>根据屏幕尺寸自适应 UI 布局，在不同设备上显示正常；</li>
<li>适配不同 API 版本，避免因系统版本差异导致功能异常。</li>
</ul>
<h3 data-id="heading-15">2. 合规性保障</h3>
<ul>
<li>批量申请权限，明确告知用户权限用途；</li>
<li>定位和通知功能可手动启停，用户可控；</li>
<li>到达目标后自动停止定位，降低功耗，符合系统规范。</li>
</ul>
<h3 data-id="heading-16">3. 用户体验优化</h3>
<ul>
<li>实时显示当前位置和设备信息，状态透明；</li>
<li>支持自定义目标位置和提醒半径，灵活适配不同场景；</li>
<li>通知点击跳转应用，形成功能闭环。</li>
</ul>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Ftraining%2FclassDetail%2F46b54a56c7e54e74973e0af43c077bff%3Ftype%3D1%3Fha_source%3Dhmosclass%26ha_sourceId%3D89000248" title="https://developer.huawei.com/consumer/cn/training/classDetail/46b54a56c7e54e74973e0af43c077bff?type=1?ha_source=hmosclass&amp;ha_sourceId=89000248" target="_blank" ref="nofollow noopener noreferrer">加入班级，学习鸿蒙开发</a></p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在高并发分布式SpringCloud系统中，什么时候时候并行查询，提高查询接口效率，从10s到100ms]]></title>    <link>https://juejin.cn/post/7582755817670361098</link>    <guid>https://juejin.cn/post/7582755817670361098</guid>    <pubDate>2025-12-12T06:50:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582755817670361098" data-draft-id="7582755817670344714" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在高并发分布式SpringCloud系统中，什么时候时候并行查询，提高查询接口效率，从10s到100ms"/> <meta itemprop="keywords" content="分布式,Java,后端"/> <meta itemprop="datePublished" content="2025-12-12T06:50:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="哈哈哈笑什么"/> <meta itemprop="url" content="https://juejin.cn/user/808832912075352"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在高并发分布式SpringCloud系统中，什么时候时候并行查询，提高查询接口效率，从10s到100ms
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/808832912075352/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    哈哈哈笑什么
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T06:50:46.000Z" title="Fri Dec 12 2025 06:50:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    17
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作为Java后端（Spring Cloud）开发，针对“查询接口是否适合并行查询并归整”，核心判断标准是 <strong>“任务独立性”“并行收益成本比”“数据一致性要求”</strong> 。以下是「适用场景」「绝对不适用场景」的详细拆解，结合实际业务场景和技术实现建议，确保可直接落地：</p>
<h2 data-id="heading-0">一、适合并行查询并归整的场景（满足任意1条核心条件+收益&gt;成本）</h2>
<h3 data-id="heading-1">核心前提（必满足）</h3>
<ol>
<li>多个查询任务 <strong>无依赖关系</strong>（不需要前一个查询的结果作为后一个的入参）；</li>
<li>单个查询是 <strong>纯读操作</strong>（无写逻辑，不会修改数据，无状态）；</li>
<li>并行的 <strong>总耗时 &lt; 串行总耗时</strong>（避免“小任务并行”导致线程切换开销大于收益）。</li>
</ol>
<h3 data-id="heading-2">具体场景（附业务例子+技术实现）</h3>
<h4 data-id="heading-3">1. 多维度数据聚合查询（无依赖）</h4>
<ul>
<li>
<p><strong>场景描述</strong>：一个接口需要返回“多维度独立数据”，每个维度的查询互不依赖，串行查询会导致总耗时=各接口耗时之和，并行可将总耗时降至“最长单个接口耗时”。</p>
</li>
<li>
<p><strong>业务例子</strong>：</p>
<ul>
<li>订单详情页：需查询「订单基本信息」「订单商品列表」「用户收货地址」「支付记录」「优惠券使用记录」，5个查询无依赖（入参都是订单ID/用户ID，无需互相等待）；</li>
<li>首页数据聚合：查询「热门商品列表」「用户个性化推荐」「公告信息」「购物车数量」，4个查询独立。</li>
</ul>
</li>
<li>
<p><strong>判断标准</strong>：</p>
<ul>
<li>每个子查询的入参相同（或可提前确定，无需前序结果）；</li>
<li>单个子查询耗时≥50ms（如果单个查询仅10ms，并行的线程切换开销可能超过收益）。</li>
</ul>
</li>
<li>
<p><strong>技术实现（Spring Cloud环境）</strong> ：</p>
<ul>
<li>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 用CompletableFuture实现异步并行（推荐IO密集型查询）</span>
<span class="hljs-keyword">@Service</span>
public class OrderDetailService {
    <span class="hljs-keyword">@Autowired</span>
    private OrderMapper orderMapper;
    <span class="hljs-keyword">@Autowired</span>
    private OrderItemFeignClient orderItemFeign; <span class="hljs-comment">// 跨服务Feign接口</span>
    <span class="hljs-keyword">@Autowired</span>
    private UserAddressFeignClient addressFeign;
    <span class="hljs-keyword">@Autowired</span>
    private ExecutorService asyncQueryExecutor; <span class="hljs-comment">// 自定义线程池（避免用默认线程池）</span>

    public OrderDetailVO <span class="hljs-built_in">getOrderDetail</span>(Long orderId, Long userId) {
        <span class="hljs-comment">// 1. 并行发起多个查询（无依赖）</span>
        CompletableFuture&lt;OrderPO&gt; orderFuture = CompletableFuture<span class="hljs-selector-class">.supplyAsync</span>(
            () -&gt; orderMapper<span class="hljs-selector-class">.selectById</span>(orderId),
            asyncQueryExecutor
        );
        CompletableFuture&lt;List&lt;OrderItemVO&gt;&gt; itemFuture = CompletableFuture<span class="hljs-selector-class">.supplyAsync</span>(
            () -&gt; orderItemFeign<span class="hljs-selector-class">.listByOrderId</span>(orderId),
            asyncQueryExecutor
        );
        CompletableFuture&lt;AddressVO&gt; addressFuture = CompletableFuture<span class="hljs-selector-class">.supplyAsync</span>(
            () -&gt; addressFeign<span class="hljs-selector-class">.getByUserId</span>(userId),
            asyncQueryExecutor
        );

        <span class="hljs-comment">// 2. 等待所有查询完成，归整结果（异常统一捕获）</span>
        try {
            CompletableFuture<span class="hljs-selector-class">.allOf</span>(orderFuture, itemFuture, addressFuture)<span class="hljs-selector-class">.join</span>();
            return OrderDetailVO<span class="hljs-selector-class">.builder</span>()
                <span class="hljs-selector-class">.order</span>(orderFuture.get())
                <span class="hljs-selector-class">.items</span>(itemFuture.get())
                <span class="hljs-selector-class">.address</span>(addressFuture.get())
                <span class="hljs-selector-class">.build</span>();
        } catch (Exception e) {
            log<span class="hljs-selector-class">.error</span>("并行查询订单详情失败", e);
            throw new <span class="hljs-built_in">BusinessException</span>("查询订单详情失败");
        }
    }
}
</code></pre>
</li>
<li>注意：线程池需自定义（核心线程数=CPU核心数×2+1，最大线程数=CPU核心数×4，队列容量适中），避免用<code>ForkJoinPool.commonPool()</code>（易被其他任务占满）。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-4">2. 跨服务无依赖接口查询（微服务场景）</h4>
<ul>
<li>
<p><strong>场景描述</strong>：Spring Cloud微服务架构中，一个服务需要调用多个其他服务的查询接口，且这些接口无依赖（如调用用户服务、商品服务、库存服务的查询接口）。</p>
</li>
<li>
<p><strong>业务例子</strong>：</p>
<ul>
<li>商品详情页：调用「商品服务（商品基本信息）」「库存服务（当前库存）」「评价服务（好评率）」「促销服务（当前活动）」，4个跨服务查询独立。</li>
</ul>
</li>
<li>
<p><strong>判断标准</strong>：</p>
<ul>
<li>跨服务接口是幂等的（多次调用结果一致，无副作用）；</li>
<li>单个跨服务接口耗时≥100ms（跨网络IO耗时较长，并行收益明显）。</li>
</ul>
</li>
<li>
<p><strong>技术实现</strong>：Feign异步调用（配合CompletableFuture），或使用Resilience4j的异步熔断降级（避免单个服务超时导致整体阻塞）。</p>
</li>
</ul>
<h4 data-id="heading-5">3. 批量数据拆分查询（大数据量场景）</h4>
<ul>
<li>
<p><strong>场景描述</strong>：查询条件可拆分为多个独立子条件，每个子条件查询部分数据，最后合并结果（如按ID分片、按时间分片）。</p>
</li>
<li>
<p><strong>业务例子</strong>：</p>
<ul>
<li>查询“近3个月的订单统计”，拆分为“1月订单”“2月订单”“3月订单”3个独立查询，并行执行后汇总统计结果；</li>
<li>批量查询100个用户的信息，拆分为10个批次（每批10个用户ID），并行查询后合并列表。</li>
</ul>
</li>
<li>
<p><strong>判断标准</strong>：</p>
<ul>
<li>拆分后的子查询无重叠数据（避免重复统计）；</li>
<li>单条查询数据量较大（如10万+），拆分后可减少单条SQL的执行压力。</li>
</ul>
</li>
<li>
<p><strong>技术实现</strong>：用<code>ListUtils.partition()</code>拆分入参，配合CompletableFuture并行执行，最后用<code>Stream.concat()</code>合并结果。</p>
</li>
</ul>
<h4 data-id="heading-6">4. 冷热数据分离查询（优化响应速度）</h4>
<ul>
<li>
<p><strong>场景描述</strong>：查询结果包含“热数据”（高频访问，如缓存中的用户信息）和“冷数据”（低频访问，如数据库中的历史记录），冷数据查询耗时较长，可并行查询冷热数据。</p>
</li>
<li>
<p><strong>业务例子</strong>：</p>
<ul>
<li>用户个人中心：查询「缓存中的用户基本信息（热数据，10ms）」和「数据库中的用户历史订单统计（冷数据，500ms）」，并行查询后合并。</li>
</ul>
</li>
<li>
<p><strong>判断标准</strong>：冷数据查询耗时明显高于热数据（如冷数据耗时是热数据的5倍以上）。</p>
</li>
</ul>
<h2 data-id="heading-7">二、绝对不能并行查询的场景（强行并行必出问题）</h2>
<h3 data-id="heading-8">核心原因（满足任意1条即禁止）</h3>
<ol start="4">
<li>查询任务 <strong>有依赖关系</strong>（后一个查询需要前一个的结果作为入参）；</li>
<li>查询涉及 <strong>状态修改</strong>（非纯读操作，如查询时触发数据更新、计数累加）；</li>
<li>要求 <strong>强一致性</strong>（并行可能导致数据不一致、重复或遗漏）；</li>
<li>查询是 <strong>非幂等</strong> 的（多次调用结果不同，有副作用）。</li>
</ol>
<h3 data-id="heading-9">具体场景（附风险点+正确做法）</h3>
<h4 data-id="heading-10">1. 有依赖关系的查询（串行是唯一选择）</h4>
<ul>
<li>
<p><strong>场景描述</strong>：后一个查询的入参必须是前一个查询的结果（如“先查用户ID，再查该用户的订单；先查订单ID，再查该订单的商品”）。</p>
</li>
<li>
<p><strong>业务例子</strong>：</p>
<ul>
<li>流程：查询“用户的最新订单” → 用该订单ID查询“订单商品” → 用商品ID查询“商品库存”，3个查询有严格依赖。</li>
</ul>
</li>
<li>
<p><strong>风险点</strong>：并行查询会导致后一个查询“拿不到入参”或“拿到错误入参”，直接报错或返回无效数据。</p>
</li>
<li>
<p><strong>正确做法</strong>：串行执行，或通过SQL关联查询（如<code>JOIN</code>）减少查询次数，而非并行。</p>
</li>
</ul>
<h4 data-id="heading-11">2. 涉及数据修改的“查询”（非纯读操作）</h4>
<ul>
<li>
<p><strong>场景描述</strong>：看似是查询接口，但内部包含写逻辑（如“查询用户积分”时，触发“积分过期扣除”；“查询订单列表”时，触发“订单状态自动更新”）。</p>
</li>
<li>
<p><strong>风险点</strong>：并行执行会导致 <strong>并发修改问题</strong>（如同一用户的积分被多个线程同时扣除，导致数据不一致）、 <strong>锁竞争加剧</strong>（如并行查询都需要获取数据库行锁，导致死锁或超时）。</p>
</li>
<li>
<p><strong>正确做法</strong>：</p>
<ul>
<li>拆分接口：将“写逻辑”单独抽为写接口，查询接口仅做纯读；</li>
<li>若无法拆分，必须串行执行，且加分布式锁（如Redisson锁）保证原子性。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-12">3. 强一致性要求的关联查询（并行会破坏一致性）</h4>
<ul>
<li>
<p><strong>场景描述</strong>：查询结果需要满足“原子性”，即所有关联数据必须是同一时间点的快照（如“查询订单金额+该订单的支付金额”，要求两者一致，不能出现“订单金额已更新，支付金额还是旧值”）。</p>
</li>
<li>
<p><strong>业务例子</strong>：</p>
<ul>
<li>财务对账接口：查询“订单表的总金额”和“支付表的总金额”，要求两者严格相等（同一时间点的数据）。</li>
</ul>
</li>
<li>
<p><strong>风险点</strong>：并行查询可能访问不同的数据库分片/副本，或在查询过程中数据被修改，导致两者数据不一致（如订单表查询完后，支付表数据被更新，支付表查询结果是新值）。</p>
</li>
<li>
<p><strong>正确做法</strong>：</p>
<ul>
<li>用分布式事务（如Seata TCC）或数据库事务（同一库内用<code>@Transactional</code>）保证一致性；</li>
<li>单条SQL关联查询（如<code>SELECT o.amount, p.amount FROM order o JOIN payment p ON o.id = p.order_id</code>），而非拆分并行。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-13">4. 非幂等的查询接口（并行会产生副作用）</h4>
<ul>
<li>
<p><strong>场景描述</strong>：查询接口的结果依赖于“调用次数”或“调用顺序”（如“查询用户的下一个序列号”“查询当前队列的下一个任务”），多次调用结果不同。</p>
</li>
<li>
<p><strong>业务例子</strong>：</p>
<ul>
<li>接口<code>getNextSequence()</code>：每次调用返回递增的序列号（内部用<code>SELECT MAX(id)+1</code>实现），并行调用会导致多个线程返回相同的序列号（并发问题）。</li>
</ul>
</li>
<li>
<p><strong>风险点</strong>：并行调用会导致数据重复、序号冲突、逻辑错乱（如多个订单拿到相同的序列号）。</p>
</li>
<li>
<p><strong>正确做法</strong>：</p>
<ul>
<li>接口改为幂等设计（如用分布式ID生成器替代<code>MAX(id)+1</code>）；</li>
<li>若无法修改，必须串行执行，且加分布式锁保证唯一性。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-14">5. 高并发下的数据库行锁竞争查询（并行会导致性能雪崩）</h4>
<ul>
<li>
<p><strong>场景描述</strong>：查询接口需要获取数据库行锁（如<code>SELECT ... FOR UPDATE</code>，悲观锁），且查询的是同一行数据（如高频查询“商品库存”并加锁，防止超卖）。</p>
</li>
<li>
<p><strong>风险点</strong>：并行查询会导致大量线程阻塞在锁竞争上，CPU利用率飙升，接口响应时间从毫秒级变为秒级，最终引发性能雪崩。</p>
</li>
<li>
<p><strong>正确做法</strong>：</p>
<ul>
<li>用乐观锁替代悲观锁（如<code>WHERE id=? AND version=?</code>）；</li>
<li>若必须用悲观锁，限制并发数（如用Redisson限流），且串行执行核心查询逻辑。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-15">6. 分页查询/滚动查询（并行会导致数据重复/遗漏）</h4>
<ul>
<li><strong>场景描述</strong>：需要按顺序分页查询数据（如“查询第1页订单→第2页订单→第3页订单”），或按游标滚动查询（如<code>WHERE id &gt; ? LIMIT 100</code>）。</li>
<li><strong>风险点</strong>：并行查询会导致分页顺序错乱（如第2页查询先执行，拿到第1页的数据），或数据重复（多个线程查询同一页）、数据遗漏（部分页面未查询）。</li>
<li><strong>正确做法</strong>：串行执行分页/滚动查询，或通过分片键（如按用户ID哈希分片）并行查询不同分片的数据（无重复无遗漏）。</li>
</ul>
<h2 data-id="heading-16">三、核心判断原则（快速决策表）</h2>








































<table><thead><tr><th>判断维度</th><th>适合并行</th><th>不适合并行</th></tr></thead><tbody><tr><td>任务依赖</td><td>无依赖（入参提前确定）</td><td>有依赖（后一个需前一个结果）</td></tr><tr><td>操作类型</td><td>纯读操作（无写逻辑）</td><td>含写逻辑（如更新、计数）</td></tr><tr><td>一致性要求</td><td>最终一致性（允许短暂不一致）</td><td>强一致性（需同一时间点快照）</td></tr><tr><td>幂等性</td><td>幂等（多次调用结果一致）</td><td>非幂等（多次调用结果不同）</td></tr><tr><td>耗时收益</td><td>单个查询≥50ms，并行总耗时更短</td><td>单个查询&lt;50ms，线程切换开销占比高</td></tr><tr><td>锁竞争</td><td>无锁或弱锁（如读锁）</td><td>强锁竞争（如写锁、行锁）</td></tr></tbody></table>
<h2 data-id="heading-17">四、Spring Cloud环境下的并行查询最佳实践</h2>
<ol start="8">
<li><strong>线程池配置</strong>：自定义IO密集型线程池（核心线程数=CPU核心数×2+1），避免使用默认线程池（如<code>CompletableFuture.supplyAsync()</code>无自定义线程池时，使用<code>ForkJoinPool.commonPool()</code>，易被耗尽）。</li>
<li><strong>超时控制</strong>：给每个并行任务设置超时时间（如<code>CompletableFuture.get(3, TimeUnit.SECONDS)</code>），避免单个任务超时导致整体阻塞。</li>
<li><strong>熔断降级</strong>：用Resilience4j/CircuitBreaker对跨服务并行查询做熔断（如某个服务超时率达50%，则熔断该服务，返回默认数据），保证整体可用性。</li>
<li><strong>异常处理</strong>：用<code>CompletableFuture.exceptionally()</code>或<code>handle()</code>统一捕获单个任务的异常，避免一个任务失败导致整个并行流程失败（如“商品库存查询失败，可返回默认库存为0，而非整个商品详情页查询失败”）。</li>
<li><strong>结果归整</strong>：用<code>CompletableFuture.allOf()</code>等待所有任务完成，再统一归整结果（避免多次<code>join()</code>导致阻塞），或用<code>CompletableFuture.anyOf()</code>获取最快返回的结果（适用于“多个数据源查询同一数据，取最快的一个”场景）。</li>
</ol>
<h2 data-id="heading-18">总结</h2>
<ul>
<li><strong>适合并行</strong>：核心是“无依赖、纯读、幂等、并行收益&gt;开销”，典型场景是多维度数据聚合、跨服务无依赖查询、批量拆分查询。</li>
<li><strong>绝对不能并行</strong>：核心是“有依赖、有写逻辑、强一致性、非幂等”，典型场景是依赖查询、含写操作的查询、强一致性对账、非幂等查询。</li>
</ul>
<p>实际开发中，先通过“核心判断原则”快速决策，再用Spring Cloud+CompletableFuture/自定义线程池实现并行，同时做好超时、熔断、异常处理，避免踩坑。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[uni-app开发路上的坑]]></title>    <link>https://juejin.cn/post/7582755817670115338</link>    <guid>https://juejin.cn/post/7582755817670115338</guid>    <pubDate>2025-12-12T06:21:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582755817670115338" data-draft-id="7581691182004502538" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="uni-app开发路上的坑"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2025-12-12T06:21:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="InkHeart"/> <meta itemprop="url" content="https://juejin.cn/user/2928754708457783"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            uni-app开发路上的坑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2928754708457783/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    InkHeart
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T06:21:47.000Z" title="Fri Dec 12 2025 06:21:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#5f6368;background-image:linear-gradient(90deg,rgba(240,191,213,.1) 3%,transparent 0),linear-gradient(1turn,rgba(240,191,213,.1) 3%,transparent 0);background-size:20px 20px;background-position:50%;letter-spacing:1px;word-spacing:1px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-left:50px;padding-bottom:5px;color:#5f6368}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{position:absolute;left:0;display:block;content:""}.markdown-body h1{font-size:32px;margin-bottom:5px}.markdown-body h1:before{top:0;content:"🦄";font-size:32px}.markdown-body h2{padding-bottom:24px;border-bottom:1px solid #ececec}.markdown-body h2:before{top:0;left:8px;content:"🐳";font-size:24px}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{top:-2px;left:8px;content:"🐄";font-size:20px}.markdown-body h4{font-size:16px}.markdown-body h4:before{top:-2px;left:8px;content:"🦥";font-size:18px}.markdown-body h5{font-size:14px}.markdown-body h5:before{top:-2px;left:9px;content:"🦩";font-size:16px}.markdown-body h6{font-size:12px;margin-top:5px}.markdown-body h6:before{top:-1px;left:10px;content:"🐧";font-size:14px}.markdown-body p{line-height:1.9;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid rgba(253,121,168,.5);margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#a6accd;background:#292d3e;border-radius:8px}.markdown-body a{text-decoration:none;color:#fd79a8;border-bottom:1px solid #fd79a8;padding:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(253,121,168,.1);color:#ee69a9}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body th{color:#fd79a8}.markdown-body th,.markdown-body tr:hover{background:rgba(253,121,168,.1)}.markdown-body td{min-width:120px}.markdown-body blockquote{position:relative;color:#666;padding:23px;margin:22px 0;border-left:4px solid #ee69a9;background-color:rgba(253,121,168,.1)}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;display:block;font-size:27px;color:#fd79a8;opacity:.8}.markdown-body blockquote:before{left:10px;top:0;content:"❝"}.markdown-body blockquote:after{right:10px;bottom:0;content:"❞"}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body strong{position:relative;color:#fd79a8}.markdown-body strong:before{content:"· "}.markdown-body strong:after{content:" ·"}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#fd79a8}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#ee69a9}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">前情提要</h2>
<p>记录一下使用uni-app + Vue3开发项目过程中遇到问题、以及解决方法。</p>
<h2 data-id="heading-1">map组件使用问题</h2>
<h3 data-id="heading-2">skew属性</h3>
<p>配置skew属性后个别手机（vivo iqoo neo11）中心点或者缩放异常（设置了坐标在广东，打开地图却定位在北京，或者定位对了但是缩放错误），未找到确切原因，为保证应用正常使用，删除了skew配置。</p>
<h3 data-id="heading-3">触摸事件穿透</h3>
<p>设置了元素定位在地图上方时，滑动元素，底部地图会跟随移动，常见于苹果手机，通过设置以下代码即可：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">view</span> @<span class="hljs-attr">touchmove.stop.prevent</span>=<span class="hljs-string">"stopTouchMove"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">stopTouchMove</span> = (<span class="hljs-params"/>) =&gt; {}
</code></pre>
<h2 data-id="heading-4">Wot UI FloatingPanel浮动面板交互优化</h2>
<p>当FloatingPanel包含滚动列表时，在内容区向上滑动，不会触发面板展开，只会滚动列表，不符合使用的习惯，应该改为：内容区向上滑动，判断面板是否完全展开，是则列表滚动，否则展开面板</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 父组件 传入子组件浮动面板的高度、展开高度 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">wd-floating-panel</span> <span class="hljs-attr">v-model:height</span>=<span class="hljs-string">"height"</span> <span class="hljs-attr">:anchors</span>=<span class="hljs-string">"anchors"</span> <span class="hljs-attr">:safeAreaInsetBottom</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">:showScrollbar</span>=<span class="hljs-string">"false"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">PromotionList</span> <span class="hljs-attr">:panelHeight</span>=<span class="hljs-string">"height"</span> <span class="hljs-attr">:panelMaxHeight</span>=<span class="hljs-string">"panelMaxHeight"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">wd-floating-panel</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 子组件 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">scroll-view</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"height: 100%;"</span> <span class="hljs-attr">:scroll-y</span>=<span class="hljs-string">"scrollY"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">scroll-view</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 子组件，设置计算属性scrollY，判断浮动面板高度达到最大高度则允许垂直方向的滚动，否则禁用</span>
<span class="hljs-keyword">const</span> props = <span class="hljs-title function_">defineProps</span>({
    <span class="hljs-comment">// 浮动面板高度</span>
    <span class="hljs-attr">panelHeight</span>: {
        <span class="hljs-attr">type</span>: <span class="hljs-title class_">Number</span>,
        <span class="hljs-attr">default</span>: <span class="hljs-number">0</span>
    },
    <span class="hljs-comment">// 浮动面板最大高度</span>
    <span class="hljs-attr">panelMaxHeight</span>: {
        <span class="hljs-attr">type</span>: <span class="hljs-title class_">Number</span>,
        <span class="hljs-attr">default</span>: <span class="hljs-number">0</span>
    }
})

<span class="hljs-keyword">const</span> scrollY = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">return</span> props.<span class="hljs-property">panelHeight</span> === props.<span class="hljs-property">panelMaxHeight</span>
})
</code></pre>
<h2 data-id="heading-5">启用分享功能</h2>
<p>通过混入(mixin)方式设置指定页面启用分享功能</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// shareMixin.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">share</span>: {
        <span class="hljs-attr">title</span>: <span class="hljs-string">"标题"</span>,
        <span class="hljs-attr">path</span>: <span class="hljs-string">"页面路由"</span>,
      },
    };
  },
  <span class="hljs-comment">// 分享到微信好友功能</span>
  <span class="hljs-title function_">onShareAppMessage</span>(<span class="hljs-params">res</span>) {
    <span class="hljs-comment">// 获取当前页面标题</span>
    <span class="hljs-keyword">const</span> pages = <span class="hljs-title function_">getCurrentPages</span>();
    <span class="hljs-keyword">const</span> data = pages[pages.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>]?.<span class="hljs-property">$page</span>;
    <span class="hljs-keyword">const</span> { title, path } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">share</span>;
    <span class="hljs-keyword">return</span> {
      title,
      <span class="hljs-attr">path</span>: data?.<span class="hljs-property">fullPath</span> || path,
      <span class="hljs-title function_">success</span>(<span class="hljs-params">res</span>) {
        uni.<span class="hljs-title function_">showToast</span>({
          <span class="hljs-attr">title</span>: <span class="hljs-string">"分享成功"</span>,
        });
      },
      <span class="hljs-title function_">fail</span>(<span class="hljs-params">res</span>) {
        uni.<span class="hljs-title function_">showToast</span>({
          <span class="hljs-attr">title</span>: <span class="hljs-string">"分享失败"</span>,
          <span class="hljs-attr">icon</span>: <span class="hljs-string">"none"</span>,
        });
      },
    };
  },
  <span class="hljs-comment">// 分享到朋友圈功能</span>
  <span class="hljs-title function_">onShareTimeline</span>(<span class="hljs-params">res</span>) {
    <span class="hljs-keyword">const</span> pages = <span class="hljs-title function_">getCurrentPages</span>();
    <span class="hljs-keyword">const</span> data = pages[pages.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>]?.<span class="hljs-property">$page</span>;
    <span class="hljs-keyword">const</span> { title, path } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">share</span>;
    <span class="hljs-keyword">return</span> {
      title,
      <span class="hljs-attr">path</span>: data?.<span class="hljs-property">fullPath</span> || path,
      <span class="hljs-title function_">success</span>(<span class="hljs-params">res</span>) {
        uni.<span class="hljs-title function_">showToast</span>({
          <span class="hljs-attr">title</span>: <span class="hljs-string">"分享成功"</span>,
        });
      },
      <span class="hljs-title function_">fail</span>(<span class="hljs-params">res</span>) {
        uni.<span class="hljs-title function_">showToast</span>({
          <span class="hljs-attr">title</span>: <span class="hljs-string">"分享失败"</span>,
          <span class="hljs-attr">icon</span>: <span class="hljs-string">"none"</span>,
        });
      },
    };
  },
};

</code></pre>
<h2 data-id="heading-6">富文本内容格式化</h2>
<p>富文本字符串包含的图片可能设置了固定宽度，影响预览效果，通过正则进行处理</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">formatRichImg</span>(<span class="hljs-params">content</span>) {
  <span class="hljs-keyword">if</span> (!content) <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
  <span class="hljs-keyword">return</span> content
    .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/(&lt;img\b[^&gt;]*?)\s+style=(["'])[\s\S]*?\2([^&gt;]*&gt;)/gi</span>, <span class="hljs-string">"$1$3"</span>)
    .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/&lt;img/gi</span>, <span class="hljs-string">'&lt;img style="max-width:100%; height:auto;"'</span>);
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何在前端开发中高效运用AI：从提效到避坑]]></title>    <link>https://juejin.cn/post/7582528397865811995</link>    <guid>https://juejin.cn/post/7582528397865811995</guid>    <pubDate>2025-12-12T06:20:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582528397865811995" data-draft-id="7582553782398582830" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何在前端开发中高效运用AI：从提效到避坑"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-12T06:20:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我是天龙_绍"/> <meta itemprop="url" content="https://juejin.cn/user/1831109918994644"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何在前端开发中高效运用AI：从提效到避坑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1831109918994644/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我是天龙_绍
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T06:20:39.000Z" title="Fri Dec 12 2025 06:20:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    16
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><p>在日常前端开发中，如何合理、高效地运用AI工具，已成为衡量开发者工具链成熟度的重要维度。AI并非取代思考的“黑箱”，而是提升效率、辅助决策的“副驾驶”。本文将结合实践，系统介绍我在不同场景下使用AI工具的方法与原则。</p>
<hr/>
<h3 data-id="heading-0">一、代码补全与辅助开发：让编码更流畅</h3>
<p>在编码阶段，我会根据上下文选择合适的AI插件。例如，在VS Code中，<strong>TabNine</strong>擅长结合项目内的代码模式，对业务逻辑、类型定义进行智能补全，尤其适合TypeScript项目。而<strong>GitHub Copilot</strong>则更侧重于框架语法的联想与生成——当我在编写React Hooks或Vue 3 Composition API时，只需写出函数名或初步结构，它就能快速补全完整的逻辑片段，显著减少重复性输入。</p>
<blockquote>
<p>实践中，Copilot对于快速生成如<code>useEffect</code>依赖数组、表单校验函数等重复模式代码尤为高效，但需注意其生成的代码仍需人工审查逻辑正确性。</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">二、组件生成与逻辑实现：从描述到代码</h3>
<p>对于常见或稍复杂的UI组件，我会借助<strong>Cursor</strong>这类具备代码库理解能力的工具。例如，在Vue项目中，通过自然语言描述“需要一个带分页的表格组件，支持排序和筛选”，Cursor可以生成包含模板、脚本与样式的完整<code>.vue</code>文件，并附有基础的性能提示（如<code>v-for</code>加<code>key</code>）。</p>
<p>在业务逻辑开发中，我常先用AI梳理步骤。例如，面对“实现一个多步骤表单，每一步需验证并缓存数据”的需求，我会先让AI输出实现流程图与关键节点，再基于此生成具体代码结构。这既避免了直接生成代码可能出现的结构混乱，也锻炼了自身拆解需求的能力。</p>
<hr/>
<h3 data-id="heading-2">三、问题排查与技术学习：成为“智能调试助手”</h3>
<p>工程问题是前端开发中的高频场景。遇到如<strong>打包体积异常增长</strong>、<strong>iOS与安卓样式兼容</strong>、或某个神秘的控制台错误时，我会将错误信息、相关配置截图或代码片段输入到<strong>ChatGPT</strong>或<strong>通义灵码</strong>中，请求其分析可能原因并提供排查方向。AI往往能给出常见的解决路径或相关文档链接，大幅缩短“盲目搜索”的时间。</p>
<p>在学习新技术时，AI同样能加速理解。例如，当我需要快速上手<code>Svelte</code>时，我会让AI生成一个包含状态管理、事件处理的最小可运行示例，并对比其与React的差异。这种“即学即用”的方式，比纯读文档更易于建立直观认知。</p>
<hr/>
<h3 data-id="heading-3">四、文档与注释生成：减轻“写作负担”</h3>
<p>良好的文档与注释是团队协作的基石。我会利用<strong>Copilot</strong>为复杂函数自动生成符合JSDoc规范的注释，涵盖参数说明、返回值与示例。对于API文档，则可使用<strong>Notion AI</strong>或类似工具，基于后端提供的OpenAPI规范JSON，快速生成结构清晰的Swagger文档草稿，后续只需稍作调整与补充。</p>
<hr/>
<h3 data-id="heading-4">五、核心原则：AI是助手，而非替代</h3>
<p>尽管AI能显著提效，但我始终坚持以下原则：</p>
<ol>
<li><strong>校验与理解</strong>：所有AI生成的代码都必须经过逻辑审查、性能评估与兼容性测试，并确保自己理解其背后的实现原理。</li>
<li><strong>避免依赖</strong>：不将AI作为决策主体，尤其在架构设计、关键算法等核心环节，保持自主思考与判断。</li>
<li><strong>持续学习</strong>：将AI作为“学习伙伴”，通过追问与迭代，深化对技术原理的理解，而非仅仅获取答案。</li>
</ol>
<hr/>
<h3 data-id="heading-5">结语</h3>
<p>在前端开发中，AI工具已逐渐成为开发者工作流中不可或缺的一环。关键在于<strong>有选择、有判断地使用</strong>——让AI处理重复、琐碎或模式化的任务，而开发者则聚焦于架构设计、逻辑抽象与创造性解决问题。如此，人与AI方能形成高效协作，共同推动开发体验与产品质量的提升。</p>
<blockquote>
<p>工具在变，但工程师的核心价值不变：批判性思维、系统化设计与持续学习的能力，始终是我们驾驭任何新技术工具的根基。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3中v-bind:class与v-bind:style如何实现条件样式、组件样式合并与深层响应式管理？]]></title>    <link>https://juejin.cn/post/7582553782398664750</link>    <guid>https://juejin.cn/post/7582553782398664750</guid>    <pubDate>2025-12-12T06:29:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582553782398664750" data-draft-id="7582561515816337471" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" Vue3中v-bind:class与v-bind:style如何实现条件样式、组件样式合并与深层响应式管理？    "/> <meta itemprop="keywords" content="前端,AI编程,Trae"/> <meta itemprop="datePublished" content="2025-12-12T06:29:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="kknone"/> <meta itemprop="url" content="https://juejin.cn/user/1366025597879930"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             Vue3中v-bind:class与v-bind:style如何实现条件样式、组件样式合并与深层响应式管理？    
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1366025597879930/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    kknone
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T06:29:39.000Z" title="Fri Dec 12 2025 06:29:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    12
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在前端开发中，动态控制元素样式是高频需求——小到按钮点击后的高亮状态，大到根据数据状态切换组件的整体外观。Vue3 提供的 <code>v-bind:class</code>（简写 <code>:class</code>）和 <code>v-bind:style</code>（简写 <code>:style</code>）指令，让我们能以<strong>声明式</strong>的方式轻松实现这些需求。今天我们就深入学习它们的基础概念、语法逻辑，以及 Vue3 带来的响应式优化。</p>
<h2 data-id="heading-0">一、<code>v-bind:class</code>——动态切换类名</h2>
<p><code>v-bind:class</code> 的核心是<strong>根据条件添加/移除 CSS 类名</strong>，支持<strong>字符串、对象、数组</strong>三种语法，覆盖了几乎所有动态类名的场景。</p>
<h3 data-id="heading-1">1. 基础语法：从简单到复杂</h3>
<h4 data-id="heading-2">（1）字符串语法：单一动态类名</h4>
<p>适合类名完全由变量控制的场景（无需条件判断）。比如：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 根据currentType切换类名：info/warning/error --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"alert"</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"currentType"</span>&gt;</span>
    {{ message }}
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-comment">// 响应式变量：控制警示框类型</span>
<span class="hljs-keyword">const</span> currentType = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'info'</span>) 
<span class="hljs-keyword">const</span> message = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'这是一条提示信息'</span>)
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.alert</span> { <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span>; <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>; <span class="hljs-attribute">margin</span>: <span class="hljs-number">10px</span> <span class="hljs-number">0</span>; }
<span class="hljs-selector-class">.info</span> { <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#d3eafd</span>; <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#90caf9</span>; }
<span class="hljs-selector-class">.warning</span> { <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#fff3cd</span>; <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ffeeba</span>; }
<span class="hljs-selector-class">.error</span> { <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#f8d7da</span>; <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#f5c6cb</span>; }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<p>当 <code>currentType</code> 从 <code>info</code> 改为 <code>warning</code> 时，元素会自动切换到 <code>warning</code> 类对应的样式——<strong>无需手动操作 DOM</strong>。</p>
<h4 data-id="heading-3">（2）对象语法：条件控制类名（最常用）</h4>
<p>对象语法的核心是**「类名: 布尔值」**的键值对：当布尔值为 <code>true</code> 时，类名被添加；为 <code>false</code> 时移除。比如实现一个「点击切换激活状态」的按钮：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> 
    <span class="hljs-attr">class</span>=<span class="hljs-string">"btn"</span>
    <span class="hljs-attr">:class</span>=<span class="hljs-string">"{ active: isActive, disabled: isDisabled }"</span>
    @<span class="hljs-attr">click</span>=<span class="hljs-string">"toggleActive"</span>
  &gt;</span>
    {{ isActive ? '已激活' : '未激活' }}
  <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-comment">// 响应式状态：控制激活/禁用</span>
<span class="hljs-keyword">const</span> isActive = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)
<span class="hljs-keyword">const</span> isDisabled = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)

<span class="hljs-comment">// 点击事件：切换状态</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleActive</span> = (<span class="hljs-params"/>) =&gt; {
  isActive.<span class="hljs-property">value</span> = !isActive.<span class="hljs-property">value</span>
  isDisabled.<span class="hljs-property">value</span> = isActive.<span class="hljs-property">value</span> <span class="hljs-comment">// 激活时禁用按钮</span>
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.btn</span> { <span class="hljs-attribute">padding</span>: <span class="hljs-number">8px</span> <span class="hljs-number">16px</span>; <span class="hljs-attribute">border</span>: none; <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>; <span class="hljs-attribute">cursor</span>: pointer; }
<span class="hljs-selector-class">.active</span> { <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#42b983</span>; <span class="hljs-attribute">color</span>: white; }
<span class="hljs-selector-class">.disabled</span> { <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0.6</span>; <span class="hljs-attribute">cursor</span>: not-allowed; }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<p>这段代码的逻辑很清晰：</p>
<ul>
<li><code>isActive</code> 为 <code>true</code> 时，添加 <code>active</code> 类（绿色背景）；</li>
<li><code>isDisabled</code> 为 <code>true</code> 时，添加 <code>disabled</code> 类（半透明+禁止指针）；</li>
<li>点击按钮会翻转 <code>isActive</code> 的值，从而动态修改类名。</li>
</ul>
<h4 data-id="heading-4">（3）数组语法：组合多个动态类名</h4>
<p>当需要<strong>同时控制多个动态类名</strong>时，用数组语法。比如一个组件需要同时添加「主题类」和「大小类」：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card"</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"[themeClass, sizeClass]"</span>&gt;</span>
    组合动态类名
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-comment">// 主题类：light/dark</span>
<span class="hljs-keyword">const</span> themeClass = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'light'</span>)
<span class="hljs-comment">// 大小类：small/medium/large</span>
<span class="hljs-keyword">const</span> sizeClass = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'medium'</span>)
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.card</span> { <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#eee</span>; <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>; <span class="hljs-attribute">padding</span>: <span class="hljs-number">16px</span>; }
<span class="hljs-selector-class">.light</span> { <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#fff</span>; <span class="hljs-attribute">color</span>: <span class="hljs-number">#333</span>; }
<span class="hljs-selector-class">.dark</span> { <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#333</span>; <span class="hljs-attribute">color</span>: <span class="hljs-number">#fff</span>; }
<span class="hljs-selector-class">.small</span> { <span class="hljs-attribute">font-size</span>: <span class="hljs-number">12px</span>; }
<span class="hljs-selector-class">.medium</span> { <span class="hljs-attribute">font-size</span>: <span class="hljs-number">16px</span>; }
<span class="hljs-selector-class">.large</span> { <span class="hljs-attribute">font-size</span>: <span class="hljs-number">20px</span>; }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<p>数组中的每个元素都可以是<strong>字符串变量</strong>或<strong>对象语法</strong>（混合条件判断）。比如：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 混合对象语法：条件添加active类 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"[themeClass, { active: isActive }]"</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<h3 data-id="heading-5">2. 组件中的 <code>v-bind:class</code>：类名合并</h3>
<p>当你在<strong>子组件</strong>上使用 <code>:class</code> 时，Vue 会自动将父组件的类名<strong>合并</strong>到子组件的根元素上。比如：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- 子组件：MyButton.vue --&gt;
&lt;template&gt;
  &lt;!-- 子组件自身的类名：btn --&gt;
  &lt;button class="btn"&gt;{{ label }}&lt;/button&gt;
&lt;/template&gt;

&lt;style&gt;
.btn { padding: 8px 16px; border: none; border-radius: 4px; }
&lt;/style&gt;
</code></pre>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 父组件使用 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 父组件添加的类名：primary --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">MyButton</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"{ primary: isPrimary }"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"主要按钮"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">MyButton</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./MyButton.vue'</span>
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">const</span> isPrimary = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">true</span>)
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.primary</span> { <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#2196f3</span>; <span class="hljs-attribute">color</span>: white; }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<p>最终子组件的按钮会有 <strong><code>btn primary</code></strong> 两个类名——父组件的类名不会覆盖子组件的类名，而是<strong>合并</strong>。</p>
<h2 data-id="heading-6">二、<code>v-bind:style</code>——动态内联样式</h2>
<p><code>v-bind:style</code> 用于<strong>直接设置元素的内联样式</strong>，语法与 <code>:class</code> 类似，但更贴近 CSS 的原生写法。</p>
<h3 data-id="heading-7">1. 对象语法：直接绑定样式对象</h3>
<p>最常用的方式——键是 <strong>CSS 属性名</strong>（驼峰式或短横线式），值是<strong>动态变量</strong>。比如实现一个「可调整字体大小」的文本：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> 
    <span class="hljs-attr">:style</span>=<span class="hljs-string">"{ 
      color: textColor, 
      fontSize: `${fontSize}px`, 
      'background-color': bgColor 
    }"</span>
  &gt;</span>
    动态内联样式示例
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"increaseFontSize"</span>&gt;</span>放大字体<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-comment">// 响应式变量：控制样式</span>
<span class="hljs-keyword">const</span> textColor = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'#333'</span>)   <span class="hljs-comment">// 文字颜色</span>
<span class="hljs-keyword">const</span> fontSize = <span class="hljs-title function_">ref</span>(<span class="hljs-number">16</span>)        <span class="hljs-comment">// 字体大小（带单位）</span>
<span class="hljs-keyword">const</span> bgColor = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'#f0f0f0'</span>)  <span class="hljs-comment">// 背景色（短横线式属性）</span>

<span class="hljs-comment">// 点击事件：字体放大2px</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">increaseFontSize</span> = (<span class="hljs-params"/>) =&gt; {
  fontSize.<span class="hljs-property">value</span> += <span class="hljs-number">2</span>
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>注意事项：</p>
<ul>
<li>CSS 属性名可以用<strong>驼峰式</strong>（如 <code>fontSize</code> 对应 <code>font-size</code>）或<strong>短横线式</strong>（如 <code>'background-color'</code>，需要引号包裹）；</li>
<li>数值类属性（如 <code>fontSize</code>）需要手动加单位（如 <code>px</code>），否则会无效。</li>
</ul>
<h3 data-id="heading-8">2. 数组语法：组合多个样式对象</h3>
<p>当需要<strong>合并多个样式对象</strong>时，用数组语法。比如一个组件需要同时应用「基础样式」和「主题样式」：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">:style</span>=<span class="hljs-string">"[baseStyle, themeStyle]"</span>&gt;</span>组合样式示例<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-comment">// 基础样式：固定属性</span>
<span class="hljs-keyword">const</span> baseStyle = <span class="hljs-title function_">ref</span>({
  <span class="hljs-attr">padding</span>: <span class="hljs-string">'16px'</span>,
  <span class="hljs-attr">border</span>: <span class="hljs-string">'1px solid #eee'</span>,
  border-<span class="hljs-attr">radius</span>: <span class="hljs-string">'8px'</span>
})
<span class="hljs-comment">// 主题样式：动态属性</span>
<span class="hljs-keyword">const</span> themeStyle = <span class="hljs-title function_">ref</span>({
  <span class="hljs-attr">backgroundColor</span>: <span class="hljs-string">'#d3eafd'</span>,
  <span class="hljs-attr">color</span>: <span class="hljs-string">'#2196f3'</span>
})
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h2 data-id="heading-9">三、Vue2 到 Vue3：语法延续与响应式优化</h2>
<p>Vue3 的 <code>:class</code> 和 <code>:style</code> 语法<strong>几乎完全继承 Vue2</strong>，但响应式系统的升级让样式更新更高效。</p>
<h3 data-id="heading-10">1. 语法延续性：无缝迁移</h3>
<p>Vue2 中的代码几乎可以直接复制到 Vue3 中使用，只是<strong>响应式数据的定义方式</strong>变了：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Vue2：data() 中的响应式数据</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">isActive</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">fontSize</span>: <span class="hljs-number">16</span>
    }
  }
}

<span class="hljs-comment">// Vue3：用 ref/reactive 定义响应式数据</span>
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">const</span> isActive = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)
<span class="hljs-keyword">const</span> fontSize = <span class="hljs-title function_">ref</span>(<span class="hljs-number">16</span>)
</code></pre>
<h3 data-id="heading-11">2. Vue3 的响应式优化：更聪明的更新</h3>
<p>Vue3 用 <strong>Proxy</strong> 代替了 Vue2 的 <code>Object.defineProperty</code>，带来两个关键提升：</p>
<ul>
<li><strong>深层响应式</strong>：修改对象的深层属性（如 <code>obj.user.info.age</code>）会自动触发更新，无需 <code>Vue.set</code>；</li>
<li><strong>数组直接修改</strong>：直接修改数组元素（如 <code>arr[0] = 'new value'</code>）或长度（如 <code>arr.length = 0</code>）会触发更新，无需 <code>splice</code>。</li>
</ul>
<details>
<summary>往期文章归档</summary>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fc85e1fe16a7ae45e965b4e2df4d9d2f4%2F" target="_blank" title="https://blog.cmdragon.cn/posts/c85e1fe16a7ae45e965b4e2df4d9d2f4/" ref="nofollow noopener noreferrer">Vue浅响应式如何解决深层响应式的性能问题？适用场景有哪些？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fc85e1fe16a7ae45e965b4e2df4d9d2f4%2F" target="_blank" title="https://blog.cmdragon.cn/posts/c85e1fe16a7ae45e965b4e2df4d9d2f4/" ref="nofollow noopener noreferrer">Vue浅响应式如何解决深层响应式的性能问题？适用场景有哪些？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fc85e1fe16a7ae45e965b4e2df4d9d2f4%2F" target="_blank" title="https://blog.cmdragon.cn/posts/c85e1fe16a7ae45e965b4e2df4d9d2f4/" ref="nofollow noopener noreferrer">Vue浅响应式如何解决深层响应式的性能问题？适用场景有哪些？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbe04b02d2723994632de0d4ca22a3391%2F" target="_blank" title="https://blog.cmdragon.cn/posts/be04b02d2723994632de0d4ca22a3391/" ref="nofollow noopener noreferrer">Vue 3组合式API中ref与reactive的核心响应式差异及使用最佳实践是什么？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbe04b02d2723994632de0d4ca22a3391%2F" target="_blank" title="https://blog.cmdragon.cn/posts/be04b02d2723994632de0d4ca22a3391/" ref="nofollow noopener noreferrer">Vue 3组合式API中ref与reactive的核心响应式差异及使用最佳实践是什么？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fa0af08dd60a37b9a890a9957f2cbfc9f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/a0af08dd60a37b9a890a9957f2cbfc9f/" ref="nofollow noopener noreferrer">Vue3响应式系统中，对象新增属性、数组改索引、原始值代理的问题如何解决？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbc287e1e36287afd90750fd907eca85e%2F" target="_blank" title="https://blog.cmdragon.cn/posts/bc287e1e36287afd90750fd907eca85e/" ref="nofollow noopener noreferrer">Vue 3中watch侦听器的正确使用姿势你掌握了吗？深度监听、与watchEffect的差异及常见报错解析 - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F654b9447ef1ba7ec1126a1bc26a4726d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/654b9447ef1ba7ec1126a1bc26a4726d/" ref="nofollow noopener noreferrer">Vue响应式声明的API差异、底层原理与常见陷阱你都搞懂了吗 - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F654b9447ef1ba7ec1126a1bc26a4726d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/654b9447ef1ba7ec1126a1bc26a4726d/" ref="nofollow noopener noreferrer">Vue响应式声明的API差异、底层原理与常见陷阱你都搞懂了吗 - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fc405a8d9950af5b7c63b56c348ac36b6%2F" target="_blank" title="https://blog.cmdragon.cn/posts/c405a8d9950af5b7c63b56c348ac36b6/" ref="nofollow noopener noreferrer">为什么Vue 3需要ref函数？它的响应式原理与正确用法是什么？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fa7e9abb9691a81e4404d9facabe0f7c3%2F" target="_blank" title="https://blog.cmdragon.cn/posts/a7e9abb9691a81e4404d9facabe0f7c3/" ref="nofollow noopener noreferrer">Vue 3中reactive函数如何通过Proxy实现响应式？使用时要避开哪些误区？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbd995ea45161727597fb85b62566c43d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/bd995ea45161727597fb85b62566c43d/" ref="nofollow noopener noreferrer">Vue3响应式系统的底层原理与实践要点你真的懂吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F53e3f270a80675df662c6857a3332c0f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/53e3f270a80675df662c6857a3332c0f/" ref="nofollow noopener noreferrer">Vue 3模板如何通过编译三阶段实现从声明式语法到高效渲染的跨越 - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fddbce4f2a23aa72c96b1c0473900321e%2F" target="_blank" title="https://blog.cmdragon.cn/posts/ddbce4f2a23aa72c96b1c0473900321e/" ref="nofollow noopener noreferrer">快速入门Vue模板引用：从收DOM“快递”到调子组件方法，你玩明白了吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F23a2d5a334e15575277814c16e45df50%2F" target="_blank" title="https://blog.cmdragon.cn/posts/23a2d5a334e15575277814c16e45df50/" ref="nofollow noopener noreferrer">快速入门Vue模板里的JS表达式有啥不能碰？计算属性为啥比方法更能打？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F6be38de6382e31d282659b689c5b17f0%2F" target="_blank" title="https://blog.cmdragon.cn/posts/6be38de6382e31d282659b689c5b17f0/" ref="nofollow noopener noreferrer">快速入门Vue的v-model表单绑定：语法糖、动态值、修饰符的小技巧你都掌握了吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F60ce517684f4a418f453d66aa805606c%2F" target="_blank" title="https://blog.cmdragon.cn/posts/60ce517684f4a418f453d66aa805606c/" ref="nofollow noopener noreferrer">快速入门Vue3事件处理的挑战题：v-on、修饰符、自定义事件你能通关吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fe4ae7d5e4a9205bb11b2baccb230c637%2F" target="_blank" title="https://blog.cmdragon.cn/posts/e4ae7d5e4a9205bb11b2baccb230c637/" ref="nofollow noopener noreferrer">快速入门Vue3的v-指令：数据和DOM的“翻译官”到底有多少本事？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F999ce4fb32259ff4fbf4bf7bcb851654%2F" target="_blank" title="https://blog.cmdragon.cn/posts/999ce4fb32259ff4fbf4bf7bcb851654/" ref="nofollow noopener noreferrer">快速入门Vue3，插值、动态绑定和避坑技巧你都搞懂了吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fa6997d81b49cd232b87e1cf603888ad1%2F" target="_blank" title="https://blog.cmdragon.cn/posts/a6997d81b49cd232b87e1cf603888ad1/" ref="nofollow noopener noreferrer">想让PostgreSQL快到飞起？先找健康密码还是先换引擎？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F1fee7afbb9abd4540b8aa9c141d6845d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/1fee7afbb9abd4540b8aa9c141d6845d/" ref="nofollow noopener noreferrer">想让PostgreSQL查询快到飞起？分区表、物化视图、并行查询这三招灵不灵？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F79c590fbd87ece535b11a71c9667884f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/79c590fbd87ece535b11a71c9667884f/" ref="nofollow noopener noreferrer">子查询总拖慢查询？把它变成连接就能解决？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F748cdac2536008199abf8a8a2cd0ec85%2F" target="_blank" title="https://blog.cmdragon.cn/posts/748cdac2536008199abf8a8a2cd0ec85/" ref="nofollow noopener noreferrer">PostgreSQL全表扫描慢到崩溃？建索引+改查询+更统计信息三招能破？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F32ca943703226d317d4276a8fb53b0dd%2F" target="_blank" title="https://blog.cmdragon.cn/posts/32ca943703226d317d4276a8fb53b0dd/" ref="nofollow noopener noreferrer">复杂查询总拖后腿？PostgreSQL多列索引+覆盖索引的神仙技巧你get没？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fca93f1d53aa910e7ba5ffd8df611c12b%2F" target="_blank" title="https://blog.cmdragon.cn/posts/ca93f1d53aa910e7ba5ffd8df611c12b/" ref="nofollow noopener noreferrer">只给表子集建索引？用函数结果建索引？PostgreSQL这俩操作凭啥能省空间又加速？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Ff507856ebfddd592448813c510a53669%2F" target="_blank" title="https://blog.cmdragon.cn/posts/f507856ebfddd592448813c510a53669/" ref="nofollow noopener noreferrer">B-tree索引像字典查词一样工作？那哪些数据库查询它能加速，哪些不能？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fb2213bfcb5b88a862f2138404c03d596%2F" target="_blank" title="https://blog.cmdragon.cn/posts/b2213bfcb5b88a862f2138404c03d596/" ref="nofollow noopener noreferrer">想抓PostgreSQL里的慢SQL？pg_stat_statements基础黑匣子和pg_stat_monitor时间窗，谁能帮你更准揪出性能小偷？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F26614eb7da6c476dde41d367ad888d2f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/26614eb7da6c476dde41d367ad888d2f/" ref="nofollow noopener noreferrer">PostgreSQL的“时光机”MVCC和锁机制是怎么搞定高并发的？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F69f99bc6972a860d559c74aad7280da4%2F" target="_blank" title="https://blog.cmdragon.cn/posts/69f99bc6972a860d559c74aad7280da4/" ref="nofollow noopener noreferrer">PostgreSQL性能暴涨的关键？内存IO并发参数居然要这么设置？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F7b7053f392147a8b3b1a16bebeb08d0a%2F" target="_blank" title="https://blog.cmdragon.cn/posts/7b7053f392147a8b3b1a16bebeb08d0a/" ref="nofollow noopener noreferrer">大表查询慢到翻遍整个书架？PostgreSQL分区表教你怎么“分类”才高效</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fc856e3cb073822349f3bf2d29995dcfc%2F" target="_blank" title="https://blog.cmdragon.cn/posts/c856e3cb073822349f3bf2d29995dcfc/" ref="nofollow noopener noreferrer">PostgreSQL 查询慢？是不是忘了优化 GROUP BY、ORDER BY 和窗口函数？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fc096347d18e67b7431faacd2c4757093%2F" target="_blank" title="https://blog.cmdragon.cn/posts/c096347d18e67b7431faacd2c4757093/" ref="nofollow noopener noreferrer">PostgreSQL里的子查询和CTE居然在性能上“掐架”？到底该站哪边？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F2eca89463454fd4250d7b66243b9fe5a%2F" target="_blank" title="https://blog.cmdragon.cn/posts/2eca89463454fd4250d7b66243b9fe5a/" ref="nofollow noopener noreferrer">PostgreSQL选Join策略有啥小九九？Nested Loop/Merge/Hash谁是它的菜？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F068ecb772a87d7df20a8c9fb4b233f8e%2F" target="_blank" title="https://blog.cmdragon.cn/posts/068ecb772a87d7df20a8c9fb4b233f8e/" ref="nofollow noopener noreferrer">PostgreSQL新手SQL总翻车？这7个性能陷阱你踩过没？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fd498f63cd0a2d5a77e445c688a8b88db%2F" target="_blank" title="https://blog.cmdragon.cn/posts/d498f63cd0a2d5a77e445c688a8b88db/" ref="nofollow noopener noreferrer">PostgreSQL索引选B-Tree还是GiST？“瑞士军刀”和“多面手”的差别你居然还不知道？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F9101b75bdec6faea9b35d54f14e37f36%2F" target="_blank" title="https://blog.cmdragon.cn/posts/9101b75bdec6faea9b35d54f14e37f36/" ref="nofollow noopener noreferrer">想知道数据库怎么给查询“算成本选路线”？EXPLAIN能帮你看明白？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fd527f8ebb6e3dae2c7dfe4c8d8979444%2F" target="_blank" title="https://blog.cmdragon.cn/posts/d527f8ebb6e3dae2c7dfe4c8d8979444/" ref="nofollow noopener noreferrer">PostgreSQL处理SQL居然像做蛋糕？解析到执行的4步里藏着多少查询优化的小心机？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F6bfdae84f313cf7ad0bb7045c4392347%2F" target="_blank" title="https://blog.cmdragon.cn/posts/6bfdae84f313cf7ad0bb7045c4392347/" ref="nofollow noopener noreferrer">PostgreSQL备份不是复制文件？物理vs逻辑咋选？误删还能精准恢复到1分钟前？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fde3672803de34dbad244d0a8d48b0eb5%2F" target="_blank" title="https://blog.cmdragon.cn/posts/de3672803de34dbad244d0a8d48b0eb5/" ref="nofollow noopener noreferrer">转账不翻车、并发不干扰，PostgreSQL的ACID特性到底有啥魔法？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fe463e8a2668abdf00a228c9b79324ded%2F" target="_blank" title="https://blog.cmdragon.cn/posts/e463e8a2668abdf00a228c9b79324ded/" ref="nofollow noopener noreferrer">银行转账不白扣钱、电商下单不超卖，PostgreSQL事务的诀窍是啥？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F5c967e595058c4a1fc4474a68e64031d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/5c967e595058c4a1fc4474a68e64031d/" ref="nofollow noopener noreferrer">PostgreSQL里的PL/pgSQL到底是啥？能让SQL从“说目标”变“讲步骤”？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F325047855e3e23b5ef82f7d2db134fbd%2F" target="_blank" title="https://blog.cmdragon.cn/posts/325047855e3e23b5ef82f7d2db134fbd/" ref="nofollow noopener noreferrer">PostgreSQL视图不存数据？那它怎么简化查询还能递归生成序列和控制权限？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fd2dba50bb6e4df7b27e735245a06a2a2%2F" target="_blank" title="https://blog.cmdragon.cn/posts/d2dba50bb6e4df7b27e735245a06a2a2/" ref="nofollow noopener noreferrer">PostgreSQL索引这么玩，才能让你的查询真的“飞”起来？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F849ae5bab0f8c66e94c2f6ad1bb798e3%2F" target="_blank" title="https://blog.cmdragon.cn/posts/849ae5bab0f8c66e94c2f6ad1bb798e3/" ref="nofollow noopener noreferrer">PostgreSQL的表关系和约束，咋帮你搞定用户订单不混乱、学生选课不重复？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fef4800975ffa84f1ca51976a70a1585b%2F" target="_blank" title="https://blog.cmdragon.cn/posts/ef4800975ffa84f1ca51976a70a1585b/" ref="nofollow noopener noreferrer">PostgreSQL查询的筛子、排序、聚合、分组？你会用它们搞定数据吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbf54711525c507c5eacfa7b0151c39d2%2F" target="_blank" title="https://blog.cmdragon.cn/posts/bf54711525c507c5eacfa7b0151c39d2/" ref="nofollow noopener noreferrer">PostgreSQL数据类型怎么选才高效不踩坑？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F887809b3e0375f5956873cd442f516d8%2F" target="_blank" title="https://blog.cmdragon.cn/posts/887809b3e0375f5956873cd442f516d8/" ref="nofollow noopener noreferrer">想解锁PostgreSQL查询从基础到进阶的核心知识点？你都get了吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F934be1203725e8be9d6f6e9104e5abcc%2F" target="_blank" title="https://blog.cmdragon.cn/posts/934be1203725e8be9d6f6e9104e5abcc/" ref="nofollow noopener noreferrer">PostgreSQL DELETE居然有这些操作？返回数据、连表删你试过没？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F0f0622e9b7402b599e618150d0596ffe%2F" target="_blank" title="https://blog.cmdragon.cn/posts/0f0622e9b7402b599e618150d0596ffe/" ref="nofollow noopener noreferrer">PostgreSQL UPDATE语句怎么玩？从改邮箱到批量更新的避坑技巧你都会吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F0e3bf7efc030b024ea67ee855a00f2de%2F" target="_blank" title="https://blog.cmdragon.cn/posts/0e3bf7efc030b024ea67ee855a00f2de/" ref="nofollow noopener noreferrer">PostgreSQL插入数据还在逐条敲？批量、冲突处理、返回自增ID的技巧你会吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fb6cd3c86da6aac26ed829e472d34078e%2F" target="_blank" title="https://blog.cmdragon.cn/posts/b6cd3c86da6aac26ed829e472d34078e/" ref="nofollow noopener noreferrer">PostgreSQL的“仓库-房间-货架”游戏，你能建出电商数据库和表吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fba1f545a3410144552fbdbfcf31b5265%2F" target="_blank" title="https://blog.cmdragon.cn/posts/ba1f545a3410144552fbdbfcf31b5265/" ref="nofollow noopener noreferrer">PostgreSQL 17安装总翻车？Windows/macOS/Linux避坑指南帮你搞定？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fb5474d1480509c5072085abc80b3dd9f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/b5474d1480509c5072085abc80b3dd9f/" ref="nofollow noopener noreferrer">能当关系型数据库还能玩对象特性，能拆复杂查询还能自动管库存，PostgreSQL凭什么这么香？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fcc098d8836e787baa8a4d92e4d56d5c5%2F" target="_blank" title="https://blog.cmdragon.cn/posts/cc098d8836e787baa8a4d92e4d56d5c5/" ref="nofollow noopener noreferrer">给接口加新字段又不搞崩老客户端？FastAPI的多版本API靠哪三招实现？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F46d05151c5bd31cf37a7bcf0b8f5b0b8%2F" target="_blank" title="https://blog.cmdragon.cn/posts/46d05151c5bd31cf37a7bcf0b8f5b0b8/" ref="nofollow noopener noreferrer">流量突增要搞崩FastAPI？熔断测试是怎么防系统雪崩的？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F65ce343cc5df9faf3a8e2eeaab42ae45%2F" target="_blank" title="https://blog.cmdragon.cn/posts/65ce343cc5df9faf3a8e2eeaab42ae45/" ref="nofollow noopener noreferrer">FastAPI秒杀库存总变负数？Redis分布式锁能帮你守住底线吗 - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Feed6cd8985d9be0a4b092a7da38b3e0c%2F" target="_blank" title="https://blog.cmdragon.cn/posts/eed6cd8985d9be0a4b092a7da38b3e0c/" ref="nofollow noopener noreferrer">FastAPI的CI流水线怎么自动测端点，还能让Allure报告美到犯规？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F6157d87338ce894d18c013c3c4777abb%2F" target="_blank" title="https://blog.cmdragon.cn/posts/6157d87338ce894d18c013c3c4777abb/" ref="nofollow noopener noreferrer">如何用GitHub Actions为FastAPI项目打造自动化测试流水线？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Ffc4ef84559e04693a620d0714cb30787%2F" target="_blank" title="https://blog.cmdragon.cn/posts/fc4ef84559e04693a620d0714cb30787/" ref="nofollow noopener noreferrer">如何用Git Hook和CI流水线为FastAPI项目保驾护航？ - cmdragon's Blog</a></li>
</ul>
</details>
<details>
<summary>免费好用的热门在线工具</summary>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fraid-calculator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/raid-calculator" ref="nofollow noopener noreferrer">RAID 计算器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fphotoshop-online" target="_blank" title="https://tools.cmdragon.cn/zh/apps/photoshop-online" ref="nofollow noopener noreferrer">在线PS - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fmermaid-live-editor" target="_blank" title="https://tools.cmdragon.cn/zh/apps/mermaid-live-editor" ref="nofollow noopener noreferrer">Mermaid 在线编辑器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fmath-solver-calculator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/math-solver-calculator" ref="nofollow noopener noreferrer">数学求解计算器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsmart-teleprompter" target="_blank" title="https://tools.cmdragon.cn/zh/apps/smart-teleprompter" ref="nofollow noopener noreferrer">智能提词器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fmagic-resume" target="_blank" title="https://tools.cmdragon.cn/zh/apps/magic-resume" ref="nofollow noopener noreferrer">魔法简历 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fimage-puzzle-tool" target="_blank" title="https://tools.cmdragon.cn/zh/apps/image-puzzle-tool" ref="nofollow noopener noreferrer">Image Puzzle Tool - 图片拼图工具 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsubtitle-downloader" target="_blank" title="https://tools.cmdragon.cn/zh/apps/subtitle-downloader" ref="nofollow noopener noreferrer">字幕下载工具 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Flyrics-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/lyrics-generator" ref="nofollow noopener noreferrer">歌词生成工具 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fcloud-drive-search" target="_blank" title="https://tools.cmdragon.cn/zh/apps/cloud-drive-search" ref="nofollow noopener noreferrer">网盘资源聚合搜索 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fascii-art-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/ascii-art-generator" ref="nofollow noopener noreferrer">ASCII字符画生成器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fjwt-tool" target="_blank" title="https://tools.cmdragon.cn/zh/apps/jwt-tool" ref="nofollow noopener noreferrer">JSON Web Tokens 工具 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fbcrypt-tool" target="_blank" title="https://tools.cmdragon.cn/zh/apps/bcrypt-tool" ref="nofollow noopener noreferrer">Bcrypt 密码工具 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fgif-composer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/gif-composer" ref="nofollow noopener noreferrer">GIF 合成器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fgif-decomposer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/gif-decomposer" ref="nofollow noopener noreferrer">GIF 分解器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftext-steganography" target="_blank" title="https://tools.cmdragon.cn/zh/apps/text-steganography" ref="nofollow noopener noreferrer">文本隐写术 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh" target="_blank" title="https://tools.cmdragon.cn/zh" ref="nofollow noopener noreferrer">CMDragon 在线工具 - 高级AI工具箱与开发者套件 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%3Fcategory%3Dtrending" target="_blank" title="https://tools.cmdragon.cn/zh/apps?category=trending" ref="nofollow noopener noreferrer">应用商店 - 发现1000+提升效率与开发的AI工具和实用程序 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fchangelog" target="_blank" title="https://tools.cmdragon.cn/zh/changelog" ref="nofollow noopener noreferrer">CMDragon 更新日志 - 最新更新、功能与改进 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fsponsor" target="_blank" title="https://tools.cmdragon.cn/zh/sponsor" ref="nofollow noopener noreferrer">支持我们 - 成为赞助者 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftext-to-image-ai" target="_blank" title="https://tools.cmdragon.cn/zh/apps/text-to-image-ai" ref="nofollow noopener noreferrer">AI文本生成图像 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftemp-email" target="_blank" title="https://tools.cmdragon.cn/zh/apps/temp-email" ref="nofollow noopener noreferrer">临时邮箱 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fqrcode-parser" target="_blank" title="https://tools.cmdragon.cn/zh/apps/qrcode-parser" ref="nofollow noopener noreferrer">二维码解析器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftext-to-mindmap" target="_blank" title="https://tools.cmdragon.cn/zh/apps/text-to-mindmap" ref="nofollow noopener noreferrer">文本转思维导图 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fregex-visualizer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/regex-visualizer" ref="nofollow noopener noreferrer">正则表达式可视化工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsteganography-tool" target="_blank" title="https://tools.cmdragon.cn/zh/apps/steganography-tool" ref="nofollow noopener noreferrer">文件隐写工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fiptv-explorer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/iptv-explorer" ref="nofollow noopener noreferrer">IPTV 频道探索器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsnapdrop" target="_blank" title="https://tools.cmdragon.cn/zh/apps/snapdrop" ref="nofollow noopener noreferrer">快传 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Flucky-draw" target="_blank" title="https://tools.cmdragon.cn/zh/apps/lucky-draw" ref="nofollow noopener noreferrer">随机抽奖工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fanime-scene-finder" target="_blank" title="https://tools.cmdragon.cn/zh/apps/anime-scene-finder" ref="nofollow noopener noreferrer">动漫场景查找器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftime-toolkit" target="_blank" title="https://tools.cmdragon.cn/zh/apps/time-toolkit" ref="nofollow noopener noreferrer">时间工具箱 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fspeed-test" target="_blank" title="https://tools.cmdragon.cn/zh/apps/speed-test" ref="nofollow noopener noreferrer">网速测试 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fbackground-remover" target="_blank" title="https://tools.cmdragon.cn/zh/apps/background-remover" ref="nofollow noopener noreferrer">AI 智能抠图工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fbackground-replacer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/background-replacer" ref="nofollow noopener noreferrer">背景替换工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fartistic-qrcode" target="_blank" title="https://tools.cmdragon.cn/zh/apps/artistic-qrcode" ref="nofollow noopener noreferrer">艺术二维码生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fopen-graph-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/open-graph-generator" ref="nofollow noopener noreferrer">Open Graph 元标签生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fimage-comparison" target="_blank" title="https://tools.cmdragon.cn/zh/apps/image-comparison" ref="nofollow noopener noreferrer">图像对比工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fimage-compressor" target="_blank" title="https://tools.cmdragon.cn/zh/apps/image-compressor" ref="nofollow noopener noreferrer">图片压缩专业版 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fpassword-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/password-generator" ref="nofollow noopener noreferrer">密码生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsvg-optimizer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/svg-optimizer" ref="nofollow noopener noreferrer">SVG优化器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fcolor-palette" target="_blank" title="https://tools.cmdragon.cn/zh/apps/color-palette" ref="nofollow noopener noreferrer">调色板生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fonline-metronome" target="_blank" title="https://tools.cmdragon.cn/zh/apps/online-metronome" ref="nofollow noopener noreferrer">在线节拍器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fip-geolocation" target="_blank" title="https://tools.cmdragon.cn/zh/apps/ip-geolocation" ref="nofollow noopener noreferrer">IP归属地查询 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fcss-grid-layout" target="_blank" title="https://tools.cmdragon.cn/zh/apps/css-grid-layout" ref="nofollow noopener noreferrer">CSS网格布局生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Femail-validator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/email-validator" ref="nofollow noopener noreferrer">邮箱验证工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fcalligraphy-practice" target="_blank" title="https://tools.cmdragon.cn/zh/apps/calligraphy-practice" ref="nofollow noopener noreferrer">书法练习字帖 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ffinance-calculator-suite" target="_blank" title="https://tools.cmdragon.cn/zh/apps/finance-calculator-suite" ref="nofollow noopener noreferrer">金融计算器套件 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fchinese-kinship-calculator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/chinese-kinship-calculator" ref="nofollow noopener noreferrer">中国亲戚关系计算器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fprotobuf-toolkit" target="_blank" title="https://tools.cmdragon.cn/zh/apps/protobuf-toolkit" ref="nofollow noopener noreferrer">Protocol Buffer 工具箱 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fip-geolocation" target="_blank" title="https://tools.cmdragon.cn/zh/apps/ip-geolocation" ref="nofollow noopener noreferrer">IP归属地查询 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fimage-upscaler" target="_blank" title="https://tools.cmdragon.cn/zh/apps/image-upscaler" ref="nofollow noopener noreferrer">图片无损放大 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftext-compare" target="_blank" title="https://tools.cmdragon.cn/zh/apps/text-compare" ref="nofollow noopener noreferrer">文本比较工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fip-batch-lookup" target="_blank" title="https://tools.cmdragon.cn/zh/apps/ip-batch-lookup" ref="nofollow noopener noreferrer">IP批量查询工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fdomain-finder" target="_blank" title="https://tools.cmdragon.cn/zh/apps/domain-finder" ref="nofollow noopener noreferrer">域名查询工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fdns-toolkit" target="_blank" title="https://tools.cmdragon.cn/zh/apps/dns-toolkit" ref="nofollow noopener noreferrer">DNS工具箱 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ffavicon-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/favicon-generator" ref="nofollow noopener noreferrer">网站图标生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fsitemap_index.xml" target="_blank" title="https://tools.cmdragon.cn/sitemap_index.xml" ref="nofollow noopener noreferrer">XML Sitemap</a></li>
</ul>
</details>
<p>比如修改深层样式对象：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">:style</span>=<span class="hljs-string">"boxStyle"</span>&gt;</span>动态深层样式<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"changeBgColor"</span>&gt;</span>切换背景<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { reactive } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-comment">// 用 reactive 定义深层响应式对象</span>
<span class="hljs-keyword">const</span> boxStyle = <span class="hljs-title function_">reactive</span>({
  <span class="hljs-attr">container</span>: {
    <span class="hljs-attr">backgroundColor</span>: <span class="hljs-string">'#f0f0f0'</span>,
    <span class="hljs-attr">padding</span>: <span class="hljs-string">'20px'</span>,
    <span class="hljs-attr">border</span>: <span class="hljs-string">'1px solid #eee'</span>
  }
})

<span class="hljs-comment">// 直接修改深层属性，触发更新</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">changeBgColor</span> = (<span class="hljs-params"/>) =&gt; {
  boxStyle.<span class="hljs-property">container</span>.<span class="hljs-property">backgroundColor</span> = 
    boxStyle.<span class="hljs-property">container</span>.<span class="hljs-property">backgroundColor</span> === <span class="hljs-string">'#f0f0f0'</span> 
    ? <span class="hljs-string">'#d3eafd'</span> 
    : <span class="hljs-string">'#f0f0f0'</span>
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>在 Vue2 中，修改 <code>boxStyle.container.backgroundColor</code> 不会触发更新（需要 <code>Vue.set</code>），但 Vue3 用 Proxy 直接拦截了属性修改，<strong>无需额外操作</strong>。</p>
<h2 data-id="heading-12">四、课后 Quiz：巩固你的理解</h2>
<h3 data-id="heading-13">问题1</h3>
<p>如何用 <code>v-bind:class</code> 同时添加<strong>静态类名</strong>和<strong>条件类名</strong>？请写出示例代码。</p>
<h3 data-id="heading-14">问题2</h3>
<p><code>v-bind:style</code> 的对象语法中，CSS 属性名可以用哪些形式？请举例说明。</p>
<h3 data-id="heading-15">答案解析</h3>
<h4 data-id="heading-16">问题1：混合静态与条件类名</h4>
<p>用<strong>数组语法</strong>或<strong>对象语法</strong>都可以。比如：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 数组语法：静态类名 + 条件类名 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card"</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"[ 'shadow', { active: isActive } ]"</span>&gt;</span>
    静态+条件类名
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">const</span> isActive = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">true</span>)
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.card</span> { <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#eee</span>; <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>; <span class="hljs-attribute">padding</span>: <span class="hljs-number">16px</span>; }
<span class="hljs-selector-class">.shadow</span> { <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">2px</span> <span class="hljs-number">4px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.1</span>); }
<span class="hljs-selector-class">.active</span> { <span class="hljs-attribute">border-color</span>: <span class="hljs-number">#2196f3</span>; }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<h4 data-id="heading-17">问题2：CSS 属性名的两种形式</h4>
<ul>
<li><strong>驼峰式</strong>：对应 CSS 的短横线命名（如 <code>fontSize</code> → <code>font-size</code>，<code>backgroundColor</code> → <code>background-color</code>）；</li>
<li><strong>短横线式</strong>：需要用引号包裹（如 <code>'font-size'</code>，<code>'background-color'</code>）。</li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">:style</span>=<span class="hljs-string">"{ 
  fontSize: '16px',        // 驼峰式
  'background-color': '#f0f0f0' // 短横线式（需引号）
}"</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<h2 data-id="heading-18">五、常见报错解决方案</h2>
<h3 data-id="heading-19">1. 报错：<code>[Vue warn]: Property "isActive" was accessed during render but is not defined on instance.</code></h3>
<ul>
<li><strong>原因</strong>：绑定的变量（如 <code>isActive</code>）未在组件中声明，Vue 找不到该变量；</li>
<li><strong>解决</strong>：用 <code>ref</code> 或 <code>reactive</code> 声明响应式变量：
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">const</span> isActive = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>) <span class="hljs-comment">// 必须声明！</span>
</code></pre>
</li>
</ul>
<h3 data-id="heading-20">2. 问题：修改变量后样式不更新</h3>
<ul>
<li><strong>原因</strong>：变量不是<strong>响应式</strong>的（用 <code>let</code> 声明的普通变量，不是 <code>ref</code>/<code>reactive</code>）；</li>
<li><strong>解决</strong>：用 Vue3 的响应式 API 包裹变量：
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 错误：let fontSize = 16;</span>
<span class="hljs-comment">// 正确：</span>
<span class="hljs-keyword">const</span> fontSize = <span class="hljs-title function_">ref</span>(<span class="hljs-number">16</span>)
</code></pre>
</li>
</ul>
<h3 data-id="heading-21">3. 报错：<code>[Vue warn]: Invalid value for dynamic directive argument (expected string or null): undefined</code></h3>
<ul>
<li><strong>原因</strong>：绑定的类名/样式属性名是 <code>undefined</code>（如 <code>{ [className]: isActive }</code> 中 <code>className</code> 未定义）；</li>
<li><strong>解决</strong>：给变量设置初始值，或用<strong>可选链</strong>处理：
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> className = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'active'</span>) <span class="hljs-comment">// 初始值</span>
<span class="hljs-comment">// 或用可选链</span>
:<span class="hljs-keyword">class</span>=<span class="hljs-string">"{ [className || '']: isActive }"</span>
</code></pre>
</li>
</ul>
<h2 data-id="heading-22">参考链接</h2>
<ul>
<li>Vue3 官方文档：Class and Style Binding <a href="https://link.juejin.cn?target=https%3A%2F%2Fvuejs.org%2Fguide%2Fessentials%2Fclass-and-style.html" target="_blank" title="https://vuejs.org/guide/essentials/class-and-style.html" ref="nofollow noopener noreferrer">vuejs.org/guide/essen…</a></li>
<li>Vue3 官方文档：响应式基础 <a href="https://link.juejin.cn?target=https%3A%2F%2Fvuejs.org%2Fguide%2Fessentials%2Freactivity-fundamentals.html" target="_blank" title="https://vuejs.org/guide/essentials/reactivity-fundamentals.html" ref="nofollow noopener noreferrer">vuejs.org/guide/essen…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[kotlin密封类的主要用途]]></title>    <link>https://juejin.cn/post/7582755817670426634</link>    <guid>https://juejin.cn/post/7582755817670426634</guid>    <pubDate>2025-12-12T06:57:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582755817670426634" data-draft-id="7582553782398976046" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="kotlin密封类的主要用途"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-12T06:57:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="南雨北斗"/> <meta itemprop="url" content="https://juejin.cn/user/4059818590476286"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            kotlin密封类的主要用途
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4059818590476286/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    南雨北斗
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T06:57:57.000Z" title="Fri Dec 12 2025 06:57:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    13
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Kotlin 中<strong>密封类（Sealed Class）的主要用途之一是实现“穷尽性检查”（Exhaustiveness Checking）</strong> 。这是它区别于普通抽象类或接口的关键优势。下面我们详细解释：</p>
<hr/>
<h2 data-id="heading-0">🔍 什么是“穷尽性检查”？</h2>
<p><strong>穷尽性检查</strong>是指：</p>
<blockquote>
<p>编译器能够静态地验证你在处理一个封闭类型（如密封类）时，是否已经覆盖了<strong>所有可能的子类型</strong>。</p>
</blockquote>
<p>如果遗漏了某个子类型，<strong>编译器会报错</strong>，从而避免运行时逻辑错误。</p>
<hr/>
<h2 data-id="heading-1">🧩 为什么需要穷尽性检查？</h2>
<p>考虑一个常见的场景：<strong>处理操作结果</strong>（成功、失败、加载中……）。如果你用普通父类：</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin">1open <span class="hljs-keyword">class</span> <span class="hljs-title class_">Result</span>
2<span class="hljs-keyword">class</span> <span class="hljs-title class_">Success</span>(<span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span>: String) : Result()
3<span class="hljs-keyword">class</span> <span class="hljs-title class_">Error</span>(<span class="hljs-keyword">val</span> msg: String) : Result()
</code></pre>
<p>然后用 <code>when</code> 处理：</p>
<pre><code class="hljs language-scss" lang="scss">Kotlin
编辑
<span class="hljs-number">1</span>fun <span class="hljs-built_in">handle</span>(result: Result) = when (result) {
<span class="hljs-number">2</span>    is Success -&gt; <span class="hljs-built_in">println</span>("OK")
<span class="hljs-number">3</span>    <span class="hljs-comment">// 忘记处理 Error！</span>
<span class="hljs-number">4</span>}
</code></pre>
<p>✅ <strong>这段代码能编译通过！</strong><br/>
但运行时如果传入 <code>Error</code>，就会抛出 <code>kotlin.NoWhenBranchMatchedException</code> —— <strong>这是一个运行时错误</strong>！</p>
<p>而使用<strong>密封类</strong>，就能在<strong>编译期</strong>发现这个问题。</p>
<hr/>
<h2 data-id="heading-2">✅ 密封类如何实现穷尽性检查？</h2>
<h3 data-id="heading-3">示例：用密封类定义结果</h3>
<pre><code class="hljs language-kotlin" lang="kotlin">Kotlin
编辑
1sealed <span class="hljs-keyword">class</span> <span class="hljs-title class_">Result</span> {
<span class="hljs-number">2</span>    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Success</span>(<span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span>: String) : Result()
<span class="hljs-number">3</span>    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Error</span>(<span class="hljs-keyword">val</span> msg: String) : Result()
<span class="hljs-number">4</span>    <span class="hljs-keyword">object</span> Loading : Result()
<span class="hljs-number">5</span>}
</code></pre>
<h3 data-id="heading-4">使用 <code>when</code> 处理（不带 <code>else</code>）</h3>
<pre><code class="hljs language-rust" lang="rust">Kotlin
编辑
<span class="hljs-number">1</span>fun <span class="hljs-title function_ invoke__">handle</span>(result: <span class="hljs-type">Result</span>): <span class="hljs-type">String</span> = <span class="hljs-title function_ invoke__">when</span> (result) {
<span class="hljs-number">2</span>    is <span class="hljs-type">Result</span>.Success <span class="hljs-punctuation">-&gt;</span> <span class="hljs-string">"成功: ${result.data}"</span>
<span class="hljs-number">3</span>    is <span class="hljs-type">Result</span>.Error <span class="hljs-punctuation">-&gt;</span> <span class="hljs-string">"失败: ${result.msg}"</span>
<span class="hljs-number">4</span>    <span class="hljs-type">Result</span>.Loading <span class="hljs-punctuation">-&gt;</span> <span class="hljs-string">"加载中"</span>
<span class="hljs-number">5</span>    <span class="hljs-comment">// 所有分支都覆盖了 → 编译通过 ✅</span>
<span class="hljs-number">6</span>}
</code></pre>
<p>现在，<strong>如果你删除任意一个分支</strong>，比如注释掉 <code>Loading</code>：</p>
<pre><code class="hljs language-rust" lang="rust">Kotlin
编辑
<span class="hljs-number">1</span>fun <span class="hljs-title function_ invoke__">handle</span>(result: <span class="hljs-type">Result</span>): <span class="hljs-type">String</span> = <span class="hljs-title function_ invoke__">when</span> (result) {
<span class="hljs-number">2</span>    is <span class="hljs-type">Result</span>.Success <span class="hljs-punctuation">-&gt;</span> <span class="hljs-string">"成功"</span>
<span class="hljs-number">3</span>    is <span class="hljs-type">Result</span>.Error <span class="hljs-punctuation">-&gt;</span> <span class="hljs-string">"失败"</span>
<span class="hljs-number">4</span>    <span class="hljs-comment">// ❌ 缺少 Loading 分支！</span>
<span class="hljs-number">5</span>}
</code></pre>
<p>👉 <strong>编译器会报错</strong>：</p>
<pre><code class="hljs language-csharp" lang="csharp">Text
编辑
<span class="hljs-number">1'</span><span class="hljs-keyword">when</span><span class="hljs-string">' expression must be exhaustive, add necessary '</span>Result.Loading<span class="hljs-string">' branch or '</span><span class="hljs-keyword">else</span><span class="hljs-string">' branch instead
</span></code></pre>
<blockquote>
<p>💡 这就是<strong>穷尽性检查</strong>：编译器知道 <code>Result</code> 只有这三种子类型，并强制你处理全部。</p>
</blockquote>
<hr/>
<h2 data-id="heading-5">🛑 如果加了 <code>else</code> 会怎样？</h2>
<pre><code class="hljs language-rust" lang="rust">Kotlin
编辑
<span class="hljs-number">1</span>fun <span class="hljs-title function_ invoke__">handle</span>(result: <span class="hljs-type">Result</span>): <span class="hljs-type">String</span> = <span class="hljs-title function_ invoke__">when</span> (result) {
<span class="hljs-number">2</span>    is <span class="hljs-type">Result</span>.Success <span class="hljs-punctuation">-&gt;</span> <span class="hljs-string">"成功"</span>
<span class="hljs-number">3</span>    <span class="hljs-keyword">else</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-string">"其他情况"</span>
<span class="hljs-number">4</span>}
</code></pre>
<p>✅ 这样也能编译通过，因为 <code>else</code> 被视为“兜底”。</p>
<p>但<strong>失去了类型安全的优势</strong>！</p>
<ul>
<li>如果以后新增一个子类（比如 <code>Retry</code>），你的 <code>else</code> 会默默吞掉它，可能引发逻辑 bug。</li>
<li>而如果不写 <code>else</code>，新增子类后<strong>所有未更新的 <code>when</code> 都会编译失败</strong>，迫使你显式处理新情况。</li>
</ul>
<blockquote>
<p>✅ <strong>最佳实践：尽量不写 <code>else</code>，让编译器帮你检查完整性。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-6">📌 穷尽性检查的前提条件</h2>
<ol>
<li>
<p><strong><code>when</code> 作为表达式使用</strong>（即有返回值或赋值给变量）</p>
<pre><code class="hljs language-csharp" lang="csharp">Kotlin
编辑
<span class="hljs-number">1</span>val message = <span class="hljs-keyword">when</span> (result) { ... } <span class="hljs-comment">// ✅ 会触发穷尽性检查</span>
</code></pre>
<p>如果只是语句（无返回值），且所有分支都有 <code>return</code>/<code>throw</code>，也会检查；否则可能不检查。</p>
</li>
<li>
<p><strong>类型必须是密封类或其子类型</strong><br/>
普通类、接口、开放类（<code>open class</code>）<strong>不会触发</strong>穷尽性检查。</p>
</li>
<li>
<p><strong>所有直接子类必须在编译期可知</strong><br/>
密封类的子类必须在同一文件（或同一模块内），这样编译器才能“看到全部可能性”。</p>
</li>
</ol>
<hr/>
<h2 data-id="heading-7">🎯 实际价值：重构安全 + 逻辑可靠</h2>
<p>假设你后期给 <code>Result</code> 新增一个状态：</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin">
编辑
1sealed <span class="hljs-keyword">class</span> <span class="hljs-title class_">Result</span> {
<span class="hljs-number">2</span>    <span class="hljs-comment">// ... 原有</span>
<span class="hljs-number">3</span>    <span class="hljs-keyword">object</span> Retry : Result() <span class="hljs-comment">// 新增</span>
<span class="hljs-number">4</span>}
</code></pre>
<p>那么<strong>所有使用 <code>when (result)</code> 的地方都会编译失败</strong>，除非你显式处理 <code>Retry</code>。<br/>
这让你在<strong>扩展功能时不会遗漏任何调用点</strong>，极大提升代码健壮性。</p>
<hr/>
<h2 data-id="heading-8">✅ 总结：穷尽性检查的核心意义</h2>






























<table><thead><tr><th>特性</th><th>普通类/接口</th><th>密封类</th></tr></thead><tbody><tr><td>子类型数量</td><td>开放（可无限扩展）</td><td>封闭（编译期已知）</td></tr><tr><td><code>when</code> 是否强制覆盖所有子类</td><td>❌ 否</td><td>✅ 是（作为表达式时）</td></tr><tr><td>新增子类是否影响现有代码</td><td>❌ 不会报错（可能出 bug）</td><td>✅ 编译失败（强制修复）</td></tr><tr><td>适合场景</td><td>开放扩展</td><td>封闭状态机、结果封装等</td></tr></tbody></table>
<blockquote>
<p>🔑 <strong>密封类 + <code>when</code> 表达式 = 编译期保证逻辑完整性</strong></p>
</blockquote>
<p>这就是为什么 Kotlin 官方推荐：<strong>当你有一组固定的、相关的类型时，优先使用密封类而不是普通继承</strong>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[open-AutoGLM部署]]></title>    <link>https://juejin.cn/post/7582502441993863211</link>    <guid>https://juejin.cn/post/7582502441993863211</guid>    <pubDate>2025-12-12T06:19:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582502441993863211" data-draft-id="7582808491582799908" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="open-AutoGLM部署"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2025-12-12T06:19:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员Soldier"/> <meta itemprop="url" content="https://juejin.cn/user/935056027688039"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            open-AutoGLM部署
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/935056027688039/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员Soldier
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T06:19:56.000Z" title="Fri Dec 12 2025 06:19:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>AutoGLM-Phone</strong> 是智谱 AI 推出的端侧智能体模型，具备通过自然语言指令直接操作手机 GUI（图形用户界面）的能力。它可以模拟人类操作，自动执行如“点外卖”、“查价格”、“发朋友圈”等跨应用任务。</p>
<p>本指南将带你完成从 <strong>算力</strong> <strong>云服务器</strong> <strong>搭建</strong>、<strong>Docker 环境配置</strong>、<strong>vLLM 模型加速部署</strong> 到 <strong>本地</strong> <strong>ADB</strong> <strong>联调</strong> 的全流程。通过本教程，你将构建一套属于自己的 AI 手机操作助手。</p>
<p>open-AutoGLM GitHub地址 ：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fzai-org%2FOpen-AutoGLM" target="_blank" title="https://github.com/zai-org/Open-AutoGLM" ref="nofollow noopener noreferrer">github.com/zai-org/Ope…</a></p>
<p>视频教程：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1dWmjBoEom%3Fvd_source%3Ddb21a1f1ccfda362b15d4e02eb5dcc0a" target="_blank" title="https://www.bilibili.com/video/BV1dWmjBoEom?vd_source=db21a1f1ccfda362b15d4e02eb5dcc0a" ref="nofollow noopener noreferrer">www.bilibili.com/video/BV1dW…</a></p>
<h2 data-id="heading-0">一、注册算力云服务器账号</h2>
<h3 data-id="heading-1">1.注册</h3>
<p><strong>注册账号</strong>：访问下方链接注册，可获取专属算力优惠券：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgpu.ai-galaxy.cn%2Flogin%3Fpage%3Dregister%26salesCode%3D59FEA3" target="_blank" title="https://gpu.ai-galaxy.cn/login?page=register&amp;salesCode=59FEA3" ref="nofollow noopener noreferrer">注册链接（含优惠券）</a></li>
</ul>
<h3 data-id="heading-2">2.选购</h3>
<h4 data-id="heading-3">2.1 显卡选择</h4>
<p>建议选择显存 <strong>40G</strong> 左右的显卡（如 A40, A100-40G, 或 4090），以确保模型加载和推理的稳定性。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d24d4865ed46494b9f3ea058348c463e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYU29sZGllcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766125756&amp;x-signature=rj8gw%2FW3OwbA7Sj2xwOQ9Ila7r0%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-4">2.2 计费模式</h4>
<p>推荐选择“按小时租用”，灵活划算。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e02ba7d92f434e05899c049b83f33285~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYU29sZGllcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766125756&amp;x-signature=2of%2BbcpFHF59dhFk7A%2FO1npE3xU%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-5">2.3 带宽配置</h4>
<ul>
<li>强烈建议将带宽<strong>拉满</strong>（最大值）。</li>
<li><em>原因</em>：模型文件和 Docker 镜像体积巨大，低带宽会导致下载耗时极长。</li>
<li><em>注意</em>：部分区域带宽速率一天仅允许修改一次，请谨慎操作。</li>
<li>预算有限也可选择 32Mbps（免费）下载速率在4M。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac3e07f4bcf5410d88d57d89b8549993~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYU29sZGllcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766125756&amp;x-signature=V8OHMEdIgqHecORtUOquD9wMQp8%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-6">2.4 镜像选择</h4>
<p>直接选择ubuntu22.04系统</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/778acbdce26443fb8facfee752139d5f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYU29sZGllcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766125756&amp;x-signature=3R9wt20kjcCPTYMSaHO6dXtvdrs%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-7">2.5 端口映射</h4>
<p>创建实例后，请务必查看控制台提供的<strong>外网</strong> <strong>端口</strong>与<strong>容器内端口</strong>的对应关系。后续启动服务时，需根据此映射关系设置 <code>-p</code> 参数。</p>
<h2 data-id="heading-8">二、服务器环境配置 (Docker)</h2>
<p>连接上服务器（SSH）后，首先需要配置 Docker 环境。</p>
<p>官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.docker.com%2Fengine%2Finstall%2Fubuntu%2F" target="_blank" title="https://docs.docker.com/engine/install/ubuntu/" ref="nofollow noopener noreferrer">docs.docker.com/engine/inst…</a></p>
<h3 data-id="heading-9">1. 清理旧版本</h3>
<p>如果系统自带了旧版 Docker，建议先卸载以避免冲突：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">for</span> pkg in docker.io docker-doc docker-compose docker-compose-v2 podman-docker containerd runc; <span class="hljs-keyword">do</span> sudo apt-get remove $pkg; done
</code></pre>
<h3 data-id="heading-10">2. 安装 Docker Engine</h3>
<p>按照以下步骤安装最新版 Docker：</p>
<pre><code class="hljs language-bash" lang="bash">
<span class="hljs-comment"># 1. 更新索引并安装依赖</span>
<span class="hljs-comment"># Add Docker's official GPG key:</span>
sudo apt-get update
sudo apt-get install ca-certificates curl
sudo install -m 0755 -d /etc/apt/keyrings
sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
sudo <span class="hljs-built_in">chmod</span> a+r /etc/apt/keyrings/docker.asc

<span class="hljs-comment"># Add the repository to Apt sources:</span>
<span class="hljs-built_in">echo</span> \
  <span class="hljs-string">"deb [arch=<span class="hljs-subst">$(dpkg --print-architecture)</span> signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
  <span class="hljs-subst">$(. /etc/os-release &amp;&amp; echo <span class="hljs-string">"<span class="hljs-variable">$VERSION_CODENAME</span>"</span>)</span> stable"</span> | \
sudo <span class="hljs-built_in">tee</span> /etc/apt/sources.list.d/docker.list &gt; /dev/null
sudo apt-get update

<span class="hljs-comment"># 2. 安装 Docker</span>
sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

<span class="hljs-comment"># 3. 验证安装</span>
docker --version
</code></pre>
<h3 data-id="heading-11">3. 配置国内镜像加速（推荐）</h3>
<p>为了提升拉取镜像的速度，建议配置国内加速源。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 编辑配置文件</span>
sudo vim /etc/docker/daemon.json
</code></pre>
<p>在文件中按 <code>i</code> 键进入编辑模式，粘贴以下内容：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"registry-mirrors"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"https://docker.m.daocloud.io"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"https://noohub.ru"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"https://huecker.io"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"https://dockerhub.timeweb.cloud"</span>
    <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>保存退出（按 <code>Esc</code> 输入 <code>:wq</code> 回车），然后重启服务：</p>
<pre><code class="hljs language-perl" lang="perl">sudo service docker restart
<span class="hljs-comment"># 验证配置是否生效</span>
sudo docker info | <span class="hljs-keyword">grep</span> Mirrors -A <span class="hljs-number">4</span>
</code></pre>
<h2 data-id="heading-12">三、模型下载</h2>
<p>我们需要将 <strong>ZhipuAI/AutoGLM-Phone-9B</strong> 模型下载到服务器的 <code>/opt/model</code> 目录。推荐使用 ModelScope（魔搭社区）进行下载。</p>
<h3 data-id="heading-13">1. 使用 ModelScope 下载（推荐）</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 安装下载工具</span>
pip install modelscope

<span class="hljs-comment"># 2. 创建目录并下载</span>
<span class="hljs-built_in">mkdir</span> -p /opt/model
modelscope download --model <span class="hljs-string">'ZhipuAI/AutoGLM-Phone-9B'</span> --local_dir <span class="hljs-string">'/opt/model'</span>
</code></pre>
<h3 data-id="heading-14">2. 使用 Git LFS 下载</h3>
<pre><code class="hljs language-bash" lang="bash">git lfs install
<span class="hljs-built_in">cd</span> /opt/model
git <span class="hljs-built_in">clone</span> https://www.modelscope.cn/ZhipuAI/AutoGLM-Phone-9B.git
</code></pre>
<h3 data-id="heading-15">3. 使用 Python SDK 下载</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment">#模型下载</span>
from modelscope import snapshot_download
<span class="hljs-attr">model_dir</span> = snapshot_download(<span class="hljs-string">'ZhipuAI/AutoGLM-Phone-9B'</span>)
</code></pre>
<h2 data-id="heading-16">四、部署 vLLM 推理服务</h2>
<p>我们将使用 <code>vLLM</code> 框架来加速模型的推理。</p>
<h3 data-id="heading-17">1. 准备 NVIDIA Container Toolkit</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 检查宿主机驱动（应显示显卡信息表）</span>
<span class="hljs-comment">#报错或找不到命令：说明你宿主机还没装显卡驱动，请先安装 NVIDIA 驱动。可根据教程自行下载。https://blog.csdn.net/a772304419/article/details/146601092</span>
nvidia-smi 


<span class="hljs-comment"># 2. 配置 NVIDIA 容器库</span>
curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | sudo gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg \
&amp;&amp; curl -s -L https://nvidia.github.io/libnvidia-container/stable/deb/nvidia-container-toolkit.list | \
  sed <span class="hljs-string">'s#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g'</span> | \
  sudo <span class="hljs-built_in">tee</span> /etc/apt/sources.list.d/nvidia-container-toolkit.list

<span class="hljs-comment"># 3. 安装工具包并配置 Docker</span>
sudo apt-get update
sudo apt-get install -y nvidia-container-toolkit
<span class="hljs-comment"># 4. 生成配置文件</span>
sudo nvidia-ctk runtime configure --runtime=docker
<span class="hljs-comment"># 5. 重启</span>
sudo systemctl restart docker
</code></pre>
<h3 data-id="heading-18">2. 启动vLLM 容器</h3>
<p>下载并运行 vLLM 镜像，将模型路径映射到容器内部。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 拉取镜像</span>
docker pull vllm/vllm-openai:v0.12.0

<span class="hljs-comment"># 启动容器</span>
<span class="hljs-comment"># 注意：-p 8800:8000 表示将宿主机的8800端口映射到容器的8000端口</span>
<span class="hljs-comment"># 请根据你在“第一部分”中查看的实际外网端口情况修改 8800</span>
docker run -it \
 --entrypoint /bin/bash \
 --gpus all \
 -p 8800:8000 \
 --ipc=host \
 -v /opt/model:/app/model \
 --name autoglm \
 vllm/vllm-openai:v0.12.0
</code></pre>
<h3 data-id="heading-19">3. 在容器内启动服务</h3>
<p>进入容器终端后，执行以下命令：</p>
<pre><code class="hljs language-css" lang="css"># <span class="hljs-number">1</span>. 安装依赖 (忽略冲突警告)
pip install -U transformers <span class="hljs-attr">--pre</span> 

# <span class="hljs-number">2</span>. 启动 API Server (严格复制以下命令)
python3 -m vllm<span class="hljs-selector-class">.entrypoints</span><span class="hljs-selector-class">.openai</span><span class="hljs-selector-class">.api_server</span> \
 <span class="hljs-attr">--served-model-name</span> autoglm-phone-<span class="hljs-number">9</span>b \
 <span class="hljs-attr">--allowed-local-media-path</span> /   \
 <span class="hljs-attr">--mm-encoder-tp-mode</span> data \
 <span class="hljs-attr">--mm_processor_cache_type</span> shm \
 <span class="hljs-attr">--mm_processor_kwargs</span> "{"max_pixels":<span class="hljs-number">5000000</span>}" \
 <span class="hljs-attr">--max-model-len</span> <span class="hljs-number">25480</span>  \
 <span class="hljs-attr">--chat-template-content-format</span> string \
 <span class="hljs-attr">--limit-mm-per-prompt</span> "{"image":<span class="hljs-number">10</span>}" \
 <span class="hljs-attr">--model</span> /app/model \
 <span class="hljs-attr">--port</span> <span class="hljs-number">8000</span>
</code></pre>
<p>注：<code>--model</code> 参数需指向容器内挂载的路径 <code>/app/model</code> 或者具体的子文件夹名。</p>
<h3 data-id="heading-20">4. 验证服务</h3>
<p>模型服务启动后，可以使用检查脚本验证部署是否成功：</p>
<pre><code class="hljs language-bash" lang="bash">python scripts/check_deployment_cn.py --base-url http://你的IP:你的端口/v1 --model 模型名称
</code></pre>
<p>脚本将发送测试请求并展示模型的推理结果，你可以根据输出判断模型部署是否正常工作。</p>
<p>基于给定的任务, 预期输出如下。如果思维链长度很短, 或者出现了乱码, 很可能是模型部署失败, 请仔细检查文档要求的配置和依赖。</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">think</span>&gt;</span></span>用户想要比较这个洗发水在京东和淘宝上的价格，然后选择最便宜的平台下单。当前在小红书app上，显示的是一个关于LUMMI MOOD洗发水的帖子。

我需要：
<span class="hljs-bullet">1.</span> 先启动京东app，搜索这个洗发水
<span class="hljs-bullet">2.</span> 查看京东的价格
<span class="hljs-bullet">3.</span> 再启动淘宝app，搜索这个洗发水
<span class="hljs-bullet">4.</span> 查看淘宝的价格
<span class="hljs-bullet">5.</span> 比较价格后，选择最便宜的京东或淘宝下单

首先，我需要从当前的小红书界面退出，然后启动京东app。<span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">think</span>&gt;</span></span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">answer</span>&gt;</span></span>do(action="Launch", app="京东")
</code></pre>
<p>参数说明：</p>
<ul>
<li><code>--base-url</code>: 模型服务地址（根据实际部署地址修改）</li>
<li><code>--model</code>: 模型名称</li>
<li><code>--messages-file</code>: 可选，指定自定义测试消息文件（默认使用 <code>scripts/sample_messages.json</code>）</li>
</ul>
<h2 data-id="heading-21">五、客户端与真机连接 (本地电脑)</h2>
<p>服务端准备就绪后，我们需要在本地电脑配置控制端，通过 ADB 控制安卓手机，并调用云端的 AI 模型。</p>
<ol>
<li>
<h3 data-id="heading-22">硬件与环境准备</h3>
</li>
</ol>
<ul>
<li>
<p><strong>操作系统</strong>：Windows / macOS</p>
</li>
<li>
<p><strong>Python</strong>：建议 Python 3.10+</p>
</li>
<li>
<p><strong>安卓设备</strong>：Android 7.0+ 手机或模拟器。</p>
</li>
<li>
<p><strong>ADB</strong> <strong>工具</strong>：</p>
<ul>
<li>
<p>下载地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Ftools%2Freleases%2Fplatform-tools%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/tools/releases/platform-tools?hl=zh-cn" ref="nofollow noopener noreferrer">Android Platform Tools</a></p>
</li>
<li>
<p><strong>配置</strong> <strong>环境变量</strong>（以 Windows 为例）：<a href="https://link.juejin.cn?target=https%3A%2F%2Fai.feishu.cn%2Fwiki%2FGSBEwwnu5izWZ6kTC9tcznJNnwg%3Ffrom%3Dfrom_copylink" target="_blank" title="https://ai.feishu.cn/wiki/GSBEwwnu5izWZ6kTC9tcznJNnwg?from=from_copylink" ref="nofollow noopener noreferrer">点击查看教程</a></p>
<ul>
<li>解压下载的包。</li>
<li><code>Win + R</code> 输入 <code>sysdm.cpl</code> -&gt; 高级 -&gt; 环境变量。</li>
<li>在 <code>System Path</code> 中添加 ADB 解压路径。</li>
<li>命令行输入 <code>adb version</code> 验证。</li>
</ul>
</li>
<li>
<p><strong>MacOS</strong> <strong>配置方法</strong>：在 <code>Terminal</code> 或者任何命令行工具里</p>
</li>
</ul>
</li>
</ul>

<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-comment"># 假设解压后的目录为 ~/Downlaods/platform-tools。如果不是请自行调整命令。</span>
export <span class="hljs-variable constant_">PATH</span>=<span class="hljs-variable">${</span><span class="hljs-variable constant_">PATH</span>}<span class="hljs-symbol">:~/Downloads/platform-tools</span>
</code></pre>
<p>2.  ## 手机端设置</p>

<ol>
<li>
<p><strong>开启开发者模式</strong>：设置 -&gt; 关于手机 -&gt; 连续点击“版本号”直至提示已开启。</p>
</li>
<li>
<p><strong>开启</strong> <strong>USB</strong> <strong>调试</strong>：设置 -&gt; 开发者选项 -&gt; 勾选“USB 调试”。</p>
</li>
<li>
<p><strong>安装</strong> <strong>ADB</strong> <strong>Keyboard</strong>：</p>
<ol>
<li>下载并安装<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsenzhk%2FADBKeyBoard%2Fblob%2Fmaster%2FADBKeyboard.apk" target="_blank" title="https://github.com/senzhk/ADBKeyBoard/blob/master/ADBKeyboard.apk" ref="nofollow noopener noreferrer"> ADB Keyboard apk</a>。</li>
<li>在手机“语言与输入法”设置中，将默认输入法切换为 ADB Keyboard。</li>
</ol>
</li>
</ol>

<ol start="3">
<li>
<h3 data-id="heading-23">部署控制端代码 (Open-AutoGLM)</h3>
</li>
</ol>
<p>在本地电脑上下载控制代码：</p>
<pre><code class="hljs language-bash" lang="bash">
<span class="hljs-comment"># 1. 克隆仓库</span>
git <span class="hljs-built_in">clone</span> https://github.com/zai-org/Open-AutoGLM
<span class="hljs-built_in">cd</span> Open-AutoGLM

<span class="hljs-comment"># 2. 安装依赖</span>
pip install -r requirements.txt 
pip install -e .
</code></pre>
<ol start="4">
<li>
<h3 data-id="heading-24">连接设备</h3>
</li>
</ol>
<p>确保手机通过 USB 连接电脑，或处于同一 WiFi 下。</p>
<ul>
<li><strong>USB</strong> <strong>方式</strong>：</li>
</ul>

<pre><code class="hljs language-bash" lang="bash">adb devices
<span class="hljs-comment"># 输出应包含 device ID</span>
</code></pre>
<ul>
<li><strong>WiFi 远程方式：</strong></li>
</ul>

<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># 需先用 USB 连接开启 tcpip</span>
adb tcpip <span class="hljs-number">5555</span>
<span class="hljs-comment"># 断开 USB，连接手机 IP</span>
adb <span class="hljs-keyword">connect</span> <span class="hljs-number">192.168</span>.x.x:<span class="hljs-number">5555</span>
</code></pre>
<h2 data-id="heading-25">六、启动 AI 代理</h2>
<p>一切准备就绪，现在让 AI 接管手机。</p>
<ol>
<li>
<h3 data-id="heading-26">命令行运行</h3>
</li>
</ol>
<p>在本地 <code>Open-AutoGLM</code> 目录下运行：</p>
<pre><code class="hljs language-csharp" lang="csharp">python main.py \
  --device-id &lt;你的设备ID或IP:<span class="hljs-number">5555</span>&gt; \
  --<span class="hljs-keyword">base</span>-url http:<span class="hljs-comment">//&lt;云服务器IP&gt;:&lt;映射端口&gt;/v1 \</span>
  --model <span class="hljs-string">"autoglm-phone-9b"</span> \
  <span class="hljs-string">"打开抖音搜索抖音号为：dycwo11nt61d 的博主并关注他！"</span>
</code></pre>
<ul>
<li><strong>--device-id</strong>: 通过 <code>adb devices</code> 获取的 ID。</li>
<li><strong>--base-url</strong>: 替换为你云服务器的公网 IP 和映射出的端口（例如 8800）。</li>
<li><strong>最后的字符串</strong>: 就是你给 AI 下达的自然语言指令。</li>
</ul>
<ol start="2">
<li>
<h3 data-id="heading-27">python API 远程连接</h3>
</li>
</ol>

<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> phone_agent.adb <span class="hljs-keyword">import</span> ADBConnection, list_devices

<span class="hljs-comment"># 创建连接管理器</span>
conn = ADBConnection()

<span class="hljs-comment"># 连接远程设备</span>
success, message = conn.connect(<span class="hljs-string">"192.168.1.100:5555"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"连接状态: <span class="hljs-subst">{message}</span>"</span>)

<span class="hljs-comment"># 列出已连接设备</span>
devices = list_devices()
<span class="hljs-keyword">for</span> device <span class="hljs-keyword">in</span> devices:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{device.device_id}</span> - <span class="hljs-subst">{device.connection_type.value}</span>"</span>)

<span class="hljs-comment"># 在 USB 设备上启用 TCP/IP</span>
success, message = conn.enable_tcpip(<span class="hljs-number">5555</span>)
ip = conn.get_device_ip()
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"设备 IP: <span class="hljs-subst">{ip}</span>"</span>)

<span class="hljs-comment"># 断开连接</span>
conn.disconnect(<span class="hljs-string">"192.168.1.100:5555"</span>)
</code></pre>
<p>3.  ## 常见问题排查</p>
<ul>
<li><strong>连接被拒绝</strong>：检查云服务器防火墙是否放行了对应端口。</li>
<li><strong>ADB</strong> <strong>掉线</strong>：WiFi 连接不稳定，尝试使用 USB 线连接。</li>
<li><strong>模型乱码/无响应</strong>：检查 vLLM 启动参数是否完全一致，尤其是显存和 max-model-len 设置。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[终于还是吃上了react-i18next的细糠]]></title>    <link>https://juejin.cn/post/7582533464245305378</link>    <guid>https://juejin.cn/post/7582533464245305378</guid>    <pubDate>2025-12-12T07:09:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582533464245305378" data-draft-id="7574045294612037667" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="终于还是吃上了react-i18next的细糠"/> <meta itemprop="keywords" content="前端,前端框架"/> <meta itemprop="datePublished" content="2025-12-12T07:09:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿呜的边城"/> <meta itemprop="url" content="https://juejin.cn/user/2620868693599405"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            终于还是吃上了react-i18next的细糠
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2620868693599405/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿呜的边城
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T07:09:37.000Z" title="Fri Dec 12 2025 07:09:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>除了经常访问我网站的朋友，几乎就没人知道，我其实一直在做 ElasticSearch 文档的中文翻译，虽然不知道到底能帮助多少人，但既然已经坚持四年了，从 7.11 版本翻译到现在 9.x 版本，我就准备继续坚持下去。</p>
<p>在文档翻译过程中，我最开始的做法，是复制内容到百度翻译一类的网站上进行翻译，然后自己校对，调整格式，保存文档，发布到网站上。</p>
<p>后来，我找到一款比较好用的翻译工具 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpot-app%2Fpot-desktop" target="_blank" title="https://github.com/pot-app/pot-desktop" ref="nofollow noopener noreferrer"><code>pot</code></a>。这款工具很好用，适当减轻了一些工作量，但也只是让我不用去翻译网站上操作。</p>
<p>我翻译文档最大困难，在于翻译过程中，不能保留原网页的格式，我只能一段段翻译，再自己整理为 Markdown 格式，非常浪费时间。</p>
<p>在之前的文章<a href="https://juejin.cn/post/7456898384352477210" target="_blank" title="https://juejin.cn/post/7456898384352477210">《一种Tauri+NextJS国际化方案》</a>中，我提到我们在开发一款 AI 应用。虽然它胎死腹中，但还是多少给互联网留下了一些电子垃圾。🤣</p>
<p>在文章中我还提到，我自己吃不来 <code>react-i18next</code> 的细糠，所以只能先撸了一个国际化方案来应急解决国际化问题。</p>
<p>我就想复用之前的开发经验，开发一款可以直接将网页翻译为指定 Markdown 格式文档的 AI 工具，这样我复制出翻译结果，就能直接保存为 <code>Docusaurus</code> 能解析的文档，效率倍增!</p>
<p>这次开发同样采用了 <code>Tauri</code> + <code>Next.JS</code> 架构，国际化也先复用了之前的文章中的经验。但应用初步开发出来后，我发现切换页面时，页面会出现闪动，会闪现未翻译的原始 key，非常难看。</p>
<p><code>AI help AI！</code></p>
<p>于是，我再次寻求 AI 帮助。可能得益于 AI 模型的升级，这次 DeepSeek 在“调教”下给出了一个基于 <code>next-i18next</code> 的可用方案，真是让我等对前端不熟悉的人觉得香死了。以下记录方案实施方法。</p>
<h2 data-id="heading-1">解决方案</h2>
<h3 data-id="heading-2">1. 目标</h3>
<ul>
<li><code>Tauri</code> 应用中前端页面实现国际化切换功能</li>
</ul>
<h3 data-id="heading-3">2. 场景</h3>
<ul>
<li>纯客户端的场景（<code>Tauri</code> 中无法使用 <code>Nextjs</code> 的 <code>SSR</code>）。</li>
<li><code>Nextjs</code>（<code>AppRouter</code> 模式）</li>
</ul>
<p>已基于 <code>Tauri</code> 和 <code>Nextjs</code> 开发了可运行的应用。</p>
<h3 data-id="heading-4">3. 安装依赖</h3>
<pre><code class="hljs language-bash" lang="bash">npm install i18next react-i18next i18next-browser-languagedetector
</code></pre>
<h3 data-id="heading-5">4. 目录结构示例</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ead5bae8f3734f6792d9ee17ccf4a40a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5ZGc55qE6L655Z-O:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766128176&amp;x-signature=LLsZscQGz8Kh93AG3zIlDYqxlGk%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li><code>i18n.ts</code> 国际化配置文件</li>
<li><code>locales</code> 国际化翻译 json 文件</li>
<li><code>layout.tsx</code> 动态加载 i18n 对象</li>
</ul>
<h3 data-id="heading-6">5. 关键文件示例</h3>
<h4 data-id="heading-7">i18n.ts</h4>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> i18n <span class="hljs-keyword">from</span> <span class="hljs-string">"i18next"</span>;
<span class="hljs-keyword">import</span> { initReactI18next } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-i18next"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">LanguageDetector</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"i18next-browser-languagedetector"</span>;

<span class="hljs-keyword">import</span> en <span class="hljs-keyword">from</span> <span class="hljs-string">"../../locales/en.json"</span>;
<span class="hljs-keyword">import</span> zh <span class="hljs-keyword">from</span> <span class="hljs-string">"../../locales/zh.json"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">TauriAdapter</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"../utils/utils"</span>;

<span class="hljs-keyword">const</span> adapter = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TauriAdapter</span>();

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">initI18n</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 从配置文件读取语言设置</span>
  <span class="hljs-keyword">const</span> config = <span class="hljs-keyword">await</span> adapter.<span class="hljs-title function_">readAppData</span>();
  <span class="hljs-keyword">const</span> locale = config.<span class="hljs-property">locale</span> || <span class="hljs-string">"zh"</span>;

  i18n
    .<span class="hljs-title function_">use</span>(<span class="hljs-title class_">LanguageDetector</span>)
    .<span class="hljs-title function_">use</span>(initReactI18next)
    .<span class="hljs-title function_">init</span>({
      <span class="hljs-attr">resources</span>: {
        <span class="hljs-attr">en</span>: { <span class="hljs-attr">translation</span>: en },
        <span class="hljs-attr">zh</span>: { <span class="hljs-attr">translation</span>: zh },
      },
      <span class="hljs-attr">lng</span>: locale,
      <span class="hljs-attr">fallbackLng</span>: <span class="hljs-string">"zh"</span>,
      <span class="hljs-attr">interpolation</span>: {
        <span class="hljs-attr">escapeValue</span>: <span class="hljs-literal">false</span>,
      },
    });

  <span class="hljs-keyword">return</span> i18n;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> i18n;
</code></pre>
<p><code>const config = await adapter.readAppData();</code> 是我自己实现的从配置文件读取当前语言的方法，如果你是其他方式读取语言，需要换成你自己的实现。</p>
<p>同时在以上配置项 <code>resources</code> 里需要把支持的语言都列出。</p>
<h4 data-id="heading-8">zh.json</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"locales"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"zh"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"中文"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"en"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"English"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>json 格式的翻译文字。</p>
<h4 data-id="heading-9">layout.tsx</h4>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-string">"use client"</span>;
<span class="hljs-keyword">import</span> { useEffect, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> { I18nextProvider } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-i18next"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"./globals.css"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"./lib/i18n"</span>; <span class="hljs-comment">// 导入 i18n 配置</span>
<span class="hljs-keyword">import</span> { initI18n } <span class="hljs-keyword">from</span> <span class="hljs-string">"./lib/i18n"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">RootLayout</span>(<span class="hljs-params">{
  children,
}: Readonly&lt;{
  children: React.ReactNode;
}&gt;</span>) {
  <span class="hljs-keyword">const</span> [i18nInstance, setI18nInstance] = useState&lt;<span class="hljs-built_in">any</span>&gt;(<span class="hljs-literal">null</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">initializeApp</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> i18n = <span class="hljs-keyword">await</span> <span class="hljs-title function_">initI18n</span>();
        <span class="hljs-title function_">setI18nInstance</span>(i18n);
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"Failed to initialize i18n:"</span>, error);
      }
    };

    <span class="hljs-title function_">initializeApp</span>();
  }, []);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">body</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">antialiased</span>`}&gt;</span>
        {i18nInstance ? (
          <span class="hljs-tag">&lt;<span class="hljs-name">I18nextProvider</span> <span class="hljs-attr">i18n</span>=<span class="hljs-string">{i18nInstance}</span>&gt;</span>
            {children}
          <span class="hljs-tag">&lt;/<span class="hljs-name">I18nextProvider</span>&gt;</span>
        ) : (
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
            <span class="hljs-attr">data-tauri-drag-region</span>
            <span class="hljs-attr">className</span>=<span class="hljs-string">"flex flex-col justify-center items-center h-screen"</span>
          &gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"loading loading-dots loading-xl text-primary h-[156px]"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        )}
      <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></span>
  );
}
</code></pre>
<p>在 <code>layout.tsx</code> 中使用国际化的 Provider，并动态加载 i18n 对象。</p>
<h4 data-id="heading-10">在文件中使用</h4>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">const</span> { t } = <span class="hljs-title function_">useTranslation</span>();
....

&lt;h1 className=<span class="hljs-string">"text-[clamp(2rem,5vw,3rem)] font-bold text-gray-800 mb-4 text-center"</span>&gt;
            {<span class="hljs-title function_">t</span>(<span class="hljs-string">"app_name"</span>)}
&lt;/h1&gt;
</code></pre>
<h4 data-id="heading-11">语言切换</h4>
<p>在我们自己实现的语言切换选择器中，当选中新语言后，使用以下逻辑进行语言变更：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">const</span> { i18n, t } = <span class="hljs-title function_">useTranslation</span>();
......
i18n.<span class="hljs-title function_">changeLanguage</span>(newLang);
</code></pre>
<p>而语言变更后的国际化，就需要自己处理了。比如在 Tauri 中，目前我是将语言存储在配置文件中。</p>
<h3 data-id="heading-12">6.扩展</h3>
<p>在以上实现中，我们知道页面上的国际化其实是依赖于全局 <code>layout.tsx</code> 中的国际化 Provider 支持的。但比如在 Tauri 中，还存在独立页面，比如独立的系统托盘菜单。</p>
<p>这种页面是没法依赖 <code>Provider</code> 来使用 <code>t("app_name")</code> 来实现国际化的，但可以通过引入 <code>i18n</code> 对象来实现。如下：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> i18n <span class="hljs-keyword">from</span> <span class="hljs-string">"./lib/i18n"</span>;
......
i18n.<span class="hljs-title function_">t</span>(<span class="hljs-string">"translation.clipboard.conflict"</span>)
</code></pre>
<h2 data-id="heading-13">小记</h2>
<p>作为非专业的前端，在 AI 帮助下解决了国际化的问题，我觉得值得记下此方案，以备日后复用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring AI Alibaba + Crawl4ai + Docker 搭建一个具有联网搜索能力的Agent]]></title>    <link>https://juejin.cn/post/7582599972950179867</link>    <guid>https://juejin.cn/post/7582599972950179867</guid>    <pubDate>2025-12-12T06:47:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582599972950179867" data-draft-id="7582528397865369627" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring AI Alibaba + Crawl4ai + Docker 搭建一个具有联网搜索能力的Agent"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-12T06:47:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="左Python右Java从从容容游刃有余"/> <meta itemprop="url" content="https://juejin.cn/user/4107431173952525"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring AI Alibaba + Crawl4ai + Docker 搭建一个具有联网搜索能力的Agent
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4107431173952525/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    左Python右Java从从容容游刃有余
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T06:47:38.000Z" title="Fri Dec 12 2025 06:47:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    30
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Spring AI Alibaba + Crawl4ai + Docker 搭建一个具有联网搜索能力的Agent</h2>
<h3 data-id="heading-1">前置要求</h3>
<p>1、本地启动ollma</p>
<p>2、docker 拉取 unclecode/crawl4ai:0.7.7 并启动</p>
<p>docker pull unclecode/crawl4ai:0.7.7</p>
<pre><code class="hljs language-bash" lang="bash">
<span class="hljs-comment">## 1、拉取镜像</span>
docker pull swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/unclecode/crawl4ai:0.7.7

<span class="hljs-comment">## 2、镜像打tag</span>
docker tag  swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/unclecode/crawl4ai:0.7.7  docker.io/unclecode/crawl4ai:0.7.7

<span class="hljs-comment">## 3、启动服务crawl4ai</span>
docker run -d \
 -p 11235:11235 \
 --name crawl4ai \
 --shm-size=3g \
 unclecode/crawl4ai:0.7.7

</code></pre>
<h3 data-id="heading-2">1、maven 依赖</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0"</span>
         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>oak-spring-ai-alibaba-crawl4ai<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>


    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.source</span>&gt;</span>17<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.source</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.target</span>&gt;</span>17<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.target</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">graalvm.polyglot.version</span>&gt;</span>24.2.1<span class="hljs-tag">&lt;/<span class="hljs-name">graalvm.polyglot.version</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">spring.ai.version</span>&gt;</span>1.1.0-M4<span class="hljs-tag">&lt;/<span class="hljs-name">spring.ai.version</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">spring.boot.version</span>&gt;</span>3.4.3<span class="hljs-tag">&lt;/<span class="hljs-name">spring.boot.version</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">spring.ai.alibaba.version</span>&gt;</span>1.1.0.0-M5.1<span class="hljs-tag">&lt;/<span class="hljs-name">spring.ai.alibaba.version</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">hutool.version</span>&gt;</span>5.8.20<span class="hljs-tag">&lt;/<span class="hljs-name">hutool.version</span>&gt;</span>

    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>


    <span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-bom<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1.0-M4<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.4.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-alibaba-bom<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1.0.0-M5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span>


    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-alibaba-agent-framework<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-starter-model-ollama<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-alibaba-studio<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">exclusions</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">exclusion</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-alibaba-dashscope<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">exclusion</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">exclusions</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>cn.hutool<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hutool-all<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${hutool.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>


    <span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.4.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">executions</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">execution</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">goals</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">goal</span>&gt;</span>repackage<span class="hljs-tag">&lt;/<span class="hljs-name">goal</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">goals</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">execution</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">executions</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.11.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">source</span>&gt;</span>17<span class="hljs-tag">&lt;/<span class="hljs-name">source</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">target</span>&gt;</span>17<span class="hljs-tag">&lt;/<span class="hljs-name">target</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">repositories</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">repository</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>spring-milestones<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>Spring Milestones<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>https://repo.spring.io/milestone<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">snapshots</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">enabled</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">enabled</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">snapshots</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">repository</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">repository</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>spring-snapshots<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>https://repo.spring.io/snapshot<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">snapshots</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">enabled</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">enabled</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">snapshots</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">repository</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">repository</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>central-portal-snapshots<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>Central Portal Snapshots<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>https://central.sonatype.com/repository/maven-snapshots/<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">releases</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">enabled</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">enabled</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">releases</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">snapshots</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">enabled</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">enabled</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">snapshots</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">repository</span>&gt;</span>

    <span class="hljs-tag">&lt;/<span class="hljs-name">repositories</span>&gt;</span>


<span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span>

</code></pre>
<h3 data-id="heading-3">2、主要代码</h3>
<p>Crawl4aiApiImpl 调用 Docker 本地 启动crawl4ai服务提供md接口</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.service.impl;

<span class="hljs-keyword">import</span> cn.hutool.http.HttpRequest;
<span class="hljs-keyword">import</span> cn.hutool.http.HttpResponse;
<span class="hljs-keyword">import</span> cn.hutool.json.JSONUtil;
<span class="hljs-keyword">import</span> com.example.config.ConfigProperties;
<span class="hljs-keyword">import</span> com.example.http.response.CrawlTaskResponse;
<span class="hljs-keyword">import</span> com.example.service.Crawl4aiApi;
<span class="hljs-keyword">import</span> org.apache.commons.lang3.StringUtils;
<span class="hljs-keyword">import</span> org.slf4j.Logger;
<span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;
<span class="hljs-keyword">import</span> org.springframework.ai.tool.annotation.Tool;
<span class="hljs-keyword">import</span> org.springframework.ai.tool.annotation.ToolParam;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;

<span class="hljs-keyword">import</span> java.io.UnsupportedEncodingException;
<span class="hljs-keyword">import</span> java.net.URLEncoder;
<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.Map;
<span class="hljs-keyword">import</span> java.util.Objects;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Crawl4aiApiImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Crawl4aiApi</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ConfigProperties configProperties;

    <span class="hljs-keyword">private</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(Crawl4aiApiImpl.class);

    <span class="hljs-meta">@Override</span>
    <span class="hljs-meta">@Tool(description = "Get the crawl result by the given taskId")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">task</span><span class="hljs-params">(String taskId)</span> {
        logger.debug(<span class="hljs-string">"taskId: {}"</span>, taskId);
        <span class="hljs-type">HttpRequest</span> <span class="hljs-variable">httpRequest</span> <span class="hljs-operator">=</span> HttpRequest.get(configProperties.getBaseUrl() + <span class="hljs-string">"/task/"</span> + taskId)
                .bearerAuth(configProperties.getApiToken());
        <span class="hljs-type">HttpResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> httpRequest.execute();
        logger.debug(response.body());
        <span class="hljs-type">CrawlTaskResponse</span> <span class="hljs-variable">rsp</span> <span class="hljs-operator">=</span> JSONUtil.toBean(response.body(), CrawlTaskResponse.class);
        <span class="hljs-keyword">return</span> JSONUtil.toJsonStr(rsp);
    }

    <span class="hljs-comment">/**
     * 必应搜索方法
     * <span class="hljs-doctag">@param</span> q 用户输入
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-meta">@Tool(description = "Call crawl4ai API to crawl a URL")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">bingSearchToolMd</span><span class="hljs-params">(<span class="hljs-meta">@ToolParam(description = "the user input content")</span> String q )</span> {
        <span class="hljs-keyword">if</span>(StringUtils.isBlank(q)){
            <span class="hljs-keyword">return</span> <span class="hljs-string">"The parameter can not be blank, Please input the parameter q and retry call crawl_tool again."</span>;
        }
<span class="hljs-comment">//        url 编码处理</span>
        <span class="hljs-keyword">try</span> {
            q = URLEncoder.encode(q , <span class="hljs-string">"utf-8"</span>);
        } <span class="hljs-keyword">catch</span> (UnsupportedEncodingException e) {
            e.printStackTrace();
        }
        Map&lt;String, Object&gt; params= <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        params.put(<span class="hljs-string">"url"</span> , <span class="hljs-string">"https://cn.bing.com/search?q="</span> + q);
        params.put(<span class="hljs-string">"f"</span> , <span class="hljs-string">"fit"</span>);
        params.put(<span class="hljs-string">"q"</span> , <span class="hljs-literal">null</span>);
        params.put(<span class="hljs-string">"c"</span> , <span class="hljs-string">"0"</span>);
        logger.debug(JSONUtil.toJsonStr(params));

        <span class="hljs-comment">//craw4ai 提供 输出 markdown 的接口</span>
        <span class="hljs-type">HttpRequest</span> <span class="hljs-variable">httpRequest</span> <span class="hljs-operator">=</span> HttpRequest.post(configProperties.getBaseUrl() + <span class="hljs-string">"/md"</span>)
                .header(<span class="hljs-string">"Content-Type"</span> , <span class="hljs-string">"application/json"</span>)
                .bearerAuth(configProperties.getApiToken()).body(JSONUtil.toJsonStr(params));

        <span class="hljs-type">HttpResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> httpRequest.execute();
        logger.debug(response.body());
        <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> JSONUtil.toBean(response.body(), Map.class);
        <span class="hljs-comment">//输出 markdown 格式内容</span>
        <span class="hljs-type">Object</span> <span class="hljs-variable">markdown</span> <span class="hljs-operator">=</span> map.get(<span class="hljs-string">"markdown"</span>);
        <span class="hljs-keyword">return</span> Objects.isNull(markdown) ? <span class="hljs-string">""</span> : markdown.toString();
    }
}
</code></pre>
<p>ReactAgentConfig 配置一下ReactAgent</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-keyword">package</span> com.example.config;

<span class="hljs-keyword">import</span> com.alibaba.cloud.ai.graph.agent.ReactAgent;
<span class="hljs-keyword">import</span> com.alibaba.cloud.ai.graph.agent.hook.modelcalllimit.ModelCallLimitHook;
<span class="hljs-keyword">import</span> com.alibaba.cloud.ai.graph.checkpoint.savers.MemorySaver;
<span class="hljs-keyword">import</span> com.example.http.request.CrawlRequest;
<span class="hljs-keyword">import</span> com.example.tools.CrawlTool;
<span class="hljs-keyword">import</span> org.springframework.ai.chat.model.ChatModel;
<span class="hljs-keyword">import</span> org.springframework.ai.tool.ToolCallback;
<span class="hljs-keyword">import</span> org.springframework.ai.tool.function.FunctionToolCallback;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Primary;

<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReactAgentConfig</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">INSTRUCTION</span> <span class="hljs-operator">=</span> <span class="hljs-string">"""
            You are a helpful assistant named research_agent.
            You can use the crawl_tool  search content from internet for user.
            You have access to tools that can search content from Internet.
            Use these tools to assist users with their tasks.
            """</span>;


    <span class="hljs-comment">// </span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> AgentStaticLoader <span class="hljs-title function_">agentStaticLoader</span><span class="hljs-params">(ReactAgent reactAgent)</span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AgentStaticLoader</span>(reactAgent);
    }


    <span class="hljs-meta">@Bean("research_agent")</span>
    <span class="hljs-meta">@Primary</span>
    <span class="hljs-keyword">public</span> ReactAgent <span class="hljs-title function_">researchAgent</span><span class="hljs-params">(ChatModel chatModel, <span class="hljs-meta">@Qualifier("crawlToolCallback")</span> ToolCallback crawlToolCallback)</span> {

        <span class="hljs-keyword">return</span> ReactAgent.
                builder()
                .name(<span class="hljs-string">"research_agent"</span>)
                .model(chatModel)
                .instruction(
                        INSTRUCTION
                )
                .saver(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MemorySaver</span>())
                .tools(crawlToolCallback)
                .hooks(ModelCallLimitHook.builder().runLimit(<span class="hljs-number">5</span>).build())  <span class="hljs-comment">// 限制模型调用次数为5次</span>
                .build();
    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> ToolCallback <span class="hljs-title function_">crawlToolCallback</span><span class="hljs-params">(<span class="hljs-meta">@Qualifier("crawlTool")</span> CrawlTool crawlTool)</span> {
        <span class="hljs-keyword">return</span> FunctionToolCallback.builder(<span class="hljs-string">"crawl_tool"</span>, crawlTool)
                .description(
                        <span class="hljs-string">"""
                                   When you need search content from Internet for user, you can use crawl_tool.
                                    Usage:
                                    - The q parameter is a string, representative user input content.
                                    - When you use crawl_tool , the parameter just like below content:
                                     {
                                       "q":"user input content"
                                     }
                                """</span>
                )

                .inputType(CrawlRequest.class)
                .build();
    }

}
</code></pre>
<h3 data-id="heading-4">3、主要配置</h3>
<pre><code class="hljs language-yml" lang="yml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">ai:</span>
    <span class="hljs-attr">ollama:</span>
      <span class="hljs-comment"># 本地ollama 地址</span>
      <span class="hljs-attr">base-url:</span> <span class="hljs-string">http://localhost:11434</span>
      <span class="hljs-comment"># 聊天模型</span>
      <span class="hljs-attr">chat:</span>
        <span class="hljs-attr">model:</span> <span class="hljs-string">llama3.2</span>
<span class="hljs-comment"># 去掉Springboot banner</span>
  <span class="hljs-attr">main:</span>
    <span class="hljs-attr">banner-mode:</span> <span class="hljs-string">off</span>

<span class="hljs-comment"># crawl4ai Settings - update your URL and token below</span>
<span class="hljs-attr">crawl4ai:</span>
  <span class="hljs-comment"># 本地 docker 启动  crawl4ai 提供的 url</span>
  <span class="hljs-attr">base-url:</span> <span class="hljs-string">http://localhost:11235</span>
  <span class="hljs-comment"># 如果 docker 启动 crawl4ai 时有token，则配置</span>
  <span class="hljs-attr">api-token:</span>

<span class="hljs-attr">logging:</span>
    <span class="hljs-attr">level:</span>
        <span class="hljs-attr">com:</span>
          <span class="hljs-attr">example:</span> <span class="hljs-string">DEBUG</span>
        <span class="hljs-attr">org:</span>
          <span class="hljs-attr">springframework:</span>
            <span class="hljs-attr">web:</span> <span class="hljs-string">INFO</span>
    <span class="hljs-attr">file:</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">./logs/crawl4ai.log</span>
</code></pre>
<p>CrawlTool 提供给Agent使用的tool</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-keyword">package</span> com.example.tools;

<span class="hljs-keyword">import</span> com.example.http.request.CrawlRequest;
<span class="hljs-keyword">import</span> com.example.service.Crawl4aiApi;
<span class="hljs-keyword">import</span> org.springframework.ai.chat.model.ToolContext;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-keyword">import</span> java.util.function.BiFunction;

<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CrawlTool</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BiFunction</span>&lt;CrawlRequest, ToolContext , String&gt; {

    Crawl4aiApi crawl4aiApi;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CrawlTool</span><span class="hljs-params">(Crawl4aiApi crawl4aiApi)</span> {
        <span class="hljs-built_in">this</span>.crawl4aiApi = crawl4aiApi;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">apply</span><span class="hljs-params">(CrawlRequest query, ToolContext toolContext)</span> {
        <span class="hljs-keyword">return</span> crawl4aiApi.bingSearchToolMd(query.getQ());
    }
}

</code></pre>
<h3 data-id="heading-5">4、运行效果</h3>
<p>打开网址：<a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A8080%2Fchatui%2Findex.html" target="_blank" title="http://localhost:8080/chatui/index.html" ref="nofollow noopener noreferrer">http://localhost:8080/chatui/index.html</a></p>
<p>在聊天框输入:Spring AI Alibaba 入门教程 ，ReactAgent 会判断，调用crawl_tool 查询信息
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b30566bb7e044d5b80dcf28a1a9a693c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bemUHl0aG9u5Y-zSmF2YeS7juS7juWuueWuuea4uOWIg-acieS9mQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766130836&amp;x-signature=1bf0W79TCu%2BcV%2BSAZPWBjIItNjU%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-6">5、代码链接</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Ftree_boss%2Foak-spring-ai-alibaba-crawl4ai.git" target="_blank" title="https://gitee.com/tree_boss/oak-spring-ai-alibaba-crawl4ai.git" ref="nofollow noopener noreferrer">gitee.com/tree_boss/o…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何在 Kuscia 中使用自定义镜像仓库]]></title>    <link>https://juejin.cn/post/7582529173829189666</link>    <guid>https://juejin.cn/post/7582529173829189666</guid>    <pubDate>2025-12-12T06:26:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582529173829189666" data-draft-id="7582517824498450466" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何在 Kuscia 中使用自定义镜像仓库"/> <meta itemprop="keywords" content="开源,资讯"/> <meta itemprop="datePublished" content="2025-12-12T06:26:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="隐语SecretFlow"/> <meta itemprop="url" content="https://juejin.cn/user/3224235748628536"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何在 Kuscia 中使用自定义镜像仓库
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3224235748628536/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    隐语SecretFlow
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T06:26:56.000Z" title="Fri Dec 12 2025 06:26:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>打开链接即可点亮社区Star，照亮技术的前进之路。</p>
<p>Github 地址：<em><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsecretflow%2Fkuscia" target="_blank" title="https://github.com/secretflow/kuscia" ref="nofollow noopener noreferrer">github.com/secretflow/…</a></em></p>
<p>Kuscia支持自动拉取远程的应用镜像（比如：SecretFlow 等），这样可以不用手动导入镜像到容器中。可以在 <a href="https://link.juejin.cn?target=..%2Fdeployment%2Fkuscia_config_cn.md" target="_blank" title="../deployment/kuscia_config_cn.md" ref="nofollow noopener noreferrer">Kuscia 配置文件</a>中配置私有（or 公开）镜像仓库地址。</p>
<h2 data-id="heading-0">如何配置使用自定义镜像仓库</h2>
<p>配置文件中的 <code>image</code> 字段用来配置自定义仓库。相关含义参考 <a href="https://link.juejin.cn?target=..%2Fdeployment%2Fkuscia_config_cn.md" target="_blank" title="../deployment/kuscia_config_cn.md" ref="nofollow noopener noreferrer">Kuscia 配置文件说明</a></p>
<h3 data-id="heading-1">私有镜像仓库</h3>
<p>如果有一个私有镜像仓库（示例：<code>private.registry.com</code>），对应的配置如下：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">image:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">defaultRegistry:</span> <span class="hljs-string">private</span> <span class="hljs-comment"># It doesn't matter, as long as it corresponds to &lt;image.registries[0].name&gt;</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">registries:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">private</span>
      <span class="hljs-attr">endpoint:</span> <span class="hljs-string">private.registry.com/test</span>
      <span class="hljs-attr">username:</span> <span class="hljs-string">testname</span>
      <span class="hljs-attr">password:</span> <span class="hljs-string">testpass</span>
</code></pre>
<h3 data-id="heading-2">公开镜像仓库</h3>
<p>如果使用公开的镜像仓库（示例：<code>secretflow-registry.cn-hangzhou.cr.aliyuncs.com</code>），对应的配置如下：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">image:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">defaultRegistry:</span> <span class="hljs-string">aliyun</span> <span class="hljs-comment"># It doesn't matter, as long as it corresponds to &lt;image.registries[0].name&gt;</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">registries:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">aliyun</span>
      <span class="hljs-attr">endpoint:</span> <span class="hljs-string">secretflow-registry.cn-hangzhou.cr.aliyuncs.com/secretflow</span>
</code></pre>
<h2 data-id="heading-3">关于镜像仓库和AppImage的搭配使用</h2>
<p>配置文件中有<code>image</code>字段，<code>AppImage</code> 中也存在image相关的配置，他们的搭配关系示例如下：</p>



























































<table><thead><tr><th>配置文件</th><th>AppImage配置</th><th>实际镜像地址</th><th>备注</th></tr></thead><tbody><tr><td>无配置</td><td>secretflow/app:v1</td><td>docker.io/secretflow/app:v1</td><td/></tr><tr><td>无配置</td><td>private.registry.com/secretflow/app:v1</td><td>private.registry.com/secretflow/app:v1</td><td/></tr><tr><td>private.registry.com</td><td>secretflow/app:v1</td><td>private.registry.com/app:v1</td><td/></tr><tr><td>private.registry.com/secretflow</td><td>app:v1</td><td>private.registry.com/secretflow/app:v1</td><td>推荐配置</td></tr><tr><td>private.registry.com/secretflow</td><td>secretflow/app:v1</td><td>private.registry.com/secretflow/app:v1</td><td/></tr><tr><td>private.registry.com/secretflow</td><td>test/app:v1</td><td>private.registry.com/secretflow/app:v1</td><td/></tr><tr><td>private.registry.com/secretflow</td><td>private.registry.com/secretflow/app:v1</td><td>private.registry.com/secretflow/app:v1</td><td/></tr><tr><td>private.registry.com/secretflow</td><td>public.aliyun.com/secretflow/app:v1</td><td>public.aliyun.com/secretflow/app:v1</td><td>强烈不推荐配置，未来可能会禁止这种配置</td></tr></tbody></table>
<p>注：Kuscia推荐在 <code>AppImage</code> 中只配置镜像名（不带镜像仓库地址），否则切换仓库的时候，需要批量修改<code>AppImage</code>，所以不建议如此配置。</p>
<h2 data-id="heading-4">镜像拉取失败</h2>
<p>当发现镜像拉取失败时，请确认 配置文件中仓库地址，以及账密相关配置是否正确， 以及参考上文，确保 AppImage 的镜像地址配置正确.</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-number">2024</span>-<span class="hljs-number">06</span>-<span class="hljs-number">06</span> <span class="hljs-number">13</span>:<span class="hljs-number">33</span>:<span class="hljs-number">00.534</span> <span class="hljs-keyword">ERROR</span> framework/pod_workers.go:<span class="hljs-number">978</span> <span class="hljs-keyword">Error</span> syncing pod <span class="hljs-string">"ant-test-0_ant(7fd5285b-2a5c-4a75-930a-2908e98c8799)"</span>, skipping: failed <span class="hljs-keyword">to</span> <span class="hljs-string">"StartContainer"</span> <span class="hljs-keyword">for</span> <span class="hljs-string">"test"</span> <span class="hljs-keyword">with</span> ErrImagePull: <span class="hljs-string">"faile to pull image \"</span>registry.xxxx.com/secretflow/nginx:v1\<span class="hljs-string">" with credentials, detail-&gt; rpc error: code = Unknown desc = failed to pull and unpack image \"</span>registry.xxxx.com/secretflow/nginx:v1\<span class="hljs-string">": failed to resolve reference \"</span>registry.xxxx.com/secretflow/nginx:v1\<span class="hljs-string">": unexpected status from HEAD request to https://registry.xxxx.com/v2/secretflow/nginx/manifests/v1: 401 Unauthorized"</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[相同方法不同状态下在ts和rust的写法(是我们一直追求的编译阶段)]]></title>    <link>https://juejin.cn/post/7582539701147107369</link>    <guid>https://juejin.cn/post/7582539701147107369</guid>    <pubDate>2025-12-12T06:59:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582539701147107369" data-draft-id="7582553782398910510" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="相同方法不同状态下在ts和rust的写法(是我们一直追求的编译阶段)"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2025-12-12T06:59:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="沐森"/> <meta itemprop="url" content="https://juejin.cn/user/4455643804079608"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            相同方法不同状态下在ts和rust的写法(是我们一直追求的编译阶段)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4455643804079608/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    沐森
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T06:59:52.000Z" title="Fri Dec 12 2025 06:59:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>先写个ts，代码让我明白逻辑，然后写rust通过枚举写出和ts一样的运行时代码，然后再写rust泛型的编译判断</p>
<p>我们将模拟同一个业务场景：<strong>订单系统</strong>。 流程：<code>新建 (New)</code> -&gt; <code>支付 (pay)</code> -&gt; <code>已支付 (Paid)</code> -&gt; <code>发货 (ship)</code> -&gt; <code>已发货 (Shipped)</code>。</p>
<hr/>
<h3 data-id="heading-0">1. TypeScript 写法 (经典 OOP，运行时检查)</h3>
<p>这是大多数程序员最熟悉的写法。状态是一个字符串或枚举值，逻辑全靠 <code>if</code> 判断。</p>
<p>TypeScript</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 定义状态类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">OrderStatus</span> = <span class="hljs-string">'New'</span> | <span class="hljs-string">'Paid'</span> | <span class="hljs-string">'Shipped'</span>;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Order</span> {
    <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">status</span>: <span class="hljs-title class_">OrderStatus</span>; <span class="hljs-comment">// 状态只是一个数据字段</span>

    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">id: <span class="hljs-built_in">number</span></span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = id;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> = <span class="hljs-string">'New'</span>; <span class="hljs-comment">// 默认为 New</span>
    }

    <span class="hljs-comment">// 支付方法</span>
    <span class="hljs-title function_">pay</span>(<span class="hljs-params"/>) {
        <span class="hljs-comment">// 【痛点】：必须在运行时写代码检查当前状态</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> !== <span class="hljs-string">'New'</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`错误：订单 <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.id}</span> 状态是 <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.status}</span>，不能支付！`</span>);
        }

        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`订单 <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.id}</span> 支付成功`</span>);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> = <span class="hljs-string">'Paid'</span>; <span class="hljs-comment">// 修改内部状态</span>
    }

    <span class="hljs-comment">// 发货方法</span>
    <span class="hljs-title function_">ship</span>(<span class="hljs-params"/>) {
        <span class="hljs-comment">// 【痛点】：如果你忘了写这个 check，或者写错了，编译时不会报错，运行时会炸</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> !== <span class="hljs-string">'Paid'</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`错误：订单 <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.id}</span> 没支付，不能发货！`</span>);
        }

        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`订单 <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.id}</span> 发货成功`</span>);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> = <span class="hljs-string">'Shipped'</span>;
    }
}

<span class="hljs-comment">// --- 测试 ---</span>
<span class="hljs-keyword">const</span> order = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>(<span class="hljs-number">1</span>);

<span class="hljs-comment">// 1. 正常流程</span>
order.<span class="hljs-title function_">pay</span>();
order.<span class="hljs-title function_">ship</span>();

<span class="hljs-comment">// 2. 错误流程 (编译器拦不住，运行才会报错)</span>
<span class="hljs-comment">// order.ship(); // 抛出 Error: 错误：订单 1 状态是 Shipped，不能发货！</span>
</code></pre>
<hr/>
<h3 data-id="heading-1">2. Rust 枚举写法 (模拟 TS 逻辑，运行时检查)</h3>
<p>这是 Rust 中处理动态状态的标准写法。逻辑和 TS 几乎一样，只是用 <code>match</code> 替代了 <code>if</code>，用 <code>Result</code> 替代了 <code>throw Error</code>。</p>
<p><strong>特点：</strong>  代码写在同一个 <code>impl</code> 里，<strong>可以</strong>编译通过非法调用的代码（比如连续调用两次 pay），必须运行起来才知道错没错。</p>
<p>Rust</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-meta">#[derive(Debug, PartialEq)]</span>
<span class="hljs-keyword">enum</span> <span class="hljs-title class_">Status</span> {
    New,
    Paid,
    Shipped,
}

<span class="hljs-meta">#[derive(Debug)]</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Order</span> {
    id: <span class="hljs-type">u64</span>,
    status: Status, <span class="hljs-comment">// 状态是结构体的一个字段</span>
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Order</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>(id: <span class="hljs-type">u64</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
        <span class="hljs-keyword">Self</span> {
            id,
            status: Status::New,
        }
    }

    <span class="hljs-comment">// 必须返回 Result，因为运行时可能会失败</span>
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">pay</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;(), <span class="hljs-type">String</span>&gt; {
        <span class="hljs-comment">// 【运行时检查】：和 TS 一样，必须手动判断状态</span>
        <span class="hljs-keyword">match</span> <span class="hljs-keyword">self</span>.status {
            Status::New =&gt; {
                <span class="hljs-built_in">println!</span>(<span class="hljs-string">"订单 {} 支付成功"</span>, <span class="hljs-keyword">self</span>.id);
                <span class="hljs-keyword">self</span>.status = Status::Paid; <span class="hljs-comment">// 修改自身字段</span>
                <span class="hljs-title function_ invoke__">Ok</span>(())
            }
            _ =&gt; <span class="hljs-title function_ invoke__">Err</span>(<span class="hljs-string">"只有新订单才能支付"</span>.<span class="hljs-title function_ invoke__">to_string</span>()),
        }
    }

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">ship</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;(), <span class="hljs-type">String</span>&gt; {
        <span class="hljs-comment">// 【运行时检查】</span>
        <span class="hljs-keyword">match</span> <span class="hljs-keyword">self</span>.status {
            Status::Paid =&gt; {
                <span class="hljs-built_in">println!</span>(<span class="hljs-string">"订单 {} 发货成功"</span>, <span class="hljs-keyword">self</span>.id);
                <span class="hljs-keyword">self</span>.status = Status::Shipped;
                <span class="hljs-title function_ invoke__">Ok</span>(())
            }
            _ =&gt; <span class="hljs-title function_ invoke__">Err</span>(<span class="hljs-string">"只有已支付的订单才能发货"</span>.<span class="hljs-title function_ invoke__">to_string</span>()),
        }
    }
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">order</span> = Order::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-number">1001</span>);

    <span class="hljs-comment">// 1. 正常流程 (需要处理 Result)</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Ok</span>(_) = order.<span class="hljs-title function_ invoke__">pay</span>() {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">_</span> = order.<span class="hljs-title function_ invoke__">ship</span>();
    }

    <span class="hljs-comment">// 2. 错误流程</span>
    <span class="hljs-comment">// 编译器完全允许你写这行代码，只有跑起来通过 Err 告诉你错了</span>
    <span class="hljs-comment">// let _ = order.ship(); // 运行时返回 Err</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-2">3. Rust 泛型 + PhantomData (Type State，编译时检查)</h3>
<p>这是 Rust 的“完全体”。状态不再是字段里的<strong>值</strong>，而是依附在结构体上的<strong>类型</strong>。</p>
<p><strong>特点：</strong>  方法被拆分到不同的 <code>impl</code> 块。<strong>非法调用的代码连编译都过不去</strong>。</p>
<p>Rust</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> std::marker::PhantomData;

<span class="hljs-comment">// --- 1. 定义状态 (空结构体，只做类型标签) ---</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">New</span>;
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Paid</span>;
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Shipped</span>;

<span class="hljs-comment">// --- 2. 定义核心结构体 (带有泛型 State) ---</span>
<span class="hljs-comment">// 注意：这里没有 `status` 字段了！状态由 State 类型本身决定</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Order</span>&lt;State&gt; {
    id: <span class="hljs-type">u64</span>,
    <span class="hljs-comment">// 这是一个 0 大小的字段，只为了告诉编译器 State 是啥</span>
    _marker: PhantomData&lt;State&gt;, 
}

<span class="hljs-comment">// --- 3. 针对不同状态实现不同的方法 ---</span>

<span class="hljs-comment">// 只有 &lt;New&gt; 状态才有 pay 方法</span>
<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Order</span>&lt;New&gt; {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>(id: <span class="hljs-type">u64</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
        <span class="hljs-keyword">Self</span> { id, _marker: PhantomData }
    }

    <span class="hljs-comment">// 动作：New -&gt; Paid</span>
    <span class="hljs-comment">// 注意：输入是 self (消耗掉旧订单)，输出是 Order&lt;Paid&gt; (返回新订单)</span>
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">pay</span>(<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> Order&lt;Paid&gt; {
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"订单 {} 支付成功"</span>, <span class="hljs-keyword">self</span>.id);
        Order { 
            id: <span class="hljs-keyword">self</span>.id, 
            _marker: PhantomData 
        }
    }
}

<span class="hljs-comment">// 只有 &lt;Paid&gt; 状态才有 ship 方法</span>
<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Order</span>&lt;Paid&gt; {
    <span class="hljs-comment">// 动作：Paid -&gt; Shipped</span>
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">ship</span>(<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> Order&lt;Shipped&gt; {
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"订单 {} 发货成功"</span>, <span class="hljs-keyword">self</span>.id);
        Order { 
            id: <span class="hljs-keyword">self</span>.id, 
            _marker: PhantomData 
        }
    }
}

<span class="hljs-comment">// 只有 &lt;Shipped&gt; 状态才有 finish 方法</span>
<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Order</span>&lt;Shipped&gt; {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">finish</span>(<span class="hljs-keyword">self</span>) {
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"订单 {} 流程结束"</span>, <span class="hljs-keyword">self</span>.id);
    }
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-comment">// --- 1. 正常流程 ---</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">order_new</span> = Order::&lt;New&gt;::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-number">1001</span>); <span class="hljs-comment">// 类型: Order&lt;New&gt;</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">order_paid</span> = order_new.<span class="hljs-title function_ invoke__">pay</span>();        <span class="hljs-comment">// 类型: Order&lt;Paid&gt;</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">order_shipped</span> = order_paid.<span class="hljs-title function_ invoke__">ship</span>();   <span class="hljs-comment">// 类型: Order&lt;Shipped&gt;</span>
    order_shipped.<span class="hljs-title function_ invoke__">finish</span>();

    <span class="hljs-comment">// --- 2. 错误流程 (高能预警) ---</span>
    
    <span class="hljs-comment">// 如果你试图把上面的流程打乱，比如直接对 New 状态发货：</span>
    <span class="hljs-comment">/* let order = Order::&lt;New&gt;::new(1002);
       order.ship(); 
    */</span>
    
    <span class="hljs-comment">// 💥 编译器直接报错：</span>
    <span class="hljs-comment">// error[E0599]: no method named `ship` found for struct `Order&lt;New&gt;`</span>
    <span class="hljs-comment">// 意思：兄弟，Order&lt;New&gt; 这个类型根本就没有 ship 这个函数，你想啥呢？</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-3">终极对比总结</h3>



































<table><thead><tr><th>维度</th><th>TS / Rust Enum 写法</th><th>Rust 泛型 (Type State) 写法</th></tr></thead><tbody><tr><td><strong>状态本质</strong></td><td><strong>数据 (Data)</strong> 存储在内存的一个变量里 (<code>"New"</code>, <code>0</code>)</td><td><strong>类型 (Type)</strong> 写在代码签名里 (<code>&lt;New&gt;</code>, <code>&lt;Paid&gt;</code>)</td></tr><tr><td><strong>逻辑位置</strong></td><td><strong>集中在一起</strong> 所有方法都在一个 class/impl 里，内部用 if/match 分流</td><td><strong>分散隔离</strong> <code>pay</code> 只存在于 <code>New</code> 的实现块里 <code>ship</code> 只存在于 <code>Paid</code> 的实现块里</td></tr><tr><td><strong>错误发现</strong></td><td><strong>运行时 (Runtime)</strong> 跑起来抛异常或返回 Err</td><td><strong>编译时 (Compile Time)</strong> 代码还没跑，编译器就标红了</td></tr><tr><td><strong>IDE 体验</strong></td><td><strong>全显示</strong> 敲 <code>order.</code> 会看到 <code>pay</code> 和 <code>ship</code>，容易误点</td><td><strong>智能筛选</strong> 如果是新订单，敲 <code>order.</code> 根本看不到 <code>ship</code></td></tr><tr><td><strong>所有权</strong></td><td><strong>状态可变</strong> 对象一直是那个对象，只是改了个字段值</td><td><strong>旧状态销毁</strong> 调用 <code>pay()</code> 后，旧的 <code>order</code> 变量直接失效 (Move)，防止你再用旧订单搞事情</td></tr></tbody></table>
<p>Export to Sheets</p>
<p>通过这三段代码，你应该能明显感觉到：Rust 的泛型写法虽然定义起来稍微啰嗦（要写好几个 struct 和 impl），但在<strong>使用时</strong>是多么的安全和省心。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TiDB详解与应用实战：分布式数据库的核心原理与最佳实践]]></title>    <link>https://juejin.cn/post/7582561515816763455</link>    <guid>https://juejin.cn/post/7582561515816763455</guid>    <pubDate>2025-12-12T07:00:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582561515816763455" data-draft-id="7582502441993977899" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TiDB详解与应用实战：分布式数据库的核心原理与最佳实践"/> <meta itemprop="keywords" content="数据库"/> <meta itemprop="datePublished" content="2025-12-12T07:00:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TiDB详解与应用实战：分布式数据库的核心原理与最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T07:00:23.000Z" title="Fri Dec 12 2025 07:00:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1 TiDB架构设计与核心原理</h2>
<p>TiDB是PingCAP公司开发的开源分布式关系型数据库，采用计算存储分离的架构设计，完美结合了传统关系型数据库的ACID特性与NoSQL数据库的水平扩展能力。作为新一代的<strong>云原生数据库</strong>，TiDB完全兼容MySQL协议，使得现有MySQL应用可以几乎无缝迁移到TiDB平台，同时获得分布式架构带来的诸多优势。</p>
<h3 data-id="heading-1">1.1 核心架构组件与协作机制</h3>
<p>TiDB采用分层架构设计，包含三个核心组件：TiDB Server（计算层）、TiKV（存储层）和PD（调度层）。这种<strong>组件分离架构</strong>使得每个层级可以独立扩展和优化，提供了极大的灵活性。</p>
<ul>
<li><strong>TiDB Server（计算层）</strong> ：作为无状态SQL层，负责SQL解析、优化和执行。它兼容MySQL协议和大多数MySQL语法，应用程序可以像使用MySQL一样连接TiDB。TiDB Server将SQL请求转换为对TiKV的Key-Value操作，并汇总存储层返回的结果。</li>
<li><strong>TiKV（存储层）</strong> ：分布式键值存储引擎，基于Raft共识算法保证数据强一致性和高可用性。TiKV将数据划分为Region（默认96MB-256MB），每个Region通过Multi-Raft协议维护多个副本，确保数据安全和高可用。</li>
<li><strong>PD（Placement Driver）</strong> ：集群的"大脑"，负责元数据管理、全局时间戳分配、负载均衡和自动故障恢复。PD通过持续监控集群状态，自动调度Region副本，优化数据分布和负载均衡。</li>
</ul>
<h3 data-id="heading-2">1.2 数据分布与Region管理</h3>
<p>TiDB采用基于Range的数据分片策略，将整个Key-Value空间分成多个连续的段，每个段称为一个Region。当Region大小达到阈值（默认256MiB）时，会自动分裂为两个子Region；当Region因大量删除变得太小时，会将相邻小Region合并。这种<strong>自动分片机制</strong>确保了数据分布的动态平衡，避免了传统分库分表需要手动维护的复杂性。</p>
<p>PD组件通过多种调度器实现智能调度：</p>
<ul>
<li><strong>balance-leader-scheduler</strong>：保持不同节点的Leader均衡</li>
<li><strong>balance-region-scheduler</strong>：保持不同节点的Peer均衡</li>
<li><strong>hot-region-scheduler</strong>：保持不同节点的读写热点Region均衡</li>
</ul>
<h3 data-id="heading-3">1.3 分布式事务与一致性机制</h3>
<p>TiDB实现了完整的分布式事务机制，采用优化的两阶段提交（2PC）协议，并基于Percolator事务模型处理分布式事务。关键机制包括：</p>
<ul>
<li><strong>全局时间戳分配</strong>：PD作为全局时间戳分配器（TSO），为每个事务分配全局唯一且递增的时间戳，用于实现MVCC和全局快照隔离。</li>
<li><strong>异步提交优化</strong>：TiDB 4.0引入的Async Commit特性，对于小事务达到类似1PC的效果，减少网络往返次数，显著提升短事务性能。</li>
<li><strong>多版本并发控制（MVCC）</strong> ：TiKV实现多版本并发控制，每个数据修改都会生成新的版本，由时间戳区分版本，实现读写不阻塞的快照隔离。</li>
</ul>
<h2 data-id="heading-4">2 TiDB关键技术深度解析</h2>
<h3 data-id="heading-5">2.1 HTAP混合负载支持</h3>
<p>TiDB通过TiFlash组件实现HTAP能力，同时支持OLTP和OLAP工作负载。TiFlash是列式存储引擎，通过Multi-Raft Learner协议实时从TiKV复制数据，确保与TiKV之间的数据强一致性。</p>
<p><strong>行列混合架构</strong>的优势在于：</p>
<ul>
<li><strong>实时分析</strong>：TiFlash以低消耗不阻塞TiKV写入的方式实时复制数据，同步延迟控制在秒级，实现真正的实时分析。</li>
<li><strong>智能选择</strong>：TiDB优化器会根据查询特征和统计信息智能选择TiKV（行存）或TiFlash（列存），甚至在同一查询内混合使用两种存储。</li>
<li><strong>资源隔离</strong>：OLTP负载运行在TiKV上，OLAP复杂查询运行在TiFlash上，避免分析查询对事务处理的干扰。</li>
</ul>
<p>实际操作中，可以通过以下方式使用TiFlash：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 设置TiFlash副本</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> orders <span class="hljs-keyword">SET</span> TIFLASH REPLICA <span class="hljs-number">2</span>;

<span class="hljs-comment">-- 强制查询走TiFlash（TPC-H Query6优化）</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-comment">/*+ read_from_storage(tiflash[lineitem]) */</span> 
       <span class="hljs-built_in">sum</span>(l_extendedprice <span class="hljs-operator">*</span> l_discount) <span class="hljs-keyword">as</span> revenue
<span class="hljs-keyword">FROM</span> lineitem
<span class="hljs-keyword">WHERE</span> l_shipdate <span class="hljs-operator">&gt;=</span> <span class="hljs-string">'1994-01-01'</span>
  <span class="hljs-keyword">AND</span> l_shipdate <span class="hljs-operator">&lt;</span> date_add(<span class="hljs-string">'1994-01-01'</span>, <span class="hljs-type">interval</span> <span class="hljs-string">'1'</span> <span class="hljs-keyword">year</span>)
  <span class="hljs-keyword">AND</span> l_discount <span class="hljs-keyword">between</span> <span class="hljs-number">0.06</span> <span class="hljs-operator">-</span> <span class="hljs-number">0.01</span> <span class="hljs-keyword">AND</span> <span class="hljs-number">0.06</span> <span class="hljs-operator">+</span> <span class="hljs-number">0.01</span>
  <span class="hljs-keyword">AND</span> l_quantity <span class="hljs-operator">&lt;</span> <span class="hljs-number">24</span>;
</code></pre>
<p>此示例展示了如何利用TiFlash加速分析型查询，<code>READ_FROM_STORAGE</code>提示符强制优化器使用列式存储。</p>
<h3 data-id="heading-6">2.2 弹性扩展与自动运维</h3>
<p>TiDB支持<strong>在线弹性扩展</strong>，可在不影响业务的情况下动态增减节点。计算层（TiDB Server）和存储层（TiKV）可以独立扩展，根据业务需求灵活调整。</p>
<p><strong>自动故障恢复</strong>机制基于Raft协议实现。当少数节点故障时，系统会自动选举新Leader，并在其他节点上恢复副本数据，实现金融级100%数据强一致性保证。故障转移过程对应用透明，客户端只需实现重试逻辑即可。</p>
<p>扩缩容操作可通过TiUP工具简单完成：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 水平扩展TiDB Server</span>
tiup cluster scale-<span class="hljs-keyword">out</span> &lt;cluster-name&gt; tidb.yaml

<span class="hljs-meta"># 垂直扩展TiKV节点配置</span>
tiup cluster edit-config &lt;cluster-name&gt;
</code></pre>
<p>这种<strong>无感扩容能力</strong>使TiDB特别适合业务快速增长或流量波动大的场景。</p>
<h3 data-id="heading-7">2.3 数据迁移与生态集成</h3>
<p>TiDB拥有丰富的工具链生态，提供完整的数据管理解决方案。主要工具包括：</p>
<ul>
<li><strong>DM（Data Migration）</strong> ：从MySQL到TiDB的数据迁移工具，支持全量和增量同步。</li>
<li><strong>BR（Backup &amp; Restore）</strong> ：集群级数据备份与恢复工具，支持分布式备份。</li>
<li><strong>TiCDC</strong>：变更数据捕获与同步工具，可将数据同步到MySQL、Kafka等下游系统。</li>
</ul>
<p>与MySQL的高度兼容性是TiDB的一大优势，支持大多数MySQL语法、存储过程、函数和触发器，使得现有MySQL应用可以平滑迁移。此外，TiDB数据可以方便地导入Kafka，接入Flink，乃至Hive、HDFS、Amazon S3、Spark等大数据生态组件，避免了技术锁定风险。</p>
<h2 data-id="heading-8">3 TiDB应用实战与性能优化</h2>
<h3 data-id="heading-9">3.1 应用场景分析</h3>
<p>TiDB特别适用于以下场景：</p>
<ul>
<li><strong>高并发OLTP应用</strong>：电商、金融、游戏等需要处理大量并发事务的场景</li>
<li><strong>实时分析系统</strong>：需要同时处理事务和分析查询的HTAP场景</li>
<li><strong>大数据量存储</strong>：单表数据量达数十亿甚至上百亿的记录存储和查询需求</li>
<li><strong>MySQL迁移升级</strong>：从MySQL迁移到分布式架构的平滑升级路径</li>
</ul>
<p>某金融企业案例显示，通过部署TiDB私有云解决方案，实现了数据的实时分析和高效处理，成功应对了数据量激增和业务复杂度提升的挑战。某电信个人账单系统从MyCAT迁移到TiDB后，单表数据量从80亿扩展到100亿，数据存储周期由半年延长至3-5年，QPS和延迟都有显著改善。</p>
<h3 data-id="heading-10">3.2 SQL优化最佳实践</h3>
<p>在TiDB中，SQL性能优化至关重要。以下是一些核心优化建议：</p>
<ul>
<li><strong>避免全表扫描</strong>：通过创建合适的索引避免全表扫描。使用EXPLAIN分析查询计划，确保查询有效利用索引。</li>
<li><strong>控制事务大小</strong>：将每个事务的记录数控制在200条以内，单条记录的数据大小小于100KB。大事务会增加延迟，容易引发冲突和内存压力。</li>
<li><strong>索引优化</strong>：一张表的索引数量建议不超过7个。使用覆盖索引避免回表操作，对字符串列考虑使用前缀索引节省空间。</li>
</ul>
<p>查询优化示例：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 不好的写法：使用OR导致全表扫描</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> name <span class="hljs-operator">=</span> <span class="hljs-string">'alice'</span> <span class="hljs-keyword">OR</span> phone <span class="hljs-operator">=</span> <span class="hljs-string">'123456'</span>;

<span class="hljs-comment">-- 优化写法：使用UNION替代OR</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> name <span class="hljs-operator">=</span> <span class="hljs-string">'alice'</span> 
<span class="hljs-keyword">UNION</span> 
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> phone <span class="hljs-operator">=</span> <span class="hljs-string">'123456'</span>;

<span class="hljs-comment">-- 创建覆盖索引优化查询</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_name_age <span class="hljs-keyword">ON</span> users(name, age);
<span class="hljs-keyword">SELECT</span> name, age <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> name <span class="hljs-operator">=</span> <span class="hljs-string">'alice'</span>; <span class="hljs-comment">-- 无需回表</span>
</code></pre>
<h3 data-id="heading-11">3.3 分布式事务优化</h3>
<p>TiDB通过以下机制优化分布式事务性能：</p>
<ul>
<li><strong>异步提交（Async Commit）</strong> ：TiDB 5.0的Async Commit特性在事务提交的第二阶段实现异步提交，对于小事务达到类似1PC的效果，减少网络往返。</li>
<li><strong>悲观事务模式</strong>：高冲突场景下使用悲观事务模式，减少事务重试开销。</li>
<li><strong>批量操作</strong>：使用批量插入代替单条插入，显著提升吞吐量。</li>
</ul>
<p>Java应用中使用悲观事务的示例：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// Java应用使用悲观事务</span>
try (Connection conn = ds.getConnection()) {
    conn<span class="hljs-selector-class">.setAutoCommit</span>(false);
    <span class="hljs-comment">// 开启悲观事务模式</span>
    conn<span class="hljs-selector-class">.createStatement</span>()<span class="hljs-selector-class">.execute</span>("SET tidb_txn_mode = 'pessimistic'");
    
    <span class="hljs-comment">// 先查询后更新（带锁）</span>
    ResultSet rs = conn<span class="hljs-selector-class">.createStatement</span>()<span class="hljs-selector-class">.executeQuery</span>(
        "SELECT balance FROM accounts WHERE id = <span class="hljs-number">1001</span> FOR UPDATE");
    
    <span class="hljs-comment">// 业务逻辑处理</span>
    BigDecimal newBalance = rs<span class="hljs-selector-class">.getBigDecimal</span>(<span class="hljs-number">1</span>)<span class="hljs-selector-class">.subtract</span>(amount);
    PreparedStatement ps = conn<span class="hljs-selector-class">.prepareStatement</span>(
        "UPDATE accounts SET balance = ? WHERE id = <span class="hljs-number">1001</span>");
    ps<span class="hljs-selector-class">.setBigDecimal</span>(<span class="hljs-number">1</span>, newBalance);
    ps<span class="hljs-selector-class">.executeUpdate</span>();
    conn<span class="hljs-selector-class">.commit</span>();
}
</code></pre>
<p>此示例展示了如何使用悲观事务避免高并发下的数据竞争问题。</p>
<h3 data-id="heading-12">3.4 热点问题处理与资源管理</h3>
<p>TiDB通过多种机制处理热点问题：</p>
<ul>
<li><strong>AUTO_RANDOM</strong>：使用AUTO_RANDOM代替AUTO_INCREMENT来分配主键，避免单调递增主键导致的写热点。</li>
<li><strong>SHARD_ROW_ID_BITS</strong>：通过行号分片分散热点。</li>
<li><strong>缓存策略</strong>：对频繁访问的小表数据使用TiDB内置缓存或应用层缓存（如Redis）。</li>
</ul>
<p>资源隔离配置示例：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># tidb-server资源控制配置</span>
<span class="hljs-attr">resource-control:</span>
  <span class="hljs-attr">request-unit:</span>
    <span class="hljs-comment"># 限制OLTP负载</span>
    <span class="hljs-attr">oltp:</span>
      <span class="hljs-attr">max-tasks:</span> <span class="hljs-number">500</span>
      <span class="hljs-attr">cpu-time-per-sec:</span> <span class="hljs-number">0.8</span>
    <span class="hljs-comment"># 保障OLAP资源</span>
    <span class="hljs-attr">olap:</span>
      <span class="hljs-attr">min-tasks:</span> <span class="hljs-number">200</span>
      <span class="hljs-attr">cpu-time-per-sec:</span> <span class="hljs-number">1.2</span>
</code></pre>
<p>此配置确保OLAP查询不会影响OLTP事务的性能。</p>
<h2 data-id="heading-13">4 部署架构与运维实践</h2>
<h3 data-id="heading-14">4.1 高可用架构设计</h3>
<p>TiDB提供金融级高可用保障，通过以下机制实现：</p>
<ul>
<li><strong>多副本机制</strong>：数据默认保存3副本，分布在不同的故障域。</li>
<li><strong>自动故障转移</strong>：少数节点故障时自动切换，无需人工干预。</li>
<li><strong>跨数据中心部署</strong>：支持同城三中心、两地三中心等部署模式，保证业务连续性。</li>
</ul>
<p>跨数据中心部署示例：</p>
<pre><code class="hljs language-scss" lang="scss">RegionA (主中心)         <span class="hljs-built_in">RegionB</span>(灾备中心)
├── <span class="hljs-number">3</span> PD节点（多数派）    ├── <span class="hljs-number">2</span> PD Learner
├── <span class="hljs-number">10</span> TiKV节点（标签zone=<span class="hljs-selector-tag">a</span>） ├── <span class="hljs-number">5</span> TiKV节点（标签zone=<span class="hljs-selector-tag">b</span>）
└── <span class="hljs-number">2</span> TiDB节点          └── <span class="hljs-number">1</span> TiDB节点
</code></pre>
<p>此拓扑确保单个数据中心故障时服务仍然可用。</p>
<h3 data-id="heading-15">4.2 监控与告警体系</h3>
<p>TiDB集成了Prometheus和Grafana构建完整的监控体系，关键监控指标包括：</p>
<ul>
<li><strong>集群概览</strong>：QPS、延迟、连接数等核心指标</li>
<li><strong>TiDB性能</strong>：查询耗时、执行时间、慢查询分析</li>
<li><strong>TiKV状态</strong>：CPU、IO负载、Region健康状态、调度操作</li>
<li><strong>PD调度</strong>：Balance操作、热点分布、调度队列</li>
</ul>
<p>通过设置合理的告警阈值，可以及时发现并处理潜在问题。例如，当出现"server is busy"或"channel full"错误时，通常意味着系统已达瓶颈，需要扩容或优化。</p>
<h3 data-id="heading-16">4.3 备份与恢复策略</h3>
<p>TiDB提供多种数据保护机制：</p>
<ul>
<li><strong>自动备份</strong>：支持全量和增量备份，可将数据备份到对象存储。</li>
<li><strong>时间点恢复（PITR）</strong> ：支持精确到秒级的数据恢复。</li>
<li><strong>异地容灾</strong>：通过TiCDC将数据同步到异地集群，实现容灾。</li>
</ul>
<p>备份策略示例：</p>
<pre><code class="hljs language-sql" lang="sql"># 使用BR进行全量备份
br backup <span class="hljs-keyword">full</span> \
    <span class="hljs-comment">--pd "&lt;pd-addresses&gt;" \</span>
    <span class="hljs-comment">--storage "s3://backup-data/backup-2023" \</span>
    <span class="hljs-comment">--ratelimit 128</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[iOS 应用保护工具怎么选？从攻击面拆解到工具职责划分的全链路实战指南]]></title>    <link>https://juejin.cn/post/7582519152566714383</link>    <guid>https://juejin.cn/post/7582519152566714383</guid>    <pubDate>2025-12-12T07:00:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582519152566714383" data-draft-id="7582519152566697999" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="iOS 应用保护工具怎么选？从攻击面拆解到工具职责划分的全链路实战指南"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-12T07:00:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="疯狂的程序猴"/> <meta itemprop="url" content="https://juejin.cn/user/2760245749234147"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            iOS 应用保护工具怎么选？从攻击面拆解到工具职责划分的全链路实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2760245749234147/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    疯狂的程序猴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T07:00:24.000Z" title="Fri Dec 12 2025 07:00:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在移动安全领域，“iOS 应用保护”听起来像是一个单一任务，但真正落地时你会发现——它并不是靠某个软件就能一劳永逸的。</p>
<p>保护 iOS 应用的过程更像是在维护一套复杂的工程系统，需要多个类型的工具协同，覆盖多个攻击入口，包括：</p>
<ul>
<li>符号泄露</li>
<li>JS / JSON / 配置文件明文</li>
<li>资源可替换</li>
<li>IPA 可重签名</li>
<li>运行时 Hook</li>
<li>越狱环境绕过</li>
<li>动态调试</li>
<li>逆向分析</li>
</ul>
<p>因此，“iOS 应用保护工具”并不是比谁强，而是比谁能覆盖更多环节、配合得更顺、工程化更容易。</p>
<p>本文将从攻击面拆解开始，再到工具矩阵与职责划分，最后给出一套完整的自动化工程方案，适合 Swift、ObjC、Flutter、React Native、Hybrid 等各类项目使用。</p>
<hr/>
<h2 data-id="heading-0">一、先看攻击者能突破哪些点（攻击面拆解）</h2>
<p>攻击路径是固定的，因此保护工具往往也是对这些入口进行阻断。</p>
<hr/>
<h2 data-id="heading-1"><strong>① 获取 IPA（通过 App Store / 企业包 / 重签包 / 网络泄露）</strong></h2>
<p>这意味着：
你的完整可执行文件和所有资源都暴露在攻击者手中。</p>
<hr/>
<h2 data-id="heading-2"><strong>② 静态逆向分析</strong></h2>
<p>攻击者会使用：</p>

























<table><thead><tr><th>工具</th><th>作用</th></tr></thead><tbody><tr><td>class-dump</td><td>导出 ObjC 符号</td></tr><tr><td>swift-dump</td><td>导出 Swift 符号</td></tr><tr><td>Hopper / IDA</td><td>反编译代码</td></tr><tr><td>MobSF</td><td>识别安全风险</td></tr></tbody></table>
<p>只要符号可读，逆向门槛就很低。</p>
<hr/>
<h2 data-id="heading-3"><strong>③ 修改资源与 JS/H5 逻辑</strong></h2>
<p>攻击者会直接替换：</p>
<ul>
<li>JSON 配置</li>
<li>JS 文件（Hybrid、RN、小游戏、WebView）</li>
<li>图片和 UI</li>
<li>信息表 / 配置表</li>
</ul>
<p>这是最常见的破解入口。</p>
<hr/>
<h2 data-id="heading-4"><strong>④ 修改二进制进行逻辑绕过</strong></h2>
<p>常见行为：</p>
<ul>
<li>Patch 校验</li>
<li>绕过会员 / 支付判断</li>
<li>移除广告</li>
<li>修改游戏数值</li>
</ul>
<hr/>
<h2 data-id="heading-5"><strong>⑤ 重签 IPA 并重新发布</strong></h2>
<p>工具如 kxsign 可轻松重签。</p>
<p>如果 App 没有完整性保护，破解者即可完成整个链路。</p>
<hr/>
<h2 data-id="heading-6">二、iOS 应用保护工具的分类与职责划分</h2>
<p>不合理的选型会造成工具重复、保护缺失、工程难维护。</p>
<p>合理的工具体系应该如下：</p>
<hr/>
<h2 data-id="heading-7">第一类：源码级保护工具（有源码时可选）</h2>
<p>适用 Swift / ObjC 工程。</p>
<h3 data-id="heading-8"><strong>Swift Shield</strong></h3>
<ul>
<li>混淆 Swift 方法、类名</li>
<li>修改可见性</li>
<li>降低结构可读性</li>
</ul>
<h3 data-id="heading-9"><strong>obfuscator-llvm</strong></h3>
<ul>
<li>深度混淆（控制流、字符串加密）</li>
<li>编译链级别，强度高但成本高</li>
</ul>
<p>这类工具的特点：</p>
<ul>
<li>覆盖源码，但无法保护生成的 IPA 中的资源文件</li>
<li>必须有源码才能用</li>
</ul>
<hr/>
<h2 data-id="heading-10">第二类：IPA 层保护工具（最通用且最重要）</h2>
<p>适用：</p>
<ul>
<li>Swift/ObjC 工程</li>
<li>Flutter</li>
<li>React Native</li>
<li>H5 / Hybrid</li>
<li>无源码工程</li>
<li>外包产物</li>
<li>第三方 SDK</li>
</ul>
<p>代表工具：</p>
<hr/>
<h2 data-id="heading-11"><strong>Ipa Guard（支持命令行）</strong></h2>
<p>IPA 层工具通常具备以下能力：</p>
<h3 data-id="heading-12"><strong>1）无需源码即可混淆符号</strong></h3>
<ul>
<li>Swift 名称</li>
<li>ObjC selector</li>
<li>方法名、变量名、类名</li>
</ul>
<h3 data-id="heading-13"><strong>2）资源混淆与防替换保护</strong></h3>
<ul>
<li>修改资源文件名称</li>
<li>扰动资源路径</li>
<li>修改 MD5 防止用同名资源替换</li>
<li>混淆 js（适合 H5 / RN / Hybrid）</li>
</ul>
<p>这点对保护 Flutter/RN 应用尤其关键。</p>
<h3 data-id="heading-14"><strong>3）IPA 重构，让二次打包难度增大</strong></h3>
<h3 data-id="heading-15"><strong>4）支持命令行，可接入 CI/CD</strong></h3>
<p>示例：</p>
<pre><code class="hljs language-bash" lang="bash">ipaguard_cli parse app.ipa -o sym.json
ipaguard_cli protect app.ipa -c sym.json --image --js -o protected.ipa
</code></pre>
<p>这是 iOS 加固中最常见、覆盖面最广的一类工具。</p>
<hr/>
<h2 data-id="heading-16">第三类：签名与安装验证工具</h2>
<p>用于验证加固后的 IPA 是否正常运行。</p>
<h3 data-id="heading-17"><strong>kxsign</strong></h3>
<ul>
<li>重签 IPA</li>
<li>安装到真机</li>
<li>用于准备审核包或测试包</li>
</ul>
<p>它不是加固工具，但在加固流程中不可缺失。</p>
<hr/>
<h2 data-id="heading-18">第四类：运行时防护工具（代码层实现）</h2>
<p>通过自研代码或安全 SDK 提供：</p>
<ul>
<li>防调试</li>
<li>防越狱</li>
<li>完整性校验</li>
<li>动态反 Hook</li>
<li>检查可疑注入</li>
</ul>
<p>这类通常需要工程师配合业务逻辑设计。</p>
<hr/>
<h2 data-id="heading-19">三、将多个工具组合成可真正落地的防护体系</h2>
<p>单一工具解决不了整体安全问题，必须构建多层体系。</p>
<p>以下是成熟移动团队常用的结构：</p>
<hr/>
<h2 data-id="heading-20"><strong>Layer 1：符号保护层（结构隐藏）</strong></h2>
<p>目标：
让逆向者无法轻易读懂系统结构。</p>
<p>工具组合：</p>
<ul>
<li>Swift Shield（如有源码）</li>
<li>Ipa Guard（IPA 层符号混淆）</li>
</ul>
<p>混淆后的类名可能如下：</p>
<pre><code class="hljs">_A3F9Controller
_B12FModel
_C7AFunction
</code></pre>
<p>逆向难度显著提升。</p>
<hr/>
<h2 data-id="heading-21"><strong>Layer 2：资源保护层（防篡改）</strong></h2>
<p>目标：
让攻击者无法通过替换资源来重写应用行为。</p>
<p>工具：
<strong>Ipa Guard CLI</strong></p>
<p>能力：</p>
<ul>
<li>修改 PNG / JSON / JS / HTML 名称</li>
<li>扰动路径</li>
<li>修改 MD5（替换资源即崩溃）</li>
</ul>
<p>这是破解链路中最关键的阻断点。</p>
<hr/>
<h2 data-id="heading-22"><strong>Layer 3：运行时保护层</strong></h2>
<p>工程内实现：</p>
<ul>
<li>完整性校验</li>
<li>Hook 检测</li>
<li>越狱检测</li>
<li>环境检测（模拟器 / 越狱插件）</li>
</ul>
<p>配合资源保护效果更好。</p>
<hr/>
<h2 data-id="heading-23"><strong>Layer 4：IPA 层结构保护与验证</strong></h2>
<p>工具组合：</p>
<ul>
<li>Ipa Guard（结构扰动）</li>
<li>kxsign（重签、验证、真机安装）</li>
</ul>
<p>流程示例：</p>
<pre><code class="hljs language-arduino" lang="arduino">kxsign sign <span class="hljs-keyword">protected</span>.ipa -c cert.p12 -p pass -m dev.mobileprovision -z <span class="hljs-type">signed</span>.ipa -i
</code></pre>
<hr/>
<h2 data-id="heading-24">四、场景化案例：不同类型 App 使用哪些工具组合？</h2>
<hr/>
<h2 data-id="heading-25"><strong>① Swift 原生项目</strong></h2>
<p>推荐组合：</p>
<ul>
<li>Swift Shield（源码层）</li>
<li>Ipa Guard（IPA 层）</li>
<li>自研完整性校验</li>
<li>Frida 反调试逻辑</li>
</ul>
<hr/>
<h2 data-id="heading-26"><strong>② Flutter 项目</strong></h2>
<p>Flutter 的资源全部明文，因此保护重点要放在 IPA 层。</p>
<p>推荐组合：</p>
<ul>
<li>Ipa Guard（flutter_assets 资源保护 + MD5）</li>
<li>JS 混淆（如使用 Hybrid）</li>
<li>kxsign 安装测试</li>
</ul>
<hr/>
<h2 data-id="heading-27"><strong>③ React Native 项目</strong></h2>
<p>RN 的 jsbundle 是最大风险点。</p>
<p>推荐组合：</p>
<ul>
<li>javascript-obfuscator（前端混淆）</li>
<li>Ipa Guard（bundle 路径扰动 + MD5 防替换）</li>
<li>Native 层符号混淆</li>
</ul>
<hr/>
<h2 data-id="heading-28"><strong>④ H5 / Hybrid 应用</strong></h2>
<p>需保护：</p>
<ul>
<li>js</li>
<li>html</li>
<li>img</li>
<li>config.json</li>
</ul>
<p>推荐组合：</p>
<ul>
<li>JS 混淆工具</li>
<li>Ipa Guard（资源路径混淆 + MD5 + JS 混淆）</li>
</ul>
<hr/>
<h2 data-id="heading-29"><strong>⑤ 无源码的历史工程或外部 SDK 集成 App</strong></h2>
<p>推荐组合：</p>
<ul>
<li><strong>Ipa Guard（主力工具，无需源码）</strong></li>
<li>kxsign（重签与安装验证）</li>
</ul>
<p>IPA 层保护基本能覆盖 80% 安全需求。</p>
<hr/>
<h2 data-id="heading-30">iOS 应用保护工具不是「用哪个」，而是「组合哪些」</h2>
<p>最终推荐的多层工具体系如下：</p>
<h2 data-id="heading-31"><strong>符号保护工具：</strong></h2>
<p>Swift Shield
obfuscator-llvm
<strong>Ipa Guard CLI（核心、IPA 层）</strong></p>
<h2 data-id="heading-32"><strong>资源保护与防替换工具：</strong></h2>
<p>JS 混淆工具
<strong>Ipa Guard CLI（路径扰动 + MD5 修改）</strong></p>
<h2 data-id="heading-33"><strong>签名与验证工具：</strong></h2>
<p>kxsign
Jenkins / GitHub Actions（自动化）</p>
<h2 data-id="heading-34"><strong>逆向验证工具：</strong></h2>
<p>Hopper
MobSF
Frida</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring 框架中 RequestContextHolder 深度解析]]></title>    <link>https://juejin.cn/post/7582808491583406116</link>    <guid>https://juejin.cn/post/7582808491583406116</guid>    <pubDate>2025-12-12T07:25:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582808491583406116" data-draft-id="7582808491582242852" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring 框架中 RequestContextHolder 深度解析"/> <meta itemprop="keywords" content="Java,架构"/> <meta itemprop="datePublished" content="2025-12-12T07:25:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="李拾叁的摸鱼日常"/> <meta itemprop="url" content="https://juejin.cn/user/4443539294129722"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring 框架中 RequestContextHolder 深度解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4443539294129722/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    李拾叁的摸鱼日常
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T07:25:03.000Z" title="Fri Dec 12 2025 07:25:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>RequestContextHolder 是 Spring 框架中<strong>核心的请求上下文管理工具类</strong>，本质是通过 <code>ThreadLocal</code> 将 HTTP 请求上下文（<code>HttpServletRequest</code>/<code>HttpServletResponse</code>/<code>Session</code> 等）绑定到当前线程，解决了非 Web 层（如 Service、Util、异步线程）无法直接获取请求上下文的问题，是 Spring MVC 实现全链路上下文传递的基石。</p>
<p>本文从<strong>核心作用、内部实现、方法详解、实战场景、避坑指南</strong>五个维度全面解析，覆盖开发全场景需求。</p>
<h2 data-id="heading-0">一、RequestContextHolder 核心定位与价值</h2>
<p>在 Spring MVC 中，<code>HttpServletRequest</code>/<code>HttpServletResponse</code> 等对象默认仅能在 Controller、Filter、Interceptor 等 Web 层通过方法参数获取，而 Service、Util 等非 Web 层无法直接访问。RequestContextHolder 解决了这一痛点：</p>
<h3 data-id="heading-1">核心价值</h3>
<ol>
<li><strong>解耦上下文获取</strong>：无需通过方法参数传递 <code>request</code>，降低代码耦合（如 Service 层无需接收 <code>request</code> 参数即可获取）；</li>
<li><strong>线程隔离</strong>：基于 <code>ThreadLocal</code> 实现，保证多线程环境下请求上下文不串用；</li>
<li><strong>子线程继承</strong>：支持 <code>InheritableThreadLocal</code>，满足异步/多线程场景的上下文传递；</li>
<li><strong>支撑框架核心功能</strong>：Spring MVC 的 <code>RequestMappingHandlerAdapter</code>、<code>SessionAttributesHandler</code>、<code>@RequestParam</code> 解析器等核心组件均依赖它获取上下文；</li>
<li><strong>兼容非 Web 场景</strong>：提供非空判断机制，避免定时任务、消息队列等非 Web 场景的空指针异常。</li>
</ol>
<h2 data-id="heading-2">二、RequestContextHolder 内部实现原理</h2>
<h3 data-id="heading-3">1. 底层存储：ThreadLocal 双容器设计</h3>
<p>RequestContextHolder 内部维护两个静态 <code>ThreadLocal</code> 容器，用于存储请求上下文的封装对象 <code>RequestAttributes</code>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 普通ThreadLocal：仅当前线程可见，子线程无法继承</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;RequestAttributes&gt; requestAttributesHolder = 
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">NamedThreadLocal</span>&lt;&gt;(<span class="hljs-string">"Request attributes"</span>);

<span class="hljs-comment">// 可继承ThreadLocal：子线程创建时自动继承父线程的上下文</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;RequestAttributes&gt; inheritableRequestAttributesHolder = 
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">NamedInheritableThreadLocal</span>&lt;&gt;(<span class="hljs-string">"Request context"</span>);
</code></pre>
<ul>
<li><code>NamedThreadLocal</code>/<code>NamedInheritableThreadLocal</code>：是 Spring 对 <code>ThreadLocal</code> 的扩展，仅增加了“线程名称”属性，便于调试（如打印 ThreadLocal 名称定位问题）；</li>
<li>双容器设计：区分“是否允许子线程继承”，满足不同场景的上下文传递需求。</li>
</ul>
<h3 data-id="heading-4">2. 核心封装：RequestAttributes 接口</h3>
<p>RequestContextHolder 不直接存储 <code>HttpServletRequest</code>，而是存储 <code>RequestAttributes</code> 接口的实现类（核心是 <code>ServletRequestAttributes</code>），这是 Spring 对 Servlet 上下文的抽象，解耦了具体的 Servlet API，便于扩展（如适配非 Servlet 环境）。</p>
<h4 data-id="heading-5">RequestAttributes 核心能力（接口方法）</h4>

































<table><thead><tr><th>方法/常量</th><th>作用</th></tr></thead><tbody><tr><td><code>SCOPE_REQUEST</code></td><td>请求级作用域（对应 <code>request.setAttribute</code>）</td></tr><tr><td><code>SCOPE_SESSION</code></td><td>会话级作用域（对应 <code>session.setAttribute</code>）</td></tr><tr><td><code>getAttribute(String name, int scope)</code></td><td>获取指定作用域的属性值</td></tr><tr><td><code>setAttribute(String name, Object value, int scope)</code></td><td>设置指定作用域的属性值</td></tr><tr><td><code>removeAttribute(String name, int scope)</code></td><td>移除指定作用域的属性值</td></tr><tr><td><code>resolveReference(String key)</code></td><td>解析 Servlet 原生对象（如 <code>REQUEST</code>/<code>RESPONSE</code>/<code>SESSION</code>）</td></tr></tbody></table>
<h4 data-id="heading-6">ServletRequestAttributes（核心实现类）</h4>
<p>封装了 <code>HttpServletRequest</code>/<code>HttpServletResponse</code>/<code>HttpSession</code>，提供以下关键方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 获取原生HttpServletRequest</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> HttpServletRequest <span class="hljs-title function_">getRequest</span><span class="hljs-params">()</span> { ... }
<span class="hljs-comment">// 获取原生HttpServletResponse</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> HttpServletResponse <span class="hljs-title function_">getResponse</span><span class="hljs-params">()</span> { ... }
<span class="hljs-comment">// 获取HttpSession（不存在则创建）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> HttpSession <span class="hljs-title function_">getSession</span><span class="hljs-params">()</span> { ... }
<span class="hljs-comment">// 获取请求完成时间（用于清理上下文）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestCompleted</span><span class="hljs-params">()</span> { ... }
</code></pre>
<h3 data-id="heading-7">3. 上下文绑定/解绑流程（Spring MVC 核心）</h3>
<p>RequestContextHolder 的上下文并非自动绑定，而是由 Spring MVC 的核心入口 <code>DispatcherServlet</code> 完成，流程如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb16aa2d178b4d7b87535c289023bdce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2O5ou-5Y-B55qE5pG46bG85pel5bi4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766129103&amp;x-signature=W7tfj2y47So%2BHF9aJmr2i5kNtvI%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>绑定时机：<code>DispatcherServlet#doDispatch</code> 方法开头；</li>
<li>解绑时机：<code>doDispatch</code> 方法的 <code>finally</code> 块（必须解绑，避免 ThreadLocal 内存泄漏）；</li>
<li>继承性控制：由 <code>spring.mvc.async.request-attributes-inheritable</code> 配置（默认 false），决定是否绑定到可继承的 ThreadLocal。</li>
<li>核心类/方法：<code>org.springframework.web.servlet.FrameworkServlet#processRequest</code>、<code>org.springframework.web.servlet.FrameworkServlet#initContextHolders</code>、<code>org.springframework.web.servlet.FrameworkServlet#resetContextHolders</code></li>
</ul>
<h2 data-id="heading-8">三、RequestContextHolder 所有方法详解</h2>
<p>RequestContextHolder 提供的方法均为 <strong>public static</strong>（除保护方法外），按功能分类解析：</p>
<h3 data-id="heading-9">1. 上下文获取方法（核心）</h3>
<h4 data-id="heading-10">(1) <code>getRequestAttributes()</code></h4>
<ul>
<li><strong>方法签名</strong>：<code>public static RequestAttributes getRequestAttributes()</code></li>
<li><strong>核心作用</strong>：获取当前线程绑定的 <code>RequestAttributes</code>，无绑定则返回 <code>null</code>；</li>
<li><strong>底层逻辑</strong>：先从 <code>requestAttributesHolder</code>（普通 ThreadLocal）获取，若为 null 则从 <code>inheritableRequestAttributesHolder</code> 获取；</li>
<li><strong>使用场景</strong>：非强制依赖上下文的场景（如日志记录，无上下文则跳过）；</li>
<li><strong>示例</strong>：
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> String <span class="hljs-title function_">getRequestIp</span><span class="hljs-params">()</span> {
    <span class="hljs-type">RequestAttributes</span> <span class="hljs-variable">attributes</span> <span class="hljs-operator">=</span> RequestContextHolder.getRequestAttributes();
    <span class="hljs-keyword">if</span> (attributes == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"未知IP（非Web请求）"</span>;
    }
    <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> ((ServletRequestAttributes) attributes).getRequest();
    <span class="hljs-keyword">return</span> request.getRemoteAddr();
}
</code></pre>
</li>
</ul>
<h4 data-id="heading-11">(2) <code>currentRequestAttributes()</code></h4>
<ul>
<li><strong>方法签名</strong>：<code>public static RequestAttributes currentRequestAttributes() throws IllegalStateException</code></li>
<li><strong>核心作用</strong>：强制获取上下文，无绑定则抛出 <code>IllegalStateException</code>（异常信息：<code>No thread-bound request found</code>）；</li>
<li><strong>底层逻辑</strong>：调用 <code>getRequestAttributes()</code>，返回 null 则抛异常；</li>
<li><strong>使用场景</strong>：必须依赖上下文的场景（如权限校验、租户隔离），无上下文则终止流程；</li>
<li><strong>示例</strong>：
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> String <span class="hljs-title function_">getCurrentTenantId</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 无上下文直接抛异常，避免空指针</span>
    <span class="hljs-type">RequestAttributes</span> <span class="hljs-variable">attributes</span> <span class="hljs-operator">=</span> RequestContextHolder.currentRequestAttributes();
    <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> ((ServletRequestAttributes) attributes).getRequest();
    <span class="hljs-type">String</span> <span class="hljs-variable">tenantId</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">"Tenant-ID"</span>);
    <span class="hljs-keyword">if</span> (tenantId == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"租户ID缺失"</span>);
    }
    <span class="hljs-keyword">return</span> tenantId;
}
</code></pre>
</li>
</ul>
<h3 data-id="heading-12">2. 上下文绑定方法</h3>
<h4 data-id="heading-13">(1) <code>setRequestAttributes(RequestAttributes attributes)</code></h4>
<ul>
<li><strong>方法签名</strong>：<code>public static void setRequestAttributes(RequestAttributes attributes)</code></li>
<li><strong>核心作用</strong>：将上下文绑定到当前线程的 <strong>普通 ThreadLocal</strong>（子线程无法继承）；</li>
<li><strong>底层逻辑</strong>：调用 <code>setRequestAttributes(attributes, false)</code>；</li>
<li><strong>使用场景</strong>：自定义 Servlet/Filter 时手动绑定上下文（无需子线程继承）；</li>
<li><strong>示例</strong>：
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 自定义Filter中手动绑定</span>
<span class="hljs-meta">@WebFilter(urlPatterns = "/*")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException {
        <span class="hljs-type">ServletRequestAttributes</span> <span class="hljs-variable">attributes</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServletRequestAttributes</span>((HttpServletRequest) request, (HttpServletResponse) response);
        RequestContextHolder.setRequestAttributes(attributes); <span class="hljs-comment">// 绑定到普通ThreadLocal</span>
        <span class="hljs-keyword">try</span> {
            chain.doFilter(request, response);
        } <span class="hljs-keyword">finally</span> {
            RequestContextHolder.resetRequestAttributes(); <span class="hljs-comment">// 必须解绑</span>
        }
    }
}
</code></pre>
</li>
</ul>
<h4 data-id="heading-14">(2) <code>setRequestAttributes(RequestAttributes attributes, boolean inheritable)</code></h4>
<ul>
<li><strong>方法签名</strong>：<code>public static void setRequestAttributes(RequestAttributes attributes, boolean inheritable)</code></li>
<li><strong>核心作用</strong>：绑定上下文，指定是否允许子线程继承；
<ul>
<li><code>inheritable=true</code>：绑定到 <code>inheritableRequestAttributesHolder</code>（可继承 ThreadLocal）；</li>
<li><code>inheritable=false</code>：绑定到 <code>requestAttributesHolder</code>（普通 ThreadLocal）；</li>
</ul>
</li>
<li><strong>使用场景</strong>：异步/多线程场景（如子线程需要获取父线程的请求上下文）；</li>
<li><strong>示例</strong>：
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 父线程绑定上下文并允许子线程继承</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parentThread</span><span class="hljs-params">()</span> {
    <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> ...; <span class="hljs-comment">// 假设已获取request</span>
    <span class="hljs-type">ServletRequestAttributes</span> <span class="hljs-variable">attributes</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServletRequestAttributes</span>(request);
    RequestContextHolder.setRequestAttributes(attributes, <span class="hljs-literal">true</span>); <span class="hljs-comment">// 允许继承</span>
    
    <span class="hljs-comment">// 子线程创建时自动继承上下文</span>
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
        <span class="hljs-type">RequestAttributes</span> <span class="hljs-variable">attr</span> <span class="hljs-operator">=</span> RequestContextHolder.getRequestAttributes();
        System.out.println(attr != <span class="hljs-literal">null</span>); <span class="hljs-comment">// true</span>
    }).start();
}
</code></pre>
</li>
</ul>
<h3 data-id="heading-15">3. 上下文重置/清理方法</h3>
<h4 data-id="heading-16"><code>resetRequestAttributes()</code></h4>
<ul>
<li><strong>方法签名</strong>：<code>public static void resetRequestAttributes()</code></li>
<li><strong>核心作用</strong>：清空当前线程的两个 ThreadLocal 容器（移除上下文）；</li>
<li><strong>底层逻辑</strong>：调用 <code>requestAttributesHolder.remove()</code> + <code>inheritableRequestAttributesHolder.remove()</code>；</li>
<li><strong>使用场景</strong>：自定义绑定上下文的场景（如 Filter、异步线程），必须在 <code>finally</code> 块调用，避免 ThreadLocal 内存泄漏；</li>
<li><strong>强制要求</strong>：Spring MVC 自动调用，但自定义场景（如手动绑定）必须手动调用！</li>
</ul>
<h3 data-id="heading-17">4. 保护方法（框架内部使用，开发极少用）</h3>
<h4 data-id="heading-18">(1) <code>getRequestAttributesHolder()</code></h4>
<ul>
<li><strong>方法签名</strong>：<code>protected static ThreadLocal&lt;RequestAttributes&gt; getRequestAttributesHolder()</code></li>
<li><strong>作用</strong>：返回普通 ThreadLocal 容器，供子类扩展（如自定义 RequestContextHolder）；</li>
</ul>
<h4 data-id="heading-19">(2) <code>getInheritableRequestAttributesHolder()</code></h4>
<ul>
<li><strong>方法签名</strong>：<code>protected static ThreadLocal&lt;RequestAttributes&gt; getInheritableRequestAttributesHolder()</code></li>
<li><strong>作用</strong>：返回可继承的 ThreadLocal 容器，框架内部扩展使用。</li>
</ul>
<h2 data-id="heading-20">四、RequestContextHolder 实战应用场景（详细）</h2>
<h3 data-id="heading-21">场景1：非 Web 层（Service/Util）获取请求上下文</h3>
<p>这是最常用的场景，解决 Service、工具类中获取 <code>request</code>/<code>response</code> 的需求，典型场景：</p>
<ul>
<li>记录操作日志：获取请求 IP、URL、请求参数、用户 Token；</li>
<li>业务逻辑：根据请求头（如 <code>Accept-Language</code>）返回多语言内容；</li>
<li>权限校验：在 Service 层校验请求头中的 Token 有效性。</li>
</ul>
<h4 data-id="heading-22">示例：全局操作日志工具类</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OperateLogUtil</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OperateLogMapper logMapper;

    <span class="hljs-comment">/**
     * 记录操作日志（自动填充请求上下文）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveLog</span><span class="hljs-params">(String operateType, String content)</span> {
        <span class="hljs-type">OperateLog</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OperateLog</span>();
        log.setOperateType(operateType);
        log.setContent(content);
        log.setCreateTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());

        <span class="hljs-comment">// 获取请求上下文（非Web场景兼容）</span>
        <span class="hljs-type">RequestAttributes</span> <span class="hljs-variable">attributes</span> <span class="hljs-operator">=</span> RequestContextHolder.getRequestAttributes();
        <span class="hljs-keyword">if</span> (attributes != <span class="hljs-literal">null</span>) {
            <span class="hljs-type">ServletRequestAttributes</span> <span class="hljs-variable">servletAttr</span> <span class="hljs-operator">=</span> (ServletRequestAttributes) attributes;
            <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> servletAttr.getRequest();
            <span class="hljs-comment">// 填充请求信息</span>
            log.setRequestIp(request.getRemoteAddr());
            log.setRequestUrl(request.getRequestURI());
            log.setRequestMethod(request.getMethod());
            log.setUserAgent(request.getHeader(<span class="hljs-string">"User-Agent"</span>));
            <span class="hljs-comment">// 从Token解析用户ID</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">"Authorization"</span>);
            <span class="hljs-keyword">if</span> (token != <span class="hljs-literal">null</span>) {
                log.setOperateUserId(JwtUtil.parseUserId(token));
            }
        }

        logMapper.insert(log);
    }
}

<span class="hljs-comment">// Service中调用（无需传递request参数）</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OperateLogUtil logUtil;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateUser</span><span class="hljs-params">(UserDTO dto)</span> {
        <span class="hljs-comment">// 业务逻辑</span>
        userMapper.updateById(dto);
        <span class="hljs-comment">// 记录日志（自动获取请求上下文）</span>
        logUtil.saveLog(<span class="hljs-string">"修改用户"</span>, <span class="hljs-string">"用户ID："</span> + dto.getId() + <span class="hljs-string">"，姓名："</span> + dto.getName());
    }
}
</code></pre>
<h3 data-id="heading-23">场景2：统一异常处理中补充请求信息</h3>
<p>全局异常处理器（<code>@RestControllerAdvice</code>）中，通过 RequestContextHolder 获取请求上下文，让异常日志包含请求信息，便于排查问题。</p>
<h4 data-id="heading-24">示例：全局异常处理器</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestControllerAdvice</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GlobalExceptionHandler</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(GlobalExceptionHandler.class);

    <span class="hljs-meta">@ExceptionHandler(BusinessException.class)</span>
    <span class="hljs-keyword">public</span> Result&lt;?&gt; handleBusinessException(BusinessException e) {
        <span class="hljs-comment">// 构建请求上下文信息</span>
        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">requestInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();
        <span class="hljs-type">RequestAttributes</span> <span class="hljs-variable">attributes</span> <span class="hljs-operator">=</span> RequestContextHolder.getRequestAttributes();
        <span class="hljs-keyword">if</span> (attributes != <span class="hljs-literal">null</span>) {
            <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> ((ServletRequestAttributes) attributes).getRequest();
            requestInfo.append(<span class="hljs-string">"请求URL："</span>).append(request.getRequestURI())
                       .append(<span class="hljs-string">" | 请求方法："</span>).append(request.getMethod())
                       .append(<span class="hljs-string">" | IP："</span>).append(request.getRemoteAddr())
                       .append(<span class="hljs-string">" | 参数："</span>).append(JSON.toJSONString(request.getParameterMap()));
        } <span class="hljs-keyword">else</span> {
            requestInfo.append(<span class="hljs-string">"非Web请求"</span>);
        }

        <span class="hljs-comment">// 记录异常日志（含请求信息）</span>
        log.error(<span class="hljs-string">"业务异常：{} | 请求信息：{}"</span>, e.getMessage(), requestInfo, e);
        <span class="hljs-comment">// 返回统一响应</span>
        <span class="hljs-keyword">return</span> Result.fail(e.getCode(), e.getMessage());
    }
}
</code></pre>
<h3 data-id="heading-25">场景3：异步/多线程场景传递上下文</h3>
<p>Spring 的 <code>@Async</code> 异步方法、线程池任务默认无法继承父线程的 RequestContextHolder 上下文，需手动处理，否则子线程获取的上下文为 null。</p>
<h4 data-id="heading-26">方案1：手动绑定（零散异步场景）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncTaskService</span> {
    <span class="hljs-comment">/**
     * 异步处理订单（手动传递上下文）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">asyncProcessOrder</span><span class="hljs-params">(Long orderId)</span> {
        <span class="hljs-comment">// 1. 父线程获取上下文</span>
        <span class="hljs-type">RequestAttributes</span> <span class="hljs-variable">parentAttr</span> <span class="hljs-operator">=</span> RequestContextHolder.getRequestAttributes();
        
        <span class="hljs-comment">// 2. 异步任务中手动绑定</span>
        CompletableFuture.runAsync(() -&gt; {
            <span class="hljs-comment">// 绑定到当前异步线程</span>
            RequestContextHolder.setRequestAttributes(parentAttr, <span class="hljs-literal">true</span>);
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 异步线程中获取请求信息</span>
                <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest();
                log.info(<span class="hljs-string">"异步处理订单{}，请求IP：{}"</span>, orderId, request.getRemoteAddr());
                <span class="hljs-comment">// 业务逻辑：处理订单</span>
            } <span class="hljs-keyword">finally</span> {
                <span class="hljs-comment">// 必须清理，避免线程池复用导致内存泄漏</span>
                RequestContextHolder.resetRequestAttributes();
            }
        });
    }
}
</code></pre>
<h4 data-id="heading-27">方案2：全局配置（@Async 全局生效）</h4>
<p>自定义 <code>TaskDecorator</code>，让所有异步线程自动继承父线程上下文：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableAsync</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AsyncConfigurer</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Executor <span class="hljs-title function_">getAsyncExecutor</span><span class="hljs-params">()</span> {
        <span class="hljs-type">ThreadPoolTaskExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolTaskExecutor</span>();
        executor.setCorePoolSize(<span class="hljs-number">5</span>);
        executor.setMaxPoolSize(<span class="hljs-number">10</span>);
        executor.setQueueCapacity(<span class="hljs-number">20</span>);
        executor.setThreadNamePrefix(<span class="hljs-string">"async-"</span>);
        
        <span class="hljs-comment">// 核心：自定义TaskDecorator传递上下文</span>
        executor.setTaskDecorator(runnable -&gt; {
            <span class="hljs-comment">// 父线程上下文</span>
            <span class="hljs-type">RequestAttributes</span> <span class="hljs-variable">parentAttr</span> <span class="hljs-operator">=</span> RequestContextHolder.getRequestAttributes();
            <span class="hljs-keyword">return</span> () -&gt; {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-comment">// 子线程绑定上下文</span>
                    RequestContextHolder.setRequestAttributes(parentAttr, <span class="hljs-literal">true</span>);
                    runnable.run();
                } <span class="hljs-keyword">finally</span> {
                    <span class="hljs-comment">// 清理上下文</span>
                    RequestContextHolder.resetRequestAttributes();
                }
            };
        });
        
        executor.initialize();
        <span class="hljs-keyword">return</span> executor;
    }
}

<span class="hljs-comment">// 使用@Async时自动传递上下文</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-meta">@Async</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">asyncUpdateUser</span><span class="hljs-params">(Long userId)</span> {
        <span class="hljs-comment">// 直接获取上下文，无需手动绑定</span>
        <span class="hljs-type">RequestAttributes</span> <span class="hljs-variable">attributes</span> <span class="hljs-operator">=</span> RequestContextHolder.getRequestAttributes();
        <span class="hljs-type">String</span> <span class="hljs-variable">ip</span> <span class="hljs-operator">=</span> ((ServletRequestAttributes) attributes).getRequest().getRemoteAddr();
        log.info(<span class="hljs-string">"异步更新用户{}，IP：{}"</span>, userId, ip);
    }
}
</code></pre>
<h3 data-id="heading-28">场景4：自定义请求级上下文扩展</h3>
<p>基于 RequestAttributes 的 <code>setAttribute</code>/<code>getAttribute</code>，实现请求级别的数据传递，无需通过方法参数传递临时数据。</p>
<h4 data-id="heading-29">示例：请求级临时数据传递</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 自定义上下文工具类</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RequestDataContext</span> {
    <span class="hljs-comment">// 自定义属性KEY（避免冲突）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">KEY_TEMP_DATA</span> <span class="hljs-operator">=</span> <span class="hljs-string">"REQUEST_TEMP_DATA"</span>;

    <span class="hljs-comment">/**
     * 设置请求级临时数据
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setTempData</span><span class="hljs-params">(Object data)</span> {
        <span class="hljs-type">RequestAttributes</span> <span class="hljs-variable">attributes</span> <span class="hljs-operator">=</span> RequestContextHolder.currentRequestAttributes();
        attributes.setAttribute(KEY_TEMP_DATA, data, RequestAttributes.SCOPE_REQUEST);
    }

    <span class="hljs-comment">/**
     * 获取请求级临时数据
     */</span>
    <span class="hljs-meta">@SuppressWarnings("unchecked")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title function_">getTempData</span><span class="hljs-params">()</span> {
        <span class="hljs-type">RequestAttributes</span> <span class="hljs-variable">attributes</span> <span class="hljs-operator">=</span> RequestContextHolder.currentRequestAttributes();
        <span class="hljs-keyword">return</span> (T) attributes.getAttribute(KEY_TEMP_DATA, RequestAttributes.SCOPE_REQUEST);
    }
}

<span class="hljs-comment">// Controller中设置</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/order")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderController</span> {
    <span class="hljs-meta">@PostMapping("/create")</span>
    <span class="hljs-keyword">public</span> Result&lt;?&gt; createOrder(<span class="hljs-meta">@RequestBody</span> OrderDTO dto) {
        <span class="hljs-comment">// 设置请求级临时数据（无需传递给Service）</span>
        RequestDataContext.setTempData(dto.getOrderNo());
        orderService.createOrder(dto);
        <span class="hljs-keyword">return</span> Result.success();
    }
}

<span class="hljs-comment">// Service中获取</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(OrderDTO dto)</span> {
        <span class="hljs-comment">// 获取请求级临时数据（无需方法参数）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">orderNo</span> <span class="hljs-operator">=</span> RequestDataContext.getTempData();
        log.info(<span class="hljs-string">"创建订单：{}"</span>, orderNo);
        <span class="hljs-comment">// 业务逻辑</span>
        orderMapper.insert(dto);
    }
}
</code></pre>
<h3 data-id="heading-30">场景5：框架扩展（自定义 MVC 组件）</h3>
<p>自定义 Spring MVC 组件（如参数解析器、拦截器）时，通过 RequestContextHolder 获取上下文，兼容非 MVC 场景。</p>
<h4 data-id="heading-31">示例：自定义当前用户参数解析器</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 自定义注解：标记当前登录用户</span>
<span class="hljs-meta">@Target(ElementType.PARAMETER)</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> CurrentUser {
}

<span class="hljs-comment">// 参数解析器：自动解析当前登录用户</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CurrentUserArgumentResolver</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerMethodArgumentResolver</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">supportsParameter</span><span class="hljs-params">(MethodParameter parameter)</span> {
        <span class="hljs-keyword">return</span> parameter.hasParameterAnnotation(CurrentUser.class);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">resolveArgument</span><span class="hljs-params">(MethodParameter parameter, ModelAndViewContainer mavContainer,
                                  NativeWebRequest webRequest, WebDataBinderFactory binderFactory)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 方式1：从webRequest获取（MVC场景推荐）</span>
        <span class="hljs-comment">// HttpServletRequest request = (HttpServletRequest) webRequest.getNativeRequest();</span>
        
        <span class="hljs-comment">// 方式2：从RequestContextHolder获取（兼容非MVC场景）</span>
        <span class="hljs-type">RequestAttributes</span> <span class="hljs-variable">attributes</span> <span class="hljs-operator">=</span> RequestContextHolder.currentRequestAttributes();
        <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> ((ServletRequestAttributes) attributes).getRequest();
        
        <span class="hljs-comment">// 从Token解析用户信息</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">"Authorization"</span>);
        <span class="hljs-keyword">return</span> JwtUtil.parseUserInfo(token);
    }
}

<span class="hljs-comment">// 配置参数解析器</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebMvcConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebMvcConfigurer</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> CurrentUserArgumentResolver currentUserArgumentResolver;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addArgumentResolvers</span><span class="hljs-params">(List&lt;HandlerMethodArgumentResolver&gt; resolvers)</span> {
        resolvers.add(currentUserArgumentResolver);
    }
}

<span class="hljs-comment">// Controller中使用</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/user")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
    <span class="hljs-meta">@GetMapping("/info")</span>
    <span class="hljs-keyword">public</span> Result&lt;UserInfo&gt; <span class="hljs-title function_">getUserInfo</span><span class="hljs-params">(<span class="hljs-meta">@CurrentUser</span> UserInfo userInfo)</span> {
        <span class="hljs-keyword">return</span> Result.success(userInfo);
    }
}
</code></pre>
<h2 data-id="heading-32">五、使用 RequestContextHolder 的注意事项（避坑指南）</h2>
<h3 data-id="heading-33">1. 避免 ThreadLocal 内存泄漏</h3>
<ul>
<li><strong>原因</strong>：线程池复用线程时，未清理的上下文会长期占用内存，最终导致内存泄漏；</li>
<li><strong>解决方案</strong>：
<ul>
<li>自定义绑定场景（如 Filter、异步线程），必须在 <code>finally</code> 块调用 <code>resetRequestAttributes()</code>；</li>
<li>避免在单例 Bean（如 Service）中持有 <code>RequestAttributes</code> 引用（会导致上下文串用）。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-34">2. 异步/线程池场景的上下文传递</h3>
<ul>
<li><strong>问题</strong>：<code>InheritableThreadLocal</code> 仅在子线程<strong>创建时</strong>继承上下文，线程池复用线程时无效；</li>
<li><strong>解决方案</strong>：
<ul>
<li>零散异步场景：手动绑定+清理（方案1）；</li>
<li>全局异步场景：自定义 <code>TaskDecorator</code>（方案2）；</li>
<li>禁止依赖 <code>InheritableThreadLocal</code> 实现线程池上下文传递。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-35">3. 非 Web 场景的空指针问题</h3>
<ul>
<li><strong>问题</strong>：定时任务、消息队列消费、单元测试等非 Web 场景，<code>currentRequestAttributes()</code> 会抛异常；</li>
<li><strong>解决方案</strong>：
<ul>
<li>优先使用 <code>getRequestAttributes()</code>（返回 null），而非 <code>currentRequestAttributes()</code>；</li>
<li>增加非空判断，兼容非 Web 场景（如日志记录时跳过请求信息）。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-36">4. 微服务跨服务调用的上下文传递</h3>
<ul>
<li><strong>问题</strong>：RequestContextHolder 仅在当前服务线程有效，无法直接传递到下游服务；</li>
<li><strong>解决方案</strong>：
<ul>
<li>手动将核心上下文（如 Token、Tenant-ID）放入 HTTP 请求头，下游服务从请求头获取；</li>
<li>使用 Spring Cloud 的 <code>RequestContextInterceptor</code> 自动传递请求头；</li>
<li>下游服务接收请求后，手动绑定上下文到 RequestContextHolder。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-37">5. 性能优化</h3>
<ul>
<li><strong>问题</strong>：频繁调用 <code>getRequestAttributes()</code> 会触发 ThreadLocal.get()，有轻微性能损耗；</li>
<li><strong>解决方案</strong>：
<ul>
<li>单次方法调用中，仅获取一次上下文，复用对象；</li>
<li>Controller 层优先通过方法参数获取 <code>request</code>，无需通过 RequestContextHolder；</li>
<li>非必要场景，避免使用（如仅需获取请求参数，可通过 <code>@RequestParam</code> 直接接收）。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-38">六、总结</h2>
<p>RequestContextHolder 是 Spring MVC 上下文管理的核心工具，核心逻辑是<strong>基于 ThreadLocal 实现请求上下文的线程绑定与全链路获取</strong>，其价值在于解耦 Web 层与非 Web 层的上下文依赖。</p>
<h3 data-id="heading-39">核心要点</h3>
<ol>
<li>底层存储：双 ThreadLocal（普通 + 可继承），存储 <code>RequestAttributes</code>（核心实现 <code>ServletRequestAttributes</code>）；</li>
<li>核心方法：获取（<code>getRequestAttributes</code>/<code>currentRequestAttributes</code>）、绑定（<code>setRequestAttributes</code>）、重置（<code>resetRequestAttributes</code>）；</li>
<li>典型场景：非 Web 层获取 request、统一异常处理、异步上下文传递、自定义 MVC 组件、请求级数据传递；</li>
<li>避坑关键：及时清理上下文、兼容非 Web 场景、异步线程手动传递上下文。</li>
</ol>
<p>合理使用 RequestContextHolder 可大幅降低代码耦合，但需遵循“按需使用、及时清理”的原则，避免引入内存泄漏、上下文串用等问题。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring AI（二）：如何在使用的时候指定角色，使用模板]]></title>    <link>https://juejin.cn/post/7582601349579325440</link>    <guid>https://juejin.cn/post/7582601349579325440</guid>    <pubDate>2025-12-12T07:29:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582601349579325440" data-draft-id="7582769411992993844" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring AI（二）：如何在使用的时候指定角色，使用模板"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-12T07:29:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吃两碗吧"/> <meta itemprop="url" content="https://juejin.cn/user/2386352583739965"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring AI（二）：如何在使用的时候指定角色，使用模板
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2386352583739965/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吃两碗吧
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T07:29:47.000Z" title="Fri Dec 12 2025 07:29:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>Spring AI在调用的时候专门设置了一个 <code>Prompt</code>类，用来填写调用大模型的提示词。
可以分角色，用不同的信息调用</p>
</blockquote>
<hr/>
<p>主要角色包括：</p>
<ul>
<li>
<p>System 角色：指导 AI 的行为和响应风格，设定 AI 解释和回复输入的参数或规则，类似于在开始对话前向 AI 提供指令。</p>
</li>
<li>
<p>User 角色：代表用户的输入 — 包括问题、命令或对 AI 的陈述。该角色构成 AI 响应的基础，具有根本重要性。</p>
</li>
<li>
<p>Assistant 角色：AI 对用户输入的响应，不仅是答案或反应，更对维持对话流至关重要。通过追踪 AI 之前的响应（其 "Assistant Role" 消息），系统确保连贯且上下文相关的交互。助手消息也可能包含函数工具调用请求信息 — 这是 AI 的特殊功能，在需要时执行计算、获取数据等超越对话的特定任务。</p>
</li>
<li>
<p>Tool/Function 角色：专注于响应工具调用类助手消息，返回附加信息。</p>
</li>
</ul>
<p>而且可以提前设置好模版
模板中可以使用分隔符，用来设定调用过程中的话传参</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">PromptTemplate</span> <span class="hljs-variable">promptTemplate</span> <span class="hljs-operator">=</span> PromptTemplate.builder() .renderer(StTemplateRenderer.builder().startDelimiterToken(<span class="hljs-string">'&lt;'</span>)
.endDelimiterToken(<span class="hljs-string">'&gt;'</span>).build()) 
.template(<span class="hljs-string">""" Tell me the names of 5 movies whose soundtrack was composed by &lt;composer&gt;. """</span>) .build();

</code></pre>
<p>也可以使用默认的</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>  
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Config</span> {  
  
    <span class="hljs-meta">@Bean</span>  
    ChatClient <span class="hljs-title function_">chatClient</span><span class="hljs-params">(ChatClient.Builder builder)</span> {  
        <span class="hljs-keyword">return</span> builder.defaultSystem(<span class="hljs-string">"你是我的好朋友，你要以{voice}的语气跟我说话"</span>)  
                .build();  
    }  
  
}
</code></pre>
<p>其中defaultSystem 指的就是默认的系统角色设置的信息，一般都用来补充回答时角色的设定等信息。</p>
<p>调用方式支持<strong>Fluent API</strong>调用方式</p>
<pre><code class="hljs language-java" lang="java">        <span class="hljs-built_in">this</span>.chatClient.prompt()  
                .system(sp -&gt; sp.param(<span class="hljs-string">"voice"</span>, voice))  
                .user(message)  
                .call()  
                .content();
</code></pre>
<p>其中配置类</p>
<pre><code class="hljs language-java" lang="java">.system(sp -&gt; sp.param(<span class="hljs-string">"voice"</span>, voice))  

<span class="hljs-comment">//部门使用传参的方式，补充默认系统角色中提前设定的好的参数。</span>
</code></pre>
<p>这样即可调用完成~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue学习：ref响应式数据、v-指令、computed]]></title>    <link>https://juejin.cn/post/7582517824498925602</link>    <guid>https://juejin.cn/post/7582517824498925602</guid>    <pubDate>2025-12-12T07:14:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582517824498925602" data-draft-id="7582601349578899456" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue学习：ref响应式数据、v-指令、computed"/> <meta itemprop="keywords" content="Vue.js,面试,JavaScript"/> <meta itemprop="datePublished" content="2025-12-12T07:14:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="南山安"/> <meta itemprop="url" content="https://juejin.cn/user/1795929588117962"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue学习：ref响应式数据、v-指令、computed
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1795929588117962/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    南山安
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T07:14:46.000Z" title="Fri Dec 12 2025 07:14:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<blockquote>
<p>本文将带你从一个Todos清单组件，上手Vue基础语法以及核心思想，设计内容有ref响应式数据,v-指令、computed计算属性</p>
</blockquote>
<p><strong>完整代码：</strong></p>
<pre><code class="hljs language-js" lang="js">&lt;!-- <span class="hljs-title class_">App</span>.<span class="hljs-property">vue</span> --&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-comment">// 1. 响应式数据：所有 UI 都靠它们驱动</span>
<span class="hljs-keyword">const</span> title = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>)                     <span class="hljs-comment">// 输入框内容</span>
<span class="hljs-keyword">const</span> todos = <span class="hljs-title function_">ref</span>([
  { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'睡觉'</span>, <span class="hljs-attr">done</span>: <span class="hljs-literal">true</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'吃饭'</span>, <span class="hljs-attr">done</span>: <span class="hljs-literal">true</span> }
])

<span class="hljs-comment">// 添加任务</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">addTodo</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (!title.<span class="hljs-property">value</span>.<span class="hljs-title function_">trim</span>()) <span class="hljs-keyword">return</span>
  todos.<span class="hljs-property">value</span>.<span class="hljs-title function_">push</span>({
    <span class="hljs-attr">id</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>(),
    <span class="hljs-attr">title</span>: title.<span class="hljs-property">value</span>.<span class="hljs-title function_">trim</span>(),
    <span class="hljs-attr">done</span>: <span class="hljs-literal">false</span>
  })
  title.<span class="hljs-property">value</span> = <span class="hljs-string">''</span>                         <span class="hljs-comment">// 清空输入框</span>
}

<span class="hljs-comment">// 2. 计算属性：派生数据，自动更新</span>
<span class="hljs-comment">// 统计未完成的数量</span>
<span class="hljs-keyword">const</span> active = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> todos.<span class="hljs-property">value</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> !t.<span class="hljs-property">done</span>).<span class="hljs-property">length</span>
})

<span class="hljs-comment">// 全选/全不选的高级玩法</span>
<span class="hljs-keyword">const</span> allDone = <span class="hljs-title function_">computed</span>({
  <span class="hljs-title function_">get</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> todos.<span class="hljs-property">value</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span> &amp;&amp; todos.<span class="hljs-property">value</span>.<span class="hljs-title function_">every</span>(<span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> t.<span class="hljs-property">done</span>)
  },
  <span class="hljs-title function_">set</span>(<span class="hljs-params">val</span>) {
    todos.<span class="hljs-property">value</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> t.<span class="hljs-property">done</span> = val)
  }
})
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>我的 Todos 任务清单<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 双向绑定 + 回车添加 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"今天还要干啥？回车添加"</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"title"</span> @<span class="hljs-attr">keydown.enter</span>=<span class="hljs-string">"addTodo"</span> /&gt;</span>

    <span class="hljs-comment">&lt;!-- 任务列表 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"todos.length"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"todo in todos"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"todo.id"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"checkbox"</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"todo.done"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"{ done: todo.done }"</span>&gt;</span>{{ todo.title }}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-else</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"empty"</span>&gt;</span>暂无计划，摸鱼去吧～<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 统计 + 全选 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"footer"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"checkbox"</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"allDone"</span> /&gt;</span>
        全选
      <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>未完成 {{ active }} / 共 {{ todos.length }} 条<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.container</span> {
  <span class="hljs-attribute">max-width</span>: <span class="hljs-number">400px</span>;
  <span class="hljs-attribute">margin</span>: <span class="hljs-number">40px</span> auto;
  <span class="hljs-attribute">font-family</span>: sans-serif;
}

<span class="hljs-selector-tag">input</span><span class="hljs-selector-attr">[type=<span class="hljs-string">"text"</span>]</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">8px</span>;
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">16px</span>;
}

<span class="hljs-selector-tag">ul</span> {
  <span class="hljs-attribute">padding-left</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">list-style</span>: none;
}

<span class="hljs-selector-tag">li</span> {
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">8px</span> <span class="hljs-number">0</span>;
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">align-items</span>: center;
  <span class="hljs-attribute">gap</span>: <span class="hljs-number">8px</span>;
}

<span class="hljs-selector-class">.done</span> {
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#999</span>;
  <span class="hljs-attribute">text-decoration</span>: line-through;
}

<span class="hljs-selector-class">.empty</span> {
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#999</span>;
  <span class="hljs-attribute">text-align</span>: center;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
}

<span class="hljs-selector-class">.footer</span> {
  <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">20px</span>;
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">justify-content</span>: space-between;
  <span class="hljs-attribute">align-items</span>: center;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</span></code></pre>
<p><strong>实际展示：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/175dbb04cdac413abe60d765cbf5689d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2X5bGx5a6J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766128485&amp;x-signature=nnw1%2FzqVhdCRZF3yEMpU7XCDRdQ%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">一、拆解Vue代码</h2>
<p>其实Vue主界面的代码就是我们的HTML+JS+CSS,它是一个三明治结构</p>
<pre><code class="hljs language-javascript" lang="javascript">    &lt;script setup&gt;&lt;<span class="hljs-regexp">/script&gt;  /</span><span class="hljs-regexp">/JavaScript
    
    &lt;template&gt;&lt;/</span>template&gt;    <span class="hljs-comment">//HTML</span>

    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>   <span class="hljs-comment">//CSS</span>

</code></pre>
<h2 data-id="heading-2">二、 响应式数据：Vue 的灵魂</h2>
<p>传统写法（jQuery 时代）：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// 想改标题？先找 DOM 再改 innerText</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'h2'</span>).<span class="hljs-property">innerText</span> = <span class="hljs-string">'新标题'</span>
</code></pre>
<p>Vue 写法：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> title = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'Todos任务清单'</span>)
</code></pre>
<p>然后模板里直接 {{ title }}，你改 title.value = '新标题'，页面就自动变了。</p>
<p>为什么这么神奇？因为 Vue 把 todos、title 这些 ref 包装成了响应式对象，只要你通过 .value 去改它，Vue 就知道「有数据变了」，然后自动把所有用到这个数据的地方更新一遍。</p>
<p>记住一句话：<strong>在 Vue 里，你只需要操心数据怎么变，页面怎么变 Vue 帮你搞定</strong>。</p>
<h2 data-id="heading-3">三、 Vue 基础指令</h2>



































<table><thead><tr><th>指令</th><th>作用</th><th>本例中的用法</th></tr></thead><tbody><tr><td>v-model</td><td>双向绑定，表单专属神器</td><td>输入框和任务的 checkbox 都用了它</td></tr><tr><td>v-for</td><td>循环渲染数组</td><td>遍历 todos 渲染每一行</td></tr><tr><td>v-if / v-else</td><td>条件渲染</td><td>没任务时显示「暂无计划」</td></tr><tr><td>v-bind</td><td>动态绑定HTML属或者组件的props</td><td>完成的任务加上删除线和灰色</td></tr><tr><td>@click / @keydown.enter</td><td>事件监听简写</td><td>回车添加任务</td></tr></tbody></table>
<p>这些指令就是 Vue 给我们提供的「魔法语法糖」，让我们几乎不用写原生 DOM 操作。</p>
<h3 data-id="heading-4">1. <code>v-model</code> —— <strong>双向数据绑定</strong></h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"title"</span> @<span class="hljs-attr">keydown.enter</span>=<span class="hljs-string">"addTodo"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"checkbox"</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"todo.done"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"checkbox"</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"allDone"</span> /&gt;</span>
</code></pre>
<h4 data-id="heading-5">🔍 作用：</h4>
<ul>
<li>
<p><strong>自动同步表单输入和响应式数据</strong>。</p>
</li>
<li>
<p>对于 <code>&lt;input type="text"&gt;</code>：<br/>
<code>v-model="title"</code> 等价于：</p>
<pre><code class="hljs language-html" lang="html">:value="title" @input="title = $event.target.value"
</code></pre>
<p>用户输入 → <code>title.value</code> 自动更新；<code>title.value</code> 变化 → 输入框内容更新。</p>
</li>
<li>
<p>对于 <code>&lt;input type="checkbox"&gt;</code>：<br/>
<code>v-model="todo.done"</code> 绑定的是布尔值：</p>
<pre><code class="hljs language-html" lang="html">:checked="todo.done" @change="todo.done = $event.target.checked"
</code></pre>
</li>
<li>
<p>对于 <code>allDone</code>（计算属性）：<br/>
因为 <code>allDone</code> 有 <code>get</code> 和 <code>set</code>，所以 <code>v-model</code> 能读也能写，实现“全选”联动。</p>
</li>
</ul>
<hr/>
<h3 data-id="heading-6">🔄 2. <code>v-for</code> —— <strong>列表渲染</strong></h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"todo in todos"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"todo.id"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"checkbox"</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"todo.done"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"{ done: todo.done }"</span>&gt;</span>{{ todo.title }}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
</code></pre>
<h4 data-id="heading-7">🔍 作用：</h4>
<ul>
<li>遍历数组（或对象），为每个元素生成一个 DOM 节点。</li>
<li><code>todo in todos</code>：<code>todos</code> 是源数组，<code>todo</code> 是当前项。</li>
<li><strong>必须加 <code>:key</code></strong>：Vue 用 <code>key</code> 来高效追踪每个节点的身份（避免复用错误）。你用了 <code>todo.id</code>，很好！</li>
</ul>
<h4 data-id="heading-8">⚠️ 注意：</h4>
<ul>
<li>不要使用 <code>index</code> 作为 <code>key</code>（除非列表只增不删），否则可能引发状态错乱。</li>
<li><code>v-for</code> 的优先级高于 <code>v-if</code>（如果同时用），但一般建议避免两者同用。</li>
</ul>
<hr/>
<h3 data-id="heading-9">3. <code>v-if</code> 与 <code>v-else</code> —— <strong>条件渲染</strong></h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"todos.length"</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 渲染任务列表 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-else</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"empty"</span>&gt;</span>暂无计划，摸鱼去吧～<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<h4 data-id="heading-10">🔍 作用：</h4>
<ul>
<li><code>v-if="todos.length"</code>：当 <code>todos.length &gt; 0</code>（真值）时，渲染 <code>&lt;ul&gt;</code>。</li>
<li><code>v-else</code>：必须紧跟在 <code>v-if</code> 或 <code>v-else-if</code> 后面，表示“否则”。</li>
<li><strong>完全销毁/重建 DOM</strong>（不是隐藏），适合切换不频繁的场景。</li>
</ul>
<h4 data-id="heading-11">💡 对比 <code>v-show</code>：</h4>
<ul>
<li><code>v-show</code> 是通过 CSS <code>display: none</code> 切换，DOM 始终存在。</li>
<li>你的场景用 <code>v-if/v-else</code> 更合适，因为“空状态”和“有任务”是互斥的两种 UI。</li>
</ul>
<hr/>
<h3 data-id="heading-12">4. <code>v-bind</code>（简写 <code>:</code>）—— <strong>动态绑定属性</strong></h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"{ done: todo.done }"</span>&gt;</span>{{ todo.title }}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"todo in todos"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"todo.id"</span>&gt;</span>
</code></pre>
<h4 data-id="heading-13">🔍 作用：</h4>
<ul>
<li>将 HTML 属性（如 <code>class</code>、<code>id</code>、<code>src</code>、<code>key</code> 等）<strong>绑定到 JS 表达式</strong>。</li>
<li><code>:class="{ done: todo.done }"</code>：<br/>
当 <code>todo.done === true</code> 时，给 <code>&lt;span&gt;</code> 添加 <code>class="done"</code>，从而应用样式（删除线+灰色）。</li>
<li><code>:key="todo.id"</code>：将 <code>key</code> 属性绑定到 <code>todo.id</code> 的值。</li>
</ul>
<h4 data-id="heading-14">💡 其他常见用法：</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">:src</span>=<span class="hljs-string">"imageUrl"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">:style</span>=<span class="hljs-string">"{ color: textColor }"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">:href</span>=<span class="hljs-string">"linkUrl"</span>&gt;</span>链接<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
</code></pre>
<blockquote>
<p><code>v-bind</code> 是 Vue 实现“数据驱动视图”的关键桥梁。</p>
</blockquote>
<hr/>
<h3 data-id="heading-15">5. <code>@</code>（即 <code>v-on</code>）—— <strong>事件监听</strong></h3>
<h4 data-id="heading-16">✅ 在你的代码中：</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">...</span> @<span class="hljs-attr">keydown.enter</span>=<span class="hljs-string">"addTodo"</span> /&gt;</span>
</code></pre>
<h4 data-id="heading-17">🔍 作用：</h4>
<ul>
<li>
<p>监听 DOM 事件，并执行方法。</p>
</li>
<li>
<p><code>@keydown.enter</code> 是修饰符写法，等价于：</p>
<pre><code class="hljs language-js" lang="js">@keydown=<span class="hljs-string">"(e) =&gt; { if (e.key === 'Enter') addTodo() }"</span>
</code></pre>
</li>
<li>
<p>常见修饰符：</p>
<ul>
<li><code>.enter</code>：回车键</li>
<li><code>.stop</code>：阻止事件冒泡</li>
<li><code>.prevent</code>：阻止默认行为</li>
<li><code>.once</code>：只触发一次</li>
</ul>
</li>
</ul>
<h4 data-id="heading-18">💡 其他例子：</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"deleteTodo(id)"</span>&gt;</span>删除<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">input</span> @<span class="hljs-attr">input</span>=<span class="hljs-string">"handleInput"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">form</span> @<span class="hljs-attr">submit.prevent</span>=<span class="hljs-string">"handleSubmit"</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>
</code></pre>
<blockquote>
<p><code>@</code> 是 <code>v-on:</code> 的缩写，就像 <code>:</code> 是 <code>v-bind:</code> 的缩写。</p>
</blockquote>
<hr/>
<h4 data-id="heading-19">总结:</h4>
<ol>
<li>
<p>用户在输入框输入 → <code>v-model</code> 同步到 <code>title</code></p>
</li>
<li>
<p>按回车 → <code>@keydown.enter</code> 触发 <code>addTodo()</code> → 新任务加入 <code>todos</code></p>
</li>
<li>
<p><code>v-for</code> 重新遍历 <code>todos</code>，渲染新 <code>&lt;li&gt;</code></p>
</li>
<li>
<p>每个任务的复选框用 <code>v-model</code> 双向绑定 <code>todo.done</code></p>
</li>
<li>
<p>勾选复选框 → <code>todo.done</code> 更新 →</p>
<ul>
<li><code>active</code> 计算属性自动更新（未完成数）</li>
<li><code>allDone.get()</code> 重新计算（是否全选）</li>
</ul>
</li>
<li>
<p>底部全选框用 <code>v-model="allDone"</code> → 点击时调用 <code>allDone.set()</code> → 批量更新所有 <code>todo.done</code></p>
</li>
<li>
<p>如果 <code>todos</code> 为空 → <code>v-if</code> 切换到 <code>v-else</code> 显示“摸鱼”提示</p>
</li>
</ol>
<h3 data-id="heading-20">四、 computed 计算属性：自动缓存的派生数据</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e8ec1d60966f4d1a8c966c93c2a9fea9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2X5bGx5a6J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766128485&amp;x-signature=pXFs3JkKQ3uLkSBPIYWKY%2BtFOMc%3D" alt="image.png" loading="lazy"/></p>
<p>我们想显示「未完成的任务有几条」，最笨的写法是：</p>
<pre><code class="hljs language-Vue" lang="Vue">{{ todos.filter(t =&gt; !t.done).length }} / {{ todos.length }}
</code></pre>
<p>这样每次渲染都会重新 filter 一遍，数据一大就废。</p>
<p>聪明做法：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> active = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> 
  todos.<span class="hljs-property">value</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> !t.<span class="hljs-property">done</span>).<span class="hljs-property">length</span>
)
</code></pre>
<p><strong>computed 有两大杀招：</strong></p>
<ol>
<li>缓存：只有当 todos 真的变了，它才会重新计算</li>
<li>响应式：todos 一变，页面上所有用了 active 的地方立刻更新</li>
</ol>
<p><strong>更牛的全选 checkbox：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/193dd13ae16b42069efab500bd0127fc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2X5bGx5a6J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766128485&amp;x-signature=or2brkFxHAek3vnxo3Ocx7lYc4Y%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> allDone = <span class="hljs-title function_">computed</span>({
  <span class="hljs-title function_">get</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> todos.<span class="hljs-property">value</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span> &amp;&amp; todos.<span class="hljs-property">value</span>.<span class="hljs-title function_">every</span>(<span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> t.<span class="hljs-property">done</span>)
  },
  <span class="hljs-title function_">set</span>(<span class="hljs-params">val</span>) {
    todos.<span class="hljs-property">value</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> t.<span class="hljs-property">done</span> = val)
  }
})
</code></pre>
<p>这样 <input type="checkbox" disabled="disabled"/> 就能实现「全选/全不选」双向功能，代码量少到令人发指。</p>
<p>在 Vue 3 的 <code>computed</code> 中，<strong><code>get</code> 和 <code>set</code> 是用于定义「可读写计算属性」的两个函数</strong>。默认情况下，<code>computed</code> 只有一个 <code>getter</code>（即只读），但当你需要让计算属性也能被赋值（比如用在 <code>v-model</code> 中），就需要提供一个 <code>setter</code>（即 <code>set</code> 函数）。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> myComputed = <span class="hljs-title function_">computed</span>({
  <span class="hljs-title function_">get</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 返回派生值（必须）</span>
    <span class="hljs-keyword">return</span> someDerivedValue
  },
  <span class="hljs-title function_">set</span>(<span class="hljs-params">newValue</span>) {
    <span class="hljs-comment">// 处理赋值逻辑（可选）</span>
    <span class="hljs-comment">// 根据 newValue 更新原始数据</span>
  }
})
</code></pre>
<h4 data-id="heading-21"><code>get()</code> —— <strong>读取时触发</strong></h4>
<ul>
<li>当你在模板中使用 <code>{{ myComputed }}</code>，或在 JS 中读取 <code>myComputed.value</code> 时，会调用 <code>get()</code>。</li>
<li>它应该<strong>返回一个值</strong>，这个值通常基于其他响应式数据（如 <code>ref</code> 或 <code>reactive</code> 对象）计算而来。</li>
<li>Vue 会自动追踪 <code>get()</code> 内部访问的所有响应式依赖，并在它们变化时<strong>重新计算</strong>。</li>
</ul>
<h4 data-id="heading-22"> <code>set(newValue)</code> —— <strong>赋值时触发</strong></h4>
<ul>
<li>当你执行 <code>myComputed.value = someValue</code>（例如通过 <code>v-model</code>），就会调用 <code>set(newValue)</code>。</li>
<li><code>newValue</code> 就是你试图赋给计算属性的值。</li>
<li>在 <code>set</code> 中，你<strong>不能直接修改计算属性本身</strong>（因为它没有存储空间），而是要<strong>反向更新它所依赖的原始数据</strong>。</li>
</ul>
<h2 data-id="heading-23">五、 Vue 开发的核心思维转变</h2>





















<table><thead><tr><th>传统开发（操作 DOM）</th><th>Vue 开发（操作数据）</th></tr></thead><tbody><tr><td>想加一条任务 → appendChild 一个 li</td><td>想加一条任务 → todos.push(新对象)</td></tr><tr><td>想改标题 → getElementById().innerText = xxx</td><td>想改标题 → title.value = '新标题'</td></tr><tr><td>想全选 → 遍历所有 checkbox 打钩</td><td>想全选 → allDone = true</td></tr></tbody></table>
<p>你看，Vue 让我们彻底从「操作页面元素」变成了「操作数据」，代码更清晰、更容易维护、也更好测试。</p>
<h3 data-id="heading-24">最后总结：</h3>
<ul>
<li>ref 响应式数据（核心核心）</li>
<li>v-model 双向绑定（表单必备）</li>
<li>v-for / v-if 指令（模板必备）</li>
<li>computed 计算属性（性能+优雅）</li>
<li>Composition API 的 script setup（现代写法）</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[企业级全栈 RBAC 实战 (11)：菜单管理与无限层级树形表格]]></title>    <link>https://juejin.cn/post/7582533464245354530</link>    <guid>https://juejin.cn/post/7582533464245354530</guid>    <pubDate>2025-12-12T07:14:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582533464245354530" data-draft-id="7582517824498860066" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="企业级全栈 RBAC 实战 (11)：菜单管理与无限层级树形表格"/> <meta itemprop="keywords" content="Vue.js,前端框架,前端工程化"/> <meta itemprop="datePublished" content="2025-12-12T07:14:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小胖霞"/> <meta itemprop="url" content="https://juejin.cn/user/3790771822016301"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            企业级全栈 RBAC 实战 (11)：菜单管理与无限层级树形表格
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3790771822016301/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小胖霞
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T07:14:11.000Z" title="Fri Dec 12 2025 07:14:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>摘要</strong>：系统如何管理它自己的菜单？这是一个经典的“先有鸡还是先有蛋”的问题。本文将介绍如何通过数据库初始化解决冷启动问题，并深入讲解如何利用 Element Plus 的树形表格展示无限层级数据，以及如何实现“目录、菜单、按钮”三种类型的动态表单交互。</p>
<h3 data-id="heading-0">一、 引言：先有鸡还是先有蛋？</h3>
<p>在前面的文章中，我们实现了<strong>动态路由</strong>，前端的菜单是根据数据库里的 sys_menus 表自动生成的。</p>
<p>现在问题来了：我们想要在页面上通过图形化界面来新增、修改菜单，但是数据库里如果没有“菜单管理”这个页面，我们就进不去这个功能。这就是典型的系统**自举（Bootstrapping）**问题。</p>
<p>本篇的核心任务：</p>
<ol>
<li><strong>数据初始化</strong>：手动 SQL 插入第一条数据，打破僵局。</li>
<li><strong>树形表格</strong>：不用递归组件，利用 el-table 原生特性展示树数据。</li>
<li><strong>动态表单</strong>：根据是“目录”还是“按钮”，动态控制表单项的显示与校验。</li>
</ol>
<h3 data-id="heading-1">二、 数据库与初始化：打破僵局</h3>
<p>在开发任何 CRUD 功能之前，先确保数据库结构支持我们的业务需求（如缓存控制、显隐控制）。</p>
<h4 data-id="heading-2">. 表结构确认</h4>
<p>除了基础的 path 和 component，我们需要重点关注 菜单类型 type：</p>
<ul>
<li><strong>M (Directory)</strong> : 目录。有路由地址，无组件路径（通常是 Layout），不显示在内容区，只展开子菜单。</li>
<li><strong>C (Menu)</strong> : 菜单。有路由，有组件，是真正的页面。</li>
<li><strong>F (Button)</strong> : 按钮。无路由，无组件，只用于控制页面内的按钮权限（如 system:user:add）。</li>
</ul>
<h4 data-id="heading-3">2. 初始化 SQL (种子数据)</h4>
<p>我们需要手动插入“菜单管理”本身，并把它分配给超级管理员。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 1. 插入菜单管理页面 (作为系统管理的子菜单)</span>
<span class="hljs-comment">-- 假设系统管理 ID=1</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `sys_menus` 
(`parent_id`, `menu_name`, `path`, `component`, `perms`, `icon`, `type`, `hidden`, `sort`) 
<span class="hljs-keyword">VALUES</span> 
(<span class="hljs-number">1</span>, <span class="hljs-string">'菜单管理'</span>, <span class="hljs-string">'menu'</span>, <span class="hljs-string">'system/menu/index'</span>, <span class="hljs-string">'system:menu:list'</span>, <span class="hljs-string">'list'</span>, <span class="hljs-string">'C'</span>, <span class="hljs-number">0</span>, <span class="hljs-number">3</span>);

<span class="hljs-comment">-- 2. 给角色分配权限 (Role ID = 1)</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `sys_role_menus` (`role_id`, `menu_id`) 
<span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, (<span class="hljs-keyword">SELECT</span> id <span class="hljs-keyword">FROM</span> sys_menus <span class="hljs-keyword">WHERE</span> path<span class="hljs-operator">=</span><span class="hljs-string">'menu'</span> LIMIT <span class="hljs-number">1</span>));
</code></pre>
<p>执行完这条 SQL，刷新页面，侧边栏就会神奇地出现“菜单管理”了。</p>
<h3 data-id="heading-4">三、 后端实现：逻辑校验与树形组装</h3>
<p>后端除了常规的 CRUD，主要有两个逻辑点：<strong>列表转树</strong> 和 <strong>删除保护</strong>。</p>
<h4 data-id="heading-5">1. 列表接口 (GET /menu/list)</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// routes/menu.js</span>
router.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/list'</span>, authMiddleware, <span class="hljs-keyword">async</span> (req, res, next) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> { menuName, status } = req.<span class="hljs-property">query</span>
    <span class="hljs-keyword">let</span> sql = <span class="hljs-string">'SELECT * FROM sys_menus WHERE 1=1'</span>
    <span class="hljs-keyword">let</span> params = []

    <span class="hljs-comment">// ... 拼接查询条件 ...</span>
    
    <span class="hljs-keyword">const</span> [rows] = <span class="hljs-keyword">await</span> pool.<span class="hljs-title function_">query</span>(sql, params)
    
    <span class="hljs-comment">// 【关键】将扁平数组转换为树形结构</span>
    <span class="hljs-comment">// 这里的 buildTree 与之前动态路由使用的是同一个辅助函数</span>
    <span class="hljs-keyword">const</span> list = <span class="hljs-title function_">buildTree</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(rows)))

    res.<span class="hljs-title function_">json</span>({ <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>, <span class="hljs-attr">data</span>: list })
  } <span class="hljs-keyword">catch</span> (err) { <span class="hljs-title function_">next</span>(err) }
})
</code></pre>
<h3 data-id="heading-6">四、 前端实现：树形表格与动态表单</h3>
<h4 data-id="heading-7">1. 树形表格 (el-table)</h4>
<p>Element Plus 的 Table 组件自带树形展示功能，只需配置 row-key 和 tree-props。</p>
<pre><code class="hljs language-vue" lang="vue">&lt;el-table
  :data="menuList"
  row-key="id" 
  border
  :tree-props="{ children: 'children', hasChildren: 'hasChildren' }"
&gt;
  &lt;el-table-column prop="menu_name" label="菜单名称" width="160" /&gt;
  
  &lt;!-- 动态图标展示 --&gt;
  &lt;el-table-column prop="icon" label="图标" align="center" width="60"&gt;
    &lt;template #default="{ row }"&gt;
      &lt;el-icon v-if="row.icon"&gt;
        &lt;component :is="row.icon" /&gt;
      &lt;/el-icon&gt;
    &lt;/template&gt;
  &lt;/el-table-column&gt;
  
  &lt;el-table-column prop="perms" label="权限标识" /&gt;
  &lt;el-table-column prop="component" label="组件路径" /&gt;
  
  &lt;!-- 状态展示 --&gt;
  &lt;el-table-column prop="hidden" label="状态" width="80"&gt;
    &lt;template #default="{ row }"&gt;
      &lt;el-tag v-if="row.hidden === 0" type="success"&gt;显示&lt;/el-tag&gt;
      &lt;el-tag v-else type="info"&gt;隐藏&lt;/el-tag&gt;
    &lt;/template&gt;
  &lt;/el-table-column&gt;
&lt;/el-table&gt;
</code></pre>
<ul>
<li><strong>row-key="id"</strong> : 告诉表格每行的唯一标识，这是折叠展开的关键。</li>
<li><strong>tree-props</strong>: 告诉表格子节点在哪个字段里（默认是 children）。</li>
</ul>
<h4 data-id="heading-8">2. 动态表单交互 (核心亮点)</h4>
<p>在“新增/修改”弹窗中，我们需要根据 type 的不同，动态控制表单项的<strong>显示/隐藏</strong>和<strong>校验规则</strong>。</p>
<ul>
<li><strong>目录 (M)</strong> : 需要路由地址，不需要组件路径。</li>
<li><strong>菜单 (C)</strong> : 需要路由地址 + 组件路径。</li>
<li><strong>按钮 (F)</strong> : 只需要权限字符，不需要路由和组件。</li>
</ul>
<pre><code class="hljs language-vue" lang="vue">&lt;el-form ref="menuFormRef" :model="form" :rules="rules" label-width="100px"&gt;
  
  &lt;!-- 上级菜单选择：使用 TreeSelect 组件 --&gt;
  &lt;el-form-item label="上级菜单"&gt;
    &lt;el-tree-select
      v-model="form.parentId"
      :data="menuOptions"
      :props="{ value: 'id', label: 'label', children: 'children' }"
      check-strictly
    /&gt;
  &lt;/el-form-item&gt;

  &lt;!-- 类型切换 --&gt;
  &lt;el-form-item label="菜单类型" prop="menuType"&gt;
    &lt;el-radio-group v-model="form.menuType"&gt;
      &lt;el-radio value="M"&gt;目录&lt;/el-radio&gt;
      &lt;el-radio value="C"&gt;菜单&lt;/el-radio&gt;
      &lt;el-radio value="F"&gt;按钮&lt;/el-radio&gt;
    &lt;/el-radio-group&gt;
  &lt;/el-form-item&gt;

  &lt;!-- 动态逻辑 v-if --&gt;
  &lt;el-form-item label="路由地址" prop="path" v-if="form.menuType !== 'F'"&gt;
    &lt;el-input v-model="form.path" /&gt;
  &lt;/el-form-item&gt;

  &lt;el-form-item label="组件路径" prop="component" v-if="form.menuType === 'C'"&gt;
    &lt;el-input v-model="form.component" placeholder="views下的路径" /&gt;
  &lt;/el-form-item&gt;

  &lt;el-form-item label="权限字符" v-if="form.menuType !== 'M'"&gt;
    &lt;el-input v-model="form.perms" placeholder="system:user:add" /&gt;
  &lt;/el-form-item&gt;
  
  &lt;!-- ... 其他通用项 ... --&gt;
&lt;/el-form&gt;
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a7b3f5f449247c5b9c20edb02341a34~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6IOW6Zye:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766128451&amp;x-signature=glgL6QI9BF9VIpOhWXP1Lyxmb7g%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-9">3. 构建上级菜单下拉树</h4>
<p>在选择“上级菜单”时，我们需要展示一个树形下拉框。这里有个小技巧：<strong>我们需要在数据顶层手动添加一个“主类目”节点</strong>，否则用户无法将菜单创建为一级菜单。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">getTreeselect</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">listMenu</span>({}); <span class="hljs-comment">// 复用列表接口</span>
  <span class="hljs-comment">// 手动构造根节点</span>
  <span class="hljs-keyword">const</span> menu = { <span class="hljs-attr">id</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">label</span>: <span class="hljs-string">'主类目'</span>, <span class="hljs-attr">children</span>: [] };
  
  <span class="hljs-comment">// 简单的字段映射 (menu_name -&gt; label)</span>
  menu.<span class="hljs-property">children</span> = res.<span class="hljs-property">data</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">node</span> =&gt;</span> <span class="hljs-title function_">mapTreeSelect</span>(node));
  
  menuOptions.<span class="hljs-property">value</span> = [menu];
};
</code></pre>
<p>通过本篇，我们完成了 RBAC 系统管理的最后一块拼图——<strong>菜单管理</strong>。<br/>
现在，你可以直接在页面上配置新的路由，设置图标，定义权限，无需修改一行代码，刷新页面即可生效。这标志着我们的系统具备了<strong>动态扩展能力</strong></p>
<p>但是，我们在菜单里配置了 <code>system:user:add</code> 这种权限标识，它到底有什么用？前端如何利用它来控制按钮的显示和隐藏？</p>
<p><strong>下一篇：《全栈 RBAC 实战 (12)：操作日志与按钮级别权限》</strong> ，我们将深入 Vue 3 自定义指令的实现原理，实现细粒度的按钮级权限控制，并顺带搞定操作日志记录。</p>
<h2 data-id="heading-10">具备完整功能后台管理系统的代码仓库：</h2>
<p>感谢大家的star</p>
<p>前端：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fchen_pengchao%2Famdin-tempalte" target="_blank" title="https://gitee.com/chen_pengchao/amdin-tempalte" ref="nofollow noopener noreferrer">前端</a></p>
<p>后端：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fchen_pengchao%2Fadmin-node" target="_blank" title="https://gitee.com/chen_pengchao/admin-node" ref="nofollow noopener noreferrer">后端</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[活动报名 | Apache Spark Meetup · 上海站，助力企业构建高效数据平台]]></title>    <link>https://juejin.cn/post/7582517824499154978</link>    <guid>https://juejin.cn/post/7582517824499154978</guid>    <pubDate>2025-12-12T07:51:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582517824499154978" data-draft-id="7582601349579358208" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="活动报名 | Apache Spark Meetup · 上海站，助力企业构建高效数据平台"/> <meta itemprop="keywords" content="Spark"/> <meta itemprop="datePublished" content="2025-12-12T07:51:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云大数据AI技术"/> <meta itemprop="url" content="https://juejin.cn/user/2414974667341287"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            活动报名 | Apache Spark Meetup · 上海站，助力企业构建高效数据平台
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2414974667341287/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云大数据AI技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T07:51:01.000Z" title="Fri Dec 12 2025 07:51:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在大数据技术飞速发展的今天，如何在性能与成本效益之间实现平衡，始终是企业构建数据平台的核心挑战之一。阿里云 EMR Serverless Spark 作为一款面向 Data+AI 的高性能 Lakehouse 产品，凭借其内置的 Fusion 2.0（企业级 Spark 内核），为企业提供了一站式的企业级数据平台服务方案。</p>
<p>2025年9月，EMR Serverless Spark（Fusion 2.0 内核）结合 DLF（阿里云数据湖构建）以 QphDS 性能评分达到 6568 万分以上的优异成绩，斩获 TPC-DS 100T 测试全球榜首。TPC-DS 是数据仓库领域全球权威基准测试之一，其测试场景全面模拟了复杂查询、多维分析、数据聚合等真实企业级数据分析负载，对数据处理引擎的性能和扩展性提出了极高要求。此次夺冠不仅彰显了 EMR Serverless Spark 在超大规模数据处理场景中的卓越性能，更体现了其在极致性能与成本控制之间实现高效平衡的技术实力。</p>
<p>为了帮助企业更好地构建高效数据平台，阿里云 EMR 团队特别策划并举办本次线下 Meetup，深入解析 EMR Serverless Spark Fusion 2.0 登顶背后的创新技术与优化策略。活动特别邀请流利说技术专家，分享 EMR Serverless Spark 在企业级场景中的最佳实践。同时，DataWorks 高级技术专家也将亲临现场，详细解读其与 EMR Serverless Spark 的深度协同能力，为企业提供更高效、更智能的数据处理解决方案，以及如何结合 DataWorks 的多源数据高效入湖与智能化调度方案，实现从非结构化数据采集、存储、治理到分析应用的全生命周期管理闭环。此外，我们还荣幸地邀请到了 AMD 高级解决方案架构师，现场分享 AMD 在阿里云 EMR Serverless Spark 中的创新应用，包括硬件加速、资源调度优化等技术细节，深入探讨如何通过软硬件结合进一步提升数据处理效率与性能表现。</p>
<p>通过此次 Meetup，企业不仅能够全面了解 EMR Serverless Spark 的技术优势和应用场景，还能深入掌握其与 DataWorks 和 AMD 技术的协同价值，为企业在数据驱动的业务场景中构建高效、智能的数据平台提供重要参考与实践指导。</p>
<p><strong>活动时间：2025 年 12 月 20 日，13:30-17:00</strong></p>
<p><strong>活动地点：上海 · 阿里巴巴徐汇滨江园区</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhd.aliyun.com%2Fform%2F7156" target="_blank" title="https://hd.aliyun.com/form/7156" ref="nofollow noopener noreferrer"><strong>点此报名</strong></a></p>
<h3 data-id="heading-0">活动议程</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/acd424988d0b4ff5902332b11891ba9a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766130661&amp;x-signature=wfWV9efHQYf2Sw0g7NjcMw3ZamU%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 中 CSS Modules 详解]]></title>    <link>https://juejin.cn/post/7582533464245731362</link>    <guid>https://juejin.cn/post/7582533464245731362</guid>    <pubDate>2025-12-12T08:01:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582533464245731362" data-draft-id="7582517824499220514" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 中 CSS Modules 详解"/> <meta itemprop="keywords" content="前端,CSS"/> <meta itemprop="datePublished" content="2025-12-12T08:01:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="三年三月"/> <meta itemprop="url" content="https://juejin.cn/user/694547078186440"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 中 CSS Modules 详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547078186440/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    三年三月
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T08:01:44.000Z" title="Fri Dec 12 2025 08:01:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">React 中 CSS Modules 详解</h2>
<h3 data-id="heading-1">1. 什么是 React 中的 CSS Modules</h3>
<p>CSS Modules 是一种用于解决 CSS 命名冲突问题的模块化方案，它允许在 React 组件中使用局部作用域的 CSS 类名。在 CSS Modules 中，所有的类名默认都是局部作用域的，这意味着它们只在导入该 CSS 文件的组件中有效，不会影响其他组件。</p>
<p>CSS Modules 不是 React 特有的功能，它是一种通用的 CSS 模块化解决方案，可以与任何支持 ES Modules 的构建工具（如 Webpack、Rollup 等）一起使用。在 React 生态系统中，CSS Modules 是一种非常流行的样式管理方式。</p>
<h3 data-id="heading-2">2. 为什么在 React 中使用 CSS Modules</h3>
<p>在 React 中使用 CSS Modules 主要是为了解决传统 CSS 的一些问题：</p>
<h4 data-id="heading-3">2.1 解决类名冲突问题</h4>
<p>传统的 CSS 是全局作用域的，这意味着当多个组件使用相同的类名时，会发生样式冲突。</p>
<p><strong>传统 CSS 的问题示例：</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* Button.css */</span>
<span class="hljs-selector-class">.button</span> {
  <span class="hljs-attribute">background-color</span>: blue;
  <span class="hljs-attribute">color</span>: white;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">8px</span> <span class="hljs-number">16px</span>;
}

<span class="hljs-comment">/* PrimaryButton.css */</span>
<span class="hljs-selector-class">.button</span> {
  <span class="hljs-attribute">background-color</span>: red;
  <span class="hljs-attribute">color</span>: white;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">8px</span> <span class="hljs-number">16px</span>;
}
</code></pre>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// Button.js</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'./Button.css'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">Button</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"button"</span>&gt;</span>普通按钮<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>;
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Button</span>;

<span class="hljs-comment">// PrimaryButton.js</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'./PrimaryButton.css'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">PrimaryButton</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"button"</span>&gt;</span>主要按钮<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>;
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">PrimaryButton</span>;

<span class="hljs-comment">// App.js</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Button</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./Button'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">PrimaryButton</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./PrimaryButton'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> /&gt;</span> {/* 这里的按钮样式会被 PrimaryButton.css 覆盖 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">PrimaryButton</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">App</span>;
</code></pre>
<p>在上面的示例中，由于两个组件都使用了 <code>.button</code> 类名，后导入的 PrimaryButton.css 会覆盖 Button.css 中的样式，导致两个按钮都显示为红色。</p>
<h4 data-id="heading-4">2.2 避免样式污染</h4>
<p>使用 CSS Modules 可以确保组件的样式不会影响其他组件，避免样式污染。</p>
<h4 data-id="heading-5">2.3 提高代码可维护性</h4>
<p>CSS Modules 使得样式与组件紧密耦合，提高了代码的可维护性。当需要修改某个组件的样式时，只需要修改对应的 CSS 文件即可，不需要担心影响其他组件。</p>
<h3 data-id="heading-6">3. React 中 CSS Modules 的基本使用方法</h3>
<h4 data-id="heading-7">3.1 创建 CSS Modules 文件</h4>
<p>CSS Modules 文件的命名方式通常是 <code>.module.css</code>，例如 <code>Button.module.css</code>。</p>
<h4 data-id="heading-8">3.2 导入和使用 CSS Modules</h4>
<p>在 React 组件中，可以使用 ES Modules 的方式导入 CSS Modules 文件，然后通过对象的方式访问其中的类名。</p>
<p><strong>基本使用示例：</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* Button.module.css */</span>
<span class="hljs-selector-class">.button</span> {
  <span class="hljs-attribute">background-color</span>: blue;
  <span class="hljs-attribute">color</span>: white;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">8px</span> <span class="hljs-number">16px</span>;
  <span class="hljs-attribute">border</span>: none;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>;
  <span class="hljs-attribute">cursor</span>: pointer;
}

<span class="hljs-selector-class">.primary</span> {
  <span class="hljs-attribute">background-color</span>: red;
}
</code></pre>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// Button.js</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> styles <span class="hljs-keyword">from</span> <span class="hljs-string">'./Button.module.css'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">Button</span> = (<span class="hljs-params">{ primary, children }</span>) =&gt; {
  <span class="hljs-keyword">const</span> buttonClass = primary ? <span class="hljs-string">`<span class="hljs-subst">${styles.button}</span> <span class="hljs-subst">${styles.primary}</span>`</span> : styles.<span class="hljs-property">button</span>;
  
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{buttonClass}</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>;
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Button</span>;

<span class="hljs-comment">// App.js</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Button</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./Button'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Button</span>&gt;</span>普通按钮<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">primary</span>&gt;</span>主要按钮<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">App</span>;
</code></pre>
<p>在上面的示例中，CSS Modules 会自动将类名转换为唯一的标识符，例如 <code>.button</code> 可能会被转换为 <code>.Button_button__1a2b3c</code>，这样就避免了类名冲突。</p>
<h3 data-id="heading-9">4. CSS Modules 的原理</h3>
<p>CSS Modules 的工作原理主要包括以下几个步骤：</p>
<ol>
<li><strong>解析 CSS 文件</strong>：构建工具（如 Webpack）的 CSS Modules 插件会解析 <code>.module.css</code> 文件。</li>
<li><strong>生成唯一类名</strong>：对于每个类名，插件会生成一个唯一的哈希值，通常是基于文件名、类名和内容生成的。</li>
<li><strong>创建映射表</strong>：插件会创建一个从原始类名到生成的唯一类名的映射表。</li>
<li><strong>替换类名</strong>：将 CSS 文件中的原始类名替换为生成的唯一类名。</li>
<li><strong>导出映射表</strong>：将映射表导出为一个 JavaScript 对象，供组件使用。</li>
</ol>
<p><strong>原理示例：</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* Button.module.css */</span>
<span class="hljs-selector-class">.button</span> {
  <span class="hljs-attribute">background-color</span>: blue;
  <span class="hljs-attribute">color</span>: white;
}

<span class="hljs-selector-class">.primary</span> {
  <span class="hljs-attribute">background-color</span>: red;
}
</code></pre>
<p>经过 CSS Modules 处理后，会生成类似以下的 CSS：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.Button_button__1a2b3c</span> {
  <span class="hljs-attribute">background-color</span>: blue;
  <span class="hljs-attribute">color</span>: white;
}

<span class="hljs-selector-class">.Button_primary__4d5e6f</span> {
  <span class="hljs-attribute">background-color</span>: red;
}
</code></pre>
<p>同时会生成一个 JavaScript 对象：</p>
<pre><code class="hljs language-javascript" lang="javascript">{
  <span class="hljs-attr">button</span>: <span class="hljs-string">'Button_button__1a2b3c'</span>,
  <span class="hljs-attr">primary</span>: <span class="hljs-string">'Button_primary__4d5e6f'</span>
}
</code></pre>
<p>组件可以通过导入这个对象来使用生成的唯一类名。</p>
<h3 data-id="heading-10">5. VSCode 中 CSS Modules 插件的介绍与使用</h3>
<p>在 VSCode 中，有几个常用的 CSS Modules 插件可以提高开发效率：</p>
<h4 data-id="heading-11">5.1 CSS Modules</h4>
<ul>
<li><strong>插件名称</strong>：CSS Modules</li>
<li><strong>功能</strong>：提供 CSS Modules 类名的自动补全、悬停提示和跳转到定义等功能。</li>
<li><strong>安装方法</strong>：在 VSCode 扩展商店中搜索 "CSS Modules" 并安装。</li>
<li><strong>使用方法</strong>：
<ol>
<li>安装插件后，在 JavaScript/TypeScript 文件中导入 CSS Modules 文件时，插件会自动识别。</li>
<li>当输入 <code>styles.</code> 时，插件会显示可用的类名列表。</li>
<li>悬停在类名上时，会显示对应的 CSS 样式。</li>
<li>按住 Ctrl/Cmd 键并点击类名，可以跳转到 CSS 文件中的定义。</li>
</ol>
</li>
</ul>
<h4 data-id="heading-12">5.2 CSS Modules Syntax Highlighter</h4>
<ul>
<li><strong>插件名称</strong>：CSS Modules Syntax Highlighter</li>
<li><strong>功能</strong>：为 CSS Modules 文件提供语法高亮支持。</li>
<li><strong>安装方法</strong>：在 VSCode 扩展商店中搜索 "CSS Modules Syntax Highlighter" 并安装。</li>
</ul>
<h3 data-id="heading-13">6. 如何自定义打包之后的 className</h3>
<p>在 CSS Modules 中，可以通过 <code>generateScopedName</code> 选项来自定义打包之后的类名格式。</p>
<h4 data-id="heading-14">6.1 在 Webpack 中配置 generateScopedName</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// webpack.config.js</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-comment">// ...</span>
  <span class="hljs-attr">module</span>: {
    <span class="hljs-attr">rules</span>: [
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.module\.css$/</span>,
        <span class="hljs-attr">use</span>: [
          <span class="hljs-string">'style-loader'</span>,
          {
            <span class="hljs-attr">loader</span>: <span class="hljs-string">'css-loader'</span>,
            <span class="hljs-attr">options</span>: {
              <span class="hljs-attr">modules</span>: {
                <span class="hljs-attr">generateScopedName</span>: <span class="hljs-string">'[name]__[local]__[hash:base64:5]'</span>
              }
            }
          }
        ]
      }
    ]
  }
  <span class="hljs-comment">// ...</span>
};
</code></pre>
<h4 data-id="heading-15">6.2 generateScopedName 选项说明</h4>
<ul>
<li><code>[name]</code>：文件名</li>
<li><code>[local]</code>：原始类名</li>
<li><code>[hash:base64:5]</code>：基于内容生成的 5 位 base64 哈希值</li>
</ul>
<p><strong>自定义类名示例：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 自定义格式</span>
<span class="hljs-attr">generateScopedName</span>: <span class="hljs-string">'app-[local]'</span>
<span class="hljs-comment">// 生成的类名：app-button</span>

<span class="hljs-comment">// 更复杂的格式</span>
<span class="hljs-attr">generateScopedName</span>: <span class="hljs-string">'[name]_[local]_[hash:hex:4]'</span>
<span class="hljs-comment">// 生成的类名：Button_button_a1b2</span>
</code></pre>
<h3 data-id="heading-16">7. CSS Modules 中全局变量和局部变量的设置</h3>
<p>CSS Modules 支持全局变量和局部变量的设置，可以通过多种方式实现。</p>
<h4 data-id="heading-17">7.1 使用 :global() 和 :local() 伪类</h4>
<ul>
<li><code>:local()</code>：定义局部作用域的类名（默认）</li>
<li><code>:global()</code>：定义全局作用域的类名</li>
</ul>
<p><strong>示例代码：</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 局部作用域（默认） */</span>
<span class="hljs-selector-class">.button</span> {
  <span class="hljs-attribute">background-color</span>: blue;
}

<span class="hljs-comment">/* 显式定义局部作用域 */</span>
:<span class="hljs-built_in">local</span>(.primary) {
  <span class="hljs-attribute">background-color</span>: red;
}

<span class="hljs-comment">/* 全局作用域 */</span>
:<span class="hljs-built_in">global</span>(.global-button) {
  <span class="hljs-attribute">background-color</span>: green;
}

<span class="hljs-comment">/* 嵌套使用 */</span>
:<span class="hljs-built_in">local</span>(.container) {
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">16px</span>;
  
  <span class="hljs-comment">/* 容器内的全局类 */</span>
  :<span class="hljs-built_in">global</span>(.title) {
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">24px</span>;
    <span class="hljs-attribute">font-weight</span>: bold;
  }
}
</code></pre>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 使用全局类</span>
div className={styles.<span class="hljs-property">container</span>}&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"title"</span>&gt;</span>标题<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span> {<span class="hljs-comment">/* 全局类直接使用 */</span>}
  &lt;button className={styles.<span class="hljs-property">button</span>}&gt;局部按钮&lt;/button&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"global-button"</span>&gt;</span>全局按钮<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
&lt;/div&gt;
</code></pre>
<h4 data-id="heading-18">7.2 exportsGlobals 配置</h4>
<p><code>exportsGlobals</code> 选项用于指定哪些类名应该被导出为全局变量。
这样全局css变量也可以这样使用 <code>{styles.globalButton}</code>(之前只能这样<code>className="global-button"</code>)</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// webpack.config.js</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-comment">// ...</span>
  <span class="hljs-attr">module</span>: {
    <span class="hljs-attr">rules</span>: [
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.module\.css$/</span>,
        <span class="hljs-attr">use</span>: [
          <span class="hljs-string">'style-loader'</span>,
          {
            <span class="hljs-attr">loader</span>: <span class="hljs-string">'css-loader'</span>,
            <span class="hljs-attr">options</span>: {
              <span class="hljs-attr">modules</span>: {
                <span class="hljs-attr">exportsGlobals</span>: <span class="hljs-literal">true</span>
              }
            }
          }
        ]
      }
    ]
  }
  <span class="hljs-comment">// ...</span>
};
</code></pre>
<h4 data-id="heading-19">7.3 scopeBehaviour 配置</h4>
<p><code>scopeBehaviour</code> 选项用于指定 CSS Modules 的作用域行为，有两个值：</p>
<ul>
<li><code>'local'</code>：默认值，所有类名都是局部作用域的</li>
<li><code>'global'</code>：所有类名都是全局作用域的，除非使用 <code>:local()</code> 显式定义</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// webpack.config.js</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-comment">// ...</span>
  <span class="hljs-attr">module</span>: {
    <span class="hljs-attr">rules</span>: [
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.module\.css$/</span>,
        <span class="hljs-attr">use</span>: [
          <span class="hljs-string">'style-loader'</span>,
          {
            <span class="hljs-attr">loader</span>: <span class="hljs-string">'css-loader'</span>,
            <span class="hljs-attr">options</span>: {
              <span class="hljs-attr">modules</span>: {
                <span class="hljs-comment">// （默认值为 local；就是默认情况下css写的样式都是局部作用域的）</span>
                <span class="hljs-comment">// 改成 global 之后：默认情况css写的样式都是全局作用域的</span>
                <span class="hljs-attr">scopeBehaviour</span>: <span class="hljs-string">'global'</span> 
              }
            }
          }
        ]
      }
    ]
  }
  <span class="hljs-comment">// ...</span>
};
</code></pre>
<h4 data-id="heading-20">7.4 通过正则表达式匹配哪些 CSS 文件是默认全局的</h4>
<p>默认情况下，所有启用了 CSS Modules 的 <code>.module.css</code> 文件中的样式都采用<strong>局部作用域</strong>。但在实际项目中，我们可能希望某些特定的 CSS Modules 文件默认采用<strong>全局作用域</strong>。</p>
<p>例如：假设项目中所有 <code>.module.css</code> 文件都默认是局部作用域，但我们希望所有文件名中包含 <code>Button1</code> 的 CSS Modules 文件默认采用全局作用域。</p>
<p>我们可以通过 <code>css-loader</code> 的 <code>globalModulePaths</code> 配置来实现这一需求（注意：在 Webpack 中，<code>exportGlobals</code> 是一个独立的选项，用于导出全局选择器，而不是用于控制文件级别的作用域）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// webpack.config.js</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-comment">// ...</span>
  <span class="hljs-attr">module</span>: {
    <span class="hljs-attr">rules</span>: [
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.module\.css$/</span>,
        <span class="hljs-attr">use</span>: [
          <span class="hljs-comment">// 开发环境使用 style-loader，生产环境建议使用 MiniCssExtractPlugin</span>
          <span class="hljs-string">'style-loader'</span>,
          {
            <span class="hljs-attr">loader</span>: <span class="hljs-string">'css-loader'</span>,
            <span class="hljs-attr">options</span>: {
              <span class="hljs-attr">modules</span>: {
                <span class="hljs-comment">// 指定哪些 CSS Modules 文件默认使用全局作用域</span>
                <span class="hljs-comment">// 正则表达式匹配文件路径，这里匹配所有包含 "Button1" 的文件</span>
                <span class="hljs-attr">globalModulePaths</span>: [
                  <span class="hljs-regexp">/Button1/</span> <span class="hljs-comment">// 匹配文件名或路径中包含 "Button1" 的所有文件</span>
                ]
              }
            }
          }
        ]
      }
    ]
  }
  <span class="hljs-comment">// ...</span>
};
</code></pre>
<p><strong>说明：</strong></p>
<ul>
<li><code>globalModulePaths: [/Button1/]</code>：在 Webpack 的 <code>css-loader</code> 配置中，此选项用于指定哪些 CSS Modules 文件默认使用全局作用域</li>
<li>使用正则表达式 <code>/Button1/</code> 匹配所有文件名或路径中包含 "Button1" 的 CSS Modules 文件</li>
<li>被匹配到的文件（如 <code>Button1.module.css</code>、<code>MyButton1Styles.module.css</code> 等）将默认采用全局作用域</li>
<li>未被匹配到的文件仍保持默认的局部作用域</li>
<li>注意：<code>exportGlobals</code> 是一个独立选项，用于导出全局选择器（如 <code>:global(.global-class)</code>），而不是控制文件级别的作用域</li>
</ul>
<p>这种配置方式可以让我们在保持大部分 CSS Modules 文件为局部作用域的同时，灵活地将特定文件设置为全局作用域，无需在每个文件中使用 <code>:global()</code> 语法。</p>
<h3 data-id="heading-21">8. 其他配置的介绍与使用</h3>
<h4 data-id="heading-22">8.1 localsConvention 配置</h4>
<p><code>localsConvention</code> 选项用于指定如何转换导出的类名的键名。</p>
<p><strong>可用选项：</strong></p>
<ul>
<li><code>'asIs'</code>：保持原始类名</li>
<li><code>'camelCase'</code>：转换为驼峰式命名</li>
<li><code>'camelCaseOnly'</code>：仅转换为驼峰式命名，不保留原始类名</li>
<li><code>'dashes'</code>：转换为短横线分隔命名</li>
<li><code>'dashesOnly'</code>：仅转换为短横线分隔命名，不保留原始类名</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// webpack.config.js</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-comment">// ...</span>
  <span class="hljs-attr">module</span>: {
    <span class="hljs-attr">rules</span>: [
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.module\.css$/</span>,
        <span class="hljs-attr">use</span>: [
          <span class="hljs-string">'style-loader'</span>,
          {
            <span class="hljs-attr">loader</span>: <span class="hljs-string">'css-loader'</span>,
            <span class="hljs-attr">options</span>: {
              <span class="hljs-attr">modules</span>: {
                <span class="hljs-attr">localsConvention</span>: <span class="hljs-string">'camelCase'</span>
              }
            }
          }
        ]
      }
    ]
  }
  <span class="hljs-comment">// ...</span>
};
</code></pre>
<p><strong>示例：</strong></p>
<p>假设我们有以下 CSS 文件：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* Button.module.css */</span>
<span class="hljs-selector-class">.button-primary</span> {
  <span class="hljs-attribute">background-color</span>: red;
}

<span class="hljs-comment">/* 注意：下面的例子会用到这个驼峰式命名的类 */</span>
<span class="hljs-selector-class">.mainButton</span> {
  <span class="hljs-attribute">background-color</span>: blue;
}
</code></pre>
<h5 data-id="heading-23">1. localsConvention: 'asIs'</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// webpack.config.js</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-comment">// ...</span>
  <span class="hljs-attr">module</span>: {
    <span class="hljs-attr">rules</span>: [
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.module\.css$/</span>,
        <span class="hljs-attr">use</span>: [
          <span class="hljs-string">'style-loader'</span>,
          {
            <span class="hljs-attr">loader</span>: <span class="hljs-string">'css-loader'</span>,
            <span class="hljs-attr">options</span>: {
              <span class="hljs-attr">modules</span>: {
                <span class="hljs-attr">localsConvention</span>: <span class="hljs-string">'asIs'</span>
              }
            }
          }
        ]
      }
    ]
  }
  <span class="hljs-comment">// ...</span>
};
</code></pre>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// React 组件中的使用</span>
<span class="hljs-keyword">import</span> styles <span class="hljs-keyword">from</span> <span class="hljs-string">'./Button.module.css'</span>;

<span class="hljs-comment">// 保持原始类名，使用短横线命名</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles[</span>'<span class="hljs-attr">button-primary</span>']}&gt;</span>主要按钮<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>

<span class="hljs-comment">// 驼峰式命名的类保持不变</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.mainButton}</span>&gt;</span>主要按钮<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
</code></pre>
<h5 data-id="heading-24">2. localsConvention: 'camelCase'</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// webpack.config.js</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-comment">// ...</span>
  <span class="hljs-attr">module</span>: {
    <span class="hljs-attr">rules</span>: [
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.module\.css$/</span>,
        <span class="hljs-attr">use</span>: [
          <span class="hljs-string">'style-loader'</span>,
          {
            <span class="hljs-attr">loader</span>: <span class="hljs-string">'css-loader'</span>,
            <span class="hljs-attr">options</span>: {
              <span class="hljs-attr">modules</span>: {
                <span class="hljs-attr">localsConvention</span>: <span class="hljs-string">'camelCase'</span>
              }
            }
          }
        ]
      }
    ]
  }
  <span class="hljs-comment">// ...</span>
};
</code></pre>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// React 组件中的使用</span>
<span class="hljs-keyword">import</span> styles <span class="hljs-keyword">from</span> <span class="hljs-string">'./Button.module.css'</span>;

<span class="hljs-comment">// 可以使用转换后的驼峰式命名</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.buttonPrimary}</span>&gt;</span>主要按钮<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
<span class="hljs-comment">// 也可以使用原始的短横线命名</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles[</span>'<span class="hljs-attr">button-primary</span>']}&gt;</span>主要按钮<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>

<span class="hljs-comment">// 驼峰式命名的类保持不变</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.mainButton}</span>&gt;</span>主要按钮<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
</code></pre>
<h5 data-id="heading-25">3. localsConvention: 'camelCaseOnly'</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// webpack.config.js</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-comment">// ...</span>
  <span class="hljs-attr">module</span>: {
    <span class="hljs-attr">rules</span>: [
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.module\.css$/</span>,
        <span class="hljs-attr">use</span>: [
          <span class="hljs-string">'style-loader'</span>,
          {
            <span class="hljs-attr">loader</span>: <span class="hljs-string">'css-loader'</span>,
            <span class="hljs-attr">options</span>: {
              <span class="hljs-attr">modules</span>: {
                <span class="hljs-attr">localsConvention</span>: <span class="hljs-string">'camelCaseOnly'</span>
              }
            }
          }
        ]
      }
    ]
  }
  <span class="hljs-comment">// ...</span>
};
</code></pre>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// React 组件中的使用</span>
<span class="hljs-keyword">import</span> styles <span class="hljs-keyword">from</span> <span class="hljs-string">'./Button.module.css'</span>;

<span class="hljs-comment">// 只能使用转换后的驼峰式命名</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.buttonPrimary}</span>&gt;</span>主要按钮<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
<span class="hljs-comment">// 原始的短横线命名不再可用</span>
<span class="hljs-comment">// &lt;button className={styles['button-primary']}&gt;主要按钮&lt;/button&gt; // 会报错</span>

<span class="hljs-comment">// 驼峰式命名的类保持不变</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.mainButton}</span>&gt;</span>主要按钮<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
</code></pre>
<h5 data-id="heading-26">4. localsConvention: 'dashes'</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// webpack.config.js</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-comment">// ...</span>
  <span class="hljs-attr">module</span>: {
    <span class="hljs-attr">rules</span>: [
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.module\.css$/</span>,
        <span class="hljs-attr">use</span>: [
          <span class="hljs-string">'style-loader'</span>,
          {
            <span class="hljs-attr">loader</span>: <span class="hljs-string">'css-loader'</span>,
            <span class="hljs-attr">options</span>: {
              <span class="hljs-attr">modules</span>: {
                <span class="hljs-attr">localsConvention</span>: <span class="hljs-string">'dashes'</span>
              }
            }
          }
        ]
      }
    ]
  }
  <span class="hljs-comment">// ...</span>
};
</code></pre>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// React 组件中的使用</span>
<span class="hljs-keyword">import</span> styles <span class="hljs-keyword">from</span> <span class="hljs-string">'./Button.module.css'</span>;

<span class="hljs-comment">// 短横线命名的类保持不变</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles[</span>'<span class="hljs-attr">button-primary</span>']}&gt;</span>主要按钮<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>

<span class="hljs-comment">// 驼峰式命名的类会被转换为短横线命名，同时保留原始命名</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles[</span>'<span class="hljs-attr">main-button</span>']}&gt;</span>主要按钮<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
<span class="hljs-comment">// 原始的驼峰式命名仍然可用</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.mainButton}</span>&gt;</span>主要按钮<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
</code></pre>
<h5 data-id="heading-27">5. localsConvention: 'dashesOnly'</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// webpack.config.js</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-comment">// ...</span>
  <span class="hljs-attr">module</span>: {
    <span class="hljs-attr">rules</span>: [
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.module\.css$/</span>,
        <span class="hljs-attr">use</span>: [
          <span class="hljs-string">'style-loader'</span>,
          {
            <span class="hljs-attr">loader</span>: <span class="hljs-string">'css-loader'</span>,
            <span class="hljs-attr">options</span>: {
              <span class="hljs-attr">modules</span>: {
                <span class="hljs-attr">localsConvention</span>: <span class="hljs-string">'dashesOnly'</span>
              }
            }
          }
        ]
      }
    ]
  }
  <span class="hljs-comment">// ...</span>
};
</code></pre>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// React 组件中的使用</span>
<span class="hljs-keyword">import</span> styles <span class="hljs-keyword">from</span> <span class="hljs-string">'./Button.module.css'</span>;

<span class="hljs-comment">// 短横线命名的类保持不变</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles[</span>'<span class="hljs-attr">button-primary</span>']}&gt;</span>主要按钮<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>

<span class="hljs-comment">// 驼峰式命名的类会被转换为短横线命名，原始命名不再可用</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles[</span>'<span class="hljs-attr">main-button</span>']}&gt;</span>主要按钮<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
<span class="hljs-comment">// 原始的驼峰式命名不再可用</span>
<span class="hljs-comment">// &lt;button className={styles.mainButton}&gt;主要按钮&lt;/button&gt; // 会报错</span>
</code></pre>
<h4 data-id="heading-28">8.2 处理多层 className</h4>
<p>在 CSS Modules 中，可以使用嵌套语法和 <code>:global()</code> 伪类来处理多层 className。</p>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* Button.module.css */</span>
<span class="hljs-selector-class">.button</span> {
  <span class="hljs-attribute">background-color</span>: blue;
  <span class="hljs-attribute">color</span>: white;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">8px</span> <span class="hljs-number">16px</span>;
  
  <span class="hljs-comment">/* 嵌套的局部类 */</span>
  &amp;<span class="hljs-selector-pseudo">:hover</span> {
    <span class="hljs-attribute">background-color</span>: darkblue;
  }
  
  <span class="hljs-comment">/* 嵌套的全局类 */</span>
  &amp;:<span class="hljs-built_in">global</span>(.large) {
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">12px</span> <span class="hljs-number">24px</span>;
  }
  
  <span class="hljs-comment">/* 嵌套的组合类 */</span>
  &amp;<span class="hljs-selector-class">.primary</span> {
    <span class="hljs-attribute">background-color</span>: red;
  }
}
</code></pre>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 使用多层 className</span>
<span class="hljs-keyword">import</span> styles <span class="hljs-keyword">from</span> <span class="hljs-string">'./Button.module.css'</span>;

<span class="hljs-comment">// 组合使用</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`${<span class="hljs-attr">styles.button</span>} <span class="hljs-attr">large</span>`}&gt;</span>大按钮<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`${<span class="hljs-attr">styles.button</span>} ${<span class="hljs-attr">styles.primary</span>}`}&gt;</span>主要按钮<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
</code></pre>
<h3 data-id="heading-29">9. Vue 中关于 CSS 的处理方式</h3>
<p>在 Vue 中，处理 CSS 的方式与 React 有所不同。Vue 提供了内置的 CSS 作用域机制，不需要额外的构建工具配置。</p>
<h4 data-id="heading-30">9.1 Vue 中的 scoped CSS</h4>
<p>Vue 中的 <code>scoped</code> 属性可以将样式限制在当前组件的作用域内，类似于 CSS Modules。</p>
<p><strong>Vue 中 scoped CSS 的示例：</strong></p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- Button.vue --&gt;
&lt;template&gt;
  &lt;button class="button"&gt;
    &lt;slot&gt;&lt;/slot&gt;
  &lt;/button&gt;
&lt;/template&gt;

&lt;style scoped&gt;
.button {
  background-color: blue;
  color: white;
  padding: 8px 16px;
}

.button:hover {
  background-color: darkblue;
}
&lt;/style&gt;

&lt;!-- PrimaryButton.vue --&gt;
&lt;template&gt;
  &lt;button class="button"&gt;
    &lt;slot&gt;&lt;/slot&gt;
  &lt;/button&gt;
&lt;/template&gt;

&lt;style scoped&gt;
.button {
  background-color: red;
  color: white;
  padding: 8px 16px;
}

.button:hover {
  background-color: darkred;
}
&lt;/style&gt;

&lt;!-- App.vue --&gt;
&lt;template&gt;
  &lt;div&gt;
    &lt;Button&gt;普通按钮&lt;/Button&gt;
    &lt;PrimaryButton&gt;主要按钮&lt;/PrimaryButton&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script&gt;
import Button from './Button.vue';
import PrimaryButton from './PrimaryButton.vue';

export default {
  components: {
    Button,
    PrimaryButton
  }
};
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-31">9.2 Vue 中的 CSS Modules</h4>
<p>Vue 也支持 CSS Modules，可以通过 <code>module</code> 属性实现。</p>
<p><strong>Vue 中 CSS Modules 的示例：</strong></p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- Button.vue --&gt;
&lt;template&gt;
  &lt;button :class="$style.button"&gt;
    &lt;slot&gt;&lt;/slot&gt;
  &lt;/button&gt;
&lt;/template&gt;

&lt;style module&gt;
.button {
  background-color: blue;
  color: white;
  padding: 8px 16px;
}

.button:hover {
  background-color: darkblue;
}
&lt;/style&gt;

&lt;!-- App.vue --&gt;
&lt;template&gt;
  &lt;div&gt;
    &lt;Button&gt;普通按钮&lt;/Button&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script&gt;
import Button from './Button.vue';

export default {
  components: {
    Button
  }
};
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-32">10. Vue 与 React CSS Modules 的对比</h3>
<h4 data-id="heading-33">10.1 底层原理对比</h4>
<p><strong>CSS Modules（React）的原理：</strong></p>
<ol>
<li>构建工具解析 <code>.module.css</code> 文件</li>
<li>为每个类名生成唯一的哈希值</li>
<li>创建原始类名到唯一类名的映射表</li>
<li>替换 CSS 文件中的类名</li>
<li>导出映射表供组件使用</li>
</ol>
<p><strong>Vue scoped CSS 的原理：</strong></p>
<ol>
<li>Vue 编译器解析带有 <code>scoped</code> 属性的样式</li>
<li>为组件的根元素添加一个唯一的 <code>data-v-xxx</code> 属性</li>
<li>为样式中的每个选择器添加 <code>[data-v-xxx]</code> 属性选择器</li>
<li>这样样式就只对当前组件的元素生效</li>
</ol>
<p><strong>Vue CSS Modules 的原理：</strong>
与 React 中的 CSS Modules 原理类似，但是集成在 Vue 的单文件组件中，使用 <code>$style</code> 对象访问生成的类名。</p>
<h4 data-id="heading-34">10.2 异同点</h4>
<p><strong>相同点：</strong></p>
<ul>
<li>都解决了 CSS 类名冲突问题</li>
<li>都支持局部作用域和全局作用域</li>
<li>都需要构建工具的支持</li>
</ul>
<p><strong>不同点：</strong></p>
<ul>
<li>Vue 的 scoped CSS 是内置的，不需要额外配置；React 的 CSS Modules 需要配置构建工具</li>
<li>Vue 使用 <code>data-v-xxx</code> 属性实现作用域隔离；React 使用哈希类名</li>
<li>Vue 单文件组件中可以直接使用 <code>scoped</code> 属性；React 需要使用 <code>.module.css</code> 命名约定</li>
<li>Vue 支持 <code>module</code> 属性直接在模板中使用 <code>$style</code> 对象；React 需要导入样式对象</li>
</ul>
<h4 data-id="heading-35">10.3 示例对比</h4>
<p><strong>React CSS Modules 示例：</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// Button.js</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> styles <span class="hljs-keyword">from</span> <span class="hljs-string">'./Button.module.css'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">Button</span> = (<span class="hljs-params">{ children }</span>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.button}</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>;
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Button</span>;

<span class="hljs-comment">// Button.module.css</span>
.<span class="hljs-property">button</span> {
  background-<span class="hljs-attr">color</span>: blue;
  <span class="hljs-attr">color</span>: white;
  <span class="hljs-attr">padding</span>: 8px 16px;
}
</code></pre>
<p><strong>Vue scoped CSS 示例：</strong></p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- Button.vue --&gt;
&lt;template&gt;
  &lt;button class="button"&gt;
    &lt;slot&gt;&lt;/slot&gt;
  &lt;/button&gt;
&lt;/template&gt;

&lt;style scoped&gt;
.button {
  background-color: blue;
  color: white;
  padding: 8px 16px;
}
&lt;/style&gt;
</code></pre>
<p><strong>Vue CSS Modules 示例：</strong></p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- Button.vue --&gt;
&lt;template&gt;
  &lt;button :class="$style.button"&gt;
    &lt;slot&gt;&lt;/slot&gt;
  &lt;/button&gt;
&lt;/template&gt;

&lt;style module&gt;
.button {
  background-color: blue;
  color: white;
  padding: 8px 16px;
}
&lt;/style&gt;
</code></pre>
<h3 data-id="heading-36">总结</h3>
<p>CSS Modules 是一种非常实用的 CSS 模块化解决方案，在 React 生态系统中得到了广泛的应用。它解决了传统 CSS 的类名冲突、样式污染等问题，提高了代码的可维护性。</p>
<p>在 Vue 中，虽然有自己的 scoped CSS 和 CSS Modules 实现，但核心思想与 React 中的 CSS Modules 是一致的，都是为了实现样式的模块化和作用域隔离。</p>
<p>选择使用哪种方案取决于项目的需求和技术栈，但无论选择哪种方案，都应该遵循 CSS 模块化的思想，避免全局样式污染，提高代码的可维护性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从零开始学MCP（八）- 构建一个MCP server]]></title>    <link>https://juejin.cn/post/7582510291667419187</link>    <guid>https://juejin.cn/post/7582510291667419187</guid>    <pubDate>2025-12-12T04:28:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582510291667419187" data-draft-id="7582528397865287707" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从零开始学MCP（八）- 构建一个MCP server"/> <meta itemprop="keywords" content="人工智能,Python"/> <meta itemprop="datePublished" content="2025-12-12T04:28:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="锐学AI"/> <meta itemprop="url" content="https://juejin.cn/user/1165926981220583"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从零开始学MCP（八）- 构建一个MCP server
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1165926981220583/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    锐学AI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T04:28:14.000Z" title="Fri Dec 12 2025 04:28:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在本教程中，我们将通过构建一个简单的MCP server，并通过 <a href="https://link.juejin.cn?target=https%3A%2F%2Fopenmcp.kirigaya.cn%2Fzh%2Fplugin-tutorial%2Fquick-start%2F" target="_blank" title="https://openmcp.kirigaya.cn/zh/plugin-tutorial/quick-start/" ref="nofollow noopener noreferrer">OpenMCP </a>进行测试。</p>
<h3 data-id="heading-0">MCP核心概念</h3>
<p>MCP servers可以提供三种主要类型的功能：</p>
<ol>
<li><strong>Resources</strong>: 客户端可以读取的类文件数据（如API响应或文件内容）</li>
</ol>

<ol start="2">
<li><strong>Tools</strong>: LLM可以调用的函数（经过用户批准）</li>
</ol>

<ol start="3">
<li><strong>Prompts</strong>: 帮助用户完成特定任务的预编写模板</li>
</ol>
<p>本教程使用Python进行演示（当然还可使用TypeScript、Java、Rust等其他语言， <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmodelcontextprotocol%23getting-started" target="_blank" title="https://github.com/modelcontextprotocol#getting-started" ref="nofollow noopener noreferrer">参考 </a>）。</p>
<h3 data-id="heading-1">📝 日志处理指南</h3>
<p>在开发 MCP 服务器时，日志记录方式取决于服务器的传输协议。请根据您的实现方式遵循以下准则：</p>
<h4 data-id="heading-2">1. STDIO 基础服务器</h4>
<p><strong>严禁</strong>向标准输出写入任何内容。</p>
<ul>
<li><strong>🚫 禁止操作：</strong> 所有的调试打印语句（如    print() 、   console.log() 、   fmt.Println()  等）。</li>
</ul>

<ul>
<li><strong>⚠️ 后果：</strong> 任何写入标准输出的内容都会破坏 JSON-RPC 消息流，导致服务器通信中断。</li>
</ul>
<h4 data-id="heading-3">2. HTTP 基础服务器</h4>
<p>标准输出日志是安全的。</p>
<ul>
<li><strong>✅ 允许操作：</strong> 可以正常使用标准输出进行日志记录。</li>
</ul>

<ul>
<li><strong>💡 原因：</strong> 日志输出不会干扰 HTTP 响应数据。</li>
</ul>
<h2 data-id="heading-4">安装 uv</h2>
<p>本次将使用  <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.astral.sh%2Fuv%2F" target="_blank" title="https://docs.astral.sh/uv/" ref="nofollow noopener noreferrer">uv </a> 来管理项目</p>
<blockquote>
<p>uv是用 Rust 编写的 Python 超快包管理器，可替代   pip 、   venv 和   pip-tools ，极速安装依赖并管理虚拟环境。</p>
</blockquote>
<p>如果你还未使用过uv，请先下载安装：</p>
<pre><code class="hljs">pip install uv
</code></pre>
<p>查看 uv 的版本：</p>
<pre><code class="hljs">uv version
</code></pre>
<p>输出以下内容代表安装成功（版本号取决于你安装的版本）</p>
<pre><code class="hljs language-scss" lang="scss">uv <span class="hljs-number">0.8</span><span class="hljs-selector-class">.22</span> (ade2bdbd2 <span class="hljs-number">2025</span>-<span class="hljs-number">09</span>-<span class="hljs-number">23</span>)
</code></pre>
<h2 data-id="heading-5">快速开始</h2>
<p>创建项目并初始化</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> -p ~/codes/my_first_mcp

<span class="hljs-built_in">cd</span> ~/codes/my_first_mcp

uv init --no-workspace
</code></pre>
<p>添加MCP相关库</p>
<pre><code class="hljs language-csharp" lang="csharp">uv <span class="hljs-keyword">add</span> <span class="hljs-string">"mcp[cli]"</span>
</code></pre>
<p>修改main.py</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> mcp.server.fastmcp <span class="hljs-keyword">import</span> FastMCP

<span class="hljs-comment"># 初始化 FastMCP 服务器</span>
mcp = FastMCP(<span class="hljs-string">"我的第一个MCP"</span>)

<span class="hljs-meta">@mcp.tool(<span class="hljs-params">name=<span class="hljs-string">"greet"</span>, description=<span class="hljs-string">"两个数相加"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a: <span class="hljs-built_in">int</span>, b: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">int</span>:

    <span class="hljs-keyword">return</span> a + b

<span class="hljs-meta">@mcp.resource(<span class="hljs-params"><span class="hljs-string">"resource://{name}"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_greeting</span>(<span class="hljs-params">name: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">""""根据resource中的名字向他问好（资源名建议为英文，否则出现乱码）"""</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"Hello, <span class="hljs-subst">{name}</span>!"</span>

<span class="hljs-meta">@mcp.prompt()</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">greet_user</span>(<span class="hljs-params">name: <span class="hljs-built_in">str</span>, style: <span class="hljs-built_in">str</span> = <span class="hljs-string">"friendly"</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    styles = {
        <span class="hljs-string">"friendly"</span>: <span class="hljs-string">"写一个温暖友好的问候语"</span>,
        <span class="hljs-string">"formal"</span>: <span class="hljs-string">"写一个正式的问候语"</span>,
        <span class="hljs-string">"casual"</span>: <span class="hljs-string">"写一个随意的问候语"</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"给<span class="hljs-subst">{name}</span><span class="hljs-subst">{styles.get(style, styles[<span class="hljs-string">'friendly'</span>])}</span>"</span>

<span class="hljs-comment"># 以http方式启动服务器</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    mcp.run(transport=<span class="hljs-string">"streamable-http"</span>)
</code></pre>
<h3 data-id="heading-6"/>
<h2 data-id="heading-7">测试</h2>
<p>安装OpenMCP， <a href="https://link.juejin.cn?target=https%3A%2F%2Fopenmcp.kirigaya.cn%2Fzh%2Fplugin-tutorial%2Fquick-start%2F" target="_blank" title="https://openmcp.kirigaya.cn/zh/plugin-tutorial/quick-start/" ref="nofollow noopener noreferrer">参考 </a>，效果如下</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c2be8fbc478847619fb18e62b9ab522b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZSQ5a2mQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766118493&amp;x-signature=DsEC3JlIYCUmKV6wcxqFKxtjs3Y%3D" alt="" loading="lazy"/></p>
<hr/>
<blockquote>
<p>欢迎加入我的【ima知识库】   <a href="https://link.juejin.cn?target=https%3A%2F%2Fima.qq.com%2Fwiki%2F%3FshareId%3D58d81eb0444db19630cccc44e04ab7692431b71a8de38b24ed4f34920ec08bf4" target="_blank" title="https://ima.qq.com/wiki/?shareId=58d81eb0444db19630cccc44e04ab7692431b71a8de38b24ed4f34920ec08bf4" ref="nofollow noopener noreferrer">从零开始学MCP </a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[万众瞩目的 GPT 5.2，连个火柴人游戏都做不明白？]]></title>    <link>https://juejin.cn/post/7582808491582636068</link>    <guid>https://juejin.cn/post/7582808491582636068</guid>    <pubDate>2025-12-12T05:45:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582808491582636068" data-draft-id="7582561515816386623" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="万众瞩目的 GPT 5.2，连个火柴人游戏都做不明白？"/> <meta itemprop="keywords" content="后端,算法"/> <meta itemprop="datePublished" content="2025-12-12T05:45:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="卡尔AI工坊"/> <meta itemprop="url" content="https://juejin.cn/user/2582086210300680"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            万众瞩目的 GPT 5.2，连个火柴人游戏都做不明白？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2582086210300680/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    卡尔AI工坊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T05:45:52.000Z" title="Fri Dec 12 2025 05:45:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    15
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文共 1906 字，阅读预计需要 4 分钟。</p>
<p>Hi，你好，我是Carl，一个本科进大厂做了2年+AI研发后，裸辞的AI创业者。</p>
<p>今早，一个月内第三个<strong>号称“地表最强”</strong> 的模型发布了，OpenAI的<strong>GPT-5.2</strong> ，官方定位是“最强大的专业知识工作模型”。</p>
<p>看腻了那些复杂的跑分和论文，我此刻更想在一个最朴素的场景下，试试这些“王炸”们的成色。</p>
<p>提示词非常简单，</p>
<blockquote>
<p>“你是一个资深全栈游戏开发工程师。请在当前目录下创建一个新文件夹，写一个火柴人第一人称射击游戏，并直接帮我完成所有构建工作。”</p>
</blockquote>
<p>三分钟，代码生成完毕。我启动服务，打开浏览器，屏幕上确实出现了一个火柴人，手里也确实拿着枪，也确实能攻击周围的敌人。</p>
<p>但我晃动鼠标，发现它开始在屏幕上左右射击，像一个比魂斗罗还要古早的横屏射击游戏。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e459e37778141f5b2192d6c933e6355~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2h5bCUQUnlt6XlnYo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766125407&amp;x-signature=ZPS5ARYD4IQctzy3v%2BapqP%2B5Hds%3D" alt="" loading="lazy"/></p>
<p><strong>说好的第一人称射击呢？这明明是个横版第三人称游戏啊！</strong></p>
<p>那一刻我意识到一个被由于过度营销而掩盖的真相，参数量再大，听不懂人话也是白搭。</p>
<p>于是我准备不看跑分，不看论文，试试各个模型，就看谁能真正帮我把这个游戏做出来。</p>
<h2 data-id="heading-0">亲历：当“全能神”听不懂人话</h2>
<p>这次规则非常简单粗暴，还原最真实的“懒人开发”场景：</p>
<p>1. 环境：VS Code + Copilot 插件。</p>
<p>2. 提示词：统一使用上文中，与GPT 5.2相同的一段 Prompt。</p>
<p>3. 干涉：零干涉。不解释，不修 Bug，生成什么跑什么。</p>
<p>尝试的模型除了刚才翻车的 GPT 5.2，还有 Google 的 Gemini 3，Anthropic 的 Opus 4.5，以及 OpenAI 自家的两个偏科生：GPT 5.1 Codex 和 GPT 5.1 Codex Max。</p>
<h2 data-id="heading-1">战况：谁才是真正的程序员？</h2>
<p>如果把这几个模型比作你的同事，他们的画风是这样的：</p>
<h3 data-id="heading-2">Gemini 3：稳重的老干部</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/782cf5b0ba4f461db9926fd6331dac9d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2h5bCUQUnlt6XlnYo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766125407&amp;x-signature=dhJ7o%2B%2B6v0t3aJrLGuugWEmmG%2FU%3D" alt="" loading="lazy"/></p>
<p>Gemini 3 是那个让你最放心的老员工。</p>
<p>它写得最慢，磨蹭了 5 分钟。生成的项目结构也最简单：<code>game.js</code>，<code>index.html</code>，<code>style.css</code>，外加一个内容很简单的 README，只讲如何启动。</p>
<p>但是，它跑起来了。</p>
<p>没有花哨的特效，界面简陋得像 90 年代的 Flash 游戏，颜色也是最基础的黑白灰。但它稳稳当当地执行了“第一人称射击”的指令，没有报错，没有崩溃。</p>
<p>这个简单的界面倒是与它多模态之神的标签不符，不过也是因为在copilot的环境里它获取上下文和渲染的能力受限，并不能释放Google AI Studio的原生环境里的能力。</p>
<p>在文章末尾，我加上了Gemini3在Google AI Studio中的表现。“主场作战”形态的Gemini3，依然是最均衡、最稳定的那个。</p>
<h3 data-id="heading-3">Opus 4.5：偏科的设计师</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2c84ed9a44d4b5b820be1a20c851b2b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2h5bCUQUnlt6XlnYo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766125407&amp;x-signature=opjozlS%2FbTrlt9h75vxdcmg7BaI%3D" alt="" loading="lazy"/></p>
<p>Opus 4.5 则是那个很前卫的设计师。</p>
<p>它速度很快，也是3分钟完成构建，也是简单的三个游戏文件。</p>
<p>打开游戏的一瞬间，我也确实被惊艳到了：丰富的配色，细腻的 UI 风格，甚至启动界面是动态的。</p>
<p>但当我按下鼠标左键开火时，每次开火，屏幕都会疯狂闪烁。也许这是它独到的设计？</p>
<h3 data-id="heading-4">GPT 5.1 Codex：不修边幅的后端程序员</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/63677878fbfe43a481d8da1d84c24225~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2h5bCUQUnlt6XlnYo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766125407&amp;x-signature=3WMcc9i5dQGfZF%2Bbq6f8QxeZ8IY%3D" alt="" loading="lazy"/></p>
<p>这才是真正的“扫地僧”。</p>
<p>GPT 5.1 Codex 交出的作业，让我看到了专业程序员的影子。看看这个文件结构：</p>
<ul>
<li><code>enemies.js</code></li>
<li><code>game.js</code></li>
<li><code>stickman.js</code></li>
<li><code>utils.js</code></li>
<li><code>weapons.js</code></li>
<li>...</li>
</ul>
<p>它是唯一一个知道要把“敌人”、“武器”、“工具函数”拆分成独立模块的模型。生成的 README 文档也最长、最详细。</p>
<p>甚至每次开枪射击也是有音效的，即使很难听。</p>
<p>运行游戏，典型的程序员审美，界面丑得令人发指，但打击感是最好的。子弹的弹道、敌人的反馈，都像模像样。</p>
<p>它不修边幅，不善言辞，但它是唯一一个真正懂“软件工程”的家伙，构建的项目也是最完整的。</p>
<h3 data-id="heading-5">GPT 5.1 Codex Max：走火入魔、急于证明自己的____</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/33ee32f1f11a4d3490ac3358a0de07e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2h5bCUQUnlt6XlnYo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766125407&amp;x-signature=VQQdp9xAjSqG5h%2Fo9O7OaijXCiY%3D" alt="" loading="lazy"/></p>
<p>它没能交出一个能正常运行的项目。画面错乱，鼠标控制也是反的（鼠标左移，视角右转）</p>
<p>它想得太多了。它试图引入更复杂的物理引擎和交互逻辑，结果导致了灾难性的后果，甚至连敌人模型都加载不出来。</p>
<p>这就是典型的“过度工程”。为了炫技，把最基础的可用性搞丢了。</p>
<h2 data-id="heading-6">盲区与反思：Copilot 的“中间商差价”</h2>
<p>这里必须帮 Gemini 3 说句公道话。</p>
<p>我在 VS Code 的 Copilot 里调用它，效果肯定远不如它在自家主场 Google AI Studio 里表现得好。</p>
<p>IDE 插件往往会对 Prompt 进行一层包装，或者受限于上下文窗口的截断，导致模型发挥受限。</p>
<p>所以，我又在Google AI Studio里构建了一次，呈现的效果完全不同：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/665dea482777439d8164ed6599cdf239~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2h5bCUQUnlt6XlnYo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766125407&amp;x-signature=OfEKPWRIHJVScXs8hm6mLLA2WH4%3D" alt="" loading="lazy"/></p>
<p>震动效果、音效，交互感，远胜于copilot下的Gemini3，也比其它的模型的完成度高得多。</p>
<h2 data-id="heading-7">风险：迷信“最新版”的代价</h2>
<p>这次测试倒是给了我一个不一样的审视最新模型的视角，也许，在 AI 编程领域，最新 ≠ 最好，Max ≠ 最强。</p>
<p>很多团队在做技术选型时，习惯性地把所有业务都切到最新模型上，结果往往是成本飙升，效果却不升反降。</p>
<p>也许，当下模型的能力正在逐步靠近瓶颈期，“更新换代”所带来的提升正在逐步减少，上下文工程的重要性越来越大。</p>
<h3 data-id="heading-8">结语：几个落地建议</h3>
<p><strong>1. 过度推理的陷阱：</strong></p>
<p>像 GPT 5.1 Codex Max 这种“聪明过头”的模型，很容易在简单任务上加戏。</p>
<p>对策：对于 CRUD 或基础逻辑代码，强制指定使用参数量较小、针对代码微调过的版本（如 Codex 基础版）。</p>
<p><strong>2. 指令遵循的随机性：</strong></p>
<p>强如 GPT 5.2 也会把 FPS 做成横版游戏。</p>
<p>对策：不要过度迷信“一句话生成”，将复杂需求拆解为 Step-by-Step 的原子指令。先让它写大纲，确认理解无误后，再让它写代码。</p>
<p><strong>3. “各取所长”：</strong></p>
<p>尝试“组合拳”。用 Codex 写后端逻辑和核心算法与任务规划，让Gemini3来干活或者做前端的设计。</p>
<p><strong>总之，无论 AI 多强，永远保留人工 Review 的环节。毕竟，它可能连左右都分不清。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc69eb0f80ca4978bbc63fb13d232e64~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2h5bCUQUnlt6XlnYo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766125407&amp;x-signature=5CTcS2myE6xZFK9F9MCKOHnqb4k%3D" alt="5d07d16b6eaccf139cbda4690946282d.jpg" loading="lazy"/>
我是Carl，我们下期再见。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6b825656fd44ffb96ff432acd32d4b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2h5bCUQUnlt6XlnYo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766125407&amp;x-signature=gZX67852hk7xDfacYO0JqF6sCNs%3D" alt="微信图片_20251212142244_1280_235.jpg" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java设计模式实战指南：创建型模式深度解析]]></title>    <link>https://juejin.cn/post/7582808491582472228</link>    <guid>https://juejin.cn/post/7582808491582472228</guid>    <pubDate>2025-12-12T04:44:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582808491582472228" data-draft-id="7582539701146533929" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java设计模式实战指南：创建型模式深度解析"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-12-12T04:44:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吃西红柿长大的番茄"/> <meta itemprop="url" content="https://juejin.cn/user/3097787706900985"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java设计模式实战指南：创建型模式深度解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3097787706900985/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吃西红柿长大的番茄
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T04:44:13.000Z" title="Fri Dec 12 2025 04:44:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    12
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读21分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.7;font-weight:400;font-size:16px;overflow-x:hidden;color:#212122}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:8px;padding-bottom:8px}.markdown-body h1{color:#a0a0a0;font-size:38px;margin-top:32px;padding-top:32px}.markdown-body h2{color:#fff;background-color:#212122;width:fit-content;border-bottom-right-radius:100px;margin-top:47px;margin-bottom:16px;padding:4px 48px 4px 8px;line-height:1.7;font-size:30px;transition:all .3s ease-out}.markdown-body h2:hover{border-bottom-right-radius:50px;transition:all .3s ease-out}.markdown-body h3{font-size:24px;padding-left:8px;margin-top:32px;border-bottom:2px solid #c6c4c4;line-height:1.7}.markdown-body h4{font-size:20px;padding-left:8px;margin-top:32px;border-bottom:1px solid #ddd}.markdown-body h5{font-size:16px;margin-top:24px}.markdown-body h6{margin-top:16px;line-height:1.1}.markdown-body p{font-size:16px;text-align:start;white-space:normal;text-size-adjust:auto;line-height:2;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%;margin:auto;padding-left:8px;padding-right:8px}.markdown-body hr{border:none;border-top:4px double #212122;margin-top:32px;margin-bottom:32px;text-align:center}.markdown-body hr:after{content:"♥";display:inline-block;position:relative;top:-15px;padding:0 10px;color:#212122;font-size:18px}.markdown-body code{word-break:break-word;overflow-x:auto;background-color:#f1f1f1;color:#ef7060;font-size:14px;padding:.065em 6px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.7;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);margin:32px 16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-color:#212122;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);background-size:40px}.markdown-body pre&gt;code{font-size:14px;padding:16px 8px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#fff;background:#272822}.markdown-body pre&gt;code::-webkit-scrollbar{height:10px;background-color:#f5f5f5}.markdown-body pre&gt;code::-webkit-scrollbar-track{box-shadow:inset 0 0 6px rgba(0,0,0,.3);border-radius:3px;background-color:#f5f5f5}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{border-radius:3px;box-shadow:inset 0 0 6px rgba(0,0,0,.3);background-color:#555}.markdown-body a{color:#ef7060;padding:2px;text-decoration:none;border-bottom:.125em solid #ef7060;border-radius:2px;box-shadow:inset 0 -.025em 0 #ef7060;transition:box-shadow .27s cubic-bezier(.77,0,.175,1),color .27s cubic-bezier(.77,0,.175,1)}.markdown-body a:focus,.markdown-body a:hover{outline:none;box-shadow:inset 0 -1.5em 0 #ef7060;color:#fff}.markdown-body a:before{content:"⇲ ";vertical-align:top;margin-left:2px;font-family:dart!important;font-size:12px;color:inherit;opacity:.7}.markdown-body table{background:#fbfbfb;border-radius:4px;border-collapse:collapse;margin:auto;padding:5px;width:95%;box-shadow:0 5px 10px rgba(0,0,0,.1);animation:float 5s infinite}.markdown-body table th{color:#fff;background:#212122;border-bottom:1px solid #9ea7af;border-right:1px solid #343a45;font-size:18px;padding:16px;text-align:left;vertical-align:middle}.markdown-body table th:first-child{border-top-left-radius:4px}.markdown-body table th:last-child{border-top-right-radius:4px;border-right:none}.markdown-body table tr{border-top:1px solid #c1c3d1;border-bottom:1px solid #c1c3d1;color:#666b85}.markdown-body table tr:hover td{background:#212122;color:#fff;border-top:1px solid #22262e}.markdown-body table tr:first-child{border-top:none}.markdown-body table tr:last-child{border-bottom:none}.markdown-body table tr:nth-child(odd) td{background:#f1f1f1}.markdown-body table tr:nth-child(odd):hover td{background:#212122}.markdown-body table tr:last-child td:first-child{border-bottom-left-radius:4px}.markdown-body table tr:last-child td:last-child{border-bottom-right-radius:4px}.markdown-body table td{background:#fbfbfb;padding:16px;text-align:left;vertical-align:middle;font-size:16px;border-right:1px solid #c1c3d1}.markdown-body table td:last-child{border-right:0}.markdown-body blockquote{color:#777;padding:1px 16px;margin:24px 0;border-left:4px solid #c6c4c4;background-color:#f1f1f1;transition:all .3s ease-out;border-radius:4px}.markdown-body blockquote:hover{border-left-color:#212122;background-color:#212122;color:#fff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:24px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body span.math{margin-left:32px;font-size:18px;font-weight:700}@media (max-width:720px){.markdown-body h1{font-size:30.4px}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:19.2px}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:12.8px}}</style><style data-highlight="" data-highlight-key="a11y-light">.hljs-comment,.hljs-quote{color:#696969}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#d91e18}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#aa5d00}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:green}.hljs-section,.hljs-title{color:#007faa}.hljs-keyword,.hljs-selector-tag{color:#7928a1}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fefefe;color:#545454}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">引言：设计模式的重要性</h2>
<p>想象一下建造一座高楼大厦。没有蓝图和标准施工方法，每个建筑工人按自己的想法随意建造，结果会是灾难性的。同样，在软件开发中，设计模式就是经过验证的“蓝图”，它帮助我们构建可维护、可扩展、可复用的代码。设计模式不是具体代码，而是解决特定问题的<strong>思想模型</strong>。</p>
<h2 data-id="heading-1">设计模式分类概览</h2>
<pre><code class="hljs language-java" lang="java">设计模式分为三大类：
├── 创建型模式 (Creational Patterns)
│   ├── 单例模式 (Singleton)
│   ├── 工厂方法模式 (Factory Method)
│   ├── 抽象工厂模式 (Abstract Factory)
│   ├── 建造者模式 (Builder)
│   └── 原型模式 (Prototype)
│
├── 结构型模式 (Structural Patterns)
│   ├── 适配器模式 (Adapter)
│   ├── 装饰器模式 (Decorator)
│   ├── 代理模式 (Proxy)
│   └── ...
│
└── 行为型模式 (Behavioral Patterns)
    ├── 观察者模式 (Observer)
    ├── 策略模式 (Strategy)
    ├── 责任链模式 (Chain of Responsibility)
    └── ...
</code></pre>
<p>本文将深入探讨<strong>创建型模式</strong>，这些模式关注对象的创建过程，隐藏创建细节，使系统独立于对象的创建、组合和表示。</p>
<h2 data-id="heading-2">单例模式：确保唯一性</h2>
<h3 data-id="heading-3">问题场景</h3>
<p>在某些情况下，系统中只需要一个类的实例，比如：</p>
<ul>
<li>数据库连接池</li>
<li>配置文件管理器</li>
<li>日志记录器</li>
<li>线程池</li>
</ul>
<h3 data-id="heading-4">多种实现方式对比</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SingletonPattern</span> {
    
    <span class="hljs-comment">// 方式1：饿汉式（线程安全，但可能造成资源浪费）</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EagerSingleton</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">EagerSingleton</span> <span class="hljs-variable">INSTANCE</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EagerSingleton</span>();
        
        <span class="hljs-keyword">private</span> <span class="hljs-title function_">EagerSingleton</span><span class="hljs-params">()</span> {
            <span class="hljs-comment">// 私有构造器防止外部实例化</span>
            System.out.println(<span class="hljs-string">"饿汉式单例被创建"</span>);
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> EagerSingleton <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> INSTANCE;
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doSomething</span><span class="hljs-params">()</span> {
            System.out.println(<span class="hljs-string">"饿汉式单例工作"</span>);
        }
    }
    
    <span class="hljs-comment">// 方式2：懒汉式（线程不安全）</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LazySingleton</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> LazySingleton instance;
        
        <span class="hljs-keyword">private</span> <span class="hljs-title function_">LazySingleton</span><span class="hljs-params">()</span> {
            System.out.println(<span class="hljs-string">"懒汉式单例被创建"</span>);
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> LazySingleton <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) {
                instance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LazySingleton</span>();  <span class="hljs-comment">// 多线程环境下可能创建多个实例</span>
            }
            <span class="hljs-keyword">return</span> instance;
        }
    }
    
    <span class="hljs-comment">// 方式3：同步方法懒汉式（线程安全但效率低）</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SynchronizedLazySingleton</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SynchronizedLazySingleton instance;
        
        <span class="hljs-keyword">private</span> <span class="hljs-title function_">SynchronizedLazySingleton</span><span class="hljs-params">()</span> {
            System.out.println(<span class="hljs-string">"同步懒汉式单例被创建"</span>);
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">synchronized</span> SynchronizedLazySingleton <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) {
                instance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SynchronizedLazySingleton</span>();
            }
            <span class="hljs-keyword">return</span> instance;
        }
    }
    
    <span class="hljs-comment">// 方式4：双重检查锁定（DCL）</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DoubleCheckedSingleton</span> {
        <span class="hljs-comment">// 使用volatile防止指令重排序</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">volatile</span> DoubleCheckedSingleton instance;
        
        <span class="hljs-keyword">private</span> <span class="hljs-title function_">DoubleCheckedSingleton</span><span class="hljs-params">()</span> {
            System.out.println(<span class="hljs-string">"双重检查单例被创建"</span>);
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> DoubleCheckedSingleton <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) {  <span class="hljs-comment">// 第一次检查，避免不必要的同步</span>
                <span class="hljs-keyword">synchronized</span> (DoubleCheckedSingleton.class) {
                    <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) {  <span class="hljs-comment">// 第二次检查，确保唯一性</span>
                        instance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DoubleCheckedSingleton</span>();
                    }
                }
            }
            <span class="hljs-keyword">return</span> instance;
        }
    }
    
    <span class="hljs-comment">// 方式5：静态内部类（推荐）</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StaticInnerClassSingleton</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-title function_">StaticInnerClassSingleton</span><span class="hljs-params">()</span> {
            System.out.println(<span class="hljs-string">"静态内部类单例被创建"</span>);
        }
        
        <span class="hljs-comment">// 静态内部类在第一次使用时才会加载</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SingletonHolder</span> {
            <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">StaticInnerClassSingleton</span> <span class="hljs-variable">INSTANCE</span> <span class="hljs-operator">=</span> 
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">StaticInnerClassSingleton</span>();
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> StaticInnerClassSingleton <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> SingletonHolder.INSTANCE;
        }
    }
    
    <span class="hljs-comment">// 方式6：枚举单例（最安全，防止反射攻击和序列化问题）</span>
    <span class="hljs-keyword">enum</span> <span class="hljs-title class_">EnumSingleton</span> {
        INSTANCE;
        
        <span class="hljs-keyword">private</span> <span class="hljs-title function_">EnumSingleton</span><span class="hljs-params">()</span> {
            System.out.println(<span class="hljs-string">"枚举单例被创建"</span>);
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doSomething</span><span class="hljs-params">()</span> {
            System.out.println(<span class="hljs-string">"枚举单例工作"</span>);
        }
    }
    
    <span class="hljs-comment">// 测试代码</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 测试饿汉式</span>
        <span class="hljs-type">EagerSingleton</span> <span class="hljs-variable">eager1</span> <span class="hljs-operator">=</span> EagerSingleton.getInstance();
        <span class="hljs-type">EagerSingleton</span> <span class="hljs-variable">eager2</span> <span class="hljs-operator">=</span> EagerSingleton.getInstance();
        System.out.println(<span class="hljs-string">"饿汉式是否是同一个实例: "</span> + (eager1 == eager2));
        
        <span class="hljs-comment">// 测试双重检查</span>
        <span class="hljs-type">DoubleCheckedSingleton</span> <span class="hljs-variable">dcl1</span> <span class="hljs-operator">=</span> DoubleCheckedSingleton.getInstance();
        <span class="hljs-type">DoubleCheckedSingleton</span> <span class="hljs-variable">dcl2</span> <span class="hljs-operator">=</span> DoubleCheckedSingleton.getInstance();
        System.out.println(<span class="hljs-string">"双重检查是否是同一个实例: "</span> + (dcl1 == dcl2));
        
        <span class="hljs-comment">// 测试枚举单例</span>
        <span class="hljs-type">EnumSingleton</span> <span class="hljs-variable">enum1</span> <span class="hljs-operator">=</span> EnumSingleton.INSTANCE;
        <span class="hljs-type">EnumSingleton</span> <span class="hljs-variable">enum2</span> <span class="hljs-operator">=</span> EnumSingleton.INSTANCE;
        System.out.println(<span class="hljs-string">"枚举是否是同一个实例: "</span> + (enum1 == enum2));
        enum1.doSomething();
    }
}
</code></pre>
<h3 data-id="heading-5">实际应用：数据库连接池</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 数据库连接池的单例实现</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseConnectionPool</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> DatabaseConnectionPool instance;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;Connection&gt; connectionPool;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> maxConnections;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String url;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String username;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String password;
    
    <span class="hljs-keyword">private</span> <span class="hljs-title function_">DatabaseConnectionPool</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">this</span>.maxConnections = <span class="hljs-number">10</span>;
        <span class="hljs-built_in">this</span>.url = <span class="hljs-string">"jdbc:mysql://localhost:3306/mydb"</span>;
        <span class="hljs-built_in">this</span>.username = <span class="hljs-string">"root"</span>;
        <span class="hljs-built_in">this</span>.password = <span class="hljs-string">"password"</span>;
        <span class="hljs-built_in">this</span>.connectionPool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        
        <span class="hljs-comment">// 初始化连接池</span>
        initializePool();
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">synchronized</span> DatabaseConnectionPool <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) {
            instance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DatabaseConnectionPool</span>();
        }
        <span class="hljs-keyword">return</span> instance;
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initializePool</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; maxConnections; i++) {
                <span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> DriverManager.getConnection(url, username, password);
                connectionPool.add(conn);
            }
            System.out.println(<span class="hljs-string">"数据库连接池初始化完成，连接数: "</span> + connectionPool.size());
        } <span class="hljs-keyword">catch</span> (SQLException e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"初始化数据库连接池失败"</span>, e);
        }
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> Connection <span class="hljs-title function_">getConnection</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (connectionPool.isEmpty()) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"连接池已耗尽"</span>);
        }
        <span class="hljs-keyword">return</span> connectionPool.remove(<span class="hljs-number">0</span>);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">releaseConnection</span><span class="hljs-params">(Connection conn)</span> {
        <span class="hljs-keyword">if</span> (connectionPool.size() &lt; maxConnections) {
            connectionPool.add(conn);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">try</span> {
                conn.close();
            } <span class="hljs-keyword">catch</span> (SQLException e) {
                e.printStackTrace();
            }
        }
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">closeAllConnections</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">for</span> (Connection conn : connectionPool) {
            <span class="hljs-keyword">try</span> {
                conn.close();
            } <span class="hljs-keyword">catch</span> (SQLException e) {
                e.printStackTrace();
            }
        }
        connectionPool.clear();
    }
}
</code></pre>
<h2 data-id="heading-6">工厂方法模式：解耦创建逻辑</h2>
<h3 data-id="heading-7">问题场景</h3>
<p>当创建对象的过程比较复杂，或者需要根据不同的条件创建不同的对象时，直接使用<code>new</code>关键字会使得代码耦合度高，难以维护。</p>
<h3 data-id="heading-8">基本实现</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FactoryMethodPattern</span> {
    
    <span class="hljs-comment">// 产品接口</span>
    <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Shape</span> {
        <span class="hljs-keyword">void</span> <span class="hljs-title function_">draw</span><span class="hljs-params">()</span>;
        <span class="hljs-type">double</span> <span class="hljs-title function_">getArea</span><span class="hljs-params">()</span>;
    }
    
    <span class="hljs-comment">// 具体产品</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Circle</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Shape</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> radius;
        
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">Circle</span><span class="hljs-params">(<span class="hljs-type">double</span> radius)</span> {
            <span class="hljs-built_in">this</span>.radius = radius;
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">draw</span><span class="hljs-params">()</span> {
            System.out.println(<span class="hljs-string">"绘制圆形，半径: "</span> + radius);
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">getArea</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> Math.PI * radius * radius;
        }
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Rectangle</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Shape</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> width;
        <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> height;
        
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">Rectangle</span><span class="hljs-params">(<span class="hljs-type">double</span> width, <span class="hljs-type">double</span> height)</span> {
            <span class="hljs-built_in">this</span>.width = width;
            <span class="hljs-built_in">this</span>.height = height;
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">draw</span><span class="hljs-params">()</span> {
            System.out.println(<span class="hljs-string">"绘制矩形，宽: "</span> + width + <span class="hljs-string">", 高: "</span> + height);
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">getArea</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> width * height;
        }
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Square</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Shape</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> side;
        
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">Square</span><span class="hljs-params">(<span class="hljs-type">double</span> side)</span> {
            <span class="hljs-built_in">this</span>.side = side;
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">draw</span><span class="hljs-params">()</span> {
            System.out.println(<span class="hljs-string">"绘制正方形，边长: "</span> + side);
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">getArea</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> side * side;
        }
    }
    
    <span class="hljs-comment">// 工厂接口</span>
    <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ShapeFactory</span> {
        Shape <span class="hljs-title function_">createShape</span><span class="hljs-params">()</span>;
    }
    
    <span class="hljs-comment">// 具体工厂</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CircleFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ShapeFactory</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">double</span> radius;
        
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">CircleFactory</span><span class="hljs-params">(<span class="hljs-type">double</span> radius)</span> {
            <span class="hljs-built_in">this</span>.radius = radius;
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> Shape <span class="hljs-title function_">createShape</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Circle</span>(radius);
        }
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RectangleFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ShapeFactory</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">double</span> width;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">double</span> height;
        
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">RectangleFactory</span><span class="hljs-params">(<span class="hljs-type">double</span> width, <span class="hljs-type">double</span> height)</span> {
            <span class="hljs-built_in">this</span>.width = width;
            <span class="hljs-built_in">this</span>.height = height;
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> Shape <span class="hljs-title function_">createShape</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Rectangle</span>(width, height);
        }
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SquareFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ShapeFactory</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">double</span> side;
        
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">SquareFactory</span><span class="hljs-params">(<span class="hljs-type">double</span> side)</span> {
            <span class="hljs-built_in">this</span>.side = side;
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> Shape <span class="hljs-title function_">createShape</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Square</span>(side);
        }
    }
    
    <span class="hljs-comment">// 客户端代码</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 使用工厂创建对象</span>
        <span class="hljs-type">ShapeFactory</span> <span class="hljs-variable">circleFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CircleFactory</span>(<span class="hljs-number">5.0</span>);
        <span class="hljs-type">Shape</span> <span class="hljs-variable">circle</span> <span class="hljs-operator">=</span> circleFactory.createShape();
        circle.draw();
        System.out.println(<span class="hljs-string">"圆形面积: "</span> + circle.getArea());
        
        <span class="hljs-type">ShapeFactory</span> <span class="hljs-variable">rectangleFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RectangleFactory</span>(<span class="hljs-number">4.0</span>, <span class="hljs-number">6.0</span>);
        <span class="hljs-type">Shape</span> <span class="hljs-variable">rectangle</span> <span class="hljs-operator">=</span> rectangleFactory.createShape();
        rectangle.draw();
        System.out.println(<span class="hljs-string">"矩形面积: "</span> + rectangle.getArea());
        
        <span class="hljs-comment">// 通过配置文件决定使用哪个工厂</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">shapeType</span> <span class="hljs-operator">=</span> <span class="hljs-string">"square"</span>; <span class="hljs-comment">// 可以从配置文件中读取</span>
        <span class="hljs-type">ShapeFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> createFactory(shapeType, <span class="hljs-number">3.0</span>, <span class="hljs-number">0.0</span>);
        <span class="hljs-type">Shape</span> <span class="hljs-variable">shape</span> <span class="hljs-operator">=</span> factory.createShape();
        shape.draw();
    }
    
    <span class="hljs-comment">// 根据类型创建工厂（可以扩展为从配置文件读取）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ShapeFactory <span class="hljs-title function_">createFactory</span><span class="hljs-params">(String type, <span class="hljs-type">double</span> param1, <span class="hljs-type">double</span> param2)</span> {
        <span class="hljs-keyword">switch</span> (type.toLowerCase()) {
            <span class="hljs-keyword">case</span> <span class="hljs-string">"circle"</span>:
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CircleFactory</span>(param1);
            <span class="hljs-keyword">case</span> <span class="hljs-string">"rectangle"</span>:
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RectangleFactory</span>(param1, param2);
            <span class="hljs-keyword">case</span> <span class="hljs-string">"square"</span>:
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SquareFactory</span>(param1);
            <span class="hljs-keyword">default</span>:
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"不支持的形状类型: "</span> + type);
        }
    }
}
</code></pre>
<h3 data-id="heading-9">实际应用：数据库连接工厂</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 数据库连接工厂</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseConnectionFactory</span> {
    
    <span class="hljs-comment">// 数据库类型枚举</span>
    <span class="hljs-keyword">enum</span> <span class="hljs-title class_">DatabaseType</span> {
        MYSQL,
        POSTGRESQL,
        ORACLE,
        SQLSERVER
    }
    
    <span class="hljs-comment">// 数据库连接接口</span>
    <span class="hljs-keyword">interface</span> <span class="hljs-title class_">DatabaseConnection</span> {
        Connection <span class="hljs-title function_">getConnection</span><span class="hljs-params">()</span>;
        String <span class="hljs-title function_">getDatabaseInfo</span><span class="hljs-params">()</span>;
        <span class="hljs-keyword">void</span> <span class="hljs-title function_">executeQuery</span><span class="hljs-params">(String sql)</span>;
    }
    
    <span class="hljs-comment">// MySQL连接实现</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MySQLConnection</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">DatabaseConnection</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String url;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String username;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String password;
        
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">MySQLConnection</span><span class="hljs-params">(String url, String username, String password)</span> {
            <span class="hljs-built_in">this</span>.url = url;
            <span class="hljs-built_in">this</span>.username = username;
            <span class="hljs-built_in">this</span>.password = password;
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> Connection <span class="hljs-title function_">getConnection</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">return</span> DriverManager.getConnection(url, username, password);
            } <span class="hljs-keyword">catch</span> (SQLException e) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"MySQL连接失败"</span>, e);
            }
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getDatabaseInfo</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"MySQL数据库连接: "</span> + url;
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">executeQuery</span><span class="hljs-params">(String sql)</span> {
            <span class="hljs-keyword">try</span> (<span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> getConnection();
                 <span class="hljs-type">Statement</span> <span class="hljs-variable">stmt</span> <span class="hljs-operator">=</span> conn.createStatement()) {
                stmt.execute(sql);
                System.out.println(<span class="hljs-string">"MySQL查询执行成功: "</span> + sql);
            } <span class="hljs-keyword">catch</span> (SQLException e) {
                e.printStackTrace();
            }
        }
    }
    
    <span class="hljs-comment">// PostgreSQL连接实现</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PostgreSQLConnection</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">DatabaseConnection</span> {
        <span class="hljs-comment">// 类似MySQLConnection的实现，省略...</span>
    }
    
    <span class="hljs-comment">// 数据库连接工厂</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConnectionFactory</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Properties config;
        
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">ConnectionFactory</span><span class="hljs-params">(String configFile)</span> {
            config = loadConfig(configFile);
        }
        
        <span class="hljs-keyword">public</span> DatabaseConnection <span class="hljs-title function_">createConnection</span><span class="hljs-params">(DatabaseType type)</span> {
            <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> config.getProperty(type.name().toLowerCase() + <span class="hljs-string">".url"</span>);
            <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> config.getProperty(type.name().toLowerCase() + <span class="hljs-string">".username"</span>);
            <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> config.getProperty(type.name().toLowerCase() + <span class="hljs-string">".password"</span>);
            
            <span class="hljs-keyword">switch</span> (type) {
                <span class="hljs-keyword">case</span> MYSQL:
                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MySQLConnection</span>(url, username, password);
                <span class="hljs-keyword">case</span> POSTGRESQL:
                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PostgreSQLConnection</span>(url, username, password);
                <span class="hljs-comment">// 其他数据库类型...</span>
                <span class="hljs-keyword">default</span>:
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"不支持的数据库类型: "</span> + type);
            }
        }
        
        <span class="hljs-keyword">private</span> Properties <span class="hljs-title function_">loadConfig</span><span class="hljs-params">(String configFile)</span> {
            <span class="hljs-type">Properties</span> <span class="hljs-variable">props</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();
            <span class="hljs-keyword">try</span> (<span class="hljs-type">InputStream</span> <span class="hljs-variable">input</span> <span class="hljs-operator">=</span> getClass().getClassLoader().getResourceAsStream(configFile)) {
                props.load(input);
            } <span class="hljs-keyword">catch</span> (IOException e) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"加载配置文件失败"</span>, e);
            }
            <span class="hljs-keyword">return</span> props;
        }
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 使用工厂创建数据库连接</span>
        <span class="hljs-type">ConnectionFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConnectionFactory</span>(<span class="hljs-string">"database.properties"</span>);
        <span class="hljs-type">DatabaseConnection</span> <span class="hljs-variable">mysqlConn</span> <span class="hljs-operator">=</span> factory.createConnection(DatabaseType.MYSQL);
        System.out.println(mysqlConn.getDatabaseInfo());
        mysqlConn.executeQuery(<span class="hljs-string">"SELECT * FROM users"</span>);
        
        <span class="hljs-comment">// 切换数据库类型只需修改参数</span>
        <span class="hljs-type">DatabaseConnection</span> <span class="hljs-variable">pgConn</span> <span class="hljs-operator">=</span> factory.createConnection(DatabaseType.POSTGRESQL);
        System.out.println(pgConn.getDatabaseInfo());
    }
}
</code></pre>
<h2 data-id="heading-10">抽象工厂模式：创建产品族</h2>
<h3 data-id="heading-11">问题场景</h3>
<p>当需要创建一系列相关或相互依赖的对象时，比如：</p>
<ul>
<li>GUI组件：不同操作系统的按钮、文本框、对话框</li>
<li>数据库访问：不同数据库的连接、命令、适配器</li>
<li>游戏开发：不同主题的角色、武器、场景</li>
</ul>
<h3 data-id="heading-12">基本实现</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractFactoryPattern</span> {
    
    <span class="hljs-comment">// 抽象产品A：UI组件</span>
    <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Button</span> {
        <span class="hljs-keyword">void</span> <span class="hljs-title function_">render</span><span class="hljs-params">()</span>;
        <span class="hljs-keyword">void</span> <span class="hljs-title function_">onClick</span><span class="hljs-params">()</span>;
    }
    
    <span class="hljs-keyword">interface</span> <span class="hljs-title class_">TextField</span> {
        <span class="hljs-keyword">void</span> <span class="hljs-title function_">render</span><span class="hljs-params">()</span>;
        String <span class="hljs-title function_">getText</span><span class="hljs-params">()</span>;
        <span class="hljs-keyword">void</span> <span class="hljs-title function_">setText</span><span class="hljs-params">(String text)</span>;
    }
    
    <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Dialog</span> {
        <span class="hljs-keyword">void</span> <span class="hljs-title function_">render</span><span class="hljs-params">()</span>;
        <span class="hljs-keyword">void</span> <span class="hljs-title function_">addButton</span><span class="hljs-params">(Button button)</span>;
        <span class="hljs-keyword">void</span> <span class="hljs-title function_">addTextField</span><span class="hljs-params">(TextField field)</span>;
    }
    
    <span class="hljs-comment">// 具体产品：Windows风格</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WindowsButton</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Button</span> {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">render</span><span class="hljs-params">()</span> {
            System.out.println(<span class="hljs-string">"渲染Windows风格按钮"</span>);
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onClick</span><span class="hljs-params">()</span> {
            System.out.println(<span class="hljs-string">"Windows按钮被点击"</span>);
        }
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WindowsTextField</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">TextField</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">text</span> <span class="hljs-operator">=</span> <span class="hljs-string">""</span>;
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">render</span><span class="hljs-params">()</span> {
            System.out.println(<span class="hljs-string">"渲染Windows风格文本框，内容: "</span> + text);
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getText</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> text;
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setText</span><span class="hljs-params">(String text)</span> {
            <span class="hljs-built_in">this</span>.text = text;
        }
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WindowsDialog</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Dialog</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;Button&gt; buttons = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;TextField&gt; textFields = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">render</span><span class="hljs-params">()</span> {
            System.out.println(<span class="hljs-string">"渲染Windows风格对话框"</span>);
            System.out.println(<span class="hljs-string">"包含 "</span> + buttons.size() + <span class="hljs-string">" 个按钮"</span>);
            System.out.println(<span class="hljs-string">"包含 "</span> + textFields.size() + <span class="hljs-string">" 个文本框"</span>);
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addButton</span><span class="hljs-params">(Button button)</span> {
            buttons.add(button);
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addTextField</span><span class="hljs-params">(TextField field)</span> {
            textFields.add(field);
        }
    }
    
    <span class="hljs-comment">// 具体产品：Mac风格</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MacButton</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Button</span> {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">render</span><span class="hljs-params">()</span> {
            System.out.println(<span class="hljs-string">"渲染Mac风格按钮"</span>);
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onClick</span><span class="hljs-params">()</span> {
            System.out.println(<span class="hljs-string">"Mac按钮被点击"</span>);
        }
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MacTextField</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">TextField</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">text</span> <span class="hljs-operator">=</span> <span class="hljs-string">""</span>;
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">render</span><span class="hljs-params">()</span> {
            System.out.println(<span class="hljs-string">"渲染Mac风格文本框，内容: "</span> + text);
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getText</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> text;
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setText</span><span class="hljs-params">(String text)</span> {
            <span class="hljs-built_in">this</span>.text = text;
        }
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MacDialog</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Dialog</span> {
        <span class="hljs-comment">// 类似WindowsDialog的实现，省略...</span>
    }
    
    <span class="hljs-comment">// 抽象工厂</span>
    <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UIFactory</span> {
        Button <span class="hljs-title function_">createButton</span><span class="hljs-params">()</span>;
        TextField <span class="hljs-title function_">createTextField</span><span class="hljs-params">()</span>;
        Dialog <span class="hljs-title function_">createDialog</span><span class="hljs-params">()</span>;
    }
    
    <span class="hljs-comment">// 具体工厂：Windows工厂</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WindowsUIFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UIFactory</span> {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> Button <span class="hljs-title function_">createButton</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WindowsButton</span>();
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> TextField <span class="hljs-title function_">createTextField</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WindowsTextField</span>();
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> Dialog <span class="hljs-title function_">createDialog</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WindowsDialog</span>();
        }
    }
    
    <span class="hljs-comment">// 具体工厂：Mac工厂</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MacUIFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UIFactory</span> {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> Button <span class="hljs-title function_">createButton</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MacButton</span>();
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> TextField <span class="hljs-title function_">createTextField</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MacTextField</span>();
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> Dialog <span class="hljs-title function_">createDialog</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MacDialog</span>();
        }
    }
    
    <span class="hljs-comment">// 客户端代码</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Application</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UIFactory factory;
        <span class="hljs-keyword">private</span> Button button;
        <span class="hljs-keyword">private</span> TextField textField;
        <span class="hljs-keyword">private</span> Dialog dialog;
        
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">Application</span><span class="hljs-params">(UIFactory factory)</span> {
            <span class="hljs-built_in">this</span>.factory = factory;
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createUI</span><span class="hljs-params">()</span> {
            <span class="hljs-built_in">this</span>.button = factory.createButton();
            <span class="hljs-built_in">this</span>.textField = factory.createTextField();
            <span class="hljs-built_in">this</span>.dialog = factory.createDialog();
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">renderUI</span><span class="hljs-params">()</span> {
            System.out.println(<span class="hljs-string">"=== 渲染应用程序界面 ==="</span>);
            button.render();
            textField.render();
            dialog.render();
        }
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 根据配置决定使用哪个工厂</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">os</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">"os.name"</span>).toLowerCase();
        UIFactory factory;
        
        <span class="hljs-keyword">if</span> (os.contains(<span class="hljs-string">"win"</span>)) {
            factory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WindowsUIFactory</span>();
            System.out.println(<span class="hljs-string">"检测到Windows系统，使用Windows UI工厂"</span>);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (os.contains(<span class="hljs-string">"mac"</span>)) {
            factory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MacUIFactory</span>();
            System.out.println(<span class="hljs-string">"检测到Mac系统，使用Mac UI工厂"</span>);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>(<span class="hljs-string">"不支持的操作系统: "</span> + os);
        }
        
        <span class="hljs-comment">// 创建应用程序</span>
        <span class="hljs-type">Application</span> <span class="hljs-variable">app</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Application</span>(factory);
        app.createUI();
        app.renderUI();
    }
}
</code></pre>
<h3 data-id="heading-13">实际应用：数据库访问抽象工厂</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 数据库访问抽象工厂</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseAccessFactory</span> {
    
    <span class="hljs-comment">// 抽象产品：数据库连接</span>
    <span class="hljs-keyword">interface</span> <span class="hljs-title class_">DBConnection</span> {
        Connection <span class="hljs-title function_">connect</span><span class="hljs-params">()</span>;
        <span class="hljs-keyword">void</span> <span class="hljs-title function_">disconnect</span><span class="hljs-params">()</span>;
        <span class="hljs-type">boolean</span> <span class="hljs-title function_">isConnected</span><span class="hljs-params">()</span>;
    }
    
    <span class="hljs-comment">// 抽象产品：数据库命令</span>
    <span class="hljs-keyword">interface</span> <span class="hljs-title class_">DBCommand</span> {
        <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(String sql)</span>;
        ResultSet <span class="hljs-title function_">executeQuery</span><span class="hljs-params">(String sql)</span>;
        <span class="hljs-type">int</span> <span class="hljs-title function_">executeUpdate</span><span class="hljs-params">(String sql)</span>;
    }
    
    <span class="hljs-comment">// 抽象产品：数据适配器</span>
    <span class="hljs-keyword">interface</span> <span class="hljs-title class_">DBAdapter</span> {
        &lt;T&gt; List&lt;T&gt; <span class="hljs-title function_">executeQuery</span><span class="hljs-params">(String sql, RowMapper&lt;T&gt; mapper)</span>;
        <span class="hljs-type">int</span> <span class="hljs-title function_">executeUpdate</span><span class="hljs-params">(String sql, Object... params)</span>;
    }
    
    <span class="hljs-comment">// 行映射器接口</span>
    <span class="hljs-keyword">interface</span> <span class="hljs-title class_">RowMapper</span>&lt;T&gt; {
        T <span class="hljs-title function_">mapRow</span><span class="hljs-params">(ResultSet rs)</span> <span class="hljs-keyword">throws</span> SQLException;
    }
    
    <span class="hljs-comment">// MySQL具体产品</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MySQLConnection</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">DBConnection</span> {
        <span class="hljs-keyword">private</span> Connection connection;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String url;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String username;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String password;
        
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">MySQLConnection</span><span class="hljs-params">(String url, String username, String password)</span> {
            <span class="hljs-built_in">this</span>.url = url;
            <span class="hljs-built_in">this</span>.username = username;
            <span class="hljs-built_in">this</span>.password = password;
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> Connection <span class="hljs-title function_">connect</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">try</span> {
                connection = DriverManager.getConnection(url, username, password);
                System.out.println(<span class="hljs-string">"MySQL连接成功"</span>);
                <span class="hljs-keyword">return</span> connection;
            } <span class="hljs-keyword">catch</span> (SQLException e) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"MySQL连接失败"</span>, e);
            }
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">disconnect</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">if</span> (connection != <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">try</span> {
                    connection.close();
                    System.out.println(<span class="hljs-string">"MySQL连接关闭"</span>);
                } <span class="hljs-keyword">catch</span> (SQLException e) {
                    e.printStackTrace();
                }
            }
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isConnected</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">return</span> connection != <span class="hljs-literal">null</span> &amp;&amp; !connection.isClosed();
            } <span class="hljs-keyword">catch</span> (SQLException e) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
        }
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MySQLCommand</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">DBCommand</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Connection connection;
        
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">MySQLCommand</span><span class="hljs-params">(Connection connection)</span> {
            <span class="hljs-built_in">this</span>.connection = connection;
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(String sql)</span> {
            <span class="hljs-keyword">try</span> (<span class="hljs-type">Statement</span> <span class="hljs-variable">stmt</span> <span class="hljs-operator">=</span> connection.createStatement()) {
                stmt.execute(sql);
            } <span class="hljs-keyword">catch</span> (SQLException e) {
                e.printStackTrace();
            }
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> ResultSet <span class="hljs-title function_">executeQuery</span><span class="hljs-params">(String sql)</span> {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">Statement</span> <span class="hljs-variable">stmt</span> <span class="hljs-operator">=</span> connection.createStatement();
                <span class="hljs-keyword">return</span> stmt.executeQuery(sql);
            } <span class="hljs-keyword">catch</span> (SQLException e) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"查询执行失败"</span>, e);
            }
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">executeUpdate</span><span class="hljs-params">(String sql)</span> {
            <span class="hljs-keyword">try</span> (<span class="hljs-type">Statement</span> <span class="hljs-variable">stmt</span> <span class="hljs-operator">=</span> connection.createStatement()) {
                <span class="hljs-keyword">return</span> stmt.executeUpdate(sql);
            } <span class="hljs-keyword">catch</span> (SQLException e) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"更新执行失败"</span>, e);
            }
        }
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MySQLAdapter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">DBAdapter</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Connection connection;
        
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">MySQLAdapter</span><span class="hljs-params">(Connection connection)</span> {
            <span class="hljs-built_in">this</span>.connection = connection;
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> &lt;T&gt; List&lt;T&gt; <span class="hljs-title function_">executeQuery</span><span class="hljs-params">(String sql, RowMapper&lt;T&gt; mapper)</span> {
            List&lt;T&gt; results = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
            <span class="hljs-keyword">try</span> (<span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">stmt</span> <span class="hljs-operator">=</span> connection.prepareStatement(sql);
                 <span class="hljs-type">ResultSet</span> <span class="hljs-variable">rs</span> <span class="hljs-operator">=</span> stmt.executeQuery()) {
                
                <span class="hljs-keyword">while</span> (rs.next()) {
                    results.add(mapper.mapRow(rs));
                }
            } <span class="hljs-keyword">catch</span> (SQLException e) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"查询执行失败"</span>, e);
            }
            <span class="hljs-keyword">return</span> results;
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">executeUpdate</span><span class="hljs-params">(String sql, Object... params)</span> {
            <span class="hljs-keyword">try</span> (<span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">stmt</span> <span class="hljs-operator">=</span> connection.prepareStatement(sql)) {
                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; params.length; i++) {
                    stmt.setObject(i + <span class="hljs-number">1</span>, params[i]);
                }
                <span class="hljs-keyword">return</span> stmt.executeUpdate();
            } <span class="hljs-keyword">catch</span> (SQLException e) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"更新执行失败"</span>, e);
            }
        }
    }
    
    <span class="hljs-comment">// PostgreSQL具体产品（类似MySQL，省略）</span>
    
    <span class="hljs-comment">// 抽象工厂</span>
    <span class="hljs-keyword">interface</span> <span class="hljs-title class_">DatabaseFactory</span> {
        DBConnection <span class="hljs-title function_">createConnection</span><span class="hljs-params">()</span>;
        DBCommand <span class="hljs-title function_">createCommand</span><span class="hljs-params">(Connection connection)</span>;
        DBAdapter <span class="hljs-title function_">createAdapter</span><span class="hljs-params">(Connection connection)</span>;
    }
    
    <span class="hljs-comment">// MySQL工厂</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MySQLFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">DatabaseFactory</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String url;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String username;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String password;
        
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">MySQLFactory</span><span class="hljs-params">(String url, String username, String password)</span> {
            <span class="hljs-built_in">this</span>.url = url;
            <span class="hljs-built_in">this</span>.username = username;
            <span class="hljs-built_in">this</span>.password = password;
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> DBConnection <span class="hljs-title function_">createConnection</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MySQLConnection</span>(url, username, password);
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> DBCommand <span class="hljs-title function_">createCommand</span><span class="hljs-params">(Connection connection)</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MySQLCommand</span>(connection);
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> DBAdapter <span class="hljs-title function_">createAdapter</span><span class="hljs-params">(Connection connection)</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MySQLAdapter</span>(connection);
        }
    }
    
    <span class="hljs-comment">// PostgreSQL工厂（类似MySQLFactory，省略）</span>
    
    <span class="hljs-comment">// 客户端：数据库访问层</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseAccessLayer</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DatabaseFactory factory;
        <span class="hljs-keyword">private</span> DBConnection connection;
        <span class="hljs-keyword">private</span> DBCommand command;
        <span class="hljs-keyword">private</span> DBAdapter adapter;
        
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">DatabaseAccessLayer</span><span class="hljs-params">(DatabaseFactory factory)</span> {
            <span class="hljs-built_in">this</span>.factory = factory;
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">connect</span><span class="hljs-params">()</span> {
            connection = factory.createConnection();
            connection.connect();
            command = factory.createCommand(connection.connect());
            adapter = factory.createAdapter(connection.connect());
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">executeQuery</span><span class="hljs-params">(String sql)</span> {
            command.execute(sql);
        }
        
        <span class="hljs-keyword">public</span> &lt;T&gt; List&lt;T&gt; <span class="hljs-title function_">query</span><span class="hljs-params">(String sql, RowMapper&lt;T&gt; mapper)</span> {
            <span class="hljs-keyword">return</span> adapter.executeQuery(sql, mapper);
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">disconnect</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">if</span> (connection != <span class="hljs-literal">null</span>) {
                connection.disconnect();
            }
        }
    }
}
</code></pre>
<h2 data-id="heading-14">建造者模式：构建复杂对象</h2>
<h3 data-id="heading-15">问题场景</h3>
<p>当一个对象有多个属性，且构建过程复杂，或者需要构建不可变对象时，使用构造器会非常冗长且难以维护。</p>
<h3 data-id="heading-16">基本实现</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BuilderPattern</span> {
    
    <span class="hljs-comment">// 复杂产品：电脑</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Computer</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String cpu;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String motherboard;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String memory;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String storage;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String gpu;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String powerSupply;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String coolingSystem;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> hasBluetooth;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> hasWiFi;
        
        <span class="hljs-comment">// 私有构造器，只能通过Builder创建</span>
        <span class="hljs-keyword">private</span> <span class="hljs-title function_">Computer</span><span class="hljs-params">(Builder builder)</span> {
            <span class="hljs-built_in">this</span>.cpu = builder.cpu;
            <span class="hljs-built_in">this</span>.motherboard = builder.motherboard;
            <span class="hljs-built_in">this</span>.memory = builder.memory;
            <span class="hljs-built_in">this</span>.storage = builder.storage;
            <span class="hljs-built_in">this</span>.gpu = builder.gpu;
            <span class="hljs-built_in">this</span>.powerSupply = builder.powerSupply;
            <span class="hljs-built_in">this</span>.coolingSystem = builder.coolingSystem;
            <span class="hljs-built_in">this</span>.hasBluetooth = builder.hasBluetooth;
            <span class="hljs-built_in">this</span>.hasWiFi = builder.hasWiFi;
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"Computer配置:\n"</span> +
                   <span class="hljs-string">"  CPU: "</span> + cpu + <span class="hljs-string">"\n"</span> +
                   <span class="hljs-string">"  主板: "</span> + motherboard + <span class="hljs-string">"\n"</span> +
                   <span class="hljs-string">"  内存: "</span> + memory + <span class="hljs-string">"\n"</span> +
                   <span class="hljs-string">"  存储: "</span> + storage + <span class="hljs-string">"\n"</span> +
                   <span class="hljs-string">"  显卡: "</span> + (gpu != <span class="hljs-literal">null</span> ? gpu : <span class="hljs-string">"集成显卡"</span>) + <span class="hljs-string">"\n"</span> +
                   <span class="hljs-string">"  电源: "</span> + powerSupply + <span class="hljs-string">"\n"</span> +
                   <span class="hljs-string">"  散热: "</span> + coolingSystem + <span class="hljs-string">"\n"</span> +
                   <span class="hljs-string">"  蓝牙: "</span> + (hasBluetooth ? <span class="hljs-string">"有"</span> : <span class="hljs-string">"无"</span>) + <span class="hljs-string">"\n"</span> +
                   <span class="hljs-string">"  WiFi: "</span> + (hasWiFi ? <span class="hljs-string">"有"</span> : <span class="hljs-string">"无"</span>);
        }
        
        <span class="hljs-comment">// 建造者类</span>
        <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Builder</span> {
            <span class="hljs-comment">// 必需参数</span>
            <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String cpu;
            <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String motherboard;
            <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String memory;
            
            <span class="hljs-comment">// 可选参数（带默认值）</span>
            <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">storage</span> <span class="hljs-operator">=</span> <span class="hljs-string">"512GB SSD"</span>;
            <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">gpu</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;  <span class="hljs-comment">// 默认集成显卡</span>
            <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">powerSupply</span> <span class="hljs-operator">=</span> <span class="hljs-string">"500W 80+ Bronze"</span>;
            <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">coolingSystem</span> <span class="hljs-operator">=</span> <span class="hljs-string">"风冷"</span>;
            <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">hasBluetooth</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
            <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">hasWiFi</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
            
            <span class="hljs-comment">// 必需参数的构造器</span>
            <span class="hljs-keyword">public</span> <span class="hljs-title function_">Builder</span><span class="hljs-params">(String cpu, String motherboard, String memory)</span> {
                <span class="hljs-built_in">this</span>.cpu = cpu;
                <span class="hljs-built_in">this</span>.motherboard = motherboard;
                <span class="hljs-built_in">this</span>.memory = memory;
            }
            
            <span class="hljs-comment">// 可选参数设置方法</span>
            <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">storage</span><span class="hljs-params">(String storage)</span> {
                <span class="hljs-built_in">this</span>.storage = storage;
                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
            }
            
            <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">gpu</span><span class="hljs-params">(String gpu)</span> {
                <span class="hljs-built_in">this</span>.gpu = gpu;
                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
            }
            
            <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">powerSupply</span><span class="hljs-params">(String powerSupply)</span> {
                <span class="hljs-built_in">this</span>.powerSupply = powerSupply;
                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
            }
            
            <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">coolingSystem</span><span class="hljs-params">(String coolingSystem)</span> {
                <span class="hljs-built_in">this</span>.coolingSystem = coolingSystem;
                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
            }
            
            <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">hasBluetooth</span><span class="hljs-params">(<span class="hljs-type">boolean</span> hasBluetooth)</span> {
                <span class="hljs-built_in">this</span>.hasBluetooth = hasBluetooth;
                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
            }
            
            <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">hasWiFi</span><span class="hljs-params">(<span class="hljs-type">boolean</span> hasWiFi)</span> {
                <span class="hljs-built_in">this</span>.hasWiFi = hasWiFi;
                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
            }
            
            <span class="hljs-comment">// 构建方法</span>
            <span class="hljs-keyword">public</span> Computer <span class="hljs-title function_">build</span><span class="hljs-params">()</span> {
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Computer</span>(<span class="hljs-built_in">this</span>);
            }
        }
    }
    
    <span class="hljs-comment">// 使用示例</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 构建基础版电脑</span>
        <span class="hljs-type">Computer</span> <span class="hljs-variable">basicComputer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Computer</span>.Builder(<span class="hljs-string">"Intel i5"</span>, <span class="hljs-string">"B660"</span>, <span class="hljs-string">"16GB DDR4"</span>)
            .build();
        System.out.println(<span class="hljs-string">"基础版电脑:"</span>);
        System.out.println(basicComputer);
        
        System.out.println(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>.repeat(<span class="hljs-number">50</span>) + <span class="hljs-string">"\n"</span>);
        
        <span class="hljs-comment">// 构建游戏电脑</span>
        <span class="hljs-type">Computer</span> <span class="hljs-variable">gamingComputer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Computer</span>.Builder(<span class="hljs-string">"Intel i9"</span>, <span class="hljs-string">"Z790"</span>, <span class="hljs-string">"32GB DDR5"</span>)
            .storage(<span class="hljs-string">"2TB NVMe SSD"</span>)
            .gpu(<span class="hljs-string">"NVIDIA RTX 4080"</span>)
            .powerSupply(<span class="hljs-string">"850W 80+ Gold"</span>)
            .coolingSystem(<span class="hljs-string">"360mm水冷"</span>)
            .hasBluetooth(<span class="hljs-literal">true</span>)
            .hasWiFi(<span class="hljs-literal">true</span>)
            .build();
        System.out.println(<span class="hljs-string">"游戏电脑:"</span>);
        System.out.println(gamingComputer);
        
        System.out.println(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>.repeat(<span class="hljs-number">50</span>) + <span class="hljs-string">"\n"</span>);
        
        <span class="hljs-comment">// 构建办公电脑</span>
        <span class="hljs-type">Computer</span> <span class="hljs-variable">officeComputer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Computer</span>.Builder(<span class="hljs-string">"AMD Ryzen 7"</span>, <span class="hljs-string">"B650"</span>, <span class="hljs-string">"32GB DDR4"</span>)
            .storage(<span class="hljs-string">"1TB SSD"</span>)
            .gpu(<span class="hljs-string">"集成显卡"</span>)
            .hasWiFi(<span class="hljs-literal">true</span>)
            .build();
        System.out.println(<span class="hljs-string">"办公电脑:"</span>);
        System.out.println(officeComputer);
    }
}
</code></pre>
<h3 data-id="heading-17">实际应用：HTTP请求构建器</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// HTTP请求构建器</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HttpRequestBuilder</span> {
    
    <span class="hljs-comment">// HTTP请求类</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HttpRequest</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String url;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> HttpMethod method;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, String&gt; headers;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, String&gt; queryParams;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String body;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> timeout;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> followRedirects;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SSLContext sslContext;
        
        <span class="hljs-keyword">private</span> <span class="hljs-title function_">HttpRequest</span><span class="hljs-params">(Builder builder)</span> {
            <span class="hljs-built_in">this</span>.url = builder.url;
            <span class="hljs-built_in">this</span>.method = builder.method;
            <span class="hljs-built_in">this</span>.headers = Collections.unmodifiableMap(builder.headers);
            <span class="hljs-built_in">this</span>.queryParams = Collections.unmodifiableMap(builder.queryParams);
            <span class="hljs-built_in">this</span>.body = builder.body;
            <span class="hljs-built_in">this</span>.timeout = builder.timeout;
            <span class="hljs-built_in">this</span>.followRedirects = builder.followRedirects;
            <span class="hljs-built_in">this</span>.sslContext = builder.sslContext;
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">()</span> {
            System.out.println(<span class="hljs-string">"执行HTTP请求:"</span>);
            System.out.println(<span class="hljs-string">"  URL: "</span> + url);
            System.out.println(<span class="hljs-string">"  方法: "</span> + method);
            System.out.println(<span class="hljs-string">"  请求头: "</span> + headers);
            System.out.println(<span class="hljs-string">"  查询参数: "</span> + queryParams);
            System.out.println(<span class="hljs-string">"  请求体: "</span> + (body != <span class="hljs-literal">null</span> ? body.substring(<span class="hljs-number">0</span>, Math.min(<span class="hljs-number">50</span>, body.length())) : <span class="hljs-string">"null"</span>));
            System.out.println(<span class="hljs-string">"  超时: "</span> + timeout + <span class="hljs-string">"ms"</span>);
            System.out.println(<span class="hljs-string">"  跟随重定向: "</span> + followRedirects);
            
            <span class="hljs-comment">// 实际执行HTTP请求的代码...</span>
        }
        
        <span class="hljs-comment">// 获取完整URL（包含查询参数）</span>
        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getFullUrl</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">if</span> (queryParams.isEmpty()) {
                <span class="hljs-keyword">return</span> url;
            }
            
            <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">urlBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(url);
            urlBuilder.append(<span class="hljs-string">"?"</span>);
            
            <span class="hljs-type">boolean</span> <span class="hljs-variable">first</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">for</span> (Map.Entry&lt;String, String&gt; entry : queryParams.entrySet()) {
                <span class="hljs-keyword">if</span> (!first) {
                    urlBuilder.append(<span class="hljs-string">"&amp;"</span>);
                }
                urlBuilder.append(URLEncoder.encode(entry.getKey(), StandardCharsets.UTF_8))
                         .append(<span class="hljs-string">"="</span>)
                         .append(URLEncoder.encode(entry.getValue(), StandardCharsets.UTF_8));
                first = <span class="hljs-literal">false</span>;
            }
            
            <span class="hljs-keyword">return</span> urlBuilder.toString();
        }
        
        <span class="hljs-comment">// 建造者类</span>
        <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Builder</span> {
            <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String url;
            <span class="hljs-keyword">private</span> <span class="hljs-type">HttpMethod</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> HttpMethod.GET;
            <span class="hljs-keyword">private</span> Map&lt;String, String&gt; headers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
            <span class="hljs-keyword">private</span> Map&lt;String, String&gt; queryParams = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
            <span class="hljs-keyword">private</span> String body;
            <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">timeout</span> <span class="hljs-operator">=</span> <span class="hljs-number">10000</span>; <span class="hljs-comment">// 默认10秒</span>
            <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">followRedirects</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">private</span> SSLContext sslContext;
            
            <span class="hljs-keyword">public</span> <span class="hljs-title function_">Builder</span><span class="hljs-params">(String url)</span> {
                <span class="hljs-built_in">this</span>.url = url;
                <span class="hljs-comment">// 设置默认请求头</span>
                headers.put(<span class="hljs-string">"User-Agent"</span>, <span class="hljs-string">"HttpRequestBuilder/1.0"</span>);
                headers.put(<span class="hljs-string">"Accept"</span>, <span class="hljs-string">"application/json"</span>);
            }
            
            <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">method</span><span class="hljs-params">(HttpMethod method)</span> {
                <span class="hljs-built_in">this</span>.method = method;
                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
            }
            
            <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">header</span><span class="hljs-params">(String name, String value)</span> {
                <span class="hljs-built_in">this</span>.headers.put(name, value);
                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
            }
            
            <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">headers</span><span class="hljs-params">(Map&lt;String, String&gt; headers)</span> {
                <span class="hljs-built_in">this</span>.headers.putAll(headers);
                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
            }
            
            <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">queryParam</span><span class="hljs-params">(String name, String value)</span> {
                <span class="hljs-built_in">this</span>.queryParams.put(name, value);
                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
            }
            
            <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">queryParams</span><span class="hljs-params">(Map&lt;String, String&gt; params)</span> {
                <span class="hljs-built_in">this</span>.queryParams.putAll(params);
                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
            }
            
            <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">body</span><span class="hljs-params">(String body)</span> {
                <span class="hljs-built_in">this</span>.body = body;
                <span class="hljs-keyword">if</span> (body != <span class="hljs-literal">null</span> &amp;&amp; !headers.containsKey(<span class="hljs-string">"Content-Type"</span>)) {
                    headers.put(<span class="hljs-string">"Content-Type"</span>, <span class="hljs-string">"application/json"</span>);
                }
                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
            }
            
            <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">timeout</span><span class="hljs-params">(<span class="hljs-type">int</span> timeout)</span> {
                <span class="hljs-built_in">this</span>.timeout = timeout;
                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
            }
            
            <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">followRedirects</span><span class="hljs-params">(<span class="hljs-type">boolean</span> followRedirects)</span> {
                <span class="hljs-built_in">this</span>.followRedirects = followRedirects;
                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
            }
            
            <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">sslContext</span><span class="hljs-params">(SSLContext sslContext)</span> {
                <span class="hljs-built_in">this</span>.sslContext = sslContext;
                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
            }
            
            <span class="hljs-keyword">public</span> HttpRequest <span class="hljs-title function_">build</span><span class="hljs-params">()</span> {
                <span class="hljs-comment">// 验证必要参数</span>
                <span class="hljs-keyword">if</span> (url == <span class="hljs-literal">null</span> || url.trim().isEmpty()) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"URL不能为空"</span>);
                }
                
                <span class="hljs-comment">// 如果是POST/PUT请求且有body，确保Content-Type已设置</span>
                <span class="hljs-keyword">if</span> ((method == HttpMethod.POST || method == HttpMethod.PUT) &amp;&amp; body != <span class="hljs-literal">null</span>) {
                    <span class="hljs-keyword">if</span> (!headers.containsKey(<span class="hljs-string">"Content-Type"</span>)) {
                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"POST/PUT请求必须设置Content-Type"</span>);
                    }
                }
                
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpRequest</span>(<span class="hljs-built_in">this</span>);
            }
        }
    }
    
    <span class="hljs-comment">// HTTP方法枚举</span>
    <span class="hljs-keyword">enum</span> <span class="hljs-title class_">HttpMethod</span> {
        GET, POST, PUT, DELETE, PATCH, HEAD, OPTIONS
    }
    
    <span class="hljs-comment">// 使用示例</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 构建简单的GET请求</span>
        <span class="hljs-type">HttpRequest</span> <span class="hljs-variable">getRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpRequest</span>.Builder(<span class="hljs-string">"https://api.example.com/users"</span>)
            .method(HttpMethod.GET)
            .queryParam(<span class="hljs-string">"page"</span>, <span class="hljs-string">"1"</span>)
            .queryParam(<span class="hljs-string">"limit"</span>, <span class="hljs-string">"10"</span>)
            .header(<span class="hljs-string">"Authorization"</span>, <span class="hljs-string">"Bearer token123"</span>)
            .timeout(<span class="hljs-number">5000</span>)
            .build();
        
        getRequest.execute();
        System.out.println(<span class="hljs-string">"完整URL: "</span> + getRequest.getFullUrl());
        
        System.out.println(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>.repeat(<span class="hljs-number">50</span>) + <span class="hljs-string">"\n"</span>);
        
        <span class="hljs-comment">// 构建复杂的POST请求</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">jsonBody</span> <span class="hljs-operator">=</span> <span class="hljs-string">"{"</span>name<span class="hljs-string">":"</span>John<span class="hljs-string">","</span>email<span class="hljs-string">":"</span>john<span class="hljs-meta">@example</span>.com<span class="hljs-string">"}"</span>;
        
        <span class="hljs-type">HttpRequest</span> <span class="hljs-variable">postRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpRequest</span>.Builder(<span class="hljs-string">"https://api.example.com/users"</span>)
            .method(HttpMethod.POST)
            .header(<span class="hljs-string">"Authorization"</span>, <span class="hljs-string">"Bearer token123"</span>)
            .header(<span class="hljs-string">"Content-Type"</span>, <span class="hljs-string">"application/json"</span>)
            .body(jsonBody)
            .timeout(<span class="hljs-number">15000</span>)
            .followRedirects(<span class="hljs-literal">false</span>)
            .build();
        
        postRequest.execute();
    }
}
</code></pre>
<h2 data-id="heading-18">原型模式：克隆对象</h2>
<h3 data-id="heading-19">问题场景</h3>
<p>当创建对象的成本较高（如需要复杂的数据库查询、网络请求），或者需要创建大量相似对象时，使用原型模式可以提高性能。</p>
<h3 data-id="heading-20">基本实现</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PrototypePattern</span> {
    
    <span class="hljs-comment">// 原型接口</span>
    <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Prototype</span>&lt;T&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Cloneable</span> {
        T <span class="hljs-title function_">clone</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> CloneNotSupportedException;
        T <span class="hljs-title function_">deepClone</span><span class="hljs-params">()</span>;
    }
    
    <span class="hljs-comment">// 具体原型：简历</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Resume</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Prototype</span>&lt;Resume&gt; {
        <span class="hljs-keyword">private</span> String name;
        <span class="hljs-keyword">private</span> String email;
        <span class="hljs-keyword">private</span> String phone;
        <span class="hljs-keyword">private</span> WorkExperience workExperience;
        <span class="hljs-keyword">private</span> List&lt;String&gt; skills;
        
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">Resume</span><span class="hljs-params">(String name, String email, String phone)</span> {
            <span class="hljs-built_in">this</span>.name = name;
            <span class="hljs-built_in">this</span>.email = email;
            <span class="hljs-built_in">this</span>.phone = phone;
            <span class="hljs-built_in">this</span>.workExperience = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WorkExperience</span>();
            <span class="hljs-built_in">this</span>.skills = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        }
        
        <span class="hljs-comment">// 设置工作经验</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setWorkExperience</span><span class="hljs-params">(String company, String position, Date startDate, Date endDate)</span> {
            <span class="hljs-built_in">this</span>.workExperience = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WorkExperience</span>(company, position, startDate, endDate);
        }
        
        <span class="hljs-comment">// 添加技能</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addSkill</span><span class="hljs-params">(String skill)</span> {
            skills.add(skill);
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"简历信息:\n"</span> +
                   <span class="hljs-string">"  姓名: "</span> + name + <span class="hljs-string">"\n"</span> +
                   <span class="hljs-string">"  邮箱: "</span> + email + <span class="hljs-string">"\n"</span> +
                   <span class="hljs-string">"  电话: "</span> + phone + <span class="hljs-string">"\n"</span> +
                   <span class="hljs-string">"  工作经验: "</span> + workExperience + <span class="hljs-string">"\n"</span> +
                   <span class="hljs-string">"  技能: "</span> + skills;
        }
        
        <span class="hljs-comment">// 浅克隆（使用Java的clone方法）</span>
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> Resume <span class="hljs-title function_">clone</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> CloneNotSupportedException {
            <span class="hljs-keyword">return</span> (Resume) <span class="hljs-built_in">super</span>.clone();
        }
        
        <span class="hljs-comment">// 深克隆</span>
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> Resume <span class="hljs-title function_">deepClone</span><span class="hljs-params">()</span> {
            <span class="hljs-type">Resume</span> <span class="hljs-variable">cloned</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Resume</span>(<span class="hljs-built_in">this</span>.name, <span class="hljs-built_in">this</span>.email, <span class="hljs-built_in">this</span>.phone);
            
            <span class="hljs-comment">// 克隆工作经验（WorkExperience也需要实现深克隆）</span>
            cloned.workExperience = <span class="hljs-built_in">this</span>.workExperience.clone();
            
            <span class="hljs-comment">// 克隆技能列表</span>
            cloned.skills = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(<span class="hljs-built_in">this</span>.skills);
            
            <span class="hljs-keyword">return</span> cloned;
        }
        
        <span class="hljs-comment">// 修改姓名（用于测试克隆是否成功）</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> {
            <span class="hljs-built_in">this</span>.name = name;
        }
    }
    
    <span class="hljs-comment">// 工作经验类（也需要实现克隆）</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WorkExperience</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Cloneable</span> {
        <span class="hljs-keyword">private</span> String company;
        <span class="hljs-keyword">private</span> String position;
        <span class="hljs-keyword">private</span> Date startDate;
        <span class="hljs-keyword">private</span> Date endDate;
        
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">WorkExperience</span><span class="hljs-params">()</span> {
            <span class="hljs-comment">// 默认构造器</span>
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">WorkExperience</span><span class="hljs-params">(String company, String position, Date startDate, Date endDate)</span> {
            <span class="hljs-built_in">this</span>.company = company;
            <span class="hljs-built_in">this</span>.position = position;
            <span class="hljs-built_in">this</span>.startDate = (Date) startDate.clone();
            <span class="hljs-built_in">this</span>.endDate = (Date) endDate.clone();
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> company + <span class="hljs-string">" - "</span> + position + <span class="hljs-string">" ("</span> + startDate + <span class="hljs-string">" 至 "</span> + endDate + <span class="hljs-string">")"</span>;
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> WorkExperience <span class="hljs-title function_">clone</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">WorkExperience</span> <span class="hljs-variable">cloned</span> <span class="hljs-operator">=</span> (WorkExperience) <span class="hljs-built_in">super</span>.clone();
                <span class="hljs-comment">// Date是可变的，需要深克隆</span>
                cloned.startDate = (Date) <span class="hljs-built_in">this</span>.startDate.clone();
                cloned.endDate = (Date) <span class="hljs-built_in">this</span>.endDate.clone();
                <span class="hljs-keyword">return</span> cloned;
            } <span class="hljs-keyword">catch</span> (CloneNotSupportedException e) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"克隆失败"</span>, e);
            }
        }
    }
    
    <span class="hljs-comment">// 原型管理器</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PrototypeManager</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Map&lt;String, Prototype&lt;?&gt;&gt; prototypes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        
        <span class="hljs-keyword">static</span> {
            <span class="hljs-comment">// 预置一些原型</span>
            <span class="hljs-type">Resume</span> <span class="hljs-variable">defaultResume</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Resume</span>(<span class="hljs-string">"张三"</span>, <span class="hljs-string">"zhangsan@example.com"</span>, <span class="hljs-string">"13800138000"</span>);
            defaultResume.setWorkExperience(<span class="hljs-string">"ABC公司"</span>, <span class="hljs-string">"Java开发"</span>, 
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-number">121</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-number">123</span>, <span class="hljs-number">11</span>, <span class="hljs-number">31</span>));
            defaultResume.addSkill(<span class="hljs-string">"Java"</span>);
            defaultResume.addSkill(<span class="hljs-string">"Spring"</span>);
            defaultResume.addSkill(<span class="hljs-string">"MySQL"</span>);
            
            prototypes.put(<span class="hljs-string">"defaultResume"</span>, defaultResume);
            
            <span class="hljs-comment">// 可以添加更多原型...</span>
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerPrototype</span><span class="hljs-params">(String key, Prototype&lt;?&gt; prototype)</span> {
            prototypes.put(key, prototype);
        }
        
        <span class="hljs-meta">@SuppressWarnings("unchecked")</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Prototype</span>&lt;T&gt;&gt; T <span class="hljs-title function_">getPrototype</span><span class="hljs-params">(String key)</span> {
            Prototype&lt;T&gt; prototype = (Prototype&lt;T&gt;) prototypes.get(key);
            <span class="hljs-keyword">if</span> (prototype == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"未找到原型: "</span> + key);
            }
            <span class="hljs-keyword">return</span> prototype.clone();
        }
    }
    
    <span class="hljs-comment">// 使用示例</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> CloneNotSupportedException {
        System.out.println(<span class="hljs-string">"=== 直接克隆示例 ==="</span>);
        
        <span class="hljs-comment">// 创建原始简历</span>
        <span class="hljs-type">Resume</span> <span class="hljs-variable">original</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Resume</span>(<span class="hljs-string">"李四"</span>, <span class="hljs-string">"lisi@example.com"</span>, <span class="hljs-string">"13900139000"</span>);
        original.setWorkExperience(<span class="hljs-string">"XYZ公司"</span>, <span class="hljs-string">"高级开发"</span>, 
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-number">120</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-number">122</span>, <span class="hljs-number">11</span>, <span class="hljs-number">31</span>));
        original.addSkill(<span class="hljs-string">"Python"</span>);
        original.addSkill(<span class="hljs-string">"Django"</span>);
        
        System.out.println(<span class="hljs-string">"原始简历:"</span>);
        System.out.println(original);
        
        <span class="hljs-comment">// 浅克隆</span>
        <span class="hljs-type">Resume</span> <span class="hljs-variable">shallowClone</span> <span class="hljs-operator">=</span> original.clone();
        shallowClone.setName(<span class="hljs-string">"王五"</span>);  <span class="hljs-comment">// 修改克隆体的名字</span>
        
        System.out.println(<span class="hljs-string">"\n浅克隆后:"</span>);
        System.out.println(<span class="hljs-string">"原始简历: "</span> + original.name);
        System.out.println(<span class="hljs-string">"克隆简历: "</span> + shallowClone.name);
        
        <span class="hljs-comment">// 深克隆</span>
        <span class="hljs-type">Resume</span> <span class="hljs-variable">deepClone</span> <span class="hljs-operator">=</span> original.deepClone();
        deepClone.setName(<span class="hljs-string">"赵六"</span>);
        
        System.out.println(<span class="hljs-string">"\n深克隆后:"</span>);
        System.out.println(<span class="hljs-string">"原始简历: "</span> + original.name);
        System.out.println(<span class="hljs-string">"深克隆简历: "</span> + deepClone.name);
        
        System.out.println(<span class="hljs-string">"\n=== 原型管理器示例 ==="</span>);
        
        <span class="hljs-comment">// 使用原型管理器获取原型并克隆</span>
        <span class="hljs-type">Resume</span> <span class="hljs-variable">templateResume</span> <span class="hljs-operator">=</span> PrototypeManager.getPrototype(<span class="hljs-string">"defaultResume"</span>);
        System.out.println(<span class="hljs-string">"模板简历:"</span>);
        System.out.println(templateResume);
        
        <span class="hljs-comment">// 基于模板创建个性化简历</span>
        <span class="hljs-type">Resume</span> <span class="hljs-variable">myResume</span> <span class="hljs-operator">=</span> templateResume.deepClone();
        myResume.setName(<span class="hljs-string">"陈七"</span>);
        myResume.addSkill(<span class="hljs-string">"Redis"</span>);
        myResume.addSkill(<span class="hljs-string">"Docker"</span>);
        
        System.out.println(<span class="hljs-string">"\n个性化简历:"</span>);
        System.out.println(myResume);
        
        <span class="hljs-comment">// 注册新原型</span>
        <span class="hljs-type">Resume</span> <span class="hljs-variable">newTemplate</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Resume</span>(<span class="hljs-string">"新模板"</span>, <span class="hljs-string">"template@example.com"</span>, <span class="hljs-string">"10000000000"</span>);
        newTemplate.setWorkExperience(<span class="hljs-string">"模板公司"</span>, <span class="hljs-string">"模板职位"</span>, 
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-number">120</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-number">123</span>, <span class="hljs-number">11</span>, <span class="hljs-number">31</span>));
        newTemplate.addSkill(<span class="hljs-string">"模板技能1"</span>);
        newTemplate.addSkill(<span class="hljs-string">"模板技能2"</span>);
        
        PrototypeManager.registerPrototype(<span class="hljs-string">"newTemplate"</span>, newTemplate);
        
        System.out.println(<span class="hljs-string">"\n新模板已注册"</span>);
    }
}
</code></pre>
<h3 data-id="heading-21">实际应用：图形编辑器</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 图形编辑器原型模式实现</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GraphicEditorPrototype</span> {
    
    <span class="hljs-comment">// 图形接口</span>
    <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Graphic</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Cloneable</span> {
        <span class="hljs-keyword">void</span> <span class="hljs-title function_">draw</span><span class="hljs-params">(<span class="hljs-type">int</span> x, <span class="hljs-type">int</span> y)</span>;
        Graphic <span class="hljs-title function_">clone</span><span class="hljs-params">()</span>;
        String <span class="hljs-title function_">getType</span><span class="hljs-params">()</span>;
        <span class="hljs-keyword">void</span> <span class="hljs-title function_">setColor</span><span class="hljs-params">(String color)</span>;
    }
    
    <span class="hljs-comment">// 具体图形：圆形</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Circle</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Graphic</span> {
        <span class="hljs-keyword">private</span> String color;
        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> radius;
        
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">Circle</span><span class="hljs-params">(String color, <span class="hljs-type">int</span> radius)</span> {
            <span class="hljs-built_in">this</span>.color = color;
            <span class="hljs-built_in">this</span>.radius = radius;
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">draw</span><span class="hljs-params">(<span class="hljs-type">int</span> x, <span class="hljs-type">int</span> y)</span> {
            System.out.printf(<span class="hljs-string">"在(%d, %d)绘制%s圆形，半径%d%n"</span>, x, y, color, radius);
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> Circle <span class="hljs-title function_">clone</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">return</span> (Circle) <span class="hljs-built_in">super</span>.clone();
            } <span class="hljs-keyword">catch</span> (CloneNotSupportedException e) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"克隆失败"</span>, e);
            }
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getType</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"圆形"</span>;
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setColor</span><span class="hljs-params">(String color)</span> {
            <span class="hljs-built_in">this</span>.color = color;
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setRadius</span><span class="hljs-params">(<span class="hljs-type">int</span> radius)</span> {
            <span class="hljs-built_in">this</span>.radius = radius;
        }
    }
    
    <span class="hljs-comment">// 具体图形：矩形</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Rectangle</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Graphic</span> {
        <span class="hljs-keyword">private</span> String color;
        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> width;
        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> height;
        
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">Rectangle</span><span class="hljs-params">(String color, <span class="hljs-type">int</span> width, <span class="hljs-type">int</span> height)</span> {
            <span class="hljs-built_in">this</span>.color = color;
            <span class="hljs-built_in">this</span>.width = width;
            <span class="hljs-built_in">this</span>.height = height;
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">draw</span><span class="hljs-params">(<span class="hljs-type">int</span> x, <span class="hljs-type">int</span> y)</span> {
            System.out.printf(<span class="hljs-string">"在(%d, %d)绘制%s矩形，宽%d，高%d%n"</span>, x, y, color, width, height);
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> Rectangle <span class="hljs-title function_">clone</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">return</span> (Rectangle) <span class="hljs-built_in">super</span>.clone();
            } <span class="hljs-keyword">catch</span> (CloneNotSupportedException e) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"克隆失败"</span>, e);
            }
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getType</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"矩形"</span>;
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setColor</span><span class="hljs-params">(String color)</span> {
            <span class="hljs-built_in">this</span>.color = color;
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setSize</span><span class="hljs-params">(<span class="hljs-type">int</span> width, <span class="hljs-type">int</span> height)</span> {
            <span class="hljs-built_in">this</span>.width = width;
            <span class="hljs-built_in">this</span>.height = height;
        }
    }
    
    <span class="hljs-comment">// 图形工厂（使用原型模式）</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GraphicFactory</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, Graphic&gt; prototypes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">GraphicFactory</span><span class="hljs-params">()</span> {
            <span class="hljs-comment">// 初始化原型</span>
            prototypes.put(<span class="hljs-string">"红色小圆"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Circle</span>(<span class="hljs-string">"红色"</span>, <span class="hljs-number">10</span>));
            prototypes.put(<span class="hljs-string">"蓝色大圆"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Circle</span>(<span class="hljs-string">"蓝色"</span>, <span class="hljs-number">50</span>));
            prototypes.put(<span class="hljs-string">"绿色矩形"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Rectangle</span>(<span class="hljs-string">"绿色"</span>, <span class="hljs-number">30</span>, <span class="hljs-number">40</span>));
            prototypes.put(<span class="hljs-string">"黄色正方形"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Rectangle</span>(<span class="hljs-string">"黄色"</span>, <span class="hljs-number">25</span>, <span class="hljs-number">25</span>));
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerPrototype</span><span class="hljs-params">(String name, Graphic prototype)</span> {
            prototypes.put(name, prototype);
        }
        
        <span class="hljs-keyword">public</span> Graphic <span class="hljs-title function_">createGraphic</span><span class="hljs-params">(String name)</span> {
            <span class="hljs-type">Graphic</span> <span class="hljs-variable">prototype</span> <span class="hljs-operator">=</span> prototypes.get(name);
            <span class="hljs-keyword">if</span> (prototype == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"未知的图形类型: "</span> + name);
            }
            <span class="hljs-keyword">return</span> prototype.clone();
        }
        
        <span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">getAvailableGraphics</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(prototypes.keySet());
        }
    }
    
    <span class="hljs-comment">// 图形编辑器</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GraphicEditor</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> GraphicFactory factory;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;Graphic&gt; graphics = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">GraphicEditor</span><span class="hljs-params">(GraphicFactory factory)</span> {
            <span class="hljs-built_in">this</span>.factory = factory;
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addGraphic</span><span class="hljs-params">(String type, <span class="hljs-type">int</span> x, <span class="hljs-type">int</span> y)</span> {
            <span class="hljs-type">Graphic</span> <span class="hljs-variable">graphic</span> <span class="hljs-operator">=</span> factory.createGraphic(type);
            graphic.draw(x, y);
            graphics.add(graphic);
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addCustomGraphic</span><span class="hljs-params">(Graphic graphic, <span class="hljs-type">int</span> x, <span class="hljs-type">int</span> y)</span> {
            graphic.draw(x, y);
            graphics.add(graphic);
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">changeColor</span><span class="hljs-params">(<span class="hljs-type">int</span> index, String newColor)</span> {
            <span class="hljs-keyword">if</span> (index &gt;= <span class="hljs-number">0</span> &amp;&amp; index &lt; graphics.size()) {
                graphics.get(index).setColor(newColor);
                System.out.println(<span class="hljs-string">"第"</span> + (index + <span class="hljs-number">1</span>) + <span class="hljs-string">"个图形颜色改为"</span> + newColor);
            }
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">listAllGraphics</span><span class="hljs-params">()</span> {
            System.out.println(<span class="hljs-string">"\n当前所有图形:"</span>);
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; graphics.size(); i++) {
                System.out.println((i + <span class="hljs-number">1</span>) + <span class="hljs-string">". "</span> + graphics.get(i).getType());
            }
        }
    }
    
    <span class="hljs-comment">// 使用示例</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">GraphicFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GraphicFactory</span>();
        <span class="hljs-type">GraphicEditor</span> <span class="hljs-variable">editor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GraphicEditor</span>(factory);
        
        System.out.println(<span class="hljs-string">"可用的图形类型: "</span> + factory.getAvailableGraphics());
        
        System.out.println(<span class="hljs-string">"\n=== 添加预设图形 ==="</span>);
        editor.addGraphic(<span class="hljs-string">"红色小圆"</span>, <span class="hljs-number">10</span>, <span class="hljs-number">20</span>);
        editor.addGraphic(<span class="hljs-string">"蓝色大圆"</span>, <span class="hljs-number">50</span>, <span class="hljs-number">60</span>);
        editor.addGraphic(<span class="hljs-string">"绿色矩形"</span>, <span class="hljs-number">100</span>, <span class="hljs-number">120</span>);
        
        System.out.println(<span class="hljs-string">"\n=== 创建自定义图形 ==="</span>);
        <span class="hljs-comment">// 创建自定义图形并注册为原型</span>
        <span class="hljs-type">Circle</span> <span class="hljs-variable">customCircle</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Circle</span>(<span class="hljs-string">"紫色"</span>, <span class="hljs-number">15</span>);
        factory.registerPrototype(<span class="hljs-string">"紫色中圆"</span>, customCircle);
        
        editor.addGraphic(<span class="hljs-string">"紫色中圆"</span>, <span class="hljs-number">150</span>, <span class="hljs-number">80</span>);
        
        System.out.println(<span class="hljs-string">"\n=== 克隆并修改图形 ==="</span>);
        <span class="hljs-comment">// 获取原型并修改</span>
        <span class="hljs-type">Graphic</span> <span class="hljs-variable">clonedCircle</span> <span class="hljs-operator">=</span> factory.createGraphic(<span class="hljs-string">"红色小圆"</span>);
        <span class="hljs-keyword">if</span> (clonedCircle <span class="hljs-keyword">instanceof</span> Circle) {
            ((Circle) clonedCircle).setRadius(<span class="hljs-number">20</span>);  <span class="hljs-comment">// 修改半径</span>
            ((Circle) clonedCircle).setColor(<span class="hljs-string">"橙色"</span>);  <span class="hljs-comment">// 修改颜色</span>
            editor.addCustomGraphic(clonedCircle, <span class="hljs-number">200</span>, <span class="hljs-number">100</span>);
        }
        
        editor.listAllGraphics();
        
        System.out.println(<span class="hljs-string">"\n=== 修改现有图形颜色 ==="</span>);
        editor.changeColor(<span class="hljs-number">0</span>, <span class="hljs-string">"粉红色"</span>);
        editor.changeColor(<span class="hljs-number">2</span>, <span class="hljs-string">"深绿色"</span>);
    }
}
</code></pre>
<h2 data-id="heading-22">模式选择指南：何时使用哪种创建型模式</h2>
<h3 data-id="heading-23">决策流程图</h3>
<pre><code class="hljs language-java" lang="java">开始
  │
  ├── 是否需要确保只有一个实例？
  │     ├── 是 → 使用单例模式
  │     └── 否 → 继续
  │
  ├── 创建过程是否复杂，需要逐步构建？
  │     ├── 是 → 使用建造者模式
  │     └── 否 → 继续
  │
  ├── 是否需要创建一系列相关对象？
  │     ├── 是 → 使用抽象工厂模式
  │     └── 否 → 继续
  │
  ├── 创建逻辑是否需要封装，以便子类决定具体类型？
  │     ├── 是 → 使用工厂方法模式
  │     └── 否 → 继续
  │
  └── 是否需要通过克隆现有对象来创建新对象？
        ├── 是 → 使用原型模式
        └── 否 → 直接使用 <span class="hljs-keyword">new</span> 关键字
</code></pre>
<h3 data-id="heading-24">实际项目中的综合应用</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 电子商务系统中的创建型模式综合应用</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ECommerceSystem</span> {
    
    <span class="hljs-comment">// 使用单例模式：购物车服务</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ShoppingCartService</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ShoppingCartService instance;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, List&lt;Product&gt;&gt; userCarts = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
        
        <span class="hljs-keyword">private</span> <span class="hljs-title function_">ShoppingCartService</span><span class="hljs-params">()</span> {
            <span class="hljs-comment">// 私有构造器</span>
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">synchronized</span> ShoppingCartService <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) {
                instance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ShoppingCartService</span>();
            }
            <span class="hljs-keyword">return</span> instance;
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addToCart</span><span class="hljs-params">(String userId, Product product)</span> {
            userCarts.computeIfAbsent(userId, k -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;()).add(product);
            System.out.println(<span class="hljs-string">"用户 "</span> + userId + <span class="hljs-string">" 添加商品: "</span> + product.getName());
        }
        
        <span class="hljs-keyword">public</span> List&lt;Product&gt; <span class="hljs-title function_">getCart</span><span class="hljs-params">(String userId)</span> {
            <span class="hljs-keyword">return</span> userCarts.getOrDefault(userId, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;());
        }
    }
    
    <span class="hljs-comment">// 使用工厂方法模式：支付方式工厂</span>
    <span class="hljs-keyword">interface</span> <span class="hljs-title class_">PaymentMethod</span> {
        <span class="hljs-type">boolean</span> <span class="hljs-title function_">pay</span><span class="hljs-params">(<span class="hljs-type">double</span> amount)</span>;
        String <span class="hljs-title function_">getType</span><span class="hljs-params">()</span>;
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CreditCardPayment</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">PaymentMethod</span> {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">pay</span><span class="hljs-params">(<span class="hljs-type">double</span> amount)</span> {
            System.out.println(<span class="hljs-string">"信用卡支付: "</span> + amount);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getType</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"信用卡"</span>;
        }
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PayPalPayment</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">PaymentMethod</span> {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">pay</span><span class="hljs-params">(<span class="hljs-type">double</span> amount)</span> {
            System.out.println(<span class="hljs-string">"PayPal支付: "</span> + amount);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getType</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"PayPal"</span>;
        }
    }
    
    <span class="hljs-keyword">interface</span> <span class="hljs-title class_">PaymentFactory</span> {
        PaymentMethod <span class="hljs-title function_">createPayment</span><span class="hljs-params">()</span>;
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CreditCardFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">PaymentFactory</span> {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> PaymentMethod <span class="hljs-title function_">createPayment</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CreditCardPayment</span>();
        }
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PayPalFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">PaymentFactory</span> {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> PaymentMethod <span class="hljs-title function_">createPayment</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PayPalPayment</span>();
        }
    }
    
    <span class="hljs-comment">// 使用建造者模式：订单构建</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Order</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String orderId;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String userId;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;Product&gt; products;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> PaymentMethod payment;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ShippingAddress address;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Date orderDate;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> OrderStatus status;
        
        <span class="hljs-keyword">private</span> <span class="hljs-title function_">Order</span><span class="hljs-params">(Builder builder)</span> {
            <span class="hljs-built_in">this</span>.orderId = builder.orderId;
            <span class="hljs-built_in">this</span>.userId = builder.userId;
            <span class="hljs-built_in">this</span>.products = builder.products;
            <span class="hljs-built_in">this</span>.payment = builder.payment;
            <span class="hljs-built_in">this</span>.address = builder.address;
            <span class="hljs-built_in">this</span>.orderDate = builder.orderDate;
            <span class="hljs-built_in">this</span>.status = builder.status;
        }
        
        <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Builder</span> {
            <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String orderId;
            <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String userId;
            <span class="hljs-keyword">private</span> List&lt;Product&gt; products = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
            <span class="hljs-keyword">private</span> PaymentMethod payment;
            <span class="hljs-keyword">private</span> ShippingAddress address;
            <span class="hljs-keyword">private</span> <span class="hljs-type">Date</span> <span class="hljs-variable">orderDate</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>();
            <span class="hljs-keyword">private</span> <span class="hljs-type">OrderStatus</span> <span class="hljs-variable">status</span> <span class="hljs-operator">=</span> OrderStatus.PENDING;
            
            <span class="hljs-keyword">public</span> <span class="hljs-title function_">Builder</span><span class="hljs-params">(String orderId, String userId)</span> {
                <span class="hljs-built_in">this</span>.orderId = orderId;
                <span class="hljs-built_in">this</span>.userId = userId;
            }
            
            <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">products</span><span class="hljs-params">(List&lt;Product&gt; products)</span> {
                <span class="hljs-built_in">this</span>.products = products;
                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
            }
            
            <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">payment</span><span class="hljs-params">(PaymentMethod payment)</span> {
                <span class="hljs-built_in">this</span>.payment = payment;
                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
            }
            
            <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">address</span><span class="hljs-params">(ShippingAddress address)</span> {
                <span class="hljs-built_in">this</span>.address = address;
                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
            }
            
            <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">orderDate</span><span class="hljs-params">(Date orderDate)</span> {
                <span class="hljs-built_in">this</span>.orderDate = orderDate;
                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
            }
            
            <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">status</span><span class="hljs-params">(OrderStatus status)</span> {
                <span class="hljs-built_in">this</span>.status = status;
                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
            }
            
            <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">build</span><span class="hljs-params">()</span> {
                <span class="hljs-comment">// 验证</span>
                <span class="hljs-keyword">if</span> (payment == <span class="hljs-literal">null</span>) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">"支付方式必须设置"</span>);
                }
                <span class="hljs-keyword">if</span> (address == <span class="hljs-literal">null</span>) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">"收货地址必须设置"</span>);
                }
                <span class="hljs-keyword">if</span> (products.isEmpty()) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">"订单商品不能为空"</span>);
                }
                
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>(<span class="hljs-built_in">this</span>);
            }
        }
    }
    
    <span class="hljs-comment">// 使用抽象工厂模式：不同国家的电商工厂</span>
    <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ECommerceFactory</span> {
        TaxCalculator <span class="hljs-title function_">createTaxCalculator</span><span class="hljs-params">()</span>;
        ShippingCalculator <span class="hljs-title function_">createShippingCalculator</span><span class="hljs-params">()</span>;
        CurrencyFormatter <span class="hljs-title function_">createCurrencyFormatter</span><span class="hljs-params">()</span>;
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">USFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ECommerceFactory</span> {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> TaxCalculator <span class="hljs-title function_">createTaxCalculator</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">USTaxCalculator</span>();
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> ShippingCalculator <span class="hljs-title function_">createShippingCalculator</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">USShippingCalculator</span>();
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> CurrencyFormatter <span class="hljs-title function_">createCurrencyFormatter</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">USDCurrencyFormatter</span>();
        }
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CNFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ECommerceFactory</span> {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> TaxCalculator <span class="hljs-title function_">createTaxCalculator</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CNTaxCalculator</span>();
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> ShippingCalculator <span class="hljs-title function_">createShippingCalculator</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CNShippingCalculator</span>();
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> CurrencyFormatter <span class="hljs-title function_">createCurrencyFormatter</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CNYCurrencyFormatter</span>();
        }
    }
    
    <span class="hljs-comment">// 辅助类（省略具体实现）</span>
    <span class="hljs-keyword">interface</span> <span class="hljs-title class_">TaxCalculator</span> {
        <span class="hljs-type">double</span> <span class="hljs-title function_">calculateTax</span><span class="hljs-params">(<span class="hljs-type">double</span> amount)</span>;
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">USTaxCalculator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">TaxCalculator</span> {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">calculateTax</span><span class="hljs-params">(<span class="hljs-type">double</span> amount)</span> {
            <span class="hljs-keyword">return</span> amount * <span class="hljs-number">0.08</span>; <span class="hljs-comment">// 8%税率</span>
        }
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CNTaxCalculator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">TaxCalculator</span> {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">calculateTax</span><span class="hljs-params">(<span class="hljs-type">double</span> amount)</span> {
            <span class="hljs-keyword">return</span> amount * <span class="hljs-number">0.06</span>; <span class="hljs-comment">// 6%税率</span>
        }
    }
    
    <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ShippingCalculator</span> {
        <span class="hljs-type">double</span> <span class="hljs-title function_">calculateShipping</span><span class="hljs-params">(<span class="hljs-type">double</span> weight, String address)</span>;
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">USShippingCalculator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ShippingCalculator</span> {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">calculateShipping</span><span class="hljs-params">(<span class="hljs-type">double</span> weight, String address)</span> {
            <span class="hljs-keyword">return</span> weight * <span class="hljs-number">2.5</span>; <span class="hljs-comment">// 美国运费计算</span>
        }
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CNShippingCalculator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ShippingCalculator</span> {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">calculateShipping</span><span class="hljs-params">(<span class="hljs-type">double</span> weight, String address)</span> {
            <span class="hljs-keyword">return</span> weight * <span class="hljs-number">1.5</span>; <span class="hljs-comment">// 中国运费计算</span>
        }
    }
    
    <span class="hljs-keyword">interface</span> <span class="hljs-title class_">CurrencyFormatter</span> {
        String <span class="hljs-title function_">format</span><span class="hljs-params">(<span class="hljs-type">double</span> amount)</span>;
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">USDCurrencyFormatter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">CurrencyFormatter</span> {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">format</span><span class="hljs-params">(<span class="hljs-type">double</span> amount)</span> {
            <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"$%.2f"</span>, amount);
        }
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CNYCurrencyFormatter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">CurrencyFormatter</span> {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">format</span><span class="hljs-params">(<span class="hljs-type">double</span> amount)</span> {
            <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"¥%.2f"</span>, amount);
        }
    }
    
    <span class="hljs-comment">// 实体类</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Product</span> {
        <span class="hljs-keyword">private</span> String id;
        <span class="hljs-keyword">private</span> String name;
        <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> price;
        <span class="hljs-comment">// 其他属性...</span>
        
        <span class="hljs-comment">// getter/setter省略</span>
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ShippingAddress</span> {
        <span class="hljs-keyword">private</span> String address;
        <span class="hljs-comment">// 其他属性...</span>
        
        <span class="hljs-comment">// getter/setter省略</span>
    }
    
    <span class="hljs-keyword">enum</span> <span class="hljs-title class_">OrderStatus</span> {
        PENDING, PROCESSING, SHIPPED, DELIVERED, CANCELLED
    }
    
    <span class="hljs-comment">// 客户端代码</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"=== 电子商务系统演示 ==="</span>);
        
        <span class="hljs-comment">// 1. 使用单例模式：购物车服务</span>
        <span class="hljs-type">ShoppingCartService</span> <span class="hljs-variable">cartService</span> <span class="hljs-operator">=</span> ShoppingCartService.getInstance();
        cartService.addToCart(<span class="hljs-string">"user123"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>());
        
        <span class="hljs-comment">// 2. 使用工厂方法模式：创建支付方式</span>
        <span class="hljs-type">PaymentFactory</span> <span class="hljs-variable">paymentFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CreditCardFactory</span>();
        <span class="hljs-type">PaymentMethod</span> <span class="hljs-variable">payment</span> <span class="hljs-operator">=</span> paymentFactory.createPayment();
        
        <span class="hljs-comment">// 3. 使用建造者模式：创建订单</span>
        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>.Builder(<span class="hljs-string">"ORD123"</span>, <span class="hljs-string">"user123"</span>)
            .products(cartService.getCart(<span class="hljs-string">"user123"</span>))
            .payment(payment)
            .address(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ShippingAddress</span>())
            .status(OrderStatus.PROCESSING)
            .build();
        
        System.out.println(<span class="hljs-string">"订单创建成功: "</span> + order);
        
        <span class="hljs-comment">// 4. 使用抽象工厂模式：根据不同地区创建相关对象</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">country</span> <span class="hljs-operator">=</span> <span class="hljs-string">"US"</span>; <span class="hljs-comment">// 可以从用户配置获取</span>
        ECommerceFactory factory;
        
        <span class="hljs-keyword">if</span> (<span class="hljs-string">"US"</span>.equals(country)) {
            factory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">USFactory</span>();
        } <span class="hljs-keyword">else</span> {
            factory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CNFactory</span>();
        }
        
        <span class="hljs-type">TaxCalculator</span> <span class="hljs-variable">taxCalculator</span> <span class="hljs-operator">=</span> factory.createTaxCalculator();
        <span class="hljs-type">ShippingCalculator</span> <span class="hljs-variable">shippingCalculator</span> <span class="hljs-operator">=</span> factory.createShippingCalculator();
        <span class="hljs-type">CurrencyFormatter</span> <span class="hljs-variable">currencyFormatter</span> <span class="hljs-operator">=</span> factory.createCurrencyFormatter();
        
        <span class="hljs-type">double</span> <span class="hljs-variable">subtotal</span> <span class="hljs-operator">=</span> <span class="hljs-number">100.0</span>;
        <span class="hljs-type">double</span> <span class="hljs-variable">tax</span> <span class="hljs-operator">=</span> taxCalculator.calculateTax(subtotal);
        <span class="hljs-type">double</span> <span class="hljs-variable">shipping</span> <span class="hljs-operator">=</span> shippingCalculator.calculateShipping(<span class="hljs-number">2.0</span>, <span class="hljs-string">"New York"</span>);
        <span class="hljs-type">double</span> <span class="hljs-variable">total</span> <span class="hljs-operator">=</span> subtotal + tax + shipping;
        
        System.out.println(<span class="hljs-string">"小计: "</span> + currencyFormatter.format(subtotal));
        System.out.println(<span class="hljs-string">"税费: "</span> + currencyFormatter.format(tax));
        System.out.println(<span class="hljs-string">"运费: "</span> + currencyFormatter.format(shipping));
        System.out.println(<span class="hljs-string">"总计: "</span> + currencyFormatter.format(total));
    }
}
</code></pre>
<h2 data-id="heading-25">总结：创建型模式的核心思想</h2>
<ol>
<li><strong>单例模式</strong>：控制实例数量，确保全局唯一访问点</li>
<li><strong>工厂方法模式</strong>：将对象的创建延迟到子类，实现开闭原则</li>
<li><strong>抽象工厂模式</strong>：创建相关对象族，确保产品兼容性</li>
<li><strong>建造者模式</strong>：分离复杂对象的构建与表示，支持逐步构建</li>
<li><strong>原型模式</strong>：通过克隆创建对象，提高创建效率</li>
</ol>
<h3 data-id="heading-26">设计原则体现</h3>
<ul>
<li><strong>单一职责原则</strong>：每个类只负责自己的创建逻辑</li>
<li><strong>开闭原则</strong>：通过扩展而非修改来支持新的对象类型</li>
<li><strong>依赖倒置原则</strong>：依赖抽象而非具体实现</li>
<li><strong>里氏替换原则</strong>：子类可以替换父类</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java内存管理与JVM调优完全指南]]></title>    <link>https://juejin.cn/post/7582502441993551915</link>    <guid>https://juejin.cn/post/7582502441993551915</guid>    <pubDate>2025-12-12T05:16:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582502441993551915" data-draft-id="7582808491582521380" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java内存管理与JVM调优完全指南"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-12-12T05:16:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吃西红柿长大的番茄"/> <meta itemprop="url" content="https://juejin.cn/user/3097787706900985"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java内存管理与JVM调优完全指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3097787706900985/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吃西红柿长大的番茄
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T05:16:47.000Z" title="Fri Dec 12 2025 05:16:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读21分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.7;font-weight:400;font-size:16px;overflow-x:hidden;color:#212122}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:8px;padding-bottom:8px}.markdown-body h1{color:#a0a0a0;font-size:38px;margin-top:32px;padding-top:32px}.markdown-body h2{color:#fff;background-color:#212122;width:fit-content;border-bottom-right-radius:100px;margin-top:47px;margin-bottom:16px;padding:4px 48px 4px 8px;line-height:1.7;font-size:30px;transition:all .3s ease-out}.markdown-body h2:hover{border-bottom-right-radius:50px;transition:all .3s ease-out}.markdown-body h3{font-size:24px;padding-left:8px;margin-top:32px;border-bottom:2px solid #c6c4c4;line-height:1.7}.markdown-body h4{font-size:20px;padding-left:8px;margin-top:32px;border-bottom:1px solid #ddd}.markdown-body h5{font-size:16px;margin-top:24px}.markdown-body h6{margin-top:16px;line-height:1.1}.markdown-body p{font-size:16px;text-align:start;white-space:normal;text-size-adjust:auto;line-height:2;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%;margin:auto;padding-left:8px;padding-right:8px}.markdown-body hr{border:none;border-top:4px double #212122;margin-top:32px;margin-bottom:32px;text-align:center}.markdown-body hr:after{content:"♥";display:inline-block;position:relative;top:-15px;padding:0 10px;color:#212122;font-size:18px}.markdown-body code{word-break:break-word;overflow-x:auto;background-color:#f1f1f1;color:#ef7060;font-size:14px;padding:.065em 6px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.7;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);margin:32px 16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-color:#212122;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);background-size:40px}.markdown-body pre&gt;code{font-size:14px;padding:16px 8px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#fff;background:#272822}.markdown-body pre&gt;code::-webkit-scrollbar{height:10px;background-color:#f5f5f5}.markdown-body pre&gt;code::-webkit-scrollbar-track{box-shadow:inset 0 0 6px rgba(0,0,0,.3);border-radius:3px;background-color:#f5f5f5}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{border-radius:3px;box-shadow:inset 0 0 6px rgba(0,0,0,.3);background-color:#555}.markdown-body a{color:#ef7060;padding:2px;text-decoration:none;border-bottom:.125em solid #ef7060;border-radius:2px;box-shadow:inset 0 -.025em 0 #ef7060;transition:box-shadow .27s cubic-bezier(.77,0,.175,1),color .27s cubic-bezier(.77,0,.175,1)}.markdown-body a:focus,.markdown-body a:hover{outline:none;box-shadow:inset 0 -1.5em 0 #ef7060;color:#fff}.markdown-body a:before{content:"⇲ ";vertical-align:top;margin-left:2px;font-family:dart!important;font-size:12px;color:inherit;opacity:.7}.markdown-body table{background:#fbfbfb;border-radius:4px;border-collapse:collapse;margin:auto;padding:5px;width:95%;box-shadow:0 5px 10px rgba(0,0,0,.1);animation:float 5s infinite}.markdown-body table th{color:#fff;background:#212122;border-bottom:1px solid #9ea7af;border-right:1px solid #343a45;font-size:18px;padding:16px;text-align:left;vertical-align:middle}.markdown-body table th:first-child{border-top-left-radius:4px}.markdown-body table th:last-child{border-top-right-radius:4px;border-right:none}.markdown-body table tr{border-top:1px solid #c1c3d1;border-bottom:1px solid #c1c3d1;color:#666b85}.markdown-body table tr:hover td{background:#212122;color:#fff;border-top:1px solid #22262e}.markdown-body table tr:first-child{border-top:none}.markdown-body table tr:last-child{border-bottom:none}.markdown-body table tr:nth-child(odd) td{background:#f1f1f1}.markdown-body table tr:nth-child(odd):hover td{background:#212122}.markdown-body table tr:last-child td:first-child{border-bottom-left-radius:4px}.markdown-body table tr:last-child td:last-child{border-bottom-right-radius:4px}.markdown-body table td{background:#fbfbfb;padding:16px;text-align:left;vertical-align:middle;font-size:16px;border-right:1px solid #c1c3d1}.markdown-body table td:last-child{border-right:0}.markdown-body blockquote{color:#777;padding:1px 16px;margin:24px 0;border-left:4px solid #c6c4c4;background-color:#f1f1f1;transition:all .3s ease-out;border-radius:4px}.markdown-body blockquote:hover{border-left-color:#212122;background-color:#212122;color:#fff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:24px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body span.math{margin-left:32px;font-size:18px;font-weight:700}@media (max-width:720px){.markdown-body h1{font-size:30.4px}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:19.2px}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:12.8px}}</style><style data-highlight="" data-highlight-key="a11y-light">.hljs-comment,.hljs-quote{color:#696969}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#d91e18}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#aa5d00}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:green}.hljs-section,.hljs-title{color:#007faa}.hljs-keyword,.hljs-selector-tag{color:#7928a1}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fefefe;color:#545454}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">引言：为什么需要理解内存管理？</h2>
<p>想象一下你在管理一个大型仓库。如果随意堆放货物，很快就会混乱不堪，找不到需要的物品，甚至可能因为堆放不当导致仓库坍塌。Java内存管理就如同这个仓库的管理系统——它决定了如何分配、使用和回收内存空间。掌握JVM内存管理不仅能让你写出更高效的代码，还能在生产环境中快速定位和解决性能问题。</p>
<h2 data-id="heading-1">JVM内存结构深度解析</h2>
<h3 data-id="heading-2">运行时数据区域</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JVMMemoryLayout</span> {
    
    <span class="hljs-comment">// 类加载过程演示</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ClassLoaderDemo</span> {
        <span class="hljs-comment">// 类变量（存储在方法区）</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CLASS_CONSTANT</span> <span class="hljs-operator">=</span> <span class="hljs-string">"常量"</span>;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">staticCounter</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        
        <span class="hljs-comment">// 实例变量（存储在堆内存）</span>
        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> instanceId;
        <span class="hljs-keyword">private</span> String instanceName;
        
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">ClassLoaderDemo</span><span class="hljs-params">(<span class="hljs-type">int</span> id, String name)</span> {
            <span class="hljs-built_in">this</span>.instanceId = id;
            <span class="hljs-built_in">this</span>.instanceName = name;
            staticCounter++;
        }
        
        <span class="hljs-comment">// 方法（字节码存储在方法区）</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printInfo</span><span class="hljs-params">()</span> {
            <span class="hljs-comment">// 局部变量（存储在栈帧的局部变量表）</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">localVar</span> <span class="hljs-operator">=</span> <span class="hljs-string">"局部变量"</span>;
            System.out.println(<span class="hljs-string">"实例ID: "</span> + instanceId + 
                             <span class="hljs-string">", 名称: "</span> + instanceName + 
                             <span class="hljs-string">", 局部: "</span> + localVar);
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">showMemoryInfo</span><span class="hljs-params">()</span> {
            <span class="hljs-comment">// 演示不同内存区域的使用</span>
            <span class="hljs-type">Runtime</span> <span class="hljs-variable">runtime</span> <span class="hljs-operator">=</span> Runtime.getRuntime();
            System.out.println(<span class="hljs-string">"=== 内存信息 ==="</span>);
            System.out.println(<span class="hljs-string">"最大内存: "</span> + runtime.maxMemory() / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span> + <span class="hljs-string">"MB"</span>);
            System.out.println(<span class="hljs-string">"总内存: "</span> + runtime.totalMemory() / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span> + <span class="hljs-string">"MB"</span>);
            System.out.println(<span class="hljs-string">"空闲内存: "</span> + runtime.freeMemory() / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span> + <span class="hljs-string">"MB"</span>);
            System.out.println(<span class="hljs-string">"已用内存: "</span> + 
                (runtime.totalMemory() - runtime.freeMemory()) / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span> + <span class="hljs-string">"MB"</span>);
        }
    }
    
    <span class="hljs-comment">// 演示栈内存溢出</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">causeStackOverflow</span><span class="hljs-params">()</span> {
        causeStackOverflow();  <span class="hljs-comment">// 递归调用，没有终止条件</span>
    }
    
    <span class="hljs-comment">// 演示堆内存溢出</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">causeHeapOOM</span><span class="hljs-params">()</span> {
        List&lt;<span class="hljs-type">byte</span>[]&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
            <span class="hljs-comment">// 每次分配1MB，快速耗尽堆内存</span>
            list.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>]);
        }
    }
    
    <span class="hljs-comment">// 演示方法区（元空间）溢出</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">causeMetaspaceOOM</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 使用动态类加载来填满元空间</span>
        <span class="hljs-comment">// 实际项目中，可以通过CGLIB等动态生成类</span>
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 展示类加载和内存分配</span>
        <span class="hljs-type">ClassLoaderDemo</span> <span class="hljs-variable">obj1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassLoaderDemo</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"对象1"</span>);
        <span class="hljs-type">ClassLoaderDemo</span> <span class="hljs-variable">obj2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassLoaderDemo</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"对象2"</span>);
        
        obj1.printInfo();
        obj2.printInfo();
        ClassLoaderDemo.showMemoryInfo();
        
        <span class="hljs-comment">// 查看对象内存布局（需要JOL库）</span>
        <span class="hljs-comment">// System.out.println(ClassLayout.parseInstance(obj1).toPrintable());</span>
        
        <span class="hljs-comment">// 小心：以下代码会触发内存溢出，仅用于演示</span>
        <span class="hljs-comment">// causeStackOverflow();</span>
        <span class="hljs-comment">// causeHeapOOM();</span>
    }
}
</code></pre>
<h3 data-id="heading-3">JVM内存结构示意图</h3>
<pre><code class="hljs language-java" lang="java">JVM内存区域：
┌─────────────────────────────────────────────────┐
│               运行时数据区域                      │
├─────────────────────────────────────────────────┤
│                                                 │
│  ┌─────────────┐   ┌─────────────────────┐    │
│  │   程序计数器 │   │      Java虚拟机栈     │    │
│  │  (PC Register)│   │    (Java Stack)     │    │
│  └─────────────┘   └─────────────────────┘    │
│          │                    │                │
│  ┌─────────────┐   ┌─────────────────────┐    │
│  │   本地方法栈 │   │      Java堆          │    │
│  │ (Native Stack)│   │    (Heap)          │    │
│  └─────────────┘   └─────────────────────┘    │
│                                                 │
│  ┌─────────────────────────────────────┐      │
│  │          方法区/元空间               │      │
│  │    (Method Area/Metaspace)          │      │
│  │    ┌─────────────┐                  │      │
│  │    │  运行时常量池 │                  │      │
│  │    └─────────────┘                  │      │
│  └─────────────────────────────────────┘      │
│                                                 │
│  ┌─────────────────────────────────────┐      │
│  │         直接内存                     │      │
│  │    (Direct Memory)                  │      │
│  └─────────────────────────────────────┘      │
└─────────────────────────────────────────────────┘
</code></pre>
<h2 data-id="heading-4">垃圾回收机制：JVM的自动内存管理</h2>
<h3 data-id="heading-5">垃圾回收算法</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GarbageCollectionDemo</span> {
    
    <span class="hljs-comment">// 对象生命周期追踪</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LifecycleObject</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> id;
        <span class="hljs-keyword">private</span> <span class="hljs-type">byte</span>[] data;
        
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">LifecycleObject</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span> {
            <span class="hljs-built_in">this</span>.id = id;
            <span class="hljs-built_in">this</span>.data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span> * <span class="hljs-number">10</span>]; <span class="hljs-comment">// 分配10KB</span>
            System.out.println(<span class="hljs-string">"对象 "</span> + id + <span class="hljs-string">" 被创建"</span>);
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">finalize</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Throwable {
            System.out.println(<span class="hljs-string">"对象 "</span> + id + <span class="hljs-string">" 即将被垃圾回收"</span>);
            <span class="hljs-built_in">super</span>.finalize();
        }
    }
    
    <span class="hljs-comment">// 引用类型演示</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReferenceDemo</span> {
        
        <span class="hljs-comment">// 强引用 - 最常见的引用类型</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">strongReferenceDemo</span><span class="hljs-params">()</span> {
            <span class="hljs-type">LifecycleObject</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LifecycleObject</span>(<span class="hljs-number">1</span>);
            obj = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 取消强引用，对象可被GC</span>
            System.gc(); <span class="hljs-comment">// 建议JVM进行垃圾回收</span>
        }
        
        <span class="hljs-comment">// 软引用 - 内存不足时才回收</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">softReferenceDemo</span><span class="hljs-params">()</span> {
            SoftReference&lt;LifecycleObject&gt; softRef = 
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">SoftReference</span>&lt;&gt;(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LifecycleObject</span>(<span class="hljs-number">2</span>));
            
            System.out.println(<span class="hljs-string">"软引用对象: "</span> + softRef.get());
            
            <span class="hljs-comment">// 模拟内存不足</span>
            <span class="hljs-keyword">try</span> {
                List&lt;<span class="hljs-type">byte</span>[]&gt; memoryHog = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {
                    memoryHog.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>]); <span class="hljs-comment">// 每次1MB</span>
                }
            } <span class="hljs-keyword">catch</span> (OutOfMemoryError e) {
                System.out.println(<span class="hljs-string">"内存不足，软引用对象: "</span> + softRef.get());
            }
        }
        
        <span class="hljs-comment">// 弱引用 - GC时立即回收</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">weakReferenceDemo</span><span class="hljs-params">()</span> {
            WeakReference&lt;LifecycleObject&gt; weakRef = 
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakReference</span>&lt;&gt;(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LifecycleObject</span>(<span class="hljs-number">3</span>));
            
            System.out.println(<span class="hljs-string">"弱引用对象: "</span> + weakRef.get());
            System.gc();
            System.out.println(<span class="hljs-string">"GC后弱引用对象: "</span> + weakRef.get());
        }
        
        <span class="hljs-comment">// 虚引用 - 用于跟踪对象被回收</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">phantomReferenceDemo</span><span class="hljs-params">()</span> {
            ReferenceQueue&lt;LifecycleObject&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReferenceQueue</span>&lt;&gt;();
            PhantomReference&lt;LifecycleObject&gt; phantomRef = 
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">PhantomReference</span>&lt;&gt;(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LifecycleObject</span>(<span class="hljs-number">4</span>), queue);
            
            System.out.println(<span class="hljs-string">"虚引用对象始终为null: "</span> + phantomRef.get());
            System.gc();
            
            <span class="hljs-comment">// 检查队列中是否有引用</span>
            Reference&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">LifecycleObject</span>&gt; ref = queue.poll();
            <span class="hljs-keyword">if</span> (ref != <span class="hljs-literal">null</span>) {
                System.out.println(<span class="hljs-string">"对象已被回收，进入引用队列"</span>);
            }
        }
        
        <span class="hljs-comment">// 引用队列示例</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">referenceQueueDemo</span><span class="hljs-params">()</span> {
            ReferenceQueue&lt;LifecycleObject&gt; refQueue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReferenceQueue</span>&lt;&gt;();
            List&lt;WeakReference&lt;LifecycleObject&gt;&gt; refList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
            
            <span class="hljs-comment">// 创建10个弱引用对象</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
                WeakReference&lt;LifecycleObject&gt; ref = 
                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakReference</span>&lt;&gt;(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LifecycleObject</span>(<span class="hljs-number">100</span> + i), refQueue);
                refList.add(ref);
            }
            
            <span class="hljs-comment">// 触发GC</span>
            System.gc();
            
            <span class="hljs-comment">// 处理引用队列</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">collectedCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
                Reference&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">LifecycleObject</span>&gt; ref = refQueue.poll();
                <span class="hljs-keyword">if</span> (ref == <span class="hljs-literal">null</span>) <span class="hljs-keyword">break</span>;
                collectedCount++;
                System.out.println(<span class="hljs-string">"回收了第 "</span> + collectedCount + <span class="hljs-string">" 个对象"</span>);
            }
            System.out.println(<span class="hljs-string">"总共回收了 "</span> + collectedCount + <span class="hljs-string">" 个对象"</span>);
        }
    }
    
    <span class="hljs-comment">// 内存泄漏示例</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MemoryLeakDemo</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> List&lt;<span class="hljs-type">byte</span>[]&gt; LEAK_LIST = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Map&lt;String, <span class="hljs-type">byte</span>[]&gt; LEAK_MAP = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        
        <span class="hljs-comment">// 静态集合引起的内存泄漏</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">causeStaticLeak</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {
                LEAK_LIST.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span> * <span class="hljs-number">100</span>]); <span class="hljs-comment">// 100KB</span>
                LEAK_MAP.put(<span class="hljs-string">"key"</span> + i, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span> * <span class="hljs-number">100</span>]);
            }
            System.out.println(<span class="hljs-string">"已添加对象到静态集合，即使方法结束也不会释放"</span>);
        }
        
        <span class="hljs-comment">// 监听器未移除引起的内存泄漏</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LeakyListener</span> {
            <span class="hljs-keyword">private</span> <span class="hljs-type">byte</span>[] data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>]; <span class="hljs-comment">// 1MB</span>
            
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onEvent</span><span class="hljs-params">(String event)</span> {
                System.out.println(<span class="hljs-string">"处理事件: "</span> + event);
            }
        }
        
        <span class="hljs-comment">// 内部类持有外部类引用引起的内存泄漏</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OuterClass</span> {
            <span class="hljs-keyword">private</span> <span class="hljs-type">byte</span>[] outerData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>]; <span class="hljs-comment">// 1MB</span>
            
            <span class="hljs-keyword">public</span> Runnable <span class="hljs-title function_">createTask</span><span class="hljs-params">()</span> {
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() {
                    <span class="hljs-meta">@Override</span>
                    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
                        <span class="hljs-comment">// 匿名内部类隐式持有OuterClass.this引用</span>
                        System.out.println(<span class="hljs-string">"访问外部类数据大小: "</span> + outerData.length);
                    }
                };
            }
        }
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        System.out.println(<span class="hljs-string">"=== 引用类型演示 ==="</span>);
        <span class="hljs-type">ReferenceDemo</span> <span class="hljs-variable">refDemo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReferenceDemo</span>();
        refDemo.strongReferenceDemo();
        Thread.sleep(<span class="hljs-number">100</span>);
        
        refDemo.softReferenceDemo();
        Thread.sleep(<span class="hljs-number">100</span>);
        
        refDemo.weakReferenceDemo();
        Thread.sleep(<span class="hljs-number">100</span>);
        
        refDemo.phantomReferenceDemo();
        Thread.sleep(<span class="hljs-number">100</span>);
        
        refDemo.referenceQueueDemo();
        
        System.out.println(<span class="hljs-string">"\n=== 内存泄漏演示 ==="</span>);
        MemoryLeakDemo.causeStaticLeak();
        
        <span class="hljs-comment">// 注意：以下代码仅用于演示，实际中应避免内存泄漏</span>
        Runtime.getRuntime().gc();
        Thread.sleep(<span class="hljs-number">1000</span>);
        System.out.println(<span class="hljs-string">"演示完成，建议重启JVM以释放泄漏的内存"</span>);
    }
}
</code></pre>
<h3 data-id="heading-6">GC算法详解与比较</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GCAlgorithms</span> {
    
    <span class="hljs-comment">/**
     * 垃圾回收算法比较：
     * 
     * 1. 标记-清除 (Mark-Sweep)
     *    - 优点：简单，不会移动对象
     *    - 缺点：产生内存碎片，效率较低
     *    
     * 2. 标记-整理 (Mark-Compact)
     *    - 优点：没有内存碎片
     *    - 缺点：需要移动对象，开销较大
     *    
     * 3. 复制算法 (Copying)
     *    - 优点：没有碎片，实现简单
     *    - 缺点：内存利用率只有50%
     *    
     * 4. 分代收集 (Generational Collection)
     *    - 现代JVM主要采用此策略
     *    - 新生代 (Young Generation)：使用复制算法
     *    - 老年代 (Old Generation)：使用标记-清除或标记-整理
     */</span>
    
    <span class="hljs-comment">// 模拟分代收集策略</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GenerationalGCSimulation</span> {
        <span class="hljs-comment">// 模拟新生代（Eden + Survivor）</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> List&lt;Object&gt; youngGen = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        <span class="hljs-comment">// 模拟老年代</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> List&lt;Object&gt; oldGen = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">objectId</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">youngGCCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">fullGCCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        
        <span class="hljs-comment">// 创建新对象（首先分配在新生代）</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">allocate</span><span class="hljs-params">()</span> {
            <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>() {
                <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> ++objectId;
                <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">byte</span>[] data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>]; <span class="hljs-comment">// 1KB</span>
                <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">age</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; <span class="hljs-comment">// 对象年龄</span>
                
                <span class="hljs-meta">@Override</span>
                <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> {
                    <span class="hljs-keyword">return</span> <span class="hljs-string">"对象#"</span> + id + <span class="hljs-string">"(age:"</span> + age + <span class="hljs-string">")"</span>;
                }
                
                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">incrementAge</span><span class="hljs-params">()</span> {
                    age++;
                }
                
                <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> {
                    <span class="hljs-keyword">return</span> age;
                }
            };
            
            youngGen.add(obj);
            System.out.println(<span class="hljs-string">"分配新对象: "</span> + obj + <span class="hljs-string">" 到新生代"</span>);
            <span class="hljs-keyword">return</span> obj;
        }
        
        <span class="hljs-comment">// 模拟新生代GC（Minor GC）</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">minorGC</span><span class="hljs-params">()</span> {
            youngGCCount++;
            System.out.println(<span class="hljs-string">"\n=== 开始第 "</span> + youngGCCount + <span class="hljs-string">" 次新生代GC ==="</span>);
            
            <span class="hljs-comment">// 标记阶段（简化版）</span>
            List&lt;Object&gt; survivors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
            List&lt;Object&gt; promoted = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
            
            <span class="hljs-keyword">for</span> (Object obj : youngGen) {
                <span class="hljs-comment">// 模拟可达性分析（这里简化：随机决定对象是否存活）</span>
                <span class="hljs-type">boolean</span> <span class="hljs-variable">isAlive</span> <span class="hljs-operator">=</span> Math.random() &gt; <span class="hljs-number">0.5</span>; <span class="hljs-comment">// 50%存活率</span>
                
                <span class="hljs-keyword">if</span> (isAlive) {
                    <span class="hljs-comment">// 对象年龄增加</span>
                    <span class="hljs-keyword">try</span> {
                        java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">incrementAge</span> <span class="hljs-operator">=</span> 
                            obj.getClass().getDeclaredMethod(<span class="hljs-string">"incrementAge"</span>);
                        incrementAge.invoke(obj);
                        
                        java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">getAge</span> <span class="hljs-operator">=</span> 
                            obj.getClass().getDeclaredMethod(<span class="hljs-string">"getAge"</span>);
                        <span class="hljs-type">int</span> <span class="hljs-variable">age</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) getAge.invoke(obj);
                        
                        <span class="hljs-keyword">if</span> (age &gt;= <span class="hljs-number">15</span>) { <span class="hljs-comment">// 年龄阈值，晋升到老年代</span>
                            promoted.add(obj);
                            System.out.println(<span class="hljs-string">"对象 "</span> + obj + <span class="hljs-string">" 晋升到老年代"</span>);
                        } <span class="hljs-keyword">else</span> {
                            survivors.add(obj);
                            System.out.println(<span class="hljs-string">"对象 "</span> + obj + <span class="hljs-string">" 存活，进入Survivor区"</span>);
                        }
                    } <span class="hljs-keyword">catch</span> (Exception e) {
                        survivors.add(obj);
                    }
                } <span class="hljs-keyword">else</span> {
                    System.out.println(<span class="hljs-string">"对象 "</span> + obj + <span class="hljs-string">" 被回收"</span>);
                }
            }
            
            <span class="hljs-comment">// 复制存活对象（模拟复制算法）</span>
            youngGen.clear();
            youngGen.addAll(survivors);
            
            <span class="hljs-comment">// 晋升到老年代</span>
            oldGen.addAll(promoted);
            
            System.out.println(<span class="hljs-string">"新生代GC完成，存活对象: "</span> + survivors.size() + 
                             <span class="hljs-string">", 晋升对象: "</span> + promoted.size());
        }
        
        <span class="hljs-comment">// 模拟Full GC</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">fullGC</span><span class="hljs-params">()</span> {
            fullGCCount++;
            System.out.println(<span class="hljs-string">"\n=== 开始第 "</span> + fullGCCount + <span class="hljs-string">" 次Full GC ==="</span>);
            
            <span class="hljs-comment">// 标记阶段（同时处理新生代和老年代）</span>
            List&lt;Object&gt; allObjects = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
            allObjects.addAll(youngGen);
            allObjects.addAll(oldGen);
            
            List&lt;Object&gt; survivors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
            
            <span class="hljs-keyword">for</span> (Object obj : allObjects) {
                <span class="hljs-type">boolean</span> <span class="hljs-variable">isAlive</span> <span class="hljs-operator">=</span> Math.random() &gt; <span class="hljs-number">0.3</span>; <span class="hljs-comment">// 70%存活率</span>
                
                <span class="hljs-keyword">if</span> (isAlive) {
                    survivors.add(obj);
                } <span class="hljs-keyword">else</span> {
                    System.out.println(<span class="hljs-string">"对象 "</span> + obj + <span class="hljs-string">" 在Full GC中被回收"</span>);
                }
            }
            
            <span class="hljs-comment">// 整理阶段（简化版）</span>
            youngGen.clear();
            oldGen.clear();
            
            <span class="hljs-comment">// 重新分配（实际JVM会移动对象进行内存整理）</span>
            <span class="hljs-keyword">for</span> (Object obj : survivors) {
                <span class="hljs-comment">// 简化处理：都放到老年代</span>
                oldGen.add(obj);
            }
            
            System.out.println(<span class="hljs-string">"Full GC完成，总存活对象: "</span> + survivors.size());
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printStats</span><span class="hljs-params">()</span> {
            System.out.println(<span class="hljs-string">"\n=== 内存统计 ==="</span>);
            System.out.println(<span class="hljs-string">"新生代对象数: "</span> + youngGen.size());
            System.out.println(<span class="hljs-string">"老年代对象数: "</span> + oldGen.size());
            System.out.println(<span class="hljs-string">"新生代GC次数: "</span> + youngGCCount);
            System.out.println(<span class="hljs-string">"Full GC次数: "</span> + fullGCCount);
        }
    }
    
    <span class="hljs-comment">// 现代GC收集器对比</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GCCollectorsComparison</span> {
        <span class="hljs-comment">/**
         * 常用GC收集器：
         * 
         * 1. Serial收集器
         *    - 单线程，适用于客户端应用
         *    - 参数：-XX:+UseSerialGC
         *    
         * 2. Parallel收集器 (吞吐量优先)
         *    - 多线程，适用于后台计算
         *    - 参数：-XX:+UseParallelGC -XX:ParallelGCThreads=N
         *    
         * 3. CMS收集器 (低延迟优先)
         *    - 并发标记清除，减少停顿时间
         *    - 参数：-XX:+UseConcMarkSweepGC
         *    - 已废弃，不建议使用
         *    
         * 4. G1收集器 (平衡型)
         *    - 分区收集，可预测停顿时间
         *    - 参数：-XX:+UseG1GC
         *    
         * 5. ZGC收集器 (超低延迟)
         *    - 并发，停顿时间不超过10ms
         *    - 参数：-XX:+UseZGC
         *    
         * 6. Shenandoah收集器 (低延迟)
         *    - 并发，与ZGC类似
         *    - 参数：-XX:+UseShenandoahGC
         */</span>
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printGCInfo</span><span class="hljs-params">()</span> {
            <span class="hljs-comment">// 获取当前GC信息</span>
            List&lt;GarbageCollectorMXBean&gt; gcBeans = 
                ManagementFactory.getGarbageCollectorMXBeans();
            
            System.out.println(<span class="hljs-string">"=== GC收集器信息 ==="</span>);
            <span class="hljs-keyword">for</span> (GarbageCollectorMXBean gcBean : gcBeans) {
                System.out.println(<span class="hljs-string">"收集器名称: "</span> + gcBean.getName());
                System.out.println(<span class="hljs-string">"  收集次数: "</span> + gcBean.getCollectionCount());
                System.out.println(<span class="hljs-string">"  收集时间: "</span> + gcBean.getCollectionTime() + <span class="hljs-string">"ms"</span>);
                System.out.println(<span class="hljs-string">"  内存池名称: "</span> + 
                    Arrays.toString(gcBean.getMemoryPoolNames()));
                System.out.println();
            }
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">suggestGCParameters</span><span class="hljs-params">()</span> {
            System.out.println(<span class="hljs-string">"=== GC参数建议 ==="</span>);
            
            <span class="hljs-type">String</span> <span class="hljs-variable">appType</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">"app.type"</span>, <span class="hljs-string">"web"</span>);
            
            <span class="hljs-keyword">switch</span> (appType) {
                <span class="hljs-keyword">case</span> <span class="hljs-string">"web"</span>:
                    System.out.println(<span class="hljs-string">"Web应用推荐使用G1GC:"</span>);
                    System.out.println(<span class="hljs-string">"  -XX:+UseG1GC"</span>);
                    System.out.println(<span class="hljs-string">"  -XX:MaxGCPauseMillis=200"</span>);
                    System.out.println(<span class="hljs-string">"  -XX:G1HeapRegionSize=4M"</span>);
                    <span class="hljs-keyword">break</span>;
                    
                <span class="hljs-keyword">case</span> <span class="hljs-string">"batch"</span>:
                    System.out.println(<span class="hljs-string">"批处理应用推荐使用ParallelGC:"</span>);
                    System.out.println(<span class="hljs-string">"  -XX:+UseParallelGC"</span>);
                    System.out.println(<span class="hljs-string">"  -XX:ParallelGCThreads=CPU核心数"</span>);
                    System.out.println(<span class="hljs-string">"  -XX:+UseAdaptiveSizePolicy"</span>);
                    <span class="hljs-keyword">break</span>;
                    
                <span class="hljs-keyword">case</span> <span class="hljs-string">"low-latency"</span>:
                    System.out.println(<span class="hljs-string">"低延迟应用推荐使用ZGC:"</span>);
                    System.out.println(<span class="hljs-string">"  -XX:+UseZGC"</span>);
                    System.out.println(<span class="hljs-string">"  -Xmx&lt;size&gt; -Xms&lt;size&gt; (设置堆大小)"</span>);
                    System.out.println(<span class="hljs-string">"  -XX:ConcGCThreads=&lt;threads&gt;"</span>);
                    <span class="hljs-keyword">break</span>;
                    
                <span class="hljs-keyword">default</span>:
                    System.out.println(<span class="hljs-string">"通用建议:"</span>);
                    System.out.println(<span class="hljs-string">"  -XX:+UseG1GC (JDK 9+默认)"</span>);
                    System.out.println(<span class="hljs-string">"  -Xmx和-Xms设置为相同值避免堆震荡"</span>);
            }
        }
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        System.out.println(<span class="hljs-string">"=== 分代收集模拟 ==="</span>);
        
        <span class="hljs-comment">// 模拟对象分配和GC</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">20</span>; i++) {
            GenerationalGCSimulation.allocate();
            
            <span class="hljs-keyword">if</span> (i % <span class="hljs-number">5</span> == <span class="hljs-number">0</span>) {
                GenerationalGCSimulation.minorGC();
            }
            
            <span class="hljs-keyword">if</span> (i % <span class="hljs-number">10</span> == <span class="hljs-number">0</span>) {
                GenerationalGCSimulation.fullGC();
            }
            
            Thread.sleep(<span class="hljs-number">100</span>);
        }
        
        GenerationalGCSimulation.printStats();
        
        System.out.println(<span class="hljs-string">"\n=== 实际GC信息 ==="</span>);
        GCCollectorsComparison.printGCInfo();
        GCCollectorsComparison.suggestGCParameters();
    }
}
</code></pre>
<h2 data-id="heading-7">JVM监控与故障诊断</h2>
<h3 data-id="heading-8">1. 命令行监控工具</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JVMMonitoringTools</span> {
    
    <span class="hljs-comment">// 获取JVM运行时信息</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printRuntimeInfo</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Runtime</span> <span class="hljs-variable">runtime</span> <span class="hljs-operator">=</span> Runtime.getRuntime();
        
        System.out.println(<span class="hljs-string">"=== JVM运行时信息 ==="</span>);
        System.out.println(<span class="hljs-string">"可用处理器: "</span> + runtime.availableProcessors());
        System.out.println(<span class="hljs-string">"最大内存: "</span> + formatBytes(runtime.maxMemory()));
        System.out.println(<span class="hljs-string">"总内存: "</span> + formatBytes(runtime.totalMemory()));
        System.out.println(<span class="hljs-string">"空闲内存: "</span> + formatBytes(runtime.freeMemory()));
        System.out.println(<span class="hljs-string">"已用内存: "</span> + 
            formatBytes(runtime.totalMemory() - runtime.freeMemory()));
    }
    
    <span class="hljs-comment">// 获取内存管理器信息</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printMemoryManagerInfo</span><span class="hljs-params">()</span> {
        List&lt;MemoryManagerMXBean&gt; memoryManagers = 
            ManagementFactory.getMemoryManagerMXBeans();
        
        System.out.println(<span class="hljs-string">"\n=== 内存管理器 ==="</span>);
        <span class="hljs-keyword">for</span> (MemoryManagerMXBean manager : memoryManagers) {
            System.out.println(<span class="hljs-string">"管理器: "</span> + manager.getName());
            System.out.println(<span class="hljs-string">"  内存池: "</span> + 
                Arrays.toString(manager.getMemoryPoolNames()));
        }
    }
    
    <span class="hljs-comment">// 获取内存池信息</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printMemoryPoolInfo</span><span class="hljs-params">()</span> {
        List&lt;MemoryPoolMXBean&gt; memoryPools = 
            ManagementFactory.getMemoryPoolMXBeans();
        
        System.out.println(<span class="hljs-string">"\n=== 内存池信息 ==="</span>);
        <span class="hljs-keyword">for</span> (MemoryPoolMXBean pool : memoryPools) {
            <span class="hljs-type">MemoryUsage</span> <span class="hljs-variable">usage</span> <span class="hljs-operator">=</span> pool.getUsage();
            <span class="hljs-type">MemoryUsage</span> <span class="hljs-variable">peakUsage</span> <span class="hljs-operator">=</span> pool.getPeakUsage();
            
            System.out.println(<span class="hljs-string">"内存池: "</span> + pool.getName());
            System.out.println(<span class="hljs-string">"  类型: "</span> + pool.getType());
            System.out.println(<span class="hljs-string">"  使用量: "</span> + formatBytes(usage.getUsed()) + 
                             <span class="hljs-string">" / "</span> + formatBytes(usage.getMax()));
            System.out.println(<span class="hljs-string">"  提交量: "</span> + formatBytes(usage.getCommitted()));
            System.out.println(<span class="hljs-string">"  峰值: "</span> + formatBytes(peakUsage.getUsed()));
            System.out.println(<span class="hljs-string">"  使用率: "</span> + 
                String.format(<span class="hljs-string">"%.2f%%"</span>, (usage.getUsed() * <span class="hljs-number">100.0</span> / usage.getMax())));
        }
    }
    
    <span class="hljs-comment">// 获取线程信息</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printThreadInfo</span><span class="hljs-params">()</span> {
        <span class="hljs-type">ThreadMXBean</span> <span class="hljs-variable">threadBean</span> <span class="hljs-operator">=</span> ManagementFactory.getThreadMXBean();
        
        System.out.println(<span class="hljs-string">"\n=== 线程信息 ==="</span>);
        System.out.println(<span class="hljs-string">"活动线程数: "</span> + threadBean.getThreadCount());
        System.out.println(<span class="hljs-string">"峰值线程数: "</span> + threadBean.getPeakThreadCount());
        System.out.println(<span class="hljs-string">"守护线程数: "</span> + threadBean.getDaemonThreadCount());
        System.out.println(<span class="hljs-string">"总启动线程数: "</span> + threadBean.getTotalStartedThreadCount());
        
        <span class="hljs-comment">// 检测死锁</span>
        <span class="hljs-type">long</span>[] deadlockedThreads = threadBean.findDeadlockedThreads();
        <span class="hljs-keyword">if</span> (deadlockedThreads != <span class="hljs-literal">null</span> &amp;&amp; deadlockedThreads.length &gt; <span class="hljs-number">0</span>) {
            System.out.println(<span class="hljs-string">"检测到死锁线程:"</span>);
            <span class="hljs-keyword">for</span> (<span class="hljs-type">long</span> threadId : deadlockedThreads) {
                System.out.println(<span class="hljs-string">"  线程ID: "</span> + threadId);
            }
        }
    }
    
    <span class="hljs-comment">// 获取类加载信息</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printClassLoadingInfo</span><span class="hljs-params">()</span> {
        <span class="hljs-type">ClassLoadingMXBean</span> <span class="hljs-variable">classBean</span> <span class="hljs-operator">=</span> ManagementFactory.getClassLoadingMXBean();
        
        System.out.println(<span class="hljs-string">"\n=== 类加载信息 ==="</span>);
        System.out.println(<span class="hljs-string">"已加载类总数: "</span> + classBean.getTotalLoadedClassCount());
        System.out.println(<span class="hljs-string">"当前加载类数: "</span> + classBean.getLoadedClassCount());
        System.out.println(<span class="hljs-string">"已卸载类数: "</span> + classBean.getUnloadedClassCount());
    }
    
    <span class="hljs-comment">// 获取操作系统信息</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printOSInfo</span><span class="hljs-params">()</span> {
        <span class="hljs-type">OperatingSystemMXBean</span> <span class="hljs-variable">osBean</span> <span class="hljs-operator">=</span> ManagementFactory.getOperatingSystemMXBean();
        
        System.out.println(<span class="hljs-string">"\n=== 操作系统信息 ==="</span>);
        System.out.println(<span class="hljs-string">"操作系统: "</span> + osBean.getName() + 
                         <span class="hljs-string">" "</span> + osBean.getVersion());
        System.out.println(<span class="hljs-string">"系统架构: "</span> + osBean.getArch());
        System.out.println(<span class="hljs-string">"可用处理器: "</span> + osBean.getAvailableProcessors());
        
        <span class="hljs-keyword">if</span> (osBean <span class="hljs-keyword">instanceof</span> com.sun.management.OperatingSystemMXBean) {
            com.sun.management.<span class="hljs-type">OperatingSystemMXBean</span> <span class="hljs-variable">sunOsBean</span> <span class="hljs-operator">=</span> 
                (com.sun.management.OperatingSystemMXBean) osBean;
            
            System.out.println(<span class="hljs-string">"系统负载: "</span> + sunOsBean.getSystemLoadAverage());
            System.out.println(<span class="hljs-string">"进程CPU时间: "</span> + 
                sunOsBean.getProcessCpuTime() / <span class="hljs-number">1_000_000</span> + <span class="hljs-string">"ms"</span>);
            System.out.println(<span class="hljs-string">"进程CPU使用率: "</span> + 
                String.format(<span class="hljs-string">"%.2f%%"</span>, sunOsBean.getProcessCpuLoad() * <span class="hljs-number">100</span>));
            System.out.println(<span class="hljs-string">"系统CPU使用率: "</span> + 
                String.format(<span class="hljs-string">"%.2f%%"</span>, sunOsBean.getSystemCpuLoad() * <span class="hljs-number">100</span>));
        }
    }
    
    <span class="hljs-comment">// 堆内存转储分析</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HeapDumpAnalyzer</span> {
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">triggerHeapDump</span><span class="hljs-params">(String fileName)</span> {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 触发堆转储</span>
                <span class="hljs-type">String</span> <span class="hljs-variable">pid</span> <span class="hljs-operator">=</span> ManagementFactory.getRuntimeMXBean().getName().split(<span class="hljs-string">"@"</span>)[<span class="hljs-number">0</span>];
                <span class="hljs-type">String</span> <span class="hljs-variable">command</span> <span class="hljs-operator">=</span> <span class="hljs-string">"jcmd "</span> + pid + <span class="hljs-string">" GC.heap_dump "</span> + fileName;
                
                System.out.println(<span class="hljs-string">"执行命令: "</span> + command);
                
                <span class="hljs-comment">// 实际环境中可以使用以下方法之一：</span>
                <span class="hljs-comment">// 1. 使用jcmd命令</span>
                <span class="hljs-comment">// 2. 使用JMX: HotSpotDiagnosticMXBean.dumpHeap()</span>
                <span class="hljs-comment">// 3. 在启动时添加参数: -XX:+HeapDumpOnOutOfMemoryError</span>
                
                System.out.println(<span class="hljs-string">"堆转储文件: "</span> + fileName);
                
            } <span class="hljs-keyword">catch</span> (Exception e) {
                e.printStackTrace();
            }
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">analyzeMemoryLeak</span><span class="hljs-params">()</span> {
            System.out.println(<span class="hljs-string">"\n=== 内存泄漏分析步骤 ==="</span>);
            System.out.println(<span class="hljs-string">"1. 使用 jps 命令查找Java进程ID"</span>);
            System.out.println(<span class="hljs-string">"2. 使用 jmap 生成堆转储:"</span>);
            System.out.println(<span class="hljs-string">"   jmap -dump:live,format=b,file=heap.bin &lt;pid&gt;"</span>);
            System.out.println(<span class="hljs-string">"3. 使用分析工具打开堆转储文件:"</span>);
            System.out.println(<span class="hljs-string">"   - Eclipse MAT (Memory Analyzer Tool)"</span>);
            System.out.println(<span class="hljs-string">"   - VisualVM"</span>);
            System.out.println(<span class="hljs-string">"   - YourKit"</span>);
            System.out.println(<span class="hljs-string">"4. 查找:"</span>);
            System.out.println(<span class="hljs-string">"   - 最大的对象"</span>);
            System.out.println(<span class="hljs-string">"   - 重复的字符串"</span>);
            System.out.println(<span class="hljs-string">"   - 未关闭的资源"</span>);
        }
    }
    
    <span class="hljs-comment">// JVM参数优化建议</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JVMOptimizer</span> {
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">analyzeAndSuggest</span><span class="hljs-params">()</span> {
            <span class="hljs-type">RuntimeMXBean</span> <span class="hljs-variable">runtimeBean</span> <span class="hljs-operator">=</span> ManagementFactory.getRuntimeMXBean();
            List&lt;String&gt; inputArgs = runtimeBean.getInputArguments();
            
            System.out.println(<span class="hljs-string">"\n=== 当前JVM参数 ==="</span>);
            <span class="hljs-keyword">for</span> (String arg : inputArgs) {
                System.out.println(<span class="hljs-string">"  "</span> + arg);
            }
            
            System.out.println(<span class="hljs-string">"\n=== 优化建议 ==="</span>);
            
            <span class="hljs-comment">// 检查堆大小设置</span>
            <span class="hljs-type">boolean</span> <span class="hljs-variable">hasXmx</span> <span class="hljs-operator">=</span> inputArgs.stream().anyMatch(arg -&gt; arg.startsWith(<span class="hljs-string">"-Xmx"</span>));
            <span class="hljs-type">boolean</span> <span class="hljs-variable">hasXms</span> <span class="hljs-operator">=</span> inputArgs.stream().anyMatch(arg -&gt; arg.startsWith(<span class="hljs-string">"-Xms"</span>));
            
            <span class="hljs-keyword">if</span> (!hasXmx) {
                System.out.println(<span class="hljs-string">"建议设置最大堆大小: -Xmx4g (根据实际内存调整)"</span>);
            }
            
            <span class="hljs-keyword">if</span> (!hasXms) {
                System.out.println(<span class="hljs-string">"建议设置初始堆大小: -Xms2g (与-Xmx相同以避免堆震荡)"</span>);
            }
            
            <span class="hljs-comment">// 检查GC设置</span>
            <span class="hljs-type">boolean</span> <span class="hljs-variable">hasGCParam</span> <span class="hljs-operator">=</span> inputArgs.stream()
                .anyMatch(arg -&gt; arg.startsWith(<span class="hljs-string">"-XX:+Use"</span>) &amp;&amp; arg.contains(<span class="hljs-string">"GC"</span>));
            
            <span class="hljs-keyword">if</span> (!hasGCParam) {
                System.out.println(<span class="hljs-string">"建议明确指定GC收集器:"</span>);
                System.out.println(<span class="hljs-string">"  G1GC: -XX:+UseG1GC -XX:MaxGCPauseMillis=200"</span>);
                System.out.println(<span class="hljs-string">"  ZGC: -XX:+UseZGC (适用于低延迟应用)"</span>);
            }
            
            <span class="hljs-comment">// 检查元空间设置</span>
            <span class="hljs-type">boolean</span> <span class="hljs-variable">hasMetaspaceParam</span> <span class="hljs-operator">=</span> inputArgs.stream()
                .anyMatch(arg -&gt; arg.contains(<span class="hljs-string">"MetaspaceSize"</span>) || arg.contains(<span class="hljs-string">"MaxMetaspaceSize"</span>));
            
            <span class="hljs-keyword">if</span> (!hasMetaspaceParam) {
                System.out.println(<span class="hljs-string">"建议设置元空间大小:"</span>);
                System.out.println(<span class="hljs-string">"  -XX:MetaspaceSize=256m"</span>);
                System.out.println(<span class="hljs-string">"  -XX:MaxMetaspaceSize=512m"</span>);
            }
        }
    }
    
    <span class="hljs-comment">// 格式化字节大小为易读格式</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">formatBytes</span><span class="hljs-params">(<span class="hljs-type">long</span> bytes)</span> {
        <span class="hljs-keyword">if</span> (bytes &lt; <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> bytes + <span class="hljs-string">" B"</span>;
        <span class="hljs-type">int</span> <span class="hljs-variable">exp</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) (Math.log(bytes) / Math.log(<span class="hljs-number">1024</span>));
        <span class="hljs-type">char</span> <span class="hljs-variable">unit</span> <span class="hljs-operator">=</span> <span class="hljs-string">"KMGTPE"</span>.charAt(exp - <span class="hljs-number">1</span>);
        <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"%.2f %sB"</span>, bytes / Math.pow(<span class="hljs-number">1024</span>, exp), unit);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        printRuntimeInfo();
        printMemoryManagerInfo();
        printMemoryPoolInfo();
        printThreadInfo();
        printClassLoadingInfo();
        printOSInfo();
        
        HeapDumpAnalyzer.analyzeMemoryLeak();
        JVMOptimizer.analyzeAndSuggest();
    }
}
</code></pre>
<h3 data-id="heading-9">2. 可视化监控工具集成</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VisualMonitoringTools</span> {
    
    <span class="hljs-comment">// 简易的内存监控仪表盘</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MemoryMonitorDashboard</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">HISTORY_SIZE</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span>;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;Long&gt; heapHistory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;Long&gt; nonHeapHistory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ScheduledExecutorService</span> <span class="hljs-variable">scheduler</span> <span class="hljs-operator">=</span> 
            Executors.newScheduledThreadPool(<span class="hljs-number">1</span>);
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startMonitoring</span><span class="hljs-params">(<span class="hljs-type">int</span> intervalSeconds)</span> {
            System.out.println(<span class="hljs-string">"启动内存监控，间隔: "</span> + intervalSeconds + <span class="hljs-string">"秒"</span>);
            
            scheduler.scheduleAtFixedRate(() -&gt; {
                <span class="hljs-keyword">try</span> {
                    updateMetrics();
                    printDashboard();
                } <span class="hljs-keyword">catch</span> (Exception e) {
                    e.printStackTrace();
                }
            }, <span class="hljs-number">0</span>, intervalSeconds, TimeUnit.SECONDS);
        }
        
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateMetrics</span><span class="hljs-params">()</span> {
            <span class="hljs-type">MemoryMXBean</span> <span class="hljs-variable">memoryBean</span> <span class="hljs-operator">=</span> ManagementFactory.getMemoryMXBean();
            
            <span class="hljs-comment">// 堆内存使用情况</span>
            <span class="hljs-type">MemoryUsage</span> <span class="hljs-variable">heapUsage</span> <span class="hljs-operator">=</span> memoryBean.getHeapMemoryUsage();
            heapHistory.add(heapUsage.getUsed());
            <span class="hljs-keyword">if</span> (heapHistory.size() &gt; HISTORY_SIZE) {
                heapHistory.remove(<span class="hljs-number">0</span>);
            }
            
            <span class="hljs-comment">// 非堆内存使用情况</span>
            <span class="hljs-type">MemoryUsage</span> <span class="hljs-variable">nonHeapUsage</span> <span class="hljs-operator">=</span> memoryBean.getNonHeapMemoryUsage();
            nonHeapHistory.add(nonHeapUsage.getUsed());
            <span class="hljs-keyword">if</span> (nonHeapHistory.size() &gt; HISTORY_SIZE) {
                nonHeapHistory.remove(<span class="hljs-number">0</span>);
            }
        }
        
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printDashboard</span><span class="hljs-params">()</span> {
            System.out.println(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>.repeat(<span class="hljs-number">60</span>));
            System.out.println(<span class="hljs-string">"内存监控仪表盘 - "</span> + <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());
            System.out.println(<span class="hljs-string">"="</span>.repeat(<span class="hljs-number">60</span>));
            
            <span class="hljs-type">MemoryMXBean</span> <span class="hljs-variable">memoryBean</span> <span class="hljs-operator">=</span> ManagementFactory.getMemoryMXBean();
            <span class="hljs-type">MemoryUsage</span> <span class="hljs-variable">heapUsage</span> <span class="hljs-operator">=</span> memoryBean.getHeapMemoryUsage();
            <span class="hljs-type">MemoryUsage</span> <span class="hljs-variable">nonHeapUsage</span> <span class="hljs-operator">=</span> memoryBean.getNonHeapMemoryUsage();
            
            <span class="hljs-comment">// 堆内存图表</span>
            printMemoryChart(<span class="hljs-string">"堆内存"</span>, heapUsage, heapHistory);
            
            <span class="hljs-comment">// 非堆内存图表</span>
            printMemoryChart(<span class="hljs-string">"非堆内存"</span>, nonHeapUsage, nonHeapHistory);
            
            <span class="hljs-comment">// GC信息</span>
            printGCInfo();
        }
        
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printMemoryChart</span><span class="hljs-params">(String title, MemoryUsage usage, 
                                     List&lt;Long&gt; history)</span> {
            <span class="hljs-type">long</span> <span class="hljs-variable">used</span> <span class="hljs-operator">=</span> usage.getUsed();
            <span class="hljs-type">long</span> <span class="hljs-variable">committed</span> <span class="hljs-operator">=</span> usage.getCommitted();
            <span class="hljs-type">long</span> <span class="hljs-variable">max</span> <span class="hljs-operator">=</span> usage.getMax();
            
            System.out.println(<span class="hljs-string">"\n"</span> + title + <span class="hljs-string">":"</span>);
            System.out.println(<span class="hljs-string">"  使用: "</span> + formatBytes(used));
            System.out.println(<span class="hljs-string">"  提交: "</span> + formatBytes(committed));
            System.out.println(<span class="hljs-string">"  最大: "</span> + (max == -<span class="hljs-number">1</span> ? <span class="hljs-string">"无限制"</span> : formatBytes(max)));
            
            <span class="hljs-type">double</span> <span class="hljs-variable">usagePercent</span> <span class="hljs-operator">=</span> (<span class="hljs-type">double</span>) used / committed * <span class="hljs-number">100</span>;
            System.out.printf(<span class="hljs-string">"  使用率: %.2f%%\n"</span>, usagePercent);
            
            <span class="hljs-comment">// 简单图表</span>
            <span class="hljs-keyword">if</span> (!history.isEmpty()) {
                System.out.print(<span class="hljs-string">"  趋势图: "</span>);
                <span class="hljs-type">long</span> <span class="hljs-variable">avg</span> <span class="hljs-operator">=</span> history.stream().mapToLong(Long::longValue).sum() / history.size();
                <span class="hljs-type">long</span> <span class="hljs-variable">min</span> <span class="hljs-operator">=</span> history.stream().mapToLong(Long::longValue).min().orElse(<span class="hljs-number">0</span>);
                <span class="hljs-type">long</span> <span class="hljs-variable">maxVal</span> <span class="hljs-operator">=</span> history.stream().mapToLong(Long::longValue).max().orElse(<span class="hljs-number">0</span>);
                
                System.out.printf(<span class="hljs-string">"[最小: %s, 平均: %s, 最大: %s]\n"</span>,
                    formatBytes(min), formatBytes(avg), formatBytes(maxVal));
            }
        }
        
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printGCInfo</span><span class="hljs-params">()</span> {
            List&lt;GarbageCollectorMXBean&gt; gcBeans = 
                ManagementFactory.getGarbageCollectorMXBeans();
            
            System.out.println(<span class="hljs-string">"\n垃圾回收:"</span>);
            <span class="hljs-keyword">for</span> (GarbageCollectorMXBean gcBean : gcBeans) {
                System.out.printf(<span class="hljs-string">"  %s: 次数=%d, 时间=%,dms\n"</span>,
                    gcBean.getName(),
                    gcBean.getCollectionCount(),
                    gcBean.getCollectionTime());
            }
        }
        
        <span class="hljs-keyword">private</span> String <span class="hljs-title function_">formatBytes</span><span class="hljs-params">(<span class="hljs-type">long</span> bytes)</span> {
            <span class="hljs-keyword">if</span> (bytes &lt; <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> bytes + <span class="hljs-string">"B"</span>;
            <span class="hljs-keyword">if</span> (bytes &lt; <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"%.1fKB"</span>, bytes / <span class="hljs-number">1024.0</span>);
            <span class="hljs-keyword">if</span> (bytes &lt; <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>) <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"%.1fMB"</span>, bytes / (<span class="hljs-number">1024.0</span> * <span class="hljs-number">1024</span>));
            <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"%.1fGB"</span>, bytes / (<span class="hljs-number">1024.0</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>));
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">stop</span><span class="hljs-params">()</span> {
            scheduler.shutdown();
            System.out.println(<span class="hljs-string">"监控已停止"</span>);
        }
    }
    
    <span class="hljs-comment">// 性能瓶颈检测</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PerformanceProfiler</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, MethodStats&gt; methodStats = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
        
        <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MethodStats</span> {
            String methodName;
            <span class="hljs-type">long</span> invocationCount;
            <span class="hljs-type">long</span> totalTime;
            <span class="hljs-type">long</span> maxTime;
            <span class="hljs-type">long</span> <span class="hljs-variable">minTime</span> <span class="hljs-operator">=</span> Long.MAX_VALUE;
            
            <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">recordInvocation</span><span class="hljs-params">(<span class="hljs-type">long</span> duration)</span> {
                invocationCount++;
                totalTime += duration;
                maxTime = Math.max(maxTime, duration);
                minTime = Math.min(minTime, duration);
            }
            
            <span class="hljs-type">double</span> <span class="hljs-title function_">getAverageTime</span><span class="hljs-params">()</span> {
                <span class="hljs-keyword">return</span> invocationCount == <span class="hljs-number">0</span> ? <span class="hljs-number">0</span> : (<span class="hljs-type">double</span>) totalTime / invocationCount;
            }
        }
        
        <span class="hljs-comment">// AOP风格的方法拦截（简化版）</span>
        <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">profile</span><span class="hljs-params">(Supplier&lt;T&gt; task, String methodName)</span> {
            <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> System.nanoTime();
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">return</span> task.get();
            } <span class="hljs-keyword">finally</span> {
                <span class="hljs-type">long</span> <span class="hljs-variable">duration</span> <span class="hljs-operator">=</span> System.nanoTime() - startTime;
                methodStats.computeIfAbsent(methodName, k -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">MethodStats</span>())
                          .recordInvocation(duration);
            }
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printProfilingReport</span><span class="hljs-params">()</span> {
            System.out.println(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>.repeat(<span class="hljs-number">60</span>));
            System.out.println(<span class="hljs-string">"方法性能分析报告"</span>);
            System.out.println(<span class="hljs-string">"="</span>.repeat(<span class="hljs-number">60</span>));
            
            methodStats.entrySet().stream()
                .sorted((a, b) -&gt; Long.compare(b.getValue().totalTime, a.getValue().totalTime))
                .limit(<span class="hljs-number">10</span>) <span class="hljs-comment">// 只显示最耗时的10个方法</span>
                .forEach(entry -&gt; {
                    <span class="hljs-type">MethodStats</span> <span class="hljs-variable">stats</span> <span class="hljs-operator">=</span> entry.getValue();
                    System.out.printf(<span class="hljs-string">"\n方法: %s\n"</span>, entry.getKey());
                    System.out.printf(<span class="hljs-string">"  调用次数: %,d\n"</span>, stats.invocationCount);
                    System.out.printf(<span class="hljs-string">"  总耗时: %,.2fms\n"</span>, stats.totalTime / <span class="hljs-number">1_000_000.0</span>);
                    System.out.printf(<span class="hljs-string">"  平均耗时: %,.2fms\n"</span>, stats.getAverageTime() / <span class="hljs-number">1_000_000.0</span>);
                    System.out.printf(<span class="hljs-string">"  最长时间: %,.2fms\n"</span>, stats.maxTime / <span class="hljs-number">1_000_000.0</span>);
                    System.out.printf(<span class="hljs-string">"  最短时间: %,.2fms\n"</span>, stats.minTime / <span class="hljs-number">1_000_000.0</span>);
                });
        }
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        System.out.println(<span class="hljs-string">"=== 可视化监控工具演示 ==="</span>);
        
        <span class="hljs-comment">// 启动内存监控</span>
        <span class="hljs-type">MemoryMonitorDashboard</span> <span class="hljs-variable">dashboard</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MemoryMonitorDashboard</span>();
        dashboard.startMonitoring(<span class="hljs-number">2</span>); <span class="hljs-comment">// 每2秒更新一次</span>
        
        <span class="hljs-comment">// 创建性能分析器</span>
        <span class="hljs-type">PerformanceProfiler</span> <span class="hljs-variable">profiler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PerformanceProfiler</span>();
        
        <span class="hljs-comment">// 模拟一些方法调用</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
            profiler.profile(() -&gt; {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-comment">// 模拟耗时操作</span>
                    Thread.sleep(<span class="hljs-number">100</span> + (<span class="hljs-type">long</span>)(Math.random() * <span class="hljs-number">100</span>));
                    <span class="hljs-keyword">return</span> <span class="hljs-string">"操作完成"</span>;
                } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);
                }
            }, <span class="hljs-string">"simulatedOperation"</span>);
            
            <span class="hljs-comment">// 模拟另一个方法</span>
            profiler.profile(() -&gt; {
                <span class="hljs-comment">// 模拟计算密集型操作</span>
                <span class="hljs-type">long</span> <span class="hljs-variable">sum</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">1000000</span>; j++) {
                    sum += j;
                }
                <span class="hljs-keyword">return</span> sum;
            }, <span class="hljs-string">"calculateSum"</span>);
            
            Thread.sleep(<span class="hljs-number">500</span>);
        }
        
        <span class="hljs-comment">// 打印性能报告</span>
        profiler.printProfilingReport();
        
        <span class="hljs-comment">// 运行一段时间后停止监控</span>
        Thread.sleep(<span class="hljs-number">10000</span>);
        dashboard.stop();
        
        System.out.println(<span class="hljs-string">"\n监控演示完成"</span>);
    }
}
</code></pre>
<h2 data-id="heading-10">实战：JVM调优案例</h2>
<h3 data-id="heading-11">案例1：电商系统调优</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ECommerceJVMOptimization</span> {
    
    <span class="hljs-comment">/**
     * 电商系统特点：
     * 1. 高并发：大量用户同时访问
     * 2. 大内存：商品信息、用户会话缓存
     * 3. 低延迟：页面加载要快
     * 4. 频繁GC：大量短期对象（请求、响应对象）
     */</span>
    
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductService</span> {
        <span class="hljs-comment">// 商品缓存（大对象）</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;Integer, <span class="hljs-type">byte</span>[]&gt; productCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
        
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">ProductService</span><span class="hljs-params">()</span> {
            <span class="hljs-comment">// 初始化缓存（模拟10000个商品，每个商品信息100KB）</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000</span>; i++) {
                productCache.put(i, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span> * <span class="hljs-number">100</span>]); <span class="hljs-comment">// 100KB</span>
            }
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] getProduct(<span class="hljs-type">int</span> id) {
            <span class="hljs-keyword">return</span> profile(() -&gt; {
                <span class="hljs-comment">// 模拟业务逻辑</span>
                <span class="hljs-type">byte</span>[] product = productCache.get(id);
                <span class="hljs-keyword">if</span> (product == <span class="hljs-literal">null</span>) {
                    <span class="hljs-comment">// 模拟数据库查询</span>
                    product = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span> * <span class="hljs-number">50</span>]; <span class="hljs-comment">// 50KB</span>
                    productCache.put(id, product);
                }
                
                <span class="hljs-comment">// 创建响应对象（短期对象）</span>
                <span class="hljs-type">byte</span>[] response = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[product.length + <span class="hljs-number">1024</span>];
                System.arraycopy(product, <span class="hljs-number">0</span>, response, <span class="hljs-number">0</span>, product.length);
                
                <span class="hljs-keyword">return</span> response;
            }, <span class="hljs-string">"getProduct"</span>);
        }
        
        <span class="hljs-comment">// 模拟用户请求</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">simulateUserRequests</span><span class="hljs-params">(<span class="hljs-type">int</span> requestCount)</span> {
            <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">50</span>);
            
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; requestCount; i++) {
                <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">productId</span> <span class="hljs-operator">=</span> i % <span class="hljs-number">10000</span>;
                executor.submit(() -&gt; {
                    getProduct(productId);
                });
            }
            
            executor.shutdown();
            <span class="hljs-keyword">try</span> {
                executor.awaitTermination(<span class="hljs-number">30</span>, TimeUnit.SECONDS);
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                e.printStackTrace();
            }
        }
        
        <span class="hljs-keyword">private</span> &lt;T&gt; T <span class="hljs-title function_">profile</span><span class="hljs-params">(Supplier&lt;T&gt; task, String methodName)</span> {
            <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.nanoTime();
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">return</span> task.get();
            } <span class="hljs-keyword">finally</span> {
                <span class="hljs-type">long</span> <span class="hljs-variable">duration</span> <span class="hljs-operator">=</span> System.nanoTime() - start;
                <span class="hljs-comment">// 这里可以记录性能指标</span>
            }
        }
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OptimizationStrategy</span> {
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printOptimizationPlan</span><span class="hljs-params">()</span> {
            System.out.println(<span class="hljs-string">"=== 电商系统JVM调优方案 ==="</span>);
            System.out.println(<span class="hljs-string">"\n1. 堆内存设置:"</span>);
            System.out.println(<span class="hljs-string">"   -Xms4g -Xmx4g  # 固定堆大小，避免堆震荡"</span>);
            System.out.println(<span class="hljs-string">"   -XX:NewRatio=2  # 新生代:老年代 = 1:2"</span>);
            System.out.println(<span class="hljs-string">"   -XX:SurvivorRatio=8  # Eden:Survivor = 8:1:1"</span>);
            
            System.out.println(<span class="hljs-string">"\n2. GC策略:"</span>);
            System.out.println(<span class="hljs-string">"   -XX:+UseG1GC  # 使用G1收集器"</span>);
            System.out.println(<span class="hljs-string">"   -XX:MaxGCPauseMillis=200  # 目标停顿时间200ms"</span>);
            System.out.println(<span class="hljs-string">"   -XX:G1HeapRegionSize=4m  # 区域大小4MB"</span>);
            System.out.println(<span class="hljs-string">"   -XX:InitiatingHeapOccupancyPercent=45  # IHOP阈值"</span>);
            
            System.out.println(<span class="hljs-string">"\n3. 元空间设置:"</span>);
            System.out.println(<span class="hljs-string">"   -XX:MetaspaceSize=256m"</span>);
            System.out.println(<span class="hljs-string">"   -XX:MaxMetaspaceSize=512m"</span>);
            
            System.out.println(<span class="hljs-string">"\n4. 代码优化建议:"</span>);
            System.out.println(<span class="hljs-string">"   a. 使用对象池复用大对象"</span>);
            System.out.println(<span class="hljs-string">"   b. 避免在热点路径中创建大数组"</span>);
            System.out.println(<span class="hljs-string">"   c. 使用软引用/弱引用缓存"</span>);
            System.out.println(<span class="hljs-string">"   d. 及时清理会话数据"</span>);
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">implementObjectPool</span><span class="hljs-params">()</span> {
            System.out.println(<span class="hljs-string">"\n=== 对象池实现示例 ==="</span>);
            
            <span class="hljs-comment">// 简单对象池实现</span>
            <span class="hljs-keyword">class</span> <span class="hljs-title class_">ByteArrayPool</span> {
                <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Queue&lt;<span class="hljs-type">byte</span>[]&gt; pool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentLinkedQueue</span>&lt;&gt;();
                <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> arraySize;
                
                <span class="hljs-keyword">public</span> <span class="hljs-title function_">ByteArrayPool</span><span class="hljs-params">(<span class="hljs-type">int</span> arraySize, <span class="hljs-type">int</span> initialSize)</span> {
                    <span class="hljs-built_in">this</span>.arraySize = arraySize;
                    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; initialSize; i++) {
                        pool.offer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[arraySize]);
                    }
                }
                
                <span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] borrow() {
                    <span class="hljs-type">byte</span>[] array = pool.poll();
                    <span class="hljs-keyword">if</span> (array == <span class="hljs-literal">null</span>) {
                        array = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[arraySize];
                    }
                    <span class="hljs-keyword">return</span> array;
                }
                
                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">returnObject</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] array)</span> {
                    <span class="hljs-keyword">if</span> (array != <span class="hljs-literal">null</span> &amp;&amp; array.length == arraySize) {
                        <span class="hljs-comment">// 清空数组内容</span>
                        Arrays.fill(array, (<span class="hljs-type">byte</span>) <span class="hljs-number">0</span>);
                        pool.offer(array);
                    }
                }
            }
            
            <span class="hljs-comment">// 使用对象池</span>
            <span class="hljs-type">ByteArrayPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayPool</span>(<span class="hljs-number">1024</span> * <span class="hljs-number">100</span>, <span class="hljs-number">100</span>); <span class="hljs-comment">// 100KB * 100</span>
            
            <span class="hljs-comment">// 借用对象</span>
            <span class="hljs-type">byte</span>[] buffer = pool.borrow();
            
            <span class="hljs-comment">// 使用对象...</span>
            
            <span class="hljs-comment">// 归还对象</span>
            pool.returnObject(buffer);
            
            System.out.println(<span class="hljs-string">"对象池实现完成，减少对象创建开销"</span>);
        }
    }
    
    <span class="hljs-comment">// 压力测试工具</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StressTester</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ProductService productService;
        
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">StressTester</span><span class="hljs-params">(ProductService productService)</span> {
            <span class="hljs-built_in">this</span>.productService = productService;
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">runTest</span><span class="hljs-params">(<span class="hljs-type">int</span> durationSeconds, <span class="hljs-type">int</span> threads)</span> {
            System.out.println(<span class="hljs-string">"开始压力测试:"</span>);
            System.out.println(<span class="hljs-string">"  持续时间: "</span> + durationSeconds + <span class="hljs-string">"秒"</span>);
            System.out.println(<span class="hljs-string">"  并发线程: "</span> + threads);
            
            <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(threads);
            <span class="hljs-type">AtomicLong</span> <span class="hljs-variable">requestCount</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicLong</span>();
            <span class="hljs-type">AtomicBoolean</span> <span class="hljs-variable">running</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicBoolean</span>(<span class="hljs-literal">true</span>);
            
            <span class="hljs-comment">// 监控线程</span>
            <span class="hljs-type">ScheduledExecutorService</span> <span class="hljs-variable">monitor</span> <span class="hljs-operator">=</span> Executors.newSingleThreadScheduledExecutor();
            monitor.scheduleAtFixedRate(() -&gt; {
                System.out.println(<span class="hljs-string">"当前QPS: "</span> + requestCount.getAndSet(<span class="hljs-number">0</span>) + <span class="hljs-string">" 请求/秒"</span>);
            }, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, TimeUnit.SECONDS);
            
            <span class="hljs-comment">// 工作线程</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; threads; i++) {
                executor.submit(() -&gt; {
                    <span class="hljs-type">Random</span> <span class="hljs-variable">random</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>();
                    <span class="hljs-keyword">while</span> (running.get()) {
                        <span class="hljs-keyword">try</span> {
                            productService.getProduct(random.nextInt(<span class="hljs-number">10000</span>));
                            requestCount.incrementAndGet();
                            Thread.sleep(random.nextInt(<span class="hljs-number">10</span>)); <span class="hljs-comment">// 模拟思考时间</span>
                        } <span class="hljs-keyword">catch</span> (Exception e) {
                            e.printStackTrace();
                        }
                    }
                });
            }
            
            <span class="hljs-comment">// 运行指定时间</span>
            <span class="hljs-keyword">try</span> {
                Thread.sleep(durationSeconds * <span class="hljs-number">1000L</span>);
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                e.printStackTrace();
            }
            
            running.set(<span class="hljs-literal">false</span>);
            
            <span class="hljs-comment">// 清理</span>
            executor.shutdown();
            monitor.shutdown();
            
            <span class="hljs-keyword">try</span> {
                executor.awaitTermination(<span class="hljs-number">5</span>, TimeUnit.SECONDS);
                monitor.awaitTermination(<span class="hljs-number">5</span>, TimeUnit.SECONDS);
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                e.printStackTrace();
            }
            
            System.out.println(<span class="hljs-string">"压力测试完成"</span>);
        }
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        System.out.println(<span class="hljs-string">"=== 电商系统JVM调优实战 ==="</span>);
        
        <span class="hljs-comment">// 显示调优方案</span>
        OptimizationStrategy.printOptimizationPlan();
        OptimizationStrategy.implementObjectPool();
        
        <span class="hljs-comment">// 创建服务</span>
        <span class="hljs-type">ProductService</span> <span class="hljs-variable">productService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProductService</span>();
        
        <span class="hljs-comment">// 运行压力测试</span>
        <span class="hljs-type">StressTester</span> <span class="hljs-variable">tester</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StressTester</span>(productService);
        tester.runTest(<span class="hljs-number">30</span>, <span class="hljs-number">100</span>); <span class="hljs-comment">// 30秒，100并发</span>
        
        <span class="hljs-comment">// 显示GC统计</span>
        List&lt;GarbageCollectorMXBean&gt; gcBeans = 
            ManagementFactory.getGarbageCollectorMXBeans();
        
        System.out.println(<span class="hljs-string">"\n=== GC统计 ==="</span>);
        <span class="hljs-keyword">for</span> (GarbageCollectorMXBean gcBean : gcBeans) {
            System.out.printf(<span class="hljs-string">"%s: %d次, %dms\n"</span>,
                gcBean.getName(),
                gcBean.getCollectionCount(),
                gcBean.getCollectionTime());
        }
        
        <span class="hljs-comment">// 内存使用统计</span>
        <span class="hljs-type">MemoryMXBean</span> <span class="hljs-variable">memoryBean</span> <span class="hljs-operator">=</span> ManagementFactory.getMemoryMXBean();
        <span class="hljs-type">MemoryUsage</span> <span class="hljs-variable">heapUsage</span> <span class="hljs-operator">=</span> memoryBean.getHeapMemoryUsage();
        
        System.out.printf(<span class="hljs-string">"\n堆内存使用: %.2fMB / %.2fMB (%.1f%%)\n"</span>,
            heapUsage.getUsed() / <span class="hljs-number">1024.0</span> / <span class="hljs-number">1024</span>,
            heapUsage.getCommitted() / <span class="hljs-number">1024.0</span> / <span class="hljs-number">1024</span>,
            (heapUsage.getUsed() * <span class="hljs-number">100.0</span> / heapUsage.getCommitted()));
    }
}
</code></pre>
<h3 data-id="heading-12">案例2：大数据处理系统调优</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BigDataJVMOptimization</span> {
    
    <span class="hljs-comment">/**
     * 大数据处理系统特点：
     * 1. 大内存需求：处理大量数据
     * 2. 计算密集型：CPU使用率高
     * 3. 大量临时对象：中间计算结果
     * 4. 需要高吞吐量
     */</span>
    
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataProcessor</span> {
        <span class="hljs-comment">// 处理大数据集</span>
        <span class="hljs-keyword">public</span> List&lt;Map&lt;String, Object&gt;&gt; <span class="hljs-title function_">processLargeDataset</span><span class="hljs-params">(List&lt;<span class="hljs-type">byte</span>[]&gt; dataset)</span> {
            <span class="hljs-keyword">return</span> profile(() -&gt; {
                List&lt;Map&lt;String, Object&gt;&gt; results = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
                
                <span class="hljs-keyword">for</span> (<span class="hljs-type">byte</span>[] data : dataset) {
                    <span class="hljs-comment">// 解析数据（创建临时对象）</span>
                    Map&lt;String, Object&gt; record = parseRecord(data);
                    
                    <span class="hljs-comment">// 转换数据（更多临时对象）</span>
                    Map&lt;String, Object&gt; transformed = transformRecord(record);
                    
                    <span class="hljs-comment">// 聚合计算</span>
                    Map&lt;String, Object&gt; aggregated = aggregateRecord(transformed);
                    
                    results.add(aggregated);
                }
                
                <span class="hljs-keyword">return</span> results;
            }, <span class="hljs-string">"processLargeDataset"</span>);
        }
        
        <span class="hljs-keyword">private</span> Map&lt;String, Object&gt; <span class="hljs-title function_">parseRecord</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] data)</span> {
            <span class="hljs-comment">// 模拟解析，创建临时对象</span>
            Map&lt;String, Object&gt; record = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
            record.put(<span class="hljs-string">"raw"</span>, data);
            record.put(<span class="hljs-string">"timestamp"</span>, System.currentTimeMillis());
            
            <span class="hljs-comment">// 模拟字符串处理（容易产生大量临时对象）</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">text</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(data, <span class="hljs-number">0</span>, Math.min(<span class="hljs-number">100</span>, data.length));
            record.put(<span class="hljs-string">"text"</span>, text.toUpperCase().trim());
            
            <span class="hljs-keyword">return</span> record;
        }
        
        <span class="hljs-keyword">private</span> Map&lt;String, Object&gt; <span class="hljs-title function_">transformRecord</span><span class="hljs-params">(Map&lt;String, Object&gt; record)</span> {
            Map&lt;String, Object&gt; transformed = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(record);
            
            <span class="hljs-comment">// 模拟数据转换</span>
            transformed.put(<span class="hljs-string">"processed"</span>, <span class="hljs-literal">true</span>);
            transformed.put(<span class="hljs-string">"version"</span>, <span class="hljs-number">2</span>);
            
            <span class="hljs-comment">// 模拟计算</span>
            <span class="hljs-type">double</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> Math.random() * <span class="hljs-number">1000</span>;
            transformed.put(<span class="hljs-string">"calculated"</span>, value);
            
            <span class="hljs-keyword">return</span> transformed;
        }
        
        <span class="hljs-keyword">private</span> Map&lt;String, Object&gt; <span class="hljs-title function_">aggregateRecord</span><span class="hljs-params">(Map&lt;String, Object&gt; record)</span> {
            <span class="hljs-comment">// 模拟聚合，重用部分对象</span>
            Map&lt;String, Object&gt; aggregated = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
            
            <span class="hljs-comment">// 选择性复制，避免复制整个map</span>
            aggregated.put(<span class="hljs-string">"key"</span>, record.get(<span class="hljs-string">"timestamp"</span>));
            aggregated.put(<span class="hljs-string">"value"</span>, record.get(<span class="hljs-string">"calculated"</span>));
            
            <span class="hljs-keyword">return</span> aggregated;
        }
        
        <span class="hljs-comment">// 优化版本：减少对象创建</span>
        <span class="hljs-keyword">public</span> List&lt;Map&lt;String, Object&gt;&gt; <span class="hljs-title function_">processLargeDatasetOptimized</span><span class="hljs-params">(List&lt;<span class="hljs-type">byte</span>[]&gt; dataset)</span> {
            <span class="hljs-keyword">return</span> profile(() -&gt; {
                List&lt;Map&lt;String, Object&gt;&gt; results = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(dataset.size());
                
                <span class="hljs-comment">// 重用对象</span>
                Map&lt;String, Object&gt; reusableMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(<span class="hljs-number">4</span>);
                
                <span class="hljs-keyword">for</span> (<span class="hljs-type">byte</span>[] data : dataset) {
                    <span class="hljs-comment">// 清空重用map</span>
                    reusableMap.clear();
                    
                    <span class="hljs-comment">// 直接填充，避免创建中间对象</span>
                    reusableMap.put(<span class="hljs-string">"raw"</span>, data);
                    reusableMap.put(<span class="hljs-string">"timestamp"</span>, System.currentTimeMillis());
                    
                    <span class="hljs-comment">// 重用StringBuilder避免创建多个String对象</span>
                    <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">textBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-number">100</span>);
                    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; Math.min(<span class="hljs-number">100</span>, data.length); i++) {
                        textBuilder.append((<span class="hljs-type">char</span>) (data[i] &amp; <span class="hljs-number">0xFF</span>));
                    }
                    reusableMap.put(<span class="hljs-string">"text"</span>, textBuilder.toString().toUpperCase().trim());
                    textBuilder.setLength(<span class="hljs-number">0</span>); <span class="hljs-comment">// 重置StringBuilder</span>
                    
                    reusableMap.put(<span class="hljs-string">"processed"</span>, <span class="hljs-literal">true</span>);
                    reusableMap.put(<span class="hljs-string">"version"</span>, <span class="hljs-number">2</span>);
                    reusableMap.put(<span class="hljs-string">"calculated"</span>, Math.random() * <span class="hljs-number">1000</span>);
                    
                    <span class="hljs-comment">// 创建新map保存结果（需要不同的实例）</span>
                    results.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(reusableMap));
                }
                
                <span class="hljs-keyword">return</span> results;
            }, <span class="hljs-string">"processLargeDatasetOptimized"</span>);
        }
        
        <span class="hljs-keyword">private</span> &lt;T&gt; T <span class="hljs-title function_">profile</span><span class="hljs-params">(Supplier&lt;T&gt; task, String methodName)</span> {
            <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.nanoTime();
            <span class="hljs-type">long</span> <span class="hljs-variable">startMem</span> <span class="hljs-operator">=</span> Runtime.getRuntime().totalMemory() - Runtime.getRuntime().freeMemory();
            
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">return</span> task.get();
            } <span class="hljs-keyword">finally</span> {
                <span class="hljs-type">long</span> <span class="hljs-variable">duration</span> <span class="hljs-operator">=</span> System.nanoTime() - start;
                <span class="hljs-type">long</span> <span class="hljs-variable">endMem</span> <span class="hljs-operator">=</span> Runtime.getRuntime().totalMemory() - Runtime.getRuntime().freeMemory();
                <span class="hljs-type">long</span> <span class="hljs-variable">memUsed</span> <span class="hljs-operator">=</span> endMem - startMem;
                
                System.out.printf(<span class="hljs-string">"%s: 耗时=%,.2fms, 内存使用=%,.2fMB\n"</span>,
                    methodName,
                    duration / <span class="hljs-number">1_000_000.0</span>,
                    memUsed / <span class="hljs-number">1024.0</span> / <span class="hljs-number">1024</span>);
            }
        }
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BigDataOptimizationStrategy</span> {
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printOptimizationPlan</span><span class="hljs-params">()</span> {
            System.out.println(<span class="hljs-string">"=== 大数据处理系统JVM调优方案 ==="</span>);
            
            System.out.println(<span class="hljs-string">"\n1. 内存设置（大内存配置）:"</span>);
            System.out.println(<span class="hljs-string">"   -Xms16g -Xmx16g  # 大堆内存"</span>);
            System.out.println(<span class="hljs-string">"   -XX:NewSize=8g -XX:MaxNewSize=8g  # 大新生代"</span>);
            System.out.println(<span class="hljs-string">"   -XX:SurvivorRatio=6  # 更大的Eden区"</span>);
            
            System.out.println(<span class="hljs-string">"\n2. GC策略（吞吐量优先）:"</span>);
            System.out.println(<span class="hljs-string">"   -XX:+UseParallelGC  # 并行收集器"</span>);
            System.out.println(<span class="hljs-string">"   -XX:ParallelGCThreads=8  # GC线程数"</span>);
            System.out.println(<span class="hljs-string">"   -XX:+UseAdaptiveSizePolicy  # 自适应大小策略"</span>);
            System.out.println(<span class="hljs-string">"   -XX:GCTimeRatio=19  # GC时间比率 (1/(1+19)=5%)"</span>);
            
            System.out.println(<span class="hljs-string">"\n3. 字符串优化:"</span>);
            System.out.println(<span class="hljs-string">"   -XX:+UseStringDeduplication  # 字符串去重"</span>);
            System.out.println(<span class="hljs-string">"   -XX:+OptimizeStringConcat  # 字符串连接优化"</span>);
            
            System.out.println(<span class="hljs-string">"\n4. 编译优化:"</span>);
            System.out.println(<span class="hljs-string">"   -XX:+UseLargePages  # 大内存页"</span>);
            System.out.println(<span class="hljs-string">"   -XX:+AggressiveOpts  # 激进优化"</span>);
            System.out.println(<span class="hljs-string">"   -XX:+UseCompressedOops  # 压缩指针"</span>);
            
            System.out.println(<span class="hljs-string">"\n5. 代码级优化:"</span>);
            System.out.println(<span class="hljs-string">"   a. 使用原始类型集合（fastutil, koloboke）"</span>);
            System.out.println(<span class="hljs-string">"   b. 对象池技术"</span>);
            System.out.println(<span class="hljs-string">"   c. 堆外内存处理大数组"</span>);
            System.out.println(<span class="hljs-string">"   d. 流式处理减少内存占用"</span>);
        }
        
        <span class="hljs-comment">// 使用堆外内存处理大数组</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">demonstrateOffHeapMemory</span><span class="hljs-params">()</span> {
            System.out.println(<span class="hljs-string">"\n=== 堆外内存示例 ==="</span>);
            
            <span class="hljs-type">int</span> <span class="hljs-variable">bufferSize</span> <span class="hljs-operator">=</span> <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">100</span>; <span class="hljs-comment">// 100MB</span>
            <span class="hljs-type">ByteBuffer</span> <span class="hljs-variable">offHeapBuffer</span> <span class="hljs-operator">=</span> ByteBuffer.allocateDirect(bufferSize);
            
            System.out.println(<span class="hljs-string">"分配了 "</span> + (bufferSize / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span>) + <span class="hljs-string">"MB 堆外内存"</span>);
            
            <span class="hljs-comment">// 写入数据</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {
                offHeapBuffer.putInt(i);
            }
            
            <span class="hljs-comment">// 读取数据</span>
            offHeapBuffer.flip();
            <span class="hljs-keyword">while</span> (offHeapBuffer.hasRemaining()) {
                <span class="hljs-type">int</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> offHeapBuffer.getInt();
                <span class="hljs-comment">// 处理数据...</span>
            }
            
            System.out.println(<span class="hljs-string">"堆外内存使用完成，不占用堆空间"</span>);
            
            <span class="hljs-comment">// 注意：堆外内存需要手动管理</span>
            <span class="hljs-comment">// 实际中应该使用try-with-resources或显式清理</span>
        }
        
        <span class="hljs-comment">// 使用原始类型集合</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">demonstratePrimitiveCollections</span><span class="hljs-params">()</span> {
            System.out.println(<span class="hljs-string">"\n=== 原始类型集合示例 ==="</span>);
            
            <span class="hljs-comment">// 使用第三方库如fastutil（这里用标准API演示思路）</span>
            List&lt;Integer&gt; standardList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
            <span class="hljs-type">IntBuffer</span> <span class="hljs-variable">primitiveBuffer</span> <span class="hljs-operator">=</span> IntBuffer.allocate(<span class="hljs-number">1000000</span>);
            
            <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.nanoTime();
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000000</span>; i++) {
                standardList.add(i); <span class="hljs-comment">// 自动装箱，创建Integer对象</span>
            }
            <span class="hljs-type">long</span> <span class="hljs-variable">standardTime</span> <span class="hljs-operator">=</span> System.nanoTime() - start;
            
            start = System.nanoTime();
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000000</span>; i++) {
                primitiveBuffer.put(i); <span class="hljs-comment">// 直接存储int</span>
            }
            <span class="hljs-type">long</span> <span class="hljs-variable">primitiveTime</span> <span class="hljs-operator">=</span> System.nanoTime() - start;
            
            System.out.printf(<span class="hljs-string">"标准ArrayList: %,.2fms\n"</span>, standardTime / <span class="hljs-number">1_000_000.0</span>);
            System.out.printf(<span class="hljs-string">"原始类型Buffer: %,.2fms\n"</span>, primitiveTime / <span class="hljs-number">1_000_000.0</span>);
            System.out.println(<span class="hljs-string">"原始类型集合减少了对象创建和内存占用"</span>);
        }
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"=== 大数据处理系统调优实战 ==="</span>);
        
        <span class="hljs-comment">// 显示调优方案</span>
        BigDataOptimizationStrategy.printOptimizationPlan();
        BigDataOptimizationStrategy.demonstrateOffHeapMemory();
        BigDataOptimizationStrategy.demonstratePrimitiveCollections();
        
        <span class="hljs-comment">// 创建测试数据</span>
        List&lt;<span class="hljs-type">byte</span>[]&gt; testDataset = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000</span>; i++) {
            testDataset.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>]); <span class="hljs-comment">// 每个记录1KB</span>
        }
        
        <span class="hljs-comment">// 创建处理器</span>
        <span class="hljs-type">DataProcessor</span> <span class="hljs-variable">processor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataProcessor</span>();
        
        System.out.println(<span class="hljs-string">"\n=== 性能对比测试 ==="</span>);
        
        <span class="hljs-comment">// 测试普通版本</span>
        System.out.println(<span class="hljs-string">"\n1. 普通版本:"</span>);
        List&lt;Map&lt;String, Object&gt;&gt; result1 = processor.processLargeDataset(testDataset);
        System.gc();
        
        <span class="hljs-comment">// 测试优化版本</span>
        System.out.println(<span class="hljs-string">"\n2. 优化版本:"</span>);
        List&lt;Map&lt;String, Object&gt;&gt; result2 = processor.processLargeDatasetOptimized(testDataset);
        System.gc();
        
        System.out.println(<span class="hljs-string">"\n处理完成，结果数量: "</span> + result1.size());
        
        <span class="hljs-comment">// 显示内存状态</span>
        <span class="hljs-type">Runtime</span> <span class="hljs-variable">runtime</span> <span class="hljs-operator">=</span> Runtime.getRuntime();
        System.out.printf(<span class="hljs-string">"\n内存状态:\n"</span>);
        System.out.printf(<span class="hljs-string">"  最大内存: %,.2fMB\n"</span>, runtime.maxMemory() / <span class="hljs-number">1024.0</span> / <span class="hljs-number">1024</span>);
        System.out.printf(<span class="hljs-string">"  总内存: %,.2fMB\n"</span>, runtime.totalMemory() / <span class="hljs-number">1024.0</span> / <span class="hljs-number">1024</span>);
        System.out.printf(<span class="hljs-string">"  空闲内存: %,.2fMB\n"</span>, runtime.freeMemory() / <span class="hljs-number">1024.0</span> / <span class="hljs-number">1024</span>);
        System.out.printf(<span class="hljs-string">"  已用内存: %,.2fMB\n"</span>, 
            (runtime.totalMemory() - runtime.freeMemory()) / <span class="hljs-number">1024.0</span> / <span class="hljs-number">1024</span>);
    }
}
</code></pre>
<h2 data-id="heading-13">总结：JVM调优最佳实践</h2>
<h3 data-id="heading-14">调优原则</h3>
<ol>
<li><strong>测量先行</strong>：不要猜测，使用监控工具收集数据</li>
<li><strong>逐步调整</strong>：每次只调整一个参数，观察效果</li>
<li><strong>关注业务</strong>：调优的目标是改善业务指标，不是追求极致参数</li>
<li><strong>理解原理</strong>：理解GC算法和内存管理原理</li>
</ol>
<h3 data-id="heading-15">常见问题与解决方案</h3>



































<table><thead><tr><th>问题</th><th>症状</th><th>解决方案</th></tr></thead><tbody><tr><td>Full GC频繁</td><td>应用停顿频繁，响应时间波动</td><td>增加堆大小，优化对象生命周期</td></tr><tr><td>内存泄漏</td><td>内存使用持续增长，最终OOM</td><td>使用堆转储分析，修复资源未释放</td></tr><tr><td>高延迟</td><td>应用响应慢，GC停顿长</td><td>使用低延迟GC（ZGC/Shenandoah）</td></tr><tr><td>低吞吐量</td><td>CPU使用率高但处理量低</td><td>优化代码，调整GC并行度</td></tr><tr><td>元空间溢出</td><td>类加载失败，Metaspace满</td><td>增加MaxMetaspaceSize，检查类加载器泄漏</td></tr></tbody></table>
<h3 data-id="heading-16">调优检查清单</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JVMTuningChecklist</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printChecklist</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"=== JVM调优检查清单 ==="</span>);
        
        System.out.println(<span class="hljs-string">"\n1. 内存设置检查:"</span>);
        System.out.println(<span class="hljs-string">"   ☐ -Xms和-Xmx设置相同值，避免堆震荡"</span>);
        System.out.println(<span class="hljs-string">"   ☐ 堆大小设置为物理内存的50-75%"</span>);
        System.println(<span class="hljs-string">"   ☐ 年轻代大小合适（通常是堆的1/3到1/2）"</span>);
        System.out.println(<span class="hljs-string">"   ☐ 设置了合理的Metaspace大小"</span>);
        
        System.out.println(<span class="hljs-string">"\n2. GC配置检查:"</span>);
        System.out.println(<span class="hljs-string">"   ☐ 选择了合适的GC收集器"</span>);
        System.out.println(<span class="hljs-string">"   ☐ 设置了合理的GC线程数"</span>);
        System.out.println(<span class="hljs-string">"   ☐ 配置了GC日志记录"</span>);
        System.out.println(<span class="hljs-string">"   ☐ 考虑了停顿时间目标"</span>);
        
        System.out.println(<span class="hljs-string">"\n3. 监控配置检查:"</span>);
        System.out.println(<span class="hljs-string">"   ☐ 启用了JMX监控"</span>);
        System.out.println(<span class="hljs-string">"   ☐ 配置了GC日志轮转"</span>);
        System.out.println(<span class="hljs-string">"   ☐ 设置了堆转储参数"</span>);
        System.out.println(<span class="hljs-string">"   ☐ 配置了性能指标收集"</span>);
        
        System.out.println(<span class="hljs-string">"\n4. 代码优化检查:"</span>);
        System.out.println(<span class="hljs-string">"   ☐ 避免大对象直接进入老年代"</span>);
        System.out.println(<span class="hljs-string">"   ☐ 合理使用缓存（大小限制、过期策略）"</span>);
        System.out.println(<span class="hljs-string">"   ☐ 及时关闭资源（连接、流）"</span>);
        System.out.println(<span class="hljs-string">"   ☐ 使用合适的数据结构"</span>);
        
        System.out.println(<span class="hljs-string">"\n5. 部署环境检查:"</span>);
        System.out.println(<span class="hljs-string">"   ☐ 容器内存限制设置正确"</span>);
        System.out.println(<span class="hljs-string">"   ☐ 系统交换空间足够"</span>);
        System.out.println(<span class="hljs-string">"   ☐ 文件描述符限制合适"</span>);
        System.out.println(<span class="hljs-string">"   ☐ 网络配置优化"</span>);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printCommonParameters</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"\n=== 常用JVM参数 ==="</span>);
        
        System.out.println(<span class="hljs-string">"\n内存相关:"</span>);
        System.out.println(<span class="hljs-string">"  -Xms4g -Xmx4g                    # 堆内存"</span>);
        System.out.println(<span class="hljs-string">"  -XX:MetaspaceSize=256m          # 元空间初始大小"</span>);
        System.out.println(<span class="hljs-string">"  -XX:MaxMetaspaceSize=512m       # 元空间最大大小"</span>);
        System.out.println(<span class="hljs-string">"  -XX:NewRatio=2                  # 新生代:老年代比例"</span>);
        System.out.println(<span class="hljs-string">"  -XX:SurvivorRatio=8             # Eden:Survivor比例"</span>);
        
        System.out.println(<span class="hljs-string">"\nGC相关:"</span>);
        System.out.println(<span class="hljs-string">"  -XX:+UseG1GC                    # 使用G1收集器"</span>);
        System.out.println(<span class="hljs-string">"  -XX:MaxGCPauseMillis=200        # 目标停顿时间"</span>);
        System.out.println(<span class="hljs-string">"  -XX:+UseParallelGC              # 使用并行收集器"</span>);
        System.out.println(<span class="hljs-string">"  -XX:ParallelGCThreads=8         # GC线程数"</span>);
        System.out.println(<span class="hljs-string">"  -XX:+UseZGC                     # 使用ZGC收集器"</span>);
        
        System.out.println(<span class="hljs-string">"\n监控调试:"</span>);
        System.out.println(<span class="hljs-string">"  -XX:+PrintGCDetails             # 打印GC详情"</span>);
        System.out.println(<span class="hljs-string">"  -XX:+PrintGCDateStamps          # 打印GC时间戳"</span>);
        System.out.println(<span class="hljs-string">"  -Xloggc:/path/to/gc.log         # GC日志路径"</span>);
        System.out.println(<span class="hljs-string">"  -XX:+HeapDumpOnOutOfMemoryError # OOM时堆转储"</span>);
        System.out.println(<span class="hljs-string">"  -XX:HeapDumpPath=/path/to/dump  # 堆转储路径"</span>);
        
        System.out.println(<span class="hljs-string">"\n性能优化:"</span>);
        System.out.println(<span class="hljs-string">"  -XX:+UseStringDeduplication     # 字符串去重"</span>);
        System.out.println(<span class="hljs-string">"  -XX:+OptimizeStringConcat       # 字符串连接优化"</span>);
        System.out.println(<span class="hljs-string">"  -XX:+UseCompressedOops          # 压缩指针"</span>);
        System.out.println(<span class="hljs-string">"  -XX:+UseLargePages              # 使用大内存页"</span>);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        printChecklist();
        printCommonParameters();
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[挖到 5 个很哇塞的 AI 开源项目，快来瞧瞧。]]></title>    <link>https://juejin.cn/post/7582535649275920425</link>    <guid>https://juejin.cn/post/7582535649275920425</guid>    <pubDate>2025-12-12T06:09:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582535649275920425" data-draft-id="7582535649275904041" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="挖到 5 个很哇塞的 AI 开源项目，快来瞧瞧。"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2025-12-12T06:09:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="逛逛GitHub"/> <meta itemprop="url" content="https://juejin.cn/user/1442202996186093"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            挖到 5 个很哇塞的 AI 开源项目，快来瞧瞧。
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1442202996186093/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    逛逛GitHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T06:09:54.000Z" title="Fri Dec 12 2025 06:09:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">01、Nano Banana PPT</h2>
<p><strong>Banana-slides</strong> 是基于 Nano Banana Pro 模型开源的 AI PPT 生成应用，解决传统 AI PPT 工具模板僵化、设计感差和素材质量低的问题。</p>
<p><strong>一句话生成 PPT</strong>：从一个简单的想法快速得到大纲、页面描述和最终的 PPT 文稿</p>
<p>还可以上传参考风格图片、示例 PPT 模板图片 等作为风格和内容参考。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/578815609e9843c2879d4a09acbe4538~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124593&amp;x-signature=0qNeNzl5uZQlj5To7Z2tCvZZTGk%3D" alt="图片" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62bbccfd845b4124949d562b0a408c32~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124593&amp;x-signature=ZijNvIYyc7W%2BRCJbdb%2B9hTsu8IM%3D" alt="图片" loading="lazy"/></p>
<p>支持口头修改功能，说句话就能对生成的单页或局部区域进行精准调整，大幅降低了 PPT 的排版和修改门槛。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e45717623324fe797febf8e07da1043~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124593&amp;x-signature=MAT%2FusjT%2FmihNuwAGZWALKDydWo%3D" alt="图片" loading="lazy"/></p>
<p>而且能以 PPTX 或 PDF 格式一键导出。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/13bd7472b02f47b1850c88af0c727bd5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124593&amp;x-signature=N%2Bw5VDplxGk9fhoCvoGyEjZVDOw%3D" alt="图片" loading="lazy"/></p>
<p>在技术实现上，Banana-slides 采用了 React 18 前端与 Python Flask 后端的现代化架构，集成了 Google Gemini API 提供 AI 能力。</p>
<p>提供了 Docker Compose 一键部署方案。</p>
<pre><code class="hljs language-bash" lang="bash">开源地址：https://github.com/Anionex/banana-slides
</code></pre>
<h2 data-id="heading-1">02、复制 AI 内容到 Word 完美排版</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0009e283800490085ef3e037f581ddd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124593&amp;x-signature=eDCJ0l%2BqVUDiRz0pWL2inXk1%2FDw%3D" alt="图片" loading="lazy"/></p>
<p>这个开源项目解决 Markdown 文本及 AI 生成内容无法完美粘贴至 Office 软件的痛点而设计。</p>
<p>该工具基于 Pandoc 文档转换引擎，能够将剪贴板中的 Markdown 内容实时转换为原生的 Word 格式。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/841675c81cfe4b3c96259b2f088b54c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124593&amp;x-signature=sR%2BYCk0CaLz16x7%2BrcsVVIN0kxA%3D" alt="图片" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b016391ed8748449069705d5fba23c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124593&amp;x-signature=KOBg3P8WDKO05EurPoyOxxt3vTY%3D" alt="图片" loading="lazy"/></p>
<p>支持通过全局热键一键将格式化好的标题、列表、代码块等内容插入到当前激活的 Word 或 WPS 文档中，极大提升了文档整理效率。</p>
<p>除了基础的文本转换，PasteMD 还具备<strong>智能表格识别</strong>与<strong>网页富文本支持</strong>功能。</p>
<p>它能自动识别剪贴板中的 Markdown 表格并将其结构化地粘贴到 Excel 单元格中，避免了传统复制导致的数据挤在同一单元格的问题。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7456ee1040f94d1b8c3060b75b316505~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124593&amp;x-signature=sgaskpJeklfv5dzHKVVR%2B6rzLO4%3D" alt="图片" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70146e55fd9a4bed8f532f939e3d6028~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124593&amp;x-signature=uc1H8awhuyTjmDIGdqZDaTdvdLo%3D" alt="图片" loading="lazy"/></p>
<p>同时，它也能处理从 ChatGPT、DeepSeek 等网页复制的 HTML 富文本，确保 AI 回复的格式在办公软件中得到高保真还原。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/173ef467c233498c820365ac46c2401e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124593&amp;x-signature=1aQ%2BlQ3Fo5Z3uE93pOy4LF27Vro%3D" alt="图片" loading="lazy"/></p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/RICHQAQ/PasteMD</span>
</code></pre>
<h2 data-id="heading-2">03、金融强化学习框架</h2>
<p>FinRL 是由 AI4Finance-Foundation 开发的全球首个开源金融强化学习框架。</p>
<p>目前已经在 GitHub 上斩获 13.3 K 的 Star 了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4a640f7389d4228bbcd4f31f37ededb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124593&amp;x-signature=VGCO1K%2FDsAYovuPjQ%2Fj6bfVLfg8%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p>这个开源项目想降低金融强化学习（DRL）的入门门槛，为研究人员和交易者提供一个统一、可复现的开发平台。</p>
<p>解决传统量化金融中数据处理繁琐、环境构建复杂以及模型难以复现的痛点。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b45636dd854a4b4bacd7fe48e4ace461~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124593&amp;x-signature=23Mq5wCuQtvOIE0G1XNsLk4u1UU%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p>该框架采用清晰的三层架构设计：</p>
<p>底层为市场环境层，通过 FinRL-Meta 连接 Yahoo Finance、Binance、Akshare 等数十种全球主流数据源。</p>
<p>中间层为智能体层，集成了 Stable Baselines 3、RLlib 等成熟的 DRL 算法库。</p>
<p>顶层为应用层，覆盖股票交易、加密货币、投资组合管理及高频交易等多种金融任务，并提供标准的训练-测试-交易全流程流水线。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e9d0a6f8d1142f684c18f370bd0f32b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124593&amp;x-signature=0M8%2FELyh3mmQ05gAyxw12Q822vs%3D" alt="图片" loading="lazy"/></p>
<p>它不仅被多篇 NeurIPS 和 ICAIF 等顶级学术会议论文引用作为基准框架，还被广泛应用于教学和工业界的策略原型开发，是目前金融科技领域将深度强化学习应用于自动化交易的首选开源工具之一。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f279d34fc98b4086ac54b348557eb421~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124593&amp;x-signature=OBXBtOsWer4fD3y%2F1hP3qP2eHdU%3D" alt="图片" loading="lazy"/></p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/AI4Finance-Foundation/FinRL</span>
</code></pre>
<h2 data-id="heading-3">04、谷歌开源手写转换技术</h2>
<p>Google Research 开源的一个创新技术。</p>
<p>拍张你手写的笔记，AI 就能把你的纸上字迹变成原本只能在 iPad 上写出的矢量数字墨水，甚至还能像编辑 Word 一样修改它。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70767cdf39b643faa9845acd6e2f9788~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124593&amp;x-signature=qjtnGz%2Bt2Rd4GXfRy3A1diRQGNU%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p>不同于传统的 OCR 仅仅将图片转换为标准文本，InkSight 采用了一种被称为 Derendering（去渲染）的技术，能够将普通的手写照片转换为<strong>可编辑、可搜索的矢量数字墨水</strong>（Digital Ink）。</p>
<p>你不仅能保留原始的笔迹风格，还能像操作电子笔记一样对纸质笔记的内容进行移动、擦除或修改。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24ab824aeadd4e8ba36305fe1caf6585~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124593&amp;x-signature=V4VTZ%2Fo1CAZmHFsnzB3dW%2BHzxtI%3D" alt="图片" loading="lazy"/></p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/google-research/inksight</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入剖析 Java 中的 ZGC 机制：原理、优势与实践]]></title>    <link>https://juejin.cn/post/7582529173829058594</link>    <guid>https://juejin.cn/post/7582529173829058594</guid>    <pubDate>2025-12-12T06:07:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582529173829058594" data-draft-id="7582533464244846626" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入剖析 Java 中的 ZGC 机制：原理、优势与实践"/> <meta itemprop="keywords" content="后端,Java,算法"/> <meta itemprop="datePublished" content="2025-12-12T06:07:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员西西"/> <meta itemprop="url" content="https://juejin.cn/user/326976944214804"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入剖析 Java 中的 ZGC 机制：原理、优势与实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/326976944214804/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员西西
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T06:07:57.000Z" title="Fri Dec 12 2025 06:07:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在 Java 开发的世界里，垃圾回收（Garbage Collection，GC）一直是开发者们极为关注的话题。随着应用规模的不断扩大以及对性能要求的日益严苛，传统的垃圾回收器逐渐难以满足需求。而 ZGC（Z Garbage Collector）的出现，宛如一颗璀璨的新星，为 Java 开发者们带来了全新的解决方案。本文将深入探讨 ZGC 机制，从其诞生背景、核心技术、工作流程，到性能优势以及实际应用中的优化，全方位地为大家揭开 ZGC 的神秘面纱。</p>
<h2 data-id="heading-1">ZGC 诞生的背景</h2>
<p>在 ZGC 出现之前，Java 已经拥有了多种垃圾回收器，如 Serial、Parallel、CMS、G1 等。这些垃圾回收器在不同的场景下都发挥了重要作用，但随着应用程序处理的数据量不断增大，以及对响应时间要求的不断提高，它们逐渐暴露出一些局限性。</p>
<p>例如，在处理大规模数据和高负载的情况下，传统垃圾回收器可能会出现较长的停顿时间，这对于一些对延迟极为敏感的应用，如金融服务、在线游戏等，是无法接受的。以金融交易系统为例，哪怕是短暂的停顿，都可能导致巨额的交易损失。此外，随着堆内存的不断增大，传统垃圾回收器的性能会显著下降，难以满足现代应用对大堆内存管理的需求。</p>
<p>正是在这样的背景下，Oracle 公司研发了 ZGC，其目标是实现一种可扩展的低延迟垃圾收集器，能够在处理从几百 MB 到数 TB 的堆大小的同时，将停顿时间控制在 10ms 以内，并且尽可能减少对吞吐量的影响。</p>
<h2 data-id="heading-2">ZGC 的核心技术</h2>
<p><strong>（一）染色指针（Colored Pointers）技术</strong></p>
<p>染色指针是 ZGC 的核心技术之一，它重新定义了 64 位指针的语义结构。在传统的指针中，所有的比特位都用于表示内存地址。而在 ZGC 中，利用了 64 位指针中的高位比特来存储对象的状态信息。具体来说，ZGC 使用了四个关键标志位实现多重语义：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa7940aed65c4ffc9314cf070f83ccca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6KW_6KW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124477&amp;x-signature=2oCwiw54h54mIcYNteQ6f3CyxtU%3D" alt="" loading="lazy"/></p>
<ol>
<li><strong>Marked0/Marked1</strong>：这两个位是交替使用的标记位，用于实现三色标记的状态记录。在垃圾回收的标记阶段，通过这两个位来标识对象是否被标记为存活。</li>
<li><strong>Remapped</strong>：该位用于标识对象是否完成重定位。在对象移动到新的内存位置时，通过设置这个位来确保应用程序能够正确访问到移动后的对象。</li>
<li><strong>Finalizable</strong>：此位用于标记需要通过 finalizer 处理的对象。</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c863a5e0b2de4d3e981b3dbc89272e0f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6KW_6KW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124477&amp;x-signature=0NiON4MNJI12GDFtlrtU%2BaimDQM%3D" alt="" loading="lazy"/></p>
<p>染色指针技术带来了诸多优势。首先，它实现了零额外内存开销。传统收集器通常需要额外 5 - 10% 的堆内存来存储标记位图，而 ZGC 直接利用指针高位存储标记信息，无需额外的内存空间。其次，染色指针使得 GC 线程无需访问对象头即可获取标记状态，大大减少了缓存行污染，提高了缓存命中率。此外，由于指针本身携带重定位状态，避免了像 G1 那样在跨 Region 引用更新时可能出现的问题，保证了对象移动的原子性。</p>
<p><strong>（二）读屏障（Load Barriers）的精细化应用</strong></p>
<p>读屏障是 ZGC 中另一个关键技术。它是 JVM 向应用代码插入的一小段代码。当应用线程从堆中读取对象引用时，就会执行这段代码。读屏障在 ZGC 中的主要作用是在对象移动过程中保证所有引用都指向正确的位置。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c971cc2539545c8925a50f18bb462b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6KW_6KW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124477&amp;x-signature=h6x74LMaF%2FpyPduagkNE0tYPG6c%3D" alt="" loading="lazy"/></p>
<p>在 ZGC 的并发转移阶段，对象可能会被移动到新的内存位置。如果没有读屏障，应用线程在访问对象时，可能会访问到旧的内存地址，从而导致错误。通过读屏障，当应用线程访问一个可能已经被移动的对象时，读屏障会自动完成指针更新，将应用线程的访问导向到对象的新地址。这样，即使在对象移动的过程中，应用线程也能够正确地访问对象，避免了长时间的 Stop - The - World（STW）事件。</p>
<p><strong>（三）动态内存布局（Multi - Mapping Memory）</strong></p>
<p>ZGC 采用了动态内存布局技术，通过虚拟内存映射技术，使得物理内存中的对象可以同时拥有多个虚拟地址。在 x86 - 64 平台上，ZGC 通过 Linux 的 mmap 系统调用实现多重内存映射，将同一物理内存映射到三个虚拟地址空间（对应不同标志位组合）。</p>
<p>这种设计使得处理器能正确解析染色指针，并且为并发压缩提供了硬件级支持。在垃圾回收过程中，当需要对对象进行移动和内存压缩时，通过修改虚拟地址映射关系，就可以快速实现对象的重定位，而无需实际移动大量的数据。同时，动态内存布局还带来了即时视图切换的优势，在 GC 阶段转换时，仅需修改指针标志位，无需数据搬迁，大大提高了垃圾回收的效率。</p>
<h2 data-id="heading-3">ZGC 的工作流程</h2>
<p>ZGC 的工作流程主要分为以下几个阶段：</p>
<p><strong>（一）标记阶段</strong></p>
<ol>
<li><strong>初始标记（Initial Mark）</strong> ：这个阶段需要暂停应用线程（STW），初始标记只需要扫描所有 GC Roots，其处理时间和 GC Roots 的数量成正比。由于只扫描 GC Roots，所以停顿时间不会随着堆的大小或者活跃对象的大小而增加。在这个阶段，ZGC 标记出所有 GC Roots 直接引用的活跃对象（根对象）。</li>
<li><strong>并发标记（Concurrent Mark）</strong> ：此阶段不需要暂停应用线程（没有 STW），ZGC 的回收线程会扫描剩余的所有对象。这个处理时间相对较长，所以采用并发方式，让业务线程与 GC 线程同时运行。在并发标记阶段，ZGC 使用三色标记算法的变种，通过读屏障技术捕获对象引用变化，从而标记出所有存活的对象。然而，并发标记阶段会产生漏标问题。</li>
<li><strong>再标记（Remark）</strong> ：这个阶段需要再次暂停应用线程（STW），主要处理并发标记阶段产生的漏标对象。ZGC 通过 SATB（Snapshot - At - The - Beginning）算法来解决漏标问题，该算法与 G1 中解决漏标的方案类似。</li>
</ol>
<p><strong>（二）重定位阶段</strong></p>
<ol>
<li><strong>并发预备重分配（Concurrent Prepare for Relocate）</strong> ：在这个阶段，ZGC 会动态计算回收效益最高的 Region 集合（称为 Relocation Set）。它采用类似 G1 的衰减平均值算法来预测 Region 存活率，并预计算对象移动路径，为后续的重分配建立内存拓扑图。</li>
<li><strong>初始转移（Initial Relocate）</strong> ：在初始转移阶段，ZGC 会选择部分 Region，将这些 Region 中初始标记的存活对象进行转移，同时进行对象重定位。这个阶段需要短暂的 STW，以确保对象转移的一致性。</li>
<li><strong>并发转移（Concurrent Relocate）</strong> ：在并发转移阶段，ZGC 会对并发标记阶段确定的存活对象进行大规模转移。ZGC 的核心创新点 “自愈” 指针机制在此阶段发挥重要作用。当用户线程访问被移动对象时，读屏障会自动完成指针更新，使得对象移动延迟从传统的毫秒级降至微秒级。</li>
</ol>
<p><strong>（三）重映射阶段</strong></p>
<p>并发引用处理（Concurrent Reference Processing）：在重映射阶段，ZGC 采用无锁队列处理软 / 弱 / 虚引用，通过哈希分散技术将引用对象均匀分布到多个处理线程，避免了像 G1 中常见的引用处理瓶颈，确保所有指向已移动对象的引用都被正确更新。</p>
<h2 data-id="heading-4">ZGC 的性能优势</h2>
<p><strong>（一）低延迟特性</strong></p>
<p>ZGC 最显著的优势之一就是其卓越的低延迟特性。通过将传统的 Stop - the - World 停顿时间压缩到极低范围，ZGC 使得大规模应用在垃圾回收期间的响应时间几乎不可察觉。官方数据显示，ZGC 的设计目标是将 GC 停顿时间严格控制在 10 毫秒以内，在实际应用中，特别是在 JDK 16 及更高版本中，停顿时间常常能够稳定在亚毫秒级。例如，在 256GB 堆内存环境下的实测数据表明，ZGC 的 STW 阶段最大停顿仅为 1.3 毫秒，平均停顿时间更是短至可以忽略不计。这种低延迟特性对于那些对响应时间要求极高的应用，如金融交易系统、实时游戏等，具有无可比拟的价值。在金融交易中，每毫秒的延迟都可能影响交易的成败，ZGC 的低延迟确保了交易系统能够快速响应，避免因垃圾回收停顿而导致的交易损失。</p>
<p><strong>（二）高吞吐量</strong></p>
<p>尽管 ZGC 以低延迟为首要目标，但它在吞吐量方面也表现出色。与其他垃圾回收器相比，ZGC 在处理大堆内存时，吞吐量下降幅度极小。这得益于其并发处理机制，大部分回收工作都可以与应用线程并行执行，减少了垃圾回收对应用程序运行时间的占用。例如，在处理大规模数据的实时分析系统中，ZGC 能够在保证低延迟的同时，高效地进行垃圾回收，确保系统能够持续稳定地处理大量数据，不会因为垃圾回收而导致吞吐量大幅下降。</p>
<p><strong>（三）大堆支持能力</strong></p>
<p>ZGC 能够轻松应对从几百 MB 到数 TB 的超大堆内存，这是许多传统垃圾回收器难以企及的。从 JDK 11 最初支持 8MB - 4TB 级别的堆，到 JDK 15 后已经可以支持 16TB 的超大堆内存。在处理 TB 级实时 AI 数据处理、大规模的内存数据库等场景时，ZGC 的大堆支持能力使其游刃有余，不会因为内存规模的庞大而出现性能瓶颈。无论是大规模的深度学习模型训练，需要频繁创建和销毁大量的张量对象，还是海量数据的实时分析，需要处理不断涌入的大规模数据集，ZGC 都能提供稳定而高效的内存管理支持。</p>
<p><strong>（四）内存碎片处理</strong></p>
<p>ZGC 采用基于 Region 的内存管理策略，并且在回收过程中会对内存进行整理和压缩，有效减少了内存碎片的产生。与一些传统垃圾回收器相比，ZGC 的内存碎片率显著降低。例如，与 G1 的固定大小 Region 设计相比，ZGC 的动态 Region 大小设计（Region 大小动态可调，有 2MB、4MB、8MB、16MB、32MB 等）使得内存碎片率降低 40% 以上。这种低内存碎片率保证了内存空间的高效利用，避免了因内存碎片过多而导致的内存分配失败或性能下降问题。</p>
<h2 data-id="heading-5">ZGC 在实际应用中的优化与案例分析</h2>
<p>（一）ZGC 的参数优化</p>
<p>虽然 ZGC 在大多数情况下能够自动进行优化，但在一些特定场景下，合理调整参数可以进一步提升其性能。</p>
<ol>
<li><strong>堆大小设置</strong>：通过 - Xmx 参数设置堆的最大大小。当分配速率过高，超过回收速率，造成堆内存不够时，会触发 Allocation Stall，这类 Stall 会减缓当前的用户线程。因此，当在 GC 日志中看到 Allocation Stall 时，通常可以考虑适当增大堆空间。</li>
<li><strong>GC 触发时机调整</strong>：</li>
</ol>
<ul>
<li><strong>ZAllocationSpikeTolerance</strong>：该参数控制 GC 触发的阈值大小，默认值为 2。数值越大，越早触发 GC。可以根据应用程序的对象分配速率和内存使用情况来调整这个参数。</li>
<li><strong>ZCollectionInterval</strong>：用于控制基于固定时间间隔的 GC 触发。适合应对突增流量场景，比如定时活动、秒杀等场景。在流量平稳变化时，自适应算法可能在堆使用率达到 95% 以上才触发 GC，而流量突增时，自适应算法触发的时机可能过晚，导致部分线程阻塞，此时可以通过调整此参数来解决问题。</li>
</ul>
<ol start="3">
<li><strong>并发线程数设置</strong>：在一些混合负载的场景下，例如又跑批处理又跑实时交易的系统中，可以通过 - XX:ConcGCThreads 参数固定并发标记的线程数，以避免批处理任务总被 GC 线程打断，从而稳定系统延迟。</li>
</ol>
<p><strong>（二）实际案例分析</strong></p>
<p><strong>美团技术团队</strong>：美团技术团队将其核心服务升级至 JDK 17 + ZGC 组合后，取得了显著的成效。GC 停顿时间降低了 90%，整体服务稳定性也有了显著提升。在美团这样的大规模在线服务平台上，每天需要处理海量的订单数据和用户请求，对系统的响应时间和稳定性要求极高。ZGC 的低延迟特性使得用户在下单、查询订单等操作时，几乎感受不到垃圾回收的影响，大大提升了用户体验。同时，服务稳定性的提升也减少了因系统故障导致的业务损失。</p>
<p><strong>某互联网公司的实时推荐系统</strong>：该公司在开发一款基于 AI 的实时推荐系统时，使用传统垃圾回收器时，系统经常出现卡顿和延迟，严重影响了推荐的准确性和实时性。引入 ZGC 之后，系统性能得到了显著提升。垃圾回收的停顿时间大幅减少，数据处理的效率提高了数倍。这使得推荐系统能够更快速地根据用户的实时行为和海量数据进行分析和推荐，推荐的准确性和实时性得到了极大的改善，为公司带来了可观的商业价值，如用户点击率提升、用户粘性增强等。</p>
<p><strong>某科研机构的基因数据分析</strong>：某科研机构在进行大规模的基因数据分析时，需要处理 TB 级别的基因数据。由于数据量巨大，传统垃圾回收器无法满足其对内存管理的要求。采用 ZGC 后，成功解决了内存管理的难题，实现了基因数据的快速处理和分析。在基因数据分析中，需要频繁地创建和销毁大量的数据对象，对垃圾回收的效率和低延迟要求极高。ZGC 的大堆支持能力和低延迟特性，使得科研人员能够高效地完成数据分析工作，为科研工作的顺利开展提供了有力支持。</p>
<h2 data-id="heading-6">ZGC 的局限性</h2>
<p><strong>（一）JVM 版本依赖</strong></p>
<p>ZGC 从 Java 11 开始引入，但在早期版本中存在一些问题，例如在 OpenJDK 11 及以下版本中，ZGC 占用内存较多，且不能实现 Class Unloading 等。直到 JDK 17，ZGC 才成为正式生产可用特性。生产级特性较为成熟的版本始于 JDK 15，而分代 ZGC（性能更优）则需要 JDK 21 及以上版本。这就要求开发者在使用 ZGC 时，需要确保应用程序运行在支持且稳定的 JVM 版本上。</p>
<p><strong>（二）平台限制</strong></p>
<p>ZGC 主要在 Linux 和 macOS 上得到优化，在 Windows 平台上的支持相对较少。例如，在 Windows 上，ZGC 的最大堆大小可能会受到限制，并且在一些功能特性上可能无法达到在 Linux 和 macOS 上的表现。这使得在 Windows 环境下运行的 Java 应用程序，在考虑使用 ZGC 时需要谨慎评估。</p>
<p><strong>（三）资源需求</strong></p>
<p>由于 ZGC 的并发特性，它在运行过程中需要较多的 CPU 和内存带宽资源。在并发阶段，ZGC 会占用较多的计算资源，因此建议在使用 ZGC 时，服务器的 CPU 核心数最好≥16 核。此外，在大堆并发转移时，可能会受限于内存复制速度，需要较高的内存带宽支持。如果服务器的资源不足，可能会导致 ZGC 的性能无法充分发挥，甚至影响应用程序的正常运行。</p>
<h2 data-id="heading-7">总结</h2>
<p>ZGC 作为 Java 垃圾回收领域的一项重大创新，以其低延迟、高吞吐量、大堆支持以及高效的内存管理等特性，为现代 Java 应用程序的开发带来了前所未有的性能提升。在实际应用中，已经有众多企业和项目通过采用 ZGC，成功解决了传统垃圾回收器在面对海量数据和高负载时的困境，取得了显著的经济效益和技术突破。</p>
<p>然而，ZGC 并非完美无缺，它仍然存在一些局限性，如 JVM 版本依赖、平台限制和较高的资源需求等。但随着 Java 技术的不断发展和迭代，相信 ZGC 会在未来得到进一步的优化和完善。例如，在未来，ZGC 有望进一步降低垃圾回收的停顿时间，提高内存管理的效率，更好地适应新的硬件架构和应用场景。同时，随着与容器技术、云计算技术等的深度融合，ZGC 将为更多的应用场景提供高效的内存管理支持，推动 Java 技术在各个领域的广泛应用和发展。对于 Java 开发者来说，深入了解 ZGC 并合理运用其优势，将为构建高性能、低延迟的 Java 应用程序提供有力的保障。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么 AI 明明写后端更爽，但却都网传 AI 取代前端，而不是 AI 取代后端？就离谱...]]></title>    <link>https://juejin.cn/post/7582528397865254939</link>    <guid>https://juejin.cn/post/7582528397865254939</guid>    <pubDate>2025-12-12T04:11:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582528397865254939" data-draft-id="7582491862264922162" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么 AI 明明写后端更爽，但却都网传 AI 取代前端，而不是 AI 取代后端？就离谱..."/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2025-12-12T04:11:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员Sunday"/> <meta itemprop="url" content="https://juejin.cn/user/2963939078980712"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么 AI 明明写后端更爽，但却都网传 AI 取代前端，而不是 AI 取代后端？就离谱...
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2963939078980712/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员Sunday
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T04:11:06.000Z" title="Fri Dec 12 2025 04:11:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.7;font-weight:400;font-size:16px;overflow-x:hidden;color:#2c3e50;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;font-weight:600;margin-top:35px;margin-bottom:8px;padding-bottom:5px}.markdown-body h1 :before,.markdown-body h2 :before,.markdown-body h3 :before,.markdown-body h4 :before,.markdown-body h5 :before,.markdown-body h6 :before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{padding-bottom:8px;margin-top:50px;font-size:24px;border-bottom:1px solid #eaecef}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #eaecef;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;font-weight:400;background-color:rgba(27,31,35,.05);color:#476582;margin:0;font-size:.85em;border-radius:3px;font-size:.87em;padding:.165em .5em}.markdown-body code,.markdown-body pre{font-family:source-code-pro,Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.6;padding:20px 24px;background-color:#282c34;border-radius:6px}.markdown-body pre&gt;code{font-size:14px;padding:0;margin:0;word-break:normal;display:block;overflow-x:auto;color:#fff}.markdown-body a{text-decoration:none;color:#3eaf7c;font-weight:500}.markdown-body a:active,.markdown-body a:hover{color:#42b983;border-bottom:1px solid #42b983}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;margin:16px 0;border-collapse:collapse}.markdown-body thead{background:#f6f6f6;background:#3eaf7c;color:#000;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f6f8fa}.markdown-body td,.markdown-body th{border:1px solid #dfe2e5;padding:10px 16px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{font-size:14px;padding:6px 23px;margin:22px 0;border-left:6px solid #42b983;background-color:#f3f5f7;font-weight:400}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body p,.markdown-body ul{line-height:1.7}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="base16/tomorrow-night">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是 Sunday。</p>
<p>昨天发完 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F_ha5pViynB6CAOr8-v91QA" target="_blank" title="https://mp.weixin.qq.com/s/_ha5pViynB6CAOr8-v91QA" ref="nofollow noopener noreferrer">手写代码"已死"？深度体验 Gemini 3 Pro 和 Claude Sonnet 4.5 后的 72 小时
</a> 后，后台私信直接爆了。</p>
<p>大家的关注点出奇的一致，但是却并不是我提到的薪资差距，<strong>而是文中我随口提的一句话：</strong></p>
<blockquote>
<p><strong>“用 AI 写后端比写前端厉害多了。但为什么大家总觉得 AI 要取代前端，而不是后端？”</strong></p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c914606f28e4f1ea61d371ed55b9b1a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYU3VuZGF5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766117466&amp;x-signature=3bR09qoFejQxbJfC1Cd9sxn%2FU0k%3D" alt="" loading="lazy"/></p>
<p>很多做后端的同学不服气，跑来跟我对线：“Sunday，你懂不懂后端？后端涉及高并发、微服务、分布式事务，AI 怎么可能搞得定？”</p>
<p>也有前端同学很焦虑：“是不是前端真的要完了？我还需要继续学吗？”</p>
<p>别急。今天是 12 月 12 号，距离 2026 年只剩不到 20 天。在各大厂开始锁 HC（Headcount）、大家开始摸鱼写年终总结的 <strong>“垃圾时间”</strong> 里，我想和大家 <strong>深度、"赤裸"(请不要想歪了...)</strong> 地聊聊这个话题。</p>
<p>这不仅仅是“前端 vs 后端”的技术之争，更是我们每个人在 <strong>2026 年保住饭碗</strong> 的底层逻辑。</p>
<h2 data-id="heading-0">并不是“后端更难”，而是“上下文”不同</h2>
<p>首先，我要抛出一个反直觉的结论：<strong>单纯从代码生成的质量来看，AI 写后端代码（Python/Java/Go），其实比写前端代码（JS/TS/CSS）要强得多。</strong></p>
<p>为什么？因为后端逻辑通常是线性的、严谨的。</p>
<ul>
<li>输入一个参数 -&gt; 查数据库 -&gt; 做个计算 -&gt; 返回结果。</li>
<li>这种逻辑，LLM（大语言模型）理解起来毫不费力。</li>
</ul>
<p>反观前端：</p>
<ul>
<li>CSS 的层叠上下文（Stacking Context）</li>
<li>React 的闭包陷阱</li>
<li>Vue 的响应式原理</li>
<li>还有那该死的浏览器兼容性，以及 <strong>最重要的</strong> UI 还原度</li>
</ul>
<p>这些东西充满了“难以被机器理解的东西”，AI 会经常写出“不是这里差点，就是那里差点”，无法复原设计图的代码。</p>
<p><strong>但是！</strong> 为什么大家依然觉得 <strong>前端更容易被取代</strong>？</p>
<p>核心原因只有两个：</p>
<ol>
<li><strong>颗粒度的细化！</strong></li>
<li><strong>IDE 的支持！</strong></li>
</ol>
<h3 data-id="heading-1">1. 颗粒度的细化</h3>
<p>前端开发在这十年做了一件最伟大的事，就是 <strong>组件化</strong>（React/Vue）。</p>
<p>我们把页面拆成了 Header、Sidebar、Button、List。每一个组件都是 <strong>相对独立</strong> 的。</p>
<p>这就给 AI 提供了一个 <strong>完美的切入点</strong>。</p>
<p>你想想，当你用 Cursor 或者 Windsurf 写代码时，你是不是通常只把当前这个 <code>.vue</code> 或者 <code>.tsx</code> 文件投喂给 AI？</p>
<p>因为前端的逻辑 <strong>高度内聚</strong> 在组件内部。AI 只需要理解这 200 行代码，就能完美地帮你重构、加功能、改样式。它不需要知道你隔壁页面的路由是怎么配置的，也不需要知道你的全局 Store 里存了什么（大部分时候）。<code>PS：</code> 我并不是说 AI 不会理解全局，事实上现在的 <code>AI 已经可以很好的理解全局代码了</code></p>
<p><strong>这就是为什么前端觉得 AI 好用，老板觉得前端好裁。</strong></p>
<p>因为任务被颗粒化了，颗粒化到连外行都能用 AI 拼凑出一个像模像样的页面。虽然无法完美还原设计图，但是如果让 AI 自行设计样式的话，那么是完全可以达到商用水平的。即：<strong>无设计图，AI 发挥，则可超过一般设计师的设计</strong></p>
<p><strong>再看看后端。</strong></p>
<p>后端的复杂，从来不在于某一个函数的实现，而在于 <strong>关系</strong>。</p>
<ul>
<li>这个接口改了，会不会影响那个微服务的调用？</li>
<li>这个字段动了，会不会导致两年前写的那个报表任务挂掉？</li>
<li>这个缓存策略改了，会不会在半夜 12 点引发雪崩？</li>
</ul>
<p>这些逻辑，往往分散在几十个服务、上百个配置文件、以及 <strong>只有老员工脑子里才知道的“祖传规矩”</strong> 里。</p>
<p>目前的 AI 模型（哪怕是 Gemini 3 pro 或 Claude Sonnet 4.5），它们的 <strong>Context Window（上下文窗口）</strong> 虽然已经很大了，但依然无法装下整个公司 <strong>10 年积累的后端架构和业务逻辑</strong>。</p>
<p>所以，后端同学目前的安全感，其实是来自于 <strong>“业务逻辑的极度耦合”</strong> 和 <strong>“系统的不可维护性”</strong>。</p>
<p>说难听点：<strong>是因为代码写得烂且复杂，AI 才看不懂。</strong> 这不算什么值得骄傲的护城河，但在 2025 年，这确实救了很多人的命。</p>
<h3 data-id="heading-2">02：IDE 的支持</h3>
<p>说起 AI 编程工具，那么大家想到的肯定是 <code>cursor、Github Copilot</code> 等。但是，大家有没有发现这些 IDE 大部分都是用来写前端代码的工具。虽然他们可以写后端代码，但是后端人却依然习惯使用 IDEA（注：这里的后端仅指 <code>java</code>不涉及 Node、Python 等）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3d4730bda234f97abe5b64213eb2f76~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYU3VuZGF5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766117466&amp;x-signature=zYaH9RQlV0CqJMlot63wUssoF5U%3D" alt="" loading="lazy"/></p>
<p>这就导致了一个非常有意思的现象：<strong>工具的壁垒，意外成了后端的掩体。</strong></p>
<p>众所周知，<code>Cursor</code> 是基于 VS Code 二次开发的。而在 Java / Go 的庞大生态里，JetBrains 系列（IntelliJ IDEA, GoLand）才是绝对的统治者。</p>
<p>对于后端同学来说，IDEA 强大的静态分析、重构能力、以及对 Maven/Gradle 复杂构建工具的支持，是 VS Code 很难在短期内追平的。这就导致很多后端同学<strong>想用 Cursor 却用得不顺手</strong>，被迫留在了老牌 IDE 里，从而在物理上“隔离”了一部分 AI 的冲击。</p>
<p><strong>但这只是暂时的。</strong> 随着 JetBrains AI 的发力以及 Cursor 对 Java 支持的完善，这层窗户纸迟早要破。</p>
<p>而当这层窗户纸捅破之后，真正的危机才刚刚开始。</p>
<p>当然，以上内容 <strong>仅为个人见解</strong>，非喜勿喷... 如果一定要喷，请轻喷...</p>
<h2 data-id="heading-3">12月该准备什么？</h2>
<p>说了这么多理论，供大家参考就可以。</p>
<p>但是，我相信大多数的同学看文章也不是光想看看热闹的。大家想要的还是 <strong>现在我们应该怎么做？</strong></p>
<p>落地到 <strong>今天（2025 年 12 月 12 号）</strong>，这一天，我们该做什么？</p>
<p>现在的招聘市场很奇妙：</p>
<ul>
<li><strong>大厂锁 HC：</strong> 只有零星的补录，主要在盘点年终奖和裁员名单。</li>
<li><strong>中小厂在观望：</strong> 想招人，但想招“全能侠”，价格给得还低。</li>
</ul>
<p>很多同学会认为这是 <strong>“年底垃圾时间”</strong>。</p>
<p>从而导致，大多数人这时候选择躺平，等年终奖，或者等明年“金三银四”。<strong>大错特错！</strong></p>
<p>Sunday 阅人无数，可以负责任地告诉你：<strong>每年的 12 月和 1 月，是普通人实现“职场超车”的黄金窗口期。</strong></p>
<p>为什么？因为这时候竞争对手最少，而面试官（如果还在招人的话）是最急的。更重要的是，这一个半月，足够把 <strong>针对面试做好充足准备</strong>。</p>
<p>所以，好好的准备你的简历，好好的深挖你的业务项目，抓住年底的机会，尽快拿到中大厂的 offer。因为只有进入到更大的平台，你才可以真正实现薪资的跳跃！</p>
<h2 data-id="heading-4">写在最后</h2>
<p>文章的最后，我想聊聊心态。</p>
<p>昨天文章发出后，有一位 90 后的同学问我，说：“Sunday 老师，我觉得我们 90 后就是被放弃的一代。好不容易学个技术上个班，技术更新的那么快，根本学不动。现在 AI 出来了，程序员是不是都要被淘汰了？”</p>
<p>不过，话说回来。虽然我也是 90 后，但是我不这么认为。</p>
<p>AI 本质上是一个 <strong>杠杆</strong>。</p>
<blockquote>
<p>它会放大你的弱点，同时也会放大你的优势！对于普通人而言，AI 是极其富有创造力的工具，它可以让你一个人就能活成一支优秀的团队！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[把代码上传到 GitHub Gist]]></title>    <link>https://juejin.cn/post/7582533464244879394</link>    <guid>https://juejin.cn/post/7582533464244879394</guid>    <pubDate>2025-12-12T06:13:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582533464244879394" data-draft-id="7582424649784590336" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="把代码上传到 GitHub Gist"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2025-12-12T06:13:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Emma歌小白"/> <meta itemprop="url" content="https://juejin.cn/user/668922459726520"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            把代码上传到 GitHub Gist
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/668922459726520/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Emma歌小白
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T06:13:09.000Z" title="Fri Dec 12 2025 06:13:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>下面是一步步教你怎么<strong>把代码上传到 GitHub Gist（生成可分享的公开链接）<strong>的简易教程 👇<br/>
我提供的是</strong>网页操作法（最简单）</strong> ：</p>
<hr/>
<h2 data-id="heading-0">📌 什么是 GitHub Gist？</h2>
<p><strong>Gist</strong> 是 GitHub 提供的一个代码片段分享平台，可用于快速分享代码（类似 Pastebin）。你上传后会得到一个公开链接，他人可以直接访问和下载。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.github.com%2Farticles%2Fcreating-gists%3Futm_source%3Dchatgpt.com" title="https://docs.github.com/articles/creating-gists?utm_source=chatgpt.com" target="_blank" ref="nofollow noopener noreferrer">GitHub Docs</a>)</p>
<hr/>
<h2 data-id="heading-1">🧑‍💻 步骤 1 — 注册 / 登录 GitHub</h2>
<ol>
<li>打开浏览器访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2F" target="_blank" title="https://github.com/" ref="nofollow noopener noreferrer">github.com</a></li>
<li>注册一个 GitHub 账号（如果已有账号则直接登录）</li>
</ol>
<hr/>
<h2 data-id="heading-2">📄 步骤 2 — 进入 Gist 页面</h2>
<p>打开：</p>
<p>👉 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgist.github.com%2F" target="_blank" title="https://gist.github.com/" ref="nofollow noopener noreferrer">gist.github.com</a></p>
<p>这是 Gist 专用的页面。</p>
<hr/>
<h2 data-id="heading-3">➕ 步骤 3 — 创建一个新 Gist</h2>
<ol>
<li>
<p>在 Gist 页面右上角点击 <strong>“+”</strong> 或 <strong>“New Gist”</strong> 。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.github.com%2Fen%2Fenterprise-server%25403.14%2Fget-started%2Fwriting-on-github%2Fediting-and-sharing-content-with-gists%2Fcreating-gists%3Futm_source%3Dchatgpt.com" title="https://docs.github.com/en/enterprise-server%403.14/get-started/writing-on-github/editing-and-sharing-content-with-gists/creating-gists?utm_source=chatgpt.com" target="_blank" ref="nofollow noopener noreferrer">GitHub Docs</a>)</p>
</li>
<li>
<p>在 <strong>Filename including extension</strong> 输入文件名，比如：</p>
<pre><code class="hljs">code1.txt
</code></pre>
</li>
<li>
<p>在下面的大文本框粘贴你的代码内容。</p>
</li>
<li>
<p>你可以在上方的 <strong>Description</strong> 输入简短描述（可选）。</p>
</li>
<li>
<p>选择 <strong>Public Gist</strong>（公开）或者 <strong>Secret Gist</strong>（私密，可通过链接访问但不会被搜索到）。</p>
</li>
<li>
<p>最后点击 <strong>Create public gist</strong>（创建公开 Gist）或者 <strong>Create secret gist</strong>。(<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.github.com%2Farticles%2Fcreating-gists%3Futm_source%3Dchatgpt.com" title="https://docs.github.com/articles/creating-gists?utm_source=chatgpt.com" target="_blank" ref="nofollow noopener noreferrer">GitHub Docs</a>)</p>
</li>
</ol>
<p>✔️ 创建完成后会出现一个类似这样的网址：</p>
<pre><code class="hljs language-arduino" lang="arduino">https:<span class="hljs-comment">//gist.github.com/你的用户名/一串唯一ID</span>
</code></pre>
<p>这个就是你分享给我的链接。</p>
<hr/>
<h2 data-id="heading-4">📎 步骤 4 — 获取可分享链接</h2>
<p>创建完成后：</p>
<p>📍 地址栏就是该 Gist 的公开访问链接<br/>
📍 点击右上角的 <strong>Raw</strong> 可以看到原始纯代码文件</p>
<p>你只需复制 <strong>浏览器地址栏的网址</strong>发给我即可。</p>
<hr/>
<h2 data-id="heading-5">📁 上传多个文件（可选）</h2>
<p>如果你需要上传多个文件：</p>
<ol>
<li>点击 <strong>Add file</strong>（可以添加更多代码文件）</li>
<li>每个文件都有独立的文件名</li>
<li>最终一起上传到同一个 Gist</li>
</ol>
<hr/>
<h2 data-id="heading-6">📌 小提示</h2>
<p>✅ <strong>公开 Gist</strong>：任何人有链接都能访问<br/>
✅ <strong>Secret Gist</strong>：别人只有得到链接才能访问，不会被搜索到<br/>
✅ Gist 是 Git 仓库：可以 clone、fork、管理版本历史 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.github.com%2Farticles%2Fcreating-gists%3Futm_source%3Dchatgpt.com" title="https://docs.github.com/articles/creating-gists?utm_source=chatgpt.com" target="_blank" ref="nofollow noopener noreferrer">GitHub Docs</a>)</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[突破 LLM 极限！n8n + MemMachine 打造“无限流”小说生成器]]></title>    <link>https://juejin.cn/post/7582561515816484927</link>    <guid>https://juejin.cn/post/7582561515816484927</guid>    <pubDate>2025-12-12T06:12:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582561515816484927" data-draft-id="7582422766731755563" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="突破 LLM 极限！n8n + MemMachine 打造“无限流”小说生成器"/> <meta itemprop="keywords" content="AIGC,人工智能,Agent"/> <meta itemprop="datePublished" content="2025-12-12T06:12:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="后端小肥肠"/> <meta itemprop="url" content="https://juejin.cn/user/2966945320667536"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            突破 LLM 极限！n8n + MemMachine 打造“无限流”小说生成器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2966945320667536/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    后端小肥肠
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T06:12:30.000Z" title="Fri Dec 12 2025 06:12:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是小肥肠！今天我们搞点真正的黑科技，挑战一下大模型的“记忆极限”。针对AI写长文容易“失忆”的顽疾，我用 <strong>n8n + MemMachine</strong> 打造了一套“永不忘词”的无限长篇小说工作流。从大纲设定到自动连载，字数无上限，剧情不崩坏，一键直达飞书。想让你的 AI 进化成能写百万字的“网文大神”吗？码住这篇教程，带你零门槛实操起飞！</p>
<h2 data-id="heading-0">1. 效果演示</h2>
<p>上周我写了一个写小说的工作流，很多读者反馈能不能突破篇幅限制，短篇小说不够看的。为了解决这个痛点，我基于 <strong>MemMachine</strong> 实现了这个可以突破大模型上下文限制的 <strong>n8n 无限长篇小说工作流</strong>。做出来以后在群里内测，反馈相当不错。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f16ba78af5a24eb8bd7f9e13f7f967cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124750&amp;x-signature=EsNff3fqmyLgpZIRSQ9%2F7x8XbBU%3D" alt="" loading="lazy"/></p>
<p>现在的工作流一共为两部分：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6844602725d4fa6a4e15fa07cb4328b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124750&amp;x-signature=FuvYKdJE0rmlo4t0CPOkY%2FtyyG0%3D" alt="" loading="lazy"/></p>
<p><strong>第一部分</strong>是将本地小说录入飞书素材库。有了这一步，我们就可以基于自定义素材，编写任意领域风格的小说。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce23c06e51d8473e90413aec49d7c27d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124750&amp;x-signature=2t7%2FVMnRs4DbPAan3ksHqa%2FYDmY%3D" alt="" loading="lazy"/></p>
<p><strong>第二部分</strong>是读取素材库中的小说作为参考配合<strong>MemMachine</strong> 记忆库编写长篇小说，下图中写了整整16章。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd210b311d064fc380ea6773435c2cb7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124750&amp;x-signature=9%2FBr1kQdpR1LwGngM0T7VaP%2FFYk%3D" alt="" loading="lazy"/></p>
<p>每章的字数在2000—3000字，远远突破了大模型上下文限制。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fab79269d8344cf99c6f75a7546255d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124750&amp;x-signature=aIxDEIVAYQ62jpS6c0h8lgPDjME%3D" alt="" loading="lazy"/></p>
<p>接下来就正式开始这个硬核工作流的搭建~</p>
<h2 data-id="heading-1">2. 工作流架构剖析和前置准备</h2>
<h3 data-id="heading-2">2.1 长篇小说工作流架构说明</h3>
<p>长篇小说工作流主要依赖于<strong>MemMachine来存储章节的记忆，每写完一章会将这章的内容存入记忆库，下一章的编写可依赖这一章的内容。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b9721119be744040b587ebd0d62a235a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124750&amp;x-signature=NWaTB7tteogsSgVxCm0QEcHvGYo%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">2.2 基于Docker部署MemMachine</h3>
<p><strong>MemMachine</strong>是一个开源的<strong>AI 智能体通用记忆层（Universal Memory Layer）</strong> 项目。简单来说，它的目标是解决大语言模型（LLM）通常存在的<strong>失忆</strong>问题（即无状态），让 AI 智能体能够像人一样拥有长期记忆、个性化认知和上下文理解能力。</p>
<p>现在的 AI 虽然聪明但非常健忘，一旦关闭对话窗口或者换一个模型，它就会把你以前说过的话和你的个人喜好忘得一干二净。MemMachine 就是为了解决这个问题而设计的一个外挂大脑，它能像一个超级记事本一样，自动把你的聊天记录、习惯偏好（比如我不吃香菜）和历史事件永久存储下来。</p>
<p>这样做最大的好处是，AI 拥有了长期记忆。哪怕你过段时间再回来，或者换用了不同公司的 AI 模型，只要连上这个系统，AI 就能立刻想起来你是谁以及你们之前的交情，不需要你重复啰嗦。它让 AI 从一个每次见面都要重新认识的陌生人，变成了一个真正懂你、记得你一切过往的老朋友。</p>
<p><strong>源码地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FMemMachine%2FMemMachine" target="_blank" title="https://github.com/MemMachine/MemMachine" ref="nofollow noopener noreferrer">github.com/MemMachine/…</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b8154267d3047f3b47c464b56918882~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124750&amp;x-signature=GJZnhVqdYWINqabU8Bt7sGS%2Fxis%3D" alt="" loading="lazy"/></p>
<p>进入页面后我们就可以用git clone或下载压缩包的形式来下载源码了，源码下载完后项目的目录如下图。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a837393c1de74baaab22236f57f1feb5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124750&amp;x-signature=bJnxVd8Edz%2B4Ny%2F6Wmc2szc102A%3D" alt="" loading="lazy"/></p>
<p>只需要配置好.env、docker-compose.yml、configuration.yml这三个文件就可以基于Docker顺利部署<strong>MemMachine</strong>在本地了。</p>
<p><strong>MemMachine</strong>部署也很简单，只需要在文件路径输出cmd，在弹出的命令提示符中输入<strong>docker compose up -d</strong>即可完成部署。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c728e5c6d7d447599edda71c611cddc3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124750&amp;x-signature=zumsdw0Crh6jcADWoX%2BiZqLjUUo%3D" alt="" loading="lazy"/></p>
<p>部署后可访问<a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A8080%2Fdocs%25EF%25BC%258C%25E7%259C%258B%25E5%2588%25B0%25E5%25A6%2582%25E4%25B8%258B%25E7%2595%258C%25E9%259D%25A2%25E5%258D%25B3%25E4%25B8%25BA%25E6%2588%2590%25E5%258A%259F%25E3%2580%2582" target="_blank" title="http://localhost:8080/docs%EF%BC%8C%E7%9C%8B%E5%88%B0%E5%A6%82%E4%B8%8B%E7%95%8C%E9%9D%A2%E5%8D%B3%E4%B8%BA%E6%88%90%E5%8A%9F%E3%80%82" ref="nofollow noopener noreferrer">http://localhost:8080/docs，看到如下界面即为成功。</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6aa0876b3c7414db66afe3e9c552a27~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124750&amp;x-signature=kihAa4nOYxX8p2hHN6sMZbK8WCQ%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">3. 工作流搭建</h2>
<p>这个小说工作流和原来的一样，唯一的区别是加了<strong>MemMachine</strong>记忆写入和读取逻辑。这里就不再从头开始搭建，只讲差异部分，需要看从0开始的搭建步骤可以去看<a href="https://juejin.cn/post/7580378958072610826" target="_blank" title="https://juejin.cn/post/7580378958072610826">通吃网文投稿+AI漫剧版权！我用 n8n+飞书搭了个“万字爆款小说流水线”</a></p>
<p><strong>长篇小说工作运行流程如下：</strong></p>
<ol>
<li>
<p>表单提交小说主题和领域内容</p>
</li>
<li>
<p>根据用户提交表单中的小说领域去飞书素材库中找到对应小说素材作为写作参考</p>
</li>
<li>
<p>结合小说素材，用户提供的主题编写小说的大纲和章节梗概列表（数组形式）</p>
</li>
<li>
<p>初始化一个<strong>MemMachine</strong> project，获得一个project_id</p>
</li>
<li>
<p>进入循环开始编写章节内容</p>
</li>
<li>
<p>根据project_id从<strong>MemMachine</strong> 获取上一章节的内容</p>
</li>
<li>
<p>根据前期提要，大纲和本章节的梗概编写本章节的详细内容</p>
</li>
<li>
<p>写入章节内容到飞书表格</p>
</li>
<li>
<p>总结本章节的内容，以project_id为标识写入<strong>MemMachine</strong></p>
</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ffb1ee4bbb624cbb881b0b67841863b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124750&amp;x-signature=DaVbeqFPjSrJNV6iovE6xdNLB8s%3D" alt="" loading="lazy"/></p>
<p><strong>初始化项目(HTTP Request)：</strong> 这个节点位于编写大纲节点的前面，它的作用是在<strong>MemMachine</strong> 中新建一个<strong>project</strong>，后续编写的章节内容会存入到project中。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f6254a35ed048bc88785197726324bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124750&amp;x-signature=gP2Dmh%2F1Qn%2B0Rgt%2BobzpqonCEDM%3D" alt="" loading="lazy"/></p>
<p>跟之前的小说工作流比，这个工作流的变动主要在章节编写部分，故本文的节点搭建讲解主要围绕章节编写部分展开：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0a79c1399af4df796314b5435b857c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124750&amp;x-signature=qoGkoW7p7yrLnT9YLHIxhhbXcLY%3D" alt="" loading="lazy"/></p>
<p><strong>读取记忆（HTTP Request）：</strong> 这个节点的作用是根据<strong>project_id</strong>，获取对应<strong>project</strong>中存储的记忆。举个例子，如果<strong>当前章数为3</strong>，那么就会从<strong>project中</strong>获取<strong>前2章的数据</strong>，如果当前章数为1则返回空数据。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c8685abcfbb84d12a15ce564978cc18e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124750&amp;x-signature=bkGUfXPO1IkyvxRtkbnzYarJOUQ%3D" alt="" loading="lazy"/></p>
<p><strong>获取章节梗概(Code inJavaScript)：读取记忆（HTTP Request）节点出来后点击【+】新增Code inJavaScript节点。</strong> 它的作用是从前置所有章节列表中取出最后一章的章节内容。如<strong>读取记忆（HTTP Request）</strong> 节点传入了2章数据，那么这个节点就会获取第2章数据。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6cdd0dc5a36f4ef4aaeec0b6e460b8d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124750&amp;x-signature=8tg%2BGrIrC61qQtMBcIEtAj1wAbk%3D" alt="" loading="lazy"/></p>
<p><strong>章节编写（AI Agent）：获取章节梗概(Code inJavaScript)节点出来后点击【+】新增AI Agent节点。</strong> 这个节点的作用是根据小说摘要，第2章故事梗概与结尾，和第三章故事梗概<strong>编写第三章内容</strong>，这样就能完美解决大模型无法编写长篇小说以及内容过长导致的内容不连贯或人物OOC。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/356f98bb1e4343659148d3b4c0f94710~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124750&amp;x-signature=o57h70mdXvbePjWLvrfX%2BDhqb14%3D" alt="" loading="lazy"/></p>
<p><strong>Code1（将数据改为</strong> <strong>飞书</strong> <strong>表格适配形式）：章节编写（AI Agent）节点出来后点击【+】新增Code inJavaScript节点。</strong> 这是一个代码节点，它的作用是将小说内容适配为飞书表格的形式。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/244c35d71f56467280cf28edb7633f94~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124750&amp;x-signature=q4HIsBgPtVENIJSNSIbRyacVB64%3D" alt="" loading="lazy"/></p>
<p><strong>写入</strong> <strong>飞书</strong> <strong>（Bitable:table:record:add bitable）：Code1（将数据改为飞书表格适配形式）出来后点击【+】新增Bitable:table:record:add bitable节点。</strong> 这是n8n社区节点，负责写入数据到飞书表格。节点的配置使用可参考<a href="https://juejin.cn/post/7578499754553278515" target="_blank" title="https://juejin.cn/post/7578499754553278515">n8n+Coze+飞书：公众号对标文章一键录入+深度拆解，打造你的【爆款素材库】</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f6a8b2286614ff297e33e4bd672340b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124750&amp;x-signature=TOdg9Zgky%2BANOmqrNAjdgW5Nw4s%3D" alt="" loading="lazy"/></p>
<p><strong>总结（AI Agent）：写入</strong> <strong>飞书</strong> <strong>（Bitable:table:record:add bitable）节点出来后点击【+】新增AI Agent节点。</strong> 这个节点的作用是对<strong>章节编写（AI Agent）节点</strong>输出的小说内容进行总结，总结剧情摘要，保留结尾内容以便下一章的衔接。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3632bd586d604c39bc6dd4d3409d2bd2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124750&amp;x-signature=F6NgZTpMVPCpXwa8XkTxDXvg1%2B8%3D" alt="" loading="lazy"/></p>
<p><strong>存入记忆（HTTP Request）：总结（AI Agent）节点出来后点击【+】新增HTTP Request节点。</strong> 这个节点的作用是调用<strong>MemMachine</strong> 接口将章节内容存入<strong>project</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b056994e6bf4445d91aed991430728ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124750&amp;x-signature=NFHAiwzVn7bdruKIrSjGFYM7Tck%3D" alt="" loading="lazy"/></p>
<p>以上就是整个工作流的完整流程拆解，动手能力强的读者可以跟着教程实践一遍。<strong>上述工作流已经被收录到了小肥肠行动家社群中，如果想直接获取工作流原件，可以加入社群后我拉你进空间直接学习使用。</strong></p>
<h2 data-id="heading-5">4. 结语</h2>
<p>至此，一个能够自我迭代、拥有长期记忆的<strong>无限长篇小说生成器</strong>就搭建完成了。这套工作流最大的价值，不在于写小说本身，而在于它证明了 <strong>MemMachine + n8n</strong> 组合的无限可能。当我们把<strong>记忆</strong>从大模型中解耦出来，赋予 Agent 真正的长期状态管理能力时，AI就不再是一个聊完即忘的聊天机器人，而是一个能伴随剧情成长的<strong>创作者</strong>。</p>
<p><strong>如本次分享对你有帮助，麻烦一键三连支持一下小肥肠，我们下期再见~</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e48cf94d4e9243909c862e24653280b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124750&amp;x-signature=1S%2F%2FmQ1qcrb%2FHOzPy3kIk9TVPqk%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为天地图 JavaScript API v4.0 提供 TypeScript 类型支持 —— tianditu-v4-types 正式发布！]]></title>    <link>https://juejin.cn/post/7582502441993830443</link>    <guid>https://juejin.cn/post/7582502441993830443</guid>    <pubDate>2025-12-12T06:15:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582502441993830443" data-draft-id="7582808491582734372" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为天地图 JavaScript API v4.0 提供 TypeScript 类型支持 —— tianditu-v4-types 正式发布！"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-12T06:15:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="知了清语"/> <meta itemprop="url" content="https://juejin.cn/user/2436173498942055"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为天地图 JavaScript API v4.0 提供 TypeScript 类型支持 —— tianditu-v4-types 正式发布！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2436173498942055/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    知了清语
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T06:15:50.000Z" title="Fri Dec 12 2025 06:15:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>如果你正在使用 <strong>天地图（Tianditu）JavaScript API v4.0</strong> 开发 Web 地图应用，并且希望获得更好的开发体验（比如自动补全、类型检查、减少运行时错误），那么你一定会喜欢这个新工具包 👉 <strong>tianditu-v4-types</strong></p>
<h2 data-id="heading-0">简介</h2>
<p><code>tianditu-v4-types</code> 是一个 <strong>纯 TypeScript 类型定义包</strong>，专为 <code>天地图官方 JavaScript API v4.0</code> 设计。它完整覆盖了天地图 API 中的核心类、方法、事件和配置项，包括但不限于：</p>
<ul>
<li><code>T.Map</code>：地图实例</li>
<li><code>T.LngLat</code>：经纬度坐标</li>
<li><code>T.Marker</code> / <code>T.Polyline</code> / <code>T.Polygon</code>：覆盖物</li>
<li><code>T.InfoWindow</code>：信息窗口</li>
<li><code>T.TileLayer</code> / <code>T.MapType</code>：图层与底图类型</li>
<li>事件监听器（如 <code>click</code>, <code>zoomend</code> 等）</li>
<li>地理编码、行政区划查询等高级功能的回调结构</li>
</ul>
<p>✅ <strong>无需修改原有代码</strong>，只需安装类型包，即可在 TypeScript 项目中享受完整的类型提示！</p>
<h2 data-id="heading-1">快速开始</h2>
<pre><code class="hljs language-sql" lang="sql">npm install tianditu<span class="hljs-operator">-</span>v4<span class="hljs-operator">-</span>types <span class="hljs-comment">--save-dev</span>

<span class="hljs-keyword">or</span>

pnpm <span class="hljs-keyword">add</span> tianditu<span class="hljs-operator">-</span>v4<span class="hljs-operator">-</span>types <span class="hljs-operator">-</span>D
</code></pre>
<h2 data-id="heading-2"> 为什么需要它？</h2>
<p>天地图官方 API 虽然功能强大，但仅提供 <strong>无类型的 JavaScript 库</strong>，在现代前端工程化开发中存在以下痛点：</p>
<ul>
<li>❌ 没有类型提示，开发效率低</li>
<li>❌ 容易拼错方法名或传错参数</li>
<li>❌ 团队协作时缺乏接口契约</li>
</ul>
<p>而 <code>tianditu-v4-types</code> 正是为解决这些问题而生——<strong>零运行时开销，纯开发期增强</strong>！</p>
<h2 data-id="heading-3">🌟 特点</h2>
<ul>
<li>✅ 100% 覆盖天地图 JS API v4.0 官方文档</li>
<li>✅ 支持主流框架（Vue、React、Angular、原生 TS）</li>
<li>✅ 严格遵循 TypeScript 最佳实践</li>
<li>✅ 开源免费，MIT 协议</li>
<li>✅ 持续维护，欢迎 PR 和 Issue！</li>
</ul>
<h2 data-id="heading-4">🔗 资源链接</h2>
<ul>
<li>📦 <strong>NPM</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Ftianditu-v4-types" target="_blank" title="https://www.npmjs.com/package/tianditu-v4-types" ref="nofollow noopener noreferrer">www.npmjs.com/package/tia…</a></li>
<li>📁 <strong>GitHub</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fluoriwusheng%2Ftianditu-v4-types" target="_blank" title="https://gitee.com/luoriwusheng/tianditu-v4-types" ref="nofollow noopener noreferrer">tianditu-v4-types: 天地图v4版本typescript 类型文件</a> </li>
<li>📚 <strong>天地图官方文档</strong>: <a href="https://link.juejin.cn?target=http%3A%2F%2Flbs.tianditu.gov.cn%2Fapi%2Fjs4.0%2Fguide.html" target="_blank" title="http://lbs.tianditu.gov.cn/api/js4.0/guide.html" ref="nofollow noopener noreferrer">天地图API</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SIGIR 2025 | 基于图同构网络的群体建模在点击率预测中的应用]]></title>    <link>https://juejin.cn/post/7582553782398468142</link>    <guid>https://juejin.cn/post/7582553782398468142</guid>    <pubDate>2025-12-12T06:14:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582553782398468142" data-draft-id="7582553782398320686" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SIGIR 2025 | 基于图同构网络的群体建模在点击率预测中的应用"/> <meta itemprop="keywords" content="算法"/> <meta itemprop="datePublished" content="2025-12-12T06:14:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东零售技术"/> <meta itemprop="url" content="https://juejin.cn/user/4233576972293643"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SIGIR 2025 | 基于图同构网络的群体建模在点击率预测中的应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4233576972293643/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东零售技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T06:14:23.000Z" title="Fri Dec 12 2025 06:14:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文入选顶会SIGIR 2025</p>
<p>点击率预估任务通常会面临冷启动问题，即新用户因历史行为数据不足而难以进行准确预测。近期研究尝试通过编码器-解码器网络，基于活跃用户数据为冷启动用户生成虚拟行为表征。然而，现有方法存在两大缺陷：对活跃用户行为的编码技术过于简单化，且直接使用虚拟行为表征会导致用户兴趣表达受限、模型泛化能力不足。为解决这些问题，我们提出创新性的基于图同构网络的群体建模方法。该方案通过GIN网络有效捕捉用户-物品高阶交互关系，从而更精细地刻画用户多样化兴趣。结合群体建模策略，可显著减少嵌入构建偏差，增强模型泛化能力。我们在公开数据集和工业数据集上的实验表明，相较现有方法，新方案对活跃用户和冷启动用户均带来显著效果提升。</p>
<p>论文链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdl.acm.org%2Fdoi%2F10.1145%2F3726302.3731936" target="_blank" title="https://dl.acm.org/doi/10.1145/3726302.3731936" ref="nofollow noopener noreferrer">dl.acm.org/doi/10.1145…</a></p>
<h2 data-id="heading-0"><strong>01</strong> 业务背景与问题表现</h2>
<p><strong>1、业务场景：京东广告推荐系统</strong></p>
<p>在京东的在线广告推荐系统中，系统每天需要为数亿用户实时推送个性化广告。CTR（点击率）预测模型是核心模块，直接决定广告收入和用户体验。</p>
<p>核心目标：预测用户对某个广告的点击概率 P(y=1∣u,i)P(y=1∣u,i)，从而排序并展示最可能被点击的广告。</p>
<p><strong>2、冷启动问题（Cold Start Problem）的表现</strong></p>
<p>冷启动问题是指推荐系统在缺乏用户-物品交互数据时，无法提供有效个性化推荐的困境。</p>




















<table><thead><tr><th>用户类型</th><th>行为数据</th><th>问题表现</th></tr></thead><tbody><tr><td><strong>活跃用户（Warm User）</strong></td><td>有大量历史点击、浏览、收藏行为</td><td>模型可精准建模兴趣</td></tr><tr><td><strong>冷启用户（Cold User）</strong></td><td>无/少历史行为、仅知基础属性（性别、年龄、地域）</td><td>模型无法有效建模兴趣 → 推荐随机、点击率低、转化差</td></tr></tbody></table>
<p><strong>3、具体业务影响</strong></p>
<p>新用户点击率低：因无行为数据，只能依赖统计特征，推荐“热门商品”或“默认广告”，缺乏个性化。</p>
<p>用户体验差：用户看到“与我无关”的广告 → 产生反感、降低平台信任度。</p>
<p>模型评估偏差：传统模型在“全体用户”上AUC表现良好，但在“新用户”子集上显著下降。</p>
<p>关键痛点： “没有行为，就没有兴趣” —— 但用户不能等行为积累后才被推荐。</p>
<h2 data-id="heading-1"><strong>02</strong> <strong>问题抽象与动机提炼</strong></h2>
<p><strong>1、零样本学习的核心思路</strong></p>
<p>在缺乏交互数据的前提下，利用辅助信息（属性、内容、关系等）进行兴趣推断。“从千万个老用户的行为模式中，学习‘属性→行为’，‘行为→属性’的映射规则，然后用这个规则，基于用户的属性信息，为新用户生成一个‘虚拟的但合理’的行为推断。”</p>
<p>场景设定</p>
<p>一位新用户“小李”刚注册京东App，仅提供以下属性信息：性别-女，年龄-28岁，城市-北京，设备-iPhone 15，从未点击、购买过任何商品—— 行为数据为0。</p>
<p>传统推荐系统看到她，只能推“全站热销”：iPhone 17、AirPods、小米手环……</p>
<p>但系统中有多个与小李相似的活跃用户和其历史行为</p>
<p>用户A：性别-女，年龄-26岁，城市-北京，设备-iPhone16 ，历史点击- Apple Watch, 吹风机，扫地机器人……</p>
<p>用户B：性别-女，年龄-29岁，城市-北京，设备-iPhone16 ，历史点击- 运动服饰，网球拍……</p>
<p>基于这部分用户的历史兴趣，我们可以大致推断该类用户比较共同的兴趣范畴：她们生活在一线都市，注重生活品质与效率，偏好科技感强、能提升日常体验的智能家电，同时关注健康与自我管理。</p>
<p>零样本方法两大问题（论文动机来源）：</p>




















<table><thead><tr><th>缺陷</th><th>描述</th><th>问题</th></tr></thead><tbody><tr><td><strong>1. 行为编码过于简单</strong></td><td>用Mean-Pooling等方式直接聚合行为序列，忽略<strong>高阶交互</strong>（如：用户A买过手机+耳机 → 可能也买充电宝）</td><td>生成的虚拟行为嵌入<strong>信息稀疏、表达力弱</strong></td></tr><tr><td><strong>2. 直接使用虚拟嵌入</strong></td><td>将生成的虚拟行为嵌入直接输入CTR模型，未做校正</td><td>与真实行为嵌入存在<strong>偏差</strong>→ 模型学到的是“噪声兴趣”</td></tr></tbody></table>
<p>核心洞察： 我们不需要“完美还原”个体行为，而是要找到一群相似的用户，用群体共识来校正个体偏差。</p>
<p><strong>2、论文的抽象与动机提炼</strong></p>

























<table><thead><tr><th>核心问题</th><th>抽象问题</th><th>论文动机</th></tr></thead><tbody><tr><td><strong>数据层面</strong></td><td>个体行为嵌入表达力不足</td><td>→ 引入<strong>GIN图网络</strong>，建模高阶、非线性用户-物品交互</td></tr><tr><td><strong>建模层面</strong></td><td>虚拟嵌入有偏差</td><td>→ 引入<strong>群体建模（Cohort Modeling）</strong> ：不依赖个体，依赖群体共识</td></tr><tr><td><strong>系统层面</strong></td><td>无法在线部署，延迟高</td><td>→ 设计<strong>预计算+实时读取</strong>架构，兼顾精度与效率</td></tr></tbody></table>
<p>核心动机： “用图神经网络生成虚拟行为表征，再用群体共识校正个体偏差，实现冷启动用户的群体智能推荐”</p>
<h2 data-id="heading-2"><strong>03</strong> 论文解法与实验方案</h2>
<p><strong>1、整体架构：GINCM（Graph Isomorphism Network-based Cohort Modeling）</strong>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74e0fc61e5644637b85f702166f0b86a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic6Zu25ZSu5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124862&amp;x-signature=4H8ZfShfVzHGmxw%2Fc%2FDY0oexROQ%3D" alt="图片" loading="lazy"/></p>
<p><strong>2、模型由三大模块协同工作</strong></p>
<p>模块一：GIN-based Graph Encoder（高阶交互建模）</p>
<p>输入：用户-物品交互图（二部图），节点=用户/物品，边=点击/浏览</p>
<p>步骤：使用Graph Isomorphism Network (GIN)编码子图</p>
<p>◦GIN 相比GCN、GraphSAGE，GIN能捕捉更复杂的拓扑结构，能学习到更高级的用户-商品交互模式</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/66705ff5f8064498a6946d243ef84378~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic6Zu25ZSu5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124862&amp;x-signature=Tf5aUPjXE6DgkvjA6FEo%2F97751I%3D" alt="图片" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73e347b9bb4d4a21a142d151961b4697~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic6Zu25ZSu5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124862&amp;x-signature=XeHylULOnROXwHvm%2B%2FWjGZIDEPc%3D" alt="图片" loading="lazy"/>
输出：聚合后的用户行为表征﻿</p>
<p>模块二：Joint Denoising Auto-Encoder（JDAE）—— 虚拟行为生成</p>
<p>目标：为冷启用户生成“虚拟行为嵌入”</p>
<p>输入：冷启用户的属性特征（如：性别=男，年龄=25，城市=北京）</p>
<p><strong>结构：</strong></p>
<p>编码器：将用户属性特征和用户行为特征都进行编码；</p>
<p>解码器：双向重建，用“行为”重建“属性” ，用“属性”重建“行为”•损失函数（式6）：<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e2c1edf82684c5ea02860c761cca4c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic6Zu25ZSu5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766124862&amp;x-signature=hjkotbYN4xp%2F9MV7%2FwGq8S17fYk%3D" alt="图片" loading="lazy"/><br/>
关键设计： 如果“25岁男性”能重建出“买手机+耳机”行为 → 说明模型学到真实模式 如果“买手机+耳机”能重建出“25岁男性” → 说明行为与属性强相关﻿</p>
<p>模块三：Cohort Modeling Network（CMN）—— 群体共识校正</p>
<p>核心思想：以群体兴趣代替有偏的个体兴趣</p>
<p>步骤：</p>
<p>1、将生成的虚拟用户行为表征二值化（Binarization + STE）得到二进制码</p>
<p>2、STE（Straight-Through Estimator）允许反向传播通过二值化操作</p>
<p>3、每个二进制码代表一个群体（Cohort），如：[1,0,1,0,0,1,0,0]表示属于第1、3、6群体</p>
<p>4、对当前用户对应群体兴趣进行聚合</p>
<p>为什么有效？ 即使生成的用户行为表征有偏差，只要它落在“相似群体”中，就能被群体中心拉回正轨。 群体像“平均值”，能过滤噪声，提升鲁棒性。﻿</p>
<p><strong>3、实验方案与结果</strong></p>
<p>数据集</p>




















<table><thead><tr><th>类型</th><th>数据量</th><th>说明</th></tr></thead><tbody><tr><td><strong>公开数据集</strong></td><td>Amazon Reviews</td><td>1.2M样本，标准benchmark</td></tr><tr><td><strong>工业数据集</strong></td><td>京东广告系统</td><td>30亿样本，31天数据（前30天训练，最后1天测试）</td></tr></tbody></table>
<p>消融实验（Ablation）</p>

























<table><thead><tr><th>模块</th><th>去除后新用户AUC</th><th>结论</th></tr></thead><tbody><tr><td>无GIN（用Mean Pooling）</td><td>↓ 0.7321</td><td>GIN对高阶交互建模非常重要</td></tr><tr><td>无JDAE（用默认向量）</td><td>↓ 0.7112</td><td>虚拟行为生成效果优于直接用属性</td></tr><tr><td>无CMN（直接用虚拟嵌入）</td><td>↓ 0.7145</td><td>群体校正比个体直接使用更鲁棒</td></tr></tbody></table>
<h4 data-id="heading-3"/>
<p><strong>在线部署与A/B测试</strong></p>
<p>部署方式：</p>
<p>预计算：用户行为发生 → 图引擎实时构建子图 → GINCM计算并缓存</p>
<p>实时预测：精排阶段，直接读取缓存的 cohort embedding，无需重算图</p>
<p>结果：</p>
<p>CTR 提升 2.13%</p>
<p>RPM（千次展示收入）提升 2.13%</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从Vue 到 React：Valtio 让状态管理更熟悉]]></title>    <link>https://juejin.cn/post/7582517824498810914</link>    <guid>https://juejin.cn/post/7582517824498810914</guid>    <pubDate>2025-12-12T06:58:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582517824498810914" data-draft-id="7582517824498712610" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从Vue 到 React：Valtio 让状态管理更熟悉"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-12T06:58:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="KenXu"/> <meta itemprop="url" content="https://juejin.cn/user/483440843559406"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从Vue 到 React：Valtio 让状态管理更熟悉
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/483440843559406/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    KenXu
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T06:58:41.000Z" title="Fri Dec 12 2025 06:58:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作为一名 Vue 开发者,你一定习惯了 Vue 3 响应式系统的便利性。当切换到 React 时,最大的不适应可能就是状态管理的方式。好消息是,<strong>Valtio 能让你在 React 中找回类似 Vue 的开发体验</strong>。</p>
<p>参考用例 : <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fckken%2Femp-zustand%2Fblob%2Fmain%2Fprojects%2Femp-valtio%2Fsrc%2Fstore%2Fbase.ts" target="_blank" title="https://github.com/ckken/emp-zustand/blob/main/projects/emp-valtio/src/store/base.ts" ref="nofollow noopener noreferrer">DEMO</a></p>
<h2 data-id="heading-0">为什么 Vue 开发者会喜欢 Valtio?</h2>
<h3 data-id="heading-1">1. 熟悉的可变状态写法</h3>
<p><strong>在 Vue 中:</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// Vue 3 Composition API</span>
<span class="hljs-keyword">import</span> { reactive } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> state = <span class="hljs-title function_">reactive</span>({
  <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">user</span>: {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'Alice'</span>
  }
})

<span class="hljs-comment">// 直接修改</span>
state.<span class="hljs-property">count</span>++
state.<span class="hljs-property">user</span>.<span class="hljs-property">name</span> = <span class="hljs-string">'Bob'</span>
</code></pre>
<p><strong>在 Pinia 中:</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// Pinia Store</span>
<span class="hljs-keyword">import</span> { defineStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useCounterStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'counter'</span>, {
  <span class="hljs-attr">state</span>: <span class="hljs-function">() =&gt;</span> ({
    <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">user</span>: {
      <span class="hljs-attr">name</span>: <span class="hljs-string">'Alice'</span>
    }
  }),
  <span class="hljs-attr">actions</span>: {
    <span class="hljs-title function_">increment</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>++
    },
    <span class="hljs-title function_">updateName</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">user</span>.<span class="hljs-property">name</span> = name
    }
  }
})

<span class="hljs-comment">// 在组件中使用</span>
<span class="hljs-keyword">const</span> store = <span class="hljs-title function_">useCounterStore</span>()
store.<span class="hljs-title function_">increment</span>()
store.<span class="hljs-title function_">updateName</span>(<span class="hljs-string">'Bob'</span>)
</code></pre>
<p><strong>在 Valtio 中:</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// React + Valtio</span>
<span class="hljs-keyword">import</span> { proxy } <span class="hljs-keyword">from</span> <span class="hljs-string">'valtio'</span>

<span class="hljs-keyword">const</span> state = <span class="hljs-title function_">proxy</span>({
  <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">user</span>: {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'Alice'</span>
  }
})

<span class="hljs-comment">// 同样直接修改!</span>
state.<span class="hljs-property">count</span>++
state.<span class="hljs-property">user</span>.<span class="hljs-property">name</span> = <span class="hljs-string">'Bob'</span>
</code></pre>
<p>看到了吗?<strong>写法几乎一模一样!</strong> 不需要像其他 React 状态库那样写 <code>setState</code> 或者返回新对象。</p>
<h3 data-id="heading-2">2. 自动的响应式追踪</h3>
<p><strong>Vue 的响应式:</strong></p>
<pre><code class="hljs language-ts" lang="ts">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{{ state.count }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"state.count++"</span>&gt;</span>增加<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { reactive } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">const</span> state = <span class="hljs-title function_">reactive</span>({ <span class="hljs-attr">count</span>: <span class="hljs-number">0</span> })
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<p><strong>Valtio 的响应式:</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { proxy, useSnapshot } <span class="hljs-keyword">from</span> <span class="hljs-string">'valtio'</span>

<span class="hljs-keyword">const</span> state = <span class="hljs-title function_">proxy</span>({ <span class="hljs-attr">count</span>: <span class="hljs-number">0</span> })

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> snap = <span class="hljs-title function_">useSnapshot</span>(state)  <span class="hljs-comment">// 类似 Vue 的自动依赖追踪</span>
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{snap.count}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> state.count++}&gt;增加<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<p><code>useSnapshot</code> 就像 Vue 的响应式系统,<strong>只会在组件实际使用的状态改变时才重新渲染</strong>。</p>
<h2 data-id="heading-3">核心概念对比</h2>















































<table><thead><tr><th>Vue 3</th><th>Pinia</th><th>Valtio</th><th>说明</th></tr></thead><tbody><tr><td><code>reactive()</code></td><td><code>state: () =&gt; ({})</code></td><td><code>proxy()</code></td><td>创建响应式对象</td></tr><tr><td><code>ref()</code></td><td>-</td><td>不需要</td><td>Valtio 的 proxy 可以直接修改基础类型</td></tr><tr><td>模板自动追踪</td><td><code>storeToRefs()</code></td><td><code>useSnapshot()</code></td><td>追踪依赖并触发更新</td></tr><tr><td><code>computed()</code></td><td><code>getters: {}</code></td><td>getter 函数</td><td>计算属性</td></tr><tr><td><code>watch()</code></td><td><code>$subscribe()</code></td><td><code>subscribe()</code></td><td>监听状态变化</td></tr><tr><td>-</td><td><code>actions: {}</code></td><td>类方法</td><td>定义状态修改方法</td></tr></tbody></table>
<h2 data-id="heading-4">实战示例:从 Vue/Pinia 迁移到 Valtio</h2>
<h3 data-id="heading-5">场景一:简单计数器</h3>
<p><strong>Vue 版本:</strong></p>
<pre><code class="hljs language-ts" lang="ts">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>{{ count }}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"increment"</span>&gt;</span>+1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"decrement"</span>&gt;</span>-1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)

<span class="hljs-keyword">const</span> <span class="hljs-title function_">increment</span> = (<span class="hljs-params"/>) =&gt; count.<span class="hljs-property">value</span>++
<span class="hljs-keyword">const</span> <span class="hljs-title function_">decrement</span> = (<span class="hljs-params"/>) =&gt; count.<span class="hljs-property">value</span>--
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<p><strong>Pinia 版本:</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// stores/counter.ts</span>
<span class="hljs-keyword">import</span> { defineStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useCounterStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'counter'</span>, {
  <span class="hljs-attr">state</span>: <span class="hljs-function">() =&gt;</span> ({
    <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>
  }),
  <span class="hljs-attr">actions</span>: {
    <span class="hljs-title function_">increment</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>++
    },
    <span class="hljs-title function_">decrement</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>--
    }
  }
})

<span class="hljs-comment">// 组件中使用</span>
&lt;script setup lang=<span class="hljs-string">"ts"</span>&gt;
<span class="hljs-keyword">import</span> { useCounterStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/stores/counter'</span>

<span class="hljs-keyword">const</span> store = <span class="hljs-title function_">useCounterStore</span>()
&lt;/script&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>{{ store.count }}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"store.increment"</span>&gt;</span>+1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"store.decrement"</span>&gt;</span>-1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>
</code></pre>
<p><strong>Valtio 版本 (推荐 Class 写法):</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { proxy, useSnapshot } <span class="hljs-keyword">from</span> <span class="hljs-string">'valtio'</span>

<span class="hljs-comment">// 辅助函数</span>
<span class="hljs-keyword">function</span> bind&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">object</span>&gt;(<span class="hljs-attr">instance</span>: T): T {
  <span class="hljs-keyword">const</span> obj = instance <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>
  <span class="hljs-keyword">const</span> names = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getOwnPropertyNames</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getPrototypeOf</span>(obj))
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> name <span class="hljs-keyword">of</span> names) {
    <span class="hljs-keyword">const</span> method = obj[name]
    <span class="hljs-keyword">if</span> (name === <span class="hljs-string">'constructor'</span> || <span class="hljs-keyword">typeof</span> method !== <span class="hljs-string">'function'</span>) <span class="hljs-keyword">continue</span>
    obj[name] = <span class="hljs-function">(<span class="hljs-params">...args: <span class="hljs-built_in">unknown</span>[]</span>) =&gt;</span> method.<span class="hljs-title function_">apply</span>(instance, args)
  }
  <span class="hljs-keyword">return</span> instance
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ValtioStore</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">bind</span>(<span class="hljs-title function_">proxy</span>(<span class="hljs-variable language_">this</span>))
  }
}

<span class="hljs-comment">// 状态类 - 类型自动推导</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CounterStore</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">ValtioStore</span> {
  count = <span class="hljs-number">0</span>  <span class="hljs-comment">// 自动推导为 number</span>
  
  <span class="hljs-title function_">increment</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>++
  }
  
  <span class="hljs-title function_">decrement</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>--
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> counterStore = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CounterStore</span>()

<span class="hljs-comment">// 组件中使用</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> snap = <span class="hljs-title function_">useSnapshot</span>(counterStore)
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>{snap.count}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{snap.increment}</span>&gt;</span>+1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{snap.decrement}</span>&gt;</span>-1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<h3 data-id="heading-6">场景二:嵌套对象和方法</h3>
<p><strong>Vue 版本:</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { reactive } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> store = <span class="hljs-title function_">reactive</span>({
  <span class="hljs-attr">user</span>: {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>,
    <span class="hljs-attr">age</span>: <span class="hljs-number">25</span>
  },
  <span class="hljs-title function_">updateName</span>(<span class="hljs-params">newName: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">user</span>.<span class="hljs-property">name</span> = newName
  },
  <span class="hljs-title function_">incrementAge</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">user</span>.<span class="hljs-property">age</span>++
  }
})
</code></pre>
<p><strong>Pinia 版本:</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// stores/user.ts</span>
<span class="hljs-keyword">import</span> { defineStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useUserStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'user'</span>, {
  <span class="hljs-attr">state</span>: (): { <span class="hljs-attr">user</span>: <span class="hljs-title class_">User</span> } =&gt; ({
    <span class="hljs-attr">user</span>: {
      <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>,
      <span class="hljs-attr">age</span>: <span class="hljs-number">25</span>
    }
  }),
  <span class="hljs-attr">actions</span>: {
    <span class="hljs-title function_">updateName</span>(<span class="hljs-params">newName: <span class="hljs-built_in">string</span></span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">user</span>.<span class="hljs-property">name</span> = newName
    },
    <span class="hljs-title function_">incrementAge</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">user</span>.<span class="hljs-property">age</span>++
    },
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">fetchUser</span>(<span class="hljs-params">id: <span class="hljs-built_in">number</span></span>) {
      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/api/user/<span class="hljs-subst">${id}</span>`</span>)
      <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>()
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">user</span> = data
    }
  }
})
</code></pre>
<p><strong>Valtio Class 版本:</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { proxy } <span class="hljs-keyword">from</span> <span class="hljs-string">'valtio'</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ValtioStore</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">bind</span>(<span class="hljs-title function_">proxy</span>(<span class="hljs-variable language_">this</span>))
  }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserStore</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">ValtioStore</span> {
  user = {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>,
    <span class="hljs-attr">age</span>: <span class="hljs-number">25</span>
  }  <span class="hljs-comment">// 类型自动推导: { name: string; age: number }</span>
  
  <span class="hljs-title function_">updateName</span>(<span class="hljs-params">newName: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">user</span>.<span class="hljs-property">name</span> = newName  <span class="hljs-comment">// 类型安全</span>
  }
  
  <span class="hljs-title function_">incrementAge</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">user</span>.<span class="hljs-property">age</span>++
  }
  
  <span class="hljs-comment">// 支持异步方法</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">fetchUser</span>(<span class="hljs-params">id: <span class="hljs-built_in">number</span></span>) {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/api/user/<span class="hljs-subst">${id}</span>`</span>)
    <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>()
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">user</span> = data
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> userStore = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserStore</span>()

<span class="hljs-comment">// 在组件中使用</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">UserProfile</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> snap = <span class="hljs-title function_">useSnapshot</span>(userStore)
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>{snap.user.name} - {snap.user.age}岁<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> userStore.updateName('李四')}&gt;
        改名
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{snap.incrementAge}</span>&gt;</span>
        增加年龄
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<h3 data-id="heading-7">场景三:推荐使用 Class 风格 ⭐</h3>
<p><strong>为什么推荐 Class?</strong></p>
<ul>
<li>✅ <strong>类型自动推导</strong> - 不需要手动定义类型</li>
<li>✅ <strong>代码组织清晰</strong> - 方法和状态在一起</li>
<li>✅ <strong>更符合 OOP 思维</strong> - 类似 Pinia 的 setup store 语法</li>
</ul>
<p><strong>Pinia Setup Store 写法:</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { defineStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>
<span class="hljs-keyword">import</span> { ref, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useCounterStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'counter'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// state</span>
  <span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)
  <span class="hljs-keyword">const</span> user = <span class="hljs-title function_">ref</span>({
    <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>,
    <span class="hljs-attr">age</span>: <span class="hljs-number">25</span>
  })
  
  <span class="hljs-comment">// getters</span>
  <span class="hljs-keyword">const</span> doubleCount = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> count.<span class="hljs-property">value</span> * <span class="hljs-number">2</span>)
  
  <span class="hljs-comment">// actions</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">increment</span>(<span class="hljs-params"/>) {
    count.<span class="hljs-property">value</span>++
  }
  
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">decrement</span>(<span class="hljs-params"/>) {
    count.<span class="hljs-property">value</span>--
  }
  
  <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchUserAsync</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">1000</span>))
    user.<span class="hljs-property">value</span>.<span class="hljs-property">age</span>++
  }
  
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">updateUser</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span>, age: <span class="hljs-built_in">number</span></span>) {
    user.<span class="hljs-property">value</span>.<span class="hljs-property">name</span> = name
    user.<span class="hljs-property">value</span>.<span class="hljs-property">age</span> = age
  }
  
  <span class="hljs-keyword">return</span> {
    count,
    user,
    doubleCount,
    increment,
    decrement,
    fetchUserAsync,
    updateUser
  }
})
</code></pre>
<p><strong>Valtio Class 写法 (更简洁):</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { proxy } <span class="hljs-keyword">from</span> <span class="hljs-string">'valtio'</span>

<span class="hljs-comment">// 辅助函数:绑定方法的 this</span>
<span class="hljs-keyword">function</span> bind&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">object</span>&gt;(<span class="hljs-attr">instance</span>: T): T {
  <span class="hljs-keyword">const</span> obj = instance <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>
  <span class="hljs-keyword">const</span> names = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getOwnPropertyNames</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getPrototypeOf</span>(obj))

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> name <span class="hljs-keyword">of</span> names) {
    <span class="hljs-keyword">const</span> method = obj[name]
    <span class="hljs-keyword">if</span> (name === <span class="hljs-string">'constructor'</span> || <span class="hljs-keyword">typeof</span> method !== <span class="hljs-string">'function'</span>) <span class="hljs-keyword">continue</span>
    obj[name] = <span class="hljs-function">(<span class="hljs-params">...args: <span class="hljs-built_in">unknown</span>[]</span>) =&gt;</span> method.<span class="hljs-title function_">apply</span>(instance, args)
  }
  <span class="hljs-keyword">return</span> instance
}

<span class="hljs-comment">// 基类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ValtioStore</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">bind</span>(<span class="hljs-title function_">proxy</span>(<span class="hljs-variable language_">this</span>))
  }
}

<span class="hljs-comment">// 你的状态类 - 无需定义类型!</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CounterStore</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">ValtioStore</span> {
  count = <span class="hljs-number">0</span>  <span class="hljs-comment">// TypeScript 自动推导为 number</span>
  user = {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>,
    <span class="hljs-attr">age</span>: <span class="hljs-number">25</span>
  }  <span class="hljs-comment">// 自动推导嵌套对象类型</span>
  
  <span class="hljs-comment">// getter - 类似 Pinia 的 computed</span>
  <span class="hljs-keyword">get</span> <span class="hljs-title function_">doubleCount</span>() {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span> * <span class="hljs-number">2</span>
  }

  <span class="hljs-title function_">increment</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>++  <span class="hljs-comment">// this 指向正确,类型安全!</span>
  }

  <span class="hljs-title function_">decrement</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>--
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">fetchUserAsync</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 支持异步方法</span>
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">1000</span>))
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">user</span>.<span class="hljs-property">age</span>++
  }

  <span class="hljs-title function_">updateUser</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span>, age: <span class="hljs-built_in">number</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">user</span>.<span class="hljs-property">name</span> = name
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">user</span>.<span class="hljs-property">age</span> = age
  }
}

<span class="hljs-comment">// 导出单例</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> counterStore = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CounterStore</span>()

<span class="hljs-comment">// TypeScript 会自动推导出完整类型:</span>
<span class="hljs-comment">// counterStore.count: number</span>
<span class="hljs-comment">// counterStore.user: { name: string, age: number }</span>
<span class="hljs-comment">// counterStore.doubleCount: number (getter)</span>
<span class="hljs-comment">// counterStore.increment: () =&gt; void</span>
</code></pre>
<p><strong>在组件中使用:</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { useSnapshot } <span class="hljs-keyword">from</span> <span class="hljs-string">'valtio'</span>
<span class="hljs-keyword">import</span> { counterStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'./stores/counter'</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> snap = <span class="hljs-title function_">useSnapshot</span>(counterStore)
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>{snap.count}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>双倍: {snap.doubleCount}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{snap.user.name} - {snap.user.age}岁<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{snap.increment}</span>&gt;</span>+1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{snap.decrement}</span>&gt;</span>-1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{snap.fetchUserAsync}</span>&gt;</span>增加年龄<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<p><strong>对比 Pinia 和对象风格的优势:</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// ❌ Pinia:需要 ref/reactive 包装,return 暴露</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'store'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)
  <span class="hljs-keyword">const</span> user = <span class="hljs-title function_">ref</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">25</span> })
  
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">increment</span>(<span class="hljs-params"/>) { count.<span class="hljs-property">value</span>++ }
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">decrement</span>(<span class="hljs-params"/>) { count.<span class="hljs-property">value</span>-- }
  
  <span class="hljs-keyword">return</span> { count, user, increment, decrement }
})

<span class="hljs-comment">// ❌ Valtio 对象风格:需要手动定义类型</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">State</span> {
  <span class="hljs-attr">count</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">user</span>: { <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>; <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span> }
  <span class="hljs-attr">increment</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>
  <span class="hljs-attr">decrement</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>
}

<span class="hljs-keyword">const</span> <span class="hljs-attr">state</span>: <span class="hljs-title class_">State</span> = <span class="hljs-title function_">proxy</span>({
  <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">user</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">25</span> },
  <span class="hljs-title function_">increment</span>(<span class="hljs-params"/>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>++ },
  <span class="hljs-title function_">decrement</span>(<span class="hljs-params"/>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>-- }
})

<span class="hljs-comment">// ✅ Valtio Class 风格:类型自动推导,代码更简洁</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CounterStore</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">ValtioStore</span> {
  count = <span class="hljs-number">0</span>
  user = { <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">25</span> }
  
  <span class="hljs-title function_">increment</span>(<span class="hljs-params"/>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>++ }
  <span class="hljs-title function_">decrement</span>(<span class="hljs-params"/>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>-- }
}
</code></pre>
<h2 data-id="heading-8">性能优化:和 Vue 一样智能</h2>
<h3 data-id="heading-9">Vue 的性能特点:</h3>
<ul>
<li>自动追踪依赖,只更新用到的组件</li>
<li>深层对象变化也能精确响应</li>
</ul>
<h3 data-id="heading-10">Valtio 的性能特点:</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 父组件</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> snap = <span class="hljs-title function_">useSnapshot</span>(state)
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Counter</span> /&gt;</span>      {/* 只在 count 变化时重渲染 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">UserInfo</span> /&gt;</span>     {/* 只在 user 变化时重渲染 */}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}

<span class="hljs-comment">// 子组件 1 - 只使用 count</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> snap = <span class="hljs-title function_">useSnapshot</span>(state)
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{snap.count}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>  <span class="hljs-comment">// 只订阅 count</span>
}

<span class="hljs-comment">// 子组件 2 - 只使用 user</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">UserInfo</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> snap = <span class="hljs-title function_">useSnapshot</span>(state)
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{snap.user.name}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>  <span class="hljs-comment">// 只订阅 user.name</span>
}
</code></pre>
<p><strong>关键点:</strong> 当 <code>state.count</code> 改变时,<code>UserInfo</code> 组件<strong>不会重新渲染</strong>,这和 Vue 的响应式系统行为一致!</p>
<h2 data-id="heading-11">监听状态变化 (类似 Vue 的 watch 和 Pinia 的 $subscribe)</h2>
<p><strong>Vue 的 watch:</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { reactive, watch } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> state = <span class="hljs-title function_">reactive</span>({ <span class="hljs-attr">count</span>: <span class="hljs-number">0</span> })

<span class="hljs-title function_">watch</span>(<span class="hljs-function">() =&gt;</span> state.<span class="hljs-property">count</span>, <span class="hljs-function">(<span class="hljs-params">newVal, oldVal</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`count 从 <span class="hljs-subst">${oldVal}</span> 变为 <span class="hljs-subst">${newVal}</span>`</span>)
})
</code></pre>
<p><strong>Pinia 的 $subscribe:</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { defineStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>

<span class="hljs-keyword">const</span> useStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'counter'</span>, {
  <span class="hljs-attr">state</span>: <span class="hljs-function">() =&gt;</span> ({ <span class="hljs-attr">count</span>: <span class="hljs-number">0</span> })
})

<span class="hljs-keyword">const</span> store = <span class="hljs-title function_">useStore</span>()

<span class="hljs-comment">// 订阅整个 store 的变化</span>
store.$subscribe(<span class="hljs-function">(<span class="hljs-params">mutation, state</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'状态变化了:'</span>, state.<span class="hljs-property">count</span>)
})
</code></pre>
<p><strong>Valtio 的 subscribe:</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { proxy, subscribe } <span class="hljs-keyword">from</span> <span class="hljs-string">'valtio'</span>

<span class="hljs-keyword">const</span> state = <span class="hljs-title function_">proxy</span>({ <span class="hljs-attr">count</span>: <span class="hljs-number">0</span> })

<span class="hljs-keyword">const</span> unsubscribe = <span class="hljs-title function_">subscribe</span>(state, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'状态改变了:'</span>, state.<span class="hljs-property">count</span>)
})

<span class="hljs-comment">// 取消订阅</span>
<span class="hljs-title function_">unsubscribe</span>()
</code></pre>
<p><strong>在 React 组件中使用:</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Logger</span>(<span class="hljs-params"/>) {
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> unsub = <span class="hljs-title function_">subscribe</span>(counterStore, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'状态变化:'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(counterStore))
    })
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">unsub</span>()  <span class="hljs-comment">// 组件卸载时清理</span>
  }, [])
  
  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
}
</code></pre>
<h2 data-id="heading-12">Valtio vs Zustand vs Pinia:该选哪个?</h2>
<p>从 Vue/Pinia 过来的开发者,我建议<strong>优先选择 Valtio</strong>,原因如下:</p>
<h3 data-id="heading-13">Valtio 的优势 (最像 Vue/Pinia):</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// ✅ 直接修改,符合 Vue/Pinia 习惯</span>
counterStore.<span class="hljs-property">count</span>++
counterStore.<span class="hljs-property">user</span>.<span class="hljs-property">name</span> = <span class="hljs-string">'Bob'</span>

<span class="hljs-comment">// 或者用方法</span>
counterStore.<span class="hljs-title function_">increment</span>()
</code></pre>
<h3 data-id="heading-14">Pinia 的写法:</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// Pinia 在 Vue 中</span>
<span class="hljs-keyword">const</span> store = <span class="hljs-title function_">useCounterStore</span>()
store.<span class="hljs-property">count</span>++  <span class="hljs-comment">// 可以直接修改</span>
store.<span class="hljs-title function_">increment</span>()  <span class="hljs-comment">// 或调用 action</span>
</code></pre>
<h3 data-id="heading-15">Zustand 的写法 (更像 Redux):</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// ❌ 需要调用 set 函数,不够直观</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">CounterState</span> {
  <span class="hljs-attr">count</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">increment</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>
}

<span class="hljs-keyword">const</span> useStore = create&lt;<span class="hljs-title class_">CounterState</span>&gt;(<span class="hljs-function"><span class="hljs-params">set</span> =&gt;</span> ({
  <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">increment</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">set</span>(<span class="hljs-function"><span class="hljs-params">state</span> =&gt;</span> ({ <span class="hljs-attr">count</span>: state.<span class="hljs-property">count</span> + <span class="hljs-number">1</span> }))
}))
</code></pre>
<h3 data-id="heading-16">三者对比表格</h3>





















































<table><thead><tr><th>特性</th><th>Pinia</th><th>Valtio</th><th>Zustand</th></tr></thead><tbody><tr><td>可变状态</td><td>✅ 是</td><td>✅ 是</td><td>❌ 否 (不可变)</td></tr><tr><td>学习曲线</td><td>低 (Vue 开发者)</td><td>低 (类似 Pinia)</td><td>中等</td></tr><tr><td>TypeScript</td><td>✅ 优秀</td><td>✅ 优秀 (Class 自动推导)</td><td>✅ 优秀</td></tr><tr><td>DevTools</td><td>✅ Vue DevTools</td><td>✅ 支持</td><td>✅ Redux DevTools</td></tr><tr><td>中间件</td><td>✅ Plugins</td><td>⚠️ 较少</td><td>✅ 丰富</td></tr><tr><td>Class 支持</td><td>⚠️ Setup Store</td><td>✅ 原生支持</td><td>❌ 不推荐</td></tr><tr><td>生态系统</td><td>大 (Vue)</td><td>中等</td><td>大 (React)</td></tr></tbody></table>
<p><strong>但是</strong>,如果你需要以下功能,可以考虑 Zustand:</p>
<ul>
<li>中间件支持 (持久化、日志等)</li>
<li>选择器优化 (精确控制订阅)</li>
<li>更大的社区和生态</li>
</ul>
<p><strong>Valtio vs Pinia 的核心区别:</strong></p>
<ul>
<li>Pinia 需要在 Vue 组件中使用 <code>useStore()</code> hook</li>
<li>Valtio 的 store 是全局单例,可以在任何地方使用</li>
<li>Pinia 有 Vue DevTools 集成</li>
<li>Valtio 更轻量,没有框架绑定</li>
</ul>
<h2 data-id="heading-17">最佳实践总结</h2>
<h3 data-id="heading-18">1. 组件分离 (类似 Vue 的组件化思想)</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// ❌ 不好:所有逻辑混在一起</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> snap = <span class="hljs-title function_">useSnapshot</span>(counterStore)
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{snap.count}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{snap.increment}</span>&gt;</span>+<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}

<span class="hljs-comment">// ✅ 好:控制和展示分离</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> snap = <span class="hljs-title function_">useSnapshot</span>(counterStore)
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>{snap.count}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Controls</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> snap = <span class="hljs-title function_">useSnapshot</span>(counterStore)
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{snap.increment}</span>&gt;</span>+<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{snap.decrement}</span>&gt;</span>-<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<h3 data-id="heading-19">2. 状态模块化 (推荐 Class 方式)</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// stores/counter.ts</span>
<span class="hljs-keyword">import</span> { proxy } <span class="hljs-keyword">from</span> <span class="hljs-string">'valtio'</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ValtioStore</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">bind</span>(<span class="hljs-title function_">proxy</span>(<span class="hljs-variable language_">this</span>))
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CounterStore</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">ValtioStore</span> {
  count = <span class="hljs-number">0</span>
  
  <span class="hljs-title function_">increment</span>(<span class="hljs-params"/>) { 
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>++ 
  }
  
  <span class="hljs-title function_">decrement</span>(<span class="hljs-params"/>) { 
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>-- 
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> counterStore = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CounterStore</span>()
</code></pre>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// stores/user.ts</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">email</span>: <span class="hljs-built_in">string</span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserStore</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">ValtioStore</span> {
  <span class="hljs-attr">user</span>: <span class="hljs-title class_">User</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>
  loading = <span class="hljs-literal">false</span>
  
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">login</span>(<span class="hljs-params">username: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span> = <span class="hljs-literal">true</span>
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">login</span>(username)
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">user</span> = user
    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span> = <span class="hljs-literal">false</span>
    }
  }
  
  <span class="hljs-title function_">logout</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">user</span> = <span class="hljs-literal">null</span>
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> userStore = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserStore</span>()
</code></pre>
<h3 data-id="heading-20">3. 读用 snap,写用原始 store</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { counterStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'./stores/counter'</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Component</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> snap = <span class="hljs-title function_">useSnapshot</span>(counterStore)  <span class="hljs-comment">// ✅ 读取用 snap</span>
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{snap.count}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>                    {/* 读 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{counterStore.increment}</span>&gt;</span>  {/* 写 - 直接用 store */}
        增加
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      {/* 或者用 snap 的方法也可以 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{snap.decrement}</span>&gt;</span>
        减少
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<h2 data-id="heading-21">总结</h2>
<p>从 Vue/Pinia 切换到 React,选择 Valtio 可以让你:</p>
<ul>
<li>✅ <strong>保持熟悉的可变状态写法</strong> - 和 Vue reactive/Pinia 一样直观</li>
<li>✅ <strong>享受类似 Vue 的响应式体验</strong> - 自动依赖追踪</li>
<li>✅ <strong>Class 风格减少类型定义</strong> - 类似 Pinia Setup Store,但更简洁</li>
<li>✅ <strong>减少学习曲线,快速上手</strong> - 从 Pinia 迁移几乎无缝</li>
<li>✅ <strong>获得优秀的性能表现</strong> - 精确的响应式更新</li>
</ul>
<h3 data-id="heading-22">Vue/Pinia → Valtio 迁移速查表</h3>













































<table><thead><tr><th>Pinia</th><th>Valtio</th><th>说明</th></tr></thead><tbody><tr><td><code>defineStore()</code></td><td><code>class extends ValtioStore</code></td><td>定义 store</td></tr><tr><td><code>state: () =&gt; ({})</code></td><td><code>count = 0</code></td><td>定义状态</td></tr><tr><td><code>actions: {}</code></td><td>类方法</td><td>定义操作</td></tr><tr><td><code>getters: {}</code></td><td><code>get xxx()</code></td><td>计算属性</td></tr><tr><td><code>useStore()</code></td><td><code>useSnapshot(store)</code></td><td>在组件中使用</td></tr><tr><td><code>store.$subscribe()</code></td><td><code>subscribe(store)</code></td><td>监听变化</td></tr><tr><td><code>storeToRefs(store)</code></td><td><code>useSnapshot(store)</code></td><td>响应式引用</td></tr></tbody></table>
<p>如果你习惯了 Vue 的 <code>reactive()</code> 和 Pinia 的状态管理,那么 Valtio 的 <code>proxy()</code> 和 Class 写法会让你感到宾至如归。不需要重新学习完全不同的状态管理思维,就能在 React 中高效开发。</p>
<p>现在就开始你的 Valtio 之旅吧!🚀</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[springboot+redis 如何实现订单的过期]]></title>    <link>https://juejin.cn/post/7582553782398533678</link>    <guid>https://juejin.cn/post/7582553782398533678</guid>    <pubDate>2025-12-12T06:17:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582553782398533678" data-draft-id="7582599972949966875" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="springboot+redis 如何实现订单的过期"/> <meta itemprop="keywords" content="后端,Java,架构"/> <meta itemprop="datePublished" content="2025-12-12T06:17:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT界Tony哥"/> <meta itemprop="url" content="https://juejin.cn/user/3157453122578087"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            springboot+redis 如何实现订单的过期
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3157453122578087/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT界Tony哥
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T06:17:44.000Z" title="Fri Dec 12 2025 06:17:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在Spring Boot中使用Redis实现订单过期（超时取消）功能，有多种成熟方案。以下是完整的实现方案：</p>
<h2 data-id="heading-0">一、Redis键过期回调方案（推荐）</h2>
<h3 data-id="heading-1">1. 配置Redis监听器</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisKeyExpirationConfig</span> {
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> RedisMessageListenerContainer <span class="hljs-title function_">redisMessageListenerContainer</span><span class="hljs-params">(
            RedisConnectionFactory connectionFactory)</span> {
        <span class="hljs-type">RedisMessageListenerContainer</span> <span class="hljs-variable">container</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisMessageListenerContainer</span>();
        container.setConnectionFactory(connectionFactory);
        <span class="hljs-keyword">return</span> container;
    }
}
</code></pre>
<h3 data-id="heading-2">2. 监听键过期事件</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderExpirationListener</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final <span class="hljs-title class_">String</span> <span class="hljs-variable constant_">ORDER_KEY_PREFIX</span> = <span class="hljs-string">"order:"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final <span class="hljs-title class_">String</span> <span class="hljs-variable constant_">ORDER_EXPIRE_KEY_PREFIX</span> = <span class="hljs-string">"order:expire:"</span>;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">RedisTemplate</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Object</span>&gt; redisTemplate;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">OrderService</span> orderService;
    
    <span class="hljs-comment">/**
     * 监听所有键过期事件
     */</span>
    <span class="hljs-meta">@EventListener</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">handleKeyExpiredEvent</span>(<span class="hljs-params">KeyExpiredEvent&lt;<span class="hljs-built_in">String</span>&gt; event</span>) {
        <span class="hljs-title class_">String</span> expiredKey = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(event.<span class="hljs-title function_">getSource</span>());
        
        <span class="hljs-keyword">if</span> (expiredKey.<span class="hljs-title function_">startsWith</span>(<span class="hljs-variable constant_">ORDER_EXPIRE_KEY_PREFIX</span>)) {
            <span class="hljs-title class_">String</span> orderId = expiredKey.<span class="hljs-title function_">substring</span>(<span class="hljs-variable constant_">ORDER_EXPIRE_KEY_PREFIX</span>.<span class="hljs-title function_">length</span>());
            <span class="hljs-title function_">handleOrderExpired</span>(orderId);
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">handleOrderExpired</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> orderId</span>) {
        log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"检测到订单过期: {}"</span>, orderId);
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 异步处理，避免阻塞Redis监听线程</span>
            <span class="hljs-title class_">CompletableFuture</span>.<span class="hljs-title function_">runAsync</span>(() -&gt; {
                <span class="hljs-built_in">boolean</span> result = orderService.<span class="hljs-title function_">cancelExpiredOrder</span>(orderId);
                <span class="hljs-keyword">if</span> (result) {
                    log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"订单 {} 已成功取消"</span>, orderId);
                } <span class="hljs-keyword">else</span> {
                    log.<span class="hljs-title function_">warn</span>(<span class="hljs-string">"订单 {} 取消失败或已处理"</span>, orderId);
                }
            });
        } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">Exception</span> e) {
            log.<span class="hljs-title function_">error</span>(<span class="hljs-string">"处理订单过期异常: {}"</span>, orderId, e);
        }
    }
}
</code></pre>
<h3 data-id="heading-3">3. Redis配置（开启键空间通知）</h3>
<p>在Redis配置文件<code>redis.conf</code>中开启键空间通知：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 开启键空间通知</span>
notify-keyspace-events Ex

<span class="hljs-comment"># 或者开启所有事件</span>
<span class="hljs-comment"># notify-keyspace-events AKE</span>
</code></pre>
<p>Spring Boot配置：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">redis:</span>
    <span class="hljs-attr">host:</span> <span class="hljs-string">localhost</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">6379</span>
    <span class="hljs-attr">database:</span> <span class="hljs-number">0</span>
    <span class="hljs-comment"># 监听键过期事件</span>
    <span class="hljs-attr">listen-patterns:</span> <span class="hljs-string">"__keyevent@*__:expired"</span>
</code></pre>
<h2 data-id="heading-4">二、延时队列方案（Redisson实现）</h2>
<h3 data-id="heading-5">1. 添加Redisson依赖</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.redisson<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>redisson-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.23.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h3 data-id="heading-6">2. 使用Redisson延时队列</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderDelayQueueService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">RedissonClient</span> redissonClient;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">OrderService</span> orderService;
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final <span class="hljs-title class_">String</span> <span class="hljs-variable constant_">DELAY_QUEUE_NAME</span> = <span class="hljs-string">"order:delay:queue"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final <span class="hljs-title class_">String</span> <span class="hljs-variable constant_">PROCESSING_SET</span> = <span class="hljs-string">"order:delay:processing"</span>;
    
    <span class="hljs-comment">/**
     * 添加订单到延时队列
     * <span class="hljs-doctag">@param</span> orderId 订单ID
     * <span class="hljs-doctag">@param</span> delayTime 延时时间（分钟）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">addToDelayQueue</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> orderId, long delayTime</span>) {
        <span class="hljs-title class_">RBlockingQueue</span>&lt;<span class="hljs-title class_">String</span>&gt; blockingQueue = redissonClient
            .<span class="hljs-title function_">getBlockingQueue</span>(<span class="hljs-variable constant_">DELAY_QUEUE_NAME</span>);
        <span class="hljs-title class_">RDelayedQueue</span>&lt;<span class="hljs-title class_">String</span>&gt; delayedQueue = redissonClient
            .<span class="hljs-title function_">getDelayedQueue</span>(blockingQueue);
        
        <span class="hljs-comment">// 添加到延时队列</span>
        delayedQueue.<span class="hljs-title function_">offer</span>(orderId, delayTime, <span class="hljs-title class_">TimeUnit</span>.<span class="hljs-property">MINUTES</span>);
        
        log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"订单 {} 已添加到延时队列，将在 {} 分钟后过期"</span>, orderId, delayTime);
    }
    
    <span class="hljs-comment">/**
     * 启动延时队列消费者
     */</span>
    <span class="hljs-meta">@PostConstruct</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">startDelayQueueConsumer</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(<span class="hljs-attr">this</span>::consumeDelayQueue, <span class="hljs-string">"delay-queue-consumer"</span>).<span class="hljs-title function_">start</span>();
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">consumeDelayQueue</span>(<span class="hljs-params"/>) {
        <span class="hljs-title class_">RBlockingQueue</span>&lt;<span class="hljs-title class_">String</span>&gt; blockingQueue = redissonClient
            .<span class="hljs-title function_">getBlockingQueue</span>(<span class="hljs-variable constant_">DELAY_QUEUE_NAME</span>);
        
        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 从队列中取出过期的订单</span>
                <span class="hljs-title class_">String</span> orderId = blockingQueue.<span class="hljs-title function_">take</span>();
                
                <span class="hljs-comment">// 处理订单过期</span>
                <span class="hljs-title function_">processExpiredOrder</span>(orderId);
                
            } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">InterruptedException</span> e) {
                <span class="hljs-title class_">Thread</span>.<span class="hljs-title function_">currentThread</span>().<span class="hljs-title function_">interrupt</span>();
                log.<span class="hljs-title function_">error</span>(<span class="hljs-string">"延时队列消费线程被中断"</span>, e);
                <span class="hljs-keyword">break</span>;
            } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">Exception</span> e) {
                log.<span class="hljs-title function_">error</span>(<span class="hljs-string">"处理延时队列消息异常"</span>, e);
            }
        }
    }
    
    <span class="hljs-comment">/**
     * 处理过期订单
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">processExpiredOrder</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> orderId</span>) {
        <span class="hljs-title class_">RSet</span>&lt;<span class="hljs-title class_">String</span>&gt; processingSet = redissonClient.<span class="hljs-title function_">getSet</span>(<span class="hljs-variable constant_">PROCESSING_SET</span>);
        
        <span class="hljs-comment">// 使用set防止重复处理</span>
        <span class="hljs-keyword">if</span> (processingSet.<span class="hljs-title function_">add</span>(orderId)) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-built_in">boolean</span> result = orderService.<span class="hljs-title function_">cancelExpiredOrder</span>(orderId);
                <span class="hljs-keyword">if</span> (result) {
                    log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"延时队列：订单 {} 已过期取消"</span>, orderId);
                } <span class="hljs-keyword">else</span> {
                    log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"延时队列：订单 {} 无需处理"</span>, orderId);
                }
            } <span class="hljs-keyword">finally</span> {
                processingSet.<span class="hljs-title function_">remove</span>(orderId);
            }
        }
    }
}
</code></pre>
<h2 data-id="heading-7">三、ZSet有序集合方案</h2>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderExpireZSetService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">StringRedisTemplate</span> redisTemplate;
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final <span class="hljs-title class_">String</span> <span class="hljs-variable constant_">ORDER_EXPIRE_ZSET</span> = <span class="hljs-string">"order:expire:zset"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final <span class="hljs-title class_">String</span> <span class="hljs-variable constant_">ORDER_PROCESSING_SET</span> = <span class="hljs-string">"order:processing:set"</span>;
    
    <span class="hljs-comment">/**
     * 添加订单到过期集合
     * <span class="hljs-doctag">@param</span> orderId 订单ID
     * <span class="hljs-doctag">@param</span> expireTime 过期时间戳
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">addOrderToExpireSet</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> orderId, long expireTime</span>) {
        redisTemplate.<span class="hljs-title function_">opsForZSet</span>().<span class="hljs-title function_">add</span>(<span class="hljs-variable constant_">ORDER_EXPIRE_ZSET</span>, orderId, expireTime);
        log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"订单 {} 已添加到过期集合，过期时间: {}"</span>, orderId, 
                 <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(expireTime));
    }
    
    <span class="hljs-comment">/**
     * 批量扫描过期订单
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">scanExpiredOrders</span>(<span class="hljs-params"/>) {
        long now = <span class="hljs-title class_">System</span>.<span class="hljs-title function_">currentTimeMillis</span>();
        
        <span class="hljs-comment">// 获取已过期的订单</span>
        <span class="hljs-title class_">Set</span>&lt;<span class="hljs-title class_">String</span>&gt; expiredOrders = redisTemplate.<span class="hljs-title function_">opsForZSet</span>()
            .<span class="hljs-title function_">rangeByScore</span>(<span class="hljs-variable constant_">ORDER_EXPIRE_ZSET</span>, <span class="hljs-number">0</span>, now);
        
        <span class="hljs-keyword">if</span> (expiredOrders != <span class="hljs-literal">null</span> &amp;&amp; !expiredOrders.<span class="hljs-title function_">isEmpty</span>()) {
            <span class="hljs-keyword">for</span> (<span class="hljs-title class_">String</span> orderId : expiredOrders) {
                <span class="hljs-title function_">processExpiredOrder</span>(orderId);
            }
            
            <span class="hljs-comment">// 移除已处理的订单</span>
            redisTemplate.<span class="hljs-title function_">opsForZSet</span>().<span class="hljs-title function_">removeRangeByScore</span>(
                <span class="hljs-variable constant_">ORDER_EXPIRE_ZSET</span>, <span class="hljs-number">0</span>, now);
        }
    }
    
    <span class="hljs-comment">/**
     * 定时扫描任务
     */</span>
    <span class="hljs-meta">@Scheduled</span>(fixedDelay = <span class="hljs-number">30000</span>) <span class="hljs-comment">// 每30秒执行一次</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">scheduledScan</span>(<span class="hljs-params"/>) {
        log.<span class="hljs-title function_">debug</span>(<span class="hljs-string">"开始扫描过期订单"</span>);
        <span class="hljs-title function_">scanExpiredOrders</span>();
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">processExpiredOrder</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> orderId</span>) {
        <span class="hljs-comment">// 使用setnx防止重复处理</span>
        <span class="hljs-title class_">Boolean</span> success = redisTemplate.<span class="hljs-title function_">opsForValue</span>()
            .<span class="hljs-title function_">setIfAbsent</span>(<span class="hljs-variable constant_">ORDER_PROCESSING_SET</span> + <span class="hljs-string">":"</span> + orderId, <span class="hljs-string">"1"</span>, <span class="hljs-number">5</span>, <span class="hljs-title class_">TimeUnit</span>.<span class="hljs-property">MINUTES</span>);
        
        <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Boolean</span>.<span class="hljs-property">TRUE</span>.<span class="hljs-title function_">equals</span>(success)) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 处理订单过期逻辑</span>
                <span class="hljs-title function_">handleOrderExpired</span>(orderId);
            } <span class="hljs-keyword">finally</span> {
                <span class="hljs-comment">// 清理处理标记</span>
                redisTemplate.<span class="hljs-title function_">delete</span>(<span class="hljs-variable constant_">ORDER_PROCESSING_SET</span> + <span class="hljs-string">":"</span> + orderId);
            }
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">handleOrderExpired</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> orderId</span>) {
        <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> 实现订单过期处理逻辑</span>
        log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"处理过期订单: {}"</span>, orderId);
    }
}
</code></pre>
<h2 data-id="heading-8">四、完整订单服务实现</h2>
<h3 data-id="heading-9">1. 订单状态枚举</h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">OrderStatus</span> {
    
    <span class="hljs-built_in">PENDING_PAYMENT</span>(<span class="hljs-number">0</span>, <span class="hljs-string">"待支付"</span>),
    <span class="hljs-built_in">PAID</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"已支付"</span>),
    <span class="hljs-built_in">COMPLETED</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"已完成"</span>),
    <span class="hljs-built_in">CANCELLED</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"已取消"</span>),
    <span class="hljs-built_in">EXPIRED</span>(<span class="hljs-number">4</span>, <span class="hljs-string">"已过期"</span>);
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> code;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> description;
    
    <span class="hljs-built_in">OrderStatus</span>(<span class="hljs-type">int</span> code, <span class="hljs-type">String</span> description) {
        <span class="hljs-keyword">this</span>.code = code;
        <span class="hljs-keyword">this</span>.description = description;
    }
    
    <span class="hljs-comment">// getter方法省略</span>
}
</code></pre>
<h3 data-id="heading-10">2. 订单实体</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Data</span>
<span class="hljs-variable">@Entity</span>
<span class="hljs-variable">@Table</span>(name = <span class="hljs-string">"t_order"</span>)
public class Order {
    
    <span class="hljs-variable">@Id</span>
    <span class="hljs-variable">@GeneratedValue</span>(strategy = GenerationType.IDENTITY)
    private Long id;
    
    <span class="hljs-variable">@Column</span>(unique = true)
    private String orderNo;
    
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">Long</span> <span class="hljs-selector-tag">userId</span>;
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">BigDecimal</span> <span class="hljs-selector-tag">amount</span>;
    
    @<span class="hljs-selector-tag">Enumerated</span>(EnumType.ORDINAL)
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">OrderStatus</span> <span class="hljs-selector-tag">status</span> = <span class="hljs-selector-tag">OrderStatus</span><span class="hljs-selector-class">.PENDING_PAYMENT</span>;
    
    @<span class="hljs-selector-tag">Column</span>(name = <span class="hljs-string">"expire_time"</span>)
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">LocalDateTime</span> <span class="hljs-selector-tag">expireTime</span>;
    
    @<span class="hljs-selector-tag">Column</span>(name = <span class="hljs-string">"create_time"</span>)
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">LocalDateTime</span> <span class="hljs-selector-tag">createTime</span> = <span class="hljs-selector-tag">LocalDateTime</span><span class="hljs-selector-class">.now</span>();
    
    @<span class="hljs-selector-tag">Column</span>(name = <span class="hljs-string">"update_time"</span>)
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">LocalDateTime</span> <span class="hljs-selector-tag">updateTime</span> = <span class="hljs-selector-tag">LocalDateTime</span><span class="hljs-selector-class">.now</span>();
    
    <span class="hljs-comment">/**
     * 判断订单是否已过期
     */</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">boolean</span> <span class="hljs-selector-tag">isExpired</span>() {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">LocalDateTime</span><span class="hljs-selector-class">.now</span>()<span class="hljs-selector-class">.isAfter</span>(expireTime) 
            <span class="hljs-selector-tag">&amp;</span><span class="hljs-selector-tag">&amp;</span> <span class="hljs-selector-tag">status</span> == <span class="hljs-selector-tag">OrderStatus</span><span class="hljs-selector-class">.PENDING_PAYMENT</span>;
    }
}
</code></pre>
<h3 data-id="heading-11">3. 订单服务实现</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Service</span>
<span class="hljs-keyword">@Slf</span>4j
<span class="hljs-keyword">@Transactional</span>
public class OrderService {
    
    <span class="hljs-keyword">@Autowired</span>
    private OrderRepository orderRepository;
    
    <span class="hljs-keyword">@Autowired</span>
    private StringRedisTemplate redisTemplate;
    
    <span class="hljs-keyword">@Autowired</span>
    private OrderDelayQueueService delayQueueService;
    
    <span class="hljs-keyword">@Autowired</span>
    private OrderExpireZSetService zSetService;
    
    <span class="hljs-keyword">@Autowired</span>
    private ApplicationEventPublisher eventPublisher;
    
    private static final String ORDER_LOCK_PREFIX = "<span class="hljs-attribute">order</span>:lock:<span class="hljs-string">";
    private static final String ORDER_EXPIRE_KEY_PREFIX = "</span>order:expire:<span class="hljs-string">";
    private static final int ORDER_EXPIRE_MINUTES = 30; // 30分钟未支付过期
    
    /**
     * 创建订单
     */
    public Order createOrder(Long userId, BigDecimal amount) {
        Order order = new Order();
        order.setOrderNo(generateOrderNo());
        order.setUserId(userId);
        order.setAmount(amount);
        order.setStatus(OrderStatus.PENDING_PAYMENT);
        order.setExpireTime(LocalDateTime.now().plusMinutes(ORDER_EXPIRE_MINUTES));
        
        order = orderRepository.save(order);
        
        // 设置Redis过期
        setOrderExpire(order.getOrderNo());
        
        // 添加到延时队列
        delayQueueService.addToDelayQueue(order.getOrderNo(), ORDER_EXPIRE_MINUTES);
        
        // 添加到ZSet
        zSetService.addOrderToExpireSet(
            order.getOrderNo(), 
            order.getExpireTime().atZone(ZoneId.systemDefault()).toInstant().toEpochMilli()
        );
        
        log.info("</span>创建订单成功: {}, 过期时间: {}", <span class="hljs-attribute">order</span><span class="hljs-selector-class">.getOrderNo</span>(), <span class="hljs-attribute">order</span><span class="hljs-selector-class">.getExpireTime</span>());
        return <span class="hljs-attribute">order</span>;
    }
    
    <span class="hljs-comment">/**
     * 设置Redis键过期
     */</span>
    private void <span class="hljs-built_in">setOrderExpire</span>(String orderNo) {
        String key = ORDER_EXPIRE_KEY_PREFIX + orderNo;
        String value = String<span class="hljs-selector-class">.valueOf</span>(System.currentTimeMillis());
        
        <span class="hljs-comment">// 设置30分钟后过期</span>
        redisTemplate<span class="hljs-selector-class">.opsForValue</span>()<span class="hljs-selector-class">.set</span>(
            key, 
            value, 
            ORDER_EXPIRE_MINUTES, 
            TimeUnit.MINUTES
        );
        
        <span class="hljs-comment">// 同时存储订单信息，用于过期时处理</span>
        Map&lt;String, String&gt; orderInfo = new HashMap&lt;&gt;();
        orderInfo<span class="hljs-selector-class">.put</span>("orderNo", orderNo);
        orderInfo<span class="hljs-selector-class">.put</span>("userId", "<span class="hljs-number">1</span>"); <span class="hljs-comment">// 实际从订单获取</span>
        orderInfo<span class="hljs-selector-class">.put</span>("amount", "<span class="hljs-number">100.00</span>");
        
        redisTemplate<span class="hljs-selector-class">.opsForHash</span>()<span class="hljs-selector-class">.putAll</span>(ORDER_KEY_PREFIX + orderNo, orderInfo);
    }
    
    <span class="hljs-comment">/**
     * 支付成功处理
     */</span>
    public boolean <span class="hljs-built_in">processPayment</span>(String orderNo) {
        <span class="hljs-comment">// 获取分布式锁</span>
        String lockKey = ORDER_LOCK_PREFIX + orderNo;
        Boolean locked = redisTemplate<span class="hljs-selector-class">.opsForValue</span>()
            <span class="hljs-selector-class">.setIfAbsent</span>(lockKey, "<span class="hljs-number">1</span>", <span class="hljs-number">10</span>, TimeUnit.SECONDS);
        
        if (Boolean.FALSE.equals(locked)) {
            throw new <span class="hljs-built_in">RuntimeException</span>("订单处理中，请稍后");
        }
        
        try {
            <span class="hljs-attribute">Order</span> <span class="hljs-attribute">order</span> = orderRepository<span class="hljs-selector-class">.findByOrderNo</span>(orderNo)
                <span class="hljs-selector-class">.orElseThrow</span>(() -&gt; new <span class="hljs-built_in">RuntimeException</span>("订单不存在"));
            
            <span class="hljs-comment">// 检查订单状态</span>
            if (order.getStatus() != OrderStatus<span class="hljs-selector-class">.PENDING_PAYMENT</span>) {
                throw new <span class="hljs-built_in">RuntimeException</span>("订单状态异常: " + order.getStatus());
            }
            
            <span class="hljs-comment">// 检查是否过期</span>
            if (order.isExpired()) {
                <span class="hljs-attribute">order</span><span class="hljs-selector-class">.setStatus</span>(OrderStatus.EXPIRED);
                orderRepository<span class="hljs-selector-class">.save</span>(order);
                throw new <span class="hljs-built_in">RuntimeException</span>("订单已过期");
            }
            
            <span class="hljs-comment">// 更新订单状态</span>
            <span class="hljs-attribute">order</span><span class="hljs-selector-class">.setStatus</span>(OrderStatus.PAID);
            <span class="hljs-attribute">order</span><span class="hljs-selector-class">.setUpdateTime</span>(LocalDateTime.now());
            orderRepository<span class="hljs-selector-class">.save</span>(order);
            
            <span class="hljs-comment">// 移除过期设置</span>
            <span class="hljs-built_in">removeOrderExpire</span>(orderNo);
            
            <span class="hljs-comment">// 发布支付成功事件</span>
            eventPublisher<span class="hljs-selector-class">.publishEvent</span>(new OrderPaidEvent(this, order));
            
            log<span class="hljs-selector-class">.info</span>("订单支付成功: {}", orderNo);
            return true;
            
        } finally {
            <span class="hljs-comment">// 释放锁</span>
            redisTemplate<span class="hljs-selector-class">.delete</span>(lockKey);
        }
    }
    
    <span class="hljs-comment">/**
     * 处理过期订单
     */</span>
    public boolean <span class="hljs-built_in">cancelExpiredOrder</span>(String orderNo) {
        String lockKey = ORDER_LOCK_PREFIX + orderNo;
        Boolean locked = redisTemplate<span class="hljs-selector-class">.opsForValue</span>()
            <span class="hljs-selector-class">.setIfAbsent</span>(lockKey, "<span class="hljs-number">1</span>", <span class="hljs-number">10</span>, TimeUnit.SECONDS);
        
        if (Boolean.FALSE.equals(locked)) {
            return false;
        }
        
        try {
            <span class="hljs-attribute">Order</span> <span class="hljs-attribute">order</span> = orderRepository<span class="hljs-selector-class">.findByOrderNo</span>(orderNo)
                <span class="hljs-selector-class">.orElseThrow</span>(() -&gt; new <span class="hljs-built_in">RuntimeException</span>("订单不存在"));
            
            <span class="hljs-comment">// 双重检查：订单是否仍为待支付状态</span>
            if (order.getStatus() != OrderStatus<span class="hljs-selector-class">.PENDING_PAYMENT</span>) {
                log<span class="hljs-selector-class">.info</span>("订单 {} 状态已变更为 {}，跳过取消", orderNo, order.getStatus());
                return false;
            }
            
            <span class="hljs-comment">// 检查是否真的过期</span>
            if (!order.isExpired()) {
                log<span class="hljs-selector-class">.info</span>("订单 {} 未过期，跳过取消", orderNo);
                return false;
            }
            
            <span class="hljs-comment">// 更新订单状态</span>
            <span class="hljs-attribute">order</span><span class="hljs-selector-class">.setStatus</span>(OrderStatus.EXPIRED);
            <span class="hljs-attribute">order</span><span class="hljs-selector-class">.setUpdateTime</span>(LocalDateTime.now());
            orderRepository<span class="hljs-selector-class">.save</span>(order);
            
            <span class="hljs-comment">// 释放库存等业务逻辑</span>
            <span class="hljs-built_in">releaseStock</span>(order);
            
            <span class="hljs-comment">// 发送通知</span>
            <span class="hljs-built_in">sendExpireNotification</span>(order);
            
            log<span class="hljs-selector-class">.info</span>("订单 {} 已过期取消", orderNo);
            return true;
            
        } finally {
            redisTemplate<span class="hljs-selector-class">.delete</span>(lockKey);
        }
    }
    
    <span class="hljs-comment">/**
     * 移除订单过期设置
     */</span>
    private void <span class="hljs-built_in">removeOrderExpire</span>(String orderNo) {
        <span class="hljs-comment">// 删除过期key</span>
        redisTemplate<span class="hljs-selector-class">.delete</span>(ORDER_EXPIRE_KEY_PREFIX + orderNo);
        
        <span class="hljs-comment">// 从延时队列移除</span>
        <span class="hljs-comment">// 注意：Redisson延时队列不支持直接移除，需要其他方式</span>
        
        <span class="hljs-comment">// 从ZSet移除</span>
        redisTemplate<span class="hljs-selector-class">.opsForZSet</span>()<span class="hljs-selector-class">.remove</span>(ORDER_EXPIRE_ZSET, orderNo);
        
        <span class="hljs-comment">// 删除订单缓存</span>
        redisTemplate<span class="hljs-selector-class">.delete</span>(ORDER_KEY_PREFIX + orderNo);
    }
    
    <span class="hljs-comment">/**
     * 生成订单号
     */</span>
    private String <span class="hljs-built_in">generateOrderNo</span>() {
        <span class="hljs-comment">// 时间戳 + 随机数</span>
        return "ORD" + 
               System<span class="hljs-selector-class">.currentTimeMillis</span>() + 
               String<span class="hljs-selector-class">.format</span>("%<span class="hljs-number">06</span>d", ThreadLocalRandom.current()<span class="hljs-selector-class">.nextInt</span>(<span class="hljs-number">1000000</span>));
    }
    
    private void <span class="hljs-built_in">releaseStock</span>(Order order) {
        <span class="hljs-comment">// 释放库存逻辑</span>
        log<span class="hljs-selector-class">.info</span>("释放订单 {} 的库存", order.getOrderNo());
    }
    
    private void <span class="hljs-built_in">sendExpireNotification</span>(Order order) {
        <span class="hljs-comment">// 发送通知逻辑</span>
        log<span class="hljs-selector-class">.info</span>("发送订单 {} 过期通知", order.getOrderNo());
    }
}
</code></pre>
<h3 data-id="heading-12">4. 订单支付事件</h3>
<pre><code class="hljs language-scala" lang="scala">public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OrderPaidEvent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ApplicationEvent</span> </span>{
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Order</span> order;
    
    public <span class="hljs-type">OrderPaidEvent</span>(<span class="hljs-type">Object</span> source, <span class="hljs-type">Order</span> order) {
        <span class="hljs-keyword">super</span>(source);
        <span class="hljs-keyword">this</span>.order = order;
    }
    
    public <span class="hljs-type">Order</span> getOrder() {
        <span class="hljs-keyword">return</span> order;
    }
}
</code></pre>
<h2 data-id="heading-13">五、多级过期策略（增强版）</h2>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderExpireManager</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">OrderService</span> orderService;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">StringRedisTemplate</span> redisTemplate;
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final <span class="hljs-title class_">String</span> <span class="hljs-variable constant_">ORDER_EXPIRE_ZSET</span> = <span class="hljs-string">"order:expire:zset"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final <span class="hljs-title class_">String</span> <span class="hljs-variable constant_">ORDER_EXPIRE_DELAY_QUEUE</span> = <span class="hljs-string">"order:expire:delay:queue"</span>;
    
    <span class="hljs-comment">/**
     * 三级过期检测策略
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">startExpireMonitor</span>(<span class="hljs-params"/>) {
        <span class="hljs-comment">// 1. Redis键过期事件（实时）</span>
        <span class="hljs-comment">// 2. 定时任务扫描（兜底）</span>
        <span class="hljs-comment">// 3. 延时队列（精确控制）</span>
        
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(<span class="hljs-attr">this</span>::monitorDelayQueue, <span class="hljs-string">"order-expire-monitor"</span>).<span class="hljs-title function_">start</span>();
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(<span class="hljs-attr">this</span>::scheduledScan, <span class="hljs-string">"order-expire-scanner"</span>).<span class="hljs-title function_">start</span>();
    }
    
    <span class="hljs-comment">/**
     * 监控延时队列
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">monitorDelayQueue</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">while</span> (!<span class="hljs-title class_">Thread</span>.<span class="hljs-title function_">currentThread</span>().<span class="hljs-title function_">isInterrupted</span>()) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 从延时队列获取订单</span>
                <span class="hljs-title class_">String</span> orderId = redisTemplate.<span class="hljs-title function_">opsForList</span>()
                    .<span class="hljs-title function_">rightPop</span>(<span class="hljs-variable constant_">ORDER_EXPIRE_DELAY_QUEUE</span>, <span class="hljs-number">1</span>, <span class="hljs-title class_">TimeUnit</span>.<span class="hljs-property">SECONDS</span>);
                
                <span class="hljs-keyword">if</span> (orderId != <span class="hljs-literal">null</span>) {
                    <span class="hljs-title function_">processExpiredOrder</span>(orderId);
                }
            } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">Exception</span> e) {
                log.<span class="hljs-title function_">error</span>(<span class="hljs-string">"监控延时队列异常"</span>, e);
            }
        }
    }
    
    <span class="hljs-comment">/**
     * 定时扫描
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">scheduledScan</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">while</span> (!<span class="hljs-title class_">Thread</span>.<span class="hljs-title function_">currentThread</span>().<span class="hljs-title function_">isInterrupted</span>()) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-title function_">scanExpiredOrders</span>();
                <span class="hljs-title class_">Thread</span>.<span class="hljs-title function_">sleep</span>(<span class="hljs-number">30000</span>); <span class="hljs-comment">// 30秒扫描一次</span>
            } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">InterruptedException</span> e) {
                <span class="hljs-title class_">Thread</span>.<span class="hljs-title function_">currentThread</span>().<span class="hljs-title function_">interrupt</span>();
                <span class="hljs-keyword">break</span>;
            } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">Exception</span> e) {
                log.<span class="hljs-title function_">error</span>(<span class="hljs-string">"定时扫描异常"</span>, e);
            }
        }
    }
    
    <span class="hljs-comment">/**
     * 扫描过期订单
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">scanExpiredOrders</span>(<span class="hljs-params"/>) {
        long now = <span class="hljs-title class_">System</span>.<span class="hljs-title function_">currentTimeMillis</span>();
        <span class="hljs-title class_">Set</span>&lt;<span class="hljs-title class_">String</span>&gt; expiredOrders = redisTemplate.<span class="hljs-title function_">opsForZSet</span>()
            .<span class="hljs-title function_">rangeByScore</span>(<span class="hljs-variable constant_">ORDER_EXPIRE_ZSET</span>, <span class="hljs-number">0</span>, now);
        
        <span class="hljs-keyword">if</span> (expiredOrders != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">for</span> (<span class="hljs-title class_">String</span> orderId : expiredOrders) {
                <span class="hljs-title function_">processExpiredOrder</span>(orderId);
            }
            
            <span class="hljs-comment">// 移除已处理的订单</span>
            redisTemplate.<span class="hljs-title function_">opsForZSet</span>().<span class="hljs-title function_">removeRangeByScore</span>(
                <span class="hljs-variable constant_">ORDER_EXPIRE_ZSET</span>, <span class="hljs-number">0</span>, now);
        }
    }
    
    <span class="hljs-comment">/**
     * 处理过期订单
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">processExpiredOrder</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> orderId</span>) {
        <span class="hljs-comment">// 防重处理</span>
        <span class="hljs-title class_">String</span> lockKey = <span class="hljs-string">"order:expire:process:"</span> + orderId;
        <span class="hljs-title class_">Boolean</span> locked = redisTemplate.<span class="hljs-title function_">opsForValue</span>()
            .<span class="hljs-title function_">setIfAbsent</span>(lockKey, <span class="hljs-string">"1"</span>, <span class="hljs-number">5</span>, <span class="hljs-title class_">TimeUnit</span>.<span class="hljs-property">MINUTES</span>);
        
        <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Boolean</span>.<span class="hljs-property">TRUE</span>.<span class="hljs-title function_">equals</span>(locked)) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-built_in">boolean</span> result = orderService.<span class="hljs-title function_">cancelExpiredOrder</span>(orderId);
                <span class="hljs-keyword">if</span> (result) {
                    log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"成功处理过期订单: {}"</span>, orderId);
                }
            } <span class="hljs-keyword">finally</span> {
                redisTemplate.<span class="hljs-title function_">delete</span>(lockKey);
            }
        }
    }
}
</code></pre>
<h2 data-id="heading-14">六、配置类</h2>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableScheduling</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderExpireConfig</span> {
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">RedisTemplate</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Object</span>&gt; <span class="hljs-title function_">redisTemplate</span>(<span class="hljs-params">
            RedisConnectionFactory connectionFactory</span>) {
        <span class="hljs-title class_">RedisTemplate</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Object</span>&gt; template = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisTemplate</span>&lt;&gt;();
        template.<span class="hljs-title function_">setConnectionFactory</span>(connectionFactory);
        
        <span class="hljs-comment">// 设置key和value的序列化方式</span>
        template.<span class="hljs-title function_">setKeySerializer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRedisSerializer</span>());
        template.<span class="hljs-title function_">setValueSerializer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">GenericJackson2JsonRedisSerializer</span>());
        
        template.<span class="hljs-title function_">setHashKeySerializer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRedisSerializer</span>());
        template.<span class="hljs-title function_">setHashValueSerializer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">GenericJackson2JsonRedisSerializer</span>());
        
        template.<span class="hljs-title function_">afterPropertiesSet</span>();
        <span class="hljs-keyword">return</span> template;
    }
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">OrderExpireManager</span> <span class="hljs-title function_">orderExpireManager</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderExpireManager</span>();
    }
    
    <span class="hljs-meta">@PostConstruct</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">init</span>(<span class="hljs-params"/>) {
        <span class="hljs-comment">// 启动过期监控</span>
        <span class="hljs-title function_">orderExpireManager</span>().<span class="hljs-title function_">startExpireMonitor</span>();
    }
}
</code></pre>
<h2 data-id="heading-15">七、API接口</h2>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@RestController</span>
<span class="hljs-variable">@RequestMapping</span>(<span class="hljs-string">"/api/orders"</span>)
<span class="hljs-variable">@Slf4j</span>
public class OrderController {
    
    <span class="hljs-variable">@Autowired</span>
    private OrderService orderService;
    
    <span class="hljs-variable">@PostMapping</span>(<span class="hljs-string">"/create"</span>)
    public ApiResponse&lt;Order&gt; <span class="hljs-built_in">createOrder</span>(<span class="hljs-variable">@RequestBody</span> CreateOrderRequest request) {
        <span class="hljs-selector-tag">Order</span> <span class="hljs-selector-tag">order</span> = <span class="hljs-selector-tag">orderService</span><span class="hljs-selector-class">.createOrder</span>(
            request.<span class="hljs-built_in">getUserId</span>(), 
            request.<span class="hljs-built_in">getAmount</span>()
        );
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ApiResponse</span><span class="hljs-selector-class">.success</span>(order);
    }
    
    @<span class="hljs-selector-tag">PostMapping</span>(<span class="hljs-string">"/{orderNo}/pay"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">ApiResponse</span>&lt;<span class="hljs-selector-tag">Void</span>&gt; <span class="hljs-selector-tag">payOrder</span>(<span class="hljs-variable">@PathVariable</span> String orderNo) {
        <span class="hljs-selector-tag">boolean</span> <span class="hljs-selector-tag">success</span> = <span class="hljs-selector-tag">orderService</span><span class="hljs-selector-class">.processPayment</span>(orderNo);
        <span class="hljs-selector-tag">if</span> (success) {
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ApiResponse</span><span class="hljs-selector-class">.success</span>(<span class="hljs-string">"支付成功"</span>);
        } <span class="hljs-selector-tag">else</span> {
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ApiResponse</span><span class="hljs-selector-class">.error</span>(<span class="hljs-string">"支付失败"</span>);
        }
    }
    
    @<span class="hljs-selector-tag">GetMapping</span>(<span class="hljs-string">"/{orderNo}/status"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">ApiResponse</span>&lt;<span class="hljs-selector-tag">OrderStatus</span>&gt; <span class="hljs-selector-tag">getOrderStatus</span>(<span class="hljs-variable">@PathVariable</span> String orderNo) {
        <span class="hljs-comment">// 从Redis或数据库获取订单状态</span>
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ApiResponse</span><span class="hljs-selector-class">.success</span>(OrderStatus.PENDING_PAYMENT);
    }
}
</code></pre>
<h2 data-id="heading-16">八、测试类</h2>
<pre><code class="hljs language-ini" lang="ini">@SpringBootTest
@Slf4j
class OrderExpireTest {
    
    @Autowired
    private OrderService orderService<span class="hljs-comment">;</span>
    
    @Autowired
    private StringRedisTemplate redisTemplate<span class="hljs-comment">;</span>
    
    @Test
    void testOrderExpire() throws InterruptedException {
        // 创建订单
        Order <span class="hljs-attr">order</span> = orderService.createOrder(<span class="hljs-number">1</span>L, new BigDecimal(<span class="hljs-string">"100.00"</span>))<span class="hljs-comment">;</span>
        
        // 验证Redis中已设置过期
        String <span class="hljs-attr">expireKey</span> = <span class="hljs-string">"order:expire:"</span> + order.getOrder<span class="hljs-literal">No</span>()<span class="hljs-comment">;</span>
        String <span class="hljs-attr">value</span> = redisTemplate.opsForValue().get(expireKey)<span class="hljs-comment">;</span>
        assertNotNull(value)<span class="hljs-comment">;</span>
        
        // 验证订单状态
        assertEquals(OrderStatus.PENDING_PAYMENT, order.getStatus())<span class="hljs-comment">;</span>
        
        // 等待订单过期
        Thread.sleep(2000)<span class="hljs-comment">; // 实际应该等30分钟</span>
        
        // 测试支付
        boolean <span class="hljs-attr">paid</span> = orderService.processPayment(order.getOrder<span class="hljs-literal">No</span>())<span class="hljs-comment">;</span>
        assertTrue(paid)<span class="hljs-comment">;</span>
    }
    
    @Test
    void testConcurrentPay() throws InterruptedException {
        Order <span class="hljs-attr">order</span> = orderService.createOrder(<span class="hljs-number">2</span>L, new BigDecimal(<span class="hljs-string">"200.00"</span>))<span class="hljs-comment">;</span>
        
        ExecutorService <span class="hljs-attr">executor</span> = Executors.newFixedThreadPool(<span class="hljs-number">5</span>)<span class="hljs-comment">;</span>
        CountDownLatch <span class="hljs-attr">latch</span> = new CountDownLatch(<span class="hljs-number">5</span>)<span class="hljs-comment">;</span>
        
        AtomicInteger <span class="hljs-attr">successCount</span> = new AtomicInteger(<span class="hljs-number">0</span>)<span class="hljs-comment">;</span>
        
        for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; 5; i++) {</span>
            executor.submit(() -&gt; {
                try {
                    boolean <span class="hljs-attr">result</span> = orderService.processPayment(order.getOrder<span class="hljs-literal">No</span>())<span class="hljs-comment">;</span>
                    if (result) {
                        successCount.incrementAndGet()<span class="hljs-comment">;</span>
                    }
                } catch (Exception e) {
                    log.error("支付异常", e)<span class="hljs-comment">;</span>
                } finally {
                    latch.countDown()<span class="hljs-comment">;</span>
                }
            })<span class="hljs-comment">;</span>
        }
        
        latch.await()<span class="hljs-comment">;</span>
        executor.shutdown()<span class="hljs-comment">;</span>
        
        // 只有一个支付成功
        assertEquals(1, successCount.get())<span class="hljs-comment">;</span>
    }
}
</code></pre>
<h2 data-id="heading-17">九、监控和告警</h2>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderExpireMonitor</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">StringRedisTemplate</span> redisTemplate;
    
    <span class="hljs-meta">@Scheduled</span>(fixedRate = <span class="hljs-number">60000</span>) <span class="hljs-comment">// 每分钟执行一次</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">monitorExpireOrders</span>(<span class="hljs-params"/>) {
        <span class="hljs-title class_">String</span> expireKeyPattern = <span class="hljs-string">"order:expire:*"</span>;
        
        <span class="hljs-comment">// 统计待过期订单数量</span>
        <span class="hljs-title class_">Set</span>&lt;<span class="hljs-title class_">String</span>&gt; keys = redisTemplate.<span class="hljs-title function_">keys</span>(expireKeyPattern);
        long expireCount = keys != <span class="hljs-literal">null</span> ? keys.<span class="hljs-title function_">size</span>() : <span class="hljs-number">0</span>;
        
        <span class="hljs-comment">// 统计即将在5分钟内过期的订单</span>
        long soonExpireCount = keys.<span class="hljs-title function_">stream</span>()
            .<span class="hljs-title function_">map</span>(key -&gt; redisTemplate.<span class="hljs-title function_">getExpire</span>(key, <span class="hljs-title class_">TimeUnit</span>.<span class="hljs-property">SECONDS</span>))
            .<span class="hljs-title function_">filter</span>(ttl -&gt; ttl != <span class="hljs-literal">null</span> &amp;&amp; ttl &gt; <span class="hljs-number">0</span> &amp;&amp; ttl &lt;= <span class="hljs-number">300</span>)
            .<span class="hljs-title function_">count</span>();
        
        <span class="hljs-comment">// 记录监控日志</span>
        log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"订单过期监控 - 待过期订单: {}, 即将过期订单: {}"</span>, 
                 expireCount, soonExpireCount);
        
        <span class="hljs-comment">// 发送告警</span>
        <span class="hljs-keyword">if</span> (soonExpireCount &gt; <span class="hljs-number">100</span>) {
            <span class="hljs-title function_">sendAlert</span>(<span class="hljs-string">"大量订单即将过期: "</span> + soonExpireCount + <span class="hljs-string">" 个"</span>);
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">sendAlert</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> message</span>) {
        <span class="hljs-comment">// 发送告警到监控系统</span>
        log.<span class="hljs-title function_">warn</span>(<span class="hljs-string">"订单过期告警: {}"</span>, message);
    }
}
</code></pre>
<h2 data-id="heading-18">总结建议</h2>
<h3 data-id="heading-19">推荐方案</h3>
<ol>
<li>
<p><strong>生产环境推荐组合方案</strong>：</p>
<ul>
<li>主方案：<strong>Redisson延时队列</strong>​ + <strong>Redis键过期回调</strong></li>
<li>兜底方案：<strong>定时任务扫描ZSet</strong></li>
<li>防重处理：<strong>Redis分布式锁</strong></li>
</ul>
</li>
<li>
<p><strong>方案对比</strong>：</p>
<ul>
<li><strong>Redis键过期回调</strong>：实时性最好，但可靠性依赖Redis配置</li>
<li><strong>Redisson延时队列</strong>：功能强大，支持分布式，推荐使用</li>
<li><strong>ZSet定时扫描</strong>：实现简单，但实时性较差</li>
<li><strong>多级策略</strong>：最可靠，但实现复杂</li>
</ul>
</li>
<li>
<p><strong>注意事项</strong>：</p>
<ul>
<li>一定要配置Redis的<code>notify-keyspace-events Ex</code></li>
<li>考虑网络分区和Redis故障的情况</li>
<li>实现幂等性处理，防止重复取消</li>
<li>添加监控和告警</li>
<li>考虑持久化，防止重启后数据丢失</li>
</ul>
</li>
<li>
<p><strong>性能优化</strong>：</p>
<ul>
<li>使用批量处理过期订单</li>
<li>异步处理过期逻辑</li>
<li>合理设置扫描频率</li>
<li>使用连接池</li>
</ul>
</li>
</ol>
<p>这种实现可以确保订单过期功能的可靠性和实时性，适合电商等高并发场景。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何用Spring Boot实现分布式锁？]]></title>    <link>https://juejin.cn/post/7582755817670049802</link>    <guid>https://juejin.cn/post/7582755817670049802</guid>    <pubDate>2025-12-12T06:14:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582755817670049802" data-draft-id="7582528397865746459" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何用Spring Boot实现分布式锁？"/> <meta itemprop="keywords" content="后端,Java,Redis"/> <meta itemprop="datePublished" content="2025-12-12T06:14:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT界Tony哥"/> <meta itemprop="url" content="https://juejin.cn/user/3157453122578087"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何用Spring Boot实现分布式锁？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3157453122578087/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT界Tony哥
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T06:14:54.000Z" title="Fri Dec 12 2025 06:14:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>我来详细讲解Spring Boot中实现分布式锁的几种方式，包括手写Redis锁和使用Redisson框架。</p>
<h2 data-id="heading-0">一、基于Redis原生命令实现分布式锁</h2>
<h3 data-id="heading-1">1. 基础版Redis分布式锁</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisDistributedLock</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> StringRedisTemplate redisTemplate;
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">LOCK_PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">"distributed:lock:"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">DEFAULT_EXPIRE_TIME</span> <span class="hljs-operator">=</span> <span class="hljs-number">30000</span>; <span class="hljs-comment">// 30秒</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">DEFAULT_WAIT_TIME</span> <span class="hljs-operator">=</span> <span class="hljs-number">10000</span>;   <span class="hljs-comment">// 10秒</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">DEFAULT_SLEEP_TIME</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span>;    <span class="hljs-comment">// 100ms</span>
    
    <span class="hljs-comment">/**
     * 尝试获取分布式锁（简单版）
     * <span class="hljs-doctag">@param</span> lockKey 锁的key
     * <span class="hljs-doctag">@param</span> value 锁的值（通常用UUID）
     * <span class="hljs-doctag">@param</span> expireTime 锁的过期时间(ms)
     * <span class="hljs-doctag">@return</span> 是否获取成功
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">(String lockKey, String value, <span class="hljs-type">long</span> expireTime)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> LOCK_PREFIX + lockKey;
        
        <span class="hljs-comment">// 使用SET命令，通过NX参数实现"不存在时设置"，EX参数设置过期时间</span>
        <span class="hljs-type">Boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue()
            .setIfAbsent(key, value, expireTime, TimeUnit.MILLISECONDS);
        
        <span class="hljs-keyword">return</span> Boolean.TRUE.equals(result);
    }
    
    <span class="hljs-comment">/**
     * 释放锁
     * 需要确保是自己加的锁才能释放（防止释放别人的锁）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">releaseLock</span><span class="hljs-params">(String lockKey, String value)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> LOCK_PREFIX + lockKey;
        <span class="hljs-type">String</span> <span class="hljs-variable">currentValue</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().get(key);
        
        <span class="hljs-comment">// 通过Lua脚本确保原子性：判断值是否匹配，匹配则删除</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">luaScript</span> <span class="hljs-operator">=</span> 
            <span class="hljs-string">"if redis.call('get', KEYS[1]) == ARGV[1] then "</span> +
            <span class="hljs-string">"   return redis.call('del', KEYS[1]) "</span> +
            <span class="hljs-string">"else "</span> +
            <span class="hljs-string">"   return 0 "</span> +
            <span class="hljs-string">"end"</span>;
        
        DefaultRedisScript&lt;Long&gt; redisScript = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultRedisScript</span>&lt;&gt;();
        redisScript.setScriptText(luaScript);
        redisScript.setResultType(Long.class);
        
        <span class="hljs-type">Long</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> redisTemplate.execute(
            redisScript, 
            Collections.singletonList(key), 
            value
        );
        
        <span class="hljs-keyword">return</span> result != <span class="hljs-literal">null</span> &amp;&amp; result == <span class="hljs-number">1</span>;
    }
    
    <span class="hljs-comment">/**
     * 获取锁（支持重试）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">lockWithRetry</span><span class="hljs-params">(String lockKey, String value, 
                                 <span class="hljs-type">long</span> expireTime, <span class="hljs-type">long</span> waitTime)</span> {
        <span class="hljs-type">long</span> <span class="hljs-variable">endTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis() + waitTime;
        
        <span class="hljs-keyword">while</span> (System.currentTimeMillis() &lt; endTime) {
            <span class="hljs-keyword">if</span> (tryLock(lockKey, value, expireTime)) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            }
            
            <span class="hljs-keyword">try</span> {
                Thread.sleep(DEFAULT_SLEEP_TIME);
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                Thread.currentThread().interrupt();
                <span class="hljs-keyword">break</span>;
            }
        }
        
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
}
</code></pre>
<h3 data-id="heading-2">2. 可重入锁实现</h3>
<pre><code class="hljs language-vbnet" lang="vbnet">@Component
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> RedisReentrantLock {
    
    @Autowired
    <span class="hljs-keyword">private</span> StringRedisTemplate redisTemplate;
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final <span class="hljs-type">String</span> LOCK_PREFIX = <span class="hljs-string">"reentrant:lock:"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final ThreadLocal&lt;Map&lt;<span class="hljs-type">String</span>, <span class="hljs-type">Integer</span>&gt;&gt; LOCK_COUNT = 
        ThreadLocal.withInitial(HashMap::<span class="hljs-built_in">new</span>);
    
    /**
     * 可重入锁实现
     */
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> tryReentrantLock(<span class="hljs-type">String</span> lockKey, <span class="hljs-type">String</span> clientId, 
                                    <span class="hljs-type">long</span> expireTime) {
        <span class="hljs-type">String</span> <span class="hljs-keyword">key</span> = LOCK_PREFIX + lockKey;
        
        Map&lt;<span class="hljs-type">String</span>, <span class="hljs-type">Integer</span>&gt; lockCountMap = LOCK_COUNT.<span class="hljs-keyword">get</span>();
        int count = lockCountMap.getOrDefault(lockKey, <span class="hljs-number">0</span>);
        
        // 重入：当前线程已持有锁
        <span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">0</span>) {
            lockCountMap.put(lockKey, count + <span class="hljs-number">1</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        
        // 尝试获取锁
        <span class="hljs-type">String</span> luaScript = 
            <span class="hljs-string">"if redis.call('exists', KEYS[1]) == 0 then "</span> +
            <span class="hljs-string">"   redis.call('hset', KEYS[1], 'owner', ARGV[1]) "</span> +
            <span class="hljs-string">"   redis.call('hset', KEYS[1], 'count', 1) "</span> +
            <span class="hljs-string">"   redis.call('pexpire', KEYS[1], ARGV[2]) "</span> +
            <span class="hljs-string">"   return 1 "</span> +
            <span class="hljs-string">"elseif redis.call('hget', KEYS[1], 'owner') == ARGV[1] then "</span> +
            <span class="hljs-string">"   local count = redis.call('hget', KEYS[1], 'count') "</span> +
            <span class="hljs-string">"   redis.call('hset', KEYS[1], 'count', tonumber(count) + 1) "</span> +
            <span class="hljs-string">"   redis.call('pexpire', KEYS[1], ARGV[2]) "</span> +
            <span class="hljs-string">"   return 1 "</span> +
            <span class="hljs-string">"else "</span> +
            <span class="hljs-string">"   return 0 "</span> +
            <span class="hljs-string">"end"</span>;
        
        DefaultRedisScript&lt;<span class="hljs-type">Long</span>&gt; script = <span class="hljs-built_in">new</span> DefaultRedisScript&lt;&gt;();
        script.setScriptText(luaScript);
        script.setResultType(<span class="hljs-type">Long</span>.<span class="hljs-keyword">class</span>);
        
        <span class="hljs-type">Long</span> result = redisTemplate.execute(
            script,
            Collections.singletonList(<span class="hljs-keyword">key</span>),
            clientId,
            <span class="hljs-type">String</span>.valueOf(expireTime)
        );
        
        <span class="hljs-keyword">if</span> (result != null &amp;&amp; result == <span class="hljs-number">1</span>) {
            lockCountMap.put(lockKey, <span class="hljs-number">1</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    
    /**
     * 释放可重入锁
     */
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> releaseReentrantLock(<span class="hljs-type">String</span> lockKey, <span class="hljs-type">String</span> clientId) {
        <span class="hljs-type">String</span> <span class="hljs-keyword">key</span> = LOCK_PREFIX + lockKey;
        
        Map&lt;<span class="hljs-type">String</span>, <span class="hljs-type">Integer</span>&gt; lockCountMap = LOCK_COUNT.<span class="hljs-keyword">get</span>();
        int count = lockCountMap.getOrDefault(lockKey, <span class="hljs-number">0</span>);
        
        <span class="hljs-keyword">if</span> (count &lt;= <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        
        <span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">1</span>) {
            // 重入次数减<span class="hljs-number">1</span>
            lockCountMap.put(lockKey, count - <span class="hljs-number">1</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        
        // 最后一次重入，释放锁
        <span class="hljs-type">String</span> luaScript = 
            <span class="hljs-string">"if redis.call('hget', KEYS[1], 'owner') == ARGV[1] then "</span> +
            <span class="hljs-string">"   local current = redis.call('hget', KEYS[1], 'count') "</span> +
            <span class="hljs-string">"   if tonumber(current) &gt; 1 then "</span> +
            <span class="hljs-string">"       redis.call('hset', KEYS[1], 'count', tonumber(current) - 1) "</span> +
            <span class="hljs-string">"       redis.call('pexpire', KEYS[1], ARGV[2]) "</span> +
            <span class="hljs-string">"       return 0 "</span> +
            <span class="hljs-string">"   else "</span> +
            <span class="hljs-string">"       redis.call('del', KEYS[1]) "</span> +
            <span class="hljs-string">"       return 1 "</span> +
            <span class="hljs-string">"   end "</span> +
            <span class="hljs-string">"else "</span> +
            <span class="hljs-string">"   return -1 "</span> +
            <span class="hljs-string">"end"</span>;
        
        DefaultRedisScript&lt;<span class="hljs-type">Long</span>&gt; script = <span class="hljs-built_in">new</span> DefaultRedisScript&lt;&gt;();
        script.setScriptText(luaScript);
        script.setResultType(<span class="hljs-type">Long</span>.<span class="hljs-keyword">class</span>);
        
        <span class="hljs-type">Long</span> result = redisTemplate.execute(
            script,
            Collections.singletonList(<span class="hljs-keyword">key</span>),
            clientId,
            <span class="hljs-string">"30000"</span>
        );
        
        <span class="hljs-keyword">if</span> (result != null &amp;&amp; result == <span class="hljs-number">1</span>) {
            lockCountMap.remove(lockKey);
            <span class="hljs-keyword">if</span> (lockCountMap.isEmpty()) {
                LOCK_COUNT.remove();
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
}
</code></pre>
<h2 data-id="heading-3">二、使用Redisson实现分布式锁（推荐生产环境使用）</h2>
<h3 data-id="heading-4">1. 添加依赖</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- pom.xml --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.redisson<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>redisson-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.23.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h3 data-id="heading-5">2. 配置Redisson</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># application.yml</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">redis:</span>
    <span class="hljs-attr">host:</span> <span class="hljs-string">localhost</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">6379</span>
    <span class="hljs-attr">database:</span> <span class="hljs-number">0</span>
    <span class="hljs-attr">timeout:</span> <span class="hljs-number">3000</span>

<span class="hljs-attr">redisson:</span>
  <span class="hljs-attr">config:</span> <span class="hljs-string">|
    singleServerConfig:
      address: "redis://${spring.redis.host}:${spring.redis.port}"
      database: ${spring.redis.database}
      connectionPoolSize: 64
      connectionMinimumIdleSize: 24
      idleConnectionTimeout: 10000
      connectTimeout: ${spring.redis.timeout}
      timeout: ${spring.redis.timeout}
      retryAttempts: 3
      retryInterval: 1500
</span></code></pre>
<h3 data-id="heading-6">3. Redisson分布式锁服务</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.redisson.api.RLock;
<span class="hljs-keyword">import</span> org.redisson.api.RedissonClient;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedissonDistributedLock</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedissonClient redissonClient;
    
    <span class="hljs-comment">/**
     * 可重入锁（最常用）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryReentrantLock</span><span class="hljs-params">(String lockKey, <span class="hljs-type">long</span> waitTime, 
                                    <span class="hljs-type">long</span> leaseTime, TimeUnit unit)</span> {
        <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redissonClient.getLock(lockKey);
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> lock.tryLock(waitTime, leaseTime, unit);
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            Thread.currentThread().interrupt();
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }
    
    <span class="hljs-comment">/**
     * 公平锁
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryFairLock</span><span class="hljs-params">(String lockKey, <span class="hljs-type">long</span> waitTime, 
                               <span class="hljs-type">long</span> leaseTime, TimeUnit unit)</span> {
        <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redissonClient.getFairLock(lockKey);
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> lock.tryLock(waitTime, leaseTime, unit);
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            Thread.currentThread().interrupt();
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }
    
    <span class="hljs-comment">/**
     * 联锁（多个锁同时获取）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryMultiLock</span><span class="hljs-params">(String[] lockKeys, <span class="hljs-type">long</span> waitTime, 
                                <span class="hljs-type">long</span> leaseTime, TimeUnit unit)</span> {
        RLock[] locks = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RLock</span>[lockKeys.length];
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; lockKeys.length; i++) {
            locks[i] = redissonClient.getLock(lockKeys[i]);
        }
        
        <span class="hljs-type">RLock</span> <span class="hljs-variable">multiLock</span> <span class="hljs-operator">=</span> redissonClient.getMultiLock(locks);
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> multiLock.tryLock(waitTime, leaseTime, unit);
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            Thread.currentThread().interrupt();
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }
    
    <span class="hljs-comment">/**
     * 红锁（RedLock，多个Redis实例）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryRedLock</span><span class="hljs-params">(String lockKey, <span class="hljs-type">long</span> waitTime, 
                              <span class="hljs-type">long</span> leaseTime, TimeUnit unit)</span> {
        <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redissonClient.getLock(lockKey);
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> lock.tryLock(waitTime, leaseTime, unit);
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            Thread.currentThread().interrupt();
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }
    
    <span class="hljs-comment">/**
     * 释放锁
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">(String lockKey)</span> {
        <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redissonClient.getLock(lockKey);
        <span class="hljs-keyword">if</span> (lock.isLocked() &amp;&amp; lock.isHeldByCurrentThread()) {
            lock.unlock();
        }
    }
    
    <span class="hljs-comment">/**
     * 强制释放锁
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">forceUnlock</span><span class="hljs-params">(String lockKey)</span> {
        <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redissonClient.getLock(lockKey);
        lock.forceUnlock();
    }
    
    <span class="hljs-comment">/**
     * 自动续期的锁（看门狗机制）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lockWithWatchdog</span><span class="hljs-params">(String lockKey)</span> {
        <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redissonClient.getLock(lockKey);
        lock.lock(); <span class="hljs-comment">// 默认30秒，看门狗会自动续期</span>
    }
}
</code></pre>
<h3 data-id="heading-7">4. 使用AOP简化分布式锁使用</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Target</span>(ElementType.METHOD)
<span class="hljs-variable">@Retention</span>(RetentionPolicy.RUNTIME)
<span class="hljs-variable">@Documented</span>
public <span class="hljs-variable">@interface</span> DistributedLock {
    
    <span class="hljs-comment">/** 锁的key，支持SpEL表达式 */</span>
    <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">key</span>();
    
    <span class="hljs-comment">/** 锁类型，默认可重入锁 */</span>
    <span class="hljs-selector-tag">LockType</span> <span class="hljs-selector-tag">lockType</span>() <span class="hljs-selector-tag">default</span> <span class="hljs-selector-tag">LockType</span><span class="hljs-selector-class">.REENTRANT</span>;
    
    <span class="hljs-comment">/** 等待时间（秒） */</span>
    <span class="hljs-selector-tag">long</span> <span class="hljs-selector-tag">waitTime</span>() <span class="hljs-selector-tag">default</span> <span class="hljs-number">5</span>;
    
    <span class="hljs-comment">/** 持有时间（秒），-1表示使用看门狗自动续期 */</span>
    <span class="hljs-selector-tag">long</span> <span class="hljs-selector-tag">leaseTime</span>() <span class="hljs-selector-tag">default</span> <span class="hljs-selector-tag">-1</span>;
    
    <span class="hljs-comment">/** 时间单位 */</span>
    <span class="hljs-selector-tag">TimeUnit</span> <span class="hljs-selector-tag">timeUnit</span>() <span class="hljs-selector-tag">default</span> <span class="hljs-selector-tag">TimeUnit</span><span class="hljs-selector-class">.SECONDS</span>;
    
    <span class="hljs-selector-tag">enum</span> <span class="hljs-selector-tag">LockType</span> {
        <span class="hljs-selector-tag">REENTRANT</span>,      <span class="hljs-comment">// 可重入锁</span>
        <span class="hljs-selector-tag">FAIR</span>,           <span class="hljs-comment">// 公平锁</span>
        <span class="hljs-selector-tag">READ</span>,           <span class="hljs-comment">// 读锁</span>
        <span class="hljs-selector-tag">WRITE</span>,          <span class="hljs-comment">// 写锁</span>
        <span class="hljs-selector-tag">MULTI</span>,          <span class="hljs-comment">// 联锁</span>
        <span class="hljs-selector-tag">RED</span>             <span class="hljs-comment">// 红锁</span>
    }
}
</code></pre>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Aspect</span>
<span class="hljs-keyword">@Component</span>
<span class="hljs-keyword">@Slf</span>4j
public class DistributedLockAspect {
    
    <span class="hljs-keyword">@Autowired</span>
    private RedissonClient redissonClient;
    
    <span class="hljs-keyword">@Autowired</span>
    private RedissonDistributedLock redissonDistributedLock;
    
    <span class="hljs-keyword">@Around</span>(<span class="hljs-string">"@annotation(distributedLock)"</span>)
    public Object around(ProceedingJoinPoint joinPoint, 
                         DistributedLock distributedLock) throws Throwable {
        String lockKey = <span class="hljs-built_in">parseKey</span>(distributedLock.key(), joinPoint);
        RLock lock = <span class="hljs-built_in">getLock</span>(lockKey, distributedLock.lockType());
        
        boolean locked = false;
        try {
            <span class="hljs-comment">// 尝试获取锁</span>
            if (distributedLock.leaseTime() == -<span class="hljs-number">1</span>) {
                <span class="hljs-comment">// 使用看门狗自动续期</span>
                lock<span class="hljs-selector-class">.lock</span>();
            } else {
                locked = lock<span class="hljs-selector-class">.tryLock</span>(
                    distributedLock.waitTime(),
                    distributedLock<span class="hljs-selector-class">.leaseTime</span>(),
                    distributedLock<span class="hljs-selector-class">.timeUnit</span>()
                );
            }
            
            if (!locked &amp;&amp; distributedLock.leaseTime() != -<span class="hljs-number">1</span>) {
                throw new <span class="hljs-built_in">RuntimeException</span>("获取分布式锁失败: " + lockKey);
            }
            
            log<span class="hljs-selector-class">.info</span>("获取分布式锁成功: {}", lockKey);
            return joinPoint<span class="hljs-selector-class">.proceed</span>();
            
        } catch (InterruptedException e) {
            Thread<span class="hljs-selector-class">.currentThread</span>()<span class="hljs-selector-class">.interrupt</span>();
            throw new <span class="hljs-built_in">RuntimeException</span>("获取分布式锁被中断", e);
        } finally {
            if (lock.isLocked() &amp;&amp; lock<span class="hljs-selector-class">.isHeldByCurrentThread</span>()) {
                lock<span class="hljs-selector-class">.unlock</span>();
                log<span class="hljs-selector-class">.info</span>("释放分布式锁: {}", lockKey);
            }
        }
    }
    
    private String <span class="hljs-built_in">parseKey</span>(String keySpEL, ProceedingJoinPoint joinPoint) {
        MethodSignature signature = (MethodSignature) joinPoint<span class="hljs-selector-class">.getSignature</span>();
        Method method = signature<span class="hljs-selector-class">.getMethod</span>();
        
        <span class="hljs-comment">// 解析SpEL表达式</span>
        if (keySpEL.startsWith("#")) {
            ExpressionParser parser = new <span class="hljs-built_in">SpelExpressionParser</span>();
            Expression expression = parser<span class="hljs-selector-class">.parseExpression</span>(keySpEL);
            
            EvaluationContext context = new <span class="hljs-built_in">StandardEvaluationContext</span>();
            context<span class="hljs-selector-class">.setVariable</span>("methodName", method.getName());
            
            <span class="hljs-comment">// 设置参数</span>
            <span class="hljs-selector-tag">Object</span><span class="hljs-selector-attr">[]</span> args = joinPoint<span class="hljs-selector-class">.getArgs</span>();
            Parameter<span class="hljs-selector-attr">[]</span> parameters = method<span class="hljs-selector-class">.getParameters</span>();
            for (int i = <span class="hljs-number">0</span>; i &lt; parameters.length; i++) {
                context<span class="hljs-selector-class">.setVariable</span>(parameters[i].getName(), args<span class="hljs-selector-attr">[i]</span>);
            }
            
            return expression<span class="hljs-selector-class">.getValue</span>(context, String.class);
        }
        
        return keySpEL;
    }
    
    private RLock <span class="hljs-built_in">getLock</span>(String lockKey, DistributedLock.LockType lockType) {
        switch (lockType) {
            case FAIR:
                return redissonClient.<span class="hljs-built_in">getFairLock</span>(lockKey);
            case READ:
                return redissonClient.<span class="hljs-built_in">getReadWriteLock</span>(lockKey).<span class="hljs-built_in">readLock</span>();
            case WRITE:
                return redissonClient.<span class="hljs-built_in">getReadWriteLock</span>(lockKey).<span class="hljs-built_in">writeLock</span>();
            case MULTI:
            case RED:
                // 简化处理，实际使用需要多个实例
                return redissonClient.<span class="hljs-built_in">getLock</span>(lockKey);
            case REENTRANT:
            default:
                return redissonClient.<span class="hljs-built_in">getLock</span>(lockKey);
        }
    }
}
</code></pre>
<h2 data-id="heading-8">三、使用Spring Integration实现分布式锁</h2>
<h3 data-id="heading-9">1. 添加依赖</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-integration<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.integration<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-integration-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h3 data-id="heading-10">2. 配置Redis锁注册表</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisLockConfiguration</span> {
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">RedisLockRegistry</span> <span class="hljs-title function_">redisLockRegistry</span>(<span class="hljs-params">RedisConnectionFactory connectionFactory</span>) {
        <span class="hljs-comment">// 过期时间10秒</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisLockRegistry</span>(connectionFactory, <span class="hljs-string">"distributed-lock"</span>, 10000L);
    }
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">LockRegistry</span> <span class="hljs-title function_">lockRegistry</span>(<span class="hljs-params">RedisLockRegistry redisLockRegistry</span>) {
        <span class="hljs-keyword">return</span> redisLockRegistry;
    }
}
</code></pre>
<h3 data-id="heading-11">3. 使用Spring Integration锁</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">LockRegistry</span> lockRegistry;
    
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">createOrder</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> orderId</span>) {
        <span class="hljs-title class_">Lock</span> lock = lockRegistry.<span class="hljs-title function_">obtain</span>(<span class="hljs-string">"order:"</span> + orderId);
        
        <span class="hljs-built_in">boolean</span> locked = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 尝试获取锁，最多等待5秒</span>
            locked = lock.<span class="hljs-title function_">tryLock</span>(<span class="hljs-number">5</span>, <span class="hljs-title class_">TimeUnit</span>.<span class="hljs-property">SECONDS</span>);
            
            <span class="hljs-keyword">if</span> (!locked) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"系统繁忙，请稍后重试"</span>);
            }
            
            <span class="hljs-comment">// 执行业务逻辑</span>
            <span class="hljs-title function_">processOrder</span>(orderId);
            
        } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">InterruptedException</span> e) {
            <span class="hljs-title class_">Thread</span>.<span class="hljs-title function_">currentThread</span>().<span class="hljs-title function_">interrupt</span>();
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"订单处理被中断"</span>, e);
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (locked) {
                lock.<span class="hljs-title function_">unlock</span>();
            }
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">processOrder</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> orderId</span>) {
        <span class="hljs-comment">// 订单处理逻辑</span>
        log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"处理订单: {}"</span>, orderId);
    }
}
</code></pre>
<h2 data-id="heading-12">四、实际应用示例</h2>
<h3 data-id="heading-13">1. 商品秒杀场景</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SeckillService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedissonClient redissonClient;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> StringRedisTemplate redisTemplate;
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">SECKILL_PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">"seckill:product:"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">LOCK_PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">"seckill:lock:"</span>;
    
    <span class="hljs-comment">/**
     * 秒杀下单（防超卖）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">seckillOrder</span><span class="hljs-params">(Long productId, Integer quantity, Long userId)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> LOCK_PREFIX + productId;
        <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redissonClient.getLock(lockKey);
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 尝试获取锁，等待100ms，持有锁3秒</span>
            <span class="hljs-keyword">if</span> (!lock.tryLock(<span class="hljs-number">100</span>, <span class="hljs-number">3000</span>, TimeUnit.MILLISECONDS)) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"抢购太火爆，请重试"</span>);
            }
            
            <span class="hljs-comment">// 检查库存</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">stockKey</span> <span class="hljs-operator">=</span> SECKILL_PREFIX + productId + <span class="hljs-string">":stock"</span>;
            <span class="hljs-type">Integer</span> <span class="hljs-variable">stock</span> <span class="hljs-operator">=</span> Integer.valueOf(
                redisTemplate.opsForValue().get(stockKey)
            );
            
            <span class="hljs-keyword">if</span> (stock == <span class="hljs-literal">null</span> || stock &lt; quantity) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"库存不足"</span>);
            }
            
            <span class="hljs-comment">// 扣减库存</span>
            <span class="hljs-type">Long</span> <span class="hljs-variable">newStock</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().decrement(stockKey, quantity);
            <span class="hljs-keyword">if</span> (newStock &lt; <span class="hljs-number">0</span>) {
                <span class="hljs-comment">// 库存不足，恢复库存</span>
                redisTemplate.opsForValue().increment(stockKey, quantity);
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"库存不足"</span>);
            }
            
            <span class="hljs-comment">// 创建订单</span>
            createOrder(productId, quantity, userId);
            
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            Thread.currentThread().interrupt();
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"系统异常"</span>, e);
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (lock.isLocked() &amp;&amp; lock.isHeldByCurrentThread()) {
                lock.unlock();
            }
        }
    }
    
    <span class="hljs-comment">/**
     * 使用注解简化版
     */</span>
    <span class="hljs-meta">@DistributedLock(
        key = "'seckill:lock:' + #productId",
        waitTime = 1,
        leaseTime = 3,
        timeUnit = TimeUnit.SECONDS
    )</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">seckillOrderWithAnnotation</span><span class="hljs-params">(Long productId, Integer quantity, Long userId)</span> {
        <span class="hljs-comment">// 业务逻辑，无需关心锁的获取和释放</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">stockKey</span> <span class="hljs-operator">=</span> SECKILL_PREFIX + productId + <span class="hljs-string">":stock"</span>;
        <span class="hljs-type">Integer</span> <span class="hljs-variable">stock</span> <span class="hljs-operator">=</span> Integer.valueOf(
            redisTemplate.opsForValue().get(stockKey)
        );
        
        <span class="hljs-keyword">if</span> (stock == <span class="hljs-literal">null</span> || stock &lt; quantity) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"库存不足"</span>);
        }
        
        <span class="hljs-type">Long</span> <span class="hljs-variable">newStock</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().decrement(stockKey, quantity);
        <span class="hljs-keyword">if</span> (newStock &lt; <span class="hljs-number">0</span>) {
            redisTemplate.opsForValue().increment(stockKey, quantity);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"库存不足"</span>);
        }
        
        createOrder(productId, quantity, userId);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Long productId, Integer quantity, Long userId)</span> {
        <span class="hljs-comment">// 创建订单逻辑</span>
        log.info(<span class="hljs-string">"用户{}抢购商品{}，数量{}"</span>, userId, productId, quantity);
    }
}
</code></pre>
<h3 data-id="heading-14">2. 定时任务防重复执行</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ScheduledTasks</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">RedissonClient</span> redissonClient;
    
    <span class="hljs-comment">/**
     * 分布式定时任务，确保集群中只有一个实例执行
     */</span>
    <span class="hljs-meta">@Scheduled</span>(cron = <span class="hljs-string">"0 */5 * * * ?"</span>) <span class="hljs-comment">// 每5分钟执行一次</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">syncDataTask</span>(<span class="hljs-params"/>) {
        <span class="hljs-title class_">String</span> lockKey = <span class="hljs-string">"task:sync:data"</span>;
        <span class="hljs-title class_">RLock</span> lock = redissonClient.<span class="hljs-title function_">getLock</span>(lockKey);
        
        <span class="hljs-comment">// 不等待，获取不到锁直接返回</span>
        <span class="hljs-built_in">boolean</span> locked = lock.<span class="hljs-title function_">tryLock</span>();
        <span class="hljs-keyword">if</span> (!locked) {
            log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"其他节点正在执行数据同步任务"</span>);
            <span class="hljs-keyword">return</span>;
        }
        
        <span class="hljs-keyword">try</span> {
            log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"开始执行数据同步任务"</span>);
            <span class="hljs-comment">// 执行业务逻辑</span>
            <span class="hljs-title function_">syncData</span>();
            log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"数据同步任务完成"</span>);
        } <span class="hljs-keyword">finally</span> {
            lock.<span class="hljs-title function_">unlock</span>();
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">syncData</span>(<span class="hljs-params"/>) {
        <span class="hljs-comment">// 数据同步逻辑</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-title class_">Thread</span>.<span class="hljs-title function_">sleep</span>(<span class="hljs-number">5000</span>);
        } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">InterruptedException</span> e) {
            <span class="hljs-title class_">Thread</span>.<span class="hljs-title function_">currentThread</span>().<span class="hljs-title function_">interrupt</span>();
        }
    }
}
</code></pre>
<h2 data-id="heading-15">五、配置和最佳实践</h2>
<h3 data-id="heading-16">1. Redisson配置类</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Configuration</span>
public class RedissonConfig {
    
    <span class="hljs-keyword">@Value</span>(<span class="hljs-string">"${spring.redis.host}"</span>)
    private String redisHost;
    
    <span class="hljs-keyword">@Value</span>(<span class="hljs-string">"${spring.redis.port}"</span>)
    private String redisPort;
    
    <span class="hljs-keyword">@Value</span>(<span class="hljs-string">"${spring.redis.password:}"</span>)
    private String password;
    
    <span class="hljs-keyword">@Value</span>(<span class="hljs-string">"${spring.redis.database:0}"</span>)
    private int database;
    
    <span class="hljs-keyword">@Bean</span>(destroyMethod = <span class="hljs-string">"shutdown"</span>)
    public RedissonClient redissonClient() {
        Config config = new <span class="hljs-built_in">Config</span>();
        
        <span class="hljs-comment">// 单节点模式</span>
        config<span class="hljs-selector-class">.useSingleServer</span>()
            <span class="hljs-selector-class">.setAddress</span>(String.format("redis://%s:%s", redisHost, redisPort))
            <span class="hljs-selector-class">.setDatabase</span>(database)
            <span class="hljs-selector-class">.setPassword</span>(StringUtils.hasText(password) ? password : null)
            .<span class="hljs-built_in">setConnectionPoolSize</span>(<span class="hljs-number">64</span>)
            .<span class="hljs-built_in">setConnectionMinimumIdleSize</span>(<span class="hljs-number">10</span>)
            .<span class="hljs-built_in">setIdleConnectionTimeout</span>(<span class="hljs-number">10000</span>)
            .<span class="hljs-built_in">setConnectTimeout</span>(<span class="hljs-number">3000</span>)
            .<span class="hljs-built_in">setTimeout</span>(<span class="hljs-number">3000</span>)
            .<span class="hljs-built_in">setRetryAttempts</span>(<span class="hljs-number">3</span>)
            .<span class="hljs-built_in">setRetryInterval</span>(<span class="hljs-number">1500</span>)
            .<span class="hljs-built_in">setPingConnectionInterval</span>(<span class="hljs-number">30000</span>)
            .<span class="hljs-built_in">setKeepAlive</span>(true);
        
        <span class="hljs-comment">// 锁配置</span>
        config<span class="hljs-selector-class">.setLockWatchdogTimeout</span>(<span class="hljs-number">30000</span>L); <span class="hljs-comment">// 看门狗超时时间</span>
        
        return Redisson<span class="hljs-selector-class">.create</span>(config);
    }
}
</code></pre>
<h3 data-id="heading-17">2. 分布式锁工具类</h3>
<pre><code class="hljs language-csharp" lang="csharp">@Component
@Slf4j
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">DistributedLockUtil</span> {
    
    @Autowired
    <span class="hljs-keyword">private</span> RedissonClient redissonClient;
    
    <span class="hljs-comment">/**
     * 执行带锁的方法
     */</span>
    <span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-function">T <span class="hljs-title">executeWithLock</span>(<span class="hljs-params">String lockKey, <span class="hljs-built_in">long</span> waitTime, <span class="hljs-built_in">long</span> leaseTime, 
                                  TimeUnit unit, Supplier&lt;T&gt; supplier</span>)</span> {
        RLock <span class="hljs-keyword">lock</span> = redissonClient.getLock(lockKey);
        boolean locked = <span class="hljs-literal">false</span>;
        
        <span class="hljs-keyword">try</span> {
            locked = <span class="hljs-keyword">lock</span>.tryLock(waitTime, leaseTime, unit);
            <span class="hljs-keyword">if</span> (!locked) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> DistributedLockException(<span class="hljs-string">"获取分布式锁失败: "</span> + lockKey);
            }
            
            <span class="hljs-keyword">return</span> supplier.<span class="hljs-keyword">get</span>();
            
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            Thread.currentThread().interrupt();
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> DistributedLockException(<span class="hljs-string">"获取分布式锁被中断"</span>, e);
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (locked &amp;&amp; <span class="hljs-keyword">lock</span>.isHeldByCurrentThread()) {
                <span class="hljs-keyword">lock</span>.unlock();
            }
        }
    }
    
    <span class="hljs-comment">/**
     * 执行带锁的方法（无返回值）
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">executeWithLock</span>(<span class="hljs-params">String lockKey, <span class="hljs-built_in">long</span> waitTime, <span class="hljs-built_in">long</span> leaseTime,
                               TimeUnit unit, Runnable runnable</span>)</span> {
        executeWithLock(lockKey, waitTime, leaseTime, unit, () -&gt; {
            runnable.run();
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        });
    }
    
    <span class="hljs-comment">/**
     * 执行带锁的方法（快速失败）
     */</span>
    <span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-function">Optional&lt;T&gt; <span class="hljs-title">tryExecuteWithLock</span>(<span class="hljs-params">String lockKey, <span class="hljs-built_in">long</span> waitTime, 
                                             <span class="hljs-built_in">long</span> leaseTime, TimeUnit unit,
                                             Supplier&lt;T&gt; supplier</span>)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> Optional.ofNullable(
                executeWithLock(lockKey, waitTime, leaseTime, unit, supplier)
            );
        } <span class="hljs-keyword">catch</span> (DistributedLockException e) {
            log.warn(<span class="hljs-string">"获取锁失败，跳过执行: {}"</span>, lockKey);
            <span class="hljs-keyword">return</span> Optional.empty();
        }
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">DistributedLockException</span> <span class="hljs-title">extends</span> <span class="hljs-title">RuntimeException</span> {
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">DistributedLockException</span>(<span class="hljs-params">String message</span>)</span> {
            super(message);
        }
        
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">DistributedLockException</span>(<span class="hljs-params">String message, Throwable cause</span>)</span> {
            super(message, cause);
        }
    }
}
</code></pre>
<h2 data-id="heading-18">六、测试分布式锁</h2>
<pre><code class="hljs language-ini" lang="ini">@SpringBootTest
@Slf4j
class DistributedLockTest {
    
    @Autowired
    private RedissonDistributedLock redissonDistributedLock<span class="hljs-comment">;</span>
    
    @Autowired
    private DistributedLockUtil distributedLockUtil<span class="hljs-comment">;</span>
    
    private final AtomicInteger <span class="hljs-attr">counter</span> = new AtomicInteger(<span class="hljs-number">0</span>)<span class="hljs-comment">;</span>
    
    @Test
    void testConcurrentLock() throws InterruptedException {
        int <span class="hljs-attr">threadCount</span> = <span class="hljs-number">10</span><span class="hljs-comment">;</span>
        String <span class="hljs-attr">lockKey</span> = <span class="hljs-string">"test:concurrent:lock"</span><span class="hljs-comment">;</span>
        CountDownLatch <span class="hljs-attr">latch</span> = new CountDownLatch(threadCount)<span class="hljs-comment">;</span>
        
        ExecutorService <span class="hljs-attr">executor</span> = Executors.newFixedThreadPool(threadCount)<span class="hljs-comment">;</span>
        
        for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; threadCount; i++) {</span>
            executor.submit(() -&gt; {
                try {
                    boolean <span class="hljs-attr">locked</span> = redissonDistributedLock
                        .tryReentrantLock(lockKey, 2, 5, TimeUnit.SECONDS)<span class="hljs-comment">;</span>
                    
                    if (locked) {
                        try {
                            // 模拟业务处理
                            Thread.sleep(100)<span class="hljs-comment">;</span>
                            int <span class="hljs-attr">value</span> = counter.incrementAndGet()<span class="hljs-comment">;</span>
                            log.info("线程 {} 获取锁成功，计数: {}", 
                                    Thread.currentThread().getName(), value)<span class="hljs-comment">;</span>
                        } finally {
                            redissonDistributedLock.unlock(lockKey)<span class="hljs-comment">;</span>
                        }
                    } else {
                        log.warn("线程 {} 获取锁失败", Thread.currentThread().getName())<span class="hljs-comment">;</span>
                    }
                } catch (Exception e) {
                    log.error("线程执行异常", e)<span class="hljs-comment">;</span>
                } finally {
                    latch.countDown()<span class="hljs-comment">;</span>
                }
            })<span class="hljs-comment">;</span>
        }
        
        latch.await()<span class="hljs-comment">;</span>
        executor.shutdown()<span class="hljs-comment">;</span>
        
        assertEquals(threadCount, counter.get())<span class="hljs-comment">;</span>
    }
    
    @Test
    void testLockWithUtil() {
        String <span class="hljs-attr">lockKey</span> = <span class="hljs-string">"test:util:lock"</span><span class="hljs-comment">;</span>
        
        String <span class="hljs-attr">result</span> = distributedLockUtil.executeWithLock(
            lockKey, 
            2, 
            5, 
            TimeUnit.SECONDS,
            () -&gt; {
                // 业务逻辑
                return "success"<span class="hljs-comment">;</span>
            }
        )<span class="hljs-comment">;</span>
        
        assertEquals("success", result)<span class="hljs-comment">;</span>
    }
}
</code></pre>
<h2 data-id="heading-19">总结与建议</h2>
<h3 data-id="heading-20">1. <strong>选择方案</strong></h3>
<ul>
<li><strong>简单场景</strong>：使用Spring Integration的<code>RedisLockRegistry</code></li>
<li><strong>生产环境</strong>：推荐使用<strong>Redisson</strong>，功能最全，稳定性最好</li>
<li><strong>特殊需求</strong>：需要精细控制时，可以使用原生Redis命令自定义</li>
</ul>
<h3 data-id="heading-21">2. <strong>最佳实践</strong></h3>
<ul>
<li>锁的key要有业务含义，如<code>order:create:{orderId}</code></li>
<li>一定要设置合理的过期时间，防止死锁</li>
<li>释放锁时要检查是否当前线程持有</li>
<li>使用Lua脚本保证原子性</li>
<li>考虑锁的可重入性</li>
<li>生产环境使用Redis集群或哨兵模式</li>
</ul>
<h3 data-id="heading-22">3. <strong>注意事项</strong></h3>
<ul>
<li>避免锁粒度过大，影响并发性能</li>
<li>避免锁持有时间过长</li>
<li>实现锁的自动续期（看门狗机制）</li>
<li>考虑锁等待超时和快速失败</li>
<li>添加监控和告警机制</li>
</ul>
<h3 data-id="heading-23">4. <strong>常见问题解决</strong></h3>
<ul>
<li><strong>锁提前过期</strong>：使用Redisson的看门狗机制</li>
<li><strong>锁误删</strong>：每个锁设置唯一value，释放时验证</li>
<li><strong>锁不可重入</strong>：使用Redisson或实现可重入逻辑</li>
<li><strong>Redis集群故障</strong>：使用RedLock算法（多个Redis实例）</li>
</ul>
<p>这样实现的分布式锁既安全又可靠，可以满足大多数业务场景的需求。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Django实现接口token检测的实现方案]]></title>    <link>https://juejin.cn/post/7582519152566419471</link>    <guid>https://juejin.cn/post/7582519152566419471</guid>    <pubDate>2025-12-12T06:24:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7582519152566419471" data-draft-id="7582533464244928546" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Django实现接口token检测的实现方案"/> <meta itemprop="keywords" content="后端,Django"/> <meta itemprop="datePublished" content="2025-12-12T06:24:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java水解"/> <meta itemprop="url" content="https://juejin.cn/user/2441349519143037"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Django实现接口token检测的实现方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2441349519143037/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java水解
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-12T06:24:01.000Z" title="Fri Dec 12 2025 06:24:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0"><strong>一、Token认证的实现思路</strong></h3>
<ol>
<li><strong>用户登录后生成Token</strong>：用户登录成功后，服务器生成一个Token，并返回给客户端。</li>
<li><strong>客户端请求时携带Token</strong>：客户端在每次请求时，将Token放入HTTP请求头（Headers）中。</li>
<li><strong>服务器端验证Token</strong>：Django后端解析请求中的Token，并验证其合法性。</li>
<li><strong>Token校验通过，允许访问接口</strong>；否则，返回未授权的错误信息。</li>
</ol>
<hr/>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a600ef266304456f9ad43c492b387677~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766125440&amp;x-signature=omrZz79gNqa%2F%2Fy%2BAUpZQAPkyE6M%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-1"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><strong>二、环境准备</strong></h3>
<p>在Django项目中，我们可以使用<code>rest_framework.authtoken</code>或者自定义Token认证逻辑。这里介绍两种方式：</p>
<ol>
<li><strong>基于 Django REST framework（DRF） 的 Token 认证</strong></li>
<li><strong>自定义 Token 认证</strong></li>
</ol>
<hr/>
<h3 data-id="heading-2"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><strong>三、基于 Django REST Framework（DRF）的 Token 认证</strong></h3>
<p>Django REST Framework 提供了现成的 Token 认证机制，下面是实现步骤。</p>
<h4 data-id="heading-3"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><strong>1. 安装 Django REST framework</strong></h4>
<p>如果还未安装 Django <a href="https://link.juejin.cn?target=https%3A%2F%2Fso.csdn.net%2Fso%2Fsearch%3Fq%3DREST%2520framework%26spm%3D1001.2101.3001.7020" target="_blank" title="https://so.csdn.net/so/search?q=REST%20framework&amp;spm=1001.2101.3001.7020" ref="nofollow noopener noreferrer">REST framework</a>，请使用 pip 安装：</p>
<pre><code class="hljs">pip install djangorestframework
pip install djangorestframework.authtoken

AI写代码sh
12
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5211e8b0e3444549917feadabb0066c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766125440&amp;x-signature=%2B62btK3jB5VYJhmhMB1%2FxKcTzpk%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h4 data-id="heading-4"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><strong>2. 添加到 Django 配置</strong></h4>
<p>在 <code>settings.py</code> 中启用 Django REST framework 和 Token 认证：</p>
<pre><code class="hljs language-css" lang="css">INSTALLED_APPS = <span class="hljs-selector-attr">[    <span class="hljs-string">'django.contrib.admin'</span>,    <span class="hljs-string">'django.contrib.auth'</span>,    <span class="hljs-string">'django.contrib.contenttypes'</span>,    <span class="hljs-string">'django.contrib.sessions'</span>,    <span class="hljs-string">'django.contrib.messages'</span>,    <span class="hljs-string">'django.contrib.staticfiles'</span>,    <span class="hljs-string">'rest_framework'</span>,    <span class="hljs-string">'rest_framework.authtoken'</span>,]</span>

REST_FRAMEWORK = {
    'DEFAULT_AUTHENTICATION_CLASSES': (
        <span class="hljs-string">'rest_framework.authentication.TokenAuthentication'</span>,
    ),
    <span class="hljs-string">'DEFAULT_PERMISSION_CLASSES'</span>: (
        <span class="hljs-string">'rest_framework.permissions.IsAuthenticated'</span>,
    ),
}

AI写代码python
运行
<span class="hljs-number">12345678910111213141516171819</span>
</code></pre>
<h4 data-id="heading-5"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><strong>3. 生成 Token 表</strong></h4>
<p>运行 Django 迁移命令，创建 Token 认证所需的数据表：</p>
<pre><code class="hljs">python manage.py migrate

AI写代码sh
1
</code></pre>
<h4 data-id="heading-6"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><strong>4. 创建 API 视图</strong></h4>
<p>创建用户登录接口，生成并返回 Token。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">from django.contrib.auth <span class="hljs-keyword">import</span> authenticate
from rest_framework.authtoken.models <span class="hljs-keyword">import</span> Token
from rest_framework.response <span class="hljs-keyword">import</span> Response
from rest_framework.views <span class="hljs-keyword">import</span> APIView
from rest_framework <span class="hljs-keyword">import</span> status

<span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginView</span>(APIView):
    def post(self, request):
        username = request.<span class="hljs-keyword">data</span>.<span class="hljs-keyword">get</span>(<span class="hljs-string">"username"</span>)
        password = request.<span class="hljs-keyword">data</span>.<span class="hljs-keyword">get</span>(<span class="hljs-string">"password"</span>)
        user = authenticate(username=username, password=password)
        <span class="hljs-keyword">if</span> user:
            token, created = Token.objects.get_or_create(user=user)
            <span class="hljs-keyword">return</span> Response({<span class="hljs-string">"token"</span>: token.key})
        <span class="hljs-keyword">return</span> Response({<span class="hljs-string">"error"</span>: <span class="hljs-string">"Invalid Credentials"</span>}, status=status.HTTP_401_UNAUTHORIZED)

AI写代码python
运行
<span class="hljs-number">123456789101112131415</span>
</code></pre>
<h4 data-id="heading-7"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><strong>5. 保护 API 端点</strong></h4>
<p>在 API 视图中使用 <code>TokenAuthentication</code> 保护 API，仅允许持有有效 Token 的用户访问：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> rest_framework.authentication <span class="hljs-keyword">import</span> TokenAuthentication
<span class="hljs-keyword">from</span> rest_framework.permissions <span class="hljs-keyword">import</span> IsAuthenticated
<span class="hljs-keyword">from</span> rest_framework.views <span class="hljs-keyword">import</span> APIView
<span class="hljs-keyword">from</span> rest_framework.response <span class="hljs-keyword">import</span> Response

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ProtectedView</span>(<span class="hljs-title class_ inherited__">APIView</span>):
    authentication_classes = [TokenAuthentication]
    permission_classes = [IsAuthenticated]

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">self, request</span>):
        <span class="hljs-keyword">return</span> Response({<span class="hljs-string">"message"</span>: <span class="hljs-string">"You have access to this protected endpoint."</span>})

AI写代码python
运行
<span class="hljs-number">1234567891011</span>
</code></pre>
<h4 data-id="heading-8"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><strong>6. 测试 API</strong></h4>
<ol>
<li>
<p><strong>获取 Token</strong>：</p>
<pre><code class="hljs language-makefile" lang="makefile">curl -X POST http://127.0.0.1:8000/api/login/ -H <span class="hljs-string">"Content-Type: application/json"</span> -d '{<span class="hljs-string">"username"</span>: <span class="hljs-string">"admin"</span>, <span class="hljs-string">"password"</span>: <span class="hljs-string">"password"</span>}'

AI写代码sh
1
</code></pre>
<p>服务器返回：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span><span class="hljs-attr">"token"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"abc123xyz456"</span><span class="hljs-punctuation">}</span>

AI写代码json
<span class="hljs-number">1</span>
</code></pre>
</li>
<li>
<p><strong>访问受保护的 API</strong>：</p>
<pre><code class="hljs language-ruby" lang="ruby">curl -X <span class="hljs-variable constant_">GET</span> <span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/127.0.0.1:8000/api</span><span class="hljs-regexp">/protected/</span> -H <span class="hljs-string">"Authorization: Token abc123xyz456"</span>

<span class="hljs-variable constant_">AI</span>写代码sh
<span class="hljs-number">1</span>
</code></pre>
<p>服务器返回：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span><span class="hljs-attr">"message"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"You have access to this protected endpoint."</span><span class="hljs-punctuation">}</span>

AI写代码json
<span class="hljs-number">1</span>
</code></pre>
</li>
</ol>
<hr/>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe6fa8f906e345c7bdd1474128008424~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766125440&amp;x-signature=SOiEfc%2FBNN36q4g8Eh1uQUsgLYo%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-9"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><strong>四、自定义 Token 认证方案</strong></h3>
<p>如果不使用 DRF 自带的 <code>TokenAuthentication</code>，我们也可以自定义 Token 认证。</p>
<h4 data-id="heading-10"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><strong>1. 自定义 Token 模型</strong></h4>
<p>在 <code>models.py</code> 中创建 Token 存储表：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> django.db <span class="hljs-keyword">import</span> models
<span class="hljs-keyword">from</span> django.contrib.auth.models <span class="hljs-keyword">import</span> User
<span class="hljs-keyword">import</span> uuid

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomToken</span>(models.Model):
    user = models.OneToOneField(User, on_delete=models.CASCADE)
    key = models.CharField(max_length=<span class="hljs-number">255</span>, unique=<span class="hljs-literal">True</span>, default=uuid.uuid4)
    created_at = models.DateTimeField(auto_now_add=<span class="hljs-literal">True</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__str__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">return</span> self.key

AI写代码python
运行
<span class="hljs-number">1234567891011</span>
</code></pre>
<h4 data-id="heading-11"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><strong>2. 创建 Token 生成逻辑</strong></h4>
<p>在 <code>views.py</code> 中定义登录逻辑，生成自定义 Token：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> django.contrib.auth <span class="hljs-keyword">import</span> authenticate
<span class="hljs-keyword">from</span> django.http <span class="hljs-keyword">import</span> JsonResponse
<span class="hljs-keyword">from</span> .models <span class="hljs-keyword">import</span> CustomToken

<span class="hljs-keyword">def</span> <span class="hljs-title function_">custom_login</span>(<span class="hljs-params">request</span>):
    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">"POST"</span>:
        username = request.POST.get(<span class="hljs-string">"username"</span>)
        password = request.POST.get(<span class="hljs-string">"password"</span>)
        user = authenticate(username=username, password=password)

        <span class="hljs-keyword">if</span> user:
            token, created = CustomToken.objects.get_or_create(user=user)
            <span class="hljs-keyword">return</span> JsonResponse({<span class="hljs-string">"token"</span>: token.key})
        <span class="hljs-keyword">return</span> JsonResponse({<span class="hljs-string">"error"</span>: <span class="hljs-string">"Invalid credentials"</span>}, status=<span class="hljs-number">401</span>)

AI写代码python
运行
<span class="hljs-number">1234567891011121314</span>
</code></pre>
<h4 data-id="heading-12"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><strong>3. 中间件拦截 Token</strong></h4>
<p>在 <code>middleware.py</code> 中定义 Token 验证逻辑：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> django.http <span class="hljs-keyword">import</span> JsonResponse
<span class="hljs-keyword">from</span> .models <span class="hljs-keyword">import</span> CustomToken

<span class="hljs-keyword">class</span> <span class="hljs-title class_">TokenMiddleware</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, get_response</span>):
        self.get_response = get_response

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__call__</span>(<span class="hljs-params">self, request</span>):
        token = request.headers.get(<span class="hljs-string">"Authorization"</span>)

        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> token:
            <span class="hljs-keyword">return</span> JsonResponse({<span class="hljs-string">"error"</span>: <span class="hljs-string">"Token missing"</span>}, status=<span class="hljs-number">401</span>)

        <span class="hljs-keyword">try</span>:
            user_token = CustomToken.objects.get(key=token)
            request.user = user_token.user
        <span class="hljs-keyword">except</span> CustomToken.DoesNotExist:
            <span class="hljs-keyword">return</span> JsonResponse({<span class="hljs-string">"error"</span>: <span class="hljs-string">"Invalid token"</span>}, status=<span class="hljs-number">401</span>)

        <span class="hljs-keyword">return</span> self.get_response(request)

AI写代码python
运行
<span class="hljs-number">1234567891011121314151617181920</span>
</code></pre>
<p>然后，在 <code>settings.py</code> 中启用中间件：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">MIDDLEWARE</span> = [
    <span class="hljs-string">'django.middleware.security.SecurityMiddleware'</span>,
    <span class="hljs-string">'django.contrib.sessions.middleware.SessionMiddleware'</span>,
    <span class="hljs-string">'django.middleware.common.CommonMiddleware'</span>,
    <span class="hljs-string">'django.middleware.csrf.CsrfViewMiddleware'</span>,
    <span class="hljs-string">'django.middleware.authentication.AuthenticationMiddleware'</span>,
    <span class="hljs-string">'django.contrib.messages.middleware.MessageMiddleware'</span>,
    <span class="hljs-string">'django.middleware.clickjacking.XFrameOptionsMiddleware'</span>,
    <span class="hljs-string">'myapp.middleware.TokenMiddleware'</span>,  <span class="hljs-comment"># 添加自定义 Token 认证中间件</span>
]

AI写代码python
运行
12345678910
</code></pre>
<h4 data-id="heading-13"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><strong>4. 受保护的 API</strong></h4>
<p>在 <code>views.py</code> 中定义需要 Token 认证的接口：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> django.http <span class="hljs-keyword">import</span> JsonResponse

<span class="hljs-keyword">def</span> <span class="hljs-title function_">protected_view</span>(<span class="hljs-params">request</span>):
    <span class="hljs-keyword">return</span> JsonResponse({<span class="hljs-string">"message"</span>: <span class="hljs-string">"Welcome, you are authenticated!"</span>})

AI写代码python
运行
<span class="hljs-number">1234</span>
</code></pre>
<h4 data-id="heading-14"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><strong>5. 测试</strong></h4>
<ol>
<li>
<p><strong>获取 Token</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">curl -X POST http://127.0.0.1:8000/custom_login/ -d <span class="hljs-string">"username=admin&amp;password=admin"</span>

AI写代码sh
1
</code></pre>
<p>返回：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span><span class="hljs-attr">"token"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"abc123xyz456"</span><span class="hljs-punctuation">}</span>

AI写代码json
<span class="hljs-number">1</span>
</code></pre>
</li>
<li>
<p><strong>访问受保护 API</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">curl -X GET http://127.0.0.1:8000/protected_view/ -H <span class="hljs-string">"Authorization: abc123xyz456"</span>

AI写代码sh
1
</code></pre>
<p>返回：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span><span class="hljs-attr">"message"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Welcome, you are authenticated!"</span><span class="hljs-punctuation">}</span>

AI写代码json
<span class="hljs-number">1</span>
</code></pre>
</li>
</ol>
<hr/>
<h3 data-id="heading-15"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><strong>五、总结</strong></h3>
<p>本方案介绍了 Django 中实现接口 Token 认证的两种方法：</p>
<ol>
<li><strong>使用 Django REST framework（DRF）的 Token 认证</strong>：适用于 REST API，简单易用。</li>
<li><strong>自定义 Token 认证</strong>：适用于更灵活的需求，可定制 Token 规则、过期策略等。</li>
</ol>
<p>以上代码和步骤确保了 API 的安全性，避免未经授权的访问，适用于 Django Web 项目的用户身份验证。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>