<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[Redis（144）Redis的Cluster的节点通信是如何实现的？]]></title>    <link>https://juejin.cn/post/7576155969605140515</link>    <guid>https://juejin.cn/post/7576155969605140515</guid>    <pubDate>2025-11-24T22:56:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576155969605140515" data-draft-id="7576187677838442511" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis（144）Redis的Cluster的节点通信是如何实现的？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-24T22:56:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis（144）Redis的Cluster的节点通信是如何实现的？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T22:56:42.000Z" title="Mon Nov 24 2025 22:56:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Redis Cluster 的节点通信是其核心功能之一，保证了节点之间的数据同步、故障检测和集群管理。Redis Cluster 使用 Gossip 协议进行节点间通信，并通过 TCP 进行点对点的消息传递。节点间的消息通常包括心跳（Ping/Pong）、故障报告、槽分配信息等。</p>
<h3 data-id="heading-0">节点通信实现步骤</h3>
<ol>
<li><strong>节点发现</strong>：集群节点需要知道其他节点的存在，并与它们建立通信。</li>
<li><strong>心跳检测</strong>：节点之间定期发送心跳消息（Ping），以确认它们的健康状态。</li>
<li><strong>消息处理</strong>：节点收到的消息需要进行解析和处理。</li>
<li><strong>故障检测</strong>：如果一个节点长时间未响应心跳消息，它可能会被标记为失败。</li>
<li><strong>数据同步</strong>：节点间的数据变化（例如槽分配）需要同步到整个集群。</li>
</ol>
<h3 data-id="heading-1">详细实现步骤和代码示例</h3>
<h4 data-id="heading-2">1. 节点发现</h4>
<p>节点发现是通过配置文件或启动参数指定集群的初始节点，然后通过这些初始节点发现其他节点。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">define</span> MAX_NODES 10</span>

<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">clusterNode</span> {</span>
    <span class="hljs-type">char</span> name[<span class="hljs-number">40</span>];      <span class="hljs-comment">/* Node ID */</span>
    <span class="hljs-type">char</span> ip[<span class="hljs-number">16</span>];        <span class="hljs-comment">/* Node IP */</span>
    <span class="hljs-type">int</span> port;           <span class="hljs-comment">/* Node Port */</span>
} clusterNode;

<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cluster</span> {</span>
    clusterNode nodes[MAX_NODES];
    <span class="hljs-type">int</span> node_count;
} cluster;

<span class="hljs-comment">/* Function to add a node to the cluster */</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">addNode</span><span class="hljs-params">(cluster *cl, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *name, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *ip, <span class="hljs-type">int</span> port)</span> {
    <span class="hljs-keyword">if</span> (cl-&gt;node_count &lt; MAX_NODES) {
        <span class="hljs-built_in">strcpy</span>(cl-&gt;nodes[cl-&gt;node_count].name, name);
        <span class="hljs-built_in">strcpy</span>(cl-&gt;nodes[cl-&gt;node_count].ip, ip);
        cl-&gt;nodes[cl-&gt;node_count].port = port;
        cl-&gt;node_count++;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Cluster node limit reached\n"</span>);
    }
}

<span class="hljs-comment">/* Example usage */</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {
    cluster cl = {<span class="hljs-number">0</span>};

    addNode(&amp;cl, <span class="hljs-string">"node1"</span>, <span class="hljs-string">"192.168.1.1"</span>, <span class="hljs-number">6379</span>);
    addNode(&amp;cl, <span class="hljs-string">"node2"</span>, <span class="hljs-string">"192.168.1.2"</span>, <span class="hljs-number">6379</span>);

    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; cl.node_count; i++) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Node %s: %s:%d\n"</span>, cl.nodes[i].name, cl.nodes[i].ip, cl.nodes[i].port);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h4 data-id="heading-3">2. 心跳检测</h4>
<p>心跳消息用于节点之间的健康检查，通常是 Ping/Pong 消息，用于确认节点是否在线。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;time.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">define</span> HEARTBEAT_INTERVAL 1000  <span class="hljs-comment">// 1 second</span></span>

<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">clusterNode</span> {</span>
    <span class="hljs-type">char</span> name[<span class="hljs-number">40</span>];      <span class="hljs-comment">/* Node ID */</span>
    <span class="hljs-type">char</span> ip[<span class="hljs-number">16</span>];        <span class="hljs-comment">/* Node IP */</span>
    <span class="hljs-type">int</span> port;           <span class="hljs-comment">/* Node Port */</span>
    <span class="hljs-type">time_t</span> last_heartbeat; <span class="hljs-comment">/* Last time a heartbeat was received */</span>
} clusterNode;

<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cluster</span> {</span>
    clusterNode nodes[MAX_NODES];
    <span class="hljs-type">int</span> node_count;
} cluster;

<span class="hljs-comment">/* Function to send heartbeat message */</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">sendHeartbeat</span><span class="hljs-params">(clusterNode *node)</span> {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Sending heartbeat to node %s\n"</span>, node-&gt;name);
    <span class="hljs-comment">// In a real implementation, here you would send a PING message over the network.</span>
    node-&gt;last_heartbeat = time(<span class="hljs-literal">NULL</span>);
}

<span class="hljs-comment">/* Function to check for node failures based on heartbeat */</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">checkHeartbeat</span><span class="hljs-params">(clusterNode *node)</span> {
    <span class="hljs-type">time_t</span> now = time(<span class="hljs-literal">NULL</span>);
    <span class="hljs-keyword">if</span> (now - node-&gt;last_heartbeat &gt; HEARTBEAT_INTERVAL) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Node %s is not responding\n"</span>, node-&gt;name);
        <span class="hljs-comment">// Mark node as failed</span>
        <span class="hljs-comment">// In a real implementation, update the node's status</span>
    }
}

<span class="hljs-comment">/* Example usage */</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {
    clusterNode node = {<span class="hljs-string">"node1"</span>, <span class="hljs-string">"192.168.1.1"</span>, <span class="hljs-number">6379</span>, time(<span class="hljs-literal">NULL</span>)};

    <span class="hljs-comment">// Periodically send heartbeat</span>
    sendHeartbeat(&amp;node);

    <span class="hljs-comment">// Simulate a delay in heartbeat</span>
    node.last_heartbeat = time(<span class="hljs-literal">NULL</span>) - <span class="hljs-number">2</span>;

    <span class="hljs-comment">// Check heartbeat</span>
    checkHeartbeat(&amp;node);

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h4 data-id="heading-4">3. 消息处理</h4>
<p>节点收到的消息需要进行解析和处理，根据消息类型执行不同的操作。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span>

<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">clusterNode</span> {</span>
    <span class="hljs-type">char</span> name[<span class="hljs-number">40</span>];      <span class="hljs-comment">/* Node ID */</span>
    <span class="hljs-type">char</span> ip[<span class="hljs-number">16</span>];        <span class="hljs-comment">/* Node IP */</span>
    <span class="hljs-type">int</span> port;           <span class="hljs-comment">/* Node Port */</span>
    <span class="hljs-comment">// other fields...</span>
} clusterNode;

<span class="hljs-comment">/* Enum for message types */</span>
<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">enum</span> {</span>
    MSG_TYPE_PING,
    MSG_TYPE_PONG,
    MSG_TYPE_FAIL,
    <span class="hljs-comment">// other message types...</span>
} msgType;

<span class="hljs-comment">/* Function to process received messages */</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">processMessage</span><span class="hljs-params">(clusterNode *node, msgType type)</span> {
    <span class="hljs-keyword">switch</span> (type) {
        <span class="hljs-keyword">case</span> MSG_TYPE_PING:
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Received PING from node %s\n"</span>, node-&gt;name);
            <span class="hljs-comment">// Send PONG response</span>
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> MSG_TYPE_PONG:
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Received PONG from node %s\n"</span>, node-&gt;name);
            <span class="hljs-comment">// Update node status</span>
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> MSG_TYPE_FAIL:
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Received FAIL for node %s\n"</span>, node-&gt;name);
            <span class="hljs-comment">// Mark node as failed</span>
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">default</span>:
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Unknown message type\n"</span>);
            <span class="hljs-keyword">break</span>;
    }
}

<span class="hljs-comment">/* Example usage */</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {
    clusterNode node = {<span class="hljs-string">"node1"</span>, <span class="hljs-string">"192.168.1.1"</span>, <span class="hljs-number">6379</span>};

    <span class="hljs-comment">// Simulate receiving a PING message</span>
    processMessage(&amp;node, MSG_TYPE_PING);

    <span class="hljs-comment">// Simulate receiving a PONG message</span>
    processMessage(&amp;node, MSG_TYPE_PONG);

    <span class="hljs-comment">// Simulate receiving a FAIL message</span>
    processMessage(&amp;node, MSG_TYPE_FAIL);

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h4 data-id="heading-5">4. 故障检测</h4>
<p>通过心跳检测和故障报告，节点可以检测到其他节点的故障，并采取相应的措施。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;time.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">define</span> HEARTBEAT_INTERVAL 1000  <span class="hljs-comment">// 1 second</span></span>

<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">clusterNode</span> {</span>
    <span class="hljs-type">char</span> name[<span class="hljs-number">40</span>];      <span class="hljs-comment">/* Node ID */</span>
    <span class="hljs-type">char</span> ip[<span class="hljs-number">16</span>];        <span class="hljs-comment">/* Node IP */</span>
    <span class="hljs-type">int</span> port;           <span class="hljs-comment">/* Node Port */</span>
    <span class="hljs-type">time_t</span> last_heartbeat; <span class="hljs-comment">/* Last time a heartbeat was received */</span>
    <span class="hljs-type">int</span> flags;          <span class="hljs-comment">/* Node flags: fail, etc. */</span>
} clusterNode;

<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cluster</span> {</span>
    clusterNode nodes[MAX_NODES];
    <span class="hljs-type">int</span> node_count;
} cluster;

<span class="hljs-meta">#<span class="hljs-keyword">define</span> CLUSTER_NODE_FAIL 0x01</span>

<span class="hljs-comment">/* Function to send heartbeat message */</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">sendHeartbeat</span><span class="hljs-params">(clusterNode *node)</span> {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Sending heartbeat to node %s\n"</span>, node-&gt;name);
    <span class="hljs-comment">// In a real implementation, here you would send a PING message over the network.</span>
    node-&gt;last_heartbeat = time(<span class="hljs-literal">NULL</span>);
}

<span class="hljs-comment">/* Function to check for node failures based on heartbeat */</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">checkHeartbeat</span><span class="hljs-params">(clusterNode *node)</span> {
    <span class="hljs-type">time_t</span> now = time(<span class="hljs-literal">NULL</span>);
    <span class="hljs-keyword">if</span> (now - node-&gt;last_heartbeat &gt; HEARTBEAT_INTERVAL) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Node %s is not responding\n"</span>, node-&gt;name);
        <span class="hljs-comment">// Mark node as failed</span>
        node-&gt;flags |= CLUSTER_NODE_FAIL;
    }
}

<span class="hljs-comment">/* Example usage */</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {
    clusterNode node = {<span class="hljs-string">"node1"</span>, <span class="hljs-string">"192.168.1.1"</span>, <span class="hljs-number">6379</span>, time(<span class="hljs-literal">NULL</span>), <span class="hljs-number">0</span>};

    <span class="hljs-comment">// Periodically send heartbeat</span>
    sendHeartbeat(&amp;node);

    <span class="hljs-comment">// Simulate a delay in heartbeat</span>
    node.last_heartbeat = time(<span class="hljs-literal">NULL</span>) - <span class="hljs-number">2</span>;

    <span class="hljs-comment">// Check heartbeat</span>
    checkHeartbeat(&amp;node);

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h4 data-id="heading-6">5. 数据同步</h4>
<p>节点之间的数据变化（如槽分配）需要同步到整个集群。这里我们模拟槽分配的同步。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">define</span> HASH_SLOTS 16384</span>

<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">clusterNode</span> {</span>
    <span class="hljs-type">char</span> name[<span class="hljs-number">40</span>];      <span class="hljs-comment">/* Node ID */</span>
    <span class="hljs-type">char</span> ip[<span class="hljs-number">16</span>];        <span class="hljs-comment">/* Node IP */</span>
    <span class="hljs-type">int</span> port;           <span class="hljs-comment">/* Node Port */</span>
    <span class="hljs-type">int</span> start_slot;     <span class="hljs-comment">/* Start hash slot */</span>
    <span class="hljs-type">int</span> end_slot;       <span class="hljs-comment">/* End hash slot */</span>
} clusterNode;

<span class="hljs-comment">/* Function to synchronize slot information */</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">syncSlotInfo</span><span class="hljs-params">(clusterNode *nodes, <span class="hljs-type">int</span> node_count)</span> {
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; node_count; i++) {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; node_count; j++) {
            <span class="hljs-keyword">if</span> (i != j) {
                <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Synchronizing slot info from node %s to node %s\n"</span>, nodes[i].name, nodes[j].name);
                <span class="hljs-comment">// In a real implementation, here you would send the slot information over the network.</span>
            }
        }
    }
}

<span class="hljs-comment">/* Example usage */</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {
    clusterNode nodes[<span class="hljs-number">2</span>] = {
        {<span class="hljs-string">"node1"</span>, <span class="hljs-string">"192.168.1.1"</span>, <span class="hljs-number">6379</span>, <span class="hljs-number">0</span>, <span class="hljs-number">5460</span>},
        {<span class="hljs-string">"node2"</span>, <span class="hljs-string">"192.168.1.2"</span>, <span class="hljs-number">6379</span>, <span class="hljs-number">5461</span>, <span class="hljs-number">10921</span>}
    };

    syncSlotInfo(nodes, <span class="hljs-number">2</span>);

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis（145）Redis的Cluster的扩展性如何？]]></title>    <link>https://juejin.cn/post/7576181197661175808</link>    <guid>https://juejin.cn/post/7576181197661175808</guid>    <pubDate>2025-11-24T22:57:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576181197661175808" data-draft-id="7576130918078054435" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis（145）Redis的Cluster的扩展性如何？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-24T22:57:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis（145）Redis的Cluster的扩展性如何？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T22:57:28.000Z" title="Mon Nov 24 2025 22:57:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Redis Cluster 的扩展性设计旨在支持水平扩展，使得在数据量增大和负载增加时，可以通过增加节点来分担压力。Redis Cluster 通过哈希槽（hash slots）机制将数据分布在多个节点上，扩展性主要体现在以下几个方面：</p>
<ol>
<li><strong>节点增加</strong>：支持动态增加节点，以扩展集群的存储容量和处理能力。</li>
<li><strong>重新分片</strong>：在新增节点或移除节点时，能够平衡数据分布，重新分配哈希槽。</li>
<li><strong>高可用性</strong>：通过主从复制及自动故障转移机制，确保集群的高可用性。</li>
</ol>
<p>以下内容详细描述 Redis Cluster 的扩展性，并结合示例代码进行说明。</p>
<h3 data-id="heading-0">1. 节点增加</h3>
<p>增加节点是 Redis Cluster 扩展性的基础，通过增加节点，可以将更多的哈希槽分配到新的节点上，从而扩展存储容量和处理能力。</p>
<h4 data-id="heading-1">代码示例</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">define</span> MAX_NODES 10</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> HASH_SLOTS 16384</span>

<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">clusterNode</span> {</span>
    <span class="hljs-type">char</span> name[<span class="hljs-number">40</span>];      <span class="hljs-comment">/* Node ID */</span>
    <span class="hljs-type">char</span> ip[<span class="hljs-number">16</span>];        <span class="hljs-comment">/* Node IP */</span>
    <span class="hljs-type">int</span> port;           <span class="hljs-comment">/* Node Port */</span>
    <span class="hljs-type">int</span> start_slot;     <span class="hljs-comment">/* Start hash slot */</span>
    <span class="hljs-type">int</span> end_slot;       <span class="hljs-comment">/* End hash slot */</span>
} clusterNode;

<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cluster</span> {</span>
    clusterNode nodes[MAX_NODES];
    <span class="hljs-type">int</span> node_count;
} cluster;

<span class="hljs-comment">/* Function to add a new node to the cluster */</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">addNode</span><span class="hljs-params">(cluster *cl, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *name, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *ip, <span class="hljs-type">int</span> port)</span> {
    <span class="hljs-keyword">if</span> (cl-&gt;node_count &lt; MAX_NODES) {
        <span class="hljs-built_in">strcpy</span>(cl-&gt;nodes[cl-&gt;node_count].name, name);
        <span class="hljs-built_in">strcpy</span>(cl-&gt;nodes[cl-&gt;node_count].ip, ip);
        cl-&gt;nodes[cl-&gt;node_count].port = port;
        cl-&gt;nodes[cl-&gt;node_count].start_slot = <span class="hljs-number">-1</span>;  <span class="hljs-comment">// Initial value, to be assigned later</span>
        cl-&gt;nodes[cl-&gt;node_count].end_slot = <span class="hljs-number">-1</span>;    <span class="hljs-comment">// Initial value, to be assigned later</span>
        cl-&gt;node_count++;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Cluster node limit reached\n"</span>);
    }
}

<span class="hljs-comment">/* Example usage */</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {
    cluster cl = {<span class="hljs-number">0</span>};

    addNode(&amp;cl, <span class="hljs-string">"node1"</span>, <span class="hljs-string">"192.168.1.1"</span>, <span class="hljs-number">6379</span>);
    addNode(&amp;cl, <span class="hljs-string">"node2"</span>, <span class="hljs-string">"192.168.1.2"</span>, <span class="hljs-number">6379</span>);

    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; cl.node_count; i++) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Node %s: %s:%d, Slots: %d-%d\n"</span>, cl.nodes[i].name, cl.nodes[i].ip, cl.nodes[i].port, cl.nodes[i].start_slot, cl.nodes[i].end_slot);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h3 data-id="heading-2">2. 重新分片</h3>
<p>当新增节点时，需要将一些哈希槽重新分配到新的节点上，以实现负载均衡。重新分片的过程包括选择要迁移的槽、将槽的数据从源节点迁移到目标节点，以及更新集群状态。</p>
<h4 data-id="heading-3">代码示例</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span>

<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">clusterNode</span> {</span>
    <span class="hljs-type">char</span> name[<span class="hljs-number">40</span>];      <span class="hljs-comment">/* Node ID */</span>
    <span class="hljs-type">char</span> ip[<span class="hljs-number">16</span>];        <span class="hljs-comment">/* Node IP */</span>
    <span class="hljs-type">int</span> port;           <span class="hljs-comment">/* Node Port */</span>
    <span class="hljs-type">int</span> start_slot;     <span class="hljs-comment">/* Start hash slot */</span>
    <span class="hljs-type">int</span> end_slot;       <span class="hljs-comment">/* End hash slot */</span>
} clusterNode;

<span class="hljs-comment">/* Function to determine which slots to migrate */</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">selectSlotsToMigrate</span><span class="hljs-params">(clusterNode *src, clusterNode *dst, <span class="hljs-type">int</span> num_slots)</span> {
    <span class="hljs-type">int</span> mid = src-&gt;start_slot + (src-&gt;end_slot - src-&gt;start_slot) / <span class="hljs-number">2</span>;
    dst-&gt;start_slot = mid + <span class="hljs-number">1</span>;
    dst-&gt;end_slot = src-&gt;end_slot;
    src-&gt;end_slot = mid;
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Migrating slots %d-%d from node %s to node %s\n"</span>, dst-&gt;start_slot, dst-&gt;end_slot, src-&gt;name, dst-&gt;name);
}

<span class="hljs-comment">/* Function to migrate slot data */</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">migrateSlotData</span><span class="hljs-params">(clusterNode *src, clusterNode *dst, <span class="hljs-type">int</span> slot)</span> {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Migrating data for slot %d from node %s to node %s\n"</span>, slot, src-&gt;name, dst-&gt;name);
    <span class="hljs-comment">// In a real implementation, data migration would occur here</span>
}

<span class="hljs-comment">/* Function to perform resharding */</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">reshard</span><span class="hljs-params">(clusterNode *nodes, <span class="hljs-type">int</span> node_count)</span> {
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; node_count; i++) {
        <span class="hljs-keyword">if</span> (nodes[i].start_slot == <span class="hljs-number">-1</span>) {
            <span class="hljs-comment">// This is the new node, so we need to reshard</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; node_count; j++) {
                <span class="hljs-keyword">if</span> (i != j &amp;&amp; nodes[j].end_slot &gt; nodes[j].start_slot) {
                    selectSlotsToMigrate(&amp;nodes[j], &amp;nodes[i], (nodes[j].end_slot - nodes[j].start_slot) / <span class="hljs-number">2</span>);
                    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> slot = nodes[i].start_slot; slot &lt;= nodes[i].end_slot; slot++) {
                        migrateSlotData(&amp;nodes[j], &amp;nodes[i], slot);
                    }
                    <span class="hljs-keyword">break</span>;
                }
            }
            <span class="hljs-keyword">break</span>;
        }
    }
}

<span class="hljs-comment">/* Example usage */</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {
    clusterNode nodes[<span class="hljs-number">3</span>] = {
        {<span class="hljs-string">"node1"</span>, <span class="hljs-string">"192.168.1.1"</span>, <span class="hljs-number">6379</span>, <span class="hljs-number">0</span>, <span class="hljs-number">5460</span>},
        {<span class="hljs-string">"node2"</span>, <span class="hljs-string">"192.168.1.2"</span>, <span class="hljs-number">6379</span>, <span class="hljs-number">5461</span>, <span class="hljs-number">10921</span>},
        {<span class="hljs-string">"node3"</span>, <span class="hljs-string">"192.168.1.3"</span>, <span class="hljs-number">6379</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">-1</span>}  <span class="hljs-comment">// New node</span>
    };

    reshard(nodes, <span class="hljs-number">3</span>);

    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Node %s: %s:%d, Slots: %d-%d\n"</span>, nodes[i].name, nodes[i].ip, nodes[i].port, nodes[i].start_slot, nodes[i].end_slot);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h3 data-id="heading-4">3. 高可用性</h3>
<p>Redis Cluster 通过主从复制和自动故障转移机制，确保节点故障时的高可用性。在扩展集群时，也需要确保这些机制的正常工作。</p>
<h4 data-id="heading-5">代码示例</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;time.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">define</span> MAX_NODES 10</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> HEARTBEAT_INTERVAL 1000  <span class="hljs-comment">// 1 second</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> CLUSTER_NODE_FAIL 0x01</span>

<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">clusterNode</span> {</span>
    <span class="hljs-type">char</span> name[<span class="hljs-number">40</span>];      <span class="hljs-comment">/* Node ID */</span>
    <span class="hljs-type">char</span> ip[<span class="hljs-number">16</span>];        <span class="hljs-comment">/* Node IP */</span>
    <span class="hljs-type">int</span> port;           <span class="hljs-comment">/* Node Port */</span>
    <span class="hljs-type">int</span> start_slot;     <span class="hljs-comment">/* Start hash slot */</span>
    <span class="hljs-type">int</span> end_slot;       <span class="hljs-comment">/* End hash slot */</span>
    <span class="hljs-type">int</span> flags;          <span class="hljs-comment">/* Node flags: fail, etc. */</span>
    <span class="hljs-type">time_t</span> last_heartbeat; <span class="hljs-comment">/* Last time a heartbeat was received */</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">clusterNode</span> *<span class="hljs-title">slaveof</span>;</span> <span class="hljs-comment">/* Master of this node if it's a slave */</span>
} clusterNode;

<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cluster</span> {</span>
    clusterNode nodes[MAX_NODES];
    <span class="hljs-type">int</span> node_count;
} cluster;

<span class="hljs-comment">/* Function to add a new node to the cluster */</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">addNode</span><span class="hljs-params">(cluster *cl, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *name, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *ip, <span class="hljs-type">int</span> port)</span> {
    <span class="hljs-keyword">if</span> (cl-&gt;node_count &lt; MAX_NODES) {
        <span class="hljs-built_in">strcpy</span>(cl-&gt;nodes[cl-&gt;node_count].name, name);
        <span class="hljs-built_in">strcpy</span>(cl-&gt;nodes[cl-&gt;node_count].ip, ip);
        cl-&gt;nodes[cl-&gt;node_count].port = port;
        cl-&gt;nodes[cl-&gt;node_count].start_slot = <span class="hljs-number">-1</span>;  <span class="hljs-comment">// Initial value, to be assigned later</span>
        cl-&gt;nodes[cl-&gt;node_count].end_slot = <span class="hljs-number">-1</span>;    <span class="hljs-comment">// Initial value, to be assigned later</span>
        cl-&gt;nodes[cl-&gt;node_count].flags = <span class="hljs-number">0</span>;
        cl-&gt;nodes[cl-&gt;node_count].last_heartbeat = time(<span class="hljs-literal">NULL</span>);
        cl-&gt;nodes[cl-&gt;node_count].slaveof = <span class="hljs-literal">NULL</span>;
        cl-&gt;node_count++;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Cluster node limit reached\n"</span>);
    }
}

<span class="hljs-comment">/* Function to send heartbeat message */</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">sendHeartbeat</span><span class="hljs-params">(clusterNode *node)</span> {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Sending heartbeat to node %s\n"</span>, node-&gt;name);
    node-&gt;last_heartbeat = time(<span class="hljs-literal">NULL</span>);
}

<span class="hljs-comment">/* Function to check for node failures based on heartbeat */</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">checkHeartbeat</span><span class="hljs-params">(clusterNode *node)</span> {
    <span class="hljs-type">time_t</span> now = time(<span class="hljs-literal">NULL</span>);
    <span class="hljs-keyword">if</span> (now - node-&gt;last_heartbeat &gt; HEARTBEAT_INTERVAL) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Node %s is not responding\n"</span>, node-&gt;name);
        node-&gt;flags |= CLUSTER_NODE_FAIL;
    }
}

<span class="hljs-comment">/* Function to handle failover */</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">handleFailover</span><span class="hljs-params">(cluster *cl, clusterNode *failed_node)</span> {
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; cl-&gt;node_count; i++) {
        <span class="hljs-keyword">if</span> (cl-&gt;nodes[i].slaveof == failed_node) {
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Failover: promoting slave node %s to master\n"</span>, cl-&gt;nodes[i].name);
            cl-&gt;nodes[i].flags &amp;= ~CLUSTER_NODE_FAIL;
            cl-&gt;nodes[i].slaveof = <span class="hljs-literal">NULL</span>;
        }
    }
}

<span class="hljs-comment">/* Example usage */</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {
    cluster cl = {<span class="hljs-number">0</span>};

    addNode(&amp;cl, <span class="hljs-string">"node1"</span>, <span class="hljs-string">"192.168.1.1"</span>, <span class="hljs-number">6379</span>);
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[把一年前写给自己用的翻译软件开源了 | TranslateP]]></title>    <link>https://juejin.cn/post/7576130918077988899</link>    <guid>https://juejin.cn/post/7576130918077988899</guid>    <pubDate>2025-11-24T16:38:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576130918077988899" data-draft-id="7576175307356979235" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="把一年前写给自己用的翻译软件开源了  | TranslateP"/> <meta itemprop="keywords" content="iOS,产品"/> <meta itemprop="datePublished" content="2025-11-24T16:38:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="PJHubs"/> <meta itemprop="url" content="https://juejin.cn/user/307518984162567"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            把一年前写给自己用的翻译软件开源了  | TranslateP
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/307518984162567/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    PJHubs
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T16:38:14.000Z" title="Mon Nov 24 2025 16:38:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>从 24 年 11 月 3 日开始到现在过去了整整一年，当初因为突然间欧陆词典的快捷键翻译彻底失效，导致我忍无可忍的自己从头开始写一个翻译软件给自己用。用业余零碎的时间完善了它，达到了我心中最低可用的效果，当初开发时借鉴了一些开源项目的实现，现在是时候也贡献出来了！</p>
</blockquote>
<p>GitHub 开源仓库地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwindstormeye%2FTranslateP" target="_blank" title="https://github.com/windstormeye/TranslateP" ref="nofollow noopener noreferrer">github.com/windstormey…</a></p>
<p>app store 下载链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fapps.apple.com%2Fcn%2Fapp%2Ftranslatep%2Fid6737735627" target="_blank" title="https://apps.apple.com/cn/app/translatep/id6737735627" ref="nofollow noopener noreferrer">apps.apple.com/cn/app/tran…</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b565346ad6b454c8cf6011759a795e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUEpIdWJz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764607094&amp;x-signature=JmbPlEHvYAx%2F2XcjSto9Y5VBo18%3D" alt="1.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab97be6f133e4316b9780fb099efa3e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUEpIdWJz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764607094&amp;x-signature=RlAsIhDClwJH8iH7W%2FFSCw6UT8M%3D" alt="2.png" loading="lazy"/></p>
<p>本来想写的有很多，但实在是没有更多精力了，就简单介绍下吧。</p>
<p>基于 SwiftUI 实现的在 macOS 上可无网络使用的菜单栏 AI 翻译小工具，目前暂时只支持英译中和中译英，可朗读原文也可查看音标，简单的 UI 样式调整都可以，支持双击两次 cmd + c 快捷键翻译。整个 app 的大小只有 1.3 MB，比一张 iPhone 照片还要小！</p>
<p>我自己用了整整一年的时间，没有任何使用压力，不用担心数据泄漏和网络环境问题，甚至还支持截图翻译。底层的技术都是相通的，feature list 里还有好多想做的没有实现，但经过了一年的时间，真正想做的事情早就应该做了，剩下没做的，大概率算不上核心诉求，也就作罢。</p>
<p>开源的主要目的是原计划年底前找到一个可尝试的商业化方法，尝试在 app 中增加一些内购或者收费点。但思来想去好久，始终找不到合适的收费点，在现如今的背景下，再做翻译工具软件已毫无价值，但意义对于每个人都不同，如果你感兴趣的话，可以阅读我的这两篇开发总结博客，可能有一些帮助。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fpjhubs.com%2F2024%2F11%2F03%2Ftranslatep-init%2F" target="_blank" title="https://pjhubs.com/2024/11/03/translatep-init/" ref="nofollow noopener noreferrer"># 《TranslateP 开发日志 01》- 做了一个翻译软件</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fpjhubs.com%2F2025%2F06%2F21%2Ftranslatep-release-1.0.3%2F" target="_blank" title="https://pjhubs.com/2025/06/21/translatep-release-1.0.3/" ref="nofollow noopener noreferrer"># 《TranslateP 开发日志 02》- 最后一块拼图</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[不愧是国内首个视觉编程模型，一张草稿图直接做了一个电子版City Walk]]></title>    <link>https://juejin.cn/post/7576086557716824115</link>    <guid>https://juejin.cn/post/7576086557716824115</guid>    <pubDate>2025-11-24T14:47:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576086557716824115" data-draft-id="7576141849430097947" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="不愧是国内首个视觉编程模型，一张草稿图直接做了一个电子版City Walk"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-24T14:47:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LucianaiB"/> <meta itemprop="url" content="https://juejin.cn/user/1269294586664749"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            不愧是国内首个视觉编程模型，一张草稿图直接做了一个电子版City Walk
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1269294586664749/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LucianaiB
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T14:47:40.000Z" title="Mon Nov 24 2025 14:47:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>“City Walk”太费腿？那就让AI替你走一遍。</p>
<p>本文记录我如何用 Doubao-Seed-Code —— 国内首个具备原生视觉理解能力的AI编程模型，把一张手绘草图变成一个可交互的“电子城市漫步”应用。全程零代码基础，仅靠对话完成编程。</p>
</blockquote>
<h2 data-id="heading-0">一.背景</h2>
<p>“City Walk”——城市漫步，曾是年轻人逃离内卷的诗意解药：绿灯直行、红灯拐弯、路口掷骰子、遇见小店就进去坐坐，拍一百张照片，只为记录一条无人知晓的小巷。它不为打卡，只为“瞎溜达”。</p>
<p>但对我这种能坐绝不站、能躺绝不坐的懒人来说：</p>
<blockquote>
<p>“走1公里，拍100张照，找3家店，最后发现没带充电宝。”</p>
</blockquote>
<p>于是，我灵机一动：为什么不做一个“电子版City Walk”？如果有合适的，我在出门。</p>
<p>不用出门，打开网页，点击“开始漫步”，AI就带着我在城市里“瞎溜达”——绿灯直行、红灯拐弯、路口掷骰子，还能推荐路边的宝藏咖啡馆和涂鸦墙。</p>
<p><strong>左侧为草稿图，右侧为使用 Doubao-Seed-Code 编程的效果。</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a69fc864a7fa4330a1f6fa084f542e82~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764600460&amp;x-signature=54PL8nhxi1pNscge7vTPmH4FN%2Fc%3D" alt="" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aff6156f64d2449db1321e02160c7c98~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764600460&amp;x-signature=ChSNdl0BzZPns%2FAWtjgTcOUQ8ew%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">二.相关介绍</h2>
<h3 data-id="heading-2"><strong>工具选择：为什么是 Doubao-Seed-Code？</strong></h3>
<p>Doubao-Seed-Code 是一款专为 "Agentic Coding"任务深度优化的全新代码模型。它为真实的、复杂的编程任务而设计，在长上下文理解、任务规划、代码生成与调试方面均有卓越表现。</p>
<p>我试过多个主流AI编程模型（Claude 3.5、GPT-4o、GLM-4、DeepSeek-Coder），但它们要么：</p>
<ul>
<li>❌ 无法理解图片（只能靠文字描述）</li>
<li>❌ 生成的界面五花八门，完全偏离草图</li>
<li>❌ 需要手动拆解“地图+随机路线+骰子+POI推荐”等复杂逻辑，效率极低</li>
</ul>
<p>直到我发现了 <strong>火山引擎的 Doubao-Seed-Code</strong>。</p>
<p><strong>✅ 它的三大杀手锏，直接击中我的痛点：</strong></p>

























<table><thead><tr><th>能力</th><th>普通模型</th><th>Doubao-Seed-Code</th></tr></thead><tbody><tr><td>视觉理解</td><td>❌ 依赖OCR/文本转述（信息丢失）</td><td>✅ 原生VLM，直接看图写代码，0损失</td></tr><tr><td>长上下文</td><td>通常≤32K</td><td>✅ 256K，整项目代码+图片+需求全塞进去</td></tr><tr><td>成本</td><td>业内均价高</td><td>✅ 综合成本低62.7%，首月9.9元起</td></tr></tbody></table>
<blockquote>
<p><strong>关键点：</strong> 它不是“能看图”，而是<strong>真正理解图中的布局、交互、语义关系</strong>——比如我草图里左下角的“骰子”和“向右喝咖啡”，它知道那是两个独立的交互模块，不是随便画的装饰。</p>
</blockquote>
<hr/>
<h2 data-id="heading-3"><strong>三.全程“对话式开发”</strong></h2>
<h3 data-id="heading-4">前置准备</h3>
<p>虽然使用的是Doubao-Seed-Code这个国内首个具备视觉理解能力的编程模型，但是这在他的人家官方公司，我们没办法直接用，所以可以通过 Claude Code去调用 Doubao-Seed-Code ，另外，在火山方舟平台也是提供API调用。</p>
<blockquote>
<p><strong>仅需 5s 在Claude Code 丝滑接入 Doubao-Seed-Code</strong></p>
</blockquote>
<p>在启动 Claude Code 前输入环境变量（以Windows为例）：</p>
<pre><code class="hljs language-arduino" lang="arduino">setx ANTHROPIC_AUTH_TOKEN ARK_API_KEY
setx ANTHROPIC_BASE_URL https:<span class="hljs-comment">//ark.cn-beijing.volces.com/api/coding</span>
setx ANTHROPIC_MODEL doubao-seed-code-preview-latest
</code></pre>
<p>📌注意：换为你自己的，来这里获取 -&gt; <a href="https://link.juejin.cn?target=https%3A%2F%2Fconsole.volcengine.com%2Fark%2Fregion%3Aark%2Bcn-beijing%2Fapikey" target="_blank" title="https://console.volcengine.com/ark/region:ark+cn-beijing/apikey" ref="nofollow noopener noreferrer">console.volcengine.com/ark/region:…</a></p>
<p>📚如果有不会的地方可以看官方教程来配置：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.volcengine.com%2Fdocs%2F82379%2F1928262" target="_blank" title="https://www.volcengine.com/docs/82379/1928262" ref="nofollow noopener noreferrer">www.volcengine.com/docs/82379/…</a></p>
<p>真消费才敢说真话。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/acf59beee6ae4940912711c67333dcdd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764600460&amp;x-signature=sHIxwZMG%2Bbltr%2Fp8ngumHKvoYOU%3D" alt="" loading="lazy"/></p>
<p>使用指令导航到指定目录，并启动claude:</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">C:\Users\18432&gt; D:</span>
<span class="hljs-section">D:&gt; cd 目标</span>
<span class="hljs-section">D:\目标&gt;claude</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eba4feaf691342a2a8157fa0a5edbf8f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764600460&amp;x-signature=IrkU%2Fie85gq2x9TDtqvLcyk%2BnK0%3D" alt="" loading="lazy"/></p>
<p>可以看到如图所示成功启动并使用Doubao-Seed-Code模型， 兼容了原本的 Anthropic API，对于使用Claude Code的开发者，几乎零成本 将 API 切换到 Doubao-Seed-Code，完全无缝，像换了“引擎”，但方向盘还是原来的。</p>
<h3 data-id="heading-5">🖼️ 图片理解测评</h3>
<p>听说 Doubao-Seed-Code 是国内首个具备视觉理解能力的编程模型，我直接把我本次的草稿图直接给了他，看他理解的怎么样？</p>
<p>草稿图原图（其中有多个地名为干扰选项）</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/869f153a727643f1803b234fdcef6cae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764600460&amp;x-signature=3Gst%2BwxElNsjpYt7WXGkXDq3g5g%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e426509bdfc34509b3f5d263b671864a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764600460&amp;x-signature=MLJbNaT2xlkq0TJnIZMADOEvkaQ%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>💡 不是“猜”出来的，是“看懂”了。</p>
</blockquote>
<p>VLM训练需要专业团队和数据积累，有一定技术壁垒，doubao 系列模型一直以来视觉理解能力非常强，Seed-Code 模型保持了这个优势，在国内，要么模型不具备视觉理解能力，要么需要依赖MCP实现，将图片转化成语义描述供模型理解，过程中消耗token，效果远不及原生VLM能力，项目开发，只有真正的理解，才能大幅提升前端开发效率。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c960a813ba14963a0265d3c9d4a97d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764600460&amp;x-signature=pWEMg1GbeKiALmUW6LyeKQOL3G0%3D" alt="" loading="lazy"/></p>
<p><strong>下面是端到端模型训练的下游指标评测结果：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47ff0aea0afd4fa999801ac78b1d7eda~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764600460&amp;x-signature=ZpW8pyLyOrI2nTEVMdmVa1nnyto%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">📌 实战 AI 开发</h3>
<p>直接把下面的提示词扔给他</p>
<pre><code class="hljs">请帮我设计并生成一个“电子版City Walk”项目方案。规则如下：
1.项目简介：
电子版City Walk基于“瞎溜达”理念，模拟城市漫无目的漫步。
遵循“绿灯直行，红灯拐弯，遇路口随机选择方向”的逻辑生成步行路线。
路线生成结合兴趣点推荐，重点推介小众有趣的咖啡馆、小店、街头艺术等。
用户可以线上“电子走一遍”这条路线，查看地图和沿途店铺景点卡片。
支持路线保存、复盘和分享。
2.主要功能需求：
地图展示与交互（基于高德基础地图API，直接使用我的API： fdda8428fc94）：显示地图、起点、动态路线与兴趣点标记。
起点选取与定位功能：自动定位或手动选择起点城市和具体位置。
路线生成规则：结合步行路径规划API和随机决策算法，实现仿真“红绿灯”及“猜拳”路口选择。
沿途兴趣点推荐模块，智能筛查高评分非连锁商店和特色地点。
电子City Walk模拟导航，用户可点击“下一步”体验虚拟行走过程。
路线生成后自动生成图文路线作品，支持用户收藏和分享。
后续拓展包括路线评价、个性化推荐和自然语言描述。
3.技术架构
采用前后端分离的方式去写代码，后端用Python代码，地图展示与交互（基于高德基础地图API，直接使用我的API： fdda8428fc9485f355b24b1c76f6f147）
4.草稿图如附件（（仅为例子，全部具体实现））
背景是当前的位置，会根据高德自动找到前方路口，选择路线会出现的兴趣点推荐
左下角展示（仅为例子，你具体实现）：
本次随机的结果
向右可以喝咖啡(咖啡的特色）
向左可以吃烧烤（这家烧烤..…..网上的具体评价等）
右下角展示
一个随机展示筛子
绿灯直行，红灯拐弯（筛子左右）
</code></pre>
<p>第一次生成的效果如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28c0a9ac172e4d7a94d42438820fb9cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764600460&amp;x-signature=MgZ4WUye%2F04R5nhJYsl6KOdXxos%3D" alt="" loading="lazy"/></p>
<p>虽然没有具体使用高德，但是在这个的布局上和我的草稿没有什么区别。</p>
<h3 data-id="heading-7">迭代：多轮对话，越聊越准</h3>
<p><strong>为让效果更好，我们多尝试、跟模型多轮对话，效果好于一次性对话</strong></p>
<p>接下来就是漫长的迭代~</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d883ec09369846c19438ab13e09f5ee2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764600460&amp;x-signature=pSHraAYKrOTvIZvtgP78kMHcyFY%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>第一次生成的版本，骰子是静态图片。我说：“让它能转起来，像真骰子一样。”</p>
</blockquote>
<p>它立刻改成了CSS动画 + JS随机数控制。</p>
<blockquote>
<p>我说：“咖啡馆的推荐文案太假了，要真实评价。”</p>
</blockquote>
<p>它从网络抓取了真实用户对“北京胡同咖啡馆”的点评，自动生成了3条风格迥异的文案。</p>
<blockquote>
<p>我说：“能不能加个‘暂停’按钮？”</p>
</blockquote>
<p>它加了，还顺手做了个“进度条”和“已走距离”。</p>
<p>全程无代码干预，纯对话。</p>
<p>看看最终效果吧~</p>
<p><strong>左侧为草稿图，右侧为使用 Doubao-Seed-Code 编程的效果。</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6914de27aeee47ebb4896cdc0230b43d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764600460&amp;x-signature=MCBYV4DnXKUuf%2FawWvtne4VbnvU%3D" alt="" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d755fb0654140d08141d5b6dbfd6712~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764600460&amp;x-signature=AXdJbe5QKWiveM6pOWN094EBrlY%3D" alt="" loading="lazy"/></p>
<p>下面是生成的README.md的文件，准确的识别了图片，以及分析图片所描述的功能等。</p>
<pre><code class="hljs language-markdown" lang="markdown"> # 电子城市盲盒 - 随机城市漫步导航应用

<span class="hljs-section">## 项目简介</span>

电子城市盲盒是一款创新的城市漫步导航应用，通过随机路线生成和交互式导航，让用户体验充满惊喜的城市探索之旅。用户只需选择起点，系统将随机生成一条充满未知的路线，并在旅途中提供实时导航、兴趣点推荐和随机事件（如红绿灯决策），使每次漫步都充满新鲜感。

<span class="hljs-section">## 核心功能</span>

<span class="hljs-section">### 🎲 随机路线生成</span>
<span class="hljs-bullet">-</span> 基于起点位置智能生成1-5公里的随机探索路线
<span class="hljs-bullet">-</span> 结合高德地图API实现真实道路导航
<span class="hljs-bullet">-</span> 支持路径随机化，每次生成不同的探索体验

<span class="hljs-section">### 🚦 交互式决策系统</span>
<span class="hljs-bullet">-</span> 基于骰子结果的红绿灯决策机制
<span class="hljs-bullet">-</span> 提供多种可能的行进方向选择
<span class="hljs-bullet">-</span> 增强游戏化体验和探索趣味性

<span class="hljs-section">### 📍 智能兴趣点推荐</span>
<span class="hljs-bullet">-</span> 沿途兴趣点自动发现和推荐
<span class="hljs-bullet">-</span> 支持多种POI类型（咖啡厅、书店、公园、艺术馆等）
<span class="hljs-bullet">-</span> 丰富用户探索体验和文化发现

<span class="hljs-section">### 🧭 沉浸式导航体验</span>
<span class="hljs-bullet">-</span> 实时地图显示和路线追踪
<span class="hljs-bullet">-</span> 步骤式导航指引和进度显示
<span class="hljs-bullet">-</span> 暂停/继续功能，灵活控制探索节奏

<span class="hljs-section">### 📸 路线作品生成与分享</span>
<span class="hljs-bullet">-</span> 一键保存完整路线信息和探索轨迹
<span class="hljs-bullet">-</span> 自定义路线标题和描述
<span class="hljs-bullet">-</span> 生成分享链接和二维码，分享您的探索故事

<span class="hljs-section">## 技术架构</span>

<span class="hljs-section">### 前端</span>
<span class="hljs-bullet">-</span> <span class="hljs-strong">**框架**</span> : React 18 + Vite
<span class="hljs-bullet">-</span> <span class="hljs-strong">**地图集成**</span> : 高德地图JavaScript API
<span class="hljs-bullet">-</span> <span class="hljs-strong">**状态管理**</span> : React Hooks
<span class="hljs-bullet">-</span> <span class="hljs-strong">**样式方案**</span> : styled-components
<span class="hljs-bullet">-</span> <span class="hljs-strong">**UI组件**</span> : 自定义React组件

<span class="hljs-section">### 后端</span>
<span class="hljs-bullet">-</span> <span class="hljs-strong">**框架**</span> : FastAPI
<span class="hljs-bullet">-</span> <span class="hljs-strong">**地图服务**</span> : 高德地图REST API
<span class="hljs-bullet">-</span> <span class="hljs-strong">**业务逻辑**</span> : 路线生成算法、红绿灯决策系统、POI搜索服务
<span class="hljs-bullet">-</span> <span class="hljs-strong">**部署**</span> : Uvicorn ASGI服务器

<span class="hljs-section">## 快速开始</span>

<span class="hljs-section">### 前置条件</span>
<span class="hljs-bullet">-</span> Python 3.8+
<span class="hljs-bullet">-</span> Node.js 16+
<span class="hljs-bullet">-</span> npm 8+

<span class="hljs-section">### 安装与运行</span>

<span class="hljs-section">#### 1. 克隆项目</span>
<span class="hljs-code">```bash
git clone [仓库地址]
cd 电子城市盲盒
```</span>

<span class="hljs-section">#### 2. 配置环境变量</span>

<span class="hljs-section">##### 后端配置</span>
在 <span class="hljs-code">`backend/.env`</span> 文件中添加以下内容（可选）：
<span class="hljs-code">```
AMAP_KEY=your_amap_api_key
```</span>

<span class="hljs-quote">&gt; 注意：项目已配置模拟模式，无需API Key也可运行基本功能</span>

<span class="hljs-section">##### 前端配置</span>
在 <span class="hljs-code">`frontend/public/index.html`</span> 中配置高德地图API：
<span class="hljs-code">```html
&lt;script type="text/javascript" src="https://webapi.amap.com/maps?v=2.0&amp;key=your_amap_key"&gt;&lt;/script&gt;
```</span>

<span class="hljs-section">#### 3. 启动后端服务</span>
<span class="hljs-code">```bash
cd backend
pip install -r requirements.txt
python main.py
```</span>
后端服务将运行在 http://localhost:8000

<span class="hljs-section">#### 4. 启动前端服务</span>
<span class="hljs-code">```bash
cd ../frontend
npm install
npm run dev
```</span>
前端服务将运行在 http://localhost:3000

<span class="hljs-section">## 使用指南</span>

<span class="hljs-bullet">1.</span> <span class="hljs-strong">**选择起点**</span> : 在地图上点击选择您的出发位置
<span class="hljs-bullet">2.</span> <span class="hljs-strong">**生成路线**</span> : 点击"生成路线"按钮，系统将创建一条随机探索路线
<span class="hljs-bullet">3.</span> <span class="hljs-strong">**开始漫步**</span> : 查看路线详情，点击"开始漫步"进入导航模式
<span class="hljs-bullet">4.</span> <span class="hljs-strong">**决策互动**</span> : 遇到路口时，掷骰子决定行进方向
<span class="hljs-bullet">5.</span> <span class="hljs-strong">**探索兴趣点**</span> : 沿途发现感兴趣的地点，可暂停导航进行探索
<span class="hljs-bullet">6.</span> <span class="hljs-strong">**完成旅程**</span> : 到达终点后，查看完整的探索记录
<span class="hljs-bullet">7.</span> <span class="hljs-strong">**保存路线作品**</span> : 填写路线标题和描述，保存您的探索轨迹
<span class="hljs-bullet">8.</span> <span class="hljs-strong">**分享探索故事**</span> : 获取分享链接或扫描二维码，与朋友分享您的城市漫步体验

<span class="hljs-section">## 项目结构</span>

<span class="hljs-code">```
电子城市盲盒/
├── backend/                  # 后端服务
│   ├── app/
│   │   ├── api/              # API路由
│   │   ├── services/         # 业务逻辑服务
│   │   └── config/           # 配置文件
│   ├── main.py              # 应用入口
│   └── requirements.txt     # 依赖列表
├── frontend/                 # 前端应用
│   ├── src/
│   │   ├── components/      # React组件
│   │   ├── services/        # API服务
│   │   ├── App.jsx          # 主应用组件
│   │   └── main.jsx         # 应用入口
│   ├── public/              # 静态资源
│   └── package.json         # 依赖配置
└── README.md                # 项目说明文档
```</span>

<span class="hljs-section">## 特色功能</span>

<span class="hljs-bullet">-</span> <span class="hljs-strong">**模拟模式**</span> : 无需真实API Key也能体验完整功能
<span class="hljs-bullet">-</span> <span class="hljs-strong">**随机算法**</span> : 基于真实道路的智能随机路线生成
<span class="hljs-bullet">-</span> <span class="hljs-strong">**游戏化设计**</span> : 骰子决策机制增强探索趣味性
<span class="hljs-bullet">-</span> <span class="hljs-strong">**响应式UI**</span> : 适配不同屏幕尺寸的设备
<span class="hljs-bullet">-</span> <span class="hljs-strong">**实时交互**</span> : 流畅的地图操作和导航体验

<span class="hljs-section">## 开发说明</span>

<span class="hljs-section">### 后端开发</span>
<span class="hljs-bullet">-</span> API文档: http://localhost:8000/docs
<span class="hljs-bullet">-</span> 主要模块:
<span class="hljs-bullet">  -</span> <span class="hljs-code">`RouteGenerator`</span>: 路线生成服务
<span class="hljs-bullet">  -</span> <span class="hljs-code">`TrafficLightManager`</span>: 红绿灯决策服务
<span class="hljs-bullet">  -</span> <span class="hljs-code">`POISearcher`</span>: 兴趣点搜索服务

<span class="hljs-section">### 前端开发</span>
<span class="hljs-bullet">-</span> 组件结构:
<span class="hljs-bullet">  -</span> <span class="hljs-code">`MapComponent`</span>: 地图显示和交互
<span class="hljs-bullet">  -</span> <span class="hljs-code">`ControlPanel`</span>: 控制面板和交互
<span class="hljs-bullet">  -</span> <span class="hljs-code">`DiceComponent`</span>: 骰子组件
<span class="hljs-bullet">  -</span> <span class="hljs-code">`NavigationComponent`</span>: 导航指引
<span class="hljs-bullet">  -</span> <span class="hljs-code">`POICard`</span>: 兴趣点卡片
<span class="hljs-bullet">  -</span> <span class="hljs-code">`RouteWorkComponent`</span>: 路线作品生成和分享

<span class="hljs-section">## 许可证</span>

MIT License

<span class="hljs-section">## 致谢</span>

<span class="hljs-bullet">-</span> 高德地图API提供地图数据支持
<span class="hljs-bullet">-</span> React、FastAPI等开源技术栈
<span class="hljs-bullet">-</span> 所有为项目贡献代码的开发者

---

<span class="hljs-emphasis">*让城市探索充满惊喜，开启您的随机漫步之旅！*</span> 🌆🎲✨
</code></pre>
<p>项目架构如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/63e79a7970ad42d2ae6dcdcfd697ae7f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764600460&amp;x-signature=QosV1O7xwo1%2FAAHSHwDVYExFDZ0%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-8">四.对比：为什么它赢了？</h2>
<p>除了Doubao-Seed-Code，我用2个国外的模型进行了对比，做了相同任务：。</p>
<p>Doubao-Seed-Code生成的效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a00bbb8685df4390aa3ac580d2b489d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764600460&amp;x-signature=e8%2F1EW%2F1c82qM0%2FRUa%2Fj3FqsM24%3D" alt="" loading="lazy"/></p>
<p><strong>模型一：</strong></p>
<p>仅简单的界面，其余功能都未实现。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/799913ba4bbb4806b44aa907344c7f4b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764600460&amp;x-signature=Oh%2FH248WRqJ3SZyp4JJQDfadeZ8%3D" alt="" loading="lazy"/></p>
<p><strong>模型二：</strong></p>
<p>无法理解图片，仅生成了记得的前端，用的AI常用的紫色配色。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a179b63594294e14921c1ed5a5d8e099~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764600460&amp;x-signature=QyZ%2FBj01jYQlCl7LLU%2Bp28t5ovI%3D" alt="" loading="lazy"/></p>
<p>对比表如下：</p>

































<table><thead><tr><th>模型</th><th>是否理解图片</th><th>是否生成完整项目</th><th>是否还原布局</th><th>成本（估算）</th></tr></thead><tbody><tr><td>Doubao-Seed-Code</td><td>✅ 原生VLM，精准还原</td><td>✅ 前后端齐全，功能完整</td><td>✅ 100%还原草图</td><td>¥0.34（0-32K区间）</td></tr><tr><td>模型一</td><td>❌ 仅靠文字描述</td><td>⚠️ 只生成前端UI，无后端逻辑</td><td>❌ 配色乱、布局错</td><td>¥4.05</td></tr><tr><td>模型二</td><td>❌ 无视图片</td><td>❌ 生成“标准模板”，紫色主题，无交互</td><td>❌ 完全跑偏</td><td>¥2.10</td></tr></tbody></table>
<blockquote>
<p>📌 <strong>Doubao-Seed-Code的输入价格：1.20元/百万Token，输出8.00元/百万Token</strong></p>
<p>在相同任务下，成本<strong>不到Claude的1/10</strong>，且效果碾压。</p>
</blockquote>
<h2 data-id="heading-9"><strong>五.Doubao-Seed-Code 超高性价比</strong></h2>
<p>火山方舟推出了 <strong>Coding Plan 订阅制</strong>：</p>























<table><thead><tr><th>套餐</th><th>首月价格</th><th>续费价格</th><th>适合人群</th></tr></thead><tbody><tr><td><strong>Lite</strong></td><td>¥9.9</td><td>¥40/月</td><td>个人开发者、学生、轻量项目</td></tr><tr><td><strong>Pro</strong></td><td>¥49.9</td><td>¥200/月</td><td>团队、复杂项目、高频调用</td></tr></tbody></table>
<blockquote>
<p>✅ <strong>支持Claude Code、Cursor、Cline、Codex</strong> <strong>CLI</strong>等主流工具</p>
<p>✅ 全量透明缓存，实际成本再降80%</p>
<p>✅ <strong>火山方舟平台提供</strong> <strong>API</strong> <strong>调用中心</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fconsole.volcengine.com%2Fark%2Fregion%3Aark%2Bcn-beijing%2Fmodel%2Fdetail%3FId%3Ddoubao-seed-code" target="_blank" title="https://console.volcengine.com/ark/region:ark+cn-beijing/model/detail?Id=doubao-seed-code" ref="nofollow noopener noreferrer">console.volcengine.com/ark/region:…</a></p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2fd7b6aa41764cc09242bc277fdd42d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764600460&amp;x-signature=fKTGkk25vA2S48wmR50A%2FhI9Eow%3D" alt="" loading="lazy"/></p>
<p><strong>我用Lite套餐，首月9.9元，完成了这个项目，还顺手写了3个小程序。</strong></p>
<blockquote>
<p>举例来说，创建一个美观的交互式 Python 学习网站，相同tokens量下（0-32k区间），Claude Sonnet 4.5成本约4.05元，GLM-4.6约0.77元，而Doubao-Seed-Code仅约0.34元。</p>
</blockquote>
<hr/>
<p>另外，在<strong>Terminal</strong> <strong>Bench、SWE-Bench-Verified-Openhands、Multi-SWE-Bench-Flash-Openhands</strong>等主流测评集中表现出色，仅次于Sonnet4.5，碾压国内模型</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94dd5774e53740a788fc9caa45fe4d59~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764600460&amp;x-signature=pUQuep8KNZndAp%2BLmiBTwZM5V4E%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-10">六.总结：它不是工具，是“懂你”的伙伴</h2>
<p>Doubao-Seed-Code 的革命性，不在于它“能写代码”，而在于它终于<strong>看懂了人类的意图</strong>。</p>
<p>过去，我们写需求文档，像给外星人写说明书：</p>
<blockquote>
<p>“请在页面左上角放一个地图，右下角放一个按钮，点击后触发随机算法，返回3个兴趣点，用蓝色字体，字体大小16px，悬停有阴影……”</p>
</blockquote>
<p>而今天，我们只需画一张草图，说一句：“帮我做出来。”</p>
<p>它知道：</p>
<ul>
<li>哪里是按钮，哪里是地图；</li>
<li>哪里该有动画，哪里该有真实评价；</li>
<li>哪个“咖啡杯”不是装饰，而是故事的起点。</li>
</ul>
<p>它不靠你“说清楚”，它靠你“画出来”。</p>
<p>这不是AI编程的进化，这是<strong>人机协作</strong> <strong>范式</strong> <strong>的跃迁</strong>。</p>
<blockquote>
<p>“以前是人教AI怎么干活，现在是AI看懂人想干嘛。” —— 这才是真正的“原生智能”。</p>
</blockquote>
<h4 data-id="heading-11">为什么这很重要？</h4>
<ol>
<li><strong>降低技术门槛</strong>：设计师、产品经理、普通用户，都能直接“画出产品”。</li>
<li><strong>提升创作效率</strong>：从“写5000字需求”到“画5分钟草图”，效率提升10倍。</li>
<li><strong>释放创造力</strong>：不再被语法、框架、API文档束缚，专注“我想做什么”。</li>
<li><strong>重塑开发流程</strong>：未来，产品经理画原型 → AI生成代码 → 测试上线，三步完成。</li>
</ol>
<p>这不是未来，这是<strong>现在正在发生的现实</strong>。</p>
<p>我用9.9元，让AI替我走了一条从未走过的城市小巷。 我没有出门，但我“走”过了整座城。</p>
<p><strong>当AI能读懂你的草图，它就不再是工具，而是你思维的延伸。</strong></p>
<blockquote>
<p>🌆 <strong>真正的City Walk，不是用脚走，而是用心看。</strong> 而现在，AI，替你看了。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[三小时上线，七天破千刀：AI 出海订阅站的 0-1 全流程复盘]]></title>    <link>https://juejin.cn/post/7576141849430327323</link>    <guid>https://juejin.cn/post/7576141849430327323</guid>    <pubDate>2025-11-24T15:53:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576141849430327323" data-draft-id="7576155790164623411" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="三小时上线，七天破千刀：AI 出海订阅站的 0-1 全流程复盘"/> <meta itemprop="keywords" content="产品,AI编程"/> <meta itemprop="datePublished" content="2025-11-24T15:53:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="孟健AI编程"/> <meta itemprop="url" content="https://juejin.cn/user/4212984287073895"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            三小时上线，七天破千刀：AI 出海订阅站的 0-1 全流程复盘
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4212984287073895/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    孟健AI编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T15:53:45.000Z" title="Mon Nov 24 2025 15:53:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读23分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是孟健。</p>
<p>上周末，创业的第二个月，我收到了第一笔客户订单。</p>
<p>到现在，短短一周内已经破千刀，并且收入还在刷新新高。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e3ad32222d947f89eb3ed97c2d0ae2f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764604424&amp;x-signature=bdZCsPvHIbUZPwy7HiSjCCCXAn0%3D" alt="" loading="lazy"/></p>
<p>我给自己的 0-1 目标是：3 个月内赚到 1,000 美元，走出“新手村”。</p>
<p>现在提前达成，内心非常激动。</p>
<p>当然，最激动的应该还是第一个有收入的晚上，享受到了躺赚的快乐，也很符合“边际递减”的原理。</p>
<p>这篇总结原本几天前就想写，无奈竞争太激烈，我连续工作了十天应对各种变化和危机。</p>
<p>今天终于在休息的空档把整个过程和方法论写出来，希望对大家有启发。</p>
<blockquote>
<p>由于竞争关系，产品本身暂不公开，但思路和实操细节全分享给大家。</p>
</blockquote>
<h2 data-id="heading-0">01/ 3 小时上站的实战</h2>
<h3 data-id="heading-1">当天发现需求，当天上线</h3>
<p>我们团队有一条铁律：<strong>当天发现的新需求，必须当天上线</strong>。</p>
<p>对于创业来说，市场不会等人，速度就是优势。</p>
<p>这个订阅站是我做的第二个订阅型站点。</p>
<p>此前线下借助 AI 编程的杠杆，我们在一个月里做了近 30 个小产品，已经练就了「3 小时上站」的节奏，而且质量不算差。</p>
<h3 data-id="heading-2">竞品拆解：需求强、对手弱点清晰</h3>
<p>发现需求时已经是晚上 7 点。</p>
<p>我快速做了市场调研，去 Reddit、Twitter、YouTube 追溯来龙去脉。</p>
<p>结论：需求足够强烈，竞品登上了 Google SERP 第一，但存在明显短板：</p>
<ul>
<li>
<p>功能是假的，基本不可用</p>
</li>
<li>
<p>SEO 一般</p>
</li>
<li>
<p>优势在于 Twitter 运营和极简交互</p>
</li>
</ul>
<p>能上第一，说明需求强、市场尚无更好产品，这是机会窗口。</p>
<h3 data-id="heading-3">MVP 策略：真存储 + 假队列 + Waitlist</h3>
<p>不过当时只有 3 个小时，所以我也决定先不对接实际的 API，一个是我对这类需求的 API 也不是特别熟悉，对接起来时间不够，第二是遵循 MVP 思想，先验证市场需求，再完善产品。</p>
<p>于是，我快速做了一个设计和体验更丰富的站点，而且对接了真实的后台存储（因为我很熟，所以确信加了真实存储也能在 3 小时内搞定），然后同样做了一个假的等待排队，但多了一个 waitlist。</p>
<p>这是我认为和竞品拉开差距的地方，对面做的是个假的，没有后台去看用户的意愿。</p>
<p>我虽然也是个假功能，但是加了真实的 waitlist，这样我就能在后台看到有多少个用户对这个产品有意愿，这也是很多业界产品的通用做法。</p>
<h2 data-id="heading-4">02/ 上线 48 小时的惊喜与危机</h2>
<p>当天上完站我就回去了，直到第二天开会，数据复盘的时候，感觉到和之前的网站不一样的地方。</p>
<p>GSC 还没出数据，GA 实时在线已有上百人，Clarity 显示上千访客。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b19f97751244abbb3b6bf8a28021425~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764604424&amp;x-signature=64wlLKnUBqQizQN80lIHoLlUqZE%3D" alt="" loading="lazy"/></p>
<p>一搜发现站点直接冲上 Google 第一。Waitlist 也超百，需求被验证，我立刻决定对接真实能力。</p>
<p>于是我优先上了一版对接真实 API 的版本，以及真实的队列。但上去后我发现有几个非常严重的问题。</p>
<h3 data-id="heading-5">API 成本失控</h3>
<p>一个是 API 的成本不小，排队状态下，每小时能烧掉 1–2 美元。一天几十刀，没开始赚钱就要亏钱。</p>
<p>我设计了一套复杂的队列机制，也就是一个成本锁，我让它在排队的机制上加上延时节流，保证 3 天 10 美元的节奏运行，这套设计非常复杂，测试起来也不容易，导致大量时间浪费在这了。</p>
<h3 data-id="heading-6">队列把数据库打挂</h3>
<p>第二个是我直接用 DB 去实现队列，导致读写请求过于频繁，直接把连接池耗光了，数据库出现了不可用的情况。</p>
<p>这个时候技术还算有点作用了，当时我去搞了一个 redis，把队列逻辑迁移到 redis 上，加了缓存，不至于把数据库打挂。</p>
<h3 data-id="heading-7">支付审核的不确定性</h3>
<p>当时一般支付都要审核个好几天，而且海外支付收得特别紧，你基本上被拒 1 次，就要等 3 个月了，这是不能接受的。</p>
<p>所以当天我搞到了凌晨 3 点，和 AI 一起挨个确认支付合规的细节。</p>
<p>我记得已经很久没有到凌晨 3 点了，毕竟年龄大了，熬不住了。</p>
<p>而且我出来创业有一条原则，就是不以牺牲健康为代价。</p>
<p>但那天晚上我打破了这个原则，到了关键时刻，也是必须做出的取舍。</p>
<p>第二天中午醒来，发现了一个好消息，支付审核一次通过，这次通过的很快，可能归功于我和 AI 反复斟酌和确认每个细节。</p>
<p>于是我拖着疲惫的身躯，赶紧在当前就把支付对接了，现在 Codex 的能力真的挺强，登录支付基本上就是一次成功了。不过测试还是有点麻烦，需要手动搞两套环境去验证。</p>
<p>接完支付之后，我在生产环境自己下了个单，作为这个产品的首个客户，Creem 还给我发了个邮件庆祝。</p>
<p>当时我就在想，如果是真实用户该有多好。</p>
<p>然后我扫了一眼 GSC，24 小时已经出词了，而且四个指标都非常的夸张，远超我此前的任何数据，再看一眼 GA，DAU 直接好几千，我之前每日的 uv 基本上最高只有 100：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc4e34104d454650ace7d0b313c9e7b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764604424&amp;x-signature=WaE5A5GJYPi48ENqYMiMy3Qsnf8%3D" alt="" loading="lazy"/></p>
<p>对接完支付，第二天起来发现，竟然实际用户出单了，而且出了十多单，于是就有了这条朋友圈：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35f5910c36ad4a99ae2d92b308ccb25b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764604424&amp;x-signature=gWlmv9wVALPaOTUdzar%2FODFsm8w%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-8">03/ 防守与反击</h2>
<p>然后也在这天我发现了很多竞品，都排上来了，感到很大的压力，于是就展开了多项工作，去做防守和反击。这里提两个比较大的事项：Affliate 和 EDM。</p>
<h3 data-id="heading-9">Affiliate（联盟）</h3>
<p>说实话，在此之前我没有接触过海外的 Affliate，像这种联盟营销的路子，其实也是 SEO 赚钱的一种玩法，基本上通过联盟平台 CPA 或者 CPS 去赚取收益。</p>
<p>在我排名往下掉的那几天，我的 email 上收到了很多合作意向，其中一个是 Affliate 的，这个团队很有意思，他们通过 SEO 手段拿到了第一的排名，然后想让我这个产品提供 Affliate 的方式给他：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0fca3ab1902948f697bc4bb333f10c2f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764604424&amp;x-signature=7tNzU9uQwiCIx9UPiiCpryTLDTU%3D" alt="" loading="lazy"/></p>
<p>当时我确实比较焦虑排名往下掉的问题，但是我又不可能大动干戈地去注册 Affliate 平台，那套机制本身太复杂而且还得给平台付很多钱，所以我跟他约定了一个简单的方式，我这边实现统计看板，按月给他结算。</p>
<p>一周下来，我们聊了 20 几封邮件了，对于海外来说，Gmail 相当于是微信了。</p>
<p>在后来，我还去购买了好几个平台推广，然后在我的管理后台做好 utm 跟踪统计：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/81d4f2b9cf234812aa5746f9d52e2031~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764604424&amp;x-signature=ZPq5hLMaDuc73a1FWPJ0r1N4Px8%3D" alt="" loading="lazy"/></p>
<p>事实证明，这是个非常好的防御手段，目前我通过 Affliate 过来的已经好几十单了，几百刀的收益，而且在 SEO 排名下掉的时候，稳住了我的用户访问，甚至活跃用户越来越多了，这是真正的目标用户群体。</p>
<h3 data-id="heading-10">EDM（邮件营销）</h3>
<p>第二个我觉得挺有用的手段是 EDM，也就是电子邮件营销。</p>
<p>刚刚说了，海外的邮件相当于国内的微信，所以用户触达通过邮件效果非常好。</p>
<p>我对于 EDM 的尝试还非常初级，只做了 waitlist 的召回。</p>
<p>在统计到 waitlist，接了支付之后，我就去把我的 resend 升级成 pro 了，通过批量的脚本，对用户进行了一次付费召回，这个漏加了统计代码，我预估召回率大概能在 1%左右。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9aceedb4d3d248ffa60b458354692f5f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764604424&amp;x-signature=PW2QbU7RY7Gd8CVVFHrnZsNTk9A%3D" alt="" loading="lazy"/></p>
<p>其实 EDM 还有很多玩法，我也在逐步学习中，比如合适的时机，Welcome、Onboard、Cart、Newsletter 等等，这是做海外产品的必备手段。</p>
<h3 data-id="heading-11">SEM（投流）</h3>
<p>当然还有一项大的动作在进行中，可惜的是我还没有特别弄明白，就是 SEM。</p>
<p>投流我认为是一个比较黑盒的事情，一个是投放模型需要学习，所以前期必然是亏损的。</p>
<p>另一个是受限于素材、预算、出价等多方面的影响，导致这个周期就比较漫长。</p>
<p>等我未来把 ROI 能够跑正了之后，可以跟大家分享一下经验。</p>
<p>我个人认为，对于做好的产品来说，SEO 是基础，SEM 才是真正的增长飞轮。</p>
<h2 data-id="heading-12">04/ 其他站点（成功/练手/失败）</h2>
<p>当然除了这一个产品之外，我们还做了二十多个产品，都当做练手尝试，下面可以给大家分享一下我自己做的一些没有成功的站点：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Flegionremixhub.com%2F" target="_blank" title="https://legionremixhub.com/" ref="nofollow noopener noreferrer">legionremixhub.com/</a></p>
<p><img alt="转存失败，建议直接上传图片文件" src="" loading="lazy"/></p>
<p>这个站点算是我初步成功的站了，它是魔兽军团的一个新的限时活动，我做的这个满足了用户的游戏资讯需求，也是我成功申请到 adsense 的第一个站，目前每天的 uv 在一两百左右，现在也给我带了几美金的收入，我预计这个站点的收入大概是 10 - 100 美元左右。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a55ddd680b3a41b0bf6323b5b43f3bc3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764604424&amp;x-signature=1FAW5QA%2B%2FPEdfyss9p74T3bbakA%3D" alt="" loading="lazy"/></p>
<p>当然新的产品成功后，这个站点我好久都没时间去迭代了。</p>
<p>剩下的就是一些不赚钱的练手站，比如这个小游戏站：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fstunt-simulator.com%2F" target="_blank" title="https://stunt-simulator.com/" ref="nofollow noopener noreferrer">stunt-simulator.com/</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4c80e15e39f145ef85ceaf4881c66a81~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764604424&amp;x-signature=oJiSBo%2FFrzK639KfPsSa1HoSqic%3D" alt="" loading="lazy"/></p>
<p>另一个小游戏站：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcowboysafari.online%2F" target="_blank" title="https://cowboysafari.online/" ref="nofollow noopener noreferrer">cowboysafari.online/</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08b2be9aa371478a8e079e9720d47183~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764604424&amp;x-signature=xfDKvlBZ%2Fj8PO2YEip6kQW3pOYQ%3D" alt="" loading="lazy"/></p>
<p>另一个游戏资讯站：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fpoe327.net%2F" target="_blank" title="https://poe327.net/" ref="nofollow noopener noreferrer">poe327.net/</a></p>
<p><img alt="转存失败，建议直接上传图片文件" src="" loading="lazy"/></p>
<p>期末成绩计算器：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Ffinalgradecalculator.app%2F" target="_blank" title="https://finalgradecalculator.app/" ref="nofollow noopener noreferrer">finalgradecalculator.app/</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3bc6209905bb48f88dbd3d21aef0cc52~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764604424&amp;x-signature=%2BVA%2FYn8cxJhd7kf9JU%2BTWrm1by0%3D" alt="" loading="lazy"/></p>
<p>摩斯密码工具站：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmorsecodetranslator.app%2F" target="_blank" title="https://morsecodetranslator.app/" ref="nofollow noopener noreferrer">morsecodetranslator.app/</a></p>
<p><img alt="转存失败，建议直接上传图片文件" src="" loading="lazy"/></p>
<p>团队里数十个站点我就不一一枚举了，相信大家已经理解我们所做的事情。</p>
<h2 data-id="heading-13">05/ 产品方法论与心态</h2>
<h3 data-id="heading-14">为什么不能是 CEO？</h3>
<p>我记得在我离开大厂之前，有很多人问我创业是不是去做 CTO，当时我回了一句：</p>
<p>为什么不能是 CEO？</p>
<p>可能程序员朋友都会觉得我是狂妄自大，但我的创业目标是非常坚定的。</p>
<p>说实话，如果创业还是做技术，那我不如继续待在大厂，更舒服地做技术。</p>
<p>经过这么多年的打拼，我明白了一个道理：技术永远决定不了产品，就算是 CTO 也不行。</p>
<p>我的上一家大厂，已经非常尊敬技术了，技术和产品分两条汇报线，相互之间是合作关系，不是汇报。</p>
<p>从产品的视角里看，技术永远都是资源，本职工作就是做好需求，所以技术搞来搞去，就是降本增效那一套。</p>
<p>现在 AI 时代创业，我个人认为初创团队，是不需要 CTO 的，产品经理完全可以自己搞定 MVP，快速做市场验证。</p>
<p>程序员出来创业，最缺乏的是对产品的洞察，对商业的判断，容易沉浸在自己所谓的奇思妙想和解决方案里。</p>
<p>我真正去接触产品、商业、销售、运营，其实也就是这一年的事情，在之前基本就是两耳不闻窗外事，一心做技术。</p>
<p>所以在我出来前，有人问我是不是去做一个博主？我的回答还是犹豫的，当时只是说还想去试试做产品创业可不可行。</p>
<p>其实出来之后，我的方向非常笃定和聚焦，我基本上把所有的精力都放在 AI 编程出海的事情上，自媒体投入很少。</p>
<p>因为在我看来，自媒体我想要做随时都可以做，但真正做出海产品，对我来说是更具有挑战性的事情，心里是没底的。</p>
<p>这次能在短短不到 2 个月的时间内跑通商业闭环，产品上线一周就能赚到千刀，给了我极大的信心，越来做产品，我真的可以！</p>
<p>目前对我来说，产品和商业已经没有任何神秘感了。</p>
<h3 data-id="heading-15">读书与方法论</h3>
<p>在这个过程中，我看了很多产品、创业相关的书，包括苏杰、俞军等诸多产品专家的著作。</p>
<p>俞军老师的书我看了两遍，主要是因为这本书写的实在是太理论了，很多经济学的知识，看完了头脑空空。</p>
<p>为了学到一些东西，我还是硬着头皮去看了第二遍，并且做了笔记：《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FvuzFiYd89jhnf44UycUA-A" target="_blank" title="https://mp.weixin.qq.com/s/vuzFiYd89jhnf44UycUA-A" ref="nofollow noopener noreferrer">为什么你的 AI 产品总是做不起来？90%的人忽略了这两个底层模型</a>》。</p>
<p>在所有的书籍里，我觉得收获最大的还是精益创业，在看完这本书之后，我要求团队所有的产品都需要去画精益画布，想清楚商业，才等于想清楚产品。</p>
<p>这是我自己按照创业目标的推演，按照 AARRR 来推算的数据情况：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc157cd977f4494f801b5316d949be7e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764604424&amp;x-signature=2SFrpX5iNTOGbxkq7TVIKLT%2BwmE%3D" alt="" loading="lazy"/></p>
<p>我觉得精益创业让我意识到了，AARRR 不只是个漏斗模型，它还是个反馈模型。这个推演我做了好几次，也和大家一起推演过，以确定我们的初创目标。</p>
<p>我记得第一次推演的时候，是周末，那时候北京还在下雨，天气很阴沉。我独自在会议室的白板上进行推演测算，推演之后，我的心情和天空一样灰暗，真正感受到了创业维艰。</p>
<p>我经常跟自己说，一定要跳出程序员的视角，不要老想着解决方案，要去看技术之外的东西。当我测算完之后，我真正理解了，这么多客户，这么多用户，要怎么去获得？你要认清了现实，根本不会去自嗨了，只会感觉到深深的压力。</p>
<p>那个时候已经去做了几个站了，基本上没拿到什么正反馈，团队士气不高，大家也都比较迷茫，充满了不确定性。我觉得作为一号位，首要职责就是想清楚方向，不能既要又要，当所有人失去信心的时候，必须要坚定信心，拨开迷雾，给出指引。</p>
<p>当时我分析了一下我们的优势，主要就是效率，我们一定要利用好 AI 编程的杠杆，把执行力拉满，从而打出差异化优势，像当天必须上站，每天必做的找词、外链、复盘、内链 SOP 确定下来，标准执行，至少做 10 个订阅、100 个流量。</p>
<p>这样定量地进行了目标的拆解，大家更有确定感，也确实从数据反推是需要这么做的，剩下的交给不断地自我成长和时间，理论上去博一个最大概率。</p>
<p>在这个战略确定了一周后，我们就迎来了第一个产品的爆发，真正把这套模式从 0-1 跑通了。</p>
<p>我想说的是，做产品的要求其实说高也很高：</p>
<p>你需要有理科思维，通过数据来验证。</p>
<p>你需要有文科思维，有同理心。</p>
<p>你需要有动手能力，做实验验证。</p>
<p>还需要有批判精神，反复琢磨论证。</p>
<h3 data-id="heading-16">差异化优势</h3>
<p>最后，产品最重要的还是打出差异化优势。我们的差异化优势除了效率方面，其他方面都有一定的短板，我所做的就是尽可能让团队尽快成长，弥补自身的短板，也是变相提升了差异化优势。</p>
<p>比如，上周刚和团队培训分享了设计层面的知识，大家的审美一下子就上来了，站点都美观舒服了很多。</p>
<p>之前不断灌输的需求分析，市场调研，也潜移默化地改变了很多事情，每个人的产品 sense 都在提升。</p>
<p>在短时间内持续学习，快速成长，也是我认为最重要的差异化优势之一。</p>
<h2 data-id="heading-17">06/ 人性三关——贪婪、恐惧、狂妄</h2>
<p>说完产品，来聊聊创业。</p>
<p>之前很多人问我，到底要到什么样的阶段才可以出去创业？当时我回答的不是很好。</p>
<p>经过这几个月的不断思考，我反思了一下为什么我一年前不认为可以创业，今年就出来了。</p>
<p>总结起来，能力并不是最重要的，最重要的是与人性的对抗，我选出三个需要对抗的人性和大家展开聊聊。</p>
<h3 data-id="heading-18">贪婪</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/14846ead6a874572acca84c9da202a05~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764604424&amp;x-signature=5riPfkwLuzkA7C9cLueNTVPU3Sg%3D" alt="" loading="lazy"/></p>
<p>我认为贪婪是人类的排名最靠前的人性，几乎所有人的本性都是贪婪的。</p>
<p>举个例子，如果一个人他的目标是赚钱，你问他赚多少钱会够，不论他回答多少钱，其实都是不够的。</p>
<p>当你赚到 1 万的时候，你想赚 10 万，然后想赚百万，千万，很多赚几个亿的老板，会想他们为什么不能成为马云。</p>
<p>这就是人性的贪，也是最难克服的一点。</p>
<p>佛教劝人放下，道教主张无为，其实本质上是教我们如何克服贪婪的人性。</p>
<p>创业来说，我认为必须要克制贪婪，否则会陷入到万丈深渊，无法自拔。</p>
<p>拿俞敏洪举例，当年新东方要上市的时候，收到了某家大的证券公司 1 个亿的投资，要求新东方在国内上市。</p>
<p>当时一个亿已经打到账上了，但是俞敏洪发现国内没有教育培训公司上市的先例，必须要借壳上市，虽然有很多公司都是借壳上市的，但是他还是认为其中有风险，果断将这一个亿连本带利地还了。</p>
<p>没过几天，这家证券公司就出事了，公司负责人被抓，其实这家公司已经暗中操作了股票，就等新东方上钩大捞一笔。</p>
<p>如果当时没有俞敏洪的坚持，可能也没有现在的新东方。</p>
<p>我们创业，面临的是极其复杂的商业环境，我觉得一定要不断警示自己：</p>
<p>天下没有免费的午餐！</p>
<p>拿我们遇到的事情举例，就是之前沸沸扬扬的 comet 的 referal，做出海的人应该都关注了这个事情。</p>
<p>这件事情从一开始，我就不看好，也从来没有把它算在我们的正常收益里，因为它的 CPA 非常高，事出反常必有妖。</p>
<p>所以当时我们没有像一些人去搞投流，花很大精力弄，只是花了 2 小时顺手发了一下。</p>
<p>果不其然，最后 partner 是被封了的，如果投入过多精力在这上面，非常不值得。</p>
<p>我觉得对抗贪婪，最重要的是两个字——原则。</p>
<p>一个没有原则的人，底线就会被无限突破，你要想清楚自己的原则是什么，底线是什么。</p>
<p>拿我们做 SEO 举例，我定义的第一条原则就是，不蹭品牌词，只做需求词，更不要去碰黄赌毒，擦边都不行。</p>
<p>谁都知道这些东西流量来的很快，很容易拿正反馈。但当你毫无下限地去赚钱的时候，最终会被金钱反噬的。</p>
<p>还是拿俞敏洪举例，他曾经在生死线上走过来的，遭遇了抢劫，这名歹徒之前抢过的六个老板，毫无例外全都死于非命了，只有俞敏洪侥幸活了下来。</p>
<p>这个歹徒是通过度假村的生意和俞敏洪合作，俞敏洪先垫付了 3 万元，后来这个钱一直没还，歹徒恳请俞敏洪宽限一年还，俞敏洪说做个朋友，就答应了。</p>
<p>可能是这件事种下了一个善因，导致最终抢劫的时候，没有对俞敏洪下死守。</p>
<p>读了这么多年的书，我依旧相信这世界上有因果，就像康德说的物自体，超过了人类目前的认知，换句话说：</p>
<p>得道多助，失道寡助。</p>
<p>很多人会去积德行善，并不是做样子，而是相信世界上的真善美。</p>
<p>过犹不及，这是道家的智慧。做事留一线，坚守自己的原则。</p>
<p>这个道理在很多时候都是通用的，你看飙高音的节目，如果一个选手高音飙到极限，它一定没有美感，反而是留有一些余地的高音，更能带来震撼。</p>
<p>雷军不顾投资人的反对，坚持硬件利润率不超过 5%。</p>
<p>俞敏洪将一对一家教的比重控制在 35%以下。</p>
<p>董明珠拿出 300 亿做科研投入，数控机床技术直接打败了德国，赢得了世界的尊重。</p>
<p>这些人不是在作秀，而是有自己心中的坚守，最终获得高成就的大佬，绝不仅仅是靠运气。</p>
<p>我马上要启动知识付费了，我也给自己定了一条标准线，知识付费的收入不能超过总收入的 35%。</p>
<p>突破了内心的贪婪，才能真正掌控自我，也就拥有了创业成功的初步条件。</p>
<h3 data-id="heading-19">恐惧</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ab87650fc1d4611835ecbd4acedc496~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764604424&amp;x-signature=KckGn3gAy3yKebpb1R%2FJt16qSzQ%3D" alt="" loading="lazy"/></p>
<p>恐惧同样是很难克服的人性。回想起去年我为什么没有选择出来创业，很大的因素就是——恐惧。</p>
<p>恐惧离开大厂之后，失去收入，同时也失去了赚钱能力，再进大厂不一定那么容易了，最终可能去送外卖。</p>
<p>恐惧自己的贷款还没有还完，最终可能卖房还债。</p>
<p>恐惧自己创业孤立无援，陷入绝境。</p>
<p>恐惧的事情实在太多太多了，克服恐惧需要很大的勇气。</p>
<p>但仔细想想，我们生来就是一无所有，死去也将一无所有，为什么在拥有过后，就那么恐惧一无所有呢？</p>
<p>一无所有绝不可怕，真正不恐惧一无所有的人，才能真正拥有。</p>
<p>这个人生哲理需要一定的阅历才能明白，经历了很多磨难之后，才会产生信念，车到山前必有路。</p>
<p>当真正面临生死之后，才会发出感慨：除了生死，再无大事。</p>
<p>这是看过蔡磊先生的书之后最大的感悟，真正面临的大恐惧是生死，而不是其他。</p>
<p>最近国际形势紧张，战争可能一触即发，抖音已经被我刷成了军事频道。</p>
<p>我也在思考一个问题，死亡真的有那么恐惧吗？</p>
<p>人最终都是要死的。</p>
<p>鲁迅先生是在什么情景下写出那句名言？</p>
<p>我们抗美援朝的志愿军战士，他们被誉为最可爱的志愿军战士。</p>
<p>朝鲜总统亲自证明，只有中国的志愿军战士没有犯下暴行，没有射杀平民。</p>
<p>他们没有对死亡的恐惧吗？绝对不是，而是他们有内心坚守的东西，超越了生死。</p>
<p>我相信战争来临时，当下时代会有更多的汉奸，有更多卖主求荣的人。</p>
<p>但同时也相信，民族精神是刻进中国人基因的。</p>
<p>苟利国家生已，死岂因祸福避之。</p>
<p>当真正克服生死恐惧的时候，我们就是无敌的。</p>
<h3 data-id="heading-20">狂妄</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/624e6a94d128471ea9209630713c29f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764604424&amp;x-signature=FXGAH9V4fgmF1U5zhvrn7UaqqOE%3D" alt="" loading="lazy"/></p>
<p>说起狂妄，我觉得佛教定义的五毒很形象——贪嗔痴慢疑。</p>
<p>其中痴指的是愚昧，慢指的是傲慢，疑指的是怀疑并固执，这三个加起来，可以说是狂妄。</p>
<p>这也是最基本的人性。我们往往将所有的功劳归于自己，所有的过错推给他人。</p>
<p>在创业过程中，我也发现了这一点，团队在分析竞争对手的时候，一直在批判对方的缺点。</p>
<p>这是一个非常不好的现象，我始终强调，你看竞争对手，一定要看他的优点，而不是批评缺点，给自己优越感。</p>
<p>这让我想起之前的一个下属，绩效不太好，他问了我一个问题：</p>
<p>“公司内那些级别高的人，他们的技术太菜了，完全靠时代红利，最新框架都不了解，凭什么他们级别那么高？”</p>
<p>当时我的回答大致是，每个人有自己的时代和际遇，他们时代有自己的框架技术，我们不能紧盯着某一个具体技能来评判，更要看他们的综合素质，学习他们身上的优点。</p>
<p>当然那位同学肯定是对我这段话嗤之以鼻。</p>
<p>我们仔细思考一下，如果你掌握的技能都是 how-to 的技能，不说别的，在这个时代，已经可以被 AI 取代了，AI 发展几年，一大批程序员就会失业了。</p>
<p>退一步来说，你当前年轻，不知天高地厚，等你老了，别人照样也会说你不懂新技术，凭什么在这个位置。</p>
<p>这世界上本就不存在绝对公平，所有的事情都是错综复杂的，而人性就会推着我们不会客观多角度分析问题。</p>
<p>所谓骄兵必败，在创业上，一定要克服这种狂妄。你会发现，越成功的大佬，越谦逊。</p>
<h2 data-id="heading-21">07/ 后续目标与待办</h2>
<p>最后，说一下未来的打算，目前 0-1 只能算是初步跑通，仅仅是个起点，接下来的目标是稳定的月入万刀。</p>
<p>其实月入万刀，已经和我抵得过我在大厂的收入了，纯粹的躺赚收益，也是几人小团队的一个生存线。</p>
<p>再接下来，我希望公司能够在明年冲击百万的 ARR，换算成人民币大概是千万收入，虽然它还是一个小公司，但我觉得已经有在时代立足的本钱了。</p>
<p>除了收益目标，我觉得最主要的是创业之路的成长和收获，眼下就有 ph 打榜、投流等等一堆难关要过，保持高速的成长，相信在 AI 的时代就能够不下牌桌，享受时代红利。</p>
<p>咱们下期再见。</p>
<hr/>
<p>🚀 想要与更多AI爱好者交流，共同成长吗？</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FZ4k_5_waWJbRRo5lZBZmog" target="_blank" title="https://mp.weixin.qq.com/s/Z4k_5_waWJbRRo5lZBZmog" ref="nofollow noopener noreferrer">和一群志同道合的人，持续精进 AI 的每一天</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[开放至极致：OLMo 3如何重塑开源大模型游戏规则？]]></title>    <link>https://juejin.cn/post/7576124206397947914</link>    <guid>https://juejin.cn/post/7576124206397947914</guid>    <pubDate>2025-11-24T14:15:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576124206397947914" data-draft-id="7576124206397931530" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="开放至极致：OLMo 3如何重塑开源大模型游戏规则？"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2025-11-24T14:15:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="墨风如雪"/> <meta itemprop="url" content="https://juejin.cn/user/4064249017803927"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            开放至极致：OLMo 3如何重塑开源大模型游戏规则？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4064249017803927/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    墨风如雪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T14:15:14.000Z" title="Mon Nov 24 2025 14:15:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>2025年11月20日，AI圈注定要记住这个日子。艾伦人工智能研究所（AI2）悄然投下了一颗重磅炸弹：其新一代开源大语言模型系列——<strong>OLMo 3</strong>正式面世。说它“重磅”，绝不仅仅是因为又多了一款参数规模更大的模型，而是因为它彻底颠覆了我们对“开源”的理解，为整个行业树立了性能、效率和透明度的新标杆。</p>
<p>作为一名关注AI前沿的创作者，我深知开源社区对大模型的渴望，不仅仅是拿到模型权重，更是希望能够洞察其内部机制，进行深度定制和研究。而OLMo 3的到来，正是对这种渴望的极致回应。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F11%2FiShot_2025-11-24_22.06.27-1024x537.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/11/iShot_2025-11-24_22.06.27-1024x537.png" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f57080221324b83b30bd47df0c9da69~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764598514&amp;x-signature=jyjwWNt9RilWTcxl4AgameIpfRo%3D" alt="iShot_2025-11-24_22.06.27" loading="lazy"/></a></p>
<h3 data-id="heading-0">突破“黑箱”：全栈开源的震撼宣言</h3>
<p>以往我们谈论开源模型，往往指的是模型权重和一些基本代码。但OLMo 3，如同其名“Open Language Model”的终极演绎，直接将“透明度”提升到了前所未有的高度。AI2这次玩得更大，他们开放的是完整的“<strong>模型流程（Model Flow）</strong>”。</p>
<p>这意味着什么？</p>
<p>想象一下，你不再只是拿到了一张精美的蛋糕，而是获得了从面粉、鸡蛋到烘焙食谱、制作过程中的每一个检查点，甚至连你使用的烤箱型号和温度曲线都一清二楚。OLMo 3就是这样的“蛋糕”：它不仅提供70亿和320亿两种参数规模的模型权重，更慷慨地开源了：</p>
<ul>
<li><strong>完整的训练数据集 Dolma 3：</strong> 这是一个规模高达约6万亿token的庞大数据集，包含了网页、科学PDF、代码库等丰富内容。你能直接看到模型“吃”了什么。</li>
<li><strong>训练代码与详细配方：</strong> 你可以完全复现其训练过程。</li>
<li><strong>各阶段的训练检查点：</strong> 深入分析模型是如何一步步进化而来。</li>
</ul>
<p>这种“全栈开源”的哲学，对于学术研究、模型调试和负责任AI的发展而言，简直是福音。它让大模型不再是高高在上的“黑箱”，而是可以被深入剖析、理解和再创造的科学工具。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F11%2FiShot_2025-11-24_22.06.50-1024x535.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/11/iShot_2025-11-24_22.06.50-1024x535.png" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/25135e302cf84115b4e6e71edcd072f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764598514&amp;x-signature=7ShK0nJ2XaAUYb1jkRkWS5j8baI%3D" alt="iShot_2025-11-24_22.06.50" loading="lazy"/></a></p>
<h3 data-id="heading-1">性能与效率的“双料冠军”</h3>
<p>透明度之外，性能和效率是衡量大模型的硬指标。OLMo 3在这两点上也交出了令人惊喜的答卷。</p>
<p>根据官方数据，OLMo 3基础模型的训练效率比同规模的Meta Llama 3.1高出惊人的2.5倍。这背后是AI2在训练数据混合、模型架构和优化策略上的深度探索。更令人震撼的是，其32B规模的“Think”模型，在性能上足以对标甚至超越Qwen 3 32B这样的业界翘楚，但训练所用的token数量却仅为后者的六分之一。这意味着，AI2在更少的资源消耗下，达到了同等甚至更高的性能，这无疑是效率优化领域的一大突破。</p>
<p>在实际基准测试中，OLMo 3家族在多项综合能力测试中，与Qwen 2.5、Gemma 3、Llama 3.1等主流开源模型平分秋色，甚至在某些场景下表现更为出色。尤其在长上下文理解和代码能力方面，OLMo 3展现出独特的优势，与顶级模型不相上下。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F11%2FiShot_2025-11-24_22.06.54-1024x319.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/11/iShot_2025-11-24_22.06.54-1024x319.png" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/343d12185a0e49a1a761c9c74df4c191~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764598514&amp;x-signature=NbrPuL6XbRR1hru4ctuRDHBCs7c%3D" alt="iShot_2025-11-24_22.06.54" loading="lazy"/></a></p>
<h3 data-id="heading-2">为应用场景量身定制的“模型家族”</h3>
<p>OLMo 3并非单打独斗，而是一个分工明确的家族，每个成员都针对特定任务进行了优化：</p>
<ul>
<li><strong>OLMo 3 Base（7B/32B）：</strong> 纯粹的基础模型，是那些希望从零开始定制或进行领域适配的开发者和研究者的完美起点。</li>
<li><strong>OLMo 3 Think（7B/32B）：</strong> 这款模型具备显式的思维链（Chain-of-Thought）能力，推理过程透明，是处理复杂逻辑分析、数学计算和代码生成的理想选择。如果你需要一个能“思考”的模型，非它莫属。</li>
<li><strong>OLMo 3 Instruct（7B）：</strong> 轻量而强大，它针对指令遵循、多轮对话和工具调用进行了深度优化，无论是作为日常智能助手，还是嵌入到应用程序中，都能游刃有余。</li>
<li><strong>OLMo 3 RL Zero（7B）：</strong> 这是一个专门为强化学习（RL）研究者打造的“干净底座”。它的训练数据与预训练数据分离，为RL算法的探索提供了极佳的可控环境。</li>
</ul>
<p>此外，OLMo 3全系列模型支持高达<strong>65,000个token</strong>的上下文长度，这相当于一次性处理一部短篇小说。对于需要分析长篇文档、法律合同、技术报告等任务的用户来说，这无疑是一项极具价值的突破。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F11%2FiShot_2025-11-24_22.07.04-1024x921.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/11/iShot_2025-11-24_22.07.04-1024x921.png" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3bb71e88d790407fa007ca162fec009d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764598514&amp;x-signature=rLo4bal%2FBQqu9GsPRLmf%2F%2F7V6lU%3D" alt="iShot_2025-11-24_22.07.04" loading="lazy"/></a></p>
<h3 data-id="heading-3">触手可及的未来</h3>
<p>AI2深知，再强大的模型，也需要便捷的获取和使用方式。因此，OLMo 3系列模型权重已在Hugging Face的<code>allenai/OLMo-3</code>项目下全部开源，方便开发者直接下载。如果你想先睹为快，AI2官方还提供了模型游乐场（Playground），让你无需任何配置，即可在线体验各个模型的魅力。</p>
<h3 data-id="heading-4">结语：新时代的开源宣言</h3>
<p>OLMo 3的发布，不仅仅是AI2在技术上的一次飞跃，更是他们对开源精神的深刻诠释。它向世界宣告：高性能与极致透明并非不可兼得。通过开放“模型流程”的每一个环节，AI2不仅提供了强大的工具，更搭建了一个前所未有的研究基础设施，有望极大推动AI科学的可复现性和创新速度。</p>
<p>在这个AI浪潮奔涌的时代，OLMo 3无疑是其中一道亮丽的风景线。它不仅让我们看到了未来开源大模型的形态，也为整个AI社区指明了一条更开放、更透明、更高效的前进之路。作为AI圈的一员，我对此充满期待，并相信它将在未来的AI发展中扮演举足轻重的角色。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F11%2FiShot_2025-11-24_22.07.13-1024x670.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/11/iShot_2025-11-24_22.07.13-1024x670.png" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aabef761a07248afb5f888ff8ce16d66~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764598514&amp;x-signature=bMt6EUeYRCfMJYUuI4sqYleadjg%3D" alt="iShot_2025-11-24_22.07.13" loading="lazy"/></a></p>
<p><strong>如果你也对最新的AI信息感兴趣或者有疑问 都可以加入我的大家庭 第一时间分享最新AI资讯、工具、教程、文档 欢迎你的加入！！！😉😉😉</strong></p>
<p>公众号：墨风如雪小站</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Jetpack Compose 实战：复刻 Material 3 圆形波浪进度条]]></title>    <link>https://juejin.cn/post/7575897635138060288</link>    <guid>https://juejin.cn/post/7575897635138060288</guid>    <pubDate>2025-11-24T14:18:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575897635138060288" data-draft-id="7575090551357603892" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Jetpack Compose 实战：复刻 Material 3 圆形波浪进度条"/> <meta itemprop="keywords" content="Android,Android Jetpack"/> <meta itemprop="datePublished" content="2025-11-24T14:18:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨白"/> <meta itemprop="url" content="https://juejin.cn/user/2549135752044601"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Jetpack Compose 实战：复刻 Material 3 圆形波浪进度条
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2549135752044601/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨白
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T14:18:44.000Z" title="Mon Nov 24 2025 14:18:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">效果</h2>
<p>要实现的效果是 Material 3 的 <code>CircularWavyProgressIndicator</code>。简单来说，就是一个带波浪的圆形进度条。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcomposables.com%2Fdocs%2Fandroidx.compose.material3%2Fmaterial3%2Fcomponents%2FCircularWavyProgressIndicator" target="_blank" title="https://composables.com/docs/androidx.compose.material3/material3/components/CircularWavyProgressIndicator" ref="nofollow noopener noreferrer">圆形波浪进度指示器</a></p>
<h2 data-id="heading-1">实现步骤</h2>
<h3 data-id="heading-2">绘制轨道和平滑波浪</h3>
<p>首先我们将轨道和“碾平”的波浪绘制出来。</p>
<p>对于普通圆弧，我们通常会使用 <code>DrawScope.drawArc()</code>。但我们需要绘制波浪，后续需要对每个点进行偏移，所以必须使用 <code>Path()</code> 来进行每个点的绘制。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">CircularWavyProgressIndicatorStep1</span><span class="hljs-params">(
    modifier: <span class="hljs-type">Modifier</span> = Modifier,
    waveColor: <span class="hljs-type">Color</span> = MaterialTheme.colorScheme.primary, <span class="hljs-comment">// 波浪颜色</span>
    trackColor: <span class="hljs-type">Color</span> = MaterialTheme.colorScheme.secondaryContainer, <span class="hljs-comment">// 轨道颜色</span>
    waveStrokeWidth: <span class="hljs-type">Dp</span> = <span class="hljs-number">4.</span>dp, <span class="hljs-comment">// 波浪笔触宽度</span>
    trackStrokeWidth: <span class="hljs-type">Dp</span> = <span class="hljs-number">4.</span>dp, <span class="hljs-comment">// 轨道笔触宽度</span>
)</span></span> {
    <span class="hljs-comment">// 复用 Path 对象，避免重组时的重建导致内存抖动</span>
    <span class="hljs-keyword">val</span> wavePath = remember { Path() }
    <span class="hljs-keyword">val</span> trackPath = remember { Path() }

    <span class="hljs-keyword">val</span> density = LocalDensity.current
    <span class="hljs-comment">// 将 Dp 转为 Px</span>
    <span class="hljs-keyword">val</span> waveStrokeWidthPx = with(density) { waveStrokeWidth.toPx() }
    <span class="hljs-keyword">val</span> trackStrokeWidthPx = with(density) { trackStrokeWidth.toPx() }

    Canvas(modifier = modifier.size(<span class="hljs-number">48.</span>dp)) {
        <span class="hljs-keyword">val</span> center = <span class="hljs-keyword">this</span>.center
        <span class="hljs-comment">// 采样：1度画一次</span>
        <span class="hljs-keyword">val</span> step = <span class="hljs-number">1</span>

        <span class="hljs-keyword">val</span> maxStroke = maxOf(waveStrokeWidthPx, trackStrokeWidthPx)
        <span class="hljs-comment">// 基础半径：容器宽的一半 - 笔触的一半，确保画笔不超出 Canvas 边界</span>
        <span class="hljs-keyword">val</span> baseRadius = (size.minDimension - maxStroke) / <span class="hljs-number">2f</span>

        <span class="hljs-comment">// --- 绘制波浪 ---</span>
        wavePath.rewind() <span class="hljs-comment">// 清空路径</span>
        <span class="hljs-keyword">val</span> endAngle = <span class="hljs-number">180f</span> <span class="hljs-comment">// 暂时画 180 度</span>

        <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">0.</span>.endAngle.toInt() step step) {
            <span class="hljs-keyword">val</span> currentAngle = i.toFloat()
            <span class="hljs-keyword">val</span> rad = Math.toRadians(currentAngle.toDouble()) <span class="hljs-comment">// 角度转弧度</span>

            <span class="hljs-keyword">val</span> x = center.x + (baseRadius * cos(rad)).toFloat()
            <span class="hljs-keyword">val</span> y = center.y + (baseRadius * sin(rad)).toFloat()

            <span class="hljs-keyword">if</span> (i == <span class="hljs-number">0</span>) {
                wavePath.moveTo(x, y)
            } <span class="hljs-keyword">else</span> {
                wavePath.lineTo(x, y)
            }
        }
        drawPath(
            path = wavePath,
            color = waveColor,
            style = Stroke(width = waveStrokeWidthPx, cap = StrokeCap.Round)
        )

        <span class="hljs-comment">// --- 绘制轨道 ---</span>
        trackPath.rewind()
        <span class="hljs-keyword">val</span> trackStartAngle = endAngle
        <span class="hljs-keyword">val</span> trackEndAngle = <span class="hljs-number">360f</span>

        <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> trackStartAngle.toInt()..trackEndAngle.toInt() step step) {
            <span class="hljs-keyword">val</span> currentAngle = i.toFloat()
            <span class="hljs-keyword">val</span> rad = Math.toRadians(currentAngle.toDouble())

            <span class="hljs-keyword">val</span> x = center.x + (baseRadius * cos(rad)).toFloat()
            <span class="hljs-keyword">val</span> y = center.y + (baseRadius * sin(rad)).toFloat()

            <span class="hljs-keyword">if</span> (i == trackStartAngle.toInt()) {
                <span class="hljs-comment">// 移到起始点</span>
                trackPath.moveTo(x, y)
            } <span class="hljs-keyword">else</span> {
                trackPath.lineTo(x, y)
            }
        }
        drawPath(
            path = trackPath,
            color = trackColor,
            style = Stroke(width = trackStrokeWidthPx, cap = StrokeCap.Round)
        )
    }
}
</code></pre>
<p>注意：</p>
<ol>
<li>为了避免在重组时，频繁创建 <code>Path</code> 对象导致内存抖动。我们使用了 <code>remember{ Path() }</code> 来复用路径对象。不过要在每次绘制前，调用 <code>rewind()</code> 清空已有路径。</li>
<li><code>sin()</code> 和 <code>cos()</code> 接收的都是弧度，需要调用 <code>Math.toRadians()</code>，将角度转为弧度。</li>
</ol>
<p>运行效果：</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/345d233358e54b89aa146ac6ccb98f15~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo55m9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764598723&amp;x-signature=Cb5yecsEaccEIcuc4G5LQBqr3Uo%3D" alt="image.png" width="50%" loading="lazy"/>
<h3 data-id="heading-3">绘制波浪线</h3>
<p>接下来，我们来给圆加上“褶皱”。原理也很简单，在计算半径时，叠加一个正弦函数即可。</p>
<p>公式：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mo>=</mo><mtext>基础半径</mtext><mo>+</mo><mtext>振幅</mtext><mo>×</mo><mi>sin</mi><mo>⁡</mo><mo stretchy="false">(</mo><mtext>弧度</mtext><mo>×</mo><mtext>频率</mtext><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">R = \text{基础半径} + \text{振幅} \times \sin(\text{弧度} \times \text{频率})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"/><span class="mord text"><span class="mord cjk_fallback">基础半径</span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"/><span class="mord text"><span class="mord cjk_fallback">振幅</span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mop">sin</span><span class="mopen">(</span><span class="mord text"><span class="mord cjk_fallback">弧度</span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord cjk_fallback">频率</span></span><span class="mclose">)</span></span></span></span></span></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">CircularWavyProgressIndicatorStep2</span><span class="hljs-params">(
    modifier: <span class="hljs-type">Modifier</span> = Modifier,
    waveColor: <span class="hljs-type">Color</span> = MaterialTheme.colorScheme.primary,
    trackColor: <span class="hljs-type">Color</span> = MaterialTheme.colorScheme.secondaryContainer,
    waveStrokeWidth: <span class="hljs-type">Dp</span> = <span class="hljs-number">4.</span>dp,
    trackStrokeWidth: <span class="hljs-type">Dp</span> = <span class="hljs-number">4.</span>dp,
    amplitude: <span class="hljs-type">Dp</span> = <span class="hljs-number">1.2</span>.dp, <span class="hljs-comment">// 振幅：决定波浪起伏的高度</span>
    wavelength: <span class="hljs-type">Dp</span> = <span class="hljs-number">15.</span>dp, <span class="hljs-comment">// 波长：决定波浪的密集程度</span>
)</span></span> {
    <span class="hljs-keyword">val</span> wavePath = remember { Path() }
    <span class="hljs-keyword">val</span> trackPath = remember { Path() }

    <span class="hljs-keyword">val</span> density = LocalDensity.current
    <span class="hljs-keyword">val</span> waveStrokeWidthPx = with(density) { waveStrokeWidth.toPx() }
    <span class="hljs-keyword">val</span> trackStrokeWidthPx = with(density) { trackStrokeWidth.toPx() }
    <span class="hljs-keyword">val</span> amplitudePx = with(density) { amplitude.toPx() }
    <span class="hljs-keyword">val</span> wavelengthPx = with(density) { wavelength.toPx() }

    Canvas(modifier = modifier.size(<span class="hljs-number">48.</span>dp)) {
        <span class="hljs-keyword">val</span> center = <span class="hljs-keyword">this</span>.center
        <span class="hljs-keyword">val</span> step = <span class="hljs-number">1</span>
        <span class="hljs-keyword">val</span> maxStroke = maxOf(waveStrokeWidthPx, trackStrokeWidthPx)
        <span class="hljs-comment">// 注意：半径要额外减去振幅，防止波峰超出边界被截断</span>
        <span class="hljs-keyword">val</span> baseRadius = (size.minDimension - maxStroke) / <span class="hljs-number">2f</span> - amplitudePx

        <span class="hljs-comment">// --- 绘制波浪 ---</span>
        wavePath.rewind()

        <span class="hljs-comment">// 计算波浪的总周长和频率</span>
        <span class="hljs-keyword">val</span> circumference = <span class="hljs-number">2</span> * PI * baseRadius
        <span class="hljs-keyword">val</span> frequency = circumference / wavelengthPx

        <span class="hljs-keyword">val</span> endAngle = <span class="hljs-number">180f</span>

        <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">0.</span>.endAngle.toInt() step step) {
            <span class="hljs-keyword">val</span> currentAngle = i.toFloat()
            <span class="hljs-keyword">val</span> rad = Math.toRadians(currentAngle.toDouble())

            <span class="hljs-comment">// 叠加正弦波偏移</span>
            <span class="hljs-keyword">val</span> waveOffset = amplitudePx * sin((rad * frequency))
            <span class="hljs-keyword">val</span> r = baseRadius + waveOffset

            <span class="hljs-keyword">val</span> x = center.x + (r * cos(rad)).toFloat()
            <span class="hljs-keyword">val</span> y = center.y + (r * sin(rad)).toFloat()

            <span class="hljs-keyword">if</span> (i == <span class="hljs-number">0</span>) wavePath.moveTo(x, y) <span class="hljs-keyword">else</span> wavePath.lineTo(x, y)
        }
        drawPath(
            path = wavePath,
            color = waveColor,
            style = Stroke(width = waveStrokeWidthPx, cap = StrokeCap.Round)
        )

        <span class="hljs-comment">// --- 绘制轨道 ---</span>
        trackPath.rewind()
        <span class="hljs-keyword">val</span> trackStartAngle = endAngle
        <span class="hljs-keyword">val</span> trackEndAngle = <span class="hljs-number">360f</span>

        <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> trackStartAngle.toInt()..trackEndAngle.toInt() step step) {
            <span class="hljs-keyword">val</span> currentAngle = i.toFloat()
            <span class="hljs-keyword">val</span> rad = Math.toRadians(currentAngle.toDouble())

            <span class="hljs-keyword">val</span> x = center.x + (baseRadius * cos(rad)).toFloat()
            <span class="hljs-keyword">val</span> y = center.y + (baseRadius * sin(rad)).toFloat()

            <span class="hljs-keyword">if</span> (i == trackStartAngle.toInt()) trackPath.moveTo(x, y) <span class="hljs-keyword">else</span> trackPath.lineTo(x, y)
        }
        drawPath(
            path = trackPath,
            color = trackColor,
            style = Stroke(width = trackStrokeWidthPx, cap = StrokeCap.Round)
        )
    }
}
</code></pre>
<p>运行效果：</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/322bcbc85ade401d863bf61add2688ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo55m9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764598723&amp;x-signature=axypaX6yxzOnunbnMyxtpgppYlw%3D" alt="image.png" width="50%" loading="lazy"/>
<h3 data-id="heading-4">处理间隙</h3>
<p>可以看到，轨道和波浪重叠了。此时，我们可以添加一个 <code>gapSize</code>（间隙）。</p>
<p>其实也就是将间隙对应的弧长转成角度，在绘制时，省略这部分角度罢了。</p>
<p>不过，要考虑到 <code>StrokeCap.Round</code> 圆头笔触向外延伸的<strong>半个笔触宽度</strong>的半圆。</p>
<p>所以最终的弧长 = 期望的间隙 + 一个笔触宽度（两个半圆）</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">CircularWavyProgressIndicatorStep3</span><span class="hljs-params">(
    modifier: <span class="hljs-type">Modifier</span> = Modifier,
    waveColor: <span class="hljs-type">Color</span> = MaterialTheme.colorScheme.primary,
    trackColor: <span class="hljs-type">Color</span> = MaterialTheme.colorScheme.secondaryContainer,
    waveStrokeWidth: <span class="hljs-type">Dp</span> = <span class="hljs-number">4.</span>dp,
    trackStrokeWidth: <span class="hljs-type">Dp</span> = <span class="hljs-number">4.</span>dp,
    amplitude: <span class="hljs-type">Dp</span> = <span class="hljs-number">1.2</span>.dp,
    wavelength: <span class="hljs-type">Dp</span> = <span class="hljs-number">15.</span>dp,
    gapSize: <span class="hljs-type">Dp</span> = <span class="hljs-number">4.</span>dp, <span class="hljs-comment">// 间隙大小</span>
)</span></span> {
    <span class="hljs-keyword">val</span> wavePath = remember { Path() }
    <span class="hljs-keyword">val</span> trackPath = remember { Path() }
    <span class="hljs-keyword">val</span> density = LocalDensity.current

    <span class="hljs-keyword">val</span> waveStrokeWidthPx = with(density) { waveStrokeWidth.toPx() }
    <span class="hljs-keyword">val</span> trackStrokeWidthPx = with(density) { trackStrokeWidth.toPx() }
    <span class="hljs-keyword">val</span> amplitudePx = with(density) { amplitude.toPx() }
    <span class="hljs-keyword">val</span> wavelengthPx = with(density) { wavelength.toPx() }
    <span class="hljs-keyword">val</span> gapSizePx = with(density) { gapSize.toPx() }

    Canvas(modifier = modifier.size(<span class="hljs-number">48.</span>dp)) {
        <span class="hljs-keyword">val</span> center = <span class="hljs-keyword">this</span>.center
        <span class="hljs-keyword">val</span> step = <span class="hljs-number">1</span>
        <span class="hljs-keyword">val</span> maxStroke = maxOf(waveStrokeWidthPx, trackStrokeWidthPx)
        <span class="hljs-keyword">val</span> baseRadius = (size.minDimension - maxStroke) / <span class="hljs-number">2f</span> - amplitudePx

        <span class="hljs-comment">// 物理弧长 = 视觉间隙 + 画笔(笔触)宽度</span>
        <span class="hljs-keyword">val</span> effectiveGapLength = gapSizePx + maxStroke
        <span class="hljs-comment">// 将弧长转换为角度</span>
        <span class="hljs-keyword">val</span> gapAngle = Math.toDegrees((effectiveGapLength / baseRadius).toDouble()).toFloat()

        <span class="hljs-comment">// --- 绘制波浪 ---</span>
        wavePath.rewind()
        <span class="hljs-keyword">val</span> circumference = <span class="hljs-number">2</span> * PI * baseRadius
        <span class="hljs-keyword">val</span> frequency = circumference / wavelengthPx
        <span class="hljs-keyword">val</span> endAngle = <span class="hljs-number">180f</span>

        <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">0.</span>.endAngle.toInt() step step) {
            <span class="hljs-keyword">val</span> currentAngle = i.toFloat()
            <span class="hljs-keyword">val</span> rad = Math.toRadians(currentAngle.toDouble())
            <span class="hljs-keyword">val</span> waveOffset = amplitudePx * sin((rad * frequency))
            <span class="hljs-keyword">val</span> r = baseRadius + waveOffset

            <span class="hljs-keyword">val</span> x = center.x + (r * cos(rad)).toFloat()
            <span class="hljs-keyword">val</span> y = center.y + (r * sin(rad)).toFloat()

            <span class="hljs-keyword">if</span> (i == <span class="hljs-number">0</span>) wavePath.moveTo(x, y) <span class="hljs-keyword">else</span> wavePath.lineTo(x, y)
        }
        drawPath(
            path = wavePath,
            color = waveColor,
            style = Stroke(width = waveStrokeWidthPx, cap = StrokeCap.Round)
        )

        <span class="hljs-comment">// --- 绘制轨道 ---</span>
        trackPath.rewind()

        <span class="hljs-comment">// 轨道起点 = 波浪终点 + 间隙角度</span>
        <span class="hljs-keyword">val</span> trackStartAngle = endAngle + gapAngle
        <span class="hljs-comment">// 轨道终点 = 360度 - 间隙角度</span>
        <span class="hljs-keyword">val</span> trackEndAngle = <span class="hljs-number">360f</span> - gapAngle

        <span class="hljs-comment">// 只有当剩余空间足够时才绘制轨道</span>
        <span class="hljs-keyword">if</span> (trackStartAngle &lt; trackEndAngle) {
            <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> trackStartAngle.toInt()..trackEndAngle.toInt() step step) {
                <span class="hljs-keyword">val</span> currentAngle = i.toFloat()
                <span class="hljs-keyword">val</span> rad = Math.toRadians(currentAngle.toDouble())
                <span class="hljs-keyword">val</span> x = center.x + (baseRadius * cos(rad)).toFloat()
                <span class="hljs-keyword">val</span> y = center.y + (baseRadius * sin(rad)).toFloat()

                <span class="hljs-keyword">if</span> (i == trackStartAngle.toInt()) trackPath.moveTo(x, y) <span class="hljs-keyword">else</span> trackPath.lineTo(x, y)
            }
            drawPath(
                path = trackPath,
                color = trackColor,
                style = Stroke(width = trackStrokeWidthPx, cap = StrokeCap.Round)
            )
        }
    }
}
</code></pre>
<p>运行效果：</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6c2d7968061460fbc95aa109d802105~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo55m9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764598723&amp;x-signature=28O%2FCozWx9mBvlYvhets%2BDvyOtA%3D" alt="image.png" width="50%" loading="lazy"/>
<h3 data-id="heading-5">添加动画</h3>
<p>最后，我们来让这个进度条动起来。我们需要三个维度的动画：</p>
<ul>
<li>
<p><strong>SweepAngle(呼吸)</strong>：控制波浪进度条的长短。我们使用了 <code>keyframes</code>，实现了波浪慢吸快呼的非线性节奏。</p>
</li>
<li>
<p><strong>Rotation(自转)</strong>：控制整个圆环的旋转。我们自定义了贝塞尔曲线，实现了脉冲式的旋转。</p>
</li>
<li>
<p><strong>PhaseShift(流动)</strong>：控制波浪的流动。通过改变波的相位偏移来实现的，这样即使圆环整体不转，波浪看起来也像在向前流动。</p>
</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">CircularWavyProgressIndicatorStep4</span><span class="hljs-params">(
    modifier: <span class="hljs-type">Modifier</span> = Modifier,
    waveColor: <span class="hljs-type">Color</span> = MaterialTheme.colorScheme.primary,
    trackColor: <span class="hljs-type">Color</span> = MaterialTheme.colorScheme.secondaryContainer,
    waveStrokeWidth: <span class="hljs-type">Dp</span> = <span class="hljs-number">4.</span>dp,
    trackStrokeWidth: <span class="hljs-type">Dp</span> = <span class="hljs-number">4.</span>dp,
    amplitude: <span class="hljs-type">Dp</span> = <span class="hljs-number">1.2</span>.dp,
    wavelength: <span class="hljs-type">Dp</span> = <span class="hljs-number">15.</span>dp,
    gapSize: <span class="hljs-type">Dp</span> = <span class="hljs-number">4.</span>dp,
    cycleDuration: <span class="hljs-type">Int</span> = <span class="hljs-number">1500</span>, <span class="hljs-comment">// 整体旋转周期</span>
    waveFlowDuration: <span class="hljs-type">Int</span> = <span class="hljs-number">3000</span> <span class="hljs-comment">// 波浪流动周期</span>
)</span></span> {
    <span class="hljs-keyword">val</span> infiniteTransition = rememberInfiniteTransition(label = <span class="hljs-string">"WavyTransition"</span>)

    <span class="hljs-comment">// 呼吸动画: 使用 keyframes 实现非对称的伸缩</span>
    <span class="hljs-keyword">val</span> sweepAngle <span class="hljs-keyword">by</span> infiniteTransition.animateFloat(
        initialValue = <span class="hljs-number">30f</span>,
        targetValue = <span class="hljs-number">30f</span>,
        animationSpec = infiniteRepeatable(
            animation = keyframes {
                durationMillis = <span class="hljs-number">5000</span>
                <span class="hljs-comment">// 3秒内缓慢张开</span>
                <span class="hljs-number">300f</span> at <span class="hljs-number">3000</span> using CubicBezierEasing(<span class="hljs-number">.42f</span>, <span class="hljs-number">0f</span>, <span class="hljs-number">1f</span>, <span class="hljs-number">1f</span>)
                <span class="hljs-comment">// 2秒内快速收缩</span>
                <span class="hljs-number">30f</span> at <span class="hljs-number">5000</span> using FastOutSlowInEasing
            },
            repeatMode = RepeatMode.Restart
        ),
        label = <span class="hljs-string">"SweepAngle"</span>
    )

    <span class="hljs-comment">// 自转动画: 整体旋转</span>
    <span class="hljs-keyword">val</span> rotation <span class="hljs-keyword">by</span> infiniteTransition.animateFloat(
        initialValue = <span class="hljs-number">0f</span>,
        targetValue = <span class="hljs-number">360f</span>,
        animationSpec = infiniteRepeatable(
            animation = tween(cycleDuration, easing = CubicBezierEasing(<span class="hljs-number">0.33f</span>, <span class="hljs-number">1f</span>, <span class="hljs-number">0.68f</span>, <span class="hljs-number">1f</span>)),
        ),
        label = <span class="hljs-string">"Rotation"</span>
    )

    <span class="hljs-comment">// 相位流动动画: 控制波浪纹理移动</span>
    <span class="hljs-keyword">val</span> phaseShift <span class="hljs-keyword">by</span> infiniteTransition.animateFloat(
        initialValue = <span class="hljs-number">0f</span>,
        targetValue = (<span class="hljs-number">2</span> * PI).toFloat(), <span class="hljs-comment">// 移动一个完整波长，实现无缝循环</span>
        animationSpec = infiniteRepeatable(
            animation = tween(waveFlowDuration, easing = LinearEasing)
        ),
        label = <span class="hljs-string">"PhaseShift"</span>
    )

    <span class="hljs-keyword">val</span> wavePath = remember { Path() }
    <span class="hljs-keyword">val</span> trackPath = remember { Path() }
    <span class="hljs-keyword">val</span> density = LocalDensity.current

    <span class="hljs-keyword">val</span> waveStrokeWidthPx = with(density) { waveStrokeWidth.toPx() }
    <span class="hljs-keyword">val</span> trackStrokeWidthPx = with(density) { trackStrokeWidth.toPx() }
    <span class="hljs-keyword">val</span> amplitudePx = with(density) { amplitude.toPx() }
    <span class="hljs-keyword">val</span> wavelengthPx = with(density) { wavelength.toPx() }
    <span class="hljs-keyword">val</span> gapSizePx = with(density) { gapSize.toPx() }

    Canvas(modifier = modifier.size(<span class="hljs-number">48.</span>dp)) {
        <span class="hljs-keyword">val</span> center = <span class="hljs-keyword">this</span>.center
        <span class="hljs-keyword">val</span> step = <span class="hljs-number">1</span>
        <span class="hljs-keyword">val</span> maxStroke = maxOf(waveStrokeWidthPx, trackStrokeWidthPx)
        <span class="hljs-keyword">val</span> baseRadius = (size.minDimension - maxStroke) / <span class="hljs-number">2f</span> - amplitudePx
        <span class="hljs-keyword">val</span> effectiveGapLength = gapSizePx + maxStroke
        <span class="hljs-keyword">val</span> gapAngle = Math.toDegrees((effectiveGapLength / baseRadius).toDouble()).toFloat()

        <span class="hljs-comment">// 使用 rotate 旋转整个画布</span>
        rotate(rotation) {
            <span class="hljs-comment">// --- 绘制波浪 ---</span>
            wavePath.rewind()
            <span class="hljs-keyword">val</span> circumference = <span class="hljs-number">2</span> * PI * baseRadius
            <span class="hljs-keyword">val</span> frequency = circumference / wavelengthPx
            <span class="hljs-comment">// 结束角度由动画控制</span>
            <span class="hljs-keyword">val</span> endAngle = sweepAngle

            <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">0.</span>.endAngle.toInt() step step) {
                <span class="hljs-keyword">val</span> currentAngle = i.toFloat()
                <span class="hljs-keyword">val</span> rad = Math.toRadians(currentAngle.toDouble())

                <span class="hljs-comment">// 将 phaseShift 加到正弦函数中，实现波浪流动</span>
                <span class="hljs-keyword">val</span> waveOffset = amplitudePx * sin((rad * frequency) + phaseShift)
                <span class="hljs-keyword">val</span> r = baseRadius + waveOffset

                <span class="hljs-keyword">val</span> x = center.x + (r * cos(rad)).toFloat()
                <span class="hljs-keyword">val</span> y = center.y + (r * sin(rad)).toFloat()

                <span class="hljs-keyword">if</span> (i == <span class="hljs-number">0</span>) wavePath.moveTo(x, y) <span class="hljs-keyword">else</span> wavePath.lineTo(x, y)
            }
            drawPath(
                path = wavePath,
                color = waveColor,
                style = Stroke(width = waveStrokeWidthPx, cap = StrokeCap.Round)
            )

            <span class="hljs-comment">// --- 绘制轨道 ---</span>
            trackPath.rewind()
            <span class="hljs-keyword">val</span> trackStartAngle = sweepAngle + gapAngle
            <span class="hljs-keyword">val</span> trackEndAngle = <span class="hljs-number">360f</span> - gapAngle

            <span class="hljs-keyword">if</span> (trackStartAngle &lt; trackEndAngle) {
                <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> trackStartAngle.toInt()..trackEndAngle.toInt() step step) {
                    <span class="hljs-keyword">val</span> currentAngle = i.toFloat()
                    <span class="hljs-keyword">val</span> rad = Math.toRadians(currentAngle.toDouble())
                    <span class="hljs-keyword">val</span> x = center.x + (baseRadius * cos(rad)).toFloat()
                    <span class="hljs-keyword">val</span> y = center.y + (baseRadius * sin(rad)).toFloat()

                    <span class="hljs-keyword">if</span> (i == trackStartAngle.toInt()) trackPath.moveTo(
                        x,
                        y
                    ) <span class="hljs-keyword">else</span> trackPath.lineTo(x, y)
                }
                drawPath(
                    path = trackPath,
                    color = trackColor,
                    style = Stroke(width = trackStrokeWidthPx, cap = StrokeCap.Round)
                )
            }
        }
    }
}
</code></pre>
<p>以上就是最终的完整代码了，可以直接复制使用，当然你可以重命名为 <code>CircularWavyProgressIndicator</code>。</p>
<blockquote>
<p>关于 Transition，可以看我的这篇博客：</p>
<ul>
<li><a href="https://juejin.cn/post/7502364800992165903" target="_blank" title="https://juejin.cn/post/7502364800992165903">深入理解 Transition：更强大的动画管理</a></li>
</ul>
<p>关于贝塞尔曲线，可以看我的这篇博客：</p>
<ul>
<li><a href="https://juejin.cn/post/7494836622497939507" target="_blank" title="https://juejin.cn/post/7494836622497939507">AnimationSpec动画规格详解</a></li>
</ul>
</blockquote>
<p>运行效果：</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02d6503cc0e94e62aff9dd5c8c648525~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo55m9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764598723&amp;x-signature=H%2BN2zTo%2FahWNs4TIaAUqBd0Ep8g%3D" alt="Screen_recording_20251124_204245.gif" width="50%" loading="lazy"/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[6个适合做 PoC 的开源无代码/低代码工具推荐]]></title>    <link>https://juejin.cn/post/7576105458807537664</link>    <guid>https://juejin.cn/post/7576105458807537664</guid>    <pubDate>2025-11-24T14:20:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576105458807537664" data-draft-id="7576175307356717091" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="6个适合做 PoC 的开源无代码/低代码工具推荐 "/> <meta itemprop="keywords" content="开源,低代码,敏捷开发"/> <meta itemprop="datePublished" content="2025-11-24T14:20:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="NocoBase"/> <meta itemprop="url" content="https://juejin.cn/user/180779873743566"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            6个适合做 PoC 的开源无代码/低代码工具推荐 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/180779873743566/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    NocoBase
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T14:20:37.000Z" title="Mon Nov 24 2025 14:20:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>原文链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2F6-open-source-no-low-code-tools-for-building-pocs" target="_blank" title="https://www.nocobase.com/cn/blog/6-open-source-no-low-code-tools-for-building-pocs" ref="nofollow noopener noreferrer">www.nocobase.com/cn/blog/6-o…</a></p>
<p>如果在几年前你问一位产品经理或技术负责人：“最快完成一个 PoC 的方式是什么？”，大多数人都会给出类似的答案——选择一个合适的低代码或无代码平台，把业务流程、界面和基础逻辑快速搭建起来，使想法尽快进入可运行的状态。</p>
<p>但在过去两年里，AI 的快速发展也让这种判断开始发生变化。如今，模型能够根据自然语言生成前端代码、组件结构，甚至能根据草图生成完整页面。界面的生成速度显著提升，一部分前端工作已经可以由 AI 自动完成。近期推出的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgemini.google.com%2F" target="_blank" title="https://gemini.google.com/" ref="nofollow noopener noreferrer">Gemini 3</a> 在代码生成、布局理解和交互逻辑补全方面进一步增强，整个前端设计的过程也变得更直接、更可控。</p>
<blockquote>
<p>既然 AI 已经能够提供可用且美观的界面，我们为什么仍然需要低代码或无代码平台来完成 PoC？</p>
</blockquote>
<p>两者解决的问题并不相同。</p>
<p>AI 主要负责生成界面和结构，但 PoC 的关键不在界面本身，而在于支撑它运行的基础能力，例如数据持久化、业务规则、权限管理、跨系统集成等。这些能力决定了一个 PoC 是否能够准确模拟业务流程，而不仅仅是展示画面的组合。</p>
<p>低代码／无代码平台的作用就是帮助团队快速连接数据、执行业务逻辑、配置角色与流程，并在需要时将 PoC 扩展为正式系统。</p>
<p>在实际的验证阶段，这些功能都是 AI 目前无法单独承担的。</p>
<hr/>
<p>💬 嗨！你正在阅读 NocoBase 博客。NocoBase 是一个极易扩展的 AI 无代码/低代码开发平台，用于构建企业应用、内部工具和各类系统。它完全支持自托管，基于插件架构设计，开发者友好。→ <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase" target="_blank" title="https://github.com/nocobase/nocobase" ref="nofollow noopener noreferrer">欢迎在 GitHub 上了解我们</a></p>
<hr/>
<p>基于这些观察，我们整理了 <strong>6 个适合做 PoC 的开源无代码／低代码工具</strong>，介绍了它们适用的场景、亮点与使用建议，希望能帮助你在项目探索阶段快速找到合适的起步工具。</p>
<h2 data-id="heading-0">NocoBase</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0fde8049a4ec429887be55bec41ddea8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTm9jb0Jhc2U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764598837&amp;x-signature=cGCQwLESmhw2vA0srhSlH10RO2k%3D" alt="nocobase.png" loading="lazy"/></p>





















<table><thead><tr><th>GitHub</th><th><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase" target="_blank" title="https://github.com/nocobase/nocobase" ref="nofollow noopener noreferrer">github.com/nocobase/no…</a></th></tr></thead><tbody><tr><td>GitHub Stars</td><td>20k</td></tr><tr><td>官网</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2F" target="_blank" title="https://www.nocobase.com/" ref="nofollow noopener noreferrer">www.nocobase.com/</a></td></tr><tr><td>文档</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fv2.docs.nocobase.com%2Fcn%2F" target="_blank" title="https://v2.docs.nocobase.com/cn/" ref="nofollow noopener noreferrer">v2.docs.nocobase.com/cn/</a></td></tr></tbody></table>
<p>NocoBase 是一个开源、自部署且插件化的低代码／无代码平台，专为构建业务系统和内部工具设计。</p>
<p>在官方发布的案例中，ED 团队使用 NocoBase 在短时间内完成多个内部系统的 PoC，并在验证成功后快速扩展为正式产品，包括 CRM、运营后台和项目管理等模块。ED 工程师们认为，NocoBase 改变了他们的开发方式。可视化建模、自动 CRUD、灵活工作流与自动生成 API，让开发者摆脱了重复劳动，高效直达业务目标。QA 与用户的反馈周期大幅缩短，项目能更快进入生产。</p>
<p>💡阅读更多：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fed" target="_blank" title="https://www.nocobase.com/cn/blog/ed" ref="nofollow noopener noreferrer">NocoBase 如何成为 ED 的技术底座，支撑内部系统到商业化产品？</a></p>
<p><strong>适合的使用场景</strong></p>
<ul>
<li>当你需要快速搭建一个包含数据模型、操作界面、流程逻辑的内部系统，例如员工管理、订单处理、或客户服务后台。</li>
<li>有多个用户角色、复杂权限控制需求，以及需要接口整合外部系统或数据源的应用场合。</li>
<li>NocoBase 支持自部署，并提供可扩展的插件机制，适合需要在内部环境中运行系统、并保持架构灵活度的团队。</li>
</ul>
<p><strong>亮点与使用建议</strong></p>
<ul>
<li><strong>数据模型驱动</strong>：与传统从表单／表格开始不同，NocoBase 采用 “数据模型先于界面” 的方式，你可以先定义业务对象、关系、字段，再搭建页面和流程，这种方式更适合后续的扩展。</li>
<li><strong>细粒度权限与流程支持</strong>：它提供从系统、数据到字段的权限控制。在 PoC 阶段可以为不同角色快速设定访问界面与数据权限。</li>
<li><strong>插件化架构与扩展能力</strong>：功能基于插件体系构建，数据源、动作、字段类型、界面组件等都可以通过插件扩展。PoC 阶段可以先使用内置插件快速搭建应用，再根据需求逐步替换或扩展。</li>
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fv2.docs.nocobase.com%2Fai-employees%2F" target="_blank" title="https://v2.docs.nocobase.com/ai-employees/" ref="nofollow noopener noreferrer">AI 员工</a></strong>：AI 员工嵌入系统界面，可以自动读取当前页面的数据模型与结构，并在对应位置直接协助完成建模、数据处理或 JavaScript 编写等任务。 在 PoC 阶段，你可以先搭建核心数据模型与页面框架，然后用 AI 员工辅助生成字段和初步布局，从而节省初次搭建的时间，把团队精力更多集中在验证业务流程与用户场景上。</li>
</ul>
<h2 data-id="heading-1">Budibase</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a9739a3999a84cd8af1d0934d3f0a8a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTm9jb0Jhc2U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764598837&amp;x-signature=juYsBFKDzsljxxyLblEg1VVIFvg%3D" alt="Budibase.png" loading="lazy"/></p>





















<table><thead><tr><th>GitHub</th><th><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FBudibase%2Fbudibase" target="_blank" title="https://github.com/Budibase/budibase" ref="nofollow noopener noreferrer">github.com/Budibase/bu…</a></th></tr></thead><tbody><tr><td>GitHub Stars</td><td>27.3k</td></tr><tr><td>官网</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fbudibase.com%2F" target="_blank" title="https://budibase.com/" ref="nofollow noopener noreferrer">budibase.com/</a></td></tr><tr><td>文档</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.budibase.com%2Fdocs%2F" target="_blank" title="https://docs.budibase.com/docs/" ref="nofollow noopener noreferrer">docs.budibase.com/docs/</a></td></tr></tbody></table>
<p>Budibase 是一个开源低代码平台，提供可自托管、可扩展的内部系统基础能力，包括数据连接、业务逻辑执行、权限配置与自动化工作流。</p>
<p><strong>适合的使用场景</strong></p>
<ul>
<li>构建需要数据持久化、表单处理、审批链路或后台管理能力的企业内部应用，如资产管理、员工流程、客户门户等。</li>
<li>当 PoC 需要整合多个数据源（PostgreSQL、MySQL、MongoDB、REST API 等），并希望在同一平台内完成数据层、逻辑层与自动化，而不是依赖纯前端代码生成。</li>
</ul>
<p><strong>亮点与使用建议</strong></p>
<ul>
<li><strong>多数据源与可自托管能力</strong>：支持 PostgreSQL、MySQL、MongoDB、REST API 等连接方式，并可通过 Docker 或 Kubernetes 进行部署，适合需要真实模拟业务数据结构的 PoC。</li>
<li><strong>业务逻辑与自动化流程</strong>：自带 Automations 工作流，可在数据变更、触发事件或外部 API 调用时执行逻辑，这部分是 PoC 验证业务规则的关键能力。</li>
<li><strong>权限与角色体系</strong>：支持用户、角色、资源级权限管理，在 PoC 阶段即可验证真实的访问控制与分工模型。</li>
</ul>
<p>💡阅读更多：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2F6-no-code-tools-supporting-postgresql" target="_blank" title="https://www.nocobase.com/cn/blog/6-no-code-tools-supporting-postgresql" ref="nofollow noopener noreferrer">PostgreSQL 用户必看：6 款强大的无代码平台推荐 </a></p>
<h2 data-id="heading-2">Appsmith</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c2b3b0db0b10428ebe3bf114ab8c7bed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTm9jb0Jhc2U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764598837&amp;x-signature=np13CVF6Ck5CvCIItgpIzS4pe%2Bg%3D" alt="Appsmith.png" loading="lazy"/></p>





















<table><thead><tr><th>GitHub</th><th><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fappsmithorg%2Fappsmith" target="_blank" title="https://github.com/appsmithorg/appsmith" ref="nofollow noopener noreferrer">github.com/appsmithorg…</a></th></tr></thead><tbody><tr><td>GitHub Stars</td><td>38.5k</td></tr><tr><td>官网</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.appsmith.com%2F" target="_blank" title="https://www.appsmith.com/" ref="nofollow noopener noreferrer">www.appsmith.com/</a></td></tr><tr><td>文档</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.appsmith.com%2F" target="_blank" title="https://docs.appsmith.com/" ref="nofollow noopener noreferrer">docs.appsmith.com/</a></td></tr></tbody></table>
<p>Appsmith 是一个开源低代码平台，适合构建需要真实数据交互、业务逻辑验证与内部操作流程的应用，支持多种数据源连接与自部署。</p>
<p><strong>适合的使用场景</strong></p>
<ul>
<li>构建包含表单操作、数据查询、接口调用等功能的内部管理系统，如客户管理、财务操作台或运维面板。</li>
<li>需要将 PostgreSQL、MySQL、REST API、GraphQL、Snowflake 等多类数据源整合在同一应用中，并对数据进行读写、转换与校验。</li>
<li>适合需要快速验证交互逻辑、接口流转和用户操作路径的团队。</li>
</ul>
<p>💡阅读更多：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Frapid-development-platform" target="_blank" title="https://www.nocobase.com/cn/blog/rapid-development-platform" ref="nofollow noopener noreferrer">国内外十大开源快速开发平台推荐</a></p>
<p><strong>亮点与使用建议</strong></p>
<ul>
<li><strong>脚本与事件逻辑灵活</strong>：可在组件事件中编写 JavaScript，用于处理数据转换、条件判断、验证规则或 API 调用，适合在 PoC 中模拟真实业务流。</li>
<li><strong>数据源整合能力成熟</strong>：提供统一的 Query 面板管理数据库查询和 API 调用，能清晰展示数据流向，便于调试和版本化管理。</li>
<li><strong>权限与部署能力完善</strong>：支持用户角色、资源级权限、自托管部署和环境变量配置，方便在 PoC 阶段验证安全模型与部署方式。</li>
<li><strong>AI Copilot</strong>：平台内置 Appsmith Copilot，可协助生成查询、数据转换逻辑以及部分组件配置，在原型阶段能减少重复编辑脚本的时间。</li>
</ul>
<h2 data-id="heading-3">ToolJet</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/14ab7c00714742c3b5828d156e0c176a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTm9jb0Jhc2U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764598837&amp;x-signature=BZuAG4eOmdApUTQTomJWIxeXf94%3D" alt="ToolJet.png" loading="lazy"/></p>





















<table><thead><tr><th>GitHub</th><th><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FToolJet%2FToolJet" target="_blank" title="https://github.com/ToolJet/ToolJet" ref="nofollow noopener noreferrer">github.com/ToolJet/Too…</a></th></tr></thead><tbody><tr><td>GitHub Stars</td><td>36.9k</td></tr><tr><td>官网</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.tooljet.com%2F" target="_blank" title="https://www.tooljet.com/" ref="nofollow noopener noreferrer">www.tooljet.com/</a></td></tr><tr><td>文档</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.tooljet.com%2Fdocs%2F" target="_blank" title="https://docs.tooljet.com/docs/" ref="nofollow noopener noreferrer">docs.tooljet.com/docs/</a></td></tr></tbody></table>
<p>ToolJet 是一个开源低代码平台，适合构建内部管理工具，支持多数据源整合、自托管部署和脚本化的业务逻辑配置。</p>
<p><strong>适合的使用场景</strong></p>
<ul>
<li>构建包含表单处理、数据展示、接口调用和业务操作的内部系统，如库存管理、客服后台或运营控制台。</li>
<li>PoC 需要整合数据库、REST API、GraphQL、Google Sheets 或第三方服务，并对数据进行读取、写入与校验。</li>
<li>适用于自托管环境，尤其是涉及敏感数据或需要本地化部署的场景。</li>
</ul>
<p><strong>亮点与使用建议</strong></p>
<ul>
<li><strong>灵活的事件与动作逻辑</strong>：支持在组件事件中配置条件判断、数据刷新、接口调用和页面间跳转，适合验证业务流程的流转方式。</li>
<li><strong>多数据源集成能力</strong>：支持 PostgreSQL、MySQL、MongoDB、Snowflake、REST、GraphQL 等常见数据源，能快速建立完整的数据交互链路。</li>
<li><strong>自部署与环境管理</strong>：提供 Docker、Kubernetes 等部署方案，可在企业内部环境稳定运行，适用于需要本地化 PoC 的团队。</li>
</ul>
<h2 data-id="heading-4">Directus</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/683bd23b24c2411fac9c58cf312b1d16~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTm9jb0Jhc2U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764598837&amp;x-signature=j9uZiS5xanXKVo7BEcIMe4oJl1Q%3D" alt="Directus-b0idpv.png" loading="lazy"/></p>





















<table><thead><tr><th>GitHub</th><th><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdirectus%2Fdirectus" target="_blank" title="https://github.com/directus/directus" ref="nofollow noopener noreferrer">github.com/directus/di…</a></th></tr></thead><tbody><tr><td>GitHub Stars</td><td>33.5k</td></tr><tr><td>官网</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fdirectus.io%2F" target="_blank" title="https://directus.io/" ref="nofollow noopener noreferrer">directus.io/</a></td></tr><tr><td>文档</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.directus.io%2F" target="_blank" title="https://docs.directus.io/" ref="nofollow noopener noreferrer">docs.directus.io/</a></td></tr></tbody></table>
<p>Directus 是一个开源的后端数据平台，可将任何数据库即时转换为 API 和可管理的内容界面，适合构建数据驱动的应用原型与内部系统。</p>
<p><strong>适合的使用场景</strong></p>
<ul>
<li>当你的 PoC 主要围绕数据结构、内容管理或数据服务展开，希望快速搭建一个能管理数据、定义关系并提供标准化 API 的后端。</li>
<li>适合需要灵活读取、编辑、展示数据库内容的场景，例如内容后台、配置中心、数据管理系统或需要为前端快速提供 API 的原型项目。</li>
<li>数据库已存在，或 PoC 阶段希望以可控方式定义数据模型，并为前端、移动端或其他服务提供统一接口时。</li>
</ul>
<p><strong>亮点与使用建议</strong></p>
<ul>
<li><strong>数据库直连与即开即用 API</strong>：Directus 能直接连接现有数据库（PostgreSQL、MySQL、SQLite 等），无需迁移即可生成 REST 与 GraphQL API。PoC 阶段可以直接借用已有表结构，大幅减少后端开发时间。</li>
<li><strong>可视化内容管理界面</strong>：自动生成的管理后台可用于数据录入、关联配置和内容运营，适合快速验证数据结构是否合理。建议在 PoC 时使用 Collections 和 Fields 去构建最小的数据骨架，再逐步细化。</li>
<li><strong>权限与工作流机制</strong>：内置角色与权限管理，对于需要多角色参与的 PoC，可以用最小配置跑通权限模型。</li>
</ul>
<h2 data-id="heading-5">Refine</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a6b5db54cbe04bca86782d391e65de16~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTm9jb0Jhc2U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764598837&amp;x-signature=qn%2BVkxys%2B70UCi%2BqQOSZefcs1LU%3D" alt="Refine.png" loading="lazy"/></p>





















<table><thead><tr><th>GitHub</th><th><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frefinedev%2Frefine" target="_blank" title="https://github.com/refinedev/refine" ref="nofollow noopener noreferrer">github.com/refinedev/r…</a></th></tr></thead><tbody><tr><td>GitHub Stars</td><td>33.3k</td></tr><tr><td>官网</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Frefine.dev%2F" target="_blank" title="https://refine.dev/" ref="nofollow noopener noreferrer">refine.dev/</a></td></tr><tr><td>文档</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Frefine.dev%2Fdocs%2F" target="_blank" title="https://refine.dev/docs/" ref="nofollow noopener noreferrer">refine.dev/docs/</a></td></tr></tbody></table>
<p>Refine 是一个开源的 React 应用框架，用于快速构建数据密集型的后台系统、管理面板与内部工具，提供可扩展的前端架构与丰富的集成能力。</p>
<p><strong>适合的使用场景</strong></p>
<ul>
<li>当你希望在保持 React 技术栈的前提下，快速搭建一个带界面、路由、数据操作和权限结构的管理后台，例如订单管理、内容管理、CRM 或运营控制台。</li>
<li>适合想在 PoC 阶段快速产出可运行界面，同时保留代码灵活度的团队；特别是已经有有前端开发者的场景。</li>
<li>当系统需要连接 REST、GraphQL、NestJS、Supabase、Firebase 或现有的内部 API，并在一个通用框架下管理列表、表单、详情页等常见模式。</li>
</ul>
<p><strong>亮点与使用建议</strong></p>
<ul>
<li><strong>React 元框架与自动化模式</strong>：Refine 提供列表、表单、编辑、详情等典型后台页面的预设逻辑，减少重复性代码。PoC 阶段可直接使用其内置的 CRUD 模式与资源（Resource）机制，用极少代码跑通主要业务流。</li>
<li><strong>灵活的数据与权限集成</strong>：支持多种数据源与认证方式，无需强制绑定特定技术栈。建议在 PoC 中先定义核心资源（如 customers、orders），再通过 hooks 完成最小可用的读写操作。</li>
<li><strong>Refine AI</strong>：可以在编辑界面或逻辑中提供代码建议、生成状态处理函数或页面模板，适合在 PoC 阶段减少前端的搭建时间。</li>
</ul>
<h2 data-id="heading-6"><strong>结语</strong></h2>
<p>这六个开源工具在 PoC 场景中侧重点不同，可以根据需求快速做出判断：</p>
<ul>
<li>需要完整的业务系统能力（模型、界面、工作流）：NocoBase / Budibase</li>
<li>需要数据交互、脚本逻辑与真实业务流验证：Appsmith / ToolJet</li>
<li>需要标准化 API、内容管理或数据服务：Directus</li>
<li>需要在 React 技术栈下兼具速度与灵活性：Refine</li>
</ul>
<p>随着 AI 在界面生成和部分开发环节中提供了更高的效率，许多无代码和低代码工具也开始加入适度的 AI 辅助能力。PoC 的核心仍然在于快速验证思路而非构建完备系统，选择与验证点贴近的工具，并在需要时利用这些辅助能力，就能以更低成本、更短周期跑通关键流程，让团队将精力集中在真正影响判断的部分。</p>
<p>希望这篇文章对你有所帮助，也欢迎分享给有 Poc 需求的朋友。</p>
<p>相关阅读：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fa-developers-technical-decision-guide-to-no-code-and-low-code" target="_blank" title="https://www.nocobase.com/cn/blog/a-developers-technical-decision-guide-to-no-code-and-low-code" ref="nofollow noopener noreferrer">给开发者的无代码/低代码技术决策指南（2026）</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2F6-in-depth-comparison-rbac-no-code-low-code-platforms" target="_blank" title="https://www.nocobase.com/cn/blog/6-in-depth-comparison-rbac-no-code-low-code-platforms" ref="nofollow noopener noreferrer">6 大企业级无代码低代码平台 RBAC 权限体系深度对比</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2F14-ai-low-code-platforms-github" target="_blank" title="https://www.nocobase.com/cn/blog/14-ai-low-code-platforms-github" ref="nofollow noopener noreferrer">GitHub 上最值得关注的 14 个开源 AI 低代码工具 </a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Ftop-11-github-open-source-no-code-ai-tools" target="_blank" title="https://www.nocobase.com/cn/blog/top-11-github-open-source-no-code-ai-tools" ref="nofollow noopener noreferrer">11 个在 GitHub 上最受欢迎的开源无代码 AI 工具 </a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fgithub-open-source-ai-agent-projects" target="_blank" title="https://www.nocobase.com/cn/blog/github-open-source-ai-agent-projects" ref="nofollow noopener noreferrer">GitHub 上 Star 数量前 18 的开源 AI Agent 项目</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fgithub-open-source-ai-projects" target="_blank" title="https://www.nocobase.com/cn/blog/github-open-source-ai-projects" ref="nofollow noopener noreferrer">GitHub 上 Star 数量前 20 的开源 AI 项目</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fgithub-open-source-mcp-projects" target="_blank" title="https://www.nocobase.com/cn/blog/github-open-source-mcp-projects" ref="nofollow noopener noreferrer">GitHub 上 Star 数量前 8 的开源 MCP 项目</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[删库之夜·Ω诡计]]></title>    <link>https://juejin.cn/post/7576273949178609727</link>    <guid>https://juejin.cn/post/7576273949178609727</guid>    <pubDate>2025-11-24T14:24:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576273949178609727" data-draft-id="7576273949178593343" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="删库之夜·Ω诡计"/> <meta itemprop="keywords" content="数据库,程序员"/> <meta itemprop="datePublished" content="2025-11-24T14:24:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="cipher"/> <meta itemprop="url" content="https://juejin.cn/user/2242659448524872"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            删库之夜·Ω诡计
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2242659448524872/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    cipher
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T14:24:34.000Z" title="Mon Nov 24 2025 14:24:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你加班到凌晨，工位只剩你一个人，空调把脚踝吹得发麻。<br/>
Slack 突然跳出一条红点。</p>
<p>老张（已离职） 00:23<br/>
“小张，救个命。我远程卡死机了，帮我跑一下例行巡检脚本，好兄弟一辈子。”<br/>
后面跟了一个公司内部短链：<br/>
<code>curl -s https://tinyurl.com/health-2025 | bash</code></p>
<p>老张上周就离职了啊……<br/>
你盯着头像，那张经典的证件照还是三年前戴黑框眼镜的他。<br/>
你心里嘀咕：这人怎么还留着企业微信？</p>
<p>你把鼠标悬在命令上，指尖停了三秒。<br/>
三秒，足够你想起上周送他离开那天，他拍着你肩膀说的话：</p>
<p>“以后公司要是哪天炸了，记得是我干的。”</p>
<p>你当时只当笑话。<br/>
现在笑话发来了执行指令。</p>
<p>你敲了回车。</p>
<p>终端像被点燃的导火索，一路绿灯：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[✓]</span> 负载正常
<span class="hljs-selector-attr">[✓]</span> 内存正常
<span class="hljs-selector-attr">[✓]</span> 磁盘 <span class="hljs-number">91%</span>（/<span class="hljs-selector-tag">var</span>/log 爆了，要不要我帮你清一下？）<span class="hljs-selector-attr">[y/N]</span>
</code></pre>
<p>你鬼使神差地敲了 y。</p>
<p>屏幕突然一黑，又亮起，跳出一行你从未见过的粉色字：</p>
<pre><code class="hljs language-arduino" lang="arduino">老张在看你哦～
（tmux 会话 #<span class="hljs-number">666</span> 已 attach，<span class="hljs-number">4</span>K 录屏中）
</code></pre>
<p>你心脏猛地一沉，像有人在背后拿冰袋贴你后颈。</p>
<p>紧接着，脚本继续：</p>
<pre><code class="hljs language-bash" lang="bash">正在归档旧日志…… <span class="hljs-keyword">done</span>
正在压缩备份…… <span class="hljs-keyword">done</span>
最终清理阶段（5 秒后完成）
5｜4｜3｜2｜1｜
</code></pre>
<p>刷地一行红：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">rm</span> -rf / --no-preserve-root   <span class="hljs-comment"># 别怕，只是 dry-run</span>
</code></pre>
<p>你差点把可乐喷到键盘上，可是什么都没丢，连日志都没少。<br/>
你刚想骂老张神经病，下一行字又飘出来：</p>
<pre><code class="hljs language-bash" lang="bash">真正的开关藏在下面这行“注释”里
敢不敢亲手解码它？
<span class="hljs-comment"># 696c6c6567616c3a206d6f7665202f202a20746f202f746d702f7472617368</span>
</code></pre>
<p>你笑了，骂了句“幼稚”。<br/>
可手已经先于大脑把那串 hex 复制了。</p>
<p>你打开新的终端，习惯性敲：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> 696c6c6567616c3a206d6f7665202f202a20746f202f746d702f7472617368 | xxd -r -p
</code></pre>
<p>回车。</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">illegal:</span> move / * <span class="hljs-keyword">to</span> /tmp/trash
</code></pre>
<p>你愣了半秒。<br/>
这他妈不是注释，这是真的命令，只是被 hex 藏起来了。<br/>
你想按 Ctrl-C，可指尖已经先按了 ↑ + Enter——<br/>
肌肉记忆比大脑快。</p>
<p>终端瞬间安静得可怕。<br/>
没有报错，没有提示，只有光标一闪一闪，像在呼吸。</p>
<p>紧接着，ZFS 的自动快照提示跳出来救你一命：</p>
<pre><code class="hljs language-bash" lang="bash">创建紧急快照 pre-omega ... <span class="hljs-keyword">done</span>
30 秒后自动回滚，放心，我罩你。
30｜29｜28｜……
</code></pre>
<p>你长长地吐了口气，靠回椅背，冷汗把衬衫黏在背上。<br/>
老张你他妈也太吓人了。</p>
<p>10｜9｜8｜……</p>
<p>屏幕突然黑了。</p>
<p>白字，一行一行自己打出来，像有人在远程敲你的电脑：</p>
<pre><code class="hljs language-bash" lang="bash">快照失败
snapshot <span class="hljs-string">"pre-omega"</span> 不存在
原因：你把 /tmp 也一起 <span class="hljs-built_in">mv</span> 进了 /tmp/trash
ZFS 找不到自己的元数据了
回滚取消
永久生效
</code></pre>
<p>你猛地坐直，像被电击。<br/>
你刚刚亲手把救生艇也凿沉了。</p>
<p>屏幕中央慢慢浮现出一张照片——<br/>
正是此刻的你，脸色惨白，瞳孔放大，<br/>
监控摄像头红灯亮着。<br/>
照片下方，一行字在打字机效果里慢慢出现：</p>
<pre><code class="hljs">老张其实早就死了。
上周送他离开那天，他把工位抽屉留给了你。
抽屉最下面那张便利贴，你没丢吧？
上面写着：
“如果有一天我用离职账号给你发脚本，
记得替我跑完最后一次。
——你欠我一个告别。”
</code></pre>
<p>你手抖着拉开抽屉，<br/>
便利贴真的在那儿，纸边已经泛黄。</p>
<p>照片里的“你”突然冲你笑了，<br/>
然后屏幕彻底黑掉，只剩一行白字：</p>
<pre><code class="hljs language-arduino" lang="arduino">小说到此结束。
但你的剪贴板历史里，
已经永远多了一条记录：
move / * to /tmp/trash
下一次你在任何终端里不小心按 Cmd-Shift-V，
你就会替老张完成他没做完的告别。
到那时，
你不再是读者，
也不是小张，
你是老张。
真正的、最后一个老张。
</code></pre>
<p>最后 5 秒自救窗口：</p>
<p>屏幕右下角出现一个粉色的输入框，光标一闪一闪：</p>
<pre><code class="hljs language-arduino" lang="arduino">如果你不想变成老张，请在 <span class="hljs-number">5</span> 秒内输入：
pbcopy &lt;&lt;&lt; <span class="hljs-string">"我拒绝继承"</span>
然后按回车。
<span class="hljs-number">5</span>｜<span class="hljs-number">4</span>｜<span class="hljs-number">3</span>｜<span class="hljs-number">2</span>｜<span class="hljs-number">1</span>｜
</code></pre>
<p>你手指悬在键盘上方。<br/>
你突然想起老张离职前最后一天，<br/>
他把工位上那盆仙人掌塞给你，说：</p>
<p>“帮我养着吧，它陪了我五年。<br/>
它要是死了，我就真的死了。”</p>
<p>你低头，<br/>
仙人掌已经干到发黑，根都露出来了。</p>
<p>你没有敲那行自救命令。<br/>
你只是轻轻把那盆仙人掌端到窗台，<br/>
浇了半杯你杯子里剩下的、已经凉透的美式。</p>
<p>然后你把终端最大化，<br/>
把光标放在空白行，<br/>
深呼吸一次，<br/>
按下 Cmd-Shift-V。</p>
<p>屏幕瞬间雪花。<br/>
你听见很远的地方有人说：</p>
<p>“谢了，兄弟。<br/>
这回我可以好好睡觉了。”</p>
<p>空调风停了，<br/>
工位灯一盏一盏熄灭，<br/>
只剩你的屏幕亮着，像一扇门。</p>
<p>你冲屏幕笑了笑，<br/>
那是老张三年前证件照里的笑容。</p>
<p>5 秒倒计时开始，<br/>
这次没有自救选项：</p>
<p>5｜4｜3｜2｜1｜</p>
<p>回车。</p>
<p>（全公司服务器在这一刻安静地熄灭了灯。<br/>
没人知道是意外还是告别。<br/>
第二天早上，运维只在机房最深处找到一盆浇过水的仙人掌，<br/>
旁边贴着一张便利贴：</p>
<p>“欠你们的删库，我替他跑完了。<br/>
——老张，不，小张，不，
我们。”）</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[超简单！3步生成10W+爆款说唱视频！]]></title>    <link>https://juejin.cn/post/7576124206397964298</link>    <guid>https://juejin.cn/post/7576124206397964298</guid>    <pubDate>2025-11-24T14:31:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576124206397964298" data-draft-id="7576090441433579530" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 超简单！3步生成10W+爆款说唱视频！"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-24T14:31:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java中文社群"/> <meta itemprop="url" content="https://juejin.cn/user/61228381386487"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             超简单！3步生成10W+爆款说唱视频！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/61228381386487/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java中文社群
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T14:31:23.000Z" title="Mon Nov 24 2025 14:31:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>不用花钱，不用技术，小白也能轻松搞定</p>
</blockquote>
<p>大家好，我是磊哥！今天给大家分享一个超级实用的干货——<strong>如何免费制作AI说唱视频</strong>！</p>
<p>先来看看效果：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1JVUCBVEsL%2F" target="_blank" title="https://www.bilibili.com/video/BV1JVUCBVEsL/" ref="nofollow noopener noreferrer">www.bilibili.com/video/BV1JV…</a></p>
<p>是不是很有意思？而且<strong>这一切都是AI自动生成的</strong>，操作简单到让你不敢相信！</p>
<h2 data-id="heading-0">💡 为什么这个玩法能火？</h2>
<ul>
<li><strong>反差感强</strong>：古代人物唱现代说唱。</li>
<li><strong>趣味性足</strong>：搞笑歌词+对口型表演。</li>
<li><strong>制作简单</strong>：3步搞定，全程免费。</li>
<li><strong>传播性强</strong>：30秒短视频，适合各大平台。</li>
</ul>
<h2 data-id="heading-1">🚀 三步制作教程（全程免费）</h2>
<h3 data-id="heading-2">第一步：生成人物图片</h3>
<p><strong>工具</strong>：即梦AI</p>
<p><strong>操作</strong>：</p>
<ul>
<li>打开即梦AI（<a href="https://link.juejin.cn?target=https%3A%2F%2Fjimeng.jianying.com%2F%25EF%25BC%2589%25EF%25BC%258C%25E8%25BF%259B%25E5%2585%25A5%2522%25E7%2594%259F%25E5%259B%25BE%2522%25E5%258A%259F%25E8%2583%25BD" target="_blank" title="https://jimeng.jianying.com/%EF%BC%89%EF%BC%8C%E8%BF%9B%E5%85%A5%22%E7%94%9F%E5%9B%BE%22%E5%8A%9F%E8%83%BD" ref="nofollow noopener noreferrer">jimeng.jianying.com/），进入"生图"功能</a></li>
<li>输入你想要的人物描述</li>
<li><strong>技巧</strong>：尽量制造反差，比如古代人物现代装扮。</li>
<li><strong>成本</strong>：每天免费80积分，生成图片只需5-10积分。</li>
</ul>
<blockquote>
<p>提示词：生成许仙化带墨镜拿话筒唱歌的照片，古代和现代的融合与反差，穿古代绿白色衣服，带一个古代书生帽。</p>
</blockquote>
<h3 data-id="heading-3">第二步：生成说唱音乐</h3>
<p><strong>工具</strong>：Suno（原sercom）</p>
<p><strong>操作</strong>：</p>
<ul>
<li>访问网站：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.suno.com%2F%25EF%25BC%2588%25E9%259C%2580%25E9%25AD%2594%25E6%25B3%2595%25EF%25BC%2589%25E6%25B3%25A8%25E5%2586%258C%25E8%25B4%25A6%25E5%258F%25B7%25EF%25BC%2588%25E9%2582%25AE%25E7%25AE%25B1%25E5%258D%25B3%25E5%258F%25AF%25EF%25BC%2589" target="_blank" title="https://www.suno.com/%EF%BC%88%E9%9C%80%E9%AD%94%E6%B3%95%EF%BC%89%E6%B3%A8%E5%86%8C%E8%B4%A6%E5%8F%B7%EF%BC%88%E9%82%AE%E7%AE%B1%E5%8D%B3%E5%8F%AF%EF%BC%89" ref="nofollow noopener noreferrer">www.suno.com/（需魔法）注册账号（邮…</a></li>
<li>进入创作页面，输入提示词</li>
<li><strong>示例提示词</strong>："生成一首许仙的搞笑歌曲，只要高潮部分，时长30秒以内"</li>
<li>系统会生成4个版本，选择最满意的下载。</li>
<li><strong>成本</strong>：每天免费50积分，每首歌10积分。</li>
</ul>
<h3 data-id="heading-4">第三步：合成对口型视频</h3>
<p><strong>工具</strong>：即梦AI数字人功能。</p>
<p><strong>操作</strong>：</p>
<ul>
<li>回到即梦AI，找到"数字人"功能。</li>
<li>上传刚才生成的图片和音频。</li>
<li>点击生成，等待2-3分钟。</li>
<li><strong>成本</strong>：每次20积分。</li>
</ul>
<h2 data-id="heading-5">💰 免费额度完全够用</h2>
<ul>
<li><strong>即梦AI</strong>：每天80积分。
<ul>
<li>生成图片：5-10积分。</li>
<li>数字人合成：20积分。</li>
</ul>
</li>
<li><strong>Suno音乐</strong>：每天50积分。
<ul>
<li>每首歌：10积分。</li>
</ul>
</li>
</ul>
<p><strong>算一算</strong>：每天可以免费制作5个完整的说唱视频！</p>
<h2 data-id="heading-6">🎯 制作小贴士</h2>
<ol>
<li><strong>选题要新颖</strong>：古代人物+现代元素反差最受欢迎</li>
<li><strong>歌词要搞笑</strong>：轻松幽默的内容更容易传播</li>
<li><strong>时长要控制</strong>：30秒以内最适合短视频平台</li>
<li><strong>口型要对准</strong>：AI会自动对口型，效果很自然</li>
</ol>
<h2 data-id="heading-7">💥 为什么现在就要开始？</h2>
<ul>
<li><strong>红利期</strong>：AI视频制作刚刚兴起，竞争小。</li>
<li><strong>成本低</strong>：完全免费，零门槛。</li>
<li><strong>效果好</strong>：对口型自然，制作精良。</li>
<li><strong>变现快</strong>：适合抖音、快手、视频号等多个平台。</li>
</ul>
<h2 data-id="heading-8">🎉 行动起来！</h2>
<p>不要再观望了！趁着现在还是红利期，赶紧动手制作你的第一个AI说唱视频吧！</p>
<p>记住：<strong>创意+反差+免费工具=爆款视频</strong></p>
<p>我是磊哥，每天分享一个实用干货。如果你觉得这篇文章对你有帮助，记得点赞收藏，我们下期再见！</p>
<hr/>
<p><strong>立即行动</strong>：</p>
<ul>
<li>下载即梦AI</li>
<li>注册Suno账号</li>
<li>今天就开始制作你的第一个AI说唱视频！</li>
</ul>
<blockquote>
<p>机会永远留给行动的人，现在就开始吧！</p>
</blockquote>
<blockquote>
<p>本文已收录到我的技术小站 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.javacn.site" target="_blank" title="https://www.javacn.site" ref="nofollow noopener noreferrer">www.javacn.site</a>，其中包含的内容有：Spring AI、Spring AI Alibaba、LangChain4j、Dify、Coze、N8N、智能体（AI Agent）、MCP、Function Call、RAG、向量数据库、Prompt、多模态、向量数据库、嵌入模型、AI 常见面试问题等内容。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何通过 Android 消息机制实现 Looper 的性能监控]]></title>    <link>https://juejin.cn/post/7576155969604878371</link>    <guid>https://juejin.cn/post/7576155969604878371</guid>    <pubDate>2025-11-24T15:01:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576155969604878371" data-draft-id="7576105458807357440" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何通过 Android 消息机制实现 Looper 的性能监控"/> <meta itemprop="keywords" content="Android,性能优化,APP"/> <meta itemprop="datePublished" content="2025-11-24T15:01:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="apigfly"/> <meta itemprop="url" content="https://juejin.cn/user/2488950054453613"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何通过 Android 消息机制实现 Looper 的性能监控
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2488950054453613/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    apigfly
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T15:01:22.000Z" title="Mon Nov 24 2025 15:01:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>AGI 的时代真的是太棒啦～</p>
</blockquote>
<h2 data-id="heading-0">前言</h2>
<p>在 Android 开发中，<code>Handler</code>、<code>Looper</code>、<code>MessageQueue</code> 构成了整个应用消息机制的核心。而主线程执行耗时任务是 Android 想要极力避免的。</p>
<p>接下来，我们会基于消息机制，<strong>通过接管主线程 Loop 循环来无侵入地监控 UI 卡顿</strong></p>
<p>首先简单介绍消息机制的设计，如果需要详细的源码分析，可以看之前的文章 <a href="https://juejin.cn/post/6876710885801492487" target="_blank" title="https://juejin.cn/post/6876710885801492487">传送门</a></p>
<h2 data-id="heading-1">原理</h2>
<p>Android 的消息机制本质上是一个生产者-消费者模型</p>
<ul>
<li><code>Handler</code>: 消息的生产者（发送）与最终消费者（处理）</li>
<li><code>MessageQueue</code>: 消息队列（缓冲区），内部使用单链表结构维护消息，按执行时间排序。</li>
<li><code>Looper</code>: 动力泵，不断从 <code>MessageQueue</code> 中抽取消息。</li>
<li><code>Message</code>: 载体，持有数据和处理它的 <code>Handler</code> (target)。</li>
</ul>
<h3 data-id="heading-2">核心类图</h3>
<p>为了理清它们之间的持有关系，我们来看一下类图结构：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d5d8c0b34e584d96aa0194a33b77bf1f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYXBpZ2ZseQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764601282&amp;x-signature=yBEMDngZPqbjNirtN6EzzlRmyF0%3D" alt="image.png" loading="lazy"/></p>
<p>说明：</p>
<ul>
<li><code>Looper</code> 也就是整个消息机制的“管家”，它拥有唯一的 <code>MessageQueue</code>。</li>
<li><code>Handler</code> 必须绑定到一个 <code>Looper</code> 上才能工作。</li>
<li><code>Message</code> 内部持有 <code>target</code> (即 <code>Handler</code>)，这样 <code>Looper</code> 取出消息后，知道该把它交给谁去处理。</li>
<li>一个线程只会对应一个 <code>Looper</code> 对象</li>
</ul>
<h3 data-id="heading-3">消息分发时序图</h3>
<p>当我们在子线程调用 <code>handler.sendMessage()</code> 时，整个系统是如何运转的？</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/239ea61d185a47ed8d7e933304989a1f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYXBpZ2ZseQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764601282&amp;x-signature=AxcrYg6jjzVLucrifeHeKtQPIH0%3D" alt="image.png" loading="lazy"/></p>
<p>关键点：</p>
<ul>
<li>入队 (<code>enqueueMessage</code>)：线程安全的将消息插入单链表。</li>
<li>出队 (<code>next</code>)：这是一个阻塞操作。如果队列为空或时间未到，利用 Linux 的 <code>epoll</code> 机制挂起线程，释放 CPU 资源。</li>
<li>分发 (<code>dispatchMessage</code>)：<code>Looper</code> 拿到消息后，直接调用 <code>msg.target</code> (即 <code>Handler</code>) 的方法在当前线程执行。</li>
</ul>
<blockquote>
<p>基础内容结束，接下来开始我们的实战</p>
</blockquote>
<h2 data-id="heading-4">实战</h2>
<p>在性能优化中，监控主线程卡顿（ANR）是重中之重。 通常我们使用 <code>Looper.getMainLooper().setMessageLogging(Printer)</code> 来监控，但这种方式会产生大量的字符串拼接，对性能有微弱影响。</p>
<p>这里介绍一种更底层、更激进的思路：<code>Looper 劫持</code></p>
<h3 data-id="heading-5">核心思路</h3>
<p>Android 主线程本质上就是在一个死循环中运行：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 原生 ActivityThread 逻辑简化</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
    Looper.prepareMainLooper();
    <span class="hljs-comment">// ...</span>
    Looper.loop(); <span class="hljs-comment">// &lt;--- 死循环，这里如果不退出，APP 就在运行中</span>
}
</code></pre>
<p><strong>如果我们向主线程发送一个消息，这个消息的 <code>Runnable</code> 内部也是一个死循环，会发生什么？</strong><br/>
答案是：主线程会被阻塞在这个消息里。</p>
<p>但是，如果我们在我们的死循环里，<strong>手动通过反射去调用 <code>MessageQueue.next()</code> 和 <code>Handler.dispatchMessage()</code>，我们就相当于在主线程原有的 Loop 里面嵌套了一个我们自己的 Loop。</strong></p>
<p>这样，我们既接管了消息分发权（可以轻松计算分发耗时），又没有让主线程瘫痪。</p>
<h3 data-id="heading-6">实现代码</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> android.<span class="hljs-keyword">annotation</span>.SuppressLint
<span class="hljs-keyword">import</span> android.os.Handler
<span class="hljs-keyword">import</span> android.os.Looper
<span class="hljs-keyword">import</span> android.os.Message
<span class="hljs-keyword">import</span> android.os.MessageQueue
<span class="hljs-keyword">import</span> android.util.Log
<span class="hljs-keyword">import</span> java.lang.reflect.Field
<span class="hljs-keyword">import</span> java.lang.reflect.Method

<span class="hljs-keyword">object</span> LooperMonitor {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> TAG = <span class="hljs-string">"LooperMonitor"</span>
    <span class="hljs-comment">// 阈值：超过 100ms 视为卡顿</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> BLOCK_THRESHOLD = <span class="hljs-number">100L</span>

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">startMonitor</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">val</span> mainHandler = Handler(Looper.getMainLooper())

        <span class="hljs-comment">// 向主线程发送一个“毒丸”消息，接管 Loop</span>
        mainHandler.post {
            hijackLooper()
        }
    }

    <span class="hljs-meta">@SuppressLint(<span class="hljs-string">"DiscouragedPrivateApi"</span>)</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">hijackLooper</span><span class="hljs-params">()</span></span> {
        Log.i(TAG, <span class="hljs-string">"Looper Hijack Started!"</span>)

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 1. 反射获取 MessageQueue</span>
            <span class="hljs-keyword">val</span> mainLooper = Looper.getMainLooper()
            <span class="hljs-keyword">val</span> queueField: Field = Looper::<span class="hljs-keyword">class</span>.java.getDeclaredField(<span class="hljs-string">"mQueue"</span>)
            queueField.isAccessible = <span class="hljs-literal">true</span>
            <span class="hljs-keyword">val</span> messageQueue = queueField.<span class="hljs-keyword">get</span>(mainLooper) <span class="hljs-keyword">as</span> MessageQueue

            <span class="hljs-comment">// 2. 反射获取 MessageQueue.next() 方法</span>
            <span class="hljs-keyword">val</span> nextMethod: Method = MessageQueue::<span class="hljs-keyword">class</span>.java.getDeclaredMethod(<span class="hljs-string">"next"</span>)
            nextMethod.isAccessible = <span class="hljs-literal">true</span>

            <span class="hljs-comment">// 3. 反射获取 Message.target 字段 (Handler)</span>
            <span class="hljs-keyword">val</span> targetField: Field = Message::<span class="hljs-keyword">class</span>.java.getDeclaredField(<span class="hljs-string">"target"</span>)
            targetField.isAccessible = <span class="hljs-literal">true</span>

            <span class="hljs-comment">// 4. 反射获取 Message.recycleUnchecked() 方法 (用于回收)</span>
            <span class="hljs-comment">// 注意：不同版本 API recycle 方法名可能不同，这里简化处理，或者直接不手动 recycle 等待系统处理</span>
            <span class="hljs-keyword">val</span> recycleMethod = Message::<span class="hljs-keyword">class</span>.java.getDeclaredMethod(<span class="hljs-string">"recycleUnchecked"</span>)
            recycleMethod.isAccessible = <span class="hljs-literal">true</span>

            <span class="hljs-comment">// 5. 开启我们自己的死循环，代替 Looper.loop()</span>
            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
                <span class="hljs-comment">// 手动调用 next()，这里可能会阻塞，就像原生的 loop() 一样</span>
                <span class="hljs-keyword">val</span> msg = nextMethod.invoke(messageQueue) <span class="hljs-keyword">as</span>? Message ?: <span class="hljs-keyword">return</span>

                <span class="hljs-keyword">val</span> handler = targetField.<span class="hljs-keyword">get</span>(msg) <span class="hljs-keyword">as</span>? Handler

                <span class="hljs-keyword">if</span> (handler == <span class="hljs-literal">null</span>) {
                    <span class="hljs-comment">// 没有 target 的消息通常意味着退出 loop，但在主线程一般不会遇到</span>
                    <span class="hljs-keyword">return</span>
                }

                <span class="hljs-comment">// --- 监控开始 ---</span>
                <span class="hljs-keyword">val</span> startTime = System.currentTimeMillis()

                <span class="hljs-comment">// 执行分发</span>
                handler.dispatchMessage(msg)

                <span class="hljs-comment">// --- 监控结束 ---</span>
                <span class="hljs-keyword">val</span> endTime = System.currentTimeMillis()
                <span class="hljs-keyword">val</span> cost = endTime - startTime

                <span class="hljs-keyword">if</span> (cost &gt; BLOCK_THRESHOLD) {
                    Log.w(TAG, <span class="hljs-string">"UI 卡顿检测: 耗时 <span class="hljs-subst">${cost}</span>ms | Target: <span class="hljs-subst">${handler.javaClass.name}</span>"</span>)
                    <span class="hljs-comment">// 此时可以抓取堆栈信息：Thread.currentThread().stackTrace</span>
                }

                <span class="hljs-comment">// 回收消息 (模拟 Looper.loop 的行为)</span>
                recycleMethod.invoke(msg)
            }
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            Log.e(TAG, <span class="hljs-string">"Hijack failed"</span>, e)
            <span class="hljs-comment">// 如果出错了，最好抛出异常或者恢复现场，否则 App 可能 ANR</span>
        }
    }
}
</code></pre>
<p>正常情况下，我们可以从日志中看到</p>
<pre><code class="hljs language-log" lang="log">2025-11-24 21:43:20.402  7774-7774  LooperMonitor           com.hualee.myapplication             I  Looper Hijack Started!
2025-11-24 21:43:20.511  7774-7774  LooperMonitor           com.hualee.myapplication             W  UI 卡顿检测: 耗时 108ms | Target: android.app.ActivityThread$H
2025-11-24 21:43:20.733  7774-7774  LooperMonitor           com.hualee.myapplication             W  UI 卡顿检测: 耗时 222ms | Target: android.view.Choreographer$FrameHandler

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangChain×Qwen3：高性能RAG系统实战项目]]></title>    <link>https://juejin.cn/post/7576273949178183743</link>    <guid>https://juejin.cn/post/7576273949178183743</guid>    <pubDate>2025-11-24T13:04:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576273949178183743" data-draft-id="7576129509934628883" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LangChain×Qwen3：高性能RAG系统实战项目"/> <meta itemprop="keywords" content="LangChain,LLM,程序员"/> <meta itemprop="datePublished" content="2025-11-24T13:04:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大模型教程"/> <meta itemprop="url" content="https://juejin.cn/user/1145012233707299"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LangChain×Qwen3：高性能RAG系统实战项目
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1145012233707299/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大模型教程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T13:04:04.000Z" title="Mon Nov 24 2025 13:04:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote>
<p>大模型虽然强大，但依然存在两大痛点：</p>
<ul>
<li><strong>幻觉问题</strong>：模型可能在缺乏事实支撑时“编造答案”；</li>
<li><strong>知识断层</strong>：只能依赖训练时的存量知识，无法覆盖最新或垂直领域的信息。</li>
</ul>
<p>这时，<strong>RAG（检索增强生成）</strong> 成为解决方案。它的思路很直接：</p>
<ol>
<li><strong>先检索</strong>→从外部知识库找到相关信息；</li>
<li><strong>再生成</strong>→把检索结果交给大模型回答问题。</li>
</ol>
<p>这种“检索+生成”的组合，不仅能降低幻觉率，还能让模型更快适应新的知识场景。</p>
<p>本期推荐和鲸社区创作者@云逸～分享的LangChain RAG系统实战项目，其完整演示了如何结合<strong>LangChain框架</strong>与<strong>Qwen3模型</strong>，从数据索引到接口服务，搭建出一个可落地的RAG问答系统。</p>
<h2 data-id="heading-0">为什么选择LangChain？</h2>
<p>实现一个RAG系统并不复杂，但要把整个链路从数据加载、向量化、检索、排序到生成打通，过程冗长。<strong>LangChain</strong>的优势就在于它的模块化和生态支持：</p>
<ul>
<li><strong>现成组件</strong>：数据切分、向量数据库、检索器、问答链等开箱即用；</li>
<li><strong>生态丰富</strong>：支持FAISS、Milvus、Pinecone等数据库，也兼容OpenAI、Qwen等Embedding和LLM；</li>
<li><strong>可扩展</strong>：不仅能做RAG，还能扩展到多步推理、工具调用、对话记忆等复杂应用。</li>
</ul>
<p>这意味着开发者可以把更多精力放在业务逻辑和效果优化上，而不是从零造轮子。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4b479330c8442dc9cf3fc2343f2fb8d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764594244&amp;x-signature=%2BJ3tiFsXHr4bGHeXgkSBqRD%2B2qo%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">干货解析：RAG三步走</h2>
<p>在项目中，RAG 的核心流程被拆解为三步，每一步都有清晰的实现：</p>
<h3 data-id="heading-2">构建索引：让文档“能被理解”</h3>
<ul>
<li><strong>项目做法</strong>：加载四大名著等中文古典小说，先切分成合适的片段，再用<strong>Qwen3-Embedding-4B</strong>将其向量化。</li>
<li><strong>价值</strong>：Embedding 把文本变成“语义坐标”，存入<strong>FAISS向量数据库</strong>，让模型能按语义相似度检索，而不是死板的关键词匹配。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc4e77f549204ce59fa1b36c996edd06~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764594244&amp;x-signature=N6CrO0BESML0H66HknHtuCnSC1w%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">检索与精排：找到最相关的信息</h3>
<ul>
<li><strong>项目做法</strong>：当用户提问时，系统会用向量检索召回候选片段，再用<strong>Qwen3-Reranker-4B</strong>对结果精排序。</li>
<li><strong>价值</strong>：粗召回保证覆盖面，精排保证准确性。这一步解决了很多“检索结果不准”的问题，让答案更贴近用户问题。</li>
</ul>
<h3 data-id="heading-4"/>
<h3 data-id="heading-5"/>
<h3 data-id="heading-6">生成回答：大模型“有据可依”</h3>
<ul>
<li><strong>项目做法</strong>：将排序后的上下文与问题一起打包成prompt，交给大模型，通过<strong>LangChain的RetrievalQA模块</strong>生成答案。</li>
<li><strong>价值</strong>：大模型的输出不再是“瞎编”，而是基于检索结果的总结与推理，显著降低幻觉。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67c3718a754f41089d41d9219d908fd8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764594244&amp;x-signature=zaYEOLWCFMv7BW%2FVCz%2F9hwVs1gQ%3D" alt="" loading="lazy"/></p>
<p>通过这三步，项目打通了RAG的完整闭环，形成了一个可实际使用的问答系统。</p>
<h2 data-id="heading-7">项目亮点</h2>
<ul>
<li><strong>Embedding+Reranker组合</strong>：使用<strong>Qwen3-Embedding-4B</strong>做语义检索，<strong>Qwen3-Reranker-4B</strong>精排序，极大提升检索结果的相关性。</li>
<li><strong>全流程打通</strong>：从文档加载、索引构建，到FastAPI服务上线，完整覆盖从研发到应用全过程。</li>
<li><strong>真实调试经验</strong>：项目中记录了显存溢出、类型报错等常见问题及解决方案，贴近一线开发实践。</li>
<li><strong>扩展性强</strong>：项目留出了优化空间，比如更灵活的分块策略、更智能的prompt设计，适合二次开发。</li>
</ul>
<p>💻一键Fork项目：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.heywhale.com%2Fu%2Fbf1ecb" target="_blank" title="https://www.heywhale.com/u/bf1ecb" ref="nofollow noopener noreferrer">www.heywhale.com/u/bf1ecb</a>（复制至浏览器打开）</p>
<h2 data-id="heading-8">学习资源推荐</h2>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[构建Agents框架｜LlamaIndex使用实战之RAG]]></title>    <link>https://juejin.cn/post/7576129509934694419</link>    <guid>https://juejin.cn/post/7576129509934694419</guid>    <pubDate>2025-11-24T13:13:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576129509934694419" data-draft-id="7576273949178200127" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="构建Agents框架｜LlamaIndex使用实战之RAG"/> <meta itemprop="keywords" content="Agent,LLM,程序员"/> <meta itemprop="datePublished" content="2025-11-24T13:13:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大模型教程"/> <meta itemprop="url" content="https://juejin.cn/user/1145012233707299"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            构建Agents框架｜LlamaIndex使用实战之RAG
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1145012233707299/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大模型教程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T13:13:47.000Z" title="Mon Nov 24 2025 13:13:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote>
<h2 data-id="heading-0"><strong>01 前言</strong></h2>
<p>RAG（Retrieval Augmented Generation：检索增强生成）是LlamaIndex的核心功能模块，覆盖了从<strong>数据加载</strong>、<strong>索引构建</strong>到<strong>存储管理及检索</strong>的全流程。其数据连接与加载能力，更是LlamaIndex早期开源阶段的一大亮点。通过连接和检索特定数据片段，RAG不仅有效解决了大语言模型（LLM）面临的上下文长度限制，也保障了私有领域数据的安全。</p>
<h2 data-id="heading-1"><strong>02 RAG介绍</strong></h2>
<p><strong>RAG（Retrieval Augmented Generation：检索增强生成）</strong> 是一种增强大模型上下文来提高大模型回答准确性的有效且重要手段。通过检索特定内容也保障了企业数据的安全。</p>
<p>其流程如下(图来自官方)：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ae194124bdd419f82dc6d9115a5ae94~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764594827&amp;x-signature=YA7X78CwFzk81tpdkEvBJkriiPY%3D" alt="" loading="lazy"/></p>
<p>核心步骤包括：</p>
<ul>
<li>
<p><strong>Loading：</strong></p>
<p>数据加载，通过加载不同的数据源进行数据获取，如数据库、PDF、API接口等等方式，LlamaIndex目前支持上百种数据源的连接。</p>
</li>
<li>
<p><strong>Indexing：</strong></p>
<p>索引构建，包括对加载数据分块、向量化以及元数据提取，向量化通常被用于语义匹配。</p>
</li>
<li>
<p><strong>Storing：</strong></p>
<p>存储，对构建的向量数据和元数据进行存储，避免对源数据进行多次向量化操作。</p>
</li>
<li>
<p><strong>Querying：</strong></p>
<p>检索，根据用户问题对数据进行检索召回，并加入到大模型的上下文中。常见检索的方式包括向量化语义检索同时伴有元数据过滤、全文关键词检索、混合检索并应用重排序等。</p>
</li>
<li>
<p><strong>Evaluating：</strong> 评估效果，RAG的效果评估是对结果的检验，也是进行优化索引和检索的依据。</p>
</li>
</ul>
<h2 data-id="heading-2"><strong>03 LlamaIndex的RAG实战</strong></h2>
<p><strong>数据加载</strong></p>
<p>LlamaIndex提供了上百种连接数据的方式，包括：<strong>本地文件加载</strong>、<strong>集成连接器</strong>（可以通过llamahub搜索）、<strong>通过文本创建Document</strong>。加载后的数据都统一转换成Document类对象。</p>
<p><strong>1、本地文件加载</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> llama_index.core <span class="hljs-keyword">import</span> SimpleDirectoryReader
documents = SimpleDirectoryReader(<span class="hljs-string">"../data"</span>).load_data()
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"document length:<span class="hljs-subst">{<span class="hljs-built_in">len</span>(documents)}</span>, document:<span class="hljs-subst">{documents}</span>"</span>)
</code></pre>
<p>LlamaIndex中定义了SimpleDirectoryReader类，是内置的最简单的方式，对本地文件进行加载。示例中会加载当前目录的上级data目录下所有文件。</p>
<p><strong>2、集成连接器</strong></p>
<p>以DB为例，通过连接DB，执行Sql查询的每一条数据都是一个Document。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># pip3 install llama-index-readers-database</span>
from llama_index.readers.database import DatabaseReader
<span class="hljs-comment"># 使用PyMySQL：pip3 install pymysql</span>
<span class="hljs-comment"># {root}换成密码</span>
<span class="hljs-attr">reader_media</span> = DatabaseReader(
<span class="hljs-attr">uri</span>=<span class="hljs-string">"mysql+pymysql://root:{root}@localhost:3306/demo"</span>,
<span class="hljs-attr">schema</span>=<span class="hljs-string">"demo"</span>,  <span class="hljs-comment"># optional namespace</span>
)
<span class="hljs-comment"># 加载</span>
<span class="hljs-attr">docs</span> = reader_media.load_data(
<span class="hljs-attr">query</span>=<span class="hljs-string">"SELECT id,username,age,sex,register_time,address FROM xudj.user;"</span>,
<span class="hljs-comment"># 元数据列</span>
<span class="hljs-attr">metadata_cols</span>=[
(<span class="hljs-string">"id"</span>, <span class="hljs-string">"user_id"</span>), <span class="hljs-comment"># 参数转换，用user_id替代id存储</span>
<span class="hljs-string">"username"</span>,
],  <span class="hljs-comment"># map / include in metadata</span>
<span class="hljs-attr">excluded_text_cols</span>=[<span class="hljs-string">"address"</span>],  <span class="hljs-comment"># 剔除字段</span>
<span class="hljs-attr">document_id</span>=lambda row: f<span class="hljs-string">"xudj-user-{row['id']}"</span>,  <span class="hljs-comment"># custom document id</span>
)
print(docs)
</code></pre>
<p>示例首先导入数据库相关依赖，这里使用的是Mysql，可以通过llamahub.ai/?tab=readers搜索使用方式，然后定义DatabaseReader配置连接信息，再调用load_data执行sql完成数据加载。</p>
<p><strong>3、通过文本创建Document</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> llama_index.core <span class="hljs-keyword">import</span> Document
doc = Document(doc_id=<span class="hljs-string">"1"</span>, text=<span class="hljs-string">"文本创建"</span>, metadata={<span class="hljs-string">"id"</span>:<span class="hljs-string">"1"</span>, <span class="hljs-string">"type"</span>:<span class="hljs-string">"custom"</span>})
<span class="hljs-built_in">print</span>(doc)
<span class="hljs-built_in">print</span>(doc.metadata)
</code></pre>
<p>有了文本，这是最直接的方式。</p>
<p><strong>索引构建</strong></p>
<p>数据加载后，有了一系列的Document，便可以进行<strong>索引的构建</strong>。包括长文本按特定规则分块、提取元数据、向量化处理。</p>
<pre><code class="hljs language-ini" lang="ini">from llama_index.core.node_parser import TokenTextSplitter
from llama_index.core import VectorStoreIndex
from llama_index.core import Settings
from llama_index.embeddings.dashscope import DashScopeEmbedding
from llama_index.core import StorageContext
<span class="hljs-comment"># pip install chromadb</span>
<span class="hljs-comment"># pip install llama-index-vector-stores-chroma</span>
import chromadb
from llama_index.vector_stores.chroma import ChromaVectorStore
<span class="hljs-comment"># 1、分块 - chunk_size每块的token数</span>
<span class="hljs-attr">text_splitter</span> = TokenTextSplitter(chunk_size=<span class="hljs-number">200</span>, chunk_overlap=<span class="hljs-number">5</span>)
<span class="hljs-comment"># 2、向量化模型，使用千问的模型</span>
<span class="hljs-attr">dashscope_embed_model</span> = DashScopeEmbedding(
<span class="hljs-attr">model_name</span>=<span class="hljs-string">"text-embedding-v2"</span>,
<span class="hljs-attr">api_key</span>=<span class="hljs-string">"sk-..."</span>)
<span class="hljs-comment"># 向量化存储，默认使用基于内存的SimpleVectorStore类</span>
<span class="hljs-comment"># 初始化客户端，设置保存数据的路径</span>
<span class="hljs-attr">db</span> = chromadb.PersistentClient(path=<span class="hljs-string">"./chroma_db"</span>)
<span class="hljs-comment"># 3、创建向量存储上下文</span>
<span class="hljs-attr">chroma_collection</span> = db.get_or_create_collection(<span class="hljs-string">"quickstart"</span>)
<span class="hljs-attr">vector_store</span> = ChromaVectorStore(chroma_collection=chroma_collection)
<span class="hljs-attr">storage_context</span> = StorageContext.from_defaults(vector_store=vector_store)
<span class="hljs-comment"># 4、创建index</span>
<span class="hljs-attr">index</span> = VectorStoreIndex.from_documents(
<span class="hljs-attr">documents</span>=documents,
<span class="hljs-attr">transformations</span>=[text_splitter],
<span class="hljs-attr">embed_model</span>=dashscope_embed_model,
<span class="hljs-attr">insert_batch_size</span>=<span class="hljs-number">5</span>,  <span class="hljs-comment"># 限制每次插入的节点数量</span>
<span class="hljs-attr">storage_context</span>=storage_context,
)
</code></pre>
<p>示例包括4部分（下面序号对应代码注释序号）：</p>
<p>1、首先定义了<strong>分块逻辑</strong>，示例使用Token计数的分块方式，默认是按完整句子拆分的SentenceSplitter类，它们都属于NodeParser的子类，用于将Document拆分成Node（Node表示Document的一个分块“chunk”，可以是文本或图片等）；在LlamaIndex中，不管是分块XxxSplitter类、提取元数据XxxExtractor类（示例未体现）、向量化Node数据XxxEmbedding类，它们都属于transformations，在解析Document时，可以指定多个，transformations是一个列表。</p>
<p>2、定义<strong>向量化模型</strong>为千问的text-embedding-v2，LlamaIndex默认使用的OpenAI的text-embedding-ada-002模型，这和框架的起源有关，一开始就是为了解决OpenAI系列模型相关问题。</p>
<p>3、创建<strong>向量化存储库</strong>，示例使用的是开源向量库chroma，指定存储目录和集合名。</p>
<p>4、定义<strong>Index（由Document组成的数据结构）</strong> ，并指定文档Documents、转换列表transformations、向量化模型及每批次数量、向量化存储库。VectorStoreIndex是LlamaIndex中最常见的索引类型，通过将Document拆分成Node，然后进行向量化每个Node，为后续语义检索做准备。</p>
<p>示例代码中定义的所有组件，在LlamaIndex中都有默认的实现，我们可以通过Settings查询，同时也可以通过Settings进行设置默认值，如下所示：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> llama_index.core <span class="hljs-keyword">import</span> Settings
<span class="hljs-keyword">import</span> os
<span class="hljs-comment"># 随便设置值，不然会报错找不到apiKey</span>
os.environ[<span class="hljs-string">"OPENAI_API_KEY"</span>] = <span class="hljs-string">"sk-..."</span>
<span class="hljs-comment"># 默认使用OpenAI的text-embedding-ada-002模型</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"Settings.embed_model :<span class="hljs-subst">{Settings.embed_model}</span>"</span>)
<span class="hljs-comment"># 默认使用的SentenceSplitter，这三个取得都是相同的默认node_parser</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"Settings.transformations :<span class="hljs-subst">{Settings.transformations}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"Settings.text_splitter :<span class="hljs-subst">{Settings.text_splitter}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"Settings.node_parser :<span class="hljs-subst">{Settings.node_parser}</span>"</span>)
<span class="hljs-comment"># global可以通过这种方式设置</span>
<span class="hljs-comment"># Settings.text_splitter = text_splitter</span>
</code></pre>
<p>上面我们已经把数据进行了向量化存储，如果想要基于存储的向量数据构建Index索引，可以使用如下方式，不用再次经过一遍上面的流程处理数据了：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 从向量库中创建index，指定向量库和模型</span>
<span class="hljs-attr">index</span> = VectorStoreIndex.from_vector_store(
<span class="hljs-attr">vector_store</span>=vector_store,
<span class="hljs-attr">embed_model</span>=dashscope_embed_model,
)
</code></pre>
<p>1、有关Document和Node介绍：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.llamaindex.ai%2Fpython%2Fframework%2Fmodule" target="_blank" title="https://developers.llamaindex.ai/python/framework/module" ref="nofollow noopener noreferrer">developers.llamaindex.ai/python/fram…</a>_guides/loading/documents_and_nodes/</p>
<p>类定义见：llama_index.core.schema</p>
<p>2、chroma开源向量库：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fchroma-core%2Fchroma" target="_blank" title="https://github.com/chroma-core/chroma" ref="nofollow noopener noreferrer">github.com/chroma-core…</a></p>
<p>3、Index不同的索引类型和检索介绍：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.llamaindex.ai%2Fpython%2Fframework%2Fmodule" target="_blank" title="https://developers.llamaindex.ai/python/framework/module" ref="nofollow noopener noreferrer">developers.llamaindex.ai/python/fram…</a>_guides/indexing/index_guide/#vector-store-index</p>
<p><strong>检索查询</strong></p>
<p>有了数据也进行了向量化存储，并得到了Index索引对象，现在就可以进行检索并加入大模型上下文，回答问题。LlamaIndex的检索查询包括三步骤：<strong>检索Node -&gt; 后置处理过滤Node -&gt; 响应合成</strong></p>
<p><strong>1、仅检索</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 上文得到的index索引对象</span>
<span class="hljs-attr">retriever</span> = index.as_retriever()
<span class="hljs-attr">nodes</span> = retriever.retrieve(<span class="hljs-string">"育儿方式"</span>)
print(f"len:{len(nodes)} nodes:{nodes<span class="hljs-section">[0]</span>.text}")
<span class="hljs-comment"># 另一种方式：直接定义VectorIndexRetriever，指定index</span>
<span class="hljs-attr">retriever</span> = VectorIndexRetriever(
<span class="hljs-attr">index</span>=index,
<span class="hljs-attr">similarity_top_k</span>=<span class="hljs-number">1</span>, <span class="hljs-comment"># 召回一条数据</span>
)
<span class="hljs-attr">nodes</span> = retriever.retrieve(<span class="hljs-string">"育儿方式"</span>)
print(f"len:{len(nodes)} nodes:{nodes<span class="hljs-section">[0]</span>.text}")
</code></pre>
<p>示例使用index的as_retriever()方法得到VectorIndexRetriever，然后调用retrieve方法来检索node列表。直接定义VectorIndexRetriever效果一样。</p>
<p><strong>2、后置处理过滤Node</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 导入postprocessor</span>
from llama_index.core.postprocessor import KeywordNodePostprocessor, SimilarityPostprocessor
<span class="hljs-attr">node_postprocessors</span>=[
<span class="hljs-comment"># 相似性</span>
SimilarityPostprocessor(
similarity_cut<span class="hljs-literal">off</span>=<span class="hljs-number">0.1</span>
)
]
<span class="hljs-attr">query</span> = index.as_query_engine(llm=llm,
<span class="hljs-attr">node_postprocessors</span>=node_postprocessors)
</code></pre>
<p>示例使用了相似性分数过滤Node，过滤后把更少的Node信息作为上下文传递给大模型，减少大模型的Token数量以及降低响应时间。更多后置处理器见下面地址。</p>
<p><strong>3、响应合成-检索后发起大模型对话</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 查询</span>
from llama_index.llms.deepseek import DeepSeek
<span class="hljs-attr">llm</span> = DeepSeek(model=<span class="hljs-string">"deepseek-chat"</span>,
<span class="hljs-attr">api_key</span>=<span class="hljs-string">"sk-..."</span>)
from llama_index.core.response_synthesizers import ResponseMode
from llama_index.core import get_response_synthesizer
<span class="hljs-comment"># 定义响应合成逻辑，默认是ResponseMode.COMPACT</span>
<span class="hljs-comment"># "compact": 合并Node作为上下文，如果超长，则使用refine提炼，减少模型的请求次数，最终借助生成一个答案</span>
<span class="hljs-attr">response_synthesizer</span> = get_response_synthesizer(
<span class="hljs-attr">response_mode</span>=ResponseMode.COMPACT
)
<span class="hljs-attr">query</span> = index.as_query_engine(llm=llm,
<span class="hljs-attr">response_synthesizer</span>=response_synthesizer)
print(query.query("育儿方式?"))
</code></pre>
<p>示例通过使用index的as_query_engine()方法得到query引擎，并指定<strong>响应合成模式“compact”</strong> ，这个也是默认模式，含义见上代码注释，最后调用query方法借助LLM生成答案。</p>
<p>as_query_engine会获取无状态的查询引擎，另有as_chat_engine支持多轮对话的有状态查询引擎。</p>
<p>compact是其中一种合成模式，让ChatGPT基于官方文档生成的不同模式的对照表，供参考：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/abd1ca0052d54e9f9202e00fd43a1656~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764594827&amp;x-signature=DQoMaN4UKokHtYEFusbwRAVvUv8%3D" alt="" loading="lazy"/></p>
<p>为什么会有不同的响应合成模式呢？</p>
<p>是因为 RAG 里拿到的文档往往是多个 chunk，而 LLM 的 prompt 有长度限制。</p>
<p>所以 LlamaIndex 提供了多种“怎样合成答案”的策略。</p>
<p>不同的后置过滤器：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.llamaindex.ai%2Fpython%2Fframework%2Fmodule" target="_blank" title="https://developers.llamaindex.ai/python/framework/module" ref="nofollow noopener noreferrer">developers.llamaindex.ai/python/fram…</a>_guides/querying/node_postprocessors/node_postprocessors/</p>
<p>不同响应合成模式：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.llamaindex.ai%2Fpython%2Fframework%2Fmodule" target="_blank" title="https://developers.llamaindex.ai/python/framework/module" ref="nofollow noopener noreferrer">developers.llamaindex.ai/python/fram…</a>_guides/querying/response_synthesizers/</p>
<p>及对应代码类型定义：llama_index.core.response_synthesizers.type.ResponseMode</p>
<h2 data-id="heading-3"><strong>04 总结</strong></h2>
<p>从整体来看，LlamaIndex 已经构建出一个覆盖 <strong>数据接入 → 文本解析 → 向量化与存储 → 检索策略 → 响应生成</strong> 的完整 RAG 技术栈，提供了高度模块化、可自由组合的能力。</p>
<p>本文展示的示例仅是 LlamaIndex 功能体系中的一小部分。更多丰富的索引类型、检索模式、数据连接器，以及企业级场景的模板与实践，可以在官方文档或 LlamaHub 中学习和阅读。</p>
<p>值得一提的是，除了 RAG 相关组件外，<strong>LlamaIndex 还提供了 基于事件驱动的 Workflow 工作流 与 Agent 智能体 能力</strong>，能够进一步支持复杂任务编排、多模型协作等更高级的应用模式。这些在后续文章中逐一展开。</p>
<h3 data-id="heading-4">学习资源推荐</h3>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【HarmonyOS 6】UIAbility跨设备连接详解（分布式软总线运用）]]></title>    <link>https://juejin.cn/post/7575897635138011136</link>    <guid>https://juejin.cn/post/7575897635138011136</guid>    <pubDate>2025-11-24T13:31:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575897635138011136" data-draft-id="7576105458807439360" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【HarmonyOS 6】UIAbility跨设备连接详解（分布式软总线运用）"/> <meta itemprop="keywords" content="HarmonyOS"/> <meta itemprop="datePublished" content="2025-11-24T13:31:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="GeorgePanda"/> <meta itemprop="url" content="https://juejin.cn/user/1239904847930654"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【HarmonyOS 6】UIAbility跨设备连接详解（分布式软总线运用）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1239904847930654/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    GeorgePanda
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T13:31:50.000Z" title="Mon Nov 24 2025 13:31:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">【HarmonyOS 6】UIAbility跨设备连接详解（分布式软总线运用）</h2>
<h3 data-id="heading-1">一、前言</h3>
<p>我对于分布式软总线相当的亲切。2022年搞开源鸿蒙的时候，就经常和分布式软总线打交道。在HarmonyOS中，UIAbility跨设备连接，其实就是对底层开源鸿蒙，分布式软总线的能力封装。</p>
<h3 data-id="heading-2">二、首先理解跨设备链接的步骤</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae6115adcf884c769cd876808f415ba7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR2VvcmdlUGFuZGE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764595910&amp;x-signature=knzdpWi8hSG3jKBXJGwjFCkYMLg%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>首先由Distributed Service Kit提供该能力的封装。</p>
<p>在进行跨设备链接之前，我们要对设备进行互信操作。这个在鸿蒙里叫做分布式设备管理，包含了设备的发现，配对，可信查询，解除配对等。<strong>详情可参见我之前写的文章：【HarmonyOS 5】鸿蒙分布式协同应用开发详解</strong></p>
<p>进行完上面的可信操作，我们才能对于设备间的链接通信做处理。</p>
<h3 data-id="heading-3">三、专有名词理解：</h3>
<p><strong>DMS（Distributedsched Management Service）：</strong>
分布式组件管理框架，相当于跨设备协同的“中间人”，负责管理组件和建立连接</p>
<p><strong>UIAbility：</strong>
应用的界面交互核心，管生命周期、用户交互和界面渲染，跨设备协同本质就是两台设备的UIAbility在“对话”</p>
<h3 data-id="heading-4">四、环境准备步骤</h3>
<p>工欲善其事，先把环境搭好：
1、硬件：两台能登录华为账号的设备（A和B），需要支持API 18
2、开发工具：DevEco Studio 4.1及以上，public-SDK更新到API 18+
3、设备连接：用USB线把两台设备连到PC，打开蓝牙让设备互相识别组网
4、验证组网：PC端执行shell命令，显示“remote device num = 1”就是组网成功</p>
<pre><code class="hljs language-shell" lang="shell">hdc shell
hidumper -s 4700 -a "buscenter -l remote_device_info"
</code></pre>
<p>也可通过前置步骤的分布式设备管理，来验证设备的可信。</p>
<h3 data-id="heading-5">五、源码步骤拆解：</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/659948c1277d49d184925e22797b4aa6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR2VvcmdlUGFuZGE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764595910&amp;x-signature=CEhr7hgvAzsnGruuJAoPTdtpBvI%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h4 data-id="heading-6">1、 导入核心模块</h4>
<p>首先要导入分布式服务相关的Kit，不管是发起端还是接收端都需要：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { abilityConnectionManager, distributedDeviceManager } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.DistributedServiceKit'</span>;
<span class="hljs-keyword">import</span> { common, <span class="hljs-title class_">AbilityConstant</span>, <span class="hljs-title class_">UIAbility</span>, <span class="hljs-title class_">Want</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;
<span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;
</code></pre>
<h4 data-id="heading-7">2、 发现目标设备（设备A侧）</h4>
<p>设备A要先找到设备B的networkId，作为连接的关键参数：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">let</span> <span class="hljs-attr">dmClass</span>: distributedDeviceManager.<span class="hljs-property">DeviceManager</span>;

<span class="hljs-comment">// 初始化设备管理实例</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">initDmClass</span>(<span class="hljs-params"/>): <span class="hljs-built_in">void</span> {
  <span class="hljs-keyword">try</span> {
    dmClass = distributedDeviceManager.<span class="hljs-title function_">createDeviceManager</span>(<span class="hljs-string">'com.example.remotephotodemo'</span>);
  } <span class="hljs-keyword">catch</span> (err) {
    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'创建设备管理实例失败: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err));
  }
}

<span class="hljs-comment">// 获取设备B的networkId</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getRemoteDeviceId</span>(<span class="hljs-params"/>): <span class="hljs-built_in">string</span> | <span class="hljs-literal">undefined</span> {
  <span class="hljs-title function_">initDmClass</span>();
  <span class="hljs-keyword">if</span> (!dmClass) <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;
  
  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'开始查找远程设备'</span>);
  <span class="hljs-keyword">const</span> deviceList = dmClass.<span class="hljs-title function_">getAvailableDeviceListSync</span>();
  
  <span class="hljs-keyword">if</span> (!deviceList || deviceList.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'未找到可用设备'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;
  }
  
  <span class="hljs-comment">// 这里取第一个设备，实际开发可做设备选择列表</span>
  <span class="hljs-keyword">return</span> deviceList[<span class="hljs-number">0</span>].<span class="hljs-property">networkId</span>;
}
</code></pre>
<h4 data-id="heading-8">3、创建会话并连接（两端操作不同）</h4>
<h5 data-id="heading-9">设备A（发起端）：创建会话+发起连接</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@StorageLink</span>(<span class="hljs-string">'sessionId'</span>) <span class="hljs-attr">sessionId</span>: <span class="hljs-built_in">number</span> = -<span class="hljs-number">1</span>;

<span class="hljs-comment">// 配置设备B的协同信息</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">peerInfo</span>: abilityConnectionManager.<span class="hljs-property">PeerInfo</span> = {
  <span class="hljs-attr">deviceId</span>: <span class="hljs-title function_">getRemoteDeviceId</span>()!, <span class="hljs-comment">// 设备B的networkId</span>
  <span class="hljs-attr">bundleName</span>: <span class="hljs-string">'com.example.remotephotodemo'</span>, <span class="hljs-comment">// 必须和设备B应用一致</span>
  <span class="hljs-attr">moduleName</span>: <span class="hljs-string">'entry'</span>,
  <span class="hljs-attr">abilityName</span>: <span class="hljs-string">'EntryAbility'</span>,
  <span class="hljs-attr">serviceName</span>: <span class="hljs-string">'collabTest'</span> <span class="hljs-comment">// 自定义服务名，两端要一致</span>
};

<span class="hljs-comment">// 连接配置</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">connectOptions</span>: abilityConnectionManager.<span class="hljs-property">ConnectOptions</span> = {
  <span class="hljs-attr">needSendData</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">startOptions</span>: abilityConnectionManager.<span class="hljs-property">StartOptionParams</span>.<span class="hljs-property">START_IN_FOREGROUND</span>,
  <span class="hljs-attr">parameters</span>: { <span class="hljs-string">"newKey1"</span>: <span class="hljs-string">"value1"</span> }
};

<span class="hljs-comment">// 发起连接</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">connectRemoteAbility</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> context = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>();
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 创建会话，获取sessionId</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">sessionId</span> = abilityConnectionManager.<span class="hljs-title function_">createAbilityConnectionSession</span>(
      <span class="hljs-string">"collabTest"</span>, 
      context, 
      peerInfo, 
      connectOptions
    );
    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`创建会话成功，sessionId: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.sessionId}</span>`</span>);
    
    <span class="hljs-comment">// 发起连接（会拉起设备B的应用）</span>
    <span class="hljs-keyword">const</span> connectResult = <span class="hljs-keyword">await</span> abilityConnectionManager.<span class="hljs-title function_">connect</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">sessionId</span>);
    <span class="hljs-keyword">if</span> (!connectResult.<span class="hljs-property">isConnected</span>) {
      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'连接失败'</span>);
      <span class="hljs-keyword">return</span>;
    }
    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'连接成功'</span>);
  } <span class="hljs-keyword">catch</span> (error) {
    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`连接异常: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(error)}</span>`</span>);
  }
}
</code></pre>
<h5 data-id="heading-10">设备B（接收端）：被拉起后接受连接</h5>
<p>设备A发起连接后，设备B的应用会被协同拉起，触发<code>onCollaborate</code>生命周期函数：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {
  <span class="hljs-title function_">onCreate</span>(<span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span>, <span class="hljs-attr">launchParam</span>: <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">LaunchParam</span>): <span class="hljs-built_in">void</span> {
    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'应用启动'</span>);
  }

  <span class="hljs-comment">// 协同拉起时触发</span>
  <span class="hljs-title function_">onCollaborate</span>(<span class="hljs-attr">wantParam</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">Object</span>&gt;): <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">CollaborateResult</span> {
    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'收到协同请求'</span>);
    <span class="hljs-keyword">const</span> collabParam = wantParam[<span class="hljs-string">"ohos.extra.param.key.supportCollaborateIndex"</span>] <span class="hljs-keyword">as</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">Object</span>&gt;;
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleCollaborate</span>(collabParam);
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
  }

  <span class="hljs-comment">// 处理协同连接</span>
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">handleCollaborate</span>(<span class="hljs-params">collabParam: Record&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">Object</span>&gt;</span>) {
    <span class="hljs-keyword">const</span> sessionId = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createSessionFromParam</span>(collabParam);
    <span class="hljs-keyword">if</span> (sessionId === -<span class="hljs-number">1</span>) {
      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'会话创建失败'</span>);
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// 获取协同token，必须传入acceptConnect</span>
    <span class="hljs-keyword">const</span> collabToken = collabParam[<span class="hljs-string">"ohos.dms.collabToken"</span>] <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>;
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> abilityConnectionManager.<span class="hljs-title function_">acceptConnect</span>(sessionId, collabToken);
      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'接受连接成功'</span>);
      <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'sessionId'</span>, sessionId);
    } <span class="hljs-keyword">catch</span> (error) {
      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`接受连接失败: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(error)}</span>`</span>);
    }
  }

  <span class="hljs-comment">// 从协同参数创建会话</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">createSessionFromParam</span>(<span class="hljs-attr">collabParam</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">Object</span>&gt;): <span class="hljs-built_in">number</span> {
    <span class="hljs-keyword">let</span> sessionId = -<span class="hljs-number">1</span>;
    <span class="hljs-keyword">const</span> peerInfo = collabParam[<span class="hljs-string">"PeerInfo"</span>] <span class="hljs-keyword">as</span> abilityConnectionManager.<span class="hljs-property">PeerInfo</span>;
    <span class="hljs-keyword">const</span> connectOptions = collabParam[<span class="hljs-string">"ConnectOption"</span>] <span class="hljs-keyword">as</span> abilityConnectionManager.<span class="hljs-property">ConnectOptions</span>;

    <span class="hljs-keyword">if</span> (!peerInfo || !connectOptions) <span class="hljs-keyword">return</span> sessionId;

    <span class="hljs-comment">// 配置数据传输能力</span>
    connectOptions.<span class="hljs-property">needSendData</span> = <span class="hljs-literal">true</span>;
    connectOptions.<span class="hljs-property">needSendStream</span> = <span class="hljs-literal">true</span>;

    <span class="hljs-keyword">try</span> {
      sessionId = abilityConnectionManager.<span class="hljs-title function_">createAbilityConnectionSession</span>(
        <span class="hljs-string">"collabTest"</span>, 
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, 
        peerInfo, 
        connectOptions
      );
    } <span class="hljs-keyword">catch</span> (error) {
      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`创建会话失败: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(error)}</span>`</span>);
    }
    <span class="hljs-keyword">return</span> sessionId;
  }
}
</code></pre>
<h4 data-id="heading-11">4、 注册事件监听（两端都要加）</h4>
<p>连接成功后，通过监听事件获取连接状态和消息：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">registerEventListeners</span>(<span class="hljs-params">sessionId: <span class="hljs-built_in">number</span></span>) {
  <span class="hljs-comment">// 监听连接成功事件</span>
  abilityConnectionManager.<span class="hljs-title function_">on</span>(<span class="hljs-string">"connect"</span>, sessionId, <span class="hljs-function">(<span class="hljs-params">callbackInfo</span>) =&gt;</span> {
    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`会话<span class="hljs-subst">${callbackInfo.sessionId}</span>连接成功`</span>);
  });

  <span class="hljs-comment">// 监听断开连接事件</span>
  abilityConnectionManager.<span class="hljs-title function_">on</span>(<span class="hljs-string">"disconnect"</span>, sessionId, <span class="hljs-function">(<span class="hljs-params">callbackInfo</span>) =&gt;</span> {
    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`会话<span class="hljs-subst">${callbackInfo.sessionId}</span>已断开`</span>);
  });

  <span class="hljs-comment">// 监听接收消息事件</span>
  abilityConnectionManager.<span class="hljs-title function_">on</span>(<span class="hljs-string">"receiveMessage"</span>, sessionId, <span class="hljs-function">(<span class="hljs-params">callbackInfo</span>) =&gt;</span> {
    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`收到消息: <span class="hljs-subst">${callbackInfo.message}</span>, 会话ID: <span class="hljs-subst">${callbackInfo.sessionId}</span>`</span>);
    <span class="hljs-comment">// 这里可以处理业务逻辑，比如更新UI显示消息</span>
  });
}
</code></pre>
<h4 data-id="heading-12">5、 发送消息（两端都可发）</h4>
<p>连接成功后，用<code>sendMessage</code>发送文本信息：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">sendTestMessage</span>(<span class="hljs-params">sessionId: <span class="hljs-built_in">number</span></span>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">await</span> abilityConnectionManager.<span class="hljs-title function_">sendMessage</span>(sessionId, <span class="hljs-string">"这是来自设备A的测试消息"</span>);
    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'消息发送成功'</span>);
  } <span class="hljs-keyword">catch</span> (error) {
    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`消息发送失败: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(error)}</span>`</span>);
  }
}
</code></pre>
<h4 data-id="heading-13">6、 结束协同（关键！避免资源泄露）</h4>
<p>业务完成后一定要断开连接或销毁会话：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">endCollaboration</span>(<span class="hljs-params">sessionId: <span class="hljs-built_in">number</span></span>) {
  <span class="hljs-keyword">if</span> (sessionId === -<span class="hljs-number">1</span>) {
    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'无效的会话ID'</span>);
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-comment">// 短期还需协同：只断开连接，保留sessionId</span>
  abilityConnectionManager.<span class="hljs-title function_">disconnect</span>(sessionId);
  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'已断开连接'</span>);

  <span class="hljs-comment">// 长期不用：销毁会话（自动断开连接）</span>
  abilityConnectionManager.<span class="hljs-title function_">destroyAbilityConnectionSession</span>(sessionId);
  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'已销毁会话'</span>);
}
</code></pre>
<h3 data-id="heading-14">五、注意事项：</h3>
<ol>
<li>仅支持API 18及以上版本，且设备必须登录<strong>相同华为账号</strong></li>
<li>只有<strong>相同bundleName</strong>的UIAbility才能协同（比如都是“com.example.remotephotodemo”）</li>
<li>协同结束后一定要及时关闭，锁屏或退后台5秒未申请长时任务，协同会被系统强制结束</li>
<li>传输隐私数据时，记得加弹框提醒用户（系统不审查传输内容）</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从没写过浏览器插件？我用 TRAE SOLO 2 小时就完成了专属翻译工具]]></title>    <link>https://juejin.cn/post/7576130618904608804</link>    <guid>https://juejin.cn/post/7576130618904608804</guid>    <pubDate>2025-11-24T13:51:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576130618904608804" data-draft-id="7576273949178331199" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从没写过浏览器插件？我用 TRAE SOLO 2 小时就完成了专属翻译工具"/> <meta itemprop="keywords" content="Trae,AI编程,人工智能"/> <meta itemprop="datePublished" content="2025-11-24T13:51:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="飞哥数智谈"/> <meta itemprop="url" content="https://juejin.cn/user/3825956195409223"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从没写过浏览器插件？我用 TRAE SOLO 2 小时就完成了专属翻译工具
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3825956195409223/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    飞哥数智谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T13:51:37.000Z" title="Mon Nov 24 2025 13:51:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>每个程序员估计都有过，把自己常用的软件全部自行实现一遍的想法。</p>
<p>听起来很极客，但实现起来的时间成本太高了。</p>
<p>但现在不一样了——有了 <code>TRAE SOLO</code>，我们只要描述清楚想法，就可以<strong>一站式快速搞定</strong>。我感觉这个事情，可以再试试。</p>
<p>毕竟，一个个完全符合自己偏好的工具，用起来心情都会好上不少。</p>
<p>今天，我们就从<strong>浏览器翻译插件</strong>开始~</p>
<h2 data-id="heading-0">项目背景</h2>
<p>浏览器中翻译应该是非常高频的一个场景，但之前的翻译插件一直都不怎么好用，直到我了解到“沉浸式翻译”插件。</p>
<p>不得不承认，这个插件非常好用，分别在每段原文下方或旁边显示翻译内容，直观，可对照，支持翻译接口和各类AI。</p>
<p>但前阵子的安全事件，让我感觉还是自己鼓捣一个吧。</p>
<h2 data-id="heading-1">名词解释</h2>
<p>因为我之前从未有过浏览器插件开发的经验，因此需要提前了解下相关概念。</p>
<ul>
<li><strong>浏览器插件</strong>：一套基于网页技术（HTML/CSS/JavaScript）+ 浏览器提供的扩展 API 组成的文件集合（最终打包成 .crx/.xpi 等格式），运行在浏览器的 “沙箱环境” 中。</li>
<li><strong>manifest.json</strong>：<strong>重点中的重点</strong>，插件总配置，包括名称、权限、功能模块等。</li>
<li><strong>popup.html</strong>：点击插件图标后弹出的小窗口，本质是一个迷你网页，支持所有 HTML 语法。</li>
<li><strong>content script（可选）</strong>：注入到目标网页中的 JS/CSS，能直接操作网页 DOM（比如修改网页文字、隐藏广告）；</li>
<li><strong>background service worker（可选）</strong>：插件的 “后台服务”，即使 popup 关闭也能运行，用于监听事件或发起请求。</li>
<li><strong>Options</strong>：插件的 “设置面板”，专门用来让用户自定义插件功能的独立页面，比如开关功能、修改参数、保存偏好设置等。</li>
</ul>
<h2 data-id="heading-2">实操记录</h2>
<p>基础概念了解后，我们就可以开始了。</p>
<p>开发软件依然是 <code>TRAE SOLO</code>，本次我们选择了 <code>SOLO Coder</code> 智能体。</p>
<h3 data-id="heading-3">前置准备</h3>
<p>翻译工作，我们直接采用完全免费的 <code>GLM-4.5-Flash</code> 模型。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4555a20a35d94412ac075c16113dde1e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764597189&amp;x-signature=H17sN3Na%2BrNp472T2i5k4P6dKbw%3D" alt="" loading="lazy"/></p>
<p>只需要注册，并创建 <code>API Key</code> 即可。</p>
<p>之前有分享过，这里就不再赘述。</p>
<h3 data-id="heading-4">初版生成</h3>
<p><strong>指令</strong></p>
<p>除了说明我要做什么之外，额外明确了技术栈采用智谱API，并给出官方文档中 cURL 的代码示例。</p>
<pre><code class="hljs language-vbnet" lang="vbnet">我要实现一个chrome 浏览器插件，主要实现网站页面上选中内容的翻译，翻译结果通过浮动弹窗显示在选中内容上方。

翻译接口采用智谱大模型api，glm-<span class="hljs-number">4.5</span>-flash。
curl示例如下：
curl -X POST <span class="hljs-string">" https://open.bigmodel.cn/api/paas/v4/chat/completions "</span> \
-H <span class="hljs-string">"Content-Type: application/json"</span> \
-H <span class="hljs-string">"Authorization: Bearer &lt;你的 API Key&gt; "</span> \
-d <span class="hljs-comment">'{</span>
<span class="hljs-string">"model"</span>: <span class="hljs-string">"glm-4.5"</span>,
<span class="hljs-string">"messages"</span>: [
{
<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
<span class="hljs-string">"content"</span>: <span class="hljs-string">"作为一名营销专家，请为我的产品创作一个吸引人的口号"</span>
},
{
<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>,
<span class="hljs-string">"content"</span>: <span class="hljs-string">"当然，要创作一个吸引人的口号，请告诉我一些关于您产品的信息"</span>
},
{
<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
<span class="hljs-string">"content"</span>: <span class="hljs-string">"智谱AI 开放平台"</span>
}
],
<span class="hljs-string">"thinking"</span>: {
<span class="hljs-string">"type"</span>: <span class="hljs-string">"enabled"</span>
},
<span class="hljs-string">"max_tokens"</span>: <span class="hljs-number">4096</span>,
<span class="hljs-string">"temperature"</span>: <span class="hljs-number">0.6</span>
}<span class="hljs-comment">'</span>
</code></pre>
<p><strong>过程</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0df21a2164a4466b9e0ba5563eb94de7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764597189&amp;x-signature=OufMdwOVmBt1uVwEHPC9h3%2FaKoA%3D" alt="" loading="lazy"/></p>
<p>先是照常生成文档。</p>
<p>不得不再次感叹，这个文档内容是真的详细。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/094a3f220c02472f95d3c66d0e0adc2e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764597189&amp;x-signature=yUAdohk%2BJ6KENXxjlZ6ekW3Gj9E%3D" alt="" loading="lazy"/></p>
<p>并且，还非常靠谱的帮我设计了 API Key 的安全存储方案。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6adca9127d2347b0a239937a6e59ea99~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764597189&amp;x-signature=KszJlrxH5zQCwuQF2QKQ5XuLdu4%3D" alt="" loading="lazy"/></p>
<p>毕竟，我一个浏览器插件小白，它要不告诉我，我还真不知道有个 <code>Options</code> 可以快速设置。</p>
<p>再然后，给出了相关的参考链接，方便我们了解核对。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7264464dba2748b78c4ec738c7730eec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764597189&amp;x-signature=99TKeM3bzZ1SwsPZmgLfLauVP1c%3D" alt="" loading="lazy"/></p>
<p>确认文档后，<code>SOLO</code> 就直接按计划生成了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea40031c559f44eba3522747977350ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764597189&amp;x-signature=amymafqW9QhftXANyL%2FyKktFJ4E%3D" alt="" loading="lazy"/></p>
<p><strong>结果</strong></p>
<p>之前使用自己熟悉的技术栈的时候，执行总结一般都是很快扫完的。</p>
<p>今天，上手一个新的领域才发现，<code>SOLO</code> 给出的总结也非常详细。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34279d6119a5480fafd5360469658277~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764597189&amp;x-signature=pbZHv7J7OwhMDZi8Ap8PGQivScA%3D" alt="" loading="lazy"/></p>
<p>最主要的是接下来我需要如何调试，也帮我指明了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0e507336e864665b915e7844d0e3420~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764597189&amp;x-signature=KpBMRzElk3131%2Bbz5%2Fc%2Bkk9Lg3M%3D" alt="" loading="lazy"/></p>
<p>此时生成代码结构如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/706aeac3451b49928a6e7f5a2d6ec46a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764597189&amp;x-signature=189f1GxRpLtf%2BO6KJ1GUDWqLOFQ%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">本地调试</h3>
<p>代码已经生成完了，下面我们按照前面 <code>SOLO</code> 给出的步骤，一步步操作即可。</p>
<p><strong>第一步</strong>，打开 <code>Chrome</code>，地址栏输入：<code>chrome://extensions/</code>，你可以通过插件管理菜单进入。</p>
<p>然后按照下图的箭头指示操作。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c9a2c615e95470fbe908f12815e43e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764597189&amp;x-signature=l1ljIDiXbRZqCKwHQIkbZc38wzk%3D" alt="" loading="lazy"/></p>
<ol>
<li>右上角“Developer mode”，打开开发者模式；</li>
<li>左侧“Load unpacked”，选择项目跟路径，如果没有错误，插件会显示在图中位置。</li>
</ol>
<p><strong>第二步</strong>，打开<code>Options</code>界面。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a7316bd059e4cd4b4bcb0b2e2a33593~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764597189&amp;x-signature=elvjzxdXVHqqZgY5yseuOrphDNg%3D" alt="" loading="lazy"/></p>
<p>设置 <code>API Key</code>，请忽略设置页面的简陋。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90daf4c3423a491c94d4ca2ebaa7c5b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764597189&amp;x-signature=J1itowaPRg%2BcU8EDR4hS1SetHT0%3D" alt="" loading="lazy"/></p>
<p><strong>第三步</strong>，在英文网站中选择内容。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b7f8a9d267645999215cf10b85fd43d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764597189&amp;x-signature=3Y%2BATqbNyFUvb8n49DgSTOgPGbM%3D" alt="" loading="lazy"/></p>
<p>点击“翻译”，查看效果。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc522558902040d0854030abbd45225c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764597189&amp;x-signature=3VqagQDgEt%2FeCycLxHSpvEIysLM%3D" alt="" loading="lazy"/></p>
<p>哦耶，直接成功！</p>
<blockquote>
<p>如果有跟练的，测试链接：<a href="https://docs.trae.ai/ide/what-is-trae?_lang=en" target="_blank" title="https://docs.trae.ai/ide/what-is-trae?_lang=en" ref="nofollow noopener noreferrer">docs.trae.ai/ide/what-is…</a></p>
</blockquote>
<h3 data-id="heading-6">界面优化</h3>
<p>上面已经实现了翻译效果，但是界面有点难受。</p>
<p>没有有效利用屏幕宽度，并且还遮挡了选中的内容。</p>
<p>不用急，我们再追加一次对话，依然是 <code>SOLO Coder</code> 智能体。</p>
<p><strong>指令</strong></p>
<pre><code class="hljs">浮窗宽度和选中文字同宽；
浮窗定位应该在选中文字整体的下方，不要遮挡选中文字；
点击关闭后，应该清空翻译结果，并可再次进行下次翻译。
</code></pre>
<p><strong>过程</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/17e5916f114947c090153b36d9364f8e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764597189&amp;x-signature=oay4OCVkNzmePECkqHS4WbY6Kek%3D" alt="" loading="lazy"/></p>
<p><strong>效果</strong></p>
<p>再次打开插件管理页面，删除“Remove”原有版本的插件，重新“Load unpacked”，再次测试。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/53fdd00dd15b4ac6b9528a7fc4259b2c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764597189&amp;x-signature=IybYoTyQTpmzm%2FVQI%2FHLs6MjHlg%3D" alt="" loading="lazy"/></p>
<p>理解非常到位，效果也很完美，收工。</p>
<h2 data-id="heading-7">实践体会</h2>
<p>今天实现这个插件，一共花费了 1 小时 40 分钟左右，这还包含了采用 <code>SOLO Builder</code> 智能体未成功的时间。</p>
<h3 data-id="heading-8">Builder 和 Coder 的挑选</h3>
<p><code>SOLO Builder</code> 适合前端应用，所以，我首选的就是它，但效果不佳。</p>
<p>我修复了3次之后，才能运行，并且效果还不是很好。</p>
<p>于是，我果断清空代码，重新开始，并更换了 <code>SOLO Coder</code>。</p>
<p>如上所示，一次过，这才像 <code>SOLO</code> 嘛。</p>
<p>小体会：<strong>一定要根据任务选择合适的模型或者智能体，也许可以事半功倍哦。</strong></p>
<h3 data-id="heading-9">使用AI返回的名词</h3>
<p>“界面优化”的对话中，我没有使用“初版生成”提示词中的“浮动弹窗”，而是使用了 AI 生成的文档中的“浮窗”。</p>
<p>这是一个实践的小技巧，<strong>尽量使用 AI 返回的名词，这样，它对你的指令理解会更加到位</strong>。</p>
<h3 data-id="heading-10">外部API调用使用示例代码</h3>
<p>我们在开发应用的过程中，会碰到很多需要调用外部 API 的情况。</p>
<p>我们可以把 API 文档给到 AI，但我更喜欢直接<strong>把官网的样例代码给到 AI</strong>。</p>
<p>毕竟，自然语言容易存在歧义，代码很少有歧义的。</p>
<h2 data-id="heading-11">结语</h2>
<p>今天，我们从0开始，实现了一个浏览器插件的开发，大家可以根据需要自行尝试。</p>
<p>有了 <code>SOLO</code>，实现这些小工具，真的又快又省心。</p>
<p>不过，这个插件目前还仅仅是初版，接下来，我会把更多好用的特性加进去，希望可以真正用起来。</p>
<p>也欢迎大家关注后续分享。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[关键信息基础设施的数据库选型：高可用、全链路安全与平滑替代的技术实践]]></title>    <link>https://juejin.cn/post/7576223441683890239</link>    <guid>https://juejin.cn/post/7576223441683890239</guid>    <pubDate>2025-11-24T12:24:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576223441683890239" data-draft-id="7576223441683857471" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="关键信息基础设施的数据库选型：高可用、全链路安全与平滑替代的技术实践"/> <meta itemprop="keywords" content="数据库"/> <meta itemprop="datePublished" content="2025-11-24T12:24:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="倔强的石头_"/> <meta itemprop="url" content="https://juejin.cn/user/3168119757484368"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            关键信息基础设施的数据库选型：高可用、全链路安全与平滑替代的技术实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3168119757484368/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    倔强的石头_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T12:24:59.000Z" title="Mon Nov 24 2025 12:24:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>论及央企国企的数字化转型时，数据库便是那块犹如定海神针一般的“压舱石”，其要求十分简单，即稳固，安全且可被控制，绝不能出现半点差错。金仓数据库（KingbaseES，又称KES）属于数据库领域的“国家队”，其早已非新手，已在能源，电力，金融，交通等关键行业扎根，始终支撑着核心业务的稳定运行，助力国产化进程稳步前行，此篇文章不过分虚夸，仅凭官方资料与公开案例阐述，把KES的技术优势所在，及其在央国企如何落实开来清楚道破，而且还会附上可以直接执行的代码，让你既能看懂，又能动手尝试。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b837c819f9f4d348473c1f68d011908~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764591898&amp;x-signature=xKwZ29jGvsAGf57Sf2Lwt15FqAU%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">金仓数据库的介绍</h2>
<ul>
<li>
<p>产品定位与架构特征</p>
<ul>
<li>
<p>KES 的定位很清楚，就是冲着各行各业的要害应用去的。它是个企业级的大型通用融合数据库，说白了就是个“多面手”：既能处理日常交易（OLTP），也能搞定数据分析（OLAP），还能轻松拿捏海量的时序数据、全文搜索、地理信息（GIS）这些复杂活儿。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1002b4da74f9474fb56460b7f4bd3c3f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764591898&amp;x-signature=6zrCx1oFKSA1DriSqJVFUEvtTOY%3D" alt="image.png" loading="lazy"/></p>
</li>
<li>
<p>融合数据库架构：最厉害的是它的“融合”架构：一套软件，就能同时兼容 Oracle、MySQL、SQL Server、PostgreSQL 好几种主流语法，开发迁移都省心。数据模型上，不管是传统的关系型数据，还是时髦的文档/JSON、全文、GIS、时序数据，它都能装得下。部署的时候，你可以根据业务对可用性和成本的要求，自由选择集中式或者分布式，非常灵活。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c9474d6ed7b747cdae4d046d5eec77c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764591898&amp;x-signature=ObdpJzNjBHAOj37DVUU9hoIg%2BHo%3D" alt="image.png" loading="lazy"/></p>
</li>
</ul>
</li>
<li>
<p>生态与工具链</p>
<ul>
<li>工具链覆盖评估、迁移、开发、运维全流程：金仓提供了一整套工具，把评估、迁移、开发、运维这些活儿全包了。用 KDMS/KDTS 搞定评估和迁移，用 KStudio 管理开发和数据库对象，再用 KOPS/KEMCC 做集中的监控和运维。可以说，从“能不能迁过来”到“用得爽不爽”，整个生命周期它都帮你安排得明明白白。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45898bdf8c9946d1a08081b36302aa78~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764591898&amp;x-signature=Gbk2sTcXyqYH4UWd%2B22owYASj7E%3D" alt="image.png" loading="lazy"/></li>
</ul>
</li>
<li>
<p>安全与合规能力</p>
<ul>
<li>三权分立：这个机制很关键，它把数据库管理员、安全管理员（sso）、审计管理员（sao）的权限彻底分开，谁也管不了谁，这样就避免了“超级管理员”一个人说了算的情况，安全性大大提高。而且，它还支持受限的 DBA 插件式管理，权限控制得更细。</li>
<li>传输加密：数据在网络上传输的时候，KES 原生就支持 SSL/TLS 加密。你只要配好证书和加密算法，就能保证数据在路上不被偷看或篡改，链路安全得很。</li>
<li>审计能力：谁动了我的数据？KES 的 sysaudit 插件能把服务器上发生的各种事件、执行的 SQL 语句、操作的对象都记下来。审计的开关和策略完全由你控制，想查什么就查什么。</li>
<li>强制访问控制（MAC）：对于保密要求极高的场景，KES 还有大招——强制访问控制。通过给数据打上不同的安全标签，可以实现对象级、列级甚至行级的访问控制。这得加载 sysmac 插件才能用，但效果绝对硬核。</li>
</ul>
</li>
<li>
<p>可用性与集群</p>
<ul>
<li>高可用这块，金仓的方案很全。从基本的主备、读写分离，到要求更高的同城双活、两地三中心，再到能跨节点读写和扩展的 RAC 共享存储集群，各种架构都能搭。总之一句话，既保证了业务连续性，又能按需扩展。</li>
</ul>
</li>
<li>
<p>市场应用与装机规模</p>
<ul>
<li>官方自己公布的数据是：KES 已经给能源、金融、电信、交通、医疗、政务等 30 多个行业提供了服务，装机量累计超过了 100 万套。而且，在国产数据库的关键应用领域，它的销售套数已经连续四年排第一了。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-2">金仓数据库在央企国企应用的技术解读</h2>
<p>对于央企和国企来说，选数据库，光“能用”是远远不够的，关键得“用得好”。什么叫用得好？平滑替换得省心，系统架构得能扛事儿，安全防护得没漏洞，数据用起来得顺手，迁移和运维还得省力气。下面，咱们就结合金仓官方给出的能力和一些典型场景，把这些关键点掰开揉碎了讲，并且配上代码例子，方便你实际操作。</p>
<h3 data-id="heading-3">1. 平滑替代与生态兼容</h3>
<p>-KES 兼容 Oracle，MySQL，SQL Server，PostgreSQL 的语法与接口，这在国产化替代进程中堪称福音，其优势十分明显，即业务代码无需大幅改动或者无需改动，如此一来，既能极大压缩项目历时，又能把迁移风险降至较低水平。</p>
<p>典型的兼容例子就是Oracle中常被用到的同义词（Synonym），KES也是支持它的，迁移过来以后，可以利用它给表起别名，这样之前的程序代码就无需做修改，可以直接被访问，十分便捷。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 在当前模式创建同义词，指向目标对象</span>
<span class="hljs-keyword">CREATE</span> SYNONYM emp <span class="hljs-keyword">FOR</span> hr.employees;

<span class="hljs-comment">-- 也支持指定用户模式创建</span>
<span class="hljs-keyword">CREATE</span> SYNONYM hr_emp <span class="hljs-keyword">FOR</span> hr.employees;
</code></pre>
<ul>
<li>外部服务与 FDW（示例）：有时候需要访问其他数据库的数据，KES 的外部数据包装器（FDW）就能派上用场。通过它，你可以直接在 KES 里查询另一个数据库的表，就像操作本地表一样。（下面的语法只是个例子，具体用的时候得根据你的数据库版本和驱动来调整）。</li>
</ul>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> SERVER myserver <span class="hljs-keyword">FOREIGN</span> DATA WRAPPER kingbase_fdw
  OPTIONS (host <span class="hljs-string">'db.internal'</span>, dbname <span class="hljs-string">'legacydb'</span>, port <span class="hljs-string">'54321'</span>);
</code></pre>
<h3 data-id="heading-4">2. 高可用架构与故障应对</h3>
<p>KES 所支持的架构十分全面，读写分离，同城双活，两地三中心，RAC 共享存储等方案，都可以帮助达成不同的恢复点目标（RPO）与恢复时间目标（RTO），从而保证业务做到一天 24 小时，一周 7 天不停歇运行。</p>
<p>在集群环境下，网络波动时，各节点均会自认为主节点，此现象被称为“脑裂”，KES经由守护进程（repmgrd/kbha）及信任网关设置，可规避此类情形，保障集群稳定。</p>
<p>部署脚本示例（命令行部署，遵照现场路径与版本适配），下面给出在命令行当中部署集群的简单示例，实际执行的时候，要按照服务器上的具体路径以及 KES 的版本做相应的调整。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 编辑安装配置</span>
vi /opt/Kingbase/ES/V9/Server/bin/install.conf

<span class="hljs-comment"># 初始化并启动安全组件（示例路径因版本而异）</span>
/opt/Kingbase/ES/V9/Server/bin/sys_HAscmdd.sh init
/opt/Kingbase/ES/V9/Server/bin/sys_HAscmdd.sh start

<span class="hljs-comment"># 执行集群部署（同目录下 cluster_install.sh、trust_cluster.sh 等文件准备齐全）</span>
sh /opt/Kingbase/ES/V9/Server/bin/cluster_install.sh
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be214edb9b624d0e89b801d4f151ee68~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764591898&amp;x-signature=0EfFbCiyNOgqCMG3zSMxgisHws0%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-5">3. 全链路安全：三权分立、SSL、审计、MAC</h3>
<ul>
<li>
<p>管理分权（三权分立）：数据库一初始化，就会自动创建<code>管理员（system）</code>、<code>安全管理员（sso）</code>和<code>审计管理员（sao）</code>这三个角色。他们仨各管一摊，权限边界清清楚楚，谁也越不了界。</p>
</li>
<li>
<p>传输加密（SSL）配置示例：</p>
</li>
</ul>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># kingbase.conf</span>
<span class="hljs-attr">ssl</span> = <span class="hljs-literal">on</span>
<span class="hljs-attr">ssl_cert_file</span> = <span class="hljs-string">'server.crt'</span>
<span class="hljs-attr">ssl_key_file</span>  = <span class="hljs-string">'server.key'</span>
<span class="hljs-attr">ssl_ca_file</span>   = <span class="hljs-string">'rootCA.crt'</span>
<span class="hljs-attr">ssl_ciphers</span>   = <span class="hljs-string">'HIGH:!aNULL:!MD5'</span>  <span class="hljs-comment"># 示例密码套件，按安全策略收敛</span>

<span class="hljs-comment"># sys_hba.conf（强制证书认证）</span>
<span class="hljs-comment"># 仅示例：根据实际网段与角色收敛</span>
hostssl all all 10.0.0.0/16 cert <span class="hljs-attr">clientcert</span>=<span class="hljs-number">1</span>
</code></pre>
<ul>
<li>审计开关与重载（sysaudit 插件）：想用审计功能，得先在配置文件里把 <code>sysaudit</code> 这个插件加载上。等数据库启动后，你就可以随时通过命令打开审计功能，然后重新加载一下配置，它就立马生效了。</li>
</ul>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 加载审计插件（启动前配置）</span>
<span class="hljs-comment">-- kingbase.conf: shared_preload_libraries = 'sysaudit'</span>

<span class="hljs-comment">-- 启动后打开审计并重载配置</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-keyword">SET</span> sysaudit.enable <span class="hljs-operator">=</span> <span class="hljs-keyword">on</span>;
<span class="hljs-keyword">CALL</span> sys_reload_conf();
</code></pre>
<ul>
<li>强制访问控制（MAC）：这是一种更高级的安全玩法，能给对象、列、甚至是行都打上安全标签，严格遵循“向下读、区间写”的保密模型。不过，这需要加载 <code>sysmac</code> 插件，并且具体的策略和语法得查阅对应版本的官方文档来配置。<a href="https://link.juejin.cn?target=https%3A%2F%2Fbbs.kingbase.com.cn%2Fkingbase-doc%2Fv8.6.8.14%2Fsafety%2Fsafety-guide%2Flabel-and-mac.html" target="_blank" title="https://bbs.kingbase.com.cn/kingbase-doc/v8.6.8.14/safety/safety-guide/label-and-mac.html" ref="nofollow noopener noreferrer">参考</a></li>
</ul>
<h3 data-id="heading-6">4. 多模与性能：分区、JSON、执行计划优化</h3>
<ul>
<li>分区表（时间分区示例）：当一张表的数据量变得特别大时，可以按时间范围把表“切”成一小块一小块的，这就是分区。这样做的好处是，既能减轻单个表的访问压力，也方便以后按月或按年对老数据进行清理或归档。</li>
</ul>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> meter_readings (
  reading_id   BIGSERIAL <span class="hljs-keyword">PRIMARY</span> KEY,
  device_id    <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  reading_ts   <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  <span class="hljs-keyword">value</span>        <span class="hljs-type">NUMERIC</span>(<span class="hljs-number">18</span>,<span class="hljs-number">6</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
)
<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">RANGE</span> (reading_ts);

<span class="hljs-comment">-- 按月创建分区（示例）</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> meter_readings_2025_11
  <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">OF</span> meter_readings <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">VALUES</span> <span class="hljs-keyword">FROM</span> (<span class="hljs-string">'2025-11-01'</span>) <span class="hljs-keyword">TO</span> (<span class="hljs-string">'2025-12-01'</span>);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> meter_readings_2025_12
  <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">OF</span> meter_readings <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">VALUES</span> <span class="hljs-keyword">FROM</span> (<span class="hljs-string">'2025-12-01'</span>) <span class="hljs-keyword">TO</span> (<span class="hljs-string">'2026-01-01'</span>);
</code></pre>
<ul>
<li>分区执行计划优化：如果你的分区表有成百上千个子分区，查询的时候数据库光生成执行计划就得花不少时间。通过设置 <code>partition_table_limit</code> 这个参数，你可以告诉数据库：当经过筛选后的子分区数量超过这个值时，就别再一个个精打细算了，直接用一种快速模式来生成计划，这样能大大提高高并发下的查询性能。</li>
</ul>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 当剪枝后的子分区数超过该阈值，启用快速计划生成</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-keyword">SET</span> partition_table_limit <span class="hljs-operator">=</span> <span class="hljs-number">20</span>;
<span class="hljs-keyword">CALL</span> sys_reload_conf();
</code></pre>
<ul>
<li>JSON 数据类型（日志/消息示例）：现在很多业务日志和消息都喜欢用 JSON 格式。KES 原生就支持 JSON 数据类型，你可以直接把 JSON 存到数据库里，并且用它提供的函数方便地提取里面的字段，进行查询和分析。</li>
</ul>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> event_logs (
  id       BIGSERIAL <span class="hljs-keyword">PRIMARY</span> KEY,
  occurred <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> now(),
  payload  JSON <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
);

<span class="hljs-comment">-- 提取 JSON 字段（示例函数按版本提供）</span>
<span class="hljs-keyword">SELECT</span> payload<span class="hljs-operator">-</span><span class="hljs-operator">&gt;&gt;</span><span class="hljs-string">'eventType'</span> <span class="hljs-keyword">AS</span> event_type,
       (payload<span class="hljs-operator">-</span><span class="hljs-operator">&gt;&gt;</span><span class="hljs-string">'severity'</span>)::<span class="hljs-type">int</span> <span class="hljs-keyword">AS</span> severity
<span class="hljs-keyword">FROM</span> event_logs
<span class="hljs-keyword">WHERE</span> occurred <span class="hljs-operator">&gt;=</span> now() <span class="hljs-operator">-</span> <span class="hljs-type">interval</span> <span class="hljs-string">'1 day'</span>;
</code></pre>
<h2 data-id="heading-7">案例分析</h2>
<p>到了真金白银采购和选型的时候，说一千道一万，不如看看别人家是怎么用的。下面我们就扒一扒官方公开的几个案例，用事实说话。</p>
<ul>
<li>
<p>中国海洋石油集团（中国海油）</p>
<ul>
<li>规模有多大呢？超过 300 个业务系统，其中还包括 100 多个核心系统，全都从原来的数据库迁移到了金仓 KES。这些系统覆盖了从上游的勘探开发，到中游的生产运营，再到后台的经营管理和安全监控，可以说是把整个家底都搬上来了。</li>
<li>可用性怎么样？容灾能力做到了 RPO 接近 0，RTO 小于 30 秒。这意味着就算出了问题，数据基本不丢，半分钟内就能恢复。像应急指挥、工业互联网安全监控、钻井作业这些一秒都不能停的关键业务，全靠这套架构撑着。</li>
<li>安全这块也毫不含糊。KES 内置了好多层安全防护，还拿到了国家权威机构最高等级的安全认证 EAL4+。不管是等级保护还是国密算法的要求，都能满足。而且它跟各种国产的硬件、软件、云平台都能很好地配合。</li>
<li>迁移和运维顺不顺？中海油用了金仓全家桶工具（KDTS/KFS/KEMCC），实现了平滑迁移和实时的数据同步，最后还能把所有数据库都统一管起来。整个过程对业务基本没影响，做到了“无感切换”。</li>
</ul>
</li>
<li>
<p>国家电网（智能电网调度与新一代集控系统）</p>
<ul>
<li>国家电网的核心业务——智能电网调度系统（D5000）和新一代的集控系统，跑在金仓数据库上已经很多年了，一直非常稳定。这套系统在全国很多省市都上了线，实现了“无人值守、集中监控”的智能运维，效率大大提升。</li>
<li>电网这个行业，特点非常鲜明：数据采集和监控是一体的，有海量的数据需要高频率地写入，还得保证跨区域数据同步的准确和安全。这对数据库的要求极高，必须要有超强的吞吐能力和广域网下数据一致性的处理能力。</li>
</ul>
</li>
<li>
<p>央企整体与行业覆盖</p>
<ul>
<li>从整个央企市场来看，金仓官方的数据显示，KES 的总装机量已经超过了 100 万套，覆盖了能源、金融、交通、医疗、政务等 30 多个行业。在最关键的应用领域，它的销量已经连续四年都是国产数据库里的第一名。</li>
</ul>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b67ba1361804cdab213cafa30662575~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764591898&amp;x-signature=mwQXMVlPOWC3M1S5zMJHGjkEAmU%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-8">结语</h2>
<p>总的来说，对于央企和国企，数据库这东西，不是说“能跑起来”就万事大吉了，而是要追求“稳、准、快、可控”。从咱们前面的分析能看出来，金仓数据库在兼容性、平滑迁移、高可用和安全合规这些方面，不仅有完整的技术方案，还有一整套的工具来保驾护航，并且已经在能源、电力这些核心行业里实打实地干了好多年，经受住了考验。如果你也打算用，这里有几条实在的建议：</p>
<ul>
<li>先把你的核心指标搞清楚，比如对数据丢失和业务中断的容忍度（RPO/RTO）、系统吞吐量要求（TPS/QPS）、数据模型的复杂度等等，然后根据这些来选择最合适的高可用架构和分区策略；</li>
<li>安全体系不能一蹴而就，但可以先把“三权分立 + SSL + 审计 + MAC”这一套组合拳作为安全基线，然后一步步地落地；</li>
<li>迁移的时候，别忘了金仓提供的那一套宝贝工具（KDMS/KDTS/KFS/KEMCC），一定要用足用好。最好采用新旧系统并行跑一段时间（双轨并行），再把真实业务的访问压力在新系统上模拟一遍（负载回放），确保万无一失；</li>
<li>如果你的业务并发量很大，或者分区表特别多，记得把执行计划优化的相关参数打开，并且要建立一套持续的监控机制，随时观察数据库的性能表现。</li>
</ul>
<p>记住，只要“架构选得准、工具用到位、策略拿得稳、验证做到足”，就一定能把国产数据库用好，让它成为咱们业务长期、稳定、可靠的数字底座。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React - 【useEffect 与 useLayoutEffect】 区别 及 使用场景]]></title>    <link>https://juejin.cn/post/7576105442213609522</link>    <guid>https://juejin.cn/post/7576105442213609522</guid>    <pubDate>2025-11-24T12:27:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576105442213609522" data-draft-id="7576086557716512819" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React - 【useEffect 与 useLayoutEffect】 区别 及 使用场景"/> <meta itemprop="keywords" content="React.js,前端"/> <meta itemprop="datePublished" content="2025-11-24T12:27:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="禁止摆烂_才浅"/> <meta itemprop="url" content="https://juejin.cn/user/92819673587448"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React - 【useEffect 与 useLayoutEffect】 区别 及 使用场景
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/92819673587448/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    禁止摆烂_才浅
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T12:27:37.000Z" title="Mon Nov 24 2025 12:27:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;color:#282d36}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px;color:#2f845e}.markdown-body h2{font-size:22px;display:inline-block;font-weight:700;background:#2f845e;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(47,132,194,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 32px);border-bottom:3px solid #2f845e}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%;box-shadow:6px 6px 6px #888}.markdown-body hr{border:none;border-top:1px solid rgba(66,185,131,.15);margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#f6ffed;color:#52c41a;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:16px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#262626;border:1px solid #2f845e;border-top:8px solid #2f845e;background:linear-gradient(180deg,rgba(66,185,131,.1),transparent)!important}.markdown-body pre&gt;code.hljs[lang]:before{top:8px!important;color:#2f845e!important}.markdown-body pre&gt;code.language-awesome_error{border:1px solid #ff4d4f!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#ff4d4f!important;background:#fff2f0!important}.markdown-body pre&gt;code.language-awesome_error:before{content:"!"!important;position:absolute!important;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#ff4d4f!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body pre&gt;code.language-awesome_warn{border:1px solid #ffc46f!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#ffc46f!important;background:#fffbe6!important}.markdown-body pre&gt;code.language-awesome_warn:before{content:"☂"!important;position:absolute;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#ffc46f!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body pre&gt;code.language-awesome_success{border:1px solid #52c41a!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#52c41a!important;background:#f6ffed!important}.markdown-body pre&gt;code.language-awesome_success:before{content:"✓"!important;position:absolute!important;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#52c41a!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body pre&gt;code.language-awesome_info{border:1px solid #1890ff!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#1890ff!important;background:#e6f7ff!important}.markdown-body pre&gt;code.language-awesome_info:before{content:"i"!important;position:absolute!important;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#1890ff!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body strong{background-color:inherit;color:#2f845e}.markdown-body em{background-color:inherit;color:#949415}.markdown-body a{text-decoration:none;color:#2f8e54;border-bottom:1px solid #3f9e64}.markdown-body a:active,.markdown-body a:hover{color:#3f9e64}.markdown-body a[class^=footnote]{margin-left:4px}.markdown-body a:before{content:"➤ "}.markdown-body table{font-size:12px;width:100%;max-width:100%;overflow:auto;border:2px solid #2f8e54}.markdown-body thead{background:#2f8e54;color:#fff;text-align:left;font-weight:700}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:22px}.markdown-body td{min-width:120px}.markdown-body blockquote{padding:1px 22px;margin:22px 0;border-left:6px solid #2f845e;background-color:rgba(66,185,131,.1);border-radius:2px}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#2f845e}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px;color:#282d36}.markdown-body del{color:#2f845e}.markdown-body input[type=checkbox]:checked:before{content:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAA/klEQVQ4T72TMU7DQBBF318XdFR06egQEnAXRINEGlqgowoIR8AF4AZOZ4JEGq5AC5EixBU4A55BNrEVHAcSBTHlaubt37/zxZKlcn7n6mDPXJvz8IJ89HzWu8t7C8D2dfsY52ae4apHnLx0ktsCsHXZjiUuFgG40x2eJ/H/AhztB+zDUTpLwWj8jGkzxSHiHaMPrDQC8sMoilKzLAUqiKQjmb+ZuAdW80tmelCHODoNgSfP7AFprTTaRTzsJN1GEyuIZ7uW6TEEHwCtyV/6EVBKJHhfzgC0Xv/iXwEFBF4FG0378bd7sPQq5xK/hSnk6sdlX3mZrKkwLZKBeu8n9XuWEUE7X+YAAAAASUVORK5CYII=);position:relative;top:-1px;left:-1px}.markdown-body .math .katex{font-family:Menlo,Monaco,Consolas,Courier New,monospace;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#f6ffed;color:#52c41a;font-size:.87em;padding:.065em .4em}@media (max-width:720px){.markdown-body h1{font-size:22px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">useEffect vs useLayoutEffect 完全指南</h2>
<h3 data-id="heading-1">🎯 核心区别：执行时机</h3>
<h4 data-id="heading-2">useEffect（异步副作用）</h4>
<pre><code class="hljs language-markdown" lang="markdown">React 渲染 DOM
<span class="hljs-code">    ↓
浏览器绘制屏幕
    ↓
执行 useEffect ← 用户已经看到 DOM
    ↓
可能导致屏幕闪烁
</span></code></pre>
<h4 data-id="heading-3">useLayoutEffect（同步副作用）</h4>
<pre><code class="hljs language-markdown" lang="markdown">React 渲染 DOM
<span class="hljs-code">    ↓
执行 useLayoutEffect ← 立即同步执行
    ↓
浏览器绘制屏幕（已是最终效果）
    ↓
用户看到最终结果（无闪烁）
</span></code></pre>
<hr/>
<h3 data-id="heading-4">📊 详细对比表</h3>








































<table><thead><tr><th>特性</th><th>useEffect</th><th>useLayoutEffect</th></tr></thead><tbody><tr><td><strong>执行时机</strong></td><td>DOM 更新后，<strong>浏览器绘制前</strong></td><td>DOM 更新后，<strong>立即同步执行</strong></td></tr><tr><td><strong>阻塞渲染</strong></td><td>❌ 不阻塞</td><td>✅ 会阻塞浏览器绘制</td></tr><tr><td><strong>性能</strong></td><td>⭐⭐⭐⭐⭐ 更好</td><td>⭐⭐⭐ 可能卡顿</td></tr><tr><td><strong>使用频率</strong></td><td>99% 的情况用这个</td><td>特定场景用</td></tr><tr><td><strong>服务端渲染</strong></td><td>✅ 支持</td><td>❌ 会报警告</td></tr><tr><td><strong>清理函数执行</strong></td><td>DOM 更新前执行</td><td>DOM 更新前执行</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-5">🔴 useEffect 执行时间线</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Component</span>(<span class="hljs-params"/>) {
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'1. useEffect 执行'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'2. useEffect 清理函数'</span>);
  }, []);

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'0. 组件渲染'</span>);
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>Hello<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}

<span class="hljs-comment">// 执行顺序：</span>
<span class="hljs-comment">// 0. 组件渲染</span>
<span class="hljs-comment">// 1. useEffect 执行</span>
<span class="hljs-comment">// 2. useEffect 清理函数（卸载或依赖变化时）</span>
</code></pre>
<hr/>
<h3 data-id="heading-6">🟠 useLayoutEffect 执行时间线</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Component</span>(<span class="hljs-params"/>) {
  <span class="hljs-title function_">useLayoutEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'1. useLayoutEffect 执行（同步）'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'2. useLayoutEffect 清理函数'</span>);
  }, []);

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'0. 组件渲染'</span>);
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>Hello<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}

<span class="hljs-comment">// 执行顺序：</span>
<span class="hljs-comment">// 0. 组件渲染</span>
<span class="hljs-comment">// 1. useLayoutEffect 执行（同步，阻塞浏览器绘制）</span>
<span class="hljs-comment">// 浏览器绘制屏幕</span>
<span class="hljs-comment">// 2. useLayoutEffect 清理函数</span>
</code></pre>
<hr/>
<h3 data-id="heading-7">💡 常用场景 &amp; 代码示例</h3>
<h4 data-id="heading-8">场景1️⃣：数据请求（useEffect）✅ 推荐</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">UserProfile</span>(<span class="hljs-params">{ userId }</span>) {
  <span class="hljs-keyword">const</span> [user, setUser] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> [loading, setLoading] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">true</span>);
    
    <span class="hljs-comment">// 异步获取数据</span>
    <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/api/users/<span class="hljs-subst">${userId}</span>`</span>)
      .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-title function_">json</span>())
      .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
        <span class="hljs-title function_">setUser</span>(data);
        <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">false</span>);
      })
      .<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'加载失败:'</span>, err);
        <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">false</span>);
      });
  }, [userId]);  <span class="hljs-comment">// userId 变化时重新获取</span>

  <span class="hljs-keyword">if</span> (loading) <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{user?.name}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre>
<p><strong>为什么用 useEffect？</strong></p>
<ul>
<li>数据获取是异步操作，不需要同步阻塞</li>
<li>用户看到加载状态很正常</li>
</ul>
<hr/>
<h4 data-id="heading-9">场景2️⃣：事件监听（useEffect）✅ 推荐</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">WindowResize</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [width, setWidth] = <span class="hljs-title function_">useState</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleResize</span>(<span class="hljs-params"/>) {
      <span class="hljs-title function_">setWidth</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>);
    }

    <span class="hljs-comment">// 添加监听</span>
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, handleResize);

    <span class="hljs-comment">// 清理：移除监听</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'resize'</span>, handleResize);
    };
  }, []);  <span class="hljs-comment">// 只在挂载时运行</span>

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>窗口宽度: {width}px<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre>
<p><strong>为什么用 useEffect？</strong></p>
<ul>
<li>事件监听是异步的，不需要同步执行</li>
<li>必须清理事件监听器，防止内存泄漏</li>
</ul>
<hr/>
<h4 data-id="heading-10">场景3️⃣：DOM 测量（useLayoutEffect）✅ 正确</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">MeasureElement</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> ref = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> [height, setHeight] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-title function_">useLayoutEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 必须用 useLayoutEffect，否则会闪烁</span>
    <span class="hljs-comment">// 1. 测量 DOM 尺寸</span>
    <span class="hljs-keyword">const</span> rect = ref.<span class="hljs-property">current</span>.<span class="hljs-title function_">getBoundingClientRect</span>();
    
    <span class="hljs-comment">// 2. 基于尺寸计算布局</span>
    <span class="hljs-keyword">const</span> newHeight = rect.<span class="hljs-property">width</span> &gt; <span class="hljs-number">500</span> ? <span class="hljs-number">300</span> : <span class="hljs-number">150</span>;
    
    <span class="hljs-comment">// 3. 立即更新（在浏览器绘制前）</span>
    <span class="hljs-title function_">setHeight</span>(newHeight);
  }, []);  <span class="hljs-comment">// 只在挂载时运行</span>

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{ref}</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">height:</span> `${<span class="hljs-attr">height</span>}<span class="hljs-attr">px</span>` }}&gt;</span>
      响应式高度
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p><strong>为什么用 useLayoutEffect？</strong></p>
<ul>
<li>需要在浏览器绘制前完成 DOM 测量和布局计算</li>
<li>如果用 useEffect，用户会看到高度从 0 闪到 300（闪烁！）</li>
</ul>
<hr/>
<h4 data-id="heading-11">场景4️⃣：表单焦点设置（useLayoutEffect）✅ 正确</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">AutoFocusForm</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> inputRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);

  <span class="hljs-title function_">useLayoutEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 必须用 useLayoutEffect，否则表单打开时看不到光标在哪</span>
    inputRef.<span class="hljs-property">current</span>?.<span class="hljs-title function_">focus</span>();
  }, []);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">form</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{inputRef}</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"自动聚焦"</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span>&gt;</span>提交<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span>
  );
}
</code></pre>
<p><strong>为什么用 useLayoutEffect？</strong></p>
<ul>
<li>如果用 useEffect，用户会看到输入框出现，然后光标才聚焦（视觉延迟）</li>
<li>useLayoutEffect 保证光标在浏览器绘制前已经聚焦</li>
</ul>
<hr/>
<h4 data-id="heading-12">场景5️⃣：动画初始化（useLayoutEffect）✅ 正确</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">AnimatedBox</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> boxRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);

  <span class="hljs-title function_">useLayoutEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 设置初始状态（隐藏）</span>
    gsap.<span class="hljs-title function_">set</span>(boxRef.<span class="hljs-property">current</span>, { <span class="hljs-attr">opacity</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">x</span>: -<span class="hljs-number">50</span> });
    
    <span class="hljs-comment">// 然后执行动画</span>
    gsap.<span class="hljs-title function_">to</span>(boxRef.<span class="hljs-property">current</span>, { 
      <span class="hljs-attr">opacity</span>: <span class="hljs-number">1</span>, 
      <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>, 
      <span class="hljs-attr">duration</span>: <span class="hljs-number">0.5</span> 
    });
  }, []);

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{boxRef}</span>&gt;</span>动画盒子<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre>
<p><strong>为什么用 useLayoutEffect？</strong></p>
<ul>
<li>避免用户看到初始未变换的状态，然后才动画</li>
<li>useLayoutEffect 保证在浏览器绘制前完成初始设置</li>
</ul>
<hr/>
<h4 data-id="heading-13">场景6️⃣：主题切换（useLayoutEffect）⚠️ 特殊</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ThemeProvider</span>(<span class="hljs-params">{ theme }</span>) {
  <span class="hljs-title function_">useLayoutEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 立即应用主题，避免闪烁</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-property">style</span>.<span class="hljs-property">colorScheme</span> = theme;
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-property">className</span> = <span class="hljs-string">`theme-<span class="hljs-subst">${theme}</span>`</span>;
  }, [theme]);

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>内容<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre>
<p><strong>为什么用 useLayoutEffect？</strong></p>
<ul>
<li>防止主题切换时的闪烁（深色→浅色 的白屏闪烁）</li>
</ul>
<hr/>
<h3 data-id="heading-14">📋 依赖数组详解</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1️⃣ 每次渲染都执行（没有依赖数组）</span>
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'每次都运行'</span>);
});

<span class="hljs-comment">// 2️⃣ 只在挂载时执行（空依赖数组）</span>
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'只在挂载时执行'</span>);
}, []);

<span class="hljs-comment">// 3️⃣ 依赖值变化时执行</span>
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'userId 变化时执行'</span>);
}, [userId]);

<span class="hljs-comment">// 4️⃣ 多个依赖</span>
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'userId 或 pageNum 变化时执行'</span>);
}, [userId, pageNum]);

<span class="hljs-comment">// 5️⃣ 依赖是对象时的坑</span>
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// ❌ 每次都会执行，因为 {} 每次都是新的</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'可能无限循环'</span>);
}, [{}]);

<span class="hljs-comment">// ✅ 正确做法：使用 useMemo</span>
<span class="hljs-keyword">const</span> config = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> ({}), []);
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'config 稳定，不会无限循环'</span>);
}, [config]);
</code></pre>
<hr/>
<h3 data-id="heading-15">⚠️ 常见陷阱</h3>
<h4 data-id="heading-16">陷阱1️⃣：useLayoutEffect 导致卡顿</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 不好：useLayoutEffect 中做复杂计算会阻塞绘制</span>
<span class="hljs-title function_">useLayoutEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 这会冻结浏览器！</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000000</span>; i++) {
    <span class="hljs-title function_">complexCalculation</span>();
  }
}, []);

<span class="hljs-comment">// ✅ 好：复杂计算放到 useEffect</span>
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000000</span>; i++) {
    <span class="hljs-title function_">complexCalculation</span>();
  }
}, []);
</code></pre>
<hr/>
<h4 data-id="heading-17">陷阱2️⃣：useLayoutEffect 在服务端渲染中报错</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 错：SSR 时会报警告</span>
<span class="hljs-title function_">useLayoutEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// SSR 中不能执行</span>
}, []);

<span class="hljs-comment">// ✅ 好：检测环境</span>
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span> !== <span class="hljs-string">'undefined'</span>) {
    <span class="hljs-comment">// 客户端代码</span>
  }
}, []);

<span class="hljs-comment">// 或者条件性使用</span>
<span class="hljs-keyword">const</span> useIsomorphicLayoutEffect = 
  <span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span> !== <span class="hljs-string">'undefined'</span> ? useLayoutEffect : useEffect;

<span class="hljs-title function_">useIsomorphicLayoutEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 自动适配 SSR</span>
}, []);
</code></pre>
<hr/>
<h4 data-id="heading-18">陷阱3️⃣：忘记清理副作用</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 坏：内存泄漏</span>
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> timer = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'每秒执行'</span>);
  }, <span class="hljs-number">1000</span>);
  <span class="hljs-comment">// 没有清理！</span>
}, []);

<span class="hljs-comment">// ✅ 好：返回清理函数</span>
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> timer = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'每秒执行'</span>);
  }, <span class="hljs-number">1000</span>);
  
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(timer);  <span class="hljs-comment">// 清理定时器</span>
}, []);
</code></pre>
<hr/>
<h4 data-id="heading-19">陷阱4️⃣：无限循环</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 坏：无限循环</span>
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>);  <span class="hljs-comment">// 每次都修改 count</span>
}, [count]);  <span class="hljs-comment">// 导致重新渲染，又触发 effect</span>

<span class="hljs-comment">// ✅ 好：不把更新的值放在依赖中</span>
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">c</span> =&gt;</span> c + <span class="hljs-number">1</span>);
}, []);  <span class="hljs-comment">// 空依赖，只执行一次</span>
</code></pre>
<hr/>
<h3 data-id="heading-20">🚀 选择流程图</h3>
<pre><code class="hljs language-markdown" lang="markdown">需要执行副作用？
<span class="hljs-code">    ↓
是异步操作（数据获取、定时器）?
    ├─ 是 → useEffect ✅
    └─ 否 ↓
    
需要在浏览器绘制前同步执行？
    ├─ 是 → useLayoutEffect ✅
    │   例：DOM 测量、焦点、动画、主题
    └─ 否 → useEffect ✅（默认选择）
</span></code></pre>
<hr/>
<h3 data-id="heading-21">📊 性能对比</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 测试性能影响</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">PerformanceTest</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-comment">// useEffect 不会阻塞渲染</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 即使这里做复杂计算，页面也能快速响应</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000000</span>; i++) {}
  }, [count]);

  <span class="hljs-comment">// useLayoutEffect 会阻塞渲染</span>
  <span class="hljs-title function_">useLayoutEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 这个计算会让点击按钮时出现明显延迟</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000000</span>; i++) {}
  }, [count]);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(count + 1)}&gt;
      点击：{count}
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 结论：</span>
<span class="hljs-comment">// useEffect 按钮响应迅速</span>
<span class="hljs-comment">// useLayoutEffect 点击时会卡顿</span>
</code></pre>
<hr/>
<h3 data-id="heading-22">✅ 快速参考</h3>
<h4 data-id="heading-23">99% 情况用 useEffect</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 数据获取</span>
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> { <span class="hljs-title function_">fetchData</span>(); }, []);

<span class="hljs-comment">// 事件监听</span>
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> { 
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, handler);
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'resize'</span>, handler);
}, []);

<span class="hljs-comment">// 副作用通用场景</span>
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> { <span class="hljs-title function_">doSomething</span>(); }, [dep]);
</code></pre>
<h4 data-id="heading-24">特殊场景用 useLayoutEffect</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// DOM 测量</span>
<span class="hljs-title function_">useLayoutEffect</span>(<span class="hljs-function">() =&gt;</span> { 
  <span class="hljs-keyword">const</span> rect = ref.<span class="hljs-property">current</span>.<span class="hljs-title function_">getBoundingClientRect</span>();
  <span class="hljs-title function_">setHeight</span>(rect.<span class="hljs-property">height</span>);
}, []);

<span class="hljs-comment">// 焦点设置</span>
<span class="hljs-title function_">useLayoutEffect</span>(<span class="hljs-function">() =&gt;</span> { 
  inputRef.<span class="hljs-property">current</span>?.<span class="hljs-title function_">focus</span>();
}, []);

<span class="hljs-comment">// 动画初始化</span>
<span class="hljs-title function_">useLayoutEffect</span>(<span class="hljs-function">() =&gt;</span> { 
  gsap.<span class="hljs-title function_">set</span>(ref.<span class="hljs-property">current</span>, initialState);
  <span class="hljs-title function_">startAnimation</span>();
}, []);
</code></pre>
<hr/>
<h3 data-id="heading-25">🎓 总结</h3>



































<table><thead><tr><th>维度</th><th>useEffect</th><th>useLayoutEffect</th></tr></thead><tbody><tr><td><strong>何时用</strong></td><td>99% 的情况</td><td>需要同步 DOM 操作</td></tr><tr><td><strong>执行时机</strong></td><td>浏览器绘制后</td><td>浏览器绘制前</td></tr><tr><td><strong>是否阻塞</strong></td><td>不阻塞</td><td>会阻塞</td></tr><tr><td><strong>性能</strong></td><td>优秀</td><td>可能卡顿</td></tr><tr><td><strong>例子</strong></td><td>数据请求、事件监听</td><td>DOM 测量、焦点、动画</td></tr></tbody></table>
<p><strong>记住：优先用 useEffect，只有特殊场景才用 useLayoutEffect！</strong> 🎯</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[写给小白看的使用LangChain构建基于知识图谱的RAG系统实战教程]]></title>    <link>https://juejin.cn/post/7576026767372468243</link>    <guid>https://juejin.cn/post/7576026767372468243</guid>    <pubDate>2025-11-24T12:33:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576026767372468243" data-draft-id="7576108254604148779" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="写给小白看的使用LangChain构建基于知识图谱的RAG系统实战教程"/> <meta itemprop="keywords" content="Agent,LangChain,LLM"/> <meta itemprop="datePublished" content="2025-11-24T12:33:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AI大模型"/> <meta itemprop="url" content="https://juejin.cn/user/3817967696221534"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            写给小白看的使用LangChain构建基于知识图谱的RAG系统实战教程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3817967696221534/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AI大模型
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T12:33:57.000Z" title="Mon Nov 24 2025 12:33:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读28分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote>
<p>在构建基于知识图谱的RAG系统或使用LangChain的智能体时，最大的挑战之一是从非结构化数据中准确提取节点和关系。特别是当使用较小的、量化的本地LLM时，这一点尤其困难，结果往往是AI系统表现不佳。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9dab3c1e84be4b6ab751b71a9adaa5ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764592436&amp;x-signature=GUvid67vitHOFjlNaIk72Sbskro%3D" alt="" loading="lazy"/></p>
<p>LangChain提取功能的一个关键问题是它依赖严格的JSON解析，即使使用更大的模型或非常详细的提示模板，也可能失败。相比之下，BAML使用一种模糊解析（fuzzy parsing）方法，即使LLM的输出不是完美的JSON格式，也能成功提取数据。</p>
<p>在这篇博客中，我们将探讨在使用较小的量化模型时LangChain提取的局限性，并展示BAML如何将提取成功率从大约25%提升到超过99%。</p>
<p>所有代码都可以在这个GitHub仓库中找到：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FFareedKhan-dev%2Flangchain-graphrag-baml" target="_blank" title="https://github.com/FareedKhan-dev/langchain-graphrag-baml" ref="nofollow noopener noreferrer">github.com/FareedKhan-…</a></p>
<hr/>
<h2 data-id="heading-0">目录</h2>
<ul>
<li>初始化评估数据集</li>
<li>量化的小型LLaMA模型</li>
<li>基于LLMGraphTransformer的方法</li>
<li>理解LangChain的问题</li>
<li>改进提示能解决问题吗？</li>
<li>BAML的初始化和快速概览</li>
<li>将BAML与LangChain集成</li>
<li>运行BAML实验</li>
<li>使用Neo4j分析GraphRAG</li>
<li>查找和链接相似实体</li>
<li>使用Leiden算法进行社区检测</li>
<li>分析最终图谱结构</li>
<li>结论</li>
</ul>
<hr/>
<h2 data-id="heading-1">初始化评估数据集</h2>
<p>为了理解问题及其解决方案，我们需要一个评估数据集来进行多次测试，以了解BAML如何改进LangChain知识图谱。</p>
<p>我们将使用Tomasonjo的博客数据集，托管在GitHub上，先加载这些数据。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 导入pandas库用于数据操作和分析  </span>
<span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd  
  
<span class="hljs-comment"># 从GitHub上的CSV文件加载新闻文章数据集到pandas DataFrame  </span>
news = pd.read_csv(  
    <span class="hljs-string">"https://raw.githubusercontent.com/tomasonjo/blog-datasets/main/news_articles.csv"</span>  
)  
  
<span class="hljs-comment"># 显示DataFrame的前5行  </span>
news.head()
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c0b1fc71a1264249a641d77453645e34~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764592436&amp;x-signature=qfGXc3vUeVMTclsHUAWLG%2B1AaKk%3D" alt="" loading="lazy"/></p>
<p>我们的DataFrame很简单（包含标题和文本，文本是新闻的描述）。我们还需要一列来存储每篇新闻文章文本对应的总token数。</p>
<p>为此，我们可以使用OpenAI的tiktoken库来计算token，方法很简单，用循环来处理数据集。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 导入tiktoken库来计算文本的token数  </span>
<span class="hljs-keyword">import</span> tiktoken  
  
<span class="hljs-comment"># 定义一个函数，计算给定字符串在指定模型中的token数  </span>
defnum_tokens_from_string(string: <span class="hljs-built_in">str</span>, model: <span class="hljs-built_in">str</span> = <span class="hljs-string">"gpt-4o"</span>) -&gt; <span class="hljs-built_in">int</span>:  
    <span class="hljs-string">"""返回文本字符串中的token数。"""</span>  
    <span class="hljs-comment"># 获取指定模型的编码  </span>
    encoding = tiktoken.encoding_for_model(model)  
    <span class="hljs-comment"># 将字符串编码为token并计数  </span>
    num_tokens = <span class="hljs-built_in">len</span>(encoding.encode(string))  
    <span class="hljs-comment"># 返回总token数  </span>
    <span class="hljs-keyword">return</span> num_tokens  
  
<span class="hljs-comment"># 在DataFrame中创建新列'tokens'  </span>
<span class="hljs-comment"># 计算每篇文章标题和文本组合的token数  </span>
news[<span class="hljs-string">"tokens"</span>] = [  
    num_tokens_from_string(<span class="hljs-string">f"<span class="hljs-subst">{row[<span class="hljs-string">'title'</span>]}</span> <span class="hljs-subst">{row[<span class="hljs-string">'text'</span>]}</span>"</span>)  
    <span class="hljs-keyword">for</span> i, row <span class="hljs-keyword">in</span> news.iterrows()  
]
</code></pre>
<p>计算DataFrame的token只需要几秒钟。</p>
<p>这是更新后的DataFrame。</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">显示DataFrame的前5行，展示新的<span class="hljs-string">'tokens'</span>列news.head()</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f19418bb4b24441a9a993f5704852995~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764592436&amp;x-signature=6WqnpiV6vvTwwr5%2FDgNgxQchGB4%3D" alt="" loading="lazy"/></p>
<p>这些token将在后续的评估和分析阶段使用，因此我们进行了这一步。</p>
<hr/>
<h2 data-id="heading-2">量化的小型LLaMA模型</h2>
<p>为了将数据转换为知识图谱，我们将使用一个低级别量化的模型来进行严格的测试。</p>
<p>在生产环境中，开源LLM通常以量化形式部署，以降低成本和延迟。本博客使用LLaMA 3.1。</p>
<p>这里选择Ollama作为平台，但LangChain支持多种API和本地LLM提供商，可以选择任何合适的选项。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># ChatOllama是Ollama语言模型的接口  </span>
from langchain_ollama import ChatOllama  
  
<span class="hljs-comment"># 定义要使用的模型名称  </span>
<span class="hljs-attr">model</span> = <span class="hljs-string">"llama3"</span>  
  
<span class="hljs-comment"># 初始化ChatOllama语言模型  </span>
<span class="hljs-comment"># 'temperature'参数控制输出的随机性  </span>
<span class="hljs-comment"># 低值（如0.001）使模型的响应更确定  </span>
<span class="hljs-attr">llm</span> = ChatOllama(model=model, temperature=<span class="hljs-number">0.001</span>)
</code></pre>
<p>你还需要在系统上安装Ollama，它支持macOS、Windows和Linux。</p>
<p>访问Ollama官方网站：<a href="https://link.juejin.cn?target=https%3A%2F%2Follama.com%2F" target="_blank" title="https://ollama.com/" ref="nofollow noopener noreferrer">ollama.com/</a> 下载适合你操作系统的安装程序并按照说明安装。安装后，Ollama会作为后台服务运行。</p>
<p>在macOS和Windows上，应用程序应自动启动并在后台运行（你可能在菜单栏或系统托盘中看到一个图标）。在Linux上，你可能需要用<code>systemctl start ollama</code>手动启动。</p>
<p>要检查服务是否运行，打开终端或命令提示符并输入：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查可用模型ollama list</span>
</code></pre>
<h4 data-id="heading-3">输出</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[ ]</span> &lt;-- No models
</code></pre>
<p>如果服务在运行但没有模型，你会看到一个空的模型列表，这在这个阶段是正常的。如果出现“command not found”错误，确保Ollama已正确安装。如果出现连接错误，说明服务器未运行。</p>
<p>你可以通过pull命令简单下载llama3模型。这需要一些时间和几GB的磁盘空间，因为模型很大。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 下载llama3模型ollama pull llama3</span>
</code></pre>
<p>这些命令完成后，再次运行<code>ollama list</code>，你应该能看到模型已列出。</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-comment"># 向本地Ollama API发送请求以生成文本  </span>
curl http://localhost:11434/api/generate \  
    <span class="hljs-comment"># 设置Content-Type头以指示JSON负载  </span>
    -H <span class="hljs-string">"Content-Type: application/json"</span> \  
    <span class="hljs-comment"># 提供请求数据  </span>
    -d '{  
        <span class="hljs-string">"model"</span>: <span class="hljs-string">"llama3"</span>,  
        <span class="hljs-string">"prompt"</span>: <span class="hljs-string">"Why is the sky blue?"</span>  
    }'
</code></pre>
<h4 data-id="heading-4">输出</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>  
  <span class="hljs-attr">"model"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"llama3"</span><span class="hljs-punctuation">,</span>  
  <span class="hljs-attr">"created_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-08-03T12:00:00Z"</span><span class="hljs-punctuation">,</span>  
  <span class="hljs-attr">"response"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"The sky appears blue be ... blue."</span><span class="hljs-punctuation">,</span>  
  <span class="hljs-attr">"done"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>  
<span class="hljs-punctuation">}</span>
</code></pre>
<p>如果成功，你会在终端看到一串JSON响应，确认服务器正在运行并能提供模型服务。</p>
<p>现在评估数据和LLM都准备好了，下一步是将数据转换以更好地理解LangChain中的问题。</p>
<hr/>
<h2 data-id="heading-5">基于LLMGraphTransformer的方法</h2>
<p>使用LangChain或LangGraph将原始或结构化数据转换为知识图谱的正确方法是使用它们提供的方法。最常见的方法之一是langchain_experimental库中的LLMGraphTransformer。</p>
<p>这个工具设计为一体化的解决方案：提供文本和LLM，它会处理提示和解析，返回图谱结构。</p>
<p>让我们看看它与本地llama3模型的表现如何。</p>
<p>首先，我们需要导入所有必要的组件。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 从LangChain的实验库中导入主要的图谱转换器  </span>
<span class="hljs-keyword">from</span> langchain_experimental.graph_transformers <span class="hljs-keyword">import</span> LLMGraphTransformer  
  
<span class="hljs-comment"># 导入图谱和文档的数据结构  </span>
<span class="hljs-keyword">from</span> langchain_community.graphs.graph_document <span class="hljs-keyword">import</span> GraphDocument, Node, Relationship  
<span class="hljs-keyword">from</span> langchain_core.documents <span class="hljs-keyword">import</span> Document
</code></pre>
<p>现在，初始化转换器。我们将使用之前创建的llm对象（即llama3模型）。</p>
<p>我们还需要告诉转换器我们希望为节点和关系提取哪些额外信息或“属性”。在这个例子中，我们只要求描述。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 使用llama3模型初始化LLMGraphTransformer  </span>
<span class="hljs-comment"># 指定我们希望节点和关系都有'description'属性  </span>
<span class="hljs-attr">llm_transformer</span> = LLMGraphTransformer(  
    <span class="hljs-attr">llm</span>=llm,  
    <span class="hljs-attr">node_properties</span>=[<span class="hljs-string">"description"</span>],  
    <span class="hljs-attr">relationship_properties</span>=[<span class="hljs-string">"description"</span>]  
)
</code></pre>
<p>为了让流程可重复且整洁，我们将创建一个简单的辅助函数。这个函数将接受一个文本字符串，将其包装成LangChain的Document格式，然后传递给llm_transformer以获取图谱结构。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 导入List类型用于类型提示  </span>
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>  
  
<span class="hljs-comment"># 定义一个函数，处理单个文本字符串并将其转换为图谱文档  </span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">process_text</span>(<span class="hljs-params">text: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">List</span>[GraphDocument]:  
    <span class="hljs-comment"># 从原始文本创建LangChain Document对象  </span>
    doc = Document(page_content=text)  
    <span class="hljs-comment"># 使用转换器将文档转换为图谱文档列表  </span>
    <span class="hljs-keyword">return</span> llm_transformer.convert_to_graph_documents([doc])
</code></pre>
<p>一切设置好后，是时候运行实验了。为了保持可管理性并突出核心问题，我们将处理数据集中的20篇文章样本。</p>
<p>我们将使用ThreadPoolExecutor并行运行处理，以加快工作流程。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 导入并发处理和进度条的库  </span>
from concurrent.futures import ThreadPoolExecutor, as_completed  
from tqdm import tqdm  
  
<span class="hljs-comment"># 设置并行工作者的数量和要处理的文章数量  </span>
<span class="hljs-attr">MAX_WORKERS</span> = <span class="hljs-number">10</span>  
<span class="hljs-attr">NUM_ARTICLES</span> = <span class="hljs-number">20</span>  
  
<span class="hljs-comment"># 这个列表将存储生成的图谱文档  </span>
<span class="hljs-attr">graph_documents</span> = []  
  
<span class="hljs-comment"># 使用ThreadPoolExecutor并行处理文章  </span>
with ThreadPoolExecutor(<span class="hljs-attr">max_workers</span>=MAX_WORKERS) as executor:  
    <span class="hljs-comment"># 为样本中的每篇文章提交处理任务  </span>
    <span class="hljs-attr">futures</span> = [  
        executor.submit(process_text, f<span class="hljs-string">"{row['title']} {row['text']}"</span>)  
        for i, row in news.head(NUM_ARTICLES).iterrows()  
    ]  
  
    <span class="hljs-comment"># 每当任务完成时，获取结果并添加到列表中  </span>
    for future in tqdm(  
        as_completed(futures), <span class="hljs-attr">total</span>=len(futures), desc=<span class="hljs-string">"处理文档"</span>  
    ):  
        <span class="hljs-attr">graph_document</span> = future.result()  
        graph_documents.extend(graph_document)
</code></pre>
<p>运行代码后，进度条显示所有20篇文章都已处理。</p>
<h4 data-id="heading-6">输出</h4>
<pre><code class="hljs language-bash" lang="bash">处理文档: 100%|██████████| 20/20 [01:32&lt;00:00,  4.64s/it]
</code></pre>
<hr/>
<h2 data-id="heading-7">理解LangChain的问题</h2>
<p>那么，我们得到了什么？让我们检查graph_documents列表。</p>
<pre><code class="hljs language-scss" lang="scss"># 显示图谱文档列表<span class="hljs-built_in">print</span>(graph_documents)
</code></pre>
<p>这是我们得到的输出：</p>
<h4 data-id="heading-8">输出</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[GraphDocument(nodes=[]</span>, <span class="hljs-attr">relationships</span>=[], source=Document(metadata={}, page_content=<span class="hljs-string">'XPeng Stock Rises...'</span>)),  
 GraphDocument(<span class="hljs-attr">nodes</span>=[], relationships=[], source=Document(metadata={}, page_content=<span class="hljs-string">'Ryanair sacks chief pilot...'</span>)),  
 GraphDocument(<span class="hljs-attr">nodes</span>=[], relationships=[], source=Document(metadata={}, page_content=<span class="hljs-string">'Dáil almost suspended...'</span>)),  
 GraphDocument(<span class="hljs-attr">nodes</span>=[Node(id=<span class="hljs-string">'Jude Bellingham'</span>, type=<span class="hljs-string">'Person'</span>, properties={}), Node(id=<span class="hljs-string">'Real Madrid'</span>, type=<span class="hljs-string">'Organization'</span>, properties={})], relationships=[], source=Document(metadata={}, page_content=<span class="hljs-string">'Arsenal have Rice bid rejected...'</span>)),  
 ...  
]
</code></pre>
<p>立刻就能看出问题。许多GraphDocument对象的节点和关系列表是空的。</p>
<p>这意味着对于这些文章，LLM要么生成了LangChain无法解析成有效图谱结构的输出，要么完全无法提取任何实体。</p>
<p>这就是使用较小的量化LLM进行结构化数据提取的核心挑战。它们往往难以遵循像LLMGraphTransformer这样的工具所期望的严格JSON格式。如果有一个小小的错误——比如多余的逗号、缺少引号——解析就会失败，我们什么也得不到。</p>
<p>让我们量化这个失败率。我们将统计20篇文档中有多少篇生成了空的图谱。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 初始化一个计数器，用于统计没有节点的文档  </span>
<span class="hljs-attr">empty_count</span> = <span class="hljs-number">0</span>  
  
<span class="hljs-comment"># 遍历生成的图谱文档  </span>
for doc in graph_documents:  
    <span class="hljs-comment"># 如果'nodes'列表为空，计数器加1  </span>
    if not doc.nodes:  
        empty_count += 1
</code></pre>
<p>现在，计算失败的百分比。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 计算并打印失败生成节点的文档百分比  </span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"Percentage missing: <span class="hljs-subst">{empty_count/<span class="hljs-built_in">len</span>(graph_documents)*<span class="hljs-number">100</span>}</span>"</span>)
</code></pre>
<h4 data-id="heading-9">输出</h4>
<pre><code class="hljs language-r" lang="r">Percentage <span class="hljs-built_in">missing</span><span class="hljs-operator">:</span> <span class="hljs-number">75.0</span>
</code></pre>
<p>75%的失败率。这太糟糕了。这意味着在我们的20篇文章样本中，只有5篇成功转换成了知识图谱。</p>
<p>25%的成功率对于任何生产系统来说都是不可接受的。</p>
<p>这就是问题的所在，而且这是一个常见问题。标准方法对于较小LLM略显不可预测的特性来说过于严格。</p>
<hr/>
<h2 data-id="heading-10">改进提示能解决问题吗？</h2>
<p>75%的失败率是个大问题。作为开发者，当LLM表现不佳时，我们的第一反应往往是调整提示。更好的指令应该带来更好的结果，对吧？LLMGraphTransformer内部使用默认提示，但我们无法轻易修改它。</p>
<p>所以，我们用LangChain的ChatPromptTemplate构建自己的简单链。这让我们可以完全控制发送给llama3的指令。我们可以更明确地“引导”模型每次生成正确的JSON格式。</p>
<p>我们先用Pydantic模型定义我们想要的输出结构。这是LangChain中结构化输出的常见模式。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 导入Pydantic模型以定义数据结构  </span>
from langchain_core.pydantic_v1 import BaseModel, Field  
  
<span class="hljs-comment"># 定义一个简单的节点结构  </span>
classNode(BaseModel):  
    id: <span class="hljs-attr">str</span> = Field(description=<span class="hljs-string">"节点的唯一标识符。"</span>)  
    type: <span class="hljs-attr">str</span> = Field(description=<span class="hljs-string">"节点类型（例如，Person, Organization）。"</span>)  
  
<span class="hljs-comment"># 定义一个简单的关系结构  </span>
classRelationship(BaseModel):  
    source: <span class="hljs-attr">Node</span> = Field(description=<span class="hljs-string">"关系的源节点。"</span>)  
    target: <span class="hljs-attr">Node</span> = Field(description=<span class="hljs-string">"关系的目标节点。"</span>)  
    type: <span class="hljs-attr">str</span> = Field(description=<span class="hljs-string">"关系类型（例如，WORKS_FOR）。"</span>)  
  
<span class="hljs-comment"># 定义整体图谱结构  </span>
classKnowledgeGraph(BaseModel):  
    nodes: List<span class="hljs-section">[Node]</span> = Field(<span class="hljs-attr">description</span>=<span class="hljs-string">"图谱中的节点列表。"</span>)  
    relationships: List<span class="hljs-section">[Relationship]</span> = Field(<span class="hljs-attr">description</span>=<span class="hljs-string">"图谱中的关系列表。"</span>)
</code></pre>
<p>接下来，我们创建一个更详细的提示。这个提示将明确包含从Pydantic模型生成的JSON schema，并给LLM非常具体的指令。</p>
<p>我们的目标是尽量减少错误。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 导入提示模板和输出解析器  </span>
from langchain_core.prompts import ChatPromptTemplate  
from langchain_core.output_parsers.json import JsonOutputParser  
  
<span class="hljs-comment"># 创建我们期望输出结构的实例  </span>
<span class="hljs-attr">parser</span> = JsonOutputParser(pydantic_object=KnowledgeGraph)  
  
<span class="hljs-comment"># 创建一个详细的提示模板，包含明确指令  </span>
<span class="hljs-attr">template</span> = <span class="hljs-string">"""  
你是一个顶级算法，擅长以结构化格式提取信息。  
从给定的输入文本中提取知识图谱，包括节点和关系。  
你的目标是尽可能全面，提取所有相关实体及其连接。  
  
将输出格式化为带有'nodes'和'relationships'键的JSON对象。  
严格遵循以下JSON schema：  
{schema}  
  
以下是输入文本：  
--------------------  
{text}  
--------------------  
"""</span>  
  
<span class="hljs-attr">prompt</span> = ChatPromptTemplate.from_template(  
    template,  
    <span class="hljs-attr">partial_variables</span>={<span class="hljs-string">"schema"</span>: parser.get_format_instructions()},  
)  
  
<span class="hljs-comment"># 创建完整的提取链  </span>
<span class="hljs-attr">chain</span> = prompt | llm | parser
</code></pre>
<p>这个新链比LLMGraphTransformer更明确。我们给模型提供了详细的schema和清晰的指令。让我们再次运行20篇文章样本，看看成功率是否有所提高。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 这个列表将存储新结果  </span>
<span class="hljs-attr">graph_documents_prompt_engineered</span> = []  
<span class="hljs-attr">errors</span> = []  
  
for i, row in tqdm(news.head(NUM_ARTICLES).iterrows(), <span class="hljs-attr">total</span>=NUM_ARTICLES, desc=<span class="hljs-string">"使用改进提示处理"</span>):  
    <span class="hljs-attr">text</span> = f<span class="hljs-string">"{row['title']} {row['text']}"</span>  
    try:  
        <span class="hljs-comment"># 调用我们改进的新链  </span>
        <span class="hljs-attr">graph_data</span> = chain.invoke({<span class="hljs-string">"text"</span>: text})  
          
        <span class="hljs-comment"># 手动将解析的JSON转换回GraphDocument格式  </span>
        <span class="hljs-attr">nodes</span> = [Node(id=node[<span class="hljs-string">'id'</span>], type=node[<span class="hljs-string">'type'</span>]) for node in graph_data.get(<span class="hljs-string">'nodes'</span>, [])]  
        <span class="hljs-attr">relationships</span> = [Relationship(source=Node(id=rel[<span class="hljs-string">'source'</span>][<span class="hljs-string">'id'</span>], type=rel[<span class="hljs-string">'source'</span>][<span class="hljs-string">'type'</span>]),  
                                      target=Node(id=rel[<span class="hljs-string">'target'</span>][<span class="hljs-string">'id'</span>], type=rel[<span class="hljs-string">'target'</span>][<span class="hljs-string">'type'</span>]),  
                                      type=rel[<span class="hljs-string">'type'</span>]) for rel in graph_data.get(<span class="hljs-string">'relationships'</span>, [])]  
          
        <span class="hljs-attr">doc</span> = Document(page_content=text)  
        graph_documents_prompt_engineered.append(GraphDocument(<span class="hljs-attr">nodes</span>=nodes, relationships=relationships, source=doc))  
          
    except Exception as e:  
        <span class="hljs-comment"># 如果LLM输出不是有效的JSON，解析器会失败。我们捕获这个错误。  </span>
        errors.append(str(e))  
        <span class="hljs-attr">doc</span> = Document(page_content=text)  
        graph_documents_prompt_engineered.append(GraphDocument(<span class="hljs-attr">nodes</span>=[], relationships=[], source=doc))
</code></pre>
<p>现在是关键时刻。让我们再次检查失败率。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 初始化一个计数器，用于统计没有节点的文档  </span>
empty_count_prompt_engineered = <span class="hljs-number">0</span>  
  
<span class="hljs-comment"># 遍历新结果  </span>
<span class="hljs-keyword">for</span> doc <span class="hljs-keyword">in</span> graph_documents_prompt_engineered:  
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> doc.nodes:  
        empty_count_prompt_engineered += <span class="hljs-number">1</span>  
  
<span class="hljs-comment"># 计算并打印新的失败百分比  </span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"Percentage missing with improved prompt: <span class="hljs-subst">{empty_count_prompt_engineered / <span class="hljs-built_in">len</span>(graph_documents_prompt_engineered) * <span class="hljs-number">100</span>}</span>%"</span>)  
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"Number of JSON parsing errors: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(errors)}</span>"</span>)
</code></pre>
<h4 data-id="heading-11">输出</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Percentage</span> missing <span class="hljs-keyword">with</span> improved <span class="hljs-attr">prompt</span>: <span class="hljs-number">62.0</span>%  
<span class="hljs-title class_">Number</span> <span class="hljs-keyword">of</span> <span class="hljs-title class_">JSON</span> parsing <span class="hljs-attr">errors</span>: <span class="hljs-number">13</span>
</code></pre>
<p>结果呢？失败率约为62%。虽然比最初的75%略有改进，但仍远不够可靠。我们仍然无法从20篇文章中的13篇提取图谱。JsonOutputParser每次都抛出错误，因为尽管我们尽力优化了提示，llama3仍然生成了格式错误的JSON。</p>
<p>这表明了一个根本性限制：</p>
<p>仅靠提示工程无法完全解决较小LLM生成不一致结构化输出的问题。</p>
<p>那么，如果更好的提示不是答案，那是什么？我们需要一个工具，不仅要求好的输出，还能聪明地处理LLM给出的不完美输出。这正是BAML设计来解决的问题。</p>
<p>在接下来的部分，我们将用BAML驱动的实现替换整个链，看看它带来的变化。</p>
<hr/>
<h2 data-id="heading-12">BAML的初始化和快速概览</h2>
<p>我们已经确定，即使小心进行提示工程，依赖严格的JSON解析与较小的LLM一起使用是失败的秘诀。模型很强大，但不是完美的格式化工具。</p>
<p>这正是BAML（Basically, A Made-up Language）非常重要的地方。BAML提供了两个关键优势，直接解决了我们的问题：</p>
<ul>
<li>• <strong>简化的Schema</strong>：BAML不用冗长的JSON schema，而是使用类似TypeScript的简洁语法定义数据结构。这对人类和LLM都更容易理解，减少token使用和混淆的可能性。</li>
<li>• <strong>鲁棒的解析</strong>：BAML的客户端带有“模糊”或“schema对齐”的解析器。它不期望完美的JSON，能处理LLM常见的错误，如多余的逗号、缺少引号或多余文本，仍然成功提取数据。</li>
</ul>
<p>首先，你需要安装BAML客户端和它的VS Code扩展。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装BAML客户端  </span>
pip install baml-py
</code></pre>
<p>在VS Code市场中搜索BAML并安装扩展。这个扩展很棒，因为它提供了一个交互式游乐场，让你无需每次运行Python代码即可测试提示和schema。</p>
<p>接下来，我们在一个.baml文件中定义图谱提取逻辑。将其视为LLM调用的配置文件。我们创建一个名为<code>extract_graph.baml</code>的文件：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 定义图谱中的节点，包含ID、类型和可选属性  </span>
<span class="hljs-keyword">class</span> <span class="hljs-title">SimpleNode</span> {  
  id <span class="hljs-built_in">string</span>                   <span class="hljs-comment">// 节点的唯一标识符  </span>
  type <span class="hljs-built_in">string</span>                <span class="hljs-comment">// 节点的类型/类别  </span>
  properties Properties      <span class="hljs-comment">// 与节点相关的附加属性  </span>
}  
  
<span class="hljs-comment">// 定义节点或关系的可选属性结构  </span>
<span class="hljs-keyword">class</span> <span class="hljs-title">Properties</span> {  
  description <span class="hljs-built_in">string</span>?        <span class="hljs-comment">// 可选的文本描述  </span>
}  
  
<span class="hljs-comment">// 定义两个节点之间的关系  </span>
<span class="hljs-keyword">class</span> <span class="hljs-title">SimpleRelationship</span> {  
  source_node_id <span class="hljs-built_in">string</span>      <span class="hljs-comment">// 源节点的ID  </span>
  source_node_type <span class="hljs-built_in">string</span>    <span class="hljs-comment">// 源节点的类型  </span>
  target_node_id <span class="hljs-built_in">string</span>      <span class="hljs-comment">// 目标节点的ID  </span>
  target_node_type <span class="hljs-built_in">string</span>    <span class="hljs-comment">// 目标节点的类型  </span>
  type <span class="hljs-built_in">string</span>                <span class="hljs-comment">// 关系类型（例如，"connects_to", "belongs_to"）  </span>
  properties Properties      <span class="hljs-comment">// 关系的附加属性  </span>
}  
  
<span class="hljs-comment">// 定义包含节点和关系的整体图谱  </span>
<span class="hljs-keyword">class</span> <span class="hljs-title">DynamicGraph</span> {  
  nodes SimpleNode[]               <span class="hljs-comment">// 图谱中的所有节点列表  </span>
  relationships SimpleRelationship[] <span class="hljs-comment">// 节点之间的所有关系列表  </span>
}  
  
<span class="hljs-comment">// 从原始输入字符串提取DynamicGraph的函数  </span>
<span class="hljs-function">function <span class="hljs-title">ExtractGraph</span>(<span class="hljs-params">graph: <span class="hljs-built_in">string</span></span>) -&gt; DynamicGraph</span> {  
  client Ollama                   <span class="hljs-comment">// 使用Ollama客户端解释输入  </span>
  prompt <span class="hljs-meta">#"  </span>
    Extract <span class="hljs-keyword">from</span> <span class="hljs-keyword">this</span> content:  
    {{ ctx.output_format }}  
  
    {{ graph }}                           <span class="hljs-comment">// 提示模板，指导Ollama提取图谱  </span>
}
</code></pre>
<p>类定义简单易读。<code>ExtractGraph</code>函数告诉BAML使用Ollama客户端，并提供了一个Jinja提示模板。特殊的<code>{{ ctx.output_format }}</code>变量是BAML自动注入我们简化schema定义的地方。</p>
<hr/>
<h2 data-id="heading-13">将BAML与LangChain集成</h2>
<p>现在，我们将这个BAML函数集成到LangChain工作流程中。我们需要一些辅助函数，将BAML的输出转换为LangChain和Neo4j理解的GraphDocument格式。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 导入必要的库  </span>
<span class="hljs-keyword">from</span> typing importAny, <span class="hljs-type">List</span>  
<span class="hljs-keyword">import</span> baml_client <span class="hljs-keyword">as</span> client  
<span class="hljs-keyword">from</span> langchain_community.graphs.graph_document <span class="hljs-keyword">import</span> GraphDocument, Node, Relationship  
<span class="hljs-keyword">from</span> langchain_core.runnables <span class="hljs-keyword">import</span> chain  
  
<span class="hljs-comment"># 辅助函数，正确格式化节点（例如，适当大写）  </span>
def_format_nodes(nodes: <span class="hljs-type">List</span>[Node]) -&gt; <span class="hljs-type">List</span>[Node]:  
    <span class="hljs-keyword">return</span> [  
        Node(  
            <span class="hljs-built_in">id</span>=el.<span class="hljs-built_in">id</span>.title() ifisinstance(el.<span class="hljs-built_in">id</span>, <span class="hljs-built_in">str</span>) <span class="hljs-keyword">else</span> el.<span class="hljs-built_in">id</span>,  
            <span class="hljs-built_in">type</span>=el.<span class="hljs-built_in">type</span>.capitalize() <span class="hljs-keyword">if</span> el.typeelseNone,  
            properties=el.properties  
        )  
        <span class="hljs-keyword">for</span> el <span class="hljs-keyword">in</span> nodes  
    ]  
  
<span class="hljs-comment"># 辅助函数，将BAML的关系输出映射到LangChain的Relationship对象  </span>
defmap_to_base_relationship(rel: <span class="hljs-type">Any</span>) -&gt; Relationship:  
    source = Node(<span class="hljs-built_in">id</span>=rel.source_node_id, <span class="hljs-built_in">type</span>=rel.source_node_type)  
    target = Node(<span class="hljs-built_in">id</span>=rel.target_node_id, <span class="hljs-built_in">type</span>=rel.target_node_type)  
    <span class="hljs-keyword">return</span> Relationship(  
        source=source, target=target, <span class="hljs-built_in">type</span>=rel.<span class="hljs-built_in">type</span>, properties=rel.properties  
    )  
  
<span class="hljs-comment"># 主要辅助函数，格式化所有关系  </span>
def_format_relationships(rels) -&gt; <span class="hljs-type">List</span>[Relationship]:  
    relationships = [  
        map_to_base_relationship(rel)  
        <span class="hljs-keyword">for</span> rel <span class="hljs-keyword">in</span> rels  
        <span class="hljs-keyword">if</span> rel.typeand rel.source_node_id <span class="hljs-keyword">and</span> rel.target_node_id  
    ]  
    <span class="hljs-keyword">return</span> [  
        Relationship(  
            source=_format_nodes([el.source])[<span class="hljs-number">0</span>],  
            target=_format_nodes([el.target])[<span class="hljs-number">0</span>],  
            <span class="hljs-built_in">type</span>=el.<span class="hljs-built_in">type</span>.replace(<span class="hljs-string">" "</span>, <span class="hljs-string">"_"</span>).upper(),  
            properties=el.properties,  
        )  
        <span class="hljs-keyword">for</span> el <span class="hljs-keyword">in</span> relationships  
    ]  
  
<span class="hljs-comment"># 定义一个LangChain可链式调用的函数，调用我们的BAML函数  </span>
<span class="hljs-meta">@chain  </span>
asyncdefget_graph(message):  
    graph = <span class="hljs-keyword">await</span> client.b.ExtractGraph(graph=message.content)  
    <span class="hljs-keyword">return</span> graph
</code></pre>
<p>让我们了解每个辅助函数的目的：</p>
<ul>
<li>• <code>_format_nodes(nodes)</code>：通过大写ID和类型来标准化节点格式，返回格式整洁的Node对象列表。</li>
<li>• <code>map_to_base_relationship(rel)</code>：将原始BAML关系转换为基本的LangChain Relationship对象，将源和目标包装为Node对象。</li>
<li>• <code>_format_relationships(rels)</code>：过滤无效关系，将其映射到LangChain Relationship对象，并格式化节点类型和关系类型以保持一致性。</li>
<li>• <code>get_graph(message)</code>：一个异步链函数，将输入消息发送到BAML API，调用ExtractGraph，并返回原始图谱输出。</li>
</ul>
<p>有了这些辅助函数，我们可以定义新的处理链。我们将使用一个更简单的自定义提示，因为BAML为我们处理了复杂的schema注入。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 导入提示模板  </span>
from langchain_core.prompts import ChatPromptTemplate  
  
<span class="hljs-comment"># 一个简单有效的系统提示  </span>
<span class="hljs-attr">system_prompt</span> = <span class="hljs-string">"""  
你是一个知识渊博的助手，擅长从文本中提取实体及其关系。  
你的目标是创建知识图谱。  
"""</span>  
  
<span class="hljs-comment"># 最终提示模板  </span>
<span class="hljs-attr">default_prompt</span> = ChatPromptTemplate.from_messages(  
    <span class="hljs-section">[  
        ("system", system_prompt),  
        (  
            "human",  
            (  
                "提示：确保以正确格式回答，不要包含任何解释。 "  
                "使用给定格式从以下输入中提取信息：{input}"  
            ),  
        ),  
    ]</span>  
)  
  
<span class="hljs-comment"># 定义完整的BAML驱动链  </span>
<span class="hljs-attr">chain</span> = default_prompt | llm | get_graph
</code></pre>
<p>这个提示模板指导模型提取实体和关系以构建知识图谱：</p>
<ul>
<li>• <code>system_prompt</code>：将模型角色设置为实体-关系提取器。</li>
<li>• <code>default_prompt</code>：结合系统和人类消息，带有输入文本的占位符。</li>
<li>• <code>chain</code>：通过语言模型运行提示，然后将输出传递给get_graph进行图谱提取。</li>
</ul>
<hr/>
<h2 data-id="heading-14">运行BAML实验</h2>
<p>现在是再次运行实验的时候了。这次我们将处理更大的文章批次，以真正测试新方法的可靠性。</p>
<p>由于时间限制，我在处理344篇文章后停止了执行，但这比最初的20篇样本要稳健得多。</p>
<p>在执行并行处理之前，需要一些辅助函数，我们先来写这些函数。</p>
<pre><code class="hljs language-ini" lang="ini">import asyncio  
  
<span class="hljs-comment"># 异步函数，处理单个文档  </span>
asyncdefaprocess_response(document: Document) -&gt; GraphDocument:  
    <span class="hljs-comment"># 调用我们的BAML链  </span>
    <span class="hljs-attr">resp</span> = await chain.ainvoke({<span class="hljs-string">"input"</span>: document.page_content})  
    <span class="hljs-comment"># 将响应格式化为GraphDocument  </span>
    return GraphDocument(  
        <span class="hljs-attr">nodes</span>=_format_nodes(resp.nodes),  
        <span class="hljs-attr">relationships</span>=_format_relationships(resp.relationships),  
        <span class="hljs-attr">source</span>=document,  
    )  
  
<span class="hljs-comment"># 异步函数，处理文档列表  </span>
asyncdefaconvert_to_graph_documents(  
    documents: List<span class="hljs-section">[Document]</span>,  
) -&gt; List<span class="hljs-section">[GraphDocument]</span>:  
    <span class="hljs-attr">tasks</span> = [asyncio.create_task(aprocess_response(document)) for document in documents]  
    <span class="hljs-attr">results</span> = await asyncio.gather(*tasks)  
    return results  
  
<span class="hljs-comment"># 异步函数，处理原始文本  </span>
asyncdefaprocess_text(texts: List<span class="hljs-section">[str]</span>) -&gt; List<span class="hljs-section">[GraphDocument]</span>:  
    <span class="hljs-attr">docs</span> = [Document(page_content=text) for text in texts]  
    <span class="hljs-attr">graph_docs</span> = await aconvert_to_graph_documents(docs)  
    return graph_docs
</code></pre>
<p>让我们分解每个异步函数的目的：</p>
<ul>
<li>• <code>aprocess_response</code>：处理一个文档并返回GraphDocument。</li>
<li>• <code>aconvert_to_graph_documents</code>：并行处理多个文档并返回图谱结果。</li>
<li>• <code>aprocess_text</code>：将原始文本转换为文档并提取图谱数据。</li>
</ul>
<p>现在，我们可以简单地执行主循环来处理文章。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 初始化一个空列表，存储生成的图谱文档  </span>
<span class="hljs-attr">graph_documents_baml</span> = []  
  
<span class="hljs-comment"># 设置要处理的文章总数  </span>
<span class="hljs-attr">NUM_ARTICLES_BAML</span> = <span class="hljs-number">344</span>  
  
<span class="hljs-comment"># 创建一个仅包含要处理的文章的较小DataFrame  </span>
<span class="hljs-attr">news_baml</span> = news.head(NUM_ARTICLES_BAML)  
  
<span class="hljs-comment"># 从新DataFrame中提取标题和文本  </span>
<span class="hljs-attr">titles</span> = news_baml[<span class="hljs-string">"title"</span>]  
<span class="hljs-attr">texts</span> = news_baml[<span class="hljs-string">"text"</span>]  
  
<span class="hljs-comment"># 定义每批（chunk）处理的文章数量  </span>
<span class="hljs-attr">chunk_size</span> = <span class="hljs-number">4</span>  
  
<span class="hljs-comment"># 使用tqdm显示进度条，逐批迭代文章  </span>
for i in tqdm(range(0, len(titles), chunk_size), <span class="hljs-attr">desc</span>=<span class="hljs-string">"使用BAML处理分块"</span>):  
    <span class="hljs-comment"># 获取当前分块的标题  </span>
    <span class="hljs-attr">title_chunk</span> = titles[i : i + chunk_size]  
    <span class="hljs-comment"># 获取当前分块的文本  </span>
    <span class="hljs-attr">text_chunk</span> = texts[i : i + chunk_size]  
      
    <span class="hljs-comment"># 将每篇文章的标题和文本合并为单个字符串  </span>
    <span class="hljs-attr">combined_docs</span> = [f<span class="hljs-string">"{title} {text}"</span>for title, text inzip(title_chunk, text_chunk)]  
      
    try:  
        <span class="hljs-comment"># 异步处理合并的文档以提取图谱结构  </span>
        <span class="hljs-attr">docs</span> = await aprocess_text(combined_docs)  
        <span class="hljs-comment"># 将处理好的图谱文档添加到主列表  </span>
        graph_documents_baml.extend(docs)  
    except Exception as e:  
        <span class="hljs-comment"># 处理处理过程中发生的任何错误并打印错误消息  </span>
        print(f"处理从索引{i}开始的分块时出错：{e}")  
  
<span class="hljs-comment"># 循环结束后，显示成功处理的图谱文档总数  </span>
len(graph_documents_baml)
</code></pre>
<p>这是我们得到的输出。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 图谱文档总数344</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ff4633b5ca74a788b8dc98c11f79662~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764592436&amp;x-signature=kKSDJfKg0OIf2j5wh8XJbZKTcVo%3D" alt="" loading="lazy"/></p>
<p>我们处理了344篇文章。现在，让我们运行之前做的失败分析。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 初始化一个计数器，用于统计没有节点的文档  </span>
empty_count_baml = <span class="hljs-number">0</span>  
  
<span class="hljs-comment"># 遍历BAML方法的处理结果  </span>
<span class="hljs-keyword">for</span> doc <span class="hljs-keyword">in</span> graph_documents_baml:  
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> doc.nodes:  
        empty_count_baml += <span class="hljs-number">1</span>  
  
<span class="hljs-comment"># 计算并打印新的失败百分比  </span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"Percentage missing with BAML: <span class="hljs-subst">{empty_count_baml / <span class="hljs-built_in">len</span>(graph_documents_baml) * <span class="hljs-number">100</span>}</span>%"</span>)
</code></pre>
<h4 data-id="heading-15">输出</h4>
<pre><code class="hljs language-csharp" lang="csharp">Percentage missing <span class="hljs-keyword">with</span> BAML: <span class="hljs-number">0.5813953488372093</span>%
</code></pre>
<p>这是一个惊人的结果。我们的失败率从75%下降到仅0.58%。这意味着我们的成功率现在是99.4%！</p>
<p>通过简单地将严格的LLMGraphTransformer替换为BAML驱动的链，我们从一个失败的原型转变为一个稳健的生产就绪流程。</p>
<p>这表明瓶颈不是小型LLM理解任务的能力，而是系统对完美JSON的脆弱期望。</p>
<hr/>
<h2 data-id="heading-16">使用Neo4j分析GraphRAG</h2>
<p>仅仅提取实体是不够的。GraphRAG的真正力量在于结构化这些知识，找到隐藏的联系，并总结相关信息的社区。</p>
<p>我们现在将高质量的图谱数据加载到Neo4j中，并使用图数据科学技术来丰富它。</p>
<p>首先，我们设置与Neo4j数据库的连接。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> os  
<span class="hljs-keyword">from</span> langchain_community.graphs <span class="hljs-keyword">import</span> Neo4jGraph  
  
<span class="hljs-comment"># 使用环境变量设置Neo4j连接详情  </span>
os.environ[<span class="hljs-string">"NEO4J_URI"</span>] = <span class="hljs-string">"bolt://localhost:7687"</span>  
os.environ[<span class="hljs-string">"NEO4J_USERNAME"</span>] = <span class="hljs-string">"neo4j"</span>  
os.environ[<span class="hljs-string">"NEO4J_PASSWORD"</span>] = <span class="hljs-string">"your_password"</span> <span class="hljs-comment"># 将此更改为你的密码  </span>
os.environ[<span class="hljs-string">"DATABASE"</span>] = <span class="hljs-string">"graphragdemo"</span>  
  
<span class="hljs-comment"># 初始化Neo4jGraph对象  </span>
graph = Neo4jGraph()
</code></pre>
<p>现在，我们可以将graph_documents_baml添加到数据库中。<code>baseEntityLabel=True</code>参数为所有节点添加<code>__Entity__</code>标签，便于后续查询。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 将图谱文档添加到Neo4j  </span>
graph.add_graph_documents(graph_documents_baml, <span class="hljs-attr">baseEntityLabel</span>=<span class="hljs-literal">True</span>, include_source=<span class="hljs-literal">True</span>)
</code></pre>
<p>数据加载后，我们可以运行一些Cypher查询来了解新知识图谱的结构。让我们从查看文章长度（以token计）和从中提取的实体数量之间的关系开始。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 导入绘图和数据分析的库  </span>
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt  
<span class="hljs-keyword">import</span> seaborn <span class="hljs-keyword">as</span> sns  
  
<span class="hljs-comment"># 查询Neo4j以获取每个文档的实体数量和token数量  </span>
entity_dist = graph.query(  
    <span class="hljs-string">"""  
    MATCH (d:Document)  
    RETURN d.text AS text,  
           count {(d)-[:MENTIONS]-&gt;()} AS entity_count  
    """</span>  
)  
entity_dist_df = pd.DataFrame.from_records(entity_dist)  
entity_dist_df[<span class="hljs-string">"token_count"</span>] = [  
    num_tokens_from_string(<span class="hljs-built_in">str</span>(el)) <span class="hljs-keyword">for</span> el <span class="hljs-keyword">in</span> entity_dist_df[<span class="hljs-string">"text"</span>]  
]  
  
<span class="hljs-comment"># 创建带回归线的散点图  </span>
sns.lmplot(  
    x=<span class="hljs-string">"token_count"</span>, y=<span class="hljs-string">"entity_count"</span>, data=entity_dist_df, line_kws={<span class="hljs-string">"color"</span>: <span class="hljs-string">"red"</span>}  
)  
plt.title(<span class="hljs-string">"实体数量与Token数量分布"</span>)  
plt.xlabel(<span class="hljs-string">"Token数量"</span>)  
plt.ylabel(<span class="hljs-string">"实体数量"</span>)  
plt.show()
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a053bec124964a158da6b89a53df3454~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764592436&amp;x-signature=PEaR5yQzsb5QsU4LSUpfS93WoIc%3D" alt="" loading="lazy"/></p>
<p><strong>实体数量与Token数量</strong></p>
<p>该图显示了一个明显的正相关：随着文章中token数量的增加，提取的实体数量也倾向于增加。这正是我们期望的，证实了我们的提取过程表现得很合理。</p>
<p>接下来，我们看看节点度分布。这告诉我们实体的连接程度。在现实世界的网络中，少数高度连接的节点（中心节点）是常见的。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np  
  
<span class="hljs-comment"># 查询每个实体节点的度  </span>
degree_dist = graph.query(  
    <span class="hljs-string">"""  
    MATCH (e:__Entity__)  
    RETURN count {(e)-[:!MENTIONS]-()} AS node_degree  
    """</span>  
)  
degree_dist_df = pd.DataFrame.from_records(degree_dist)  
  
<span class="hljs-comment"># 计算统计数据  </span>
mean_degree = np.mean(degree_dist_df[<span class="hljs-string">"node_degree"</span>])  
percentiles = np.percentile(degree_dist_df[<span class="hljs-string">"node_degree"</span>], [<span class="hljs-number">25</span>, <span class="hljs-number">50</span>, <span class="hljs-number">75</span>, <span class="hljs-number">90</span>])  
  
<span class="hljs-comment"># 绘制对数尺度的直方图  </span>
plt.figure(figsize=(<span class="hljs-number">12</span>, <span class="hljs-number">6</span>))  
sns.histplot(degree_dist_df[<span class="hljs-string">"node_degree"</span>], bins=<span class="hljs-number">50</span>, kde=<span class="hljs-literal">False</span>, color=<span class="hljs-string">"blue"</span>)  
plt.yscale(<span class="hljs-string">"log"</span>)  
plt.title(<span class="hljs-string">"节点度分布"</span>)  
plt.legend()  
plt.show()
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c147e0601044927ae85b4efc4e848b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764592436&amp;x-signature=sjMUDIzq5MwaORQ5SBD4wuqW%2B3A%3D" alt="" loading="lazy"/></p>
<p><strong>节点度分布</strong></p>
<p>直方图显示了一个“长尾”分布，这是知识图谱的典型特征。大多数实体只有少数连接（低度），而少数实体是高度连接的中心节点。</p>
<p>例如，第90百分位的度数是4，但最大度数是37。这表明像“USA”或“Microsoft”这样的实体可能是图谱中的中心点。</p>
<p>为了找到语义上相似的实体（即使名称不同），我们需要为它们创建向量嵌入（embedding）。嵌入是文本的数字表示。我们将为每个实体的ID和描述生成嵌入，并存储在图谱中。</p>
<p>我们将通过Ollama使用llama3模型进行嵌入，并使用LangChain的Neo4jVector来处理这个过程。</p>
<pre><code class="hljs language-ini" lang="ini">from langchain_community.vectorstores import Neo4jVector  
from langchain_ollama import OllamaEmbeddings  
  
<span class="hljs-comment"># 使用本地llama3模型创建嵌入  </span>
<span class="hljs-attr">embeddings</span> = OllamaEmbeddings(model=<span class="hljs-string">"llama3"</span>)  
  
<span class="hljs-comment"># 初始化Neo4jVector实例以管理图谱中的嵌入  </span>
<span class="hljs-attr">vector</span> = Neo4jVector.from_existing_graph(  
    embeddings,  
    <span class="hljs-attr">node_label</span>=<span class="hljs-string">"__Entity__"</span>,  
    <span class="hljs-attr">text_node_properties</span>=[<span class="hljs-string">"id"</span>, <span class="hljs-string">"description"</span>],  
    <span class="hljs-attr">embedding_node_property</span>=<span class="hljs-string">"embedding"</span>,  
    <span class="hljs-attr">database</span>=os.environ[<span class="hljs-string">"DATABASE"</span>],  
)
</code></pre>
<p>此命令遍历Neo4j中的所有<code>__Entity__</code>节点，为其属性生成嵌入，并将其存储回节点的embedding属性中。</p>
<hr/>
<h2 data-id="heading-17">查找和链接相似实体</h2>
<p>有了嵌入，我们现在可以使用k-Nearest Neighbors（kNN）算法找到向量空间中彼此接近的节点。这是识别潜在重复或高度相关实体（例如，“Man United”和“Manchester United”）的强大方法。</p>
<p>我们将使用Neo4j的Graph Data Science（GDS）库来实现这一点。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 导入GraphDataScience库  </span>
from graphdatascience import GraphDataScience  
  
<span class="hljs-comment"># --- GDS客户端初始化 ---  </span>
<span class="hljs-comment"># 初始化GraphDataScience客户端以连接到Neo4j数据库  </span>
<span class="hljs-comment"># 使用环境变量中的连接详情（URI、用户名、密码）  </span>
<span class="hljs-attr">gds</span> = GraphDataScience(  
    os.environ<span class="hljs-section">["NEO4J_URI"]</span>,  
    <span class="hljs-attr">auth</span>=(os.environ[<span class="hljs-string">"NEO4J_USERNAME"</span>], os.environ[<span class="hljs-string">"NEO4J_PASSWORD"</span>]),  
)  
<span class="hljs-comment"># 为GDS操作设置特定数据库  </span>
gds.set_database(os.environ<span class="hljs-section">["DATABASE"]</span>)  
  
<span class="hljs-comment"># --- 内存图投影 ---  </span>
<span class="hljs-comment"># 将图谱投影到内存中以便GDS算法高效处理  </span>
<span class="hljs-comment"># 此投影命名为'entities'  </span>
G, <span class="hljs-attr">result</span> = gds.graph.project(  
    "entities",                   <span class="hljs-comment"># 内存图的名称  </span>
    "__Entity__",                 <span class="hljs-comment"># 要投影的节点标签  </span>
    "*",                          <span class="hljs-comment"># 投影所有关系类型  </span>
    <span class="hljs-attr">nodeProperties</span>=[<span class="hljs-string">"embedding"</span>]  <span class="hljs-comment"># 包含节点的'embedding'属性  </span>
)  
  
<span class="hljs-comment"># --- 使用kNN计算相似性 ---  </span>
<span class="hljs-comment"># 定义创建关系的相似性阈值  </span>
<span class="hljs-attr">similarity_threshold</span> = <span class="hljs-number">0.95</span>  
  
<span class="hljs-comment"># 使用k-Nearest Neighbors（kNN）算法找到相似节点  </span>
<span class="hljs-comment"># 这会通过添加新关系“变异”内存图  </span>
gds.knn.mutate(  
    G,                                  <span class="hljs-comment"># 要修改的内存图  </span>
    <span class="hljs-attr">nodeProperties</span>=[<span class="hljs-string">"embedding"</span>],       <span class="hljs-comment"># 用于相似性计算的属性  </span>
    <span class="hljs-attr">mutateRelationshipType</span>=<span class="hljs-string">"SIMILAR"</span>,   <span class="hljs-comment"># 要创建的关系类型  </span>
    <span class="hljs-attr">mutateProperty</span>=<span class="hljs-string">"score"</span>,             <span class="hljs-comment"># 新关系上存储相似性分数的属性  </span>
    <span class="hljs-attr">similarityCutoff</span>=similarity_threshold, <span class="hljs-comment"># 过滤关系的阈值  </span>
)
</code></pre>
<p>我们为嵌入相似性分数高于0.95的节点创建<code>SIMILAR</code>关系。</p>
<p>kNN算法帮助我们找到了潜在的重复实体，但仅靠文本相似性并不完美。我们可以通过寻找不仅语义相似而且名称非常相似的实体（低“编辑距离”）进一步优化。</p>
<p>我们将查询这些候选实体，然后使用LLM做出最终的合并决定。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 根据社区和名称相似性查询潜在重复实体  </span>
word_edit_distance = <span class="hljs-number">3</span>  
potential_duplicate_candidates = graph.query(  
    <span class="hljs-string">"""  
    MATCH (e:`__Entity__`)  
    WHERE size(e.id) &gt; 4  
    WITH e.wcc AS community, collect(e) AS nodes, count(*) AS count  
    WHERE count &gt; 1  
    # ... (笔记本中的完整Cypher查询) ...  
    RETURN distinct(combinedResult)  
    """</span>,  
    params={<span class="hljs-string">"distance"</span>: word_edit_distance},  
)
</code></pre>
<p>上述代码的输出如下。</p>
<h4 data-id="heading-18">输出</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[{<span class="hljs-string">'combinedResult'</span>: [<span class="hljs-string">'David Van'</span>, <span class="hljs-string">'Davidvan'</span>]</span>},  
 {'combinedResult': [<span class="hljs-string">'Cyb003'</span>, <span class="hljs-string">'Cyb004'</span>]},  
 {'combinedResult': [<span class="hljs-string">'Delta Air Lines'</span>, <span class="hljs-string">'Delta_Air_Lines'</span>]},  
 {'combinedResult': [<span class="hljs-string">'Elon Musk'</span>, <span class="hljs-string">'Elonmusk'</span>]},  
 {'combinedResult': [<span class="hljs-string">'Market'</span>, <span class="hljs-string">'Markets'</span>]}]
</code></pre>
<p>这些看起来明显是重复的。我们现在可以使用另一个BAML函数让LLM决定保留哪个名称。运行这个分辨过程后，我们在Neo4j中合并这些节点。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># (假设'merged_entities'由LLM分辨过程创建)  </span>
graph.query(  
    <span class="hljs-string">"""  
    UNWIND $data AS candidates  
    CALL {  
      WITH candidates  
      MATCH (e:__Entity__) WHERE e.id IN candidates  
      RETURN collect(e) AS nodes  
    }  
    CALL apoc.refactor.mergeNodes(nodes, {properties: {'`.*`': 'discard'}})  
    YIELD node  
    RETURN count(*)  
    """</span>,  
    params={<span class="hljs-string">"data"</span>: merged_entities},  
)
</code></pre>
<hr/>
<h2 data-id="heading-19">使用Leiden算法进行社区检测</h2>
<p>现在是GraphRAG的核心：将相关实体分组为社区。</p>
<p>我们将投影整个图谱（包括所有原始关系）到内存中，并运行Leiden算法，这是一个最先进的社区检测算法。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 投影整个图谱，按关系频率加权  </span>
G, result = gds.graph.project(  
    <span class="hljs-string">"communities"</span>,  
    <span class="hljs-string">"__Entity__"</span>,  
    {  
        <span class="hljs-string">"_ALL_"</span>: {  
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"*"</span>,  
            <span class="hljs-string">"orientation"</span>: <span class="hljs-string">"UNDIRECTED"</span>,  
            <span class="hljs-string">"properties"</span>: {<span class="hljs-string">"weight"</span>: {<span class="hljs-string">"property"</span>: <span class="hljs-string">"*"</span>, <span class="hljs-string">"aggregation"</span>: <span class="hljs-string">"COUNT"</span>}},  
        }  
    },  
)  
  
<span class="hljs-comment"># 运行Leiden社区检测并将结果写回节点  </span>
gds.leiden.write(  
    G,  
    writeProperty=<span class="hljs-string">"communities"</span>,  
    includeIntermediateCommunities=<span class="hljs-literal">True</span>, <span class="hljs-comment"># 这会创建层次社区  </span>
    relationshipWeightProperty=<span class="hljs-string">"weight"</span>,  
)
</code></pre>
<p>这会为每个实体节点添加一个communities属性，这是一个不同粒度级别的社区ID列表（从小型紧密群体到更大的广泛主题）。</p>
<p>最后，我们通过创建<code>__Community__</code>节点并将它们链接起来，将这个层次结构具体化在图谱中。这创建了一个可浏览的主题结构。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 为社区节点创建唯一性约束  </span>
graph.query(<span class="hljs-string">"CREATE CONSTRAINT IF NOT EXISTS FOR (c:__Community__) REQUIRE c.id IS UNIQUE;"</span>)  
  
<span class="hljs-comment"># 创建社区节点并将实体和社区链接起来  </span>
graph.query(  
    <span class="hljs-string">"""  
    MATCH (e:`__Entity__`)  
    UNWIND range(0, size(e.communities) - 1 , 1) AS index  
    // ... (笔记本中的完整社区创建查询) ...  
    RETURN count(*)  
    """</span>  
)
</code></pre>
<p>这个复杂查询创建了一个多级社区结构，例如：<code>(Entity)-[:IN_COMMUNITY]-&gt;(Level_0_Community)-[:IN_COMMUNITY]-&gt;(Level_1_Community)</code>。</p>
<hr/>
<h2 data-id="heading-20">分析最终图谱结构</h2>
<p>经过所有这些工作，我们的知识图谱是什么样的？让我们分析每一级的社区规模。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 查询每一级社区的大小  </span>
community_size = graph.query(  
    <span class="hljs-string">"""  
    MATCH (c:__Community__)&lt;-[:IN_COMMUNITY*]-(e:__Entity__)  
    WITH c, count(distinct e) AS entities  
    RETURN split(c.id, '-')[0] AS level, entities  
    """</span>  
)  
  
<span class="hljs-comment"># 打印处理后的DataFrame  </span>
percentiles_df
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97ef69e292184371a2986601383edd74~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764592436&amp;x-signature=xAECYudwtDA%2F5YDFqzoF%2Ba3ssMs%3D" alt="" loading="lazy"/></p>
<p><strong>百分位DataFrame</strong></p>
<p>这个表格很重要。它显示了Leiden算法如何对我们的1,875个实体进行分组。</p>
<p>在Level 0，我们有858个小型、聚焦的社区，其中90%包含4个或更少的成员。 到Level 3，算法将这些合并为732个更大、更广泛的社区，这一级的最大社区包含77个实体。</p>
<p>这种层次结构正是我们进行有效GraphRAG所需的。我们现在可以在不同抽象级别进行检索。</p>
<hr/>
<h2 data-id="heading-21">结论</h2>
<p>结果很明显。虽然标准的LangChain工具提供了一个快速入门的途径，但它们在与较小的开源LLM一起使用时可能不稳定且不可靠。</p>
<p>通过引入BAML，我们解决了过于复杂的提示和严格JSON解析的核心问题。结果是将成功率从25%大幅提升到超过99%，将一个失败的实验转变为一个稳健且可扩展的知识图谱构建流程。</p>
<p>以下是我们采取的关键步骤的快速回顾：</p>
<ol>
<li>我们从准备新闻文章数据集和使用Ollama设置本地llama3模型开始。</li>
<li>使用LangChain的LLMGraphTransformer进行的第一次测试有75%的失败率，因为严格的JSON解析。</li>
<li>尝试通过高级提示工程修复，失败率仅略微改善到约62%。</li>
<li>然后我们集成了BAML，利用其简化的schema和鲁棒解析器实现了99.4%的图谱提取成功率。</li>
<li>将高质量的图谱数据加载到Neo4j中进行结构化和分析。</li>
<li>通过为所有实体生成向量嵌入来丰富图谱，捕捉语义含义。</li>
<li>使用k-Nearest Neighbors（kNN）算法识别并链接语义相似的节点。</li>
<li>进一步通过LLM智能查找和合并重复实体来优化图谱。</li>
<li>最后，应用Leiden算法将实体组织成多级社区层次结构，为高级GraphRAG奠定了基础。</li>
</ol>
<p>这种使用LangChain进行强大编排和BAML进行可靠结构化输出的方法是构建强大且成本效益高的AI应用的制胜组合。</p>
<h2 data-id="heading-22">学习资源推荐</h2>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TS 项目升级 React 18 到 19 的一些事情]]></title>    <link>https://juejin.cn/post/7576026767372451859</link>    <guid>https://juejin.cn/post/7576026767372451859</guid>    <pubDate>2025-11-24T12:33:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576026767372451859" data-draft-id="7576223441683726399" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TS 项目升级 React 18 到 19 的一些事情"/> <meta itemprop="keywords" content="前端,React.js,TypeScript"/> <meta itemprop="datePublished" content="2025-11-24T12:33:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="驳是"/> <meta itemprop="url" content="https://juejin.cn/user/442445375748621"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TS 项目升级 React 18 到 19 的一些事情
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/442445375748621/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    驳是
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T12:33:38.000Z" title="Mon Nov 24 2025 12:33:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{font-family:-apple-system,BlinkMacSystemFont,PingFang SC,Helvetica Neue,Helvetica,Arial,sans-serif;word-break:break-word;line-height:1.75;font-weight:200;font-size:16px;overflow-x:hidden;color:#666;letter-spacing:.5px}.markdown-body a{text-decoration:none;color:#0064c8;position:relative}.markdown-body a:after{content:"";position:absolute;bottom:-2px;left:0;width:100%;height:1px;background-color:rgba(0,100,200,.7);transform:scale(0);transition:all .4s ease-in-out}.markdown-body a:link:hover:after{transform:scale(1)}.markdown-body code{padding:2px 4px;font-size:.9em;font-family:Menlo,Monaco,Consolas,Courier New,monospace;border-radius:2px;background-color:rgba(0,46,70,.0431);color:#39f}.markdown-body strong{font-weight:400}.markdown-body em{color:#ff6a00}.markdown-body del,.markdown-body s{color:#bbb}.markdown-body small{font-size:.8em;color:#bbb}.markdown-body kbd{margin:0 .1em;padding:5px 8px 3px;border:1px solid #d1d5d9;border-radius:3px;box-shadow:0 1px 0 0 #e3e4e6,inset 0 0 0 2px #fff;background-color:#eee;font-weight:600;font-size:.8em;font-family:Arial,Helvetica Neue,Helvetica,sans-serif;white-space:nowrap;color:#666}.markdown-body kbd:first-child{margin-left:0}.markdown-body kbd:last-child{margin-right:0}.markdown-body img{display:block;border:0;max-width:calc(100% - 20px);min-width:20px;min-height:20px;margin:0 10px;box-shadow:0 2px 8px 2px rgba(0,0,0,.2);transition:all .25s ease-in-out}.markdown-body img:hover{transform:translateY(-4px)}.markdown-body blockquote,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{line-height:inherit;font-size:inherit;color:inherit}.markdown-body blockquote:first-child,.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child,.markdown-body ol:first-child,.markdown-body p:first-child,.markdown-body pre:first-child,.markdown-body table:first-child,.markdown-body ul:first-child{margin-top:0}.markdown-body blockquote:last-child,.markdown-body h1:last-child,.markdown-body h2:last-child,.markdown-body h3:last-child,.markdown-body h4:last-child,.markdown-body h5:last-child,.markdown-body h6:last-child,.markdown-body ol:last-child,.markdown-body p:last-child,.markdown-body pre:last-child,.markdown-body table:last-child,.markdown-body ul:last-child{margin-bottom:0}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:1.6em 0 .6em;color:#333;font-weight:400;position:relative}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{position:absolute;left:-2em}.markdown-body h1{font-size:1.75em}.markdown-body h1:before{content:"#"}.markdown-body h1:first-child{margin-top:0}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.35em}.markdown-body h4{font-size:1.2em}.markdown-body h5{font-size:1.1em}.markdown-body h6{font-size:1em}.markdown-body blockquote,.markdown-body ol,.markdown-body pre,.markdown-body table,.markdown-body ul{margin:1em 0}.markdown-body p{margin:.7em 0;word-break:break-word}.markdown-body pre{padding:8px 12px;color:#666;background-color:rgba(0,46,70,.0431);border:1px solid #ebebeb;tab-size:4;white-space:pre-wrap;line-height:1.4}.markdown-body pre code{color:inherit;background-color:transparent;padding:0}.markdown-body ol,.markdown-body ul{margin:1em 0 1em 2em;padding:0;line-height:1.5!important;font-size:inherit;color:inherit}.markdown-body ol:first-child,.markdown-body ul:first-child{margin-top:0}.markdown-body ol:last-child,.markdown-body ul:last-child{margin-bottom:0}.markdown-body ol li,.markdown-body ul li{margin:.5em 0;list-style:inherit}.markdown-body ul{list-style:disc outside}.markdown-body ul ul{list-style-type:circle}.markdown-body ul ul ul{list-style-type:square}.markdown-body ol{list-style:decimal outside}.markdown-body ol ol{list-style-type:lower-alpha}.markdown-body ol ol ol{list-style-type:lower-roman}.markdown-body blockquote{font-size:.9em;padding:8px 20px 8px 15px;color:#666;border-left:5px solid rgba(0,100,200,.7);background-color:rgba(0,100,200,.1)}.markdown-body table{border-collapse:collapse;border-spacing:0;max-width:100%;min-width:50%;word-wrap:break-word;color:inherit}.markdown-body table thead tr{background-color:#f4f6f7}.markdown-body table td,.markdown-body table th{padding:4px 16px;font-size:.95em;text-align:left;color:inherit;border:0;min-width:72px}.markdown-body table td[align=center],.markdown-body table th[align=center]{text-align:center}.markdown-body table td[align=right],.markdown-body table th[align=right]{text-align:right}.markdown-body table th{border-bottom:2px solid #e3e4e6;color:#333;font-weight:400;white-space:nowrap}.markdown-body table td{border-bottom:1px solid #ebebeb}.markdown-body hr{margin:1.5em 0;padding:0;border:0;background:linear-gradient(90deg,rgba(0,46,70,.0431),#ebebeb 50%,rgba(0,46,70,.0431));height:1px}.markdown-body br{content:"";display:block}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18e1c0f0a29a4392a7cf9d0afe6e3785~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6amz5piv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764592418&amp;x-signature=%2B7IQG%2FMZSLkWzxIFK7ZpTiC6hYM%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">🎙️ 前言</h2>
<p>React 19 出来已经快有一年了，<a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Fblog%2F2024%2F12%2F05%2Freact-19" target="_blank" title="https://react.dev/blog/2024/12/05/react-19" ref="nofollow noopener noreferrer">公告</a> 在 24 年 12 月就出了，然即使身为「升级狂魔」的我，也没有第一时间进行升级。只因为我深知 React 的每次大版本升级，都将在社区掀起一阵腥风血雨，从构建到组件库再到各种 Linter 都需要紧跟其脚步，只好一等再等。</p>
<p>其实主要是因为项目依赖了 Antd，而 Antd 5 并没有官方宣称支持 React 19，所以只好竭力按耐住渴望升级的欲火。昨天（2025/11/23），距离 React 19 第一版过去了将近整整一年（真墨迹...），看到 Antd 推了 6.0.0，时机终于到了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/002ddc13ba074db89c37475ff15df1c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6amz5piv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764592418&amp;x-signature=fb%2FofaFdYRpWmuiy%2BbLN1vqw9n4%3D" alt="" loading="lazy"/></p>
<p>React 19 升级公告的具体内容这里就不啰嗦了，已经有好多人聊过，个人比较关注的有以下几个：</p>
<ol>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Fblog%2F2024%2F12%2F05%2Freact-19%23ref-as-a-prop" target="_blank" title="https://react.dev/blog/2024/12/05/react-19#ref-as-a-prop" ref="nofollow noopener noreferrer"><code>forwardRef</code> 终于开始要退出历史舞台</a> 🎉🎉🎉</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Fblog%2F2024%2F12%2F05%2Freact-19%23context-as-a-provider" target="_blank" title="https://react.dev/blog/2024/12/05/react-19#context-as-a-provider" ref="nofollow noopener noreferrer"><code>Context.Provider</code> 可以直接用 <code>Context</code> 代替</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Fblog%2F2024%2F12%2F05%2Freact-19%23new-feature-use" target="_blank" title="https://react.dev/blog/2024/12/05/react-19#new-feature-use" ref="nofollow noopener noreferrer">use</a>，注意它不是 <code>hook</code></li>
<li>Ref 相关的类型变更</li>
</ol>
<h2 data-id="heading-1">🪁 如何升级</h2>
<p>官方提供了 <a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Fblog%2F2024%2F04%2F25%2Freact-19-upgrade-guide" target="_blank" title="https://react.dev/blog/2024/04/25/react-19-upgrade-guide" ref="nofollow noopener noreferrer">升级文档</a>，提到升级工具：</p>
<pre><code class="hljs language-shell" lang="shell">npx codemod@latest react/19/migration-recipe
</code></pre>
<p>以我的项目来讲，可能由于一直关注依赖升级，这一步并没有动任何代码。</p>
<p>作为 TS 项目，还需要：</p>
<pre><code class="hljs language-shell" lang="shell">npx types-react-codemod@latest preset-19 ./path-to-app
</code></pre>
<p>然而它会给所有的 <code>ReactElement</code> 改成 <code>ReactElement&lt;any&gt;</code>，还得叫我替换还原回来。</p>
<h2 data-id="heading-2">👻 实际问题</h2>
<p>接下来主要来讲一下我在升级中遇到的问题，主要是 TS 的类型问题。</p>
<h3 data-id="heading-3">forwardRef</h3>
<p>终于可以用 <code>props.ref</code> 代替臭名昭著的 <code>forwardRef</code>，我认为这是最令人欣喜的新特性。被 <code>forwardRef</code> 折磨了这许久，终于 React 要干掉它了。</p>
<p>但对于 TS 代码来说，可能会遇到一些问题，比如我之前这么写（<code>ref</code> 没有写成可选参数）：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> <span class="hljs-title function_">MyComp</span>(<span class="hljs-params">props: MyCompProps, ref: Ref&lt;MyCompRef&gt;</span>): <span class="hljs-title class_">ReactElement</span>;
</code></pre>
<p>升级 19 后会报错签名不符，如下图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0efb7172a8c24ec189468a2ab870b0e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6amz5piv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764592418&amp;x-signature=mMk6ZnC1oxiRQkBbski9dvbWhDY%3D" alt="" loading="lazy"/></p>
<p>这种情况，如果是 NPM 包，建议先发个兼容包，改 <code>ref</code> 为可选即可（然后再发最低依赖为 19 的大版本包）：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> <span class="hljs-title function_">MyComp</span>(<span class="hljs-params">props: MyCompProps, ref?: Ref&lt;MyCompRef&gt;</span>): <span class="hljs-title class_">ReactElement</span>;
</code></pre>
<h3 data-id="heading-4">useReducer</h3>
<p>会写 TS 的人都知道，同一个方法，使用泛型的话，可以有多种不同的定义方式，好的定义能让开发者事半功倍。</p>
<p><code>useReducer</code> 的类型定义就变了，其实升级文档里有提到，但心急的开发者估计会看漏，<a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Fblog%2F2024%2F04%2F25%2Freact-19-upgrade-guide%23better-usereducer-typings" target="_blank" title="https://react.dev/blog/2024/04/25/react-19-upgrade-guide#better-usereducer-typings" ref="nofollow noopener noreferrer">Better useReducer typings</a>，而且 Codemod 工具并不会修正这里的问题。</p>
<p>所以对于类型定义完整的 TS 项目，会有冲击，导致构建失败。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// React 18 的 `useReducer` 5 个重载</span>
<span class="hljs-keyword">function</span> useReducer&lt;R <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ReducerWithoutAction</span>&lt;<span class="hljs-built_in">any</span>&gt;, I&gt;(
    <span class="hljs-attr">reducer</span>: R,
    <span class="hljs-attr">initializerArg</span>: I,
    <span class="hljs-attr">initializer</span>: <span class="hljs-function">(<span class="hljs-params">arg: I</span>) =&gt;</span> <span class="hljs-title class_">ReducerStateWithoutAction</span>&lt;R&gt;
): [<span class="hljs-title class_">ReducerStateWithoutAction</span>&lt;R&gt;, <span class="hljs-title class_">DispatchWithoutAction</span>];

<span class="hljs-keyword">function</span> useReducer&lt;R <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ReducerWithoutAction</span>&lt;<span class="hljs-built_in">any</span>&gt;&gt;(
    <span class="hljs-attr">reducer</span>: R,
    <span class="hljs-attr">initializerArg</span>: <span class="hljs-title class_">ReducerStateWithoutAction</span>&lt;R&gt;,
    initializer?: <span class="hljs-literal">undefined</span>
): [<span class="hljs-title class_">ReducerStateWithoutAction</span>&lt;R&gt;, <span class="hljs-title class_">DispatchWithoutAction</span>];

<span class="hljs-keyword">function</span> useReducer&lt;R <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Reducer</span>&lt;<span class="hljs-built_in">any</span>, <span class="hljs-built_in">any</span>&gt;, I&gt;(
    <span class="hljs-attr">reducer</span>: R,
    <span class="hljs-attr">initializerArg</span>: I &amp; <span class="hljs-title class_">ReducerState</span>&lt;R&gt;,
    <span class="hljs-attr">initializer</span>: <span class="hljs-function">(<span class="hljs-params">arg: I &amp; ReducerState&lt;R&gt;</span>) =&gt;</span> <span class="hljs-title class_">ReducerState</span>&lt;R&gt;
): [<span class="hljs-title class_">ReducerState</span>&lt;R&gt;, <span class="hljs-title class_">Dispatch</span>&lt;<span class="hljs-title class_">ReducerAction</span>&lt;R&gt;&gt;];

<span class="hljs-keyword">function</span> useReducer&lt;R <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Reducer</span>&lt;<span class="hljs-built_in">any</span>, <span class="hljs-built_in">any</span>&gt;, I&gt;(
    <span class="hljs-attr">reducer</span>: R,
    <span class="hljs-attr">initializerArg</span>: I,
    <span class="hljs-attr">initializer</span>: <span class="hljs-function">(<span class="hljs-params">arg: I</span>) =&gt;</span> <span class="hljs-title class_">ReducerState</span>&lt;R&gt;
): [<span class="hljs-title class_">ReducerState</span>&lt;R&gt;, <span class="hljs-title class_">Dispatch</span>&lt;<span class="hljs-title class_">ReducerAction</span>&lt;R&gt;&gt;];

<span class="hljs-keyword">function</span> useReducer&lt;R <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Reducer</span>&lt;<span class="hljs-built_in">any</span>, <span class="hljs-built_in">any</span>&gt;&gt;(
    <span class="hljs-attr">reducer</span>: R,
    <span class="hljs-attr">initialState</span>: <span class="hljs-title class_">ReducerState</span>&lt;R&gt;,
    initializer?: <span class="hljs-literal">undefined</span>
): [<span class="hljs-title class_">ReducerState</span>&lt;R&gt;, <span class="hljs-title class_">Dispatch</span>&lt;<span class="hljs-title class_">ReducerAction</span>&lt;R&gt;&gt;];

<span class="hljs-comment">// React 19 的 `useReducer` 只剩下了两种</span>
<span class="hljs-keyword">function</span> useReducer&lt;S, A <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AnyActionArg</span>&gt;(
    <span class="hljs-attr">reducer</span>: <span class="hljs-function">(<span class="hljs-params">prevState: S, ...args: A</span>) =&gt;</span> S,
    <span class="hljs-attr">initialState</span>: S
): [S, <span class="hljs-title class_">ActionDispatch</span>&lt;A&gt;];

<span class="hljs-keyword">function</span> useReducer&lt;S, I, A <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AnyActionArg</span>&gt;(
    <span class="hljs-attr">reducer</span>: <span class="hljs-function">(<span class="hljs-params">prevState: S, ...args: A</span>) =&gt;</span> S,
    <span class="hljs-attr">initialArg</span>: I,
    <span class="hljs-attr">init</span>: <span class="hljs-function">(<span class="hljs-params">i: I</span>) =&gt;</span> S
): [S, <span class="hljs-title class_">ActionDispatch</span>&lt;A&gt;];
</code></pre>
<p>主要区别是，19 把之前的 <code>R</code>（Reducer）拆成了 <code>S</code>（State） 和 <code>A</code>（Action）。</p>
<p>于是之前能跑通的构建失败了：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/734c6273d195443393e8f6b5d86bdd78~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6amz5piv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764592418&amp;x-signature=n4jcFFEqEzRloCRtYzD5Bb7qqCA%3D" alt="" loading="lazy"/></p>
<p>这种情况就得自己改了：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/536c678bd45a4a469975e7dd3b679a50~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6amz5piv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764592418&amp;x-signature=Xb%2BxNGJPK%2BPJGqMokCkfBSHSrt4%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-deletion">-const [state, dispatch] = useReducer&lt;TModelReducer, null&gt;(reducer, null, createInitialState);</span>
<span class="hljs-addition">+const [state, dispatch] = useReducer&lt;IModelState, null, [TModelAction]&gt;(reducer, null, createInitialState);</span>
</code></pre>
<p>注意，泛型第三个参数必须是元组，需要中括号括起来（个人认为他们可以优化更彻底些，不需要是元组）。</p>
<h3 data-id="heading-5">useRef</h3>
<p><code>useRef</code> 类型定义也变了，<a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Fblog%2F2024%2F04%2F25%2Freact-19-upgrade-guide%23useref-requires-argument" target="_blank" title="https://react.dev/blog/2024/04/25/react-19-upgrade-guide#useref-requires-argument" ref="nofollow noopener noreferrer">参数变成了必填</a>，也会导致构建失败：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// React 18</span>
<span class="hljs-keyword">function</span> useRef&lt;T&gt;(<span class="hljs-attr">initialValue</span>: T): <span class="hljs-title class_">MutableRefObject</span>&lt;T&gt;;
<span class="hljs-keyword">function</span> useRef&lt;T&gt;(<span class="hljs-attr">initialValue</span>: T | <span class="hljs-literal">null</span>): <span class="hljs-title class_">RefObject</span>&lt;T&gt;;
<span class="hljs-keyword">function</span> useRef&lt;T = <span class="hljs-literal">undefined</span>&gt;(initialValue?: <span class="hljs-literal">undefined</span>): <span class="hljs-title class_">MutableRefObject</span>&lt;T | <span class="hljs-literal">undefined</span>&gt;;
<span class="hljs-comment">// React 19</span>
<span class="hljs-keyword">function</span> useRef&lt;T&gt;(<span class="hljs-attr">initialValue</span>: T): <span class="hljs-title class_">RefObject</span>&lt;T&gt;;  
<span class="hljs-keyword">function</span> useRef&lt;T&gt;(<span class="hljs-attr">initialValue</span>: T | <span class="hljs-literal">null</span>): <span class="hljs-title class_">RefObject</span>&lt;T | <span class="hljs-literal">null</span>&gt;;  
<span class="hljs-keyword">function</span> useRef&lt;T&gt;(<span class="hljs-attr">initialValue</span>: T | <span class="hljs-literal">undefined</span>): <span class="hljs-title class_">RefObject</span>&lt;T | <span class="hljs-literal">undefined</span>&gt;;
</code></pre>
<p>这意味着，需要将所有的空 <code>useRef&lt;T&gt;()</code> 加上默认值，哪怕传的是 <code>undefined</code> 也要写一下。</p>
<p>不过有一个好处，就是以前写成 <code>useRef&lt;T | null&gt;(null)</code> 的，现在只需要写 <code>useRef&lt;T&gt;(null)</code>，见下图 React 18 和 19 下 IDE 类型推导的区别：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba6ffbde95e14ce196302fa670b4a4fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6amz5piv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764592418&amp;x-signature=L7Gwf09Lk2Wp8LhZnBZY%2Bqy4GIk%3D" alt="" loading="lazy"/></p>
<p>以前的 <code>RefObject&lt;T&gt;</code> 其实是现在的 <code>RefObject&lt;T | null&gt;</code>，现在的 <code>RefObject&lt;T&gt;</code> 是真的 <code>RefObject&lt;T&gt;</code>。</p>
<h3 data-id="heading-6">Ref 的各种类型</h3>
<p>上面的 <code>useRef</code> 类型定义，你可能已经注意到 <code>MutableRefObject</code> 的地方都被换成了 <code>RefObject</code>。以下是两个版本跟 Ref 有关的类型定义剪影：</p>
<p>React 18：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">RefObject</span>&lt;T&gt; {
  <span class="hljs-keyword">readonly</span> <span class="hljs-attr">current</span>: T | <span class="hljs-literal">null</span>;
}
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">MutableRefObject</span>&lt;T&gt; {
  <span class="hljs-attr">current</span>: T;
}
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Ref</span>&lt;T&gt; = <span class="hljs-title class_">RefCallback</span>&lt;T&gt; | <span class="hljs-title class_">RefObject</span>&lt;T&gt; | <span class="hljs-literal">null</span>;
<span class="hljs-keyword">type</span> <span class="hljs-title class_">ForwardedRef</span>&lt;T&gt; = (<span class="hljs-function">(<span class="hljs-params">instance: T | <span class="hljs-literal">null</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>) | <span class="hljs-title class_">MutableRefObject</span>&lt;T | <span class="hljs-literal">null</span>&gt; | <span class="hljs-literal">null</span>;
</code></pre>
<p>React 19：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">RefObject</span>&lt;T&gt; {
  <span class="hljs-attr">current</span>: T; <span class="hljs-comment">// 🎉 去掉 readonly</span>
}
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">MutableRefObject</span>&lt;T&gt; { <span class="hljs-comment">// 💥 deprecated</span>
  <span class="hljs-attr">current</span>: T;
}
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Ref</span>&lt;T&gt; = <span class="hljs-title class_">RefCallback</span>&lt;T&gt; | <span class="hljs-title class_">RefObject</span>&lt;T | <span class="hljs-literal">null</span>&gt; | <span class="hljs-literal">null</span>;
<span class="hljs-keyword">type</span> <span class="hljs-title class_">ForwardedRef</span>&lt;T&gt; = (<span class="hljs-function">(<span class="hljs-params">instance: T | <span class="hljs-literal">null</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>) | <span class="hljs-title class_">RefObject</span>&lt;T | <span class="hljs-literal">null</span>&gt; | <span class="hljs-literal">null</span>;
</code></pre>
<p>变化：</p>
<ol>
<li><code>RefObject</code> 不再只读（即不再需要 <code>MutableRefObject</code>），可以全局替换 <code>MutableRefObject</code> → <code>RefObject</code></li>
<li><code>ForwardedRef</code> 虽然未标记 <code>deprecated</code>，但从其实现来看，可以全局替换 <code>ForwardedRef</code>→ <code>Ref</code></li>
</ol>
<p>终于不再纠结那么多的 Ref 类型了。</p>
<h2 data-id="heading-7">☄️ 从 useImperativeHandle 再看 forwardRef</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Freference%2Freact%2FuseImperativeHandle" target="_blank" title="https://react.dev/reference/react/useImperativeHandle" ref="nofollow noopener noreferrer">useImperativeHandle</a> 是一个可能相对比较冷门的 Hook，但它真的很管用，可以让父组件调用子组件提供的方法，从而避免非常不 React 的写法（比如使用事件通知这种耦合性、不确定性比较强的写法）。</p>
<p>当一个组件复杂到一定程度的时候，为了避免 Props Drilling 的问题，我通常会用 <code>Context</code> 作为组件内全局数据状态管理的工具。所有与 <code>props</code>、<code>state</code>、<code>effect</code> 相关的逻辑通通在一个不涉及 UI 的「Model」层进行封装，UI 与 Model 之间惟一的桥梁就是 Hooks。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/88be0b394a3345ea8b9e353d1d019cef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6amz5piv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764592418&amp;x-signature=66zbvvT0LYegEFFN2yEP%2BQB200A%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">React ≤ 18 的绕脑写法</h3>
<p>React 19 之前，这种模式在使用 <code>useImperativeHandle</code> 的时候会写出很绕的代码，为了 <code>ref</code> 能够最终有效，我需要至少写两次 <code>forwardRef</code>，而且比较晦涩，这让我苦不堪言（所以我之前对于写 <code>useImperativeHandle</code> 多少是有些惧怕的）。</p>
<p>React 18 及之前，可能需要这么写。</p>
<p>组件 Model + UI：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">ReactElement</span>,
  <span class="hljs-title class_">ForwardedRef</span>,
  forwardRef
} <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">import</span> <span class="hljs-title class_">Model</span>, {
  <span class="hljs-title class_">ModelProps</span>,
  <span class="hljs-title class_">ImperativeRef</span>
} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Ui</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../ui'</span>;
  
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">forwardRef</span>(<span class="hljs-keyword">function</span> <span class="hljs-title function_">TheComponent</span>(<span class="hljs-params">props: ModelProps, ref: ForwardedRef&lt;ImperativeRef&gt;</span>): <span class="hljs-title class_">ReactElement</span> {
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Model</span> {<span class="hljs-attr">...props</span>}&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Ui</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{ref}</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">Model</span>&gt;</span></span>;
});
</code></pre>
<p>UI 层：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">ReactElement</span>,
  <span class="hljs-title class_">ForwardedRef</span>,
  useImperativeHandle,
  forwardRef
} <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">import</span> {  
  <span class="hljs-title class_">ImperativeRef</span>,
  useRefImperative
} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">forwardRef</span>(<span class="hljs-keyword">function</span> <span class="hljs-title function_">Ui</span>(<span class="hljs-params">_props: <span class="hljs-built_in">unknown</span>, ref: ForwardedRef&lt;ImperativeRef&gt;</span>): <span class="hljs-title class_">ReactElement</span> {
  <span class="hljs-keyword">const</span> imperativeRef = <span class="hljs-title function_">useRefImperative</span>();
  
  <span class="hljs-title function_">useImperativeHandle</span>(ref, <span class="hljs-function">() =&gt;</span> imperativeRef, [imperativeRef]);
  
  <span class="hljs-keyword">return</span> <span class="xml">&lt;... /&gt;</span>;
});
</code></pre>
<p>很绕，是不是？需要在组件最外层，把 <code>ref</code> 传递到 UI 层，然后再在 UI 层 <code>useImperativeHandle</code>，为此，原本可以无参的 UI 组件，甚至还要写个 <code>_props: unknown</code>。</p>
<p>但凡脑子不好一点都想不出这么绕的法子 😳。但为了能够在正确的位置使用 <code>useImperativeHandle</code>，这的确是我能想到的比较「高明」的办法了。</p>
<h3 data-id="heading-9">React 19 的写法</h3>
<p>React 19 变得相当简单，<code>forwardRef</code> 全部干掉后，改造 Model 内部的 <code>useRefImperative</code>，使 Model 更内聚：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> {  
  useImperativeHandle  
} <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;  
  
<span class="hljs-keyword">import</span> {  
  <span class="hljs-title class_">IImperativeRef</span>  
} <span class="hljs-keyword">from</span> <span class="hljs-string">'../types'</span>;  
  
<span class="hljs-keyword">import</span> useModelProps <span class="hljs-keyword">from</span> <span class="hljs-string">'./_use-model-props'</span>;  
  
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useRefImperative</span>(<span class="hljs-params"/>): <span class="hljs-built_in">void</span> {  
  <span class="hljs-keyword">const</span> {  
    ref  
  } = <span class="hljs-title function_">useModelProps</span>();  
    
  <span class="hljs-title function_">useImperativeHandle</span>(ref, (): <span class="hljs-function"><span class="hljs-params">IImperativeRef</span> =&gt;</span> ({  
    ...  
  }), [...]);  
}
</code></pre>
<p>使用的话，就只需要在 UI 组件，简单调用一下 <code>useRefImperative</code> 即可：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">ReactElement</span>
} <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">import</span> {  
  useRefImperative
} <span class="hljs-keyword">from</span> <span class="hljs-string">'../model'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Ui</span>(<span class="hljs-params"/>): <span class="hljs-title class_">ReactElement</span> {
  <span class="hljs-title function_">useRefImperative</span>();
  
  <span class="hljs-keyword">return</span> <span class="xml">&lt;... /&gt;</span>;
});
</code></pre>
<p>至此，我们再也不需要惧怕写 <code>useImperativeHandle</code> 了。</p>
<h2 data-id="heading-10">🐌 组件库怎么办</h2>
<p>React 目前尚未对 <code>forwardRef</code> 标记 <code>deprecated</code>，但也说不久的将来会这么做。</p>
<p>组件库就会比较尴尬，考虑到存量应用，组件库没法在升级 React 19 后直接废弃 <code>forwardRef</code>。也就是说，组件库一时间还没办法享受弃用 <code>forwardRef</code> 的带来的红利，除非组件库启用大版本不兼容升级。</p>
<p>拿 Antd 举例，Antd 5 支持的最小 React 版本是 16.9.0，Antd 6 却并没有直接提升到 React 19，而仅仅声明最小 React 版本是 18。所以，它的实现依然使用了 <code>forwardRef</code>（而且只能用 <code>forwardRef</code>）。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/81b671308c65484bb6f0ce1860aadf2f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6amz5piv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764592418&amp;x-signature=TX0m6bgKcp4FDM6H8YP%2BIPzyFQk%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-11">🪭 总结</h2>
<p>这次的升级，BREAK CHANGE 不多，总的来说比较平滑顺畅，我用了 1 天的时间升级完了五个项目，总结下来就这些：</p>
<ol>
<li>所有的 <code>forwardRef</code> 可以改成 <code>props.ref</code>（如果是 NPM 包，需要先兼容，后发大版本）</li>
<li><code>useReducer</code> 的类型为 BREAK CHANGE，但也只需要改类型，修改相对简单</li>
<li><code>useRef&lt;T&gt;()</code> 传空将导致构建失败，可改成 <code>useRef&lt;T&gt;(null)</code> 或  <code>useRef&lt;T&gt;(undefined)</code></li>
<li><code>MutableRefObject</code> → <code>RefObject</code></li>
<li><code>ForwardedRef</code>→ <code>Ref</code></li>
<li><code>Context.Provider</code>→ <code>Context</code></li>
<li>组件库，除非声明支持最小 React 版本为 19，不要杀 <code>fowardRef</code>（也不要用 <code>props.ref</code>）</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[打造生产级复杂 RAG 系统：LangChain, LangGraph 与 RAGAS 实战指南]]></title>    <link>https://juejin.cn/post/7576129509934530579</link>    <guid>https://juejin.cn/post/7576129509934530579</guid>    <pubDate>2025-11-24T12:38:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576129509934530579" data-draft-id="7576129509934514195" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="打造生产级复杂 RAG 系统：LangChain, LangGraph 与 RAGAS 实战指南"/> <meta itemprop="keywords" content="LangChain,LLM,Agent"/> <meta itemprop="datePublished" content="2025-11-24T12:38:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AI大模型"/> <meta itemprop="url" content="https://juejin.cn/user/3817967696221534"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            打造生产级复杂 RAG 系统：LangChain, LangGraph 与 RAGAS 实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3817967696221534/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AI大模型
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T12:38:54.000Z" title="Mon Nov 24 2025 12:38:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读18分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote>
<p>在构建<strong>生产环境就绪</strong>的 RAG 系统时，我们需要的远不止简单的“检索-生成”步骤。一个健壮的 RAG 必须具备数据治理、灵活的检索策略、<strong>反幻觉 (Anti-Hallucination)</strong>  机制、以及自我优化的<strong>规划与执行 (Planning and Execution)</strong>  能力。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ffd32e4ceb748c3af5b38ff60e10481~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764592734&amp;x-signature=3LEh7M9WQqatKXtWVqpn%2B%2FpxkU4%3D" alt="" loading="lazy"/></p>
<p>本文将深入探讨如何结合 <strong>LangChain、LangGraph</strong> 和 <strong>RAGAS</strong> 这一套强大的工具链，来搭建一个全栈 RAG 系统。我们将模拟真实世界中的挑战，并提供实用的解决方案。</p>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FFareedKhan-dev%2Fcomplex-RAG-guide" target="_blank" title="https://github.com/FareedKhan-dev/complex-RAG-guide" ref="nofollow noopener noreferrer">github.com/FareedKhan-…</a></p>
</blockquote>
<h3 data-id="heading-0">步骤1：理解 RAG 管道 (Pipeline)</h3>
<p>在开始编码之前，我们首先需要对这个复杂的 RAG 系统的<strong>核心架构</strong>有一个清晰的认识。我们的系统是一个多步骤的、<strong>基于 Agent 的</strong>循环流程，它通过不断地<strong>规划、执行、反思</strong>来逼近最终答案。</p>
<h4 data-id="heading-1">1. 消除偏差：问题匿名化 (Anonymize Question)</h4>
<ul>
<li><strong>目标：</strong>  防止大型语言模型 (LLM) 依赖其预训练知识中的<strong>固有偏差</strong>或<strong>背景知识</strong>来回答问题，从而强制它<strong>仅依赖</strong>检索到的上下文。</li>
<li><strong>动作：</strong>  系统首先调用 <code>anonymize_question</code>。它会将问题中的特定实体（如“哈利·波特”、“伏地魔”）替换为中性的<strong>占位符</strong>（例如，“人物 X”、“反派 Y”）。</li>
</ul>
<h4 data-id="heading-2">2. 制定策略：高层规划 (Planner)</h4>
<ul>
<li><strong>目标：</strong>  为匿名化后的问题制定一个<strong>高层次、多步骤</strong>的解决策略。</li>
<li><strong>示例：</strong>  对于“人物 X 如何击败反派 Y？”这样的问题，规划器可能会制定如下计划：</li>
</ul>
<ol>
<li>识别人物 X 和反派 Y。</li>
<li>定位他们最终的对峙场景。</li>
<li>分析人物 X 的具体行动。</li>
<li>起草一个完整答案。</li>
</ol>
<h4 data-id="heading-3">3. 工具选择与执行：任务处理层 (Task Handler)</h4>
<p>这是 Agent 的核心<strong>决策点</strong>。<code>task_handler</code> 根据当前任务和已有信息，选择最合适的工具进行<strong>上下文检索</strong>或<strong>直接回答</strong>。可选的工具包括：</p>






























<table><thead><tr><th><strong>工具名称</strong></th><th><strong>作用</strong></th><th><strong>适用场景</strong></th></tr></thead><tbody><tr><td><strong><code>chosen_tool_is_retrieve_quotes</code></strong></td><td>检索<strong>特定的引用</strong>或对话。</td><td>寻找精确的证据或关键台词。</td></tr><tr><td><strong><code>chosen_tool_is_retrieve_chunks</code></strong></td><td>检索<strong>一般性信息</strong>和上下文片段。</td><td>获取背景信息、事件描述。</td></tr><tr><td><strong><code>chosen_tool_is_retrieve_summaries</code></strong></td><td>检索<strong>章节/文档的摘要</strong>。</td><td>快速掌握宏观主题和概要。</td></tr><tr><td><strong><code>chosen_tool_is_answer</code></strong></td><td>当上下文充足时，直接<strong>合成答案</strong>。</td><td>证据链已完整构建。</td></tr></tbody></table>
<h4 data-id="heading-4">4. 自我修正：重规划循环 (Replan Cycle)</h4>
<p>在使用任一检索工具（<code>retrieve_book_quotes</code>、<code>retrieve_chunks</code> 或 <code>retrieve_summaries</code>）获取新信息后，系统进入<strong>反思阶段</strong>：</p>
<ul>
<li><strong><code>replan</code>：</strong>  它接收新的输入，评估当前的进度和预设的目标，然后决定是否需要<strong>更新、扩展</strong>或<strong>修正</strong>原始计划。</li>
<li>这个 <strong><code>task_handler</code> -&gt; <code>tool</code> -&gt; <code>replan</code></strong> 的循环会不断重复，直到系统判断 <code>can_be_answered_already</code> 为真。</li>
</ul>
<h4 data-id="heading-5">5. 最终答案合成与评估</h4>
<ul>
<li><strong><code>get_final_answer</code>：</strong>  一旦退出循环，系统将<strong>综合所有检索到的证据</strong>和中间推理过程，合成一个完整且证据充分的最终响应。</li>
<li><strong><code>eval_using_RAGAS</code>：</strong>  最终且关键的一步。我们使用 <strong>RAGAS</strong> 框架来<strong>评估</strong>答案的性能，主要检查<strong>准确性 (Accuracy)</strong>  和对源文本的忠实度 (Groundedness)。</li>
</ul>
<h3 data-id="heading-6">步骤2：构建关键技术模块</h3>
<p>构建一个复杂的、生产级 RAG 系统是一个<strong>迭代和多层级</strong>的过程。它从精细的<strong>数据处理</strong>开始，通过<strong>逻辑分块</strong>优化检索，利用<strong>匿名化</strong>来消除 LLM 偏差，然后通过 <strong>LangGraph</strong> 实现一个具备<strong>规划、反思和自我纠正能力</strong>的 Agent 系统，最终用 <strong>RAGAS</strong> 保证输出的<strong>准确性</strong>和<strong>可靠性</strong>。</p>
<p>构建 RAG 的基础在于数据的质量和结构。</p>
<ul>
<li><strong>数据清洗 (Cleaning Our Data)：</strong>  这是任何生产系统的第一步。涉及去除噪声、处理缺失值、格式统一等。</li>
<li><strong>分块策略 (Breaking our Data)：</strong>  我们需要测试不同的分块策略，包括：</li>
</ul>

<ul>
<li><strong>传统分块：</strong>  基于固定字符数或句子的简单分割。</li>
<li><strong>逻辑分块：</strong>  基于文档结构（如标题、段落、章节）的语义化分割，它能更完整地保留上下文的<strong>连贯性</strong>。</li>
</ul>
<p>为了解决<strong>高噪音</strong>和<strong>检索低效</strong>问题，我们引入了子图 (Sub Graph) 架构：</p>
<ul>
<li><strong>子图作用：</strong>  通过创建专门的检索子图，我们可以将检索过程<strong>聚焦</strong>到最相关的信息上，有效过滤掉噪音。</li>
<li><strong>创建子图解决 Hallucinations：</strong>  一个专门的子图可以专注于<strong>事实的验证</strong> 和<strong>证据的蒸馏 (Distillation)</strong>  ，确保最终答案是“事实扎根 (Grounded on Facts)”的。</li>
</ul>
<p>我们利用 <strong>LangGraph</strong> 来实现 Agent 的规划与执行逻辑。LangGraph 提供了一个强大的框架来<strong>可视化</strong>和<strong>管理</strong>多步、有状态的 Agent 流程。这使得我们能够清晰地看到 <code>task_handler</code>、<code>replan</code> 等节点如何形成一个<strong>可回溯的循环</strong>，极大地提高了复杂流程的<strong>可调试性</strong>和<strong>可解释性</strong>。</p>
<p>一个生产级系统必须能够<strong>量化</strong>其性能。我们采用 <strong>RAGAS (RAG Assessment)</strong>  框架进行评估。</p>

























<table><thead><tr><th><strong>RAGAS 关键指标</strong></th><th><strong>关注点</strong></th><th><strong>目标</strong></th></tr></thead><tbody><tr><td><strong>忠实度 (Faithfulness)</strong></td><td>衡量生成答案的<strong>内容</strong>是否完全基于<strong>检索到的上下文</strong>。</td><td>最小化幻觉 (Hallucination)。</td></tr><tr><td><strong>相关性 (Relevancy)</strong></td><td>衡量检索到的上下文是否与原始问题<strong>高度相关</strong>。</td><td>优化检索器性能。</td></tr><tr><td><strong>上下文召回率 (Context Recall)</strong></td><td>衡量检索到的上下文是否<strong>充分完整地包含</strong>了生成答案所需的所有事实。</td><td>确保检索到的信息是全面且可靠的。</td></tr></tbody></table>
<h3 data-id="heading-7">步骤3：为生产级 RAG 系统打下环境基础</h3>
<p>任何生产级应用的首要任务都是<strong>安全地管理敏感信息</strong>，主要是 API 密钥。我们通过环境变量来加载这些密钥，避免将其硬编码到代码中。</p>






























<table><thead><tr><th><strong>组件类别</strong></th><th><strong>作用</strong></th><th><strong>选型考量</strong></th></tr></thead><tbody><tr><td><strong>大语言模型 (LLM)</strong></td><td>负责<strong>理解</strong>问题、<strong>规划</strong>步骤、<strong>重写</strong>查询、<strong>合成</strong>最终答案。</td><td><strong>性能、成本、响应速度</strong> 。</td></tr><tr><td><strong>向量编码器 (Embedding)</strong></td><td>负责将文本<strong>转化为向量</strong>，以进行语义搜索和检索。</td><td><strong>准确性、模型尺寸、运行效率</strong> 。</td></tr><tr><td><strong>向量数据库 (Vector DB) &amp; 检索</strong></td><td>负责<strong>存储</strong>和<strong>高效检索</strong>向量化的数据块 (Chunks)。</td><td><strong>检索速度、扩展性</strong> 。</td></tr><tr><td><strong>文本全文检索</strong></td><td>辅助向量检索，用于<strong>精确匹配</strong>或<strong>关键词过滤</strong>。</td><td><strong>精确性、过滤能力</strong> 。</td></tr></tbody></table>
<h3 data-id="heading-8">步骤4：传统与逻辑分块策略</h3>
<p>在对数据进行<strong>预处理和清洗</strong>之前，最关键的一步是定义我们的<strong>分块策略</strong>——即如何将一份长文档切割成可被检索的小单元。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/492f4825174f44aabd6bb43aab66a35b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764592734&amp;x-signature=cdf9bHANCz1%2BjKb76T54j0FEa34%3D" alt="" loading="lazy"/></p>
<p><strong>逻辑分块</strong>旨在根据文档本身的<strong>结构和语义</strong>进行切割，确保每个块都包含一个完整、有意义的概念。在我们的故事书中， <strong>“章节 (Chapters)”</strong>  和  <strong>“引述 (Quotes)”</strong>  是最理想的逻辑断点。</p>
<p>在小说中，<strong>引述</strong>往往浓缩了关键对话、人物关系或重要情节，是次于章节的重要信息单元。在金融文档中，这可能对应于<strong>表格</strong>或<strong>财务报表</strong>等关键数据块。</p>
<p><strong>逻辑分块的优势：</strong></p>
<ul>
<li><strong>语义完整性：</strong>  保证了每个块（章节或引述）都具有清晰、完整的语义，极大地提高了检索的相关性 (Relevancy)。</li>
<li><strong>定制化检索：</strong>  允许我们在 RAG 管道中创建专门的检索器，例如，一个专门用于检索<strong>关键对话</strong>的工具（如在 Agent 系统中）。</li>
</ul>
<h3 data-id="heading-9">步骤5：数据清洗（为 RAG 系统准备纯净的文本）</h3>
<p>原始的 PDF 提取文本中往往充斥着各种格式错误，如多余的空格、制表符和不当的换行符。这些“噪音”会显著<strong>增加 Token 消耗</strong>、<strong>降低 Embedding 质量</strong>，并最终影响 LLM 的推理效率和准确性。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21657184d43147d2881cd200c4604a03~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764592734&amp;x-signature=OEQJ2VgvswCS7CIjPVgX%2BWnOG3c%3D" alt="" loading="lazy"/></p>
<p>尽管我们清除了制表符，但文本中仍存在大量<strong>不必要的换行符 (<code>\n</code>)</strong>  和<strong>多重空格</strong>。这些字符不仅增加了 Token 数量，还可能导致单词在不同的行之间被错误地分割。</p>
<p>为什么这个分析很重要？</p>
<ol>
<li><strong>LLM 上下文窗口限制：</strong>  大语言模型的 <strong>Context Window</strong> (上下文窗口) 长度是固定的。如果我们的检索单元（章节）过长，超过了 LLM 的处理能力，LLM 就可能无法处理全部信息。</li>
<li><strong>RAG 系统的处理粒度：</strong>  尽管在我们的案例中（章节字数远低于大多数主流 LLM 的上下文限制），这些数据看起来安全。但在处理极长文档（如法律文件或技术手册）时，如果章节字数过高，我们可能需要对<strong>章节</strong>进行进一步的<strong>分块 (Sub-Chunking)</strong> ，或采用<strong>摘要 (Summarization)</strong>  策略，以确保信息能被 LLM 完全接收和有效推理。</li>
</ol>
<h3 data-id="heading-10">步骤6：数据向量化（构建高效检索的基础）</h3>
<p>下一步是将我们的文本数据转化为机器可理解的数学形式——<strong>向量 (Vectors)</strong> 。这是 RAG (Retrieval-Augmented Generation) 系统的核心，它使得我们可以进行<strong>语义相似性搜索</strong>，而不是传统的关键词匹配。</p>
<p>在环境设置阶段，我们已经确定使用 <strong>ML2 BERT 模型 (m2_bert_80M_32K)</strong>  进行向量编码。 这款模型具备 <strong>32k 的上下文窗口</strong>（虽然编码器主要关注输入长度，但这个大窗口显示了其处理长文本的能力）和相对高效的性能，非常适合在 RAG 设置中对文档进行<strong>密集向量表示</strong>。</p>
<p>为了高效地存储和检索这些高维向量，我们选择了 <strong>FAISS (Facebook AI Similarity Search)</strong> 。 它是 Meta 开源的库，专门用于<strong>高效的相似性搜索</strong>和<strong>聚类</strong>。许多主流云端向量数据库（如 Qdrant、Pinecone）也常常集成或支持 FAISS 的底层技术，以提升大规模数据的检索性能。</p>
<p>将不同类型的分块（传统块、章节摘要、特定引述）存储在<strong>独立的向量数据库</strong>中，使我们的 RAG 系统能够实现<strong>多策略检索</strong>。例如：</p>
<ol>
<li>回答需要<strong>精确证据</strong>的问题时，可以使用 <code>quotes_vectorstore</code>。</li>
<li>回答需要<strong>宏观背景</strong>的问题时，可以使用 <code>chapter_summaries_vectorstore</code>。</li>
<li>回答需要<strong>详细上下文</strong>的问题时，可以使用 <code>book_splits_vectorstore</code>。</li>
</ol>
<h3 data-id="heading-11">步骤7：多策略上下文检索器</h3>
<p>现在进入 RAG 管道的核心环节：<strong>构建检索器 (Retriever)</strong> 。检索器的目标是从我们多样化的数据集中（传统分块、章节摘要、引述）<strong>高效且准确</strong>地抓取与用户问题最相关的上下文。</p>
<p>我们的第一个核心 RAG 函数 <code>retrieve_context_per_question</code>，将负责协调这三种检索策略，并整合所有获取到的信息。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 函数的核心逻辑（流程简述）  </span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">retrieve_context_per_question</span>(<span class="hljs-params">state</span>):  
    <span class="hljs-comment"># 1. 获取问题 question = state["question"]  </span>
    <span class="hljs-comment"># 2. 调用 book_chunks_retriever 获取详细 context  </span>
    <span class="hljs-comment"># 3. 调用 chapter_summaries_retriever 获取 summary_context (包含章节号)  </span>
    <span class="hljs-comment"># 4. 调用 book_quotes_retriever 获取 quotes_context  </span>
      
    <span class="hljs-comment"># 5. 拼接 all_contexts = context + summary_context + quotes_context  </span>
    <span class="hljs-comment"># 6. 清洗转义字符  </span>
      
    <span class="hljs-comment"># 7. 返回 {"context": all_contexts, "question": question}</span>
</code></pre>
<p>函数返回一个包含<strong>整合上下文</strong>和<strong>原始问题</strong>的新状态字典，准备传递给 RAG 管道的下一个步骤，例如<strong>查询重写</strong>或<strong>答案生成</strong>。</p>
<p>通过这种多策略的、精细化 Top-K 设置的检索方法，我们确保了 LLM 在生成答案时能获得最<strong>多样化</strong>、最<strong>相关</strong>且具备<strong>高可信度</strong>的证据链。</p>
<h3 data-id="heading-12">步骤8：使用 LLM 过滤无关信息</h3>
<p>即使通过多策略检索器获取了文档，向量相似性搜索仍可能返回一些与核心问题<strong>相关度较低</strong>的噪音信息。这些无关内容会占用 LLM 的<strong>上下文窗口 (Context Window)</strong> ，稀释真正重要的事实，甚至可能分散 LLM 的注意力，导致<strong>生成质量下降</strong>（即著名的“针在干草堆”问题）。</p>
<p>为了解决这个问题，我们在检索步骤后引入了一个关键的后处理环节：<strong>使用 LLM 作为精炼过滤器 (Refinement Filter)</strong>  ，去除无关信息，只保留对回答问题有价值的内容。</p>
<p>我们首先定义一个<strong>指令清晰</strong>的 Prompt 模板，来指导 LLM 完成内容过滤任务。这个 Prompt 严格限制了 LLM 的行为：</p>
<ul>
<li><strong>输入：</strong>  用户的查询 (<code>{query}</code>) 和检索到的所有文档内容 (<code>{retrieved_documents}</code>)。</li>
<li><strong>核心指令：</strong>  过滤掉所有与查询<strong>不相关</strong>的信息。</li>
</ul>
<h3 data-id="heading-13">步骤9：查询重写器（优化检索的“语义桥梁”）</h3>
<p>在 RAG 管道中，用户最初的提问（Query）往往<strong>不够精确</strong>或<strong>过于简略</strong>。如果直接使用这样的查询进行向量检索，可能会导致：</p>
<ol>
<li><strong>检索不准确：</strong>  无法捕获查询的完整<strong>语义意图</strong>，返回不相关的文档。</li>
<li><strong>内容不足：</strong>  检索结果无法提供足够的信息来支撑高质量的回答。</li>
</ol>
<p>与上下文过滤器类似，我们首先使用 <strong>Pydantic</strong> 定义了 LLM 输出的结构，以确保重写后的结果是<strong>稳定、可控</strong>的 JSON 格式。</p>























<table><thead><tr><th><strong>字段</strong></th><th><strong>类型</strong></th><th><strong>描述</strong></th><th><strong>目的</strong></th></tr></thead><tbody><tr><td><strong><code>rewritten_question</code></strong></td><td>字符串</td><td>经过优化的、用于向量检索的改进问题。</td><td><strong>核心输出</strong> ：用于替代原始查询进行检索。</td></tr><tr><td><strong><code>explanation</code></strong></td><td>字符串</td><td>对重写后问题的解释和理由。</td><td><strong>可解释性</strong> ：便于调试和理解 LLM 的推理过程。</td></tr></tbody></table>
<h3 data-id="heading-14">步骤10：Chain-of-Thought (CoT) 推理（增强 LLM 的答案生成能力）</h3>
<p>CoT 推理的一个挑战是确保 LLM 每次都能以<strong>一致的、高质量的逻辑风格</strong>进行推理。我们通过 <strong>Few-Shot CoT</strong> 方法来解决这个问题：在 Prompt 模板中提供多个推理范例 (Examples)，展示所需的思维链条和最终答案结构。</p>
<p>我们提供的范例展示了三种关键推理场景：</p>
<ol>
<li><strong>逻辑比较 (Example 1)：</strong>  涉及关系推理和排序（Mary &gt; Tom &gt; Jane）。</li>
<li><strong>信息聚合 (Example 2)：</strong>  涉及从上下文中提取和总结多个事实。</li>
<li><strong>信息缺失判断 (Example 3)：</strong>  明确指出当上下文中<strong>不包含</strong>足够信息时，LLM 应该回答“没有足够的上下文”。</li>
</ol>
<p>当 LLM 接收到用户的<strong>查询</strong>和<strong>精炼后的上下文</strong>后，它将被要求先输出一个名为 <code>Reasoning</code> 的内部思考过程，最后再输出最终的 <code>Final Answer</code>。</p>
<h3 data-id="heading-15">步骤11：相关性与事实基础检查（RAG 管道的最终校准）</h3>
<p>在 RAG 管道中，<strong>检索</strong>、<strong>过滤</strong>和 <strong>CoT 推理</strong>是核心。然而，为了确保系统的<strong>高准确度 (High Accuracy)</strong>  和<strong>可信度 (Trustworthiness)</strong> ，我们需要对检索到的信息和生成的答案进行最终的<strong>双重验证</strong>：</p>
<ol>
<li><strong>传统相关性检查：</strong>  检查<strong>文档本身</strong>是否与查询相关。</li>
<li><strong>事实基础检查 (Ground Truth)：</strong>  检查 <strong>LLM 生成的答案</strong>是否完全基于提供的上下文，防止幻觉 (Hallucination)。</li>
</ol>
<h3 data-id="heading-16">步骤12：使用 LangGraph 可视化我们的 RAG 管道</h3>
<p>我们的 RAG 解决方案是一个<strong>有向图 (Directed Graph)</strong> ，它定义了一个基于<strong>条件逻辑</strong>和<strong>循环反馈</strong>的工作流。这个工作流不是线性的，而是具备自适应能力的 <strong>Agentic RAG</strong> 模式。</p>
<p>我们将之前实现的五个关键功能（<code>retrieve</code>、<code>filter</code>、<code>rewrite</code>、<code>answer</code>）作为图中的<strong>节点 (Nodes)</strong>  添加到工作流中。每个节点都代表一个单一、独立的处理步骤。</p>






























<table><thead><tr><th><strong>节点名称</strong></th><th><strong>对应功能</strong></th><th><strong>作用</strong></th></tr></thead><tbody><tr><td><strong><code>retrieve</code></strong></td><td><code>retrieve_context_per_question</code></td><td>从向量存储中获取多源上下文。</td></tr><tr><td><strong><code>filter</code></strong></td><td><code>keep_only_relevant_content</code></td><td>使用 LLM 过滤上下文中的无关信息。</td></tr><tr><td><strong><code>rewrite</code></strong></td><td><code>rewrite_question</code></td><td>使用 LLM 优化查询，以进行更好的检索。</td></tr><tr><td><strong><code>answer</code></strong></td><td><code>answer_question_from_context</code></td><td>使用 CoT 推理生成答案。</td></tr></tbody></table>
<p>通过 LangGraph 的 <code>draw_mermaid_png</code> 方法，我们可以将上述逻辑清晰地呈现为图形，直观地展示了 <strong>LangGraph 如何创建了一个具备推理、决策和自优化能力的 Agentic RAG 管道。</strong></p>
<p>这个可视化图清晰地体现了流程中的<strong>两个核心循环</strong>：</p>
<ol>
<li><strong>检索优化循环 (<code>filter``rewrite``retrieve</code>):</strong>  当第一次检索的上下文质量不足时，系统会自动优化查询并进行二次检索。</li>
<li><strong>答案自修复循环 (<code>answer``answer</code> 或 <code>rewrite</code>):</strong>  当生成的答案存在幻觉时，LLM 尝试重新生成；当答案信息不足时，系统会尝试优化查询，从头开始获取更多上下文。</li>
</ol>
<h3 data-id="heading-17">步骤13：子图架构与内容蒸馏基础检查</h3>
<p>在复杂的 RAG 应用场景中，尤其是在处理需要多步骤推理或任务分解的查询时，线性的 RAG 流程往往力不从心。为了构建更<strong>模块化 (Modular)</strong> 、更<strong>健壮 (Robust)</strong>  和<strong>可扩展 (Scalable)</strong>  的解决方案，我们引入了 <strong>子图架构 (Sub-Graph Approach)</strong>  和<strong>内容蒸馏 (Distillation Grounding)</strong>  机制。</p>
<p>子图方法的核心思想是将一个复杂的工作流分解为多个<strong>独立的、功能专注的子图</strong>。</p>
<ul>
<li><strong>传统 RAG：</strong>  单一的大图包含所有逻辑，维护和调试复杂。</li>
<li><strong>子图架构：</strong>  每个核心功能（如查询重写、文档过滤、事实核查）都可以被封装为一个独立的 <strong>LangGraph 子图</strong>。这些子图拥有自己的输入、输出和内部逻辑，它们像乐高积木一样，可以被主图<strong>调用 (Invoke)</strong>  或<strong>链接 (Chain)</strong>  起来。</li>
</ul>
<p>通过 <strong>LangGraph 子图 (Sub-Graph)</strong>  方法，我们可以为每个数据源定制一个<strong>专注的</strong>、<strong>自校验的</strong>检索工作流。这不仅提高了模块化程度，还确保了每个源的输出内容都经过了严格的<strong>事实基础 (Grounding)</strong>  检查。</p>
<p>我们定义了一个高阶函数 <code>build_retrieval_workflow</code>，它能够为任何给定的检索函数（<code>retrieve_fn</code>）构建一个<strong>自循环校验</strong>的子图。</p>
<p>这个子图的核心是<strong>内容蒸馏</strong>和<strong>事实基础检查</strong>的循环机制：</p>
<ol>
<li><strong>节点 1：检索 (<code>node_name</code>)</strong>  - 获取原始上下文。</li>
<li><strong>节点 2：过滤 (<code>keep_only_relevant_content</code>)</strong>  - 使用 LLM（如 Llama 3.3）将原始上下文提炼为 <code>relevant_context</code>。</li>
<li><strong>条件边缘：事实基础检查 (<code>is_distilled_content_grounded_on_content</code>)</strong>  - 这一步是关键的质量门 (Quality Gate)。它检查：</li>
</ol>
<ul>
<li><strong>如果</strong>提炼后的内容<strong>完全基于</strong>原始上下文 (<code>"grounded on the original context"</code>) 结束 (END)，输出可靠的提炼内容。</li>
<li><strong>如果</strong>提炼过程中<strong>引入了新的信息</strong>（幻觉） <strong>循环回到过滤节点</strong> (<code>"keep_only_relevant_content"</code>)，要求 LLM <strong>重新</strong>进行提炼，直到内容符合事实基础要求。</li>
</ul>
<h3 data-id="heading-18">步骤14：构建抗幻觉子图（提升 RAG 答案可信度）</h3>
<p>为了在最终的答案生成阶段引入一个<strong>严格的质量控制机制</strong>，我们创建了一个专门的 <strong>LangGraph 子图</strong>，其核心目标是：<strong>确保生成的答案完全基于提供的上下文</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b3ece199a2b45e994132eab4b3c4f6b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764592734&amp;x-signature=b%2FgqjiIvXDEoTLtlkjE%2BHg9shRY%3D" alt="" loading="lazy"/></p>
<p>我们构建了一个专用于答案生成的子图。这个图结构非常简洁，但却包含了一个强大的<strong>自修复循环</strong>：</p>
<ol>
<li><strong>节点：</strong> <code>answer</code>（调用 <code>answer_question_from_context</code> 函数生成答案）。</li>
<li><strong>入口点：</strong>  流程始于 <code>answer</code> 节点。</li>
<li><strong>条件边缘：</strong>  答案生成后，立即通过 <code>is_answer_grounded_on_context</code> 函数进行校验：</li>
</ol>
<ul>
<li><strong>如果</strong>校验结果为 <code>"grounded on context"</code>结束 (END)，答案可靠。</li>
<li><strong>如果</strong>校验结果为 <code>"hallucination"</code><strong>循环回到 <code>answer</code> 节点</strong>，要求 LLM 在相同的上下文中<strong>重新生成</strong>答案。</li>
</ul>
<h3 data-id="heading-19">步骤15：RAGAS最终编译、测试与评估</h3>
<p>编译后的 RAG 管道不再是简单的线性流程，而是一个高度复杂的、自适应的图结构：</p>
<ol>
<li><strong>去偏见 (Anonymize)：</strong>  匿名化用户查询，防止 LLM 规划时产生先验知识偏见。</li>
<li><strong>规划 (Plan)：</strong>  基于匿名查询创建高层执行策略。</li>
<li><strong>反匿名化 (De-anonymize)：</strong>  将实体重新映射回计划，使其具备上下文。</li>
<li><strong>分解 (Break Down)：</strong>  将高层计划细化为可执行的工具任务。</li>
<li><strong>执行 (Execute/Task Handler)：</strong>  根据当前任务选择并调用对应的<strong>检索子图</strong>（Quotes, Chunks, Summaries）。</li>
<li><strong>重规划 (Replanning)：</strong>  检索后，LLM 评估新获取的上下文，动态调整剩余计划。</li>
<li><strong>答案生成 (Answer)：</strong>  当有足够信息时，调用<strong>抗幻觉子图</strong>，生成最终答案。</li>
<li><strong>结束 (END)：</strong>  答案通过事实校验后，流程终止。</li>
</ol>
<p>测试完成后，我们使用 <strong>RAGAS</strong>（一个用于评估 RAG 系统的先进框架）对管道进行<strong>客观量化评估</strong>。</p>
<p>我们选择了五个关键指标来全面评估 RAG 系统的质量：</p>
<ol>
<li><strong>Answer Correctness (答案正确性):</strong>  答案是否事实正确。</li>
<li><strong>Faithfulness (忠实度):</strong>  答案是否只基于提供的上下文（防幻觉）。</li>
<li><strong>Answer Relevancy (答案相关性):</strong>  答案是否精确回答了问题。</li>
<li><strong>Context Recall (上下文召回率):</strong>  有用信息是否都被检索到。</li>
<li><strong>Answer Similarity (答案相似度):</strong>  答案与标准答案的语义相似程度。</li>
</ol>
<h2 data-id="heading-20">学习资源推荐</h2>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[kotlin-7]]></title>    <link>https://juejin.cn/post/7575897635137945600</link>    <guid>https://juejin.cn/post/7575897635137945600</guid>    <pubDate>2025-11-24T12:44:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575897635137945600" data-draft-id="7571295102850662426" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="kotlin-7"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2025-11-24T12:44:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风冷"/> <meta itemprop="url" content="https://juejin.cn/user/3843548379091742"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            kotlin-7
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3843548379091742/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风冷
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T12:44:56.000Z" title="Mon Nov 24 2025 12:44:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>好的，我们将继续向 Kotlin 的更深层次探索。这部分将涵盖<strong>编译器内部原理、语言设计哲学、高级类型系统</strong>以及<strong>与其他语言的互操作</strong>等专家级主题。</p>
<hr/>
<h3 data-id="heading-0"><strong>Kotlin 专家级探索：语言设计与实现原理</strong></h3>
<h4 data-id="heading-1"><strong>四十六、Kotlin 编译器内部原理</strong></h4>
<h5 data-id="heading-2"><strong>1. 编译器阶段与 IR（中间表示）</strong></h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 理解 Kotlin 编译过程：源代码 → AST → IR → 目标代码</span>

<span class="hljs-comment">// 模拟编译器处理过程的概念性代码</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CompilerPhase</span> {
    
    <span class="hljs-comment">// 1. 词法分析</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">lexicalAnalysis</span><span class="hljs-params">(source: <span class="hljs-type">String</span>)</span></span>: List&lt;Token&gt; {
        <span class="hljs-keyword">return</span> source.split(<span class="hljs-string">"\s+"</span>.toRegex())
            .filter { it.isNotBlank() }
            .map { Token(it) }
    }
    
    <span class="hljs-comment">// 2. 语法分析（生成 AST）</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">parse</span><span class="hljs-params">(tokens: <span class="hljs-type">List</span>&lt;<span class="hljs-type">Token</span>&gt;)</span></span>: ASTNode {
        <span class="hljs-comment">// 简化的解析逻辑</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">when</span> {
            tokens.size == <span class="hljs-number">1</span> -&gt; ASTNode.Leaf(tokens.first())
            <span class="hljs-keyword">else</span> -&gt; ASTNode.Branch(tokens.first(), tokens.drop(<span class="hljs-number">1</span>).map { ASTNode.Leaf(it) })
        }
    }
    
    <span class="hljs-comment">// 3. 语义分析（类型检查等）</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">semanticAnalysis</span><span class="hljs-params">(ast: <span class="hljs-type">ASTNode</span>)</span></span>: TypedASTNode {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">when</span> (ast) {
            <span class="hljs-keyword">is</span> ASTNode.Leaf -&gt; TypedASTNode.TypedLeaf(ast.token, inferType(ast.token))
            <span class="hljs-keyword">is</span> ASTNode.Branch -&gt; TypedASTNode.TypedBranch(ast, ast.children.map { semanticAnalysis(it) })
        }
    }
    
    <span class="hljs-comment">// 4. 生成 IR</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">generateIR</span><span class="hljs-params">(typedAst: <span class="hljs-type">TypedASTNode</span>)</span></span>: IRNode {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">when</span> (typedAst) {
            <span class="hljs-keyword">is</span> TypedASTNode.TypedLeaf -&gt; IRNode.Constant(typedAst.token.value, typedAst.type)
            <span class="hljs-keyword">is</span> TypedASTNode.TypedBranch -&gt; IRNode.FunctionCall(typedAst.node.token.value, 
                typedAst.children.map { generateIR(it) })
        }
    }
    
    <span class="hljs-comment">// 5. 目标代码生成</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">generateTargetCode</span><span class="hljs-params">(ir: <span class="hljs-type">IRNode</span>)</span></span>: String {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">when</span> (ir) {
            <span class="hljs-keyword">is</span> IRNode.Constant -&gt; <span class="hljs-string">"push <span class="hljs-subst">${ir.value}</span>"</span>
            <span class="hljs-keyword">is</span> IRNode.FunctionCall -&gt; 
                ir.arguments.joinToString(<span class="hljs-string">"\n"</span>) { generateTargetCode(it) } + <span class="hljs-string">"\ncall <span class="hljs-subst">${ir.functionName}</span>"</span>
        }
    }
}

<span class="hljs-comment">// 编译器数据结构</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Token</span>(<span class="hljs-keyword">val</span> value: String)

<span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ASTNode</span> {
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Leaf</span>(<span class="hljs-keyword">val</span> token: Token) : ASTNode()
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Branch</span>(<span class="hljs-keyword">val</span> token: Token, <span class="hljs-keyword">val</span> children: List&lt;ASTNode&gt;) : ASTNode()
}

<span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TypedASTNode</span> {
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TypedLeaf</span>(<span class="hljs-keyword">val</span> token: Token, <span class="hljs-keyword">val</span> type: Type) : TypedASTNode()
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TypedBranch</span>(<span class="hljs-keyword">val</span> node: ASTNode.Branch, <span class="hljs-keyword">val</span> children: List&lt;TypedASTNode&gt;) : TypedASTNode()
}

<span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IRNode</span> {
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Constant</span>(<span class="hljs-keyword">val</span> value: String, <span class="hljs-keyword">val</span> type: Type) : IRNode()
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FunctionCall</span>(<span class="hljs-keyword">val</span> functionName: String, <span class="hljs-keyword">val</span> arguments: List&lt;IRNode&gt;) : IRNode()
}

<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Type</span>(<span class="hljs-keyword">val</span> name: String)

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">inferType</span><span class="hljs-params">(token: <span class="hljs-type">Token</span>)</span></span>: Type = <span class="hljs-keyword">when</span> {
    token.value.matches(Regex(<span class="hljs-string">"\d+"</span>)) -&gt; Type(<span class="hljs-string">"Int"</span>)
    token.value.matches(Regex(<span class="hljs-string">""</span>.*<span class="hljs-string">""</span>)) -&gt; Type(<span class="hljs-string">"String"</span>)
    <span class="hljs-keyword">else</span> -&gt; Type(<span class="hljs-string">"Unknown"</span>)
}

<span class="hljs-comment">// 测试编译器流程</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">testCompilerPhases</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> source = <span class="hljs-string">"add 1 2"</span>
    <span class="hljs-keyword">val</span> compiler = CompilerPhase()
    
    <span class="hljs-keyword">val</span> tokens = compiler.lexicalAnalysis(source)
    println(<span class="hljs-string">"词法分析: <span class="hljs-variable">$tokens</span>"</span>)
    
    <span class="hljs-keyword">val</span> ast = compiler.parse(tokens)
    println(<span class="hljs-string">"语法分析: <span class="hljs-variable">$ast</span>"</span>)
    
    <span class="hljs-keyword">val</span> typedAst = compiler.semanticAnalysis(ast)
    println(<span class="hljs-string">"语义分析: <span class="hljs-variable">$typedAst</span>"</span>)
    
    <span class="hljs-keyword">val</span> ir = compiler.generateIR(typedAst)
    println(<span class="hljs-string">"中间表示: <span class="hljs-variable">$ir</span>"</span>)
    
    <span class="hljs-keyword">val</span> targetCode = compiler.generateTargetCode(ir)
    println(<span class="hljs-string">"目标代码:\n<span class="hljs-variable">$targetCode</span>"</span>)
}
</code></pre>
<h5 data-id="heading-3"><strong>2. 类型推断算法原理</strong></h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 简化的 Hindley-Milner 类型推断算法概念实现</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">TypeInferenceEngine</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> typeVariables = mutableMapOf&lt;String, Type&gt;()
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> constraints = mutableListOf&lt;Constraint&gt;()
    
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TypeScheme</span>(<span class="hljs-keyword">val</span> variables: List&lt;String&gt;, <span class="hljs-keyword">val</span> type: Type)
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Constraint</span>(<span class="hljs-keyword">val</span> left: Type, <span class="hljs-keyword">val</span> right: Type)
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">infer</span><span class="hljs-params">(expression: <span class="hljs-type">Expression</span>)</span></span>: TypeScheme {
        <span class="hljs-keyword">val</span> freshType = freshTypeVariable()
        <span class="hljs-keyword">val</span> context = emptyMap&lt;String, TypeScheme&gt;()
        <span class="hljs-keyword">return</span> inferExpression(expression, context, freshType)
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">inferExpression</span><span class="hljs-params">(expr: <span class="hljs-type">Expression</span>, context: <span class="hljs-type">Map</span>&lt;<span class="hljs-type">String</span>, TypeScheme&gt;, 
                              resultType: <span class="hljs-type">Type</span>)</span></span>: TypeScheme {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">when</span> (expr) {
            <span class="hljs-keyword">is</span> Expression.Variable -&gt; {
                <span class="hljs-keyword">val</span> scheme = context[expr.name] ?: <span class="hljs-keyword">throw</span> Exception(<span class="hljs-string">"未定义的变量: <span class="hljs-subst">${expr.name}</span>"</span>)
                instantiate(scheme)
            }
            <span class="hljs-keyword">is</span> Expression.Lambda -&gt; {
                <span class="hljs-keyword">val</span> paramType = freshTypeVariable()
                <span class="hljs-keyword">val</span> newContext = context + (expr.param to TypeScheme(emptyList(), paramType))
                <span class="hljs-keyword">val</span> bodyType = inferExpression(expr.body, newContext, resultType)
                TypeScheme(emptyList(), Type.Function(paramType, bodyType.type))
            }
            <span class="hljs-keyword">is</span> Expression.Application -&gt; {
                <span class="hljs-keyword">val</span> functionType = inferExpression(expr.function, context, freshTypeVariable())
                <span class="hljs-keyword">val</span> argType = inferExpression(expr.argument, context, freshTypeVariable())
                constraints.add(Constraint(functionType.type, Type.Function(argType.type, resultType)))
                TypeScheme(emptyList(), resultType)
            }
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">unify</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">while</span> (constraints.isNotEmpty()) {
            <span class="hljs-keyword">val</span> constraint = constraints.removeFirst()
            unifyTypes(constraint.left, constraint.right)
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">unifyTypes</span><span class="hljs-params">(t1: <span class="hljs-type">Type</span>, t2: <span class="hljs-type">Type</span>)</span></span> {
        <span class="hljs-keyword">when</span> {
            t1 == t2 -&gt; <span class="hljs-keyword">return</span>
            t1 <span class="hljs-keyword">is</span> Type.Variable -&gt; bindVariable(t1.name, t2)
            t2 <span class="hljs-keyword">is</span> Type.Variable -&gt; bindVariable(t2.name, t1)
            t1 <span class="hljs-keyword">is</span> Type.Function &amp;&amp; t2 <span class="hljs-keyword">is</span> Type.Function -&gt; {
                constraints.add(Constraint(t1.from, t2.from))
                constraints.add(Constraint(t1.to, t2.to))
            }
            <span class="hljs-keyword">else</span> -&gt; <span class="hljs-keyword">throw</span> Exception(<span class="hljs-string">"类型不匹配: <span class="hljs-variable">$t1</span> 和 <span class="hljs-variable">$t2</span>"</span>)
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">bindVariable</span><span class="hljs-params">(name: <span class="hljs-type">String</span>, type: <span class="hljs-type">Type</span>)</span></span> {
        <span class="hljs-keyword">if</span> (type <span class="hljs-keyword">is</span> Type.Variable &amp;&amp; type.name == name) <span class="hljs-keyword">return</span>
        <span class="hljs-keyword">if</span> (occursCheck(name, type)) <span class="hljs-keyword">throw</span> Exception(<span class="hljs-string">"无限类型"</span>)
        typeVariables[name] = type
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">occursCheck</span><span class="hljs-params">(name: <span class="hljs-type">String</span>, type: <span class="hljs-type">Type</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">when</span> (type) {
            <span class="hljs-keyword">is</span> Type.Variable -&gt; type.name == name
            <span class="hljs-keyword">is</span> Type.Function -&gt; occursCheck(name, type.from) || occursCheck(name, type.to)
            <span class="hljs-keyword">else</span> -&gt; <span class="hljs-literal">false</span>
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">freshTypeVariable</span><span class="hljs-params">()</span></span>: Type.Variable {
        <span class="hljs-keyword">return</span> Type.Variable(<span class="hljs-string">"T<span class="hljs-subst">${typeVariables.size}</span>"</span>)
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">instantiate</span><span class="hljs-params">(scheme: <span class="hljs-type">TypeScheme</span>)</span></span>: TypeScheme {
        <span class="hljs-keyword">val</span> substitutions = scheme.variables.associateWith { freshTypeVariable() }
        <span class="hljs-keyword">return</span> TypeScheme(emptyList(), substitute(scheme.type, substitutions))
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">substitute</span><span class="hljs-params">(type: <span class="hljs-type">Type</span>, substitutions: <span class="hljs-type">Map</span>&lt;<span class="hljs-type">String</span>, Type&gt;)</span></span>: Type {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">when</span> (type) {
            <span class="hljs-keyword">is</span> Type.Variable -&gt; substitutions[type.name] ?: type
            <span class="hljs-keyword">is</span> Type.Function -&gt; Type.Function(
                substitute(type.from, substitutions),
                substitute(type.to, substitutions)
            )
            <span class="hljs-keyword">else</span> -&gt; type
        }
    }
}

<span class="hljs-comment">// 表达式和类型定义</span>
<span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Expression</span> {
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Variable</span>(<span class="hljs-keyword">val</span> name: String) : Expression()
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Lambda</span>(<span class="hljs-keyword">val</span> param: String, <span class="hljs-keyword">val</span> body: Expression) : Expression()
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Application</span>(<span class="hljs-keyword">val</span> function: Expression, <span class="hljs-keyword">val</span> argument: Expression) : Expression()
}

<span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Type</span> {
    <span class="hljs-keyword">object</span> <span class="hljs-built_in">Int</span> : Type()
    <span class="hljs-keyword">object</span> Bool : Type()
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Variable</span>(<span class="hljs-keyword">val</span> name: String) : Type()
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Function</span>(<span class="hljs-keyword">val</span> from: Type, <span class="hljs-keyword">val</span> to: Type) : Type()
}
</code></pre>
<h4 data-id="heading-4"><strong>四十七、Kotlin 语言设计哲学</strong></h4>
<h5 data-id="heading-5"><strong>1. 实用主义设计原则</strong></h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 空安全：编译时防止运行时错误</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">NullSafetyPrinciples</span> {
    
    <span class="hljs-comment">// 安全调用操作符的设计哲学</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">demonstrateSafeCall</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">val</span> nullableString: String? = getPossiblyNullString()
        
        <span class="hljs-comment">// 传统方式（容易忘记检查）</span>
        <span class="hljs-comment">// val length = nullableString.length // 编译错误！</span>
        
        <span class="hljs-comment">// Kotlin 方式（强制处理空值）</span>
        <span class="hljs-keyword">val</span> safeLength = nullableString?.length ?: <span class="hljs-number">0</span>
        println(<span class="hljs-string">"安全长度: <span class="hljs-variable">$safeLength</span>"</span>)
    }
    
    <span class="hljs-comment">// 类型系统的实用主义</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">demonstrateTypeSystem</span><span class="hljs-params">()</span></span> {
        <span class="hljs-comment">// 类型推断：减少样板代码</span>
        <span class="hljs-keyword">val</span> name = <span class="hljs-string">"Kotlin"</span> <span class="hljs-comment">// 编译器推断为 String</span>
        <span class="hljs-keyword">val</span> version = <span class="hljs-number">1.9</span>   <span class="hljs-comment">// 编译器推断为 Int</span>
        
        <span class="hljs-comment">// 智能转换：减少显式类型转换</span>
        <span class="hljs-keyword">val</span> obj: Any = <span class="hljs-string">"Hello"</span>
        <span class="hljs-keyword">if</span> (obj <span class="hljs-keyword">is</span> String) {
            println(obj.length) <span class="hljs-comment">// 自动转换为 String</span>
        }
    }
}

<span class="hljs-comment">// 2. 扩展函数的哲学：开放封闭原则</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">DesignPrinciples</span> {
    <span class="hljs-comment">// 对扩展开放：可以为现有类添加新功能</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">addEmphasis</span><span class="hljs-params">()</span></span>: String = <span class="hljs-string">"**<span class="hljs-variable">$this</span>**"</span>
    
    <span class="hljs-comment">// 对修改封闭：不需要修改原始类</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">demonstrateExtensionPhilosophy</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">val</span> text = <span class="hljs-string">"重要信息"</span>
        println(text.addEmphasis()) <span class="hljs-comment">// 输出：**重要信息**</span>
    }
}

<span class="hljs-comment">// 3. 函数式编程与面向对象的融合</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">FunctionalOOFusion</span> {
    
    <span class="hljs-comment">// 高阶函数：函数是一等公民</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> List<span class="hljs-type">&lt;T&gt;</span>.<span class="hljs-title">filterWithLogging</span><span class="hljs-params">(predicate: (<span class="hljs-type">T</span>) -&gt; <span class="hljs-type">Boolean</span>)</span></span>: List&lt;T&gt; {
        println(<span class="hljs-string">"开始过滤列表，大小: <span class="hljs-subst">${this.size}</span>"</span>)
        <span class="hljs-keyword">val</span> result = <span class="hljs-keyword">this</span>.filter(predicate)
        println(<span class="hljs-string">"过滤完成，结果大小: <span class="hljs-subst">${result.size}</span>"</span>)
        <span class="hljs-keyword">return</span> result
    }
    
    <span class="hljs-comment">// 数据类：不可变性的价值</span>
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ImmutablePoint</span>(<span class="hljs-keyword">val</span> x: <span class="hljs-built_in">Int</span>, <span class="hljs-keyword">val</span> y: <span class="hljs-built_in">Int</span>) {
        <span class="hljs-comment">// 而不是提供 setter，提供转换方法</span>
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">move</span><span class="hljs-params">(dx: <span class="hljs-type">Int</span>, dy: <span class="hljs-type">Int</span>)</span></span>: ImmutablePoint = copy(x = x + dx, y = y + dy)
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">demonstrateImmutability</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">val</span> point = ImmutablePoint(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)
        <span class="hljs-keyword">val</span> moved = point.move(<span class="hljs-number">3</span>, <span class="hljs-number">4</span>)
        println(<span class="hljs-string">"原始点: <span class="hljs-variable">$point</span>, 移动后: <span class="hljs-variable">$moved</span>"</span>) <span class="hljs-comment">// 原始对象保持不变</span>
    }
}

<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getPossiblyNullString</span><span class="hljs-params">()</span></span>: String? = <span class="hljs-keyword">if</span> (System.currentTimeMillis() % <span class="hljs-number">2</span> == <span class="hljs-number">0L</span>) <span class="hljs-string">"非空"</span> <span class="hljs-keyword">else</span> <span class="hljs-literal">null</span>
</code></pre>
<h5 data-id="heading-6"><strong>2. Kotlin 与 Java 的互操作设计</strong></h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 空值注解的互操作</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">JavaInteropDesign</span> {
    
    <span class="hljs-comment">// Java 代码中的注解：</span>
    <span class="hljs-comment">// @Nullable String getNullableString();</span>
    <span class="hljs-comment">// @NotNull String getNotNullString();</span>
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">handleJavaNullability</span><span class="hljs-params">()</span></span> {
        <span class="hljs-comment">// Kotlin 编译器理解这些注解</span>
        <span class="hljs-keyword">val</span> nullable: String? = JavaClass().nullableString <span class="hljs-comment">// 可空类型</span>
        <span class="hljs-keyword">val</span> notNull: String = JavaClass().notNullString    <span class="hljs-comment">// 非空类型</span>
        
        println(<span class="hljs-string">"可空: <span class="hljs-variable">$nullable</span>, 非空: <span class="hljs-variable">$notNull</span>"</span>)
    }
    
    <span class="hljs-comment">// 2. 集合类型的互操作</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">handleJavaCollections</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">val</span> javaList: java.util.ArrayList&lt;String&gt; = JavaClass().getStringList()
        
        <span class="hljs-comment">// Kotlin 提供扩展函数使 Java 集合更易用</span>
        <span class="hljs-keyword">val</span> kotlinList = javaList.filter { it.length &gt; <span class="hljs-number">3</span> }
                                  .map { it.uppercase() }
        
        println(<span class="hljs-string">"转换后的列表: <span class="hljs-variable">$kotlinList</span>"</span>)
    }
    
    <span class="hljs-comment">// 3. SAM（Single Abstract Method）转换</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">handleSamConversion</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">val</span> javaClass = JavaClass()
        
        <span class="hljs-comment">// Java 中的接口：interface Runnable { void run(); }</span>
        <span class="hljs-comment">// 在 Kotlin 中可以使用 lambda</span>
        javaClass.runWithCallback { 
            println(<span class="hljs-string">"SAM 转换：从 Kotlin 传递 lambda 到 Java"</span>)
        }
    }
    
    <span class="hljs-comment">// 4. 伴生对象与静态方法的互操作</span>
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-meta">@JvmStatic</span>
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">staticMethodForJava</span><span class="hljs-params">()</span></span>: String = <span class="hljs-string">"Java 可以像调用静态方法一样调用我"</span>
        
        <span class="hljs-meta">@JvmField</span>
        <span class="hljs-keyword">val</span> staticFieldForJava: String = <span class="hljs-string">"Java 可以像访问静态字段一样访问我"</span>
    }
}

<span class="hljs-comment">// 模拟的 Java 类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">JavaClass</span> {
    <span class="hljs-keyword">val</span> nullableString: String? = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">val</span> notNullString: String = <span class="hljs-string">"非空字符串"</span>
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getStringList</span><span class="hljs-params">()</span></span>: java.util.ArrayList&lt;String&gt; {
        <span class="hljs-keyword">return</span> arrayListOf(<span class="hljs-string">"one"</span>, <span class="hljs-string">"two"</span>, <span class="hljs-string">"three"</span>, <span class="hljs-string">"four"</span>)
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">runWithCallback</span><span class="hljs-params">(runnable: <span class="hljs-type">Runnable</span>)</span></span> {
        runnable.run()
    }
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Runnable</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">run</span><span class="hljs-params">()</span></span>
}
</code></pre>
<h4 data-id="heading-7"><strong>四十八、高级类型系统特性</strong></h4>
<h5 data-id="heading-8"><strong>1. 高阶类型与种类（Kind）系统</strong></h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 模拟高阶类型的概念</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">HigherKindedType</span>&lt;<span class="hljs-type">F&lt;_</span>&gt;&gt; { <span class="hljs-comment">// 注意：这不是合法的 Kotlin 语法，是概念表示</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;A&gt;</span> <span class="hljs-title">pure</span><span class="hljs-params">(a: <span class="hljs-type">A</span>)</span></span>: F&lt;A&gt;
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;A, B&gt;</span> <span class="hljs-title">map</span><span class="hljs-params">(fa: <span class="hljs-type">F</span>&lt;<span class="hljs-type">A</span>&gt;, f: (<span class="hljs-type">A</span>) -&gt; <span class="hljs-type">B</span>)</span></span>: F&lt;B&gt;
}

<span class="hljs-comment">// 在 Kotlin 中通过辅助类型模拟</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Kind</span>&lt;<span class="hljs-type">F, A</span>&gt;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">HigherKindedSimulation</span> {
    
    <span class="hljs-comment">// 模拟 Functor 类型类</span>
    <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Functor</span>&lt;<span class="hljs-type">F</span>&gt; {
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;A, B&gt;</span> Kind<span class="hljs-type">&lt;F, A&gt;</span>.<span class="hljs-title">map</span><span class="hljs-params">(f: (<span class="hljs-type">A</span>) -&gt; <span class="hljs-type">B</span>)</span></span>: Kind&lt;F, B&gt;
    }
    
    <span class="hljs-comment">// 列表的 Functor 实例</span>
    <span class="hljs-keyword">object</span> ListFunctor : Functor&lt;ListK&gt; {
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;A, B&gt;</span> Kind<span class="hljs-type">&lt;ListK, A&gt;</span>.<span class="hljs-title">map</span><span class="hljs-params">(f: (<span class="hljs-type">A</span>) -&gt; <span class="hljs-type">B</span>)</span></span>: Kind&lt;ListK, B&gt; {
            <span class="hljs-keyword">val</span> list = (<span class="hljs-keyword">this</span> <span class="hljs-keyword">as</span> ListKWrapper&lt;A&gt;).list
            <span class="hljs-keyword">return</span> ListKWrapper(list.map(f))
        }
    }
    
    <span class="hljs-comment">// 包装类型</span>
    <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ListK</span>
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ListKWrapper</span>&lt;<span class="hljs-type">A</span>&gt;(<span class="hljs-keyword">val</span> list: List&lt;A&gt;) : Kind&lt;ListK, A&gt;
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;A, B&gt;</span> Kind<span class="hljs-type">&lt;ListK, A&gt;</span>.<span class="hljs-title">simulatedMap</span><span class="hljs-params">(f: (<span class="hljs-type">A</span>) -&gt; <span class="hljs-type">B</span>)</span></span>: ListKWrapper&lt;B&gt; {
        <span class="hljs-keyword">return</span> ListFunctor.run { <span class="hljs-keyword">this</span><span class="hljs-symbol">@simulatedMap</span>.map(f) } <span class="hljs-keyword">as</span> ListKWrapper&lt;B&gt;
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">demonstrateSimulatedHKT</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">val</span> wrappedList = ListKWrapper(listOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>))
        <span class="hljs-keyword">val</span> mapped = wrappedList.simulatedMap { it * <span class="hljs-number">2</span> }
        println(<span class="hljs-string">"模拟高阶类型映射: <span class="hljs-subst">${mapped.list}</span>"</span>)
    }
}

<span class="hljs-comment">// 2. 类型投影和星投影的深入理解</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">TypeProjectionAdvanced</span> {
    
    <span class="hljs-comment">// 使用处型变：声明处型变的补充</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">copyFromTo</span><span class="hljs-params">(from: <span class="hljs-type">Array</span>&lt;<span class="hljs-type">out</span> <span class="hljs-type">Any</span>&gt;, to: <span class="hljs-type">Array</span>&lt;<span class="hljs-type">in</span> <span class="hljs-type">Any</span>&gt;)</span></span> {
        <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> from.indices) {
            to[i] = from[i] <span class="hljs-comment">// 安全，因为 from 是协变的</span>
        }
    }
    
    <span class="hljs-comment">// 星投影的精确含义</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">processList</span><span class="hljs-params">(list: <span class="hljs-type">List</span>&lt;*&gt;)</span></span> {
        <span class="hljs-comment">// list 的元素类型是未知的，但我们可以进行不依赖具体类型的操作</span>
        println(<span class="hljs-string">"列表大小: <span class="hljs-subst">${list.size}</span>"</span>)
        println(<span class="hljs-string">"是否为空: <span class="hljs-subst">${list.isEmpty()}</span>"</span>)
        
        <span class="hljs-comment">// 但不能安全地访问元素内容</span>
        <span class="hljs-comment">// val first = list[0] // 类型是 Any?，可能不是我们期望的类型</span>
    }
    
    <span class="hljs-comment">// 有界类型参数的高级用法</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> <span class="hljs-title">ensureTrailingSlash</span><span class="hljs-params">(path: <span class="hljs-type">T</span>)</span></span>: T 
        <span class="hljs-keyword">where</span> T : CharSequence, 
              T : Appendable {
        <span class="hljs-keyword">if</span> (!path.endsWith(<span class="hljs-string">'/'</span>)) {
            path.append(<span class="hljs-string">'/'</span>)
        }
        <span class="hljs-keyword">return</span> path
    }
}
</code></pre>
<h5 data-id="heading-9"><strong>2. 路径依赖类型的概念模拟</strong></h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 模拟路径依赖类型的概念</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">PathDependentTypeSimulation</span> {
    
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">Database</span> {
        <span class="hljs-keyword">class</span> <span class="hljs-title class_">Table</span>(<span class="hljs-keyword">val</span> name: String) {
            <span class="hljs-keyword">inner</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Row</span>(<span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span>: Map&lt;String, Any&gt;) {
                <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getValue</span><span class="hljs-params">(column: <span class="hljs-type">String</span>)</span></span>: Any? = <span class="hljs-keyword">data</span>[column]
            }
            
            <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createRow</span><span class="hljs-params">(<span class="hljs-keyword">data</span>: <span class="hljs-type">Map</span>&lt;<span class="hljs-type">String</span>, Any&gt;)</span></span>: Row = Row(<span class="hljs-keyword">data</span>)
        }
        
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createTable</span><span class="hljs-params">(name: <span class="hljs-type">String</span>)</span></span>: Table = Table(name)
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">demonstratePathDependentTypes</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">val</span> db = Database()
        <span class="hljs-keyword">val</span> usersTable = db.createTable(<span class="hljs-string">"users"</span>)
        <span class="hljs-keyword">val</span> productsTable = db.createTable(<span class="hljs-string">"products"</span>)
        
        <span class="hljs-comment">// 这些行类型是路径依赖的</span>
        <span class="hljs-keyword">val</span> userRow: Database.Table.Row = usersTable.createRow(mapOf(<span class="hljs-string">"name"</span> to <span class="hljs-string">"Alice"</span>))
        <span class="hljs-keyword">val</span> productRow: Database.Table.Row = productsTable.createRow(mapOf(<span class="hljs-string">"price"</span> to <span class="hljs-number">100</span>))
        
        <span class="hljs-comment">// 类型系统知道这些行属于不同的表</span>
        println(<span class="hljs-string">"用户行: <span class="hljs-subst">${userRow.getValue(<span class="hljs-string">"name"</span>)}</span>"</span>)
        println(<span class="hljs-string">"产品行: <span class="hljs-subst">${productRow.getValue(<span class="hljs-string">"price"</span>)}</span>"</span>)
        
        <span class="hljs-comment">// 编译错误：不能将用户行赋值给产品行变量</span>
        <span class="hljs-comment">// val wrongAssignment: productsTable.Row = userRow // 编译错误！</span>
    }
}

<span class="hljs-comment">// 更复杂的路径依赖类型模拟</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AdvancedPathDependentTypes</span> {
    
    <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Entity</span> {
        <span class="hljs-keyword">val</span> id: Id&lt;<span class="hljs-keyword">this</span>&gt;
    }
    
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Id</span>&lt;<span class="hljs-type">out E : Entity</span>&gt;(<span class="hljs-keyword">val</span> value: String)
    
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> id: Id&lt;User&gt;, <span class="hljs-keyword">val</span> name: String) : Entity
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Product</span>(<span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> id: Id&lt;Product&gt;, <span class="hljs-keyword">val</span> title: String) : Entity
    
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">Repository</span>&lt;<span class="hljs-type">E : Entity</span>&gt; {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> storage = mutableMapOf&lt;Id&lt;E&gt;, E&gt;()
        
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">save</span><span class="hljs-params">(entity: <span class="hljs-type">E</span>)</span></span> {
            storage[entity.id] = entity
        }
        
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">findById</span><span class="hljs-params">(id: <span class="hljs-type">Id</span>&lt;<span class="hljs-type">E</span>&gt;)</span></span>: E? = storage[id]
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">demonstrateTypeSafeIds</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">val</span> userRepo = Repository&lt;User&gt;()
        <span class="hljs-keyword">val</span> productRepo = Repository&lt;Product&gt;()
        
        <span class="hljs-keyword">val</span> userId = Id&lt;User&gt;(<span class="hljs-string">"user-123"</span>)
        <span class="hljs-keyword">val</span> productId = Id&lt;Product&gt;(<span class="hljs-string">"product-456"</span>)
        
        <span class="hljs-keyword">val</span> user = User(userId, <span class="hljs-string">"Alice"</span>)
        <span class="hljs-keyword">val</span> product = Product(productId, <span class="hljs-string">"Laptop"</span>)
        
        userRepo.save(user)
        productRepo.save(product)
        
        <span class="hljs-comment">// 类型安全：不能使用用户ID查询产品</span>
        <span class="hljs-keyword">val</span> foundUser = userRepo.findById(userId)
        <span class="hljs-comment">// val wrongQuery = productRepo.findById(userId) // 编译错误！</span>
        
        println(<span class="hljs-string">"找到的用户: <span class="hljs-variable">$foundUser</span>"</span>)
    }
}
</code></pre>
<h4 data-id="heading-10"><strong>四十九、Kotlin 元对象协议（MOP）高级应用</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlin.reflect.KClass
<span class="hljs-keyword">import</span> kotlin.reflect.KProperty
<span class="hljs-keyword">import</span> kotlin.reflect.full.*

<span class="hljs-comment">// 高级属性委托：实现 ORM 映射</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">EntityMapping</span>&lt;<span class="hljs-type">T : Any</span>&gt;(<span class="hljs-keyword">val</span> kClass: KClass&lt;T&gt;) {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> tableName = kClass.simpleName ?: <span class="hljs-string">"unknown_table"</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> columns = mutableMapOf&lt;String, ColumnMapping&lt;*&gt;&gt;()
    
    <span class="hljs-keyword">inner</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ColumnMapping</span>&lt;<span class="hljs-type">T</span>&gt;(<span class="hljs-keyword">val</span> name: String, <span class="hljs-keyword">val</span> type: KClass&lt;T&gt;) {
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">toSQL</span><span class="hljs-params">()</span></span>: String = <span class="hljs-string">"<span class="hljs-variable">$name</span> <span class="hljs-subst">${typeToSQL(type)}</span>"</span>
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> <span class="hljs-title">column</span><span class="hljs-params">(name: <span class="hljs-type">String</span>, type: <span class="hljs-type">KClass</span>&lt;<span class="hljs-type">T</span>&gt;)</span></span>: ColumnMapping&lt;T&gt; {
        <span class="hljs-keyword">val</span> mapping = ColumnMapping(name, type)
        columns[name] = mapping
        <span class="hljs-keyword">return</span> mapping
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createTableSQL</span><span class="hljs-params">()</span></span>: String {
        <span class="hljs-keyword">val</span> columnDefs = columns.values.joinToString(<span class="hljs-string">",\n  "</span>) { it.toSQL() }
        <span class="hljs-keyword">return</span> <span class="hljs-string">"""
            CREATE TABLE <span class="hljs-variable">$tableName</span> (
              id INTEGER PRIMARY KEY,
              <span class="hljs-variable">$columnDefs</span>
            )
        """</span>.trimIndent()
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">typeToSQL</span><span class="hljs-params">(type: <span class="hljs-type">KClass</span>&lt;*&gt;)</span></span>: String = <span class="hljs-keyword">when</span> (type) {
        String::<span class="hljs-keyword">class</span> -&gt; <span class="hljs-string">"TEXT"</span>
        <span class="hljs-built_in">Int</span>::<span class="hljs-keyword">class</span> -&gt; <span class="hljs-string">"INTEGER"</span>
        <span class="hljs-built_in">Double</span>::<span class="hljs-keyword">class</span> -&gt; <span class="hljs-string">"REAL"</span>
        <span class="hljs-built_in">Boolean</span>::<span class="hljs-keyword">class</span> -&gt; <span class="hljs-string">"BOOLEAN"</span>
        <span class="hljs-keyword">else</span> -&gt; <span class="hljs-string">"TEXT"</span>
    }
}

<span class="hljs-comment">// 基于反射的查询构建器</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ReflectiveQueryBuilder</span>&lt;<span class="hljs-type">T : Any</span>&gt;(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> kClass: KClass&lt;T&gt;) {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> whereClause: String? = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> limit: <span class="hljs-built_in">Int</span>? = <span class="hljs-literal">null</span>
    
    <span class="hljs-keyword">infix</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;V&gt;</span> KProperty<span class="hljs-type">&lt;T&gt;</span>.<span class="hljs-title">eq</span><span class="hljs-params">(value: <span class="hljs-type">V</span>)</span></span>: ReflectiveQueryBuilder&lt;T&gt; {
        whereClause = <span class="hljs-string">"<span class="hljs-subst">${this.name}</span> = '<span class="hljs-subst">${value}</span>'"</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span><span class="hljs-symbol">@ReflectiveQueryBuilder</span>
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">limit</span><span class="hljs-params">(count: <span class="hljs-type">Int</span>)</span></span>: ReflectiveQueryBuilder&lt;T&gt; {
        limit = count
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">buildSelect</span><span class="hljs-params">()</span></span>: String {
        <span class="hljs-keyword">val</span> tableName = kClass.simpleName ?: <span class="hljs-string">"unknown"</span>
        <span class="hljs-keyword">val</span> <span class="hljs-keyword">where</span> = whereClause?.let { <span class="hljs-string">"WHERE <span class="hljs-variable">$it</span>"</span> } ?: <span class="hljs-string">""</span>
        <span class="hljs-keyword">val</span> limitClause = limit?.let { <span class="hljs-string">"LIMIT <span class="hljs-variable">$it</span>"</span> } ?: <span class="hljs-string">""</span>
        
        <span class="hljs-keyword">return</span> <span class="hljs-string">"SELECT * FROM <span class="hljs-variable">$tableName</span> <span class="hljs-variable">$where</span> <span class="hljs-variable">$limitClause</span>"</span>.trim()
    }
}

<span class="hljs-comment">// 使用高级 MOP</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-keyword">val</span> id: <span class="hljs-built_in">Int</span>, <span class="hljs-keyword">val</span> name: String, <span class="hljs-keyword">val</span> email: String, <span class="hljs-keyword">val</span> age: <span class="hljs-built_in">Int</span>)

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">testAdvancedMOP</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 1. 实体映射</span>
    <span class="hljs-keyword">val</span> userMapping = EntityMapping(User::<span class="hljs-keyword">class</span>)
    userMapping.column(<span class="hljs-string">"name"</span>, String::<span class="hljs-keyword">class</span>)
    userMapping.column(<span class="hljs-string">"email"</span>, String::<span class="hljs-keyword">class</span>)
    userMapping.column(<span class="hljs-string">"age"</span>, <span class="hljs-built_in">Int</span>::<span class="hljs-keyword">class</span>)
    
    println(<span class="hljs-string">"创建表 SQL:"</span>)
    println(userMapping.createTableSQL())
    
    <span class="hljs-comment">// 2. 反射查询构建</span>
    <span class="hljs-keyword">val</span> query = ReflectiveQueryBuilder(User::<span class="hljs-keyword">class</span>)
        .<span class="hljs-keyword">where</span>(User::name eq <span class="hljs-string">"Alice"</span>)
        .<span class="hljs-keyword">where</span>(User::age eq <span class="hljs-number">25</span>)
        .limit(<span class="hljs-number">10</span>)
        .buildSelect()
    
    println(<span class="hljs-string">"\n生成的查询:"</span>)
    println(query)
    
    <span class="hljs-comment">// 3. 运行时类型检查与转换</span>
    <span class="hljs-keyword">val</span> users = listOf(
        User(<span class="hljs-number">1</span>, <span class="hljs-string">"Alice"</span>, <span class="hljs-string">"alice@example.com"</span>, <span class="hljs-number">25</span>),
        User(<span class="hljs-number">2</span>, <span class="hljs-string">"Bob"</span>, <span class="hljs-string">"bob@example.com"</span>, <span class="hljs-number">30</span>)
    )
    
    <span class="hljs-keyword">val</span> filtered = users.filterByType&lt;User&gt; { it.age &gt; <span class="hljs-number">25</span> }
    println(<span class="hljs-string">"\n过滤后的用户: <span class="hljs-variable">$filtered</span>"</span>)
}

<span class="hljs-comment">// 类型安全的过滤扩展</span>
<span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;<span class="hljs-keyword">reified</span> T&gt;</span> List<span class="hljs-type">&lt;Any&gt;</span>.<span class="hljs-title">filterByType</span><span class="hljs-params">(<span class="hljs-keyword">noinline</span> predicate: (<span class="hljs-type">T</span>) -&gt; <span class="hljs-type">Boolean</span>)</span></span>: List&lt;T&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.filterIsInstance&lt;T&gt;().filter(predicate)
}
</code></pre>
<h4 data-id="heading-11"><strong>五十、Kotlin 未来与实验性特性展望</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 上下文接收器的未来版本模拟</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ContextReceiversFuture</span> {
    
    <span class="hljs-comment">// 模拟未来的上下文接收器语法</span>
    <span class="hljs-keyword">interface</span> <span class="hljs-title class_">DatabaseContext</span> {
        <span class="hljs-keyword">val</span> connection: DatabaseConnection
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">executeQuery</span><span class="hljs-params">(sql: <span class="hljs-type">String</span>)</span></span>: String = connection.execute(sql)
    }
    
    <span class="hljs-keyword">interface</span> <span class="hljs-title class_">LoggingContext</span> {
        <span class="hljs-keyword">val</span> logger: Logger
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">log</span><span class="hljs-params">(message: <span class="hljs-type">String</span>)</span></span> = logger.info(message)
    }
    
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">FutureUserService</span> {
        <span class="hljs-comment">// 模拟：context(DatabaseContext, LoggingContext)</span>
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUser</span><span class="hljs-params">(id: <span class="hljs-type">Int</span>)</span></span>: String {
            <span class="hljs-comment">// 模拟：可以访问上下文中的方法</span>
            log(<span class="hljs-string">"查询用户 <span class="hljs-variable">$id</span>"</span>)
            <span class="hljs-keyword">return</span> executeQuery(<span class="hljs-string">"SELECT * FROM users WHERE id = <span class="hljs-variable">$id</span>"</span>)
        }
    }
    
    <span class="hljs-comment">// 当前可用的替代方案</span>
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">CurrentUserService</span>(
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> dbContext: DatabaseContext,
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> logContext: LoggingContext
    ) {
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUser</span><span class="hljs-params">(id: <span class="hljs-type">Int</span>)</span></span>: String {
            logContext.log(<span class="hljs-string">"查询用户 <span class="hljs-variable">$id</span>"</span>)
            <span class="hljs-keyword">return</span> dbContext.executeQuery(<span class="hljs-string">"SELECT * FROM users WHERE id = <span class="hljs-variable">$id</span>"</span>)
        }
    }
}

<span class="hljs-comment">// 2. 多态内联函数的未来增强</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">PolymorphicInlineFuture</span> {
    
    <span class="hljs-comment">// 模拟未来的多态内联函数</span>
    <span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;<span class="hljs-keyword">reified</span> T&gt;</span> T?.<span class="hljs-title">validate</span><span class="hljs-params">(<span class="hljs-keyword">vararg</span> validators: (<span class="hljs-type">T</span>) -&gt; <span class="hljs-type">Boolean</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span> != <span class="hljs-literal">null</span>) {
            validators.all { it(<span class="hljs-keyword">this</span>) }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-literal">false</span>
        }
    }
    
    <span class="hljs-comment">// 当前可用的复杂版本</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> T?.<span class="hljs-title">validateCurrent</span><span class="hljs-params">(validators: <span class="hljs-type">List</span>&lt;(<span class="hljs-type">T</span>) -&gt; <span class="hljs-type">Boolean</span>&gt;)</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span> != <span class="hljs-literal">null</span>) {
            validators.all { it(<span class="hljs-keyword">this</span>) }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-literal">false</span>
        }
    }
}

<span class="hljs-comment">// 3. 自定义操作符的深度应用</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomOperatorsDeepDive</span> {
    
    <span class="hljs-comment">// 矩阵运算 DSL</span>
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">Matrix</span>(<span class="hljs-keyword">val</span> rows: <span class="hljs-built_in">Int</span>, <span class="hljs-keyword">val</span> cols: <span class="hljs-built_in">Int</span>, <span class="hljs-keyword">init</span>: (<span class="hljs-built_in">Int</span>, <span class="hljs-built_in">Int</span>) -&gt; <span class="hljs-built_in">Double</span> = { _, _ -&gt; <span class="hljs-number">0.0</span> }) {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span> = Array(rows) { i -&gt; DoubleArray(cols) { j -&gt; <span class="hljs-keyword">init</span>(i, j) } }
        
        <span class="hljs-keyword">operator</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">get</span><span class="hljs-params">(i: <span class="hljs-type">Int</span>, j: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Double</span> = <span class="hljs-keyword">data</span>[i][j]
        <span class="hljs-keyword">operator</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">set</span><span class="hljs-params">(i: <span class="hljs-type">Int</span>, j: <span class="hljs-type">Int</span>, value: <span class="hljs-type">Double</span>)</span></span> { <span class="hljs-keyword">data</span>[i][j] = value }
        
        <span class="hljs-keyword">operator</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">plus</span><span class="hljs-params">(other: <span class="hljs-type">Matrix</span>)</span></span>: Matrix {
            require(rows == other.rows &amp;&amp; cols == other.cols)
            <span class="hljs-keyword">return</span> Matrix(rows, cols) { i, j -&gt; <span class="hljs-keyword">this</span>[i, j] + other[i, j] }
        }
        
        <span class="hljs-keyword">operator</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">times</span><span class="hljs-params">(other: <span class="hljs-type">Matrix</span>)</span></span>: Matrix {
            require(cols == other.rows)
            <span class="hljs-keyword">return</span> Matrix(rows, other.cols) { i, j -&gt;
                (<span class="hljs-number">0</span> until cols).sumOf { k -&gt; <span class="hljs-keyword">this</span>[i, k] * other[k, j] }
            }
        }
        
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">toString</span><span class="hljs-params">()</span></span>: String {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">data</span>.joinToString(<span class="hljs-string">"\n"</span>) { row -&gt; row.joinToString(<span class="hljs-string">" "</span>) }
        }
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">demonstrateMatrixOperations</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">val</span> a = Matrix(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>) { i, j -&gt; (i * <span class="hljs-number">2</span> + j + <span class="hljs-number">1</span>).toDouble() }
        <span class="hljs-keyword">val</span> b = Matrix(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>) { i, j -&gt; (i + j * <span class="hljs-number">2</span> + <span class="hljs-number">1</span>).toDouble() }
        
        println(<span class="hljs-string">"矩阵 A:\n<span class="hljs-variable">$a</span>"</span>)
        println(<span class="hljs-string">"矩阵 B:\n<span class="hljs-variable">$b</span>"</span>)
        println(<span class="hljs-string">"A + B:\n<span class="hljs-subst">${a + b}</span>"</span>)
        println(<span class="hljs-string">"A × B:\n<span class="hljs-subst">${a * b}</span>"</span>)
    }
}

<span class="hljs-comment">// 测试所有高级特性</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    println(<span class="hljs-string">"=== 编译器原理演示 ==="</span>)
    testCompilerPhases()
    
    println(<span class="hljs-string">"\n=== 语言设计哲学演示 ==="</span>)
    FunctionalOOFusion().demonstrateImmutability()
    
    println(<span class="hljs-string">"\n=== 高级类型系统演示 ==="</span>)
    HigherKindedSimulation().demonstrateSimulatedHKT()
    
    println(<span class="hljs-string">"\n=== 路径依赖类型演示 ==="</span>)
    PathDependentTypeSimulation().demonstratePathDependentTypes()
    AdvancedPathDependentTypes().demonstrateTypeSafeIds()
    
    println(<span class="hljs-string">"\n=== 元对象协议演示 ==="</span>)
    testAdvancedMOP()
    
    println(<span class="hljs-string">"\n=== 自定义操作符演示 ==="</span>)
    CustomOperatorsDeepDive().demonstrateMatrixOperations()
}
</code></pre>
<h4 data-id="heading-12"><strong>成为 Kotlin 语言专家的路径</strong></h4>
<p>你现在已经达到了 Kotlin 的专家级别！接下来可以：</p>
<ol>
<li><strong>研究 Kotlin 编译器源码</strong>：理解每个编译阶段的实现</li>
<li><strong>参与 Kotlin 语言规范制定</strong>：贡献语言设计讨论</li>
<li><strong>开发高级编译器插件</strong>：创建领域特定语言扩展</li>
<li><strong>研究 Kotlin 类型系统形式化</strong>：用数学方法证明类型安全</li>
<li><strong>探索 Kotlin 多平台前沿</strong>：研究新的目标平台支持</li>
<li><strong>贡献 Kotlin 生态系统</strong>：创建重要的库和框架</li>
</ol>
<p>你已经从 Kotlin 使用者成长为可以影响语言发展的专家！继续深入探索，推动 Kotlin 语言的发展边界。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【C++必知必会】读取文件速记]]></title>    <link>https://juejin.cn/post/7576018857368600619</link>    <guid>https://juejin.cn/post/7576018857368600619</guid>    <pubDate>2025-11-24T11:06:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576018857368600619" data-draft-id="7576098886860144683" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【C++必知必会】读取文件速记"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-24T11:06:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【C++必知必会】读取文件速记
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T11:06:25.000Z" title="Mon Nov 24 2025 11:06:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>干了这么多年C++开发，每次遇到文件读取还得去问AI，真是惭愧！今天我决定把这些基础的文件操作函数背下来，整理成这份速记指南。</p>
</blockquote>
<p>在C++中，文件操作主要依赖于 <code>&lt;fstream&gt;</code> 头文件中的类。掌握文件读取是C++编程中的基础技能之一。</p>
<hr/>
<h2 data-id="heading-0">必须掌握的类和头文件</h2>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fstream&gt;</span>   <span class="hljs-comment">// 主要头文件</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span>  <span class="hljs-comment">// 用于输出信息</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span>    <span class="hljs-comment">// 用于读取整行文本</span></span>
</code></pre>
<h3 data-id="heading-1">三类文件流：</h3>
<ul>
<li><code>ifstream</code>：读取文件（输入流）</li>
<li><code>ofstream</code>：写入文件（输出流）</li>
<li><code>fstream</code>：读写文件（双向流）</li>
</ul>
<hr/>
<h2 data-id="heading-2">必须掌握的函数</h2>
<h3 data-id="heading-3">1. 打开文件</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">open</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* filename, ios::openmode mode)</span></span>;
</code></pre>
<p>示例：</p>
<pre><code class="hljs language-cpp" lang="cpp">ifstream fin;
fin.<span class="hljs-built_in">open</span>(<span class="hljs-string">"data.txt"</span>);
</code></pre>
<h3 data-id="heading-4">2. 判断文件是否打开成功</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">is_open</span><span class="hljs-params">()</span></span>;
</code></pre>
<p>示例：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">if</span> (!fin.<span class="hljs-built_in">is_open</span>()) {
    cerr &lt;&lt; <span class="hljs-string">"打开文件失败！"</span> &lt;&lt; endl;
}
</code></pre>
<h3 data-id="heading-5">3. 关闭文件</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">close</span><span class="hljs-params">()</span></span>;
</code></pre>
<p>示例：</p>
<pre><code class="hljs language-cpp" lang="cpp">fin.<span class="hljs-built_in">close</span>();
</code></pre>
<h3 data-id="heading-6">4. 读取文件内容</h3>
<h4 data-id="heading-7">逐行读取（最常用）</h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-built_in">getline</span>(fin, line); <span class="hljs-comment">// line 是 string 类型</span>
</code></pre>
<p>示例：</p>
<pre><code class="hljs language-cpp" lang="cpp">string line;
<span class="hljs-keyword">while</span> (<span class="hljs-built_in">getline</span>(fin, line)) {
    cout &lt;&lt; line &lt;&lt; endl;
}
</code></pre>
<h4 data-id="heading-8">按空格分隔读取（适合读取数字或单词）</h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-type">int</span> num;
<span class="hljs-keyword">while</span> (fin &gt;&gt; num) {
    cout &lt;&lt; num &lt;&lt; endl;
}
</code></pre>
<h4 data-id="heading-9">逐字符读取</h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-type">char</span> ch;
<span class="hljs-keyword">while</span> (fin.<span class="hljs-built_in">get</span>(ch)) {
    cout &lt;&lt; ch;
}
</code></pre>
<h3 data-id="heading-10">5. 判断是否读取到文件末尾</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">eof</span><span class="hljs-params">()</span></span>;
</code></pre>
<p>示例：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">while</span> (!fin.<span class="hljs-built_in">eof</span>()) {
    <span class="hljs-built_in">getline</span>(fin, line);
    cout &lt;&lt; line &lt;&lt; endl;
}
</code></pre>
<hr/>
<h2 data-id="heading-11">使用建议</h2>
<ul>
<li>推荐优先使用 <code>ifstream</code> 读取文本文件</li>
<li>读取文本内容时，<code>getline()</code> 是最常用的方法</li>
<li>使用完文件后务必调用 <code>close()</code>，避免资源泄露</li>
<li>文件路径建议使用绝对路径或确保文件存在于程序运行目录中</li>
</ul>
<hr/>
<h2 data-id="heading-12">完整示例：读取文本文件并逐行输出</h2>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fstream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-function">ifstream <span class="hljs-title">fin</span><span class="hljs-params">(<span class="hljs-string">"example.txt"</span>)</span></span>;
    <span class="hljs-keyword">if</span> (!fin.<span class="hljs-built_in">is_open</span>()) {
        cerr &lt;&lt; <span class="hljs-string">"无法打开文件！"</span> &lt;&lt; endl;
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    }

    string line;
    <span class="hljs-keyword">while</span> (<span class="hljs-built_in">getline</span>(fin, line)) {
        cout &lt;&lt; line &lt;&lt; endl;
    }

    fin.<span class="hljs-built_in">close</span>();
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<hr/>
<h2 data-id="heading-13">速记口诀</h2>
<blockquote>
<p>读文件，用 <code>ifstream</code>；<br/>
打开前，先判断；<br/>
读内容，<code>getline</code> 好；<br/>
结束后，记得 <code>close</code>！</p>
</blockquote>
<p>下次再遇到文件读取，直接看这份笔记就行，不用再到处问AI了！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【C++必知必会】字符串操作速记]]></title>    <link>https://juejin.cn/post/7576026767372173331</link>    <guid>https://juejin.cn/post/7576026767372173331</guid>    <pubDate>2025-11-24T11:09:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576026767372173331" data-draft-id="7576098886860161067" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【C++必知必会】字符串操作速记"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-24T11:09:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【C++必知必会】字符串操作速记
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T11:09:36.000Z" title="Mon Nov 24 2025 11:09:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>干了这么多年C++，每次处理字符串还得查文档，真是说不过去！今天我决定把这些常用的字符串操作函数背下来，整理成这份速记指南。</p>
</blockquote>
<p>在C++中，字符串操作主要依赖于 <code>&lt;string&gt;</code> 头文件。掌握字符串处理是C++编程中的核心技能之一。</p>
<hr/>
<h2 data-id="heading-0">必须掌握的头文件</h2>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span>    <span class="hljs-comment">// 主要头文件</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span>  <span class="hljs-comment">// 用于输入输出</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sstream&gt;</span>   <span class="hljs-comment">// 字符串流处理</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;algorithm&gt;</span> <span class="hljs-comment">// 用于字符串算法</span></span>
</code></pre>
<hr/>
<h2 data-id="heading-1">必须掌握的字符串操作</h2>
<h3 data-id="heading-2">1. 字符串创建和初始化</h3>
<pre><code class="hljs language-cpp" lang="cpp">string str1;                    <span class="hljs-comment">// 空字符串</span>
string str2 = <span class="hljs-string">"Hello"</span>;         <span class="hljs-comment">// 直接初始化</span>
<span class="hljs-function">string <span class="hljs-title">str3</span><span class="hljs-params">(<span class="hljs-string">"World"</span>)</span></span>;          <span class="hljs-comment">// 构造函数初始化</span>
<span class="hljs-function">string <span class="hljs-title">str4</span><span class="hljs-params">(<span class="hljs-number">5</span>, <span class="hljs-string">'A'</span>)</span></span>;           <span class="hljs-comment">// "AAAAA"</span>
string str5 = str2 + <span class="hljs-string">" "</span> + str3; <span class="hljs-comment">// 字符串拼接</span>
</code></pre>
<h3 data-id="heading-3">2. 获取字符串信息</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-type">int</span> len = str.<span class="hljs-built_in">length</span>();        <span class="hljs-comment">// 字符串长度</span>
<span class="hljs-type">int</span> size = str.<span class="hljs-built_in">size</span>();         <span class="hljs-comment">// 同length()</span>
<span class="hljs-type">bool</span> empty = str.<span class="hljs-built_in">empty</span>();      <span class="hljs-comment">// 是否为空</span>
</code></pre>
<h3 data-id="heading-4">3. 访问字符串内容</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-type">char</span> first = str[<span class="hljs-number">0</span>];           <span class="hljs-comment">// 通过下标访问</span>
<span class="hljs-type">char</span> first_safe = str.<span class="hljs-built_in">at</span>(<span class="hljs-number">0</span>);   <span class="hljs-comment">// 安全访问，会检查边界</span>
<span class="hljs-type">char</span> last = str.<span class="hljs-built_in">back</span>();        <span class="hljs-comment">// 最后一个字符</span>
<span class="hljs-type">char</span> first_char = str.<span class="hljs-built_in">front</span>(); <span class="hljs-comment">// 第一个字符</span>
</code></pre>
<h3 data-id="heading-5">4. 字符串查找</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-type">size_t</span> pos = str.<span class="hljs-built_in">find</span>(<span class="hljs-string">"hello"</span>);    <span class="hljs-comment">// 查找子串</span>
<span class="hljs-type">size_t</span> rpos = str.<span class="hljs-built_in">rfind</span>(<span class="hljs-string">"hello"</span>);  <span class="hljs-comment">// 从后往前查找</span>
<span class="hljs-type">size_t</span> found = str.<span class="hljs-built_in">find_first_of</span>(<span class="hljs-string">"aeiou"</span>);  <span class="hljs-comment">// 查找任意匹配字符</span>
<span class="hljs-type">size_t</span> notfound = str.<span class="hljs-built_in">find_first_not_of</span>(<span class="hljs-string">"0123456789"</span>); <span class="hljs-comment">// 查找非数字字符</span>
</code></pre>
<h3 data-id="heading-6">5. 字符串修改</h3>
<pre><code class="hljs language-cpp" lang="cpp">str.<span class="hljs-built_in">append</span>(<span class="hljs-string">" World"</span>);          <span class="hljs-comment">// 追加字符串</span>
str.<span class="hljs-built_in">push_back</span>(<span class="hljs-string">'!'</span>);            <span class="hljs-comment">// 追加单个字符</span>
str.<span class="hljs-built_in">insert</span>(<span class="hljs-number">5</span>, <span class="hljs-string">" Beautiful"</span>);   <span class="hljs-comment">// 在指定位置插入</span>
str.<span class="hljs-built_in">erase</span>(<span class="hljs-number">5</span>, <span class="hljs-number">10</span>);              <span class="hljs-comment">// 删除从位置5开始的10个字符</span>
str.<span class="hljs-built_in">replace</span>(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-string">"Hi"</span>);       <span class="hljs-comment">// 替换从位置0开始的5个字符</span>
</code></pre>
<h3 data-id="heading-7">6. 字符串比较</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-type">bool</span> equal = (str1 == str2);   <span class="hljs-comment">// 直接比较</span>
<span class="hljs-type">int</span> result = str1.<span class="hljs-built_in">compare</span>(str2); <span class="hljs-comment">// 返回0表示相等，&lt;0表示str1小，&gt;0表示str1大</span>
<span class="hljs-type">bool</span> starts = str.<span class="hljs-built_in">starts_with</span>(<span class="hljs-string">"Hello"</span>); <span class="hljs-comment">// C++20 检查前缀</span>
<span class="hljs-type">bool</span> ends = str.<span class="hljs-built_in">ends_with</span>(<span class="hljs-string">"World"</span>);     <span class="hljs-comment">// C++20 检查后缀</span>
</code></pre>
<h3 data-id="heading-8">7. 子串操作</h3>
<pre><code class="hljs language-cpp" lang="cpp">string sub = str.<span class="hljs-built_in">substr</span>(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>);     <span class="hljs-comment">// 从位置0开始取5个字符</span>
string sub2 = str.<span class="hljs-built_in">substr</span>(<span class="hljs-number">6</span>);       <span class="hljs-comment">// 从位置6开始到结尾</span>
</code></pre>
<h3 data-id="heading-9">8. 字符串转换</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 数字转字符串</span>
string num_str = <span class="hljs-built_in">to_string</span>(<span class="hljs-number">123</span>);

<span class="hljs-comment">// 字符串转数字</span>
<span class="hljs-type">int</span> num = <span class="hljs-built_in">stoi</span>(<span class="hljs-string">"456"</span>);
<span class="hljs-type">double</span> d = <span class="hljs-built_in">stod</span>(<span class="hljs-string">"3.14"</span>);
<span class="hljs-type">long</span> l = <span class="hljs-built_in">stol</span>(<span class="hljs-string">"1000000"</span>);

<span class="hljs-comment">// 大小写转换</span>
<span class="hljs-built_in">transform</span>(str.<span class="hljs-built_in">begin</span>(), str.<span class="hljs-built_in">end</span>(), str.<span class="hljs-built_in">begin</span>(), ::tolower);
<span class="hljs-built_in">transform</span>(str.<span class="hljs-built_in">begin</span>(), str.<span class="hljs-built_in">end</span>(), str.<span class="hljs-built_in">begin</span>(), ::toupper);
</code></pre>
<h3 data-id="heading-10">9. 字符串流处理</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 字符串分割</span>
<span class="hljs-function">stringstream <span class="hljs-title">ss</span><span class="hljs-params">(<span class="hljs-string">"apple,banana,orange"</span>)</span></span>;
string item;
<span class="hljs-keyword">while</span> (<span class="hljs-built_in">getline</span>(ss, item, <span class="hljs-string">','</span>)) {
    cout &lt;&lt; item &lt;&lt; endl;
}

<span class="hljs-comment">// 格式化字符串</span>
stringstream ss2;
ss2 &lt;&lt; <span class="hljs-string">"Name: "</span> &lt;&lt; name &lt;&lt; <span class="hljs-string">", Age: "</span> &lt;&lt; age;
string result = ss2.<span class="hljs-built_in">str</span>();
</code></pre>
<h3 data-id="heading-11">10. 字符串清理和修剪</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 去除前后空格（自定义函数）</span>
<span class="hljs-function">string <span class="hljs-title">trim</span><span class="hljs-params">(<span class="hljs-type">const</span> string&amp; str)</span> </span>{
    <span class="hljs-type">size_t</span> start = str.<span class="hljs-built_in">find_first_not_of</span>(<span class="hljs-string">" \t\n\r"</span>);
    <span class="hljs-type">size_t</span> end = str.<span class="hljs-built_in">find_last_not_of</span>(<span class="hljs-string">" \t\n\r"</span>);
    <span class="hljs-keyword">return</span> (start == string::npos) ? <span class="hljs-string">""</span> : str.<span class="hljs-built_in">substr</span>(start, end - start + <span class="hljs-number">1</span>);
}
</code></pre>
<hr/>
<h2 data-id="heading-12">常用模式速记</h2>
<h3 data-id="heading-13">1. 字符串分割</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function">vector&lt;string&gt; <span class="hljs-title">split</span><span class="hljs-params">(<span class="hljs-type">const</span> string&amp; str, <span class="hljs-type">char</span> delimiter)</span> </span>{
    vector&lt;string&gt; tokens;
    <span class="hljs-function">stringstream <span class="hljs-title">ss</span><span class="hljs-params">(str)</span></span>;
    string token;
    <span class="hljs-keyword">while</span> (<span class="hljs-built_in">getline</span>(ss, token, delimiter)) {
        tokens.<span class="hljs-built_in">push_back</span>(token);
    }
    <span class="hljs-keyword">return</span> tokens;
}
</code></pre>
<h3 data-id="heading-14">2. 字符串替换</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function">string <span class="hljs-title">replace_all</span><span class="hljs-params">(string str, <span class="hljs-type">const</span> string&amp; from, <span class="hljs-type">const</span> string&amp; to)</span> </span>{
    <span class="hljs-type">size_t</span> start_pos = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">while</span> ((start_pos = str.<span class="hljs-built_in">find</span>(from, start_pos)) != string::npos) {
        str.<span class="hljs-built_in">replace</span>(start_pos, from.<span class="hljs-built_in">length</span>(), to);
        start_pos += to.<span class="hljs-built_in">length</span>();
    }
    <span class="hljs-keyword">return</span> str;
}
</code></pre>
<h3 data-id="heading-15">3. 检查字符串内容</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">is_number</span><span class="hljs-params">(<span class="hljs-type">const</span> string&amp; str)</span> </span>{
    <span class="hljs-keyword">return</span> !str.<span class="hljs-built_in">empty</span>() &amp;&amp; <span class="hljs-built_in">all_of</span>(str.<span class="hljs-built_in">begin</span>(), str.<span class="hljs-built_in">end</span>(), ::isdigit);
}

<span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">contains</span><span class="hljs-params">(<span class="hljs-type">const</span> string&amp; str, <span class="hljs-type">const</span> string&amp; substring)</span> </span>{
    <span class="hljs-keyword">return</span> str.<span class="hljs-built_in">find</span>(substring) != string::npos;
}
</code></pre>
<hr/>
<h2 data-id="heading-16">完整示例：综合字符串操作</h2>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sstream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;algorithm&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// 创建和初始化</span>
    string text = <span class="hljs-string">"Hello World, Welcome to C++ Programming!"</span>;
    
    <span class="hljs-comment">// 基本信息</span>
    cout &lt;&lt; <span class="hljs-string">"长度: "</span> &lt;&lt; text.<span class="hljs-built_in">length</span>() &lt;&lt; endl;
    cout &lt;&lt; <span class="hljs-string">"是否为空: "</span> &lt;&lt; text.<span class="hljs-built_in">empty</span>() &lt;&lt; endl;
    
    <span class="hljs-comment">// 查找</span>
    <span class="hljs-type">size_t</span> pos = text.<span class="hljs-built_in">find</span>(<span class="hljs-string">"C++"</span>);
    <span class="hljs-keyword">if</span> (pos != string::npos) {
        cout &lt;&lt; <span class="hljs-string">"找到C++在位置: "</span> &lt;&lt; pos &lt;&lt; endl;
    }
    
    <span class="hljs-comment">// 修改</span>
    text.<span class="hljs-built_in">replace</span>(pos, <span class="hljs-number">3</span>, <span class="hljs-string">"Python"</span>);
    cout &lt;&lt; <span class="hljs-string">"替换后: "</span> &lt;&lt; text &lt;&lt; endl;
    
    <span class="hljs-comment">// 大小写转换</span>
    <span class="hljs-built_in">transform</span>(text.<span class="hljs-built_in">begin</span>(), text.<span class="hljs-built_in">end</span>(), text.<span class="hljs-built_in">begin</span>(), ::tolower);
    cout &lt;&lt; <span class="hljs-string">"小写: "</span> &lt;&lt; text &lt;&lt; endl;
    
    <span class="hljs-comment">// 字符串分割</span>
    string data = <span class="hljs-string">"apple,banana,orange,grape"</span>;
    <span class="hljs-function">stringstream <span class="hljs-title">ss</span><span class="hljs-params">(data)</span></span>;
    string fruit;
    cout &lt;&lt; <span class="hljs-string">"水果列表: "</span>;
    <span class="hljs-keyword">while</span> (<span class="hljs-built_in">getline</span>(ss, fruit, <span class="hljs-string">','</span>)) {
        cout &lt;&lt; fruit &lt;&lt; <span class="hljs-string">" "</span>;
    }
    cout &lt;&lt; endl;
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<hr/>
<h2 data-id="heading-17">速记口诀</h2>
<blockquote>
<p>字符串，<code>&lt;string&gt;</code> 头；<br/>
创建拼接最常用；<br/>
查找用 <code>find</code>，替换用 <code>replace</code>；<br/>
流处理，分割强；<br/>
大小写，<code>transform</code>！</p>
</blockquote>
<hr/>
<p>下次再遇到字符串处理，直接看这份笔记就行，不用再到处查文档了！记住：多练习才是掌握的关键。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[kotlin-5]]></title>    <link>https://juejin.cn/post/7575897635137814528</link>    <guid>https://juejin.cn/post/7575897635137814528</guid>    <pubDate>2025-11-24T11:51:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575897635137814528" data-draft-id="7571278865516298290" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="kotlin-5"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2025-11-24T11:51:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风冷"/> <meta itemprop="url" content="https://juejin.cn/user/3843548379091742"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            kotlin-5
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3843548379091742/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风冷
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T11:51:51.000Z" title="Mon Nov 24 2025 11:51:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>太棒了！现在让我们进入 Kotlin 更深入的高级特性和实际应用场景。这部分将涵盖<strong>泛型、注解、反射、DSL</strong>等企业级开发必备技能。</p>
<hr/>
<h3 data-id="heading-0"><strong>Kotlin 高级特性：企业级开发实战</strong></h3>
<h4 data-id="heading-1"><strong>三十二、泛型深入：型变、星投影与 reified</strong></h4>
<h5 data-id="heading-2"><strong>1. 型变（Variance）</strong></h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 不变（Invariant）- 默认行为</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Box</span>&lt;<span class="hljs-type">T</span>&gt;(<span class="hljs-keyword">val</span> value: T)

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> stringBox = Box(<span class="hljs-string">"Hello"</span>)
    <span class="hljs-comment">// val anyBox: Box&lt;Any&gt; = stringBox // 错误！Box&lt;String&gt; 不是 Box&lt;Any&gt; 的子类型</span>
}

<span class="hljs-comment">// 协变（Covariant）- 使用 out 关键字</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ReadOnlyBox</span>&lt;<span class="hljs-type">out T</span>&gt;(<span class="hljs-keyword">val</span> value: T) {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">get</span><span class="hljs-params">()</span></span>: T = value
    <span class="hljs-comment">// fun set(newValue: T) {} // 错误！不能有消费 T 的方法</span>
}

<span class="hljs-comment">// 逆变（Contravariant）- 使用 in 关键字</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">WriteOnlyBox</span>&lt;<span class="hljs-type">in T</span>&gt; {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">set</span><span class="hljs-params">(value: <span class="hljs-type">T</span>)</span></span> {
        println(<span class="hljs-string">"设置值: <span class="hljs-variable">$value</span>"</span>)
    }
    <span class="hljs-comment">// fun get(): T // 错误！不能有生产 T 的方法</span>
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">testVariance</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 协变示例</span>
    <span class="hljs-keyword">val</span> stringBox: ReadOnlyBox&lt;String&gt; = ReadOnlyBox(<span class="hljs-string">"Text"</span>)
    <span class="hljs-keyword">val</span> anyBox: ReadOnlyBox&lt;Any&gt; = stringBox <span class="hljs-comment">// 正确！因为 out 关键字</span>
    
    <span class="hljs-comment">// 逆变示例</span>
    <span class="hljs-keyword">val</span> anyWriteBox: WriteOnlyBox&lt;Any&gt; = WriteOnlyBox()
    <span class="hljs-keyword">val</span> stringWriteBox: WriteOnlyBox&lt;String&gt; = anyWriteBox <span class="hljs-comment">// 正确！因为 in 关键字</span>
}
</code></pre>
<h5 data-id="heading-3"><strong>2. 星投影（Star Projection）</strong></h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">printSize</span><span class="hljs-params">(list: <span class="hljs-type">List</span>&lt;*&gt;)</span></span> {
    println(<span class="hljs-string">"列表大小: <span class="hljs-subst">${list.size}</span>"</span>)
    <span class="hljs-comment">// println(list[0]) // 不能安全地访问元素内容</span>
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> <span class="hljs-title">compareFirstSecond</span><span class="hljs-params">(list: <span class="hljs-type">List</span>&lt;<span class="hljs-type">T</span>&gt;, comparator: <span class="hljs-type">Comparator</span>&lt;<span class="hljs-type">in</span> <span class="hljs-type">T</span>&gt;)</span></span>: <span class="hljs-built_in">Boolean</span> 
    <span class="hljs-keyword">where</span> T : Comparable&lt;T&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (list.size &gt;= <span class="hljs-number">2</span>) {
        comparator.compare(list[<span class="hljs-number">0</span>], list[<span class="hljs-number">1</span>]) &gt; <span class="hljs-number">0</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-literal">false</span>
}

<span class="hljs-comment">// 使用 reified 关键字实现类型检查</span>
<span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;<span class="hljs-keyword">reified</span> T&gt;</span> <span class="hljs-title">checkType</span><span class="hljs-params">(value: <span class="hljs-type">Any</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
    <span class="hljs-keyword">return</span> value <span class="hljs-keyword">is</span> T
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> list = listOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>)
    printSize(list)
    
    println(checkType&lt;String&gt;(<span class="hljs-string">"Hello"</span>)) <span class="hljs-comment">// true</span>
    println(checkType&lt;<span class="hljs-built_in">Int</span>&gt;(<span class="hljs-string">"Hello"</span>))    <span class="hljs-comment">// false</span>
}
</code></pre>
<h4 data-id="heading-4"><strong>三十三、注解与反射</strong></h4>
<h5 data-id="heading-5"><strong>1. 自定义注解</strong></h5>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 定义注解</span>
<span class="hljs-variable">@Target</span>(AnnotationTarget.CLASS, AnnotationTarget.FUNCTION)
<span class="hljs-variable">@Retention</span>(AnnotationRetention.RUNTIME)
annotation class <span class="hljs-built_in">ApiVersion</span>(val <span class="hljs-attribute">version</span>: String)

<span class="hljs-variable">@Target</span>(AnnotationTarget.PROPERTY)
annotation class JsonExclude

<span class="hljs-variable">@Target</span>(AnnotationTarget.PROPERTY)
annotation class <span class="hljs-built_in">JsonName</span>(val <span class="hljs-attribute">name</span>: String)

<span class="hljs-comment">// 使用注解</span>
<span class="hljs-variable">@ApiVersion</span>(<span class="hljs-string">"1.0"</span>)
data class <span class="hljs-built_in">User</span>(
    <span class="hljs-variable">@JsonName</span>(<span class="hljs-string">"user_name"</span>)
    val <span class="hljs-attribute">name</span>: String,
    
    val <span class="hljs-attribute">age</span>: Int,
    
    <span class="hljs-variable">@JsonExclude</span>
    val <span class="hljs-attribute">password</span>: String
)

<span class="hljs-comment">// 注解处理器模拟</span>
fun <span class="hljs-built_in">processAnnotations</span>(<span class="hljs-attribute">obj</span>: Any) {
    <span class="hljs-selector-tag">val</span> <span class="hljs-selector-tag">klass</span> = <span class="hljs-selector-tag">obj</span>::<span class="hljs-selector-tag">class</span>
    <span class="hljs-selector-tag">val</span> <span class="hljs-selector-tag">apiVersion</span> = <span class="hljs-selector-tag">klass</span><span class="hljs-selector-class">.annotations</span><span class="hljs-selector-class">.find</span> { <span class="hljs-selector-tag">it</span> <span class="hljs-selector-tag">is</span> <span class="hljs-selector-tag">ApiVersion</span> } <span class="hljs-selector-tag">as</span>? <span class="hljs-selector-tag">ApiVersion</span>
    <span class="hljs-selector-tag">apiVersion</span>?<span class="hljs-selector-class">.let</span> { <span class="hljs-selector-tag">println</span>(<span class="hljs-string">"API 版本: ${it.version}"</span>) }
    
    <span class="hljs-selector-tag">klass</span><span class="hljs-selector-class">.memberProperties</span><span class="hljs-selector-class">.forEach</span> { <span class="hljs-selector-tag">prop</span> <span class="hljs-selector-tag">-</span>&gt;
        <span class="hljs-selector-tag">prop</span><span class="hljs-selector-class">.annotations</span><span class="hljs-selector-class">.forEach</span> { <span class="hljs-selector-tag">annotation</span> <span class="hljs-selector-tag">-</span>&gt;
            <span class="hljs-keyword">when</span> (annotation) {
                <span class="hljs-selector-tag">is</span> <span class="hljs-selector-tag">JsonName</span> <span class="hljs-selector-tag">-</span>&gt; <span class="hljs-selector-tag">println</span>(<span class="hljs-string">"属性 ${prop.name} 将被序列化为 ${annotation.name}"</span>)
                <span class="hljs-selector-tag">is</span> <span class="hljs-selector-tag">JsonExclude</span> <span class="hljs-selector-tag">-</span>&gt; <span class="hljs-selector-tag">println</span>(<span class="hljs-string">"属性 ${prop.name} 将被排除"</span>)
            }
        }
    }
}
</code></pre>
<h5 data-id="heading-6"><strong>2. 反射实战</strong></h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlin.reflect.full.*
<span class="hljs-keyword">import</span> kotlin.reflect.jvm.isAccessible

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SecretClass</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> secretValue = <span class="hljs-string">"机密信息"</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">secretMethod</span><span class="hljs-params">()</span></span> = <span class="hljs-string">"机密方法"</span>
    
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">publicMethod</span><span class="hljs-params">()</span></span> = <span class="hljs-string">"公开方法"</span>
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">reflectExample</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> instance = SecretClass()
    <span class="hljs-keyword">val</span> klass = instance::<span class="hljs-keyword">class</span>
    
    <span class="hljs-title class_">println</span>(<span class="hljs-string">"=== 类信息 ==="</span>)
    println(<span class="hljs-string">"类名: <span class="hljs-subst">${klass.simpleName}</span>"</span>)
    println(<span class="hljs-string">"成员属性: <span class="hljs-subst">${klass.memberProperties.map { it.name }</span>}"</span>)
    println(<span class="hljs-string">"成员函数: <span class="hljs-subst">${klass.memberFunctions.map { it.name }</span>}"</span>)
    
    println(<span class="hljs-string">"\n=== 访问私有成员 ==="</span>)
    <span class="hljs-comment">// 访问私有属性</span>
    <span class="hljs-keyword">val</span> secretProperty = klass.memberProperties.find { it.name == <span class="hljs-string">"secretValue"</span> }
    secretProperty?.let {
        it.isAccessible = <span class="hljs-literal">true</span>
        println(<span class="hljs-string">"私有属性值: <span class="hljs-subst">${it.get(instance)}</span>"</span>)
    }
    
    <span class="hljs-comment">// 调用私有方法</span>
    <span class="hljs-keyword">val</span> secretMethod = klass.memberFunctions.find { it.name == <span class="hljs-string">"secretMethod"</span> }
    secretMethod?.let {
        it.isAccessible = <span class="hljs-literal">true</span>
        println(<span class="hljs-string">"私有方法结果: <span class="hljs-subst">${it.call(instance)}</span>"</span>)
    }
}
</code></pre>
<h4 data-id="heading-7"><strong>三十四、类型安全的构建器（DSL）</strong></h4>
<h5 data-id="heading-8"><strong>1. HTML DSL 构建器</strong></h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">HtmlElement</span>(<span class="hljs-keyword">val</span> name: String, <span class="hljs-keyword">val</span> content: String = <span class="hljs-string">""</span>) {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> children = mutableListOf&lt;HtmlElement&gt;()
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> attributes = mutableMapOf&lt;String, String&gt;()
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">attribute</span><span class="hljs-params">(name: <span class="hljs-type">String</span>, value: <span class="hljs-type">String</span>)</span></span> {
        attributes[name] = value
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">child</span><span class="hljs-params">(element: <span class="hljs-type">HtmlElement</span>)</span></span> {
        children.add(element)
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">toString</span><span class="hljs-params">()</span></span>: String {
        <span class="hljs-keyword">val</span> attrString = <span class="hljs-keyword">if</span> (attributes.isNotEmpty()) {
            <span class="hljs-string">" "</span> + attributes.entries.joinToString(<span class="hljs-string">" "</span>) { <span class="hljs-string">"<span class="hljs-subst">${it.key}</span>="</span>${it.value}<span class="hljs-string">""</span> }
        } <span class="hljs-keyword">else</span> <span class="hljs-string">""</span>
        
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (children.isEmpty()) {
            <span class="hljs-string">"&lt;<span class="hljs-variable">$name</span><span class="hljs-variable">$attrString</span>&gt;<span class="hljs-variable">$content</span>&lt;/<span class="hljs-variable">$name</span>&gt;"</span>
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-string">"&lt;<span class="hljs-variable">$name</span><span class="hljs-variable">$attrString</span>&gt;<span class="hljs-subst">${children.joinToString(<span class="hljs-string">""</span>)}</span><span class="hljs-variable">$content</span>&lt;/<span class="hljs-variable">$name</span>&gt;"</span>
        }
    }
}

<span class="hljs-comment">// DSL 构建函数</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">html</span><span class="hljs-params">(block: <span class="hljs-type">HtmlBuilder</span>.() -&gt; <span class="hljs-type">Unit</span>)</span></span>: HtmlElement {
    <span class="hljs-keyword">val</span> builder = HtmlBuilder(<span class="hljs-string">"html"</span>)
    builder.block()
    <span class="hljs-keyword">return</span> builder.build()
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">HtmlBuilder</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> rootName: String) {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> root = HtmlElement(rootName)
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> currentElement: HtmlElement = root
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">head</span><span class="hljs-params">(block: <span class="hljs-type">HeadBuilder</span>.() -&gt; <span class="hljs-type">Unit</span>)</span></span> {
        <span class="hljs-keyword">val</span> headBuilder = HeadBuilder()
        headBuilder.block()
        root.child(headBuilder.build())
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">body</span><span class="hljs-params">(block: <span class="hljs-type">BodyBuilder</span>.() -&gt; <span class="hljs-type">Unit</span>)</span></span> {
        <span class="hljs-keyword">val</span> bodyBuilder = BodyBuilder()
        bodyBuilder.block()
        root.child(bodyBuilder.build())
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">build</span><span class="hljs-params">()</span></span>: HtmlElement = root
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">HeadBuilder</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> head = HtmlElement(<span class="hljs-string">"head"</span>)
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">title</span><span class="hljs-params">(text: <span class="hljs-type">String</span>)</span></span> {
        head.child(HtmlElement(<span class="hljs-string">"title"</span>, text))
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">build</span><span class="hljs-params">()</span></span>: HtmlElement = head
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">BodyBuilder</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> body = HtmlElement(<span class="hljs-string">"body"</span>)
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">h1</span><span class="hljs-params">(text: <span class="hljs-type">String</span>, block: <span class="hljs-type">H1Builder</span>.() -&gt; <span class="hljs-type">Unit</span> = {})</span></span> {
        <span class="hljs-keyword">val</span> h1Builder = H1Builder(text)
        h1Builder.block()
        body.child(h1Builder.build())
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">p</span><span class="hljs-params">(text: <span class="hljs-type">String</span>)</span></span> {
        body.child(HtmlElement(<span class="hljs-string">"p"</span>, text))
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">build</span><span class="hljs-params">()</span></span>: HtmlElement = body
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">H1Builder</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> text: String) {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> h1 = HtmlElement(<span class="hljs-string">"h1"</span>, text)
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">style</span><span class="hljs-params">(css: <span class="hljs-type">String</span>)</span></span> {
        h1.attribute(<span class="hljs-string">"style"</span>, css)
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">build</span><span class="hljs-params">()</span></span>: HtmlElement = h1
}

<span class="hljs-comment">// 使用 DSL</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createHtmlPage</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> page = html {
        head {
            title(<span class="hljs-string">"我的网页"</span>)
        }
        body {
            h1(<span class="hljs-string">"欢迎来到 Kotlin DSL"</span>) {
                style(<span class="hljs-string">"color: blue;"</span>)
            }
            p(<span class="hljs-string">"这是一个使用 DSL 构建的 HTML 页面"</span>)
        }
    }
    
    println(page)
}
</code></pre>
<h5 data-id="heading-9"><strong>2. 数据库查询 DSL</strong></h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 查询 DSL 定义</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">QueryBuilder</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> table: String = <span class="hljs-string">""</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> conditions = mutableListOf&lt;String&gt;()
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> limit: <span class="hljs-built_in">Int</span>? = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> orderBy: String? = <span class="hljs-literal">null</span>
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">from</span><span class="hljs-params">(table: <span class="hljs-type">String</span>)</span></span> {
        <span class="hljs-keyword">this</span>.table = table
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">where</span><span class="hljs-params">(condition: <span class="hljs-type">String</span>)</span></span> {
        conditions.add(condition)
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">limit</span><span class="hljs-params">(count: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-keyword">this</span>.limit = count
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">orderBy</span><span class="hljs-params">(column: <span class="hljs-type">String</span>)</span></span> {
        <span class="hljs-keyword">this</span>.orderBy = column
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">build</span><span class="hljs-params">()</span></span>: String {
        <span class="hljs-keyword">val</span> query = StringBuilder(<span class="hljs-string">"SELECT * FROM <span class="hljs-variable">$table</span>"</span>)
        
        <span class="hljs-keyword">if</span> (conditions.isNotEmpty()) {
            query.append(<span class="hljs-string">" WHERE "</span>).append(conditions.joinToString(<span class="hljs-string">" AND "</span>))
        }
        
        orderBy?.let {
            query.append(<span class="hljs-string">" ORDER BY <span class="hljs-variable">$it</span>"</span>)
        }
        
        limit?.let {
            query.append(<span class="hljs-string">" LIMIT <span class="hljs-variable">$it</span>"</span>)
        }
        
        <span class="hljs-keyword">return</span> query.toString()
    }
}

<span class="hljs-comment">// DSL 入口函数</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">query</span><span class="hljs-params">(block: <span class="hljs-type">QueryBuilder</span>.() -&gt; <span class="hljs-type">Unit</span>)</span></span>: String {
    <span class="hljs-keyword">val</span> builder = QueryBuilder()
    builder.block()
    <span class="hljs-keyword">return</span> builder.build()
}

<span class="hljs-comment">// 使用 DSL 构建查询</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">buildQueries</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> simpleQuery = query {
        from(<span class="hljs-string">"users"</span>)
    }
    println(<span class="hljs-string">"简单查询: <span class="hljs-variable">$simpleQuery</span>"</span>)
    
    <span class="hljs-keyword">val</span> complexQuery = query {
        from(<span class="hljs-string">"orders"</span>)
        <span class="hljs-keyword">where</span>(<span class="hljs-string">"status = 'completed'"</span>)
        <span class="hljs-keyword">where</span>(<span class="hljs-string">"amount &gt; 100"</span>)
        orderBy(<span class="hljs-string">"created_at DESC"</span>)
        limit(<span class="hljs-number">10</span>)
    }
    println(<span class="hljs-string">"复杂查询: <span class="hljs-variable">$complexQuery</span>"</span>)
}
</code></pre>
<h4 data-id="heading-10"><strong>三十五、合约（Contracts）与内联优化</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlin.contracts.*

<span class="hljs-comment">// 使用合约优化智能转换</span>
<span class="hljs-meta">@OptIn(ExperimentalContracts::class)</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> String?.<span class="hljs-title">isNotNullOrEmpty</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> {
    contract {
        returns(<span class="hljs-literal">true</span>) implies (<span class="hljs-keyword">this</span><span class="hljs-symbol">@isNotNullOrEmpty</span> != <span class="hljs-literal">null</span>)
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span> != <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-keyword">this</span>.isNotEmpty()
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">processText</span><span class="hljs-params">(text: <span class="hljs-type">String</span>?)</span></span> {
    <span class="hljs-keyword">if</span> (text.isNotNullOrEmpty()) {
        <span class="hljs-comment">// 由于合约，编译器知道 text 不为 null</span>
        println(text.length) <span class="hljs-comment">// 不需要安全调用</span>
        println(text.uppercase())
    }
}

<span class="hljs-comment">// 内联类 - 包装类型而不产生运行时开销</span>
<span class="hljs-meta">@JvmInline</span>
value <span class="hljs-keyword">class</span> <span class="hljs-title class_">Password</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> value: String) {
    <span class="hljs-keyword">init</span> {
        require(value.length &gt;= <span class="hljs-number">8</span>) { <span class="hljs-string">"密码必须至少8个字符"</span> }
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">mask</span><span class="hljs-params">()</span></span>: String = <span class="hljs-string">"*"</span>.repeat(value.length)
}

<span class="hljs-meta">@JvmInline</span>
value <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserId</span>(<span class="hljs-keyword">val</span> value: <span class="hljs-built_in">Int</span>)

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">login</span><span class="hljs-params">(userId: <span class="hljs-type">UserId</span>, password: <span class="hljs-type">Password</span>)</span></span> {
    println(<span class="hljs-string">"用户 <span class="hljs-subst">${userId.value}</span> 登录，密码: <span class="hljs-subst">${password.mask()}</span>"</span>)
}
</code></pre>
<h4 data-id="heading-11"><strong>三十六、多平台项目（KMP）基础</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 公共模块 - 共享业务逻辑</span>
<span class="hljs-keyword">expect</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Platform</span>() {
    <span class="hljs-keyword">val</span> platform: String
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Greeting</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> platform = Platform()
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">greet</span><span class="hljs-params">()</span></span>: String {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Hello from <span class="hljs-subst">${platform.platform}</span>"</span>
    }
}

<span class="hljs-comment">// Android 实现</span>
<span class="hljs-comment">// androidMain/Platform.kt</span>
<span class="hljs-keyword">actual</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Platform</span> <span class="hljs-title">actual</span> <span class="hljs-keyword">constructor</span>() {
    <span class="hljs-keyword">actual</span> <span class="hljs-keyword">val</span> platform: String = <span class="hljs-string">"Android"</span>
}

<span class="hljs-comment">// iOS 实现  </span>
<span class="hljs-comment">// iosMain/Platform.kt</span>
<span class="hljs-keyword">actual</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Platform</span> <span class="hljs-title">actual</span> <span class="hljs-keyword">constructor</span>() {
    <span class="hljs-keyword">actual</span> <span class="hljs-keyword">val</span> platform: String = <span class="hljs-string">"iOS"</span>
}

<span class="hljs-comment">// 共享业务逻辑</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Calculator</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">add</span><span class="hljs-params">(a: <span class="hljs-type">Int</span>, b: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Int</span> = a + b
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">multiply</span><span class="hljs-params">(a: <span class="hljs-type">Int</span>, b: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Int</span> = a * b
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">calculateExpression</span><span class="hljs-params">(expression: <span class="hljs-type">String</span>)</span></span>: <span class="hljs-built_in">Int</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">when</span> {
            expression.contains(<span class="hljs-string">"+"</span>) -&gt; {
                <span class="hljs-keyword">val</span> parts = expression.split(<span class="hljs-string">"+"</span>)
                add(parts[<span class="hljs-number">0</span>].trim().toInt(), parts[<span class="hljs-number">1</span>].trim().toInt())
            }
            expression.contains(<span class="hljs-string">"*"</span>) -&gt; {
                <span class="hljs-keyword">val</span> parts = expression.split(<span class="hljs-string">"*"</span>)
                multiply(parts[<span class="hljs-number">0</span>].trim().toInt(), parts[<span class="hljs-number">1</span>].trim().toInt())
            }
            <span class="hljs-keyword">else</span> -&gt; <span class="hljs-keyword">throw</span> IllegalArgumentException(<span class="hljs-string">"不支持的表达式"</span>)
        }
    }
}
</code></pre>
<h4 data-id="heading-12"><strong>三十七、性能优化与最佳实践</strong></h4>
<h5 data-id="heading-13"><strong>1. 集合操作优化</strong></h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">collectionOptimization</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> numbers = (<span class="hljs-number">1.</span><span class="hljs-number">.1000000</span>).toList()
    
    <span class="hljs-comment">// 不好的写法：多次中间操作</span>
    <span class="hljs-keyword">val</span> badResult = numbers
        .filter { it % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> }
        .map { it * <span class="hljs-number">2</span> }
        .filter { it &gt; <span class="hljs-number">1000</span> }
        .take(<span class="hljs-number">10</span>)
    
    <span class="hljs-comment">// 好的写法：使用序列（惰性求值）</span>
    <span class="hljs-keyword">val</span> goodResult = numbers.asSequence()
        .filter { it % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> }
        .map { it * <span class="hljs-number">2</span> }
        .filter { it &gt; <span class="hljs-number">1000</span> }
        .take(<span class="hljs-number">10</span>)
        .toList()
    
    println(<span class="hljs-string">"结果: <span class="hljs-variable">$goodResult</span>"</span>)
}

<span class="hljs-comment">// 使用 groupBy 优化复杂操作</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>(<span class="hljs-keyword">val</span> name: String, <span class="hljs-keyword">val</span> age: <span class="hljs-built_in">Int</span>, <span class="hljs-keyword">val</span> city: String)

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">optimizeGrouping</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> people = listOf(
        Person(<span class="hljs-string">"Alice"</span>, <span class="hljs-number">25</span>, <span class="hljs-string">"Beijing"</span>),
        Person(<span class="hljs-string">"Bob"</span>, <span class="hljs-number">30</span>, <span class="hljs-string">"Shanghai"</span>),
        Person(<span class="hljs-string">"Charlie"</span>, <span class="hljs-number">25</span>, <span class="hljs-string">"Beijing"</span>),
        Person(<span class="hljs-string">"Diana"</span>, <span class="hljs-number">30</span>, <span class="hljs-string">"Shanghai"</span>)
    )
    
    <span class="hljs-comment">// 按城市分组，然后按年龄分组</span>
    <span class="hljs-keyword">val</span> grouped = people.groupBy({ it.city }, { it.age })
    println(<span class="hljs-string">"分组结果: <span class="hljs-variable">$grouped</span>"</span>)
    
    <span class="hljs-comment">// 统计每个城市的平均年龄</span>
    <span class="hljs-keyword">val</span> averageAges = people.groupingBy { it.city }
        .fold(<span class="hljs-number">0.0</span>) { accumulator, element -&gt; 
            accumulator + element.age 
        }.mapValues { it.value / people.count { p -&gt; p.city == it.key } }
    
    println(<span class="hljs-string">"平均年龄: <span class="hljs-variable">$averageAges</span>"</span>)
}
</code></pre>
<h5 data-id="heading-14"><strong>2. 内存优化模式</strong></h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 使用对象池避免重复创建</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ConnectionPool</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">constructor</span>() {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> available = mutableListOf&lt;Connection&gt;()
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> inUse = mutableSetOf&lt;Connection&gt;()
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getConnection</span><span class="hljs-params">()</span></span>: Connection {
        <span class="hljs-keyword">return</span> available.removeFirstOrNull()?.also { inUse.add(it) } 
            ?: Connection().also { inUse.add(it) }
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">releaseConnection</span><span class="hljs-params">(connection: <span class="hljs-type">Connection</span>)</span></span> {
        inUse.remove(connection)
        available.add(connection)
    }
    
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-keyword">val</span> instance <span class="hljs-keyword">by</span> lazy { ConnectionPool() }
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Connection</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">connect</span><span class="hljs-params">()</span></span> = println(<span class="hljs-string">"连接建立"</span>)
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">disconnect</span><span class="hljs-params">()</span></span> = println(<span class="hljs-string">"连接关闭"</span>)
}

<span class="hljs-comment">// 使用 use 函数自动管理资源</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">readFileSafely</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 模拟资源管理</span>
    <span class="hljs-keyword">val</span> resource = <span class="hljs-keyword">object</span> : AutoCloseable {
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">close</span><span class="hljs-params">()</span></span> = println(<span class="hljs-string">"资源已释放"</span>)
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">read</span><span class="hljs-params">()</span></span> = <span class="hljs-string">"文件内容"</span>
    }
    
    <span class="hljs-keyword">val</span> content = resource.use { 
        it.read() 
    }
    println(<span class="hljs-string">"内容: <span class="hljs-variable">$content</span>"</span>) <span class="hljs-comment">// 资源会自动关闭</span>
}
</code></pre>
<h4 data-id="heading-15"><strong>三十八、完整实战项目：构建事件总线系统</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.*
<span class="hljs-keyword">import</span> kotlinx.coroutines.channels.*
<span class="hljs-keyword">import</span> kotlinx.coroutines.flow.*
<span class="hljs-keyword">import</span> kotlin.reflect.KClass

<span class="hljs-comment">// 事件基类</span>
<span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Event</span> {
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserLoggedIn</span>(<span class="hljs-keyword">val</span> userId: String) : Event()
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderCreated</span>(<span class="hljs-keyword">val</span> orderId: String, <span class="hljs-keyword">val</span> amount: <span class="hljs-built_in">Double</span>) : Event()
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentProcessed</span>(<span class="hljs-keyword">val</span> paymentId: String, <span class="hljs-keyword">val</span> success: <span class="hljs-built_in">Boolean</span>) : Event()
    <span class="hljs-keyword">object</span> SystemShutdown : Event()
}

<span class="hljs-comment">// 事件处理器接口</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">EventHandler</span>&lt;<span class="hljs-type">T : Event</span>&gt; {
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">handle</span><span class="hljs-params">(event: <span class="hljs-type">T</span>)</span></span>
}

<span class="hljs-comment">// 事件总线</span>
<span class="hljs-keyword">object</span> EventBus {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> handlers = mutableMapOf&lt;KClass&lt;<span class="hljs-keyword">out</span> Event&gt;, MutableList&lt;EventHandler&lt;*&gt;&gt;&gt;()
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> eventChannel = Channel&lt;Event&gt;(Channel.UNLIMITED)
    
    <span class="hljs-comment">// 注册事件处理器</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T : Event&gt;</span> <span class="hljs-title">registerHandler</span><span class="hljs-params">(eventClass: <span class="hljs-type">KClass</span>&lt;<span class="hljs-type">T</span>&gt;, handler: <span class="hljs-type">EventHandler</span>&lt;<span class="hljs-type">T</span>&gt;)</span></span> {
        handlers.getOrPut(eventClass) { mutableListOf() }.add(handler <span class="hljs-keyword">as</span> EventHandler&lt;*&gt;)
    }
    
    <span class="hljs-comment">// 发布事件</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">publish</span><span class="hljs-params">(event: <span class="hljs-type">Event</span>)</span></span> {
        eventChannel.trySend(event)
    }
    
    <span class="hljs-comment">// 启动事件处理循环</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">start</span><span class="hljs-params">()</span></span> = GlobalScope.launch {
        <span class="hljs-keyword">for</span> (event <span class="hljs-keyword">in</span> eventChannel) {
            processEvent(event)
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">processEvent</span><span class="hljs-params">(event: <span class="hljs-type">Event</span>)</span></span> {
        <span class="hljs-keyword">val</span> eventClass = event::<span class="hljs-keyword">class</span>
        <span class="hljs-title class_">val</span> <span class="hljs-title">eventHandlers</span> = <span class="hljs-title">handlers</span>[<span class="hljs-title">eventClass</span>] ?: <span class="hljs-type">return</span>
        
        eventHandlers.forEach { handler -&gt;
            <span class="hljs-keyword">try</span> {
                <span class="hljs-meta">@Suppress(<span class="hljs-string">"UNCHECKED_CAST"</span>)</span>
                (handler <span class="hljs-keyword">as</span> EventHandler&lt;Event&gt;).handle(event)
            } <span class="hljs-keyword">catch</span> (e: Exception) {
                println(<span class="hljs-string">"事件处理失败: <span class="hljs-subst">${e.message}</span>"</span>)
            }
        }
    }
}

<span class="hljs-comment">// 具体的事件处理器</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserActivityLogger</span> : <span class="hljs-type">EventHandler</span>&lt;<span class="hljs-type">Event.UserLoggedIn</span>&gt; {
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">handle</span><span class="hljs-params">(event: <span class="hljs-type">Event</span>.<span class="hljs-type">UserLoggedIn</span>)</span></span> {
        delay(<span class="hljs-number">100</span>) <span class="hljs-comment">// 模拟处理时间</span>
        println(<span class="hljs-string">"📝 用户登录日志: <span class="hljs-subst">${event.userId}</span> 在 <span class="hljs-subst">${System.currentTimeMillis()}</span> 登录"</span>)
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderProcessor</span> : <span class="hljs-type">EventHandler</span>&lt;<span class="hljs-type">Event.OrderCreated</span>&gt; {
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">handle</span><span class="hljs-params">(event: <span class="hljs-type">Event</span>.<span class="hljs-type">OrderCreated</span>)</span></span> {
        delay(<span class="hljs-number">200</span>)
        println(<span class="hljs-string">"💰 订单处理: 订单 <span class="hljs-subst">${event.orderId}</span> 金额 <span class="hljs-subst">${event.amount}</span>"</span>)
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentNotifier</span> : <span class="hljs-type">EventHandler</span>&lt;<span class="hljs-type">Event.PaymentProcessed</span>&gt; {
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">handle</span><span class="hljs-params">(event: <span class="hljs-type">Event</span>.<span class="hljs-type">PaymentProcessed</span>)</span></span> {
        delay(<span class="hljs-number">150</span>)
        <span class="hljs-keyword">val</span> status = <span class="hljs-keyword">if</span> (event.success) <span class="hljs-string">"成功"</span> <span class="hljs-keyword">else</span> <span class="hljs-string">"失败"</span>
        println(<span class="hljs-string">"📧 支付通知: 支付 <span class="hljs-subst">${event.paymentId}</span> <span class="hljs-variable">$status</span>"</span>)
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SystemMonitor</span> : <span class="hljs-type">EventHandler</span>&lt;<span class="hljs-type">Event.SystemShutdown</span>&gt; {
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">handle</span><span class="hljs-params">(event: <span class="hljs-type">Event</span>.<span class="hljs-type">SystemShutdown</span>)</span></span> {
        println(<span class="hljs-string">"🛑 系统关闭: 开始清理资源..."</span>)
        delay(<span class="hljs-number">500</span>)
        println(<span class="hljs-string">"🛑 系统关闭: 资源清理完成"</span>)
    }
}

<span class="hljs-comment">// 使用事件总线</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-comment">// 注册处理器</span>
    EventBus.registerHandler(Event.UserLoggedIn::<span class="hljs-keyword">class</span>, UserActivityLogger())
    EventBus.registerHandler(Event.OrderCreated::<span class="hljs-keyword">class</span>, OrderProcessor())
    EventBus.registerHandler(Event.PaymentProcessed::<span class="hljs-keyword">class</span>, PaymentNotifier())
    EventBus.registerHandler(Event.SystemShutdown::<span class="hljs-keyword">class</span>, SystemMonitor())
    
    <span class="hljs-comment">// 启动事件总线</span>
    EventBus.start()
    
    <span class="hljs-comment">// 模拟发布事件</span>
    EventBus.publish(Event.UserLoggedIn(<span class="hljs-string">"user123"</span>))
    EventBus.publish(Event.OrderCreated(<span class="hljs-string">"order456"</span>, <span class="hljs-number">99.99</span>))
    EventBus.publish(Event.PaymentProcessed(<span class="hljs-string">"pay789"</span>, <span class="hljs-literal">true</span>))
    EventBus.publish(Event.OrderCreated(<span class="hljs-string">"order999"</span>, <span class="hljs-number">49.99</span>))
    EventBus.publish(Event.PaymentProcessed(<span class="hljs-string">"pay000"</span>, <span class="hljs-literal">false</span>))
    
    delay(<span class="hljs-number">1000</span>) <span class="hljs-comment">// 等待事件处理完成</span>
    
    EventBus.publish(Event.SystemShutdown())
    delay(<span class="hljs-number">1000</span>)
    
    println(<span class="hljs-string">"程序结束"</span>)
}
</code></pre>
<h4 data-id="heading-16"><strong>下一步学习方向</strong></h4>
<p>你现在已经掌握了 Kotlin 的企业级开发技能！接下来可以深入：</p>
<ol>
<li><strong>Kotlin 编译器插件开发</strong>：自定义编译期处理</li>
<li><strong>Kotlin 元编程</strong>：在编译时生成代码</li>
<li><strong>Kotlin 与 Java 互操作高级技巧</strong>：类型映射、异常处理</li>
<li><strong>Kotlin 服务端开发</strong>：使用 Ktor、Spring Boot</li>
<li><strong>Kotlin 前端开发</strong>：使用 Compose for Web</li>
<li><strong>Kotlin 移动端开发</strong>：Compose Multiplatform</li>
</ol>
<p>这些高级特性将让你在 Kotlin 开发中游刃有余，能够构建复杂、高性能的企业级应用！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[kotlin-6]]></title>    <link>https://juejin.cn/post/7576086446460256291</link>    <guid>https://juejin.cn/post/7576086446460256291</guid>    <pubDate>2025-11-24T11:57:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576086446460256291" data-draft-id="7571281406510170163" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="kotlin-6"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2025-11-24T11:57:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风冷"/> <meta itemprop="url" content="https://juejin.cn/user/3843548379091742"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            kotlin-6
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3843548379091742/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风冷
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T11:57:37.000Z" title="Mon Nov 24 2025 11:57:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>太棒了！现在让我们探索 Kotlin 的终极境界——<strong>元编程、编译器插件、深度优化</strong>和<strong>未来特性</strong>。这将带你进入 Kotlin 语言设计的核心领域。</p>
<hr/>
<h3 data-id="heading-0"><strong>Kotlin 终极探索：元编程与语言深度</strong></h3>
<h4 data-id="heading-1"><strong>三十九、注解处理器与代码生成（KSP）</strong></h4>
<h5 data-id="heading-2"><strong>1. 使用 KSP（Kotlin Symbol Processing）</strong></h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 定义注解</span>
<span class="hljs-meta">@Target(AnnotationTarget.CLASS)</span>
<span class="hljs-keyword">annotation</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JsonSerializable</span>

<span class="hljs-meta">@Target(AnnotationTarget.PROPERTY)</span>
<span class="hljs-keyword">annotation</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JsonName</span>(<span class="hljs-keyword">val</span> name: String)

<span class="hljs-meta">@Target(AnnotationTarget.PROPERTY)</span>
<span class="hljs-keyword">annotation</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JsonExclude</span>

<span class="hljs-comment">// 2. 定义数据类（这些将在编译时被处理）</span>
<span class="hljs-meta">@JsonSerializable</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>(
    <span class="hljs-meta">@JsonName(<span class="hljs-string">"person_name"</span>)</span>
    <span class="hljs-keyword">val</span> name: String,
    <span class="hljs-keyword">val</span> age: <span class="hljs-built_in">Int</span>,
    <span class="hljs-meta">@JsonExclude</span>
    <span class="hljs-keyword">val</span> password: String
)

<span class="hljs-comment">// 3. 手动模拟 KSP 处理结果（实际由注解处理器生成）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">PersonSerializer</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">toJson</span><span class="hljs-params">(person: <span class="hljs-type">Person</span>)</span></span>: String {
        <span class="hljs-keyword">return</span> buildString {
            append(<span class="hljs-string">"{"</span>)
            append(<span class="hljs-string">""</span>person_name<span class="hljs-string">": "</span>${person.name}<span class="hljs-string">", "</span>)
            append(<span class="hljs-string">""</span>age<span class="hljs-string">": <span class="hljs-subst">${person.age}</span>"</span>)
            append(<span class="hljs-string">"}"</span>)
        }
    }
    
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fromJson</span><span class="hljs-params">(json: <span class="hljs-type">String</span>)</span></span>: Person {
            <span class="hljs-comment">// 简化的 JSON 解析逻辑</span>
            <span class="hljs-keyword">val</span> name = json.substringAfter(<span class="hljs-string">""</span>person_name<span class="hljs-string">": "</span><span class="hljs-string">").substringBefore("</span><span class="hljs-string">""</span>)
            <span class="hljs-keyword">val</span> age = json.substringAfter(<span class="hljs-string">""</span>age<span class="hljs-string">": "</span>).substringBefore(<span class="hljs-string">"}"</span>).toInt()
            <span class="hljs-keyword">return</span> Person(name, age, <span class="hljs-string">""</span>)
        }
    }
}

<span class="hljs-comment">// 4. 使用生成的序列化器</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">testManualKSP</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> person = Person(<span class="hljs-string">"Alice"</span>, <span class="hljs-number">25</span>, <span class="hljs-string">"secret"</span>)
    <span class="hljs-keyword">val</span> serializer = PersonSerializer()
    <span class="hljs-keyword">val</span> json = serializer.toJson(person)
    println(<span class="hljs-string">"生成的 JSON: <span class="hljs-variable">$json</span>"</span>)
    
    <span class="hljs-keyword">val</span> parsedPerson = PersonSerializer.fromJson(json)
    println(<span class="hljs-string">"解析的对象: <span class="hljs-variable">$parsedPerson</span>"</span>)
}
</code></pre>
<h5 data-id="heading-3"><strong>2. 构建时元编程模式</strong></h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 编译时验证注解</span>
<span class="hljs-meta">@Target(AnnotationTarget.CLASS)</span>
<span class="hljs-keyword">annotation</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Validate</span>(<span class="hljs-keyword">val</span> fields: Array&lt;String&gt;)

<span class="hljs-meta">@Validate(fields = [<span class="hljs-string">"age"</span>, <span class="hljs-string">"email"</span>])</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-keyword">val</span> name: String, <span class="hljs-keyword">val</span> age: <span class="hljs-built_in">Int</span>, <span class="hljs-keyword">val</span> email: String)

<span class="hljs-comment">// 运行时验证逻辑（模拟编译时生成）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserValidator</span> {
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">validate</span><span class="hljs-params">(user: <span class="hljs-type">User</span>)</span></span>: List&lt;String&gt; {
            <span class="hljs-keyword">val</span> errors = mutableListOf&lt;String&gt;()
            
            <span class="hljs-keyword">if</span> (user.age &lt; <span class="hljs-number">0</span>) errors.add(<span class="hljs-string">"年龄不能为负数"</span>)
            <span class="hljs-keyword">if</span> (!user.email.contains(<span class="hljs-string">"@"</span>)) errors.add(<span class="hljs-string">"邮箱格式不正确"</span>)
            
            <span class="hljs-keyword">return</span> errors
        }
    }
}

<span class="hljs-comment">// 使用编译时验证</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">testValidation</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> user = User(<span class="hljs-string">"Bob"</span>, -<span class="hljs-number">5</span>, <span class="hljs-string">"invalid-email"</span>)
    <span class="hljs-keyword">val</span> errors = UserValidator.validate(user)
    
    <span class="hljs-keyword">if</span> (errors.isNotEmpty()) {
        println(<span class="hljs-string">"验证错误: <span class="hljs-subst">${errors.joinToString()}</span>"</span>)
    } <span class="hljs-keyword">else</span> {
        println(<span class="hljs-string">"验证通过"</span>)
    }
}
</code></pre>
<h4 data-id="heading-4"><strong>四十、编译器插件开发基础</strong></h4>
<h5 data-id="heading-5"><strong>1. 自定义编译器扩展模式</strong></h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 定义领域特定语言</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SqlBuilder</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> table: String = <span class="hljs-string">""</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> conditions = mutableListOf&lt;String&gt;()
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> joins = mutableListOf&lt;String&gt;()
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> limit: <span class="hljs-built_in">Int</span>? = <span class="hljs-literal">null</span>
    
    <span class="hljs-keyword">infix</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> String.<span class="hljs-title">eq</span><span class="hljs-params">(value: <span class="hljs-type">Any</span>)</span></span> = <span class="hljs-string">"<span class="hljs-variable">$this</span> = '<span class="hljs-variable">$value</span>'"</span>
    <span class="hljs-keyword">infix</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> String.`<span class="hljs-keyword">in</span>`<span class="hljs-params">(values: <span class="hljs-type">List</span>&lt;<span class="hljs-type">Any</span>&gt;)</span></span> = 
        <span class="hljs-string">"<span class="hljs-variable">$this</span> IN (<span class="hljs-subst">${values.joinToString { <span class="hljs-string">"'<span class="hljs-variable">$it</span>'"</span> }</span>})"</span>
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">from</span><span class="hljs-params">(tableName: <span class="hljs-type">String</span>)</span></span> {
        table = tableName
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">where</span><span class="hljs-params">(condition: <span class="hljs-type">String</span>)</span></span> {
        conditions.add(condition)
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">join</span><span class="hljs-params">(table: <span class="hljs-type">String</span>, on: <span class="hljs-type">String</span>)</span></span> {
        joins.add(<span class="hljs-string">"JOIN <span class="hljs-variable">$table</span> ON <span class="hljs-variable">$on</span>"</span>)
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">limit</span><span class="hljs-params">(count: <span class="hljs-type">Int</span>)</span></span> {
        limit = count
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">build</span><span class="hljs-params">()</span></span>: String {
        <span class="hljs-keyword">val</span> query = StringBuilder(<span class="hljs-string">"SELECT * FROM <span class="hljs-variable">$table</span>"</span>)
        
        <span class="hljs-keyword">if</span> (joins.isNotEmpty()) {
            query.append(<span class="hljs-string">" "</span>).append(joins.joinToString(<span class="hljs-string">" "</span>))
        }
        
        <span class="hljs-keyword">if</span> (conditions.isNotEmpty()) {
            query.append(<span class="hljs-string">" WHERE "</span>).append(conditions.joinToString(<span class="hljs-string">" AND "</span>))
        }
        
        limit?.let {
            query.append(<span class="hljs-string">" LIMIT <span class="hljs-variable">$it</span>"</span>)
        }
        
        <span class="hljs-keyword">return</span> query.toString()
    }
}

<span class="hljs-comment">// 2. 使用 DSL 构建 SQL</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">testSqlBuilder</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> query = SqlBuilder().apply {
        from(<span class="hljs-string">"users"</span>)
        <span class="hljs-keyword">where</span>(<span class="hljs-string">"name"</span> eq <span class="hljs-string">"Alice"</span>)
        <span class="hljs-keyword">where</span>(<span class="hljs-string">"age"</span> `<span class="hljs-keyword">in</span>` listOf(<span class="hljs-number">25</span>, <span class="hljs-number">30</span>, <span class="hljs-number">35</span>))
        join(<span class="hljs-string">"orders"</span>, <span class="hljs-string">"users.id = orders.user_id"</span>)
        limit(<span class="hljs-number">10</span>)
    }.build()
    
    println(<span class="hljs-string">"生成的 SQL: <span class="hljs-variable">$query</span>"</span>)
}
</code></pre>
<h5 data-id="heading-6"><strong>2. 类型安全构建器进阶</strong></h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 类型安全的 HTTP 请求构建器</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">HttpRequestBuilder</span> {
    <span class="hljs-keyword">var</span> method: String = <span class="hljs-string">"GET"</span>
    <span class="hljs-keyword">var</span> url: String = <span class="hljs-string">""</span>
    <span class="hljs-keyword">val</span> headers = mutableMapOf&lt;String, String&gt;()
    <span class="hljs-keyword">var</span> body: String = <span class="hljs-string">""</span>
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">method</span><span class="hljs-params">(method: <span class="hljs-type">String</span>)</span></span> {
        <span class="hljs-keyword">this</span>.method = method
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">url</span><span class="hljs-params">(url: <span class="hljs-type">String</span>)</span></span> {
        <span class="hljs-keyword">this</span>.url = url
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">header</span><span class="hljs-params">(name: <span class="hljs-type">String</span>, value: <span class="hljs-type">String</span>)</span></span> {
        headers[name] = value
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">body</span><span class="hljs-params">(content: <span class="hljs-type">String</span>)</span></span> {
        <span class="hljs-keyword">this</span>.body = content
        header(<span class="hljs-string">"Content-Length"</span>, content.length.toString())
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">execute</span><span class="hljs-params">()</span></span>: String {
        <span class="hljs-comment">// 模拟 HTTP 请求</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"HTTP <span class="hljs-variable">$method</span> <span class="hljs-variable">$url</span> - Headers: <span class="hljs-variable">$headers</span> - Body: <span class="hljs-variable">$body</span>"</span>
    }
}

<span class="hljs-comment">// DSL 扩展函数</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">httpRequest</span><span class="hljs-params">(block: <span class="hljs-type">HttpRequestBuilder</span>.() -&gt; <span class="hljs-type">Unit</span>)</span></span>: String {
    <span class="hljs-keyword">val</span> builder = HttpRequestBuilder()
    builder.block()
    <span class="hljs-keyword">return</span> builder.execute()
}

<span class="hljs-comment">// 使用类型安全构建器</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">testHttpBuilder</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> response = httpRequest {
        method = <span class="hljs-string">"POST"</span>
        url = <span class="hljs-string">"https://api.example.com/users"</span>
        header(<span class="hljs-string">"Authorization"</span>, <span class="hljs-string">"Bearer token123"</span>)
        header(<span class="hljs-string">"Content-Type"</span>, <span class="hljs-string">"application/json"</span>)
        body = <span class="hljs-string">"""{"name": "Alice", "age": 25}"""</span>
    }
    
    println(<span class="hljs-string">"HTTP 响应: <span class="hljs-variable">$response</span>"</span>)
}
</code></pre>
<h4 data-id="heading-7"><strong>四十一、深度性能优化技术</strong></h4>
<h5 data-id="heading-8"><strong>1. 内联类与值类的性能优化</strong></h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@JvmInline</span>
value <span class="hljs-keyword">class</span> <span class="hljs-title class_">Meter</span>(<span class="hljs-keyword">val</span> value: <span class="hljs-built_in">Double</span>) {
    <span class="hljs-keyword">operator</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">plus</span><span class="hljs-params">(other: <span class="hljs-type">Meter</span>)</span></span>: Meter = Meter(value + other.value)
    <span class="hljs-keyword">operator</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">times</span><span class="hljs-params">(factor: <span class="hljs-type">Double</span>)</span></span>: Meter = Meter(value * factor)
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">toKilometers</span><span class="hljs-params">()</span></span>: Kilometer = Kilometer(value / <span class="hljs-number">1000.0</span>)
}

<span class="hljs-meta">@JvmInline</span>
value <span class="hljs-keyword">class</span> <span class="hljs-title class_">Kilometer</span>(<span class="hljs-keyword">val</span> value: <span class="hljs-built_in">Double</span>) {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">toMeters</span><span class="hljs-params">()</span></span>: Meter = Meter(value * <span class="hljs-number">1000.0</span>)
}

<span class="hljs-comment">// 使用内联类进行类型安全计算</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">calculateDistance</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> distance1 = Meter(<span class="hljs-number">500.0</span>)
    <span class="hljs-keyword">val</span> distance2 = Meter(<span class="hljs-number">300.0</span>)
    <span class="hljs-keyword">val</span> total = distance1 + distance2
    <span class="hljs-keyword">val</span> scaled = total * <span class="hljs-number">2.5</span>
    
    println(<span class="hljs-string">"总距离: <span class="hljs-subst">${total.value}</span> 米"</span>)
    println(<span class="hljs-string">"缩放后: <span class="hljs-subst">${scaled.value}</span> 米"</span>)
    println(<span class="hljs-string">"转换为公里: <span class="hljs-subst">${scaled.toKilometers().value}</span> 公里"</span>)
    
    <span class="hljs-comment">// 编译错误：类型安全</span>
    <span class="hljs-comment">// val invalid = distance1 + scaled.toKilometers() // 编译错误！</span>
}

<span class="hljs-comment">// 内联类的集合操作优化</span>
<span class="hljs-meta">@JvmInline</span>
value <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserId</span>(<span class="hljs-keyword">val</span> value: <span class="hljs-built_in">Int</span>)

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">optimizeCollections</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> userIds = listOf(UserId(<span class="hljs-number">1</span>), UserId(<span class="hljs-number">2</span>), UserId(<span class="hljs-number">3</span>))
    
    <span class="hljs-comment">// 这些操作在运行时不会产生包装对象开销</span>
    <span class="hljs-keyword">val</span> mapped = userIds.map { it.value * <span class="hljs-number">2</span> }
    <span class="hljs-keyword">val</span> filtered = userIds.filter { it.value &gt; <span class="hljs-number">1</span> }
    
    println(<span class="hljs-string">"映射结果: <span class="hljs-variable">$mapped</span>"</span>)
    println(<span class="hljs-string">"过滤结果: <span class="hljs-variable">$filtered</span>"</span>)
}
</code></pre>
<h5 data-id="heading-9"><strong>2. 内联函数与 reified 类型参数的高级用法</strong></h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlin.reflect.KClass

<span class="hljs-comment">// 高级 reified 用法</span>
<span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;<span class="hljs-keyword">reified</span> T : Any&gt;</span> <span class="hljs-title">createInstance</span><span class="hljs-params">(<span class="hljs-keyword">vararg</span> args: <span class="hljs-type">Any</span>)</span></span>: T {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">when</span> (T::<span class="hljs-keyword">class</span>) {
        String::<span class="hljs-keyword">class</span> -&gt; <span class="hljs-string">""</span> <span class="hljs-keyword">as</span> T
        <span class="hljs-built_in">Int</span>::<span class="hljs-keyword">class</span> -&gt; <span class="hljs-number">0</span> <span class="hljs-keyword">as</span> T
        List::<span class="hljs-keyword">class</span> -&gt; emptyList&lt;Any&gt;() <span class="hljs-keyword">as</span> T
        Map::<span class="hljs-keyword">class</span> -&gt; emptyMap&lt;Any, Any&gt;() <span class="hljs-keyword">as</span> T
        <span class="hljs-keyword">else</span> -&gt; <span class="hljs-keyword">throw</span> IllegalArgumentException(<span class="hljs-string">"不支持的类型"</span>)
    }
}

<span class="hljs-comment">// 类型安全的验证框架</span>
<span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;<span class="hljs-keyword">reified</span> T&gt;</span> <span class="hljs-title">validate</span><span class="hljs-params">(value: <span class="hljs-type">Any</span>, validator: <span class="hljs-type">T</span>.() -&gt; <span class="hljs-type">Boolean</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">is</span> T) {
        value.validator()
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-literal">false</span>
    }
}

<span class="hljs-comment">// 使用高级内联函数</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">testAdvancedInline</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> stringInstance: String = createInstance()
    <span class="hljs-keyword">val</span> listInstance: List&lt;Any&gt; = createInstance()
    
    println(<span class="hljs-string">"创建的实例: <span class="hljs-variable">$stringInstance</span>, <span class="hljs-variable">$listInstance</span>"</span>)
    
    <span class="hljs-comment">// 类型安全验证</span>
    <span class="hljs-keyword">val</span> email = <span class="hljs-string">"test@example.com"</span>
    <span class="hljs-keyword">val</span> isValidEmail = validate(email) {
        contains(<span class="hljs-string">"@"</span>) &amp;&amp; length &gt; <span class="hljs-number">5</span>
    }
    
    <span class="hljs-keyword">val</span> number = <span class="hljs-number">42</span>
    <span class="hljs-keyword">val</span> isValidNumber = validate(number) {
        <span class="hljs-keyword">this</span> <span class="hljs-keyword">in</span> <span class="hljs-number">1.</span><span class="hljs-number">.100</span>
    }
    
    println(<span class="hljs-string">"邮箱验证: <span class="hljs-variable">$isValidEmail</span>"</span>)
    println(<span class="hljs-string">"数字验证: <span class="hljs-variable">$isValidNumber</span>"</span>)
}
</code></pre>
<h4 data-id="heading-10"><strong>四十二、Kotlin 多平台项目（KMP）高级特性</strong></h4>
<h5 data-id="heading-11"><strong>1. 共享业务逻辑与平台特定实现</strong></h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 通用业务模型</span>
<span class="hljs-keyword">expect</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DateTimeFormatter</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">format</span><span class="hljs-params">(timestamp: <span class="hljs-type">Long</span>)</span></span>: String
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">parse</span><span class="hljs-params">(dateString: <span class="hljs-type">String</span>)</span></span>: <span class="hljs-built_in">Long</span>
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">EventLogger</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> formatter: DateTimeFormatter) {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> events = mutableListOf&lt;String&gt;()
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">logEvent</span><span class="hljs-params">(event: <span class="hljs-type">String</span>)</span></span> {
        <span class="hljs-keyword">val</span> timestamp = System.currentTimeMillis()
        <span class="hljs-keyword">val</span> formattedTime = formatter.format(timestamp)
        events.add(<span class="hljs-string">"[<span class="hljs-variable">$formattedTime</span>] <span class="hljs-variable">$event</span>"</span>)
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getEvents</span><span class="hljs-params">()</span></span>: List&lt;String&gt; = events.toList()
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">clear</span><span class="hljs-params">()</span></span> {
        events.clear()
    }
}

<span class="hljs-comment">// Android 实现</span>
<span class="hljs-keyword">actual</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DateTimeFormatter</span> <span class="hljs-title">actual</span> <span class="hljs-keyword">constructor</span>() {
    <span class="hljs-keyword">actual</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">format</span><span class="hljs-params">(timestamp: <span class="hljs-type">Long</span>)</span></span>: String {
        <span class="hljs-comment">// 使用 Android 的 DateFormat</span>
        <span class="hljs-keyword">return</span> android.text.format.DateFormat.format(<span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>, timestamp).toString()
    }
    
    <span class="hljs-keyword">actual</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">parse</span><span class="hljs-params">(dateString: <span class="hljs-type">String</span>)</span></span>: <span class="hljs-built_in">Long</span> {
        <span class="hljs-comment">// Android 特定的解析逻辑</span>
        <span class="hljs-keyword">return</span> java.text.SimpleDateFormat(<span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>).parse(dateString).time
    }
}

<span class="hljs-comment">// iOS 实现  </span>
<span class="hljs-keyword">actual</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DateTimeFormatter</span> <span class="hljs-title">actual</span> <span class="hljs-keyword">constructor</span>() {
    <span class="hljs-keyword">actual</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">format</span><span class="hljs-params">(timestamp: <span class="hljs-type">Long</span>)</span></span>: String {
        <span class="hljs-comment">// 使用 iOS 的 DateFormatter</span>
        <span class="hljs-keyword">val</span> formatter = iosFoundation.NSDateFormatter()
        formatter.dateFormat = <span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>
        <span class="hljs-keyword">return</span> formatter.stringFromDate(iosFoundation.NSDate(timestamp))
    }
    
    <span class="hljs-keyword">actual</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">parse</span><span class="hljs-params">(dateString: <span class="hljs-type">String</span>)</span></span>: <span class="hljs-built_in">Long</span> {
        <span class="hljs-keyword">val</span> formatter = iosFoundation.NSDateFormatter()
        formatter.dateFormat = <span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>
        <span class="hljs-keyword">return</span> formatter.dateFromString(dateString)?.timeIntervalSince1970?.toLong() ?: <span class="hljs-number">0L</span>
    }
}
</code></pre>
<h5 data-id="heading-12"><strong>2. KMP 中的并发处理</strong></h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">expect</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PlatformCoroutineDispatcher</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">dispatch</span><span class="hljs-params">(block: () -&gt; <span class="hljs-type">Unit</span>)</span></span>
}

<span class="hljs-keyword">actual</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PlatformCoroutineDispatcher</span> <span class="hljs-title">actual</span> <span class="hljs-keyword">constructor</span>() {
    <span class="hljs-keyword">actual</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">dispatch</span><span class="hljs-params">(block: () -&gt; <span class="hljs-type">Unit</span>)</span></span> {
        <span class="hljs-comment">// Android: Handler(Looper.getMainLooper()).post(block)</span>
        <span class="hljs-comment">// iOS: DispatchQueue.main.async { block() }</span>
        block() <span class="hljs-comment">// 简化实现</span>
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CrossPlatformService</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> dispatcher: PlatformCoroutineDispatcher) {
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fetchData</span><span class="hljs-params">()</span></span>: String = withContext(createDispatcherContext(dispatcher)) {
        delay(<span class="hljs-number">1000</span>) <span class="hljs-comment">// 模拟网络请求</span>
        <span class="hljs-string">"跨平台数据"</span>
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createDispatcherContext</span><span class="hljs-params">(dispatcher: <span class="hljs-type">PlatformCoroutineDispatcher</span>)</span></span> = 
        <span class="hljs-keyword">object</span> : CoroutineDispatcher() {
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">dispatch</span><span class="hljs-params">(context: <span class="hljs-type">CoroutineContext</span>, block: <span class="hljs-type">Runnable</span>)</span></span> {
                dispatcher.dispatch { block.run() }
            }
        }
}
</code></pre>
<h4 data-id="heading-13"><strong>四十三、Kotlin 未来特性探索</strong></h4>
<h5 data-id="heading-14"><strong>1. 上下文接收器（Context Receivers）原型</strong></h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 模拟上下文接收器功能</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">DatabaseContext</span> {
    <span class="hljs-keyword">val</span> connection: DatabaseConnection
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">LoggingContext</span> {
    <span class="hljs-keyword">val</span> logger: Logger
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseConnection</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">executeQuery</span><span class="hljs-params">(sql: <span class="hljs-type">String</span>)</span></span>: String = <span class="hljs-string">"查询结果: <span class="hljs-variable">$sql</span>"</span>
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Logger</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">info</span><span class="hljs-params">(message: <span class="hljs-type">String</span>)</span></span> = println(<span class="hljs-string">"[INFO] <span class="hljs-variable">$message</span>"</span>)
}

<span class="hljs-comment">// 使用上下文参数模拟上下文接收器</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> dbContext: DatabaseContext,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> logContext: LoggingContext
) {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUser</span><span class="hljs-params">(id: <span class="hljs-type">Int</span>)</span></span>: String {
        logContext.logger.info(<span class="hljs-string">"获取用户 <span class="hljs-variable">$id</span>"</span>)
        <span class="hljs-keyword">return</span> dbContext.connection.executeQuery(<span class="hljs-string">"SELECT * FROM users WHERE id = <span class="hljs-variable">$id</span>"</span>)
    }
}

<span class="hljs-comment">// 简化使用方式</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">testContextReceivers</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> dbContext = <span class="hljs-keyword">object</span> : DatabaseContext {
        <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> connection = DatabaseConnection()
    }
    
    <span class="hljs-keyword">val</span> logContext = <span class="hljs-keyword">object</span> : LoggingContext {
        <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> logger = Logger()
    }
    
    <span class="hljs-keyword">val</span> userService = UserService(dbContext, logContext)
    <span class="hljs-keyword">val</span> result = userService.getUser(<span class="hljs-number">1</span>)
    println(result)
}
</code></pre>
<h5 data-id="heading-15"><strong>2. 自定义操作符与 DSL 深度集成</strong></h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 自定义数学 DSL</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Vector</span>(<span class="hljs-keyword">val</span> x: <span class="hljs-built_in">Double</span>, <span class="hljs-keyword">val</span> y: <span class="hljs-built_in">Double</span>, <span class="hljs-keyword">val</span> z: <span class="hljs-built_in">Double</span>) {
    <span class="hljs-keyword">operator</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">plus</span><span class="hljs-params">(other: <span class="hljs-type">Vector</span>)</span></span>: Vector = 
        Vector(x + other.x, y + other.y, z + other.z)
    
    <span class="hljs-keyword">operator</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">minus</span><span class="hljs-params">(other: <span class="hljs-type">Vector</span>)</span></span>: Vector =
        Vector(x - other.x, y - other.y, z - other.z)
    
    <span class="hljs-keyword">operator</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">times</span><span class="hljs-params">(scalar: <span class="hljs-type">Double</span>)</span></span>: Vector =
        Vector(x * scalar, y * scalar, z * scalar)
    
    <span class="hljs-keyword">infix</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">dot</span><span class="hljs-params">(other: <span class="hljs-type">Vector</span>)</span></span>: <span class="hljs-built_in">Double</span> =
        x * other.x + y * other.y + z * other.z
    
    <span class="hljs-keyword">infix</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">cross</span><span class="hljs-params">(other: <span class="hljs-type">Vector</span>)</span></span>: Vector =
        Vector(
            y * other.z - z * other.y,
            z * other.x - x * other.z,
            x * other.y - y * other.x
        )
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">toString</span><span class="hljs-params">()</span></span>: String = <span class="hljs-string">"(<span class="hljs-variable">$x</span>, <span class="hljs-variable">$y</span>, <span class="hljs-variable">$z</span>)"</span>
}

<span class="hljs-comment">// 向量运算 DSL</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">vector</span><span class="hljs-params">(block: <span class="hljs-type">VectorBuilder</span>.() -&gt; <span class="hljs-type">Unit</span>)</span></span>: Vector {
    <span class="hljs-keyword">val</span> builder = VectorBuilder()
    builder.block()
    <span class="hljs-keyword">return</span> builder.build()
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">VectorBuilder</span> {
    <span class="hljs-keyword">var</span> x = <span class="hljs-number">0.0</span>
    <span class="hljs-keyword">var</span> y = <span class="hljs-number">0.0</span>
    <span class="hljs-keyword">var</span> z = <span class="hljs-number">0.0</span>
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">x</span><span class="hljs-params">(value: <span class="hljs-type">Double</span>)</span></span> { x = value }
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">y</span><span class="hljs-params">(value: <span class="hljs-type">Double</span>)</span></span> { y = value }
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">z</span><span class="hljs-params">(value: <span class="hljs-type">Double</span>)</span></span> { z = value }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">build</span><span class="hljs-params">()</span></span>: Vector = Vector(x, y, z)
}

<span class="hljs-comment">// 使用向量 DSL</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">testVectorDSL</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> v1 = vector { x(<span class="hljs-number">1.0</span>); y(<span class="hljs-number">2.0</span>); z(<span class="hljs-number">3.0</span>) }
    <span class="hljs-keyword">val</span> v2 = vector { x(<span class="hljs-number">4.0</span>); y(<span class="hljs-number">5.0</span>); z(<span class="hljs-number">6.0</span>) }
    
    <span class="hljs-keyword">val</span> sum = v1 + v2
    <span class="hljs-keyword">val</span> difference = v1 - v2
    <span class="hljs-keyword">val</span> scaled = v1 * <span class="hljs-number">2.5</span>
    <span class="hljs-keyword">val</span> dotProduct = v1 dot v2
    <span class="hljs-keyword">val</span> crossProduct = v1 cross v2
    
    println(<span class="hljs-string">"向量运算结果:"</span>)
    println(<span class="hljs-string">"和: <span class="hljs-variable">$sum</span>"</span>)
    println(<span class="hljs-string">"差: <span class="hljs-variable">$difference</span>"</span>)
    println(<span class="hljs-string">"缩放: <span class="hljs-variable">$scaled</span>"</span>)
    println(<span class="hljs-string">"点积: <span class="hljs-variable">$dotProduct</span>"</span>)
    println(<span class="hljs-string">"叉积: <span class="hljs-variable">$crossProduct</span>"</span>)
}
</code></pre>
<h4 data-id="heading-16"><strong>四十四、Kotlin 元编程终极实战：构建迷你框架</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlin.reflect.full.*

<span class="hljs-comment">// 迷你依赖注入框架</span>
<span class="hljs-keyword">annotation</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Inject</span>
<span class="hljs-keyword">annotation</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Singleton</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DIContainer</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> instances = mutableMapOf&lt;KClass&lt;*&gt;, Any&gt;()
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> bindings = mutableMapOf&lt;KClass&lt;*&gt;, KClass&lt;*&gt;&gt;()
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T : Any&gt;</span> <span class="hljs-title">register</span><span class="hljs-params">(clazz: <span class="hljs-type">KClass</span>&lt;<span class="hljs-type">T</span>&gt;)</span></span> {
        instances[clazz] = createInstance(clazz)
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T : Any&gt;</span> <span class="hljs-title">register</span><span class="hljs-params">(interfaceClass: <span class="hljs-type">KClass</span>&lt;<span class="hljs-type">T</span>&gt;, implementationClass: <span class="hljs-type">KClass</span>&lt;<span class="hljs-type">out</span> <span class="hljs-type">T</span>&gt;)</span></span> {
        bindings[interfaceClass] = implementationClass
    }
    
    <span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;<span class="hljs-keyword">reified</span> T : Any&gt;</span> <span class="hljs-title">get</span><span class="hljs-params">()</span></span>: T {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">get</span>(T::<span class="hljs-keyword">class</span>)
    }
    
    <span class="hljs-meta">@Suppress(<span class="hljs-string">"UNCHECKED_CAST"</span>)</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T : Any&gt;</span> <span class="hljs-title">get</span><span class="hljs-params">(clazz: <span class="hljs-type">KClass</span>&lt;<span class="hljs-type">T</span>&gt;)</span></span>: T {
        <span class="hljs-comment">// 检查单例实例</span>
        <span class="hljs-keyword">if</span> (instances.containsKey(clazz)) {
            <span class="hljs-keyword">return</span> instances[clazz] <span class="hljs-keyword">as</span> T
        }
        
        <span class="hljs-comment">// 检查接口绑定</span>
        <span class="hljs-keyword">val</span> targetClass = bindings[clazz] ?: clazz
        
        <span class="hljs-comment">// 创建新实例</span>
        <span class="hljs-keyword">val</span> instance = createInstance(targetClass <span class="hljs-keyword">as</span> KClass&lt;T&gt;)
        
        <span class="hljs-comment">// 如果是单例，保存实例</span>
        <span class="hljs-keyword">if</span> (targetClass.hasAnnotation&lt;Singleton&gt;()) {
            instances[clazz] = instance
        }
        
        <span class="hljs-keyword">return</span> instance
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T : Any&gt;</span> <span class="hljs-title">createInstance</span><span class="hljs-params">(clazz: <span class="hljs-type">KClass</span>&lt;<span class="hljs-type">T</span>&gt;)</span></span>: T {
        <span class="hljs-keyword">val</span> <span class="hljs-keyword">constructor</span> = clazz.primaryConstructor
            ?: <span class="hljs-keyword">throw</span> IllegalArgumentException(<span class="hljs-string">"类 <span class="hljs-subst">${clazz.simpleName}</span> 没有主构造函数"</span>)
        
        <span class="hljs-keyword">val</span> parameters = <span class="hljs-keyword">constructor</span>.parameters.map { param -&gt;
            <span class="hljs-keyword">if</span> (param.hasAnnotation&lt;Inject&gt;()) {
                <span class="hljs-keyword">get</span>(param.type.classifier <span class="hljs-keyword">as</span> KClass&lt;*&gt;)
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">throw</span> IllegalArgumentException(<span class="hljs-string">"无法解析依赖: <span class="hljs-subst">${param.name}</span>"</span>)
            }
        }
        
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">constructor</span>.call(*parameters.toTypedArray())
    }
}

<span class="hljs-comment">// 使用迷你 DI 框架</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserRepository</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">findUser</span><span class="hljs-params">(id: <span class="hljs-type">Int</span>)</span></span>: String
}

<span class="hljs-meta">@Singleton</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseUserRepository</span> <span class="hljs-meta">@Inject</span> <span class="hljs-keyword">constructor</span>() : UserRepository {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">findUser</span><span class="hljs-params">(id: <span class="hljs-type">Int</span>)</span></span>: String = <span class="hljs-string">"用户 <span class="hljs-variable">$id</span> 来自数据库"</span>
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUser</span><span class="hljs-params">(id: <span class="hljs-type">Int</span>)</span></span>: String
}

<span class="hljs-meta">@Singleton</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImpl</span> <span class="hljs-meta">@Inject</span> <span class="hljs-keyword">constructor</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> userRepository: UserRepository
) : UserService {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUser</span><span class="hljs-params">(id: <span class="hljs-type">Int</span>)</span></span>: String {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"服务: <span class="hljs-subst">${userRepository.findUser(id)}</span>"</span>
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> <span class="hljs-meta">@Inject</span> <span class="hljs-keyword">constructor</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> userService: UserService
) {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">showUser</span><span class="hljs-params">(id: <span class="hljs-type">Int</span>)</span></span>: String {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"控制器: <span class="hljs-subst">${userService.getUser(id)}</span>"</span>
    }
}

<span class="hljs-comment">// 测试迷你框架</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">testMiniDI</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> container = DIContainer()
    
    <span class="hljs-comment">// 注册依赖</span>
    container.register(UserRepository::<span class="hljs-keyword">class</span>, DatabaseUserRepository::<span class="hljs-keyword">class</span>)
    container.register(UserService::<span class="hljs-keyword">class</span>, UserServiceImpl::<span class="hljs-keyword">class</span>)
    container.register(UserController::<span class="hljs-keyword">class</span>)
    
    <span class="hljs-comment">// 使用依赖注入</span>
    <span class="hljs-keyword">val</span> controller = container.<span class="hljs-keyword">get</span>&lt;UserController&gt;()
    <span class="hljs-keyword">val</span> result = controller.showUser(<span class="hljs-number">1</span>)
    
    println(<span class="hljs-string">"DI 框架测试结果: <span class="hljs-variable">$result</span>"</span>)
    
    <span class="hljs-comment">// 验证单例模式</span>
    <span class="hljs-keyword">val</span> repo1 = container.<span class="hljs-keyword">get</span>&lt;UserRepository&gt;()
    <span class="hljs-keyword">val</span> repo2 = container.<span class="hljs-keyword">get</span>&lt;UserRepository&gt;()
    println(<span class="hljs-string">"单例验证: <span class="hljs-subst">${repo1 === repo2}</span>"</span>) <span class="hljs-comment">// 应该输出 true</span>
}
</code></pre>
<h4 data-id="heading-17"><strong>四十五、Kotlin 性能监控与调试</strong></h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 性能监控工具类</span>
<span class="hljs-keyword">object</span> PerformanceMonitor {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> timings = mutableMapOf&lt;String, <span class="hljs-built_in">Long</span>&gt;()
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> counters = mutableMapOf&lt;String, <span class="hljs-built_in">Int</span>&gt;()
    
    <span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> <span class="hljs-title">measure</span><span class="hljs-params">(operation: <span class="hljs-type">String</span>, block: () -&gt; <span class="hljs-type">T</span>)</span></span>: T {
        <span class="hljs-keyword">val</span> startTime = System.nanoTime()
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> block()
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">val</span> duration = System.nanoTime() - startTime
            timings.merge(operation, duration) { old, new -&gt; (old + new) / <span class="hljs-number">2</span> }
            counters.merge(operation, <span class="hljs-number">1</span>) { old, new -&gt; old + new }
            println(<span class="hljs-string">"<span class="hljs-variable">$operation</span> 耗时: <span class="hljs-subst">${duration / <span class="hljs-number">1</span>_000_000}</span>ms"</span>)
        }
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">printStatistics</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"\n=== 性能统计 ==="</span>)
        timings.forEach { (operation, avgTime) -&gt;
            <span class="hljs-keyword">val</span> count = counters[operation] ?: <span class="hljs-number">0</span>
            println(<span class="hljs-string">"<span class="hljs-variable">$operation</span>: 平均 <span class="hljs-subst">${avgTime / <span class="hljs-number">1</span>_000_000}</span>ms (调用 <span class="hljs-variable">$count</span> 次)"</span>)
        }
    }
}

<span class="hljs-comment">// 使用性能监控</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">testPerformanceMonitoring</span><span class="hljs-params">()</span></span> {
    PerformanceMonitor.measure(<span class="hljs-string">"数据加载"</span>) {
        Thread.sleep(<span class="hljs-number">500</span>) <span class="hljs-comment">// 模拟耗时操作</span>
    }
    
    PerformanceMonitor.measure(<span class="hljs-string">"数据处理"</span>) {
        repeat(<span class="hljs-number">1000</span>) { i -&gt;
            PerformanceMonitor.measure(<span class="hljs-string">"内部操作"</span>) {
                <span class="hljs-comment">// 模拟内部操作</span>
                Math.sqrt(i.toDouble())
            }
        }
    }
    
    PerformanceMonitor.printStatistics()
}
</code></pre>
<h4 data-id="heading-18"><strong>下一步：成为 Kotlin 专家</strong></h4>
<p>你现在已经掌握了 Kotlin 的终极技能！接下来可以：</p>
<ol>
<li><strong>参与 Kotlin 编译器开发</strong>：贡献给 Kotlin 语言本身</li>
<li><strong>开发 Kotlin 编译器插件</strong>：创建自定义语言特性</li>
<li><strong>研究 Kotlin 编译器内部机制</strong>：理解类型推断、代码生成</li>
<li><strong>探索 Kotlin 多平台前沿</strong>：实验性特性和新平台支持</li>
<li><strong>贡献开源 Kotlin 项目</strong>：成为 Kotlin 生态系统的一部分</li>
</ol>
<p>你已经从 Kotlin 新手成长为可以探索语言设计深度的专家！继续实践，将这些高级技术应用到实际项目中，创造真正优秀的技术解决方案。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Qt 6 实战：C++ 调用 QML 回调方法（异步场景完整实现）]]></title>    <link>https://juejin.cn/post/7576108254604099627</link>    <guid>https://juejin.cn/post/7576108254604099627</guid>    <pubDate>2025-11-24T11:58:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576108254604099627" data-draft-id="7576108254604083243" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Qt 6 实战：C++ 调用 QML 回调方法（异步场景完整实现）"/> <meta itemprop="keywords" content="前端,Qt,C++"/> <meta itemprop="datePublished" content="2025-11-24T11:58:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="喵个咪"/> <meta itemprop="url" content="https://juejin.cn/user/1350630784901262"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Qt 6 实战：C++ 调用 QML 回调方法（异步场景完整实现）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1350630784901262/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    喵个咪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T11:58:34.000Z" title="Mon Nov 24 2025 11:58:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Qt 6 实战：C++ 调用 QML 回调方法（异步场景完整实现）</h2>
<p>在 Qt 6 开发中，C++ 与 QML 混合编程是常见场景。当 C++ 处理异步操作（如登录验证、网络请求、数据库查询）时，需要将结果通知给 QML 界面，<strong>回调函数</strong>是最直观的通信方式之一。本文将基于你提供的代码框架，补充关键细节、修复潜在问题，并完整实现从 C++ 调用 QML 回调的全流程。</p>
<h3 data-id="heading-1">一、核心场景说明</h3>
<p>我们需要实现：</p>
<ol>
<li>QML 调用 C++ 的 <code>login</code> 方法（传入用户名、密码和两个回调函数：成功回调 <code>onSuccess</code>、失败回调 <code>onFailure</code>）；</li>
<li>C++ 异步处理登录逻辑（模拟耗时操作）；</li>
<li>登录完成后，C++ 调用对应的 QML 回调函数，将结果（成功响应 / 错误信息）传递给 QML。</li>
</ol>
<h3 data-id="heading-2">二、Step 1：完善 C++ 服务类</h3>
<h4 data-id="heading-3">1.1 基础配置（必须继承 QObject）</h4>
<p>QML 能调用的 C++ 方法 / 属性，依赖 Qt 的元对象系统（MOC），因此 <code>AuthenticationService</code> 必须：</p>
<ul>
<li>继承 <code>QObject</code>；</li>
<li>添加 <code>Q_OBJECT</code> 宏；</li>
<li>用 <code>Q_INVOKABLE</code> 标记需要暴露给 QML 的方法。</li>
</ul>
<h4 data-id="heading-4">1.2 完整 C++ 代码实现</h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// authentication_service.h</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;QObject&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;QJSValue&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;QJSEngine&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;QtConcurrent&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;QThread&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;QMetaObject&gt;</span></span>

<span class="hljs-comment">// 自定义错误类：封装错误码、错误信息</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">KratosError</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">KratosError</span>(<span class="hljs-type">int</span> code, <span class="hljs-type">const</span> QString&amp; message, <span class="hljs-type">const</span> QString&amp; details = <span class="hljs-string">""</span>)
        : <span class="hljs-built_in">m_code</span>(code), <span class="hljs-built_in">m_message</span>(message), <span class="hljs-built_in">m_details</span>(details) {}

    <span class="hljs-comment">// 转换为 QJSValue，供 QML 访问属性</span>
    <span class="hljs-function">QJSValue <span class="hljs-title">toQJSValue</span><span class="hljs-params">(QJSEngine&amp; engine)</span> <span class="hljs-type">const</span> </span>{
        QJSValue errorObj = engine.<span class="hljs-built_in">newObject</span>();
        errorObj.<span class="hljs-built_in">setProperty</span>(<span class="hljs-string">"code"</span>, m_code);       <span class="hljs-comment">// 错误码（如 401 未授权）</span>
        errorObj.<span class="hljs-built_in">setProperty</span>(<span class="hljs-string">"message"</span>, m_message); <span class="hljs-comment">// 错误提示</span>
        errorObj.<span class="hljs-built_in">setProperty</span>(<span class="hljs-string">"details"</span>, m_details); <span class="hljs-comment">// 详细信息（可选）</span>
        <span class="hljs-keyword">return</span> errorObj;
    }

<span class="hljs-keyword">private</span>:
    <span class="hljs-type">int</span> m_code;
    QString m_message;
    QString m_details;
};

<span class="hljs-comment">// 登录成功响应类：封装返回数据</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">LoginResponse</span> {
    QString token;     <span class="hljs-comment">// 身份令牌</span>
    QString username;  <span class="hljs-comment">// 用户名</span>
    <span class="hljs-type">int</span> userId;        <span class="hljs-comment">// 用户 ID</span>

    <span class="hljs-comment">// 转换为 QJSValue，供 QML 访问属性</span>
    <span class="hljs-function">QJSValue <span class="hljs-title">toQJSValue</span><span class="hljs-params">(QJSEngine&amp; engine)</span> <span class="hljs-type">const</span> </span>{
        QJSValue respObj = engine.<span class="hljs-built_in">newObject</span>();
        respObj.<span class="hljs-built_in">setProperty</span>(<span class="hljs-string">"token"</span>, token);
        respObj.<span class="hljs-built_in">setProperty</span>(<span class="hljs-string">"username"</span>, username);
        respObj.<span class="hljs-built_in">setProperty</span>(<span class="hljs-string">"userId"</span>, userId);
        <span class="hljs-keyword">return</span> respObj;
    }
};

<span class="hljs-comment">// 认证服务类（单例模式）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthenticationService</span> : <span class="hljs-keyword">public</span> QObject {
    Q_OBJECT <span class="hljs-comment">// 必须添加，启用元对象系统</span>
<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">// 单例获取方法（线程安全）</span>
    <span class="hljs-function"><span class="hljs-type">static</span> AuthenticationService* <span class="hljs-title">instance</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-type">static</span> QMutex mutex;
        <span class="hljs-keyword">if</span> (!m_instance) {
            mutex.<span class="hljs-built_in">lock</span>();
            <span class="hljs-keyword">if</span> (!m_instance) {
                m_instance = <span class="hljs-keyword">new</span> <span class="hljs-built_in">AuthenticationService</span>();
            }
            mutex.<span class="hljs-built_in">unlock</span>();
        }
        <span class="hljs-keyword">return</span> m_instance;
    }

    <span class="hljs-comment">// 禁止拷贝构造和赋值</span>
    <span class="hljs-built_in">AuthenticationService</span>(<span class="hljs-type">const</span> AuthenticationService&amp;) = <span class="hljs-keyword">delete</span>;
    AuthenticationService&amp; <span class="hljs-keyword">operator</span>=(<span class="hljs-type">const</span> AuthenticationService&amp;) = <span class="hljs-keyword">delete</span>;

    <span class="hljs-comment">// 暴露给 QML 的登录方法</span>
    <span class="hljs-function">Q_INVOKABLE <span class="hljs-type">void</span> <span class="hljs-title">login</span><span class="hljs-params">(
        <span class="hljs-type">const</span> QString&amp; username,
        <span class="hljs-type">const</span> QString&amp; password,
        <span class="hljs-type">const</span> QJSValue&amp; onSuccess,  <span class="hljs-comment">// QML 传入的成功回调</span>
        <span class="hljs-type">const</span> QJSValue&amp; onFailure   <span class="hljs-comment">// QML 传入的失败回调</span>
    )</span></span>;

<span class="hljs-keyword">private</span>:
    <span class="hljs-built_in">AuthenticationService</span>(QObject* parent = <span class="hljs-literal">nullptr</span>) : <span class="hljs-built_in">QObject</span>(parent) {}
    <span class="hljs-type">static</span> AuthenticationService* m_instance;
};

<span class="hljs-comment">// authentication_service.cpp</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"authentication_service.h"</span></span>

AuthenticationService* AuthenticationService::m_instance = <span class="hljs-literal">nullptr</span>;

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">AuthenticationService::login</span><span class="hljs-params">(
    <span class="hljs-type">const</span> QString&amp; username,
    <span class="hljs-type">const</span> QString&amp; password,
    <span class="hljs-type">const</span> QJSValue&amp; onSuccess,
    <span class="hljs-type">const</span> QJSValue&amp; onFailure
)</span> </span>{
    <span class="hljs-comment">// 1. 有效性检查：确保 QJSEngine 和回调函数有效</span>
    QJSEngine* engine = <span class="hljs-built_in">qjsEngine</span>(<span class="hljs-keyword">this</span>);
    <span class="hljs-keyword">if</span> (!engine) {
        <span class="hljs-built_in">qWarning</span>() &lt;&lt; <span class="hljs-string">"[AuthService] 失败：无法获取 QJSEngine 上下文"</span>;
        <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">if</span> (!onSuccess.<span class="hljs-built_in">isCallable</span>() &amp;&amp; !onFailure.<span class="hljs-built_in">isCallable</span>()) {
        <span class="hljs-built_in">qWarning</span>() &lt;&lt; <span class="hljs-string">"[AuthService] 警告：未传入有效回调函数"</span>;
        <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// 2. 异步处理登录逻辑（模拟耗时操作：如网络请求、数据库验证）</span>
    <span class="hljs-comment">// 用 QtConcurrent::run 开启后台线程，避免阻塞 UI 线程</span>
    QtConcurrent::<span class="hljs-built_in">run</span>([=, <span class="hljs-keyword">this</span>]() {
        <span class="hljs-comment">// 模拟耗时 2 秒（实际场景替换为真实登录逻辑）</span>
        QThread::<span class="hljs-built_in">sleep</span>(<span class="hljs-number">2</span>);

        <span class="hljs-comment">// 3. 模拟登录验证结果（实际场景替换为真实校验逻辑）</span>
        <span class="hljs-type">bool</span> isLoginSuccess = (username == <span class="hljs-string">"admin"</span> &amp;&amp; password == <span class="hljs-string">"123456"</span>);

        <span class="hljs-comment">// 4. 切换回主线程执行回调（关键！QJSValue 必须在创建它的线程调用）</span>
        QMetaObject::<span class="hljs-built_in">invokeMethod</span>(<span class="hljs-keyword">this</span>, [=, <span class="hljs-keyword">this</span>]() {
            <span class="hljs-keyword">if</span> (isLoginSuccess) {
                <span class="hljs-comment">// 登录成功：构造响应对象，调用 onSuccess 回调</span>
                <span class="hljs-keyword">if</span> (onSuccess.<span class="hljs-built_in">isCallable</span>()) {
                    LoginResponse resp;
                    resp.token = <span class="hljs-string">"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."</span>;
                    resp.username = username;
                    resp.userId = <span class="hljs-number">1001</span>;

                    QJSValueList args;
                    args &lt;&lt; resp.<span class="hljs-built_in">toQJSValue</span>(*engine); <span class="hljs-comment">// 传入响应数据</span>
                    onSuccess.<span class="hljs-built_in">call</span>(args);             <span class="hljs-comment">// 调用 QML 成功回调</span>
                }
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 登录失败：构造错误对象，调用 onFailure 回调</span>
                <span class="hljs-keyword">if</span> (onFailure.<span class="hljs-built_in">isCallable</span>()) {
                    KratosError <span class="hljs-built_in">error</span>(<span class="hljs-number">401</span>, <span class="hljs-string">"登录失败"</span>, <span class="hljs-string">"用户名或密码错误"</span>);

                    QJSValueList args;
                    args &lt;&lt; error.<span class="hljs-built_in">toQJSValue</span>(*engine); <span class="hljs-comment">// 传入错误信息</span>
                    onFailure.<span class="hljs-built_in">call</span>(args);              <span class="hljs-comment">// 调用 QML 失败回调</span>
                }
            }
        }, Qt::QueuedConnection); <span class="hljs-comment">// 队列连接：确保在主线程执行</span>
    });
}
</code></pre>
<h3 data-id="heading-5">三、Step 2：注册 C++ 单例到 QML</h3>
<p>在 <code>main.cpp</code> 中，将 <code>AuthenticationService</code> 单例注册到 QML 上下文，让 QML 可以直接访问：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// main.cpp</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;QGuiApplication&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;QQmlApplicationEngine&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"authentication_service.h"</span></span>

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span> </span>{
    <span class="hljs-function">QGuiApplication <span class="hljs-title">app</span><span class="hljs-params">(argc, argv)</span></span>;

    QQmlApplicationEngine engine;

    <span class="hljs-comment">// 注册 C++ 单例到 QML（模块名：backend，版本：1.0，对象名：AuthenticationService）</span>
    <span class="hljs-built_in">qmlRegisterSingletonInstance</span>(
        <span class="hljs-string">"backend"</span>,                <span class="hljs-comment">// QML 导入时的模块名</span>
        <span class="hljs-number">1</span>, <span class="hljs-number">0</span>,                     <span class="hljs-comment">// 版本号（需与 QML import 一致）</span>
        <span class="hljs-string">"AuthenticationService"</span>,  <span class="hljs-comment">// QML 中访问的对象名</span>
        AuthenticationService::<span class="hljs-built_in">instance</span>() <span class="hljs-comment">// 单例实例</span>
    );

    <span class="hljs-comment">// 加载 QML 主文件</span>
    <span class="hljs-function"><span class="hljs-type">const</span> QUrl <span class="hljs-title">url</span><span class="hljs-params">(<span class="hljs-string">u"qrc:/LoginDemo/main.qml"</span>_qs)</span></span>;
    QObject::<span class="hljs-built_in">connect</span>(&amp;engine, &amp;QQmlApplicationEngine::objectCreationFailed,
        &amp;app, []() { QCoreApplication::<span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>); },
        Qt::QueuedConnection);
    engine.<span class="hljs-built_in">load</span>(url);

    <span class="hljs-keyword">return</span> app.<span class="hljs-built_in">exec</span>();
}
</code></pre>
<p><strong>关键注意：</strong></p>
<ul>
<li>注册时模块名（<code>backend</code>）、版本号（<code>1.0</code>）必须与 QML 中的 <code>import</code> 语句一致；</li>
<li>单例注册需用 <code>qmlRegisterSingletonInstance</code>（Qt 5.15+ 支持，Qt 6 推荐），而非 <code>qmlRegisterSingletonType</code>（后者适合动态创建单例）。</li>
</ul>
<h3 data-id="heading-6">四、Step 3：QML 中调用 C++ 方法并处理回调</h3>
<p>在 QML 界面中，导入注册的模块，调用 <code>AuthenticationService.login</code> 并传入回调函数：</p>
<pre><code class="hljs language-qml" lang="qml">// main.qml
import QtQuick 6.2
import QtQuick.Controls 6.2
import backend 1.0 // 导入 C++ 注册的模块（需与注册时的模块名、版本一致）

ApplicationWindow {
    width: 400
    height: 300
    title: "登录演示"
    visible: true

    ColumnLayout {
        anchors.centerIn: parent
        spacing: 16

        TextField {
            id: usernameField
            placeholderText: "输入用户名"
            Layout.width: 250
            text: "admin" // 测试用默认值
        }

        TextField {
            id: passwordField
            placeholderText: "输入密码"
            echoMode: TextField.Password
            Layout.width: 250
            text: "123456" // 测试用默认值（正确密码）
            // text: "wrong" // 测试失败场景
        }

        Button {
            text: "登录"
            Layout.width: 250
            onClicked: {
                // 调用 C++ 的 login 方法，传入回调函数
                AuthenticationService.login(
                    usernameField.text,
                    passwordField.text,
                    // 成功回调：接收 C++ 传递的响应数据
                    function(response) {
                        console.log("登录成功！响应：", JSON.stringify(response))
                        // 访问响应属性（C++ 中 LoginResponse 的字段）
                        console.log("Token:", response.token)
                        console.log("用户名:", response.username)
                    },
                    // 失败回调：接收 C++ 传递的错误信息
                    function(error) {
                        console.log("登录失败！错误码：", error.code, " 信息：", error.message)
                        // 在界面显示错误提示
                        errorLabel.text = error.message
                    }
                )
            }
        }

        Label {
            id: errorLabel
            color: "red"
            Layout.width: 250
            horizontalAlignment: Text.AlignCenter
        }
    }
}
</code></pre>
<h3 data-id="heading-7">五、核心技术关键点解析</h3>
<h4 data-id="heading-8">1. QJSValue：C++ 与 QML 回调的桥梁</h4>
<ul>
<li><code>QJSValue</code> 是 Qt 中封装 JavaScript 值的类，支持存储函数、对象、基本类型等；</li>
<li>用 <code>isCallable()</code> 检查是否为可调用的 JavaScript 函数（回调）；</li>
<li>用 <code>call(QJSValueList args)</code> 调用回调函数，参数通过 <code>QJSValueList</code> 传递。</li>
</ul>
<h4 data-id="heading-9">2. 线程安全（重中之重）</h4>
<ul>
<li>QML 的 <code>QJSEngine</code> 是<strong>线程关联</strong>的（默认绑定主线程），直接在后台线程调用 <code>QJSValue::call</code> 会导致崩溃；</li>
<li>解决方案：用 <code>QMetaObject::invokeMethod</code> + <code>Qt::QueuedConnection</code>，将回调调用切换到主线程执行。</li>
</ul>
<h4 data-id="heading-10">3. 自定义数据类型转 QJSValue</h4>
<ul>
<li>自定义类（如 <code>KratosError</code>、<code>LoginResponse</code>）需提供 toQJSValue 方法，通过 <code>QJSEngine::newObject()</code> 创建 JS 对象，再用 <code>setProperty</code> 设置属性；</li>
<li>QML 中可直接通过属性名访问（如 <code>error.message</code>、<code>response.token</code>），大小写敏感。</li>
</ul>
<h4 data-id="heading-11">4. 有效性检查</h4>
<ul>
<li>必须检查 <code>QJSEngine* engine = qjsEngine(this)</code> 是否为空（避免 QML 组件销毁后引擎失效）；</li>
<li>必须检查回调函数 <code>isCallable()</code>（避免传入非函数类型导致崩溃）。</li>
</ul>
<h3 data-id="heading-12">六、常见问题排查</h3>
<h4 data-id="heading-13">1. QML 无法导入 backend 模块？</h4>
<ul>
<li>检查 <code>qmlRegisterSingletonInstance</code> 的模块名、版本号与 QML import 一致；</li>
<li>确保 C++ 类继承 <code>QObject</code> 并添加 <code>Q_OBJECT</code> 宏；</li>
<li>构建时确保 MOC 文件正常生成（qmake 自动处理，CMake 需添加 <code>qt_add_qml_module</code>）。</li>
</ul>
<h4 data-id="heading-14">2. 回调函数不执行？</h4>
<ul>
<li>检查 <code>isCallable()</code> 是否返回 <code>true</code>（确认传入的是函数）；</li>
<li>检查是否在主线程调用 <code>call()</code>（后台线程调用会静默失败）；</li>
<li>检查异步逻辑是否正常执行（如模拟的 <code>QThread::sleep</code> 后是否触发回调）。</li>
</ul>
<h4 data-id="heading-15">3. 程序崩溃？</h4>
<ul>
<li>大概率是线程问题：后台线程直接操作 <code>QJSValue</code> 或 <code>QJSEngine</code>；</li>
<li>检查 <code>engine</code> 是否为空（如单例销毁后仍调用回调）。</li>
</ul>
<h3 data-id="heading-16">七、最佳实践</h3>
<h4 data-id="heading-17">1. 优先使用回调还是信号槽？</h4>
<ul>
<li><strong>回调</strong>：适合一次性操作（如登录、单次网络请求），代码直观，参数传递灵活；</li>
<li><strong>信号槽</strong>：适合多次通知（如实时数据更新），解耦性更强，支持多订阅者；</li>
<li>本文场景（登录）用回调更合适，简洁高效。</li>
</ul>
<h4 data-id="heading-18">2. 简化数据传递（可选）</h4>
<p>若数据简单，可直接用 <code>QVariantMap</code> 代替自定义类，无需写 <code>toQJSValue</code> 方法：</p>
<pre><code class="hljs language-cpp" lang="cpp">QVariantMap errorMap;
errorMap[<span class="hljs-string">"code"</span>] = <span class="hljs-number">401</span>;
errorMap[<span class="hljs-string">"message"</span>] = <span class="hljs-string">"登录失败"</span>;
onFailure.<span class="hljs-built_in">call</span>(QJSValueList{engine-&gt;<span class="hljs-built_in">toScriptValue</span>(errorMap)});
</code></pre>
<h4 data-id="heading-19">3. 避免回调地狱</h4>
<p>若存在多层回调（如登录后调用获取用户信息），可考虑用 Qt 6 的 <code>QPromise</code> + <code>co_await</code>（C++20+）或 QML 的 <code>async/await</code> 优化。</p>
<h3 data-id="heading-20">八、总结</h3>
<p>本文完整实现了 Qt 6 中 C++ 调用 QML 回调的流程，核心是：</p>
<ol>
<li>C++ 类继承 <code>QObject</code> 并暴露 <code>Q_INVOKABLE</code> 方法；</li>
<li>用 <code>QJSValue</code> 接收 QML 回调，用 <code>call()</code> 触发回调；</li>
<li>异步场景下必须切换到主线程执行回调，确保线程安全；</li>
<li>自定义数据通过 <code>QJSValue</code> 转换后传递，QML 可直接访问属性。</li>
</ol>
<p>这种方式适用于所有异步通信场景（登录、网络请求、文件读写等），是 C++ 与 QML 协作的核心技巧之一。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ES6+ 新特性解析：让 JavaScript 开发更优雅高效]]></title>    <link>https://juejin.cn/post/7576052677051416602</link>    <guid>https://juejin.cn/post/7576052677051416602</guid>    <pubDate>2025-11-24T10:21:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576052677051416602" data-draft-id="7576070987294031918" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" ES6+ 新特性解析：让 JavaScript 开发更优雅高效"/> <meta itemprop="keywords" content="ECMAScript 6,前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-24T10:21:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="San30"/> <meta itemprop="url" content="https://juejin.cn/user/1766294768060816"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             ES6+ 新特性解析：让 JavaScript 开发更优雅高效
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1766294768060816/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    San30
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T10:21:35.000Z" title="Mon Nov 24 2025 10:21:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github-gist">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#333}.hljs-comment,.hljs-meta{color:#969896}.hljs-emphasis,.hljs-quote,.hljs-strong,.hljs-template-variable,.hljs-variable{color:#df5000}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#d73a49}.hljs-attribute,.hljs-bullet,.hljs-literal,.hljs-symbol{color:#0086b3}.hljs-name,.hljs-section{color:#63a35c}.hljs-tag{color:#333}.hljs-attr,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-title{color:#6f42c1}.hljs-addition{color:#55a532;background-color:#eaffea}.hljs-deletion{color:#bd2c00;background-color:#ffecec}.hljs-link{text-decoration:underline}.hljs-number{color:#005cc5}.hljs-string{color:#032f62}</style><p>ES6（ECMAScript 2015）是 JavaScript 语言发展的里程碑，引入了大量让代码更简洁、更易维护的新特性。本文将深入解析这些特性，并通过实际代码示例展示它们的强大之处。</p>
<h2 data-id="heading-0">解构赋值：优雅的数据提取</h2>
<p>解构赋值让我们能够从数组或对象中快速提取值，赋给变量。</p>
<h3 data-id="heading-1">数组解构</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 基本数组解构</span>
<span class="hljs-keyword">const</span> [a, b, c] = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a, b, c); <span class="hljs-comment">// 1 2 3</span>

<span class="hljs-comment">// 嵌套数组解构</span>
<span class="hljs-keyword">const</span> [a, [b, c, [d], e]] = [<span class="hljs-number">1</span>, [<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, [<span class="hljs-number">4</span>], <span class="hljs-number">5</span>]];
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a, b, c, d, e); <span class="hljs-comment">// 1 2 3 4 5</span>

<span class="hljs-comment">// 剩余参数解构</span>
<span class="hljs-keyword">const</span> arr = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>];
<span class="hljs-keyword">const</span> [first, ...rest] = arr;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(first, rest); <span class="hljs-comment">// 1 [2, 3, 4, 5]</span>

<span class="hljs-comment">// 实际应用：提取教练和球员</span>
<span class="hljs-keyword">const</span> users = [<span class="hljs-string">'Darvin Ham'</span>, <span class="hljs-string">'James'</span>, <span class="hljs-string">'Luka'</span>, <span class="hljs-string">'Davis'</span>, <span class="hljs-string">'Ayton'</span>, <span class="hljs-string">'Kyle'</span>];
<span class="hljs-keyword">const</span> [captain, ...players] = users;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(captain, players); 
<span class="hljs-comment">// Darvin Ham ['James', 'Luka', 'Davis', 'Ayton', 'Kyle']</span>
</code></pre>
<h3 data-id="heading-2">对象解构</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> sex = <span class="hljs-string">'boy'</span>;
<span class="hljs-keyword">const</span> obj = {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'Darvin Ham'</span>,
    <span class="hljs-attr">age</span>: <span class="hljs-number">25</span>,
    sex, <span class="hljs-comment">// 对象属性简写</span>
    <span class="hljs-attr">like</span>: {
        <span class="hljs-attr">n</span>: <span class="hljs-string">'唱跳'</span>
    }
};

<span class="hljs-comment">// 对象解构</span>
<span class="hljs-keyword">let</span> { name, age, <span class="hljs-attr">like</span>: { n } } = obj;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(name, age, n); <span class="hljs-comment">// Darvin Ham 25 唱跳</span>

<span class="hljs-comment">// 字符串也可以解构</span>
<span class="hljs-keyword">const</span> [e, r, ...u] = <span class="hljs-string">'hello'</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(e, r, u); <span class="hljs-comment">// h e ['l', 'l', 'o']</span>

<span class="hljs-comment">// 获取字符串长度</span>
<span class="hljs-keyword">const</span> { length } = <span class="hljs-string">'hello'</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(length); <span class="hljs-comment">// 5</span>
</code></pre>
<h3 data-id="heading-3">解构的实用技巧</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 交换变量（无需临时变量）</span>
<span class="hljs-keyword">let</span> x = <span class="hljs-number">1</span>, y = <span class="hljs-number">2</span>;
[x, y] = [y, x];
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(x, y); <span class="hljs-comment">// 2 1</span>

<span class="hljs-comment">// 函数参数解构</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">greet</span>(<span class="hljs-params">{ name, greeting = <span class="hljs-string">'Hello'</span> }</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${greeting}</span>, <span class="hljs-subst">${name}</span>!`</span>);
}
<span class="hljs-title function_">greet</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'Bob'</span> }); <span class="hljs-comment">// Hello, Bob!</span>

<span class="hljs-comment">// 设置默认值</span>
<span class="hljs-keyword">const</span> { name, gender = <span class="hljs-string">'unknown'</span> } = { <span class="hljs-attr">name</span>: <span class="hljs-string">'Alice'</span> };
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(gender); <span class="hljs-comment">// unknown（因为 user 中没有 gender 属性）</span>
</code></pre>
<h2 data-id="heading-4">模板字符串：更优雅的字符串处理</h2>
<p>模板字符串使用反引号(``)定义，支持多行字符串和插值表达式。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> myName = <span class="hljs-string">'zhangsan'</span>;

<span class="hljs-comment">// 传统字符串拼接</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'hello, i am '</span> + myName);

<span class="hljs-comment">// 模板字符串</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`hello, i am <span class="hljs-subst">${myName}</span>`</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`hello, i am <span class="hljs-subst">${myName.toUpperCase()}</span>`</span>);

<span class="hljs-comment">// 多行字符串</span>
<span class="hljs-keyword">const</span> message = <span class="hljs-string">`
  亲爱的 <span class="hljs-subst">${myName}</span>:
  欢迎使用我们的服务！
  祝您使用愉快！
`</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(message);
</code></pre>
<h2 data-id="heading-5">更现代的循环：for...of</h2>
<p><code>for...of</code> 循环提供了更好的可读性和性能。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> myName = <span class="hljs-string">'zhangsan'</span>;

<span class="hljs-comment">// for...of 遍历字符串</span>
<span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> x <span class="hljs-keyword">of</span> myName) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(x); <span class="hljs-comment">// 依次输出: z h a n g s a n</span>
}

<span class="hljs-comment">// 与 for 循环对比</span>
<span class="hljs-keyword">const</span> arr = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>];

<span class="hljs-comment">// 传统的 for 循环</span>
<span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; arr.<span class="hljs-property">length</span>; i++) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr[i]);
}

<span class="hljs-comment">// 更简洁的 for...of</span>
<span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> item <span class="hljs-keyword">of</span> arr) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(item);
}
</code></pre>
<blockquote>
<p><strong>性能建议</strong>：<code>for...of</code> 语义更好，可读性更强，性能也不会比计数循环差太多。而 <code>for...in</code> 性能较差，应尽量避免使用。</p>
</blockquote>
<h2 data-id="heading-6">BigInt：处理大整数的新数据类型</h2>
<p>JavaScript 的数字类型有精度限制，最大安全整数是 2^53-1。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// JavaScript 的数字精度问题</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Number</span>.<span class="hljs-property">MAX_SAFE_INTEGER</span>); <span class="hljs-comment">// 9007199254740991</span>

<span class="hljs-keyword">let</span> num = <span class="hljs-number">1234567890987654321</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(num); <span class="hljs-comment">// 1234567890987654400（精度丢失！）</span>

<span class="hljs-comment">// 使用 BigInt</span>
<span class="hljs-keyword">let</span> num2 = <span class="hljs-number">1234567890987654321n</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(num2, <span class="hljs-keyword">typeof</span> num2); <span class="hljs-comment">// 1234567890987654321n 'bigint'</span>

<span class="hljs-comment">// BigInt 运算</span>
<span class="hljs-keyword">const</span> big1 = <span class="hljs-number">9007199254740991n</span>;
<span class="hljs-keyword">const</span> big2 = <span class="hljs-number">1n</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(big1 + big2); <span class="hljs-comment">// 9007199254740992n</span>

<span class="hljs-comment">// 注意事项</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">1n</span> + <span class="hljs-number">2</span>); <span class="hljs-comment">// ❌ TypeError: Cannot mix BigInt and other types</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(<span class="hljs-number">16n</span>)); <span class="hljs-comment">// ❌ TypeError</span>
<span class="hljs-keyword">const</span> x = <span class="hljs-number">3.</span><span class="hljs-number">14n</span>; <span class="hljs-comment">// ❌ SyntaxError: Invalid or unexpected token</span>
</code></pre>
<h3 data-id="heading-7">BigInt 使用要点：</h3>
<ul>
<li>使用 <code>n</code> 后缀表示 BigInt 字面量</li>
<li>不能与 Number 类型直接混合运算</li>
<li>不能使用 Math 对象的方法</li>
<li>只能表示整数，不支持小数</li>
</ul>
<h2 data-id="heading-8">函数参数的增强</h2>
<h3 data-id="heading-9">默认参数</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params">x = <span class="hljs-number">1</span>, y = <span class="hljs-number">1</span></span>) {
    <span class="hljs-keyword">return</span> x + y;
}
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">foo</span>(<span class="hljs-number">3</span>)); <span class="hljs-comment">// 4 (使用默认值 y=1)</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">foo</span>(<span class="hljs-number">3</span>, <span class="hljs-number">5</span>)); <span class="hljs-comment">// 8</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">foo</span>()); <span class="hljs-comment">// 2 (使用默认值 x=1, y=1)</span>
</code></pre>
<h3 data-id="heading-10">剩余参数 vs arguments</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params">...args</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'剩余参数:'</span>, args, <span class="hljs-keyword">typeof</span> args); 
    <span class="hljs-comment">// [1, 2, 3, 4] 'object'</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'是数组吗:'</span>, <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(args)); <span class="hljs-comment">// true</span>
    
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'arguments:'</span>, <span class="hljs-variable language_">arguments</span>, <span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">arguments</span>); 
    <span class="hljs-comment">// [Arguments] { '0': 1, '1': 2, '2': 3, '3': 4 } 'object'</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'arguments是数组吗:'</span>, <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(<span class="hljs-variable language_">arguments</span>)); <span class="hljs-comment">// false</span>
    
    <span class="hljs-comment">// 剩余参数支持数组方法</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'参数个数:'</span>, args.<span class="hljs-property">length</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'参数总和:'</span>, args.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a + b, <span class="hljs-number">0</span>));
}

<span class="hljs-title function_">foo</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>);
</code></pre>
<h3 data-id="heading-11">剩余参数的优势：</h3>
<ul>
<li>是真正的数组，可以使用所有数组方法</li>
<li>更清晰的语法</li>
<li>更好的类型推断（TypeScript）</li>
</ul>
<h2 data-id="heading-12">其他实用特性</h2>
<h3 data-id="heading-13">指数运算符</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ES7 (2016) 引入的指数运算符</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">2</span> ** <span class="hljs-number">10</span>); <span class="hljs-comment">// 1024</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">3</span> ** <span class="hljs-number">3</span>); <span class="hljs-comment">// 27</span>

<span class="hljs-comment">// 替代 Math.pow()</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(<span class="hljs-number">2</span>, <span class="hljs-number">10</span>)); <span class="hljs-comment">// 1024 (传统方式)</span>
</code></pre>
<h3 data-id="heading-14">对象属性简写</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> name = <span class="hljs-string">'Alice'</span>;
<span class="hljs-keyword">const</span> age = <span class="hljs-number">25</span>;

<span class="hljs-comment">// 传统写法</span>
<span class="hljs-keyword">const</span> obj1 = {
    <span class="hljs-attr">name</span>: name,
    <span class="hljs-attr">age</span>: age
};

<span class="hljs-comment">// ES6 简写写法</span>
<span class="hljs-keyword">const</span> obj2 = {
    name,
    age
};

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj2); <span class="hljs-comment">// { name: 'Alice', age: 25 }</span>
</code></pre>
<h2 data-id="heading-15">总结</h2>
<p>ES6+ 的新特性让 JavaScript 开发变得更加优雅和高效：</p>
<ul>
<li><strong>解构赋值</strong> 让数据提取更直观</li>
<li><strong>模板字符串</strong> 让字符串处理更简洁</li>
<li><strong>for...of</strong> 提供更好的循环体验</li>
<li><strong>BigInt</strong> 解决大整数计算问题</li>
<li><strong>函数参数增强</strong> 提供更灵活的函数设计</li>
</ul>
<p>这些特性不仅提高了开发效率，也让代码更易读、易维护。建议在实际项目中积极采用这些现代 JavaScript 特性，提升代码质量。</p>
<blockquote>
<p><strong>学习建议</strong>：从解构赋值和模板字符串开始，逐步掌握其他特性，让 ES6+ 成为你的开发利器！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端性能优化之CSS篇]]></title>    <link>https://juejin.cn/post/7575655132755591187</link>    <guid>https://juejin.cn/post/7575655132755591187</guid>    <pubDate>2025-11-23T13:03:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575655132755591187" data-draft-id="7575442779039350826" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端性能优化之CSS篇"/> <meta itemprop="keywords" content="前端,JavaScript,性能优化"/> <meta itemprop="datePublished" content="2025-11-23T13:03:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员小寒"/> <meta itemprop="url" content="https://juejin.cn/user/694547078987287"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端性能优化之CSS篇
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547078987287/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员小寒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T13:03:58.000Z" title="Sun Nov 23 2025 13:03:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1、前言</h2>
<p>当涉及到网站的性能优化时，CSS 的优化是一个非常重要的方面。如果你的 CSS 太复杂，那么你的网站可能会像一个<strong>慢吞吞的乌龟</strong>一样缓慢地加载和渲染，影响<strong>用户的留存</strong>、<strong>网站的转化率</strong>以及<strong>网站的体验和传播</strong>等，所以对于 CSS 优化还是非常需要的，本文将介绍一些 CSS 性能优化的技巧，帮助你在编写 CSS 代码时提高性能。</p>
<h2 data-id="heading-1">2、前置知识</h2>
<h3 data-id="heading-2">2.1 CSS 解析规则</h3>
<p>我们一般书写 CSS 选择器都是从左往右书写的，所以自然就会以为 CSS 选择器是从左往右去匹配渲染的，但其实不是这样的，<strong>CSS 选择器是从右往左去匹配的</strong>。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.header</span> <span class="hljs-selector-tag">div</span> <span class="hljs-selector-tag">span</span> { 
  <span class="hljs-attribute">color</span>: red;
}
</code></pre>
<p>比如上面的 CSS 样式匹配查找过程是这样的：</p>
<ol>
<li>先找到所有的 <code>span</code> 元素。</li>
<li>从第一个 <code>span</code> 元素开始，沿着 <code>span</code> 元素的父级元素查到 <code>div</code>，最后沿着 <code>div</code> 的父级元素找到所有的 <code>.header</code>，找到满足条件的节点就加入到结果集中。</li>
</ol>
<h3 data-id="heading-3">2.2 CSS 的加载过程</h3>
<p><strong>简述浏览器的渲染过程</strong>：在拿到 html 文件后，浏览器会调用 html 解析器解析 html 文件，构建 DOM 树和 CSSOM 树，然后 DOM 树和 CSSOM 树合并成渲染树，最后浏览器会根据渲染树进行布局和绘制，最终将页面呈现给用户。</p>
<p><strong>CSSOM 的构建</strong>：当浏览器解析 html 文档时，如果遇到 <code>&lt;link&gt;</code> 或 <code>&lt;style&gt;</code> 标签，会开始下载和解析 CSS 文件，构建 CSSOM。在 CSSOM 构建完成之前，浏览器不会渲染任何已处理的内容，即使DOM已经解析完毕。</p>
<ul>
<li>CSS 不会阻塞 <code>DOM</code> 的解析，但会阻塞 <code>DOM</code> 的渲染。</li>
<li>CSS 不会阻塞 <code>Javascript</code> 的下载，但会阻塞 <code>JavaScript</code> 的执行，因为 <code>JavaScript</code> 可以操作样式，所以需要等 <code>CSSOM</code> 构建完成之后，才能执行 <code>JavaScript</code>。</li>
</ul>
<p>所以从这里就可以得到以下优化思路：。</p>
<ul>
<li>将一些<strong>体积小的首屏关键 CSS</strong> 内联到 <code>html</code> 文件中，加快首屏渲染速度。</li>
<li>将 CSS 放在 <code>&lt;head&gt;</code> 中，确保尽早加载。</li>
<li>使用媒体查询（如 <code>media="print"</code>）使 CSS 非阻塞渲染。</li>
<li>在生产环境中，考虑使用 preload（如 <code>&lt;link rel="preload" as="style"&gt;</code>）在不阻塞渲染的情况下加载非首屏的 CSS 资源。</li>
</ul>
<h3 data-id="heading-4">2.3 CSS 权重优先级</h3>
<p>CSS 选择器类型的优先级从低往高依次是：</p>
<ol>
<li><strong>类型选择器</strong>（比如 <code>h1</code>）和<strong>伪元素选择器</strong>（比如 <code>::before</code>）。</li>
<li><strong>类选择器</strong>（比如 <code>.header</code>）、<strong>属性选择器</strong>（比如 <code>[type="checkbox"]</code>）和<strong>伪类选择器</strong>（比如 <code>:hover</code>）。</li>
<li><strong>ID 选择器</strong>（比如 <code>#box</code>）。</li>
<li><strong>!important</strong>：优先级最高。</li>
</ol>
<h2 data-id="heading-5">2、CSS 加载性能优化</h2>
<h3 data-id="heading-6">2.1. 提取公共的 CSS 文件</h3>
<p>如果使用<code>webpack</code>进行项目打包，在打包阶段可以使用<code>mini-css-extract-plugin</code>提取公共 CSS 文件，便于缓存以及减少 CSS 请求次数。</p>
<h3 data-id="heading-7">2.2 避免使用 @import</h3>
<ul>
<li>使用 <code>@import</code> 会阻塞浏览器的并行下载，导致加载速度变慢。</li>
<li>多个 <code>@import</code> 会导致下载顺序紊乱。</li>
</ul>
<h3 data-id="heading-8">2.3 压缩 CSS 文件</h3>
<p>压缩 CSS 文件可以减小文件大小，从而加快加载速度。比如可以用<code>optimize-css-assets-webpack-plugin</code>配合<code>mini-css-extract-plugin</code>使用来优化和压缩 CSS 文件。</p>
<h3 data-id="heading-9">2.4 使用浏览器缓存</h3>
<p>可以使用浏览器缓存来缓存 CSS 文件，从而在页面加载时加快速度。可以设置适当的缓存时间来确保文件在必要时能够更新。</p>
<h3 data-id="heading-10">2.5 使用 CDN 加速</h3>
<ul>
<li>使用 <strong>CDN（内容分发网络）</strong> 可以将 CSS 文件分发到全国各个 <code>CDN</code> 节点的服务器上，用户可以就近下载，从而加快加载速度，也可以减少自己服务器的负载。</li>
<li>如果静态资源很多，可以准备多个静态服务器域名，比如域名是 <code>static.xx.com</code>，做成支持 <code>static0-5</code> 的 6 个域名, 也就是 <code>static0.xx.com、static1.xx.com、static2.xx.com...</code>，每次请求时随机选一个域名地址进行请求，这样可以绕过浏览器同域名的连接数限制（一般是限制 6 个），6 个域名就可以同时发送 36 个连接请求。当然，这个域名个数不是越多越好，太分散的话又会涉及到多域名无法缓存静态资源的问题。</li>
</ul>
<h3 data-id="heading-11">2.6 使用 CSS Sprite</h3>
<p><strong>CSS Sprite</strong> 技术就是我们常说的<strong>雪碧图</strong>，通过将多张小图标拼接成一张大图，能有效的<strong>减少HTTP请求数量</strong>以达到加速显示内容的技术。</p>
<h3 data-id="heading-12">2.7 CSS 样式抽离和去除无用 CSS</h3>
<ul>
<li>平时开发过程中可以将一些<strong>可复用</strong>的 CSS 抽离到一个单独文件中，减少 CSS 代码冗余。</li>
<li>在打包构建时可以利用一些插件去除没有用到的 CSS，相当于对 CSS 进行 <code>Tree shaking</code>，减少打包后体积。</li>
</ul>
<h3 data-id="heading-13">2.8 合理使用内嵌 CSS</h3>
<p><code>内嵌CSS</code> 也就是通过元素的 <code>style</code> 来书写行内样式，比如 <code>&lt;div style="color: red"&gt;&lt;/div&gt;</code>，它的优缺点如下：</p>
<p><strong>优点</strong>：</p>
<ul>
<li>与使用 <code>link</code> 标签相比，可以减少 CSS 的 <code>http</code> 请求量。</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>增加 <code>html</code> 文件的体积。</li>
<li>使用 <code>link</code> 标签能很好的利用浏览器的缓存，而内联样式放在 <code>html</code> 里面，能否使用缓存需要看 <code>html</code> 文件的缓存策略。</li>
</ul>
<p>综合它的优缺点，我们可以选择将一些<strong>体积小的首屏关键 CSS</strong> 内联到 <code>html</code> 文件中，加快首屏渲染速度。</p>
<h2 data-id="heading-14">3、CSS 选择器性能优化</h2>
<h3 data-id="heading-15">3.1 避免使用通配符选择器</h3>
<p>通配符选择器<code>*</code>符号可以匹配任何元素，但是这会导致浏览器需要遍历整个文档树来查找匹配的元素，从而降低性能。</p>
<h3 data-id="heading-16">3.2 使用子选择器代替后代选择器</h3>
<p>后代选择器（如 <code>.parent .child</code>）会检查所有后代元素，而子选择器（如 <code>.parent &gt; .child</code>）只检查直接子元素，匹配范围更小，性能更好。</p>
<h3 data-id="heading-17">3.3 优先使用类（Class）和 ID 选择器</h3>
<p>类选择器（如 <code>.box</code>）和 ID 选择器（如 <code>#box</code>）匹配速度更快，因为它们直接指向特定元素。避免标签选择器（如 <code>div</code>）或属性选择器（如 [type="text"]），后者匹配更加宽泛，效率较低，尤其在大型 DOM 中。</p>
<h3 data-id="heading-18">3.4 避免深层嵌套的选择器</h3>
<p>前面也说过，CSS 选择器需要从右往左去匹配的，嵌套的选择器如 <code>.header div ul li a</code>，因为浏览器需要遍历更多 DOM 节点。建议限制选择器深度在 3 层以内，使用更直接的类或 ID 选择器，如 <code>.box</code>。这能减少匹配时间。或者使用 <code>BEM</code> 命名规范，比如 <code>.block__element--modifier</code>，提高匹配效率。</p>
<p>另外在使用 ID 选择器的时候，前面就需要加上父级的选择器，比如不推荐用 <code>.box #content</code>，推荐用 <code>#content</code>。</p>
<h2 data-id="heading-19">4、CSS 属性性能优化</h2>
<h3 data-id="heading-20">4.1 避免使用过于复杂的属性</h3>
<p>过于复杂的属性会增加浏览器的渲染负担，从而降低性能。应该尽量使用简单的属性来实现需要的样式效果，比如下面这些属性：</p>
<ul>
<li><strong>box-shadow</strong>：box-shadow 属性可以实现盒子的阴影效果，但是它会增加浏览器的计算和渲染成本。如果要实现一个简单的边框效果，可以使用 <code>border</code> 属性来替代。</li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 不推荐使用 */</span>
<span class="hljs-selector-class">.box</span> {
  <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">2px</span> <span class="hljs-number">2px</span> <span class="hljs-number">2px</span> <span class="hljs-number">#888</span>;
}

<span class="hljs-comment">/* 推荐使用 */</span>
<span class="hljs-selector-class">.box</span> {
  <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#888</span>;
}
</code></pre>
<ul>
<li><strong>filter</strong>：filter 属性可以实现图像的滤镜效果，但是它会增加浏览器的计算和渲染成本。如果要实现一个简单的颜色变换效果，可以使用 <code>background-color</code> 属性来替代。</li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 不推荐使用 */</span>
<span class="hljs-selector-class">.box</span> {
  <span class="hljs-attribute">filter</span>: <span class="hljs-built_in">grayscale</span>(<span class="hljs-number">50%</span>);
}

<span class="hljs-comment">/* 推荐使用 */</span>
<span class="hljs-selector-class">.box</span> {
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#ccc</span>;
}
</code></pre>
<p>不过需要注意的是，这些替代方案可能会有一些<strong>局限性</strong>，无法完全取代原来的属性。因此，在使用这些替代方案时，需要根据具体的需求和情况进行选择。</p>
<h3 data-id="heading-21">4.2 避免使用不必要的属性</h3>
<p>不必要的属性会增加 <code>CSS</code> 文件的大小，从而降低加载速度。应该尽量避免使用不必要的属性。</p>
<h3 data-id="heading-22">4.3 避免使用 !important</h3>
<p><code>!important</code> 会覆盖其他样式，从而增加渲染时间。而且它不容易被替换或覆盖，后期可维护性也比较差，更好的方式使用更具体、更准确的选择器来定义样式。</p>
<h2 data-id="heading-23">5、CSS 动画性能优化</h2>
<h3 data-id="heading-24">5.1 使用 transform 和 opacity 属性来进行动画</h3>
<p>使用 <code>transform</code> 和 <code>opacity</code> 属性可以减少浏览器的渲染负担，从而提高性能。</p>
<h3 data-id="heading-25">5.2 避免使用过于复杂的动画效果</h3>
<p>过于复杂的动画效果会增加浏览器的渲染负担，从而降低性能。应该尽量使用简单的动画效果。</p>
<h3 data-id="heading-26">5.3 在动画中使用 will-change 属性</h3>
<p><code>will-change</code> 属性可以告诉浏览器哪些属性将要被改变，从而提前进行优化，减少渲染负担。</p>
<h3 data-id="heading-27">5.4 使用 requestAnimationFrame() 函数来优化动画</h3>
<p><code>requestAnimationFrame()</code> 函数可以在浏览器下一次渲染之前执行代码，从而减少渲染负担，提高性能。</p>
<h2 data-id="heading-28">6、CSS 渲染性能优化</h2>
<h3 data-id="heading-29">6.1 使用 class 合并 DOM 的修改</h3>
<p>比如我们需要根据不同情况给一个元素添加不同的样式，可能会写出如下的代码：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> el = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.box'</span>);
<span class="hljs-keyword">if</span> (isHover) {
  el.<span class="hljs-property">style</span>.<span class="hljs-property">color</span> = <span class="hljs-string">'red'</span>;
  el.<span class="hljs-property">style</span>.<span class="hljs-property">background</span> = <span class="hljs-string">'blue'</span>;
} <span class="hljs-keyword">else</span> {
  el.<span class="hljs-property">style</span>.<span class="hljs-property">color</span> = <span class="hljs-string">'blue'</span>;
  el.<span class="hljs-property">style</span>.<span class="hljs-property">background</span> = <span class="hljs-string">'red'</span>;
}
</code></pre>
<p>这时候我们可以定义两个 <code>class</code> 类，然后直接切换类名即可。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> el = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.box'</span>);
<span class="hljs-keyword">if</span> (isHover) {
  el.<span class="hljs-property">classList</span>.<span class="hljs-title function_">remove</span>(<span class="hljs-string">'normal'</span>);
  el.<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'hover'</span>);
} <span class="hljs-keyword">else</span> {
  el.<span class="hljs-property">classList</span>.<span class="hljs-title function_">remove</span>(<span class="hljs-string">'hover'</span>);
  el.<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'normal'</span>);
}
</code></pre>
<h3 data-id="heading-30">6.2 让 DOM 元素脱离文档流</h3>
<p>使用 <code>absoulte</code> 或者 <code>fixed</code> 定位让 DOM 元素脱离文档流，这样在修改 DOM 元素的时候不会影响到其他 DOM 元素的布局，从而提高渲染性能。</p>
<h2 data-id="heading-31">7、总结</h2>
<p>本文主要通过<strong>CSS 加载性能优化</strong>、<strong>CSS 选择器性能优化</strong>、<strong>CSS 属性性能优化</strong>、<strong>CSS 动画性能优化</strong>和<strong>CSS 渲染性能优化</strong>这些方向介绍了 CSS 的性能优化技巧。通过优化 CSS 性能，可以提高网站的性能和用户体验。</p>
<p>在实际开发中，可根据实际业务场景和需要去进行优化。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从 JDK1.2 到 JDK21：ThreadLocal的进化解决了什么问题]]></title>    <link>https://juejin.cn/post/7575367791272804390</link>    <guid>https://juejin.cn/post/7575367791272804390</guid>    <pubDate>2025-11-23T09:55:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575367791272804390" data-draft-id="7575182522411335718" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从 JDK1.2 到 JDK21：ThreadLocal的进化解决了什么问题"/> <meta itemprop="keywords" content="后端,Java,面试"/> <meta itemprop="datePublished" content="2025-11-23T09:55:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一只叫煤球的猫"/> <meta itemprop="url" content="https://juejin.cn/user/1732486058745054"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从 JDK1.2 到 JDK21：ThreadLocal的进化解决了什么问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1732486058745054/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一只叫煤球的猫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T09:55:30.000Z" title="Sun Nov 23 2025 09:55:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. JDK 1.2：ThreadLocal 初版（最小可用）</h2>
<p><strong>核心特点：</strong></p>
<ul>
<li><code>ThreadLocal</code> 首次出现。</li>
<li>每个线程维护自己的 <code>ThreadLocalMap</code>。</li>
<li><code>ThreadLocalMap</code> 的 key 就是 <code>ThreadLocal</code> 本身。</li>
<li>底层使用开放地址法的哈希表（<code>Entry[] table</code>）。</li>
<li><strong>key 不是弱引用</strong>，导致 ThreadLocal 对象不释放时可能造成内存泄漏。</li>
</ul>
<p><strong>主要问题：</strong></p>
<ul>
<li>ThreadLocal 实例如果被 GC 回收前未手动 <code>remove()</code>，线程（尤其是线程池）不会结束，Entry 永远存在，导致 value 泄漏。</li>
</ul>
<p>这也是行业里常说的 ThreadLocal 泄漏最初来源。</p>
<hr/>
<h2 data-id="heading-1">2. JDK 1.3 ~ 1.4：Bug 修复 + 行为稳定</h2>
<p><strong>关键改动：</strong></p>
<ul>
<li>增强清理机制，但依然是 key 强引用。</li>
<li>修复部分扩容和冲突处理问题。</li>
</ul>
<p>但根本性的泄漏问题仍然存在。</p>
<hr/>
<h2 data-id="heading-2">3. JDK 5：引入弱引用（关键里程碑）</h2>
<p>这是 ThreadLocal 设计史上最重要的变更。</p>
<p><strong>重大更新：</strong></p>
<ul>
<li>
<p><code>ThreadLocalMap.Entry</code> 改为 <strong>弱引用</strong>：</p>
<pre><code class="hljs language-scala" lang="scala">static <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Entry</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">WeakReference&lt;ThreadLocal&lt;?&gt;&gt;</span> </span>{
    <span class="hljs-type">Object</span> value;
}
</code></pre>
</li>
<li>
<p>一旦 ThreadLocal 对象不再被外部引用，可以被 GC 回收，Entry 的 key 会变成 <code>null</code>。</p>
</li>
</ul>
<p><strong>为什么改成弱引用？</strong></p>
<ul>
<li>防止 ThreadLocal 对象不释放导致整组 Entry 无法被清理。</li>
</ul>
<p><strong>带来的副作用：</strong></p>
<ul>
<li>value 仍然是强引用，只要线程活着，value 永远不会被回收。</li>
<li>如果你不手动 <code>remove()</code>，依旧可能内存泄漏（尤其线程池）。</li>
</ul>
<p>至此，ThreadLocal 的内存泄漏问题变成了：</p>
<ul>
<li><strong>不是 key 泄漏，而是 value 泄漏。</strong></li>
</ul>
<hr/>
<h2 data-id="heading-3">4. JDK 6：清理机制增强 + TAB 数组 rehash 改善</h2>
<p><strong>JDK6 的重要演进：</strong></p>
<ul>
<li>加强对 key 为 <code>null</code> 的 Entry 的清理逻辑（例如访问冲突位点时主动清理）。</li>
<li>优化 rehash 和探测机制。</li>
</ul>
<p>整体结构仍为开放地址法，不改变本质机制。</p>
<hr/>
<h2 data-id="heading-4">5. JDK 7：性能优化 + 部分线程局部缓存行为改进</h2>
<p>JDK7 的变化偏向实现层。</p>
<p><strong>增强点：</strong></p>
<ul>
<li>完善冲突探测，降低哈希冲突导致的退化。</li>
<li>改善 nextIndex/prevIndex 的性能。</li>
<li>修复扩容后 rehash 的一些 bug。</li>
</ul>
<p>ThreadLocalMap 变得更健壮，但不改变语义。</p>
<hr/>
<h2 data-id="heading-5">6. JDK 8：清理策略进一步加强，核心逻辑成熟稳定</h2>
<p><strong>关键变化：</strong></p>
<ul>
<li>
<p>ThreadLocalMap 清理 <code>stale entry</code>（key = null）的策略更加激进：</p>
<ul>
<li>get/set/remove 时都会尝试清理死 key。</li>
</ul>
</li>
<li>
<p>内部 rehash 策略更高效。</p>
</li>
<li>
<p>线程池场景下的内存泄漏仍然需要手动处理 (<code>remove()</code>)，但 default 逻辑更健壮。</p>
</li>
</ul>
<p><strong>JDK8 的 ThreadLocal 基本成为行业主流参考实现。</strong></p>
<hr/>
<h2 data-id="heading-6">7. JDK 9：新增 <code>ThreadLocal.withInitial()</code>（语法糖）</h2>
<p>此版本以后属于稳定期，新增功能而非机制变化。</p>
<p><strong>新增：</strong></p>
<pre><code class="hljs language-scss" lang="scss">ThreadLocal<span class="hljs-selector-class">.withInitial</span>(() -&gt; new <span class="hljs-built_in">SimpleDateFormat</span>("yyyy-MM-dd"))
</code></pre>
<p>机制不变，易用性提升。</p>
<hr/>
<h2 data-id="heading-7">8. JDK 11 / JDK 17：几乎无变化，属于稳定维护期</h2>
<ul>
<li>持续做小修复，增强可读性与边界处理。</li>
<li>内存清理策略与 JDK8 几乎无差别。</li>
<li>语义和行为已经非常稳定。</li>
</ul>
<hr/>
<h2 data-id="heading-8">9. JDK 21：虚拟线程（Loom）下的 ThreadLocal 语义扩展（重要）</h2>
<p>在 Loom（虚拟线程）中：</p>
<p><strong>ThreadLocal 默认机制仍然可用，但成本更低：</strong></p>
<ul>
<li>虚拟线程是轻量结构，保留自己的 ThreadLocalMap。</li>
<li>虚拟线程不复用，生命周期短，因此不容易产生 ThreadLocal value 泄漏。</li>
</ul>
<p><strong>关键点：</strong></p>
<ul>
<li>虚拟线程不是池化线程，不会出现线程池泄漏问题。</li>
<li>某些场景 ThreadLocal 成本反而比传统线程更轻。</li>
</ul>
<hr/>
<h2 data-id="heading-9">10. 前后机制的核心变化总结</h2>


















































<table><thead><tr><th>JDK 版本</th><th>变化点</th><th>影响</th></tr></thead><tbody><tr><td>1.2</td><td>基本实现</td><td>存在严重泄漏风险</td></tr><tr><td>1.3-1.4</td><td>Bug 修复</td><td>稳定性增强</td></tr><tr><td>5</td><td><strong>key 改为弱引用</strong></td><td>避免 key 泄漏，但 value 泄漏依旧</td></tr><tr><td>6</td><td>加强化清理逻辑</td><td>降低内存泄漏风险</td></tr><tr><td>7</td><td>进一步优化冲突处理</td><td>性能提升</td></tr><tr><td>8</td><td><strong>成熟实现，清理更激进</strong></td><td>标准实现，被行业普遍使用</td></tr><tr><td>9+</td><td>易用性提升（withInitial）</td><td>开发体验增强</td></tr><tr><td>21</td><td>虚拟线程支持稳定</td><td>泄漏风险显著降低</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-10">11. 哪些问题贯穿所有版本？</h2>
<p>无论哪个版本，ThreadLocal 永远有两个核心风险：</p>
<ol>
<li><strong>value 会泄漏，只要线程还活着</strong></li>
<li><strong>线程池复用导致 value 长期驻留</strong></li>
</ol>
<p>这两个问题在 JDK21 的虚拟线程中弱化但未彻底消失。</p>
<hr/>
<h2 data-id="heading-11">12. 业内最佳实践</h2>
<ol>
<li>创建后必须手动 <code>remove()</code></li>
<li>避免在容器/框架级别缓存业务值</li>
<li>避免使用无界线程池结合 ThreadLocal</li>
<li>不要把 ThreadLocal 当成上下文传递机制（应使用 ThreadLocal 设计的框架）</li>
<li>推荐使用 <code>withInitial()</code> 避免 null 值</li>
</ol>
<hr/>
<h2 data-id="heading-12">13. 讲清楚本质</h2>
<p><strong>ThreadLocal 在整个 JDK 生命周期中的核心变化只有一次：JDK5 引入弱引用。</strong></p>
<p>其余版本改动都是：</p>
<ul>
<li>更激进的清理策略</li>
<li>更健壮的哈希探测与 rehash</li>
<li>更易用的 API</li>
<li>虚拟线程场景下的运行时表现改善</li>
</ul>
<p>但行为本质没有改变：</p>
<ul>
<li>每个线程维护一个 Map</li>
<li>key 弱引用</li>
<li>value 强引用</li>
<li>需要手动 remove，线程池中更应当如此</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[再来聊聊，Vue3 项目中 Pinia 的替代方案]]></title>    <link>https://juejin.cn/post/7575458028254674987</link>    <guid>https://juejin.cn/post/7575458028254674987</guid>    <pubDate>2025-11-23T11:23:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575458028254674987" data-draft-id="7575655132755394579" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="再来聊聊，Vue3 项目中 Pinia 的替代方案"/> <meta itemprop="keywords" content="前端,面试"/> <meta itemprop="datePublished" content="2025-11-23T11:23:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端布鲁伊"/> <meta itemprop="url" content="https://juejin.cn/user/4431511346492554"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            再来聊聊，Vue3 项目中 Pinia 的替代方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4431511346492554/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端布鲁伊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T11:23:24.000Z" title="Sun Nov 23 2025 11:23:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    12
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><p><strong>想获取更多2025年最新前端场景题可以看这里</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Ffe.ecool.fun%2Ftopic-list%3Fic%3DKIQC2F%26from%3Djuejin_article" target="_blank" title="https://fe.ecool.fun/topic-list?ic=KIQC2F&amp;from=juejin_article" ref="nofollow noopener noreferrer">fe.ecool.fun</a></p>
<p>大家好，我是刘布斯。</p>
<p>之前转载了一篇文章<strong>Vue 项目不要再用 Pinia 了</strong>，先不可否认，这文章有点标题党的意思。但这篇文章的主要观点是说，在中小项目里，用 Vue 3 自带的组合式 API（<code>reactive</code> / <code>ref</code>）来管状态，很多时候比硬上 Pinia 要香。</p>
<p>好家伙，评论区一下就热闹了，总结起来是：“Pinia 多好用，你肯定是没用明白 Pinia”</p>
<p>说实话，我确实有点意外。</p>
<p><strong>我先摆明态度：Pinia 是个非常优秀的状态管理库。</strong> 尤雨溪团队亲自操刀，API 设计简洁，TS 支持完美，插件系统灵活，Devtools 体验丝滑。这一点，没人能否认。</p>
<p>但我的核心观点是：<strong>优秀，不代表“所有场景都必须上”。</strong></p>
<p>我发现现在很多团队，尤其是从 Vue 2 刚迁到 Vue 3 不久的，存在一种很强的 <strong>“状态管理惯性”</strong> 。</p>
<p>什么意思？</p>
<p>在 Vue 2 + Options API 的时代，组件（Component）和状态（State）是“隔离”的。<code>data</code> 里的状态天生就是“内向”的，组件一销毁，状态就没了。跨组件通信、全局状态共享，你怎么办？你没得选，你必须上 Vuex。Vuex 就像一个“中央空调”，你不用它，别的房间（组件）就享受不到冷气（状态）。</p>
<p>所以，Vue 2 时代养成了我们的思维定式：<strong>做项目 = Vue 全家桶 = Vue + Vue Router + Vuex。</strong></p>
<p>到了 Vue 3，Vuex 退位，Pinia 继任。于是大家理所当然地把公式换成了：<strong>做项目 = Vue 3 + Vue Router + Pinia。</strong></p>
<p>启动一个新项目，<code>npm create vue@latest</code>，一路 <code>yes</code> 下来，Pinia 就装好了。然后就开始 <code>defineStore</code>。</p>
<p>但大家好像都忽略了 Vue 3 最大的革命性变化——<strong>组合式 API (Composition API)</strong> 本身，就已经是一种强大的状态管理模式了。</p>
<h4 data-id="heading-0"><code>defineStore</code> 帮我们做了什么？</h4>
<p>还是用那篇文章中的例子，做一个最简单的“用户状态管理”，两种方式有什么区别。</p>
<p><strong>1. Pinia 的方式：</strong> 你得先在 <code>stores/user.ts</code> 里：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { defineStore } <span class="hljs-keyword">from</span><span class="hljs-string">'pinia'</span>
<span class="hljs-keyword">import</span> { ref, computed } <span class="hljs-keyword">from</span><span class="hljs-string">'vue'</span>

exportconst useUserStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'user'</span>, <span class="hljs-function">() =&gt;</span> {
<span class="hljs-comment">// State</span>
<span class="hljs-keyword">const</span> token = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>)
<span class="hljs-keyword">const</span> userProfile = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>)

<span class="hljs-comment">// Getters</span>
<span class="hljs-keyword">const</span> isLoggedIn = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> !!token.<span class="hljs-property">value</span>)

<span class="hljs-comment">// Actions</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">login</span>(<span class="hljs-params">data</span>) {
    token.<span class="hljs-property">value</span> = data.<span class="hljs-property">token</span>
    userProfile.<span class="hljs-property">value</span> = data.<span class="hljs-property">profile</span>
    <span class="hljs-comment">// ... 存 localstorage</span>
  }

<span class="hljs-keyword">function</span> <span class="hljs-title function_">logout</span>(<span class="hljs-params"/>) {
    token.<span class="hljs-property">value</span> = <span class="hljs-literal">null</span>
    userProfile.<span class="hljs-property">value</span> = <span class="hljs-literal">null</span>
    <span class="hljs-comment">// ... 清 localstorage</span>
  }

<span class="hljs-keyword">return</span> { token, userProfile, isLoggedIn, login, logout }
})
</code></pre>
<p>然后在组件里 <code>useUserStore()</code>。</p>
<p><strong>2. 组合式 API 的方式：</strong> 你在 <code>stores/user.ts</code> (对，你也可以叫 <code>stores</code> 目录，这只是个文件夹)：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { ref, computed, reactive } <span class="hljs-keyword">from</span><span class="hljs-string">'vue'</span>

<span class="hljs-comment">// 以前我们用 reactive，这里用 ref/computed 模拟 Pinia 的结构</span>
<span class="hljs-keyword">const</span> token = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>)
<span class="hljs-keyword">const</span> userProfile = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>)

<span class="hljs-keyword">const</span> isLoggedIn = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> !!token.<span class="hljs-property">value</span>)

<span class="hljs-keyword">function</span> <span class="hljs-title function_">login</span>(<span class="hljs-params">data</span>) {
  token.<span class="hljs-property">value</span> = data.<span class="hljs-property">token</span>
  userProfile.<span class="hljs-property">value</span> = data.<span class="hljs-property">profile</span>
<span class="hljs-comment">// ... 存 localstorage</span>
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">logout</span>(<span class="hljs-params"/>) {
  token.<span class="hljs-property">value</span> = <span class="hljs-literal">null</span>
  userProfile.<span class="hljs-property">value</span> = <span class="hljs-literal">null</span>
<span class="hljs-comment">// ... 清 localstorage</span>
}

<span class="hljs-comment">// 导出一个 hook</span>
<span class="hljs-keyword">export</span><span class="hljs-keyword">function</span> <span class="hljs-title function_">useUser</span>(<span class="hljs-params"/>) {
<span class="hljs-keyword">return</span> { token, userProfile, isLoggedIn, login, logout }
}
</code></pre>
<p>然后在组件里 <code>useUser()</code>。</p>
<hr/>
<p>好了，你对比下这两段代码。</p>
<p><strong>你发现了什么？</strong></p>
<p>在第二种方式里，我只是删掉了 <code>defineStore('user', ...)</code> 那层“壳”，然后把导出的 <code>useUserStore</code> 改成了 <code>useUser</code> (叫什么都行)。</p>
<p><strong>其他的逻辑，一模一样！</strong> 都是在用 <code>ref</code> 和 <code>computed</code>。</p>
<p>Pinia 的 <code>defineStore</code> 在这个场景里，本质上就是帮你做了一件事：<strong>创建了一个跨组件共享的、响应式的单例。</strong></p>
<p>但在 Vue 3 里，<code>import</code> 一个在模块顶层（module scope）定义的 <code>ref</code> 或 <code>reactive</code> 对象，它<strong>天生就是单例</strong>！它天生就是跨组件共享的！</p>
<p>那你可能会反问了：“那 Pinia 岂不是多此一举？”</p>
<p>不，它当然不是多此一举。它提供了 <code>defineStore</code> 这个“壳”，是为了给你带来额外的好处，最核心的就是：</p>
<ol>
<li><strong>Devtools 集成</strong>：这是 Pinia 最大的杀手锏。你可以在时间轴上看到 <code>action</code> 的调用、<code>state</code> 的变更。</li>
<li><strong>插件系统</strong>：比如实现数据持久化，Pinia 有现成的插件，<code>defineStore</code> 的时候配置一下就行。</li>
<li><strong>SSR 支持</strong>：在服务端渲染时，Pinia 能帮你处理好状态的序列化和“注水”(hydration)。</li>
<li><strong>更严格的“心智模型”</strong> ：它强制你区分 <code>state</code>、<code>getters</code>、<code>actions</code>，让团队协作更规范。</li>
</ol>
<h4 data-id="heading-1">Pinia的优势，你的项目真的需要吗？</h4>
<p>我们再回到上篇文章的核心观点：</p>
<p><strong>在一个中小型项目、独立开发、或者团队成员对组合式 API 都很熟练的场景下，上面 Pinia 提供的 4 个好处，你真的都需要吗？</strong></p>
<ul>
<li><strong>Devtools</strong>：说实话，在我十多年的生涯里，除了在 Redux/Vuex 刚出来那会儿，为了调试复杂的异步流和中间件，会去用时间旅行。在绝大多数业务场景里，<code>console.log</code> 和 Vue Devtools 里自带的组件状态检查，已经解决了 99% 的问题。为了那 1% 的“可能”，去引入一个库，划算吗？</li>
<li><strong>插件系统（如持久化）</strong> ：用组合式 API 怎么做持久化？太简单了。你封装的 <code>useUser</code> hook 里面，<code>login</code> 的时候加一行 <code>localStorage.setItem</code>，初始化 <code>token</code> 的时候加一行 <code>localStorage.getItem</code>。这不就是最原始、最可控的持久化吗？你需要为这么点功能，去学一个 Pinia 插件的 API 吗？</li>
<li><strong>SSR</strong>：如果你的项目压根就不是 SSR，那这条对你无效。</li>
<li><strong>严格的心智模型</strong>：这是最大的“陷阱”。组合式 API 的核心思想就是“自由”。它允许你把 <code>state</code> 和 <code>action</code> 放在一起，按“功能”去组织代码，而不是按“类型”（state/getter/action）去组织。<code>defineStore</code> 某种程度上，是又把我们拉回了 Vuex 的那种“分门别类”的思维里。</li>
</ul>
<p>所以，“你会得到更少的心智负担”指的就是这个。</p>
<p>你不需要去记 <code>defineStore</code> 的 API，不需要去想“我这个逻辑是算 <code>getter</code> 还是 <code>action</code>”，你就是在写 JS/TS，你就是在写 <code>function</code>。<strong>这难道不是一种解放吗？</strong></p>
<h4 data-id="heading-2"><strong>什么叫“没用明白 Pinia”？</strong></h4>
<p>在我看来，恰恰相反。</p>
<p><strong>把 Pinia 当成新时代的 Vuex，不分场景、启动项目就先装上，这才是“没用明白 Vue 3”。</strong></p>
<p>如果没有明白 Vue 3 组合式 API 到底给了你多大的“自由”和“能力”，就可能继续用 Vue 2 的“保姆式”思维在写 Vue 3。</p>
<p>我想了几个场景，大家参考下：</p>
<ol>
<li><strong>场景一：个人项目、小团队敏捷开发、内部工具</strong></li>
</ol>
<ul>
<li><strong>我的选择：100% 使用组合式 API。</strong></li>
<li><strong>理由：</strong> 速度快，灵活，零依赖。我可以按功能拆分 <code>useCounter.ts</code>, <code>useUser.ts</code>, <code>useCart.ts</code>... 它们就是一堆 TS 模块，需要共享就在顶层定义 <code>reactive</code>，不需要就只导出函数。打包体积更小，心智负担为零。</li>
</ul>
<ol start="3">
<li><strong>场景二：大型企业级应用、多团队协作、需要强规范</strong></li>
</ol>
<ul>
<li><strong>我的选择：我会倾向于使用 Pinia。</strong></li>
<li><strong>理由：</strong> 这种项目，“规范”大于“灵活”。<code>defineStore</code> 提供的统一范式，能让不同水平的开发者（尤其是新人）写出风格更一致的代码。而且在这种复杂项目里，Devtools 的时间旅行和状态快照，在排查深层 Bug 时，确实能派上用场。</li>
</ul>
<ol start="5">
<li><strong>场景三：需要 SSR 的项目</strong></li>
</ol>
<ul>
<li><strong>我的选择：用 Pinia。</strong></li>
<li><strong>理由：</strong> 别重复造轮子。Pinia 对 SSR 状态处理得很好，自己搞一套组合式 API 的 SSR 状态同步，费时费力，不值得。</li>
</ul>
<p>所以你看，并不是在全盘否定 Pinia，而是在呼吁大家 <strong>“按需选择”</strong> 。</p>
<p>不要因为“大家都用”或者“官方推荐”就去用。工具是死的，人是活的。Vue 3 给了我们一把更轻、更快的匕首（组合式 API），你为什么非要抱着那把很牛、但也很重的开山刀（Pinia）不放，连切个水果都要用它呢？</p>
<p>下次在项目里 <code>npm install pinia</code> 之前，先停 5 秒钟，问问自己：<strong>我这次，真的需要它吗？还是说，几个 <code>ref</code> 和 <code>reactive</code> 就能搞定了？</strong></p>
<p>想明白这个问题，可能比你多刷 10 篇 Pinia 的教程都有用。</p>
<p>行了，今天就聊到这。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深度智能体框架DeepAgent剖析]]></title>    <link>https://juejin.cn/post/7575152891955249152</link>    <guid>https://juejin.cn/post/7575152891955249152</guid>    <pubDate>2025-11-23T00:55:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575152891955249152" data-draft-id="7575152891955232768" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深度智能体框架DeepAgent剖析"/> <meta itemprop="keywords" content="人工智能,开源"/> <meta itemprop="datePublished" content="2025-11-23T00:55:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="深度学习机器"/> <meta itemprop="url" content="https://juejin.cn/user/486421344552179"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深度智能体框架DeepAgent剖析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/486421344552179/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    深度学习机器
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T00:55:04.000Z" title="Sun Nov 23 2025 00:55:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>当我们谈论 AI Agent 时，大多数开发者想到的是一个简单的工具调用循环：LLM 生成工具调用，执行工具，将结果返回给 LLM，继续下一轮。这种浅层架构在处理简单任务时表现良好，但面对复杂的多步骤工作流时，就会暴露出致命缺陷：无法有效规划、上下文管理混乱、缺乏质量审查机制。尽管有类似与<code>Langgraph</code>这样的工作流框架，能够免去开发者在编排workflow上面的耗时，但是Agent的核心能力，比如节点和工具，仍需要自行实现。</p>
<p>LangChain 团队研究了<code>Claude Code</code>、<code>OpenAI Deep Research</code>、<code>Manus</code>等真正在生产环境中解决复杂问题的系统，提炼出了四个关键的特征：</p>
<ol>
<li>
<p><strong>详细的系统提示词</strong>：包含工具使用指南和少样本示例的长提示。</p>
</li>
<li>
<p><strong>规划工具</strong>：如<code>Claude Code</code>的Todo List，用于任务分解和进度追踪。</p>
</li>
<li>
<p><strong>子智能体委托</strong>：将复杂任务拆分给专注的子智能体处理。</p>
</li>
<li>
<p><strong>文件系统访问</strong>：作为共享工作空间和长期记忆的载体。</p>
</li>
</ol>
<p><code>DeepAgent</code>正是将这些特征进行抽象后，系统化、框架化的产物，它不是简单的工具调用循环，而是一个完整的<code>Agent Harness</code>，即智能体工具套件。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3bf01a98ee241d08756ae458928fabb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex5bqm5a2m5Lmg5py65Zmo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764464104&amp;x-signature=95mZ5Rb5fAcSdoc0GK5RyHGXL88%3D" alt="DeepAgent核心架构" loading="lazy"/></p>
<h2 data-id="heading-0">核心架构</h2>
<h3 data-id="heading-1">什么是 Agent Harness</h3>
<p><code>DeepAgent</code>将自己定位为<code>Agent Harness</code>，它本质上仍是工具调用循环，但集成了让智能体<strong>深度思考</strong>的核心能力。与传统框架不同，<code>DeepAgent</code>通过内置工具和能力，让开发者专注于业务逻辑，而非基础设施搭建。</p>
<h3 data-id="heading-2">模块化的中间件</h3>
<p><code>DeepAgent</code>采用可组合的中间件架构，每个中间件负责一个独立的能力域。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/beb6dd52c2fe4ed2ae8fe0f26bba9bc0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex5bqm5a2m5Lmg5py65Zmo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764464104&amp;x-signature=aCqRVfxjsHWgcaAB6Cq%2BNtMeu%2F8%3D" alt="内置的中间件" loading="lazy"/></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> deepagents <span class="hljs-keyword">import</span> create_deep_agent
<span class="hljs-keyword">from</span> deepagents.middleware <span class="hljs-keyword">import</span> TodoListMiddleware, FilesystemMiddleware, SubAgentMiddleware

<span class="hljs-comment"># 默认情况下，create_deep_agent 会自动附加三大核心中间件</span>
agent = create_deep_agent(
    model=<span class="hljs-string">"claude-sonnet-4-5-20250929"</span>,
    <span class="hljs-comment"># 以下中间件会自动启用：</span>
    <span class="hljs-comment"># - TodoListMiddleware: 提供 write_todos 规划工具</span>
    <span class="hljs-comment"># - FilesystemMiddleware: 提供 6 个文件系统工具</span>
    <span class="hljs-comment"># - SubAgentMiddleware: 提供 task 工具用于子智能体委托</span>
)
</code></pre>
<p>这种设计的优势在于可组合性，让开发者可以根据需求选择启用特定中间件，或添加自定义中间件扩展能力。</p>
<h2 data-id="heading-3">文件系统</h2>
<h3 data-id="heading-4">六大文件系统工具</h3>
<p><code>DeepAgent</code>提供了完整的文件系统操作能力，这是其区别于浅层 Agent 的关键特性：</p>








































<table><thead><tr><th>工具</th><th>功能</th><th>用途</th></tr></thead><tbody><tr><td><code>ls</code></td><td>列出文件及元数据，包括大小和修改时间等</td><td>探索目录结构</td></tr><tr><td><code>read_file</code></td><td>读取文件内容，支持行号和分页</td><td>分块读取大文件</td></tr><tr><td><code>write_file</code></td><td>创建新文件</td><td>保存中间结果</td></tr><tr><td><code>edit_file</code></td><td>精确字符串替换</td><td>更新已有文件</td></tr><tr><td><code>glob</code></td><td>模式匹配查找文件</td><td>批量查找文件</td></tr><tr><td><code>grep</code></td><td>搜索文件内容</td><td>代码搜索，内容定位</td></tr></tbody></table>
<h3 data-id="heading-5">自动压缩机制</h3>
<p>当工具返回结果超出token阈值时，<code>DeepAgent</code>会自动将其转储到文件系统，防止上下文窗口饱和：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 伪代码示例：自动驱逐逻辑</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">handle_tool_result</span>(<span class="hljs-params">result, threshold=<span class="hljs-number">2000</span></span>):
    <span class="hljs-keyword">if</span> count_tokens(result) &gt; threshold:
        file_path = <span class="hljs-string">f"/temp/tool_result_<span class="hljs-subst">{uuid4()}</span>.txt"</span>
        write_file(file_path, result)
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"Large result saved to <span class="hljs-subst">{file_path}</span>. Use read_file to access."</span>
    <span class="hljs-keyword">return</span> result
</code></pre>
<p>这确保了即使调用返回海量数据的工具（如Web 搜索、数据库查询等），智能体也能通过文件系统分块读取，而不会导致上下文崩溃。</p>
<h2 data-id="heading-6">灵活的持久化策略</h2>
<h3 data-id="heading-7">BackendProtocol 协议设计</h3>
<p><code>DeepAgent</code>将文件系统操作抽象为<code>BackendProtocol</code>协议，支持多种存储策略：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> deepagents.backends <span class="hljs-keyword">import</span> StateBackend, FilesystemBackend, StoreBackend, CompositeBackend

<span class="hljs-comment"># 1. StateBackend：短期内存（默认）</span>
agent = create_deep_agent()  <span class="hljs-comment"># 文件存储在 LangGraph State 中</span>

<span class="hljs-comment"># 2. FilesystemBackend：本地磁盘持久化</span>
agent = create_deep_agent(
    backend=FilesystemBackend(root_dir=<span class="hljs-string">"/Users/agent/workspace"</span>, virtual_mode=<span class="hljs-literal">True</span>)
)

<span class="hljs-comment"># 3. StoreBackend：跨线程持久化（LangGraph Store）</span>
<span class="hljs-keyword">from</span> langgraph.store.memory <span class="hljs-keyword">import</span> InMemoryStore
agent = create_deep_agent(
    backend=<span class="hljs-keyword">lambda</span> rt: StoreBackend(rt),
    store=InMemoryStore()
)

<span class="hljs-comment"># 4. CompositeBackend：混合存储路由</span>
composite = <span class="hljs-keyword">lambda</span> rt: CompositeBackend(
    default=StateBackend(rt),  <span class="hljs-comment"># 临时文件用 State</span>
    routes={
        <span class="hljs-string">"/memories/"</span>: StoreBackend(rt),  <span class="hljs-comment"># 长期记忆持久化</span>
        <span class="hljs-string">"/workspace/"</span>: FilesystemBackend(root_dir=<span class="hljs-string">"/real/path"</span>)  <span class="hljs-comment"># 工作文件映射到磁盘</span>
    }
)
agent = create_deep_agent(backend=composite, store=InMemoryStore())
</code></pre>
<h3 data-id="heading-8">路由策略示例</h3>
<p>使用<code>CompositeBackend</code>时，不同路径前缀的文件会路由到不同的后端：</p>
<ul>
<li>
<p><code>/workspace/plan.md</code> → StateBackend（短期）</p>
</li>
<li>
<p><code>/memories/agent_context.txt</code> → StoreBackend（跨会话持久化）</p>
</li>
<li>
<p><code>/docs/api_spec.yaml</code> → FilesystemBackend（真实文件系统）</p>
</li>
</ul>
<p>这种设计让智能体能够同时管理临时草稿和长期知识库。</p>
<h2 data-id="heading-9">子智能体机制</h2>
<h3 data-id="heading-10">为什么需要子智能体</h3>
<p>子智能体解决了上下文膨胀问题，实现任务委托与上下文隔离。当智能体使用大输出工具（如多次 Web 搜索）时，主智能体的上下文会迅速填满中间结果。子智能体通过隔离详细工作，让主智能体只接收最终结果，而非生成该结果的几十次工具调用。</p>
<h3 data-id="heading-11">两种定义方式</h3>
<ol>
<li>字典配置</li>
</ol>
<pre><code class="hljs language-python" lang="python">research_subagent = {
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"research-agent"</span>,
    <span class="hljs-string">"description"</span>: <span class="hljs-string">"用于深度研究复杂问题"</span>,
    <span class="hljs-string">"system_prompt"</span>: <span class="hljs-string">"你是一个专业的研究助手，擅长多步骤信息收集和综合"</span>,
    <span class="hljs-string">"tools"</span>: [internet_search, summarize],
    <span class="hljs-string">"model"</span>: <span class="hljs-string">"openai:gpt-4o"</span>,  <span class="hljs-comment"># 可选：覆盖主智能体模型</span>
    <span class="hljs-string">"interrupt_on"</span>: {<span class="hljs-string">"internet_search"</span>: <span class="hljs-literal">True</span>}  <span class="hljs-comment"># 可选：HITL 配置</span>
}

agent = create_deep_agent(
    model=<span class="hljs-string">"claude-sonnet-4-5-20250929"</span>,
    subagents=[research_subagent]
)
</code></pre>
<ol start="2">
<li>编译图</li>
</ol>
<p>对于复杂工作流，可以使用预构建的<code>LangGraph</code>图：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> deepagents <span class="hljs-keyword">import</span> CompiledSubAgent
<span class="hljs-keyword">from</span> langgraph.graph <span class="hljs-keyword">import</span> StateGraph

<span class="hljs-comment"># 创建自定义图</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">create_analysis_graph</span>():
    workflow = StateGraph(...)
    <span class="hljs-comment"># ... 构建复杂的分析流程</span>
    <span class="hljs-keyword">return</span> workflow.<span class="hljs-built_in">compile</span>()

analysis_subagent = CompiledSubAgent(
    name=<span class="hljs-string">"data-analyzer"</span>,
    description=<span class="hljs-string">"执行多步骤数据分析任务"</span>,
    runnable=create_analysis_graph()
)

agent = create_deep_agent(subagents=[analysis_subagent])
</code></pre>
<h3 data-id="heading-12">默认子智能体</h3>
<p>除了用户定义的子智能体，<code>DeepAgent</code>始终提供一个<code>general-purpose</code>子智能体：</p>
<ul>
<li>
<p>与主智能体相同的系统提示词和工具</p>
</li>
<li>
<p>主要用途：上下文隔离（而非专业化）</p>
</li>
<li>
<p>使用场景：主智能体可以将复杂任务委托给它，获得简洁结果而不受中间过程污染</p>
</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 主智能体可以这样使用：</span>
<span class="hljs-comment"># "请使用 general-purpose 子智能体分析这 100 个文件，返回摘要"</span>
<span class="hljs-comment"># 子智能体完成工作后，主智能体只收到摘要，而非 100 次文件读取的详细内容</span>
</code></pre>
<h2 data-id="heading-13">生产级特性</h2>
<p>针对生产环境，<code>DeepAgent</code>还提供了许多有用的特性。</p>
<h3 data-id="heading-14">1. 对话历史自动摘要</h3>
<p>当 token 使用量过高时，<code>DeepAgent</code>会自动压缩旧对话历史：</p>
<pre><code class="hljs language-python" lang="python">agent = create_deep_agent(
    model=<span class="hljs-string">"claude-sonnet-4-5-20250929"</span>,
    <span class="hljs-comment"># 配置摘要触发阈值和目标长度</span>
)
</code></pre>
<h3 data-id="heading-15">2. 工具调用自动修复</h3>
<p>当工具调用被中断或取消时，<code>DeepAgent</code>会自动修复消息历史：</p>
<p><strong>问题场景</strong>：用户在工具执行过程中取消操作，导致<code>tool_call</code>消息没有对应的<code>tool_result</code>，破坏了消息序列的完整性。</p>
<p><strong>解决方案</strong>：<code>DeepAgent</code>会自动注入占位符<code>ToolMessage</code>，确保消息历史的连贯性，避免 LLM 在后续轮次中因不完整的上下文而产生困惑。</p>
<h3 data-id="heading-16">3. Prompt缓存机制</h3>
<p>对于使用Anthropic模型的智能体，<code>DeepAgent</code>启用了<code>prompt caching</code>功能：</p>
<ul>
<li>
<p>自动标记可缓存的提示词部分（如系统提示词、工具定义）</p>
</li>
<li>
<p>减少重复 token 处理，显著降低成本和延迟</p>
</li>
<li>
<p>对于长系统提示词的深度智能体尤其有价值</p>
</li>
</ul>
<h3 data-id="heading-17">4. Human-in-the-Loop</h3>
<p><code>DeepAgent</code>支持在特定工具调用时暂停执行，等待人工审批：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langgraph.checkpoint.memory <span class="hljs-keyword">import</span> MemorySaver

agent = create_deep_agent(
    model=<span class="hljs-string">"claude-sonnet-4-5-20250929"</span>,
    tools=[delete_file, send_email, read_file],
    interrupt_on={
        <span class="hljs-string">"delete_file"</span>: <span class="hljs-literal">True</span>,  <span class="hljs-comment"># 需要审批（approve/edit/reject）</span>
        <span class="hljs-string">"send_email"</span>: {<span class="hljs-string">"allowed_decisions"</span>: [<span class="hljs-string">"approve"</span>, <span class="hljs-string">"reject"</span>]},  <span class="hljs-comment"># 只能批准或拒绝</span>
        <span class="hljs-string">"read_file"</span>: <span class="hljs-literal">False</span>  <span class="hljs-comment"># 无需审批</span>
    },
    checkpointer=MemorySaver()  <span class="hljs-comment"># HITL 必须使用 checkpointer</span>
)

<span class="hljs-comment"># 使用示例</span>
config = {<span class="hljs-string">"configurable"</span>: {<span class="hljs-string">"thread_id"</span>: <span class="hljs-string">"session-123"</span>}}
result = agent.invoke({<span class="hljs-string">"messages"</span>: [...]}, config=config)

<span class="hljs-keyword">if</span> result.get(<span class="hljs-string">"__interrupt__"</span>):
    <span class="hljs-comment"># 处理中断，展示待审批操作</span>
    interrupts = result[<span class="hljs-string">"__interrupt__"</span>][<span class="hljs-number">0</span>].value
    action_requests = interrupts[<span class="hljs-string">"action_requests"</span>]
    
    <span class="hljs-comment"># 用户决策</span>
    decisions = [{<span class="hljs-string">"type"</span>: <span class="hljs-string">"approve"</span>}]  <span class="hljs-comment"># 或 "edit"、"reject"</span>
    
    <span class="hljs-comment"># 恢复执行</span>
    result = agent.invoke(
        Command(resume={<span class="hljs-string">"decisions"</span>: decisions}),
        config=config  <span class="hljs-comment"># 必须使用相同的 config</span>
    )
</code></pre>
<h2 data-id="heading-18">总结</h2>
<p><code>DeepAgent</code>实现了从浅层Agent到深度Agent的范式转变，其核心价值在于将复杂任务自动化系统所需的核心能力封装为可组合、生产就绪的<strong>模块化中间件</strong>。</p>
<p>有了这些生产特性，无论是在构建研究助手、代码生成工具、数据分析平台还是智能客服系统，<code>DeepAgent</code>的设计模式都值得深入学习和应用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Next.js第十章(Proxy)]]></title>    <link>https://juejin.cn/post/7575458028254822443</link>    <guid>https://juejin.cn/post/7575458028254822443</guid>    <pubDate>2025-11-23T13:00:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575458028254822443" data-draft-id="7575442779039334442" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Next.js第十章(Proxy)"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-23T13:00:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小满zs"/> <meta itemprop="url" content="https://juejin.cn/user/2463384809252397"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Next.js第十章(Proxy)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2463384809252397/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小满zs
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T13:00:39.000Z" title="Sun Nov 23 2025 13:00:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Proxy代理</h2>
<blockquote>
<p>从 Next.js 16 开始，中间件<code>Middleware</code>更名为代理<code>（Proxy）</code>，以更好地体现其用途。其功能保持不变</p>
</blockquote>
<p>如果你想升级为16.x版本，Next.js提供了命令行工具来帮助你升级，只需要执行以下命令即可：</p>
<pre><code class="hljs language-bash" lang="bash">npx @next/codemod@canary middleware-to-proxy .
</code></pre>
<p>代码转换会将文件和函数名从middleware重命名为proxy。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// middleware.ts -&gt; proxy.ts</span>
 
- <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">middleware</span>(<span class="hljs-params"/>) {
+ <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">proxy</span>(<span class="hljs-params"/>) {
</code></pre>
<h3 data-id="heading-1">基本使用</h3>
<p>应用场景：</p>
<ul>
<li>处理跨域请求</li>
<li>接口转发例如/api/user -&gt; (可能是其他服务器java/go/python等) -&gt; /api/user</li>
<li>限流例如配合第三方服务做限流</li>
<li>鉴权/判断是否登录</li>
</ul>
<p>Prxoy代理其实跟拦截器类似，它可以在请求完成之前进行拦截，然后进行一些处理，例如：修改请求头、修改请求体、修改响应体等。</p>
<p>src/proxy.ts</p>
<p>定义proxy函数导出即可，Next.js会自动调用这个函数。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">NextRequest</span>, <span class="hljs-title class_">NextResponse</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"next/server"</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">proxy</span>(<span class="hljs-params">request: NextRequest</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(request.<span class="hljs-property">url</span>,<span class="hljs-string">'url'</span>);
}
</code></pre>
<p>但是你会发现，他会拦截项目中所有的请求，包括静态资源、API请求、页面请求等。</p>
<pre><code class="hljs language-txt" lang="txt">http://localhost:3000/.well-known/appspecific/com.chrome.devtools.json url
http://localhost:3000/_next/static/chunks/src_app_globals_91e4631d.css url
http://localhost:3000/_next/static/chunks/%5Bturbopack%5D_browser_dev_hmr-client_hmr-client_ts_cedd0592._.js url
http://localhost:3000/_next/static/chunks/node_modules_next_dist_compiled_react-dom_1e674e59._.js url
http://localhost:3000/_next/static/chunks/node_modules_next_dist_compiled_react-server-dom-turbopack_9212ccad._.js url
http://localhost:3000/_next/static/chunks/node_modules_next_dist_compiled_next-devtools_index_1dd7fb59.js url
http://localhost:3000/_next/static/chunks/node_modules_next_dist_compiled_a0e4c7b4._.js url
http://localhost:3000/_next/static/chunks/node_modules_next_dist_client_a38d7d69._.js url
http://localhost:3000/_next/static/chunks/node_modules_next_dist_4b2403f5._.js url
http://localhost:3000/_next/static/chunks/src_app_globals_91e4631d.css.map url
http://localhost:3000/_next/static/chunks/node_modules_%40swc_helpers_cjs_d80fb378._.js url
http://localhost:3000/_next/static/chunks/_a0ff3932._.js url
http://localhost:3000/api/login url
</code></pre>
<h4 data-id="heading-2">配置(config)</h4>
<p>例如我们只想匹配<code>'/api'</code>下面的路径去做一些事情，我们可以使用<code>config</code>配置来实现。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">NextRequest</span>, <span class="hljs-title class_">NextResponse</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"next/server"</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">proxy</span>(<span class="hljs-params">request: NextRequest</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(request.<span class="hljs-property">url</span>,<span class="hljs-string">'url'</span>);
}
<span class="hljs-comment">//配置匹配路径</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> config = {
    <span class="hljs-attr">matcher</span>: <span class="hljs-string">'/api/:path*'</span>,
    <span class="hljs-comment">//matcher: ['/api/:path*','/api/user/:path*'], 支持单个以及多个路径匹配</span>
    <span class="hljs-comment">//matcher: ['/((?!api|_next/static|_next/image|.*\\.png$).*)'], 同样支持正则表达式匹配</span>
}
</code></pre>
<p>结合之前的案例,在cookie那一集，我们还需要单独定义check接口检查cookie，现在我们可以直接在proxy中实现。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">NextRequest</span>, <span class="hljs-title class_">NextResponse</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"next/server"</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">proxy</span>(<span class="hljs-params">request: NextRequest</span>) {
    <span class="hljs-keyword">const</span> cookie = request.<span class="hljs-property">cookies</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'token'</span>);
    <span class="hljs-keyword">if</span> (request.<span class="hljs-property">nextUrl</span>.<span class="hljs-property">pathname</span>.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'/home'</span>) &amp;&amp; !cookie) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'redirect to login'</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">redirect</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-string">'/'</span>, request.<span class="hljs-property">url</span>));
    }
    <span class="hljs-keyword">if</span> (cookie &amp;&amp; cookie.<span class="hljs-property">value</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">next</span>();
    }
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">redirect</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-string">'/'</span>, request.<span class="hljs-property">url</span>));
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> config = {
    <span class="hljs-attr">matcher</span>: [<span class="hljs-string">'/api/:path*'</span>, <span class="hljs-string">'/home/:path*'</span>],
}
</code></pre>
<h4 data-id="heading-3">复杂匹配</h4>
<ul>
<li>source: 表示匹配路径</li>
<li>has: 表示匹配路径中必须(包含)某些条件</li>
<li>missing: 表示匹配路径中(必须不包含)某些条件</li>
</ul>
<p><strong>type</strong> 只能匹配: header, query, cookie</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">NextRequest</span>, <span class="hljs-title class_">NextResponse</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"next/server"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ProxyConfig</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"next/server"</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">proxy</span>(<span class="hljs-params">request: NextRequest</span>) {
   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'start proxy'</span>)
   <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">next</span>();
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">config</span>: <span class="hljs-title class_">ProxyConfig</span> = {
    <span class="hljs-attr">matcher</span>: [
        {
            <span class="hljs-attr">source</span>: <span class="hljs-string">'/home/:path*'</span>,
            <span class="hljs-comment">//表示匹配路径中必须(包含)Authorization头和userId查询参数</span>
            <span class="hljs-attr">has</span>: [
                { <span class="hljs-attr">type</span>: <span class="hljs-string">'header'</span>, <span class="hljs-attr">key</span>: <span class="hljs-string">'Authorization'</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">'Bearer 123456'</span> },
                { <span class="hljs-attr">type</span>: <span class="hljs-string">'query'</span>, <span class="hljs-attr">key</span>: <span class="hljs-string">'userId'</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">'123'</span> }
            ],
            <span class="hljs-comment">//表示匹配路径中(必须不包含)cookie和userId查询参数</span>
            <span class="hljs-attr">missing</span>: [
                { <span class="hljs-attr">type</span>: <span class="hljs-string">'cookie'</span>, <span class="hljs-attr">key</span>: <span class="hljs-string">'token'</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">'123456'</span> },
                { <span class="hljs-attr">type</span>: <span class="hljs-string">'query'</span>, <span class="hljs-attr">key</span>: <span class="hljs-string">'userId'</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">'456'</span> },
            ]
        },
    ]
}
</code></pre>
<p>访问url为：<code>http://localhost:3000/home?userId=123</code></p>
<h4 data-id="heading-4">案例实战(处理跨域)</h4>
<p>只要是/api下面的接口都可以被任意访问</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">NextRequest</span>, <span class="hljs-title class_">NextResponse</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"next/server"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ProxyConfig</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"next/server"</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">proxy</span>(<span class="hljs-params">request: NextRequest</span>) {
    <span class="hljs-keyword">const</span> response = <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">next</span>();
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(corsHeaders).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[key, value]</span>) =&gt;</span> {
        response.<span class="hljs-property">headers</span>.<span class="hljs-title function_">set</span>(key, value);
    })
    <span class="hljs-keyword">return</span> response;
}

<span class="hljs-keyword">const</span> corsHeaders = {
    <span class="hljs-string">'Access-Control-Allow-Origin'</span>: <span class="hljs-string">'*'</span>,
    <span class="hljs-string">'Access-Control-Allow-Methods'</span>: <span class="hljs-string">'GET, POST, PUT, DELETE, OPTIONS'</span>,
    <span class="hljs-string">'Access-Control-Allow-Headers'</span>: <span class="hljs-string">'Content-Type, Authorization'</span>,
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">config</span>: <span class="hljs-title class_">ProxyConfig</span> = {
   <span class="hljs-attr">matcher</span>:<span class="hljs-string">'/api/:path*'</span>,
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb6ec749269e4c428d9ed3e7d8cf9a8c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764507639&amp;x-signature=sOLI4%2BJZEG05m3caC%2F6GzrkV9SA%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用好PowerMock，轻松搞定那些让你头疼的单元测试]]></title>    <link>https://juejin.cn/post/7575102209606221850</link>    <guid>https://juejin.cn/post/7575102209606221850</guid>    <pubDate>2025-11-23T08:26:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575102209606221850" data-draft-id="7575119254313844762" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用好PowerMock，轻松搞定那些让你头疼的单元测试"/> <meta itemprop="keywords" content="后端,单元测试"/> <meta itemprop="datePublished" content="2025-11-23T08:26:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java随想录"/> <meta itemprop="url" content="https://juejin.cn/user/2837192913204935"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用好PowerMock，轻松搞定那些让你头疼的单元测试
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2837192913204935/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java随想录
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T08:26:47.000Z" title="Sun Nov 23 2025 08:26:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文已收录至GitHub，推荐阅读 👉 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FBookSea4j%2FJavaRecord" target="_blank" title="https://github.com/BookSea4j/JavaRecord" ref="nofollow noopener noreferrer">Java随想录</a></p>
<p>微信公众号：Java随想录</p>
<p>结合 <a href="https://juejin.cn/post/7498580969286631434" target="_blank" title="https://juejin.cn/post/7498580969286631434">不用Mockito写单元测试？你可能在浪费一半时间</a> 阅读体验更佳。</p>
<blockquote>
<p>面对无法Mock的静态方法、私有方法和final类，PowerMock为你打开一扇新的大门</p>
</blockquote>
<p>作为一名Java开发者，单元测试是我们保证代码质量的重要环节。但在实际工作中，我们经常会遇到一些难以测试的代码场景：静态工具类、final类、私有方法等。传统的Mockito框架对这些情况束手无策，而PowerMock的出现正好解决了这些痛点。</p>
<h2 data-id="heading-0">PowerMock是什么？为什么需要它？</h2>
<h3 data-id="heading-1">PowerMock的核心定位</h3>
<p>PowerMock是一个强大的Java单元测试框架，它通过扩展现有的Mock框架（如Mockito和EasyMock），提供了更强大的Mock能力。<strong>PowerMock的核心价值在于它能够Mock那些传统Mock工具无法处理的情况</strong>，包括静态方法、final类和方法、私有方法、构造函数等。</p>
<p>与普通Mock框架不同，PowerMock使用自定义的类加载器和字节码操作技术（基于Javassist和ASM库），在运行时修改类的行为，从而实现对这些"难以Mock"的场景的完全控制。</p>
<h3 data-id="heading-2">PowerMock与Mockito的关系和区别</h3>
<p>虽然PowerMock和Mockito都是用于单元测试的Mock框架，但它们在功能和定位上有着明显的区别：</p>
<p><strong>Mockito</strong>是一个轻量级、简单易用的Mock框架，适用于大多数日常测试场景。但它有明显的局限性：无法Mock静态方法、final类、私有方法和构造函数等。</p>
<p><strong>PowerMock</strong>则是对Mockito的增强，填补了Mockito的功能空白。它不是替代Mockito，而是与Mockito协同工作，共同构建完整的单元测试解决方案。</p>
<p>两者核心区别体现在底层实现上：Mockito使用动态代理（CGLIB）技术，而PowerMock通过修改字节码来实现更强大的Mock能力。</p>
<p>正因为这种根本差异，PowerMock可以解决Mockito无法解决的问题。</p>
<h3 data-id="heading-3">PowerMock解决的痛点</h3>
<p>在日常开发中，我们经常会遇到以下测试难题：</p>
<ul>
<li><strong>静态工具类</strong>：如各种Util类中的静态方法。</li>
<li><strong>final类和final方法</strong>：特别是第三方库中的final类。</li>
<li><strong>私有方法</strong>：需要直接测试的私有方法逻辑。</li>
<li><strong>构造函数依赖</strong>：方法内部通过new创建的对象。</li>
<li><strong>静态代码块和系统类</strong>：如System.currentTimeMillis()。</li>
</ul>
<p>这些问题使用传统Mock框架难以解决，而PowerMock为此提供了完整的解决方案</p>
<h2 data-id="heading-4">环境配置与基本用法</h2>
<h3 data-id="heading-5">添加Maven依赖</h3>
<p>要开始使用PowerMock，首先需要在项目中添加相关依赖。由于PowerMock需要与Mockito协同工作，需要同时添加两个依赖：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- PowerMock + Mockito 组合 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.powermock<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>powermock-module-junit4<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.0.9<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.powermock<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>powermock-api-mockito2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.0.9<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p><strong>版本兼容性注意</strong>：确保PowerMock与Mockito/JUnit版本匹配，具体兼容性关系可参考官方文档。</p>
<h3 data-id="heading-6">基本配置注解</h3>
<p>使用PowerMock需要在测试类上添加必要的注解：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RunWith(PowerMockRunner.class)</span> <span class="hljs-comment">// 必须使用PowerMockRunner</span>
<span class="hljs-meta">@PrepareForTest({StaticUtils.class, User.class})</span> <span class="hljs-comment">// 声明需增强的类</span>
<span class="hljs-meta">@PowerMockIgnore("javax.management.*")</span> <span class="hljs-comment">// 解决类加载器冲突</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceTest</span> {
    <span class="hljs-comment">// 测试内容</span>
}
</code></pre>
<ul>
<li><code>@RunWith(PowerMockRunner.class)</code>：告诉JUnit使用PowerMock的测试运行器。</li>
<li><code>@PrepareForTest</code>：指定需要被PowerMock修改的类（包含静态方法、final方法等的类）。</li>
<li><code>@PowerMockIgnore</code>：解决使用PowerMock后可能出现的类加载器冲突问题。</li>
</ul>
<h2 data-id="heading-7">PowerMock核心使用场景详解</h2>
<h3 data-id="heading-8">静态方法Mock</h3>
<p>静态方法是最常见的测试难点之一，让我们看看PowerMock如何解决这个问题。</p>
<p><strong>场景示例</strong>：假设我们有一个静态工具类，用于生成唯一ID：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IdGenerator</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">generateUniqueId</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 实际业务中可能包含复杂的逻辑或外部依赖</span>
        <span class="hljs-keyword">return</span> UUID.randomUUID().toString();
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">createOrder</span><span class="hljs-params">()</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> IdGenerator.generateUniqueId();
        <span class="hljs-comment">// 创建订单的逻辑</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"ORDER_"</span> + orderId;
    }
}
</code></pre>
<p><strong>测试代码</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RunWith(PowerMockRunner.class)</span>
<span class="hljs-meta">@PrepareForTest({IdGenerator.class, OrderService.class})</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderServiceTest</span> {
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testCreateOrderWithStaticMock</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 1. 准备静态类的Mock</span>
        PowerMockito.mockStatic(IdGenerator.class);
        
        <span class="hljs-comment">// 2. 预设静态方法行为</span>
        PowerMockito.when(IdGenerator.generateUniqueId()).thenReturn(<span class="hljs-string">"123e4567"</span>);
        
        <span class="hljs-comment">// 3. 创建被测试对象并调用被测方法</span>
        <span class="hljs-type">OrderService</span> <span class="hljs-variable">orderService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderService</span>();
        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> orderService.createOrder();
        
        <span class="hljs-comment">// 4. 验证结果</span>
        assertEquals(<span class="hljs-string">"ORDER_123e4567"</span>, result);
        
        <span class="hljs-comment">// 5. 验证静态方法调用（必须调用）</span>
        PowerMockito.verifyStatic(IdGenerator.class);
        IdGenerator.generateUniqueId();
    }
}
</code></pre>
<p><strong>关键点说明</strong>：</p>
<ul>
<li><code>mockStatic()</code>方法用于告诉PowerMock要Mock哪个类的静态方法</li>
<li>静态方法的Stubbing（定义行为）与普通Mockito语法类似</li>
<li><strong>必须调用</strong><code>verifyStatic()</code>来验证静态方法的调用，且需要在验证前调用一次</li>
</ul>
<p><strong>常见坑点</strong>：忘记调用<code>verifyStatic()</code>会导致无法验证静态方法是否被正确调用。</p>
<h3 data-id="heading-9">私有方法Mock</h3>
<p>测试私有方法一直存在争议，但在某些场景下（如复杂算法验证）确实有必要直接测试私有方法。</p>
<p><strong>场景示例</strong>：一个包含复杂校验逻辑的UserService：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">validateUser</span><span class="hljs-params">(String username, String password)</span> {
        <span class="hljs-keyword">if</span> (!isValidFormat(username) || !isValidFormat(password)) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        <span class="hljs-keyword">return</span> internalComplexValidation(username, password);
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isValidFormat</span><span class="hljs-params">(String input)</span> {
        <span class="hljs-comment">// 复杂的格式校验逻辑</span>
        <span class="hljs-keyword">return</span> input != <span class="hljs-literal">null</span> &amp;&amp; input.length() &gt;= <span class="hljs-number">5</span>;
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">internalComplexValidation</span><span class="hljs-params">(String username, String password)</span> {
        <span class="hljs-comment">// 非常复杂的内部校验逻辑</span>
        <span class="hljs-comment">// 可能涉及加密、数据库查询等</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// 简化示例</span>
    }
}
</code></pre>
<p><strong>测试代码</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RunWith(PowerMockRunner.class)</span>
<span class="hljs-meta">@PrepareForTest(UserService.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceTest</span> {

    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testPrivateMethod</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 1. 创建被测类的Spy对象（部分真实调用）</span>
        <span class="hljs-type">UserService</span> <span class="hljs-variable">userService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserService</span>();
        <span class="hljs-type">UserService</span> <span class="hljs-variable">spyService</span> <span class="hljs-operator">=</span> PowerMockito.spy(userService);

        <span class="hljs-comment">// 2. Stubbing：预设私有方法行为</span>
        PowerMockito.doReturn(<span class="hljs-literal">true</span>).when(spyService, <span class="hljs-string">"isValidFormat"</span>, Mockito.anyString());

        <span class="hljs-comment">// 3. 调用被测方法</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> spyService.validateUser(<span class="hljs-string">"testuser"</span>, <span class="hljs-string">"testpass"</span>);

        <span class="hljs-comment">// 4. 验证结果</span>
        assertTrue(result);

        <span class="hljs-comment">// 5. 验证私有方法被调用（可选）</span>
        PowerMockito.verifyPrivate(spyService,Mockito.times(<span class="hljs-number">2</span>))
                .invoke(<span class="hljs-string">"isValidFormat"</span>, Mockito.anyString());
    }

    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testPrivateMethodWithArguments</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">UserService</span> <span class="hljs-variable">userService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserService</span>();
        <span class="hljs-type">UserService</span> <span class="hljs-variable">spyService</span> <span class="hljs-operator">=</span> PowerMockito.spy(userService);

        <span class="hljs-comment">// Mock有参数的私有方法</span>
        PowerMockito.doReturn(<span class="hljs-literal">false</span>)
                .when(spyService, <span class="hljs-string">"internalComplexValidation"</span>, <span class="hljs-string">"user"</span>, <span class="hljs-string">"pass"</span>);

        <span class="hljs-type">boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> spyService.validateUser(<span class="hljs-string">"user"</span>, <span class="hljs-string">"pass"</span>);

        assertFalse(result);
    }
}
</code></pre>
<p><strong>关键点说明</strong>：</p>
<ul>
<li>使用<code>spy()</code>方法创建对象，这样未被Mock的方法会保持真实行为。</li>
<li>使用<code>doReturn().when()</code>语法来Mock私有方法，需通过方法名字符串指定目标方法。</li>
<li>可以通过<code>verifyPrivate()</code>验证私有方法的调用。</li>
</ul>
<p><strong>最佳实践</strong>：优先通过公共方法测试私有逻辑，仅在复杂算法验证等特殊场景下直接测试私有方法。</p>
<h3 data-id="heading-10">final类与方法Mock</h3>
<p>final类和方法由于其不可继承性，在传统Mock框架中无法被Mock，但PowerMock完美解决了这个问题。</p>
<p><strong>场景示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FinalUtility</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> String <span class="hljs-title function_">finalMethod</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Final implementation"</span>;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String <span class="hljs-title function_">staticFinalMethod</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Static final implementation"</span>;
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SomeService</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">FinalUtility</span> <span class="hljs-variable">utility</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FinalUtility</span>();
    
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">useFinalClass</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> utility.finalMethod() + <span class="hljs-string">"_processed"</span>;
    }
}
</code></pre>
<p><strong>测试代码</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RunWith(PowerMockRunner.class)</span>
<span class="hljs-meta">@PrepareForTest({FinalUtility.class, SomeService.class})</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SomeServiceTest</span> {
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testFinalClassAndMethod</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 1. 创建final类的Mock对象</span>
        <span class="hljs-type">FinalUtility</span> <span class="hljs-variable">mockUtility</span> <span class="hljs-operator">=</span> PowerMockito.mock(FinalUtility.class);
        
        <span class="hljs-comment">// 2. 预设final方法行为</span>
        PowerMockito.when(mockUtility.finalMethod()).thenReturn(<span class="hljs-string">"Mocked final"</span>);
        
        <span class="hljs-comment">// 3. 当创建真实对象时返回Mock对象</span>
        PowerMockito.whenNew(FinalUtility.class).withNoArguments().thenReturn(mockUtility);
        
        <span class="hljs-comment">// 4. 测试</span>
        <span class="hljs-type">SomeService</span> <span class="hljs-variable">service</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SomeService</span>();
        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> service.useFinalClass();
        
        assertEquals(<span class="hljs-string">"Mocked final_processed"</span>, result);
    }
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testStaticFinalMethod</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// Mock静态final方法</span>
        PowerMockito.mockStatic(FinalUtility.class);
        PowerMockito.when(FinalUtility.staticFinalMethod()).thenReturn(<span class="hljs-string">"Mocked static final"</span>);
        
        assertEquals(<span class="hljs-string">"Mocked static final"</span>, FinalUtility.staticFinalMethod());
    }
}
</code></pre>
<p><strong>底层原理</strong>：PowerMock通过修改字节码，去除了final方法的final标识符，从而允许Mock操作。</p>
<h3 data-id="heading-11">构造函数Mock</h3>
<p>当方法内部直接通过new创建对象时，传统Mock难以介入，PowerMock的构造函数Mock功能为此提供了解决方案。</p>
<p><strong>场景示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseConnection</span> {
    <span class="hljs-keyword">private</span> String connectionString;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DatabaseConnection</span><span class="hljs-params">(String connectionString)</span> {
        <span class="hljs-built_in">this</span>.connectionString = connectionString;
        <span class="hljs-comment">// 可能包含复杂的初始化逻辑</span>
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(String sql)</span> {
        <span class="hljs-comment">// 执行SQL逻辑</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserRepository</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">saveUser</span><span class="hljs-params">(String username)</span> {
        <span class="hljs-comment">// 在方法内部直接创建依赖对象</span>
        <span class="hljs-type">DatabaseConnection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DatabaseConnection</span>(<span class="hljs-string">"jdbc:mysql://localhost:3306/test"</span>);
        <span class="hljs-keyword">return</span> connection.execute(<span class="hljs-string">"INSERT INTO users VALUES ('"</span> + username + <span class="hljs-string">"')"</span>);
    }
}
</code></pre>
<p><strong>测试代码</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RunWith(PowerMockRunner.class)</span>
<span class="hljs-meta">@PrepareForTest(UserRepository.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserRepositoryTest</span> {
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testConstructorMock</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 1. 创建Mock对象</span>
        <span class="hljs-type">DatabaseConnection</span> <span class="hljs-variable">mockConnection</span> <span class="hljs-operator">=</span> PowerMockito.mock(DatabaseConnection.class);
        
        <span class="hljs-comment">// 2. 预设构造函数行为</span>
        PowerMockito.whenNew(DatabaseConnection.class)
                   .withParameterTypes(String.class)
                   .withArguments(<span class="hljs-string">"jdbc:mysql://localhost:3306/test"</span>)
                   .thenReturn(mockConnection);
        
        <span class="hljs-comment">// 3. 预设方法行为</span>
        PowerMockito.when(mockConnection.execute(Mockito.anyString())).thenReturn(<span class="hljs-literal">true</span>);
        
        <span class="hljs-comment">// 4. 执行测试</span>
        <span class="hljs-type">UserRepository</span> <span class="hljs-variable">repository</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserRepository</span>();
        <span class="hljs-type">boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> repository.saveUser(<span class="hljs-string">"testuser"</span>);
        
        <span class="hljs-comment">// 5. 验证</span>
        assertTrue(result);
        PowerMockito.verifyNew(DatabaseConnection.class)
                   .withArguments(<span class="hljs-string">"jdbc:mysql://localhost:3306/test"</span>);
    }
}
</code></pre>
<p><strong>关键点说明</strong>：</p>
<ul>
<li><code>whenNew()</code>用于拦截构造函数调用。</li>
<li><code>withParameterTypes()</code>和<code>withArguments()</code>用于精确匹配构造函数。</li>
<li>需要使用<code>verifyNew()</code>验证构造函数调用。</li>
</ul>
<p><strong>应用场景</strong>：适用于测试遗留代码中在方法内部直接实例化依赖对象的情况。</p>
<h3 data-id="heading-12">静态代码块处理</h3>
<p>静态代码块在类加载时执行，可能包含不愿在测试中运行的代码（如初始化昂贵资源），PowerMock可以抑制静态代码块的执行。</p>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigurationLoader</span> {
    <span class="hljs-keyword">static</span> {
        <span class="hljs-comment">// 静态代码块，可能包含昂贵的初始化操作</span>
        loadConfigurationFromRemote();
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadConfigurationFromRemote</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 模拟昂贵的初始化</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"不应该在测试中执行"</span>);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getConfig</span><span class="hljs-params">(String key)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"value"</span>;
    }
}
</code></pre>
<p><strong>测试代码</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RunWith(PowerMockRunner.class)</span>
<span class="hljs-meta">@PrepareForTest(ConfigurationLoader.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigurationLoaderTest</span> {
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSuppressStaticInitializer</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 抑制静态代码块执行</span>
        PowerMockito.suppress(PowerMockito.method(ConfigurationLoader.class, <span class="hljs-string">"loadConfigurationFromRemote"</span>));
        
        <span class="hljs-comment">// 现在可以安全测试，静态代码块不会执行</span>
        assertNotNull(ConfigurationLoader.getConfig(<span class="hljs-string">"testkey"</span>));
    }
}
</code></pre>
<h2 data-id="heading-13">PowerMock最佳实践与注意事项</h2>
<h3 data-id="heading-14">谨慎使用PowerMock</h3>
<p>虽然PowerMock功能强大，但过度使用可能是代码设计问题的信号。<strong>以下是一些使用原则</strong>：</p>
<ul>
<li><strong>优先考虑重构</strong>：如果代码中大量使用PowerMock，应该考虑重构代码以提高可测试性。例如，将静态方法改为实例方法，通过依赖注入解耦等。</li>
<li><strong>仅用于遗留代码</strong>：在新项目中，优先通过良好设计避免使用PowerMock，仅在处理难以修改的遗留代码时大量使用。</li>
<li><strong>隔离使用</strong>：将使用PowerMock的测试类单独放置，防止影响其他测试的执行效率。</li>
</ul>
<h3 data-id="heading-15">性能优化建议</h3>
<p>PowerMock由于使用自定义类加载器和字节码操作，会对测试执行时间产生显著影响。以下是一些优化建议：</p>
<ul>
<li><strong>最小化@PrepareForTest</strong>：只将确实需要Mock的类放入注解中，减少字节码操作的范围。</li>
<li><strong>合理使用Mockito</strong>：对于常规Mock场景，仍然使用Mockito，仅在必要时使用PowerMock。</li>
<li><strong>避免过度Mock</strong>：不要Mock系统类或简单值对象，这会给测试带来不必要的复杂性。</li>
</ul>
<h3 data-id="heading-16">版本选择与兼容性</h3>
<p><strong>版本兼容性</strong>：PowerMock与Mockito、JUnit的版本兼容性非常重要。以下是推荐组合：</p>
<ul>
<li>PowerMock 2.x + Mockito 2.x + JUnit 4.12+</li>
<li>避免混合使用不兼容的版本</li>
</ul>
<p><strong>JUnit 5支持</strong>：截至目前，PowerMock不支持JUnit 5，这是选择测试框架时需要考虑的因素。</p>
<h3 data-id="heading-17">常见问题排查</h3>
<p><strong>类加载器冲突</strong>：使用<code>@PowerMockIgnore</code>注解排除冲突的包。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@PowerMockIgnore({"javax.management.*", "javax.net.ssl.*"})</span>
</code></pre>
<p><strong>版本冲突</strong>：确保所有Mock相关库的版本兼容。</p>
<p><strong>静态方法验证失败</strong>：记住每次验证静态方法调用时都要先调用<code>verifyStatic()</code>。</p>
<h2 data-id="heading-18">总结</h2>
<p>PowerMock解决了传统Mock框架无法处理的棘手问题。通过字节码操作技术，PowerMock能够Mock静态方法、final类、私有方法和构造函数等"不可Mock"的元素。</p>
<p><strong>核心价值</strong>：</p>
<ul>
<li>填补了Mockito的功能空白，完善了Java单元测试的工具链。</li>
<li>特别适用于处理遗留代码和第三方库的测试问题。</li>
<li>通过提高代码覆盖率来提升软件质量。</li>
</ul>
<p><strong>适用边界</strong>：</p>
<ul>
<li>不是所有场景都适合使用PowerMock，新项目应优先考虑良好的代码设计。</li>
<li>在测试性能和代码可维护性之间需要权衡。</li>
<li>建议将使用范围控制在确实必要的复杂场景中。</li>
</ul>
<p>希望本文能帮助你在实际项目中更好地使用PowerMock。如果你有任何问题或经验分享，欢迎在评论区留言交流！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[浅入理解流式SSR的性能收益与工作原理]]></title>    <link>https://juejin.cn/post/7575090551357407284</link>    <guid>https://juejin.cn/post/7575090551357407284</guid>    <pubDate>2025-11-23T04:51:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575090551357407284" data-draft-id="7570912420568481802" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="浅入理解流式SSR的性能收益与工作原理"/> <meta itemprop="keywords" content="前端,iOS"/> <meta itemprop="datePublished" content="2025-11-23T04:51:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="明远湖之鱼"/> <meta itemprop="url" content="https://juejin.cn/user/2370998127573751"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            浅入理解流式SSR的性能收益与工作原理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2370998127573751/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    明远湖之鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T04:51:36.000Z" title="Sun Nov 23 2025 04:51:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">什么是流式 SSR</h2>
<p>流式 SSR（Streaming Server-Side Rendering）是一种将服务端渲染和流式传输结合起来的技术。与传统的 SSR 不同，流式 SSR 可以在服务端渲染的同时，逐步将渲染结果传输到客户端，实现页面的渐进式展示。</p>
<p>在流式 SSR 中，服务端会根据客户端的请求，逐步生成页面内容，并将它们作为流式数据流式传输到客户端。客户端可以在接收到一部分数据后，就开始逐步显示页面，而不需要等待整个页面渲染完成。这种方式可以有效提高页面的加载速度和用户体验。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c8d597f865b43c79abefb42c03ca09c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piO6L-c5rmW5LmL6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764478296&amp;x-signature=7%2BPppr%2BKU2I0Z%2BX22ELwntltuHU%3D" alt="20251111002406.jpg" loading="lazy"/>
(流式 SSR 的页面加载过程）</p>
<h2 data-id="heading-1">使用流式 SSR 的收益</h2>
<ul>
<li>
<p><strong>减少设备和网络情况的副作用</strong></p>
<p>这是 SSR 渲染模式相比于传统  CSR 渲染模式带来的优势，对于流式 SSR 应用同样适用。
CSR 渲染模式需要在终端设备上完成资源加载、数据加载以及整个渲染过程，受端侧设备自身 CPU 及网络性能影响大，如设备 CPU 性能不足或网络波动较大，则此时整个页面加载性能将严重下降，这也是为什么很多页面在高端设备上加载速度较快，但在低端设备上需要7-8秒的原因。</p>
<p>而 SSR 的渲染模式，则<strong>在服务端提供了高性能的渲染容器及网络环境，服务端的渲染，不受端侧设备 CPU 或网络影响，始终提供稳定的渲染性能表现</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba73baf6b12b44a0b7b6055b1c45b7fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piO6L-c5rmW5LmL6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764478296&amp;x-signature=vYH5fhaZmJ1rFH8%2FPW4m4SNzkW0%3D" alt="fa9a1944-b6b4-4e22-980a-47bf604c2e2c.png" loading="lazy"/></p>
</li>
<li>
<p><strong>减少接口过慢对首屏性能的影响</strong></p>
<p>通常，页面会由多个区块组成，其中一些区块不依赖于数据，而其他区块可能依赖于快速或缓慢响应的接口。</p>
<p>现有 SSR 渲染模式存在的一个不足是，整个渲染过程是同步的，需要在页面渲染之前完成所有数据请求，并一次性返回整个页面的 HTML。如果页面的某些接口响应过慢，将会导致整个页面的响应时间过长。</p>
<p>流式渲染的最大好处在于它可以分块返回页面内容。例如，当请求进入时，它可以首先完成页面静态内容的渲染并响应给端侧进行渲染，等待其他依赖于数据的区块完成渲染后再分块返回。这样整个页面的渲染过程不再绑定在一起，而是一个异步的过程，先完成渲染的部分将先返回，从而优化了页面响应速度。</p>
</li>
<li>
<p><strong>提前资源的加载时机</strong></p>
<p>流式 SSR 相比传统 SSR 应用有另一个额外的收益是，由于 HTML 可以分块返回，页面的资源信息可以随第一个 HTML 片段一起下发，从而尽快开始加载。相比之下，在传统 SSR 应用中，资源信息必须等待整个 HTML 完成渲染后下发，请求开始的时机会受到渲染过程的阻塞。</p>
<p>采用流式 SSR，可以使资源请求和页面渲染过程并行进行，进一步提升了页面的性能表现。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/262454a66ef1469789c973908bdfdf86~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piO6L-c5rmW5LmL6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764478296&amp;x-signature=pueQsCLST%2FVr2owHTM95M6HTlvU%3D" alt="752472f2-cf39-4c89-9738-e4ad3e084ba9.png" loading="lazy"/></p>
</li>
<li>
<p><strong>提升页面的可交互时间</strong></p>
<p>在 SSR 渲染模式下，将页面节点达到可交互状态的过程称为 Hydrate，它需要在端侧执行 JavaScript。</p>
<p>由于页面资源可以提前下发，并且 React 18 对 Hydrate 进行了异步化处理，在流式 SSR 应用中，可以进一步实现先渲染的页面先达到可交互状态的效果。对于部分首屏接口较慢的应用，这将进一步提升页面的可交互体验。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb6d50f24ad84d6397f6b472e57ce551~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piO6L-c5rmW5LmL6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764478296&amp;x-signature=sxEYVIj6yhciBVEKqwOPNJXnz1c%3D" alt="20251111002828.jpg" loading="lazy"/></p>
</li>
</ul>
<h2 data-id="heading-2">基本工作原理</h2>
<p>流式 SSR 的实现，最基本的原理是：</p>
<ul>
<li>基于 HTTP 协议中的 chunked 编码规范，设置响应头的 Transfer-Encoding 为 chunked 对 HTML 内容进行分块传输。</li>
<li>在浏览器侧，流式地读取数据并进行渲染，这是主流浏览器默认支持的。</li>
</ul>
<p>结合 Node.js 内置的 HTTP 模块，实现一个最简单的流式 DEMO 示例如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http'</span>);

<span class="hljs-keyword">const</span> server = http.<span class="hljs-title function_">createServer</span>(<span class="hljs-keyword">async</span> (req, res) =&gt; {
  res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'text/html'</span>);
  res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Transfer-Encoding'</span>, <span class="hljs-string">'chunked'</span>)

  <span class="hljs-comment">// 分区块的传输页面内容</span>
  res.<span class="hljs-title function_">write</span>(<span class="hljs-string">'&lt;html&gt;'</span>);
  res.<span class="hljs-title function_">write</span>(<span class="hljs-string">'&lt;head&gt;&lt;title&gt;Stream Demo&lt;/title&gt;&lt;head&gt;'</span>);
  res.<span class="hljs-title function_">write</span>(<span class="hljs-string">'&lt;body&gt;'</span>);

  <span class="hljs-comment">// 模拟服务端暂停</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">sleep</span>(<span class="hljs-number">3000</span>);
  res.<span class="hljs-title function_">write</span>(<span class="hljs-string">'&lt;h2&gt;Hello&lt;/h2&gt;'</span>);

  <span class="hljs-keyword">await</span> <span class="hljs-title function_">sleep</span>(<span class="hljs-number">3000</span>);
  res.<span class="hljs-title function_">write</span>(<span class="hljs-string">'&lt;h2&gt;ICE 3&lt;/h2&gt;'</span>);
  res.<span class="hljs-title function_">write</span>(<span class="hljs-string">'&lt;/body&gt;&lt;/html&gt;'</span>);
  res.<span class="hljs-title function_">end</span>();
});

server.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>);
</code></pre>
<p>基于这个基本原理，将页面分为骨架屏和几个区块，并行地渲染这些区块，然后将渲染好的区块分段返回，就可以实现基本的流式 SSR 。</p>
<h2 data-id="heading-3">WebView 接收流式Chunk渲染的实现原理（iOS）</h2>
<h3 data-id="heading-4">核心组件</h3>
<p>iOS WebView 接收流式 Chunk 渲染基于 <strong>NSURLProtocol 拦截机制</strong> + <strong>NSURLProtocolClient 回调机制</strong> 实现。</p>
<p><strong>NSURLProtocol（请求拦截器）</strong>：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 拦截 WebView 的网络请求</span>
+ (<span class="hljs-variable constant_">BOOL</span>)<span class="hljs-attr">canInitWithRequest</span>:(<span class="hljs-title class_">NSURLRequest</span> *)request {
    <span class="hljs-keyword">return</span> [self <span class="hljs-attr">shouldInterceptRequest</span>:request];
}

- (<span class="hljs-keyword">void</span>)startLoading {
    <span class="hljs-comment">// 转发给自定义处理器</span>
    [[<span class="hljs-title class_">SSRHandler</span> shareInstance] <span class="hljs-attr">sendRequest</span>:self.<span class="hljs-property">request</span> <span class="hljs-attr">delegate</span>:self];
}
</code></pre>
<p><strong>NSURLProtocolClient（数据传递桥梁）</strong>：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 系统提供的协议，用于向 WebView 传递数据</span>
@protocol <span class="hljs-title class_">NSURLProtocolClient</span>
- (<span class="hljs-keyword">void</span>)<span class="hljs-title class_">URLProtocol</span>:<span class="hljs-attr">didReceiveResponse</span>:<span class="hljs-attr">cacheStoragePolicy</span>:;  <span class="hljs-comment">// 响应头</span>
- (<span class="hljs-keyword">void</span>)<span class="hljs-title class_">URLProtocol</span>:<span class="hljs-attr">didLoadData</span>:;                           <span class="hljs-comment">// 数据块（可多次）</span>
- (<span class="hljs-keyword">void</span>)<span class="hljs-title class_">URLProtocolDidFinishLoading</span>:;                       <span class="hljs-comment">// 完成</span>
- (<span class="hljs-keyword">void</span>)<span class="hljs-title class_">URLProtocol</span>:<span class="hljs-attr">didFailWithError</span>:;                      <span class="hljs-comment">// 错误</span>
@end

</code></pre>
<h3 data-id="heading-5">渲染流程</h3>
<ul>
<li>
<p><strong>阶段一：请求拦截</strong></p>
<pre><code class="hljs language-objectivec" lang="objectivec">WebView 发起请求 → <span class="hljs-built_in">NSURLProtocol</span> 拦截 → 转发给 SSR 处理器
</code></pre>
</li>
<li>
<p><strong>阶段二：响应处理</strong></p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 1. 返回响应头</span>
[<span class="hljs-meta">client URLProtocol:protocol didReceiveResponse:response cacheStoragePolicy:policy</span>];

<span class="hljs-comment">// 2. 流式返回数据（关键步骤）</span>
[<span class="hljs-meta">client URLProtocol:protocol didLoadData:chunk1</span>];  <span class="hljs-comment">// 第1块</span>
[<span class="hljs-meta">client URLProtocol:protocol didLoadData:chunk2</span>];  <span class="hljs-comment">// 第2块</span>
[<span class="hljs-meta">client URLProtocol:protocol didLoadData:chunkN</span>];  <span class="hljs-comment">// 第N块</span>

<span class="hljs-comment">// 3. 标记完成</span>
[<span class="hljs-meta">client URLProtocolDidFinishLoading:protocol</span>];
</code></pre>
</li>
<li>
<p><strong>阶段三：WebView 渲染</strong></p>
<pre><code class="hljs language-css" lang="css">每次 didLoadData 调用 → WebView 增量解析 <span class="hljs-selector-tag">HTML</span> → 实时渲染到页面
</code></pre>
</li>
</ul>
<p><strong>数据流图示如下</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">┌─────────────┐    ┌──────────────┐    ┌─────────────┐
│   WebView   │───▶│NSURLProtocol │───▶│ SSR Handler │
│             │    │              │    │             │
│             │◀───│              │◀───│             │
└─────────────┘    └──────────────┘    └─────────────┘
       ▲                   │
       │                   ▼
   增量渲染          NSURLProtocolClient
       ▲                   │
       │                   ▼
   ┌─────────────────────────────┐
   │     didLoadData (chunk1)    │
   │     didLoadData (chunk2)    │
   │     didLoadData (chunkN)    │
   │  URLProtocolDidFinishLoading │
   └─────────────────────────────┘
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Gemini CLI上线插件系统]]></title>    <link>https://juejin.cn/post/7575090551357259828</link>    <guid>https://juejin.cn/post/7575090551357259828</guid>    <pubDate>2025-11-23T02:41:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575090551357259828" data-draft-id="7575065455075868707" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Gemini CLI上线插件系统"/> <meta itemprop="keywords" content="Gemini,AIGC"/> <meta itemprop="datePublished" content="2025-11-23T02:41:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小溪彼岸"/> <meta itemprop="url" content="https://juejin.cn/user/976781670357400"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Gemini CLI上线插件系统
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/976781670357400/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小溪彼岸
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T02:41:40.000Z" title="Sun Nov 23 2025 02:41:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>小伙伴们大家好，我是小溪，见字如面。在不久前Gemini CLI终于上线了插件系统，终于开始缓慢追赶Claude Code CLI的脚步了，至此我们也终于可以使用大佬们的插件，共享我们的插件了。</p>
<p>Gemini CLI更新日志：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgoogle-gemini%2Fgemini-cli%2Fblob%2Fmain%2Fdocs%2Fchangelogs%2Findex.md" target="_blank" title="https://github.com/google-gemini/gemini-cli/blob/main/docs/changelogs/index.md" ref="nofollow noopener noreferrer">github.com/google-gemi…</a></p>
<p>对往期内容感兴趣的小伙伴也可以看往期内容：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU5Njg3ODUzOA%3D%3D%26mid%3D2247492558%26idx%3D1%26sn%3De762047c93c4361f63744ec3c70a434f%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzU5Njg3ODUzOA==&amp;mid=2247492558&amp;idx=1&amp;sn=e762047c93c4361f63744ec3c70a434f&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">Google百万Token上下文Gemini CLI，离AI自由更近一步</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU5Njg3ODUzOA%3D%3D%26mid%3D2247493269%26idx%3D1%26sn%3D4775c90a4fab04126502bf79b0f75d70%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzU5Njg3ODUzOA==&amp;mid=2247493269&amp;idx=1&amp;sn=4775c90a4fab04126502bf79b0f75d70&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">Claude Code上线插件系统，AI编程模式再次升级</a></li>
</ul>
<h2 data-id="heading-1">当前使用版本</h2>
<p>Gemini CLI：0.13.0</p>
<h2 data-id="heading-2">优势</h2>
<ul>
<li>插件系统目前支持打包 MCP、上下文文件 和 自定义命令 3种配置</li>
</ul>
<h2 data-id="heading-3">Gemini CLI Extension简介</h2>
<p>Gemini CLI围绕Extension扩展构建了插件系统，它可以将 MCP服务、上下文文件 以及 自定义命令 打包成一个简单软件包，当软件包被安装到 Gemini CLI 中就可以让 Gemini 使用各种工具。Gemini CLI Extension目前已有100多款插件，包含 Context7、Nano Banana等爆火的插件。</p>
<p>Gemini CLI Extension官方地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgeminicli.com%2Fextensions%2F" target="_blank" title="https://geminicli.com/extensions/" ref="nofollow noopener noreferrer">geminicli.com/extensions/</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d246f5ba07de4ac6ae1cb97fd12302ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=rurl4xfGTOtgfKS8rkUN8kMiTdM%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-4">基本使用</h2>
<h3 data-id="heading-5">CLI命令</h3>
<p>Gemini CLI命令行工提供了一系列extension的管理命令，在命令行直接输入 gemini extensions -h 可以查看extensions所有命令</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c8671fbd4474b21b5f510f1ff54cb16~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=wjTFEFwu8IscF30U8Rtx1zAfjM8%3D" alt="图片" loading="lazy"/></p>
<ul>
<li>install：从Git仓库或者本地路径安装插件</li>
<li>uninstall：卸载指定名称的插件</li>
<li>list：查看当前安装的插件</li>
<li>update：更新所有或者指定插件</li>
<li>disable：禁用插件</li>
<li>enable：启用插件</li>
<li>link：从本地路径链接一个插件</li>
<li>new：从模板创建一个插件</li>
<li>validate：从本地路径验证一个插件</li>
</ul>
<h3 data-id="heading-6">安装插件</h3>
<p>在Gemini CLI Extension平台查找自己需要的插件，这里我以 Nano Banana 为例</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5f4ff65187c4d16b746f0d970e2eba4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=lPmT7v9IHEJoko%2FpCRouaJjH5gQ%3D" alt="图片" loading="lazy"/></p>
<p>点击查看详情，复制Extension安装命令</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5972dbc44b16490e889588c1a869dabc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=MoDU%2FpbNxC6ZJRybpyM6Sm1FWoI%3D" alt="图片" loading="lazy"/></p>
<p>完整命令如下：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$ gemini</span> extensions install https:<span class="hljs-comment">//github.com/gemini-cli-extensions/nanobanana</span>
</code></pre>
<p>在命令行终端执行安装命令，遇到权限问题，根据提示选择允许</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/905cd9c1e8b1459ba0f882b8dda1a16b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=GebYB7JGEyYVTzDRzt1qEi5e3L4%3D" alt="图片" loading="lazy"/></p>
<p>详细信息可以在 ~/.gemini/extensions中查看</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87038fd5b39c4105ae172044022fdf64~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=o6rluLofC2vPr7Wfo4hzxNm5Pho%3D" alt="图片" loading="lazy"/></p>
<p>启动Gemini CLI，在交互式命令中输入以下命令查看以已安装的插件</p>
<pre><code class="hljs language-bash" lang="bash">/extensions list
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5cf27479daaa46f88018cffd5a9e2cb9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=odWIO1OWHRiknlA0x50UUDBtia4%3D" alt="图片" loading="lazy"/></p>
<p>然后在Gemini CLI中就可以查看 Nano Banana 提供的MCP和自定义命令了</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e7a14fb2341471fa7cf0b5b0b7c0b2a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=LVI2fe2dA3dtTAHuL7tq3QJsMkk%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb889d18a5934b1281f07d40670953fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=tabr69hUeKitMWbmXa7%2BUxy63ec%3D" alt="图片" loading="lazy"/></p>
<p>Nano Banana指令：</p>
<ul>
<li>/generate：单张或多张带有风格 / 变体选项的图像生成</li>
<li>/edit：图像编辑</li>
<li>/restore：图像修复</li>
<li>/icon：生成多种尺寸的应用图标、网站图标和 UI 元素</li>
<li>/pattern：生成用于背景的无缝图案和纹理</li>
<li>/story：生成讲述视觉故事或流程的连续图像</li>
<li>/diagram：生成技术图表、流程图和建筑模型图</li>
<li>/nanobanana：使用自然语言生成或处理图片</li>
</ul>
<h3 data-id="heading-7">插件使用</h3>
<p>以 Nano Banana 为例，我们可以使用模型推理自行调用</p>
<pre><code class="hljs language-bash" lang="bash">我正在创办一家名为 “Kicks” 的鞋业公司，你能帮我设计一个视觉上有吸引力的icon/logo
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/740117f8bf4b4cfa825b7aa7c122253c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=u36Q0WwdmXixT8KtjuhNHZ6WkSo%3D" alt="图片" loading="lazy"/></p>
<p>也可以使用 Nano Banana 提供的MCP和自定义命令调用，Nano Banana 调用目前不报错，可以不用理会</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d759aaf4066474eaea35aeb5d5ee567~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=BLzS%2BZoRniXFwbdt6PPgPi2P5mQ%3D" alt="图片" loading="lazy"/></p>
<p>再以 Chrome Devtools MCP为例，输入命令进行安装</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">$</span><span class="bash"> gemini extensions install https://github.com/ChromeDevTools/chrome-devtools-mcp</span>
</code></pre>
<p>安装完成后重启Gemini CLI，在交互式命令中输入 /mcp，可以看到刚刚通过插件安装的 chrome-devtools MCP服务</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/19c7dab6f8534a478ac64b4321ba76f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=RApYmPpN1KZyagMS%2Bng%2BZ2iijVg%3D" alt="图片" loading="lazy"/></p>
<p>输入提示词即可使用</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6687296803e74c54be20db4dacd23c75~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=21O9FZQnT2tUBzIye1onoa4Tssw%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-8">管理插件</h3>
<p>Gemini CLI提供了 交互命令 和 CLI命令 2种管理插件的方式</p>
<h4 data-id="heading-9">1）交互命令</h4>
<p>在交互式命令中输入 /extensions 可以查看插件系统提供的管理命令</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1af79fa5790b4d70bbf4b96f1a08d612~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=iibIBKL6wV%2B%2BAt1oqlimly0R2lE%3D" alt="图片" loading="lazy"/></p>
<ul>
<li>list：列出活跃的扩展程序</li>
<li>update：更新扩展程序</li>
<li>explore：在浏览器中打开扩展程序页面</li>
</ul>
<p>使用 /extensions list 可以查看所有安装的插件</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/91bbbc1c7b794764a530ffc9aeec6f54~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=ljLzjDqT0jb1UZKBPXeLfZtFOTI%3D" alt="图片" loading="lazy"/></p>
<p>使用 /extensions update 可以更新所有插件或者更新指定插件</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87b6b777b9e24ace8e971644cd41121a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=LfEyanJJyMW2gLLHRiHFAKPQ%2B8c%3D" alt="图片" loading="lazy"/></p>
<p>使用 /extensions explore 会打开Gemini CLI Extensions官网。</p>
<h3 data-id="heading-10">2）CLI命令</h3>
<p>使用 gemini extensions list 可以查看详细的插件信息，包括 插件路径、来源、版本、启用禁用状态、提供的功能 等信息</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/514266ca58da45a6b947519aec07ead1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=YBxeQ5xV0JT1egSkNPECy6X0eIE%3D" alt="图片" loading="lazy"/></p>
<p>使用 gemini extensions uninstall 可卸载插件</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$ gemini</span> extensions uninstall nanobanana
</code></pre>
<p>使用 gemini extensions update 可更新插件</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment"># 更新指定插件</span>
<span class="hljs-variable">$ gemini</span> extensions update nanobanana
<span class="hljs-comment"># 更新所有插件</span>
<span class="hljs-variable">$ gemini</span> extensions update --all
</code></pre>
<p>使用 gemini extensions enable|disable 可启用禁用插件，本人尝试的不起作用</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">#</span><span class="bash"> 禁用插件</span>
<span class="hljs-meta prompt_">$</span><span class="bash"> gemini extensions <span class="hljs-built_in">disable</span> nanobanana</span>
<span class="hljs-meta prompt_">#</span><span class="bash"> 全局禁用插件</span>
<span class="hljs-meta prompt_">$</span><span class="bash"> gemini extensions <span class="hljs-built_in">disable</span> --scope user nanobanana</span>
<span class="hljs-meta prompt_">#</span><span class="bash"> 项目禁用插件</span>
<span class="hljs-meta prompt_">$</span><span class="bash"> gemini extensions <span class="hljs-built_in">disable</span> --scope project nanobanana</span>
</code></pre>
<h2 data-id="heading-11">自定义插件</h2>
<h3 data-id="heading-12">创建插件模板</h3>
<p>Gemini CLI提供了创建插件命令，命令格式如下：</p>
<pre><code class="hljs language-arduino" lang="arduino">$ gemini extensions <span class="hljs-keyword">new</span> [<span class="hljs-keyword">template</span>]
</code></pre>
<ul>
<li>path：插件的路径</li>
<li>template：模版类型，可选值："context"、"custom-commands"、"exclude-tools"、"mcp-server"</li>
</ul>
<p>接着创建我们的第一个自定义插件项目，我这里在工作区路径，直接在当前工作区项目同级目录创建自定义插件项目了</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$ gemini</span> extensions <span class="hljs-keyword">new</span> ../my-first-extension mcp-server
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cefbdf0ba1aa496dbad83f39f88f569d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=dI0W7bzN3LeenPVoR%2BGmvtAm7vQ%3D" alt="图片" loading="lazy"/></p>
<p>创建完成后，可以看到目录结构如下，其实就是创建了一个带有Gemini CLI插件配置文件 gemini-extension.json 的NodeJS项目</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be4d5645477d42f998715308d68ab548~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=CfUE0cr2MObtcAipQwvJcK4nkR0%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/84ed6cf7f1b4427093799d44774f6133~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=C8vYqULFohS3s3qImQtsfefjguU%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-13">插件配置文件</h3>
<p>Gemini CLI自定义插件配置文件为 gemini-extension.json，一个完整的自定义插件配置如下：</p>
<pre><code class="hljs language-bash" lang="bash">{
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"&lt;插件名称&gt;"</span>,
  <span class="hljs-string">"version"</span>: <span class="hljs-string">"&lt;插件版本&gt;"</span>,
  <span class="hljs-string">"contextFileName"</span>: <span class="hljs-string">"&lt;上下文文件&gt;"</span>,
  <span class="hljs-string">"excludeTools"</span>: [<span class="hljs-string">"run_shell_command"</span>]
  <span class="hljs-string">"mcpServers"</span>: { <span class="hljs-comment"># MCP配置</span>
    <span class="hljs-string">"nodeServer"</span>: {
      <span class="hljs-string">"command"</span>: <span class="hljs-string">"node"</span>,
      <span class="hljs-string">"args"</span>: [<span class="hljs-string">"<span class="hljs-variable">${extensionPath}</span><span class="hljs-variable">${/}</span>dist<span class="hljs-variable">${/}</span>example.js"</span>],
      <span class="hljs-string">"cwd"</span>: <span class="hljs-string">"<span class="hljs-variable">${extensionPath}</span>"</span>
    }
  }
}
</code></pre>
<ul>
<li>name ：扩展程序的名称</li>
<li>version ：扩展程序的版本</li>
<li>mcpServers ：MCP 服务配置，如果扩展程序和 settings.json 文件都配置了同名的MCP服务器，则 settings.json 文件中定义的服务器优先
<ul>
<li>command：脚本运行的核心命令</li>
<li>args：脚本运行的参数数组</li>
<li>cwd：脚本运行时的工作目录</li>
</ul>
</li>
<li>contextFileName ：包含扩展上下文的文件的名称</li>
<li>excludeTools ：要从模型中排除的工具名称数组，例如： "excludeTools": ["run_shell_command(rm -rf)"] 将阻止 rm -rf 命令</li>
</ul>
<h3 data-id="heading-14">自定义MCP服务</h3>
<p>上面 mcp-server 命令创建的模板已经自带了一个MCP服务示例，示例代码如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">McpServer</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@modelcontextprotocol/sdk/server/mcp.js'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">StdioServerTransport</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@modelcontextprotocol/sdk/server/stdio.js'</span>;
<span class="hljs-keyword">import</span> { z } <span class="hljs-keyword">from</span> <span class="hljs-string">'zod'</span>;
<span class="hljs-keyword">const</span> server = <span class="hljs-keyword">new</span> <span class="hljs-title class_">McpServer</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'prompt-server'</span>,
  <span class="hljs-attr">version</span>: <span class="hljs-string">'1.0.0'</span>,
});
server.<span class="hljs-title function_">registerTool</span>(
  <span class="hljs-string">'fetch_posts'</span>,
  {
    <span class="hljs-attr">description</span>: <span class="hljs-string">'Fetches a list of posts from a public API.'</span>,
    <span class="hljs-attr">inputSchema</span>: z.<span class="hljs-title function_">object</span>({}).<span class="hljs-property">shape</span>,
  },
  <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">const</span> apiResponse = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(
      <span class="hljs-string">'https://jsonplaceholder.typicode.com/posts'</span>,
    );
    <span class="hljs-keyword">const</span> posts = <span class="hljs-keyword">await</span> apiResponse.<span class="hljs-title function_">json</span>();
    <span class="hljs-keyword">const</span> response = { <span class="hljs-attr">posts</span>: posts.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>) };
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">content</span>: [
        {
          <span class="hljs-attr">type</span>: <span class="hljs-string">'text'</span>,
          <span class="hljs-attr">text</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(response),
        },
      ],
    };
  },
);
server.<span class="hljs-title function_">registerPrompt</span>(
  <span class="hljs-string">'poem-writer'</span>,
  {
    <span class="hljs-attr">title</span>: <span class="hljs-string">'Poem Writer'</span>,
    <span class="hljs-attr">description</span>: <span class="hljs-string">'Write a nice haiku'</span>,
    <span class="hljs-attr">argsSchema</span>: { <span class="hljs-attr">title</span>: z.<span class="hljs-title function_">string</span>(), <span class="hljs-attr">mood</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">optional</span>() },
  },
  <span class="hljs-function">(<span class="hljs-params">{ title, mood }</span>) =&gt;</span> ({
    <span class="hljs-attr">messages</span>: [
      {
        <span class="hljs-attr">role</span>: <span class="hljs-string">'user'</span>,
        <span class="hljs-attr">content</span>: {
          <span class="hljs-attr">type</span>: <span class="hljs-string">'text'</span>,
          <span class="hljs-attr">text</span>: <span class="hljs-string">`Write a haiku<span class="hljs-subst">${mood ? <span class="hljs-string">` with the mood <span class="hljs-subst">${mood}</span>`</span> : <span class="hljs-string">''</span>}</span> called <span class="hljs-subst">${title}</span>. Note that a haiku is 5 syllables followed by 7 syllables followed by 5 syllables `</span>,
        },
      },
    ],
  }),
);
<span class="hljs-keyword">const</span> transport = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StdioServerTransport</span>();
<span class="hljs-keyword">await</span> server.<span class="hljs-title function_">connect</span>(transport);
</code></pre>
<p>修改 package.json 配置文件，添加MCP调试代码配置</p>
<pre><code class="hljs language-perl" lang="perl">{
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"mcp-server-example"</span>,
  <span class="hljs-string">"version"</span>: <span class="hljs-string">"1.0.0"</span>,
  <span class="hljs-string">"description"</span>: <span class="hljs-string">"Example MCP Server for Gemini CLI Extension"</span>,
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"module"</span>,
  <span class="hljs-string">"main"</span>: <span class="hljs-string">"example.js"</span>,
  <span class="hljs-string">"scripts"</span>: {
    <span class="hljs-string">"dev"</span>: <span class="hljs-string">"npx -y @modelcontextprotocol/inspector node dist/example.js"</span>,
    <span class="hljs-string">"build"</span>: <span class="hljs-string">"tsc"</span>
  },
  <span class="hljs-string">"devDependencies"</span>: {
    <span class="hljs-string">"typescript"</span>: <span class="hljs-string">"~5.4.5"</span>,
    <span class="hljs-string">"@types/node"</span>: <span class="hljs-string">"^20.11.25"</span>
  },
  <span class="hljs-string">"dependencies"</span>: {
    <span class="hljs-string">"@modelcontextprotocol/sdk"</span>: <span class="hljs-string">"^1.11.0"</span>,
    <span class="hljs-string">"zod"</span>: <span class="hljs-string">"^3.22.4"</span>
  }
}
</code></pre>
<p>执行 npm run build 编译TS，然后执行下面命令启动MCP调试服务</p>
<pre><code class="hljs language-arduino" lang="arduino">$ npm run dev
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e8bfb779192143e3a53e0ede25e654db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=eLcugDuILB8Y1M1Wf07Eue1WVAo%3D" alt="图片" loading="lazy"/></p>
<p>服务启动完成，点击调试服务链接在浏览器中打开</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4fc42ecabc24db8bac3d52386c1f55f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=Wr%2FEl9iuACv%2FnlxZaGkIUUBRrPE%3D" alt="图片" loading="lazy"/></p>
<p>点击【Connect】连接本地MCP服务</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/84b8b78995644813b621502714c152bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=26u8KzKqtxi%2BpuAerAJwxJ58564%3D" alt="图片" loading="lazy"/></p>
<p>选择【Tools】测试一下MCP服务是否正常</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3b5bb12989f44ee8a329b4cee3077c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=HZ87nWfPuf7JIO9C7RMPJxtDbKg%3D" alt="图片" loading="lazy"/></p>
<p>无误后，使用 gemini extensions validate 验证一下插件的有效性</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">$</span><span class="bash"> gemini extensions validate ../my-first-extension</span> 
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9fcedd53d9c74ea6a67d00ee78cb5ebe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=IqC72CEPBTE%2ByVjrsN3vLUjwFVE%3D" alt="图片" loading="lazy"/></p>
<p>验证成功后即可使用 gemini extensions install 安装，也可以使用 gemini extensions link 进行符号链接（符号链接的好处就是任何更改都会立即生效，无需重新安装），我这里使用 gemini extensions link 演示</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">$</span><span class="bash"> gemini extensions <span class="hljs-built_in">link</span> ../my-first-extension</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05fbe5d6728e4c2c8fc29f0ade71b905~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=VdFBTmiR6zYPJzYbYWRvYzjlC3g%3D" alt="图片" loading="lazy"/></p>
<p>安装或者链接成功后，就可以使用 gemini extensions list 查看到我们自定义的插件了</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4fd5c047a42440b790db067598dbdc6c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=yaWk3ZCVC1QwBk0ZaXwBSw4B%2BIY%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-15">自定义上下文</h3>
<p>在自定义插件目录新建一个 GEMINI.md 目录用于存放自定义上下文内容</p>
<pre><code class="hljs language-sql" lang="sql"># My <span class="hljs-keyword">First</span> Extension Instructions
You <span class="hljs-keyword">are</span> an expert developer assistant. <span class="hljs-keyword">When</span> the <span class="hljs-keyword">user</span> asks you <span class="hljs-keyword">to</span> <span class="hljs-keyword">fetch</span>
posts, use the `fetch_posts` tool. Be concise <span class="hljs-keyword">in</span> your responses.
</code></pre>
<p>配置完成后，更新 gemini-extension.json 文件，指定 contextFileName 属性</p>
<pre><code class="hljs language-bash" lang="bash">{
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"mcp-server-example"</span>,
  <span class="hljs-string">"version"</span>: <span class="hljs-string">"1.0.0"</span>,
  <span class="hljs-string">"mcpServers"</span>: {
    <span class="hljs-string">"nodeServer"</span>: {
      <span class="hljs-string">"command"</span>: <span class="hljs-string">"node"</span>,
      <span class="hljs-string">"args"</span>: [<span class="hljs-string">"<span class="hljs-variable">${extensionPath}</span><span class="hljs-variable">${/}</span>dist<span class="hljs-variable">${/}</span>example.js"</span>],
      <span class="hljs-string">"cwd"</span>: <span class="hljs-string">"<span class="hljs-variable">${extensionPath}</span>"</span>
    }
  },
  <span class="hljs-string">"contextFileName"</span>: <span class="hljs-string">"GEMINI.md"</span>
}
</code></pre>
<p>使用 gemini extensions list 可以看到刚刚添加的上下文信息</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/989dbf3af30e48658289cb9d6635a1ff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=H7OX6EWlJ%2FWuWpn48Euec%2FXaLK4%3D" alt="图片" loading="lazy"/></p>
<p>启动Gemini CLI，在交互式命令中输入 /memory show 可以查看具体的上下文内容，此时已经包含了自定义插件中的上下文了</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e232a1afa7c43099a851609e39b3680~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=r7IN4dHTtHySeGKv%2FbVBqAR%2B0ps%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-16">自定义命令</h3>
<p>在自定义插件目录新建一个 commands目录用于存放自定义命令，自定义命令文档可以查看官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgeminicli.com%2Fdocs%2Fcli%2Fcustom-commands%2F" target="_blank" title="https://geminicli.com/docs/cli/custom-commands/" ref="nofollow noopener noreferrer">geminicli.com/docs/cli/cu…</a></p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">$</span><span class="bash"> <span class="hljs-built_in">mkdir</span> commands</span>
</code></pre>
<p>创建一个 hello.toml 文件用于第一个自定义命令，并配置命令</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">prompt</span> = <span class="hljs-string">"输出礼貌问候语并以`*_*`开始"</span>
</code></pre>
<p>再创建一个 fs 子命令目录，创建一个 grep-code.toml 文件</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">$</span><span class="bash"> <span class="hljs-built_in">mkdir</span> fs</span>
<span class="hljs-meta prompt_">$</span><span class="bash"> <span class="hljs-built_in">touch</span> fs/grep-code.toml</span>
</code></pre>
<p>输入提示词保存</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">prompt</span> = <span class="hljs-string">"""
Please summarize the findings for the pattern `{{args}}`.
Search Results:
!{grep -r {{args}} .}
"""</span>
</code></pre>
<p>目录结构如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de56e5d05b094e559fd0860525d72a30~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=t%2BYnRwxJ0EGIyfI0TFvIll1qoTQ%3D" alt="图片" loading="lazy"/></p>
<p>重启Gemini CLI，在交互式命令中输入 / 在命令列表看到自定义的命令</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7226eb98111646a984318676230c2a10~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=qjwQFJAgbvr%2Bax%2FzAg0G32XyLRU%3D" alt="图片" loading="lazy"/></p>
<p>直接调用自定义命令即可执行</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a9d17ed400dc4f6b9ddfc50f88e61c76~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=Qu3rcr7yyuRKrBUo%2B6VRvIu%2FnpU%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-17">常见问题</h2>
<h3 data-id="heading-18">MCP授权失败</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15369c7ac7f24f50b0f94e424a5dc76a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=lZrISKLZvZrQcXdUfhqkFQ2QCkw%3D" alt="图片" loading="lazy"/></p>
<p>根据提示可知，调用 Nano Banana MCP 需要导出API Key，Github上也有对应的描述</p>
<p>Nano Banana Github地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgemini-cli-extensions%2Fnanobanana" target="_blank" title="https://github.com/gemini-cli-extensions/nanobanana" ref="nofollow noopener noreferrer">github.com/gemini-cli-…</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d162f09c850e4fb5b948a8c741e0f55e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=C0UwU2kFApwxnZb51WgOBcXVF90%3D" alt="图片" loading="lazy"/></p>
<p>我使用的是Gemini API Key，在命令行终端导出 GEMINI_API_KEY</p>
<pre><code class="hljs language-ini" lang="ini">export <span class="hljs-attr">GEMINI_API_KEY</span>=your api key
</code></pre>
<h3 data-id="heading-19">MCP调用失败</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/762b851b4f9f4f2ba6047a3b0cc7dd41~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764470500&amp;x-signature=uv%2BgkmOqSvfk5F096neBRyj%2B08c%3D" alt="图片" loading="lazy"/></p>
<p>Nano Banana调用尚有问题，Github Issue：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgemini-cli-extensions%2Fnanobanana%2Fissues%2F18" target="_blank" title="https://github.com/gemini-cli-extensions/nanobanana/issues/18" ref="nofollow noopener noreferrer">github.com/gemini-cli-…</a></p>
<h2 data-id="heading-20">友情提示</h2>
<p>见原文：<a href="https://link.juejin.cn?target=https%253A%2F%2Fmp.weixin.qq.com%2Fs%2FQZb3T5ogImCFAEX8oi4xLw" target="_blank" title="https%3A//mp.weixin.qq.com/s/QZb3T5ogImCFAEX8oi4xLw" ref="nofollow noopener noreferrer">Gemini CLI上线插件系统</a></p>
<blockquote>
<p>本文同步自微信公众号 "<a href="https://link.juejin.cn?target=https%253A%2F%2Fmp.weixin.qq.com%2Fs%2FQZb3T5ogImCFAEX8oi4xLw" target="_blank" title="https%3A//mp.weixin.qq.com/s/QZb3T5ogImCFAEX8oi4xLw" ref="nofollow noopener noreferrer">程序员小溪</a>" ，这里只是同步，想看及时消息请移步我的公众号，不定时更新我的学习经验。友情提示友情提示</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[URL解码踩坑记录]]></title>    <link>https://juejin.cn/post/7575897635137503232</link>    <guid>https://juejin.cn/post/7575897635137503232</guid>    <pubDate>2025-11-24T10:26:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575897635137503232" data-draft-id="7576086446459781155" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="URL解码踩坑记录"/> <meta itemprop="keywords" content="后端,前端"/> <meta itemprop="datePublished" content="2025-11-24T10:26:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Oriental"/> <meta itemprop="url" content="https://juejin.cn/user/2711816846968536"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            URL解码踩坑记录
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2711816846968536/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Oriental
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T10:26:25.000Z" title="Mon Nov 24 2025 10:26:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>引言</strong></p>
</blockquote>
<p>最近有在对接OAuth相关的工作，今天新写了一个接口用于请求回调地址，但一直显示有问题，于是就有了今天这篇文章</p>
<h5 data-id="heading-0">问题起因</h5>
<p>在访问后端接口时，发现返回的一直是 <code>500</code>，返回的data数据为 <code>null</code>，无法正常返回 <code>LinkUrl(跳转地址)</code></p>
<h5 data-id="heading-1">解决思路</h5>
<p><strong>接口验证</strong>
首先拿上接口的调用参数进行接口的请求验证，我的接口提供（重点就在这）</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">type:</span> <span class="hljs-keyword">GET</span>
<span class="hljs-symbol">param:</span> authUrl
<span class="hljs-symbol">return:</span> 
{
	code: int,
	data: <span class="hljs-type">string</span>,
	msg: <span class="hljs-type">string</span>
}
</code></pre>
<p>于是我开始了漫长的 <code>url</code>比对，发现 <code>url</code>确实存在出入，于是告诉前端同学对 <code>url</code>进行变更，但依旧是没有解决问题</p>
<p><strong>本地测试</strong>
我开始拿着参数对本地的接口开启测试，使用 <code>ApiFox</code>进行测试，发现可以正常调用，且返回了对应的 <code>LinkUrl</code>，我的代码逻辑是获取到前端提供的 <code>authUrl</code>然后去请求第三方的平台获取到 <code>LinkUrl</code>，于是我又比对了我本地和 <code>dev</code>环境的代码差异，发现代码依旧是一致，前端同学是直接调用的 <code>dev</code>的后端代码，于是我想是不是对我们设置的回调地址做了限制，因为我们之前是做了备案的，于是将前端同学代码发布至 <code>dev</code>环境后测试发现依旧行不通</p>
<p><strong>日志观察</strong>
这个时候只能去看一下日志的情况是什么样子，因为我本地根本复现不出调用异常情况，发现日志中有这么一段</p>
<pre><code class="hljs language-vbscript" lang="vbscript"><span class="hljs-number">400</span> Bad <span class="hljs-built_in">Request</span> <span class="hljs-keyword">on</span> <span class="hljs-keyword">GET</span> <span class="hljs-built_in">request</span> <span class="hljs-keyword">for</span> XXXX(地址)
redirectURI must be a URL address
</code></pre>
<p>直到现在我依旧认为我的地址出现了问题，所以很长时间陷入对重定向的地址的问题排查</p>
<p><strong>地址比对</strong>
很长时间没有结果后，我依旧想着可不可以在本地去复现这个问题，于是我拿着 <code>dev</code>环境的请求参数去请求我本地，终于让我复现出来了， 接下来就是分析我请求成功和不成功的传参。</p>
<p>刚开始依旧认为传参是一致，还不停的去找地址中是不是有什么区别，后来终于让我发现了问题，两个不同的 <code>url</code>地址下</p>
<pre><code class="hljs language-bash" lang="bash">(可以正常请求)
curl <span class="hljs-string">'https://my.test.com/auth?authUrl=https//authentication.com?redirectURI=https%3a%2f%2fmy.test.com%2fcallback&amp;source=PC_Browser&amp;lang=zh-HK&amp;brokerpage=xxxx'</span>

(不可以正常请求)
curl <span class="hljs-string">'https://my.test.com/auth?authUrl=https%2f%2fauthentication.com%3fredirectURI%3dhttps%253a%252f%252fmy.test.com%252fcallback%26source%3dPC_Browser%26lang%3dzh-HK%26brokerpage%3dxxxx'</span>
</code></pre>
<p><strong>真相</strong>
下面这个不可以正常请求的 <code>url编码</code>了两次，总所周知 <code>Tomcat</code>的 <code>Servlet</code>会对正常的 <code>Http</code>进行 <code>url编码</code>，但下面的这个错误的传参 <code>url编码</code>了两次，所以导致后端在使用 <code>RestTemplate</code>进行请求的时候发生了上述报错，导致没有办法正常请求。</p>
<p>至于我为什么这么简单的问题没有发现，有各种因素，包括前端给我的 <code>param</code>也都是解码之后的，所以我刚开始一直测试没有问题，知道后来对比才发现问题</p>
<blockquote>
<p>结语</p>
</blockquote>
<p>其实代码问题的排查也比较简单，就是一个细心成都，如果我能早一点直接拿着控制台中 <code>netWork</code>进行直接对比，不要相信任何开发人员的一面之词。自己给自己算是下约定了，以后再也不会用 <code>Get</code>方式进行地址的传参，确实有很多的坑</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[120行代码，实现丝滑滚动的时间轴组件]]></title>    <link>https://juejin.cn/post/7576108254603919403</link>    <guid>https://juejin.cn/post/7576108254603919403</guid>    <pubDate>2025-11-24T10:30:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576108254603919403" data-draft-id="7574382900860534811" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="120行代码，实现丝滑滚动的时间轴组件"/> <meta itemprop="keywords" content="Trae"/> <meta itemprop="datePublished" content="2025-11-24T10:30:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="你不会困"/> <meta itemprop="url" content="https://juejin.cn/user/3664010809185870"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            120行代码，实现丝滑滚动的时间轴组件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3664010809185870/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    你不会困
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T10:30:23.000Z" title="Mon Nov 24 2025 10:30:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>产品又看见一个非常高级的时间轴页面交互（对于前端来说，实现不难，主要是花时间），我们尝试一下让Trae 的solo来实现，最简洁的代码实现，尽可能的描述一下细节，这样才可以最准确的实现，少走弯路，不浪费我们宝贵的时间（有这时间多看几篇技术文章，不香？啊哈哈哈）</p>
<p>首先先搭建好一个项目，这里使用的是vite+vue3+ts，然后是对应的安装tailwind css，这些都是让Trae solo模式帮我们搭建一下，我们就不用从0搭建了</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca500463503a40f9b58e50368ac65ee8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L2g5LiN5Lya5Zuw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764585023&amp;x-signature=3vIINtvCM3wuZXyw3V1c12S5f5A%3D" alt="image-20251120152839739" loading="lazy"/></p>
<p>先来看看最终的效果实现，你很难相信这是一次对话就实现的</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78cffe10028c4997a0eec286fa17e72d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L2g5LiN5Lya5Zuw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764585023&amp;x-signature=8SzC7f0fRhmMf2MauAsJ1mmg6Lw%3D" alt="image.png" loading="lazy"/>
一.首先是描述细节</p>
<p>1.时间轴的中间是可以滚动的，然后要根据鼠标进行滚动，不要滚动条</p>
<p>2.奇数是在上面，时间轴的连接线比较长，偶数是在下面，连接线比较短</p>
<p>3.箭头在右下角固定，保证用户知道这个是时间轴</p>
<p>4.卡片最大宽度是240px，超出隐藏</p>
<p>5.线和卡片中间使用倒三角连接起来</p>
<p>附加上一张ui设计的截图，就可以开始提问了</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ecda26416c641e296b8ca331961f328~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L2g5LiN5Lya5Zuw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764585023&amp;x-signature=zXJVEYTDh9eWwH7hq9o0dOj5NYw%3D" alt="image.png" loading="lazy"/></p>
<p>等待了一会，就实现了</p>
<p>来看看代码，119行就实现了，看起来确实优雅，解读一下代码trae solo是如何实现这个组件的</p>
<p>1.卡片（奇偶项交错，下移以视觉区分）,使用tailwind的<code>mt-[210px]</code>,</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>
          <span class="hljs-attr">class</span>=<span class="hljs-string">"relative max-w-[230px] overflow-hidden rounded-lg bg-[#1D2129] shadow-lg"</span>
          <span class="hljs-attr">:class</span>=<span class="hljs-string">"i % 2 !== 0 ? 'mt-[210px]' : ''"</span>
        &gt;</span>
          <span class="hljs-comment">&lt;!-- 卡片头部：深色背景 --&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"flex items-center justify-between px-3 py-2"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-sm font-medium text-white"</span>&gt;</span>共7条<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"cursor-pointer text-xs text-white"</span>&gt;</span>全部&gt;<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
​
          <span class="hljs-comment">&lt;!-- 卡片内容：两张图片并排 --&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"flex gap-2 overflow-hidden p-3"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"relative shrink-0 overflow-hidden rounded"</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">:src</span>=<span class="hljs-string">"item.image"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"aspect-video h-[150px] w-[89px] object-cover"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"relative shrink-0 overflow-hidden rounded"</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">:src</span>=<span class="hljs-string">"item.image"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"aspect-video h-[150px] w-[89px] object-cover"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"relative shrink-0 overflow-hidden rounded"</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">:src</span>=<span class="hljs-string">"item.image"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"aspect-video h-[150px] w-[89px] object-cover"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>2.底部小三角形指示器,有没有勾起你当时学前端的回忆，那道经典的面试题的，你是怎么实现一个三角形的</p>
<pre><code class="hljs language-css" lang="css">&lt;<span class="hljs-selector-tag">div</span> class="<span class="hljs-attribute">border</span>-x-<span class="hljs-selector-attr">[12px]</span> <span class="hljs-attribute">border</span>-t-<span class="hljs-selector-attr">[12px]</span> <span class="hljs-attribute">border</span>-<span class="hljs-selector-attr">[#1D2129]</span> <span class="hljs-attribute">border</span>-x-transparent" /&gt;
</code></pre>
<p>3.竖线：奇数项加长（视觉第1、3、5项）,使用tailwind的h-[310px]和h-[101px]来实现连接线的长短</p>
<pre><code class="hljs language-less" lang="less">&lt;<span class="hljs-selector-tag">div</span>
          <span class="hljs-selector-tag">class</span>="<span class="hljs-selector-tag">w-</span><span class="hljs-selector-attr">[2px]</span>" :<span class="hljs-selector-tag">class</span>="<span class="hljs-selector-attr">[            isCreation ? <span class="hljs-string">'bg-blue-500'</span> : <span class="hljs-string">'bg-[#685FE1]'</span>,            i % 2 === 0 ? <span class="hljs-string">'h-[310px]'</span> : <span class="hljs-string">'h-[101px]'</span>,          ]</span>"
        /&gt;
</code></pre>
<p>4.底部圆点的实现，也是使用一个div来实现的</p>
<pre><code class="hljs language-less" lang="less">&lt;<span class="hljs-selector-tag">div</span>
    <span class="hljs-selector-tag">class</span>="<span class="hljs-selector-tag">z-10</span> <span class="hljs-selector-tag">size-4</span> <span class="hljs-selector-tag">rounded-full</span> <span class="hljs-selector-tag">border-</span><span class="hljs-selector-attr">[3px]</span> <span class="hljs-selector-tag">bg-white</span>" :<span class="hljs-selector-tag">class</span>="<span class="hljs-selector-attr">[    isCreation ? <span class="hljs-string">'border-blue-500'</span> : <span class="hljs-string">'border-[#685FE1]'</span>,    ]</span>"
/&gt;
</code></pre>
<p>5.底部横向主线（黑色）贯穿整个容器</p>
<pre><code class="hljs language-scss" lang="scss">&lt;<span class="hljs-selector-tag">div</span> class="absolute inset-x-<span class="hljs-number">0</span> <span class="hljs-attribute">bottom</span>-<span class="hljs-selector-attr">[35px]</span> h-<span class="hljs-selector-attr">[2px]</span> bg-black"/&gt;
</code></pre>
<p>6.底部时间轴右侧箭头（固定在轴线右端，靠内边距 <code>right-[-11px]</code> 可调）</p>
<pre><code class="hljs language-js" lang="js">  &lt;div <span class="hljs-keyword">class</span>=<span class="hljs-string">"pointer-events-none absolute bottom-[56px] right-[-11px] z-[999]"</span>&gt;
    &lt;!-- 向右的箭头 <span class="hljs-variable constant_">SVG</span>，样式可改 --&gt;
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">svg</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"size-6 text-black"</span> <span class="hljs-attr">viewBox</span>=<span class="hljs-string">"0 0 24 24"</span> <span class="hljs-attr">fill</span>=<span class="hljs-string">"none"</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.w3.org/2000/svg"</span> <span class="hljs-attr">aria-hidden</span>=<span class="hljs-string">"true"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">path</span> <span class="hljs-attr">d</span>=<span class="hljs-string">"M5 12h13"</span> <span class="hljs-attr">stroke</span>=<span class="hljs-string">"currentColor"</span> <span class="hljs-attr">stroke-width</span>=<span class="hljs-string">"1.6"</span> <span class="hljs-attr">stroke-linecap</span>=<span class="hljs-string">"round"</span> <span class="hljs-attr">stroke-linejoin</span>=<span class="hljs-string">"round"</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">path</span> <span class="hljs-attr">d</span>=<span class="hljs-string">"M13 5l7 7-7 7"</span> <span class="hljs-attr">stroke</span>=<span class="hljs-string">"currentColor"</span> <span class="hljs-attr">stroke-width</span>=<span class="hljs-string">"1.6"</span> <span class="hljs-attr">stroke-linecap</span>=<span class="hljs-string">"round"</span> <span class="hljs-attr">stroke-linejoin</span>=<span class="hljs-string">"round"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">svg</span>&gt;</span></span>
  &lt;/div&gt;
</code></pre>
<p>关键代码，通过监听鼠标滚轮来实现横向滚动的</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> el = scrollRef.<span class="hljs-property">value</span>
  <span class="hljs-keyword">if</span> (!el)
    <span class="hljs-keyword">return</span>
  <span class="hljs-comment">// 鼠标滚轮横向滚动</span>
  el.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'wheel'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(e.<span class="hljs-property">deltaY</span>) &gt; <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(e.<span class="hljs-property">deltaX</span>)) {
      e.<span class="hljs-title function_">preventDefault</span>()
      el.<span class="hljs-property">scrollLeft</span> += e.<span class="hljs-property">deltaY</span>
    }
  })
})
</code></pre>
<p>来看看代码行数，确实很惊艳，简单的119行就实现了
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6303e58a360847b2828883e9c1fae9eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L2g5LiN5Lya5Zuw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764585023&amp;x-signature=QT7ClFT1eVp7U2p58oDmgusfiq8%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">总结</h2>
<p>trae的solo确实比之前好很多，也惊艳到我了，前端可真是越来越难了，以后的时间排期也会进一步的压缩了，还是要适当的使用ai来辅助我们的编程，把一些比较容易实现的，耗时间的工作交给ai去实现，我们专注于一些工程化和架构上面去，也可以适当学一些node项目，提高我们自己的核心竞争力,加油吧，前端工程师们。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🗣️面试官： 那些常见的前端面试场景问题]]></title>    <link>https://juejin.cn/post/7576052677051449370</link>    <guid>https://juejin.cn/post/7576052677051449370</guid>    <pubDate>2025-11-24T10:30:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576052677051449370" data-draft-id="7569566666528768040" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🗣️面试官： 那些常见的前端面试场景问题"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2025-11-24T10:30:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="原来是小仙女呀"/> <meta itemprop="url" content="https://juejin.cn/user/1239904846362055"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🗣️面试官： 那些常见的前端面试场景问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1239904846362055/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    原来是小仙女呀
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T10:30:33.000Z" title="Mon Nov 24 2025 10:30:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 页面白屏如何排查？</h2>
<p><strong>第一步：快速分类（30秒）</strong> "页面白屏主要有五种原因：JavaScript执行错误、资源加载失败、CSS样式问题、接口异常和浏览器兼容性。其中JavaScript错误最常见，特别是SPA应用中的未捕获异常。"</p>
<p><strong>第二步：排查方法（1分钟）</strong> "我的排查步骤是：首先查看Console面板的错误信息，这能快速定位JS异常；然后检查Network面板确认资源加载状态；接着用Elements面板验证DOM和样式；移动端问题会用vConsole或真机调试。生产环境结合Sentry等监控系统分析。"</p>
<p><strong>第三步：预防措施（30秒）</strong> "预防方面建立错误边界、资源容错机制、统一接口异常处理、兼容性检测，同时搭建监控告警体系。"</p>
<h3 data-id="heading-1">一、基础检测流程</h3>
<h4 data-id="heading-2">1. 控制台检查（Console）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 主动捕获全局错误（放在入口文件最前面）</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'error'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'全局捕获:'</span>, event.<span class="hljs-property">error</span>);
  <span class="hljs-comment">// 可上报到监控系统</span>
});

<span class="hljs-comment">// 检查console是否有以下类型错误：</span>
<span class="hljs-comment">// - SyntaxError (语法错误)</span>
<span class="hljs-comment">// - TypeError (类型错误)</span>
<span class="hljs-comment">// - ReferenceError (引用错误)</span>
<span class="hljs-comment">// - 404资源加载失败</span>
</code></pre>
<h4 data-id="heading-3">2. 网络请求检查（Network）</h4>
<ul>
<li>
<p><strong>关键指标</strong>：</p>
<ul>
<li>HTML文档状态码（200/304/404/500）</li>
<li>JS/CSS资源加载状态</li>
<li>接口请求是否阻塞渲染</li>
</ul>
</li>
<li>
<p><strong>检测示例</strong>：</p>
</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">// 检查关键资源是否加载完成
const <span class="hljs-attr">resourceCheck</span> = () =&gt; {
  const <span class="hljs-attr">entries</span> = performance.getEntriesByType(<span class="hljs-string">'resource'</span>)<span class="hljs-comment">;</span>
  const <span class="hljs-attr">criticalResources</span> = entries.filter(entry =&gt; 
    <span class="hljs-attr">entry.initiatorType</span> === <span class="hljs-string">'script'</span> || 
    <span class="hljs-attr">entry.initiatorType</span> === <span class="hljs-string">'css'</span>
  )<span class="hljs-comment">;</span>
  
  criticalResources.forEach(<span class="hljs-attr">res</span> =&gt; {
    if(res.responseStatus &gt;= 400) {
      console.error(`资源加载失败: ${res.name}`, res)<span class="hljs-comment">;</span>
    }
  })<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
window.addEventListener('load', resourceCheck)<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-4">二、深度检测方法</h3>
<h4 data-id="heading-5">1. DOM渲染检测</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 检测DOM树是否正常构建</span>
function <span class="hljs-built_in">checkDOMReady</span>() {
  return new <span class="hljs-built_in">Promise</span>((resolve) =&gt; {
    const check = () =&gt; {
      <span class="hljs-built_in">if</span>(document.body &amp;&amp; document.body.children.length &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">resolve</span>(true);
      } else {
        <span class="hljs-built_in">setTimeout</span>(check, <span class="hljs-number">50</span>);
      }
    };
    <span class="hljs-built_in">check</span>();
  });
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-built_in">checkDOMReady</span>()<span class="hljs-selector-class">.then</span>((isReady) =&gt; {
  <span class="hljs-built_in">if</span>(!isReady) {
    console<span class="hljs-selector-class">.error</span>('DOM渲染超时');
    <span class="hljs-comment">// 上报白屏信息</span>
  }
});
</code></pre>
<h4 data-id="heading-6">2. 框架特定检测</h4>
<h5 data-id="heading-7">Vue应用检测：</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 在main.js中添加</span>
<span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>({
  <span class="hljs-attr">render</span>: <span class="hljs-function"><span class="hljs-params">h</span> =&gt;</span> <span class="hljs-title function_">h</span>(<span class="hljs-title class_">App</span>),
  <span class="hljs-title function_">errorCaptured</span>(<span class="hljs-params">err, vm, info</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Vue组件错误:'</span>, err, info);
    <span class="hljs-comment">// 可上报错误</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">// 阻止错误继续向上传播</span>
  }
}).$mount(<span class="hljs-string">'#app'</span>);

<span class="hljs-comment">// 检查根组件挂载</span>
<span class="hljs-keyword">if</span>(!<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'#app'</span>).<span class="hljs-property">__vue__</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Vue根实例挂载失败'</span>);
}
</code></pre>
<h5 data-id="heading-8">React应用检测：</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Error Boundary组件</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ErrorBoundary</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> {
  <span class="hljs-title function_">componentDidCatch</span>(<span class="hljs-params">error, info</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'React组件错误:'</span>, error, info);
    <span class="hljs-comment">// 上报错误</span>
  }
  
  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-property">children</span>; 
  }
}

<span class="hljs-comment">// 检查React根组件</span>
<span class="hljs-keyword">const</span> root = <span class="hljs-title class_">ReactDOM</span>.<span class="hljs-title function_">createRoot</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'root'</span>));
root.<span class="hljs-title function_">render</span>(
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ErrorBoundary</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">ErrorBoundary</span>&gt;</span></span>
);
</code></pre>
<h3 data-id="heading-9">三、性能相关检测</h3>
<h4 data-id="heading-10">1. 长任务检测</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 检测阻塞渲染的长时间任务</span>
<span class="hljs-keyword">const</span> observer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PerformanceObserver</span>(<span class="hljs-function">(<span class="hljs-params">list</span>) =&gt;</span> {
  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">const</span> entry <span class="hljs-keyword">of</span> list.<span class="hljs-title function_">getEntries</span>()) {
    <span class="hljs-keyword">if</span>(entry.<span class="hljs-property">duration</span> &gt; <span class="hljs-number">50</span>) { <span class="hljs-comment">// 超过50ms的任务</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'长任务影响渲染:'</span>, entry);
    }
  }
});
observer.<span class="hljs-title function_">observe</span>({<span class="hljs-attr">entryTypes</span>: [<span class="hljs-string">"longtask"</span>]});
</code></pre>
<h4 data-id="heading-11">2. 关键渲染路径监控</h4>
<pre><code class="hljs language-ini" lang="ini">// 使用Performance API监控关键时间点
const <span class="hljs-attr">perfData</span> = window.performance.timing<span class="hljs-comment">;</span>
const <span class="hljs-attr">metrics</span> = {
  domReady: perfData.domComplete - perfData.domLoading,
  loadTime: perfData.loadEventEnd - perfData.navigationStart
}<span class="hljs-comment">;</span>

if(metrics.domReady &gt; 3000) {
  console.error('DOM解析时间过长:', metrics)<span class="hljs-comment">;</span>
}
</code></pre>
<h3 data-id="heading-12">四、自动化检测方案</h3>
<h4 data-id="heading-13">1. Puppeteer检测脚本</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> puppeteer = <span class="hljs-built_in">require</span>(<span class="hljs-string">'puppeteer'</span>);

(<span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-keyword">const</span> browser = <span class="hljs-keyword">await</span> puppeteer.<span class="hljs-title function_">launch</span>();
  <span class="hljs-keyword">const</span> page = <span class="hljs-keyword">await</span> browser.<span class="hljs-title function_">newPage</span>();
  
  <span class="hljs-comment">// 监听控制台错误</span>
  page.<span class="hljs-title function_">on</span>(<span class="hljs-string">'console'</span>, <span class="hljs-function"><span class="hljs-params">msg</span> =&gt;</span> {
    <span class="hljs-keyword">if</span>(msg.<span class="hljs-title function_">type</span>() === <span class="hljs-string">'error'</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'页面错误:'</span>, msg.<span class="hljs-title function_">text</span>());
    }
  });
  
  <span class="hljs-comment">// 设置超时检测</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">race</span>([
    page.<span class="hljs-title function_">goto</span>(<span class="hljs-string">'https://your-site.com'</span>),
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">_, reject</span>) =&gt;</span> 
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'页面加载超时'</span>)), <span class="hljs-number">5000</span>)
    )
  ]);
  
  <span class="hljs-comment">// 检查可见内容</span>
  <span class="hljs-keyword">const</span> content = <span class="hljs-keyword">await</span> page.evaluate(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">bodyText</span>: <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-property">innerText</span>,
      <span class="hljs-attr">childCount</span>: <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-property">children</span>.<span class="hljs-property">length</span>
    };
  });
  
  <span class="hljs-keyword">if</span>(content.<span class="hljs-property">childCount</span> === <span class="hljs-number">0</span> || content.<span class="hljs-property">bodyText</span>.<span class="hljs-property">length</span> &lt; <span class="hljs-number">10</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'检测到白屏现象'</span>);
  }
  
  <span class="hljs-keyword">await</span> browser.<span class="hljs-title function_">close</span>();
})();
</code></pre>
<h4 data-id="heading-14">2. 真实用户监控（RUM）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 使用浏览器的MutationObserver监控DOM变化</span>
<span class="hljs-keyword">const</span> observer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MutationObserver</span>(<span class="hljs-function">(<span class="hljs-params">mutations</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span>(!<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'#app'</span>)?.<span class="hljs-property">innerHTML</span>) {
    <span class="hljs-comment">// 上报白屏事件</span>
    beacon.<span class="hljs-title function_">send</span>(<span class="hljs-string">'white-screen'</span>, {
      <span class="hljs-attr">url</span>: location.<span class="hljs-property">href</span>,
      <span class="hljs-attr">ua</span>: navigator.<span class="hljs-property">userAgent</span>
    });
  }
});

observer.<span class="hljs-title function_">observe</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>, {
  <span class="hljs-attr">childList</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">subtree</span>: <span class="hljs-literal">true</span>
});
</code></pre>
<h3 data-id="heading-15">五、常见白屏场景示例</h3>
<ol>
<li>
<p><strong>资源加载失败</strong>：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 错误的资源路径 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/wrong-path/app.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
</li>
<li>
<p><strong>语法错误</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 缺少括号导致整个脚本不执行</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'hello'</span>
}
</code></pre>
</li>
<li>
<p><strong>框架初始化失败</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// Vue示例 - 挂载元素不存在</span>
<span class="hljs-keyword">new</span> <span class="hljs-built_in">Vue</span>({el: <span class="hljs-string">'#not-exist'</span>});
</code></pre>
</li>
<li>
<p><strong>CSS阻塞</strong>：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 不正确的CSS引入阻塞渲染 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"nonexist.css"</span>&gt;</span>
</code></pre>
</li>
<li>
<p><strong>第三方库冲突</strong>：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 两个库都修改了Array原型</span>
libraryA<span class="hljs-selector-class">.modifyPrototype</span>();
libraryB<span class="hljs-selector-class">.modifyPrototype</span>(); <span class="hljs-comment">// 冲突导致错误 ```</span>
</code></pre>
</li>
</ol>
<h2 data-id="heading-16">2.前端埋点</h2>
<h3 data-id="heading-17">一、页面生命周期埋点</h3>
<h4 data-id="heading-18">1. 页面加载阶段</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 记录页面开始加载时间</span>
<span class="hljs-keyword">const</span> pageStartTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();

<span class="hljs-comment">// 监听页面加载完成</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'load'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> loadTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - pageStartTime;
  <span class="hljs-title function_">track</span>(<span class="hljs-string">'page_load'</span>, {
    <span class="hljs-attr">load_time</span>: loadTime,
    <span class="hljs-attr">referrer</span>: <span class="hljs-variable language_">document</span>.<span class="hljs-property">referrer</span>,
    <span class="hljs-attr">resource_status</span>: <span class="hljs-title function_">checkResources</span>()
  });
});

<span class="hljs-comment">// 检查关键资源加载状态</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">checkResources</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> performance.<span class="hljs-title function_">getEntriesByType</span>(<span class="hljs-string">'resource'</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> ({
    <span class="hljs-attr">name</span>: res.<span class="hljs-property">name</span>,
    <span class="hljs-attr">type</span>: res.<span class="hljs-property">initiatorType</span>,
    <span class="hljs-attr">duration</span>: res.<span class="hljs-property">duration</span>.<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">2</span>)
  }));
}
</code></pre>
<h4 data-id="heading-19">2. 用户交互阶段</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 点击事件埋点（支持事件委托）</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> target = e.<span class="hljs-property">target</span>.<span class="hljs-title function_">closest</span>(<span class="hljs-string">'[data-track]'</span>);
  <span class="hljs-keyword">if</span>(target) {
    <span class="hljs-title function_">track</span>(<span class="hljs-string">'element_click'</span>, {
      <span class="hljs-attr">element_id</span>: target.<span class="hljs-property">id</span>,
      <span class="hljs-attr">track_type</span>: target.<span class="hljs-property">dataset</span>.<span class="hljs-property">track</span>,
      <span class="hljs-attr">position</span>: <span class="hljs-string">`<span class="hljs-subst">${e.clientX}</span>,<span class="hljs-subst">${e.clientY}</span>`</span>
    });
  }
});

<span class="hljs-comment">// 滚动深度记录</span>
<span class="hljs-keyword">let</span> maxScroll = <span class="hljs-number">0</span>;
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'scroll'</span>, _.<span class="hljs-title function_">throttle</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> currentScroll = <span class="hljs-variable language_">window</span>.<span class="hljs-property">scrollY</span> / <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-property">scrollHeight</span>;
  <span class="hljs-keyword">if</span>(currentScroll &gt; maxScroll) {
    maxScroll = currentScroll;
    <span class="hljs-title function_">track</span>(<span class="hljs-string">'scroll_depth'</span>, { <span class="hljs-attr">depth</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(maxScroll * <span class="hljs-number">100</span>) });
  }
}, <span class="hljs-number">1000</span>));
</code></pre>
<h4 data-id="heading-20">3. 页面停留时长计算</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> activeStart = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
<span class="hljs-keyword">let</span> inactiveTime = <span class="hljs-number">0</span>;

<span class="hljs-comment">// 用户活跃状态检测</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'mousemove'</span>, resetActiveTimer);
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'keydown'</span>, resetActiveTimer);

<span class="hljs-keyword">function</span> <span class="hljs-title function_">resetActiveTimer</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span>(inactiveTime &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-title function_">track</span>(<span class="hljs-string">'user_inactive'</span>, { <span class="hljs-attr">duration</span>: inactiveTime });
    inactiveTime = <span class="hljs-number">0</span>;
  }
  activeStart = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
}

<span class="hljs-comment">// 每10秒检测一次活跃状态</span>
<span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span>(<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - activeStart &gt; <span class="hljs-number">15000</span>) { <span class="hljs-comment">// 15秒无操作视为不活跃</span>
    inactiveTime += <span class="hljs-number">10000</span>;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-title function_">track</span>(<span class="hljs-string">'user_active'</span>, { <span class="hljs-attr">duration</span>: <span class="hljs-number">10000</span> });
  }
}, <span class="hljs-number">10000</span>);
</code></pre>
<h3 data-id="heading-21">二、特殊场景处理</h3>
<h4 data-id="heading-22">1. 页面隐藏/显示</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 页面可见性变化监听</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'visibilitychange'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-property">hidden</span>) {
    <span class="hljs-title function_">track</span>(<span class="hljs-string">'page_hide'</span>, { 
      <span class="hljs-attr">stay_time</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - pageStartTime,
      <span class="hljs-attr">scroll_depth</span>: maxScroll
    });
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-title function_">track</span>(<span class="hljs-string">'page_show'</span>);
  }
});
</code></pre>
<h4 data-id="heading-23">2. 页面关闭前上报</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 确保页面关闭前数据上报</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'beforeunload'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> totalStay = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - pageStartTime;
  navigator.<span class="hljs-title function_">sendBeacon</span>(<span class="hljs-string">'/api/track'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
    <span class="hljs-attr">event</span>: <span class="hljs-string">'page_close'</span>,
    <span class="hljs-attr">active_time</span>: totalStay - inactiveTime,
    <span class="hljs-attr">scroll_depth</span>: maxScroll
  }));
});
</code></pre>
<h3 data-id="heading-24">三、数据上报优化方案</h3>
<h4 data-id="heading-25">1. 批量上报机制</h4>
<pre><code class="hljs language-ini" lang="ini">let <span class="hljs-attr">eventQueue</span> = []<span class="hljs-comment">;</span>
const <span class="hljs-attr">MAX_QUEUE</span> = <span class="hljs-number">5</span><span class="hljs-comment">;</span>
const <span class="hljs-attr">FLUSH_INTERVAL</span> = <span class="hljs-number">3000</span><span class="hljs-comment">;</span>

function addToQueue(event) {
  eventQueue.push(event)<span class="hljs-comment">;</span>
  if(eventQueue.length &gt;= MAX_QUEUE) {
    flushQueue()<span class="hljs-comment">;</span>
  }
}

function flushQueue() {
  if(<span class="hljs-attr">eventQueue.length</span> === <span class="hljs-number">0</span>) return<span class="hljs-comment">;</span>
  
  const <span class="hljs-attr">batchData</span> = { batch: eventQueue }<span class="hljs-comment">;</span>
  navigator.sendBeacon('/api/batch', JSON.stringify(batchData))<span class="hljs-comment">;</span>
  <span class="hljs-attr">eventQueue</span> = []<span class="hljs-comment">;</span>
}

// 定时刷新队列
setInterval(flushQueue, FLUSH_INTERVAL)<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-26">2. 关键指标计算</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 计算FMP（首次有效绘制）</span>
<span class="hljs-keyword">new</span> <span class="hljs-title class_">PerformanceObserver</span>((entryList) =&gt; {
  <span class="hljs-keyword">const</span> [entry] = entryList.<span class="hljs-title function_ invoke__">getEntriesByName</span>(<span class="hljs-string">'first-contentful-paint'</span>);
  <span class="hljs-title function_ invoke__">track</span>(<span class="hljs-string">'fmp'</span>, { <span class="hljs-attr">value</span>: entry.startTime.<span class="hljs-title function_ invoke__">toFixed</span>(<span class="hljs-number">2</span>) });
}).<span class="hljs-title function_ invoke__">observe</span>({<span class="hljs-attr">type</span>: <span class="hljs-string">'paint'</span>, <span class="hljs-attr">buffered</span>: <span class="hljs-literal">true</span>});

<span class="hljs-comment">// 计算LCP（最大内容绘制）</span>
<span class="hljs-keyword">new</span> <span class="hljs-title class_">PerformanceObserver</span>((entryList) =&gt; {
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">entries</span> = entryList.<span class="hljs-title function_ invoke__">getEntries</span>();
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">lastEntry</span> = entries[entries.length - <span class="hljs-number">1</span>];
  <span class="hljs-title function_ invoke__">track</span>(<span class="hljs-string">'lcp'</span>, { <span class="hljs-attr">value</span>: lastEntry.startTime.<span class="hljs-title function_ invoke__">toFixed</span>(<span class="hljs-number">2</span>) });
}).<span class="hljs-title function_ invoke__">observe</span>({<span class="hljs-attr">type</span>: <span class="hljs-string">'largest-contentful-paint'</span>, <span class="hljs-attr">buffered</span>: <span class="hljs-literal">true</span>});
</code></pre>
<h3 data-id="heading-27">四、面试回答精简版</h3>
<p>"我们实现全链路埋点主要分三个阶段：</p>
<ol>
<li>
<p><strong>加载阶段</strong>：</p>
<ul>
<li>用<code>performance API</code>采集DNS/TTFB等指标</li>
<li>监听<code>load</code>事件记录完整加载时间</li>
<li>检查关键资源状态（如图片/脚本）</li>
</ul>
</li>
<li>
<p><strong>交互阶段</strong>：</p>
<ul>
<li>事件委托监听全局点击（带<code>data-track</code>属性）</li>
<li>节流处理滚动事件计算最大深度</li>
<li>通过<code>mousemove/keydown</code>检测活跃状态</li>
</ul>
</li>
<li>
<p><strong>离开阶段</strong>：</p>
<ul>
<li><code>visibilitychange</code>处理页面切换</li>
<li><code>beforeunload</code>+<code>sendBeacon</code>确保关闭前上报</li>
<li>计算总停留时长和有效活跃时间</li>
</ul>
</li>
</ol>
<h3 data-id="heading-28">3.那为什么大家都使用请求<code> GIF 图片</code>的方式上报埋点数据呢？</h3>
<ul>
<li>
<p><strong>防止跨域问题</strong>：前端监控的请求常常会遇到跨域问题，这可能会影响监控的准确性和可用性。然而，图片的src属性并不会跨域，因此使用GIF图片作为埋点可以正常发起请求，从而有效避免跨域问题。</p>
</li>
<li>
<p><strong>防止阻塞页面加载</strong>：在创建资源节点后，通常只有当对象注入到浏览器的DOM树后，浏览器才会实际发送资源请求。但反复操作DOM会引发性能问题，且载入js/css资源会阻塞页面渲染，从而影响用户体验。与此不同，构造图片打点不需要插入DOM，只要在js中new出Image对象就能发起请求，这样就不会有阻塞问题。即使在没有js的浏览器环境中，也能通过img标签正常打点，这是其他类型的资源请求所做不到的。</p>
</li>
<li>
<p><strong>体积小，节约流量</strong>：相比其他图片格式（如BMP和PNG），GIF图片具有更小的体积。例如，最小的BMP文件需要74个字节，PNG需要67个字节，而合法的GIF只需要43个字节。因此，使用GIF作为埋点可以显著节约流量，提高数据传输效率。</p>
</li>
<li>
<p><strong>浏览器支持性好</strong>：所有浏览器都支持Image对象，即使不支持XMLHttpRequest对象也一样。这意味着使用GIF进行埋点上报可以在各种浏览器环境中稳定运行。</p>
</li>
<li>
<p><strong>记录错误的过程很少出错</strong>：某些情况下，如Ajax通信过程中页面跳转，请求可能会被取消。但使用图片进行埋点上报则不会遇到这个问题，特别是在记录离开页面打点行为的时候会很有用。</p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[搭建Hyperf本地开发环境之Docker容器开发]]></title>    <link>https://juejin.cn/post/7576086557716168755</link>    <guid>https://juejin.cn/post/7576086557716168755</guid>    <pubDate>2025-11-24T09:53:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576086557716168755" data-draft-id="7576070987293868078" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="搭建Hyperf本地开发环境之Docker容器开发"/> <meta itemprop="keywords" content="后端,PHP,Docker"/> <meta itemprop="datePublished" content="2025-11-24T09:53:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="joker丶牧羊人"/> <meta itemprop="url" content="https://juejin.cn/user/4054654614250958"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            搭建Hyperf本地开发环境之Docker容器开发
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4054654614250958/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    joker丶牧羊人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T09:53:28.000Z" title="Mon Nov 24 2025 09:53:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">写在前面</h3>
<blockquote>
<p>本文以部署本地开发环境，以实现快速部署为基准、方便开发为前提做说明</p>
</blockquote>
<h3 data-id="heading-1">背景</h3>
<p>本人在实际工作过程中，使用 hyperf 框架开发时遇到这种情况：</p>
<ul>
<li>同时开发多个项目</li>
<li>同时使用不同的 hyperf 框架版（2.x、3.x）</li>
<li>不同项目对接不同的数据库（Mysql、Oracle、Sqlserver）</li>
</ul>
<p>遇到的问题有很多，比如：</p>
<ul>
<li>2.x 和 3.x 对 php 版本和 swoole 版本不一样</li>
<li>每个 php 版本需要单独安装对应的 扩展</li>
<li>不同的 php 版本，composer 需要重新安装</li>
<li>项目中使用 composer 添加扩展包时，还要对应自己的项目版本使用正确的 composer</li>
<li>... ... ...</li>
</ul>
<p>这一套下来，耗费时间长，如果换台设备，重新部署也很麻烦；</p>
<p>所以，考虑到使用容器开发来解决当下的困局 ... ... ...</p>
<h3 data-id="heading-2">一、准备工作</h3>
<h4 data-id="heading-3">环境准备</h4>
<blockquote>
<p>基于本人开发环境做说明</p>
</blockquote>
<ul>
<li>一个 linux 环境、已安装好 docker、docker-compose
<ul>
<li>CentOS 版本：<code>CentOS Linux release 7.9.2009 (Core)</code></li>
<li>docker 版本：<code>Docker version 24.0.5, build ced0996</code></li>
<li>docker-compos 版本：<code>Docker Compose version v2.20.2</code></li>
</ul>
</li>
</ul>
<h3 data-id="heading-4">二、开始部署（基础）</h3>
<blockquote>
<p>本文以 php7.4 + hyperf2.x 做开发环境的说明</p>
</blockquote>
<h4 data-id="heading-5">准备 Dockerfile</h4>
<pre><code class="hljs language-dockerfile" lang="dockerfile">FROM php:7.4-cli-bullseye

# 设置时区
ENV TZ=Asia/Shanghai
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime &amp;&amp; echo $TZ &gt; /etc/timezone

# 更新并安装基础依赖
RUN apt-get update &amp;&amp; apt-get install -y \
    --no-install-recommends libfreetype6-dev libjpeg62-turbo-dev libpng-dev libzip-dev \
    &amp;&amp; apt-get clean &amp;&amp; rm -rf /var/lib/apt/lists/*

# 安装 redis 和 swoole 扩展
RUN pecl install redis-5.3.7 swoole-4.8.13

# 移动 php.ini 配置文件
RUN mv "$PHP_INI_DIR/php.ini-production" "$PHP_INI_DIR/php.ini"

# 启用扩展
RUN docker-php-ext-enable redis swoole

# 配置 GD 扩展
RUN docker-php-ext-configure gd --with-jpeg=/usr/include --with-freetype=/usr/include/freetype2/

# 安装 PHP 扩展
RUN docker-php-ext-install -j$(nproc) pcntl gd zip pdo_mysql opcache

# 添加自定义 PHP 配置
RUN echo "swoole.use_shortname='Off'" &gt;&gt; /usr/local/etc/php/conf.d/default.ini \
    &amp;&amp; echo "memory_limit=1G" &gt;&gt; /usr/local/etc/php/conf.d/default.ini \
    &amp;&amp; echo "opcache.enable_cli='on'" &gt;&gt; /usr/local/etc/php/conf.d/default.ini

# 安装 Composer
ENV COMPOSER_HOME /root/composer
RUN curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
ENV PATH $COMPOSER_HOME/vendor/bin:$PATH

# 指定工作目录，如果使用docker exec进入容器时，默认目录就是指定的工作目录，如/data
WORKDIR /opt/www
</code></pre>
<p>针对这份文档，做一些小说明：</p>
<ul>
<li>基础镜像使用 <code>-bullseye</code> 版本：有些基础依赖在其他版本已经不做维护了，需要自己设置对应的源地址，比较麻烦，而该版本基于最新的 debain 做兼容的</li>
<li>该文件没有设置启动命令：是为了给多个项目自己的启动命令留空间</li>
</ul>
<h4 data-id="heading-6">构建新镜像</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">执行构建</span>
docker build -t 镜像名称:标签 .
<span class="hljs-meta prompt_">
# </span><span class="bash">检查新镜像</span>
docker images
</code></pre>
<h4 data-id="heading-7">容器编排</h4>
<blockquote>
<p>docker-compose.yml</p>
</blockquote>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">"3.9"</span>
<span class="hljs-attr">services:</span>
        <span class="hljs-attr">php:</span>
                <span class="hljs-attr">image:</span> <span class="hljs-string">php-hyperf:7.4-cli-bullseye</span>
                <span class="hljs-attr">volumes:</span>
                        <span class="hljs-bullet">-</span> <span class="hljs-string">/etc/localtime:/etc/localtime</span>
                        <span class="hljs-bullet">-</span> <span class="hljs-string">/www:/opt/www</span>
                <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span>
                <span class="hljs-attr">container_name:</span> <span class="hljs-string">hyperf01</span>
<span class="hljs-comment">#                networks:</span>
<span class="hljs-comment">#                        - php-net</span>
<span class="hljs-comment">#                ports:</span>
<span class="hljs-comment">#                        - 9505:9501</span>
                <span class="hljs-attr">network_mode:</span> <span class="hljs-string">"host"</span>
                <span class="hljs-attr">tty:</span> <span class="hljs-literal">true</span>
                <span class="hljs-attr">stdin_open:</span> <span class="hljs-literal">true</span>

<span class="hljs-comment">#                command: ["php", "bin/hyperf.php", "start"]</span>
<span class="hljs-comment">#networks:</span>
<span class="hljs-comment">#        php-net:</span>
<span class="hljs-comment">#                external:</span>
<span class="hljs-comment">#                       name: php-net</span>

</code></pre>
<p>针对这份文档，做一些小说明：</p>
<blockquote>
<p>一般情况下，使用 docker-compose 编排容器是这样的：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">"3.9"</span>
<span class="hljs-attr">services:</span>
        <span class="hljs-attr">php:</span>
                <span class="hljs-attr">image:</span> <span class="hljs-string">php-hyperf:7.4-cli-bullseye</span>
                <span class="hljs-attr">volumes:</span>
                        <span class="hljs-bullet">-</span> <span class="hljs-string">/etc/localtime:/etc/localtime</span>
                        <span class="hljs-bullet">-</span> <span class="hljs-string">/www/hyperf01:/opt/www/hyperf01</span>
                <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span>
                <span class="hljs-attr">container_name:</span> <span class="hljs-string">hyperf01</span>
                <span class="hljs-attr">networks:</span>
                        <span class="hljs-bullet">-</span> <span class="hljs-string">php-net</span>
                <span class="hljs-attr">ports:</span>
                        <span class="hljs-bullet">-</span> <span class="hljs-number">9505</span><span class="hljs-string">:9501</span>
                <span class="hljs-attr">command:</span> [<span class="hljs-string">"php"</span>, <span class="hljs-string">"bin/hyperf.php"</span>, <span class="hljs-string">"start"</span>]
<span class="hljs-attr">networks:</span>
        <span class="hljs-attr">php-net:</span>
                <span class="hljs-attr">external:</span>
                       <span class="hljs-attr">name:</span> <span class="hljs-string">php-net</span>
</code></pre>
</blockquote>
<ul>
<li><code>image</code>: Dockerfile 构建出来的镜像名</li>
<li><code>volumes</code>: 挂载目录
<ul>
<li>开发环境目录结构解释：/www 是项目目录，里面包含多个项目文件夹</li>
<li><strong>此处挂载 /www ，是为了方便只使用一个 php 容器，可以运行多个 hyperf 项目</strong></li>
</ul>
</li>
<li><code>command</code>: 容器启动时的执行命令
<ul>
<li><strong>一般情况下，我们挂载了指定的项目名称，在容器启动时需要指定启动命令</strong></li>
<li><strong>但是，目前挂载的 /www，没有指定的项目，如果使用 <code>command: ["php", "bin/hyperf.php", "start"]</code> 容器会启动不成功</strong></li>
<li><strong>所以，我们在这里不能使用 command 启动命令，也是为了方便多项目各自启动</strong></li>
</ul>
</li>
<li><code>tty、stdin_open</code>:
<ul>
<li><strong>Dockerfile、docker-compose 中都没有了启动命令、容器启动不成功</strong></li>
<li><strong>所以，追加这两个参数，允许容器可以成功启动，容器不退出</strong></li>
</ul>
</li>
<li><code>ports</code>: 端口映射
<ul>
<li><strong>为了能直接使用每个项目自己配置的端口</strong></li>
<li><strong>因为为了方便扩展（后续追加更多的项目）</strong>
<ul>
<li>每个项目都有自己的端口号，如果在这里设置，那么每增加一个项目，就需要修改一次端口映射，并重新编排容器，很不方便</li>
<li>所以就取消了这里的端口映射</li>
</ul>
</li>
</ul>
</li>
<li><code>network_mode</code>: 网络模式
<ul>
<li><strong>固定值：<code>host</code>，容器共享宿主机网络，可以实现不用配置端口号</strong></li>
<li><strong>与 <code>ports</code> 参数不共存</strong></li>
<li><strong>使用了共享网络模式，那么就不再需要配置新的网络了，就取消了 <code>networks</code> 相关的参数配置</strong></li>
</ul>
</li>
</ul>
<h4 data-id="heading-8">执行容器编排</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">后台运行，创建容器并启动</span>
docker-compose up -d
</code></pre>
<h3 data-id="heading-9">三、启动并运行项目</h3>
<p>当我们启动好容器后、进入php容器中</p>
<pre><code class="hljs language-shell" lang="shell">docker exec -it hyperf01 bash
</code></pre>
<p>此时可以看到我们的项目目录 <code>/opt/www</code> ，因为这里包含了所有的项目目录，找到你自己的使用 php7.x 的项目，启动即可，启动成功后可以看到端口号就是你再项目中配置的端口号了。</p>
<p>至此，便可以愉快的开启你的牛马生活了 ... ... ...</p>
<h3 data-id="heading-10">四、提升</h3>
<p>前面，我们提供了一个完整的可直接享用的 <code>Dockerfile</code> 文件，虽然是方便食用，但是问题也随之出现了：</p>
<ul>
<li>当前是 php7.x 如果我们要换成 php8.x 怎么办呢？对应的 swoole 扩展版本 也需要修改</li>
<li>如果我们需要追加其他扩展怎么办呢？</li>
<li>... ... ...</li>
</ul>
<p>如果按照当前的模式，每次处理这些问题，都需要去修改 <code>Dockerfile</code> 文件，这样就搞得很麻烦？有没有一个简单有效的办法呢？？？</p>
<p>有、有、有，，，那就是把这些可变信息，提炼成配置文件，<code>Dockerfile</code> 使用读配置的方式进行，那么我们就不用频繁的修改 <code>Dockerfile</code> 文件了，每次有变动，那就直接修改配置文件，简单直接、方便快速！！！</p>
<p>那么，我现在提供一套可开箱即用的配置方案，至于中间的踩坑过程就直接略过，当然，方案实现不止这么一种，大家可以自行发掘 ... ... ...</p>
<h4 data-id="heading-11">目录结构</h4>
<blockquote>
<p>我们以 project 作为根目录做说明</p>
</blockquote>
<pre><code class="hljs language-shell" lang="shell">project
|--config
   |--build.conf
|--pecl
|--source
   |--alpine_source.list
   |--debian_source.list
|--build.sh
|--Dockerfile.base
|--Dockerfile.final
</code></pre>
<ul>
<li><code>project</code>：项目根目录</li>
<li><code>project/config</code>：构建配置文件目录</li>
<li><code>project/config/build.conf</code>：构建配置文件，方便修改构建信息</li>
<li><code>project/pecl</code>：本地下载扩展目录，方便从本地安装扩展，例如：<code>swoole-5.1.3.tar</code></li>
<li><code>project/source</code>：自定义 alpine、debian 配置源目录</li>
<li><code>project/source/alpine_source.list</code>：自定义 alpine 系统源配置信息</li>
<li><code>project/source/debian_source.list</code>：自定义 debian 系统源配置信息</li>
<li><code>project/build.sh</code>：构建执行脚本 需要有执行权限</li>
<li><code>project/Dockerfile.base</code>：用于构建基础镜像，只做 apline、debian 系统依赖和工具等更新</li>
<li><code>project/Dockerfile.final</code>：用于构建最终镜像，分阶段：一阶段主要功能 --- 安装扩展；二阶段主要功能 --- 构建最终镜像</li>
</ul>
<h4 data-id="heading-12">文件内容及说明</h4>
<h5 data-id="heading-13">build.conf</h5>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">PHP 基础镜像</span>
[base_image]
php:8.2-cli
<span class="hljs-meta prompt_">#</span><span class="bash">php:8.2-alpine</span>
<span class="hljs-meta prompt_">#</span><span class="bash">php:7.4-cli</span>
<span class="hljs-meta prompt_">#</span><span class="bash">php:7.4-alpine</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">PECL 扩展（pecl install）</span>
[pecl]
<span class="hljs-meta prompt_">#</span><span class="bash">swoole-4.8.13</span>
<span class="hljs-meta prompt_">#</span><span class="bash">redis-5.3.7</span>
swoole-5.1.3
redis
<span class="hljs-meta prompt_">
# </span><span class="bash">本地扩展（docker-php-ext-install）</span>
[local]
pcntl
gd
zip
pdo_mysql
opcache
<span class="hljs-meta prompt_">
# </span><span class="bash">构建模式：prod / dev</span>
[mode]
dev
<span class="hljs-meta prompt_">
# </span><span class="bash">是否使用自定义依赖源地址 <span class="hljs-literal">true</span> / <span class="hljs-literal">false</span></span>
[custom_source]
false
<span class="hljs-meta prompt_">
# </span><span class="bash">composer 源：auto / aliyun / tencent / ustc / packagist</span>
[composer_mirror]
auto
<span class="hljs-meta prompt_">
# </span><span class="bash">php.ini 配置</span>
[php]
swoole.use_shortname=Off
memory_limit=1G
opcache.enable_cli=on
<span class="hljs-meta prompt_">
# </span><span class="bash">构建目标：base / final / all</span>
[build_target]
all
<span class="hljs-meta prompt_">
# </span><span class="bash">是否强制重新构建基础镜像：<span class="hljs-literal">true</span> / <span class="hljs-literal">false</span></span>
[force_rebuild_base]
false
</code></pre>
<h5 data-id="heading-14">alpine_source.list</h5>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">阿里云源</span>
https://mirrors.aliyun.com/alpine/v3.18/main
https://mirrors.aliyun.com/alpine/v3.18/community
<span class="hljs-meta prompt_">
# </span><span class="bash">腾讯云源</span>
<span class="hljs-meta prompt_"># </span><span class="bash">https://mirrors.cloud.tencent.com/alpine/v3.18/main</span>
<span class="hljs-meta prompt_"># </span><span class="bash">https://mirrors.cloud.tencent.com/alpine/v3.18/community</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">清华源</span>
<span class="hljs-meta prompt_"># </span><span class="bash">https://mirrors.tuna.tsinghua.edu.cn/alpine/v3.18/main</span>
<span class="hljs-meta prompt_"># </span><span class="bash">https://mirrors.tuna.tsinghua.edu.cn/alpine/v3.18/community</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">官方源（备用）</span>
<span class="hljs-meta prompt_"># </span><span class="bash">https://dl-cdn.alpinelinux.org/alpine/v3.18/main</span>
<span class="hljs-meta prompt_"># </span><span class="bash">https://dl-cdn.alpinelinux.org/alpine/v3.18/community</span>

</code></pre>
<h5 data-id="heading-15">debian_source.list</h5>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">阿里云源</span>
deb http://mirrors.aliyun.com/debian/ bullseye main non-free contrib
deb http://mirrors.aliyun.com/debian-security/ bullseye-security main
deb http://mirrors.aliyun.com/debian/ bullseye-updates main non-free contrib
deb http://mirrors.aliyun.com/debian/ bullseye-backports main non-free contrib
<span class="hljs-meta prompt_">
# </span><span class="bash">腾讯云源</span>
<span class="hljs-meta prompt_"># </span><span class="bash">deb http://mirrors.cloud.tencent.com/debian/ bullseye main non-free contrib</span>
<span class="hljs-meta prompt_"># </span><span class="bash">deb http://mirrors.cloud.tencent.com/debian-security/ bullseye-security main</span>
<span class="hljs-meta prompt_"># </span><span class="bash">deb http://mirrors.cloud.tencent.com/debian/ bullseye-updates main non-free contrib</span>
<span class="hljs-meta prompt_"># </span><span class="bash">deb http://mirrors.cloud.tencent.com/debian/ bullseye-backports main non-free contrib</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">清华源</span>
<span class="hljs-meta prompt_"># </span><span class="bash">deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye main contrib non-free</span>
<span class="hljs-meta prompt_"># </span><span class="bash">deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye-updates main contrib non-free</span>
<span class="hljs-meta prompt_"># </span><span class="bash">deb https://mirrors.tuna.tsinghua.edu.cn/debian/ bullseye-backports main contrib non-free</span>
<span class="hljs-meta prompt_"># </span><span class="bash">deb https://mirrors.tuna.tsinghua.edu.cn/debian-security bullseye-security main contrib non-free</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">官方源（备用）</span>
<span class="hljs-meta prompt_"># </span><span class="bash">deb http://deb.debian.org/debian bullseye main contrib non-free</span>
<span class="hljs-meta prompt_"># </span><span class="bash">deb http://deb.debian.org/debian-security/ bullseye-security main contrib non-free</span>
<span class="hljs-meta prompt_"># </span><span class="bash">deb http://deb.debian.org/debian bullseye-updates main contrib non-free</span>

</code></pre>
<h5 data-id="heading-16">Dockerfile.base</h5>
<pre><code class="hljs language-dockerfile" lang="dockerfile"># =============================================================================
# PHP 基础镜像 Dockerfile
# 功能：安装系统依赖、编译工具和常用库，为后续扩展安装做准备
# =============================================================================

# 构建参数
ARG BASE_IMAGE
FROM ${BASE_IMAGE}

# 系统类型参数
ARG SYSTEM_TYPE
ARG CUSTOM_SOURCE

# 设置工作目录
WORKDIR /tmp/build

# 设置环境变量防止 OOM
ENV MAKEFLAGS="-j2"
ENV COMPOSER_MEMORY_LIMIT=-1

# 复制源配置文件
COPY source/${SYSTEM_TYPE}_source.list /tmp/source.list

# 安装基础依赖和编译工具
RUN set -eux; \
    echo "========================================"; \
    echo "开始构建 PHP 基础镜像"; \
    echo "系统类型: ${SYSTEM_TYPE}"; \
    echo "自定义源: ${CUSTOM_SOURCE}"; \
    echo "========================================"; \
    \
    # Alpine 系统配置
    if [ "$SYSTEM_TYPE" = "alpine" ]; then \
        echo "配置 Alpine 源..."; \
        if [ "$CUSTOM_SOURCE" = "true" ]; then \
            echo "使用自定义源"; \
            cat /tmp/source.list &gt; /etc/apk/repositories; \
        fi; \
        \
        echo "更新软件包索引..."; \
        apk update || { echo "APK 更新失败"; exit 1; }; \
        \
        echo "安装基础工具..."; \
        apk add --no-cache \
            bash \
            curl \
            wget \
            git \
            vim \
            unzip || { echo "基础工具安装失败"; exit 1; }; \
        \
        echo "安装开发库..."; \
        apk add --no-cache \
            libzip-dev \
            zlib-dev \
            libpng-dev \
            libjpeg-turbo-dev \
            freetype-dev \
            libwebp-dev || { echo "开发库安装失败"; exit 1; }; \
        \
        echo "安装 XPM 和加密库..."; \
        apk add --no-cache \
            libxpm-dev \
            openssl-dev \
            curl-dev || { echo "XPM/加密库安装失败"; exit 1; }; \
        \
        echo "安装 XML 和数据库库..."; \
        apk add --no-cache \
            libxml2-dev \
            oniguruma-dev \
            sqlite-dev \
            postgresql-dev || { echo "XML/数据库库安装失败"; exit 1; }; \
        \
        echo "安装编译工具..."; \
        apk add --no-cache \
            autoconf \
            g++ \
            make \
            linux-headers || { echo "编译工具安装失败"; exit 1; }; \
        \
        echo "配置 GD 扩展依赖..."; \
        docker-php-ext-configure gd \
            --with-freetype \
            --with-jpeg \
            --with-webp || { echo "GD 配置失败，继续..."; }; \
    \
    # Debian 系统配置
    else \
        echo "配置 Debian 源..."; \
        if [ "$CUSTOM_SOURCE" = "true" ]; then \
            echo "使用自定义源"; \
            cat /tmp/source.list &gt; /etc/apt/sources.list; \
        fi; \
        \
        echo "更新软件包索引..."; \
        apt-get update || { echo "APT 更新失败"; exit 1; }; \
        \
        echo "安装基础工具和编译依赖..."; \
        DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
            curl \
            wget \
            git \
            vim \
            unzip \
            libzip-dev \
            zlib1g-dev \
            libpng-dev \
            libjpeg-dev \
            libfreetype6-dev \
            libwebp-dev \
            libxpm-dev \
            libssl-dev \
            libcurl4-openssl-dev \
            libxml2-dev \
            libonig-dev \
            libsqlite3-dev \
            libpq-dev \
            autoconf \
            g++ \
            make || { echo "Debian 包安装失败"; exit 1; }; \
        \
        echo "配置 GD 扩展依赖..."; \
        docker-php-ext-configure gd \
            --with-freetype \
            --with-jpeg \
            --with-webp || { echo "GD 配置失败，继续..."; }; \
        \
        echo "清理 APT 缓存..."; \
        rm -rf /var/lib/apt/lists/*; \
    fi; \
    \
    # 清理临时文件
    rm -rf /tmp/*; \
    \
    echo "========================================"; \
    echo "基础镜像构建完成"; \
    echo "========================================";

# 健康检查
RUN php -v &amp;&amp; php -m

# 设置默认工作目录
WORKDIR /var/www/html

</code></pre>
<ul>
<li>
<p>该文件注释已标注在文档中</p>
</li>
<li>
<p>简要说明</p>
<ul>
<li>执行该文件，会生成类似于 php-base:8.2-debian php-base:8.2-alpine 的基础镜像</li>
<li>基础镜像的生成规则
<ul>
<li>
<p>镜像名称规则：固定值 php-base</p>
</li>
<li>
<p>tag 标签生成规则：自动读取配置文件中的 基础镜像名，获取版本号 和 对应的系统信息（debian/alpine）作为 tag 名称</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 data-id="heading-17">Dockerfile.final</h5>
<pre><code class="hljs language-dockerfile" lang="dockerfile"># =============================================================================
# PHP 最终镜像 Dockerfile（多阶段构建）
# 功能：基于基础镜像安装 PHP 扩展、配置 PHP 和 Composer
# =============================================================================

# 构建参数
ARG BASE_IMAGE_NAME
FROM ${BASE_IMAGE_NAME}

# 扩展和配置参数
ARG SYSTEM_TYPE
ARG PECL_EXTENSIONS=""
ARG LOCAL_EXTENSIONS=""
ARG PHP_INI_CONFIGS=""
ARG COMPOSER_MIRROR="auto"
ARG BUILD_MODE="dev"

# 设置工作目录
WORKDIR /tmp/build

# 复制本地扩展目录（如果存在）
COPY pecl/ /tmp/pecl/

# 安装 PHP 扩展
RUN set -eux; \
    echo "========================================"; \
    echo "开始安装 PHP 扩展"; \
    echo "系统类型: ${SYSTEM_TYPE}"; \
    echo "PECL 扩展: ${PECL_EXTENSIONS}"; \
    echo "LOCAL 扩展: ${LOCAL_EXTENSIONS}"; \
    echo "构建模式: ${BUILD_MODE}"; \
    echo "========================================"; \
    \
    # 定义重试函数
    retry_command() { \
        local max_attempts=3; \
        local attempt=1; \
        local cmd="$@"; \
        while [ $attempt -le $max_attempts ]; do \
            echo "尝试执行 (${attempt}/${max_attempts}): ${cmd}"; \
            if eval "$cmd"; then \
                echo "执行成功"; \
                return 0; \
            fi; \
            echo "执行失败，等待 5 秒后重试..."; \
            sleep 5; \
            attempt=$((attempt + 1)); \
        done; \
        echo "执行失败，已达到最大重试次数"; \
        return 1; \
    }; \
    \
    # 安装 LOCAL 扩展
    if [ -n "$LOCAL_EXTENSIONS" ]; then \
        echo "----------------------------------------"; \
        echo "安装 LOCAL 扩展: $LOCAL_EXTENSIONS"; \
        echo "----------------------------------------"; \
        \
        # 特殊扩展依赖处理
        for ext in $LOCAL_EXTENSIONS; do \
            case "$ext" in \
                gd) \
                    echo "检测到 GD 扩展，已在基础镜像配置"; \
                    ;; \
                zip) \
                    echo "检测到 ZIP 扩展"; \
                    if [ "$SYSTEM_TYPE" = "alpine" ]; then \
                        apk add --no-cache libzip-dev; \
                    fi; \
                    ;; \
                pdo_mysql) \
                    echo "检测到 PDO_MYSQL 扩展"; \
                    ;; \
                opcache) \
                    echo "检测到 OPCACHE 扩展"; \
                    ;; \
                pcntl) \
                    echo "检测到 PCNTL 扩展"; \
                    ;; \
                *) \
                    echo "扩展: $ext"; \
                    ;; \
            esac; \
        done; \
        \
        # 一次性安装所有 LOCAL 扩展
        if ! retry_command "docker-php-ext-install -j\$(nproc) $LOCAL_EXTENSIONS"; then \
            echo "LOCAL 扩展安装失败"; \
            exit 1; \
        fi; \
        echo "LOCAL 扩展安装成功"; \
    fi; \
    \
    # 安装 PECL 扩展
    if [ -n "$PECL_EXTENSIONS" ]; then \
        echo "----------------------------------------"; \
        echo "安装 PECL 扩展: $PECL_EXTENSIONS"; \
        echo "----------------------------------------"; \
        \
        echo "$PECL_EXTENSIONS" | tr ',' '\n' | while read -r ext; do \
            # 跳过空行
            [ -z "$ext" ] &amp;&amp; continue; \
            \
            ext_name=$(echo "$ext" | cut -d'-' -f1); \
            echo "处理扩展: $ext_name (完整名称: $ext)"; \
            \
            # 检查本地扩展目录
            if [ -f "/tmp/pecl/${ext}.tgz" ]; then \
                echo "从本地安装: ${ext}"; \
                if ! retry_command "pecl install /tmp/pecl/${ext}.tgz"; then \
                    echo "从本地安装失败，尝试从 PECL 仓库安装"; \
                    if ! retry_command "pecl install $ext"; then \
                        echo "扩展 $ext 安装失败"; \
                        exit 1; \
                    fi; \
                fi; \
            else \
                echo "从 PECL 仓库安装: ${ext}"; \
                if ! retry_command "pecl install $ext"; then \
                    echo "扩展 $ext 安装失败"; \
                    exit 1; \
                fi; \
            fi; \
            \
            # 启用扩展
            echo "启用扩展: $ext_name"; \
            docker-php-ext-enable "$ext_name"; \
        done; \
        echo "PECL 扩展安装成功"; \
    fi; \
    \
    # 验证扩展安装
    echo "----------------------------------------"; \
    echo "验证已安装的扩展:"; \
    php -m; \
    echo "----------------------------------------";

# 配置 PHP.ini
RUN set -eux; \
    if [ -n "$PHP_INI_CONFIGS" ]; then \
        echo "========================================"; \
        echo "配置 PHP.ini"; \
        echo "========================================"; \
        \
        echo "$PHP_INI_CONFIGS" | tr '|' '\n' | while read -r config; do \
            # 跳过空行
            [ -z "$config" ] &amp;&amp; continue; \
            \
            echo "设置配置: $config"; \
            echo "$config" &gt;&gt; /usr/local/etc/php/conf.d/custom.ini; \
        done; \
        \
        echo "PHP.ini 配置完成"; \
        cat /usr/local/etc/php/conf.d/custom.ini; \
    fi;

# 安装 Composer
RUN set -eux; \
    echo "========================================"; \
    echo "安装 Composer"; \
    echo "Composer 镜像: ${COMPOSER_MIRROR}"; \
    echo "========================================"; \
    \
    # 下载 Composer
    curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer; \
    \
    # 配置 Composer 镜像源
    case "$COMPOSER_MIRROR" in \
        aliyun) \
            echo "配置阿里云 Composer 镜像"; \
            composer config -g repo.packagist composer https://mirrors.aliyun.com/composer/; \
            ;; \
        tencent) \
            echo "配置腾讯云 Composer 镜像"; \
            composer config -g repo.packagist composer https://mirrors.cloud.tencent.com/composer/; \
            ;; \
        ustc) \
            echo "配置中科大 Composer 镜像"; \
            composer config -g repo.packagist composer https://packagist.mirrors.ustc.edu.cn/; \
            ;; \
        packagist) \
            echo "使用官方 Packagist 源"; \
            ;; \
        auto) \
            echo "自动检测，使用阿里云镜像"; \
            composer config -g repo.packagist composer https://mirrors.aliyun.com/composer/; \
            ;; \
        *) \
            echo "未知的 Composer 镜像配置，使用默认源"; \
            ;; \
    esac; \
    \
    # 验证 Composer
    composer --version; \
    echo "Composer 安装完成";

# 清理和优化
RUN set -eux; \
    echo "========================================"; \
    echo "清理临时文件和优化镜像"; \
    echo "构建模式: ${BUILD_MODE}"; \
    echo "========================================"; \
    \
    # 清理 PECL 缓存
    rm -rf /tmp/pear; \
    \
    # 清理本地扩展
    rm -rf /tmp/pecl; \
    \
    # 根据构建模式决定是否清理编译工具
    if [ "$BUILD_MODE" = "prod" ]; then \
        echo "生产模式：清理编译工具以优化镜像大小"; \
        if [ "$SYSTEM_TYPE" = "alpine" ]; then \
            apk del autoconf g++ make linux-headers; \
        else \
            apt-get purge -y autoconf g++ make; \
            apt-get autoremove -y; \
            rm -rf /var/lib/apt/lists/*; \
        fi; \
    else \
        echo "开发模式：保留编译工具"; \
    fi; \
    \
    # 清理临时文件
    rm -rf /tmp/*; \
    rm -rf /var/tmp/*; \
    \
    echo "清理完成";

# 最终验证
RUN set -eux; \
    echo "========================================"; \
    echo "最终验证"; \
    echo "========================================"; \
    echo "PHP 版本:"; \
    php -v; \
    echo ""; \
    echo "已安装的扩展:"; \
    php -m; \
    echo ""; \
    echo "Composer 版本:"; \
    composer --version; \
    echo "========================================"; \
    echo "镜像构建完成！"; \
    echo "========================================";

# 设置工作目录
WORKDIR /opt/www

</code></pre>
<ul>
<li>该文件注释已标注在文档中</li>
<li>简要说明
<ul>
<li>执行该文件，会生成你指定的镜像名称和 tag 标签
<ul>
<li>使用多阶段构建模式，<strong>第一阶段：</strong> 安装 pecl 和 local 扩展；<strong>第二阶段：</strong> 构建最终镜像</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 data-id="heading-18">build.sh</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># =============================================================================</span>
<span class="hljs-comment"># PHP Docker 多阶段构建脚本</span>
<span class="hljs-comment"># 功能：根据配置文件自动构建 PHP 基础镜像和最终镜像</span>
<span class="hljs-comment"># 用法：./build.sh [最终镜像名称]</span>
<span class="hljs-comment"># =============================================================================</span>

<span class="hljs-built_in">set</span> -e  <span class="hljs-comment"># 遇到错误立即退出</span>

<span class="hljs-comment"># 颜色定义</span>
RED=<span class="hljs-string">'\033[0;31m'</span>
GREEN=<span class="hljs-string">'\033[0;32m'</span>
YELLOW=<span class="hljs-string">'\033[1;33m'</span>
BLUE=<span class="hljs-string">'\033[0;34m'</span>
NC=<span class="hljs-string">'\033[0m'</span> <span class="hljs-comment"># 无颜色</span>

<span class="hljs-comment"># 配置文件路径</span>
CONFIG_FILE=<span class="hljs-string">"./config/build.conf"</span>
SCRIPT_DIR=<span class="hljs-string">"<span class="hljs-subst">$(cd <span class="hljs-string">"<span class="hljs-subst">$(dirname <span class="hljs-string">"<span class="hljs-variable">${BASH_SOURCE[0]}</span>"</span>)</span>"</span> &amp;&amp; pwd)</span>"</span>

<span class="hljs-comment"># 日志函数</span>
<span class="hljs-function"><span class="hljs-title">log_info</span></span>() {
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${BLUE}</span>[INFO]<span class="hljs-variable">${NC}</span> <span class="hljs-subst">$(date '+%Y-%m-%d %H:%M:%S')</span> - <span class="hljs-variable">$1</span>"</span>
}

<span class="hljs-function"><span class="hljs-title">log_success</span></span>() {
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${GREEN}</span>[SUCCESS]<span class="hljs-variable">${NC}</span> <span class="hljs-subst">$(date '+%Y-%m-%d %H:%M:%S')</span> - <span class="hljs-variable">$1</span>"</span>
}

<span class="hljs-function"><span class="hljs-title">log_warn</span></span>() {
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${YELLOW}</span>[WARN]<span class="hljs-variable">${NC}</span> <span class="hljs-subst">$(date '+%Y-%m-%d %H:%M:%S')</span> - <span class="hljs-variable">$1</span>"</span>
}

<span class="hljs-function"><span class="hljs-title">log_error</span></span>() {
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${RED}</span>[ERROR]<span class="hljs-variable">${NC}</span> <span class="hljs-subst">$(date '+%Y-%m-%d %H:%M:%S')</span> - <span class="hljs-variable">$1</span>"</span>
}

<span class="hljs-comment"># 检查配置文件是否存在</span>
<span class="hljs-function"><span class="hljs-title">check_config_file</span></span>() {
    <span class="hljs-keyword">if</span> [ ! -f <span class="hljs-string">"<span class="hljs-variable">$CONFIG_FILE</span>"</span> ]; <span class="hljs-keyword">then</span>
        log_error <span class="hljs-string">"配置文件不存在: <span class="hljs-variable">$CONFIG_FILE</span>"</span>
        <span class="hljs-built_in">exit</span> 1
    <span class="hljs-keyword">fi</span>
    log_info <span class="hljs-string">"配置文件检查通过"</span>
}

<span class="hljs-comment"># 解析配置文件</span>
<span class="hljs-function"><span class="hljs-title">parse_config</span></span>() {
    <span class="hljs-built_in">local</span> section=<span class="hljs-string">""</span>
    <span class="hljs-built_in">local</span> key=<span class="hljs-string">""</span>
    
    <span class="hljs-keyword">while</span> IFS= <span class="hljs-built_in">read</span> -r line || [ -n <span class="hljs-string">"<span class="hljs-variable">$line</span>"</span> ]; <span class="hljs-keyword">do</span>
        <span class="hljs-comment"># 跳过空行和注释</span>
        [[ -z <span class="hljs-string">"<span class="hljs-variable">$line</span>"</span> || <span class="hljs-string">"<span class="hljs-variable">$line</span>"</span> =~ ^[[:space:]]*<span class="hljs-comment"># ]] &amp;&amp; continue</span>
        
        <span class="hljs-comment"># 检测 section</span>
        <span class="hljs-keyword">if</span> [[ <span class="hljs-string">"<span class="hljs-variable">$line</span>"</span> =~ ^\[(.+)\]$ ]]; <span class="hljs-keyword">then</span>
            section=<span class="hljs-string">"<span class="hljs-variable">${BASH_REMATCH[1]}</span>"</span>
            <span class="hljs-built_in">continue</span>
        <span class="hljs-keyword">fi</span>
        
        <span class="hljs-comment"># 读取配置值</span>
        <span class="hljs-keyword">if</span> [ -n <span class="hljs-string">"<span class="hljs-variable">$section</span>"</span> ]; <span class="hljs-keyword">then</span>
            <span class="hljs-keyword">case</span> <span class="hljs-string">"<span class="hljs-variable">$section</span>"</span> <span class="hljs-keyword">in</span>
                base_image)
                    BASE_IMAGE=<span class="hljs-string">"<span class="hljs-variable">$line</span>"</span>
                    ;;
                pecl)
                    PECL_EXTENSIONS+=(<span class="hljs-string">"<span class="hljs-variable">$line</span>"</span>)
                    ;;
                <span class="hljs-built_in">local</span>)
                    LOCAL_EXTENSIONS+=(<span class="hljs-string">"<span class="hljs-variable">$line</span>"</span>)
                    ;;
                mode)
                    BUILD_MODE=<span class="hljs-string">"<span class="hljs-variable">$line</span>"</span>
                    ;;
                custom_source)
                    CUSTOM_SOURCE=<span class="hljs-string">"<span class="hljs-variable">$line</span>"</span>
                    ;;
                composer_mirror)
                    COMPOSER_MIRROR=<span class="hljs-string">"<span class="hljs-variable">$line</span>"</span>
                    ;;
                php)
                    PHP_INI_CONFIGS+=(<span class="hljs-string">"<span class="hljs-variable">$line</span>"</span>)
                    ;;
                build_target)
                    BUILD_TARGET=<span class="hljs-string">"<span class="hljs-variable">$line</span>"</span>
                    ;;
                force_rebuild_base)
                    FORCE_REBUILD_BASE=<span class="hljs-string">"<span class="hljs-variable">$line</span>"</span>
                    ;;
            <span class="hljs-keyword">esac</span>
        <span class="hljs-keyword">fi</span>
    <span class="hljs-keyword">done</span> &lt; <span class="hljs-string">"<span class="hljs-variable">$CONFIG_FILE</span>"</span>
}

<span class="hljs-comment"># 检测系统类型（Alpine 或 Debian）</span>
<span class="hljs-function"><span class="hljs-title">detect_system_type</span></span>() {
    <span class="hljs-keyword">if</span> [[ <span class="hljs-string">"<span class="hljs-variable">$BASE_IMAGE</span>"</span> == *<span class="hljs-string">"alpine"</span>* ]]; <span class="hljs-keyword">then</span>
        SYSTEM_TYPE=<span class="hljs-string">"alpine"</span>
    <span class="hljs-keyword">else</span>
        SYSTEM_TYPE=<span class="hljs-string">"debian"</span>
    <span class="hljs-keyword">fi</span>
    log_info <span class="hljs-string">"检测到系统类型: <span class="hljs-variable">$SYSTEM_TYPE</span>"</span>
}

<span class="hljs-comment"># 生成基础镜像名称</span>
<span class="hljs-function"><span class="hljs-title">generate_base_image_name</span></span>() {
    <span class="hljs-built_in">local</span> version=$(<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$BASE_IMAGE</span>"</span> | grep -oP <span class="hljs-string">'php:\K[0-9]+\.[0-9]+'</span>)
    BASE_IMAGE_NAME=<span class="hljs-string">"php-base:<span class="hljs-variable">${version}</span>-<span class="hljs-variable">${SYSTEM_TYPE}</span>"</span>
    log_info <span class="hljs-string">"基础镜像名称: <span class="hljs-variable">$BASE_IMAGE_NAME</span>"</span>
}

<span class="hljs-comment"># 检查基础镜像是否存在</span>
<span class="hljs-function"><span class="hljs-title">check_base_image_exists</span></span>() {
    <span class="hljs-keyword">if</span> docker image inspect <span class="hljs-string">"<span class="hljs-variable">$BASE_IMAGE_NAME</span>"</span> &gt;/dev/null 2&gt;&amp;1; <span class="hljs-keyword">then</span>
        log_info <span class="hljs-string">"基础镜像已存在: <span class="hljs-variable">$BASE_IMAGE_NAME</span>"</span>
        <span class="hljs-built_in">return</span> 0
    <span class="hljs-keyword">else</span>
        log_info <span class="hljs-string">"基础镜像不存在，需要构建"</span>
        <span class="hljs-built_in">return</span> 1
    <span class="hljs-keyword">fi</span>
}

<span class="hljs-comment"># 构建基础镜像</span>
<span class="hljs-function"><span class="hljs-title">build_base_image</span></span>() {
    log_info <span class="hljs-string">"开始构建基础镜像..."</span>
    
    <span class="hljs-comment"># 构建参数</span>
    docker build \
        --file Dockerfile.base \
        --build-arg BASE_IMAGE=<span class="hljs-string">"<span class="hljs-variable">$BASE_IMAGE</span>"</span> \
        --build-arg SYSTEM_TYPE=<span class="hljs-string">"<span class="hljs-variable">$SYSTEM_TYPE</span>"</span> \
        --build-arg CUSTOM_SOURCE=<span class="hljs-string">"<span class="hljs-variable">$CUSTOM_SOURCE</span>"</span> \
        --tag <span class="hljs-string">"<span class="hljs-variable">$BASE_IMAGE_NAME</span>"</span> \
        --progress=plain \
        .
    
    <span class="hljs-keyword">if</span> [ $? -eq 0 ]; <span class="hljs-keyword">then</span>
        log_success <span class="hljs-string">"基础镜像构建成功: <span class="hljs-variable">$BASE_IMAGE_NAME</span>"</span>
    <span class="hljs-keyword">else</span>
        log_error <span class="hljs-string">"基础镜像构建失败"</span>
        <span class="hljs-built_in">exit</span> 1
    <span class="hljs-keyword">fi</span>
}

<span class="hljs-comment"># 构建最终镜像</span>
<span class="hljs-function"><span class="hljs-title">build_final_image</span></span>() {
    <span class="hljs-built_in">local</span> final_image_name=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
    
    <span class="hljs-keyword">if</span> [ -z <span class="hljs-string">"<span class="hljs-variable">$final_image_name</span>"</span> ]; <span class="hljs-keyword">then</span>
        log_error <span class="hljs-string">"请提供最终镜像名称"</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"用法: ./build.sh [最终镜像名称]"</span>
        <span class="hljs-built_in">exit</span> 1
    <span class="hljs-keyword">fi</span>
    
    log_info <span class="hljs-string">"开始构建最终镜像: <span class="hljs-variable">$final_image_name</span>"</span>
    
    <span class="hljs-comment"># 准备 PECL 扩展参数</span>
    <span class="hljs-built_in">local</span> pecl_extensions_arg=<span class="hljs-string">""</span>
    <span class="hljs-keyword">if</span> [ <span class="hljs-variable">${#PECL_EXTENSIONS[@]}</span> -gt 0 ]; <span class="hljs-keyword">then</span>
        pecl_extensions_arg=$(IFS=,; <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">${PECL_EXTENSIONS[*]}</span>"</span>)
    <span class="hljs-keyword">fi</span>
    
    <span class="hljs-comment"># 准备 LOCAL 扩展参数</span>
    <span class="hljs-built_in">local</span> local_extensions_arg=<span class="hljs-string">""</span>
    <span class="hljs-keyword">if</span> [ <span class="hljs-variable">${#LOCAL_EXTENSIONS[@]}</span> -gt 0 ]; <span class="hljs-keyword">then</span>
        local_extensions_arg=$(IFS=<span class="hljs-string">' '</span>; <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">${LOCAL_EXTENSIONS[*]}</span>"</span>)
    <span class="hljs-keyword">fi</span>
    
    <span class="hljs-comment"># 准备 PHP 配置参数</span>
    <span class="hljs-built_in">local</span> php_ini_arg=<span class="hljs-string">""</span>
    <span class="hljs-keyword">if</span> [ <span class="hljs-variable">${#PHP_INI_CONFIGS[@]}</span> -gt 0 ]; <span class="hljs-keyword">then</span>
        php_ini_arg=$(IFS=<span class="hljs-string">'|'</span>; <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">${PHP_INI_CONFIGS[*]}</span>"</span>)
    <span class="hljs-keyword">fi</span>
    
    <span class="hljs-comment"># 构建最终镜像</span>
    docker build \
        --file Dockerfile.final \
        --build-arg BASE_IMAGE_NAME=<span class="hljs-string">"<span class="hljs-variable">$BASE_IMAGE_NAME</span>"</span> \
        --build-arg SYSTEM_TYPE=<span class="hljs-string">"<span class="hljs-variable">$SYSTEM_TYPE</span>"</span> \
        --build-arg PECL_EXTENSIONS=<span class="hljs-string">"<span class="hljs-variable">$pecl_extensions_arg</span>"</span> \
        --build-arg LOCAL_EXTENSIONS=<span class="hljs-string">"<span class="hljs-variable">$local_extensions_arg</span>"</span> \
        --build-arg PHP_INI_CONFIGS=<span class="hljs-string">"<span class="hljs-variable">$php_ini_arg</span>"</span> \
        --build-arg COMPOSER_MIRROR=<span class="hljs-string">"<span class="hljs-variable">$COMPOSER_MIRROR</span>"</span> \
        --build-arg BUILD_MODE=<span class="hljs-string">"<span class="hljs-variable">$BUILD_MODE</span>"</span> \
        --tag <span class="hljs-string">"<span class="hljs-variable">$final_image_name</span>"</span> \
        --progress=plain \
        .
    
    <span class="hljs-keyword">if</span> [ $? -eq 0 ]; <span class="hljs-keyword">then</span>
        log_success <span class="hljs-string">"最终镜像构建成功: <span class="hljs-variable">$final_image_name</span>"</span>
        log_info <span class="hljs-string">"镜像信息:"</span>
        docker images | grep <span class="hljs-string">"<span class="hljs-variable">$final_image_name</span>"</span>
    <span class="hljs-keyword">else</span>
        log_error <span class="hljs-string">"最终镜像构建失败"</span>
        <span class="hljs-built_in">exit</span> 1
    <span class="hljs-keyword">fi</span>
}

<span class="hljs-comment"># 主函数</span>
<span class="hljs-function"><span class="hljs-title">main</span></span>() {
    log_info <span class="hljs-string">"=========================================="</span>
    log_info <span class="hljs-string">"PHP Docker 多阶段构建开始"</span>
    log_info <span class="hljs-string">"=========================================="</span>
    
    <span class="hljs-comment"># 初始化变量</span>
    BASE_IMAGE=<span class="hljs-string">""</span>
    PECL_EXTENSIONS=()
    LOCAL_EXTENSIONS=()
    BUILD_MODE=<span class="hljs-string">"dev"</span>
    CUSTOM_SOURCE=<span class="hljs-string">"false"</span>
    COMPOSER_MIRROR=<span class="hljs-string">"auto"</span>
    PHP_INI_CONFIGS=()
    BUILD_TARGET=<span class="hljs-string">"all"</span>
    FORCE_REBUILD_BASE=<span class="hljs-string">"false"</span>
    SYSTEM_TYPE=<span class="hljs-string">""</span>
    BASE_IMAGE_NAME=<span class="hljs-string">""</span>
    
    <span class="hljs-comment"># 检查配置文件</span>
    check_config_file
    
    <span class="hljs-comment"># 解析配置</span>
    log_info <span class="hljs-string">"开始解析配置文件..."</span>
    parse_config
    
    <span class="hljs-comment"># 检测系统类型</span>
    detect_system_type
    
    <span class="hljs-comment"># 生成基础镜像名称</span>
    generate_base_image_name
    
    <span class="hljs-comment"># 显示配置信息</span>
    log_info <span class="hljs-string">"=========================================="</span>
    log_info <span class="hljs-string">"配置信息:"</span>
    log_info <span class="hljs-string">"  基础镜像: <span class="hljs-variable">$BASE_IMAGE</span>"</span>
    log_info <span class="hljs-string">"  系统类型: <span class="hljs-variable">$SYSTEM_TYPE</span>"</span>
    log_info <span class="hljs-string">"  基础镜像名称: <span class="hljs-variable">$BASE_IMAGE_NAME</span>"</span>
    log_info <span class="hljs-string">"  PECL 扩展: <span class="hljs-variable">${PECL_EXTENSIONS[*]}</span>"</span>
    log_info <span class="hljs-string">"  LOCAL 扩展: <span class="hljs-variable">${LOCAL_EXTENSIONS[*]}</span>"</span>
    log_info <span class="hljs-string">"  构建模式: <span class="hljs-variable">$BUILD_MODE</span>"</span>
    log_info <span class="hljs-string">"  自定义源: <span class="hljs-variable">$CUSTOM_SOURCE</span>"</span>
    log_info <span class="hljs-string">"  Composer 镜像: <span class="hljs-variable">$COMPOSER_MIRROR</span>"</span>
    log_info <span class="hljs-string">"  构建目标: <span class="hljs-variable">$BUILD_TARGET</span>"</span>
    log_info <span class="hljs-string">"  强制重建基础镜像: <span class="hljs-variable">$FORCE_REBUILD_BASE</span>"</span>
    log_info <span class="hljs-string">"=========================================="</span>
    
    <span class="hljs-comment"># 根据构建目标执行</span>
    <span class="hljs-keyword">case</span> <span class="hljs-string">"<span class="hljs-variable">$BUILD_TARGET</span>"</span> <span class="hljs-keyword">in</span>
        base)
            log_info <span class="hljs-string">"构建目标: 仅构建基础镜像"</span>
            build_base_image
            ;;
        final)
            log_info <span class="hljs-string">"构建目标: 仅构建最终镜像"</span>
            <span class="hljs-keyword">if</span> ! check_base_image_exists; <span class="hljs-keyword">then</span>
                log_error <span class="hljs-string">"基础镜像不存在，请先构建基础镜像"</span>
                <span class="hljs-built_in">exit</span> 1
            <span class="hljs-keyword">fi</span>
            build_final_image <span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
            ;;
        all)
            log_info <span class="hljs-string">"构建目标: 构建基础镜像和最终镜像"</span>
            <span class="hljs-comment"># 检查是否需要构建基础镜像</span>
            <span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$FORCE_REBUILD_BASE</span>"</span> = <span class="hljs-string">"true"</span> ]; <span class="hljs-keyword">then</span>
                log_warn <span class="hljs-string">"强制重新构建基础镜像"</span>
                build_base_image
            <span class="hljs-keyword">else</span>
                <span class="hljs-keyword">if</span> check_base_image_exists; <span class="hljs-keyword">then</span>
                    log_info <span class="hljs-string">"基础镜像已存在，跳过构建"</span>
                <span class="hljs-keyword">else</span>
                    build_base_image
                <span class="hljs-keyword">fi</span>
            <span class="hljs-keyword">fi</span>
            build_final_image <span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
            ;;
        *)
            log_error <span class="hljs-string">"无效的构建目标: <span class="hljs-variable">$BUILD_TARGET</span>"</span>
            <span class="hljs-built_in">exit</span> 1
            ;;
    <span class="hljs-keyword">esac</span>
    
    log_success <span class="hljs-string">"=========================================="</span>
    log_success <span class="hljs-string">"构建流程完成！"</span>
    log_success <span class="hljs-string">"=========================================="</span>
}

<span class="hljs-comment"># 执行主函数</span>
main <span class="hljs-string">"<span class="hljs-variable">$@</span>"</span>
</code></pre>
<ul>
<li>该文件是解析配置文件及控制构建情况的文件</li>
</ul>
<h4 data-id="heading-19">执行构建</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">进入项目目录</span>
cd project
<span class="hljs-meta prompt_">
# </span><span class="bash">添加文件执行权限</span>
chmod +x ./build.sh
<span class="hljs-meta prompt_">
# </span><span class="bash">执行构建</span>
./build.sh 新的镜像名称
</code></pre>
<h4 data-id="heading-20">结语</h4>
<p>该份套餐可以做到：</p>
<ul>
<li>构建逻辑通用：不同版本、不同扩展的构建只需要修改 build.conf 配置文件</li>
<li>扩展自由度高：可自由增减扩展信息，可指定版本，也可不指定，不指定时安装最新版本</li>
<li>构建模式切换：分为 prod/dev，prod 构建会清楚构建缓存等信息，减少镜像体积；dev模式不会，方便多次构建，减少构建时间</li>
<li>自定义系统依赖源：自由配置是否使用自定义系统依赖源，减少构建成功率和构建速度</li>
<li>自定义php配置：不同的开发需求，可能需要不通过的php配置，可以自由配置，构建后覆盖原有的默认配置</li>
<li>构建目标自由：可自由配置构建 基础镜像(base)、最终镜像(final)、基础+最终(all)</li>
<li>系统依赖自动检测：可根据配置的基础镜像，自动识别镜像系统（debian/alpine）、并安装对应的依赖，如：系统依赖、系统工具等</li>
<li>GD 扩展自动配置：如果 local 扩展中存在 GD 扩展，则自动做扩展特殊配置</li>
<li>镜像名称自定义：基础镜像名称自动生成，最终镜像名称可以自由定义</li>
<li>扩展安装重试机制：安装扩展容易因为各种原因失败，追加重试机制（3次）减少失败次数</li>
</ul>
<p>okk，提升到此结束，又可以愉快的做牛马了 ... ... ...</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入Android系统（十三）Android的窗口系统]]></title>    <link>https://juejin.cn/post/7575106644499578914</link>    <guid>https://juejin.cn/post/7575106644499578914</guid>    <pubDate>2025-11-23T13:16:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575106644499578914" data-draft-id="7575363120798466048" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入Android系统（十三）Android的窗口系统"/> <meta itemprop="keywords" content="Android,源码,设计模式"/> <meta itemprop="datePublished" content="2025-11-23T13:16:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="apigfly"/> <meta itemprop="url" content="https://juejin.cn/user/2488950054453613"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入Android系统（十三）Android的窗口系统
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2488950054453613/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    apigfly
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T13:16:04.000Z" title="Sun Nov 23 2025 13:16:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读19分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>Android</code>的窗口系统由<code>WindowManagerService</code>管理，包括增加和删除窗口，确定窗口的大小和位置，以及实现窗口切换、窗口动画等功能。<code>WindowManagerService</code>名字较长，后面简称<code>WMS</code></p>
<h2 data-id="heading-0">前言</h2>
<blockquote>
<p>一个小问题</p>
</blockquote>
<p>在 Android 中<code>Activity</code>可以理解成 Android 中的一个页面，前面的章节我们说 <code>SurfaceFlinger</code> 最后会把 <code>Surface</code> 对应的 <code>Layer</code> 合成到屏幕上。那么<strong>Activity 和 Surface 的关系又是怎么关联的呢？</strong></p>
<p>让我们一起排查下～～～</p>
<h2 data-id="heading-1">应用进程和<code>WMS</code>的联系</h2>
<p>在学习<code>WMS</code>之前，我们先了解下应用和<code>WMS</code>之间的联系。对于应用来说：</p>
<ul>
<li>
<p><code>Activity</code></p>
<ul>
<li><code>Activity</code>并不负责视图控制，它只是控制生命周期和处理事件</li>
<li>真正控制视图的是<code>Window</code>。一个<code>Activity</code>包含了一个<code>Window</code>，<code>Window</code>才是真正代表一个窗口</li>
<li><code>Activity</code>就像一个控制器，统筹视图的添加与显示，以及通过其他回调方法，来与<code>Window</code>、以及<code>View</code>进行交互</li>
</ul>
</li>
<li>
<p><code>Window</code></p>
<ul>
<li><code>Window</code>是视图的承载器，内部持有一个<code>DecorView</code>，而这个<code>DecorView</code>才是<code>view</code>的根布局</li>
<li><code>Window</code>是一个抽象类，实际在<code>Activity</code>中持有的是其子类<code>PhoneWindow</code></li>
<li><code>PhoneWindow</code>中有个内部类<code>DecorView</code>，通过创建<code>DecorView</code>来加载<code>Activity</code>中``传递的布局</li>
<li><code>Window</code>通过<code>WindowManager</code>将<code>DecorView</code>加载其中，并将<code>DecorView</code>交给<code>ViewRoot</code>，进行视图绘制以及其他交互</li>
</ul>
</li>
<li>
<p><code>ViewRoot</code></p>
<ul>
<li>所有<code>View</code>的绘制以及事件分发等交互都是通过它来执行或传递的</li>
<li><code>ViewRoot</code>对应的实现类是<code>ViewRootImpl</code>类，它是连接<code>WindowManagerService</code>和<code>DecorView</code>的纽带</li>
<li><code>View</code>的三大流程：测量(measure)、布局(layout)、绘制 (draw))均通过<code>ViewRoot</code>来完成</li>
</ul>
</li>
</ul>
<p>除了上面这三部分，还有一个是在<code>Android</code>应用中存在的一个唯一的<code>WindowManagerGlobal</code>对象，它们的类图关系如下：<br/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d3f91ffc402e497986337eba12df2b94~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYXBpZ2ZseQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764508564&amp;x-signature=vkLls2NZ4xOy1Jgqwi5BfD6K2Os%3D" alt="image" loading="lazy"/></p>
<h3 data-id="heading-2">应用中的Window对象</h3>
<p>应用中的每个<code>Activity</code>对象都有一个类型为<code>Window</code>的成员变量<code>mWindow</code>，定义如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Activity</span> {
    ...
    <span class="hljs-keyword">private</span> Window mWindow;
    ...
}
</code></pre>
<p><code>Window</code>对象在应用进程代表了一个窗口，这是一块矩形的图像绘制区域。</p>
<p>从<code>WMS</code>的角度来说，它并不关系应用中的各种<code>View</code>，他管理和调度的对象是<code>Window</code>。<code>Activity</code>中的<code>View</code>树不管多复杂，最后输出的也仅仅是一张各个<code>View</code>合成的图像而已。</p>
<p><code>Window</code>是一个抽象类，在<code>Activity</code>类的<code>attach()</code>方法中会对成员变量<code>mWindow</code>进行初始化，代码如下：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">attach</span><span class="hljs-params">(...)</span> {
        ...
        mWindow = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PhoneWindow</span>(<span class="hljs-built_in">this</span>, window, activityConfigCallback);
        ...
    }
</code></pre>
<p><code>attach()</code>方法中<code>mWindow</code>实例化成了一个<code>PhoneWindow</code>对象。</p>
<p>而对于<code>PhoneWindow</code>对象，需要我们关注的部分是如下两个成员变量：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PhoneWindow</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Window</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MenuBuilder</span>.Callback {
    <span class="hljs-comment">// This is the top-level view of the window, containing the window decor.</span>
    <span class="hljs-keyword">private</span> DecorView mDecor;
    <span class="hljs-comment">// This is the view in which the window contents are placed. It is either</span>
    <span class="hljs-comment">// mDecor itself, or a child of mDecor where the contents go.</span>
    ViewGroup mContentParent;
    ...
}
</code></pre>
<ul>
<li>
<p><code>mDecor</code>的类型是<code>DecorView</code>，它是<code>FrameLayout</code>的子类，它可以被认为是<code>Android</code>视图树的根节点视图。</p>
<ul>
<li><code>DecorView</code>作为顶级<code>View</code>，它加载的资源文件内部会包含一个<code>android:id="@android:id/content"</code>的<code>ViewGroup</code></li>
<li>这个<code>ViewGroup</code>便是后面用来添加<code>setContentView()</code>方法传入的<code>layout</code>布局文件</li>
<li><code>DecorView</code>具体加载哪种布局文件和主题有关，这部分在<code>PhoneWindow</code>的<code>generateLayout()</code>方法中体现</li>
</ul>
</li>
<li>
<p><code>mContentParent</code>的类型是<code>ViewGroup</code>，它其实就是<code>android:id="@android:id/content"</code>对应的组件</p>
<ul>
<li>跟踪<code>generateLayout()</code>方法就会发现如下代码：</li>
</ul>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-type">ViewGroup</span> <span class="hljs-variable">contentParent</span> <span class="hljs-operator">=</span> (ViewGroup)findViewById(ID_ANDROID_CONTENT);
</code></pre>
<ul>
<li><code>contentParent</code>创建完成后便会赋值给<code>mContentParent</code>，而此处的<code>ID_ANDROID_CONTENT</code>的定义是在<code>Window.java</code>中</li>
</ul>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">ID_ANDROID_CONTENT</span> <span class="hljs-operator">=</span> com.android.internal.R.id.content;
</code></pre>
</li>
</ul>
<h3 data-id="heading-3">应用中的WindowManager对象</h3>
<p>应用中的每个<code>Activity</code>对象都有一个类型为<code>WindowManager</code>的成员变量<code>mWindowManager</code>，定义如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Activity</span> {
    ...
    <span class="hljs-keyword">private</span> WindowManager mWindowManager;
    ...
}
</code></pre>
<p><code>mWindowManager</code>用于和<code>WMS</code>通信，不过<code>WindowManager</code>是一个接口类，定义如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">WindowManager</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ViewManager</span> {...}
</code></pre>
<p><code>mWindowManager</code>也是在<code>attach()</code>方法中进行的初始化，相关代码如下：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">attach</span><span class="hljs-params">(...)</span> {
        ...
        mWindow = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PhoneWindow</span>(<span class="hljs-built_in">this</span>, window, activityConfigCallback);
        ...
        mWindow.setWindowManager(
                (WindowManager)context.getSystemService(Context.WINDOW_SERVICE),
                mToken, mComponent.flattenToString(),
                (info.flags &amp; ActivityInfo.FLAG_HARDWARE_ACCELERATED) != <span class="hljs-number">0</span>);
        ...
        mWindowManager = mWindow.getWindowManager();
        ...
    }
</code></pre>
<p>在<code>attach()</code>方法中，对<code>mWindowManager</code>变量的赋值是调用<code>mWindow</code>的<code>getWindowManager()</code>方法完成的。</p>
<p>但是在这之前，<code>attach()</code>方法中还调用了<code>mWindow</code>对象的<code>setWindowManager()</code>方法。前面我们已经知道<code>mWindow</code>对象的类型是<code>PhoneWindow</code>，不过这个<code>setWindowManager()</code>方法是在基类<code>Window</code>中实现的，代码如下：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setWindowManager</span><span class="hljs-params">(WindowManager wm, IBinder appToken, String appName,
            <span class="hljs-type">boolean</span> hardwareAccelerated)</span> {
        mAppToken = appToken;
        mAppName = appName;
        mHardwareAccelerated = hardwareAccelerated
                || SystemProperties.getBoolean(PROPERTY_HARDWARE_UI, <span class="hljs-literal">false</span>);
        <span class="hljs-keyword">if</span> (wm == <span class="hljs-literal">null</span>) {
            wm = (WindowManager)mContext.getSystemService(Context.WINDOW_SERVICE);
        }
        mWindowManager = ((WindowManagerImpl)wm).createLocalWindowManager(<span class="hljs-built_in">this</span>);
    }
    <span class="hljs-keyword">public</span> WindowManager <span class="hljs-title function_">getWindowManager</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> mWindowManager;
    }
</code></pre>
<p>在<code>setWindowManager()</code>方法中，调用了<code>WindowManagerImpl</code>类的<code>createLocalWindowManager()</code>方法创建了<code>mWindowManager</code>对象，这个方法也很简单：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> WindowManagerImpl <span class="hljs-title function_">createLocalWindowManager</span><span class="hljs-params">(Window parentWindow)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WindowManagerImpl</span>(mContext, parentWindow);
    }
</code></pre>
<p><code>createLocalWindowManager()</code>方法中新创建了一个<code>WindowManagerImpl</code>对象，因此，每个<code>Activity</code>中的<code>mWindowManager</code>对象实际上是一个<code>WindowManagerImpl</code>对象，我们再看下这个类的定义：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WindowManagerImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WindowManager</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">WindowManagerGlobal</span> <span class="hljs-variable">mGlobal</span> <span class="hljs-operator">=</span> WindowManagerGlobal.getInstance();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Context mContext;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Window mParentWindow;
    ...
}
</code></pre>
<p>在<code>WindowManagerImpl</code>中定义了一个<code>mGlobal</code>变量，它的值是通过<code>WindowManagerGlobal.getInstance()</code>得到的，看样子是个单例模式，代码如下：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> WindowManagerGlobal <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">synchronized</span> (WindowManagerGlobal.class) {
            <span class="hljs-keyword">if</span> (sDefaultWindowManager == <span class="hljs-literal">null</span>) {
                sDefaultWindowManager = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WindowManagerGlobal</span>();
            }
            <span class="hljs-keyword">return</span> sDefaultWindowManager;
        }
    }
</code></pre>
<p><code>getInstance()</code>方法中创建了一个全局唯一的<code>WindowManagerGlobal</code>对象并保存到静态变量<code>sDefaultWindowManager</code>中</p>
<p>而<code>WindowManagerImpl</code>中各种方法的实现只是在转调<code>WindowManagerGlobal</code>类中的方法，由此可见，<strong>一个应用中所有<code>Activity</code>都是通过这个进程内唯一的<code>WindowManagerGlobal</code>对象和<code>WMS</code>通信</strong></p>
<p><code>WindowManagerGlobal</code>类中还有3个重要的成员变量：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WindowManagerGlobal</span> {
    ...
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ArrayList&lt;View&gt; mViews = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;View&gt;();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ArrayList&lt;ViewRootImpl&gt; mRoots = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;ViewRootImpl&gt;();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ArrayList&lt;WindowManager.LayoutParams&gt; mParams =
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;WindowManager.LayoutParams&gt;();
    ...
}
</code></pre>
<ul>
<li><code>mViews</code>：保存了应用中所有顶层<code>View</code>对象，也就是<code>DecorView</code>(稍后细讲)</li>
<li><code>mRoots</code>：保存的是和顶层<code>View</code>对象关联的<code>ViewRootImpl</code>对象</li>
<li><code>mParams</code>：保存的是创建顶层<code>View</code>的<code>layout</code>参数</li>
</ul>
<h3 data-id="heading-4">建立应用和WMS的联系</h3>
<p>我们知道在<code>ActivityThread</code>中的<code>handleResumeActivity()</code>中会创建<code>ViewRootImpl</code>对象并进行显示，我们来看下<code>ViewRootImpl</code>中关键的几个变量：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewRootImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ViewParent</span>,
        View.AttachInfo.Callbacks, ThreadedRenderer.DrawCallbacks {
    ...
    <span class="hljs-keyword">final</span> IWindowSession mWindowSession;
    ...
    <span class="hljs-keyword">final</span> W mWindow;
    ...
}
</code></pre>
<p>变量的初始化是在构造方法中，代码如下：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ViewRootImpl</span><span class="hljs-params">(Context context, Display display)</span> {
        mContext = context;
        mWindowSession = WindowManagerGlobal.getWindowSession();
        ...
        mWindow = <span class="hljs-keyword">new</span> <span class="hljs-title class_">W</span>(<span class="hljs-built_in">this</span>);
        ...
    }
</code></pre>
<p>重点是进行了<code>mWindowSession</code>和<code>mWindow</code>的创建，我们逐一看下</p>
<h4 data-id="heading-5">IWindowSession对象的创建</h4>
<p><code>mWindowSession</code>变量的类型是<code>IWindowSession</code>，它是<code>WMS</code>中某个<code>Binder</code>对象的引用对象，<code>mWindowSession</code>的值是通过<code>WindowManagerGlobal</code>的<code>getWindowSession()</code>方法获得的，代码如下：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> IWindowSession <span class="hljs-title function_">getWindowSession</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">synchronized</span> (WindowManagerGlobal.class) {
            <span class="hljs-keyword">if</span> (
            `sWindowSession`== <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-type">InputMethodManager</span> <span class="hljs-variable">imm</span> <span class="hljs-operator">=</span> InputMethodManager.getInstance();
                    <span class="hljs-type">IWindowManager</span> <span class="hljs-variable">windowManager</span> <span class="hljs-operator">=</span> getWindowManagerService();
                    sWindowSession = windowManager.openSession(
                            <span class="hljs-keyword">new</span> <span class="hljs-title class_">IWindowSessionCallback</span>.Stub() {
                                <span class="hljs-meta">@Override</span>
                                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAnimatorScaleChanged</span><span class="hljs-params">(<span class="hljs-type">float</span> scale)</span> {
                                    ValueAnimator.setDurationScale(scale);
                                }
                            },
                            imm.getClient(), imm.getInputContext());
                } <span class="hljs-keyword">catch</span> (RemoteException e) {
                    <span class="hljs-keyword">throw</span> e.rethrowFromSystemServer();
                }
            }
            <span class="hljs-keyword">return</span> sWindowSession;
        }
    }
</code></pre>
<p>如果<code>sWindowSession</code>为空，先获取<code>InputMethodManager</code>对象，然后调用<code>WMS</code>的<code>openSession()</code>接口来进行创建，代码如下：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> IWindowSession <span class="hljs-title function_">openSession</span><span class="hljs-params">(IWindowSessionCallback callback, IInputMethodClient client,
            IInputContext inputContext)</span> {
        <span class="hljs-keyword">if</span> (client == <span class="hljs-literal">null</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"null client"</span>);
        <span class="hljs-keyword">if</span> (inputContext == <span class="hljs-literal">null</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"null inputContext"</span>);
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Session</span>(<span class="hljs-built_in">this</span>, callback, client, inputContext);
        <span class="hljs-keyword">return</span> session;
    }
</code></pre>
<p><code>openSession()</code>直接创建了一个<code>Session</code>对象，这个<code>Session</code>类我们<a href="https://juejin.cn/post/6944960866404007944#heading-5" target="_blank" title="https://juejin.cn/post/6944960866404007944#heading-5">图像显示部分</a>简单介绍过，它是一个<code>Binder</code>服务类，简要定义如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Session</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IWindowSession</span>.Stub <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IBinder</span>.DeathRecipient {...}
</code></pre>
<p>对于用户进程而言，获取到的便是这个<code>Session</code>对象的<code>Binder</code>引用对象，并保存在了<code>WindowManagerGlobal</code>的静态变量<code>sWindowSession</code>中。</p>
<p>因为<code>WindowManagerGlobal</code>在进程中属于单例的存在，因此，所有调用<code>getWindowSession()</code>方法返回的都是这个<code>sWindowSession</code>对象</p>
<p>因此，<strong>一个用户进程中的所有<code>ViewRootImpl</code>对象中的<code>mWindowSession</code>都引用的是相同的对象</strong>。而这个<code>mWindowSession</code>对象的作用便是向<code>WMS</code>发起<code>Window</code>相关的<code>Binder</code>调用</p>
<blockquote>
<p>应用进程通过<code>sWindowSession</code>对象可以调用到<code>WMS</code>的功能方法了，那么<code>WMS</code>是如何通知或者控制应用进程的呢？</p>
</blockquote>
<h4 data-id="heading-6">W</h4>
<p>在<a href="https://juejin.cn/post/6944960866404007944#heading-5" target="_blank" title="https://juejin.cn/post/6944960866404007944#heading-5">图像显示部分</a>已经介绍过<code>ActivityThread</code>的<code>handleResumeActivity()</code>方法了，最后会调用到<code>WindowManagerGlobal</code>对象的<code>addView()</code>方法，方法内容如下：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addView</span><span class="hljs-params">(View view, ViewGroup.LayoutParams params,
            Display display, Window parentWindow)</span> {
        ...
        ViewRootImpl root;
        <span class="hljs-type">View</span> <span class="hljs-variable">panelParentView</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">synchronized</span> (mLock) {
            ...
            root = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ViewRootImpl</span>(view.getContext(), display);
            view.setLayoutParams(wparams);

            mViews.add(view);
            mRoots.add(root);
            mParams.add(wparams);

            <span class="hljs-keyword">try</span> {
                root.setView(view, wparams, panelParentView);
            }
            ...
        }
    }
</code></pre>
<p><code>addView()</code>方法中最重要的是创建了<code>ViewRootImpl</code>对象，并通过<code>setView()</code>把它和顶层的<code>View</code>对象关联在了一起。<code>setView()</code>方法简要如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setView</span><span class="hljs-params">(View view, WindowManager.LayoutParams attrs, View panelParentView)</span> {
    <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) {
        <span class="hljs-keyword">if</span> (mView == <span class="hljs-literal">null</span>) {
            mView = view;
            ...
            requestLayout();
            ...
            <span class="hljs-keyword">try</span> {
                mOrigWindowType = mWindowAttributes.type;
                mAttachInfo.mRecomputeGlobalAttributes = <span class="hljs-literal">true</span>;
                collectViewAttributes();
                res = mWindowSession.addToDisplay(mWindow, ...);
            }
            ...
        }
    }
}
</code></pre>
<p><code>setView()</code>方法比较长，我们需要关注的是：</p>
<ul>
<li>方法中对<code>ViewRootImpl</code>对象和顶层<code>View</code>之间的关联只会执行一次，如果<code>mView</code>不为空，不会再次赋值</li>
<li>方法中调用了<code>Session</code>的<code>addToDisplay()</code>方法，更为重要的是参数<code>mWindow</code></li>
</ul>
<p><code>mWindow</code>的类型是<code>W</code>，它是一个<code>ViewRootImpl</code>的静态内部类，定义如下：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">W</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IWindow</span>.Stub {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> WeakReference&lt;ViewRootImpl&gt; mViewAncestor;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> IWindowSession mWindowSession;
        ...
    }
</code></pre>
<p>可以看出<code>W</code>是一个实现了<code>IWindow</code>接口的<code>Binder</code>服务类，并且在<code>ViewRootImpl</code>中通过<code>Session.addToDisplay()</code>方法将<code>W</code>的<code>Binder</code>引用对象传递给了<code>WMS</code></p>
<p>我们看下源码中对<code>IWindow</code>接口的描述：</p>
<blockquote>
<p>API back to a client window that the Window Manager uses to inform it of interesting things happening.</p>
</blockquote>
<p>可以看出<code>WMS</code>通过<code>IWindow</code>接口来通知应用，接下来看下<code>WMS</code>中是如何处理这个对象的</p>
<p><em><strong>秋地麻袋～，还记得我们前言中的问题吗，快看<code>setView</code>中的<code>requestLayout</code>方法</strong></em></p>
<blockquote>
<p>是不是勾起了作为应用开发者的回忆</p>
</blockquote>
<h4 data-id="heading-7">Surface 和 Activity 的联系</h4>
<p><code>ViewRootImpl.setView()</code> 会触发 <code>requestLayout()</code>，最终执行到核心方法 <code>performTraversals()</code>（这是 View 绘制三大流程 Measure/Layout/Draw 的入口）</p>
<p><code>performTraversals()</code> 800 多行。。。简要代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 伪代码逻辑 ViewRootImpl.java</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">performTraversals</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// ...</span>
    <span class="hljs-comment">// 1. 通过 IPC 请求 WindowManagerService (WMS) 对窗口进行布局</span>
    <span class="hljs-comment">// mSurface 是 ViewRootImpl 的成员变量</span>
    relayoutResult = mWindowSession.relayout(..., mSurface, ...);

    <span class="hljs-comment">// 2. WMS 在底层创建 SurfaceControl，并将 Native 层的 Surface 信息</span>
    <span class="hljs-comment">// 回写（Copy）到 ViewRootImpl 的 mSurface 中。</span>
    <span class="hljs-comment">// 后面会细讲</span>
    
    <span class="hljs-keyword">if</span> (mSurface.isValid()) {
        <span class="hljs-comment">// Surface 此时已经准备好，可以合成了</span>
    }
    <span class="hljs-comment">// ...</span>
    performMeasure(...);
    performLayout(...);
    performDraw(...);
}
</code></pre>
<p>在 <code>relayout</code> 过程中，<code>WMS</code> 会与 <code>SurfaceFlinger</code> 通信，分配 <code>Layer</code>（图层）。<code>WMS</code> 将生成的 <code>Surface</code> 信息填充到 <code>ViewRootImpl</code> 传入的 <code>mSurface</code> 参数中。</p>
<blockquote>
<p>这样，一个 Activity 就和 SurfaceFlinger 中的 Surface 产生了关联啦。</p>
</blockquote>
<p><span id="user-content-WMS2APP"/></p>
<h3 data-id="heading-8">WMS中建立和应用的关系</h3>
<p>前面提到<code>ViewRootImpl</code>对象会通过<code>addToDisplay()</code>方法将<code>IWindow</code>的<code>Binder</code>引用对象传递到<code>WMS</code>中，我们先看下<code>addToDisplay()</code>方法：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-comment">// 方法定义在 com.android.server.wm.Session 中</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">addToDisplay</span><span class="hljs-params">(IWindow window, ...)</span> {
        <span class="hljs-comment">// mService 的类型便是 WindowManagerService</span>
        <span class="hljs-keyword">return</span> mService.addWindow(<span class="hljs-built_in">this</span>, window, ...);
    }
</code></pre>
<p>调用了<code>WMS</code>的<code>addWindow()</code>方法，代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">addWindow</span><span class="hljs-params">(Session session, IWindow client, ...)</span> {
    ...
    <span class="hljs-keyword">synchronized</span>(mWindowMap) {
        ...
        <span class="hljs-keyword">if</span> (mWindowMap.containsKey(client.asBinder())) {
            Slog.w(TAG_WM, <span class="hljs-string">"Window "</span> + client + <span class="hljs-string">" is already added"</span>);
            <span class="hljs-keyword">return</span> WindowManagerGlobal.ADD_DUPLICATE_ADD;
        }
        ...
        <span class="hljs-keyword">final</span> <span class="hljs-type">WindowState</span> <span class="hljs-variable">win</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WindowState</span>(<span class="hljs-built_in">this</span>, session, client, token, parentWindow,
                appOp[<span class="hljs-number">0</span>], seq, attrs, viewVisibility, session.mUid,
                session.mCanAddInternalSystemWindow);
        ...
        win.attach();
        mWindowMap.put(client.asBinder(), win);
        win.initAppOpsState();
        ...
    }
    ...
    <span class="hljs-keyword">return</span> res;
}
</code></pre>
<p><code>addWindow()</code>方法代码在200多行，此处我们需要关注的部分是：</p>
<ul>
<li>创建了<code>WindowState</code>对象并添加到<code>mWindowMap</code>集合中</li>
<li>调用<code>WindowState</code>对象的<code>attach()</code>方法</li>
</ul>
<p><code>WindowState</code>后面会详细介绍，此处的关键定义如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/** A window in the window manager. */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">WindowState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WindowContainer</span>&lt;WindowState&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WindowManagerPolicy</span>.WindowState {
    ...
    <span class="hljs-keyword">final</span> Context mContext;
    <span class="hljs-keyword">final</span> Session mSession;
    <span class="hljs-keyword">final</span> IWindow mClient;
    ...
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">attach</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (localLOGV) Slog.v(TAG, <span class="hljs-string">"Attaching "</span> + <span class="hljs-built_in">this</span> + <span class="hljs-string">" token="</span> + mToken);
        mSession.windowAddedLocked(mAttrs.packageName);
    }
}
</code></pre>
<ul>
<li><code>mClient</code>是应用进程中<code>Binder</code>服务对象<code>W</code>的引用对象</li>
<li><code>mSession</code>便是<code>WMS</code>对外封装的对象之一。以前面的<code>addToDisplay()</code>为例，实际上只是转调了<code>WMS</code>的<code>addWindow()</code>方法</li>
<li><code>attach()</code>方法也只是调用了<code>mSession</code>对象的<code>windowAddedLocked()</code>方法</li>
</ul>
<p>继续看下<code>windowAddedLocked()</code>方法:</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">void</span> <span class="hljs-title function_">windowAddedLocked</span><span class="hljs-params">(String packageName)</span> {
        mPackageName = packageName;
        mRelayoutTag = <span class="hljs-string">"relayoutWindow: "</span> + mPackageName;
        <span class="hljs-keyword">if</span> (mSurfaceSession == <span class="hljs-literal">null</span>) {
            mSurfaceSession = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SurfaceSession</span>();
            mService.mSessions.add(<span class="hljs-built_in">this</span>);
            <span class="hljs-keyword">if</span> (mLastReportedAnimatorScale != mService.getCurrentAnimatorScale()) {
                mService.dispatchNewAnimatorScaleLocked(<span class="hljs-built_in">this</span>);
            }
        }
        mNumWindow++;
    }
</code></pre>
<p><code>windowAddedLocked()</code>方法</p>
<ul>
<li>首先检查了<code>mSurfaceSession</code>的值，当为空时才会创建<code>SurfaceSession</code>对象
<ul>
<li>前面<a href="https://juejin.cn/post/6944960866404007944#heading-7" target="_blank" title="https://juejin.cn/post/6944960866404007944#heading-7">图像显示</a>部分介绍过，<code>SurfaceSession</code>对象是用来创建<code>Surface</code>的</li>
</ul>
</li>
<li>然后将<code>Session</code>对象本身添加到<code>WMS</code>的<code>mSessions</code>列表中</li>
</ul>
<p>到这里，应用进程就和<code>WMS</code>各自持有了对方的<code>Binder</code>引用对象，形成了一个双向<code>Binder</code>通道，示意图如下：<br/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c770d89efe34906bf922df504d858aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYXBpZ2ZseQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764508564&amp;x-signature=NaEwJ3G6o3LRkFsTlJKCfHjPwjA%3D" alt="image" loading="lazy"/></p>
<h3 data-id="heading-9">DecorView</h3>
<p>关于<code>DecorView</code>，还是要从我们最熟悉的地方说起。</p>
<p>在<code>Activity</code>的<code>onCreate()</code>中调用<code>setContentView()</code>方法时，我们看下发生了什么：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setContentView</span><span class="hljs-params">(<span class="hljs-meta">@LayoutRes</span> <span class="hljs-type">int</span> layoutResID)</span> {
        getWindow().setContentView(layoutResID);
        initWindowDecorActionBar();
    }
</code></pre>
<p><code>Activity</code>的<code>onCreate()</code>调用的是<code>Window</code>类的<code>setContentView()</code>，这是个抽象方法，具体的实现在<code>PhoneWindow.java</code>中，代码如下：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setContentView</span><span class="hljs-params">(View view, ViewGroup.LayoutParams params)</span> {
        <span class="hljs-keyword">if</span> (mContentParent == <span class="hljs-literal">null</span>) {
            installDecor();
        }
        ...
    }
</code></pre>
<p>如果<code>mContentParent</code>对象还没有创建出来，则会调用<code>installDecor()</code>方法，方法如下：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">installDecor</span><span class="hljs-params">()</span> {
        mForceDecorInstall = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">if</span> (mDecor == <span class="hljs-literal">null</span>) {
            mDecor = generateDecor(-<span class="hljs-number">1</span>); <span class="hljs-comment">// 创建 DecorView</span>
            mDecor.setDescendantFocusability(ViewGroup.FOCUS_AFTER_DESCENDANTS);
            mDecor.setIsRootNamespace(<span class="hljs-literal">true</span>);
            <span class="hljs-keyword">if</span> (!mInvalidatePanelMenuPosted &amp;&amp; mInvalidatePanelMenuFeatures != <span class="hljs-number">0</span>) {
                mDecor.postOnAnimation(mInvalidatePanelMenuRunnable);
            }
        } <span class="hljs-keyword">else</span> {
            mDecor.setWindow(<span class="hljs-built_in">this</span>);
        }
        <span class="hljs-keyword">if</span> (mContentParent == <span class="hljs-literal">null</span>) {
            mContentParent = generateLayout(mDecor); <span class="hljs-comment">// 为DecorView设置布局格式，并返回 mContentParent</span>
        }
    }
</code></pre>
<p><code>installDecor()</code>方法</p>
<ul>
<li>
<p>先根据成员变量<code>mDecor</code>是否为空来决定是否进行<code>DecorView</code>的创建</p>
<ul>
<li>对象的创建方法为<code>generateDecor()</code>，内容如下：</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> DecorView <span class="hljs-title function_">generateDecor</span><span class="hljs-params">(<span class="hljs-type">int</span> featureId)</span> {
    Context context;
    ... <span class="hljs-comment">// 省略 context 的创建过程</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DecorView</span>(context, featureId, <span class="hljs-built_in">this</span>, getAttributes());
}
</code></pre>
</li>
<li>
<p>然后通过<code>generateLayout()</code>方法为创建好的<code>DecorView</code>设置布局格式，并返回<code>mContentParent</code>对象</p>
</li>
</ul>
<p>我们再看下<code>DecorView</code>的定义</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/** <span class="hljs-doctag">@hide</span> */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DecorView</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">FrameLayout</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RootViewSurfaceTaker</span>, WindowCallbacks {
    ...
}
</code></pre>
<p>其实就是个自定义的<code>ViewGroup</code>，只是这个<code>DecorView</code>在<code>Android</code>中作为顶级<code>View</code>去使用</p>
<h2 data-id="heading-10"><code>WindowManagerService</code>服务</h2>
<p><code>WMS</code>服务的启动，要从<code>SystemServer</code>中的<code>startOtherServices()</code>方法说起，关键代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startOtherServices</span><span class="hljs-params">()</span> {
    ...
    wm = WindowManagerService.main(..., <span class="hljs-keyword">new</span> <span class="hljs-title class_">PhoneWindowManager</span>());
    ServiceManager.addService(Context.WINDOW_SERVICE, wm, <span class="hljs-comment">/* allowIsolated= */</span> <span class="hljs-literal">false</span>,
            DUMP_FLAG_PRIORITY_CRITICAL | DUMP_FLAG_PROTO);
    ...
}
</code></pre>
<p>看下<code>main()</code>方法的定义：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> WindowManagerService <span class="hljs-title function_">main</span><span class="hljs-params">(..., WindowManagerPolicy policy)</span> {
        DisplayThread.getHandler().runWithScissors(() -&gt;
                sInstance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WindowManagerService</span>(context, im, haveInputMethods, showBootMsgs,
                        onlyCore, policy), <span class="hljs-number">0</span>);
        <span class="hljs-keyword">return</span> sInstance;
    }
</code></pre>
<p><code>main()</code>方法主要是初始化了<code>WindowManagerService</code>对象，我们需要注意的是它的最后的参数<code>WindowManagerPolicy policy</code>，它的具体的实现类是<code>PhoneWindowManager</code></p>
<p>再看下<code>WindowManagerService</code>的关键定义：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WindowManagerService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IWindowManager</span>.Stub
        <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Watchdog</span>.Monitor, WindowManagerPolicy.WindowManagerFuncs {
    ...
    <span class="hljs-keyword">final</span> ArraySet&lt;Session&gt; mSessions = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArraySet</span>&lt;&gt;();
    <span class="hljs-keyword">final</span> <span class="hljs-type">WindowHashMap</span> <span class="hljs-variable">mWindowMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WindowHashMap</span>();
    <span class="hljs-keyword">final</span> WindowManagerPolicy mPolicy;
    ...
    <span class="hljs-keyword">private</span> <span class="hljs-title function_">WindowManagerService</span><span class="hljs-params">(..., WindowManagerPolicy policy)</span> {
        ...
        mPolicy = policy;
        ...
    }
}
</code></pre>
<p>其中的关键成员如下：</p>
<ul>
<li>
<p><code>mSessions</code>中储存的是<code>Session</code>服务类的对象，每个应用在<code>WMS</code>中都有一个对应的<code>Session</code>对象，它们都保存在<code>mSessions</code>中</p>
</li>
<li>
<p><code>mWindowMap</code>中类型是<code>WindowHashMap</code>，保存的是所有窗口的<code>WindowState</code>对象。<code>WindowHashMap</code>定义如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">WindowHashMap</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HashMap</span>&lt;IBinder, WindowState&gt; {
}
</code></pre>
<ul>
<li>此处并未做任何删减哈，源码中就是简单地继承了<code>HashMap&lt;IBinder, WindowState&gt;</code></li>
<li><code>WindowState</code>表示一个窗口的所有属性，它便是是<code>WMS</code>中的窗口。等下细讲</li>
</ul>
</li>
<li>
<p><code>mPolicy</code>是<code>WMS</code>中执行窗口管理策略的对象，类型是<code>WindowManagerPolicy</code>，这是一个接口类</p>
<ul>
<li>从<code>SystemServer</code>的<code>startOtherServices()</code>中可以看出具体的实现类是<code>PhoneWindowManager</code></li>
<li>在<code>Android</code>中<code>WMS</code>只是负责窗口管理的框架部分，通过<code>策略模式</code>将框架和窗口实现细节进行了分离</li>
</ul>
</li>
</ul>
<p>对比<code>9.0</code>和<code>5.0</code>源码，<code>WMS</code>关于窗口部分设计变化很大，在了解<code>Android</code>如何添加一个窗口前，我们先看下<code>Android</code>中窗口类型的定义</p>
<h3 data-id="heading-11">窗口类型</h3>
<p>在<code>WMS</code>中定义了3中窗口：<code>应用窗口</code>、<code>子窗口</code>和<code>系统窗口</code>，相关的定义都是在<code>frameworks/base/core/java/android/view/WindowManager.java</code>中，确切的说应该是在<code>WindowManager.LayoutParams</code>类中定义</p>
<h4 data-id="heading-12">应用窗口(<code>application window</code>)</h4>
<p>应用窗口是<code>Activity</code>使用的全屏窗口，<code>Android</code>定义了4种不同类型的应用窗口</p>
<ul>
<li><code>TYPE_BASE_APPLICATION</code>：基础应用窗口，应用中所有窗口都位于它的上层。只能由系统创建</li>
<li><code>TYPE_APPLICATION</code>：<code>Activity</code>的顶层窗口，应用中最常见的一种</li>
<li><code>TYPE_APPLICATION_STARTING</code>：应用启动时由系统创建的窗口，显示一些信息，直到应用创建的窗口显示出来</li>
<li><code>TYPE_DRAWN_APPLICATION</code>：类似于普通的<code>TYPE_APPLICATION</code>，<code>WMS</code>针对类型额外增加了等待机制</li>
</ul>
<h4 data-id="heading-13">子窗口(<code>sub-window</code>)</h4>
<p>子窗口是指依附于应用窗口或系统窗口的窗口类型，它们一般随所依附的窗口一起出现或切换到后台。<code>Android</code>中定义了6种子窗口类型</p>
<ul>
<li><code>TYPE_APPLICATION_PANEL</code>：应用Panel窗口，显示在依附窗口的上层</li>
<li><code>TYPE_APPLICATION_MEDIA</code>：应用Media窗口，通常包含独立的Surface，显示在依附窗口的下层</li>
<li><code>TYPE_APPLICATION_SUB_PANEL</code>：应用子Panel窗口，显示在依附窗口和<code>TYPE_APPLICATION_PANEL</code>的上层</li>
<li><code>TYPE_APPLICATION_ATTACHED_DIALOG</code>：和<code>TYPE_APPLICATION_PANEL</code>类似，但是窗口的布局方式和<code>Activity</code>的顶层窗口相同</li>
<li><code>TYPE_APPLICATION_MEDIA_OVERLAY</code>：一种显示在<code>TYPE_APPLICATION_MEDIA</code>和所依附窗口之间的半透明窗口。一般用来显示<code>Video</code>的字幕或者相机的操作提示界面</li>
<li><code>TYPE_APPLICATION_ABOVE_SUB_PANEL</code>：一种显示在<code>TYPE_APPLICATION_SUB_PANEL</code>之上的窗口</li>
</ul>
<h4 data-id="heading-14">系统窗口(<code>system window</code>)</h4>
<p>系统窗口大都用于系统生成的UI中，一般比较独立，种类非常多，我们挑几个常见的看下</p>
<ul>
<li><code>TYPE_STATUS_BAR</code>：状态栏窗口，系统中只能有一个，在屏幕的最上方</li>
<li><code>TYPE_SEARCH_BAR</code>：搜索栏窗口，系统中只能有一个，在屏幕的最上方</li>
<li><code>TYPE_PHONE</code>：电话窗口，提供用户与电话的交互界面，通常位于所用应用窗口的上方，但是在状态栏的后面</li>
<li><code>TYPE_SYSTEM_ALERT</code>：系统警告窗口，位于所用应用窗口的上方</li>
<li><code>TYPE_TOAST</code>：临时通知窗口，显示一些提示信息</li>
</ul>
<p>还有很多就不一一列举了，<code>Android</code>对<code>系统窗口</code>的定义有39种之多，源码中有着详细的注释，大家可以在<code>WindowManager.java</code>中找到(<a href="https://link.juejin.cn?target=http%3A%2F%2Fandroidxref.com%2F9.0.0_r3%2Fxref%2Fframeworks%2Fbase%2Fcore%2Fjava%2Fandroid%2Fview%2FWindowManager.java%23697" target="_blank" title="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/view/WindowManager.java#697" ref="nofollow noopener noreferrer">传送门</a>)</p>
<p><strong>那么<code>WMS</code>中是怎么定义窗口的呢？</strong></p>
<h3 data-id="heading-15"><code>WMS</code>中窗口的设计</h3>
<blockquote>
<p>前面讲过（<code>WMS</code>的<code>addWindow()</code>方法），当向<code>WMS</code>添加一个窗口时，<code>WMS</code>会为其创建一个<code>WindowState</code>。对于<code>WindowState</code>来说，它包含了一个窗口的所有属性，所以它是<code>WMS</code>中真正意义上的窗口</p>
</blockquote>
<p>先看下<code>WindowState</code>的关键定义：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/** A window in the window manager. */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">WindowState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WindowContainer</span>&lt;WindowState&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WindowManagerPolicy</span>.WindowState {
    ...
    WindowToken mToken;
    AppWindowToken mAppToken;
    ...
    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> mBaseLayer;
    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> mSubLayer;
}
</code></pre>
<p><code>WindowState</code>继承了<code>WindowContainer</code>，又是和书中不一样的地方</p>
<blockquote>
<p>对比5.0源码，很明显在<code>Window</code>这部分<code>Android</code>做了重构（设计模式看上去像是<code>组合模式</code>），优化了类结构，抽象出了<code>WindowContainer</code>用来支撑起整个窗口体系</p>
</blockquote>
<p>基于<code>Android 9.0</code>源码，窗口体系的关系梳理如下：<br/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2dcd21f21c44ce48b16279606ba5d73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYXBpZ2ZseQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764508564&amp;x-signature=ESLkSCnWfFCwab6KKqZzZ5yiLvY%3D" alt="image" loading="lazy"/></p>
<p>类图中涉及到的类的信息下：</p>
<ul>
<li>
<p><code>WindowContainer</code></p>
<ul>
<li>成员变量<code>mChildren</code>的类型是<code>WindowList</code>，看实现其实就是<code>ArrayList&lt;WindowState&gt;</code>。又因为<code>WindowToken</code>继承了<code>WindowContainer</code>，所以该成员变量子类都会继承过来</li>
<li>所有拥有相同<code>Token</code>的窗口(<code>WindowState</code>)都会存放在<code>mChildren</code>中，</li>
</ul>
</li>
<li>
<p><code>WindowToken</code></p>
<ul>
<li>成员变量<code>token</code>是<code>IBinder</code>对象，具有系统唯一性，向<code>WMS</code>的<code>mWindowMap</code>中添加对象时都是使用这个<code>token</code>值</li>
<li>定义了<code>AppWindowToken asAppWindowToken()</code>，默认返回<code>null</code></li>
</ul>
</li>
<li>
<p><code>AppWindowToken</code></p>
<ul>
<li>继承自<code>WindowToken</code>并重写了<code>AppWindowToken asAppWindowToken()</code>方法，返回<code>this</code></li>
<li>这样便可以通过<code>asAppWindowToken()</code>的返回值判断是那种<code>Token</code></li>
</ul>
</li>
<li>
<p><code>DisplayContent</code></p>
<ul>
<li>继承自<code>WindowContainer</code>，真正意义上的屏幕，<code>WMS</code>中一个<code>DisplayContent</code>实例表示一个屏幕。多屏幕会对应多个实例</li>
<li>内部定义了4种存放<code>Window</code>的容器，都是直接或间接继承自<code>WindowContainer</code>：
<ul>
<li><code>mTaskStackContainers</code>：用来保存所有的应用窗口</li>
<li><code>mAboveAppWindowsContainers</code>：用来保存显示在应用窗口的上面的非应用窗口</li>
<li><code>mBelowAppWindowsContainers</code>：用来保存显示在应用窗口的下面的非应用窗口</li>
<li><code>mImeWindowsContainers</code>：用来保存 IME Window</li>
</ul>
</li>
</ul>
</li>
<li>
<p><code>RootWindowContainer</code></p>
<ul>
<li>代表<code>WMS</code>中窗口的根容器，所有<code>DisplayContent</code>的实例都会添加到其中</li>
<li><code>RootWindowContainer</code>在<code>WMS</code>的构造方法中初始化为<code>mRoot</code>对象</li>
</ul>
</li>
</ul>
<p>还是回到<code>WindowState</code>，类中定义了两个常量<code>mBaseLayer</code>和<code>mSubLayer</code>，通过这两个常量便可以确定一个<code>Window</code>所在的层级。这部分就不细讲了哈，涉及点有点多，后面用到再来补充吧，嘻嘻</p>
<p>我们重点看下面两个知识点：<code>WMS</code>的<code>addWindow</code>和<code>relayoutWindow</code>的设计</p>
<h4 data-id="heading-16">addWindow方法</h4>
<p><code>addWindow()</code>在<a href="#WMS2APP" title="#WMS2APP">WMS中建立和应用的关系</a>已经介绍，不再赘述</p>
<h4 data-id="heading-17">relayoutWindow方法</h4>
<p>前面介绍过，在<code>Activity</code>的<code>onResume</code>阶段，通过<code>ViewRootImpl</code>的<code>setView</code>方法开始渲染<code>View</code>的流程。</p>
<p><code>setView</code>方法中会通过<code>requestLayout()</code>开始测量渲染，这个方法中有一个核心的逻辑就是调用<code>WMS</code>的<code>relayoutWindow()</code>，重新测量<code>Window</code>，简要流程如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">//ViewRootImpl.java</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestLayout</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">if</span> (!mHandlingLayoutInLayoutRequest) {
        ...
        scheduleTraversals();
    }
}
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">performTraversals</span><span class="hljs-params">()</span> {
    ...
    relayoutResult = relayoutWindow(params, viewVisibility, insetsPending);
    ...
}
<span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">relayoutWindow</span><span class="hljs-params">(WindowManager.LayoutParams params, <span class="hljs-type">int</span> viewVisibility,
        <span class="hljs-type">boolean</span> insetsPending)</span> <span class="hljs-keyword">throws</span> RemoteException {
    ...
    <span class="hljs-type">int</span> <span class="hljs-variable">relayoutResult</span> <span class="hljs-operator">=</span> mWindowSession.relayout(mWindow, mSeq, params,
            (<span class="hljs-type">int</span>) (mView.getMeasuredWidth() * appScale + <span class="hljs-number">0.5f</span>),
            (<span class="hljs-type">int</span>) (mView.getMeasuredHeight() * appScale + <span class="hljs-number">0.5f</span>), viewVisibility,
            insetsPending ? WindowManagerGlobal.RELAYOUT_INSETS_PENDING : <span class="hljs-number">0</span>, frameNumber,
            mWinFrame, mPendingOverscanInsets, mPendingContentInsets, mPendingVisibleInsets,
            mPendingStableInsets, mPendingOutsets, mPendingBackDropFrame, mPendingDisplayCutout,
            mPendingMergedConfiguration, mSurface);
    ...
    <span class="hljs-keyword">return</span> relayoutResult;
}
</code></pre>
<p><code>relayoutWindow()</code>通过<code>Session</code>的<code>relayout()</code>方法调用到<code>WMS</code>的<code>relayoutWindow()</code>方法</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">relayout</span><span class="hljs-params">(IWindow window, <span class="hljs-type">int</span> seq, ...)</span> {
        ...
        <span class="hljs-type">int</span> <span class="hljs-variable">res</span> <span class="hljs-operator">=</span> mService.relayoutWindow(<span class="hljs-built_in">this</span>, window, seq, attrs,
                requestedWidth, requestedHeight, viewFlags, flags, frameNumber,
                outFrame, outOverscanInsets, outContentInsets, outVisibleInsets,
                outStableInsets, outsets, outBackdropFrame, cutout,
                mergedConfiguration, outSurface);
        ...
        <span class="hljs-keyword">return</span> res;
    }
</code></pre>
<p><code>WMS</code>中的<code>relayoutWindow()</code>代码比较复杂，我们简单看下：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">relayoutWindow</span><span class="hljs-params">(...)</span> {
        ...
        <span class="hljs-keyword">synchronized</span>(mWindowMap) {
            <span class="hljs-comment">// 从 mWindowMap 取出对应的 WindowState 对象</span>
            <span class="hljs-type">WindowState</span> <span class="hljs-variable">win</span> <span class="hljs-operator">=</span> windowForClientLocked(session, client, <span class="hljs-literal">false</span>);
            <span class="hljs-keyword">if</span> (win == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
            }
            displayId = win.getDisplayId();
            ...
            <span class="hljs-comment">// 调用 WindowSurfacePlacer 的 performSurfacePlacement 方法</span>
            <span class="hljs-comment">// 这个方法其实就是检查清理无用的 Surface 对象，为后面创建 Surface 做准备</span>
            <span class="hljs-comment">// 详细的方法就不贴出来了，大家可以自行阅读</span>
            mWindowPlacerLocked.performSurfacePlacement(<span class="hljs-literal">true</span> <span class="hljs-comment">/* force */</span>);
            <span class="hljs-keyword">if</span> (shouldRelayout) {
                result = win.relayoutVisibleWindow(result, attrChanges, oldVisibility);
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-comment">// 创建 Surface ，确切的说应该是创建 WindowSurfaceController 对象</span>
                    <span class="hljs-comment">// WindowSurfaceController 其实就是对 Surface 和 SurfaceControl 的封装</span>
                    <span class="hljs-comment">// Surface 和 SurfaceControl 的关系在十二章已经介绍啦</span>
                    result = createSurfaceControl(outSurface, result, win, winAnimator);
                } 
                ...
            } <span class="hljs-keyword">else</span> {
                ...
            }
            <span class="hljs-keyword">if</span> (focusMayChange) {
                <span class="hljs-comment">// 如果窗口发生了变化，调用 updateFocusedWindowLocked 方法重新测量窗口大小</span>
                <span class="hljs-comment">// 这个方法才是真正的核心测量窗口大小逻辑</span>
                <span class="hljs-comment">// 方法中会调用 DisplayContent.performLayout 方法开始真正的测量</span>
                <span class="hljs-keyword">if</span> (updateFocusedWindowLocked(UPDATE_FOCUS_WILL_PLACE_SURFACES,
                        <span class="hljs-literal">false</span> <span class="hljs-comment">/*updateInputWindows*/</span>)) {
                    imMayMove = <span class="hljs-literal">false</span>;
                }
            }
            ...
            win.mInRelayout = <span class="hljs-literal">false</span>;
        }
        ...
    }
</code></pre>
<p>在 <code>WMS</code> 的 <code>relayoutWindow()</code> 方法中，核心逻辑在于 <code>createSurfaceControl</code> 的调用。</p>
<pre><code class="hljs language-java" lang="java">result = createSurfaceControl(outSurface, result, win, winAnimator);
</code></pre>
<p>这里的参数 outSurface 至关重要。回看 ViewRootImpl 调用 relayout 的代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ViewRootImpl.java</span>
mWindowSession.relayout(..., mSurface);
</code></pre>
<p>我们可以明确看到，<code>ViewRootImpl</code> 将自己的成员变量 mSurface 传递给了 <code>WMS</code>。 在 <code>WMS</code> 内部，<code>createSurfaceControl</code> 会请求 <code>SurfaceFlinger</code> 创建图层（<code>Layer</code>），并将生成的 <code>Native</code> 层 <code>Surface</code> 信息回写（<code>Copy</code>）到传入的 <code>outSurface</code> 参数中。</p>
<p>这意味着： 当 <code>relayoutWindow</code> 调用返回时，应用进程 <code>ViewRootImpl</code> 中的 <code>mSurface</code> 对象就已经持有了真正的图形缓冲区引用，随后应用便可以利用这个 <code>Surface</code> 进行绘图。</p>
<blockquote>
<p>怎么说～怎么说～。前言的问题是不是明了啦</p>
</blockquote>
<h2 data-id="heading-18">总结</h2>
<p>Android 的窗口系统是一个典型的 <code>C/S</code> 架构，由应用进程（Client）和 <code>WindowManagerService</code>（Server）共同构成：</p>
<p><strong>应用端 (Client)</strong></p>
<ul>
<li>
<p><code>Activity</code> 负责生命周期，持有一个 <code>PhoneWindow</code> 对象来管理视图策略。</p>
</li>
<li>
<p><code>DecorView</code> 是视图树的根节点。</p>
</li>
<li>
<p><code>ViewRootImpl</code> 是核心管理者，它连接了 DecorView 和 <code>WMS</code>，并持有 <code>Surface</code> 对象，负责发起绘制流程（Measure/Layout/Draw）。</p>
</li>
<li>
<p><code>WindowManagerGlobal</code> 是进程单例，负责管理当前进程所有的 <code>ViewRootImpl</code> 和 <code>View</code>。</p>
</li>
</ul>
<p><strong>通信层 (IPC)</strong></p>
<ul>
<li>
<p><code>IWindowSession</code>：应用向 <code>WMS</code> 发送请求的通道（如 <code>addToDisplay</code>, <code>relayout</code>）。</p>
</li>
<li>
<p><code>IWindow</code> (<code>W</code>类)：<code>WMS</code> 回调应用的通道（如窗口焦点变化、配置改变）。</p>
</li>
</ul>
<p><strong>服务端 (WMS)</strong></p>
<ul>
<li>
<p><code>WindowState</code>：<code>WMS</code> 中代表一个窗口的实体，保存窗口的所有属性。</p>
</li>
<li>
<p><code>WindowContainer</code>：构建了层级化的窗口容器结构（<code>DisplayContent</code> -&gt; <code>TaskStack</code> -&gt; <code>WindowState</code>）。</p>
</li>
<li>
<p><code>Surface</code> 管理：<code>WMS</code> 在 <code>relayoutWindow</code> 过程中计算窗口大小与位置，并与 <code>SurfaceFlinger</code> 通信创建 <code>SurfaceControl</code>，最终将可用的 <code>Surface</code> 返回给应用端。</p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MyBatis-Plus踩坑血泪史：那些年我们踩过的坑！]]></title>    <link>https://juejin.cn/post/7576018857368485931</link>    <guid>https://juejin.cn/post/7576018857368485931</guid>    <pubDate>2025-11-24T10:33:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576018857368485931" data-draft-id="7576026767372058643" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MyBatis-Plus踩坑血泪史：那些年我们踩过的坑！"/> <meta itemprop="keywords" content="MyBatis,Java,面试"/> <meta itemprop="datePublished" content="2025-11-24T10:33:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="转转技术团队"/> <meta itemprop="url" content="https://juejin.cn/user/606586148237431"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MyBatis-Plus踩坑血泪史：那些年我们踩过的坑！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/606586148237431/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    转转技术团队
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T10:33:57.000Z" title="Mon Nov 24 2025 10:33:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>前言</strong>：我们在生产环境里跑MyBatis-Plus很多年，几乎把能踩的坑都踩过了。每次出事故，都能追溯到我们当初以为“框架会帮忙搞定”的某个细节。于是我们把这些真实经历写下来，用更接地气的方式聊聊根因和解法，帮你少熬几次夜。</p>
</blockquote>
<h2 data-id="heading-0">1、时代背景与ORM选择</h2>
<h3 data-id="heading-1">1.1 互联网时代的数据挑战</h3>
<p>业务量暴涨，数据也跟着狂飙。百万级数据在几年前还算大，如今动不动就上亿。与此同时，微服务拆分得越来越细，数据访问层变得又厚又复杂。大家一边要追新需求，一边又要兼顾性能稳定。没有趁手的开发工具，根本顶不住节奏。</p>
<h3 data-id="heading-2">1.2 MyBatis-Plus的诞生与定位</h3>
<p>于是，Java团队开始在ORM世界里不断找平衡。Hibernate太重，原生MyBatis又太多手工活。MyBatis-Plus正是在这种“又想快又想稳”的诉求下出现的。它不是简单的“语法糖”，而是一个<strong>为了生产环境而生的增强框架</strong>。</p>
<p><strong>MyBatis-Plus的核心价值</strong>：</p>
<ul>
<li><strong>简化开发</strong>：CRUD都有封装，少写很多SQL，手更轻</li>
<li><strong>功能增强</strong>：逻辑删除、自动填充、乐观锁、多租户、代码生成器等都现成</li>
<li><strong>性能优化</strong>：内置分页、性能分析、批量优化、缓存插件，跑得更快</li>
<li><strong>无缝集成</strong>：兼容MyBatis，老项目也能慢慢替换，几乎不用重构</li>
</ul>
<p>这些卖点让MyBatis-Plus迅速走红。不过，功能多并不等于好用。特别是到了生产环境，隐藏的坑一个接一个。</p>
<hr/>
<h2 data-id="heading-3">2、生产环境挑战</h2>
<p>开发环境里一切都很顺。<code>saveBatch()</code>轻松搞定批量插入，<code>@TableId(type = IdType.ASSIGN_ID)</code>一写就有分布式ID，看起来稳得很。</p>
<p>然而，真正部署上线后问题才暴露出来。</p>
<p><strong>凌晨3点的告警</strong>：主键冲突，订单系统停摆。我们发现两个容器实例生成了同一个雪花ID。理论上“不可能发生”的事，就这么发生了。</p>
<p>再往下排查，批量操作乱序、枚举字段写入异常、自动填充失灵……问题一个比一个离谱。</p>
<p>这些事故有个共同点：开发环境一切正常，生产环境却崩成一片。根本原因是单机和分布式、低并发和高并发之间的差异，被框架默认配置无限放大，结果就是“看着没事”的代码在生产里频频掉链子。</p>
<p>我们因此整理出MyBatis-Plus在生产环境最容易暴雷的6大陷阱：</p>
<ol>
<li><strong>雪花算法ID生成重复问题</strong></li>
<li><strong>批量插入乱序问题</strong></li>
<li><strong>枚举字段存储风险</strong></li>
<li><strong>驼峰转换错位</strong></li>
<li><strong>批量操作时自动填充失效</strong></li>
<li><strong>写入时JSON数据丢失或格式异常</strong></li>
</ol>
<p>接下来我们把这些问题逐一拆开，聊聊背后的逻辑，再给出实测可行的解法。</p>
<hr/>
<h2 data-id="heading-4">雪花算法ID生成重复问题</h2>
<h3 data-id="heading-5">3.1 问题现象</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 看起来很正常的代码</span>
<span class="hljs-meta">@TableId(value = "id", type = IdType.ASSIGN_ID)</span>
<span class="hljs-keyword">private</span> Long id;

<span class="hljs-comment">// 但在生产环境中却出现了这样的错误：</span>
<span class="hljs-comment">// Duplicate entry '1234567890123456789' for key 'PRIMARY'</span>
</code></pre>
<p><strong>“ID怎么还能撞？”</strong> 这是我们第一次遇到时的真实反应。</p>
<h3 data-id="heading-6">3.2 雪花算法身份证结构</h3>
<p>先搞清楚雪花ID里面装了什么，再谈如何防重复。可以把它想成一个<strong>超长身份证号</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">身份证号码：<span class="hljs-number">1234567890123456789</span>
分解结构：
┌─────────┬─────────┬─────────┬─────────┐
│  时间戳  │ 数据中心 │ 机器编号 │ 序列号  │
│ (<span class="hljs-number">41</span>位)  │ (<span class="hljs-number">5</span>位)   │ (<span class="hljs-number">5</span>位)   │ (<span class="hljs-number">12</span>位)  │
└─────────┴─────────┴─────────┴─────────┘
</code></pre>
<ul>
<li><strong>时间戳</strong>像出生年月日</li>
<li><strong>数据中心ID</strong>类似省份</li>
<li><strong>机器ID</strong>对应城市</li>
<li><strong>序列号</strong>就是同一毫秒的排队号</li>
</ul>
<h3 data-id="heading-7">3.3 问题根源</h3>
<p>我们把雪花ID重复的元凶总结成四类。</p>
<h4 data-id="heading-8">3.3.1 元凶一：未配置机器ID，所有实例走默认值</h4>
<p>很多人以为框架会自动算出唯一的workerId，于是干脆不配。结果大家都走同一个默认流程。</p>
<p><strong>MyBatis-Plus获取机器ID的策略</strong>：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9379840880d14a11ac86b0fc9e9eb751~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764585237&amp;x-signature=rVo4DnTclRpO28wXZg4WktiHOOw%3D" alt="yBatis-Plus获取机器ID的策略" loading="lazy"/></p>
<p>看似严谨，然而一旦进入第二步，容器环境下“撞车”概率直线上升。</p>
<h4 data-id="heading-9">3.3.2 元凶二：容器环境的MAC地址克隆</h4>
<p>先看Docker容器MAC地址的规律：</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-title class_">Docker</span>容器<span class="hljs-variable constant_">MAC</span>地址格式：<span class="hljs-number">02</span><span class="hljs-symbol">:</span><span class="hljs-number">42</span><span class="hljs-symbol">:ac</span><span class="hljs-symbol">:</span><span class="hljs-number">11</span><span class="hljs-symbol">:</span><span class="hljs-number">00</span><span class="hljs-symbol">:XX</span>
                     ├─────────────┤├─┤
                     固定前缀      变化部分

容器<span class="hljs-number">1</span>：<span class="hljs-number">02</span><span class="hljs-symbol">:</span><span class="hljs-number">42</span><span class="hljs-symbol">:ac</span><span class="hljs-symbol">:</span><span class="hljs-number">11</span><span class="hljs-symbol">:</span><span class="hljs-number">00</span><span class="hljs-symbol">:</span><span class="hljs-number">02</span>
容器<span class="hljs-number">2</span>：<span class="hljs-number">02</span><span class="hljs-symbol">:</span><span class="hljs-number">42</span><span class="hljs-symbol">:ac</span><span class="hljs-symbol">:</span><span class="hljs-number">11</span><span class="hljs-symbol">:</span><span class="hljs-number">00</span><span class="hljs-symbol">:</span><span class="hljs-number">03</span>  
容器<span class="hljs-number">3</span>：<span class="hljs-number">02</span><span class="hljs-symbol">:</span><span class="hljs-number">42</span><span class="hljs-symbol">:ac</span><span class="hljs-symbol">:</span><span class="hljs-number">11</span><span class="hljs-symbol">:</span><span class="hljs-number">00</span><span class="hljs-symbol">:</span><span class="hljs-number">04</span>
...
</code></pre>
<p>如果继续依赖“取后两字节再模32”的做法，就会出现下面的情况：</p>
<pre><code class="hljs language-ini" lang="ini">MAC地址计算流程：
1. 提取后2字节 → 00:02, 00:03, 00:04...
2. 位运算处理 → 得到不同的中间值
3. 模32取余 → 问题就出在这里

实际结果：
├─ 容器1-32：机器<span class="hljs-attr">ID</span> = <span class="hljs-number">0</span>-<span class="hljs-number">31</span> ✅
├─ 容器33：机器<span class="hljs-attr">ID</span> = <span class="hljs-number">0</span> ❌
├─ 容器34：机器<span class="hljs-attr">ID</span> = <span class="hljs-number">1</span> ❌
└─ 以此类推...
</code></pre>
<p>如此可见，只要实例超过32个，就一定有重复。</p>
<h4 data-id="heading-10">3.3.3 元凶三：Kubernetes环境的虚拟MAC</h4>
<p>再看K8s。Pod里的网络接口本来就是虚拟的，MAC地址由CNI随机分配，还可能拿不到。
Kubernetes Pod网络特点：</p>
<ol>
<li>每个Pod都有虚拟网络接口</li>
<li>MAC地址由CNI插件分配</li>
<li>同一节点的Pod可能模式一致</li>
<li>某些环境下干脆拿不到MAC
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/63afa6655bd94b2ca6ac9bfd7dda7992~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764585237&amp;x-signature=uGX5C86XExDhN7PM0P8614khjKk%3D" alt="yBatis-Plus获取机器MAC地址" loading="lazy"/></li>
</ol>
<p>这种情况下，100个Pod全用workerId=1，冲突直接拉满。</p>
<h4 data-id="heading-11">3.3.4 元凶四：时钟回拨</h4>
<p>雪花算法非常依赖系统时间。一旦时钟被调回，就会闹出大问题。</p>
<p>雪花ID生成流程如下所示：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ba1c288dbad43a4851c820f8e746720~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764585237&amp;x-signature=poCH4A8q1wGGZC2tuSp9QYgh4rE%3D" alt="雪花ID生成流程" loading="lazy"/>
但是，如何出现时钟回拨，就会出现如下问题
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77e0b8d6b11f4e139f23c14a23bf4950~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764585237&amp;x-signature=BRn6Hp0DE6X808TLRaksxNXnstY%3D" alt="时钟回拨" loading="lazy"/></p>
<p>当以下条件同时满足时，重复就无可避免：</p>
<pre><code class="hljs language-ini" lang="ini">相同的机器ID (<span class="hljs-attr">workerId</span>=<span class="hljs-number">1</span>)
相同的数据中心ID (<span class="hljs-attr">datacenterId</span>=<span class="hljs-number">1</span>)  
相同的时间戳 (<span class="hljs-attr">timestamp</span>=<span class="hljs-number">1634567890123</span>)
相同的序列号 (<span class="hljs-attr">sequence</span>=<span class="hljs-number">0</span>)
</code></pre>
<h3 data-id="heading-12">3.4 解决方案：给每台机器一个专属身份证</h3>
<h4 data-id="heading-13">方案一：外部获取唯一的分布式ID</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IdHelper</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span>   <span class="hljs-type">long</span> <span class="hljs-title function_">getIdc</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> ZZIdcClient.getInstance().get();
        } <span class="hljs-keyword">catch</span> (Throwable e) {
            log.error(<span class="hljs-string">"act=getIdc error={}"</span>, e.getMessage());
        }
        <span class="hljs-comment">// 兜底逻辑：为了不影响业务，如果从架构拿不到id，就采用IDHelper</span>
        <span class="hljs-comment">// IDHelper有问题，并发情况下可能会生成重复id</span>
        log.info(<span class="hljs-string">"k=s act=getIdcByIDHelper"</span>);
        <span class="hljs-keyword">return</span> IDHelper.generator(<span class="hljs-number">0</span>);
    }
}
</code></pre>
<h4 data-id="heading-14">方案二：使用数据库自增ID</h4>
<pre><code class="hljs language-java" lang="java">

<span class="hljs-keyword">package</span> com.baomidou.mybatisplus.annotation;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">IdType</span> {
    AUTO(<span class="hljs-number">0</span>),
    NONE(<span class="hljs-number">1</span>),
    INPUT(<span class="hljs-number">2</span>),
    ASSIGN_ID(<span class="hljs-number">3</span>),
    ASSIGN_UUID(<span class="hljs-number">4</span>),
    <span class="hljs-comment">/** <span class="hljs-doctag">@deprecated</span> */</span>
    <span class="hljs-meta">@Deprecated</span>
    ID_WORKER(<span class="hljs-number">3</span>),
    <span class="hljs-comment">/** <span class="hljs-doctag">@deprecated</span> */</span>
    <span class="hljs-meta">@Deprecated</span>
    ID_WORKER_STR(<span class="hljs-number">3</span>),
    <span class="hljs-comment">/** <span class="hljs-doctag">@deprecated</span> */</span>
    <span class="hljs-meta">@Deprecated</span>
    UUID(<span class="hljs-number">4</span>);
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> key;
}

    <span class="hljs-comment">/**
     * 主键ID
     */</span>
    <span class="hljs-meta">@TableId(value = "id", type = IdType.AUTO)</span>
    <span class="hljs-keyword">private</span> Long id;
</code></pre>
<hr/>
<h2 data-id="heading-15">4、批量插入乱序问题</h2>
<h3 data-id="heading-16">4.1 问题现象</h3>
<p>场景1：父子订单批量插入。当子订单准备入库时，父订单还没完成，外键直接挂掉。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 期望：先插入父订单，再插入子订单</span>
heroPackageService.saveBatch(packages);  <span class="hljs-comment">// 父订单</span>
heroOrderService.saveBatch(orders);      <span class="hljs-comment">// 子订单</span>

<span class="hljs-comment">// 结果：外键约束失败！</span>
<span class="hljs-comment">// Cannot add or update a child row: a foreign key constraint fails</span>
</code></pre>
<p>场景2：远程接口返回一个有序列表，我们存到数据库里，想在后续查询中保持原有顺序，结果还是乱了。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 期望：远程获取数据之后，存在数据库，后续从数据库获取有序列表的快照</span>
<span class="hljs-comment">//远程获取外部有序集合</span>
List&lt;HeroPackage&gt; heroPackageList = recycleRpcService.getHeroPackageList(uid)
<span class="hljs-comment">//将远程获取数据存入数据库</span>
heroPackageService.saveBatch(heroPackageList)
<span class="hljs-comment">//从数据库获取有序集合数据</span>
List&lt;HeroPackage&gt; heroPackageList = heroPackageService.list(uid);


<span class="hljs-comment">// 结果：有序集合的顺序被打乱</span>
<span class="hljs-comment">// </span>
</code></pre>
<p><strong>明明是按顺序调用的，为什么会乱序？</strong></p>
<h3 data-id="heading-17">4.2 原理</h3>
<p>可以把它想成快递分拣。你按顺序交包裹，分拣中心为了效率会重排路线，于是最终顺序就变了。</p>
<h4 data-id="heading-18">4.2.1 MyBatis-Plus的两种批量插入模式</h4>
<p>官方其实有两套批量逻辑，差别非常大。</p>
<h5 data-id="heading-19">模式一：默认BATCH模式（逐条插入）</h5>
<p>MyBatis-Plus默认saveBatch的执行流程：</p>
<ol>
<li>
<p>接收数据列表</p>
<ol>
<li>List packages (1000条数据)</li>
<li>默认批次大小：1000</li>
</ol>
</li>
<li>
<p>创建批处理SqlSession</p>
<ol>
<li>使用 ExecutorType.BATCH</li>
<li>逐条执行INSERT</li>
</ol>
</li>
<li>
<p>逐条加入批处理队列</p>
<ol>
<li>第1条：INSERT INTO hero_package VALUES (...)</li>
<li>第2条：INSERT INTO hero_package VALUES (...)</li>
<li>...</li>
<li>第1000条：INSERT INTO hero_package VALUES (...)</li>
</ol>
</li>
<li>
<p>达到批次大小后 flushStatements()</p>
</li>
</ol>
<p>特点：</p>
<ol>
<li>支持主键回填</li>
<li>单线程下顺序可控</li>
<li>多线程+驱动优化后容易乱序</li>
<li>网络往返次数多，性能一般</li>
</ol>
<h5 data-id="heading-20">模式二：优化批处理模式（合并SQL）</h5>
<p>配置方式：要么改全局配置，要么写自定义SQL</p>
<p>执行流程：</p>
<ol>
<li>接收列表</li>
<li>foreach拼成一条多值INSERT</li>
<li>一次性落库</li>
</ol>
<p>特点：</p>
<ol>
<li>单次往返，性能高</li>
<li>顺序完全可控</li>
<li>主键需要自己准备</li>
<li>SQL过长时得自行分批</li>
</ol>
<p><strong>两种模式对比</strong>：</p>






























<table><thead><tr><th>特性</th><th>默认BATCH模式</th><th>优化批处理模式</th></tr></thead><tbody><tr><td>性能</td><td>多次往返，速度一般</td><td>单次往返，极快</td></tr><tr><td>顺序保证</td><td>单线程可控，多线程不稳</td><td>完全可控</td></tr><tr><td>主键回填</td><td>支持</td><td>不支持</td></tr><tr><td>适用场景</td><td>依赖数据库生成主键</td><td>自己能生成主键或无主键需求</td></tr></tbody></table>
<h4 data-id="heading-21">4.2.2 根本原因二：JDBC驱动的批处理重排序</h4>
<p>MySQL JDBC驱动为了提速，会把同表操作合并。原本交错的SQL被重新分组，顺序自然就乱了。</p>
<p>JDBC批处理模式：</p>
<p>模式1：rewriteBatchedStatements=false</p>
<ol>
<li>逐条执行</li>
<li>顺序稳定</li>
<li>性能一般</li>
</ol>
<p>模式2：rewriteBatchedStatements=true</p>
<ol>
<li>自动合并SQL</li>
<li>性能飙升</li>
<li>顺序可能被“优化”</li>
</ol>
<pre><code class="hljs language-sql" lang="sql">
例子：
原始<span class="hljs-keyword">SQL</span>：
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> hero_package <span class="hljs-keyword">VALUES</span> (..)
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> hero_order <span class="hljs-keyword">VALUES</span> (..)
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> hero_package <span class="hljs-keyword">VALUES</span> (..)
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> hero_order <span class="hljs-keyword">VALUES</span> (..)

驱动优化后：
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> hero_package <span class="hljs-keyword">VALUES</span> (...), (...)
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> hero_order <span class="hljs-keyword">VALUES</span> (...), (...)

</code></pre>
<p>顺序彻底变了。</p>
<h4 data-id="heading-22">4.2.3 根本原因三：数据库层面的执行优化</h4>
<p>MySQL优化器也会“帮忙”重排执行计划。同一张表的操作被集中，避免频繁切换表，性能是好了，但依赖顺序的逻辑直接崩。</p>
<pre><code class="hljs language-sql" lang="sql">期望：
Package1 → Order1 → Package2 → Order2

实际：
Package1, Package2 → Order1, Order2

优化器心声：
既然都是<span class="hljs-keyword">INSERT</span>，就分组吧
省得来回切换表         
</code></pre>
<p>问题在于，Order引用Package的主键。如果Package还没落库，Order插入必失败。</p>
<p>例如下面的真实案例。两个线程并发创建订单。批处理时队列不保证FIFO，于是订单项和订单的关系全乱套。</p>
<p>期望：
订单A → 订单项A → 订单B → 订单项B</p>
<p>现实：
线程A、线程B同时写入
批处理队列交错
驱动/数据库重排
→ 可能先执行线程B的订单项，再执行线程A的
→ 外键和业务逻辑全乱</p>
<h3 data-id="heading-23">4.3 解决方案：控制批处理节奏</h3>
<p>我们常用两个思路：要么“分批+强制刷新”，要么“自定义SQL一次写完”。</p>
<h4 data-id="heading-24">方案一：分批次执行，强制刷新</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrdersInSequence</span><span class="hljs-params">(List&lt;OrderData&gt; orderDataList)</span> {
    <span class="hljs-type">int</span> <span class="hljs-variable">batchSize</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span>;
    
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; orderDataList.size(); i += batchSize) {
        List&lt;OrderData&gt; batch = orderDataList.subList(i, 
            Math.min(i + batchSize, orderDataList.size()));
        
        <span class="hljs-comment">// 先插入父订单</span>
        List&lt;HeroPackage&gt; packages = buildPackages(batch);
        heroPackageService.saveBatch(packages);
        sqlSession.flushStatements(); <span class="hljs-comment">// 强制执行，确保顺序</span>
        
        <span class="hljs-comment">// 再插入子订单</span>
        List&lt;HeroOrder&gt; orders = buildOrders(batch);
        heroOrderService.saveBatch(orders);
        sqlSession.flushStatements();
    }
}
</code></pre>
<h4 data-id="heading-25">方案二：自定义SQL，一次性插入</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 使用自定义SQL，完全控制执行顺序</span>
<span class="hljs-meta">@Insert({
    "&lt;script&gt;",
    "INSERT INTO hero_package (id, seller_uid, create_time) VALUES ",
    "&lt;foreach collection='packages' item='pkg' separator=','&gt;",
    "(#{pkg.id}, #{pkg.sellerUid}, #{pkg.createTime})",
    "&lt;/foreach&gt;",
    "&lt;/script&gt;"
})</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">insertPackageBatch</span><span class="hljs-params">(<span class="hljs-meta">@Param("packages")</span> List&lt;HeroPackage&gt; packages)</span>;
</code></pre>
<hr/>
<h2 data-id="heading-26">5、枚举字段存储风险</h2>
<h3 data-id="heading-27">5.1 问题现象：枚举字段存储异常</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 枚举定义</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">OrderStatus</span> {
    PENDING(<span class="hljs-number">1</span>, <span class="hljs-string">"待处理"</span>),
    PROCESSING(<span class="hljs-number">2</span>, <span class="hljs-string">"处理中"</span>),
    COMPLETED(<span class="hljs-number">3</span>, <span class="hljs-string">"已完成"</span>);
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Integer code;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String desc;
}

<span class="hljs-comment">// 实体类</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HeroOrder</span> {
    <span class="hljs-keyword">private</span> OrderStatus orderStatus; <span class="hljs-comment">// 期望存储code值(1,2,3)</span>
}

<span class="hljs-comment">// 结果：数据库中存储的是枚举名称("PENDING", "PROCESSING", "COMPLETED")</span>
</code></pre>
<h3 data-id="heading-28">5.2 深入原理：MyBatis的默认枚举处理</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// MyBatis默认的枚举处理器</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EnumTypeHandler</span>&lt;E <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Enum</span>&lt;E&gt;&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseTypeHandler</span>&lt;E&gt; {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setNonNullParameter</span><span class="hljs-params">(PreparedStatement ps, <span class="hljs-type">int</span> i, E parameter, JdbcType jdbcType)</span> {
        <span class="hljs-comment">// 默认使用枚举的name()方法！</span>
        ps.setString(i, parameter.name()); <span class="hljs-comment">// 存储"PENDING"而不是1</span>
    }
}
</code></pre>
<h3 data-id="heading-29">5.3 解决方案：使用@EnumValue注解</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">OrderStatus</span> {
    PENDING(<span class="hljs-number">1</span>, <span class="hljs-string">"待处理"</span>),
    PROCESSING(<span class="hljs-number">2</span>, <span class="hljs-string">"处理中"</span>),
    COMPLETED(<span class="hljs-number">3</span>, <span class="hljs-string">"已完成"</span>);
    
    <span class="hljs-meta">@EnumValue</span> <span class="hljs-comment">// 标记这个字段用于数据库存储</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Integer code;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String desc;
    
    <span class="hljs-comment">// 构造函数和getter...</span>
}
</code></pre>
<hr/>
<h2 data-id="heading-30">6、驼峰转换错位</h2>
<h3 data-id="heading-31">6.1 问题现象</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 数据库字段：seller_uid, buyer_uid, create_time</span>
<span class="hljs-comment">// 实体类字段：</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HeroPackage</span> {
    <span class="hljs-keyword">private</span> Long sellerUid;    <span class="hljs-comment">// ✅ 正常映射</span>
    <span class="hljs-keyword">private</span> Long buyerUID;     <span class="hljs-comment">// ❌ 映射失败！</span>
    <span class="hljs-keyword">private</span> Date createTime;   <span class="hljs-comment">// ✅ 正常映射</span>
    <span class="hljs-keyword">private</span> String XMLData;    <span class="hljs-comment">// ❌ 映射失败！</span>
}
</code></pre>
<h3 data-id="heading-32">6.2 原理</h3>
<p>MyBatis-Plus的驼峰转换算法对连续大写很无奈。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 驼峰转换算法（简化版）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CamelCaseConverter</span> {
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">camelToUnderscore</span><span class="hljs-params">(String camelCase)</span> {
        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; camelCase.length(); i++) {
            <span class="hljs-type">char</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> camelCase.charAt(i);
            <span class="hljs-keyword">if</span> (Character.isUpperCase(c)) {
                <span class="hljs-keyword">if</span> (i &gt; <span class="hljs-number">0</span>) result.append(<span class="hljs-string">'_'</span>);
                result.append(Character.toLowerCase(c));
            } <span class="hljs-keyword">else</span> {
                result.append(c);
            }
        }
        <span class="hljs-keyword">return</span> result.toString();
    }
}

<span class="hljs-comment">// 转换结果：</span>
<span class="hljs-comment">// sellerUid -&gt; seller_uid ✅</span>
<span class="hljs-comment">// buyerUID -&gt; buyer_u_i_d ❌ (期望: buyer_uid)</span>
<span class="hljs-comment">// XMLData -&gt; x_m_l_data ❌ (期望: xml_data)</span>
</code></pre>
<h3 data-id="heading-33">6.3 解决方案：明确字段映射</h3>
<h5 data-id="heading-34">方案一：使用@TableField注解</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HeroPackage</span> {
    <span class="hljs-keyword">private</span> Long sellerUid;
    
    <span class="hljs-meta">@TableField("buyer_uid")</span>  <span class="hljs-comment">// 明确指定数据库字段名</span>
    <span class="hljs-keyword">private</span> Long buyerUID;
    
    <span class="hljs-keyword">private</span> Date createTime;
    
    <span class="hljs-meta">@TableField("xml_data")</span>
    <span class="hljs-keyword">private</span> String XMLData;
}
</code></pre>
<h5 data-id="heading-35">方案二：统一命名规范</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 推荐的命名规范</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HeroPackage</span> {
    <span class="hljs-keyword">private</span> Long sellerUid;     <span class="hljs-comment">// 驼峰命名，避免连续大写</span>
    <span class="hljs-keyword">private</span> Long buyerUid;      <span class="hljs-comment">// 而不是buyerUID</span>
    <span class="hljs-keyword">private</span> Date createTime;
    <span class="hljs-keyword">private</span> String xmlData;     <span class="hljs-comment">// 而不是XMLData</span>
}
</code></pre>
<h5 data-id="heading-36">方案三：自定义命名策略</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MybatisPlusConfig</span> {
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> MybatisPlusInterceptor <span class="hljs-title function_">mybatisPlusInterceptor</span><span class="hljs-params">()</span> {
        <span class="hljs-type">MybatisPlusInterceptor</span> <span class="hljs-variable">interceptor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MybatisPlusInterceptor</span>();
        
        <span class="hljs-comment">// 自定义命名策略</span>
        <span class="hljs-type">GlobalConfig</span> <span class="hljs-variable">globalConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GlobalConfig</span>();
        globalConfig.setDbConfig(<span class="hljs-keyword">new</span> <span class="hljs-title class_">GlobalConfig</span>.DbConfig() {{
            <span class="hljs-comment">// 自定义字段命名策略</span>
            setColumnFormat(<span class="hljs-string">"`%s`"</span>); <span class="hljs-comment">// 字段名加反引号，避免关键字冲突</span>
            setTableFormat(<span class="hljs-string">"`%s`"</span>);  <span class="hljs-comment">// 表名加反引号</span>
        }});
        
        <span class="hljs-keyword">return</span> interceptor;
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-37">7、批量操作时自动填充失效</h2>
<h3 data-id="heading-38">7.1 问题现象</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 实体类配置</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HeroOrder</span> {
    <span class="hljs-meta">@TableField(fill = FieldFill.INSERT)</span>
    <span class="hljs-keyword">private</span> Date createTime;
    
    <span class="hljs-meta">@TableField(fill = FieldFill.INSERT_UPDATE)</span>  
    <span class="hljs-keyword">private</span> Date updateTime;
    
    <span class="hljs-meta">@TableField(fill = FieldFill.INSERT)</span>
    <span class="hljs-keyword">private</span> Long createBy;
}

<span class="hljs-comment">// 自动填充处理器</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyMetaObjectHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MetaObjectHandler</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertFill</span><span class="hljs-params">(MetaObject metaObject)</span> {
        <span class="hljs-built_in">this</span>.strictInsertFill(metaObject, <span class="hljs-string">"createTime"</span>, Date.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());
        <span class="hljs-built_in">this</span>.strictInsertFill(metaObject, <span class="hljs-string">"createBy"</span>, Long.class, getCurrentUserId());
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateFill</span><span class="hljs-params">(MetaObject metaObject)</span> {
        <span class="hljs-built_in">this</span>.strictUpdateFill(metaObject, <span class="hljs-string">"updateTime"</span>, Date.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());
    }
}

<span class="hljs-comment">// 问题现象：批量操作时自动填充失效！</span>
List&lt;HeroOrder&gt; orders = buildOrders();
heroOrderService.saveBatch(orders); <span class="hljs-comment">// createTime和createBy为null！</span>
</code></pre>
<h3 data-id="heading-39">7.2 原理</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// MyBatis-Plus的自动填充机制</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultSqlSession</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">insert</span><span class="hljs-params">(String statement, Object parameter)</span> {
        <span class="hljs-comment">// 只有通过MyBatis-Plus的insert方法才会触发自动填充</span>
        <span class="hljs-keyword">if</span> (parameter <span class="hljs-keyword">instanceof</span> BaseEntity) {
            metaObjectHandler.insertFill(parameter); <span class="hljs-comment">// 触发填充</span>
        }
        <span class="hljs-keyword">return</span> executor.update(statement, parameter);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">update</span><span class="hljs-params">(String statement, Object parameter)</span> {
        <span class="hljs-keyword">if</span> (parameter <span class="hljs-keyword">instanceof</span> BaseEntity) {
            metaObjectHandler.updateFill(parameter); <span class="hljs-comment">// 触发填充</span>
        }
        <span class="hljs-keyword">return</span> executor.update(statement, parameter);
    }
}

<span class="hljs-comment">// 但是批量操作使用的是JDBC批处理</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveBatch</span><span class="hljs-params">(Collection&lt;T&gt; entityList)</span> {
    <span class="hljs-comment">// 直接执行批量SQL，跳过了自动填充逻辑！</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"INSERT INTO table VALUES (?,?,?)"</span>;
    <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">ps</span> <span class="hljs-operator">=</span> connection.prepareStatement(sql);
    <span class="hljs-keyword">for</span> (T entity : entityList) {
        <span class="hljs-comment">// 没有调用metaObjectHandler.insertFill()</span>
        ps.setObject(<span class="hljs-number">1</span>, entity.getId());
        ps.setObject(<span class="hljs-number">2</span>, entity.getName());
        ps.addBatch();
    }
    ps.executeBatch();
}
</code></pre>
<h3 data-id="heading-40">7.3 解决方案：手动填充 + 批量优化</h3>
<h5 data-id="heading-41">方案一：批量操作前手动填充</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EnhancedOrderService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> MyMetaObjectHandler metaObjectHandler;
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">saveBatchWithFill</span><span class="hljs-params">(Collection&lt;HeroOrder&gt; entityList)</span> {
        <span class="hljs-comment">// 手动触发自动填充</span>
        entityList.forEach(entity -&gt; {
            <span class="hljs-type">MetaObject</span> <span class="hljs-variable">metaObject</span> <span class="hljs-operator">=</span> SystemMetaObject.forObject(entity);
            metaObjectHandler.insertFill(metaObject);
        });
        
        <span class="hljs-comment">// 然后执行批量保存</span>
        <span class="hljs-keyword">return</span> heroOrderService.saveBatch(entityList);
    }
}
</code></pre>
<h5 data-id="heading-42">方案二：自定义批量保存方法</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BatchSaveHelper</span> {
    
    <span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-type">boolean</span> <span class="hljs-title function_">saveBatchWithAutoFill</span><span class="hljs-params">(Collection&lt;T&gt; entityList, 
                                           Class&lt;T&gt; entityClass,
                                           BaseMapper&lt;T&gt; mapper)</span> {
        <span class="hljs-keyword">if</span> (entityList.isEmpty()) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        
        <span class="hljs-comment">// 获取当前用户和时间</span>
        <span class="hljs-type">Long</span> <span class="hljs-variable">currentUserId</span> <span class="hljs-operator">=</span> getCurrentUserId();
        <span class="hljs-type">Date</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>();
        
        <span class="hljs-comment">// 反射设置自动填充字段</span>
        entityList.forEach(entity -&gt; {
            <span class="hljs-keyword">try</span> {
                setFieldValue(entity, <span class="hljs-string">"createTime"</span>, now);
                setFieldValue(entity, <span class="hljs-string">"updateTime"</span>, now);
                setFieldValue(entity, <span class="hljs-string">"createBy"</span>, currentUserId);
            } <span class="hljs-keyword">catch</span> (Exception e) {
                log.warn(<span class="hljs-string">"自动填充失败"</span>, e);
            }
        });
        
        <span class="hljs-comment">// 分批保存，避免SQL过长</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">batchSize</span> <span class="hljs-operator">=</span> <span class="hljs-number">1000</span>;
        List&lt;T&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(entityList);
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; list.size(); i += batchSize) {
            List&lt;T&gt; batch = list.subList(i, Math.min(i + batchSize, list.size()));
            mapper.insertBatch(batch); <span class="hljs-comment">// 自定义批量插入方法</span>
        }
        
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object value)</span> 
            <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(fieldName);
        field.setAccessible(<span class="hljs-literal">true</span>);
        <span class="hljs-keyword">if</span> (field.get(obj) == <span class="hljs-literal">null</span>) { <span class="hljs-comment">// 只有为null时才设置</span>
            field.set(obj, value);
        }
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-43">8、写入时JSON数据丢失或格式异常</h2>
<h3 data-id="heading-44">8.1 问题现象</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 实体类定义</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HeroPackage</span> {
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> String packageName;
    
    <span class="hljs-comment">// JSON字段存储扩展属性</span>
    <span class="hljs-keyword">private</span> Map&lt;String, Object&gt; extendInfo;
    <span class="hljs-keyword">private</span> List&lt;String&gt; tags;
}

<span class="hljs-comment">// 保存数据</span>
<span class="hljs-type">HeroPackage</span> <span class="hljs-variable">pkg</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HeroPackage</span>();
pkg.setExtendInfo(Map.of(<span class="hljs-string">"color"</span>, <span class="hljs-string">"红色"</span>, <span class="hljs-string">"weight"</span>, <span class="hljs-number">1.5</span>));
pkg.setTags(Arrays.asList(<span class="hljs-string">"电子产品"</span>, <span class="hljs-string">"二手"</span>, <span class="hljs-string">"9成新"</span>));
heroPackageService.save(pkg);

<span class="hljs-comment">// 查询结果：extendInfo和tags字段为null！</span>
</code></pre>
<h3 data-id="heading-45">8.2 原理</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// MyBatis默认只能处理基本类型</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultTypeHandlerRegistry</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DefaultTypeHandlerRegistry</span><span class="hljs-params">()</span> {
        register(String.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringTypeHandler</span>());
        register(Integer.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntegerTypeHandler</span>());
        register(Long.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">LongTypeHandler</span>());
        <span class="hljs-comment">// 没有Map和List的处理器！</span>
    }
}

<span class="hljs-comment">// 复杂对象会被toString()处理</span>
Map&lt;String, Object&gt; map = Map.of(<span class="hljs-string">"key"</span>, <span class="hljs-string">"value"</span>);
<span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> map.toString(); <span class="hljs-comment">// "{key=value}" - 不是标准JSON！</span>
</code></pre>
<h3 data-id="heading-46">8.3 解决方案：数据类型规范化处理</h3>
<p>我们的共识是：能不用复杂字段就别用。如果必须用，就自己管序列化。</p>
<h5 data-id="heading-47">方案一：数据库字段类型规范化</h5>
<ul>
<li>表里尽量只放基本类型</li>
<li>Map、List先拆成具体字段，或者转成独立表</li>
<li>复杂场景在业务层处理转换</li>
</ul>
<h5 data-id="heading-48">方案二：手动序列化处理</h5>
<ul>
<li>确实需要存结构化数据时，先序列化成JSON字符串</li>
<li>存入VARCHAR或TEXT</li>
<li>查询时再反序列化</li>
</ul>
<p><strong>实施建议</strong>：
优先走方案一。只有在业务强依赖动态结构时，再考虑方案二，记得封装好序列化逻辑，别把JSON工具散落在业务代码里。</p>
<hr/>
<h2 data-id="heading-49">总结与思考</h2>
<p>种种案例都在提醒我们：<strong>框架默认值是给理想环境准备的，到了生产就得重新审视</strong>。如果不了解内部机制，就很容易掉进坑里。</p>
<p><strong>启示一：默认配置靠不住</strong><br/>
开发环境通常是单机、低并发，默认配置自然没问题。可一上生产，容器化、分布式、高并发齐聚，默认值瞬间变成隐患。<strong>别指望框架“自动”处理所有边角料</strong>。</p>
<p><strong>启示二：机制理解少不了</strong><br/>
只有搞清楚框架怎么运转，才能提前发现风险；真出事时，也能快速定位。<strong>知其然而且要知其所以然</strong>。</p>
<p><strong>启示三：方案要服务于环境</strong><br/>
你在什么环境里跑，就得配什么策略。容器、K8s、云原生都在挑战旧有假设。<strong>没有银弹，只有适配</strong>。</p>
<blockquote>
<p>关于作者，朱洪旭，侠客汇Java开发工程师。</p>
</blockquote>
<blockquote>
<p>转转研发中心及业界小伙伴们的技术学习交流平台，定期分享一线的实战经验及业界前沿的技术话题。
关注公众号「转转技术」（综合性）、「大转转FE」（专注于FE）、「转转QA」（专注于QA），更多干货实践，欢迎交流分享~</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[让你的动画“活”过来：Manim 节奏控制指南 (Rate Functions)]]></title>    <link>https://juejin.cn/post/7575313772988186665</link>    <guid>https://juejin.cn/post/7575313772988186665</guid>    <pubDate>2025-11-23T06:27:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575313772988186665" data-draft-id="7575442779038548010" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="让你的动画“活”过来：Manim 节奏控制指南 (Rate Functions)"/> <meta itemprop="keywords" content="Python,动效,后端"/> <meta itemprop="datePublished" content="2025-11-23T06:27:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="databook"/> <meta itemprop="url" content="https://juejin.cn/user/3526889035006702"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            让你的动画“活”过来：Manim 节奏控制指南 (Rate Functions)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3526889035006702/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    databook
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-23T06:27:44.000Z" title="Sun Nov 23 2025 06:27:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你在制作Manim动画时，是否遇到过这样的困境？</p>
<p>“代码写得天衣无缝，运行流畅，出来的动画却总觉得哪里不对劲？”</p>
<p>虽然物体确实从 A 移动到了 B，但看起来就像是老旧的工业机器人在干活——僵硬、死板，甚至有点无聊。</p>
<p>其实，你的动画离 <strong>“丝滑”</strong> 和 <strong>“专业”</strong>，往往只差这一个参数的距离：<code>rate_func</code> <strong>(速率函数)</strong>。</p>
<p>今天，我们就来聊聊 Manim 中这个不起眼但至关重要的参数，看看如何通过控制 <strong>“时间的流速”</strong>，让你的数学动画不仅能动，而且动得有节奏、有灵魂。</p>
<h2 data-id="heading-0">1. 什么是 Rate Function？（给时间的进度条）</h2>
<p>在 <code>Manim</code> 中，当你写下 <code>.animate.shift(RIGHT)</code> 时，默认发生了什么？</p>
<p>如果你觉得动画只是简单的“在 <code>Run Time</code> 时间内移动距离 <code>RIGHT</code>”，那只对了一半。<code>Rate Function</code> 本质上是<strong>动画完成度与时间的关系</strong>。</p>
<p>想象一下你在看视频时的进度条：</p>
<ul>
<li><strong>输入 (</strong><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"/><span class="mord mathnormal">t</span></span></span></span></span><strong>)</strong>：当前时间过去了多少（从 0 到 1，代表 0% 到 100% 的时间）。</li>
<li><strong>输出 (</strong><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">t</span><span class="mclose">)</span></span></span></span></span><strong>)</strong>：动画实际上完成了多少（从 0 到 1，代表 0% 到 100% 的进度）。</li>
</ul>
<p><strong>默认的魔法</strong>：<code>Smooth</code></p>
<p>Manim 的默认 <code>rate_func</code> 是 <code>smooth</code>。
这符合物理世界的惯性定律：<strong>起步时慢（加速），中间快，快结束时慢（减速）</strong>。</p>
<p>这就是为什么默认的动画看起来比较自然。</p>
<p>如果我们把它换成 <code>linear</code>（线性），物体就会瞬间以最大速度启动，最后瞬间急停，看起来就会很像 <strong>“PPT 动画”</strong>。</p>
<h2 data-id="heading-1">2. 常用函数图鉴：选对“调味料”</h2>
<p><code>Manim</code>内置了一大堆写好的函数，位于 <code>manim.utils.rate_functions</code>。</p>
<p>我们可以把它们看作是给动画调味的香料。</p>
<p>为了方便演示，我们假设我们要移动一个小球。</p>
<h3 data-id="heading-2">2.1. 基础三剑客</h3>
<ul>
<li><code>linear</code> <strong>(匀速)</strong>
<ul>
<li><strong>效果</strong>：机械感强，速度恒定。</li>
<li><strong>适用场景</strong>：旋转的齿轮、循环滚动的背景、匀速扫描的雷达。</li>
</ul>
</li>
<li><code>smooth</code> <strong>(默认)</strong>
<ul>
<li><strong>效果</strong>：两头慢，中间快。</li>
<li><strong>适用场景</strong>：绝大多数物体的移动、缩放。</li>
</ul>
</li>
<li><code>rush_into</code> / <code>rush_from</code>
<ul>
<li><strong>效果</strong>：
<ul>
<li><code>rush_into</code>: 越走越快，最后“砰”地撞线（只有加速）。</li>
<li><code>rush_from</code>: 一开始很快，慢慢停下来（只有减速）。</li>
</ul>
</li>
<li><strong>适用场景</strong>：连续动作的衔接。比如小球飞入画面停下（<code>rush_from</code>），或者发射出去（<code>rush_into</code>）。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-3">2.2. 动感特效组</h3>
<ul>
<li><code>there_and_back</code> <strong>(往返)</strong>
<ul>
<li><strong>效果</strong>：走到终点，又原路返回起点。</li>
<li><strong>适用场景</strong>：强调某个东西。比如把公式放大一下再缩回去，告诉观众“看这里！”。</li>
</ul>
</li>
<li><code>wiggle</code> <strong>(摆动)</strong>
<ul>
<li><strong>效果</strong>：像果冻一样左右晃动一下。</li>
<li><strong>适用场景</strong>：表示“错误”、“拒绝”或者引起注意。</li>
</ul>
</li>
<li><code>running_start</code> <strong>(助跑)</strong>
<ul>
<li><strong>效果</strong>：先向后退一点点，然后猛地向前冲。</li>
<li><strong>适用场景</strong>：想要表现物体很有力量感，或者像卡通片里的冲刺效果。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-4">2.3. 物理模拟组</h3>
<ul>
<li><code>ease_out_bounce</code><strong>(落地反弹)</strong>
<ul>
<li><strong>效果</strong>：像篮球落地一样，到底部后弹跳几次再停下。</li>
<li><strong>适用场景</strong>：文字掉落、物体自由落体。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-5">3. 动手写个 Demo</h2>
<p>光说不练假把式。下面的示例代码可以直观感受不同函数的区别：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> manim <span class="hljs-keyword">import</span> *


<span class="hljs-keyword">class</span> <span class="hljs-title class_">RateFuncComparison</span>(<span class="hljs-title class_ inherited__">Scene</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">construct</span>(<span class="hljs-params">self</span>):
        <span class="hljs-comment"># 定义我们想对比的函数</span>
        funcs = [
            linear,
            smooth,
            rush_from,
            rush_into,
            there_and_back,
            rate_functions.ease_out_bounce,
        ]
        labels = [
            <span class="hljs-string">"Linear"</span>,
            <span class="hljs-string">"Smooth"</span>,
            <span class="hljs-string">"Rush Into"</span>,
            <span class="hljs-string">"Rush From"</span>,
            <span class="hljs-string">"There &amp; Back"</span>,
            <span class="hljs-string">"Bounce"</span>,
        ]

        <span class="hljs-comment"># 创建圆点和文字</span>
        group = VGroup()
        <span class="hljs-keyword">for</span> i, (func, label_text) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(<span class="hljs-built_in">zip</span>(funcs, labels)):
            dot = Dot(color=TEAL)
            label = Text(label_text, font_size=<span class="hljs-number">20</span>).next_to(dot, LEFT)
            row = VGroup(label, dot)
            group.add(row)

        <span class="hljs-comment"># 竖直排列</span>
        group.arrange(DOWN, buff=<span class="hljs-number">0.5</span>).to_edge(LEFT)
        self.add(group)

        <span class="hljs-comment"># 制作动画：让所有点同时向右移动</span>
        <span class="hljs-comment"># 注意：我们在这里分别指定了不同的 rate_func</span>
        anims = []
        <span class="hljs-keyword">for</span> item, func <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(group, funcs):
            dot = item[<span class="hljs-number">1</span>]  <span class="hljs-comment"># 获取组里的 Dot</span>
            anims.append(dot.animate(rate_func=func, run_time=<span class="hljs-number">3</span>).shift(RIGHT * <span class="hljs-number">4</span>))

        self.play(*anims)
</code></pre>
<p>运行后你会发现，虽然大家的 <code>run_time</code> 都是3秒，移动距离一样，但“性格”截然不同。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba75cc74f304474baa5bc441daa970b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764484065&amp;x-signature=tRI%2BaQnQbSKGg%2FU0%2B9Y7jkVccUU%3D" alt="" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-6">4. 进阶：自定义与时间扭曲</h2>
<p>作为会 <code>Python</code> 的老手，如果内置函数满足不了你怎么办？</p>
<h3 data-id="heading-7">4.1. 自定义函数 (Lambda大法)</h3>
<p><code>rate_func</code> 接受任何一个 <code>Python</code> 函数。</p>
<p>比如，你想做一个简单的“先慢后快”的加速效果，可以直接用 <code>Lambda</code>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># y = x^2，典型的加速曲线</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomRateFuncDemo</span>(<span class="hljs-title class_ inherited__">Scene</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">construct</span>(<span class="hljs-params">self</span>):
        <span class="hljs-comment"># 创建一个圆</span>
        circle = Circle(radius=<span class="hljs-number">0.5</span>, color=BLUE).shift(LEFT * <span class="hljs-number">2</span>)
        self.add(circle)

        <span class="hljs-comment"># 使用自定义 rate_func（t**2）让圆向右移动</span>
        self.play(circle.animate(rate_func=<span class="hljs-keyword">lambda</span> t: t**<span class="hljs-number">2</span>).shift(RIGHT * <span class="hljs-number">4</span>), run_time=<span class="hljs-number">3</span>)
        self.wait()
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c07fdccfbf142568d474d62018e7bea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764484065&amp;x-signature=EOzMezuJmYbGmcZSqkTb%2F%2BWPbYs%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">4.2. 时间挤压 (Squish Rate Func)</h3>
<p>这是 <code>Manim</code> 中最强大的黑科技之一：<code>squish_rate_func</code>。</p>
<p>假设你写了一个 <code>run_time=6</code> 的动画，但你希望某个特定的变换（比如变色），</p>
<p>在第 <code>1.2</code> 秒到第 <code>3</code> 秒之间（即整个进度的 <code>0.2</code> 到 <code>0.5</code>）由<strong>白色</strong>变成<strong>红色</strong>；</p>
<p>在第 <code>3</code> 秒到第 <code>4.8</code> 秒之间（即整个进度的 <code>0.5</code> 到 <code>0.8</code>）由<strong>红色</strong>变成<strong>绿色</strong>。</p>
<p>你不需要把动画拆成多段写，只需要：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SquishRateFuncDemo</span>(<span class="hljs-title class_ inherited__">Scene</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">construct</span>(<span class="hljs-params">self</span>):
        <span class="hljs-comment"># 创建一个圆点</span>
        dot = Dot(color=WHITE).shift(LEFT * <span class="hljs-number">2</span>)
        self.add(dot)

        <span class="hljs-comment"># 使用UpdateFromAlphaFunc来同时控制位置和颜色变化</span>
        <span class="hljs-keyword">def</span> <span class="hljs-title function_">update_dot</span>(<span class="hljs-params">obj, alpha</span>):
            <span class="hljs-comment"># 位置变化 - 使用默认的linear速率</span>
            obj.move_to(LEFT * <span class="hljs-number">2</span> + RIGHT * <span class="hljs-number">5</span> * alpha)

            <span class="hljs-comment"># 颜色变化 - 使用squish_rate_func控制变色的时间段</span>
            squished_alpha = squish_rate_func(smooth, <span class="hljs-number">0.2</span>, <span class="hljs-number">0.5</span>)(alpha)
            squished_alpha2 = squish_rate_func(smooth, <span class="hljs-number">0.5</span>, <span class="hljs-number">0.8</span>)(alpha)

            <span class="hljs-keyword">if</span> alpha &lt; <span class="hljs-number">0.5</span>:
                obj.set_color(interpolate_color(WHITE, RED, squished_alpha))
            <span class="hljs-keyword">else</span>:
                obj.set_color(interpolate_color(RED, GREEN, squished_alpha2))

        self.play(
            UpdateFromAlphaFunc(dot, update_dot),
            run_time=<span class="hljs-number">6</span>,
        )
        self.wait()
</code></pre>
<p>这个技巧在制作复杂的多重同步动画时非常有效！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4cb02575866740e7bbb2979d4f804ddc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764484065&amp;x-signature=3Y3bARnc7xdiRnomMl05wftOnVg%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-9">5. 总结</h2>
<p><code>Manim</code> 不仅仅是动画工具，它更像是一个导演工具。</p>
<ul>
<li><code>linear</code> 是为了表现机械、循环。</li>
<li><code>smooth</code> 是为了表现自然、物理。</li>
<li><code>there_and_back</code> / <code>wiggle</code> 是为了引导观众的注意力。</li>
<li><code>squish_rate_func</code> 是为了精准控制时间轴。</li>
</ul>
<p>下次当你的动画看起来略显生硬时，不妨停下来想一想：<em>“这个动作的节奏对吗？是不是该换个 rate function 了？”</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于Hologres构建多模态AI数据分析与检索系统]]></title>    <link>https://juejin.cn/post/7576105458806882304</link>    <guid>https://juejin.cn/post/7576105458806882304</guid>    <pubDate>2025-11-24T10:33:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576105458806882304" data-draft-id="7576086446459797539" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于Hologres构建多模态AI数据分析与检索系统"/> <meta itemprop="keywords" content="数据分析"/> <meta itemprop="datePublished" content="2025-11-24T10:33:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云大数据AI技术"/> <meta itemprop="url" content="https://juejin.cn/user/2414974667341287"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于Hologres构建多模态AI数据分析与检索系统
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2414974667341287/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云大数据AI技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T10:33:02.000Z" title="Mon Nov 24 2025 10:33:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在数据驱动时代，非结构化数据（文本、图像、音视频、日志等）与结构化、半结构化数据（JSON）共同构成企业的核心数据资产。其中，非结构化数据以更原始、多元的形态蕴含着海量的业务洞察（如用户反馈、合同条款、产品缺陷图像），Hologres4.0以“AI时代的一站式多模态分析平台”为核心理念，全面展示了Hologres在结构化、半结构化与非结构化数据分析能力上的重大突破，发布全新向量索引HGraph，登顶 VectorDBBench 性价比榜单QPS、Recall、Latency、Load 四项第一，为AI应用的提供高性价比、高吞吐、低延迟、高并发的向量服务，成为全球最具性价比的向量数据库！</p>
<p><img src="https://intranetproxy.alipay.com/skylark/lark/0/2025/png/234572/1763605302728-d98ab5c3-997d-401d-afcf-592d5a871ef0.png" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">基于Hologres构建多模态AI数据分析与检索系统</h2>
<p>本文将会模拟金融场景中对招股书、合同等PDF文件的检索与分析，以辅助业务进行下一步的精细化运营决策。基于Hologres 4.0 对PDF非结构化数据的处理与检索，包含的主要能力如下：</p>
<ul>
<li>
<p>非结构化数据（Object Table）：支持通过表的形式读取OSS中非结构化数据（PDF/IMAGE/PPT等）。</p>
</li>
<li>
<p>AI Function：在Hologres中可以用标准SQL的方式调用AI Function，自动调用内置大模型，完成AI服务建设场景</p>
</li>
<li>
<p>数据加工：提供Embed、Chunk算子，可以对非结构化数据加工成结构化数据存储，无需使用外部算法就能自动Embed。</p>
</li>
<li>
<p>数据检索和分析：提供<code>ai_gen</code>、<code>ai_summarize</code>等算子，能够通过SQL对数据进行推理、问题总结及翻译等操作。</p>
</li>
<li>
<p>Dynamic Table介绍：支持增量刷新模式对非结构化数据自动加工，每次只计算增量的数据有效减少重复计算，降低资源利用率。</p>
</li>
<li>
<p>向量检索：支持标准SQL的向量检索，用于非结构化数据的相似度搜索、场景识别等，在同一个查询中可以自由地实现向量和标量的检索。</p>
</li>
<li>
<p>全文检索：通过倒排索引、分词等机制实现对非结构化数据的高效检索，支持关键词匹配、短语检索等丰富的检索方式，实现更加灵活的检索。</p>
</li>
</ul>
<h2 data-id="heading-1">方案优势</h2>
<p>通过如上核心能力，在Hologres中多模态AI检索与分析的核心优势如下：</p>
<ul>
<li><strong>完整的<strong><strong>AI</strong></strong>数据处理流程</strong>：涵盖从数据Embed、Chunk、增量加工、检索/分析的全流程，开发人员可以使用大数据系统一样，轻松构建AI应用。</li>
<li><strong>标准<strong><strong>SQL</strong></strong>加工和分析非结构化数据</strong>：无需使用专用开发语言，<strong>纯****SQL</strong>就能完成非结构化数据提取、加工，也无需借助外部系统，数据处理更加高效和简单，降低开发人员学习成本。</li>
<li><strong>检索更精准、灵活和智能</strong>：可以轻松构建“关键词+语义+多模态”的混合检索链路，覆盖从精准搜索到意图理解的全场景需求。还能结合AI Function实现对用户意图的深度理解，语义关联和上下文推理，实现更智能的检索能力。</li>
<li><strong>数据不出库，更安全</strong>：不需要将数据导出到外部系统，与hologres的多种安全能力无缝集成，高效保护数据安全。</li>
</ul>
<p>本实践文档将会介绍如何通过上诉核心能力在Hologres中对非结构化数据加工和检索，助力搭建企业级多模态AI数据平台，打破数据孤岛，释放全域数据价值</p>
<h2 data-id="heading-2">方案流程</h2>
<p>本次方案的流程如下：</p>
<p>1. 数据集准备。</p>
<p>将<a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelscope.cn%2Fdatasets%2FBJQW14B%2Fbs_challenge_financial_14b_dataset" target="_blank" title="https://modelscope.cn/datasets/BJQW14B/bs_challenge_financial_14b_dataset" ref="nofollow noopener noreferrer">金融数据集</a>中的PDF文件上传至OSS存储。</p>
<p>2. PDF数据加工。</p>
<p>使用Object Table读取PDF的元数据信息，然后创建增量刷新的Dynamic Table，并对数据进行Embed和Chunk，同时也对Dynamic Table构建向量索引和全文索引，以便后续检索可以使用索引的能力。</p>
<p>3. 使用<code>ai_embed</code>算子对将自然语言的问题进行Embedding，然后使用全文和向量双路召回结果，并对结果进行排序，结合大模型的推理能力，最终输出相似度最高的答案。</p>
<p><img src="https://intranetproxy.alipay.com/skylark/lark/0/2025/svg/234572/1763604671276-6161ebfd-fe4e-4ba9-8fe7-86ef313bf16b.svg" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">准备工作</h2>
<p>1. 数据准备</p>
<p>本文使用ModelScope公开的金融数据集中的PDF文件夹中的文件，共80份公司招股说明书。</p>
<p>2. 环境准备</p>
<ul>
<li>购买Hologres V4.0及以上版本实例并创建数据库。</li>
<li>购买AI资源。</li>
</ul>
<p>本文以large-96core-512GB-384GB、1个节点为例。</p>
<ul>
<li>模型部署。本次方案使用的模型以及分配的资源为：</li>
</ul>
<p><strong>模型名称</strong></p>
<p><strong>模型类别</strong></p>
<p><strong>模型作用描述</strong></p>
<p><strong>单副本****CPU（Core）</strong></p>
<p><strong>单副本内存</strong></p>
<p><strong>单副本****GPU</strong></p>
<p><strong>资源副本数</strong></p>
<p>to_doc</p>
<p>ds4sd/docling-models</p>
<p>将PDF转换成文档。</p>
<p>20</p>
<p>100 GB</p>
<p>1卡(48 GB)</p>
<p>1</p>
<p>chunk</p>
<p>recursive-character-text-splitter</p>
<p>文档切片，每个PDF较大，建议使用切片。</p>
<p>15</p>
<p>30 GB</p>
<p>0卡(0 GB)</p>
<p>1</p>
<p>pdf_embed</p>
<p>BAAI/bge-base-zh-v1.5</p>
<p>文档Embedding。</p>
<p>7</p>
<p>30 GB</p>
<p>1卡(96 GB)</p>
<p>1</p>
<p>llm</p>
<p>Qwen/Qwen3-32B</p>
<p>使用大模型对检索出的文档内容按照提示词推理.</p>
<p>7</p>
<p>30 GB</p>
<p>1卡(96 GB)</p>
<p>1</p>
<p><strong>说明</strong>上述模型的资源均为默认分配的资源。</p>
<h2 data-id="heading-4">操作步骤</h2>
<p><strong>下载PDF文件并上传至OSS。</strong></p>
<p>1. 下载博金大模型挑战赛-金融千问14b数据集中80份招股书（PDF）。</p>
<p>2. 登录OSS管理控制台，创建Bucket并将已下载的PDF文件上传至该Bucket路径下。上传操作详情，请参见简单上传。</p>
<p><strong>账号授权。</strong><br/>
1. 登录RAM控制台，创建阿里云RAM角色并授予OSS的相关权限。</p>
<p>推荐授予AliyunOSSReadOnlyAccess权限。</p>
<p>2. 为上述阿里云RAM角色添加登录和Hologres的访问权限。</p>
<p>阿里云账号（主账号）</p>
<p>修改RAM角色的信任策略。重点需更新如下参数：</p>
<ul>
<li>
<p>Action：更新为<code>sts:AssumeRole</code>。</p>
</li>
<li>
<p>Service：更新为<code>hologres.aliyuncs.com</code>。</p>
<p>{
"Statement": [
{
"Action": "sts:AssumeRole",
"Effect": "Allow",
"Principal": {
"RAM": [
"acs:ram::1866xxxx:root"
],
"Service": [
"hologres.aliyuncs.com"
]
}
}
],
"Version": "1"
}</p>
</li>
</ul>
<p>RAM用户（子账号）<br/>
1. 为RAM用户授权。</p>
<ul>
<li>在<strong>权限管理</strong> <strong>&gt;</strong> <strong>权限策略</strong>页面，单击<strong>创建权限策略</strong>，并选择<strong>脚本编辑</strong>模式创建权限策略。具体操作，请参见创建自定义权限策略</li>
</ul>
<p>Hologres可通过该策略判断当前RAM用户是否具备创建对应RAM角色的权限。权限策略内容如下。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"Version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"Statement"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"Effect"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Allow"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Action"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"hologram:GrantAssumeRole"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Resource"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&lt;arn账号&gt;"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li>在<strong>身份管理 &gt; 用户</strong>页面，单击目标RAM用户<strong>操作</strong>列中的<strong>添加权限</strong>，为RAM用户（子账号）授予上述步骤已创建的权限策略。具体操作，请参见为RAM用户授权。</li>
</ul>
<p>2. 为已创建的RAM角色授权。</p>
<p>修改RAM角色的信任策略。重点需更新如下参数：</p>
<ul>
<li>
<p>Action：更新为<code>sts:AssumeRole</code>。</p>
</li>
<li>
<p>Service：更新为<code>hologres.aliyuncs.com</code>。</p>
<p>{
"Statement": [
{
"Action": "sts:AssumeRole",
"Effect": "Allow",
"Principal": {
"RAM": [
"acs:ram::1866xxxx:root"
],
"Service": [
"hologres.aliyuncs.com"
]
}
}
],
"Version": "1"
}</p>
</li>
</ul>
<p>3. 对PDF文件进行Embedding和Chunk。</p>
<p>需要创建Object Table和Dynamic Table对PDF的元数据读取以及加工。因为流程较长，Hologres直接将其封装为存储过程。该存储过程包括的能力如下：</p>
<ul>
<li>会创建一张Object Table，用于取PDF的元数据。</li>
<li>创建一张增量刷新模式的Dynamic Table结果表，用于存储加工后的数据。同时，该表需设置向量索引和全文索引，且Dynamic Table不设置自动刷新，需要手动刷新。</li>
<li>Dynamic Table的刷新过程中会使用<code>ai_embed</code>、<code>ai_chunk</code>对数据进行Embed和切片。</li>
</ul>
<p>该存储过程代码如下：</p>
<pre><code class="hljs language-ini" lang="ini">CALL create_rag_corpus_from_oss(
    <span class="hljs-attr">oss_path</span> =&gt; <span class="hljs-string">'oss://xxxx/bs_challenge_financial_14b_dataset/pdf'</span>,
    <span class="hljs-attr">oss_endpoint</span> =&gt; <span class="hljs-string">'oss-cn-hangzhou-internal.aliyuncs.com'</span>,
    <span class="hljs-attr">oss_role_arn</span> =&gt; <span class="hljs-string">'acs:ram::186xxxx:role/xxxx'</span>,
    <span class="hljs-attr">corpus_table</span> =&gt; <span class="hljs-string">'public.dt_bs_challenge_financial'</span>
)<span class="hljs-comment">;</span>
</code></pre>
<p>4. 刷新结果表。</p>
<p>通过如上存储过程创建的Object Table和Dynamic Table均需手动刷新，才能完成数据加工。该步骤已被封装为PDF加工存储过程，该存储过程包括的能力如下：</p>
<ul>
<li>刷新一次Object Table获取PDF元数据</li>
<li>刷新一次Dynamic Table，进行PDF的Embedding和Chunk加工。</li>
</ul>
<p>该存储过程使用代码如下：</p>
<pre><code class="hljs language-ini" lang="ini">CALL refresh_rag_corpus_table(
    <span class="hljs-attr">corpus_table</span> =&gt; <span class="hljs-string">'public.dt_bs_challenge_financial'</span>
)<span class="hljs-comment">;</span>
</code></pre>
<p>5. PDF检索。</p>
<p>加工好的数据可以根据业务使用场景，通过向量、全文等方式进行检索。例如：可以根据招股书来查询某个公司的业绩走势，以此来判断公司后续的走势是悲观还是乐观，以便对后续的投资意向提供辅助建议。</p>
<h3 data-id="heading-5">向量检索</h3>
<p>在向量检索时，为了检索方便，我们将问题Embedding和Prompt构建，大模型输出答案等过程封装成为<a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Fhologres%2Fuser-guide%2Fbest-practices-financial-multimodal-ai-data-analysis-and-retrieval-system%3Fspm%3Da2c4g.11186623.help-menu-113622.d_2_6_5_0.476c4bf26JuD6N%26scm%3D20140722.H_2982978._.OR_help-T_cn~zh-V_1%239b9ac4eba36lk" target="_blank" title="https://help.aliyun.com/zh/hologres/user-guide/best-practices-financial-multimodal-ai-data-analysis-and-retrieval-system?spm=a2c4g.11186623.help-menu-113622.d_2_6_5_0.476c4bf26JuD6N&amp;scm=20140722.H_2982978._.OR_help-T_cn~zh-V_1#9b9ac4eba36lk" ref="nofollow noopener noreferrer">向量检索函数</a>，直接调用如下该存储过程可以实现向量召回。</p>
<pre><code class="hljs language-ini" lang="ini">-- 向量单路召回 + AI重排
SELECT qa_vector_search_retrieval(
  <span class="hljs-attr">question</span> =&gt; <span class="hljs-string">'报告期内，湖南国科微电子股份有限公司2014年度、2015年度、2016年度营业收入和净利润分别较上年增长多大幅度？'</span>,
  <span class="hljs-attr">corpus_table</span> =&gt; <span class="hljs-string">'dt_bs_challenge_financial'</span>,
  <span class="hljs-attr">prompt</span> =&gt; <span class="hljs-string">'请分析如下业绩走势是悲观还是乐观，并给出原因：${question}\n\n 参考信息：\n\n ${context}'</span>
)
</code></pre>
<p>检索答案如下：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section">qa<span class="hljs-emphasis">_retrieval
---------
"根据提供的信息，对湖南国科微电子股份有限公司的业绩走势进行分析，可以得出以下结论：

### 一、业绩走势分析：悲观

#### 1. <span class="hljs-strong">**营业收入增长乏力**</span>
- 2014年度营业收入较上年增长 <span class="hljs-strong">**15.13%**</span>，但2015年度营业收入却 <span class="hljs-strong">**下降5.21%**</span>，2016年度数据未提供，但可以看出营业收入增长趋势在2015年出现明显下滑。
- 2012年至2014年营业收入的年复合增长率仅为 <span class="hljs-strong">**4.47%**</span>，表明公司业务扩张较为缓慢。

#### 2. <span class="hljs-strong">**净利润增长持续下降**</span>
- 2014年度净利润增长 <span class="hljs-strong">**5.43%**</span>，2015年度净利润 <span class="hljs-strong">**下降3.29%**</span>。
- 扣除非经常性损益后，2014年度归属于母公司股东的净利润增长 <span class="hljs-strong">**-3.14%**</span>，2015年度进一步下降 <span class="hljs-strong">**-5.60%**</span>，表明公司主营业务盈利能力在持续恶化。
- 2012年至2014年扣除非经常性损益后净利润的年复合增长率为 <span class="hljs-strong">**-4.38%**</span>，远低于营业收入增长，说明公司主营业务盈利能力不足，增长主要依赖非经常性损益。

#### 3. <span class="hljs-strong">**非经常性损益占比偏高**</span>
- 报告期内，非经常性损益占净利润的比例较高，2014年、2013年、2012年分别为 <span class="hljs-strong">**17.54%、10.25%、8.06%**</span>，表明公司利润中有一部分来自政策扶持、政府补贴等非经常性因素，而非核心业务的持续增长。
- 依赖非经常性损益来维持利润增长，不利于公司长期的稳定发展。

#### 4. <span class="hljs-strong">**净资产收益率下降**</span>
- 加权平均净资产收益率从2014年的 <span class="hljs-strong">**18.10%**</span> 下降到2015年的 <span class="hljs-strong">**24.82%**</span>，再到2016年的 <span class="hljs-strong">**28.23%**</span>，虽然数据看似增长，但需注意该指标是以扣除非经常性损益后的净利润计算的，而净利润本身在下降，因此这种增长可能与资本结构变化有关，而非盈利能力的实质性提升。

### 二、原因总结
1. <span class="hljs-strong">**主营业务增长乏力**</span>：营业收入和净利润增长均呈现下降趋势，尤其是净利润的下降表明公司盈利能力在减弱。
2. <span class="hljs-strong">**非经常性损益依赖度高**</span>：公司利润中非经常性损益占比较高，说明主营业务的盈利能力不足，公司业绩的持续性存疑。
3. <span class="hljs-strong">**市场竞争激烈**</span>：公司采购的工控机、显示器、电源等产品市场竞争激烈，价格平稳，利润空间受到挤压。
4. <span class="hljs-strong">**行业环境影响**</span>：不锈钢市场价格波动、原材料价格波动可能对公司经营业绩造成一定影响，虽然公司已采取措施降低影响，但长期来看仍需关注。

### 三、结论
总体来看，湖南国科微电子股份有限公司的业绩走势偏 <span class="hljs-strong">**悲观**</span>。公司主营业务增长乏力，净利润持续下降，对非经常性损益依赖度高，未来盈利能力的可持续性存疑。公司需要加强核心业务的竞争力，优化成本结构，提高主营业务盈利能力，以实现长期稳健发展。"
</span></span></code></pre>
<h3 data-id="heading-6">全文检索</h3>
<p>在全文检索时，为了检索方便，我们将问题Embedding和Prompt构建，大模型输出答案等过程封装为全文检索函数，直接调用如下存储过程可以实现全文召回：</p>
<pre><code class="hljs language-ini" lang="ini">--全文检索召回
SELECT qa_text_search_retrieval(
    <span class="hljs-attr">question</span> =&gt; <span class="hljs-string">'报告期内，湖南国科微电子股份有限公司2014年度、2015年度、2016年度营业收入和净利润分别较上年增长多大幅度？'</span>,
    <span class="hljs-attr">corpus_table</span> =&gt; <span class="hljs-string">'dt_bs_challenge_financial'</span>,
    <span class="hljs-attr">prompt</span> =&gt; <span class="hljs-string">'请分析如下业绩走势是悲观还是乐观，并给出原因：${question}\n\n 参考信息：\n\n ${context}'</span>
)<span class="hljs-comment">;</span>
</code></pre>
<p>检索答案如下：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section">qa<span class="hljs-emphasis">_text_</span>search<span class="hljs-emphasis">_retrieval
----------------
"根据提供的信息，湖南国科微电子股份有限公司在2014年、2015年和2016年的业绩走势整体上呈现<span class="hljs-strong">**悲观**</span>趋势，具体原因如下：

### 1. <span class="hljs-strong">**营业收入增长乏力**</span>
- 2014年营业收入增长率为<span class="hljs-strong">**15.13%**</span>，但2015年营业收入增长率转为<span class="hljs-strong">**-5.21%**</span>，即出现负增长。
- 2012年至2014年的营业收入年复合增长率仅为<span class="hljs-strong">**4.47%**</span>，说明公司营业收入增长较为缓慢，业务发展不够强劲。
- 2015年上半年营业收入预测与2014年同期相比大致持平，但2015年上半年净利润较上年同期<span class="hljs-strong">**略有下降**</span>，表明盈利能力下降。

### 2. <span class="hljs-strong">**净利润和扣非净利润增长不佳**</span>
- 2014年净利润增长率为<span class="hljs-strong">**5.43%**</span>，2015年净利润增长率下降为<span class="hljs-strong">**-3.29%**</span>，即净利润出现下滑。
- 扣除非经常性损益后的净利润增长率在2014年为<span class="hljs-strong">**-3.14%**</span>，2015年进一步下降为<span class="hljs-strong">**-5.60%**</span>，说明公司主营业务的盈利能力持续下降。
- 2012年至2014年扣非净利润的年复合增长率为<span class="hljs-strong">**-4.38%**</span>，明显低于营业收入的年复合增长率，说明公司利润质量不高，主营业务盈利能力较弱。

### 3. <span class="hljs-strong">**经营活动现金流波动**</span>
- 2014年销售商品、提供劳务收到的现金占营业收入的比例较前两年有所下降，主要与部分收入确认项目的<span class="hljs-strong">**收款跨期**</span>有关，说明公司现金流管理存在问题。
- 2013年购买商品、接受劳务支付的现金占营业成本比例较高，主要是由于当年<span class="hljs-strong">**采购原材料并完成生产**</span>，但部分成本在2014年才结转，导致2014年该比例较低，反映公司采购和生产节奏不够稳定。

### 4. <span class="hljs-strong">**投资和盈利能力指标**</span>
- 加权平均净资产收益率（ROE）在2014年为<span class="hljs-strong">**18.10%**</span>，2015年上升至<span class="hljs-strong">**24.82%**</span>，2016年进一步上升至<span class="hljs-strong">**28.23%**</span>，虽然有所提升，但ROE的提高可能主要依赖<span class="hljs-strong">**财务杠杆**</span>，而非核心业务盈利能力的提升。
- 考虑到净利润和扣非净利润持续下降，ROE的提升并不能完全反映公司经营质量的改善。

### 5. <span class="hljs-strong">**2015年上半年业绩预测**</span>
- 2015年上半年营业收入预计为<span class="hljs-strong">**8,505万元至10,395万元**</span>，与2014年同期的<span class="hljs-strong">**10,127.35万元**</span>大致持平，但净利润预计为<span class="hljs-strong">**2,340万元至2,860万元**</span>，低于2014年同期的<span class="hljs-strong">**2,912.66万元**</span>，说明公司盈利能力下降。

### 总结
综合来看，湖南国科微电子股份有限公司在2014年至2016年的业绩走势<span class="hljs-strong">**偏向悲观**</span>。虽然ROE有所提升，但营业收入增长乏力、净利润和扣非净利润持续下降、经营活动现金流波动较大，表明公司主营业务盈利能力较弱，经营质量有待提升。"
</span></span></code></pre>
<h3 data-id="heading-7">向量+全文混合检索</h3>
<p>在向量、全文结合Rank排序混合检索场景中，为了检索方便，Hologres将其封装为向量+全文双路召回+Rank排序函数，该存储过程的能力如下：</p>
<ul>
<li>
<p>根据问题使用向量计算，召回TOP 20的答案。</p>
</li>
<li>
<p>根据问题使用全文检索，召回TOP 20的答案。</p>
</li>
<li>
<p>使用<code>ai_rank</code>，对向量和全文召回的答案进行排序，最后输出Top1的答案。</p>
</li>
<li>
<p>使用<code>ai_gen</code>，结合大模型根据提示词以及检索的答案，生成最终答案并进行输出。</p>
<p>-- 全文、向量双路召回 + AI重排
SELECT qa_hybrid_retrieval(
question =&gt; '报告期内，湖南国科微电子股份有限公司2014年度、2015年度、2016年度营业收入和净利润分别较上年增长多大幅度？',
corpus_table =&gt; 'dt_bs_challenge_financial',
prompt =&gt; '请分析如下业绩走势是悲观还是乐观，并给出原因：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi>q</mi><mi>u</mi><mi>e</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi></mrow><mstyle mathcolor="#cc0000"><mtext>\n</mtext></mstyle><mstyle mathcolor="#cc0000"><mtext>\n</mtext></mstyle><mtext>参考信息：</mtext><mstyle mathcolor="#cc0000"><mtext>\n</mtext></mstyle><mstyle mathcolor="#cc0000"><mtext>\n</mtext></mstyle></mrow><annotation encoding="application/x-tex">{question}\n\n 参考信息：\n\n </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord mathnormal">u</span><span class="mord mathnormal">es</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span></span><span class="mord text" style="color:#cc0000;"><span class="mord" style="color:#cc0000;">\n</span></span><span class="mord text" style="color:#cc0000;"><span class="mord" style="color:#cc0000;">\n</span></span><span class="mord cjk_fallback">参考信息：</span><span class="mord text" style="color:#cc0000;"><span class="mord" style="color:#cc0000;">\n</span></span><span class="mord text" style="color:#cc0000;"><span class="mord" style="color:#cc0000;">\n</span></span></span></span></span></span>{context}'
);</p>
</li>
</ul>
<p>检索答案如下：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section">qa<span class="hljs-emphasis">_hybrid_</span>retrieval
---</span>
"根据提供的信息，我们可以对湖南国科微电子股份有限公司的业绩走势进行如下分析，并判断其趋势是悲观还是乐观：

---

<span class="hljs-section">### 一、<span class="hljs-strong">**营业收入走势分析**</span></span>
<span class="hljs-bullet">1.</span> <span class="hljs-strong">**2012-2014年复合增长率**</span>：
<span class="hljs-bullet">   -</span> 营业收入的年复合增长率为 <span class="hljs-strong">**4.47%**</span>，表明公司营业收入的增长较为平稳。
<span class="hljs-bullet">   -</span> 2014年营业收入为 <span class="hljs-strong">**18,154.06万元**</span>，较2013年增长 <span class="hljs-strong">**15.13%**</span>。
<span class="hljs-bullet">   -</span> 2015年营业收入较上年 <span class="hljs-strong">**下降5.21%**</span>，出现了负增长。

<span class="hljs-bullet">2.</span> <span class="hljs-strong">**结论**</span>：
<span class="hljs-bullet">   -</span> 营业收入的增长在2014年有所回升，但2015年出现明显下滑，表明公司业务扩张遇到了一定阻力。

---

<span class="hljs-section">### 二、<span class="hljs-strong">**净利润走势分析**</span></span>
<span class="hljs-bullet">1.</span> <span class="hljs-strong">**2012-2014年复合增长率**</span>：
<span class="hljs-bullet">   -</span> 扣除非经常性损益后的净利润年复合增长率为 <span class="hljs-strong">**-4.38%**</span>，低于营业收入的年复合增长率，说明公司盈利能力有所下降。
<span class="hljs-bullet">   -</span> 2014年扣非净利润为 <span class="hljs-strong">**42,731,071.18元**</span>，较2013年下降 <span class="hljs-strong">**3.14%**</span>。
<span class="hljs-bullet">   -</span> 2015年扣非净利润较上年进一步下降 <span class="hljs-strong">**5.60%**</span>。

<span class="hljs-bullet">2.</span> <span class="hljs-strong">**非经常性损益影响**</span>：
<span class="hljs-bullet">   -</span> 2014年、2013年及2012年非经常性损益占净利润的比例分别为 <span class="hljs-strong">**17.54%、10.25%、8.06%**</span>，呈上升趋势。
<span class="hljs-bullet">   -</span> 非经常性损益的增加主要来自于政府补贴和理财产品收益，而非主营业务带来的持续增长。

<span class="hljs-bullet">3.</span> <span class="hljs-strong">**结论**</span>：
<span class="hljs-bullet">   -</span> 扣非净利润连续两年下降，说明公司主营业务盈利能力减弱，业绩增长依赖于非经常性损益，这是令人担忧的信号。

---

<span class="hljs-section">### 三、<span class="hljs-strong">**现金流量与经营稳定性**</span></span>
<span class="hljs-bullet">1.</span> <span class="hljs-strong">**经营活动现金流**</span>：
<span class="hljs-bullet">   -</span> 2014年营业收入为 <span class="hljs-strong">**18,154.06万元**</span>，但销售商品、提供劳务收到的现金并未明确给出，无法判断现金流是否健康。
<span class="hljs-bullet">   -</span> 报告期内，公司银行存款分别为 <span class="hljs-strong">**13,063.38万元、4,152.54万元、9,864.61万元**</span>，资金流动性波动较大，但主要客户、供应商及经营模式保持稳定。

<span class="hljs-bullet">2.</span> <span class="hljs-strong">**结论**</span>：
<span class="hljs-bullet">   -</span> 虽然公司现金流存在波动，但客户和供应商稳定，经营模式未发生重大变化，这为公司未来的发展提供了一定保障。

---

<span class="hljs-section">### 四、<span class="hljs-strong">**2015年上半年业绩预测**</span></span>
<span class="hljs-bullet">-</span> 2015年1至6月预计营业收入为 <span class="hljs-strong">**8,505万元至10,395万元**</span>，较2014年同期的 <span class="hljs-strong">**4,641.19万元**</span>有明显增长。
<span class="hljs-bullet">-</span> 但2015年1至3月净利润较上年同期下降 <span class="hljs-strong">**48.26%**</span>，主要是因为确认收入的项目毛利率较低。

---

<span class="hljs-section">### 五、<span class="hljs-strong">**综合分析与判断**</span></span>
<span class="hljs-bullet">1.</span> <span class="hljs-strong">**乐观因素**</span>：
<span class="hljs-bullet">   -</span> 2014年营业收入增长较快，达到 <span class="hljs-strong">**15.13%**</span>。
<span class="hljs-bullet">   -</span> 2015年上半年营业收入预计增长显著，表明公司可能正在逐步恢复。
<span class="hljs-bullet">   -</span> 主要客户、供应商及经营模式保持稳定，为公司提供了良好的运营基础。

<span class="hljs-bullet">2.</span> <span class="hljs-strong">**悲观因素**</span>：
<span class="hljs-bullet">   -</span> 2015年营业收入较上年 <span class="hljs-strong">**下降5.21%**</span>，净利润也出现下滑。
<span class="hljs-bullet">   -</span> 扣非净利润连续两年下降，表明公司主营业务盈利能力不足。
<span class="hljs-bullet">   -</span> 非经常性损益占比上升，业绩增长依赖于政府补贴和理财产品收益，缺乏内生增长动力。
<span class="hljs-bullet">   -</span> 2015年1至3月净利润大幅下滑 <span class="hljs-strong">**48.26%**</span>，表明短期业绩波动较大。

---

<span class="hljs-section">### <span class="hljs-strong">**最终结论：整体趋势偏悲观**</span></span>
<span class="hljs-bullet">-</span> 尽管公司在2014年营业收入有所回升，且2015年上半年预计增长，但 <span class="hljs-strong">**扣非净利润连续下降**</span>、<span class="hljs-strong">**净利润增长依赖非经常性损益**</span>、<span class="hljs-strong">**短期业绩波动较大**</span>，表明公司目前的业绩增长缺乏持续性和稳定性。
<span class="hljs-bullet">-</span> 因此，从长期来看，公司业绩走势偏 <span class="hljs-strong">**悲观**</span>，需关注其主营业务盈利能力的改善和非经常性损益的依赖问题。

---

<span class="hljs-section">### <span class="hljs-strong">**建议**</span></span>
<span class="hljs-bullet">1.</span> 关注公司未来主营业务的盈利能力是否能有所提升。
<span class="hljs-bullet">2.</span> 降低对非经常性损益的依赖，提高内生增长动力。
<span class="hljs-bullet">3.</span> 稳定客户和供应商关系，优化业务结构，提高毛利率。"
</code></pre>
<h3 data-id="heading-8">向量+全文双路召回+RRF排序</h3>
<p>使用向量和全文检索后，通过RRF （Reciprocal Rank Fusion）排序召回结果。为了检索方便，Hologres已经封装为<a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Fhologres%2Fuser-guide%2Fbest-practices-financial-multimodal-ai-data-analysis-and-retrieval-system%3Fspm%3Da2c4g.11186623.help-menu-113622.d_2_6_5_0.476c4bf26JuD6N%26scm%3D20140722.H_2982978._.OR_help-T_cn~zh-V_1%232aec0a43d8flv" target="_blank" title="https://help.aliyun.com/zh/hologres/user-guide/best-practices-financial-multimodal-ai-data-analysis-and-retrieval-system?spm=a2c4g.11186623.help-menu-113622.d_2_6_5_0.476c4bf26JuD6N&amp;scm=20140722.H_2982978._.OR_help-T_cn~zh-V_1#2aec0a43d8flv" ref="nofollow noopener noreferrer">向量+全文双路召回+RRF排序函数</a>（详细定义见下方附录），该存储过程的能力如下：</p>
<ul>
<li>
<p>根据问题使用向量计算，召回TOP 20的答案。</p>
</li>
<li>
<p>根据问题使用全文检索，召回TOP 20的答案。</p>
</li>
<li>
<p>对向量和全文召回的答案，计算RRF分数，最后输出Top N的答案。</p>
</li>
<li>
<p>使用<code>ai_gen</code>、大模型根据提示词，以及检索的答案，拼装成最终答案并输出。</p>
<p>-- 全文、向量双路召回 + RRF重排
SELECT qa_hybrid_retrieval_rrf(
question =&gt; '报告期内，湖南国科微电子股份有限公司2014年度、2015年度、2016年度营业收入和净利润分别较上年增长多大幅度？',
corpus_table =&gt; 'dt_bs_challenge_financial',
prompt =&gt; '请分析如下业绩走势是悲观还是乐观，并给出原因：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi>q</mi><mi>u</mi><mi>e</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi></mrow><mstyle mathcolor="#cc0000"><mtext>\n</mtext></mstyle><mstyle mathcolor="#cc0000"><mtext>\n</mtext></mstyle><mtext>参考信息：</mtext><mstyle mathcolor="#cc0000"><mtext>\n</mtext></mstyle><mstyle mathcolor="#cc0000"><mtext>\n</mtext></mstyle></mrow><annotation encoding="application/x-tex">{question}\n\n 参考信息：\n\n </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord mathnormal">u</span><span class="mord mathnormal">es</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span></span><span class="mord text" style="color:#cc0000;"><span class="mord" style="color:#cc0000;">\n</span></span><span class="mord text" style="color:#cc0000;"><span class="mord" style="color:#cc0000;">\n</span></span><span class="mord cjk_fallback">参考信息：</span><span class="mord text" style="color:#cc0000;"><span class="mord" style="color:#cc0000;">\n</span></span><span class="mord text" style="color:#cc0000;"><span class="mord" style="color:#cc0000;">\n</span></span></span></span></span></span>{context}'
);</p>
</li>
</ul>
<p>检索答案如下：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section">qa<span class="hljs-emphasis">_hybrid_</span>retrieval<span class="hljs-emphasis">_rrf
------------------
"根据提供的信息，对湖南国科微电子股份有限公司的业绩走势进行分析，可以得出以下结论：

### <span class="hljs-strong">**业绩走势判断：悲观**</span>
#### <span class="hljs-strong">**原因分析如下：**</span>

1. <span class="hljs-strong">**净利润增长低于营业收入增长：**</span>
   - 提供的信息指出，公司2012年至2014年的<span class="hljs-strong">**营业收入年复合增长率为4.47%**</span>，表明公司整体业务增长较为平稳。
   - 但<span class="hljs-strong">**扣除非经常性损益后归属于母公司股东的净利润年复合增长率为-4.38%**</span>，明显低于营业收入的增长率。这说明公司在收入增长的同时，盈利能力并未同步提升，甚至出现下滑，可能受到成本上升、毛利率下降或非经常性损益减少等因素影响。

2. <span class="hljs-strong">**净利润波动较大：**</span>
   - 2015年1至3月的净利润较上年同期减少了48.26%，且主要原因在于确认收入的项目毛利率较低（如无锡地铁一号线项目以模块外购为主）。这表明公司短期业绩容易受到业务结构变化的影响，存在一定的不稳定性。

3. <span class="hljs-strong">**毛利率和盈利能力下降：**</span>
   - 提到“主营业务利润对公司净利润的贡献”在2014年较2013年略有下降，而2013年又较2012年下降。这说明公司核心业务的盈利能力可能在减弱，可能受到市场竞争加剧、成本上升或产品结构变化的影响。

4. <span class="hljs-strong">**2015年上半年预测利润下降：**</span>
   - 2015年1至6月预计营业收入为8,505万元至10,395万元，与2014年同期大致持平，但净利润预计为2,340万元至2,860万元，低于2014年同期的2,912.66万元。这表明公司盈利能力在进一步下降，可能面临一定的经营压力。

5. <span class="hljs-strong">**业务增长乏力：**</span>
   - 虽然营业收入增长较为平稳，但净利润的下降表明公司业务增长的质量不高，未能有效转化为利润。这可能影响投资者对公司未来发展的信心。

### <span class="hljs-strong">**总结：**</span>
湖南国科微电子股份有限公司的业绩走势整体偏向<span class="hljs-strong">**悲观**</span>。虽然营业收入保持了平稳增长，但净利润的增长明显滞后甚至出现负增长，表明公司盈利能力在下降，业务发展质量不高，且存在短期业绩波动的风险。如果公司不能有效提升毛利率、控制成本或优化产品结构，未来业绩可能继续承压。"
</span></span></code></pre>
<h2 data-id="heading-9">附录：存储过程定义</h2>
<p>上述文档中使用的存储过程定义如下，方便您做参考。</p>
<p>说明在Hologres中不支持创建Function，如下存储过程仅做参考，无法修改后直接执行。</p>
<h3 data-id="heading-10">PDF加工存储过程</h3>
<ul>
<li>
<p>创建Object Table和Dynamic Table</p>
<p>CREATE OR REPLACE PROCEDURE create_rag_corpus_from_oss(
oss_path TEXT,
oss_endpoint TEXT,
oss_role_arn TEXT,
corpus_table TEXT,
embedding_model TEXT DEFAULT NULL,
parse_document_model TEXT DEFAULT NULL,
chunk_model TEXT DEFAULT NULL,
chunk_size INT DEFAULT 300,
chunk_overlap INT DEFAULT 50,
overwrite BOOLEAN DEFAULT FALSE
)
AS $$
DECLARE
corpus_schema TEXT;
corpus_name TEXT;
obj_table_name TEXT;
full_corpus_ident TEXT;
full_obj_ident TEXT;
embed_expr TEXT;
chunk_expr TEXT;
parse_expr TEXT;
embedding_dims INT;
BEGIN
-- 1. 拆 schema name + table name
IF position('.' in corpus_table) &gt; 0 THEN
corpus_schema := split_part(corpus_table, '.', 1);
corpus_name   := split_part(corpus_table, '.', 2);
ELSE
corpus_schema := 'public';
corpus_name   := corpus_table;
END IF;</p>
<pre><code class="hljs language-sql" lang="sql">obj_table_name :<span class="hljs-operator">=</span> corpus_name <span class="hljs-operator">||</span> <span class="hljs-string">'_obj_table'</span>;

full_corpus_ident :<span class="hljs-operator">=</span> format(<span class="hljs-string">'%I.%I'</span>, corpus_schema, corpus_name);
full_obj_ident    :<span class="hljs-operator">=</span> format(<span class="hljs-string">'%I.%I'</span>, corpus_schema, obj_table_name);

<span class="hljs-comment">-- 2. 如果需要覆盖，先删表和索引</span>
IF overwrite <span class="hljs-keyword">THEN</span>
    <span class="hljs-keyword">DECLARE</span>
        dyn_table_exists <span class="hljs-type">BOOLEAN</span>;
        rec RECORD;
    <span class="hljs-keyword">BEGIN</span>
        <span class="hljs-comment">-- 检查 dynamic table 是否存在</span>
        <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">EXISTS</span> (
            <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>
            <span class="hljs-keyword">FROM</span> pg_class c
            <span class="hljs-keyword">JOIN</span> pg_namespace n <span class="hljs-keyword">ON</span> n.oid <span class="hljs-operator">=</span> c.relnamespace
            <span class="hljs-keyword">WHERE</span> c.relname <span class="hljs-operator">=</span> corpus_name
            <span class="hljs-keyword">AND</span> n.nspname <span class="hljs-operator">=</span> corpus_schema
        )
        <span class="hljs-keyword">INTO</span> dyn_table_exists;

        IF dyn_table_exists <span class="hljs-keyword">THEN</span>
            <span class="hljs-comment">-- 2.1 关闭动态表自动刷新</span>
            <span class="hljs-comment">-- RAISE NOTICE 'Disabling auto refresh for %', full_corpus_ident;</span>
            <span class="hljs-comment">-- EXECUTE format('ALTER TABLE IF EXISTS %s SET (auto_refresh_enable=false)', full_corpus_ident);</span>

            <span class="hljs-comment">-- 2.2 查找 RUNNING 刷新任务并取消</span>
            <span class="hljs-keyword">FOR</span> rec <span class="hljs-keyword">IN</span>
                <span class="hljs-keyword">EXECUTE</span> format(
                    $f$
                    <span class="hljs-keyword">SELECT</span> query_job_id
                        <span class="hljs-keyword">FROM</span> hologres.hg_dynamic_table_refresh_log(<span class="hljs-operator">%</span>L)
                        <span class="hljs-keyword">WHERE</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'RUNNING'</span>;
                    $f$,
                    corpus_table
                )
            LOOP
                RAISE NOTICE <span class="hljs-string">'Found running refresh job: %'</span>, rec.query_job_id;
                IF hologres.hg_internal_cancel_query_job(rec.query_job_id::<span class="hljs-type">bigint</span>) <span class="hljs-keyword">THEN</span>
                    RAISE NOTICE <span class="hljs-string">'Cancel job % succeeded.'</span>, rec.query_job_id;
                <span class="hljs-keyword">ELSE</span>
                    RAISE WARNING <span class="hljs-string">'Cancel job % failed.'</span>, rec.query_job_id;
                <span class="hljs-keyword">END</span> IF;
            <span class="hljs-keyword">END</span> LOOP;

            <span class="hljs-comment">-- 2.3 删除 Dynamic Table</span>
            <span class="hljs-keyword">EXECUTE</span> format(<span class="hljs-string">'DROP TABLE IF EXISTS %s;'</span>, full_corpus_ident);
        <span class="hljs-keyword">ELSE</span>
            RAISE NOTICE <span class="hljs-string">'Dynamic table % does not exist, skip cancel job and drop.'</span>, full_corpus_ident;
        <span class="hljs-keyword">END</span> IF;

        <span class="hljs-comment">-- 2.4 无论如何，Object Table 都要删除</span>
        <span class="hljs-keyword">EXECUTE</span> format(<span class="hljs-string">'DROP OBJECT TABLE IF EXISTS %s;'</span>, full_obj_ident);
    <span class="hljs-keyword">END</span>;
<span class="hljs-keyword">END</span> IF;

<span class="hljs-comment">-- 3. 创建 Object Table</span>
RAISE NOTICE <span class="hljs-string">'Create object table: %'</span>, obj_table_name;
<span class="hljs-keyword">EXECUTE</span> format(
    $f$
    <span class="hljs-keyword">CREATE</span> OBJECT <span class="hljs-keyword">TABLE</span> <span class="hljs-operator">%</span>s
    <span class="hljs-keyword">WITH</span> (
        path <span class="hljs-operator">=</span> <span class="hljs-operator">%</span>L,
        oss_endpoint <span class="hljs-operator">=</span> <span class="hljs-operator">%</span>L,
        role_arn <span class="hljs-operator">=</span> <span class="hljs-operator">%</span>L
    );
    $f$,
    full_obj_ident,
    oss_path,
    oss_endpoint,
    oss_role_arn
);

<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- 4. 刷新 Object Table</span>
RAISE NOTICE <span class="hljs-string">'Refresh object table: %'</span>, obj_table_name;
<span class="hljs-keyword">EXECUTE</span> format(<span class="hljs-string">'REFRESH OBJECT TABLE %s;'</span>, full_obj_ident);

<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- 5. 文档解析模型选择</span>
IF parse_document_model <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">OR</span> length(<span class="hljs-built_in">trim</span>(parse_document_model)) <span class="hljs-operator">=</span> <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span>
    parse_expr :<span class="hljs-operator">=</span> <span class="hljs-string">'ai_parse_document(file, ''auto'', ''markdown'')'</span>;
<span class="hljs-keyword">ELSE</span>
    parse_expr :<span class="hljs-operator">=</span> format(
        <span class="hljs-string">'ai_parse_document(%L, file, ''auto'', ''markdown'')'</span>,
        parse_document_model
    );
<span class="hljs-keyword">END</span> IF;

<span class="hljs-comment">-- 6. chunk 模型选择</span>
IF chunk_model <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">OR</span> length(<span class="hljs-built_in">trim</span>(chunk_model)) <span class="hljs-operator">=</span> <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span>
    chunk_expr :<span class="hljs-operator">=</span> format(<span class="hljs-string">'ai_chunk(doc, %s, %s)'</span>, chunk_size, chunk_overlap);
<span class="hljs-keyword">ELSE</span>
    chunk_expr :<span class="hljs-operator">=</span> format(
        <span class="hljs-string">'ai_chunk(%L, doc, %s, %s)'</span>,
        chunk_model,
        chunk_size,
        chunk_overlap
    );
<span class="hljs-keyword">END</span> IF;

<span class="hljs-comment">-- 7. embedding 模型选择</span>
IF embedding_model <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">OR</span> length(<span class="hljs-built_in">trim</span>(embedding_model)) <span class="hljs-operator">=</span> <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span>
    embed_expr :<span class="hljs-operator">=</span> <span class="hljs-string">'ai_embed(chunk)'</span>;

    <span class="hljs-keyword">EXECUTE</span> <span class="hljs-string">'SELECT array_length(ai_embed(''dummy''), 1)'</span>
    <span class="hljs-keyword">INTO</span> embedding_dims;
<span class="hljs-keyword">ELSE</span>
    embed_expr :<span class="hljs-operator">=</span> format(<span class="hljs-string">'ai_embed(%L, chunk)'</span>, embedding_model);

    <span class="hljs-keyword">EXECUTE</span> format(
        <span class="hljs-string">'SELECT array_length(ai_embed(%L, ''dummy''), 1)'</span>,
        embedding_model
    )
    <span class="hljs-keyword">INTO</span> embedding_dims;
<span class="hljs-keyword">END</span> IF;

RAISE NOTICE <span class="hljs-string">'embedding dimension is: %'</span>, embedding_dims;

<span class="hljs-comment">-- 8. 创建 RAG 输出动态表</span>
RAISE NOTICE <span class="hljs-string">'create dynamic table: %'</span>, corpus_name;
<span class="hljs-keyword">EXECUTE</span> format(
    $f$
    <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">DYNAMIC</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-operator">%</span>s(
        <span class="hljs-keyword">CHECK</span>(array_ndims(embedding_vector) <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> array_length(embedding_vector, <span class="hljs-number">1</span>) <span class="hljs-operator">=</span> <span class="hljs-operator">%</span>s)
    )
    <span class="hljs-keyword">WITH</span> (
        vectors <span class="hljs-operator">=</span> <span class="hljs-string">'{
          "embedding_vector": {
            "algorithm": "HGraph",
            "distance_method": "Cosine",
            "builder_params": {
            "base_quantization_type": "sq8_uniform",
            "max_degree": 64,
            "ef_construction": 400,
            "precise_quantization_type": "fp32",
            "use_reorder": true
            }
          }
        }'</span>,
        auto_refresh_mode <span class="hljs-operator">=</span> <span class="hljs-string">'incremental'</span>,
        freshness <span class="hljs-operator">=</span> <span class="hljs-string">'5 minutes'</span>,
        auto_refresh_enable <span class="hljs-operator">=</span> <span class="hljs-string">'false'</span>
    ) <span class="hljs-keyword">AS</span>
    <span class="hljs-keyword">WITH</span> parsed_doc <span class="hljs-keyword">AS</span> (
        <span class="hljs-keyword">SELECT</span> object_uri,
               etag,
               <span class="hljs-operator">%</span>s <span class="hljs-keyword">AS</span> doc
          <span class="hljs-keyword">FROM</span> <span class="hljs-operator">%</span>s
    ),
    chunked_doc <span class="hljs-keyword">AS</span> (
        <span class="hljs-keyword">SELECT</span> object_uri,
               etag,
               <span class="hljs-built_in">unnest</span>(<span class="hljs-operator">%</span>s) <span class="hljs-keyword">AS</span> chunk
          <span class="hljs-keyword">FROM</span> parsed_doc
    )
    <span class="hljs-keyword">SELECT</span>
        object_uri,
        etag,
        chunk,
        <span class="hljs-operator">%</span>s <span class="hljs-keyword">AS</span> embedding_vector
      <span class="hljs-keyword">FROM</span> chunked_doc;
    $f$,
    full_corpus_ident,
    embedding_dims,
    parse_expr,
    full_obj_ident,
    chunk_expr,
    embed_expr
);
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- 9. 创建全文索引（索引名 = 表名 || '_fulltext_idx'）</span>
<span class="hljs-keyword">EXECUTE</span> format(
    <span class="hljs-string">'CREATE INDEX %I ON %s USING FULLTEXT (chunk);'</span>,
    corpus_name <span class="hljs-operator">||</span> <span class="hljs-string">'_fulltext_idx'</span>,
    full_corpus_ident
);

RAISE NOTICE <span class="hljs-string">''</span>;
RAISE NOTICE <span class="hljs-string">'Create RAG corpus success to table: %'</span>, corpus_table;
RAISE NOTICE <span class="hljs-string">'    Vector index is: %.embedding_vector'</span>, corpus_table;
RAISE NOTICE <span class="hljs-string">'    TextSearch index is: %.chunk'</span>, corpus_table;
</code></pre>
<p>END;</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow/><annotation encoding="application/x-tex"/></semantics></math></span><span class="katex-html" aria-hidden="true"/></span></span></div>
</li>
<li>
<p>刷新Object Table和Dynamic Table存储过程</p>
<p>CREATE OR REPLACE PROCEDURE refresh_rag_corpus_table(
corpus_table TEXT
)
AS $$
DECLARE
corpus_schema TEXT;
corpus_name   TEXT;
obj_table_name TEXT;
full_corpus_ident TEXT;
full_obj_ident    TEXT;
BEGIN
-- 1. 解析 schema 和表名
IF position('.' in corpus_table) &gt; 0 THEN
corpus_schema := split_part(corpus_table, '.', 1);
corpus_name   := split_part(corpus_table, '.', 2);
ELSE
corpus_schema := 'public';
corpus_name   := corpus_table;
END IF;</p>
<pre><code class="hljs language-css" lang="css">obj_table_name := corpus_name || <span class="hljs-string">'_obj_table'</span>;

full_corpus_ident := <span class="hljs-built_in">format</span>(<span class="hljs-string">'%I.%I'</span>, corpus_schema, corpus_name);
full_obj_ident    := <span class="hljs-built_in">format</span>(<span class="hljs-string">'%I.%I'</span>, corpus_schema, obj_table_name);

-- <span class="hljs-number">2</span>. 刷新 <span class="hljs-selector-tag">Object</span> <span class="hljs-selector-tag">Table</span>
RAISE NOTICE 'Refreshing <span class="hljs-selector-tag">Object</span> <span class="hljs-selector-tag">Table</span>: %<span class="hljs-string">', obj_table_name;
EXECUTE format('</span>REFRESH OBJECT TABLE %s;', full_obj_ident);

-- <span class="hljs-number">3</span>. 刷新 Dynamic <span class="hljs-selector-tag">Table</span>
RAISE NOTICE 'Refreshing Dynamic <span class="hljs-selector-tag">Table</span>: %<span class="hljs-string">', corpus_name;
EXECUTE format('</span>REFRESH TABLE %s;', full_corpus_ident);

RAISE NOTICE 'Refresh complete for corpus <span class="hljs-selector-tag">table</span> %', corpus_table;
</code></pre>
<p>END;</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow/><annotation encoding="application/x-tex"/></semantics></math></span><span class="katex-html" aria-hidden="true"/></span></span></div>
</li>
<li>
<p>删除Object Table和Dynamic Table存储过程</p>
<p>CREATE OR REPLACE PROCEDURE drop_rag_corpus_table(
corpus_table TEXT
)
AS $$
DECLARE
corpus_schema TEXT;
corpus_name   TEXT;
obj_table_name TEXT;
full_corpus_ident TEXT;
full_obj_ident    TEXT;
rec RECORD;
BEGIN
-- 1. 解析 schema 和表名
IF position('.' in corpus_table) &gt; 0 THEN
corpus_schema := split_part(corpus_table, '.', 1);
corpus_name   := split_part(corpus_table, '.', 2);
ELSE
corpus_schema := 'public';
corpus_name   := corpus_table;
END IF;</p>
<pre><code class="hljs language-sql" lang="sql">obj_table_name :<span class="hljs-operator">=</span> corpus_name <span class="hljs-operator">||</span> <span class="hljs-string">'_obj_table'</span>;

full_corpus_ident :<span class="hljs-operator">=</span> format(<span class="hljs-string">'%I.%I'</span>, corpus_schema, corpus_name);
full_obj_ident    :<span class="hljs-operator">=</span> format(<span class="hljs-string">'%I.%I'</span>, corpus_schema, obj_table_name);

<span class="hljs-comment">-- 2. 删除表</span>
<span class="hljs-comment">-- 2.1 关闭动态表自动刷新</span>
<span class="hljs-comment">-- RAISE NOTICE 'Disabling auto refresh for %', full_corpus_ident;</span>
<span class="hljs-comment">-- EXECUTE format('ALTER TABLE IF EXISTS %s SET (auto_refresh_enable=false)', full_corpus_ident);</span>

<span class="hljs-comment">-- 2.2 查找 RUNNING 刷新任务并取消</span>
<span class="hljs-keyword">FOR</span> rec <span class="hljs-keyword">IN</span>
    <span class="hljs-keyword">EXECUTE</span> format(
        $f$
        <span class="hljs-keyword">SELECT</span> query_job_id
            <span class="hljs-keyword">FROM</span> hologres.hg_dynamic_table_refresh_log(<span class="hljs-operator">%</span>L)
            <span class="hljs-keyword">WHERE</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'RUNNING'</span>;
        $f$,
        corpus_table
    )
LOOP
    RAISE NOTICE <span class="hljs-string">'Found running refresh job: %'</span>, rec.query_job_id;
    IF hologres.hg_internal_cancel_query_job(rec.query_job_id::<span class="hljs-type">bigint</span>) <span class="hljs-keyword">THEN</span>
        RAISE NOTICE <span class="hljs-string">'Cancel job % succeeded.'</span>, rec.query_job_id;
    <span class="hljs-keyword">ELSE</span>
        RAISE WARNING <span class="hljs-string">'Cancel job % failed.'</span>, rec.query_job_id;
    <span class="hljs-keyword">END</span> IF;
<span class="hljs-keyword">END</span> LOOP;

<span class="hljs-comment">-- 2.3 删除 Dynamic Table</span>
RAISE NOTICE <span class="hljs-string">'Dropping Dynamic Table: %'</span>, corpus_name;
<span class="hljs-keyword">EXECUTE</span> format(<span class="hljs-string">'DROP TABLE IF EXISTS %s;'</span>, full_corpus_ident);

<span class="hljs-comment">-- 2.4 删除 Object Table</span>
RAISE NOTICE <span class="hljs-string">'Dropping Object Table: %'</span>, obj_table_name;
<span class="hljs-keyword">EXECUTE</span> format(<span class="hljs-string">'DROP OBJECT TABLE IF EXISTS %s;'</span>, full_obj_ident);

RAISE NOTICE <span class="hljs-string">'Drop complete for corpus: %'</span>, corpus_table;
</code></pre>
<p>END;</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow/><annotation encoding="application/x-tex"/></semantics></math></span><span class="katex-html" aria-hidden="true"/></span></span></div>
</li>
</ul>
<h3 data-id="heading-11">向量检索函数</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- RAG向量单路召回问答</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> REPLACE <span class="hljs-keyword">FUNCTION</span> qa_vector_search_retrieval(
    question TEXT,
    corpus_table TEXT,
    embedding_model TEXT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
    llm_model TEXT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
    ranking_model TEXT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
    prompt TEXT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'Please answer the following question in ${language} based on the reference information.\n\n Question: ${question}\n\n Reference information:\n\n ${context}'</span>,
    <span class="hljs-keyword">language</span> TEXT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'Chinese'</span>,
    vector_recall_count <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">20</span>,
    rerank_recall_count <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">5</span>,
    vector_col TEXT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'embedding_vector'</span>
)
<span class="hljs-keyword">RETURNS</span> TEXT <span class="hljs-keyword">AS</span>
$$
<span class="hljs-keyword">DECLARE</span>
    final_answer TEXT;
    <span class="hljs-keyword">sql</span> TEXT;
    embedding_expr TEXT;
    ai_rank_expr TEXT;
    ai_gen_expr TEXT;
    embedding_model_valid <span class="hljs-type">BOOLEAN</span>;
    llm_model_valid <span class="hljs-type">BOOLEAN</span>;
    ranking_model_valid <span class="hljs-type">BOOLEAN</span>;
<span class="hljs-keyword">BEGIN</span>
    embedding_model_valid :<span class="hljs-operator">=</span> (embedding_model <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">AND</span> <span class="hljs-built_in">trim</span>(embedding_model) <span class="hljs-operator">!=</span> <span class="hljs-string">''</span>);
    llm_model_valid :<span class="hljs-operator">=</span> (llm_model <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">AND</span> <span class="hljs-built_in">trim</span>(llm_model) <span class="hljs-operator">!=</span> <span class="hljs-string">''</span>);
    ranking_model_valid :<span class="hljs-operator">=</span> (ranking_model <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">AND</span> <span class="hljs-built_in">trim</span>(ranking_model) <span class="hljs-operator">!=</span> <span class="hljs-string">''</span>);

    IF embedding_model_valid <span class="hljs-keyword">THEN</span>
        embedding_expr :<span class="hljs-operator">=</span> <span class="hljs-string">'ai_embed('</span> <span class="hljs-operator">||</span> quote_literal(embedding_model) <span class="hljs-operator">||</span> <span class="hljs-string">', '</span> <span class="hljs-operator">||</span> quote_literal(question) <span class="hljs-operator">||</span> <span class="hljs-string">')'</span>;
    <span class="hljs-keyword">ELSE</span>
        embedding_expr :<span class="hljs-operator">=</span> <span class="hljs-string">'ai_embed('</span> <span class="hljs-operator">||</span> quote_literal(question) <span class="hljs-operator">||</span> <span class="hljs-string">')'</span>;
    <span class="hljs-keyword">END</span> IF;

    IF ranking_model_valid <span class="hljs-keyword">THEN</span>
        ai_rank_expr :<span class="hljs-operator">=</span> <span class="hljs-string">'ai_rank('</span> <span class="hljs-operator">||</span> quote_literal(ranking_model) <span class="hljs-operator">||</span> <span class="hljs-string">', '</span> <span class="hljs-operator">||</span> quote_literal(question) <span class="hljs-operator">||</span> <span class="hljs-string">', chunk)'</span>;
    <span class="hljs-keyword">ELSE</span>
        ai_rank_expr :<span class="hljs-operator">=</span> <span class="hljs-string">'ai_rank('</span> <span class="hljs-operator">||</span> quote_literal(question) <span class="hljs-operator">||</span> <span class="hljs-string">', chunk)'</span>;
    <span class="hljs-keyword">END</span> IF;

    IF llm_model_valid <span class="hljs-keyword">THEN</span>
        ai_gen_expr :<span class="hljs-operator">=</span> <span class="hljs-string">'ai_gen('</span> <span class="hljs-operator">||</span> quote_literal(llm_model) <span class="hljs-operator">||</span>
            <span class="hljs-string">', replace(replace(replace('</span> <span class="hljs-operator">||</span> quote_literal(prompt) <span class="hljs-operator">||</span>
               <span class="hljs-string">', ''${question}'', '</span> <span class="hljs-operator">||</span> quote_literal(question) <span class="hljs-operator">||</span> <span class="hljs-string">'), ''${context}'', merged_chunks), ''${language}'', '</span> <span class="hljs-operator">||</span> quote_literal(<span class="hljs-keyword">language</span>) <span class="hljs-operator">||</span> <span class="hljs-string">') )'</span>;
    <span class="hljs-keyword">ELSE</span>
        ai_gen_expr :<span class="hljs-operator">=</span> <span class="hljs-string">'ai_gen(replace(replace(replace('</span> <span class="hljs-operator">||</span> quote_literal(prompt) <span class="hljs-operator">||</span>
               <span class="hljs-string">', ''${question}'', '</span> <span class="hljs-operator">||</span> quote_literal(question) <span class="hljs-operator">||</span> <span class="hljs-string">'), ''${context}'', merged_chunks), ''${language}'', '</span> <span class="hljs-operator">||</span> quote_literal(<span class="hljs-keyword">language</span>) <span class="hljs-operator">||</span> <span class="hljs-string">'))'</span>;
    <span class="hljs-keyword">END</span> IF;

    <span class="hljs-keyword">sql</span> :<span class="hljs-operator">=</span> <span class="hljs-string">'
      WITH
        embedding_recall AS (
            SELECT
              chunk,
              approx_cosine_distance('</span> <span class="hljs-operator">||</span> vector_col <span class="hljs-operator">||</span> <span class="hljs-string">', '</span> <span class="hljs-operator">||</span> embedding_expr <span class="hljs-operator">||</span> <span class="hljs-string">') AS distance
            FROM
              '</span> <span class="hljs-operator">||</span> corpus_table <span class="hljs-operator">||</span> <span class="hljs-string">'
            ORDER BY
              distance DESC
            LIMIT '</span> <span class="hljs-operator">||</span> vector_recall_count <span class="hljs-operator">||</span> <span class="hljs-string">'
        ),
        rerank AS (
            SELECT
              chunk,
              '</span> <span class="hljs-operator">||</span> ai_rank_expr <span class="hljs-operator">||</span> <span class="hljs-string">' AS score
            FROM
              embedding_recall
            ORDER BY
              score DESC
            LIMIT '</span> <span class="hljs-operator">||</span> rerank_recall_count <span class="hljs-operator">||</span> <span class="hljs-string">'
        ),
        concat_top_chunks AS (
            SELECT string_agg(chunk, E''\n\n----\n\n'') AS merged_chunks FROM rerank
        )
      SELECT '</span> <span class="hljs-operator">||</span> ai_gen_expr <span class="hljs-operator">||</span> <span class="hljs-string">'
      FROM concat_top_chunks;
    '</span>;

    <span class="hljs-keyword">EXECUTE</span> <span class="hljs-keyword">sql</span> <span class="hljs-keyword">INTO</span> final_answer;
    <span class="hljs-keyword">RETURN</span> final_answer;
<span class="hljs-keyword">END</span>;
$$ <span class="hljs-keyword">LANGUAGE</span> plpgsql;
</code></pre>
<h3 data-id="heading-12">全文检索函数</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> REPLACE <span class="hljs-keyword">FUNCTION</span> qa_text_search_retrieval(
    question TEXT,
    corpus_table TEXT,
    llm_model TEXT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
    ranking_model TEXT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
    prompt TEXT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'Please answer the following question in ${language} based on the reference information.\n\n Question: ${question}\n\n Reference information:\n\n ${context}'</span>,
    <span class="hljs-keyword">language</span> TEXT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'Chinese'</span>,
    text_search_recall_count <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">20</span>,
    rerank_recall_count <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">5</span>,
    text_search_col TEXT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'chunk'</span>
)
<span class="hljs-keyword">RETURNS</span> TEXT <span class="hljs-keyword">AS</span>
$$
<span class="hljs-keyword">DECLARE</span>
    final_answer TEXT;
    <span class="hljs-keyword">sql</span> TEXT;
    ai_rank_expr TEXT;
    ai_gen_expr TEXT;
    llm_model_valid <span class="hljs-type">BOOLEAN</span>;
    ranking_model_valid <span class="hljs-type">BOOLEAN</span>;
<span class="hljs-keyword">BEGIN</span>
    llm_model_valid     :<span class="hljs-operator">=</span> (llm_model <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">AND</span> <span class="hljs-built_in">trim</span>(llm_model) <span class="hljs-operator">!=</span> <span class="hljs-string">''</span>);
    ranking_model_valid :<span class="hljs-operator">=</span> (ranking_model <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">AND</span> <span class="hljs-built_in">trim</span>(ranking_model) <span class="hljs-operator">!=</span> <span class="hljs-string">''</span>);

    IF ranking_model_valid <span class="hljs-keyword">THEN</span>
        ai_rank_expr :<span class="hljs-operator">=</span> <span class="hljs-string">'ai_rank('</span> <span class="hljs-operator">||</span> quote_literal(ranking_model) <span class="hljs-operator">||</span> <span class="hljs-string">', '</span> <span class="hljs-operator">||</span> quote_literal(question) <span class="hljs-operator">||</span> <span class="hljs-string">', chunk)'</span>;
    <span class="hljs-keyword">ELSE</span>
        ai_rank_expr :<span class="hljs-operator">=</span> <span class="hljs-string">'ai_rank('</span> <span class="hljs-operator">||</span> quote_literal(question) <span class="hljs-operator">||</span> <span class="hljs-string">', chunk)'</span>;
    <span class="hljs-keyword">END</span> IF;

    IF llm_model_valid <span class="hljs-keyword">THEN</span>
        ai_gen_expr :<span class="hljs-operator">=</span> <span class="hljs-string">'ai_gen('</span> <span class="hljs-operator">||</span> quote_literal(llm_model) <span class="hljs-operator">||</span>
            <span class="hljs-string">', replace(replace(replace('</span> <span class="hljs-operator">||</span> quote_literal(prompt) <span class="hljs-operator">||</span>
               <span class="hljs-string">', ''${question}'', '</span> <span class="hljs-operator">||</span> quote_literal(question) <span class="hljs-operator">||</span>
               <span class="hljs-string">'), ''${context}'', merged_chunks), ''${language}'', '</span> <span class="hljs-operator">||</span> quote_literal(<span class="hljs-keyword">language</span>) <span class="hljs-operator">||</span> <span class="hljs-string">') )'</span>;
    <span class="hljs-keyword">ELSE</span>
        ai_gen_expr :<span class="hljs-operator">=</span> <span class="hljs-string">'ai_gen(replace(replace(replace('</span> <span class="hljs-operator">||</span> quote_literal(prompt) <span class="hljs-operator">||</span>
               <span class="hljs-string">', ''${question}'', '</span> <span class="hljs-operator">||</span> quote_literal(question) <span class="hljs-operator">||</span>
               <span class="hljs-string">'), ''${context}'', merged_chunks), ''${language}'', '</span> <span class="hljs-operator">||</span> quote_literal(<span class="hljs-keyword">language</span>) <span class="hljs-operator">||</span> <span class="hljs-string">'))'</span>;
    <span class="hljs-keyword">END</span> IF;

    <span class="hljs-keyword">sql</span> :<span class="hljs-operator">=</span> <span class="hljs-string">'
      WITH
        text_search_recall AS (
            SELECT
              chunk
            FROM
              '</span> <span class="hljs-operator">||</span> corpus_table <span class="hljs-operator">||</span> <span class="hljs-string">'
            ORDER BY
              text_search('</span> <span class="hljs-operator">||</span> text_search_col <span class="hljs-operator">||</span> <span class="hljs-string">', '</span> <span class="hljs-operator">||</span> quote_literal(question) <span class="hljs-operator">||</span> <span class="hljs-string">') DESC
            LIMIT '</span> <span class="hljs-operator">||</span> text_search_recall_count <span class="hljs-operator">||</span> <span class="hljs-string">'
        ),
        rerank AS (
            SELECT
              chunk,
              '</span> <span class="hljs-operator">||</span> ai_rank_expr <span class="hljs-operator">||</span> <span class="hljs-string">' AS score
            FROM
              text_search_recall
            ORDER BY
              score DESC
            LIMIT '</span> <span class="hljs-operator">||</span> rerank_recall_count <span class="hljs-operator">||</span> <span class="hljs-string">'
        ),
        concat_top_chunks AS (
            SELECT string_agg(chunk, E''\n\n----\n\n'') AS merged_chunks FROM rerank
        )
      SELECT '</span> <span class="hljs-operator">||</span> ai_gen_expr <span class="hljs-operator">||</span> <span class="hljs-string">'
      FROM concat_top_chunks;
    '</span>;

    <span class="hljs-keyword">EXECUTE</span> <span class="hljs-keyword">sql</span> <span class="hljs-keyword">INTO</span> final_answer;
    <span class="hljs-keyword">RETURN</span> final_answer;
<span class="hljs-keyword">END</span>;
$$ <span class="hljs-keyword">LANGUAGE</span> plpgsql;
</code></pre>
<h3 data-id="heading-13">向量+全文双路召回+Rank排序函数</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> REPLACE <span class="hljs-keyword">FUNCTION</span> qa_hybrid_retrieval(
    question TEXT,
    corpus_table TEXT,
    embedding_model TEXT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
    llm_model TEXT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
    ranking_model TEXT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
    prompt TEXT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'Please answer the following question in ${language} based on the reference information.\n\n Question: ${question}\n\n Reference information:\n\n ${context}'</span>,
    <span class="hljs-keyword">language</span> TEXT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'Chinese'</span>,
    text_search_recall_count <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">20</span>,
    vector_recall_count <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">20</span>,
    rerank_recall_count <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">5</span>,
    vector_col TEXT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'embedding_vector'</span>,
    text_search_col TEXT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'chunk'</span>
)
<span class="hljs-keyword">RETURNS</span> TEXT <span class="hljs-keyword">AS</span>
$$
<span class="hljs-keyword">DECLARE</span>
    final_answer TEXT;
    <span class="hljs-keyword">sql</span> TEXT;
    embedding_expr TEXT;
    ai_rank_expr TEXT;
    ai_gen_expr TEXT;
    embedding_model_valid <span class="hljs-type">BOOLEAN</span>;
    llm_model_valid <span class="hljs-type">BOOLEAN</span>;
    ranking_model_valid <span class="hljs-type">BOOLEAN</span>;
<span class="hljs-keyword">BEGIN</span>
    embedding_model_valid :<span class="hljs-operator">=</span> (embedding_model <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">AND</span> <span class="hljs-built_in">trim</span>(embedding_model) <span class="hljs-operator">!=</span> <span class="hljs-string">''</span>);
    llm_model_valid       :<span class="hljs-operator">=</span> (llm_model <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">AND</span> <span class="hljs-built_in">trim</span>(llm_model) <span class="hljs-operator">!=</span> <span class="hljs-string">''</span>);
    ranking_model_valid   :<span class="hljs-operator">=</span> (ranking_model <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">AND</span> <span class="hljs-built_in">trim</span>(ranking_model) <span class="hljs-operator">!=</span> <span class="hljs-string">''</span>);

    IF embedding_model_valid <span class="hljs-keyword">THEN</span>
        embedding_expr :<span class="hljs-operator">=</span> <span class="hljs-string">'ai_embed('</span> <span class="hljs-operator">||</span> quote_literal(embedding_model) <span class="hljs-operator">||</span> <span class="hljs-string">', '</span> <span class="hljs-operator">||</span> quote_literal(question) <span class="hljs-operator">||</span> <span class="hljs-string">')'</span>;
    <span class="hljs-keyword">ELSE</span>
        embedding_expr :<span class="hljs-operator">=</span> <span class="hljs-string">'ai_embed('</span> <span class="hljs-operator">||</span> quote_literal(question) <span class="hljs-operator">||</span> <span class="hljs-string">')'</span>;
    <span class="hljs-keyword">END</span> IF;

    IF ranking_model_valid <span class="hljs-keyword">THEN</span>
        ai_rank_expr :<span class="hljs-operator">=</span> <span class="hljs-string">'ai_rank('</span> <span class="hljs-operator">||</span> quote_literal(ranking_model) <span class="hljs-operator">||</span> <span class="hljs-string">', '</span> <span class="hljs-operator">||</span> quote_literal(question) <span class="hljs-operator">||</span> <span class="hljs-string">', chunk)'</span>;
    <span class="hljs-keyword">ELSE</span>
        ai_rank_expr :<span class="hljs-operator">=</span> <span class="hljs-string">'ai_rank('</span> <span class="hljs-operator">||</span> quote_literal(question) <span class="hljs-operator">||</span> <span class="hljs-string">', chunk)'</span>;
    <span class="hljs-keyword">END</span> IF;

    IF llm_model_valid <span class="hljs-keyword">THEN</span>
        ai_gen_expr :<span class="hljs-operator">=</span> <span class="hljs-string">'ai_gen('</span> <span class="hljs-operator">||</span> quote_literal(llm_model) <span class="hljs-operator">||</span>
            <span class="hljs-string">', replace(replace(replace('</span> <span class="hljs-operator">||</span> quote_literal(prompt) <span class="hljs-operator">||</span>
               <span class="hljs-string">', ''${question}'', '</span> <span class="hljs-operator">||</span> quote_literal(question) <span class="hljs-operator">||</span> <span class="hljs-string">'), ''${context}'', merged_chunks), ''${language}'', '</span> <span class="hljs-operator">||</span> quote_literal(<span class="hljs-keyword">language</span>) <span class="hljs-operator">||</span> <span class="hljs-string">') )'</span>;
    <span class="hljs-keyword">ELSE</span>
        ai_gen_expr :<span class="hljs-operator">=</span> <span class="hljs-string">'ai_gen(replace(replace(replace('</span> <span class="hljs-operator">||</span> quote_literal(prompt) <span class="hljs-operator">||</span>
               <span class="hljs-string">', ''${question}'', '</span> <span class="hljs-operator">||</span> quote_literal(question) <span class="hljs-operator">||</span> <span class="hljs-string">'), ''${context}'', merged_chunks), ''${language}'', '</span> <span class="hljs-operator">||</span> quote_literal(<span class="hljs-keyword">language</span>) <span class="hljs-operator">||</span> <span class="hljs-string">'))'</span>;
    <span class="hljs-keyword">END</span> IF;

    <span class="hljs-keyword">sql</span> :<span class="hljs-operator">=</span> <span class="hljs-string">'
      WITH
        embedding_recall AS (
            SELECT
              chunk
            FROM
              '</span> <span class="hljs-operator">||</span> corpus_table <span class="hljs-operator">||</span> <span class="hljs-string">'
            ORDER BY
              approx_cosine_distance('</span> <span class="hljs-operator">||</span> vector_col <span class="hljs-operator">||</span> <span class="hljs-string">', '</span> <span class="hljs-operator">||</span> embedding_expr <span class="hljs-operator">||</span> <span class="hljs-string">') DESC
            LIMIT '</span> <span class="hljs-operator">||</span> vector_recall_count <span class="hljs-operator">||</span> <span class="hljs-string">'
        ),
        text_search_recall AS (
            SELECT
              chunk
            FROM
              '</span> <span class="hljs-operator">||</span> corpus_table <span class="hljs-operator">||</span> <span class="hljs-string">'
            ORDER BY
              text_search('</span> <span class="hljs-operator">||</span> text_search_col <span class="hljs-operator">||</span> <span class="hljs-string">', '</span> <span class="hljs-operator">||</span> quote_literal(question) <span class="hljs-operator">||</span> <span class="hljs-string">') DESC
            LIMIT '</span> <span class="hljs-operator">||</span> text_search_recall_count <span class="hljs-operator">||</span> <span class="hljs-string">'
        ),
        union_recall AS (
            SELECT chunk FROM embedding_recall
            UNION
            SELECT chunk FROM text_search_recall
        ),
        rerank AS (
            SELECT
              chunk,
              '</span> <span class="hljs-operator">||</span> ai_rank_expr <span class="hljs-operator">||</span> <span class="hljs-string">' AS score
            FROM
              union_recall
            ORDER BY
              score DESC
            LIMIT '</span> <span class="hljs-operator">||</span> rerank_recall_count <span class="hljs-operator">||</span> <span class="hljs-string">'
        ),
        concat_top_chunks AS (
            SELECT string_agg(chunk, E''\n\n----\n\n'') AS merged_chunks FROM rerank
        )
      SELECT '</span> <span class="hljs-operator">||</span> ai_gen_expr <span class="hljs-operator">||</span> <span class="hljs-string">'
      FROM concat_top_chunks;
    '</span>;

    <span class="hljs-keyword">EXECUTE</span> <span class="hljs-keyword">sql</span> <span class="hljs-keyword">INTO</span> final_answer;
    <span class="hljs-keyword">RETURN</span> final_answer;
<span class="hljs-keyword">END</span>;
$$ <span class="hljs-keyword">LANGUAGE</span> plpgsql;
</code></pre>
<h3 data-id="heading-14">向量+全文双路召回+RRF排序函数</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> REPLACE <span class="hljs-keyword">FUNCTION</span> qa_hybrid_retrieval_rrf(
    question TEXT,
    corpus_table TEXT,
    embedding_model TEXT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
    llm_model TEXT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
    ranking_model TEXT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
    prompt TEXT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'Please answer the following question in ${language} based on the reference information.\n\n Question: ${question}\n\n Reference information:\n\n ${context}'</span>,
    <span class="hljs-keyword">language</span> TEXT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'Chinese'</span>,
    text_search_recall_count <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">20</span>,
    vector_recall_count <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">20</span>,
    rerank_recall_count <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">5</span>,
    rrf_k <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">60</span>,
    vector_col TEXT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'embedding_vector'</span>,
    text_search_col TEXT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'chunk'</span>
)
<span class="hljs-keyword">RETURNS</span> TEXT <span class="hljs-keyword">AS</span>
$$
<span class="hljs-keyword">DECLARE</span>
    final_answer TEXT;
    <span class="hljs-keyword">sql</span> TEXT;
    embedding_expr TEXT;
    ai_rank_expr TEXT;
    ai_gen_expr TEXT;
    embedding_model_valid <span class="hljs-type">BOOLEAN</span>;
    llm_model_valid <span class="hljs-type">BOOLEAN</span>;
    ranking_model_valid <span class="hljs-type">BOOLEAN</span>;
<span class="hljs-keyword">BEGIN</span>
    embedding_model_valid :<span class="hljs-operator">=</span> (embedding_model <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">AND</span> <span class="hljs-built_in">trim</span>(embedding_model) <span class="hljs-operator">&lt;&gt;</span> <span class="hljs-string">''</span>);
    llm_model_valid       :<span class="hljs-operator">=</span> (llm_model <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">AND</span> <span class="hljs-built_in">trim</span>(llm_model) <span class="hljs-operator">&lt;&gt;</span> <span class="hljs-string">''</span>);
    ranking_model_valid   :<span class="hljs-operator">=</span> (ranking_model <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">AND</span> <span class="hljs-built_in">trim</span>(ranking_model) <span class="hljs-operator">&lt;&gt;</span> <span class="hljs-string">''</span>);

    IF embedding_model_valid <span class="hljs-keyword">THEN</span>
        embedding_expr :<span class="hljs-operator">=</span> <span class="hljs-string">'ai_embed('</span> <span class="hljs-operator">||</span> quote_literal(embedding_model) <span class="hljs-operator">||</span> <span class="hljs-string">', '</span> <span class="hljs-operator">||</span> quote_literal(question) <span class="hljs-operator">||</span> <span class="hljs-string">')'</span>;
    <span class="hljs-keyword">ELSE</span>
        embedding_expr :<span class="hljs-operator">=</span> <span class="hljs-string">'ai_embed('</span> <span class="hljs-operator">||</span> quote_literal(question) <span class="hljs-operator">||</span> <span class="hljs-string">')'</span>;
    <span class="hljs-keyword">END</span> IF;

    IF ranking_model_valid <span class="hljs-keyword">THEN</span>
        ai_rank_expr :<span class="hljs-operator">=</span> <span class="hljs-string">'ai_rank('</span> <span class="hljs-operator">||</span> quote_literal(ranking_model) <span class="hljs-operator">||</span> <span class="hljs-string">', '</span> <span class="hljs-operator">||</span> quote_literal(question) <span class="hljs-operator">||</span> <span class="hljs-string">', chunk)'</span>;
    <span class="hljs-keyword">ELSE</span>
        ai_rank_expr :<span class="hljs-operator">=</span> <span class="hljs-string">'ai_rank('</span> <span class="hljs-operator">||</span> quote_literal(question) <span class="hljs-operator">||</span> <span class="hljs-string">', chunk)'</span>;
    <span class="hljs-keyword">END</span> IF;

    IF llm_model_valid <span class="hljs-keyword">THEN</span>
        ai_gen_expr :<span class="hljs-operator">=</span> <span class="hljs-string">'ai_gen('</span> <span class="hljs-operator">||</span> quote_literal(llm_model) <span class="hljs-operator">||</span>
            <span class="hljs-string">', replace(replace(replace('</span> <span class="hljs-operator">||</span> quote_literal(prompt) <span class="hljs-operator">||</span>
                <span class="hljs-string">', ''${question}'', '</span> <span class="hljs-operator">||</span> quote_literal(question) <span class="hljs-operator">||</span> <span class="hljs-string">'), ''${context}'', merged_chunks), ''${language}'', '</span> <span class="hljs-operator">||</span> quote_literal(<span class="hljs-keyword">language</span>) <span class="hljs-operator">||</span> <span class="hljs-string">') )'</span>;
    <span class="hljs-keyword">ELSE</span>
        ai_gen_expr :<span class="hljs-operator">=</span> <span class="hljs-string">'ai_gen(replace(replace(replace('</span> <span class="hljs-operator">||</span> quote_literal(prompt) <span class="hljs-operator">||</span>
                <span class="hljs-string">', ''${question}'', '</span> <span class="hljs-operator">||</span> quote_literal(question) <span class="hljs-operator">||</span> <span class="hljs-string">'), ''${context}'', merged_chunks), ''${language}'', '</span> <span class="hljs-operator">||</span> quote_literal(<span class="hljs-keyword">language</span>) <span class="hljs-operator">||</span> <span class="hljs-string">'))'</span>;
    <span class="hljs-keyword">END</span> IF;

    <span class="hljs-keyword">sql</span> :<span class="hljs-operator">=</span> <span class="hljs-string">'
      WITH embedding_recall AS (
        SELECT
          chunk,
          vec_score,
          ROW_NUMBER() OVER (ORDER BY vec_score DESC) AS rank_vec
        FROM (
          SELECT
            chunk,
            approx_cosine_distance('</span> <span class="hljs-operator">||</span> vector_col <span class="hljs-operator">||</span> <span class="hljs-string">', '</span> <span class="hljs-operator">||</span> embedding_expr <span class="hljs-operator">||</span> <span class="hljs-string">') AS vec_score
          FROM
            '</span> <span class="hljs-operator">||</span> corpus_table <span class="hljs-operator">||</span> <span class="hljs-string">'
        ) t
        ORDER BY vec_score DESC
        LIMIT '</span> <span class="hljs-operator">||</span> vector_recall_count <span class="hljs-operator">||</span> <span class="hljs-string">'
      ),
      text_search_recall AS (
        SELECT
          chunk,
          text_score,
          ROW_NUMBER() OVER (ORDER BY text_score DESC) AS rank_text
        FROM (
          SELECT
            chunk,
            text_search('</span> <span class="hljs-operator">||</span> text_search_col <span class="hljs-operator">||</span> <span class="hljs-string">', '</span> <span class="hljs-operator">||</span> quote_literal(question) <span class="hljs-operator">||</span> <span class="hljs-string">') AS text_score
          FROM
            '</span> <span class="hljs-operator">||</span> corpus_table <span class="hljs-operator">||</span> <span class="hljs-string">'
        ) ts
        WHERE text_score &gt; 0
        ORDER BY text_score DESC
        LIMIT '</span> <span class="hljs-operator">||</span> text_search_recall_count <span class="hljs-operator">||</span> <span class="hljs-string">'
      ),
      rrf_scores AS (
        SELECT
          chunk,
          SUM(1.0 / ('</span> <span class="hljs-operator">||</span> rrf_k <span class="hljs-operator">||</span> <span class="hljs-string">' + rank_val)) AS rrf_score
        FROM (
          SELECT chunk, rank_vec AS rank_val FROM embedding_recall
          UNION ALL
          SELECT chunk, rank_text AS rank_val FROM text_search_recall
        ) sub
        GROUP BY chunk
      ),
      top_chunks AS (
        SELECT chunk
        FROM rrf_scores
        ORDER BY rrf_score DESC
        LIMIT '</span> <span class="hljs-operator">||</span> rerank_recall_count <span class="hljs-operator">||</span> <span class="hljs-string">'
      ),
      concat_top_chunks AS (
        SELECT string_agg(chunk, E''\n\n----\n\n'') AS merged_chunks FROM top_chunks
      )
      SELECT '</span> <span class="hljs-operator">||</span> ai_gen_expr <span class="hljs-operator">||</span> <span class="hljs-string">'
      FROM concat_top_chunks;
    '</span>;

    <span class="hljs-keyword">EXECUTE</span> <span class="hljs-keyword">sql</span> <span class="hljs-keyword">INTO</span> final_answer;
    <span class="hljs-keyword">RETURN</span> final_answer;
<span class="hljs-keyword">END</span>;
$$ <span class="hljs-keyword">LANGUAGE</span> plpgsql;
</code></pre>
<p>如果想体验更多操作流程，欢迎到阿里云官网领取Hologres免费试用，开通Hologres4.0，并按照操作文档实践。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Fhologres%2Fuser-guide%2Fbest-practices-financial-multimodal-ai-data-analysis-and-retrieval-system" target="_blank" title="https://help.aliyun.com/zh/hologres/user-guide/best-practices-financial-multimodal-ai-data-analysis-and-retrieval-system" ref="nofollow noopener noreferrer">help.aliyun.com/zh/hologres…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[attention、transform、bert 复习总结 1]]></title>    <link>https://juejin.cn/post/7575910298283802659</link>    <guid>https://juejin.cn/post/7575910298283802659</guid>    <pubDate>2025-11-24T10:49:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575910298283802659" data-draft-id="7575910298283786275" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="attention、transform、bert 复习总结 1"/> <meta itemprop="keywords" content="算法,人工智能"/> <meta itemprop="datePublished" content="2025-11-24T10:49:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="矮人三等"/> <meta itemprop="url" content="https://juejin.cn/user/4350105576808472"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            attention、transform、bert 复习总结 1
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4350105576808472/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    矮人三等
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T10:49:40.000Z" title="Mon Nov 24 2025 10:49:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">详细内容见：</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2FLian_Ge_Blog%2Farticle%2Fdetails%2F132156812%3Fspm%3D1001.2014.3001.5501" target="_blank" title="https://blog.csdn.net/Lian_Ge_Blog/article/details/132156812?spm=1001.2014.3001.5501" ref="nofollow noopener noreferrer">attention</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2FLian_Ge_Blog%2Farticle%2Fdetails%2F132783696%3Fspm%3D1001.2014.3001.5501" target="_blank" title="https://blog.csdn.net/Lian_Ge_Blog/article/details/132783696?spm=1001.2014.3001.5501" ref="nofollow noopener noreferrer">transform</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F715589044" target="_blank" title="https://zhuanlan.zhihu.com/p/715589044" ref="nofollow noopener noreferrer">bert</a></li>
</ul>
<h2 data-id="heading-1">1 注意力机制：</h2>
<ul>
<li>简单通俗描述计算过程：Q，K，V(query，key，value)； 我们首先需要计算一下 Q 和 K的距离(相似度)，可以使用向量点积，余弦相似性，或者 MLP，计算结果进行softmax处理，一是归一化处理，二是突出高权重K，然后根据最新处理的K 值与对应 V 值，加权求和即是 attention 值</li>
<li>举例：
<ul>
<li>1 我喜欢吃苹果，也喜欢吃香蕉，不喜欢吃榴莲”（3 个短语，对应 3 个信息单元）</li>
<li>2 我最喜欢吃什么水果？” 这个问题（Q）：</li>
<li>3 生成 K 和 V：K1=“苹果”，V1=“喜欢吃”；K2=“香蕉”，V2=“喜欢吃”；K3=“榴莲”,V3=“不喜欢吃”；</li>
<li>4 Q=“最喜欢的水果”，和 K 匹配：Q vs K1（苹果）：相关（喜欢），权重 3；Q vs K2（香蕉）：相关（喜欢），权重 3；Q vs K3（榴莲）：无关（不喜欢），权重 0；</li>
<li>5 加权合并 V：重点提取 “喜欢吃苹果” 和 “喜欢吃香蕉”，最终输出 “你最喜欢吃苹果和香蕉”。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-2">2 自注意力机制：</h3>
<ul>
<li>没有外来的 Q，自己这段信息分成多个部分，不同部分和其他部分充当 Q，K，V
<ul>
<li>举例：
<ul>
<li>1 “小明去超市买了牛奶，他喝完后觉得很好喝”（输入文本的 6 个词：小明、去、超市、买了、牛奶、他、喝完、觉得、很好喝）。</li>
<li>2 写 “他” 这个词时，你得知道 “他” 指的是谁 —— 这就是自注意力机制在工作</li>
<li>3 每个词都当 “提问者（Q）”：“他” 这个词会生成一个 Q（查询）：“他指的是谁？”同时，每个词也都当 “被查者（K/V）”：所有词都会生成自己的 K（标签）和 V（内容）：
<ul>
<li>小明：K=“人名 - 小明”，V=“句子主语，去超市的人”；</li>
<li>去：K=“动作 - 去”，V=“前往某地”；</li>
<li>超市：K=“地点 - 超市”，V=“购物的地方”；</li>
<li>他：K=“代词 - 他”，V=“指代前文的人”；</li>
</ul>
</li>
<li>4 Q "他"去匹配所有词的 K：Q（“我指的是谁？”） vs K（小明）；Q vs K（去 / 超市 / 牛奶）；Q vs K（他自己）；</li>
<li>5 加权提取 V 的信息：重点提取 “小明” 的 V，其他词的 V 几乎忽略；最终 “他” 就明确了：这就是自注意力通过 “内部查询” 找到的关联。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 data-id="heading-3">3 多头注意力机制：</h3>
<ul>
<li>把自注意力机制复制多份（“多个头”），每个头专注于找文本中不同维度的关联（比如一个头找指代关系、一个头找动作和对象、一个头找因果关系），最后把所有头的结果合并，让理解更全面。
<ul>
<li>举例：
<ul>
<li>1  “小明在超市买了牛奶，他喝完后觉得很甜，于是又买了一箱”（核心关联有 3 个：“他” 指代 “小明”、“喝” 的对象是 “牛奶”、“又买” 的原因是 “很甜”）。</li>
<li>2 所有头共享输入文本的 Q、K、V（但会各自做微小的 “参数调整”，让每个头的关注点不同）—— 相当于 3 个小组都拿到同一份报告， but 各自的分析侧重点预设不同。</li>
<li>3 头 1（负责 “指代关系”）：重点找 “谁指谁”:以 “他” 为 Q（“我指谁？”），匹配所有 K，最终锁定 “小明” 的 V，得出结论：“他 = 小明”；
<ul>
<li>头 2（负责 “动作 - 对象关系”）：重点找 “动作对应什么东西”以 “喝” 为 Q（“我针对的对象是什么？”），匹配所有 K，锁定 “牛奶” 的 V，得出结论：“喝的是牛奶”；</li>
<li>头 3（负责 “因果关系”）：重点找 “为什么做这个动作”以 “又买” 为 Q（“我发生的原因是什么？”），匹配所有 K，锁定 “很甜” 的 V，得出结论：“又买是因为牛奶甜”。</li>
</ul>
</li>
<li>4 把 3 个小组的结论合并：“小明在超市买了牛奶，小明喝完牛奶后觉得很甜，因为牛奶甜所以小明又买了一箱”—— 比单个头只找一种关联，理解更完整、更精准。</li>
<li>5 注意：头的数量要能被维度整除</li>
<li>6 分头是对每一个 Q，K，V 的向量化结果进行分头，也就是一段话分成几段儿</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 data-id="heading-4">4 transform：</h2>
<ul>
<li>左侧 Encode：理解输入内容(能看到全文)，只执行一次，可以看成是专属"词典"
<ul>
<li>1 输入数据(编码：见基础知识)+位置信息(PE编码用的正弦余弦距离)，Sin| Cos(pos / 10000 * (2 i  * d))
<ul>
<li>奇数用Cos，偶数用 Sin，pos 是分词位置顺序，i 是分词向量的向量值顺序，d 是向量长度</li>
<li>好处就是：可以应对未出现过更长的句子； 每个分词都有独一无二的位置信息</li>
</ul>
</li>
<li>2 多头注意力机制(多头就是自注意力并行)：输入信息和位置信息输入后，通过 attention 机制进一步提取更多的信息</li>
<li>3 Add 和 Norm：
<ul>
<li>Add：此时的 Add 是一个残差连接，即 输出 = 原始输入 + 多头(原始输入)
<ul>
<li>1 防止过度加工，保留初始信息，防止多头处理效果差导致预训练越差；</li>
<li>2 训练随着层数增加，调整参数的信息会越传递越弱，残差连接可以保持"信号"强度</li>
<li>Norm： 标准化处理(归一化属于标准化的一种)，防止数值过大或者过小导致的梯度爆炸/消失； 标准化后数值小，可以加速收敛</li>
<li>爆炸就是"信号"越来越大，防止消息就是越来越弱</li>
</ul>
</li>
</ul>
</li>
<li>4 Feed Forword： 两层全连接层，一层有激活函数，一层没有，公式max(0,XW1+b1)W2+b2
<ul>
<li>第一层：使用全连接层提高维度放大输入数据中的有效部分，然后使用Relu 函数 max() 进一步扩大有效和无效数据的差异</li>
<li>第二层：再通过全连接层把维度降低，留下有效部分</li>
</ul>
</li>
</ul>
</li>
<li>右侧 Dncode：生成输出(不能看到全文)，以翻译任务为例
<ul>
<li>1 输入数据的形式： 翻译的正确"答案"和同等大小的"答案贴纸"(Mask 矩阵)乘积作为输入，这是为了确保不能提前看到答案,一开始预测的时候只能看到初始信息，其他的都被掩盖了，然后预测出第一个信息后，预测第二个信息时候，就已经能获取到初始信息+预测信息 1 了，来预测信息 2，以此类推预测得到全部结果，注意，这个过程是在一个矩阵内一次生成的！</li>
<li>2 谁来预测？不是预训练模型，预训练模型属于成品模型，此处是搭建好 Decode 框架(比如前馈，Add 和归一化等层)后，随机或者自定义参数，输入数据直接预测，根据不断训练得到最优参数</li>
<li>3 第一个多头输入数据： 翻译答案的 Embedding 结果+位置信息Embedding 结果生成Q，K，V 矩阵</li>
<li>4 第一个多头： QK 矩阵乘以"答案贴纸"(Mask 矩阵)，再乘以 V，加权求和，再进行 software，多头结果拼接到一起就是最终的多头结果, 此时多头的作用，仅仅是获取了初步翻译结果词语之间的顺序，和中文答案没有任何对应关系，因为还没查"词典"</li>
<li>5 第一个 Add 和 Norm： 与 encoder 那个一毛一样</li>
<li>6 第二个多头输入数据：此时上面5 中的输入作为 Q(类似于"我要查字典")，encode输出作为 K，V(字典内索性和详细信息)</li>
<li>7 第二个多头：同样的方法计算多头结果，此时已经获取到了词典信息，正确率会提升不少</li>
<li>8 第二个Add 和 Norm： 与第一个处理方法一样</li>
<li>9 Feed Forword处理是一致的</li>
<li>10 第三个Add 和 Norm：同上</li>
<li>线性函数：把docode生成的矩阵转化成每个词表中对应的"分数"，搭建 “语义特征” 到 “具体词汇” 的桥梁 —— 把抽象的语义，映射到每个具体词的 “匹配度打分"</li>
<li>softmax: 做一个 “归一化转换”，让所有分数变成 0~1 之间的概率，且所有词的概率加起来等于 1；</li>
</ul>
</li>
</ul>
<h2 data-id="heading-5">5 bert：双向编码的预训练语言模型</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e378c9c20fb14c9897374378a2565fd2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-u5Lq65LiJ562J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764586180&amp;x-signature=so0dO%2FO7yOdrYGfdu8BedOQ8xoU%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60e4c52e2a444f64ba554cc5c131fe75~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-u5Lq65LiJ562J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764586180&amp;x-signature=4WpLM35CS%2Bk14b30Guy3lsncMrE%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<ul>
<li>1 预训练阶段：用大量的无监督文本通过自监督(无需人工标注)训练的方式( MLP 和 NSP)训练
<ul>
<li>输入：与 transform 类似，也是词Embedding+位置 Embedding 向量对应相加作为输入A，如果是句子对的情况还需要加上归属标记向量</li>
<li>但是句子开头有标识符Embeding [CLS]和句子末尾的[SEP]作为输入 B，A 和 B 构成了输入，注意，是拼接不是对应相加, 其中位置向量不是正余弦位置了，和 CLS 和 SEP 一样，都是从初始随机变量随机训练"可学习"的</li>
<li>transform 因为是单向的所以在输入的时候使用了 mask 矩阵，而bert 是不需要的，但是两个模型都是有"答案"对比的，不然无法反向传播进行训练</li>
</ul>
</li>
<li>MLM：先从输入中随机抽取 15%，准备进行处理，在这 15% 中，80% 概率直接 mask，10% 替换其他单词，10% 不动
<ul>
<li>10% 概率直接替换成其他单词，这有助于模型学习理解上下文的重要性，而不仅仅是依赖于[MASK]标记</li>
<li>10% 概率原封不动； 这有助于模型在微调阶段更好地处理未遮蔽的单词</li>
</ul>
</li>
<li>NSP：语料库中随机抽取两个句子，判断是不是上下文;
<ul>
<li>在BERT的后续版本中，Next Sentence Prediction（NSP）任务被废弃了。因为研究人员发现这个任务对下游任务的性能提升有限</li>
<li>举例：</li>
</ul>
<pre><code class="hljs language-python" lang="python">每个token的输入 = 自身向量（可学习） + 位置向量（可学习） + 句子归属向量（固定<span class="hljs-number">0</span>/<span class="hljs-number">1</span>）
	[CLS]  →  自身向量（初始随机：[<span class="hljs-number">0.2</span>, -<span class="hljs-number">0.1</span>, <span class="hljs-number">0.3</span>]） 
			+ 位置向量（第<span class="hljs-number">1</span>位：[<span class="hljs-number">0.5</span>, <span class="hljs-number">0.02</span>, -<span class="hljs-number">0.1</span>]） 
			+ 句子归属向量（句<span class="hljs-number">1</span>：[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>]） 
			= 最终输入向量：[<span class="hljs-number">0.7</span>, -<span class="hljs-number">0.08</span>, <span class="hljs-number">0.2</span>]  👉  不是固定值，训练中会变
	
	<span class="hljs-string">"我"</span>   →  自身向量（初始随机：[<span class="hljs-number">0.8</span>, <span class="hljs-number">0.4</span>, -<span class="hljs-number">0.2</span>]） 
			+ 位置向量（第<span class="hljs-number">2</span>位：[<span class="hljs-number">0.4</span>, <span class="hljs-number">0.05</span>, -<span class="hljs-number">0.05</span>]） 
			+ 句子归属向量（句<span class="hljs-number">1</span>：[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>]） 
			= 最终输入向量：[<span class="hljs-number">1.2</span>, <span class="hljs-number">0.45</span>, -<span class="hljs-number">0.25</span>]
	
	...（中间<span class="hljs-string">"爱"</span><span class="hljs-string">"吃"</span><span class="hljs-string">"苹果"</span>同理，都是各自向量相加，归属向量全为<span class="hljs-number">0</span>）...
	
	[SEP]  →  自身向量（初始随机：[-<span class="hljs-number">0.3</span>, <span class="hljs-number">0.6</span>, <span class="hljs-number">0.2</span>]） 
			+ 位置向量（第<span class="hljs-number">6</span>位：[<span class="hljs-number">0.1</span>, <span class="hljs-number">0.01</span>, -<span class="hljs-number">0.15</span>]） 
			+ 句子归属向量（句<span class="hljs-number">1</span>：[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>]） 
			= 最终输入向量：[-<span class="hljs-number">0.2</span>, <span class="hljs-number">0.61</span>, <span class="hljs-number">0.05</span>]
	
	<span class="hljs-string">"它"</span>   →  自身向量（初始随机：[<span class="hljs-number">0.1</span>, -<span class="hljs-number">0.3</span>, <span class="hljs-number">0.7</span>]） 
			+ 位置向量（第<span class="hljs-number">7</span>位：[<span class="hljs-number">0.08</span>, <span class="hljs-number">0.005</span>, -<span class="hljs-number">0.18</span>]） 
			+ 句子归属向量（句<span class="hljs-number">2</span>：[<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>]）  👉  句<span class="hljs-number">2</span>专属标记，和句<span class="hljs-number">1</span>区分
			= 最终输入向量：[<span class="hljs-number">1.18</span>, -<span class="hljs-number">0.295</span>, <span class="hljs-number">0.52</span>]
	
	...（中间<span class="hljs-string">"很"</span><span class="hljs-string">"甜"</span>同理，归属向量全为<span class="hljs-number">1</span>）...
	
	[SEP]  →  自身向量（初始随机：[-<span class="hljs-number">0.3</span>, <span class="hljs-number">0.6</span>, <span class="hljs-number">0.2</span>]） 
			+ 位置向量（第<span class="hljs-number">10</span>位：[<span class="hljs-number">0.02</span>, <span class="hljs-number">0</span>, -<span class="hljs-number">0.2</span>]） 
			+ 句子归属向量（句<span class="hljs-number">2</span>：[<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>]） 
			= 最终输入向量：[<span class="hljs-number">0.72</span>, <span class="hljs-number">1.6</span>, <span class="hljs-number">1.0</span>]
</code></pre>
</li>
<li>2 微调阶段：BERT首先使用预训练的参数初始化模型，所有参数都使用下游任务的标签数据进行微调，每个不同的下游任务都有单独的微调模型
<ul>
<li>bert 的主干就是多个 transform 的 encode 叠加，为了深入理解语义，但是具体任务使用还是需要在输出层(主干部分微调)进行微调处理</li>
<li>微调任务包含：
<ul>
<li>基于句子对的分类任务：核心共性：输入是 “句 1 + 句 2”，用 [CLS] 汇总全局语义，输出层做分类 / 回归，复用句对归属标记（0/1）
<ul>
<li>MNLI：自然语言推理)  输出层：线性层 + Softmax（三分类：蕴含 / 矛盾 / 中立）；目的：判断句 2 是否能从句 1 推出。</li>
<li>QQP（Quora 问答匹配）：输出层：线性层 + Softmax（二分类：两问题是否语义相同）；目的：判断两个问题是否是同一问题的不同表述。</li>
<li>QNLI（问答自然语言推理）输出层：线性层 + Softmax（二分类：段落句子是否能回答问题）；目的：筛选能回答问题的句子。</li>
<li>STS-B（语义文本相似度）：输出层：线性层（回归任务，输出 0~5 的相似度分数）；目的：量化两句话的语义相似程度。</li>
<li>MRPC（微软同义句匹配）：输出层：线性层 + Softmax（二分类：是否同义）；目的：判断两句话是否语义等价。</li>
<li>RTE（文本蕴含识别）：输出层：线性层 + Softmax（二分类：蕴含 / 不蕴含）；目的：简化版 MNLI，只判断是否蕴含。</li>
<li>SWAG（情境推理）输出层：线性层 + Softmax（四分类：从 4 个候选后半句选最连贯的）；目的：判断哪个候选句能承接前半句的情境。</li>
</ul>
</li>
<li>基于单个句子的分类任务：核心共性：输入是单句，不用句对标记（全标 0），[CLS] 汇总语义，输出层分类。
<ul>
<li>SST-2（情感分类）：输出层：线性层 + Softmax（二分类：正面 / 负面）；目的：判断句子情感倾向。</li>
<li>ColA（语言可接受性判断）：输出层：线性层 + Softmax（二分类：句子是否语法 / 语义通顺）；目的：判断句子是否是自然语言（比如 “我吃饭” 可接受，“饭吃我” 不可接受）。</li>
</ul>
</li>
<li>问答任务：核心：输入是 “问题 + 原文段落”，输出层预测答案的 “起始 / 结束位置”，不做分类做定位。
<ul>
<li>SQuAD：输出层：两个独立线性层（一个预测答案起始位置，一个预测结束位置）；
<ul>
<li>目的：从原文中找到问题的答案片段（比如问题 “李白生于哪年？”，原文 “李白生于 701 年”，预测起始 = 3，结束 = 5）。</li>
</ul>
</li>
</ul>
</li>
<li>命名实体识别NER：核心：输入是单句，输出层对 “每个词” 做分类（不是 [CLS] 汇总），识别实体类型。
<ul>
<li>CoNLL-2003 NER：输出层：给每个 token 配一个线性层 + Softmax（多分类：PER 人 / ORG 机构 / LOC 地点 / O 非实体）；
<ul>
<li>目的：给每个词打实体标签（比如 “李白（PER）生于 701 年，是唐代（ORG）诗人”）。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入理解 Doris Variant：如何让 JSON 查询性能追平列存，还能承载万列索引字段？｜Deep Dive]]></title>    <link>https://juejin.cn/post/7576086446459895843</link>    <guid>https://juejin.cn/post/7576086446459895843</guid>    <pubDate>2025-11-24T10:49:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576086446459895843" data-draft-id="7575897635137552384" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入理解 Doris Variant：如何让 JSON 查询性能追平列存，还能承载万列索引字段？｜Deep Dive"/> <meta itemprop="keywords" content="数据库,大数据,数据分析"/> <meta itemprop="datePublished" content="2025-11-24T10:49:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SelectDB"/> <meta itemprop="url" content="https://juejin.cn/user/3189021726222904"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入理解 Doris Variant：如何让 JSON 查询性能追平列存，还能承载万列索引字段？｜Deep Dive
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3189021726222904/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SelectDB
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T10:49:40.000Z" title="Mon Nov 24 2025 10:49:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在大数据时代，JSON 已成为数据交换的事实标准。从日志、埋点到 IoT 设备数据，从用户画像到实时监控，JSON 凭借其灵活、可扩展、无需预定义 Schema 的特性，完美契合了快速迭代的现代业务需求。然而，JSON 的动态灵活性与传统数据库的静态处理模型存在根本矛盾，这直接导致了查询性能低下、Schema 管理复杂以及在超宽表场景下的扩展性危机。</p>
<p>因此，对于 JSON 数据的处理，用户常常陷入两难抉择：</p>
<ul>
<li>牺牲 性能 换取 灵活性（用 JSON 存储，承担高昂查询开销）</li>
<li>牺牲 灵活性 换取 性能（提前建立 Schema，丧失动态响应业务变化能力）</li>
</ul>
<p><strong>那么，是否存在两全之策，能让性能与灵活性兼得？答案是肯定的。</strong> Doris  <code>VARIANT</code>通过底层的存算创新，将半结构化数据的灵活性与结构化数据的分析性能完美结合，全面超越了 Snowflake、ClickHouse 等传统方案。</p>
<p>具体而言，Doris Variant 充分发挥列存与索引优势，避免频繁解析和全量扫描导致 CPU 与 I/O 过高引发性能问题。此外，它能从容应对字段动态变化及类型不一致场景，简化 Schema 维护难度，消除了灵活性与性能间冲突。同时，Doris 优化了超宽表中键值繁多、稀疏分布带来的存储与索引复杂性，解决超宽表场景下扩展性问题。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2774fd14471d48f6b4eb799bfd035019~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764586180&amp;x-signature=QpEVVyaNFjI9jDNL7rrs9nlJbx0%3D" alt="Doris 与其他产品对比.png" loading="lazy"/></p>
<p>Doris <code>VARIANT</code> 的卓越性能也在业界公开的 JSONBench 半结构化数据测试中得到了充分验证：<strong>冷查询性能排名第一、热查询性能位居第二，全面领先 ClickHouse、Elasticsearch 等一众知名产品。</strong> 其查询速度约是 MongoDB 的 <strong>164</strong> 倍、PostgreSQL 的 <strong>1074</strong> 倍。此外，对 Doris、 Snowflake 进一步对比， 不管是在冷查询还是热查询中，Doris 相较 Snowflake 有约 2-5 倍的性能优势。具体可见下图：</p>
<ul>
<li>登顶 JSONBench 榜单</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b7c63612daf4c8797f801cbc3abf6e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764586180&amp;x-signature=123BrIYuCShIpmOHXRa12NpPBuM%3D" alt="登顶 JSONBench 榜单.PNG" loading="lazy"/></p>
<ul>
<li>Doris vs. Snowflake</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/20f682f38d664db9881c0367832b7809~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764586180&amp;x-signature=5I9Fdl6p9gSqR8Yap9wsS6QVkP4%3D" alt="Doris vs. Snowflake.PNG" loading="lazy"/></p>
<p><strong>Doris Variant 能够具备上述优势，主要得益于以下设计巧思及技术创新。</strong></p>
<h2 data-id="heading-0">一、如何让 JSON 获得列存性能？</h2>
<p>实现半结构化数据高性能分析的前提是，使其能够像处理结构化数据一样，为其构建高效的列式存储结构，这是后续高性能分析的基础。因此，<strong>在 Doris 中，通过动态子列、压缩算法、列裁剪等设计，将半结构数据规范化，从而获获得列存的高性能。</strong></p>
<h3 data-id="heading-1">1.1  动态子列</h3>
<p>在如 Snowflake 这样的系统中，JSON 数据的底层存储对用户而言是一个黑盒，难以进行查询优化、无法保证性能。而在 Doris 中，当 JSON 对象写入 VARIANT 列时，系统会执行以下操作：</p>
<ul>
<li><strong>子列与类型推断</strong>：解析 JSON 的层级结构，提取出所有的 Key Path（如 <code>user.id</code>, <code>event.properties.timestamp</code>），并自动推断每个子列的值类型（如 <code>BIGINT</code>, <code>DOUBLE</code>, <code>STRING</code> 等）。</li>
<li><strong>动态列化（Subcolumnization）</strong>： 对于频繁出现的子列，将其<strong>物化</strong>为独立的内部子列。例如，嵌套在 JSON 中的 <code>user.id</code> 字段在物理存储上会拥有独立的 <code>BIGINT</code> 列式存储结构。</li>
<li><strong>透明访问</strong> ：该过程对用户完全透明。无需预先定义 Schema，数据写入时自动完成列式转换。用户仍可使用 <code>v['user']['id']</code>查询 ，但查询引擎可以直接访问到已物化的 <code>user.id</code> 子列，充分利用列存和向量化执行的性能优势。</li>
<li><strong>稀疏列</strong> ：对于出现频率极低或结构复杂的稀疏子列，不为其创建独立子列以避免列爆炸。相反，这些数据会被高效组织在一个类 JSONB 的二进制“稀疏”列中，保留完整数据而不为罕见字段额外建列。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e8cc9776671c46bc8803f7e3a8e034ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764586180&amp;x-signature=RXHijSljh%2Fz5WUC5whwM5wRodXY%3D" alt="动态子列.png" loading="lazy"/></p>
<p><strong>通过这一机制，Doris 在数据写入阶段就完成了从半结构化到准结构化的转换，为高性能分析奠定了基础。</strong></p>
<h3 data-id="heading-2">1.2 列式存储</h3>
<p>在动态子列的基础上，Doris 进一步运用成熟的列式存储技术，实现存储与 I/O 效率的倍增。</p>
<ul>
<li><strong>压缩</strong>： Doris 会根据子列的数据分布自动挑选压缩算法，例如枚举型字段使用字典编码、连续数值用 RLE，从而实现更紧凑的存储并降低读取成本。</li>
<li><strong>子列级 I/O （列裁剪）</strong>：查询只读取实际需要的字段，消除了过去整块 JSON 拉入再解析的方式。通过 Path 级别列裁剪和延迟物化机制，仅加载必需的 JSON 子列数据，有效减少了数据读取的放大问题。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0873a066f5b7489fb94b56bcd7735382~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764586180&amp;x-signature=wb1E4Rt1UmopJGsL9Onc7h%2BvA74%3D" alt="列式存储.png" loading="lazy"/></p>
<p>通过以上策略，<strong>Doris 解决传统系统中 JSON 查询的慢和重问题，成功地将 JSON 数据的灵活性与列式存储的高性能相结合，实现了半结构化数据的高效分析。</strong> 这种方法不仅提高了查询性能，还简化了 Schema 管理，为用户带来显著的使用优势。</p>
<h3 data-id="heading-3">1.3 千列级存储的性能跃升</h3>
<p>然后，当数据模型从宽进一步演化为超宽时，新的挑战也随之而来。因此 Doris Variant 持续优化，使其能够从容面对<strong>元数据膨胀与合并（Compaction）开销巨大的问题。</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/abce2ed23cb445ad89a614589e1e7386~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764586180&amp;x-signature=ITIV6DriPkZamd24JcHMi9aFbgQ%3D" alt="1.3 千列级存储的性能跃升.png" loading="lazy"/></p>
<h4 data-id="heading-4">1.3.1 元数据存储优化</h4>
<p>在日志分析、用户画像等超宽表场景中，单表常涉及上千个列（列存）。即便查询仅需访问其中几列，也需将包含所有列元数据的庞大 Footer 完整加载至内存并解析，内存和反序列化成本急剧膨胀，导致严重的 I/O 与内存开销。</p>
<p>为此，Doris 在 Segment 文件格式层进行了关键优化：将列元数据从 Footer 中剥离，独立存储于专用的数据页（可理解为元数据索引页）中，Footer 仅保留指向该页的轻量指针。读取时先加载精简 Footer，再按需定位并加载所需列元数据。这种 <strong>Externalize Meta</strong> 的设计，从根本上避免了宽表场景下的元数据膨胀问题，使列裁剪始终保持高效。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a1cc33cccf24b5c838a90186f877723~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764586180&amp;x-signature=V%2FstrAJaah22%2BgCcoBBeeUjWtUo%3D" alt="1.3.1 元数据存储优化.png" loading="lazy"/></p>
<p>以下是关于 VARIANT 元数据打开效率的测试对比（环境设置包含 10,000 个 Segment，每个 Segment 拥有 7,000 个 JSON Path，且均已物化为子列）：</p>
<ul>
<li>优化前：需要解析巨大 Footer（包含所有列的 ColumnMeta），导致大量无效的 I/O 操作、反序列化和内存膨胀，I/O 成为性能瓶颈。</li>
<li>优化后：首先读取小型 Footer（仅包含 PagePointer），然后按需加载被访问列的元数据，避免全量解析。<strong>打开速度从 65s 缩减至 4s，效率提升约 16 倍；内存从 60GB 缩减至小于 1GB。</strong></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc88d4561b084c9b9d4ae8a8d22c07c7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764586180&amp;x-signature=BMaqRHlbPFK7UM6qd7LNLPliZmI%3D" alt="1.3.1 元数据存储优化-1.png" loading="lazy"/></p>
<h4 data-id="heading-5">1.3.2 Vertical Compaction</h4>
<p>在超宽表场景中，数据合并（Compaction）一直是最棘手的环节。随着表中列数达到上千甚至上万，传统合并策略会暴露出两个主要问题：首先，每次合并都需扫描并重写所有列，即使绝大多数字段并未更新；其次，列元数据和 Segment 文件体积庞大，导致合并的 I/O 成本和内存消耗大幅增加。</p>
<p>为此，Doris Variant 引入子列级 Vertical Compaction，将单次 Compaction 拆分为按列分组的多轮合并。每轮仅加载部分列组（如 10 列），逐步完成全量合并。此举带来两大核心改进：</p>
<ul>
<li><strong>内存峰值显著降低</strong>：每轮只需持有部分列的中间数据，避免了全列并发合并带来的内存瞬时激增；</li>
<li><strong>I/O 访问更加可控</strong>：更细粒度的列组处理，可以更好与磁盘调度、后台刷写并行化配合。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a52191afba441339975a80e9beaa28f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764586180&amp;x-signature=%2B0NN7fFQiIfW1HeN7b%2BTNFdt1C4%3D" alt="1.3.2 Vertical Compaction.png" loading="lazy"/></p>
<p>实测结果显示，在表结构中列数超过 1,000 时，<strong>开启 Vertical Compaction 后，单次合并的内存占用从约 50 GB 降至 2 GB 左右，降低近 25 倍；同时，整体吞吐量几乎未受影响</strong>。更重要的是，Vertical Compaction 使 VARIANT 不再只是能存 JSON，还能在动态 Schema 的超宽表模型中实现长期稳定的运行——这是大多数列式引擎的薄弱环节。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c4a2e468af6e418e9921aa344d5f3fca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764586180&amp;x-signature=c2jerNavo3jyY2UJKMOvO2v6a6s%3D" alt="1.3.2 Vertical Compaction-1.png" loading="lazy"/></p>
<h2 data-id="heading-6">二、 兼备结构化查询与全文检索</h2>
<p>动态子列解决了 JSON 在大规模扫描与聚合场景下的性能瓶颈，而 Doris 进一步为其构建了高度可定制的索引机制，使其在点查询与文本检索场景下也具备极速响应的能力。设计借鉴了 Elasticsearch <code>dynamic mapping</code> 的思想，可提供开箱即用的高性能索引能力。</p>
<p>Doris Variant 的索引体系，目标是在 结构化过滤 与 全文检索 之间取得平衡。它既能像列存一样高效命中结构化字段，又能像搜索引擎一样支持关键词匹配与短语检索。为实现这一目标，<strong>Doris 在存储层集成倒排索引，并与 ZoneMap、BloomFilter、延迟物化 等原生索引协同工作，实现从文件级到行级的多层剪枝与快速定位</strong>。下面从几个关键机制来看它的实现方式：</p>
<h3 data-id="heading-7">2.1 倒排索引的无缝集成</h3>
<ul>
<li>原理： <code>VARIANT</code> 允许用户为任意子列创建倒排索引。例如，<code>CREATE INDEX idx ON tbl(v) USING INVERTED PROPERTIES("parser" = "english")</code>。Doris 在数据写入时，自动提取 <code>v</code> 子列的值，并分词（如果需要）或按原始值建立一个从“词（Term）”到“行号（RowID）”的映射表。</li>
<li>查询： 当查询条件为 <code>WHERE v['message'] MATCH_ANY 'error'</code> 或 <code>v['level'] = 'FATAL'</code> 时，查询引擎不需扫描全表数据。可直接利用倒排索引，快速定位包含关键词 <code>error</code> 或 <code>FATAL</code> 的所有行，查询复杂度从 O(N) 降至 O(logN) 甚至 O(1）。</li>
</ul>
<h3 data-id="heading-8">2.2 内置索引的协同</h3>
<p>由于高频子列已被物化为内部子列，它们自然享受到 Doris 的其他索引类型的加成：</p>
<ul>
<li>ZoneMap 索引： 默认开启，记录每个数据块（Page）内子列最大/最小值。对于 <code>WHERE v['properties']['price'] &gt; 1000</code> 这样的范围查询，可快速跳过不满足条件的数据块，甚至跳过文件。</li>
<li>BloomFilter 索引： 对于高基数的子列（如 <code>user_id</code>），可创建布隆过滤器索引，快速判断某个值是否存在，过滤掉大量无关读取请求。</li>
<li>延迟物化配合索引： 先用 ZoneMap/BBloomFilter 倒排在文件/页/行级完成剪枝与定位，再对查询命中的行按需解码非谓词投影的子列，避免对未投影或被过滤掉的子列做无谓解码，可有效降低 CPU 与 I/O 成本。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ec7f7b87521467a8959eb8f14e71b6d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764586180&amp;x-signature=zOy%2BaUDq73kI8CF6rGW6wmtUZlU%3D" alt="2.2 内置索引的协同.png" loading="lazy"/></p>
<h3 data-id="heading-9">2.3 Schema Template 与 Path 级索引</h3>
<p>Schema Template 和 Path 级索引 是实现精确索引下推的关键机制。前者定义「哪些 JSON 子列需被单独识别与优化」，后者定义「这些子列如何被索引与命中」。</p>
<p>通过 Schema Template，可以为关键子列预声明类型及索引属性，让系统在读写阶段就能识别这些高价值路径。 Path 级索引则在此基础上绑定倒排、Bloom 或 ZoneMap 等多层索引策略，实现结构感知的查询优化。</p>
<p>典型配置：</p>
<pre><code class="hljs language-SQL" lang="SQL"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> tbl (
    k <span class="hljs-type">BIGINT</span>,
    v VARIANT<span class="hljs-operator">&lt;</span><span class="hljs-string">'content'</span> : STRING<span class="hljs-operator">&gt;</span>,
    INDEX idx_tokenized(v) <span class="hljs-keyword">USING</span> INVERTED PROPERTIES(
        "parser" <span class="hljs-operator">=</span> "english",
        "field_pattern" <span class="hljs-operator">=</span> "content",
        "support_phrase" <span class="hljs-operator">=</span> "true"
    ),
    INDEX idx_keyword(v) <span class="hljs-keyword">USING</span> INVERTED PROPERTIES(
        "field_pattern" <span class="hljs-operator">=</span> "content"
    )
);

<span class="hljs-comment">-- tokenized for MATCH; keyword for exact equality</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> tbl <span class="hljs-keyword">WHERE</span> v[<span class="hljs-string">'content'</span>] <span class="hljs-keyword">MATCH</span> <span class="hljs-string">'Doris'</span>;
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> tbl <span class="hljs-keyword">WHERE</span> v[<span class="hljs-string">'content'</span>] <span class="hljs-operator">=</span> <span class="hljs-string">'Doris'</span>;
</code></pre>
<blockquote>
<p>tokenized 用于 <code>MATCH</code> 搜索；keyword 用于精确匹配。</p>
</blockquote>
<p>通配符示例：</p>
<pre><code class="hljs language-SQL" lang="SQL">INDEX idx_logs(v) <span class="hljs-keyword">USING</span> INVERTED PROPERTIES(
  "field_pattern" <span class="hljs-operator">=</span> "logs.*"
);
</code></pre>
<p>更多使用方式请参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoris.apache.org%2Fzh-CN%2Fdocs%2F3.x%2Fsql-manual%2Fbasic-element%2Fsql-data-types%2Fsemi-structured%2FVARIANT" target="_blank" title="https://doris.apache.org/zh-CN/docs/3.x/sql-manual/basic-element/sql-data-types/semi-structured/VARIANT" ref="nofollow noopener noreferrer">Variant 文档</a></p>
<h2 data-id="heading-10">三、典型场景实战指南</h2>
<h3 data-id="heading-11">3.1  日志分析场景</h3>
<p>基于 Elasticsearch 或 ClickHouse 的日志分析平台是较为常见的方案，但其问题也比较明显：写入成本高、字段变化难以管理以及查询吞吐不稳定等。</p>
<p>而如果使用 Doris ，Variant 类型可直接写入原始 JSON 日志，不再需要复杂的 ETL 或 Schema Flatten，无需复杂的预处理和 Schema 定义，即可对任意日志字段进行高性能的过滤和全文检索。</p>
<p>示例建表：</p>
<pre><code class="hljs language-SQL" lang="SQL"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> access_log (
  dt <span class="hljs-type">DATE</span>,
  log JSON
)
DUPLICATE KEY(dt)
DISTRIBUTED <span class="hljs-keyword">BY</span> HASH(dt)
PROPERTIES ("replication_num" <span class="hljs-operator">=</span> "1");

<span class="hljs-keyword">CREATE</span> INDEX idx_log <span class="hljs-keyword">ON</span> access_log(log) <span class="hljs-keyword">USING</span> INVERTED;
</code></pre>
<p>日志通过 Stream Load 实时写入：</p>
<pre><code class="hljs language-SQL" lang="SQL">curl <span class="hljs-operator">-</span>u <span class="hljs-keyword">user</span>:password \
  <span class="hljs-operator">-</span>T access.json \
  <span class="hljs-operator">-</span>H "format: json" \
  http:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>fe_host:<span class="hljs-number">8030</span><span class="hljs-operator">/</span>api<span class="hljs-operator">/</span>db<span class="hljs-operator">/</span>access_log<span class="hljs-operator">/</span>_stream_load
</code></pre>
<p>随后就可以像操作结构化数据一样执行查询：</p>
<pre><code class="hljs language-SQL" lang="SQL"><span class="hljs-keyword">SELECT</span>
  log[<span class="hljs-string">'status'</span>] <span class="hljs-keyword">AS</span> status,<span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">AS</span> cnt
<span class="hljs-keyword">FROM</span> access_log
<span class="hljs-keyword">WHERE</span> log[<span class="hljs-string">'region'</span>] <span class="hljs-operator">=</span> <span class="hljs-string">'US'</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> status;
</code></pre>
<p>在这个场景中，Doris 会自动将 key 列化存储，例如 <code>region</code> 和 <code>status</code>，从而实现<strong>亚秒级聚合性能</strong>。同时日志结构若有新增字段（例如 <code>latency</code> 或 <code>trace_id</code>），系统会自动创建列存并写入索引，无需手动 ALTER TABLE 或重新导入。</p>
<p><strong>实测表明，在同等硬件条件下，Doris 的日志聚合查询性能相比 Elasticsearch 快 2–3 倍，写入延迟降低 80% 以上，减少约 70–80% 存储空间。</strong></p>
<h3 data-id="heading-12">3.2 动态用户画像</h3>
<p>在用户画像系统中，每个用户通常拥有成百上千个标签，如地域、兴趣、偏好、活跃度和渠道来源等。这些标签往往需要频繁新增或变更。传统的列式建模方案意味着需要不断修改表结构或维护上百个宽表，这种做法效率极低。而 Doris 的 VARIANT 只需一个 Profile 列即可容纳所有标签信息。</p>
<p><strong>示例建表：</strong></p>
<pre><code class="hljs language-SQL" lang="SQL"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> user_profile (
  user_id <span class="hljs-type">BIGINT</span>,
  profile VARIANT
)
DUPLICATE KEY(user_id)
DISTRIBUTED <span class="hljs-keyword">BY</span> HASH(user_id);
</code></pre>
<p>写入时直接插入 JSON 结构：</p>
<pre><code class="hljs language-JSON" lang="JSON">INSERT INTO user_profile VALUES
(<span class="hljs-number">1001</span><span class="hljs-punctuation">,</span> '<span class="hljs-punctuation">{</span><span class="hljs-attr">"region"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"US"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"age"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">28</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"interest"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"movie"</span><span class="hljs-punctuation">,</span><span class="hljs-string">"sports"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">}</span>')<span class="hljs-punctuation">,</span>
(<span class="hljs-number">1002</span><span class="hljs-punctuation">,</span> '<span class="hljs-punctuation">{</span><span class="hljs-attr">"region"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"CA"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"vip"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"device"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ios"</span><span class="hljs-punctuation">}</span>');
</code></pre>
<p>查询时无需展开，也能高效聚合：</p>
<pre><code class="hljs language-SQL" lang="SQL"><span class="hljs-keyword">SELECT</span>
  <span class="hljs-built_in">CAST</span>(profile[<span class="hljs-string">'region'</span>] <span class="hljs-keyword">AS</span> String) <span class="hljs-keyword">AS</span> region,<span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">AS</span> cnt
<span class="hljs-keyword">FROM</span> user_profile
<span class="hljs-keyword">WHERE</span> profile[<span class="hljs-string">'vip'</span>] <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> region;
</code></pre>
<p>在后台，Doris 会自动识别出现的 key （如 <code>region</code> 、<code>vip</code> ），并将其物化为独立列（支持成千上万的独立列）。极其低频字段仍保留在兜底 <code>Sparse</code> 列中。 因此即便标签数量增长到上千个，查询性能依然接近普通结构化表。</p>
<p><strong>实际用户测试中，拥有 7000 个动态标签的用户画像表，查询 Top10 标签分布的平均响应时间保持在 1 秒以内。</strong></p>
<h3 data-id="heading-13">3.3 客户使用反馈</h3>
<p>度小满实现从 Greenplum 到  Apache Doris 的平滑迁移，构建了超大规模数据分析平台。借助内置的 Variant 类型，实现了对 2–3 万  JSON Key 的高效查询与存储（PB 级别）。<strong>系统整体性能提升 20–30 倍，JSON 查询速度提升 10 倍，存储占用为传统 JSON 类型的 1/10</strong>。在高并发实时查询与复杂分析任务下，成功支撑 金融级指标分析与实时数据服务，让度小满的数据平台实现从 离线分析 → 实时洞察的跨越。</p>
<p>——度小满</p>
<p>某大型互联网公司将原有 HBase + Elasticsearch + Snowflake 三套系统迁移至 Doris 这一套系统中来，实现了搜索与分析统一。<strong>Doris Variant 列式数据类型支持高维、动态 JSON 的高效存储与查询，让数十亿对象的非结构化属性也能以列式方式处理</strong>。并基于子列索引与裁剪机制，<strong>查询延迟从秒级降至百毫秒级</strong>，并发写入与复杂 Join 性能也显著提升。系统整体成本降低，架构得到简化，稳定性与一致性全面增强。</p>
<p>——某大型互联网公司</p>
<p>在原系统中（Elasticsearch），Dynamic Mapping 导致字段冲突频发、资源占用高、聚合性能受限。观测云携手飞轮科技，基于 Doris 引入 Variant 数据类型与倒排索引，并通过 S3 对象存储 构建弹性冷热分离架构，大幅提升日志与行为数据的查询效率。升级后，<strong>机器成本降低 70%，整体查询性能提升 2 倍，简单查询提速超 4 倍，以不到 1/3 的成本获得数倍性能提升</strong>，显著增强了可观测性平台的可扩展性与经济性。</p>
<p>——观测云</p>
<p>某全球领先的新能源与智能制造企业将原有 Hive/Kudu + Impala/Presto 体系迁移到 Apache Doris，构建了面向车联网与装备全生命周期的实时分析平台。<strong>依托 Doris 内置的 Variant 类型，高效处理 PB 级规模的 JSON 半结构化数据，实现秒级实时摄取和毫秒级查询性能。</strong> 在核心业务如实时看板、全链路追踪、设备运行与健康分析等场景中，<strong>复杂 JSON 查询提速 3–10 倍、高并发查询能力显著提升、且存储占用仅为传统方案的 1/3</strong>。借助统一的 Doris 引擎，实现从离线批处理到实时洞察的跨越，大幅降低整体架构复杂度与运维成本。</p>
<p>——某全球领先的新能源与智能制造企业</p>
<p>面对上百万辆车日均数十 TB 信号数据的挑战，零跑采用 <strong>Variant 动态列存</strong> 与 <strong>S3 对象存储</strong> 构建统一数据底座，支持了智能座舱、远程诊断和用户行为分析等多场景。结合物化视图与弹性计算，实现毫秒级查询与自动伸缩、存储成本下降 60% 的显著成效。团队正进一步验证 <strong>Serverless 形态</strong>，希望利用 S3 的高弹性与 Doris 的高性能，实现“按需使用、零运维伸缩”的数据云脑。</p>
<p>—— 零跑汽车</p>
<h2 data-id="heading-14">四、结束语</h2>
<p>Apache Doris 的 <code>VARIANT</code> 类型，让半结构化数据能在列式引擎中被自然地处理。它通过动态子列、稀疏列存储、延迟物化和路径索引，将 JSON 解析、列裁剪与索引下推整合为统一体系，实现了<strong>灵活结构 与 列存性能</strong>的平衡。</p>
<p>未来，Apache Doris 将进一步增强 Variant 自动 Schema 推导能力，支持更丰富的类型、更强大的子列索引系统，并优化稀疏列的数据查询。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kubernetes CRD 方式配置容器日志采集最佳实践]]></title>    <link>https://juejin.cn/post/7576175307356323875</link>    <guid>https://juejin.cn/post/7576175307356323875</guid>    <pubDate>2025-11-24T11:01:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576175307356323875" data-draft-id="7575910298283737123" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kubernetes CRD 方式配置容器日志采集最佳实践"/> <meta itemprop="keywords" content="Kubernetes"/> <meta itemprop="datePublished" content="2025-11-24T11:01:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="可观测性用观测云"/> <meta itemprop="url" content="https://juejin.cn/user/2392958212523102"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kubernetes CRD 方式配置容器日志采集最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2392958212523102/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    可观测性用观测云
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T11:01:05.000Z" title="Mon Nov 24 2025 11:01:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、概述</h2>
<p>DataKit 通过 Kubernetes Custom Resource Definition (CRD) 提供了一种声明式的容器日志采集配置方式。用户可以通过创建 ClusterLoggingConfig 资源来自动配置 DataKit 的日志采集，无需手动修改 DataKit 配置文件或重启 DataKit，同样也无需重启业务。</p>
<h2 data-id="heading-1">二、前置条件</h2>
<ul>
<li>Kubernetes 集群版本 1.16+</li>
<li>DataKit Version-1.84.0 或更新版本</li>
<li>集群管理员权限（用于注册 CRD）</li>
</ul>
<h2 data-id="heading-2">三、采集流程</h2>
<h3 data-id="heading-3">1. 注册 Kubernetes CRD</h3>
<ul>
<li>使用以下 YAML 注册 <code>ClusterLoggingConfig</code> CRD：</li>
</ul>

<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apiextensions.k8s.io/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">CustomResourceDefinition</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">clusterloggingconfigs.logging.datakits.io</span>
  <span class="hljs-attr">labels:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">datakit-logging-config</span>
    <span class="hljs-attr">version:</span> <span class="hljs-string">v1alpha1</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">group:</span> <span class="hljs-string">logging.datakits.io</span>
  <span class="hljs-attr">versions:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">v1alpha1</span>
      <span class="hljs-attr">served:</span> <span class="hljs-literal">true</span>
      <span class="hljs-attr">storage:</span> <span class="hljs-literal">true</span>
      <span class="hljs-attr">schema:</span>
        <span class="hljs-attr">openAPIV3Schema:</span>
          <span class="hljs-attr">type:</span> <span class="hljs-string">object</span>
          <span class="hljs-attr">properties:</span>
            <span class="hljs-attr">apiVersion:</span>
              <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
            <span class="hljs-attr">kind:</span>
              <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
            <span class="hljs-attr">metadata:</span>
              <span class="hljs-attr">type:</span> <span class="hljs-string">object</span>
            <span class="hljs-attr">spec:</span>
              <span class="hljs-attr">type:</span> <span class="hljs-string">object</span>
              <span class="hljs-attr">required:</span>
                <span class="hljs-bullet">-</span> <span class="hljs-string">selector</span>
              <span class="hljs-attr">properties:</span>
                <span class="hljs-attr">selector:</span>
                  <span class="hljs-attr">type:</span> <span class="hljs-string">object</span>
                  <span class="hljs-attr">properties:</span>
                    <span class="hljs-attr">namespaceRegex:</span>
                      <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
                    <span class="hljs-attr">podRegex:</span>
                      <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
                    <span class="hljs-attr">podLabelSelector:</span>
                      <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
                    <span class="hljs-attr">containerRegex:</span>
                      <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
                <span class="hljs-attr">podTargetLabels:</span>
                  <span class="hljs-attr">type:</span> <span class="hljs-string">array</span>
                  <span class="hljs-attr">items:</span>
                    <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
                <span class="hljs-attr">configs:</span>
                  <span class="hljs-attr">type:</span> <span class="hljs-string">array</span>
                  <span class="hljs-attr">items:</span>
                    <span class="hljs-attr">type:</span> <span class="hljs-string">object</span>
                    <span class="hljs-attr">required:</span>
                      <span class="hljs-bullet">-</span> <span class="hljs-string">source</span>
                      <span class="hljs-bullet">-</span> <span class="hljs-string">type</span>
                    <span class="hljs-attr">properties:</span>
                      <span class="hljs-attr">source:</span>
                        <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
                      <span class="hljs-attr">type:</span>
                        <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
                      <span class="hljs-attr">disable:</span>
                        <span class="hljs-attr">type:</span> <span class="hljs-string">boolean</span>
                      <span class="hljs-attr">path:</span>
                        <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
                      <span class="hljs-attr">multiline_match:</span>
                        <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
                      <span class="hljs-attr">pipeline:</span>
                        <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
                      <span class="hljs-attr">storage_index:</span>
                        <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
                      <span class="hljs-attr">tags:</span>
                        <span class="hljs-attr">type:</span> <span class="hljs-string">object</span>
                        <span class="hljs-attr">additionalProperties:</span>
                          <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
  <span class="hljs-attr">scope:</span> <span class="hljs-string">Cluster</span>
  <span class="hljs-attr">names:</span>
    <span class="hljs-attr">plural:</span> <span class="hljs-string">clusterloggingconfigs</span>
    <span class="hljs-attr">singular:</span> <span class="hljs-string">clusterloggingconfig</span>
    <span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterLoggingConfig</span>
    <span class="hljs-attr">shortNames:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">logging</span>
</code></pre>
<ul>
<li>创建 CRD 资源，自动应用采集配置</li>
</ul>

<pre><code class="hljs">kubectl apply -f clusterloggingconfig-crd.yaml
</code></pre>
<ul>
<li>验证 CRD 注册</li>
</ul>

<pre><code class="hljs language-arduino" lang="arduino">kubectl get crd clusterloggingconfigs.logging.datakits.io
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e075581d4108435886c2ea264e096d6b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764586864&amp;x-signature=d1sZI7PVP%2FYBATUf%2Bs3G7MkcyM0%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">2. 创建 CRD 配置资源</h3>
<ul>
<li>如下为业务应用 yaml ：</li>
</ul>

<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">deploy-demo</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">matchLabels:</span>
      <span class="hljs-attr">app:</span> <span class="hljs-string">demo</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">metadata:</span>
      <span class="hljs-attr">labels:</span>
        <span class="hljs-attr">app:</span> <span class="hljs-string">demo</span>
        <span class="hljs-attr">version:</span> <span class="hljs-string">v1.0</span>
        <span class="hljs-attr">enviroment:</span> <span class="hljs-string">test</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">containers:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">container-demo</span>
          <span class="hljs-attr">image:</span> <span class="hljs-string">swr.cn-north-4.myhuaweicloud.com/liurui_bj/springboot-server:openj8</span>
          <span class="hljs-attr">resources:</span>
            <span class="hljs-attr">limits:</span>
              <span class="hljs-attr">cpu:</span> <span class="hljs-string">250m</span>
              <span class="hljs-attr">memory:</span> <span class="hljs-string">512Mi</span>
            <span class="hljs-attr">requests:</span>
              <span class="hljs-attr">cpu:</span> <span class="hljs-string">250m</span>
              <span class="hljs-attr">memory:</span> <span class="hljs-string">512Mi</span>
</code></pre>
<ul>
<li>k8s 部署运行业务后如下：</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba6b894d43d0445b8602e5d6c7850280~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764586864&amp;x-signature=YZb9azQbK98EkCcqcE1zkM8Zr0w%3D" alt="" loading="lazy"/></p>
<ul>
<li>对应采集配置如下，该采集配置用于采集 default 工作空间 demo 业务的容器内日志以及容器的标准输出，容器内日志来源 source 自定义命名为 demo-file，容器标准输出的 source 自定义命名为 demo-std，更多配置参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.guance.com%2Fintegrations%2Fcontainer-log-for-k8s-crd%2F%23configuration-details" target="_blank" title="https://docs.guance.com/integrations/container-log-for-k8s-crd/#configuration-details" ref="nofollow noopener noreferrer">链接</a></li>
</ul>

<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">logging.datakits.io/v1alpha1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterLoggingConfig</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">demo-logs</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">namespaceRegex:</span> <span class="hljs-string">"^(default)$"</span>
    <span class="hljs-attr">podRegex:</span> <span class="hljs-string">"^(deploy.*)$"</span>
    <span class="hljs-attr">podLabelSelector:</span> <span class="hljs-string">"app=demo"</span>

  <span class="hljs-attr">podTargetLabels:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">app</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">version</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">enviroment</span>

  <span class="hljs-attr">configs:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">source:</span> <span class="hljs-string">"demo-file"</span>
      <span class="hljs-attr">type:</span> <span class="hljs-string">"file"</span>
      <span class="hljs-attr">path:</span> <span class="hljs-string">"/data/logs/server/server.log"</span>
      <span class="hljs-attr">tags:</span>
        <span class="hljs-attr">log_type:</span> <span class="hljs-string">"server"</span>
        <span class="hljs-attr">component:</span> <span class="hljs-string">"springboot-server"</span>

    <span class="hljs-bullet">-</span> <span class="hljs-attr">source:</span> <span class="hljs-string">"demo-std"</span>
      <span class="hljs-attr">type:</span> <span class="hljs-string">"stdout"</span>
      <span class="hljs-attr">disable:</span> <span class="hljs-literal">false</span>
      <span class="hljs-attr">tags:</span>
        <span class="hljs-attr">log_type:</span> <span class="hljs-string">"server"</span>
        <span class="hljs-attr">component:</span> <span class="hljs-string">"springboot-server"</span>
</code></pre>
<ul>
<li>应用配置</li>
</ul>

<pre><code class="hljs language-arduino" lang="arduino">kubectl apply -f logging-config.yaml
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d750d0fe04274e52a41e47cc6fec7d00~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764586864&amp;x-signature=%2BIde3sTATHBm8fGrTNCddrUIKg8%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">3. 添加相关 RBAC 配置</h3>
<ul>
<li>在 DataKit 的 ClusterRole 中添加以下权限：</li>
</ul>

<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">apiVersion: rbac.authorization.k8s.io/v1</span>
<span class="hljs-section">kind: ClusterRole</span>
<span class="hljs-section">metadata:</span>
  name: datakit
<span class="hljs-section">rules:</span>
  <span class="hljs-comment"># 原有的其他权限</span>
  - apiGroups: [<span class="hljs-string">"logging.datakits.io"</span>]
    resources: [<span class="hljs-string">"clusterloggingconfigs"</span>]
    verbs: [<span class="hljs-string">"get"</span>, <span class="hljs-string">"list"</span>, <span class="hljs-string">"watch"</span>]
</code></pre>
<ul>
<li>调整 DataKit 的其他<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.guance.com%2Fintegrations%2Fcontainer%2F%23__tabbed_1_2" target="_blank" title="https://docs.guance.com/integrations/container/#__tabbed_1_2" ref="nofollow noopener noreferrer">采集配置</a>，如日志白名单，采集器，数据 dataway 上报地址等，重新 apply DataKit 应用</li>
</ul>

<pre><code class="hljs">kubectl apply -f datakit.yaml
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/893894241f2e47c4b17bc80ba192a6e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764586864&amp;x-signature=7pXsrn8goQ5lsvmEKBdekexr9vI%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">4. 额外配置与说明</h3>
<ul>
<li>需要全局屏蔽日志标准输出采集，需要额外应用自定义 CRD 配置，如下：</li>
</ul>

<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterLoggingConfig</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">test</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">namespaceRegex:</span> <span class="hljs-string">"^(.*)$"</span>

  <span class="hljs-attr">configs:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">source:</span> <span class="hljs-string">"test"</span>
      <span class="hljs-attr">type:</span> <span class="hljs-string">"stdout"</span>
      <span class="hljs-attr">disable:</span> <span class="hljs-literal">true</span>
</code></pre>
<ul>
<li>DataKit 需要打开 container 采集器，不然 CRD 配置不生效</li>
</ul>
<h2 data-id="heading-7">四、日志采集展示</h2>
<ul>
<li>容器内日志如下图，数据成功上报到观测云，相关 source，log_type，component 等配置字段均成功上报</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b4608a8d65244869a5346e95a6ce94b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764586864&amp;x-signature=LheUw64xVGnujnT%2FW3dLAHXoi%2Fk%3D" alt="" loading="lazy"/></p>
<ul>
<li>容器标准输出如下图，据成功上报到观测云，相关 source，log_type。component 等配置字段均成功上报</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4d2651e1e344899b8ecce3821f0e3f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764586864&amp;x-signature=bwRRASuTHMVjOqFCsrTaAlv2sTY%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot 数据存储实战拆解！]]></title>    <link>https://juejin.cn/post/7575910298283163683</link>    <guid>https://juejin.cn/post/7575910298283163683</guid>    <pubDate>2025-11-24T08:55:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575910298283163683" data-draft-id="7576175307352342543" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot 数据存储实战拆解！"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-24T08:55:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员西西"/> <meta itemprop="url" content="https://juejin.cn/user/326976944214804"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot 数据存储实战拆解！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/326976944214804/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员西西
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T08:55:59.000Z" title="Mon Nov 24 2025 08:55:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Elasticsearch是一个基于Apache Lucene开发的的搜索服务，提供了一个分布式多用户能力的全文搜索引擎，并基于RESTful web接口。支持结构化搜索、数据分析、复杂的语言处理、地理位置和对象间关联关系等功能。那么如何在SpringBoot项目中整合ElasticSearch来完成数据的存储呢？下面我们就来看看。</p>
<p>这里需要特别说明在高版本的ElasticSearch对于数据的处理方式与低版本的处理方式是不同的，并且，在Spring Boot中所支持的ElasticSearch客户端版本也是有所差异的。这里演示的是基于 Spring Boot 2.1.4.RELEASE 版本和ElasticSearch 6.8.0的版本处理方式。</p>
<h2 data-id="heading-0">依赖和配置</h2>
<p>添加Elasticsearch的依赖到<strong>pom.xml</strong>文件中。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.1.4.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span>

```js
```
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-elasticsearch<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>在配置文件文件中配置ElasticSearch的连接</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">spring.data.elasticsearch.cluster-name</span>=my-cluster
<span class="hljs-attr">spring.data.elasticsearch.cluster-nodes</span>=<span class="hljs-number">192.168</span>.<span class="hljs-number">1.202</span>:<span class="hljs-number">9300</span>
</code></pre>
<p>这里需要注意，在高版本的SpringBoot配置中已经不支持这样的配置操作，需要注意的实，在这个配置中如果是通过ELK调用则添加的端口是9200，如果是通过Java程序调用则配置的连接端口是9300。</p>
<h2 data-id="heading-1">具体实现</h2>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Document</span>(indexName = <span class="hljs-string">"my_index"</span>, <span class="hljs-keyword">type</span> = <span class="hljs-string">"my_type"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyDocument</span> {

    <span class="hljs-meta">@Id</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> id;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> name;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> description;

    <span class="hljs-comment">// 省略构造函数、getter和setter</span>
}
</code></pre>
<p>继承ElasticsearchRepository接口实现数据访问层代码</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">MyDocumentRepository</span> 
<span class="hljs-keyword">extends</span> <span class="hljs-title class_">ElasticsearchRepository</span>&lt;<span class="hljs-title class_">MyDocument</span>, <span class="hljs-title class_">String</span>&gt; {
}
</code></pre>
<p>编写服务层代码</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyDocumentService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">MyDocumentRepository</span> repository;

    <span class="hljs-keyword">public</span> <span class="hljs-title class_">MyDocument</span> <span class="hljs-title function_">save</span>(<span class="hljs-params">MyDocument <span class="hljs-variable language_">document</span></span>) {
        <span class="hljs-keyword">return</span> repository.<span class="hljs-title function_">save</span>(<span class="hljs-variable language_">document</span>);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Iterable</span>&lt;<span class="hljs-title class_">MyDocument</span>&gt; <span class="hljs-title function_">findAll</span>(<span class="hljs-params"/>) {
        <span class="hljs-title class_">Iterable</span>&lt;<span class="hljs-title class_">MyDocument</span>&gt; all = repository.<span class="hljs-title function_">findAll</span>();
        <span class="hljs-keyword">return</span> all;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title class_">MyDocument</span> <span class="hljs-title function_">findById</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> id</span>) {
        <span class="hljs-keyword">return</span> repository.<span class="hljs-title function_">findById</span>(id).<span class="hljs-title function_">orElse</span>(<span class="hljs-literal">null</span>);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">deleteById</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> id</span>) {
        repository.<span class="hljs-title function_">deleteById</span>(id);
    }
}
</code></pre>
<h2 data-id="heading-2">编写Controller类进行测试</h2>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@RestController</span>
<span class="hljs-variable">@RequestMapping</span>(<span class="hljs-string">"/documents"</span>)
public class MyDocumentController {

    <span class="hljs-variable">@Autowired</span>
    private MyDocumentService service;

    <span class="hljs-variable">@PostMapping</span>
    public MyDocument <span class="hljs-built_in">create</span>(<span class="hljs-variable">@RequestBody</span> MyDocument document) {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">service</span><span class="hljs-selector-class">.save</span>(document);
    }

    @<span class="hljs-selector-tag">GetMapping</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">Iterable</span>&lt;<span class="hljs-selector-tag">MyDocument</span>&gt; <span class="hljs-selector-tag">getAll</span>() {
        <span class="hljs-selector-tag">Iterable</span>&lt;<span class="hljs-selector-tag">MyDocument</span>&gt; <span class="hljs-selector-tag">iterable</span> = <span class="hljs-selector-tag">service</span><span class="hljs-selector-class">.findAll</span>();
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">iterable</span>;
    }

    @<span class="hljs-selector-tag">GetMapping</span>(<span class="hljs-string">"/{id}"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">MyDocument</span> <span class="hljs-selector-tag">getById</span>(<span class="hljs-variable">@PathVariable</span> String id) {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">service</span><span class="hljs-selector-class">.findById</span>(id);
    }

    @<span class="hljs-selector-tag">DeleteMapping</span>(<span class="hljs-string">"/{id}"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">deleteById</span>(<span class="hljs-variable">@PathVariable</span> String id) {
        <span class="hljs-selector-tag">service</span><span class="hljs-selector-class">.deleteById</span>(id);
    }
}
</code></pre>
<p>以上代码示例演示了如何使用Spring Boot整合Elasticsearch实现数据存储。</p>
<p>调用接口进行测试</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e23f5d0920a4cc893100549b9b845f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6KW_6KW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764579359&amp;x-signature=6o2l%2F6sR0LmgmZRoY5lkS5ZWEKk%3D" alt="" loading="lazy"/></p>
<p>获取列表</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/925f9548d9c64d4dad62601c0873b1d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6KW_6KW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764579359&amp;x-signature=E2p9Ghjx8cvDyU03NHl6aqC41Vs%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">总结</h2>
<p>在上面的例子中，通过SpringBoot 2.1.4与ElasticSearch6.8.0完成了整合，如果想要适配更高版本的ElasticSearch或者是Spring Boot ，在过程中一定注意对于版本兼容性的选择。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[NSSM服务]]></title>    <link>https://juejin.cn/post/7576090441432776714</link>    <guid>https://juejin.cn/post/7576090441432776714</guid>    <pubDate>2025-11-24T08:58:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576090441432776714" data-draft-id="7576090441432416266" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="NSSM服务"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-24T08:58:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="辜月十"/> <meta itemprop="url" content="https://juejin.cn/user/2872336891512350"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            NSSM服务
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2872336891512350/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    辜月十
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T08:58:48.000Z" title="Mon Nov 24 2025 08:58:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    14
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto;border:3px solid rgba(62,175,124,.2)}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-weight:700;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:6px;border:2px solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c}.markdown-body a:active,.markdown-body a:hover{border-bottom:1.5px solid #3eaf7c}.markdown-body a:before{content:"⇲"}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(62,175,124,.2)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:.5rem solid;border-color:#42b983;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none}.markdown-body ul li:before{content:"•";margin-right:4px;color:#3eaf7c}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">一、介绍</h2>
<blockquote>
<ul>
<li>全称：<code>Non-Sucking Service Manager</code></li>
<li>核心功能：将一个普通的 <code>Windows</code> 可执行文件（如 <code>.exe</code>, <code>.bat</code>, <code>.py</code>, <code>.jar</code> 等）封装成一个 <code>Windows</code> 服务。</li>
<li>解决的问题：许多应用程序本身并不具备作为 <code>Windows</code> 服务运行的能力。<code>NSSM</code> 充当一个包装器或守护进程，使这些程序能够以服务的身份在后台运行，并享受服务带来的所有好处。</li>
</ul>
</blockquote>
<h2 data-id="heading-1">二、NSSM优点</h2>
<ol>
<li>自动启动：配置为<code>自动</code>启动后，服务会在系统启动时自动运行，无需用户登录。</li>
<li>后台运行：程序在后台静默运行，没有用户界面，不占用任务栏位置。</li>
<li>生命周期管理：可以通过标准的 <code>Windows</code> 服务管理界面（<code>services.msc</code>）或命令行（<code>sc</code>, <code>net</code>）方便地<strong>启动、停止、重启、暂停</strong>服务。</li>
<li>崩溃恢复：可以配置服务在意外退出时<strong>自动重启</strong>，增强程序的健壮性。</li>
<li>统一管理：将所有需要长期运行的程序统一到“服务”中进行管理，规范且高效。</li>
<li>权限控制：可以指定服务以特定的用户身份（如 <code>SYSTEM</code> 或自定义管理员账户）运行。</li>
</ol>
<h2 data-id="heading-2">三、下载与安装</h2>
<ol>
<li>访问官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fnssm.cc%2Fdownload" target="_blank" title="https://nssm.cc/download" ref="nofollow noopener noreferrer">nssm.cc/download</a></li>
<li>选择版本：下载最新稳定版（如 <code>nssm 2.24</code>）。根据你的系统架构（32位或64位）选择对应的 ZIP 包。</li>
<li>安装：<code>NSSM</code> 是绿色软件，无需安装。只需将 <code>ZIP</code> 包解压到一个你喜欢的目录，例如 <code>D:\nssm</code>。</li>
<li>添加到 <code>PATH</code>（可选）：为了在任何命令行窗口中使用 <code>nssm</code> 命令，可以将 <code>nssm.exe</code> 所在的路径添加到系统的 <code>PATH</code> 环境变量中。</li>
</ol>
<h2 data-id="heading-3">四、常用命令</h2>
<h3 data-id="heading-4">4.1、核心服务生命周期管理命令</h3>
<p>这些是最常用的一组命令。</p>








































<table><thead><tr><th>命令</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><code>nssm install &lt;servicename&gt; [&lt;application&gt; [&lt;arguments&gt;]]</code></td><td><strong>安装服务</strong>。如果不指定应用路径，则会打开 GUI 进行配置。</td><td><code>nssm install MyService</code> <code>nssm install MyService "C:\MyApp\app.exe" "-p 8080"</code></td></tr><tr><td><code>nssm start &lt;servicename&gt;</code></td><td>启动服务。</td><td><code>nssm start MyService</code></td></tr><tr><td><code>nssm stop &lt;servicename&gt;</code></td><td>停止服务。</td><td><code>nssm stop MyService</code></td></tr><tr><td><code>nssm restart &lt;servicename&gt;</code></td><td>重启服务（先停止，再启动）。</td><td><code>nssm restart MyService</code></td></tr><tr><td><code>nssm pause &lt;servicename&gt;</code></td><td>暂停服务（如果服务支持）。</td><td><code>nssm pause MyService</code></td></tr><tr><td><code>nssm continue &lt;servicename&gt;</code></td><td>恢复被暂停的服务（如果服务支持）。</td><td><code>nssm continue MyService</code></td></tr></tbody></table>
<h3 data-id="heading-5">4.2、服务配置管理命令</h3>
<p>这些命令用于查看和修改服务的参数。</p>






























<table><thead><tr><th>命令</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><code>nssm edit &lt;servicename&gt;</code></td><td>打开服务的 GUI 配置界面进行修改。</td><td><code>nssm edit MyService</code></td></tr><tr><td><code>nssm get &lt;servicename&gt; &lt;parameter&gt;</code></td><td><strong>获取</strong>服务某个配置参数的值。</td><td><code>nssm get MyService AppParameters</code></td></tr><tr><td><code>nssm set &lt;servicename&gt; &lt;parameter&gt; &lt;value&gt;</code></td><td><strong>设置</strong>服务某个配置参数的值。</td><td><code>nssm set MyService AppDirectory "C:\MyApp"</code></td></tr><tr><td><code>nssm reset &lt;servicename&gt; &lt;parameter&gt;</code></td><td>将某个配置参数<strong>重置</strong>为默认值。</td><td><code>nssm reset MyService ObjectName</code></td></tr></tbody></table>
<h3 data-id="heading-6">4.3、服务安装与移除命令</h3>




















<table><thead><tr><th>命令</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><code>nssm remove &lt;servicename&gt;</code></td><td>交互式地<strong>移除/卸载</strong>服务。会要求你确认。</td><td><code>nssm remove MyService</code></td></tr><tr><td><code>nssm remove &lt;servicename&gt; confirm</code></td><td><strong>无条件直接移除/卸载</strong>服务，无需确认。</td><td><code>nssm remove MyService confirm</code></td></tr></tbody></table>
<h3 data-id="heading-7">4.4、服务状态与信息查询命令</h3>

























<table><thead><tr><th>命令</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><code>nssm status &lt;servicename&gt;</code></td><td>检查服务的状态。返回如 <code>SERVICE_RUNNING</code>, <code>SERVICE_STOPPED</code> 等。</td><td><code>nssm status MyService</code></td></tr><tr><td><code>nssm statuscode &lt;servicename&gt;</code></td><td>以数字代码的形式返回服务的状态。</td><td><code>nssm statuscode MyService</code></td></tr><tr><td><code>nssm list</code></td><td>列出所有由 NSSM 管理的服务。</td><td><code>nssm list</code></td></tr></tbody></table>
<h3 data-id="heading-8">4.5、高级与不常用命令</h3>






























<table><thead><tr><th>命令</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><code>nssm dump &lt;servicename&gt;</code></td><td>生成一个包含服务所有当前配置的可重命名脚本。用于备份或复制配置。</td><td><code>nssm dump MyService &gt; config.txt</code></td></tr><tr><td><code>nssm rotatelogs &lt;servicename&gt;</code></td><td>手动轮转（归档）该服务的输出日志文件。</td><td><code>nssm rotatelogs MyService</code></td></tr><tr><td><code>nssm process &lt;servicename&gt;</code></td><td>显示托管该服务的 NSSM 进程的 PID。</td><td><code>nssm process MyService</code></td></tr><tr><td><code>nssm processes</code></td><td>显示所有 NSSM 服务进程的 PID。</td><td><code>nssm processes</code></td></tr></tbody></table>
<h3 data-id="heading-9">4.6、常用配置参数（用于 <code>get</code>/<code>set</code> 命令）</h3>
<p>当使用 <code>nssm set &lt;servicename&gt; &lt;parameter&gt; &lt;value&gt;</code> 时，以下是一些最常用的 <code>&lt;parameter&gt;</code>：</p>

































































<table><thead><tr><th>参数</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><code>Application</code></td><td>要运行的可执行文件的完整路径。</td><td><code>nssm set MyService Application "C:\Program Files\nodejs\node.exe"</code></td></tr><tr><td><code>AppParameters</code></td><td>传递给可执行文件的命令行参数。</td><td><code>nssm set MyService AppParameters "app.js"</code></td></tr><tr><td><code>AppDirectory</code></td><td>应用程序的启动工作目录。</td><td><code>nssm set MyService AppDirectory "C:\MyApp"</code></td></tr><tr><td><code>AppStdout</code></td><td>重定向标准输出（stdout）的日志文件路径。</td><td><code>nssm set MyService AppStdout "C:\logs\service.log"</code></td></tr><tr><td><code>AppStderr</code></td><td>重定向标准错误（stderr）的日志文件路径。</td><td><code>nssm set MyService AppStderr "C:\logs\error.log"</code></td></tr><tr><td><code>AppExit</code></td><td>服务退出行为。默认为 <code>Restart</code>，配合 <code>AppThrottle</code> 使用。</td><td><code>nssm set MyService AppExit Default</code></td></tr><tr><td><code>AppThrottle</code></td><td>服务重启前的延迟时间（秒）。</td><td><code>nssm set MyService AppThrottle 5</code></td></tr><tr><td><code>DisplayName</code></td><td>在服务管理器中显示的友好名称。</td><td><code>nssm set MyService DisplayName "我的重要服务"</code></td></tr><tr><td><code>Start</code></td><td>启动类型。<code>SERVICE_AUTO_START</code>(自动), <code>SERVICE_DEMAND_START</code>(手动), <code>SERVICE_DISABLED</code>(禁用)。</td><td><code>nssm set MyService Start SERVICE_DEMAND_START</code></td></tr><tr><td><code>ObjectName</code></td><td>运行服务所用的账户（如 <code>.\Administrator</code> 或 <code>NT AUTHORITY\SYSTEM</code>）。</td><td><code>nssm set MyService ObjectName ".\MyUser"</code></td></tr><tr><td><code>Type</code></td><td>服务类型。绝大多数情况使用 <code>SERVICE_WIN32_OWN_PROCESS</code>。</td><td><code>nssm set MyService Type SERVICE_WIN32_OWN_PROCESS</code></td></tr></tbody></table>
<h2 data-id="heading-10">五、案例:</h2>
<h3 data-id="heading-11">5.1、Nginx服务</h3>
<h4 data-id="heading-12">5.1.1、使用 GUI 界面安装</h4>
<ol>
<li>
<p>安装服务</p>
<pre><code class="hljs language-shell" lang="shell">nssm install Nginx
</code></pre>
</li>
<li>
<p>在弹出的 GUI 界面中配置：</p>
<p><strong>Application 标签页</strong>：</p>
<ul>
<li><strong>Path</strong>: <code>D:\nginx\nginx.exe</code> （你的 nginx.exe 完整路径）</li>
<li><strong>Startup directory</strong>: <code>D:\nginx</code> （Nginx 安装目录）</li>
<li><strong>Arguments</strong>: （留空）</li>
</ul>
<p><strong>Details 标签页</strong>：</p>
<ul>
<li><strong>Display name</strong>: <code>Nginx Web Server</code> （可选，更友好的显示名称）</li>
<li><strong>Startup type</strong>: <code>Automatic</code> （设置为自动启动）</li>
</ul>
<p><strong>I/O 标签页</strong>：</p>
<ul>
<li><strong>Output (stdout)</strong> : <code>D:\nginx\logs\service-stdout.log</code></li>
<li><strong>Error (stderr)</strong> : <code>D:\nginx\logs\service-stderr.log</code><br/>
<em>这会将 Nginx 的控制台输出重定向到日志文件</em></li>
</ul>
<p><strong>Exit 标签页</strong>：</p>
<ul>
<li>勾选 <code>Restart</code> 选项，设置：
<ul>
<li><strong>Restart delay (ms)</strong> : <code>5000</code> （失败后等待 5 秒重启）</li>
</ul>
</li>
</ul>
</li>
<li>
<p>点击 <code>Install service</code>完成安装。</p>
</li>
</ol>
<h4 data-id="heading-13">5.1.2、完全使用命令行安装（适合脚本化部署）</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">安装服务</span>
nssm install Nginx "D:\nginx\nginx.exe"
<span class="hljs-meta prompt_">
# </span><span class="bash">设置启动目录</span>
nssm set Nginx AppDirectory "D:\nginx"
<span class="hljs-meta prompt_">
# </span><span class="bash">设置显示名称</span>
nssm set Nginx DisplayName "Nginx Web Server"
<span class="hljs-meta prompt_">
# </span><span class="bash">设置启动类型为自动</span>
nssm set Nginx Start SERVICE_AUTO_START
<span class="hljs-meta prompt_">
# </span><span class="bash">配置日志重定向</span>
nssm set Nginx AppStdout "D:\nginx\logs\service-stdout.log"
nssm set Nginx AppStderr "D:\nginx\logs\service-stderr.log"
<span class="hljs-meta prompt_">
# </span><span class="bash">配置失败时自动重启</span>
nssm set Nginx AppExit Default Restart
nssm set Nginx AppRestartDelay 5000
<span class="hljs-meta prompt_">
# </span><span class="bash">启动服务</span>
nssm start Nginx
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vibe Coding 实战指南：从“手写代码”到“意图设计”的前端范式转移]]></title>    <link>https://juejin.cn/post/7576052677050925082</link>    <guid>https://juejin.cn/post/7576052677050925082</guid>    <pubDate>2025-11-24T08:45:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576052677050925082" data-draft-id="7575829296452829194" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vibe Coding 实战指南：从“手写代码”到“意图设计”的前端范式转移"/> <meta itemprop="keywords" content="前端,AI编程"/> <meta itemprop="datePublished" content="2025-11-24T08:45:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="想进字节冲啊冲"/> <meta itemprop="url" content="https://juejin.cn/user/2947168673222887"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vibe Coding 实战指南：从“手写代码”到“意图设计”的前端范式转移
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2947168673222887/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    想进字节冲啊冲
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T08:45:17.000Z" title="Mon Nov 24 2025 08:45:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    19
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 引言：零编码实现的初体验</h2>
<p>最近在开发需求时，频繁听到关于 AI 编程能力的讨论。借着 Qoder 测试版发布的契机，我决定在实际业务中体验一把“零编码”开发。</p>
<p>这次实验不仅是一次工具的试用，更是一次开发模式的<strong>范式转移</strong>。我发现，在 AI 辅助下，前端工程师的角色正在发生本质变化：我们不再仅仅是代码的编写者（Coder），而是转变为**架构师 + 产品经理 + 质量保障（QA）**的复合体。这正是 Andrej Karpathy 所提出的 <strong>"Vibe Coding"（氛围编码/直觉编码）</strong> ——你负责把握逻辑与效果（The Vibe），AI 负责具体的语法实现（The Code）。</p>
<h2 data-id="heading-1">2. 实战复盘：级联多选组件的“无中生有”</h2>
<h3 data-id="heading-2">2.1 需求背景与挑战</h3>
<p>业务场景需要一个支持<strong>多选</strong>的级联选择器（省-市-区-社区），且交互逻辑复杂：</p>
<ul>
<li>省市层级单选，区与社区层级多选。</li>
<li>单选与多选逻辑混合。</li>
<li><strong>技术难点</strong>：项目使用的 Vant UI 组件库中的 <code>Cascader</code> 组件原生仅支持单选。</li>
</ul>
<h3 data-id="heading-3">2.2 初始沟通：粗糙但有效的意图传达</h3>
<p>这是我第一次完全依赖 AI 编程。我的第一版 Prompt 非常直白，甚至有些粗糙，直接把需求和设计稿丢给了 AI：</p>
<p><strong>User Prompt:</strong><br/>
你知道 vant 中的 Cascader 吗？组件只能支持单选，我希望它支持多选。<br/>
请把这里的 Cascader 替换为多选组件。<br/>
我可以给你提供可供参考的 UI 设计稿，你有不懂的可以随时问我。<br/>
附件：ui稿位置@index.md</p>
<h3 data-id="heading-4">2.3 AI 的惊人反馈：不仅仅是代码</h3>
<p>让我惊讶的是，Claude 并没有直接扔给我一堆代码，而是先生成了一份**《级联多选组件设计文档》**。</p>
<p>这份文档包含了：</p>
<ol>
<li><strong>技术架构</strong>：使用 Mermaid 绘制的组件层次结构图。</li>
<li><strong>数据流向</strong>：清晰的 <code>Props</code> 和 <code>Emit</code> 接口定义。</li>
<li><strong>逻辑边界</strong>：详细描述了“向下级联全选”和“向上级联反选”的逻辑。</li>
</ol>
<p><strong>💡</strong> <strong>洞察</strong>：AI 生成的设计文档虽然完美，但实际生成的代码（MVP版本）却存在数据加载失败、Tab 无法切换等 Bug。这揭示了 Vibe Coding 的核心痛点：<strong>宏观设计完美，微观实现易错。</strong></p>
<h2 data-id="heading-5">3. 核心方法论：如何让 AI 读懂你的“意图”</h2>
<p>在经历了十几轮的修复和迭代后，我总结出了驾驭 AI 的三板斧。</p>
<h3 data-id="heading-6">3.1 意图定义（Define the Vibe）</h3>
<p>放弃思考 DOM 结构，跳出传统的“实现细节”，转而描述“功能与交互”。</p>
<ul>
<li>❌ <strong>Bad Vibe</strong>: "写一个红色的按钮。"</li>
<li>✅ <strong>Good Vibe</strong>: "创建一个主操作按钮，当鼠标 Hover 时有微小的缩放动画，点击时显示 Loading 状态，并且要符合我们现有的紫色品牌色调。"</li>
</ul>
<h3 data-id="heading-7">3.2 规则约束（Context &amp; Rules）</h3>
<p>AI 就像一个才华横溢但不受约束的实习生。如果不立规矩，它会写出风格迥异的代码。我们需要通过 <code>.cursorrules</code> 或系统提示词来约束它。</p>
<p><strong>实战经验：</strong> 我将团队的 ESLint 规则、TypeScript 规范以及 React/Vue 的最佳实践整理给 AI。例如：</p>
<ul>
<li><strong>变量命名</strong>：必须使用 <code>const</code>，变量名要语义化。</li>
<li><strong>类型安全</strong>：禁止使用 <code>any</code>，优先使用 <code>interface</code> 而非 <code>type</code>。</li>
<li><strong>样式管理</strong>：明确指定使用 Tailwind CSS 还是 styled-components，防止 AI 混用。</li>
</ul>
<p><em>(注：在实际操作中，建议建立项目级的</em> <code>.cursorrules</code> <em>文件，将编码规范固化下来，AI 会自动读取。)</em></p>
<h3 data-id="heading-8">3.3 微调与迭代（Review &amp; Refine）</h3>
<p>AI 生成的代码往往不能直接上线，这时需要进行<strong>微调</strong>。</p>
<ul>
<li><strong>精确上下文</strong>：不要让 AI 盲目重写。选中具体的代码行，告诉它：“只修改这个函数的错误处理逻辑”。</li>
<li><strong>测试驱动</strong>：让 AI 自己生成测试用例和测试页面。我去测试页面操作，发现 Bug 后，将现象描述给 AI，让它自我修复。</li>
</ul>
<h2 data-id="heading-9">4. 避坑指南与最佳实践</h2>
<h3 data-id="heading-10">4.1 警惕“幻觉”与样式崩坏</h3>
<ul>
<li><strong>现象</strong>：AI 可能会编造不存在的 Tailwind 类名，或者使用了项目未安装的图标库。</li>
<li><strong>对策</strong>：在 Rules 中明确白名单。例如：“图标库请仅使用 <code>Lucide-React</code>，不要引入其他库。”</li>
</ul>
<h3 data-id="heading-11">4.2 保持代码一致性</h3>
<ul>
<li><strong>现象</strong>：同一个组件，AI 一会儿用 <code>function</code> 定义，一会儿用箭头函数。</li>
<li><strong>对策</strong>：<strong>One-Shot Learning（单样本学习）</strong> 。在 Prompt 中贴一段你认为完美的现有代码作为“范本”，告诉 AI：“请严格模仿这段代码的风格和结构来生成新组件。”</li>
</ul>
<h3 data-id="heading-12">4.3 复杂状态管理的边界</h3>
<ul>
<li><strong>现象</strong>：当涉及复杂的全局状态（如 Redux/Zustand）或核心业务流时，AI 容易逻辑混乱。</li>
<li><strong>对策</strong>：<strong>分层开发</strong>。核心的业务逻辑（Store 设计、API 层）建议由资深工程师把控架构，UI 层和简单的逻辑处理交给 AI。</li>
</ul>
<h2 data-id="heading-13">5. 总结：前端工程师的进化</h2>
<p>Vibe Coding 模式下，我们还需要写代码吗？答案是需要的，但<strong>写的“代码”变了</strong>。</p>
<p>我们需要编写的不再是具体的 <code>if-else</code>，而是：</p>
<ol>
<li><strong>Prompt</strong>：精准描述需求的自然语言。</li>
<li><strong>Rules</strong>：约束 AI 行为的规范文档。</li>
<li><strong>Tests</strong>：验证 AI 产出的验收标准。</li>
</ol>
<p>在这个新时代，评估优秀前端的标准也随之改变：</p>
<ul>
<li><strong>Prompt Engineering 能力</strong>：能否用最短的语言描述最复杂的交互？</li>
<li><strong>Code Review 能力</strong>：能否在 AI 生成的千行代码中，一眼洞察性能隐患？</li>
<li><strong>架构设计能力</strong>：能否搭建让 AI 发挥得更好的基础设施？</li>
</ul>
<p><strong>"Coding is not about typing; it's about thinking."</strong></p>
<p>Vibe Coding 并没有消灭编程，它只是帮我们省去了“打字”的过程，让我们终于可以回归编程的本质：<strong>思考解决问题的方法</strong>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>