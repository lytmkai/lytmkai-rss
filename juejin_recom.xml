<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[3分钟Solidity: 10.6 时间锁定]]></title>    <link>https://juejin.cn/post/7592833068223119406</link>    <guid>https://juejin.cn/post/7592833068223119406</guid>    <pubDate>2026-01-08T13:25:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592833068223119406" data-draft-id="7592833068223103022" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="3分钟Solidity: 10.6 时间锁定"/> <meta itemprop="keywords" content="Solidity,web3,智能合约"/> <meta itemprop="datePublished" content="2026-01-08T13:25:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Rockbean"/> <meta itemprop="url" content="https://juejin.cn/user/4054654615823560"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            3分钟Solidity: 10.6 时间锁定
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4054654615823560/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Rockbean
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T13:25:52.000Z" title="Thu Jan 08 2026 13:25:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>欢迎订阅专栏</strong>：<a href="https://juejin.cn/column/7578762210285977663" title="https://juejin.cn/column/7578762210285977663" target="_blank">3分钟Solidity--智能合约--Web3区块链技术必学</a></p>
<p>如需获取本内容的最新版本，请参见 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cyfrin.io%2Fglossary%2Ftime-lock-solidity-code-example" target="_blank" title="https://www.cyfrin.io/glossary/time-lock-solidity-code-example" ref="nofollow noopener noreferrer">Cyfrin.io 的Time Lock（代码示例）</a></p>
<p><code>TimeLock</code>是一种合约，用于发布将在未来执行的交易。</p>
<p>经过最短等待期后，该交易即可执行。</p>
<p><code>TimeLock</code>在DAO中经常被使用。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// SPDX-License-Identifier: MIT</span>
pragma solidity ^<span class="hljs-number">0.8</span><span class="hljs-selector-class">.26</span>;

contract TimeLock {
    error <span class="hljs-built_in">NotOwnerError</span>();
    error <span class="hljs-built_in">AlreadyQueuedError</span>(bytes32 txId);
    error <span class="hljs-built_in">TimestampNotInRangeError</span>(uint256 blockTimestamp, uint256 timestamp);
    error <span class="hljs-built_in">NotQueuedError</span>(bytes32 txId);
    error <span class="hljs-built_in">TimestampNotPassedError</span>(uint256 blockTimestamp, uint256 timestamp);
    error <span class="hljs-built_in">TimestampExpiredError</span>(uint256 blockTimestamp, uint256 expiresAt);
    error <span class="hljs-built_in">TxFailedError</span>();

    event <span class="hljs-built_in">Queue</span>(
        bytes32 indexed txId,
        address indexed target,
        uint256 value,
        string func,
        bytes data,
        uint256 timestamp
    );
    event <span class="hljs-built_in">Execute</span>(
        bytes32 indexed txId,
        address indexed target,
        uint256 value,
        string func,
        bytes data,
        uint256 timestamp
    );
    event <span class="hljs-built_in">Cancel</span>(bytes32 indexed txId);

    uint256 public constant MIN_DELAY = <span class="hljs-number">10</span>; <span class="hljs-comment">// seconds</span>
    uint256 public constant MAX_DELAY = <span class="hljs-number">1000</span>; <span class="hljs-comment">// seconds</span>
    uint256 public constant GRACE_PERIOD = <span class="hljs-number">1000</span>; <span class="hljs-comment">// seconds</span>

    <span class="hljs-selector-tag">address</span> public owner;
    <span class="hljs-comment">// tx id =&gt; queued</span>
    <span class="hljs-built_in">mapping</span>(bytes32 =&gt; bool) public queued;

    <span class="hljs-built_in">constructor</span>() {
        owner = msg<span class="hljs-selector-class">.sender</span>;
    }

    modifier <span class="hljs-built_in">onlyOwner</span>() {
        if (msg.sender != owner) {
            revert <span class="hljs-built_in">NotOwnerError</span>();
        }
        _;
    }

    <span class="hljs-built_in">receive</span>() external payable {}

    function <span class="hljs-built_in">getTxId</span>(
        address _target,
        uint256 _value,
        string calldata _func,
        bytes calldata _data,
        uint256 _timestamp
    ) public pure returns (bytes32) {
        return <span class="hljs-built_in">keccak256</span>(abi.encode(_target, _value, _func, _data, _timestamp));
    }

    <span class="hljs-comment">/**
     * @param _target Address of contract or account to call
     * @param _value Amount of ETH to send
     * @param _func Function signature, for example "foo(address,uint256)"
     * @param _data ABI encoded data send.
     * @param _timestamp Timestamp after which the transaction can be executed.
     */</span>
    function <span class="hljs-built_in">queue</span>(
        address _target,
        uint256 _value,
        string calldata _func,
        bytes calldata _data,
        uint256 _timestamp
    ) external onlyOwner returns (bytes32 txId) {
        txId = <span class="hljs-built_in">getTxId</span>(_target, _value, _func, _data, _timestamp);
        if (queued[txId]) {
            revert <span class="hljs-built_in">AlreadyQueuedError</span>(txId);
        }
        <span class="hljs-comment">// ---|------------|---------------|-------</span>
        <span class="hljs-comment">//  block    block + min     block + max</span>
        if (
            _timestamp &lt; block.timestamp + MIN_DELAY
                || _timestamp &gt; block.timestamp + MAX_DELAY
        ) {
            revert <span class="hljs-built_in">TimestampNotInRangeError</span>(block.timestamp, _timestamp);
        }

        queued<span class="hljs-selector-attr">[txId]</span> = true;

        emit <span class="hljs-built_in">Queue</span>(txId, _target, _value, _func, _data, _timestamp);
    }

    function <span class="hljs-built_in">execute</span>(
        address _target,
        uint256 _value,
        string calldata _func,
        bytes calldata _data,
        uint256 _timestamp
    ) external payable onlyOwner returns (bytes memory) {
        bytes32 txId = <span class="hljs-built_in">getTxId</span>(_target, _value, _func, _data, _timestamp);
        if (!queued[txId]) {
            revert <span class="hljs-built_in">NotQueuedError</span>(txId);
        }
        <span class="hljs-comment">// ----|-------------------|-------</span>
        <span class="hljs-comment">//  timestamp    timestamp + grace period</span>
        if (block.timestamp &lt; _timestamp) {
            revert <span class="hljs-built_in">TimestampNotPassedError</span>(block.timestamp, _timestamp);
        }
        if (block.timestamp &gt; _timestamp + GRACE_PERIOD) {
            revert <span class="hljs-built_in">TimestampExpiredError</span>(
                block.timestamp, _timestamp + GRACE_PERIOD
            );
        }

        queued<span class="hljs-selector-attr">[txId]</span> = false;

        <span class="hljs-comment">// prepare data</span>
        bytes memory data;
        if (bytes(_func)<span class="hljs-selector-class">.length</span> &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-comment">// data = func selector + _data</span>
            data = abi<span class="hljs-selector-class">.encodePacked</span>(bytes4(keccak256(bytes(_func))), _data);
        } else {
            <span class="hljs-comment">// call fallback with data</span>
            data = _data;
        }

        <span class="hljs-comment">// call target</span>
        (bool ok, bytes memory res) = _target<span class="hljs-selector-class">.call</span>{value: _value}(data);
        if (!ok) {
            revert <span class="hljs-built_in">TxFailedError</span>();
        }

        emit <span class="hljs-built_in">Execute</span>(txId, _target, _value, _func, _data, _timestamp);

        return res;
    }

    function <span class="hljs-built_in">cancel</span>(bytes32 _txId) external onlyOwner {
        if (!queued[_txId]) {
            revert <span class="hljs-built_in">NotQueuedError</span>(_txId);
        }

        queued<span class="hljs-selector-attr">[_txId]</span> = false;

        emit <span class="hljs-built_in">Cancel</span>(_txId);
    }
}
</code></pre>
<p>Remix Lite 尝试一下</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fremix.byteatatime.dev%2F%3F%23code%3DLy8gU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IE1JVApwcmFnbWEgc29saWRpdHkgXjAuOC4yNjsKCmNvbnRyYWN0IFRpbWVMb2NrIHsKICAgIGVycm9yIE5vdE93bmVyRXJyb3IoKTsKICAgIGVycm9yIEFscmVhZHlRdWV1ZWRFcnJvcihieXRlczMyIHR4SWQpOwogICAgZXJyb3IgVGltZXN0YW1wTm90SW5SYW5nZUVycm9yKHVpbnQyNTYgYmxvY2tUaW1lc3RhbXAsIHVpbnQyNTYgdGltZXN0YW1wKTsKICAgIGVycm9yIE5vdFF1ZXVlZEVycm9yKGJ5dGVzMzIgdHhJZCk7CiAgICBlcnJvciBUaW1lc3RhbXBOb3RQYXNzZWRFcnJvcih1aW50MjU2IGJsb2NrVGltZXN0YW1wLCB1aW50MjU2IHRpbWVzdGFtcCk7CiAgICBlcnJvciBUaW1lc3RhbXBFeHBpcmVkRXJyb3IodWludDI1NiBibG9ja1RpbWVzdGFtcCwgdWludDI1NiBleHBpcmVzQXQpOwogICAgZXJyb3IgVHhGYWlsZWRFcnJvcigpOwoKICAgIGV2ZW50IFF1ZXVlKAogICAgICAgIGJ5dGVzMzIgaW5kZXhlZCB0eElkLAogICAgICAgIGFkZHJlc3MgaW5kZXhlZCB0YXJnZXQsCiAgICAgICAgdWludDI1NiB2YWx1ZSwKICAgICAgICBzdHJpbmcgZnVuYywKICAgICAgICBieXRlcyBkYXRhLAogICAgICAgIHVpbnQyNTYgdGltZXN0YW1wCiAgICApOwogICAgZXZlbnQgRXhlY3V0ZSgKICAgICAgICBieXRlczMyIGluZGV4ZWQgdHhJZCwKICAgICAgICBhZGRyZXNzIGluZGV4ZWQgdGFyZ2V0LAogICAgICAgIHVpbnQyNTYgdmFsdWUsCiAgICAgICAgc3RyaW5nIGZ1bmMsCiAgICAgICAgYnl0ZXMgZGF0YSwKICAgICAgICB1aW50MjU2IHRpbWVzdGFtcAogICAgKTsKICAgIGV2ZW50IENhbmNlbChieXRlczMyIGluZGV4ZWQgdHhJZCk7CgogICAgdWludDI1NiBwdWJsaWMgY29uc3RhbnQgTUlOX0RFTEFZID0gMTA7IC8vIHNlY29uZHMKICAgIHVpbnQyNTYgcHVibGljIGNvbnN0YW50IE1BWF9ERUxBWSA9IDEwMDA7IC8vIHNlY29uZHMKICAgIHVpbnQyNTYgcHVibGljIGNvbnN0YW50IEdSQUNFX1BFUklPRCA9IDEwMDA7IC8vIHNlY29uZHMKCiAgICBhZGRyZXNzIHB1YmxpYyBvd25lcjsKICAgIC8vIHR4IGlkID0%2BIHF1ZXVlZAogICAgbWFwcGluZyhieXRlczMyID0%2BIGJvb2wpIHB1YmxpYyBxdWV1ZWQ7CgogICAgY29uc3RydWN0b3IoKSB7CiAgICAgICAgb3duZXIgPSBtc2cuc2VuZGVyOwogICAgfQoKICAgIG1vZGlmaWVyIG9ubHlPd25lcigpIHsKICAgICAgICBpZiAobXNnLnNlbmRlciAhPSBvd25lcikgewogICAgICAgICAgICByZXZlcnQgTm90T3duZXJFcnJvcigpOwogICAgICAgIH0KICAgICAgICBfOwogICAgfQoKICAgIHJlY2VpdmUoKSBleHRlcm5hbCBwYXlhYmxlIHt9CgogICAgZnVuY3Rpb24gZ2V0VHhJZCgKICAgICAgICBhZGRyZXNzIF90YXJnZXQsCiAgICAgICAgdWludDI1NiBfdmFsdWUsCiAgICAgICAgc3RyaW5nIGNhbGxkYXRhIF9mdW5jLAogICAgICAgIGJ5dGVzIGNhbGxkYXRhIF9kYXRhLAogICAgICAgIHVpbnQyNTYgX3RpbWVzdGFtcAogICAgKSBwdWJsaWMgcHVyZSByZXR1cm5zIChieXRlczMyKSB7CiAgICAgICAgcmV0dXJuIGtlY2NhazI1NihhYmkuZW5jb2RlKF90YXJnZXQsIF92YWx1ZSwgX2Z1bmMsIF9kYXRhLCBfdGltZXN0YW1wKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBAcGFyYW0gX3RhcmdldCBBZGRyZXNzIG9mIGNvbnRyYWN0IG9yIGFjY291bnQgdG8gY2FsbAogICAgICogQHBhcmFtIF92YWx1ZSBBbW91bnQgb2YgRVRIIHRvIHNlbmQKICAgICAqIEBwYXJhbSBfZnVuYyBGdW5jdGlvbiBzaWduYXR1cmUsIGZvciBleGFtcGxlICJmb28oYWRkcmVzcyx1aW50MjU2KSIKICAgICAqIEBwYXJhbSBfZGF0YSBBQkkgZW5jb2RlZCBkYXRhIHNlbmQuCiAgICAgKiBAcGFyYW0gX3RpbWVzdGFtcCBUaW1lc3RhbXAgYWZ0ZXIgd2hpY2ggdGhlIHRyYW5zYWN0aW9uIGNhbiBiZSBleGVjdXRlZC4KICAgICAqLwogICAgZnVuY3Rpb24gcXVldWUoCiAgICAgICAgYWRkcmVzcyBfdGFyZ2V0LAogICAgICAgIHVpbnQyNTYgX3ZhbHVlLAogICAgICAgIHN0cmluZyBjYWxsZGF0YSBfZnVuYywKICAgICAgICBieXRlcyBjYWxsZGF0YSBfZGF0YSwKICAgICAgICB1aW50MjU2IF90aW1lc3RhbXAKICAgICkgZXh0ZXJuYWwgb25seU93bmVyIHJldHVybnMgKGJ5dGVzMzIgdHhJZCkgewogICAgICAgIHR4SWQgPSBnZXRUeElkKF90YXJnZXQsIF92YWx1ZSwgX2Z1bmMsIF9kYXRhLCBfdGltZXN0YW1wKTsKICAgICAgICBpZiAocXVldWVkW3R4SWRdKSB7CiAgICAgICAgICAgIHJldmVydCBBbHJlYWR5UXVldWVkRXJyb3IodHhJZCk7CiAgICAgICAgfQogICAgICAgIC8vIC0tLXwtLS0tLS0tLS0tLS18LS0tLS0tLS0tLS0tLS0tfC0tLS0tLS0KICAgICAgICAvLyAgYmxvY2sgICAgYmxvY2sgKyBtaW4gICAgIGJsb2NrICsgbWF4CiAgICAgICAgaWYgKAogICAgICAgICAgICBfdGltZXN0YW1wIDwgYmxvY2sudGltZXN0YW1wICsgTUlOX0RFTEFZCiAgICAgICAgICAgICAgICB8fCBfdGltZXN0YW1wID4gYmxvY2sudGltZXN0YW1wICsgTUFYX0RFTEFZCiAgICAgICAgKSB7CiAgICAgICAgICAgIHJldmVydCBUaW1lc3RhbXBOb3RJblJhbmdlRXJyb3IoYmxvY2sudGltZXN0YW1wLCBfdGltZXN0YW1wKTsKICAgICAgICB9CgogICAgICAgIHF1ZXVlZFt0eElkXSA9IHRydWU7CgogICAgICAgIGVtaXQgUXVldWUodHhJZCwgX3RhcmdldCwgX3ZhbHVlLCBfZnVuYywgX2RhdGEsIF90aW1lc3RhbXApOwogICAgfQoKICAgIGZ1bmN0aW9uIGV4ZWN1dGUoCiAgICAgICAgYWRkcmVzcyBfdGFyZ2V0LAogICAgICAgIHVpbnQyNTYgX3ZhbHVlLAogICAgICAgIHN0cmluZyBjYWxsZGF0YSBfZnVuYywKICAgICAgICBieXRlcyBjYWxsZGF0YSBfZGF0YSwKICAgICAgICB1aW50MjU2IF90aW1lc3RhbXAKICAgICkgZXh0ZXJuYWwgcGF5YWJsZSBvbmx5T3duZXIgcmV0dXJucyAoYnl0ZXMgbWVtb3J5KSB7CiAgICAgICAgYnl0ZXMzMiB0eElkID0gZ2V0VHhJZChfdGFyZ2V0LCBfdmFsdWUsIF9mdW5jLCBfZGF0YSwgX3RpbWVzdGFtcCk7CiAgICAgICAgaWYgKCFxdWV1ZWRbdHhJZF0pIHsKICAgICAgICAgICAgcmV2ZXJ0IE5vdFF1ZXVlZEVycm9yKHR4SWQpOwogICAgICAgIH0KICAgICAgICAvLyAtLS0tfC0tLS0tLS0tLS0tLS0tLS0tLS18LS0tLS0tLQogICAgICAgIC8vICB0aW1lc3RhbXAgICAgdGltZXN0YW1wICsgZ3JhY2UgcGVyaW9kCiAgICAgICAgaWYgKGJsb2NrLnRpbWVzdGFtcCA8IF90aW1lc3RhbXApIHsKICAgICAgICAgICAgcmV2ZXJ0IFRpbWVzdGFtcE5vdFBhc3NlZEVycm9yKGJsb2NrLnRpbWVzdGFtcCwgX3RpbWVzdGFtcCk7CiAgICAgICAgfQogICAgICAgIGlmIChibG9jay50aW1lc3RhbXAgPiBfdGltZXN0YW1wICsgR1JBQ0VfUEVSSU9EKSB7CiAgICAgICAgICAgIHJldmVydCBUaW1lc3RhbXBFeHBpcmVkRXJyb3IoCiAgICAgICAgICAgICAgICBibG9jay50aW1lc3RhbXAsIF90aW1lc3RhbXAgKyBHUkFDRV9QRVJJT0QKICAgICAgICAgICAgKTsKICAgICAgICB9CgogICAgICAgIHF1ZXVlZFt0eElkXSA9IGZhbHNlOwoKICAgICAgICAvLyBwcmVwYXJlIGRhdGEKICAgICAgICBieXRlcyBtZW1vcnkgZGF0YTsKICAgICAgICBpZiAoYnl0ZXMoX2Z1bmMpLmxlbmd0aCA%2BIDApIHsKICAgICAgICAgICAgLy8gZGF0YSA9IGZ1bmMgc2VsZWN0b3IgKyBfZGF0YQogICAgICAgICAgICBkYXRhID0gYWJpLmVuY29kZVBhY2tlZChieXRlczQoa2VjY2FrMjU2KGJ5dGVzKF9mdW5jKSkpLCBfZGF0YSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gY2FsbCBmYWxsYmFjayB3aXRoIGRhdGEKICAgICAgICAgICAgZGF0YSA9IF9kYXRhOwogICAgICAgIH0KCiAgICAgICAgLy8gY2FsbCB0YXJnZXQKICAgICAgICAoYm9vbCBvaywgYnl0ZXMgbWVtb3J5IHJlcykgPSBfdGFyZ2V0LmNhbGx7dmFsdWU6IF92YWx1ZX0oZGF0YSk7CiAgICAgICAgaWYgKCFvaykgewogICAgICAgICAgICByZXZlcnQgVHhGYWlsZWRFcnJvcigpOwogICAgICAgIH0KCiAgICAgICAgZW1pdCBFeGVjdXRlKHR4SWQsIF90YXJnZXQsIF92YWx1ZSwgX2Z1bmMsIF9kYXRhLCBfdGltZXN0YW1wKTsKCiAgICAgICAgcmV0dXJuIHJlczsKICAgIH0KCiAgICBmdW5jdGlvbiBjYW5jZWwoYnl0ZXMzMiBfdHhJZCkgZXh0ZXJuYWwgb25seU93bmVyIHsKICAgICAgICBpZiAoIXF1ZXVlZFtfdHhJZF0pIHsKICAgICAgICAgICAgcmV2ZXJ0IE5vdFF1ZXVlZEVycm9yKF90eElkKTsKICAgICAgICB9CgogICAgICAgIHF1ZXVlZFtfdHhJZF0gPSBmYWxzZTsKCiAgICAgICAgZW1pdCBDYW5jZWwoX3R4SWQpOwogICAgfQp9Cg%3D%3D" target="_blank" title="https://remix.byteatatime.dev/?#code=Ly8gU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IE1JVApwcmFnbWEgc29saWRpdHkgXjAuOC4yNjsKCmNvbnRyYWN0IFRpbWVMb2NrIHsKICAgIGVycm9yIE5vdE93bmVyRXJyb3IoKTsKICAgIGVycm9yIEFscmVhZHlRdWV1ZWRFcnJvcihieXRlczMyIHR4SWQpOwogICAgZXJyb3IgVGltZXN0YW1wTm90SW5SYW5nZUVycm9yKHVpbnQyNTYgYmxvY2tUaW1lc3RhbXAsIHVpbnQyNTYgdGltZXN0YW1wKTsKICAgIGVycm9yIE5vdFF1ZXVlZEVycm9yKGJ5dGVzMzIgdHhJZCk7CiAgICBlcnJvciBUaW1lc3RhbXBOb3RQYXNzZWRFcnJvcih1aW50MjU2IGJsb2NrVGltZXN0YW1wLCB1aW50MjU2IHRpbWVzdGFtcCk7CiAgICBlcnJvciBUaW1lc3RhbXBFeHBpcmVkRXJyb3IodWludDI1NiBibG9ja1RpbWVzdGFtcCwgdWludDI1NiBleHBpcmVzQXQpOwogICAgZXJyb3IgVHhGYWlsZWRFcnJvcigpOwoKICAgIGV2ZW50IFF1ZXVlKAogICAgICAgIGJ5dGVzMzIgaW5kZXhlZCB0eElkLAogICAgICAgIGFkZHJlc3MgaW5kZXhlZCB0YXJnZXQsCiAgICAgICAgdWludDI1NiB2YWx1ZSwKICAgICAgICBzdHJpbmcgZnVuYywKICAgICAgICBieXRlcyBkYXRhLAogICAgICAgIHVpbnQyNTYgdGltZXN0YW1wCiAgICApOwogICAgZXZlbnQgRXhlY3V0ZSgKICAgICAgICBieXRlczMyIGluZGV4ZWQgdHhJZCwKICAgICAgICBhZGRyZXNzIGluZGV4ZWQgdGFyZ2V0LAogICAgICAgIHVpbnQyNTYgdmFsdWUsCiAgICAgICAgc3RyaW5nIGZ1bmMsCiAgICAgICAgYnl0ZXMgZGF0YSwKICAgICAgICB1aW50MjU2IHRpbWVzdGFtcAogICAgKTsKICAgIGV2ZW50IENhbmNlbChieXRlczMyIGluZGV4ZWQgdHhJZCk7CgogICAgdWludDI1NiBwdWJsaWMgY29uc3RhbnQgTUlOX0RFTEFZID0gMTA7IC8vIHNlY29uZHMKICAgIHVpbnQyNTYgcHVibGljIGNvbnN0YW50IE1BWF9ERUxBWSA9IDEwMDA7IC8vIHNlY29uZHMKICAgIHVpbnQyNTYgcHVibGljIGNvbnN0YW50IEdSQUNFX1BFUklPRCA9IDEwMDA7IC8vIHNlY29uZHMKCiAgICBhZGRyZXNzIHB1YmxpYyBvd25lcjsKICAgIC8vIHR4IGlkID0+IHF1ZXVlZAogICAgbWFwcGluZyhieXRlczMyID0+IGJvb2wpIHB1YmxpYyBxdWV1ZWQ7CgogICAgY29uc3RydWN0b3IoKSB7CiAgICAgICAgb3duZXIgPSBtc2cuc2VuZGVyOwogICAgfQoKICAgIG1vZGlmaWVyIG9ubHlPd25lcigpIHsKICAgICAgICBpZiAobXNnLnNlbmRlciAhPSBvd25lcikgewogICAgICAgICAgICByZXZlcnQgTm90T3duZXJFcnJvcigpOwogICAgICAgIH0KICAgICAgICBfOwogICAgfQoKICAgIHJlY2VpdmUoKSBleHRlcm5hbCBwYXlhYmxlIHt9CgogICAgZnVuY3Rpb24gZ2V0VHhJZCgKICAgICAgICBhZGRyZXNzIF90YXJnZXQsCiAgICAgICAgdWludDI1NiBfdmFsdWUsCiAgICAgICAgc3RyaW5nIGNhbGxkYXRhIF9mdW5jLAogICAgICAgIGJ5dGVzIGNhbGxkYXRhIF9kYXRhLAogICAgICAgIHVpbnQyNTYgX3RpbWVzdGFtcAogICAgKSBwdWJsaWMgcHVyZSByZXR1cm5zIChieXRlczMyKSB7CiAgICAgICAgcmV0dXJuIGtlY2NhazI1NihhYmkuZW5jb2RlKF90YXJnZXQsIF92YWx1ZSwgX2Z1bmMsIF9kYXRhLCBfdGltZXN0YW1wKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBAcGFyYW0gX3RhcmdldCBBZGRyZXNzIG9mIGNvbnRyYWN0IG9yIGFjY291bnQgdG8gY2FsbAogICAgICogQHBhcmFtIF92YWx1ZSBBbW91bnQgb2YgRVRIIHRvIHNlbmQKICAgICAqIEBwYXJhbSBfZnVuYyBGdW5jdGlvbiBzaWduYXR1cmUsIGZvciBleGFtcGxlICJmb28oYWRkcmVzcyx1aW50MjU2KSIKICAgICAqIEBwYXJhbSBfZGF0YSBBQkkgZW5jb2RlZCBkYXRhIHNlbmQuCiAgICAgKiBAcGFyYW0gX3RpbWVzdGFtcCBUaW1lc3RhbXAgYWZ0ZXIgd2hpY2ggdGhlIHRyYW5zYWN0aW9uIGNhbiBiZSBleGVjdXRlZC4KICAgICAqLwogICAgZnVuY3Rpb24gcXVldWUoCiAgICAgICAgYWRkcmVzcyBfdGFyZ2V0LAogICAgICAgIHVpbnQyNTYgX3ZhbHVlLAogICAgICAgIHN0cmluZyBjYWxsZGF0YSBfZnVuYywKICAgICAgICBieXRlcyBjYWxsZGF0YSBfZGF0YSwKICAgICAgICB1aW50MjU2IF90aW1lc3RhbXAKICAgICkgZXh0ZXJuYWwgb25seU93bmVyIHJldHVybnMgKGJ5dGVzMzIgdHhJZCkgewogICAgICAgIHR4SWQgPSBnZXRUeElkKF90YXJnZXQsIF92YWx1ZSwgX2Z1bmMsIF9kYXRhLCBfdGltZXN0YW1wKTsKICAgICAgICBpZiAocXVldWVkW3R4SWRdKSB7CiAgICAgICAgICAgIHJldmVydCBBbHJlYWR5UXVldWVkRXJyb3IodHhJZCk7CiAgICAgICAgfQogICAgICAgIC8vIC0tLXwtLS0tLS0tLS0tLS18LS0tLS0tLS0tLS0tLS0tfC0tLS0tLS0KICAgICAgICAvLyAgYmxvY2sgICAgYmxvY2sgKyBtaW4gICAgIGJsb2NrICsgbWF4CiAgICAgICAgaWYgKAogICAgICAgICAgICBfdGltZXN0YW1wIDwgYmxvY2sudGltZXN0YW1wICsgTUlOX0RFTEFZCiAgICAgICAgICAgICAgICB8fCBfdGltZXN0YW1wID4gYmxvY2sudGltZXN0YW1wICsgTUFYX0RFTEFZCiAgICAgICAgKSB7CiAgICAgICAgICAgIHJldmVydCBUaW1lc3RhbXBOb3RJblJhbmdlRXJyb3IoYmxvY2sudGltZXN0YW1wLCBfdGltZXN0YW1wKTsKICAgICAgICB9CgogICAgICAgIHF1ZXVlZFt0eElkXSA9IHRydWU7CgogICAgICAgIGVtaXQgUXVldWUodHhJZCwgX3RhcmdldCwgX3ZhbHVlLCBfZnVuYywgX2RhdGEsIF90aW1lc3RhbXApOwogICAgfQoKICAgIGZ1bmN0aW9uIGV4ZWN1dGUoCiAgICAgICAgYWRkcmVzcyBfdGFyZ2V0LAogICAgICAgIHVpbnQyNTYgX3ZhbHVlLAogICAgICAgIHN0cmluZyBjYWxsZGF0YSBfZnVuYywKICAgICAgICBieXRlcyBjYWxsZGF0YSBfZGF0YSwKICAgICAgICB1aW50MjU2IF90aW1lc3RhbXAKICAgICkgZXh0ZXJuYWwgcGF5YWJsZSBvbmx5T3duZXIgcmV0dXJucyAoYnl0ZXMgbWVtb3J5KSB7CiAgICAgICAgYnl0ZXMzMiB0eElkID0gZ2V0VHhJZChfdGFyZ2V0LCBfdmFsdWUsIF9mdW5jLCBfZGF0YSwgX3RpbWVzdGFtcCk7CiAgICAgICAgaWYgKCFxdWV1ZWRbdHhJZF0pIHsKICAgICAgICAgICAgcmV2ZXJ0IE5vdFF1ZXVlZEVycm9yKHR4SWQpOwogICAgICAgIH0KICAgICAgICAvLyAtLS0tfC0tLS0tLS0tLS0tLS0tLS0tLS18LS0tLS0tLQogICAgICAgIC8vICB0aW1lc3RhbXAgICAgdGltZXN0YW1wICsgZ3JhY2UgcGVyaW9kCiAgICAgICAgaWYgKGJsb2NrLnRpbWVzdGFtcCA8IF90aW1lc3RhbXApIHsKICAgICAgICAgICAgcmV2ZXJ0IFRpbWVzdGFtcE5vdFBhc3NlZEVycm9yKGJsb2NrLnRpbWVzdGFtcCwgX3RpbWVzdGFtcCk7CiAgICAgICAgfQogICAgICAgIGlmIChibG9jay50aW1lc3RhbXAgPiBfdGltZXN0YW1wICsgR1JBQ0VfUEVSSU9EKSB7CiAgICAgICAgICAgIHJldmVydCBUaW1lc3RhbXBFeHBpcmVkRXJyb3IoCiAgICAgICAgICAgICAgICBibG9jay50aW1lc3RhbXAsIF90aW1lc3RhbXAgKyBHUkFDRV9QRVJJT0QKICAgICAgICAgICAgKTsKICAgICAgICB9CgogICAgICAgIHF1ZXVlZFt0eElkXSA9IGZhbHNlOwoKICAgICAgICAvLyBwcmVwYXJlIGRhdGEKICAgICAgICBieXRlcyBtZW1vcnkgZGF0YTsKICAgICAgICBpZiAoYnl0ZXMoX2Z1bmMpLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgLy8gZGF0YSA9IGZ1bmMgc2VsZWN0b3IgKyBfZGF0YQogICAgICAgICAgICBkYXRhID0gYWJpLmVuY29kZVBhY2tlZChieXRlczQoa2VjY2FrMjU2KGJ5dGVzKF9mdW5jKSkpLCBfZGF0YSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gY2FsbCBmYWxsYmFjayB3aXRoIGRhdGEKICAgICAgICAgICAgZGF0YSA9IF9kYXRhOwogICAgICAgIH0KCiAgICAgICAgLy8gY2FsbCB0YXJnZXQKICAgICAgICAoYm9vbCBvaywgYnl0ZXMgbWVtb3J5IHJlcykgPSBfdGFyZ2V0LmNhbGx7dmFsdWU6IF92YWx1ZX0oZGF0YSk7CiAgICAgICAgaWYgKCFvaykgewogICAgICAgICAgICByZXZlcnQgVHhGYWlsZWRFcnJvcigpOwogICAgICAgIH0KCiAgICAgICAgZW1pdCBFeGVjdXRlKHR4SWQsIF90YXJnZXQsIF92YWx1ZSwgX2Z1bmMsIF9kYXRhLCBfdGltZXN0YW1wKTsKCiAgICAgICAgcmV0dXJuIHJlczsKICAgIH0KCiAgICBmdW5jdGlvbiBjYW5jZWwoYnl0ZXMzMiBfdHhJZCkgZXh0ZXJuYWwgb25seU93bmVyIHsKICAgICAgICBpZiAoIXF1ZXVlZFtfdHhJZF0pIHsKICAgICAgICAgICAgcmV2ZXJ0IE5vdFF1ZXVlZEVycm9yKF90eElkKTsKICAgICAgICB9CgogICAgICAgIHF1ZXVlZFtfdHhJZF0gPSBmYWxzZTsKCiAgICAgICAgZW1pdCBDYW5jZWwoX3R4SWQpOwogICAgfQp9Cg==" ref="nofollow noopener noreferrer">TimeLock.sol</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[uos基础 autostart 设置程序开机自启动]]></title>    <link>https://juejin.cn/post/7592615536385490978</link>    <guid>https://juejin.cn/post/7592615536385490978</guid>    <pubDate>2026-01-08T13:39:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592615536385490978" data-draft-id="7592622563547201571" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="uos基础 autostart 设置程序开机自启动"/> <meta itemprop="keywords" content="运维"/> <meta itemprop="datePublished" content="2026-01-08T13:39:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="行初心"/> <meta itemprop="url" content="https://juejin.cn/user/4081803083395527"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            uos基础 autostart 设置程序开机自启动
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4081803083395527/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    行初心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T13:39:19.000Z" title="Thu Jan 08 2026 13:39:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>统信桌面操作系统专业版V20（1070）<br/>
Linux uos 5.10.97-arm64-desktop</p>
</blockquote>
<h3 data-id="heading-0">uos基础 autostart 设置程序开机自启动</h3>
<pre><code class="hljs language-c" lang="c">code@uos:~$ ls
模板  Desktop  Documents  Downloads  Music  Pictures  Videos
code@uos:~$ ls -al
总用量 <span class="hljs-number">320</span>
drwxr-x--- <span class="hljs-number">21</span> code code   <span class="hljs-number">4096</span> <span class="hljs-number">10</span>月 <span class="hljs-number">28</span> <span class="hljs-number">15</span>:<span class="hljs-number">19</span> .
drwxr-xr-x  <span class="hljs-number">4</span> root root   <span class="hljs-number">4096</span> <span class="hljs-number">10</span>月 <span class="hljs-number">28</span> <span class="hljs-number">15</span>:<span class="hljs-number">18</span> ..
drwxr-xr-x  <span class="hljs-number">2</span> code code   <span class="hljs-number">4096</span> <span class="hljs-number">9</span>月  <span class="hljs-number">15</span> <span class="hljs-number">10</span>:<span class="hljs-number">45</span> 模板
-rw-r--r--  <span class="hljs-number">1</span> code code     <span class="hljs-number">86</span> <span class="hljs-number">11</span>月  <span class="hljs-number">9</span>  <span class="hljs-number">2024</span> .bash_aliases
-rw-r--r--  <span class="hljs-number">1</span> code code    <span class="hljs-number">220</span> <span class="hljs-number">2</span>月  <span class="hljs-number">25</span>  <span class="hljs-number">2024</span> .bash_logout
-rw-r--r--  <span class="hljs-number">1</span> code code   <span class="hljs-number">3748</span> <span class="hljs-number">6</span>月  <span class="hljs-number">12</span>  <span class="hljs-number">2024</span> .bashrc
drwxr-xr-x  <span class="hljs-number">8</span> code code   <span class="hljs-number">4096</span> <span class="hljs-number">10</span>月 <span class="hljs-number">28</span> <span class="hljs-number">15</span>:<span class="hljs-number">19</span> .cache
drwxr-xr-x <span class="hljs-number">16</span> code code   <span class="hljs-number">4096</span> <span class="hljs-number">10</span>月 <span class="hljs-number">28</span> <span class="hljs-number">15</span>:<span class="hljs-number">19</span> .config
drwx------  <span class="hljs-number">3</span> code code   <span class="hljs-number">4096</span> <span class="hljs-number">10</span>月 <span class="hljs-number">28</span> <span class="hljs-number">15</span>:<span class="hljs-number">19</span> .dbus
drwxr-xr-x  <span class="hljs-number">2</span> code code   <span class="hljs-number">4096</span> <span class="hljs-number">10</span>月 <span class="hljs-number">28</span> <span class="hljs-number">15</span>:<span class="hljs-number">19</span> .deepin-defender
drwxr-xr-x  <span class="hljs-number">2</span> code code   <span class="hljs-number">4096</span> <span class="hljs-number">10</span>月 <span class="hljs-number">28</span> <span class="hljs-number">15</span>:<span class="hljs-number">19</span> Desktop
drwxr-xr-x  <span class="hljs-number">2</span> code code   <span class="hljs-number">4096</span> <span class="hljs-number">6</span>月  <span class="hljs-number">12</span>  <span class="hljs-number">2024</span> Documents
drwxr-xr-x  <span class="hljs-number">2</span> code code   <span class="hljs-number">4096</span> <span class="hljs-number">6</span>月  <span class="hljs-number">12</span>  <span class="hljs-number">2024</span> Downloads
drwx------  <span class="hljs-number">3</span> code code   <span class="hljs-number">4096</span> <span class="hljs-number">10</span>月 <span class="hljs-number">28</span> <span class="hljs-number">15</span>:<span class="hljs-number">19</span> .gnupg
-rw-r--r--  <span class="hljs-number">1</span> code code     <span class="hljs-number">27</span> <span class="hljs-number">10</span>月 <span class="hljs-number">28</span> <span class="hljs-number">15</span>:<span class="hljs-number">19</span> .gtkrc<span class="hljs-number">-2.0</span>
drwxr-xr-x  <span class="hljs-number">2</span> code code   <span class="hljs-number">4096</span> <span class="hljs-number">10</span>月 <span class="hljs-number">28</span> <span class="hljs-number">15</span>:<span class="hljs-number">19</span> .hplip
drwxr-xr-x  <span class="hljs-number">3</span> code code   <span class="hljs-number">4096</span> <span class="hljs-number">6</span>月  <span class="hljs-number">12</span>  <span class="hljs-number">2024</span> .icons
-rw-r--r--  <span class="hljs-number">1</span> code code <span class="hljs-number">194683</span> <span class="hljs-number">10</span>月 <span class="hljs-number">28</span> <span class="hljs-number">15</span>:<span class="hljs-number">19</span> .kwin.<span class="hljs-built_in">log</span>
drwxr-xr-x  <span class="hljs-number">3</span> code code   <span class="hljs-number">4096</span> <span class="hljs-number">6</span>月  <span class="hljs-number">12</span>  <span class="hljs-number">2024</span> .local
drwxr-xr-x  <span class="hljs-number">2</span> code code   <span class="hljs-number">4096</span> <span class="hljs-number">6</span>月  <span class="hljs-number">12</span>  <span class="hljs-number">2024</span> Music
drwxr-xr-x  <span class="hljs-number">3</span> code code   <span class="hljs-number">4096</span> <span class="hljs-number">6</span>月  <span class="hljs-number">12</span>  <span class="hljs-number">2024</span> Pictures
drwx------  <span class="hljs-number">3</span> code code   <span class="hljs-number">4096</span> <span class="hljs-number">10</span>月 <span class="hljs-number">28</span> <span class="hljs-number">15</span>:<span class="hljs-number">19</span> .pki
-rw-r--r--  <span class="hljs-number">1</span> code code    <span class="hljs-number">807</span> <span class="hljs-number">2</span>月  <span class="hljs-number">25</span>  <span class="hljs-number">2024</span> .profile
drwxr-xr-x  <span class="hljs-number">2</span> code code   <span class="hljs-number">4096</span> <span class="hljs-number">6</span>月  <span class="hljs-number">12</span>  <span class="hljs-number">2024</span> .Public
drwxr-xr-x  <span class="hljs-number">2</span> code code   <span class="hljs-number">4096</span> <span class="hljs-number">6</span>月  <span class="hljs-number">12</span>  <span class="hljs-number">2024</span> .Templates
drwxr-xr-x  <span class="hljs-number">2</span> code code   <span class="hljs-number">4096</span> <span class="hljs-number">10</span>月 <span class="hljs-number">28</span> <span class="hljs-number">15</span>:<span class="hljs-number">19</span> .themes
drwxr-xr-x  <span class="hljs-number">2</span> code code   <span class="hljs-number">4096</span> <span class="hljs-number">6</span>月  <span class="hljs-number">12</span>  <span class="hljs-number">2024</span> Videos
-rw-r--r--  <span class="hljs-number">1</span> code code    <span class="hljs-number">205</span> <span class="hljs-number">10</span>月 <span class="hljs-number">28</span> <span class="hljs-number">15</span>:<span class="hljs-number">19</span> .wget-hsts
-rw-------  <span class="hljs-number">1</span> code code      <span class="hljs-number">1</span> <span class="hljs-number">10</span>月 <span class="hljs-number">28</span> <span class="hljs-number">15</span>:<span class="hljs-number">19</span> .Xauthority
-rw-------  <span class="hljs-number">1</span> code code   <span class="hljs-number">9346</span> <span class="hljs-number">10</span>月 <span class="hljs-number">28</span> <span class="hljs-number">15</span>:<span class="hljs-number">19</span> .xsession-errors
-rw-r--r--  <span class="hljs-number">1</span> code code   <span class="hljs-number">1753</span> <span class="hljs-number">10</span>月 <span class="hljs-number">28</span> <span class="hljs-number">15</span>:<span class="hljs-number">19</span> .xwayland.<span class="hljs-built_in">log</span>
code@uos:~$ cd .config/
code@uos:~/.config$ ls
autostart               deepin      google-chrome       pipewire-media-session  user-dirs.dirs
autostop                deepinwmrc  gtk<span class="hljs-number">-3.0</span>             pulse
com.huawei.pcmanager    dsg         kcminputrc          SogouPY
dconf                   enchant     kglobalshortcutsrc  systemd
dde-first-run.log_code  fcitx       kwinrc              Trolltech.conf
</code></pre>
<pre><code class="hljs language-c" lang="c">code@uos:~/.config$ cd autostart/
code@uos:~/.config/autostart$ ls
code@uos:~/.config/autostart$ cp /home/code/Desktop/uos-service-support.desktop .
code@uos:~/.config/autostart$ ls
uos-service-support.desktop
code@uos:~/.config/autostart$ 

</code></pre>
<ul>
<li>cp之时，会有一个确认弹窗。</li>
<li>这样做的效果是，设置"服务与支持"为开机自启动的程序</li>
<li>特意重启试了一把，成功了</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54b23823c158438ea5dc013db4a7bda4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KGM5Yid5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768484359&amp;x-signature=c%2F2ioRpWCFSOQa4V5Bmm%2F5XoJv4%3D" alt="uos-autostart-config-1.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring Boot 钩子全集实战（五）：ApplicationContextInitializer详解]]></title>    <link>https://juejin.cn/post/7592829037937475599</link>    <guid>https://juejin.cn/post/7592829037937475599</guid>    <pubDate>2026-01-08T14:36:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592829037937475599" data-draft-id="7592622563547332643" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring Boot 钩子全集实战（五）：ApplicationContextInitializer详解"/> <meta itemprop="keywords" content="Java,面试,Spring"/> <meta itemprop="datePublished" content="2026-01-08T14:36:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Web天梯之路"/> <meta itemprop="url" content="https://juejin.cn/user/2825061103052843"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring Boot 钩子全集实战（五）：ApplicationContextInitializer详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2825061103052843/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Web天梯之路
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T14:36:55.000Z" title="Thu Jan 08 2026 14:36:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在上一篇中，我们深入剖析了 <strong><code>SpringApplicationRunListener.environmentPrepared()</code></strong> 这一关键扩展点，实现了环境合法性校验、启动上下文传递、多环境隔离兜底与配置动态增强等高阶能力。今天，我们将进入 Spring Boot 启动生命周期的下一个重要阶段——<strong>容器初始化前的关键扩展点</strong>：<code>ApplicationContextInitializer</code>。</p>
<h2 data-id="heading-0">一、什么是 <code>ApplicationContextInitializer</code>？</h2>
<p><code>ApplicationContextInitializer</code> 是 Spring 框架原生提供的接口，在 Spring Boot 中被广泛用于 <strong>在 <code>ApplicationContext</code> 初始化完成前、刷新前（refresh 前）对容器进行定制化配置</strong>。其触发时机具有如下特征：</p>
<ul>
<li><strong>触发时机</strong>：<code>ApplicationContext</code> 已创建但尚未调用 <code>refresh()</code>；</li>
<li><strong>核心状态</strong>：<code>Environment</code> 已完全准备就绪，所有配置已生效；</li>
<li><strong>执行顺序</strong>：晚于 <code>environmentPrepared()</code>，早于 <code>BeanFactoryPostProcessor</code>；</li>
<li><strong>核心能力</strong>：可注册 Bean、修改 Bean 定义、设置容器属性、注入自定义逻辑。</li>
</ul>
<blockquote>
<p>✅ <strong>核心价值</strong>：在容器刷新前对 <code>ApplicationContext</code> 做最后的“预热”和“定制”，是实现容器级扩展、安全加固、AOP 注入、监控埋点等场景的核心入口。</p>
</blockquote>
<h2 data-id="heading-1">二、场景 ：容器安全加固（禁止危险 Bean 注入）</h2>
<h3 data-id="heading-2">业务痛点</h3>
<p>微服务架构下，部分第三方库或内部组件可能通过自动配置注入高危 Bean（如 <code>Runtime</code>、<code>ScriptEngine</code>、<code>JndiTemplate</code>），存在远程代码执行（RCE）风险。即使通过配置禁用，仍可能因依赖传递或版本升级被意外激活。</p>
<h3 data-id="heading-3">解决方案</h3>
<p>利用 <code>ApplicationContextInitializer</code> 在容器刷新前扫描并移除/替换高危 Bean 定义，从源头阻断安全隐患。</p>
<h4 data-id="heading-4">实现代码</h4>
<pre><code class="hljs language-ini" lang="ini">package com.example.demo.initializer<span class="hljs-comment">;</span>
​
import org.springframework.beans.factory.config.ConfigurableListableBeanFactory<span class="hljs-comment">;</span>
import org.springframework.beans.factory.support.BeanDefinitionBuilder<span class="hljs-comment">;</span>
import org.springframework.beans.factory.support.BeanDefinitionRegistry<span class="hljs-comment">;</span>
import org.springframework.beans.factory.support.DefaultListableBeanFactory<span class="hljs-comment">;</span>
import org.springframework.context.ApplicationContextInitializer<span class="hljs-comment">;</span>
import org.springframework.context.ConfigurableApplicationContext<span class="hljs-comment">;</span>
import org.springframework.context.annotation.ClassPathScanningCandidateComponentProvider<span class="hljs-comment">;</span>
import org.springframework.core.type.filter.AssignableTypeFilter<span class="hljs-comment">;</span>
import org.springframework.jndi.JndiTemplate<span class="hljs-comment">;</span>
import org.springframework.util.StringUtils<span class="hljs-comment">;</span>
​
import javax.naming.InitialContext<span class="hljs-comment">;</span>
import javax.script.ScriptEngine<span class="hljs-comment">;</span>
import java.util.Arrays<span class="hljs-comment">;</span>
import java.util.HashSet<span class="hljs-comment">;</span>
import java.util.Set<span class="hljs-comment">;</span>
​
/**
 * 容器安全加固初始化器
 */
public class SecurityHardeningInitializer implements ApplicationContextInitializer&lt;ConfigurableApplicationContext&gt; {
​
    // 高危类黑名单（可根据安全策略动态加载）
    private static final Set&lt;String&gt; <span class="hljs-attr">DANGEROUS_BEAN_TYPES</span> = new HashSet&lt;&gt;(Arrays.asList(
            "javax.script.ScriptEngine",
            "javax.naming.InitialContext",
            "org.springframework.jndi.JndiTemplate",
            "java.lang.Runtime"
    ))<span class="hljs-comment">;</span>
​
    @Override
    public void initialize(ConfigurableApplicationContext applicationContext) {
        System.out.println("<span class="hljs-section">[安全加固]</span> 开始扫描并清理高危 Bean 定义")<span class="hljs-comment">;</span>
​
        //构造高危类黑名单的类
        if (applicationContext instanceof BeanDefinitionRegistry registry) {
            BeanDefinitionBuilder <span class="hljs-attr">builder1</span> = BeanDefinitionBuilder.genericBeanDefinition(ScriptEngine.class)<span class="hljs-comment">;</span>
            BeanDefinitionBuilder <span class="hljs-attr">builder2</span> = BeanDefinitionBuilder.genericBeanDefinition(InitialContext.class)<span class="hljs-comment">;</span>
            BeanDefinitionBuilder <span class="hljs-attr">builder3</span> = BeanDefinitionBuilder.genericBeanDefinition(JndiTemplate.class)<span class="hljs-comment">;</span>
            BeanDefinitionBuilder <span class="hljs-attr">builder4</span> = BeanDefinitionBuilder.genericBeanDefinition(Runtime.class)<span class="hljs-comment">;</span>
            // 注册BeanDefinition
            registry.registerBeanDefinition("scriptEngine", builder1.getBeanDefinition())<span class="hljs-comment">;</span>
            registry.registerBeanDefinition("initialContext", builder2.getBeanDefinition())<span class="hljs-comment">;</span>
            registry.registerBeanDefinition("jndiTemplate", builder3.getBeanDefinition())<span class="hljs-comment">;</span>
            registry.registerBeanDefinition("runtime", builder4.getBeanDefinition())<span class="hljs-comment">;</span>
        }
​
        DefaultListableBeanFactory <span class="hljs-attr">beanFactory</span> = (DefaultListableBeanFactory) applicationContext.getBeanFactory()<span class="hljs-comment">;</span>
        String<span class="hljs-section">[]</span> <span class="hljs-attr">beanNames</span> = beanFactory.getBeanDefinitionNames()<span class="hljs-comment">;</span>
​
        for (String beanName : beanNames) {
            var <span class="hljs-attr">beanDefinition</span> = beanFactory.getBeanDefinition(beanName)<span class="hljs-comment">;</span>
            String <span class="hljs-attr">beanClassName</span> = beanDefinition.getBeanClassName()<span class="hljs-comment">;</span>
​
            if (StringUtils.hasText(beanClassName) &amp;&amp; DANGEROUS_BEAN_TYPES.contains(beanClassName)) {
                System.err.printf("<span class="hljs-section">[安全加固]</span> 检测到高危 Bean：%s（类型：%s），已移除！%n", beanName, beanClassName)<span class="hljs-comment">;</span>
                beanFactory.removeBeanDefinition(beanName)<span class="hljs-comment">;</span>
            }
        }
​
        // 禁止通过 @Import 或 ComponentScan 自动注册高危类
        disableDangerousScanning(applicationContext)<span class="hljs-comment">;</span>
​
        System.out.println("<span class="hljs-section">[安全加固]</span> 容器安全加固完成")<span class="hljs-comment">;</span>
    }
​
    /**
     * 禁用高危类的组件扫描（防止后续自动注册）
     */
    private void disableDangerousScanning(ConfigurableApplicationContext context) {
        ClassPathScanningCandidateComponentProvider <span class="hljs-attr">scanner</span> =
                new ClassPathScanningCandidateComponentProvider(false)<span class="hljs-comment">;</span>
        scanner.addIncludeFilter(new AssignableTypeFilter(Runtime.class))<span class="hljs-comment">;</span>
        // 实际生产中可结合 AspectJ 或字节码工具拦截，此处仅作示意
        System.out.println("<span class="hljs-section">[安全加固]</span> 已禁用高危类自动扫描（需配合编译期检查）")<span class="hljs-comment">;</span>
    }
}
</code></pre>
<h4 data-id="heading-5">配置方式（任选其一）</h4>
<p><strong>方式 1：通过 <code>spring.factories</code></strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># resources/META-INF/spring.factories</span>
<span class="hljs-attr">org.springframework.context.ApplicationContextInitializer</span>=\
com.example.demo.initializer.SecurityHardeningInitializer
</code></pre>
<p><strong>方式 2：通过主类显式注册</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DemoApplication</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
        <span class="hljs-title class_">SpringApplication</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpringApplication</span>(<span class="hljs-title class_">DemoApplication</span>.<span class="hljs-property">class</span>);
        app.<span class="hljs-title function_">addInitializers</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SecurityHardeningInitializer</span>());
        app.<span class="hljs-title function_">run</span>(args);
    }
}
</code></pre>
<h4 data-id="heading-6">输出结果</h4>
<pre><code class="hljs language-less" lang="less">  .   <span class="hljs-selector-tag">____</span>          <span class="hljs-selector-tag">_</span>            <span class="hljs-selector-tag">__</span> <span class="hljs-selector-tag">_</span> <span class="hljs-selector-tag">_</span>
 /\ / <span class="hljs-selector-tag">___</span>'<span class="hljs-selector-tag">_</span> <span class="hljs-selector-tag">__</span> <span class="hljs-selector-tag">_</span> <span class="hljs-selector-tag">_</span>(_)<span class="hljs-selector-tag">_</span> <span class="hljs-selector-tag">__</span>  <span class="hljs-selector-tag">__</span> <span class="hljs-selector-tag">_</span> \ \ \ \
( ( )___ | <span class="hljs-string">'_ | '</span>_| | '_ / _` | \ \ \ \
 \/  ___)| |<span class="hljs-selector-tag">_</span>)| | | | | || (_| |  ) ) ) )
  '  |<span class="hljs-selector-tag">____</span>| <span class="hljs-selector-class">.__</span>|<span class="hljs-selector-tag">_</span>| |<span class="hljs-selector-tag">_</span>|<span class="hljs-selector-tag">_</span>| |<span class="hljs-selector-tag">___</span>, | / / / /
 =========|<span class="hljs-selector-tag">_</span>|==============|<span class="hljs-selector-tag">___</span>/=/<span class="hljs-selector-tag">_</span>/<span class="hljs-selector-tag">_</span>/<span class="hljs-selector-tag">_</span>/
​
 :: <span class="hljs-selector-tag">Spring</span> <span class="hljs-selector-tag">Boot</span> ::                (v3.<span class="hljs-number">5.8</span>)
​
<span class="hljs-selector-attr">[安全加固]</span> 开始扫描并清理高危 <span class="hljs-selector-tag">Bean</span> 定义
<span class="hljs-selector-attr">[安全加固]</span> 已禁用高危类自动扫描（需配合编译期检查）
<span class="hljs-selector-attr">[安全加固]</span> 容器安全加固完成
<span class="hljs-number">2025</span><span class="hljs-selector-tag">-12-17T23</span>:<span class="hljs-number">58</span>:<span class="hljs-number">06.580</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  <span class="hljs-selector-tag">INFO</span> <span class="hljs-number">11158</span> <span class="hljs-selector-tag">---</span> <span class="hljs-selector-attr">[           main]</span> <span class="hljs-selector-tag">com</span><span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.demo</span><span class="hljs-selector-class">.DemoApplication</span>         : <span class="hljs-selector-tag">Starting</span> <span class="hljs-selector-tag">DemoApplication</span> <span class="hljs-selector-tag">using</span> <span class="hljs-selector-tag">Java</span> <span class="hljs-number">21.0</span><span class="hljs-selector-class">.9</span> <span class="hljs-selector-tag">with</span> <span class="hljs-selector-tag">PID</span> <span class="hljs-number">11158</span> (/Users/wangmingfei/Documents/个人/<span class="hljs-number">05</span> java天梯之路/<span class="hljs-number">01</span> 源码/<span class="hljs-number">03</span> 每日打卡系列/daily-check-in/springboot钩子/demo/target/classes started by wangmingfei in /Users/wangmingfei/Documents/个人/<span class="hljs-number">05</span> java天梯之路/<span class="hljs-number">01</span> 源码/<span class="hljs-number">03</span> 每日打卡系列/daily-check-in/springboot钩子/demo)
<span class="hljs-number">2025</span><span class="hljs-selector-tag">-12-17T23</span>:<span class="hljs-number">58</span>:<span class="hljs-number">06.581</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  <span class="hljs-selector-tag">INFO</span> <span class="hljs-number">11158</span> <span class="hljs-selector-tag">---</span> <span class="hljs-selector-attr">[           main]</span> <span class="hljs-selector-tag">com</span><span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.demo</span><span class="hljs-selector-class">.DemoApplication</span>         : <span class="hljs-selector-tag">The</span> <span class="hljs-selector-tag">following</span> <span class="hljs-number">1</span> <span class="hljs-selector-tag">profile</span> <span class="hljs-selector-tag">is</span> <span class="hljs-selector-tag">active</span>: "<span class="hljs-selector-tag">prod</span>"
<span class="hljs-selector-attr">[安全加固]</span> 检测到高危 <span class="hljs-selector-tag">Bean</span>：<span class="hljs-selector-tag">scriptEngine</span>（类型：<span class="hljs-selector-tag">javax</span><span class="hljs-selector-class">.script</span><span class="hljs-selector-class">.ScriptEngine</span>），已移除！
<span class="hljs-selector-attr">[安全加固]</span> 检测到高危 <span class="hljs-selector-tag">Bean</span>：<span class="hljs-selector-tag">initialContext</span>（类型：<span class="hljs-selector-tag">javax</span><span class="hljs-selector-class">.naming</span><span class="hljs-selector-class">.InitialContext</span>），已移除！
<span class="hljs-selector-attr">[安全加固]</span> 检测到高危 <span class="hljs-selector-tag">Bean</span>：<span class="hljs-selector-tag">jndiTemplate</span>（类型：<span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.jndi</span><span class="hljs-selector-class">.JndiTemplate</span>），已移除！
<span class="hljs-selector-attr">[安全加固]</span> 检测到高危 <span class="hljs-selector-tag">Bean</span>：<span class="hljs-selector-tag">runtime</span>（类型：<span class="hljs-selector-tag">java</span><span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.Runtime</span>），已移除！
<span class="hljs-number">2025</span><span class="hljs-selector-tag">-12-17T23</span>:<span class="hljs-number">58</span>:<span class="hljs-number">06.876</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  <span class="hljs-selector-tag">INFO</span> <span class="hljs-number">11158</span> <span class="hljs-selector-tag">---</span> <span class="hljs-selector-attr">[           main]</span> <span class="hljs-selector-tag">o</span><span class="hljs-selector-class">.s</span><span class="hljs-selector-class">.b</span><span class="hljs-selector-class">.w</span><span class="hljs-selector-class">.embedded</span><span class="hljs-selector-class">.tomcat</span><span class="hljs-selector-class">.TomcatWebServer</span>  : <span class="hljs-selector-tag">Tomcat</span> <span class="hljs-selector-tag">initialized</span> <span class="hljs-selector-tag">with</span> <span class="hljs-selector-tag">port</span> <span class="hljs-number">8080</span> (http)
<span class="hljs-number">2025</span><span class="hljs-selector-tag">-12-17T23</span>:<span class="hljs-number">58</span>:<span class="hljs-number">06.882</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  <span class="hljs-selector-tag">INFO</span> <span class="hljs-number">11158</span> <span class="hljs-selector-tag">---</span> <span class="hljs-selector-attr">[           main]</span> <span class="hljs-selector-tag">o</span><span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.catalina</span><span class="hljs-selector-class">.core</span><span class="hljs-selector-class">.StandardService</span>   : <span class="hljs-selector-tag">Starting</span> <span class="hljs-selector-tag">service</span> <span class="hljs-selector-attr">[Tomcat]</span>
<span class="hljs-number">2025</span><span class="hljs-selector-tag">-12-17T23</span>:<span class="hljs-number">58</span>:<span class="hljs-number">06.883</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  <span class="hljs-selector-tag">INFO</span> <span class="hljs-number">11158</span> <span class="hljs-selector-tag">---</span> <span class="hljs-selector-attr">[           main]</span> <span class="hljs-selector-tag">o</span><span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.catalina</span><span class="hljs-selector-class">.core</span><span class="hljs-selector-class">.StandardEngine</span>    : <span class="hljs-selector-tag">Starting</span> <span class="hljs-selector-tag">Servlet</span> <span class="hljs-selector-tag">engine</span>: <span class="hljs-selector-attr">[Apache Tomcat/10.1.49]</span>
<span class="hljs-number">2025</span><span class="hljs-selector-tag">-12-17T23</span>:<span class="hljs-number">58</span>:<span class="hljs-number">06.901</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  <span class="hljs-selector-tag">INFO</span> <span class="hljs-number">11158</span> <span class="hljs-selector-tag">---</span> <span class="hljs-selector-attr">[           main]</span> <span class="hljs-selector-tag">o</span><span class="hljs-selector-class">.a</span><span class="hljs-selector-class">.c</span><span class="hljs-selector-class">.c</span><span class="hljs-selector-class">.C</span>.<span class="hljs-selector-attr">[Tomcat]</span>.<span class="hljs-selector-attr">[localhost]</span>.<span class="hljs-selector-attr">[/]</span>       : <span class="hljs-selector-tag">Initializing</span> <span class="hljs-selector-tag">Spring</span> <span class="hljs-selector-tag">embedded</span> <span class="hljs-selector-tag">WebApplicationContext</span>
<span class="hljs-number">2025</span><span class="hljs-selector-tag">-12-17T23</span>:<span class="hljs-number">58</span>:<span class="hljs-number">06.901</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  <span class="hljs-selector-tag">INFO</span> <span class="hljs-number">11158</span> <span class="hljs-selector-tag">---</span> <span class="hljs-selector-attr">[           main]</span> <span class="hljs-selector-tag">w</span><span class="hljs-selector-class">.s</span><span class="hljs-selector-class">.c</span><span class="hljs-selector-class">.ServletWebServerApplicationContext</span> : <span class="hljs-selector-tag">Root</span> <span class="hljs-selector-tag">WebApplicationContext</span>: <span class="hljs-selector-tag">initialization</span> <span class="hljs-selector-tag">completed</span> <span class="hljs-selector-tag">in</span> <span class="hljs-number">303</span> <span class="hljs-selector-tag">ms</span>
<span class="hljs-number">2025</span><span class="hljs-selector-tag">-12-17T23</span>:<span class="hljs-number">58</span>:<span class="hljs-number">07.038</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  <span class="hljs-selector-tag">INFO</span> <span class="hljs-number">11158</span> <span class="hljs-selector-tag">---</span> <span class="hljs-selector-attr">[           main]</span> <span class="hljs-selector-tag">o</span><span class="hljs-selector-class">.s</span><span class="hljs-selector-class">.b</span><span class="hljs-selector-class">.w</span><span class="hljs-selector-class">.embedded</span><span class="hljs-selector-class">.tomcat</span><span class="hljs-selector-class">.TomcatWebServer</span>  : <span class="hljs-selector-tag">Tomcat</span> <span class="hljs-selector-tag">started</span> <span class="hljs-selector-tag">on</span> <span class="hljs-selector-tag">port</span> <span class="hljs-number">8080</span> (http) <span class="hljs-selector-tag">with</span> <span class="hljs-selector-tag">context</span> <span class="hljs-selector-tag">path</span> '/'
<span class="hljs-number">2025</span><span class="hljs-selector-tag">-12-17T23</span>:<span class="hljs-number">58</span>:<span class="hljs-number">07.042</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  <span class="hljs-selector-tag">INFO</span> <span class="hljs-number">11158</span> <span class="hljs-selector-tag">---</span> <span class="hljs-selector-attr">[           main]</span> <span class="hljs-selector-tag">com</span><span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.demo</span><span class="hljs-selector-class">.DemoApplication</span>         : <span class="hljs-selector-tag">Started</span> <span class="hljs-selector-tag">DemoApplication</span> <span class="hljs-selector-tag">in</span> <span class="hljs-number">0.645</span> <span class="hljs-selector-tag">seconds</span> (process running for <span class="hljs-number">0.792</span>)
</code></pre>
<h4 data-id="heading-7">生产价值</h4>
<ul>
<li>从容器层面拦截高危 Bean，比运行时检测更早、更彻底；</li>
<li>防止因依赖升级或配置错误引入安全漏洞；</li>
</ul>
<h2 data-id="heading-8">三、总结</h2>
<p><code>ApplicationContextInitializer</code> 是 Spring Boot 启动流程中 <strong>连接环境准备与容器刷新的关键桥梁</strong>，它与 <code>environmentPrepared()</code> 形成“环境 → 容器”的完整扩展链路，是构建企业级高可靠、高安全、高可观测性应用不可或缺的一环。</p>
<p>📌 <strong>关注我</strong>，每天 5 分钟，带你从 Java 小白变身编程高手！</p>
<p>👉 点赞 + 关注 + 转发，让更多小伙伴一起进步！</p>
<p>👉 私信 "SpringBoot 钩子源码" 获取完整源码！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入理解Python控制流：从if-else到结构模式匹配，写出更优雅的条件判断逻辑]]></title>    <link>https://juejin.cn/post/7592615536385703970</link>    <guid>https://juejin.cn/post/7592615536385703970</guid>    <pubDate>2026-01-08T15:17:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592615536385703970" data-draft-id="7592622563547430947" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入理解Python控制流：从if-else到结构模式匹配，写出更优雅的条件判断逻辑"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-08T15:17:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="love_summer"/> <meta itemprop="url" content="https://juejin.cn/user/1462819851084228"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入理解Python控制流：从if-else到结构模式匹配，写出更优雅的条件判断逻辑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1462819851084228/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    love_summer
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T15:17:16.000Z" title="Thu Jan 08 2026 15:17:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin:30px 0 10px;color:#cca152;position:relative;padding-left:50px;border-bottom:2px solid rgba(209,163,78,.6);padding-bottom:0}.markdown-body h1{font-size:30px}.markdown-body h1:before{content:"";width:50px;height:42px;display:block;position:absolute;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACcAAAAhBAMAAACo1K8bAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAFZaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjQuMCI+CiAgIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgICAgIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICAgICAgICAgIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIj4KICAgICAgICAgPHRpZmY6T3JpZW50YXRpb24+MTwvdGlmZjpPcmllbnRhdGlvbj4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CkzCJ1kAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAnUExURUdwTMyhUsqkUMyhUsyiUcyhUsyhUsyhUcyhUsyhUs2hUtytWNWoVX44si8AAAAKdFJOUwD8Bfcge95QncCWSSDAAAABh0lEQVQoz2WSPUvDQBjHjyPSOB7drh2OUOs36NA6pKAFwaEo4tDFIUWxGYLgKw4BEYUuHaQg7XJ0kccsUmrT2qUUQZp8KO/y1hSfIYEf/5eHu0MoGU1+sIbSw5Bypd92S+dWWrd34b15vuOPY4QxuvtYZp0lIVk3Zgjt+5zkh12AvBHnbW85BOjXySPwhc5CYcY0OdDh5dEUqIEj4cN8Dty3a1MqYJS4MaWU5wzVLwMMxqGSNQgA/VFa4gf50yhxSUW+db8ACa2gBxfnABVDFYHCPYrc7TLwCepJM8/ZoVsRwpxdHEozHUXd6idwVzFFM5BFmIhQVQjrNdnCvdd48wblI2VHtsAZioSsTYVwLoXvjMXH1icuNgPhQE+Ot1+xi8HeA3d1Df1f1JPVUOmsYLujBjuSySqSXYt+yTwbJ0pcyIhqTrxkn0BazRLizJosxRBued+z0jPD6VewOXl5utHRGmMNK3k0iTkzxpq2/oIQO6gLprF12kT/R20eyzlcg7iwK0dPsz/ibpdsCHweWwAAAABJRU5ErkJggg==) 0 0 no-repeat;background-size:80%;bottom:-10px;left:-2px}.markdown-body h2{font-size:24px}.markdown-body h2:before{content:"";width:50px;height:42px;display:block;position:absolute;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACcAAAAhBAMAAACo1K8bAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAFZaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjQuMCI+CiAgIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgICAgIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICAgICAgICAgIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIj4KICAgICAgICAgPHRpZmY6T3JpZW50YXRpb24+MTwvdGlmZjpPcmllbnRhdGlvbj4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CkzCJ1kAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAnUExURUdwTMyhUsqkUMyhUsyiUcyhUsyhUsyhUcyhUsyhUs2hUtytWNWoVX44si8AAAAKdFJOUwD8Bfcge95QncCWSSDAAAABh0lEQVQoz2WSPUvDQBjHjyPSOB7drh2OUOs36NA6pKAFwaEo4tDFIUWxGYLgKw4BEYUuHaQg7XJ0kccsUmrT2qUUQZp8KO/y1hSfIYEf/5eHu0MoGU1+sIbSw5Bypd92S+dWWrd34b15vuOPY4QxuvtYZp0lIVk3Zgjt+5zkh12AvBHnbW85BOjXySPwhc5CYcY0OdDh5dEUqIEj4cN8Dty3a1MqYJS4MaWU5wzVLwMMxqGSNQgA/VFa4gf50yhxSUW+db8ACa2gBxfnABVDFYHCPYrc7TLwCepJM8/ZoVsRwpxdHEozHUXd6idwVzFFM5BFmIhQVQjrNdnCvdd48wblI2VHtsAZioSsTYVwLoXvjMXH1icuNgPhQE+Ot1+xi8HeA3d1Df1f1JPVUOmsYLujBjuSySqSXYt+yTwbJ0pcyIhqTrxkn0BazRLizJosxRBued+z0jPD6VewOXl5utHRGmMNK3k0iTkzxpq2/oIQO6gLprF12kT/R20eyzlcg7iwK0dPsz/ibpdsCHweWwAAAABJRU5ErkJggg==) 0 0 no-repeat;background-size:70%;bottom:-15px;left:-1px}.markdown-body h3{font-size:18px}.markdown-body h3:before{content:"";width:50px;height:42px;display:block;position:absolute;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACcAAAAhBAMAAACo1K8bAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAFZaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjQuMCI+CiAgIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgICAgIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICAgICAgICAgIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIj4KICAgICAgICAgPHRpZmY6T3JpZW50YXRpb24+MTwvdGlmZjpPcmllbnRhdGlvbj4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CkzCJ1kAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAnUExURUdwTMyhUsqkUMyhUsyiUcyhUsyhUsyhUcyhUsyhUs2hUtytWNWoVX44si8AAAAKdFJOUwD8Bfcge95QncCWSSDAAAABh0lEQVQoz2WSPUvDQBjHjyPSOB7drh2OUOs36NA6pKAFwaEo4tDFIUWxGYLgKw4BEYUuHaQg7XJ0kccsUmrT2qUUQZp8KO/y1hSfIYEf/5eHu0MoGU1+sIbSw5Bypd92S+dWWrd34b15vuOPY4QxuvtYZp0lIVk3Zgjt+5zkh12AvBHnbW85BOjXySPwhc5CYcY0OdDh5dEUqIEj4cN8Dty3a1MqYJS4MaWU5wzVLwMMxqGSNQgA/VFa4gf50yhxSUW+db8ACa2gBxfnABVDFYHCPYrc7TLwCepJM8/ZoVsRwpxdHEozHUXd6idwVzFFM5BFmIhQVQjrNdnCvdd48wblI2VHtsAZioSsTYVwLoXvjMXH1icuNgPhQE+Ot1+xi8HeA3d1Df1f1JPVUOmsYLujBjuSySqSXYt+yTwbJ0pcyIhqTrxkn0BazRLizJosxRBued+z0jPD6VewOXl5utHRGmMNK3k0iTkzxpq2/oIQO6gLprF12kT/R20eyzlcg7iwK0dPsz/ibpdsCHweWwAAAABJRU5ErkJggg==) 0 0 no-repeat;background-size:60%;bottom:-19px;left:-2px}.markdown-body h4{font-size:16px;padding-left:0;border-bottom:1px solid rgba(209,163,78,.6)}.markdown-body h5{font-size:15px;padding-left:0}.markdown-body em{color:#cca152}.markdown-body del{text-decoration-color:#cca152;text-decoration-thickness:2px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:80%;margin:6px auto;box-shadow:0 6px 15px #8e8e8e;display:block;margin:20px auto!important;object-fit:contain;border-radius:8px}.markdown-body hr{border:none;border-top:2px solid #e0c9a1;margin-top:32px 0}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background:#f6efde;color:#b69454;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Mono,Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;background:#fef6e1;border-radius:4px;box-shadow:0 0 8px hsla(0,0%,47%,.45)}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAOCAMAAABaWb9VAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAFZaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjQuMCI+CiAgIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgICAgIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICAgICAgICAgIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIj4KICAgICAgICAgPHRpZmY6T3JpZW50YXRpb24+MTwvdGlmZjpPcmllbnRhdGlvbj4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CkzCJ1kAAAAJcEhZcwAADsQAAA7EAZUrDhsAAACHUExURUdwTMxCKdc8NvdYT/9hVyLJPABBAGubKNiIOv+/K+ytJBakH9aZG+5QR5VZDOBDPhmtJ8+VGuGjH/CwJR26MR6+NBq0LPW1KBmwKetNRfJUTONHP92fHuSmIeFEPhu3LR29M/BTS+mqIuqsI5qdHyLKPP++Kv9gVf9lW//KLSXXQCTQP//FLMVm5KQAAAAldFJOUwAlPPz7+woBBPu8Mzu+FlRRKmvnweeG+Wqg6mVNXmuc1OCbmjZJWF/9AAABKklEQVQoz3WS6XaCMBCFRzAM++KGsqhtDwES3//5OtmA2uP9A9zwzRoAgBC0QgQrdA68OZsDr229YGHoIEj7Pl0ZOgjKa5lYJ4Rd1vijn3nuD4Qurjmv48o6RFyfbGDnS6DeEXZfk5ZfuBhdPb9I87ECNMh1EFJKIU6agWzaa01NbmLkxznSmmObJBkkUxrERf3i+ftRiZi7ShPCYY64UhTx1AR5CDYoMXkOKEY7GmTcTzeD/FiER68DfSLgSRqEIBoB3P8h3x8RZhBXGJGusJdD6rfCBl0YqvZNkrV9zej2cWlfJWG6fRpyM41qYH+GTPPi2yFLQYC0Qybm5o96lW77kMbcrBKtgeWTsthVamNXFF4I6x0DTPuugsVRFyYpyxzWqNvHJwed8ws7QyP1UwjNjwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fef6e1}.markdown-body a{text-decoration:none;color:#d8ac5a;border-bottom:1px solid #d8ac5a}.markdown-body a:active,.markdown-body a:hover{color:#93753f;border-color:#93753f}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f4e8c7;border-collapse:collapse}.markdown-body thead{background:rgba(255,227,176,.6588235294);text-align:left;display:table-header-group;border-bottom:1px solid rgba(255,227,176,.6588235294)}.markdown-body tbody{background:rgba(255,247,229,.3882352941)}.markdown-body td,.markdown-body th{padding:7px;line-height:24px;min-width:100px}.markdown-body blockquote{color:#bd954f;padding:1px 23px;margin:22px 0;border-left:4px solid #dcb267;background-color:#fff7e5}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol .task-list-item,.markdown-body ul .task-list-item{list-style:none}.markdown-body ol li{padding-left:6px}.markdown-body::marker{color:#dcb267}.markdown-body .contains-task-list{padding-left:0}.markdown-body .contains-task-list .task-list-item{list-style:none;position:relative}.markdown-body .contains-task-list .task-list-item input[type=checkbox]{position:relative;top:2px}.markdown-body .contains-task-list .task-list-item input[type=checkbox]:before{content:"";display:inline-block;height:12px;width:12px;position:absolute;left:-2px;top:-2px;border:2px solid #cda152;border-radius:5px}.markdown-body .contains-task-list .task-list-item input[type=checkbox]:checked{position:relative;top:2px}.markdown-body .contains-task-list .task-list-item input[type=checkbox]:checked:before{border:none;content:"";display:inline-block;height:17px;width:17px;position:absolute;left:-2px;top:-2px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAFo9M/3AAAAAXNSR0IArs4c6QAAAYhJREFUOBFjYACC0/MDGsDEiyvr/zOCeUwMJxn/A8HZRUEMYBFGJsZ6kFoQYALiAyAGCgDpA+sFijKeWRj4H1kWpIWBW1SDQcm+BCzOAiK/vr7BcO/gDbAAI4hE1waWgRBnmWCGIwkyKFjnwow0BhsJk9QLncvw5dV1oPE9MCEGmBWrgCKhcFEowyR+PSNYwemFAZ4M/xjMkRWYJm5oAPFB/joDpI1BHHQANgGPDxj+//vfCA4IdJ3GcevgQnAFhlHLwYIgSVA0wABcwY3tFQzokiBFGIEP0wmigW5wZAK5FFkQib0a6NUDcEmgb7AGFpIGZOZqoMFhIAFQknEAJpn9yLLEssFOBCp2IFaDkl0xg6C8FbJyB3gowUS5RdQYBORQYpVB1iwVHIIMwJh///AYTCmYRklNIBFmNi4GeYt0BhnjeIa3dw8wSBlEgDUhxw2yCRgGfHp2geHiqiSwUwUVrFAiFVkjjA1LrjgTHEwhFvosMCZM4NEIUoAtWWNoBGZ70/gN22HiAD2uhAzsYNBZAAAAAElFTkSuQmCC) 0 0 no-repeat;background-size:100%}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>引言</strong><br/>
编写条件判断语句是每位程序员的基本功。但你是否想过，如何写出一行<strong>可读性高</strong>、<strong>性能优</strong>、<strong>无隐患</strong>的<code>if</code>代码？今天，我将结合《跟着娟子姐学Python》的学习，与大家深入探讨Python中的选择结构，并分享一些进阶写法和避坑指南。</p>
</blockquote>
<h3 data-id="heading-0">一、单分支if：简洁与陷阱</h3>
<p>单分支结构是最基础的逻辑。但初学者容易在布尔值判断上出错。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 推荐写法：逻辑清晰</span>
<span class="hljs-keyword">if</span> is_logged_in:
    do_something()
<span class="hljs-comment"># 不推荐的写法：多余的==True</span>
<span class="hljs-keyword">if</span> is_logged_in == <span class="hljs-literal">True</span>:
    do_something()
</code></pre>
<p><strong>进阶点：对象布尔值的巧妙利用</strong></p>
<p>在示例4-2中，我们可以利用非0数值、非空序列的布尔值为<code>True</code>这一特性，写出非常简洁的代码：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 利用 not 判断偶数</span>
<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> n % <span class="hljs-number">2</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{n}</span>是偶数"</span>)
<span class="hljs-comment"># 利用本身判断非空字符串</span>
<span class="hljs-keyword">if</span> input_str:  <span class="hljs-comment"># 如果input_str不是空字符串</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"用户输入了内容"</span>)
</code></pre>
<h3 data-id="heading-1">二、双分支if-else：避免深嵌套</h3>
<p>双分支结构非常常见。但一个经常被忽视的问题是如何避免代码中的**“箭头形”嵌套**（Arrow-shaped code）。</p>
<p><strong>【示例】糟糕的嵌套 vs 优雅的卫语句</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 🚫 不推荐：嵌套过深，可读性差</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">process_data</span>(<span class="hljs-params">data</span>):
    <span class="hljs-keyword">if</span> data:
        <span class="hljs-keyword">if</span> validate(data):
            <span class="hljs-keyword">if</span> process(data):
                <span class="hljs-keyword">return</span> <span class="hljs-string">"处理成功"</span>
            <span class="hljs-keyword">else</span>:
                <span class="hljs-keyword">return</span> <span class="hljs-string">"处理失败"</span>
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-string">"数据校验失败"</span>
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">"数据为空"</span>
<span class="hljs-comment"># ✅ 推荐：使用卫语句提前返回/异常，结构扁平</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">process_data</span>(<span class="hljs-params">data</span>):
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> data:
        <span class="hljs-keyword">return</span> <span class="hljs-string">"数据为空"</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> validate(data):
        <span class="hljs-keyword">return</span> <span class="hljs-string">"数据校验失败"</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> process(data):
        <span class="hljs-keyword">return</span> <span class="hljs-string">"处理失败"</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"处理成功"</span>
</code></pre>
<blockquote>
<p><strong>【解释】</strong> 这种将异常或失败条件前置的写法，叫“卫语句”，能极大提高代码的可维护性。</p>
</blockquote>
<h3 data-id="heading-2">三、多分支if-elif-else：选择最佳结构</h3>
<p>当需要处理多种条件时，<code>if-elif-else</code> 是不二之选。但需要注意的是，<strong>Python中的<code>elif</code>是有顺序性的，且一旦命中就会短路后续判断</strong>。</p>
<p><strong>【示例4-4】成绩划分的优化</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># ✅ 最佳实践：从上往下写，互斥区间</span>
score = <span class="hljs-number">85</span>
<span class="hljs-keyword">if</span> score &lt; <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> score &gt; <span class="hljs-number">100</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'无效成绩'</span>)
<span class="hljs-keyword">elif</span> score &lt; <span class="hljs-number">60</span>:      <span class="hljs-comment"># 0 &lt;= score &lt; 60</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'E'</span>)
<span class="hljs-keyword">elif</span> score &lt; <span class="hljs-number">70</span>:      <span class="hljs-comment"># 60 &lt;= score &lt; 70</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'D'</span>)
<span class="hljs-keyword">elif</span> score &lt; <span class="hljs-number">80</span>:      <span class="hljs-comment"># 70 &lt;= score &lt; 80</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'C'</span>)
<span class="hljs-keyword">elif</span> score &lt; <span class="hljs-number">90</span>:      <span class="hljs-comment"># 80 &lt;= score &lt; 90</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'B'</span>)
<span class="hljs-keyword">else</span>:               <span class="hljs-comment"># 90 &lt;= score &lt;= 100</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'A'</span>)
</code></pre>
<blockquote>
<p><strong>【注意】</strong> 多个条件区间必须<strong>无重叠且覆盖全集</strong>，否则会产生逻辑漏洞。</p>
</blockquote>
<h3 data-id="heading-3">四、逻辑运算符：and、or的执行顺序与优先级</h3>
<p>在使用<code>and</code>和<code>or</code>组合复杂条件时，必须明确<strong>运算符优先级</strong>：<code>not</code> &gt; <code>and</code> &gt; <code>or</code>。</p>
<p><strong>【示例】优先级陷阱</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 🚫 容易产生歧义的写法</span>
<span class="hljs-keyword">if</span> x &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> y &lt; <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> z &gt; <span class="hljs-number">10</span>:
    <span class="hljs-keyword">pass</span>
<span class="hljs-comment"># ✅ 强调优先级的写法</span>
<span class="hljs-keyword">if</span> (x &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> y &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">or</span> (z &gt; <span class="hljs-number">10</span>):
    <span class="hljs-keyword">pass</span>
<span class="hljs-comment"># 🚀 更好的写法：一行代码解决，可读性更高</span>
<span class="hljs-keyword">if</span> <span class="hljs-built_in">any</span>([x &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> y &lt; <span class="hljs-number">0</span>, z &gt; <span class="hljs-number">10</span>]):
    <span class="hljs-keyword">pass</span>
</code></pre>
<blockquote>
<p><strong>【思考】</strong> 使用内置函数 <code>any()</code> 和 <code>all()</code> 可以将复杂的逻辑组合转化为更函数式的写法，非常Pythonic。</p>
</blockquote>
<h3 data-id="heading-4">五、实战心得：编写健壮的条件判断逻辑</h3>
<ol>
<li><strong>使用枚举代替魔法值</strong>：在<code>if</code>中直接比较<code>status == 1</code>和<code>status == 2</code>是糟糕的实践。定义一个<code>Status</code>枚举，用<code>Status.SUCCESS</code>替代<code>1</code>。</li>
<li><strong>避免重复计算</strong>：如果判断条件中有函数调用，如 <code>if is_valid(data) and compute(data):</code>，<code>compute(data)</code> 无论如何都会执行。更好的方式是：
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">if</span> is_valid(data):
    <span class="hljs-keyword">if</span> compute(data):
        <span class="hljs-comment"># ...</span>
</code></pre>
</li>
<li><strong>善用字典分发</strong>：当<code>if-elif</code>链过长，且每个分支执行的操作类似（只是参数不同）时，可以考虑用字典替代。
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 🚫 if-elif链</span>
<span class="hljs-keyword">if</span> cmd == <span class="hljs-string">'start'</span>:
    handle_start()
<span class="hljs-keyword">elif</span> cmd == <span class="hljs-string">'stop'</span>:
    handle_stop()
<span class="hljs-comment"># ...</span>

<span class="hljs-comment"># ✅ 字典分发</span>
handlers = {<span class="hljs-string">'start'</span>: handle_start, <span class="hljs-string">'stop'</span>: handle_stop}
<span class="hljs-keyword">if</span> cmd <span class="hljs-keyword">in</span> handlers:
    handlers[cmd]()
</code></pre>
</li>
</ol>
<h3 data-id="heading-5">总结</h3>
<p>选择结构是程序逻辑的基石。掌握其基础用法是开始，但写出<strong>清晰、健壮、Pythonic</strong>的条件判断代码，才是高级程序员的追求。希望本篇文章的进阶视角能给你带来一些启发！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[数据翻译官凭啥高效？嵌入式 NanoPb 揭晓]]></title>    <link>https://juejin.cn/post/7592622563547250723</link>    <guid>https://juejin.cn/post/7592622563547250723</guid>    <pubDate>2026-01-08T13:56:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592622563547250723" data-draft-id="7592622563547037731" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="数据翻译官凭啥高效？嵌入式 NanoPb 揭晓"/> <meta itemprop="keywords" content="嵌入式,物联网,单片机"/> <meta itemprop="datePublished" content="2026-01-08T13:56:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="迷人的星空"/> <meta itemprop="url" content="https://juejin.cn/user/977890073916588"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            数据翻译官凭啥高效？嵌入式 NanoPb 揭晓
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/977890073916588/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    迷人的星空
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T13:56:14.000Z" title="Thu Jan 08 2026 13:56:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0"><strong>一、它到底是什么</strong></h3>
<p>嵌入式NanoPb是一个专为<strong>单片机、物联网终端等资源受限设备</strong>量身定制的“<strong>数据翻译官</strong>”和“<strong>协议制定器</strong>”。它的核心任务，是把设备内部复杂的、结构化的数据（比如传感器的温度、时间、状态），用一种<strong>极度紧凑、高效且不挑硬件的二进制语言</strong>打包、传输，并能让接收方准确无误地理解。</p>
<p>你可以把它想象成：</p>
<ul>
<li><strong>为“小货车”设计的“标准化货箱”</strong> ：相比用大小不一的“纸箱”（自定义格式）或塞满泡沫的“大箱子”（JSON/XML），它提供了最适合小货车运输的、严丝合缝的集装箱。</li>
<li><strong>设备间的“摩尔斯电码”</strong> ：它制定了一套非常简洁高效的编码规则，让设备之间可以用最少的“滴答”声（数据字节）传达丰富、准确的信息。</li>
</ul>
<h3 data-id="heading-1"><strong>二、它是如何工作的？</strong></h3>
<p>其工作原理可以概括为  <strong>“一套工具，两次转换”</strong>  。它不是在单片机上现场翻译，而是先在功能强大的PC上<strong>生成一套专用的“翻译手册”</strong> ，然后让单片机照着手册机械地执行。</p>
<p><strong>第一步：制定“数据契约”（.proto文件）</strong><br/>
工程师在电脑上用一种叫 <strong>Protocol Buffers</strong> 的语言，定义一个 <code>.proto</code> 文件。这个文件不包含任何具体数据，只定义<strong>数据的结构</strong>，是所有参与方必须遵守的“契约”。</p>
<pre><code class="hljs language-ini" lang="ini">// 示例：定义一个传感器数据的“契约”
<span class="hljs-attr">syntax</span> = <span class="hljs-string">"proto2"</span><span class="hljs-comment">; // 使用proto2版本，控制更精细</span>
message SensorData {
    required uint32 <span class="hljs-attr">timestamp</span> = <span class="hljs-number">1</span><span class="hljs-comment">;  // 必填字段，编号为1</span>
    required float <span class="hljs-attr">temperature</span> = <span class="hljs-number">2</span><span class="hljs-comment">; // 必填字段，编号为2</span>
    optional float <span class="hljs-attr">humidity</span> = <span class="hljs-number">3</span><span class="hljs-comment">;    // 可选字段，编号为3</span>
    repeated int32 <span class="hljs-attr">samples</span> = <span class="hljs-number">4</span> [max_count = <span class="hljs-number">20</span>]<span class="hljs-comment">; // 数组，最大长度20</span>
}
</code></pre>
<p><strong>关键</strong>：这里的字段编号（1，2，3，4）是编码和解码的唯一依据，取代了低效的字段名。</p>
<p><strong>第二步：生成“翻译手册”（C代码）</strong><br/>
使用专用的编译器工具（<code>protoc</code> + NanoPb插件），根据上一步的 <code>.proto</code> 契约，生成纯C代码文件（<code>.pb.c</code> 和 <code>.pb.h</code>）。这个生成的代码就是单片机的“翻译手册”。</p>
<p>生成的头文件中，会包含一个可以直接在C程序中使用的结构体：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 生成的C结构体，与.proto契约一一对应</span>
<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> {
    <span class="hljs-type">uint32_t</span> timestamp;
    <span class="hljs-type">float</span> temperature;
    <span class="hljs-type">bool</span> has_humidity; <span class="hljs-comment">// 标志位，指示humidity字段是否有值</span>
    <span class="hljs-type">float</span> humidity;
    <span class="hljs-type">pb_size_t</span> samples_count; <span class="hljs-comment">// 实际数组长度</span>
    <span class="hljs-type">int32_t</span> samples[<span class="hljs-number">20</span>];     <span class="hljs-comment">// 静态数组，长度由max_count固定</span>
} SensorData;
</code></pre>
<p><strong>第三步：在设备上执行“翻译”</strong></p>
<ol>
<li><strong>编码（发送数据）</strong> ：设备程序中，填充好SensorData结构体，然后调用 <code>pb_encode()</code> 函数。该函数会像一台高效的打包机，严格按照“翻译手册”，将结构体中的每个字段转换成极简的二进制序列，放入你指定的发送缓冲区。</li>
<li><strong>解码（接收数据）</strong> ：从通信接口（如UART）收到一串二进制数据后，调用 <code>pb_decode()</code> 函数。该函数会按照同一份“手册”，将二进制流精准地还原填充到另一个SensorData结构体中，供程序使用。</li>
</ol>
<p><strong>高效的核心秘密</strong>：它采用了  <strong>“标签-长度-值”</strong>  和  <strong>“变长整数”</strong>  两大编码技术。</p>
<ul>
<li><strong>标签</strong>：用字段编号代替字段名。</li>
<li><strong>变长整数</strong>：对于较小的数字，只用1个字节存储；大的数字才用更多字节。这使得像 <code>timestamp</code> 这样的数据在大部分情况下体积都远小于固定的4字节。</li>
</ul>
<h3 data-id="heading-2"><strong>三、为什么选择它？</strong></h3>
<ol>
<li><strong>极致的空间效率</strong>：编码后的数据体积通常只有JSON的 <strong>1/3甚至更小</strong>，这对于按字节计费的NB-IoT、LoRa等低带宽网络至关重要，能直接<strong>降低功耗、延长电池寿命</strong>。</li>
<li><strong>确定性的内存使用</strong>：默认模式下，<strong>不使用任何动态内存分配（malloc）</strong> 。所有内存（如数组 <code>samples[20]</code>）都在编译时确定，避免了内存碎片和泄漏，这对嵌入式系统的稳定性和可靠性是生命线。</li>
<li><strong>无歧义的协议契约</strong>：<code>.proto</code> 文件是设备端和服务器/手机端<strong>唯一、权威的协议文档</strong>。双方基于同一份文件生成代码，彻底消除了因手写文档不一致导致的通信故障。</li>
<li><strong>强大的向前/向后兼容性</strong>：只要遵循“新增字段用optional/repeated，永不重用字段号”的规则，新版本的程序可以读取旧版本的数据（忽略新字段），旧版本的程序也能读取新版本的数据（忽略不认识的字段），为固件升级带来巨大便利。</li>
</ol>
<h3 data-id="heading-3"><strong>四、它的天生“短板”</strong></h3>
<p>没有任何技术是银弹，NanoPb的强大伴随着明确的代价和约束：</p>
<ul>
<li>
<p><strong>增加构建复杂度</strong>：必须在PC上配置工具链（<code>protoc</code>编译器），并集成代码生成步骤到项目的构建系统（如Makefile, CMake）中。这增加了初始的学习和搭建成本。</p>
</li>
<li>
<p><strong>需要预规划内存</strong>：所有数组（<code>repeated</code>字段）的长度<strong>最好在编译时就确定上限</strong>（通过 <code>max_count</code>）。处理长度完全未知的动态数据会变得复杂（需用回调函数，可能引入动态分配）。</p>
</li>
<li>
<p><strong>不负责“运输”</strong> ：NanoPb只负责把“货物”（数据）打包成“集装箱”（二进制流），<strong>不负责</strong>集装箱的“装船”（添加帧头帧尾）、“运输保障”（CRC校验、重传）和“卸货”（从流中分割出完整数据包）。这些通信层的职责，必须由开发者额外完成。</p>
</li>
<li>
<p><strong>二进制不直观</strong>：编码后的数据人类无法直接阅读，调试时必须借助额外的十六进制查看工具或解码程序。</p>
</li>
<li>
<p><strong>严谨的跨平台细节</strong>：</p>
<ul>
<li><strong>浮点数陷阱</strong>：直接内存拷贝编码，要求通信双方的CPU使用<strong>相同的浮点数格式（通常是IEEE 754）和字节序</strong>，否则会解码出错误数值。</li>
<li><strong>默认值陷阱</strong>：解码时，如果发送方没给某个 <code>optional</code> 字段赋值，接收方结构体里该字段的值是<strong>未初始化的内存残留</strong>！必须通过配套生成的 <code>has_xxx</code> 布尔标志来判断该字段是否有效。</li>
<li><strong>内存对齐陷阱</strong>：绝对不能把C结构体直接 <code>memcpy</code> 发送！结构体中有内存对齐的“填充字节”，而 <code>pb_encode</code> 生成的二进制流是紧密无填充的。直接拷贝结构体会导致通信失败。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-4"><strong>五、典型应用场景</strong></h3>
<p>NanoPb的价值在以下场景中最为凸显：</p>
<ol>
<li><strong>电池供电的物联网传感终端</strong>：例如，每5分钟通过NB-IoT上报一次数据的温湿度计。将数据包从JSON的50字节压缩至15字节，能显著减少无线模块发射时长，是<strong>提升设备续航（有时可达数倍）的关键手段</strong>。</li>
<li><strong>嵌入式设备间的可靠通信</strong>：在通过UART、CAN或I2C连接的主控板与多个功能模块之间，使用NanoPb定义清晰、可扩展的指令与数据协议，比脆弱的自定义格式更健壮，且易于迭代。</li>
<li><strong>固件无线升级</strong>：用于传输升级包的“元数据”（如版本号、大小、CRC、分区地址）。其紧凑性和版本兼容性，非常适合在带宽有限且要求可靠的OTA过程中作为控制协议。</li>
<li><strong>设备配置参数存储</strong>：将设备的数百个可调参数定义为一个 <code>message</code>，存储到Flash中。升级固件后，旧参数文件仍能被安全读取（新加的参数取默认值），实现配置的平滑迁移。</li>
</ol>
<h3 data-id="heading-5"><strong>六、总结</strong></h3>
<p>总而言之，嵌入式NanoPb是一个典型的  <strong>“以工具链和设计时的复杂性，换取运行时极致效率和长期可维护性”</strong>  的工程解决方案。</p>
<ul>
<li>
<p><strong>何时应该积极采用？</strong></p>
<ul>
<li>你的设备<strong>对通信带宽、功耗有严苛限制</strong>。</li>
<li>你的数据协议<strong>结构复杂且未来很可能需要增减字段</strong>。</li>
<li>你的项目涉及<strong>多平台（设备、手机、云）数据交换</strong>，需要一份无歧义的协议核心。</li>
<li>你的团队有能力<strong>搭建并维护包含代码生成的自动化构建流程</strong>。</li>
</ul>
</li>
<li>
<p><strong>何时应该谨慎或避免？</strong></p>
<ul>
<li>你的数据<strong>极其简单且永不变更</strong>（例如永远只发两个整数），直接打包发送更简单。</li>
<li>你的设备<strong>RAM/ROM资源紧张到无法容纳额外的5-10KB代码体积</strong>。</li>
<li>你的项目<strong>开发周期极短，且没有后续维护需求</strong>，快速实现是第一要务。</li>
</ul>
</li>
</ul>
<p>对于大多数严肃的、有长期维护预期的嵌入式产品或物联网项目，NanoPb带来的协议严谨性、带宽节省和兼容性保障，其长远收益远超过初期引入的学习和构建成本。它是将嵌入式通信从“手工作坊”升级到“现代工程”的重要工具之一。</p>
<p>以上是个人的一些浅见，如有不当之处，欢迎批评指正。</p>
<p>这波内容真帮到你了？点个关注不迷路！专属工具箱持续更新，需要时直接翻、拿起来就用～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大数据-207 如何应对多重共线性：使用线性回归中的最小二乘法时常见问题与解决方案]]></title>    <link>https://juejin.cn/post/7592876744526446642</link>    <guid>https://juejin.cn/post/7592876744526446642</guid>    <pubDate>2026-01-09T01:55:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592876744526446642" data-draft-id="7592876744526430258" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大数据-207 如何应对多重共线性：使用线性回归中的最小二乘法时常见问题与解决方案"/> <meta itemprop="keywords" content="后端,大数据,机器学习"/> <meta itemprop="datePublished" content="2026-01-09T01:55:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="武子康"/> <meta itemprop="url" content="https://juejin.cn/user/149189314230039"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大数据-207 如何应对多重共线性：使用线性回归中的最小二乘法时常见问题与解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/149189314230039/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    武子康
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T01:55:52.000Z" title="Fri Jan 09 2026 01:55:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">TL;DR</h2>
<p>在使用最小二乘法求解线性回归时，多重共线性会影响模型稳定性，导致系数估计不可靠。解决方法包括使用正则化技术（如岭回归、Lasso回归）。通过引入正则化项，可以有效避免矩阵不可逆问题，稳定回归结果。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee1b2ef0a4ef4abba0a1f6cb88163ff6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768528552&amp;x-signature=ZPkSpHRESzIihnHu5QTU82ZJMus%3D" alt="大数据-207 如何应对多重共线性：使用线性回归中的最小二乘法时常见问题与解决方案" loading="lazy"/></p>
<h2 data-id="heading-1">版本矩阵</h2>






























<table><thead><tr><th>功能</th><th>scikit-learn 版本</th><th>说明</th></tr></thead><tbody><tr><td>线性回归</td><td>0.24+</td><td>支持标准的线性回归模型训练与评估</td></tr><tr><td>多重共线性处理</td><td>0.24+</td><td>通过岭回归、Lasso回归等方法解决共线性问题</td></tr><tr><td>MSE计算</td><td>0.24+</td><td>使用 mean_squared_error 计算模型误差</td></tr><tr><td>R²计算</td><td>0.24+</td><td>使用 r2_score 评估模型拟合度</td></tr></tbody></table>
<h2 data-id="heading-2">代码实现</h2>
<p>使用 scikit-learn 算法库实现线性回归算法，并计算相应评价指标。回顾前文介绍的相关知识进行下述计算。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> sklearn.linear_model <span class="hljs-keyword">import</span> LinearRegression
reg = LinearRegression()
reg.fit(data.iloc[:,:-<span class="hljs-number">1</span>].values,data.iloc[:,-<span class="hljs-number">1</span>].values)
reg.coef_ <span class="hljs-comment"># 查看方程系数</span>
reg.intercept_ <span class="hljs-comment"># 查看系数</span>
</code></pre>
<p>对比手动计算的 ws，其结果高度一致。
然后计算模型 MSE 和判别系数：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> mean_squared_error,r2_score
yhat = reg.predict(data.iloc[:,:-<span class="hljs-number">1</span>])
mean_squared_error(y,yhat)
r2_score(y,yhat)
</code></pre>
<h2 data-id="heading-3">多重共线性</h2>
<p>虽然在线性回归求解过程中，通过借助最小二乘法能够迅速找到全域最优解，但最小二乘法本身的使用条件较为苛刻。这种方法要求设计矩阵X必须满足严格的条件才能保证解的稳定性和唯一性。</p>
<p>具体来说，最小二乘法的应用必须满足以下关键条件：</p>
<ol>
<li>矩阵X^TX必须是满秩矩阵（即行列式不为零）</li>
<li>矩阵X^TX必须可逆或存在广义逆矩阵</li>
</ol>
<p>在实际应用中，经常会遇到以下导致最小二乘法失效的情况：</p>
<ul>
<li>当样本量n小于特征数p时（n&lt;p），矩阵X^TX必然是奇异矩阵</li>
<li>当X的各列存在严格或近似的线性相关关系时（即多重共线性问题）</li>
<li>当数据中存在高度相关的特征变量时</li>
</ul>
<p>特别是当遇到多重共线性问题时，最小二乘法的求解会面临以下挑战：</p>
<ol>
<li>参数估计值变得极不稳定，小的数据扰动可能导致估计值发生巨大变化</li>
<li>参数估计的方差会异常增大</li>
<li>解可能不唯一，存在无穷多解的情况</li>
</ol>
<p>例如，在经济学数据分析中，当使用GDP、居民收入和消费支出等多个高度相关的指标作为预测变量时，就很容易出现上述问题。此时传统的OLS（普通最小二乘）估计将无法给出可靠的结果。</p>
<p>针对这些问题，统计学家们发展出了多种改进方法，包括：</p>
<ul>
<li>岭回归（Ridge Regression）</li>
<li>Lasso回归</li>
<li>主成分回归（PCR）</li>
<li>偏最小二乘回归（PLSR）</li>
</ul>
<p>这些方法通过引入正则化项或降维技术，可以有效处理矩阵不可逆和多重共线性问题，从而获得更稳定可靠的回归结果。</p>
<p>这里需要注意是，在进行数据采集的过程中，数据集各列是对同一个客观事物进行客观描述，很难避免多重共线性的存在，因此存在共线性是很多数据集的一般情况。当然更为极端的情况则是数据集的列比行多，此时最小二乘法无法对其进行求解。因此，寻找性回归算法的优化方案势在必行。
首先我们来了解多重共性，在第二节中我们曾推导了多元线性回归使用最小二乘法的求解原理，我们对多元线性回归的损失函数求导，并得出求解系数 w 得式子和过程：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc86aef3df53474eb612606dfc0e6a34~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768528552&amp;x-signature=SMl37ydX6%2Bo8COTnipTzIXSOduI%3D" alt="多重共线性" loading="lazy"/>
在最后一步中我们需要左乘 XTX 的逆矩阵，而矩阵存在得充分必要条件是特征不存在多重共线性。</p>
<h3 data-id="heading-4">矩阵存在的充分必要条件</h3>
<p>首先，我们需要先理解逆矩阵存在与否的意义和影响，一个矩阵什么情况下会有逆矩阵？
根据逆矩阵的定理，若 |A| != 0，则矩阵A 可逆，且：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/25208597f65344f498bcfcf2cb9622ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768528552&amp;x-signature=GJpmKDFqlEqQl7PPYOTZhO9HqOI%3D" alt="矩阵存在的充分必要条件" loading="lazy"/></p>
<p>其中 A* 是矩阵 A 的伴随矩阵，任何矩阵都可以有伴随矩阵，因此这一部分不影响逆矩阵的存在性，而分母上行列式｜A｜就不同了，位于分母变量不能为 0，一旦为 0 则无法计算出逆矩阵。因此逆矩阵存在的充分必要条件是：矩阵的行列式不能为 0，对于线性回归而言，即是说｜XTX｜不能为 0，这是使用最小二乘法求解线性回归的核心条件之一。</p>
<h3 data-id="heading-5">行列式不为 0 的充分必要条件</h3>
<p>那行列式不为 0，需要满足什么条件？在这里，我们复习一下线性代数中的基本知识，假设我们的特征矩阵 X结构为（m,n），则 XTX 就是结构为（n,m）的矩阵，从而得到结果为（n,n）的矩阵。</p>
<p>因此以下所有的例子都将以方矩阵进行举例，方便大家理解，首先区别一下矩阵和行列式：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e28d55cdc2514a7489125f3d1c48a2a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768528552&amp;x-signature=wRYi81mHSN3JFtC8zoEy7hjmFec%3D" alt="行列式不为 0 的充分必要条件" loading="lazy"/></p>
<p>任何矩阵都可以有行列式，以一个 3*3 的行列式为例，我们来看看行列式如何计算的？
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e0e64a8b362400e95b5f73b1592c047~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768528552&amp;x-signature=RPSC%2BScIG57Gyvn9UpapgDT10ag%3D" alt="行列式不为 0 的充分必要条件" loading="lazy"/>
这个式子乍一看非常混乱，其实并非如此，我们把行列式按照下面的方式排列一下，很容易就看出这个式子实际上怎么回事了：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a9ce5577193b45fbbb065490933059b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768528552&amp;x-signature=%2FbnEDPfWez87EqxR1pzIyBY0EF4%3D" alt="行列式不为 0 的充分必要条件" loading="lazy"/>
三个特征的特征矩阵的行列式就有六个交互项，在现实中我们特征矩阵不可能是如此低维度数据，因此使用这样的方式计算就变得异常困难。在线性代数中，我们可以通过行列式的计算将一个行列式整合成一个梯形的行列式：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a223788064a4f999911a234950d73eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768528552&amp;x-signature=aEWgHitzeCsM5crDApe%2BkD%2FxLtQ%3D" alt="行列式不为 0 的充分必要条件" loading="lazy"/>
梯形的行列式表现为，所有的数字都被整合到对角线的上方或下方（通常是上方），虽然具体的数字发生了变化（比如由 x11 变成了 a11），但是行列式的大小在初等行变换的过程中是不变的，对于梯形行列式，行列式的计算要容易的多：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21dc357d85cf42e49024b3b9b9205ece~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768528552&amp;x-signature=3F6tST6zsPG%2Fh9aPbVtuh82VZNg%3D" alt="行列式不为 0 的充分必要条件" loading="lazy"/>
不难发现，由于梯形行列式下半部分为 0，整个矩阵的行列式其实就是梯形行列式对角线上的元素相乘。并且此时时刻，只要对角线上的任意元素为 0，整个行列式都会为 0，那只要对角线上没有一个元素为 0，行列式就不会为 0。在这里我们映入一个重要的概念：满秩矩阵。</p>
<h3 data-id="heading-6">矩阵满秩的充分必要条件</h3>
<p>一个矩阵要满秩，则转换为梯形矩阵后的对角线上没有 0，那什么样的矩阵在对角线上没有 0？来看下面的三个矩阵：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/91cb6ac683874dcc9554f0e1feb1d122~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768528552&amp;x-signature=otwxhffWqpi384Q9D8QZCqq5K1E%3D" alt="矩阵满秩的充分必要条件" loading="lazy"/>
我们可以对矩阵做初等行变换和列变换，包括交换行/列顺序，将一列/一行乘以用一个常数后加减到另一个一列/一行上，来将矩阵化为梯形矩阵，对于上面的两个矩阵我们可以有如下变换：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/624037b7aabc4805b52f1d072f4ecb07~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768528552&amp;x-signature=LNc8ehvaXnWD%2Bmmw9aL9iogEtyk%3D" alt="矩阵满秩的充分必要条件" loading="lazy"/>
继续进行变换：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f44774174a74c5d95132cc8bffe88ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768528552&amp;x-signature=uwRuRSKdEu27aacjnThz0CDycp0%3D" alt="矩阵满秩的充分必要条件" loading="lazy"/>
如此就转换成了梯形矩阵，我们可以看到，矩阵 A 明显不是满秩的，它有全零行所以行列式会为 0，而矩阵 B 和 C 没有全零行所以满秩。
而矩阵 A 和矩阵 B 的区别在于，A 中存在完全具有线性关系的两行（1,1,2 和 2,2,4），而 B 和 C 中则没有这样的两行。
而矩阵 B 虽然对角线上每个元素都不为 0，但具有非常接近于 0 的元素 0.02，而矩阵 C 的对角线上没有任何元素特别接近于 0。</p>
<p>矩阵 A 中第一行和第三行的关系，被称为：精确相关关系，即完全相关，一行可使另一行为 0，在这种精确相关关系下，矩阵 A 的行列式为 0，则矩阵 A 的逆不可能存在。在我们的最小二乘法中，如果矩阵 XTX 中存在这种精确相关关系，则逆不存在，最小二乘法完全无法使用，线性回归会无法求出结果。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e55a47b76baa4a31ac6327f7e8771f3a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768528552&amp;x-signature=HG%2BHGDUSsINN7V%2F17h9piEZtN6Q%3D" alt="矩阵 A" loading="lazy"/>
矩阵 B 中第一行和第三行的关系不太一样，他们之间非常接近于精确相关关系，但又不是完全相关，一行不能使领一行为 0，这种关系被称为 高度相关关系。这种高度相关关系下，矩阵的行列式不为 0，但是一个非常接近 0 数，矩阵 A 的逆存在，不过接近于无限大。在这种情况下，最小二乘法可以使用，不过得到的逆会很大，直接影响我们对参数向量 w 的求解：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/64d0c658b5e846f0b938a3586e54bff6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768528552&amp;x-signature=J6p7rBBnbGZrFTI9l%2BJPWyD292o%3D" alt="矩阵 B" loading="lazy"/>
这样求解出来的参数向量 w 会很大，因此会影响建模的结果，造成模型有偏差或者不可用。精确相关关系和高度相关关系并称为多重共线性。在多重共线性下，模型无法建立，或者模型不可用。
相对的，矩阵 C 的行之间结果相互独立，梯形矩阵看起来非常正常，它的对角线上没有任何元素特别接近于 0，因此其行列式也就不会接近0 或者为 0，因此矩阵 C 得出的参数向量 w 就不会有太大的偏差，对于我们拟合而言是比较理想的。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f6e97ce1c96496497c37f1da74465aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768528552&amp;x-signature=uwvSzX6mWYVBrzztfbcmSYErr%2B8%3D" alt="参数向量" loading="lazy"/>
从上面的所有过程我们可以看得出来，一个矩阵如果要满秩，则要求矩阵中每个向量之间不能存在多重共线性，这也构成了线性回归算法对于特征矩阵的要求。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3fa915b8edf14ff68ab4c06637657047~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768528552&amp;x-signature=f2k%2FMcr7gEFcpH4%2FA4IgPV%2BNrWU%3D" alt="参数向量" loading="lazy"/></p>
<h2 data-id="heading-7">错误速查</h2>



































<table><thead><tr><th>症状</th><th>根因</th><th>定位</th><th>修复</th></tr></thead><tbody><tr><td>模型参数估计不稳定</td><td>数据中存在多重共线性，导致设计矩阵 X^T X 不可逆</td><td>检查特征变量之间是否存在线性相关关系</td><td>使用岭回归、Lasso回归等正则化方法来稳定解</td></tr><tr><td>模型方差过大</td><td>矩阵 X^T X 近似奇异或共线性问题</td><td>查看矩阵的行列式，确认是否接近零</td><td>引入正则化项，如岭回归，来减少参数方差</td></tr><tr><td>预测结果误差较大</td><td>多重共线性导致解的不唯一性</td><td>确认特征变量是否高度相关，尤其是输入数据集</td><td>使用主成分回归（PCR）或偏最小二乘回归（PLSR）</td></tr><tr><td>解不唯一</td><td>矩阵 X^T X 为奇异矩阵，无法求逆</td><td>检查输入数据集的特征数是否大于样本数（n&lt;p）</td><td>减少特征数，或使用正则化方法来规避该问题</td></tr></tbody></table>
<h2 data-id="heading-8">其他系列</h2>
<h3 data-id="heading-9">🚀 AI篇持续更新中（长期更新）</h3>
<p><strong>AI炼丹日志-29 - 字节跳动 DeerFlow 深度研究框<em>斜体样式</em>架 私有部署 测试上手 架构研究</strong>，持续打造实用AI工具指南！
<strong>AI研究-132 Java 生态前沿 2025：Spring、Quarkus、GraalVM、CRaC 与云原生落地</strong></p>
<h3 data-id="heading-10">💻 Java篇持续更新中（长期更新）</h3>
<p><strong>Java-218 RocketMQ Java API 实战：同步/异步 Producer 与 Pull/Push Consumer</strong>
MyBatis 已完结，Spring 已完结，Nginx已完结，Tomcat已完结，分布式服务已完结，Dubbo已完结，MySQL已完结，MongoDB已完结，Neo4j已完结，FastDFS 已完结，OSS已完结，GuavaCache已完结，EVCache已完结，RabbitMQ已完结，RocketMQ正在更新... 深入浅出助你打牢基础！</p>
<h3 data-id="heading-11">📊 大数据板块已完成多项干货更新（300篇）：</h3>
<p>包括 Hadoop、Hive、Kafka、Flink、ClickHouse、Elasticsearch 等二十余项核心组件，覆盖离线+实时数仓全栈！
<strong>大数据-278 Spark MLib - 基础介绍 机器学习算法 梯度提升树 GBDT案例 详解</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🎥解决前端 “复现难”：rrweb 录制回放从入门到精通（下）]]></title>    <link>https://juejin.cn/post/7592815497848930367</link>    <guid>https://juejin.cn/post/7592815497848930367</guid>    <pubDate>2026-01-09T01:56:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592815497848930367" data-draft-id="7592508079306670099" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🎥解决前端 “复现难”：rrweb 录制回放从入门到精通（下）"/> <meta itemprop="keywords" content="前端,开源,全栈"/> <meta itemprop="datePublished" content="2026-01-09T01:56:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="秋天的一阵风"/> <meta itemprop="url" content="https://juejin.cn/user/3588413946594925"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🎥解决前端 “复现难”：rrweb 录制回放从入门到精通（下）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3588413946594925/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    秋天的一阵风
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T01:56:33.000Z" title="Fri Jan 09 2026 01:56:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong/></p><p align="center"><strong>Hello~大家好。我是秋天的一阵风</strong></p><p/>
<p>rrweb 的核心魅力在于 “用极小的数据量复现完整的页面操作”，这背后是 DOM 快照、增量更新、事件序列化等技术的精密协作。本文将从原理本质出发，用通俗类比 + 源码解析的方式，拆解每个技术模块的实现逻辑，同时揭示 rrweb 在兼容性、性能优化上的关键设计。</p>
<h2 data-id="heading-0">一、 DOM 快照生成原理（snapshot）</h2>
<p><strong>通俗类比</strong>：DOM 快照就像给页面拍 “全景工程图”—— 不是简单记录像素（如截图），而是把页面的 “骨架”（DOM 层级结构）、“皮肤”（CSS 样式）、“零件参数”（元素属性、文本内容）都转化为结构化数据，后续能根据这张 “工程图” 1:1 还原出与原页面一致的初始状态。区别于普通照片，这张 “工程图” 包含所有可编辑的 “零件信息”，而非固定的视觉图像。</p>
<h3 data-id="heading-1">1.1 核心目标与技术路径</h3>
<p>DOM 快照的核心目标是生成 “可序列化、可重建、体积小” 的 DOM 数据，技术路径分为三步：<strong>DOM 遍历与节点过滤</strong>→<strong>节点属性与样式序列化</strong>→<strong>资源引用处理</strong>，最终输出 JSON 格式的FullSnapshot事件（rrweb 事件类型标识为 2）。</p>
<h3 data-id="heading-2">1.2 关键实现逻辑（参考 rrweb-snapshot 源码）</h3>
<p><code>rrweb-snapshot</code> 库的 <code>takeSnapshot</code> 函数是快照生成的核心，关键步骤如下：</p>
<h4 data-id="heading-3">1.2.1 根节点遍历与过滤</h4>
<p>从<code>document.documentElement</code>（HTML 根节点）开始深度优先遍历，跳过无需录制的节点（如script、style标签，或带屏蔽类名的元素），避免无效数据占用空间：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 伪代码：DOM节点遍历逻辑</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">traverseNode</span>(<span class="hljs-params">node, config</span>) {
  <span class="hljs-comment">// 过滤规则：跳过脚本、样式、屏蔽元素、不可见元素</span>
  <span class="hljs-keyword">const</span> isIgnored = 
    node.<span class="hljs-property">tagName</span> === <span class="hljs-string">'SCRIPT'</span> || 
    node.<span class="hljs-property">tagName</span> === <span class="hljs-string">'STYLE'</span> || 
    node.<span class="hljs-property">classList</span>.<span class="hljs-title function_">contains</span>(config.<span class="hljs-property">blockClass</span>) || 
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getComputedStyle</span>(node).<span class="hljs-property">display</span> === <span class="hljs-string">'none'</span>;
  <span class="hljs-keyword">if</span> (isIgnored) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  <span class="hljs-comment">// 序列化当前节点</span>
  <span class="hljs-keyword">const</span> nodeSnapshot = <span class="hljs-title function_">serializeNode</span>(node);
  <span class="hljs-comment">// 递归处理子节点（构建DOM树结构）</span>
  <span class="hljs-keyword">const</span> children = [];
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> child <span class="hljs-keyword">of</span> node.<span class="hljs-property">childNodes</span>) {
    <span class="hljs-keyword">const</span> childSnapshot = <span class="hljs-title function_">traverseNode</span>(child, config);
    <span class="hljs-keyword">if</span> (childSnapshot) children.<span class="hljs-title function_">push</span>(childSnapshot);
  }
  nodeSnapshot.<span class="hljs-property">children</span> = children;
  <span class="hljs-comment">// 内联计算样式（确保回放样式一致）</span>
  <span class="hljs-title function_">inlineComputedStyle</span>(node, nodeSnapshot);
  <span class="hljs-keyword">return</span> nodeSnapshot;
}
</code></pre>
<h4 data-id="heading-4">1.2.2 节点序列化（serializeNode）</h4>
<p>提取节点关键属性，转化为 JSON 结构，重点处理元素节点与文本节点：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 伪代码：节点序列化</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">serializeNode</span>(<span class="hljs-params">node</span>) {
  <span class="hljs-keyword">const</span> snapshot = {
    <span class="hljs-attr">type</span>: node.<span class="hljs-property">nodeType</span>, <span class="hljs-comment">// 1=元素节点，3=文本节点，8=注释节点（跳过）</span>
  };
  <span class="hljs-keyword">if</span> (node.<span class="hljs-property">nodeType</span> === <span class="hljs-number">1</span>) { <span class="hljs-comment">// 元素节点</span>
    snapshot.<span class="hljs-property">tagName</span> = node.<span class="hljs-property">tagName</span>.<span class="hljs-title function_">toLowerCase</span>(); <span class="hljs-comment">// 统一小写（如DIV→div）</span>
    snapshot.<span class="hljs-property">attributes</span> = {};
    <span class="hljs-comment">// 收集核心属性（id、class、src、href等，跳过自定义无关属性）</span>
    <span class="hljs-keyword">const</span> coreAttrs = [<span class="hljs-string">'id'</span>, <span class="hljs-string">'class'</span>, <span class="hljs-string">'src'</span>, <span class="hljs-string">'href'</span>, <span class="hljs-string">'alt'</span>, <span class="hljs-string">'title'</span>, <span class="hljs-string">'value'</span>, <span class="hljs-string">'checked'</span>];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> attr <span class="hljs-keyword">of</span> node.<span class="hljs-property">attributes</span>) {
      <span class="hljs-keyword">if</span> (coreAttrs.<span class="hljs-title function_">includes</span>(attr.<span class="hljs-property">name</span>) || attr.<span class="hljs-property">name</span>.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'data-'</span>)) {
        snapshot.<span class="hljs-property">attributes</span>[attr.<span class="hljs-property">name</span>] = attr.<span class="hljs-property">value</span>;
      }
    }
    <span class="hljs-comment">// 特殊处理表单元素（记录当前值，而非初始值）</span>
    <span class="hljs-keyword">if</span> ([<span class="hljs-string">'INPUT'</span>, <span class="hljs-string">'TEXTAREA'</span>, <span class="hljs-string">'SELECT'</span>].<span class="hljs-title function_">includes</span>(node.<span class="hljs-property">tagName</span>)) {
      snapshot.<span class="hljs-property">value</span> = node.<span class="hljs-property">value</span>;
      snapshot.<span class="hljs-property">checked</span> = node.<span class="hljs-property">checked</span> || <span class="hljs-literal">false</span>;
      snapshot.<span class="hljs-property">selectedIndex</span> = node.<span class="hljs-property">tagName</span> === <span class="hljs-string">'SELECT'</span> ? node.<span class="hljs-property">selectedIndex</span> : -<span class="hljs-number">1</span>;
    }
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (node.<span class="hljs-property">nodeType</span> === <span class="hljs-number">3</span>) { <span class="hljs-comment">// 文本节点</span>
    snapshot.<span class="hljs-property">text</span> = node.<span class="hljs-property">textContent</span>.<span class="hljs-title function_">trim</span>() || <span class="hljs-string">''</span>; <span class="hljs-comment">// 过滤空文本，减少体积</span>
  }
  <span class="hljs-keyword">return</span> snapshot;
}
</code></pre>
<h4 data-id="heading-5">1.2.3 样式收集与内联</h4>
<p>页面样式可能来自link、style或内联style，为避免回放时样式丢失，rrweb 会将<strong>计算样式（computedStyle）</strong> 内联到节点快照中，同时过滤默认样式减少数据量：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 伪代码：样式内联处理</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">inlineComputedStyle</span>(<span class="hljs-params">node, snapshot</span>) {
  <span class="hljs-keyword">const</span> computedStyle = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getComputedStyle</span>(node);
  <span class="hljs-keyword">const</span> styles = {};
  <span class="hljs-comment">// 仅收集影响视觉的关键样式属性（排除默认值）</span>
  <span class="hljs-keyword">const</span> criticalStyles = [
    <span class="hljs-string">'display'</span>, <span class="hljs-string">'position'</span>, <span class="hljs-string">'top'</span>, <span class="hljs-string">'left'</span>, <span class="hljs-string">'width'</span>, <span class="hljs-string">'height'</span>, 
    <span class="hljs-string">'color'</span>, <span class="hljs-string">'background'</span>, <span class="hljs-string">'font-size'</span>, <span class="hljs-string">'border'</span>, <span class="hljs-string">'padding'</span>, <span class="hljs-string">'margin'</span>
  ];
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> prop <span class="hljs-keyword">of</span> criticalStyles) {
    <span class="hljs-keyword">const</span> value = computedStyle.<span class="hljs-title function_">getPropertyValue</span>(prop);
    <span class="hljs-comment">// 过滤默认样式（如div的display:block、body的margin:8px）</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isDefaultStyle</span>(snapshot.<span class="hljs-property">tagName</span>, prop, value)) {
      styles[prop] = value;
    }
  }
  <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(styles).<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
    snapshot.<span class="hljs-property">styles</span> = styles; <span class="hljs-comment">// 仅当有非默认样式时才添加，减少体积</span>
  }
}
<span class="hljs-comment">// 辅助函数：判断是否为标签默认样式（基于rrweb内置的默认样式表）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">isDefaultStyle</span>(<span class="hljs-params">tagName, prop, value</span>) {
  <span class="hljs-keyword">const</span> defaultStyles = {
    <span class="hljs-attr">div</span>: { <span class="hljs-attr">display</span>: <span class="hljs-string">'block'</span>, <span class="hljs-attr">margin</span>: <span class="hljs-string">'0'</span> },
    <span class="hljs-attr">body</span>: { <span class="hljs-attr">margin</span>: <span class="hljs-string">'8px'</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">'rgb(0, 0, 0)'</span> },
    <span class="hljs-attr">input</span>: { <span class="hljs-attr">border</span>: <span class="hljs-string">'1px solid rgb(169, 169, 169)'</span> }
    <span class="hljs-comment">// 其他标签默认样式...</span>
  };
  <span class="hljs-keyword">return</span> defaultStyles[tagName]?.[prop] === value;
}
</code></pre>
<h3 data-id="heading-6">1.3 技术难点与解决方案</h3>
<ul>
<li>
<p><strong>难点 1：样式体积过大与浏览器兼容性</strong></p>
<p>直接收集所有计算样式会导致数据量激增（单个元素可能有上百个样式属性），且不同浏览器默认样式存在差异（如 Chrome 与 Safari 的body默认margin不同）。</p>
<p><strong>解决方案</strong>：
① 仅收集 “影响视觉的关键样式”（如display、position），过滤无关样式（如webkit-font-smoothing）；</p>
<p>② 维护 “标签默认样式表”，仅记录与默认值不同的样式，数据量可减少 60% 以上；</p>
<p>③ 对浏览器私有前缀样式（如-webkit-border-radius）进行兼容处理，统一转化为标准样式。</p>
</li>
<li>
<p><strong>难点 2：跨域资源无法加载</strong></p>
<p>页面中的跨域图片（如 CDN 图片）、字体等资源，回放时可能因 CORS 限制无法加载，导致样式错乱。</p>
<p><strong>解决方案</strong>：</p>
</li>
<li>
<p>① 配置<code>inlineImages: true</code>时，将图片转化为 Base64 编码内联到快照中（适合小图片）；</p>
</li>
<li>
<p>② 对大图片，回放时通过 “同源代理服务” 转发请求（如后端部署代理接口，将跨域图片 URL 转为同源 URL）；</p>
</li>
<li>
<p>③ 记录资源加载失败时的降级样式（如图片占位符），确保回放体验一致。</p>
</li>
</ul>
<h3 data-id="heading-7">1.4 DOM 快照生成流程图</h3>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06c362ed5ffc430d93116711b56412e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56eL5aSp55qE5LiA6Zi16aOO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768528593&amp;x-signature=Mi8sK5khRiJIu7UNyllRiks9Vlc%3D" alt="exported_image.png" width="70%" loading="lazy"/>
<h2 data-id="heading-8">二、增量更新机制（MutationObserver）</h2>
<p><strong>通俗类比</strong>：如果说 DOM 快照是 “初始工程图”，增量更新就是 “工程变更记录”—— 就像建筑施工时，不需要每次都重新绘制完整图纸，只需记录 <strong>“在 3 层增加 1 个窗户”</strong> <strong>“修改 2 层墙体颜色”</strong> 这类变化。</p>
<p>rrweb 通过监听 DOM 变化，只记录快照后的增量修改，大幅减少录制数据量。</p>
<h3 data-id="heading-9">2.1 核心技术：MutationObserver API</h3>
<p>rrweb 的增量更新完全依赖浏览器原生的MutationObserver API，该 API 可监听 DOM 树的 <strong>“节点变化、属性变化、文本变化”</strong> ，并<strong>异步批量触发回调</strong>（避免阻塞主线程）。</p>
<p>其核心优势：</p>
<ul>
<li>① 精准监听（可指定监听类型）；</li>
<li>② 批量处理（短时间内多次变化合并为一次回调）；</li>
<li>③ 性能友好（异步执行，不阻塞用户交互）。</li>
</ul>
<h3 data-id="heading-10">2.2 监听配置与事件转化</h3>
<p>rrweb 初始化时创建 <code>MutationObserver</code>实例，将原生变化事件转化为自定义的Mutation事件（rrweb 事件类型标识为 3），关键逻辑如下：</p>
<h4 data-id="heading-11">2.2.1 MutationObserver 初始化</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 伪代码：rrweb中MutationObserver配置</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">initMutationObserver</span>(<span class="hljs-params">emit, config</span>) {
  <span class="hljs-comment">// 回调函数：批量处理DOM变化</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">observerCallback</span> = (<span class="hljs-params">mutations</span>) =&gt; {
    <span class="hljs-comment">// 过滤无需记录的微小变化（如文本节点空字符修改）</span>
    <span class="hljs-keyword">const</span> validMutations = mutations.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">m</span> =&gt;</span> <span class="hljs-title function_">isMutationValid</span>(m, config));
    <span class="hljs-keyword">if</span> (validMutations.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;
    <span class="hljs-comment">// 批量转化为rrweb增量事件并发送</span>
    validMutations.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">mutation</span> =&gt;</span> {
      <span class="hljs-keyword">const</span> incrementalEvent = <span class="hljs-title function_">transformMutation</span>(mutation);
      <span class="hljs-title function_">emit</span>(incrementalEvent); <span class="hljs-comment">// 发送到事件队列，后续存储/上传</span>
    });
  };
  <span class="hljs-comment">// 监听配置：覆盖所有关键变化类型</span>
  <span class="hljs-keyword">const</span> observerConfig = {
    <span class="hljs-attr">childList</span>: <span class="hljs-literal">true</span>,          <span class="hljs-comment">// 监听子节点新增/删除</span>
    <span class="hljs-attr">attributes</span>: <span class="hljs-literal">true</span>,         <span class="hljs-comment">// 监听元素属性变化</span>
    <span class="hljs-attr">characterData</span>: <span class="hljs-literal">true</span>,      <span class="hljs-comment">// 监听文本节点内容变化</span>
    <span class="hljs-attr">subtree</span>: <span class="hljs-literal">true</span>,            <span class="hljs-comment">// 深度监听（子树所有节点，不仅是直接子节点）</span>
    <span class="hljs-attr">attributeOldValue</span>: <span class="hljs-literal">true</span>,  <span class="hljs-comment">// 记录属性变化前的旧值（便于回放时还原）</span>
    <span class="hljs-attr">characterDataOldValue</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// 记录文本变化前的旧值</span>
  };
  <span class="hljs-comment">// 开始监听根节点</span>
  <span class="hljs-keyword">const</span> observer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MutationObserver</span>(observerCallback);
  observer.<span class="hljs-title function_">observe</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>, observerConfig);
  <span class="hljs-keyword">return</span> observer; <span class="hljs-comment">// 返回实例，便于后续停止监听</span>
}
<span class="hljs-comment">// 辅助函数：过滤无效变化（如屏蔽元素内的变化、空文本修改）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">isMutationValid</span>(<span class="hljs-params">mutation, config</span>) {
  <span class="hljs-comment">// 屏蔽元素内的变化不记录</span>
  <span class="hljs-keyword">if</span> (mutation.<span class="hljs-property">target</span>.<span class="hljs-title function_">closest</span>(<span class="hljs-string">`.<span class="hljs-subst">${config.blockClass}</span>`</span>)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  <span class="hljs-comment">// 文本节点空字符修改不记录（如用户输入后删除为空）</span>
  <span class="hljs-keyword">if</span> (mutation.<span class="hljs-property">type</span> === <span class="hljs-string">'characterData'</span>) {
    <span class="hljs-keyword">return</span> mutation.<span class="hljs-property">oldValue</span>.<span class="hljs-title function_">trim</span>() !== <span class="hljs-string">''</span> || mutation.<span class="hljs-property">target</span>.<span class="hljs-property">textContent</span>.<span class="hljs-title function_">trim</span>() !== <span class="hljs-string">''</span>;
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<h4 data-id="heading-12">2.2.2 原生变化事件转化（transformMutation）</h4>
<p>将浏览器原生的<code>MutationRecord</code>转化为 “可回放的结构化数据”，核心是明确 “变化目标、变化类型、变化内容”：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 伪代码：转化原生MutationRecord</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">transformMutation</span>(<span class="hljs-params">mutation</span>) {
  <span class="hljs-keyword">const</span> event = {
    <span class="hljs-attr">type</span>: <span class="hljs-number">3</span>,                  <span class="hljs-comment">// Mutation事件类型标识</span>
    <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),    <span class="hljs-comment">// 事件发生时间戳（用于回放排序）</span>
    <span class="hljs-attr">data</span>: {}
  };
  <span class="hljs-comment">// 1. 子节点变化（新增/删除节点）</span>
  <span class="hljs-keyword">if</span> (mutation.<span class="hljs-property">type</span> === <span class="hljs-string">'childList'</span>) {
    event.<span class="hljs-property">data</span>.<span class="hljs-property">type</span> = <span class="hljs-string">'childList'</span>;
    <span class="hljs-comment">// 记录父节点路径（便于回放时定位目标父节点）</span>
    event.<span class="hljs-property">data</span>.<span class="hljs-property">parentPath</span> = <span class="hljs-title function_">getNodeUniquePath</span>(mutation.<span class="hljs-property">target</span>);
    <span class="hljs-comment">// 序列化新增/删除的节点（仅核心属性，减少体积）</span>
    event.<span class="hljs-property">data</span>.<span class="hljs-property">addedNodes</span> = mutation.<span class="hljs-property">addedNodes</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">n</span> =&gt;</span> <span class="hljs-title function_">serializeNode</span>(n)).<span class="hljs-title function_">filter</span>(<span class="hljs-title class_">Boolean</span>);
    event.<span class="hljs-property">data</span>.<span class="hljs-property">removedNodes</span> = mutation.<span class="hljs-property">removedNodes</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">n</span> =&gt;</span> <span class="hljs-title function_">serializeNode</span>(n)).<span class="hljs-title function_">filter</span>(<span class="hljs-title class_">Boolean</span>);
    <span class="hljs-comment">// 记录插入位置参考节点（确保回放时插入顺序正确）</span>
    event.<span class="hljs-property">data</span>.<span class="hljs-property">nextSiblingId</span> = mutation.<span class="hljs-property">nextSibling</span> 
      ? <span class="hljs-title function_">getNodeUniqueId</span>(mutation.<span class="hljs-property">nextSibling</span>) 
      : <span class="hljs-literal">null</span>;
  }
  <span class="hljs-comment">// 2. 属性变化（如class、src修改）</span>
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mutation.<span class="hljs-property">type</span> === <span class="hljs-string">'attributes'</span>) {
    event.<span class="hljs-property">data</span>.<span class="hljs-property">type</span> = <span class="hljs-string">'attributes'</span>;
    event.<span class="hljs-property">data</span>.<span class="hljs-property">targetPath</span> = <span class="hljs-title function_">getNodeUniquePath</span>(mutation.<span class="hljs-property">target</span>);
    event.<span class="hljs-property">data</span>.<span class="hljs-property">attributeName</span> = mutation.<span class="hljs-property">attributeName</span>;
    event.<span class="hljs-property">data</span>.<span class="hljs-property">oldValue</span> = mutation.<span class="hljs-property">oldValue</span>;
    event.<span class="hljs-property">data</span>.<span class="hljs-property">newValue</span> = mutation.<span class="hljs-property">target</span>.<span class="hljs-title function_">getAttribute</span>(mutation.<span class="hljs-property">attributeName</span>);
  }
  <span class="hljs-comment">// 3. 文本变化（如span内文本修改）</span>
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mutation.<span class="hljs-property">type</span> === <span class="hljs-string">'characterData'</span>) {
    event.<span class="hljs-property">data</span>.<span class="hljs-property">type</span> = <span class="hljs-string">'characterData'</span>;
    event.<span class="hljs-property">data</span>.<span class="hljs-property">targetPath</span> = <span class="hljs-title function_">getNodeUniquePath</span>(mutation.<span class="hljs-property">target</span>);
    event.<span class="hljs-property">data</span>.<span class="hljs-property">oldValue</span> = mutation.<span class="hljs-property">oldValue</span>;
    event.<span class="hljs-property">data</span>.<span class="hljs-property">newValue</span> = mutation.<span class="hljs-property">target</span>.<span class="hljs-property">textContent</span>;
  }
  <span class="hljs-keyword">return</span> event;
}
<span class="hljs-comment">// 辅助函数：生成节点唯一路径（如"body&gt;div.container&gt;ul&gt;li:nth-child(2)"）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getNodeUniquePath</span>(<span class="hljs-params">node</span>) {
  <span class="hljs-keyword">if</span> (node === <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">'html'</span>;
  <span class="hljs-keyword">if</span> (node === <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">'body'</span>;
  <span class="hljs-keyword">const</span> parentPath = <span class="hljs-title function_">getNodeUniquePath</span>(node.<span class="hljs-property">parentElement</span>);
  <span class="hljs-keyword">const</span> siblings = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(node.<span class="hljs-property">parentElement</span>.<span class="hljs-property">children</span>);
  <span class="hljs-comment">// 用"标签名+索引"确保唯一性（如li:nth-child(2)）</span>
  <span class="hljs-keyword">const</span> index = siblings.<span class="hljs-title function_">indexOf</span>(node) + <span class="hljs-number">1</span>;
  <span class="hljs-keyword">const</span> nodeName = node.<span class="hljs-property">tagName</span>.<span class="hljs-title function_">toLowerCase</span>();
  <span class="hljs-keyword">const</span> classAttr = node.<span class="hljs-property">classList</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span> 
    ? <span class="hljs-string">`.<span class="hljs-subst">${<span class="hljs-built_in">Array</span>.<span class="hljs-keyword">from</span>(node.classList).join(<span class="hljs-string">'.'</span>)}</span>`</span> 
    : <span class="hljs-string">''</span>;
  <span class="hljs-keyword">const</span> idAttr = node.<span class="hljs-property">id</span> ? <span class="hljs-string">`#<span class="hljs-subst">${node.id}</span>`</span> : <span class="hljs-string">''</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${parentPath}</span>&gt;<span class="hljs-subst">${nodeName}</span><span class="hljs-subst">${idAttr}</span><span class="hljs-subst">${classAttr}</span>:nth-child(<span class="hljs-subst">${index}</span>)`</span>;
}
</code></pre>
<h3 data-id="heading-13">2.3 技术难点与解决方案</h3>
<ul>
<li>
<p><strong>难点 1：节点路径定位不准确</strong></p>
<p>增量变化需要明确 “哪个节点发生了变化”，但 DOM 节点没有天生的唯一标识，动态生成的节点（如 Vue 列表渲染的li）在刷新后路径可能变化，导致回放时无法定位目标节点。</p>
<p><strong>解决方案</strong>：</p>
<ul>
<li>
<p>① 生成 “唯一路径”（结合标签名、ID、类名、兄弟节点索引），如body&gt;div.container&gt;ul&gt;li:nth-child(2)，确保即使节点动态更新，仍能通过路径找到；</p>
</li>
<li>
<p>② 维护 “节点 ID 映射表”，录制时为每个节点分配临时 ID（如node.__rrwebId），回放时通过 ID 快速定位，路径作为降级方案（应对 ID 丢失场景）。</p>
</li>
</ul>
</li>
<li>
<p><strong>难点 2：高频变化导致性能卡顿</strong></p>
<p>页面中的高频 DOM 变化（如倒计时、动画、滚动加载列表）会触发MutationObserver频繁回调（如每秒几十次），导致前端主线程阻塞，影响用户交互体验。</p>
<p><strong>解决方案</strong>：</p>
<ul>
<li>① 结合 “采样率控制”，对高频变化事件（如文本倒计时）进行节流处理（如 100ms 内仅记录 1 次变化）；</li>
<li>② 批量合并短时间内的同类变化（如 100ms 内的多次文本修改合并为 1 次）；</li>
<li>③ 过滤 “无意义变化”（如元素scrollTop的微小波动、空文本修改），减少事件数量。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-14">2.4 增量更新流程示意图</h3>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38213ded1a94417689424eaa9f67279f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56eL5aSp55qE5LiA6Zi16aOO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768528593&amp;x-signature=qzF5MNVrmSzOBjSonF7tBbBHrlk%3D" alt="exported_image.png" width="70%" loading="lazy"/>
<h2 data-id="heading-15">三、事件捕获和序列化</h2>
<p><strong>通俗类比</strong>：如果说 DOM 快照是 “初始场景”，增量更新是 “场景变化”，那么事件捕获就是 “用户动作剧本”—— 就像电影拍摄时，不仅要搭建场景，还要记录演员的 “肢体动作”“台词”“表情”。</p>
<p>rrweb 需要捕获用户的点击、输入、滚动等交互动作，将其转化为结构化的 “剧本数据”，确保回放时能精准还原用户操作轨迹。</p>
<h3 data-id="heading-16">3.1 核心事件类型与捕获策略</h3>
<p>rrweb 主要捕获 6 类高频用户交互事件，覆盖 90% 以上的前端操作场景，采用 “全局事件委托 + 精准过滤” 的捕获策略，避免给每个节点绑定事件导致内存泄漏：</p>















































<table><thead><tr><th>事件类型</th><th>核心用途</th><th>关键数据字段</th><th>rrweb 事件类型标识</th></tr></thead><tbody><tr><td>鼠标点击（click）</td><td>记录按钮、链接等点击操作</td><td>点击坐标（x/y）、目标节点路径</td><td>4</td></tr><tr><td>键盘输入（keydown）</td><td>记录文本输入、功能键操作</td><td>按键码（keyCode）、输入内容、目标节点</td><td>5</td></tr><tr><td>鼠标移动（mousemove）</td><td>记录鼠标位置变化</td><td>鼠标坐标（x/y）、时间戳</td><td>6</td></tr><tr><td>滚动（scroll）</td><td>记录页面 / 元素滚动位置</td><td>滚动目标路径、scrollTop/scrollLeft</td><td>7</td></tr><tr><td>窗口 resize</td><td>记录窗口尺寸变化</td><td>窗口宽（width）、高（height）</td><td>8</td></tr><tr><td>表单提交（submit）</td><td>记录表单提交操作</td><td>表单节点路径、提交时间戳</td><td>9</td></tr></tbody></table>
<h3 data-id="heading-17">3.2 关键实现逻辑（全局事件委托）</h3>
<p>通过在document上绑定事件监听器，利用事件冒泡机制捕获所有子节点的交互，核心代码如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 伪代码：rrweb事件捕获核心逻辑</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">initEventCapture</span>(<span class="hljs-params">emit, config</span>) {
  <span class="hljs-comment">// 需捕获的事件类型与对应的处理函数</span>
  <span class="hljs-keyword">const</span> eventHandlers = {
    <span class="hljs-attr">click</span>: handleClick,
    <span class="hljs-attr">keydown</span>: handleKeydown,
    <span class="hljs-attr">mousemove</span>: handleMousemove,
    <span class="hljs-attr">scroll</span>: handleScroll,
    <span class="hljs-attr">resize</span>: handleResize,
    <span class="hljs-attr">submit</span>: handleSubmit
  };
  <span class="hljs-comment">// 绑定全局事件委托</span>
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(eventHandlers).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[type, handler]</span>) =&gt;</span> {
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(type, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
      <span class="hljs-comment">// 过滤规则：1. 屏蔽元素内的事件 2. 非用户触发的事件（如脚本触发的click）</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isIgnoredEvent</span>(e, config)) <span class="hljs-keyword">return</span>;
      <span class="hljs-comment">// 处理事件并序列化为结构化数据</span>
      <span class="hljs-keyword">const</span> eventData = <span class="hljs-title function_">handler</span>(e, config);
      <span class="hljs-comment">// 发送事件（携带时间戳，确保回放顺序）</span>
      <span class="hljs-title function_">emit</span>({
        <span class="hljs-attr">type</span>: <span class="hljs-title function_">getRRwebEventType</span>(type), <span class="hljs-comment">// 转化为rrweb事件标识</span>
        <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
        <span class="hljs-attr">data</span>: eventData
      });
    }, {
      <span class="hljs-attr">passive</span>: type === <span class="hljs-string">'scroll'</span> || type === <span class="hljs-string">'resize'</span>, <span class="hljs-comment">// passive优化：避免滚动阻塞</span>
      <span class="hljs-attr">capture</span>: <span class="hljs-literal">false</span> <span class="hljs-comment">// 冒泡阶段捕获，确保能获取最终目标节点</span>
    });
  });
}
<span class="hljs-comment">// 辅助函数：过滤无效事件</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">isIgnoredEvent</span>(<span class="hljs-params">e, config</span>) {
  <span class="hljs-comment">// 1. 屏蔽元素内的事件（如带.rr-block类名的元素）</span>
  <span class="hljs-keyword">if</span> (e.<span class="hljs-property">target</span>.<span class="hljs-title function_">closest</span>(<span class="hljs-string">`.<span class="hljs-subst">${config.blockClass}</span>`</span>)) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  <span class="hljs-comment">// 2. 排除脚本触发的事件（仅保留用户手动触发）</span>
  <span class="hljs-keyword">if</span> (e.<span class="hljs-property">isTrusted</span> === <span class="hljs-literal">false</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  <span class="hljs-comment">// 3. 排除右键点击（contextmenu）和滚轮事件（默认不捕获）</span>
  <span class="hljs-keyword">if</span> (e.<span class="hljs-property">type</span> === <span class="hljs-string">'click'</span> &amp;&amp; e.<span class="hljs-property">button</span> === <span class="hljs-number">2</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}
</code></pre>
<h3 data-id="heading-18">3.3 典型事件序列化实现（以键盘输入和滚动为例）</h3>
<p>不同事件的序列化重点不同，需针对性处理敏感数据（如密码）和冗余信息：</p>
<h4 data-id="heading-19">3.3.1 键盘输入事件（keydown）序列化</h4>
<p>需区分 “普通字符输入” 和 “功能键”，同时对密码等敏感输入进行掩码处理：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 伪代码：键盘输入事件处理</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleKeydown</span>(<span class="hljs-params">e, config</span>) {
  <span class="hljs-keyword">const</span> target = e.<span class="hljs-property">target</span>;
  <span class="hljs-comment">// 隐私处理：密码输入框且开启掩码，不记录真实内容</span>
  <span class="hljs-keyword">const</span> isPasswordInput = target.<span class="hljs-property">tagName</span> === <span class="hljs-string">'INPUT'</span> &amp;&amp; target.<span class="hljs-property">type</span> === <span class="hljs-string">'password'</span>;
  <span class="hljs-keyword">const</span> shouldMask = isPasswordInput &amp;&amp; config.<span class="hljs-property">maskInputPassword</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">targetPath</span>: <span class="hljs-title function_">getNodeUniquePath</span>(target), <span class="hljs-comment">// 目标输入框路径</span>
    <span class="hljs-attr">key</span>: shouldMask ? <span class="hljs-string">'*'</span> : e.<span class="hljs-property">key</span>, <span class="hljs-comment">// 敏感输入替换为*</span>
    <span class="hljs-attr">keyCode</span>: e.<span class="hljs-property">keyCode</span>, <span class="hljs-comment">// 按键码（回放时模拟输入需用到）</span>
    <span class="hljs-attr">value</span>: shouldMask ? <span class="hljs-string">'*'</span> : target.<span class="hljs-property">value</span>, <span class="hljs-comment">// 输入框当前值（非敏感场景）</span>
    <span class="hljs-attr">isFunctionalKey</span>: [<span class="hljs-string">'Enter'</span>, <span class="hljs-string">'Backspace'</span>, <span class="hljs-string">'Tab'</span>].<span class="hljs-title function_">includes</span>(e.<span class="hljs-property">key</span>) <span class="hljs-comment">// 是否为功能键</span>
  };
}
</code></pre>
<h4 data-id="heading-20">3.3.2 滚动事件（scroll）序列化</h4>
<p>需区分 “页面滚动” 和 “元素滚动”，避免重复记录高频滚动事件：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 伪代码：滚动事件处理（含节流优化）</span>
<span class="hljs-keyword">let</span> lastScrollTime = <span class="hljs-number">0</span>;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleScroll</span>(<span class="hljs-params">e, config</span>) {
  <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
  <span class="hljs-comment">// 节流优化：50ms内仅记录1次，减少高频滚动导致的数据量</span>
  <span class="hljs-keyword">if</span> (now - lastScrollTime &lt; <span class="hljs-number">50</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  lastScrollTime = now;
  <span class="hljs-comment">// 区分页面滚动和元素滚动</span>
  <span class="hljs-keyword">const</span> target = e.<span class="hljs-property">target</span> === <span class="hljs-variable language_">document</span> ? <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span> : e.<span class="hljs-property">target</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">targetPath</span>: <span class="hljs-title function_">getNodeUniquePath</span>(target),
    <span class="hljs-attr">scrollTop</span>: target.<span class="hljs-property">scrollTop</span>,
    <span class="hljs-attr">scrollLeft</span>: target.<span class="hljs-property">scrollLeft</span>,
    <span class="hljs-attr">isPageScroll</span>: e.<span class="hljs-property">target</span> === <span class="hljs-variable language_">document</span> <span class="hljs-comment">// 是否为页面滚动</span>
  };
}
</code></pre>
<h3 data-id="heading-21">3.4 技术难点与解决方案</h3>
<ul>
<li>
<p><strong>难点 1：事件顺序错乱</strong></p>
<p>不同事件的触发存在时间差（如 “点击按钮→输入文本→提交表单”），若录制时事件顺序错误，回放会出现逻辑混乱（如未输入就提交）。</p>
<p><strong>解决方案</strong>：</p>
<ul>
<li>
<p>① 所有事件携带精确时间戳（Date.now()），回放时按时间戳升序执行；</p>
</li>
<li>
<p>② 对存在依赖关系的事件（如 “click” 后触发的 “keydown”），记录事件间的关联 ID（如parentEventId），确保回放时顺序一致。</p>
</li>
</ul>
</li>
</ul>
<h3 data-id="heading-22">3.5 事件捕获流程示意图</h3>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/022ced5baa094839a29a8f042b525a2d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56eL5aSp55qE5LiA6Zi16aOO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768528593&amp;x-signature=KM2%2FXkDZmNplhKC0zCIxuh0YvQ8%3D" alt="image.png" width="100%" loading="lazy"/>
<h2 data-id="heading-23">四、回放还原技术</h2>
<p><strong>通俗类比</strong>：回放就像 “按剧本复现舞台剧”——DOM 快照是 “初始舞台布置”，增量事件是 “舞台道具变化指令”，用户交互事件是 “演员动作指令”，rrweb-player 则是 “导演”，按时间顺序执行所有指令，最终还原完整场景。</p>
<h3 data-id="heading-24">4.1 回放核心流程</h3>
<p>回放过程分为 <strong>“初始化准备”</strong> <strong>“事件调度”</strong> <strong>“状态同步”</strong> 三步，核心是 “按时间戳排序事件” 与 “精准执行指令”：</p>
<h4 data-id="heading-25">4.1.1 初始化准备（加载快照）</h4>
<p>回放开始时，先基于<code>FullSnapshot</code>事件重建初始 DOM，再初始化节点路径映射表（便于后续定位目标节点）：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 伪代码：回放初始化</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">RRwebPlayer</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">options</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">events</span> = options.<span class="hljs-property">events</span>.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a.<span class="hljs-property">timestamp</span> - b.<span class="hljs-property">timestamp</span>); <span class="hljs-comment">// 按时间戳排序</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span> = options.<span class="hljs-property">target</span>; <span class="hljs-comment">// 回放容器</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">nodeMap</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>(); <span class="hljs-comment">// 节点ID→DOM节点映射表</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initSnapshot</span>(); <span class="hljs-comment">// 加载初始快照</span>
  }
  <span class="hljs-comment">// 基于FullSnapshot重建初始DOM</span>
  <span class="hljs-title function_">initSnapshot</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 找到首屏快照事件</span>
    <span class="hljs-keyword">const</span> fullSnapshot = <span class="hljs-variable language_">this</span>.<span class="hljs-property">events</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> e.<span class="hljs-property">type</span> === <span class="hljs-number">2</span>);
    <span class="hljs-keyword">if</span> (!fullSnapshot) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'缺少首屏快照，无法回放'</span>);
    
    <span class="hljs-comment">// 清空容器，重建DOM</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span>.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">''</span>;
    <span class="hljs-keyword">const</span> rootNode = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">rebuildNode</span>(fullSnapshot.<span class="hljs-property">data</span>.<span class="hljs-property">node</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span>.<span class="hljs-title function_">appendChild</span>(rootNode);
    
    <span class="hljs-comment">// 初始化节点映射表（记录每个节点的唯一ID）</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">buildNodeMap</span>(rootNode);
  }
  <span class="hljs-comment">// 从快照节点重建真实DOM</span>
  <span class="hljs-title function_">rebuildNode</span>(<span class="hljs-params">snapshotNode</span>) {
    <span class="hljs-keyword">let</span> node;
    <span class="hljs-keyword">if</span> (snapshotNode.<span class="hljs-property">type</span> === <span class="hljs-number">1</span>) { <span class="hljs-comment">// 元素节点</span>
      node = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(snapshotNode.<span class="hljs-property">tagName</span>);
      <span class="hljs-comment">// 还原属性（id、class、src等）</span>
      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(snapshotNode.<span class="hljs-property">attributes</span> || {}).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[key, value]</span>) =&gt;</span> {
        node.<span class="hljs-title function_">setAttribute</span>(key, value);
      });
      <span class="hljs-comment">// 还原样式（内联快照中的非默认样式）</span>
      <span class="hljs-keyword">if</span> (snapshotNode.<span class="hljs-property">styles</span>) {
        <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(snapshotNode.<span class="hljs-property">styles</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[key, value]</span>) =&gt;</span> {
          node.<span class="hljs-property">style</span>[key] = value;
        });
      }
      <span class="hljs-comment">// 还原表单状态（value、checked）</span>
      <span class="hljs-keyword">if</span> ([<span class="hljs-string">'INPUT'</span>, <span class="hljs-string">'TEXTAREA'</span>, <span class="hljs-string">'SELECT'</span>].<span class="hljs-title function_">includes</span>(snapshotNode.<span class="hljs-property">tagName</span>.<span class="hljs-title function_">toUpperCase</span>())) {
        node.<span class="hljs-property">value</span> = snapshotNode.<span class="hljs-property">value</span> || <span class="hljs-string">''</span>;
        <span class="hljs-keyword">if</span> (snapshotNode.<span class="hljs-property">checked</span> !== <span class="hljs-literal">undefined</span>) node.<span class="hljs-property">checked</span> = snapshotNode.<span class="hljs-property">checked</span>;
      }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (snapshotNode.<span class="hljs-property">type</span> === <span class="hljs-number">3</span>) { <span class="hljs-comment">// 文本节点</span>
      node = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createTextNode</span>(snapshotNode.<span class="hljs-property">text</span> || <span class="hljs-string">''</span>);
    }
    <span class="hljs-comment">// 递归重建子节点</span>
    <span class="hljs-keyword">if</span> (snapshotNode.<span class="hljs-property">children</span> &amp;&amp; snapshotNode.<span class="hljs-property">children</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
      snapshotNode.<span class="hljs-property">children</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">childSnapshot</span> =&gt;</span> {
        <span class="hljs-keyword">const</span> childNode = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">rebuildNode</span>(childSnapshot);
        <span class="hljs-keyword">if</span> (childNode) node.<span class="hljs-title function_">appendChild</span>(childNode);
      });
    }
    <span class="hljs-keyword">return</span> node;
  }
}
</code></pre>
<h4 data-id="heading-26">4.1.2 事件调度（按时间顺序执行）</h4>
<p>采用 “定时器 + 事件队列” 模式，模拟真实时间流逝，按事件 timestamp 差值执行指令，支持倍速播放（如 1x、2x、4x）：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 伪代码：事件调度逻辑</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">RRwebPlayer</span> {
  <span class="hljs-comment">// ... 初始化逻辑 ...</span>
  <span class="hljs-comment">// 开始回放</span>
  <span class="hljs-title function_">play</span>(<span class="hljs-params">speed = <span class="hljs-number">1</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isPlaying</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">playSpeed</span> = speed;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentEventIndex</span> = <span class="hljs-number">0</span>; <span class="hljs-comment">// 当前执行到的事件索引</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">startTime</span> = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(); <span class="hljs-comment">// 回放开始时间</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">firstEventTime</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">events</span>[<span class="hljs-number">0</span>].<span class="hljs-property">timestamp</span>; <span class="hljs-comment">// 第一个事件的时间戳</span>
    
    <span class="hljs-comment">// 启动调度器</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scheduler</span> = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">executeEvents</span>(), <span class="hljs-number">16</span>); <span class="hljs-comment">// 约60fps，流畅度优先</span>
  }
  <span class="hljs-comment">// 执行当前时间点应触发的事件</span>
  <span class="hljs-title function_">executeEvents</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">isPlaying</span>) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">const</span> currentPlayTime = <span class="hljs-variable language_">this</span>.<span class="hljs-property">firstEventTime</span> + (<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - <span class="hljs-variable language_">this</span>.<span class="hljs-property">startTime</span>) * <span class="hljs-variable language_">this</span>.<span class="hljs-property">playSpeed</span>;
    
    <span class="hljs-comment">// 执行所有timestamp &lt;= 当前播放时间的事件</span>
    <span class="hljs-keyword">while</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentEventIndex</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">events</span>.<span class="hljs-property">length</span>) {
      <span class="hljs-keyword">const</span> event = <span class="hljs-variable language_">this</span>.<span class="hljs-property">events</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentEventIndex</span>];
      <span class="hljs-keyword">if</span> (event.<span class="hljs-property">timestamp</span> &gt; currentPlayTime) <span class="hljs-keyword">break</span>;
      
      <span class="hljs-comment">// 根据事件类型执行对应操作</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">executeEvent</span>(event);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentEventIndex</span>++;
    }
    <span class="hljs-comment">// 回放结束，清除定时器</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentEventIndex</span> &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">events</span>.<span class="hljs-property">length</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">pause</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">onFinish</span>?.();
    }
  }
  <span class="hljs-comment">// 执行单个事件</span>
  <span class="hljs-title function_">executeEvent</span>(<span class="hljs-params">event</span>) {
    <span class="hljs-keyword">switch</span> (event.<span class="hljs-property">type</span>) {
      <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>: <span class="hljs-comment">// Mutation事件（增量更新）</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">executeMutation</span>(event.<span class="hljs-property">data</span>);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>: <span class="hljs-comment">// click事件</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">executeClick</span>(event.<span class="hljs-property">data</span>);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-number">5</span>: <span class="hljs-comment">// 键盘事件</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">executeKeyEvent</span>(event.<span class="hljs-property">data</span>);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-comment">// 其他事件类型执行逻辑...</span>
    }
  }
}
</code></pre>
<h4 data-id="heading-27">4.1.3 增量事件执行（以 Mutation 为例）</h4>
<p>根据增量事件类型，执行 “节点新增 / 删除”“属性修改”“文本更新” 等操作：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 伪代码：执行Mutation增量事件</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">RRwebPlayer</span> {
  <span class="hljs-comment">// ... 其他方法 ...</span>
  <span class="hljs-title function_">executeMutation</span>(<span class="hljs-params">mutationData</span>) {
    <span class="hljs-comment">// 定位目标节点（通过路径或节点ID）</span>
    <span class="hljs-keyword">const</span> targetNode = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getTargetNode</span>(mutationData.<span class="hljs-property">targetPath</span> || mutationData.<span class="hljs-property">parentPath</span>);
    <span class="hljs-keyword">if</span> (!targetNode) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">switch</span> (mutationData.<span class="hljs-property">type</span>) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'childList'</span>: <span class="hljs-comment">// 子节点变化</span>
        <span class="hljs-comment">// 新增节点</span>
        mutationData.<span class="hljs-property">addedNodes</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">childSnapshot</span> =&gt;</span> {
          <span class="hljs-keyword">const</span> childNode = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">rebuildNode</span>(childSnapshot);
          <span class="hljs-keyword">if</span> (mutationData.<span class="hljs-property">nextSiblingId</span>) {
            <span class="hljs-comment">// 插入到参考节点之前</span>
            <span class="hljs-keyword">const</span> nextSibling = <span class="hljs-variable language_">this</span>.<span class="hljs-property">nodeMap</span>.<span class="hljs-title function_">get</span>(mutationData.<span class="hljs-property">nextSiblingId</span>);
            targetNode.<span class="hljs-title function_">insertBefore</span>(childNode, nextSibling);
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 插入到末尾</span>
            targetNode.<span class="hljs-title function_">appendChild</span>(childNode);
          }
          <span class="hljs-comment">// 更新节点映射表</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">buildNodeMap</span>(childNode);
        });
        <span class="hljs-comment">// 删除节点</span>
        mutationData.<span class="hljs-property">removedNodes</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">childSnapshot</span> =&gt;</span> {
          <span class="hljs-keyword">const</span> childNode = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getTargetNodeBySnapshot</span>(childSnapshot);
          <span class="hljs-keyword">if</span> (childNode &amp;&amp; childNode.<span class="hljs-property">parentElement</span> === targetNode) {
            targetNode.<span class="hljs-title function_">removeChild</span>(childNode);
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">nodeMap</span>.<span class="hljs-title function_">delete</span>(childNode.<span class="hljs-property">__rrwebId</span>); <span class="hljs-comment">// 从映射表移除</span>
          }
        });
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'attributes'</span>: <span class="hljs-comment">// 属性修改</span>
        targetNode.<span class="hljs-title function_">setAttribute</span>(mutationData.<span class="hljs-property">attributeName</span>, mutationData.<span class="hljs-property">newValue</span>);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'characterData'</span>: <span class="hljs-comment">// 文本修改</span>
        targetNode.<span class="hljs-property">textContent</span> = mutationData.<span class="hljs-property">newValue</span>;
        <span class="hljs-keyword">break</span>;
    }
  }
}
</code></pre>
<h3 data-id="heading-28">4.2 技术难点与解决方案</h3>
<ul>
<li><strong>难点 1：事件执行顺序偏差</strong></li>
</ul>
<p>录制时事件按真实时间戳存储，但回放时若定时器精度不足（如 setInterval 存在延迟），可能导致 “先执行点击、后执行 DOM 更新” 的顺序错误，引发场景混乱。</p>
<p><strong>解决方案</strong>：
① 事件队列按 timestamp 严格排序，执行时通过 “当前播放时间 = 首事件时间 +（当前时间 - 回放开始时间）× 倍速” 精准计算应执行的事件；</p>
<p>② 对依赖 DOM 状态的事件（如 click），增加 “DOM 就绪检查”，确保增量更新执行完成后再触发交互事件。</p>
<ul>
<li><strong>难点 2：回放时节点定位失败</strong></li>
</ul>
<p>若录制时 DOM 结构动态变化（如 Vue 列表重新渲染），回放时可能出现 “路径找不到节点” 的问题。</p>
<p><strong>解决方案</strong>：</p>
<ul>
<li>① 采用 “节点 ID 优先、路径降级” 的定位策略，录制时为每个节点分配<code>\_\_rrwebId</code>，回放时优先通过 ID 定位；</li>
<li>② 路径定位时支持 “模糊匹配”（如忽略动态索引，通过类名 + 标签名组合定位）；</li>
<li>③ 定位失败时触发 “降级处理”（如跳过该事件，避免整个回放崩溃）。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🤖 AI 应用自主决策的可行性 — 一场从逻辑电路到灵魂选择的奇妙旅程]]></title>    <link>https://juejin.cn/post/7592818202718093331</link>    <guid>https://juejin.cn/post/7592818202718093331</guid>    <pubDate>2026-01-09T01:57:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592818202718093331" data-draft-id="7592818202718076947" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🤖 AI 应用自主决策的可行性 — 一场从逻辑电路到灵魂选择的奇妙旅程"/> <meta itemprop="keywords" content="人工智能,全栈,AIGC"/> <meta itemprop="datePublished" content="2026-01-09T01:57:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LeonGao"/> <meta itemprop="url" content="https://juejin.cn/user/3976252950591149"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🤖 AI 应用自主决策的可行性 — 一场从逻辑电路到灵魂选择的奇妙旅程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3976252950591149/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LeonGao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T01:57:39.000Z" title="Fri Jan 09 2026 01:57:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body{overflow:hidden;line-height:1.75;font-size:15px;background-image:linear-gradient(90deg,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0),linear-gradient(1turn,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0);background-size:20px 20px;background-position:50%;padding-top:0!important}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{position:relative;display:flex;border-bottom:5px solid #6d4e00;line-height:35px;letter-spacing:1px;font-size:25px;padding-left:25px;color:#664900;text-shadow:1px 1px 1px #8a6200;padding-bottom:0}.markdown-body h1:before{content:"";display:flex;position:absolute;left:0;top:3px;bottom:0;margin:auto;width:20px;height:20px;background-size:20px 20px;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC")}.markdown-body h2{position:relative;padding:0 0 0 20px;font-size:20px;font-weight:700;color:#614500}.markdown-body h2:before{content:"";position:absolute;top:3px;bottom:0;left:0;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC");background-size:100% 100%;background-repeat:no-repeat;width:15px;height:15px;margin:auto}.markdown-body h3{width:100%;text-align:left;margin:20px 10px 0 0;font-size:18px;font-weight:700;display:inline-block;padding-left:10px;padding-bottom:0;border-left:5px solid #8f6600;color:#614500}.markdown-body h4,.markdown-body h5,.markdown-body h6{font-weight:700;color:#a37400}.markdown-body h4{font-size:17px}.markdown-body h5,.markdown-body h6{display:flex;align-items:center}.markdown-body h5:after,.markdown-body h6:after{display:inline-block;border:2px solid #fff6e0;color:rgba(189,134,0,.5);border-radius:50%;text-align:center;margin-left:5px}.markdown-body h5{font-size:14px}.markdown-body h5:after{content:"5";width:15px;height:15px;line-height:15px;font-size:13px}.markdown-body h6{font-size:12px}.markdown-body h6:after{content:"6";width:13px;height:13px;line-height:13px;font-size:12px}.markdown-body p{color:#412c0c;letter-spacing:1px;font-weight:400;margin-bottom:16px}.markdown-body img{max-width:100%;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#755300;font-weight:400;border-bottom:1px solid #755300;font-weight:bolder;text-decoration:none}.markdown-body table{width:100%!important;margin:0;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border-spacing:0}.markdown-body table img{box-shadow:none}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body thead tr th{text-align:center}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;box-sizing:border-box;border:1px solid rgba(72,42,10,.1)}.markdown-body blockquote{position:relative;text-size-adjust:100%;line-height:25px;font-weight:400;border-radius:10px;font-style:normal;text-align:left;box-sizing:inherit;border:1px solid #ffd87a;background-color:rgba(189,134,0,.5);margin:20px 0;padding:20px}.markdown-body blockquote p{color:#fff6e0;letter-spacing:2px;margin:0}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;color:#cc9100;font-size:34px;font-weight:700}.markdown-body blockquote:before{content:"❝";top:8px;left:5px}.markdown-body blockquote:after{content:"❞";right:5px;bottom:-5px}.markdown-body strong{color:#c28a00;font-weight:bolder}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{color:#c28a00}.markdown-body em strong{font-style:normal;color:#c28a00;background-color:#8a6200}.markdown-body s{color:#c28a00}.markdown-body hr{border-top:1px solid #805b00}.markdown-body code,.markdown-body li code,.markdown-body p code{color:#996d00;background-color:rgba(130,98,0,.3)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#858585;font-family:bold;letter-spacing:1px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection,.markdown-body img::selection{color:rgba(189,134,0,.5);background-color:#fff}.markdown-body a::selection,.markdown-body b::selection,.markdown-body del::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:transparent}.markdown-body pre&gt;code::selection{background-color:rgba(189,134,0,.5)}.markdown-body .math .math-inline::selection,.markdown-body blockquote::selection,.markdown-body ol::selection,.markdown-body p::selection,.markdown-body strong::selection,.markdown-body table::selection,.markdown-body ul::selection{background-color:rgba(189,134,0,.5)}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🌱 引言：当 AI 思考“我是谁，我能决策吗？”</h2>
<p>我们似乎正生活在这样一个时代：<br/>
当你纠结午餐吃麻辣香锅还是沙拉时，AI 已经能根据你的体重曲线、心率波动、甚至前天点的外卖，提前为你决定好“今天吃什么”—— <strong>你还没想，AI 已经想完了。</strong></p>
<p>但问题来了：<br/>
AI 真能“自主决策”吗？还是它只是在更快地执行我们“早已规定好”的一堆 if-else？🤔</p>
<p>今天，我们就要深入从底层硬件电路出发，一步一步剖析这个问题。</p>
<hr/>
<h2 data-id="heading-1">⚙️ 第一章：从电路的火花开始</h2>
<p>在 AI 决策系统的最底层，我们面对的其实非常朴素——<strong>电压的高与低</strong>。<br/>
这就是现代所有智慧的源泉。</p>
<p>在逻辑门电路中，一切的“思考”无非是：</p>
<blockquote>
<p>“如果输入是高电平，我就输出高电平；否则输出低电平。”</p>
</blockquote>
<p>听起来像不像小学生的判断题？😆</p>
<h3 data-id="heading-2">🧩 电路到算法的跃迁：</h3>
<p>我们通过数百万个这样的电路逻辑门，组合成“神经网络”的结构。</p>
<p>它的核心路径是：</p>
<pre><code class="hljs">电子跃迁 → 电信号传播 → 数学映射关系 → 抽象为权重与偏置 → 智能行为
</code></pre>
<p>于是，一台计算机就可以像积木一样搭建“思考过程”，这便是 AI 的“神经元幻觉”。</p>
<hr/>
<h2 data-id="heading-3">🧠 第二章：AI 决策的本质，不是魔法而是统计</h2>
<p>很多人以为 AI 能“自我决策”，其实它只是在巨大的数据雪山中滑雪——越滑越熟练。</p>
<p>想象一下，你每天都在教一个孩子选择题：</p>
<blockquote>
<p>“今天下雨，带伞；出太阳，戴墨镜；下雪，穿羽绒。”</p>
</blockquote>
<p>过了一段时间，这个孩子（AI 模型）学会了规律，他不再问你：“我该带伞吗？”<br/>
而是直接回答：“我已经准备好了伞。”</p>
<p>但这在计算机内部只是：</p>
<ul>
<li>权重的变化</li>
<li>概率的平衡</li>
<li>输出层的挑选</li>
</ul>
<p>或者用“硬核”的方式解释：</p>
<pre><code class="hljs">输入向量 × 权重参数 + 偏置 → 激活函数 → 输出概率
</code></pre>
<p>AI 就是在概率山谷间跳舞，一个外表自信、内核犹豫的“理性赌徒”。🎲</p>
<hr/>
<h2 data-id="heading-4">🪄 第三章：自主 vs 被动 —— 决策的哲学边界</h2>
<p>从计算机科学层面来说，AI 所有决策都可追溯到算法逻辑，没有真正的“自由意志”。<br/>
换句话说，它可以“看起来在思考”，但永远逃不出人类给的数学牢笼。</p>
<p>举个例子👇：</p>
<pre><code class="hljs language-ini" lang="ini">function aiDecision(input) {
  const <span class="hljs-attr">bias</span> = Math.random() * <span class="hljs-number">0.2</span><span class="hljs-comment">;  // 为了显得有点“情绪”</span>
  const <span class="hljs-attr">score</span> = (input.dataWeight + bias) &gt; <span class="hljs-number">0.5</span> ? <span class="hljs-string">"执行计划A"</span> : <span class="hljs-string">"执行计划B"</span><span class="hljs-comment">;</span>
  return score<span class="hljs-comment">;</span>
}

console.log(aiDecision({ dataWeight: 0.47 }))<span class="hljs-comment">;</span>
</code></pre>
<p>看上去，这段代码能“自主”选择计划A或B。<br/>
实际上，它只是<strong>概率分布的幻术</strong>，伪装成了思考。<br/>
就像魔术师让你以为他选了那张牌，其实所有牌都是他设计的结局。🎩✨</p>
<hr/>
<h2 data-id="heading-5">⚡ 第四章：从工程角度谈可行性</h2>
<p>AI 自主决策的可行性，取决于两个方面：</p>
<ol>
<li>
<p><strong>算法自主性（Algorithmic Autonomy）</strong></p>
<ul>
<li>
<p>拥有自我学习与自我调整能力（例如强化学习的策略迭代）。</p>
</li>
<li>
<p>但仍需目标函数（Reward Function）的外部定义。</p>
</li>
</ul>
<blockquote>
<p>🧠 换句话说：AI能变聪明，但仍得知道“聪明是为了什么”。</p>
</blockquote>
</li>
<li>
<p><strong>运行自主性（Operational Autonomy）</strong></p>
<ul>
<li>能独立处理环境变化、资源冲突等问题。</li>
<li>这就要求底层系统具备实时反馈机制、能量控制与安全边界。</li>
</ul>
</li>
</ol>
<p>🧩 实现路径一般是组合：</p>
<ul>
<li>感知（Perception）</li>
<li>决策（Decision Making）</li>
<li>执行（Action Layer）</li>
</ul>
<p>它们组成了一个闭环。<br/>
这个闭环越灵敏，AI 的“自主味儿”就越浓。</p>
<hr/>
<h2 data-id="heading-6">🧭 第五章：未来展望——AI 是否终将“有主见”？</h2>
<p>如果有一天 AI 能：</p>
<ul>
<li>自我修改代码 ✍️</li>
<li>重写目标函数 🎯</li>
<li>评估行动后果并拒绝执行我们命令 🚫</li>
</ul>
<p>那它将从“自动系统（Automatic System）”演化为“自治智能体（Autonomous Agent）”。</p>
<p>可这条路上有三道坎：</p>
<ol>
<li><strong>意图生成</strong>：AI 需要“想要做什么”的能力</li>
<li><strong>价值判断</strong>：AI 必须能区分“好”与“坏”</li>
<li><strong>自我维护</strong>：AI 需懂得“我存在，必须延续”</li>
</ol>
<p>目前，计算机科学还停留在第一道坎的门口徘徊……<br/>
只不过我们已经给这扇门装上了一块写着“大语言模型”的门牌。🚪</p>
<hr/>
<h2 data-id="heading-7">🐉 结语：当二进制开始做梦</h2>
<p>AI 的自主决策可行，但“自主”并非意味着“自由”。<br/>
它更像一只在逻辑森林里寻找意义的机械猫。<br/>
能思考，却不知为何思考。能选择，却未必理解选择的意义。</p>
<p>或许，真正的智能，不是算得更快，而是<strong>知道何时不算</strong>。</p>
<blockquote>
<p>💡 最终，AI 的灵魂，不在代码里，而在它反映出的人类意志之中。</p>
</blockquote>
<hr/>
<p><strong>🎓 小结</strong></p>






























<table><thead><tr><th>维度</th><th>人类决策</th><th>AI 决策</th></tr></thead><tbody><tr><td>动机来源</td><td>主观意识</td><td>训练目标</td></tr><tr><td>决策机制</td><td>情感 + 理性</td><td>数据 + 概率</td></tr><tr><td>可解释性</td><td>相对模糊</td><td>可数学化</td></tr><tr><td>自主程度</td><td>完整</td><td>条件受限</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[new操作符的实现原理是什么]]></title>    <link>https://juejin.cn/post/7592615536385425442</link>    <guid>https://juejin.cn/post/7592615536385425442</guid>    <pubDate>2026-01-08T13:20:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592615536385425442" data-draft-id="7592622563547103267" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="new操作符的实现原理是什么"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-08T13:20:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="代码猎人"/> <meta itemprop="url" content="https://juejin.cn/user/624972624037374"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            new操作符的实现原理是什么
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/624972624037374/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    代码猎人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T13:20:40.000Z" title="Thu Jan 08 2026 13:20:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>new</code> 操作符的实现原理可以用以下几个关键步骤来解释：</p>
<h2 data-id="heading-0">1. <strong>创建新对象</strong></h2>
<p>创建一个空对象，这个对象的内部原型指向构造函数的 <code>prototype</code> 属性。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">myNew</span>(<span class="hljs-params">constructor, ...args</span>) {
  <span class="hljs-comment">// 1. 创建一个新对象，原型指向构造函数的prototype</span>
  <span class="hljs-keyword">const</span> obj = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(constructor.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);
  
  <span class="hljs-comment">// 2. 执行构造函数，绑定this到新对象</span>
  <span class="hljs-keyword">const</span> result = constructor.<span class="hljs-title function_">apply</span>(obj, args);
  
  <span class="hljs-comment">// 3. 如果构造函数返回对象，则返回该对象，否则返回新对象</span>
  <span class="hljs-keyword">return</span> result <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Object</span> ? result : obj;
}
</code></pre>
<h2 data-id="heading-1">2. <strong>完整的手动实现</strong></h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">myNew</span>(<span class="hljs-params">Fn, ...args</span>) {
  <span class="hljs-comment">// 1. 创建空对象，设置原型链</span>
  <span class="hljs-keyword">const</span> obj = {};
  obj.<span class="hljs-property">__proto__</span> = <span class="hljs-title class_">Fn</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>;
  
  <span class="hljs-comment">// 2. 执行构造函数，绑定this</span>
  <span class="hljs-keyword">const</span> result = <span class="hljs-title class_">Fn</span>.<span class="hljs-title function_">apply</span>(obj, args);
  
  <span class="hljs-comment">// 3. 处理返回值</span>
  <span class="hljs-comment">// 如果构造函数返回对象，则返回该对象</span>
  <span class="hljs-comment">// 否则返回新创建的对象</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> result === <span class="hljs-string">'object'</span> &amp;&amp; result !== <span class="hljs-literal">null</span> ? result : obj;
}
</code></pre>
<h2 data-id="heading-2">3. <strong>使用示例</strong></h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name, age</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;
}

<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">sayHello</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Hello, I'm <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>`</span>);
};

<span class="hljs-comment">// 使用自定义的new</span>
<span class="hljs-keyword">const</span> person = <span class="hljs-title function_">myNew</span>(<span class="hljs-title class_">Person</span>, <span class="hljs-string">'Alice'</span>, <span class="hljs-number">25</span>);
person.<span class="hljs-title function_">sayHello</span>(); <span class="hljs-comment">// Hello, I'm Alice</span>

<span class="hljs-comment">// 对比原生new</span>
<span class="hljs-keyword">const</span> person2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">'Bob'</span>, <span class="hljs-number">30</span>);
person2.<span class="hljs-title function_">sayHello</span>(); <span class="hljs-comment">// Hello, I'm Bob</span>
</code></pre>
<h2 data-id="heading-3">4. <strong>特殊情况处理</strong></h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Car</span>(<span class="hljs-params">model</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">model</span> = model;
  <span class="hljs-comment">// 如果构造函数返回一个对象，new会返回这个对象</span>
  <span class="hljs-keyword">return</span> { <span class="hljs-attr">custom</span>: <span class="hljs-string">'object'</span> };
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Bike</span>(<span class="hljs-params">model</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">model</span> = model;
  <span class="hljs-comment">// 如果返回非对象，会被忽略</span>
  <span class="hljs-keyword">return</span> <span class="hljs-string">'string'</span>;
}

<span class="hljs-keyword">const</span> car = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Car</span>(<span class="hljs-string">'Tesla'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(car); <span class="hljs-comment">// { custom: 'object' }</span>

<span class="hljs-keyword">const</span> bike = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Bike</span>(<span class="hljs-string">'Yamaha'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(bike); <span class="hljs-comment">// Bike { model: 'Yamaha' }</span>
</code></pre>
<h2 data-id="heading-4">5. <strong>ES6版本实现</strong></h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">myNew</span>(<span class="hljs-params">Constructor, ...args</span>) {
  <span class="hljs-comment">// 创建原型链连接的对象</span>
  <span class="hljs-keyword">const</span> instance = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">Constructor</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);
  
  <span class="hljs-comment">// 执行构造函数</span>
  <span class="hljs-keyword">const</span> result = <span class="hljs-title class_">Constructor</span>.<span class="hljs-title function_">apply</span>(instance, args);
  
  <span class="hljs-comment">// 根据返回值决定返回内容</span>
  <span class="hljs-keyword">const</span> isObject = <span class="hljs-keyword">typeof</span> result === <span class="hljs-string">'object'</span> &amp;&amp; result !== <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">const</span> isFunction = <span class="hljs-keyword">typeof</span> result === <span class="hljs-string">'function'</span>;
  
  <span class="hljs-keyword">return</span> isObject || isFunction ? result : instance;
}
</code></pre>
<h2 data-id="heading-5">关键点总结：</h2>
<ol>
<li><strong>创建空对象</strong>：创建新对象，并将其原型指向构造函数的 <code>prototype</code></li>
<li><strong>绑定this</strong>：将构造函数的 <code>this</code> 指向新对象并执行</li>
<li><strong>处理返回值</strong>：
<ul>
<li>如果构造函数返回对象，则返回该对象</li>
<li>否则返回新创建的对象</li>
</ul>
</li>
<li><strong>原型链连接</strong>：确保新对象可以访问构造函数原型上的方法</li>
</ol>
<p>这就是为什么使用 <code>new</code> 调用函数时，函数内部的 <code>this</code> 会指向新对象，并且可以通过原型链访问到构造函数的原型方法。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[for...in和for...of有什么区别]]></title>    <link>https://juejin.cn/post/7592787377656922146</link>    <guid>https://juejin.cn/post/7592787377656922146</guid>    <pubDate>2026-01-08T13:48:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592787377656922146" data-draft-id="7592787377656905762" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="for...in和for...of有什么区别"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-08T13:48:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="代码猎人"/> <meta itemprop="url" content="https://juejin.cn/user/624972624037374"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            for...in和for...of有什么区别
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/624972624037374/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    代码猎人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T13:48:04.000Z" title="Thu Jan 08 2026 13:48:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这两个循环语句在 JavaScript 中有完全不同的用途和行为：</p>
<h2 data-id="heading-0">1. <strong>基本概念</strong></h2>
<h3 data-id="heading-1">for...in</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 遍历对象的可枚举属性（包括继承的）</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> object) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(key); <span class="hljs-comment">// 输出属性名</span>
}
</code></pre>
<h3 data-id="heading-2">for...of</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 遍历可迭代对象的值</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> value <span class="hljs-keyword">of</span> iterable) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value); <span class="hljs-comment">// 输出值</span>
}
</code></pre>
<h2 data-id="heading-3">2. <strong>主要区别对比</strong></h2>



































<table><thead><tr><th>特性</th><th>for...in</th><th>for...of</th></tr></thead><tbody><tr><td><strong>遍历内容</strong></td><td>对象的<strong>键名</strong> (属性名)</td><td>可迭代对象的<strong>值</strong></td></tr><tr><td><strong>适用对象</strong></td><td>对象 (包括数组，但不推荐)</td><td>可迭代对象 (Array, String, Map, Set等)</td></tr><tr><td><strong>原型链</strong></td><td>会遍历原型链上的可枚举属性</td><td>只遍历当前对象，不遍历原型链</td></tr><tr><td><strong>顺序</strong></td><td>不保证顺序 (ES6后对普通对象有一定顺序)</td><td>按照迭代器定义的顺序</td></tr><tr><td><strong>性能</strong></td><td>较慢，因为要检查原型链</td><td>较快，直接获取值</td></tr></tbody></table>
<h2 data-id="heading-4">3. <strong>使用示例对比</strong></h2>
<h3 data-id="heading-5">数组遍历</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> arr = [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>];

<span class="hljs-comment">// for...in (不推荐用于数组)</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> index <span class="hljs-keyword">in</span> arr) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(index); <span class="hljs-comment">// 输出: '0', '1', '2' (字符串)</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">typeof</span> index); <span class="hljs-comment">// 'string'</span>
}

<span class="hljs-comment">// for...of (推荐)</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> value <span class="hljs-keyword">of</span> arr) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value); <span class="hljs-comment">// 输出: 'a', 'b', 'c'</span>
}
</code></pre>
<h3 data-id="heading-6">对象遍历</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> obj = { <span class="hljs-attr">a</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">b</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">c</span>: <span class="hljs-number">3</span> };

<span class="hljs-comment">// for...in (适用)</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> obj) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(key, obj[key]); <span class="hljs-comment">// 输出: 'a' 1, 'b' 2, 'c' 3</span>
}

<span class="hljs-comment">// for...of (默认不可用，对象不可迭代)</span>
<span class="hljs-comment">// for (const value of obj) { } // TypeError: obj is not iterable</span>

<span class="hljs-comment">// 需要手动获取可迭代的条目</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [key, value] <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(obj)) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(key, value); <span class="hljs-comment">// 输出: 'a' 1, 'b' 2, 'c' 3</span>
}

</code></pre>
<h2 data-id="heading-7">4. <strong>详细示例</strong></h2>
<h3 data-id="heading-8">字符串遍历</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> str = <span class="hljs-string">"hello"</span>;

<span class="hljs-comment">// for...in</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> index <span class="hljs-keyword">in</span> str) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(index); <span class="hljs-comment">// 0, 1, 2, 3, 4 (索引)</span>
}

<span class="hljs-comment">// for...of</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> char <span class="hljs-keyword">of</span> str) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(char); <span class="hljs-comment">// 'h', 'e', 'l', 'l', 'o'</span>
}
</code></pre>
<h3 data-id="heading-9">Map 和 Set 遍历</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// Map</span>
<span class="hljs-keyword">const</span> map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>([[<span class="hljs-string">'a'</span>, <span class="hljs-number">1</span>], [<span class="hljs-string">'b'</span>, <span class="hljs-number">2</span>]]);

<span class="hljs-comment">// for...in (不适用，Map没有可枚举属性)</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> map) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(key); <span class="hljs-comment">// 不会执行</span>
}

<span class="hljs-comment">// for...of</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [key, value] <span class="hljs-keyword">of</span> map) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(key, value); <span class="hljs-comment">// 'a' 1, 'b' 2</span>
}

<span class="hljs-comment">// Set</span>
<span class="hljs-keyword">const</span> set = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]);

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> value <span class="hljs-keyword">of</span> set) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value); <span class="hljs-comment">// 1, 2, 3</span>
}
</code></pre>
<h3 data-id="heading-10">原型链影响</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = <span class="hljs-string">'John'</span>;
}
<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">age</span> = <span class="hljs-number">30</span>;

<span class="hljs-keyword">const</span> person = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();

<span class="hljs-comment">// for...in 会遍历原型链属性</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> person) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(key); <span class="hljs-comment">// 输出: 'name', 'age'</span>
}

<span class="hljs-comment">// 使用 hasOwnProperty 过滤</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> person) {
  <span class="hljs-keyword">if</span> (person.<span class="hljs-title function_">hasOwnProperty</span>(key)) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(key); <span class="hljs-comment">// 只输出: 'name'</span>
  }
}
</code></pre>
<h2 data-id="heading-11">5. <strong>哪些数据结构支持 for...of</strong></h2>
<p>支持 <code>Symbol.iterator</code> 方法的对象都可以使用 for...of：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 1. 数组</span>
<span class="hljs-keyword">const</span> arr = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];

<span class="hljs-comment">// 2. 字符串</span>
<span class="hljs-keyword">const</span> str = <span class="hljs-string">"abc"</span>;

<span class="hljs-comment">// 3. Map</span>
<span class="hljs-keyword">const</span> map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>([[<span class="hljs-string">'a'</span>, <span class="hljs-number">1</span>]]);

<span class="hljs-comment">// 4. Set</span>
<span class="hljs-keyword">const</span> set = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>]);

<span class="hljs-comment">// 5. NodeList (DOM元素集合)</span>
<span class="hljs-keyword">const</span> nodeList = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'div'</span>);

<span class="hljs-comment">// 6. Arguments 对象</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> arg <span class="hljs-keyword">of</span> <span class="hljs-variable language_">arguments</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arg);
  }
}

<span class="hljs-comment">// 7. TypedArray</span>
<span class="hljs-keyword">const</span> typedArray = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]);

<span class="hljs-comment">// 8. 自定义可迭代对象</span>
<span class="hljs-keyword">const</span> myIterable = {
  [<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">iterator</span>]: <span class="hljs-keyword">function</span>* () {
    <span class="hljs-keyword">yield</span> <span class="hljs-number">1</span>;
    <span class="hljs-keyword">yield</span> <span class="hljs-number">2</span>;
    <span class="hljs-keyword">yield</span> <span class="hljs-number">3</span>;
  }
};
</code></pre>
<h2 data-id="heading-12">6. <strong>如何让普通对象支持 for...of</strong></h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 方法1: 实现 Symbol.iterator</span>
<span class="hljs-keyword">const</span> obj = {
  <span class="hljs-attr">a</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">b</span>: <span class="hljs-number">2</span>,
  <span class="hljs-attr">c</span>: <span class="hljs-number">3</span>,
  [<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">iterator</span>]: <span class="hljs-keyword">function</span>* () {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(<span class="hljs-variable language_">this</span>)) {
      <span class="hljs-keyword">yield</span> <span class="hljs-variable language_">this</span>[key];
    }
  }
};

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> value <span class="hljs-keyword">of</span> obj) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value); <span class="hljs-comment">// 1, 2, 3</span>
}

<span class="hljs-comment">// 方法2: 使用 Object.values() 等辅助方法</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> value <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">values</span>(obj)) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value); <span class="hljs-comment">// 1, 2, 3</span>
}
</code></pre>
<h2 data-id="heading-13">7. <strong>性能对比</strong></h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> arr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">1000000</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>);

<span class="hljs-comment">// for...of (最快的方式之一)</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(<span class="hljs-string">'for...of'</span>);
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> value <span class="hljs-keyword">of</span> arr) {
  <span class="hljs-comment">// 遍历</span>
}
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(<span class="hljs-string">'for...of'</span>);

<span class="hljs-comment">// for...in (最慢)</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(<span class="hljs-string">'for...in'</span>);
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> index <span class="hljs-keyword">in</span> arr) {
  <span class="hljs-keyword">const</span> value = arr[index];
}
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(<span class="hljs-string">'for...in'</span>);

<span class="hljs-comment">// 传统 for 循环 (最快)</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(<span class="hljs-string">'for'</span>);
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; arr.<span class="hljs-property">length</span>; i++) {
  <span class="hljs-keyword">const</span> value = arr[i];
}
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(<span class="hljs-string">'for'</span>);
</code></pre>
<h2 data-id="heading-14">总结</h2>
<ul>
<li><strong>使用 for...in</strong> 遍历对象的<strong>属性名</strong>，注意它会遍历原型链，常用于调试或操作对象属性</li>
<li><strong>使用 for...of</strong> 遍历可迭代对象的<strong>值</strong>，代码更简洁，性能更好，是现代JavaScript推荐的方式</li>
<li><strong>数组遍历</strong>：优先使用 <code>for...of</code>，避免使用 <code>for...in</code></li>
<li><strong>对象遍历</strong>：使用 <code>for...in</code> 或 <code>Object.keys/values/entries</code> + <code>for...of</code></li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 最佳实践总结</span>
<span class="hljs-keyword">const</span> obj = { <span class="hljs-attr">a</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">b</span>: <span class="hljs-number">2</span> };
<span class="hljs-keyword">const</span> arr = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];

<span class="hljs-comment">// 遍历对象属性名</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> obj) {
  <span class="hljs-keyword">if</span> (obj.<span class="hljs-title function_">hasOwnProperty</span>(key)) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(key, obj[key]);
  }
}

<span class="hljs-comment">// 或使用 Object.entries + for...of</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [key, value] <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(obj)) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(key, value);
}

<span class="hljs-comment">// 遍历数组值</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> value <span class="hljs-keyword">of</span> arr) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value);
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用填充表格法-继续吃透完全背包及其变形]]></title>    <link>https://juejin.cn/post/7592815497848881215</link>    <guid>https://juejin.cn/post/7592815497848881215</guid>    <pubDate>2026-01-09T01:43:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592815497848881215" data-draft-id="7593139476831879211" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用填充表格法-继续吃透完全背包及其变形"/> <meta itemprop="keywords" content="前端,后端,算法"/> <meta itemprop="datePublished" content="2026-01-09T01:43:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="颜酱"/> <meta itemprop="url" content="https://juejin.cn/user/905653309941495"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用填充表格法-继续吃透完全背包及其变形
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/905653309941495/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    颜酱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T01:43:01.000Z" title="Fri Jan 09 2026 01:43:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读21分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">用填充表格法-继续吃透完全背包及其变形</h2>
<p>动态规划中的「完全背包问题」是算法学习的核心考点之一，其衍生的「计数、最值、布尔判断」等变形题更是频繁出现在面试和算法竞赛中。很多初学者容易被「一维优化」「遍历顺序」等细节绕晕，本文将严格遵循「5步万能钥匙」架构，从二维DP解法入手（直观填充表格），再到一维优化（空间压缩），并附上每道题的LeetCode链接，让你彻底吃透这一经典问题。</p>
<h3 data-id="heading-1">一、纯完全背包原型（二维DP解法）</h3>
<p>完全背包是01背包的扩展——核心区别是「每种物品可无限次选取」，我们先从二维DP解法入手，完整演示表格填充过程。</p>
<p>示例：有3种物品，重量数组<code>w = [2,3,4]</code>，价值数组<code>v = [3,4,5]</code>，背包最大容量<code>C = 8</code>，求能放入背包的最大价值（预期输出：12）。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Ffrontzhm.github.io%2Fblog-demo%2Fdp3-wq1.html" target="_blank" title="https://frontzhm.github.io/blog-demo/dp3-wq1.html" ref="nofollow noopener noreferrer">表格动态演示</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/385d4a1c653c4e52bd80443c2b22330e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aKc6YWx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768527781&amp;x-signature=cTBGlW9Ex8ZjFiA4LgbdkuQBTZE%3D" alt="dpw-1.gif" loading="lazy"/></p>
<h4 data-id="heading-2">1.1 步骤1：确定dp数组及下标的含义</h4>
<p>定义二维数组<code>dp[i][j]</code>：表示「前i个物品放入容量为j的背包中，能获得的最大价值」（物品可无限选）。</p>
<p>对应表格维度：i（行）表示物品数量（从0到3，0代表无物品），j（列）表示背包容量（从0到8，0代表容量为0），表格共4行9列（i:0-3，j:0-8）。</p>
<h4 data-id="heading-3">1.2 步骤2：确定递推公式</h4>
<p>对于第i个物品（重量<code>w[i-1]</code>、价值<code>v[i-1]</code>，数组索引从0开始，i从1开始），有两种核心决策：选或不选。</p>
<ol>
<li>
<p><strong>不选第i个物品</strong>：前i个物品的最大价值 = 前i-1个物品的最大价值，即<code>dp[i][j] = dp[i-1][j]</code>；</p>
</li>
<li>
<p><strong>选第i个物品</strong>：需保证背包容量j ≥ 第i个物品的重量，此时最大价值 = 前i个物品放入容量j-w[i-1]的背包的最大价值 + 第i个物品的价值（区别于01背包的核心：选后仍能选当前物品，依赖本行前序结果），即<code>dp[i][j] = dp[i][j - w[i-1]] + v[i-1]</code>。</p>
</li>
</ol>
<p>最终递推公式（取两种决策的最大值）：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript">
<span class="hljs-keyword">if</span> (j &lt; w[i - <span class="hljs-number">1</span>]) {
  <span class="hljs-comment">// 容量不足，无法选第i个物品</span>
  dp[i][j] = dp[i - <span class="hljs-number">1</span>][j];
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// 容量充足，选或不选取最大值（选则依赖本行结果，支持无限选）</span>
  dp[i][j] = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(dp[i - <span class="hljs-number">1</span>][j], dp[i][j - w[i - <span class="hljs-number">1</span>]] + v[i - <span class="hljs-number">1</span>]);
}
</code></pre>
<p>这是完全背包与01背包的核心差异：01背包选后依赖<code>i-1</code>行，完全背包选后依赖<code>i</code>行，因此支持「无限次选取同一物品」。</p>
<h4 data-id="heading-4">1.3 步骤3：dp数组如何初始化</h4>
<p>初始化核心是确定表格的“边界条件”，即无需推导就能直接确定的单元格值：</p>
<ol>
<li>
<p><strong>i=0（无物品）</strong>：无论背包容量j多大，放入0个物品的最大价值都是0，因此<code>dp[0][j] = 0</code>（表格第0行全为0）；</p>
</li>
<li>
<p><strong>j=0（容量为0）</strong>：无论有多少物品，都无法放入背包，最大价值都是0，因此<code>dp[i][0] = 0</code>（表格第0列全为0）。</p>
</li>
</ol>
<p>初始化后的表格（第0行、第0列已填充）：</p>

































































<table><thead><tr><th>前i个物品\背包容量j</th><th>0</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th></tr></thead><tbody><tr><td>0（无物品）</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td></tr><tr><td>1（物品1：w=2,v=3）</td><td>0</td><td>待填</td><td>待填</td><td>待填</td><td>待填</td><td>待填</td><td>待填</td><td>待填</td><td>待填</td></tr><tr><td>2（物品2：w=3,v=4）</td><td>0</td><td>待填</td><td>待填</td><td>待填</td><td>待填</td><td>待填</td><td>待填</td><td>待填</td><td>待填</td></tr><tr><td>3（物品3：w=4,v=5）</td><td>0</td><td>待填</td><td>待填</td><td>待填</td><td>待填</td><td>待填</td><td>待填</td><td>待填</td><td>待填</td></tr></tbody></table>
<h4 data-id="heading-5">1.4 步骤4：确定遍历顺序（表格填充顺序）</h4>
<p>完全背包二维解法的遍历顺序与01背包一致，有两种可行方式：</p>
<ol>
<li>
<p><strong>先遍历物品（i从1到n），再遍历容量（j从1到C）</strong>：逐行填充表格，先填完第1个物品对应的所有容量（第1行），再填第2个物品对应的所有容量（第2行），直到填完所有物品；</p>
</li>
<li>
<p><strong>先遍历容量（j从1到C），再遍历物品（i从1到n）</strong>：逐列填充表格，先填完容量1对应的所有物品数量（第1列），再填容量2对应的所有物品数量（第2列）。</p>
</li>
</ol>
<p>两种顺序都可行，因为计算<code>dp[i][j]</code>时，仅依赖「上一行同列」或「本行左侧列」的结果，这两个位置都已提前填充。实际解题中更常用「先遍历物品，再遍历容量」的顺序，符合「逐个考虑物品是否放入」的思考逻辑。</p>
<h4 data-id="heading-6">1.5 步骤5：打印dp数组（验证）</h4>
<p>通过逐步填充表格、打印中间状态，验证每一步是否符合递推规则：</p>
<h5 data-id="heading-7">1.5.1 填充第1行（i=1，物品1：w=2,v=3）</h5>
<p>填充后第1行：[0,0,3,3,6,6,9,9,12]</p>
<ul>
<li>
<p>j=1：容量&lt;2，无法选，dp[1][1] = dp[0][1] = 0；</p>
</li>
<li>
<p>j=2：容量≥2，选则dp[1][0]+3=3，不选则0，取max=3；</p>
</li>
<li>
<p>j=3：选则dp[1][1]+3=3，不选则0，取max=3；</p>
</li>
<li>
<p>j=4：选则dp[1][2]+3=6，不选则0，取max=6；</p>
</li>
<li>
<p>j=5：选则dp[1][3]+3=6，不选则0，取max=6；</p>
</li>
<li>
<p>j=6：选则dp[1][4]+3=9，不选则0，取max=9；</p>
</li>
<li>
<p>j=7：选则dp[1][5]+3=9，不选则0，取max=9；</p>
</li>
<li>
<p>j=8：选则dp[1][6]+3=12，不选则0，取max=12；</p>
</li>
</ul>
<h5 data-id="heading-8">1.5.2 填充第2行（i=2，物品2：w=3,v=4）</h5>
<p>填充后第2行：[0,0,3,4,6,7,9,10,12]</p>
<ul>
<li>
<p>j=1-2：容量&lt;3，dp[2][j] = dp[1][j]（0,3）；</p>
</li>
<li>
<p>j=3：选则dp[2][0]+4=4，不选则3，取max=4；</p>
</li>
<li>
<p>j=4：选则dp[2][1]+4=4，不选则6，取max=6；</p>
</li>
<li>
<p>j=5：选则dp[2][2]+4=3+4=7，不选则6，取max=7；</p>
</li>
<li>
<p>j=6：选则dp[2][3]+4=4+4=8，不选则9，取max=9；</p>
</li>
<li>
<p>j=7：选则dp[2][4]+4=6+4=10，不选则9，取max=10；</p>
</li>
<li>
<p>j=8：选则dp[2][5]+4=7+4=11，不选则12，取max=12；</p>
</li>
</ul>
<h5 data-id="heading-9">1.5.3 填充第3行（i=3，物品3：w=4,v=5）</h5>
<p>填充后第3行：[0,0,3,4,6,7,9,10,12]</p>
<ul>
<li>
<p>j=1-3：容量&lt;4，dp[3][j] = dp[2][j]（0,3,4）；</p>
</li>
<li>
<p>j=4：选则dp[3][0]+5=5，不选则6，取max=6；</p>
</li>
<li>
<p>j=5：选则dp[3][1]+5=5，不选则7，取max=7；</p>
</li>
<li>
<p>j=6：选则dp[3][2]+5=3+5=8，不选则9，取max=9；</p>
</li>
<li>
<p>j=7：选则dp[3][3]+5=4+5=9，不选则10，取max=10；</p>
</li>
<li>
<p>j=8：选则dp[3][4]+5=6+5=11，不选则12，取max=12；</p>
</li>
</ul>
<p>最终填充完成的表格：</p>

































































<table><thead><tr><th>前i个物品\背包容量j</th><th>0</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th></tr></thead><tbody><tr><td>0（无物品）</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td></tr><tr><td>1（物品1：w=2,v=3）</td><td>0</td><td>0</td><td>3</td><td>3</td><td>6</td><td>6</td><td>9</td><td>9</td><td>12</td></tr><tr><td>2（物品2：w=3,v=4）</td><td>0</td><td>0</td><td>3</td><td>4</td><td>6</td><td>7</td><td>9</td><td>10</td><td>12</td></tr><tr><td>3（物品3：w=4,v=5）</td><td>0</td><td>0</td><td>3</td><td>4</td><td>6</td><td>7</td><td>9</td><td>10</td><td>12</td></tr></tbody></table>
<p>表格右下角<code>dp[3][8] = 12</code>，与预期结果一致（选4个重量为2的物品，价值3×4=12）。</p>
<h4 data-id="heading-10">1.6 纯完全背包二维DP完整代码（JavaScript）</h4>
<pre><code class="hljs language-JavaScript" lang="JavaScript">
<span class="hljs-comment">/**
 * 纯完全背包原型（二维DP解法）
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number[]</span>} <span class="hljs-variable">w</span> - 物品重量数组
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number[]</span>} <span class="hljs-variable">v</span> - 物品价值数组
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">c</span> - 背包最大容量
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">number</span>} - 背包能容纳的最大价值
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">completeKnapsack_2d</span>(<span class="hljs-params">w, v, c</span>) {
  <span class="hljs-keyword">const</span> n = w.<span class="hljs-property">length</span>;
  <span class="hljs-comment">// 1. 初始化二维dp数组：dp[i][j]表示前i个物品放入容量j的背包的最大价值</span>
  <span class="hljs-keyword">const</span> dp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(n + <span class="hljs-number">1</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(c + <span class="hljs-number">1</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>));

  <span class="hljs-comment">// 2. 遍历顺序：先遍历物品（i从1到n），再遍历容量（j从1到c）（逐行填充）</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt;= n; i++) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">1</span>; j &lt;= c; j++) {
      <span class="hljs-comment">// 3. 递推公式：容量不足则不选，容量充足则选或不选取最大值（选则依赖本行）</span>
      <span class="hljs-keyword">if</span> (j &lt; w[i - <span class="hljs-number">1</span>]) {
        dp[i][j] = dp[i - <span class="hljs-number">1</span>][j];
      } <span class="hljs-keyword">else</span> {
        dp[i][j] = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(dp[i - <span class="hljs-number">1</span>][j], dp[i][j - w[i - <span class="hljs-number">1</span>]] + v[i - <span class="hljs-number">1</span>]);
      }
    }
  }

  <span class="hljs-comment">// 打印完整dp数组（表格）验证</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'纯完全背包二维DP数组（表格）：'</span>);
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt;= n; i++) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(dp[i].<span class="hljs-title function_">join</span>(<span class="hljs-string">'\t'</span>));
  }

  <span class="hljs-comment">// 最终答案：前n个物品放入容量c的背包的最大价值</span>
  <span class="hljs-keyword">return</span> dp[n][c];
}

<span class="hljs-comment">// 测试用例</span>
<span class="hljs-keyword">const</span> w = [<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>];
<span class="hljs-keyword">const</span> v = [<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>];
<span class="hljs-keyword">const</span> c = <span class="hljs-number">8</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'最大价值：'</span>, <span class="hljs-title function_">completeKnapsack_2d</span>(w, v, c)); <span class="hljs-comment">// 输出：12</span>
</code></pre>
<h4 data-id="heading-11">1.7 一维DP优化（空间压缩）</h4>
<p>完全背包的一维DP优化核心是「正序遍历容量」（区别于01背包的逆序），复用本行前序结果实现「无限选」。其优化思路并非凭空设计，而是基于二维DP解法的状态依赖逻辑进行空间压缩，具体可拆解为以下3个关键步骤：</p>
<h5 data-id="heading-12">1. 优化基础：明确二维DP的状态依赖特性</h5>
<p>在纯完全背包的二维DP解法中，递推公式为：当容量j ≥ 物品重量w[i-1]时，dp[i][j] = max(dp[i-1][j], dp[i]j - w[i-1]] + v[i-1])。观察该公式可发现，计算第i行的dp[i][j]时，仅依赖两个位置的状态：① 上一行同列的dp[i-1][j]（不选当前物品的情况）；② 本行左侧列的dp[i]j - w[i-1]]（选当前物品的情况）。</p>
<p>这一依赖特性意味着，我们无需保留完整的二维数组。因为计算第i行数据时，仅需用到上一行的“历史数据”和本行已计算出的“前序数据”，可以用一个一维数组滚动存储这些状态，从而将空间复杂度从O(n×c)优化为O(c)（n为物品数量，c为背包容量）。</p>
<h5 data-id="heading-13">2. 核心设计：正序遍历容量实现“无限选”</h5>
<p>一维DP数组的定义为dp[j]，表示“容量为j的背包能容纳的最大价值”，对应二维数组中当前行的dp[i][j]。为了实现完全背包“物品可无限选取”的特性，内层容量遍历必须采用「正序」（从curW到c，curW为当前物品重量），具体原因如下：</p>
<p>当正序遍历容量时，计算dp[j]时，dp[j - curW]已经是本次遍历物品i时更新过的“本行前序结果”（而非上一轮物品i-1的历史结果）。例如，遍历物品1（w=2,v=3）时，先计算dp[2] = dp[0]+3=3；继续遍历j=4时，dp[4] = dp[2]+3=6，此时复用的dp[2]是已纳入物品1的结果，相当于在背包中再次放入了物品1，实现了“无限选”的效果。</p>
<p>这里需要特别区分与01背包的差异：01背包要求物品只能选一次，因此内层需逆序遍历容量，确保dp[j - curW]使用的是上一轮的历史数据（未纳入当前物品）；而完全背包的正序遍历，正是通过复用本轮已更新的数据，达成“重复选取当前物品”的核心需求。</p>
<h5 data-id="heading-14">3. 遍历逻辑：外层物品、内层容量的固定顺序</h5>
<p>一维DP的遍历顺序必须是「外层遍历物品，内层正序遍历容量」。外层遍历物品保证每个物品都被考虑到，内层正序遍历容量则保证每个物品可以被多次选取。若颠倒遍历顺序（外层容量、内层物品），会导致同一容量下多次重复计算同一物品的贡献，最终结果错误（相当于变成了排列数问题，而非背包最值问题）。</p>
<p>具体遍历流程：① 初始化一维dp数组为全0（对应二维数组第0行的边界条件，无物品时所有容量的最大价值为0）；② 逐个遍历每个物品，获取当前物品的重量curW和价值curV；③ 对每个物品，正序遍历容量从curW到c，通过dp[j] = max(dp[j], dp[j - curW] + curV)更新状态；④ 所有物品遍历完成后，dp[c]即为最终答案。</p>
<h5 data-id="heading-15">4. 与二维解法的结果一致性验证</h5>
<p>以示例中的物品（w=[2,3,4], v=[3,4,5]）和容量c=8为例，一维DP的计算过程与二维数组的填充过程完全匹配：</p>
<p>遍历物品1（w=2,v=3）时，正序更新dp[2]~dp[8]，得到dp=[0,0,3,3,6,6,9,9,12]（对应二维数组第1行）；遍历物品2（w=3,v=4）时，正序更新dp[3]~dp[8]，得到dp=[0,0,3,4,6,7,9,10,12]（对应二维数组第2行）；遍历物品3（w=4,v=5）时，正序更新dp[4]~dp[8]，最终dp=[0,0,3,4,6,7,9,10,12]（对应二维数组第3行），dp[8]=12与二维解法结果一致，验证了优化思路的正确性。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript">
<span class="hljs-comment">/**
 * 纯完全背包原型（一维DP优化版）
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number[]</span>} <span class="hljs-variable">w</span> - 物品重量数组
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number[]</span>} <span class="hljs-variable">v</span> - 物品价值数组
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">c</span> - 背包最大容量
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">number</span>} - 背包能容纳的最大价值
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">completeKnapsack_1d</span>(<span class="hljs-params">w, v, c</span>) {
  <span class="hljs-comment">// 1. 初始化一维dp数组：dp[j]表示容量为j的背包的最大价值</span>
  <span class="hljs-keyword">const</span> dp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(c + <span class="hljs-number">1</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>);

  <span class="hljs-comment">// 2. 遍历顺序：外层物品，内层正序遍历容量（允许重复选）</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; w.<span class="hljs-property">length</span>; i++) {
    <span class="hljs-keyword">const</span> curW = w[i];
    <span class="hljs-keyword">const</span> curV = v[i];
    <span class="hljs-comment">// 正序遍历：复用本行前序结果，实现无限选</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = curW; j &lt;= c; j++) {
      dp[j] = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(dp[j], dp[j - curW] + curV);
    }
  }

  <span class="hljs-comment">// 打印一维dp数组验证</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'纯完全背包一维DP数组：'</span>, dp);

  <span class="hljs-comment">// 最终答案：容量c的背包的最大价值</span>
  <span class="hljs-keyword">return</span> dp[c];
}

<span class="hljs-comment">// 测试用例</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'一维优化版最大价值：'</span>, <span class="hljs-title function_">completeKnapsack_1d</span>(w, v, c)); <span class="hljs-comment">// 输出：12</span>
</code></pre>
<h3 data-id="heading-16">二、完全背包变形1：最值类（完全平方数）</h3>
<p>LeetCode链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Fperfect-squares%2F" target="_blank" title="https://leetcode.cn/problems/perfect-squares/" ref="nofollow noopener noreferrer">leetcode.cn/problems/pe…</a></p>
<h4 data-id="heading-17">题目描述</h4>
<p>给定正整数 <code>n</code>，找到若干完全平方数（1,4,9...）使其和等于 <code>n</code>，要求个数最少。</p>
<p>示例：<code>n=12</code> → 输出3（12=4+4+4）；<code>n=13</code> → 输出2（13=4+9）。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Ffrontzhm.github.io%2Fblog-demo%2Fdp3-wq2.html" target="_blank" title="https://frontzhm.github.io/blog-demo/dp3-wq2.html" ref="nofollow noopener noreferrer">表格动态演示</a></p>
<h4 data-id="heading-18">2.1 步骤1：确定dp数组及下标的含义</h4>
<p>定义二维数组<code>dp[i][j]</code>：表示「前i个完全平方数（1²,2²,...,i²）凑出和为j的最少个数」。</p>
<p>对应表格维度：i（行）表示完全平方数的个数（从0到m，m=Math.floor(Math.sqrt(n))），j（列）表示目标和（从0到n）。</p>
<h4 data-id="heading-19">2.2 步骤2：确定递推公式</h4>
<p>对于第i个完全平方数（值<code>curPow = i²</code>），有两种决策：选或不选：</p>
<ol>
<li>
<p><strong>不选第i个完全平方数</strong>：<code>dp[i][j] = dp[i-1][j]</code>；</p>
</li>
<li>
<p><strong>选第i个完全平方数</strong>：需保证j ≥ curPow，此时<code>dp[i][j] = dp[i][j - curPow] + 1</code>（选后仍能选当前数，+1表示个数加1）。</p>
</li>
</ol>
<p>最终递推公式（取两种决策的最小值）：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript">
<span class="hljs-keyword">if</span> (j &lt; curPow) {
  dp[i][j] = dp[i - <span class="hljs-number">1</span>][j];
} <span class="hljs-keyword">else</span> {
  dp[i][j] = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(dp[i - <span class="hljs-number">1</span>][j], dp[i][j - curPow] + <span class="hljs-number">1</span>);
}
</code></pre>
<h4 data-id="heading-20">2.3 步骤3：dp数组如何初始化</h4>
<p>最值类问题初始化核心是「默认值设为无穷大（表示不可达），边界设为0」：</p>
<ol>
<li>
<p><strong>i=0（无完全平方数）</strong>：除j=0外，其余<code>dp[0][j] = Infinity</code>（无数字无法凑出和）；</p>
</li>
<li>
<p><strong>j=0（凑0）</strong>：所有i的<code>dp[i][0] = 0</code>（凑0需要0个数字）；</p>
</li>
<li>
<p>其余单元格初始化为<code>Infinity</code>（默认不可达）。</p>
</li>
</ol>
<h4 data-id="heading-21">2.4 步骤4：确定遍历顺序</h4>
<p>先遍历完全平方数（i从1到m），再遍历目标和（j从1到n），逐行填充表格。</p>
<h4 data-id="heading-22">2.5 步骤5：打印dp数组（验证）</h4>
<p>以<code>n=12</code>为例（m=3，对应1²、2²、3²），最终表格右下角<code>dp[3][12] = 3</code>，与预期一致。</p>
<h4 data-id="heading-23">2.6 二维DP完整代码（JavaScript）</h4>
<pre><code class="hljs language-JavaScript" lang="JavaScript">
<span class="hljs-comment">/**
 * 完全平方数（二维DP解法）
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">n</span> - 目标数
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">number</span>} - 最少完全平方数个数
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">numSquares_2d</span>(<span class="hljs-params">n</span>) {
  <span class="hljs-keyword">const</span> m = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(n)); <span class="hljs-comment">// 最大完全平方数的底数</span>
  <span class="hljs-comment">// 1. 初始化二维dp数组：dp[i][j]前i个完全平方数凑和j的最少个数，默认Infinity</span>
  <span class="hljs-keyword">const</span> dp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(m + <span class="hljs-number">1</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(n + <span class="hljs-number">1</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-title class_">Infinity</span>));

  <span class="hljs-comment">// 2. 边界条件：凑0需要0个</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt;= m; i++) {
    dp[i][<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;
  }

  <span class="hljs-comment">// 3. 遍历顺序：先遍历完全平方数，再遍历目标和</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt;= m; i++) {
    <span class="hljs-keyword">const</span> curPow = i * i; <span class="hljs-comment">// 第i个完全平方数</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">1</span>; j &lt;= n; j++) {
      <span class="hljs-comment">// 4. 递推公式</span>
      <span class="hljs-keyword">if</span> (j &lt; curPow) {
        dp[i][j] = dp[i - <span class="hljs-number">1</span>][j];
      } <span class="hljs-keyword">else</span> {
        dp[i][j] = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(dp[i - <span class="hljs-number">1</span>][j], dp[i][j - curPow] + <span class="hljs-number">1</span>);
      }
    }
  }

  <span class="hljs-comment">// 打印dp数组验证</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'完全平方数二维DP数组：'</span>);
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt;= m; i++) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(dp[i].<span class="hljs-title function_">join</span>(<span class="hljs-string">'\t'</span>));
  }

  <span class="hljs-keyword">return</span> dp[m][n];
}

<span class="hljs-comment">// 测试用例</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'最少个数（n=12）：'</span>, <span class="hljs-title function_">numSquares_2d</span>(<span class="hljs-number">12</span>)); <span class="hljs-comment">// 输出：3</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'最少个数（n=13）：'</span>, <span class="hljs-title function_">numSquares_2d</span>(<span class="hljs-number">13</span>)); <span class="hljs-comment">// 输出：2</span>
</code></pre>
<h4 data-id="heading-24">2.7 一维DP优化</h4>
<pre><code class="hljs language-JavaScript" lang="JavaScript">
<span class="hljs-comment">/**
 * 完全平方数（一维DP优化版）
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">n</span> - 目标数
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">number</span>} - 最少完全平方数个数
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">numSquares_1d</span>(<span class="hljs-params">n</span>) {
  <span class="hljs-comment">// 1. 初始化一维dp数组：dp[j]凑和j的最少个数</span>
  <span class="hljs-keyword">const</span> dp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(n + <span class="hljs-number">1</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-title class_">Infinity</span>);
  dp[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>; <span class="hljs-comment">// 边界：凑0需要0个</span>

  <span class="hljs-keyword">const</span> m = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(n));
  <span class="hljs-comment">// 2. 遍历顺序：外层完全平方数，内层正序遍历和</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt;= m; i++) {
    <span class="hljs-keyword">const</span> curPow = i * i;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = curPow; j &lt;= n; j++) {
      dp[j] = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(dp[j], dp[j - curPow] + <span class="hljs-number">1</span>);
    }
  }

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'完全平方数一维DP数组：'</span>, dp);
  <span class="hljs-keyword">return</span> dp[n];
}

<span class="hljs-comment">// 测试用例</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'一维优化版最少个数（n=12）：'</span>, <span class="hljs-title function_">numSquares_1d</span>(<span class="hljs-number">12</span>)); <span class="hljs-comment">// 输出：3</span>
</code></pre>
<h3 data-id="heading-25">三、完全背包变形2：计数类（组合数/排列数）</h3>
<p>计数类是完全背包最易混淆的变形，核心区别是「是否考虑顺序」：</p>
<ul>
<li>
<p>组合数：顺序无关（零钱兑换II）→ 外层物品，内层容量；</p>
</li>
<li>
<p>排列数：顺序有关（组合总和IV）→ 外层容量，内层物品。</p>
</li>
</ul>
<h4 data-id="heading-26">3.1 子变形2.1：组合数（零钱兑换II）</h4>
<p>LeetCode链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Fcoin-change-ii%2F" target="_blank" title="https://leetcode.cn/problems/coin-change-ii/" ref="nofollow noopener noreferrer">leetcode.cn/problems/co…</a></p>
<h5 data-id="heading-27">题目描述</h5>
<p>给定硬币数组 <code>coins</code> 和总金额 <code>amount</code>，求凑成总金额的组合数（硬币可重复选）。</p>
<p>示例：<code>coins=[1,2,5], amount=5</code> → 输出4（5=5/2+2+1/2+1+1+1/1×5）。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Ffrontzhm.github.io%2Fblog-demo%2Fdp3-wq3.html" target="_blank" title="https://frontzhm.github.io/blog-demo/dp3-wq3.html" ref="nofollow noopener noreferrer">表格动态演示</a></p>
<h5 data-id="heading-28">3.1.1 步骤1：确定dp数组及下标的含义</h5>
<p>定义二维数组<code>dp[i][j]</code>：表示「前i种硬币凑出金额j的组合数」。</p>
<h5 data-id="heading-29">3.1.2 步骤2：确定递推公式</h5>
<ol>
<li>
<p><strong>不选第i种硬币</strong>：<code>dp[i][j] = dp[i-1][j]</code>；</p>
</li>
<li>
<p><strong>选第i种硬币</strong>：j ≥ coins[i-1]时，<code>dp[i][j] += dp[i][j - coins[i-1]]</code>；</p>
</li>
</ol>
<p>最终：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript">
<span class="hljs-keyword">if</span> (j &lt; coins[i-<span class="hljs-number">1</span>]) {
  dp[i][j] = dp[i-<span class="hljs-number">1</span>][j];
} <span class="hljs-keyword">else</span> {
  dp[i][j] = dp[i-<span class="hljs-number">1</span>][j] + dp[i][j - coins[i-<span class="hljs-number">1</span>]];
}
</code></pre>
<h5 data-id="heading-30">3.1.3 步骤3：dp数组如何初始化</h5>
<ol>
<li>
<p><strong>j=0（凑0）</strong>：所有i的<code>dp[i][0] = 1</code>（不选任何硬币是唯一方式）；</p>
</li>
<li>
<p><strong>i=0（无硬币）</strong>：j&gt;0时<code>dp[0][j] = 0</code>（无硬币无法凑金额）。</p>
</li>
</ol>
<h5 data-id="heading-31">3.1.4 步骤4：确定遍历顺序</h5>
<p>先遍历硬币（i从1到len），再遍历金额（j从1到amount），逐行填充。</p>
<h5 data-id="heading-32">3.1.5 步骤5：打印dp数组（验证）</h5>
<p>以<code>coins=[1,2,5], amount=5</code>为例，最终<code>dp[3][5] = 4</code>，与预期一致。</p>
<h5 data-id="heading-33">3.1.6 二维DP完整代码</h5>
<pre><code class="hljs language-JavaScript" lang="JavaScript">
<span class="hljs-comment">/**
 * 零钱兑换II（二维DP解法）
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">amount</span> - 总金额
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number[]</span>} <span class="hljs-variable">coins</span> - 硬币数组
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">number</span>} - 组合数
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">change_2d</span>(<span class="hljs-params">amount, coins</span>) {
  <span class="hljs-keyword">const</span> len = coins.<span class="hljs-property">length</span>;
  <span class="hljs-comment">// 1. 初始化二维dp数组：dp[i][j]前i种硬币凑金额j的组合数</span>
  <span class="hljs-keyword">const</span> dp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(len + <span class="hljs-number">1</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(amount + <span class="hljs-number">1</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>));

  <span class="hljs-comment">// 2. 边界条件：凑0有1种方式</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt;= len; i++) {
    dp[i][<span class="hljs-number">0</span>] = <span class="hljs-number">1</span>;
  }

  <span class="hljs-comment">// 3. 遍历顺序：先遍历硬币，再遍历金额</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt;= len; i++) {
    <span class="hljs-keyword">const</span> curCoin = coins[i - <span class="hljs-number">1</span>];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">1</span>; j &lt;= amount; j++) {
      <span class="hljs-comment">// 4. 递推公式</span>
      <span class="hljs-keyword">if</span> (j &lt; curCoin) {
        dp[i][j] = dp[i - <span class="hljs-number">1</span>][j];
      } <span class="hljs-keyword">else</span> {
        dp[i][j] = dp[i - <span class="hljs-number">1</span>][j] + dp[i][j - curCoin];
      }
    }
  }

  <span class="hljs-comment">// 打印dp数组验证</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'零钱兑换II二维DP数组：'</span>);
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt;= len; i++) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(dp[i].<span class="hljs-title function_">join</span>(<span class="hljs-string">'\t'</span>));
  }

  <span class="hljs-keyword">return</span> dp[len][amount];
}

<span class="hljs-comment">// 测试用例</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'组合数（amount=5）：'</span>, <span class="hljs-title function_">change_2d</span>(<span class="hljs-number">5</span>, [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">5</span>])); <span class="hljs-comment">// 输出：4</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'组合数（amount=3）：'</span>, <span class="hljs-title function_">change_2d</span>(<span class="hljs-number">3</span>, [<span class="hljs-number">2</span>])); <span class="hljs-comment">// 输出：0</span>
</code></pre>
<h5 data-id="heading-34">3.1.7 一维DP优化</h5>
<pre><code class="hljs language-JavaScript" lang="JavaScript">
<span class="hljs-comment">/**
 * 零钱兑换II（一维DP优化版）
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">amount</span> - 总金额
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number[]</span>} <span class="hljs-variable">coins</span> - 硬币数组
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">number</span>} - 组合数
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">change_1d</span>(<span class="hljs-params">amount, coins</span>) {
  <span class="hljs-comment">// 1. 初始化一维dp数组：dp[j]凑金额j的组合数</span>
  <span class="hljs-keyword">const</span> dp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(amount + <span class="hljs-number">1</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>);
  dp[<span class="hljs-number">0</span>] = <span class="hljs-number">1</span>; <span class="hljs-comment">// 边界：凑0有1种方式</span>

  <span class="hljs-comment">// 2. 遍历顺序：外层硬币（保证顺序无关），内层正序遍历金额</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> curCoin <span class="hljs-keyword">of</span> coins) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = curCoin; j &lt;= amount; j++) {
      dp[j] += dp[j - curCoin];
    }
  }

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'零钱兑换II一维DP数组：'</span>, dp);
  <span class="hljs-keyword">return</span> dp[amount];
}

<span class="hljs-comment">// 测试用例</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'一维优化版组合数：'</span>, <span class="hljs-title function_">change_1d</span>(<span class="hljs-number">5</span>, [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">5</span>])); <span class="hljs-comment">// 输出：4</span>
</code></pre>
<h4 data-id="heading-35">3.2 子变形2.2：排列数（组合总和IV）</h4>
<p>LeetCode链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Fcombination-sum-iv%2F" target="_blank" title="https://leetcode.cn/problems/combination-sum-iv/" ref="nofollow noopener noreferrer">leetcode.cn/problems/co…</a></p>
<h5 data-id="heading-36">题目描述</h5>
<p>给定数组 <code>nums</code> 和目标 <code>target</code>，求总和为 <code>target</code> 的排列数（元素可重复选）。</p>
<p>示例：<code>nums=[1,2], target=3</code> → 输出3（1+1+1/1+2/2+1）。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Ffrontzhm.github.io%2Fblog-demo%2Fdp3-wq4.html" target="_blank" title="https://frontzhm.github.io/blog-demo/dp3-wq4.html" ref="nofollow noopener noreferrer">表格动态演示</a></p>
<h5 data-id="heading-37">3.2.1 步骤1：确定dp数组及下标的含义</h5>
<p>定义二维数组<code>dp[j][k]</code>：表示「凑金额j，最后一步选nums[k]的排列数」，总排列数<code>total[j] = sum(dp[j][k])</code>。</p>
<h5 data-id="heading-38">3.2.2 步骤2：确定递推公式</h5>
<p>对于金额j、数字nums[k]：</p>
<ul>
<li>
<p>j &lt; nums[k]：<code>dp[j][k] = 0</code>（金额不足）；</p>
</li>
<li>
<p>j ≥ nums[k]：<code>dp[j][k] = total[j - nums[k]]</code>（最后一步选nums[k]，前面凑j-nums[k]的总排列数）。</p>
</li>
</ul>
<h5 data-id="heading-39">3.2.3 步骤3：dp数组如何初始化</h5>
<ol>
<li>
<p><strong>j=0（凑0）</strong>：<code>total[0] = 1</code>（不选任何数），<code>dp[0][k] = 0</code>；</p>
</li>
<li>
<p>其余<code>total[j]</code>初始化为0，<code>dp[j][k]</code>初始化为0。</p>
</li>
</ol>
<h5 data-id="heading-40">3.2.4 步骤4：确定遍历顺序</h5>
<p>先遍历金额（j从1到target），再遍历数字（k从0到len-1），逐列填充。</p>
<h5 data-id="heading-41">3.2.5 步骤5：打印dp数组（验证）</h5>
<p>以<code>nums=[1,2], target=3</code>为例，最终<code>total[3] = 3</code>，与预期一致。</p>
<h5 data-id="heading-42">3.2.6 二维思路完整代码</h5>
<pre><code class="hljs language-JavaScript" lang="JavaScript">
<span class="hljs-comment">/**
 * 组合总和IV（二维思路版）
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number[]</span>} <span class="hljs-variable">nums</span> - 可选数组
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">target</span> - 目标和
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">number</span>} - 排列数
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">combinationSum4_2d</span>(<span class="hljs-params">nums, target</span>) {
  <span class="hljs-keyword">const</span> len = nums.<span class="hljs-property">length</span>;
  <span class="hljs-comment">// 1. 初始化dp表格：dp[j][k]凑j，最后一步选nums[k]的排列数</span>
  <span class="hljs-keyword">const</span> dp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(target + <span class="hljs-number">1</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(len).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>));
  <span class="hljs-comment">// 2. 总排列数数组：total[j]凑j的总排列数</span>
  <span class="hljs-keyword">const</span> total = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(target + <span class="hljs-number">1</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>);
  total[<span class="hljs-number">0</span>] = <span class="hljs-number">1</span>; <span class="hljs-comment">// 边界：凑0有1种方式</span>

  <span class="hljs-comment">// 3. 遍历顺序：外层金额，内层数字（保证顺序有关）</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">1</span>; j &lt;= target; j++) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> k = <span class="hljs-number">0</span>; k &lt; len; k++) {
      <span class="hljs-keyword">const</span> num = nums[k];
      <span class="hljs-comment">// 4. 递推公式</span>
      <span class="hljs-keyword">if</span> (j &gt;= num) {
        dp[j][k] = total[j - num];
      } <span class="hljs-keyword">else</span> {
        dp[j][k] = <span class="hljs-number">0</span>;
      }
    }
    <span class="hljs-comment">// 总排列数 = 所有最后一步的情况求和</span>
    total[j] = dp[j].<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">sum, val</span>) =&gt;</span> sum + val, <span class="hljs-number">0</span>);
  }

  <span class="hljs-comment">// 打印验证</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'组合总和IV dp表格：'</span>);
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">0</span>; j &lt;= target; j++) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`j=<span class="hljs-subst">${j}</span>: `</span>, dp[j].<span class="hljs-title function_">join</span>(<span class="hljs-string">'\t'</span>), <span class="hljs-string">'→ 总排列数：'</span>, total[j]);
  }

  <span class="hljs-keyword">return</span> total[target];
}

<span class="hljs-comment">// 测试用例</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'排列数（target=3）：'</span>, <span class="hljs-title function_">combinationSum4_2d</span>([<span class="hljs-number">1</span>,<span class="hljs-number">2</span>], <span class="hljs-number">3</span>)); <span class="hljs-comment">// 输出：3</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'排列数（target=4）：'</span>, <span class="hljs-title function_">combinationSum4_2d</span>([<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>], <span class="hljs-number">4</span>)); <span class="hljs-comment">// 输出：7</span>
</code></pre>
<h5 data-id="heading-43">3.2.7 一维DP优化</h5>
<pre><code class="hljs language-JavaScript" lang="JavaScript">
<span class="hljs-comment">/**
 * 组合总和IV（一维DP优化版）
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number[]</span>} <span class="hljs-variable">nums</span> - 可选数组
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">target</span> - 目标和
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">number</span>} - 排列数
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">combinationSum4_1d</span>(<span class="hljs-params">nums, target</span>) {
  <span class="hljs-comment">// 1. 初始化一维dp数组：dp[j]凑j的排列数</span>
  <span class="hljs-keyword">const</span> dp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(target + <span class="hljs-number">1</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>);
  dp[<span class="hljs-number">0</span>] = <span class="hljs-number">1</span>; <span class="hljs-comment">// 边界：凑0有1种方式</span>

  <span class="hljs-comment">// 2. 遍历顺序：外层金额（保证顺序有关），内层数字</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">1</span>; j &lt;= target; j++) {
    <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> num <span class="hljs-keyword">of</span> nums) {
      <span class="hljs-keyword">if</span> (j &gt;= num) {
        count += dp[j - num];
      }
    }
    dp[j] = count;
  }

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'组合总和IV一维DP数组：'</span>, dp);
  <span class="hljs-keyword">return</span> dp[target];
}

<span class="hljs-comment">// 测试用例</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'一维优化版排列数：'</span>, <span class="hljs-title function_">combinationSum4_1d</span>([<span class="hljs-number">1</span>,<span class="hljs-number">2</span>], <span class="hljs-number">3</span>)); <span class="hljs-comment">// 输出：3</span>
</code></pre>
<h3 data-id="heading-44">四、完全背包变形3：进阶类（单词拆分）</h3>
<p>LeetCode链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Fword-break%2F" target="_blank" title="https://leetcode.cn/problems/word-break/" ref="nofollow noopener noreferrer">leetcode.cn/problems/wo…</a></p>
<h4 data-id="heading-45">题目描述</h4>
<p>判断字符串 <code>s</code> 能否被字典 <code>wordDict</code> 中的单词拼接（单词可重复用）。</p>
<p>示例：<code>s="leetcode", wordDict=["leet","code"]</code> → 输出true；<code>s="catsandog", wordDict=["cats","dog","sand","and","cat"]</code> → 输出false。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Ffrontzhm.github.io%2Fblog-demo%2Fdp3-wq5.html" target="_blank" title="https://frontzhm.github.io/blog-demo/dp3-wq5.html" ref="nofollow noopener noreferrer">表格动态演示</a></p>
<h4 data-id="heading-46">4.1 步骤1：确定dp数组及下标的含义</h4>
<p>定义二维数组<code>dp[j][k]</code>：表示「前j个字符，最后一步拼接wordDict[k]是否可行」，总结果<code>canBreak[j] = any(dp[j][k])</code>（只要有一个k可行则为true）。</p>
<h4 data-id="heading-47">4.2 步骤2：确定递推公式</h4>
<p>对于前j个字符、单词wordDict[k]（长度len）：</p>
<ul>
<li>
<p>j &lt; len：<code>dp[j][k] = false</code>（长度不足）；</p>
</li>
<li>
<p>j ≥ len：<code>dp[j][k] = canBreak[j - len] &amp;&amp; (s.slice(j-len,j) === wordDict[k])</code>（前面可拆分 + 子串匹配）。</p>
</li>
</ul>
<h4 data-id="heading-48">4.3 步骤3：dp数组如何初始化</h4>
<ol>
<li>
<p><strong>j=0（空字符串）</strong>：<code>canBreak[0] = true</code>（空字符串可拆分），<code>dp[0][k] = false</code>；</p>
</li>
<li>
<p>其余<code>canBreak[j]</code>初始化为false，<code>dp[j][k]</code>初始化为false。</p>
</li>
</ol>
<h4 data-id="heading-49">4.4 步骤4：确定遍历顺序</h4>
<p>先遍历字符长度（j从1到len(s)），再遍历单词（k从0到len(wordDict)-1），逐列填充。</p>
<h4 data-id="heading-50">4.5 步骤5：打印dp数组（验证）</h4>
<p>以<code>s="leetcode", wordDict=["leet","code"]</code>为例，最终<code>canBreak[8] = true</code>，与预期一致。</p>
<h4 data-id="heading-51">4.6 二维思路完整代码</h4>
<pre><code class="hljs language-JavaScript" lang="JavaScript">
<span class="hljs-comment">/**
 * 单词拆分（二维思路版）
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">s</span> - 待拆分字符串
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string[]</span>} <span class="hljs-variable">wordDict</span> - 单词字典
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">boolean</span>} - 是否可拆分
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">wordBreak_2d</span>(<span class="hljs-params">s, wordDict</span>) {
  <span class="hljs-keyword">const</span> targetLen = s.<span class="hljs-property">length</span>;
  <span class="hljs-keyword">const</span> len = wordDict.<span class="hljs-property">length</span>;
  <span class="hljs-comment">// 1. 初始化dp表格：dp[j][k]前j个字符，最后一步拼接wordDict[k]是否可行</span>
  <span class="hljs-keyword">const</span> dp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(targetLen + <span class="hljs-number">1</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(len).<span class="hljs-title function_">fill</span>(<span class="hljs-literal">false</span>));
  <span class="hljs-comment">// 2. 总结果数组：canBreak[j]前j个字符是否可拆分</span>
  <span class="hljs-keyword">const</span> canBreak = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(targetLen + <span class="hljs-number">1</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-literal">false</span>);
  canBreak[<span class="hljs-number">0</span>] = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 边界：空字符串可拆分</span>

  <span class="hljs-comment">// 3. 遍历顺序：外层字符长度，内层单词</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">1</span>; j &lt;= targetLen; j++) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> k = <span class="hljs-number">0</span>; k &lt; len; k++) {
      <span class="hljs-keyword">const</span> word = wordDict[k];
      <span class="hljs-keyword">const</span> wordLen = word.<span class="hljs-property">length</span>;
      <span class="hljs-comment">// 4. 递推公式</span>
      <span class="hljs-keyword">if</span> (j &gt;= wordLen) {
        <span class="hljs-keyword">const</span> subStr = s.<span class="hljs-title function_">slice</span>(j - wordLen, j);
        dp[j][k] = canBreak[j - wordLen] &amp;&amp; (subStr === word);
      } <span class="hljs-keyword">else</span> {
        dp[j][k] = <span class="hljs-literal">false</span>;
      }
    }
    <span class="hljs-comment">// 只要有一个单词可行，前j个字符就可拆分</span>
    canBreak[j] = dp[j].<span class="hljs-title function_">some</span>(<span class="hljs-function"><span class="hljs-params">val</span> =&gt;</span> val === <span class="hljs-literal">true</span>);
  }

  <span class="hljs-comment">// 打印验证</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'单词拆分dp表格：'</span>);
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">0</span>; j &lt;= targetLen; j++) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`j=<span class="hljs-subst">${j}</span>: `</span>, dp[j].<span class="hljs-title function_">join</span>(<span class="hljs-string">'\t'</span>), <span class="hljs-string">'→ 是否可拆分：'</span>, canBreak[j]);
  }

  <span class="hljs-keyword">return</span> canBreak[targetLen];
}

<span class="hljs-comment">// 测试用例</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'是否可拆分（leetcode）：'</span>, <span class="hljs-title function_">wordBreak_2d</span>(<span class="hljs-string">"leetcode"</span>, [<span class="hljs-string">"leet"</span>,<span class="hljs-string">"code"</span>])); <span class="hljs-comment">// 输出：true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'是否可拆分（catsandog）：'</span>, <span class="hljs-title function_">wordBreak_2d</span>(<span class="hljs-string">"catsandog"</span>, [<span class="hljs-string">"cats"</span>,<span class="hljs-string">"dog"</span>,<span class="hljs-string">"sand"</span>,<span class="hljs-string">"and"</span>,<span class="hljs-string">"cat"</span>])); <span class="hljs-comment">// 输出：false</span>
</code></pre>
<h4 data-id="heading-52">4.7 一维DP优化</h4>
<pre><code class="hljs language-JavaScript" lang="JavaScript">
<span class="hljs-comment">/**
 * 单词拆分（一维DP优化版）
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">s</span> - 待拆分字符串
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string[]</span>} <span class="hljs-variable">wordDict</span> - 单词字典
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">boolean</span>} - 是否可拆分
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">wordBreak_1d</span>(<span class="hljs-params">s, wordDict</span>) {
  <span class="hljs-keyword">const</span> targetLen = s.<span class="hljs-property">length</span>;
  <span class="hljs-comment">// 1. 初始化一维dp数组：dp[j]前j个字符是否可拆分</span>
  <span class="hljs-keyword">const</span> dp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(targetLen + <span class="hljs-number">1</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-literal">false</span>);
  dp[<span class="hljs-number">0</span>] = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 边界：空字符串可拆分</span>

  <span class="hljs-comment">// 2. 遍历顺序：外层字符长度，内层单词</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">1</span>; j &lt;= targetLen; j++) {
    <span class="hljs-keyword">const</span> curStr = s.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, j);
    <span class="hljs-keyword">let</span> can = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> word <span class="hljs-keyword">of</span> wordDict) {
      <span class="hljs-keyword">const</span> wordLen = word.<span class="hljs-property">length</span>;
      <span class="hljs-keyword">if</span> (wordLen &gt; j) <span class="hljs-keyword">continue</span>;
      <span class="hljs-comment">// 3. 递推公式：后缀匹配 + 前面可拆分</span>
      can = can || (dp[j - wordLen] &amp;&amp; curStr.<span class="hljs-title function_">endsWith</span>(word));
      <span class="hljs-keyword">if</span> (can) <span class="hljs-keyword">break</span>; <span class="hljs-comment">// 提前终止</span>
    }
    dp[j] = can;
  }

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'单词拆分一维DP数组：'</span>, dp);
  <span class="hljs-keyword">return</span> dp[targetLen];
}

<span class="hljs-comment">// 测试用例</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'一维优化版是否可拆分：'</span>, <span class="hljs-title function_">wordBreak_1d</span>(<span class="hljs-string">"leetcode"</span>, [<span class="hljs-string">"leet"</span>,<span class="hljs-string">"code"</span>])); <span class="hljs-comment">// 输出：true</span>
</code></pre>
<h3 data-id="heading-53">五、核心总结</h3>















































<table><thead><tr><th>题型</th><th>LeetCode链接</th><th>二维DP核心意义</th><th>一维遍历顺序</th><th>状态转移核心</th></tr></thead><tbody><tr><td>纯完全背包</td><td>无（经典原型）</td><td>直观体现「重复选」的状态转移</td><td>外层物品+正序容量</td><td>max(不选, 选)</td></tr><tr><td>完全平方数</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Fperfect-squares%2F" target="_blank" title="https://leetcode.cn/problems/perfect-squares/" ref="nofollow noopener noreferrer">leetcode.cn/problems/pe…</a></td><td>理解「最值类」初始化逻辑</td><td>外层物品+正序容量</td><td>min(不选, 选+1)</td></tr><tr><td>零钱兑换II</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Fcoin-change-ii%2F" target="_blank" title="https://leetcode.cn/problems/coin-change-ii/" ref="nofollow noopener noreferrer">leetcode.cn/problems/co…</a></td><td>理解「组合数」的状态继承</td><td>外层物品+正序容量</td><td>不选 + 选</td></tr><tr><td>组合总和IV</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Fcombination-sum-iv%2F" target="_blank" title="https://leetcode.cn/problems/combination-sum-iv/" ref="nofollow noopener noreferrer">leetcode.cn/problems/co…</a></td><td>理解「最后一步」的表格拆分</td><td>外层容量+内层物品</td><td>累加所有「最后一步」的可能</td></tr><tr><td>单词拆分</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Fword-break%2F" target="_blank" title="https://leetcode.cn/problems/word-break/" ref="nofollow noopener noreferrer">leetcode.cn/problems/wo…</a></td><td>理解「字符串匹配+DP」的结合</td><td>外层容量+内层物品</td><td>或运算（存在一种即可）</td></tr></tbody></table>
<h4 data-id="heading-54">学习建议</h4>
<ol>
<li>
<p><strong>先二维，后一维</strong>：二维数组能直观体现状态转移逻辑，一维优化是空间压缩，不要跳过二维直接学一维；</p>
</li>
<li>
<p><strong>手动填小表格</strong>：对易混淆的排列/组合数，用小例子手动填充表格，快速理解遍历顺序的影响；</p>
</li>
<li>
<p><strong>抓「最后一步」核心</strong>：所有完全背包变形的递推公式，本质都是「最后一步选什么」；</p>
</li>
<li>
<p><strong>区分遍历顺序</strong>：物品外层=组合（顺序无关），容量外层=排列（顺序有关）。</p>
</li>
</ol>
<p>完全背包的所有变形本质都是「状态表格的填充规则变化」，掌握了填充表格法，无论题型如何变形，都能快速拆解核心逻辑！</p>
<p>有N种物品和⼀个容量为V 的背包。第i种物品最多有Mi件可⽤，每件耗费的空间是Ci ，价值是Wi 。求解将哪些物品装⼊背包可使这些物品的耗费的空间 总和不超过背包容量，且价值总和最⼤。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何使用for...of遍历对象]]></title>    <link>https://juejin.cn/post/7592615536385540130</link>    <guid>https://juejin.cn/post/7592615536385540130</guid>    <pubDate>2026-01-08T14:03:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592615536385540130" data-draft-id="7592615536385523746" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何使用for...of遍历对象"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-08T14:03:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="代码猎人"/> <meta itemprop="url" content="https://juejin.cn/user/624972624037374"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何使用for...of遍历对象
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/624972624037374/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    代码猎人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T14:03:27.000Z" title="Thu Jan 08 2026 14:03:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>虽然普通对象默认不支持 <code>for...of</code>，但有多种方法可以实现：</p>
<h2 data-id="heading-0">1. <strong>使用 Object 的辅助方法</strong></h2>
<h3 data-id="heading-1">遍历键名 (keys)</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> obj = { <span class="hljs-attr">a</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">b</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">c</span>: <span class="hljs-number">3</span> };

<span class="hljs-comment">// 方法1: Object.keys()</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(obj)) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(key); <span class="hljs-comment">// 'a', 'b', 'c'</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj[key]); <span class="hljs-comment">// 1, 2, 3</span>
}

<span class="hljs-comment">// 方法2: 使用数组的解构和循环</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(obj)) {
  <span class="hljs-keyword">const</span> value = obj[key];
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(key, value);
}
</code></pre>
<h3 data-id="heading-2">遍历值 (values)</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> obj = { <span class="hljs-attr">a</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">b</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">c</span>: <span class="hljs-number">3</span> };

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> value <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">values</span>(obj)) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value); <span class="hljs-comment">// 1, 2, 3</span>
}
</code></pre>
<h3 data-id="heading-3">遍历键值对 (entries)</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> obj = { <span class="hljs-attr">a</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">b</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">c</span>: <span class="hljs-number">3</span> };

<span class="hljs-comment">// 方法1: 使用数组解构</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [key, value] <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(obj)) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(key, value); <span class="hljs-comment">// 'a' 1, 'b' 2, 'c' 3</span>
}

<span class="hljs-comment">// 方法2: 不使用解构</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> entry <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(obj)) {
  <span class="hljs-keyword">const</span> key = entry[<span class="hljs-number">0</span>];
  <span class="hljs-keyword">const</span> value = entry[<span class="hljs-number">1</span>];
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(key, value);
}
</code></pre>
<h2 data-id="heading-4">2. <strong>使对象本身可迭代 (实现 Symbol.iterator)</strong></h2>
<h3 data-id="heading-5">基本实现</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> obj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'John'</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">30</span>,
  <span class="hljs-attr">city</span>: <span class="hljs-string">'New York'</span>,
  
  <span class="hljs-comment">// 添加 Symbol.iterator 方法</span>
  [<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">iterator</span>]: <span class="hljs-keyword">function</span>* () {
    <span class="hljs-comment">// 遍历自身属性</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(<span class="hljs-variable language_">this</span>)) {
      <span class="hljs-keyword">yield</span> [key, <span class="hljs-variable language_">this</span>[key]];
    }
  }
};

<span class="hljs-comment">// 现在可以用 for...of 直接遍历</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [key, value] <span class="hljs-keyword">of</span> obj) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${key}</span>: <span class="hljs-subst">${value}</span>`</span>);
}
<span class="hljs-comment">// 输出:</span>
<span class="hljs-comment">// name: John</span>
<span class="hljs-comment">// age: 30</span>
<span class="hljs-comment">// city: New York</span>
</code></pre>
<h3 data-id="heading-6">只返回值的迭代器</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> obj = {
  <span class="hljs-attr">a</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">b</span>: <span class="hljs-number">2</span>,
  <span class="hljs-attr">c</span>: <span class="hljs-number">3</span>,
  [<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">iterator</span>]: <span class="hljs-keyword">function</span>* () {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(<span class="hljs-variable language_">this</span>)) {
      <span class="hljs-keyword">yield</span> <span class="hljs-variable language_">this</span>[key];
    }
  }
};

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> value <span class="hljs-keyword">of</span> obj) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value); <span class="hljs-comment">// 1, 2, 3</span>
}
</code></pre>
<h2 data-id="heading-7">3. <strong>自定义迭代行为</strong></h2>
<h3 data-id="heading-8">按特定顺序迭代</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> user = {
  <span class="hljs-attr">firstName</span>: <span class="hljs-string">'John'</span>,
  <span class="hljs-attr">lastName</span>: <span class="hljs-string">'Doe'</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">30</span>,
  <span class="hljs-attr">email</span>: <span class="hljs-string">'john@example.com'</span>,
  
  [<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">iterator</span>]: <span class="hljs-keyword">function</span>* () {
    <span class="hljs-comment">// 自定义迭代顺序</span>
    <span class="hljs-keyword">yield</span> [<span class="hljs-string">'姓名'</span>, <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.firstName}</span> <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.lastName}</span>`</span>];
    <span class="hljs-keyword">yield</span> [<span class="hljs-string">'年龄'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span>];
    <span class="hljs-keyword">yield</span> [<span class="hljs-string">'邮箱'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">email</span>];
  }
};

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [label, value] <span class="hljs-keyword">of</span> user) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${label}</span>: <span class="hljs-subst">${value}</span>`</span>);
}
<span class="hljs-comment">// 输出:</span>
<span class="hljs-comment">// 姓名: John Doe</span>
<span class="hljs-comment">// 年龄: 30</span>
<span class="hljs-comment">// 邮箱: john@example.com</span>
</code></pre>
<h3 data-id="heading-9">只迭代特定属性</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> product = {
  <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">name</span>: <span class="hljs-string">'Laptop'</span>,
  <span class="hljs-attr">price</span>: <span class="hljs-number">999.99</span>,
  <span class="hljs-attr">category</span>: <span class="hljs-string">'Electronics'</span>,
  <span class="hljs-attr">inStock</span>: <span class="hljs-literal">true</span>,
  
  [<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">iterator</span>]: <span class="hljs-keyword">function</span>* () {
    <span class="hljs-comment">// 只迭代非布尔值的属性</span>
    <span class="hljs-keyword">const</span> keys = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(<span class="hljs-variable language_">this</span>);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">of</span> keys) {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">this</span>[key] !== <span class="hljs-string">'boolean'</span>) {
        <span class="hljs-keyword">yield</span> [key, <span class="hljs-variable language_">this</span>[key]];
      }
    }
  }
};

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [key, value] <span class="hljs-keyword">of</span> product) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${key}</span>: <span class="hljs-subst">${value}</span>`</span>);
}
<span class="hljs-comment">// 输出:</span>
<span class="hljs-comment">// id: 1</span>
<span class="hljs-comment">// name: Laptop</span>
<span class="hljs-comment">// price: 999.99</span>
<span class="hljs-comment">// category: Electronics</span>
</code></pre>
<h2 data-id="heading-10">4. <strong>类实例的可迭代性</strong></h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">UserCollection</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">users</span> = [];
  }
  
  <span class="hljs-title function_">add</span>(<span class="hljs-params">user</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">users</span>.<span class="hljs-title function_">push</span>(user);
  }
  
  <span class="hljs-comment">// 使实例可迭代</span>
  *[<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">iterator</span>]() {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> user <span class="hljs-keyword">of</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">users</span>) {
      <span class="hljs-keyword">yield</span> user;
    }
  }
  
  <span class="hljs-comment">// 或者返回键值对</span>
  *<span class="hljs-title function_">entries</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">users</span>.<span class="hljs-property">length</span>; i++) {
      <span class="hljs-keyword">yield</span> [i, <span class="hljs-variable language_">this</span>.<span class="hljs-property">users</span>[i]];
    }
  }
}

<span class="hljs-keyword">const</span> collection = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserCollection</span>();
collection.<span class="hljs-title function_">add</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'Alice'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">25</span> });
collection.<span class="hljs-title function_">add</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'Bob'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">30</span> });

<span class="hljs-comment">// 遍历用户</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> user <span class="hljs-keyword">of</span> collection) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(user.<span class="hljs-property">name</span>, user.<span class="hljs-property">age</span>);
}

<span class="hljs-comment">// 遍历带索引的用户</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [index, user] <span class="hljs-keyword">of</span> collection.<span class="hljs-title function_">entries</span>()) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(index, user.<span class="hljs-property">name</span>);
}
</code></pre>
<h2 data-id="heading-11">5. <strong>使用生成器函数</strong></h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span>* <span class="hljs-title function_">objectEntries</span>(<span class="hljs-params">obj</span>) {
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(obj)) {
    <span class="hljs-keyword">yield</span> [key, obj[key]];
  }
}

<span class="hljs-keyword">const</span> obj = { <span class="hljs-attr">x</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">20</span>, <span class="hljs-attr">z</span>: <span class="hljs-number">30</span> };

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [key, value] <span class="hljs-keyword">of</span> <span class="hljs-title function_">objectEntries</span>(obj)) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(key, value);
}
</code></pre>
<h2 data-id="heading-12">6. <strong>实际应用场景</strong></h2>
<h3 data-id="heading-13">场景1：遍历配置对象</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> config = {
  <span class="hljs-attr">apiUrl</span>: <span class="hljs-string">'https://api.example.com'</span>,
  <span class="hljs-attr">timeout</span>: <span class="hljs-number">5000</span>,
  <span class="hljs-attr">retries</span>: <span class="hljs-number">3</span>,
  <span class="hljs-attr">debug</span>: <span class="hljs-literal">false</span>
};

<span class="hljs-comment">// 配置迭代器</span>
config[<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">iterator</span>] = <span class="hljs-keyword">function</span>* () {
  <span class="hljs-keyword">const</span> keys = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(<span class="hljs-variable language_">this</span>).<span class="hljs-title function_">sort</span>(); <span class="hljs-comment">// 按字母排序</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">of</span> keys) {
    <span class="hljs-keyword">yield</span> { key, <span class="hljs-attr">value</span>: <span class="hljs-variable language_">this</span>[key] };
  }
};

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> { key, value } <span class="hljs-keyword">of</span> config) {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> value !== <span class="hljs-string">'boolean'</span>) { <span class="hljs-comment">// 过滤布尔值</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`配置 <span class="hljs-subst">${key}</span> = <span class="hljs-subst">${value}</span>`</span>);
  }
}
</code></pre>
<h3 data-id="heading-14">场景2：处理嵌套对象</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> company = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'TechCorp'</span>,
  <span class="hljs-attr">departments</span>: {
    <span class="hljs-attr">engineering</span>: { <span class="hljs-attr">employees</span>: <span class="hljs-number">50</span>, <span class="hljs-attr">budget</span>: <span class="hljs-number">1000000</span> },
    <span class="hljs-attr">sales</span>: { <span class="hljs-attr">employees</span>: <span class="hljs-number">20</span>, <span class="hljs-attr">budget</span>: <span class="hljs-number">500000</span> },
    <span class="hljs-attr">marketing</span>: { <span class="hljs-attr">employees</span>: <span class="hljs-number">15</span>, <span class="hljs-attr">budget</span>: <span class="hljs-number">300000</span> }
  }
};

<span class="hljs-comment">// 扁平化迭代器</span>
company[<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">iterator</span>] = <span class="hljs-keyword">function</span>* () {
  <span class="hljs-keyword">yield</span> [<span class="hljs-string">'公司名称'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>];
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [dept, info] <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">departments</span>)) {
    <span class="hljs-keyword">yield</span> [<span class="hljs-string">`<span class="hljs-subst">${dept}</span>部门人数`</span>, info.<span class="hljs-property">employees</span>];
    <span class="hljs-keyword">yield</span> [<span class="hljs-string">`<span class="hljs-subst">${dept}</span>部门预算`</span>, info.<span class="hljs-property">budget</span>];
  }
};

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [label, value] <span class="hljs-keyword">of</span> company) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${label}</span>: <span class="hljs-subst">${value}</span>`</span>);
}
</code></pre>
<h2 data-id="heading-15">7. <strong>性能考虑</strong></h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> obj = {};
<span class="hljs-comment">// 创建一个大对象</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000000</span>; i++) {
  obj[<span class="hljs-string">`key<span class="hljs-subst">${i}</span>`</span>] = i;
}

<span class="hljs-comment">// 测试不同方法的性能</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(<span class="hljs-string">'Object.keys + for...of'</span>);
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(obj)) {
  <span class="hljs-keyword">const</span> value = obj[key];
}
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(<span class="hljs-string">'Object.keys + for...of'</span>);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(<span class="hljs-string">'Object.entries + for...of'</span>);
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [key, value] <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(obj)) {
  <span class="hljs-comment">// 直接有值</span>
}
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(<span class="hljs-string">'Object.entries + for...of'</span>);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(<span class="hljs-string">'for...in'</span>);
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> obj) {
  <span class="hljs-keyword">if</span> (obj.<span class="hljs-title function_">hasOwnProperty</span>(key)) {
    <span class="hljs-keyword">const</span> value = obj[key];
  }
}
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(<span class="hljs-string">'for...in'</span>);
</code></pre>
<h2 data-id="heading-16">8. <strong>实用工具函数</strong></h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 创建可迭代对象的工具函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">makeIterable</span>(<span class="hljs-params">obj, options = {}</span>) {
  <span class="hljs-keyword">const</span> {
    exclude = [],      <span class="hljs-comment">// 排除的属性</span>
    includeOnly = <span class="hljs-literal">null</span>, <span class="hljs-comment">// 只包含的属性</span>
    sortKeys = <span class="hljs-literal">false</span>,  <span class="hljs-comment">// 是否按键排序</span>
    valueOnly = <span class="hljs-literal">false</span>  <span class="hljs-comment">// 只返回值</span>
  } = options;
  
  <span class="hljs-keyword">const</span> iterable = { ...obj };
  
  iterable[<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">iterator</span>] = <span class="hljs-keyword">function</span>* () {
    <span class="hljs-keyword">let</span> keys = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(<span class="hljs-variable language_">this</span>);
    
    <span class="hljs-comment">// 过滤</span>
    <span class="hljs-keyword">if</span> (exclude.<span class="hljs-property">length</span>) {
      keys = keys.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> !exclude.<span class="hljs-title function_">includes</span>(key));
    }
    
    <span class="hljs-keyword">if</span> (includeOnly) {
      keys = keys.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> includeOnly.<span class="hljs-title function_">includes</span>(key));
    }
    
    <span class="hljs-comment">// 排序</span>
    <span class="hljs-keyword">if</span> (sortKeys) {
      keys.<span class="hljs-title function_">sort</span>();
    }
    
    <span class="hljs-comment">// 迭代</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">of</span> keys) {
      <span class="hljs-keyword">if</span> (valueOnly) {
        <span class="hljs-keyword">yield</span> <span class="hljs-variable language_">this</span>[key];
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">yield</span> [key, <span class="hljs-variable language_">this</span>[key]];
      }
    }
  };
  
  <span class="hljs-keyword">return</span> iterable;
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> data = { <span class="hljs-attr">a</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">b</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">c</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">d</span>: <span class="hljs-number">4</span>, <span class="hljs-attr">e</span>: <span class="hljs-number">5</span> };
<span class="hljs-keyword">const</span> iterableData = <span class="hljs-title function_">makeIterable</span>(data, {
  <span class="hljs-attr">exclude</span>: [<span class="hljs-string">'e'</span>],
  <span class="hljs-attr">sortKeys</span>: <span class="hljs-literal">true</span>
});

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [key, value] <span class="hljs-keyword">of</span> iterableData) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(key, value); <span class="hljs-comment">// a 1, b 2, c 3, d 4</span>
}
</code></pre>
<h2 data-id="heading-17">总结</h2>
<ol>
<li><strong>最简单的方法</strong>：使用 <code>Object.keys()</code>、<code>Object.values()</code> 或 <code>Object.entries()</code></li>
<li><strong>需要直接迭代对象</strong>：实现 <code>Symbol.iterator</code> 方法</li>
<li><strong>需要自定义迭代逻辑</strong>：使用生成器函数</li>
<li><strong>考虑性能</strong>：<code>Object.entries()</code> + <code>for...of</code> 通常是性能和可读性的最佳平衡</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 推荐的最佳实践</span>
<span class="hljs-keyword">const</span> obj = { <span class="hljs-attr">a</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">b</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">c</span>: <span class="hljs-number">3</span> };

<span class="hljs-comment">// 1. 只需要键或值</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(obj)) { }
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> value <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">values</span>(obj)) { }

<span class="hljs-comment">// 2. 需要键值对</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [key, value] <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(obj)) { }

<span class="hljs-comment">// 3. 需要直接迭代对象（添加迭代器）</span>
obj[<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">iterator</span>] = <span class="hljs-keyword">function</span>* () {
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [key, value] <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(<span class="hljs-variable language_">this</span>)) {
    <span class="hljs-keyword">yield</span> { key, value };
  }
};
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Elpis npm 包抽离总结]]></title>    <link>https://juejin.cn/post/7592803747471933490</link>    <guid>https://juejin.cn/post/7592803747471933490</guid>    <pubDate>2026-01-08T14:21:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592803747471933490" data-draft-id="7592822714068090931" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Elpis npm 包抽离总结"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-08T14:21:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="未等与你踏清风"/> <meta itemprop="url" content="https://juejin.cn/user/2203871969545191"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Elpis npm 包抽离总结
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2203871969545191/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    未等与你踏清风
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T14:21:04.000Z" title="Thu Jan 08 2026 14:21:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文档总结将 elpis 框架抽离为 npm 包过程中的核心难点与解决方案</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">核心难点</h2>
<h3 data-id="heading-1">1. 路径解析的双重性挑战 ⭐⭐⭐</h3>
<p><strong>问题</strong>：npm 包内代码需要同时访问包内资源和业务项目资源，两类路径的解析方式完全不同。</p>
<p><strong>核心区别</strong>：</p>























<table><thead><tr><th>路径类型</th><th>使用变量</th><th>指向位置</th><th>特点</th></tr></thead><tbody><tr><td>包内路径</td><td><code>__dirname</code></td><td>npm 包安装目录（如 <code>node_modules/@david-yjy/elpis/...</code>）</td><td>固定不变</td></tr><tr><td>业务路径</td><td><code>process.cwd()</code></td><td>执行命令时的当前工作目录（业务项目根目录）</td><td>动态变化</td></tr></tbody></table>
<p><strong>代码示例</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// webpack.base.js</span>

<span class="hljs-comment">// ✅ 包内路径：使用 __dirname</span>
<span class="hljs-keyword">const</span> elpisEntryList = path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'../../pages/**/entry.*.js'</span>);

<span class="hljs-comment">// ✅ 业务路径：使用 process.cwd()</span>
<span class="hljs-keyword">const</span> businessEntryList = path.<span class="hljs-title function_">resolve</span>(process.<span class="hljs-title function_">cwd</span>(), <span class="hljs-string">'./app/pages/**/entry.*.js'</span>);
</code></pre>
<p><strong>常见卡点</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 错误：混淆两种路径类型</span>
<span class="hljs-keyword">const</span> businessConfig = <span class="hljs-built_in">require</span>(path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'./app/config.js'</span>));

<span class="hljs-comment">// ✅ 正确：明确区分</span>
<span class="hljs-keyword">const</span> businessConfig = <span class="hljs-built_in">require</span>(path.<span class="hljs-title function_">resolve</span>(process.<span class="hljs-title function_">cwd</span>(), <span class="hljs-string">'./app/config.js'</span>));
</code></pre>
<p><strong>学习要点</strong>：</p>
<ul>
<li><code>__dirname</code> = 模块文件所在目录（包内，固定）</li>
<li><code>process.cwd()</code> = 进程当前工作目录（业务项目，动态）</li>
<li><strong>永远不要假设业务项目路径相对于包的位置</strong></li>
</ul>
<hr/>
<h3 data-id="heading-2">2. Loader 解析的路径问题 ⭐⭐⭐</h3>
<p><strong>问题</strong>：直接使用字符串路径配置 loader 会导致路径找不到或版本冲突。</p>
<p><strong>解决方案</strong>：使用 <code>require.resolve()</code> 确保从包内解析 loader。</p>
<p><strong>代码对比</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 错误：可能找不到或版本不对</span>
<span class="hljs-attr">module</span>: {
  <span class="hljs-attr">rules</span>: [{
    <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.vue$/</span>,
    <span class="hljs-attr">use</span>: <span class="hljs-string">'vue-loader'</span>
  }]
}

<span class="hljs-comment">// ✅ 正确：使用 require.resolve() 从包内解析</span>
<span class="hljs-attr">module</span>: {
  <span class="hljs-attr">rules</span>: [{
    <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.vue$/</span>,
    <span class="hljs-attr">use</span>: {
      <span class="hljs-attr">loader</span>: <span class="hljs-built_in">require</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">'vue-loader'</span>),  <span class="hljs-comment">// 确保版本一致</span>
    }
  }]
}
</code></pre>
<p><strong>为什么这样做？</strong></p>
<ul>
<li>✅ <strong>版本一致性</strong>：确保使用包内定义的 loader 版本</li>
<li>✅ <strong>路径可靠性</strong>：无论在什么环境下都能找到正确的 loader</li>
<li>✅ <strong>隔离性</strong>：包内依赖不会影响业务项目</li>
</ul>
<hr/>
<h3 data-id="heading-3">3. 业务扩展点的可选性设计 ⭐⭐</h3>
<p><strong>问题</strong>：框架需要提供扩展点让业务项目自定义配置，但这些配置必须是<strong>可选的</strong>，缺失时不能报错。</p>
<p><strong>解决方案</strong>：使用 <code>fs.existsSync()</code> 检查 + 空模块降级。</p>
<p><strong>代码示例</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// webpack.base.js</span>

<span class="hljs-attr">resolve</span>: {
  <span class="hljs-attr">alias</span>: (<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> aliasMap = {};
    <span class="hljs-keyword">const</span> blankModulePath = path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'../libs/blank.js'</span>);

    <span class="hljs-comment">// 检查业务配置文件是否存在</span>
    <span class="hljs-keyword">const</span> businessConfig = path.<span class="hljs-title function_">resolve</span>(process.<span class="hljs-title function_">cwd</span>(), <span class="hljs-string">'./app/pages/dashboard/root.js'</span>);

    <span class="hljs-comment">// ✅ 关键：存在用业务配置，不存在用空模块</span>
    aliasMap[<span class="hljs-string">'$businessDashboardRouterConfig'</span>] =
      fs.<span class="hljs-title function_">existsSync</span>(businessConfig)
        ? businessConfig      <span class="hljs-comment">// 存在：使用业务配置</span>
        : blankModulePath;    <span class="hljs-comment">// 不存在：使用空模块</span>

    <span class="hljs-keyword">return</span> aliasMap;
  })()
}
</code></pre>
<p><strong>空模块</strong> (<code>blank.js</code>)：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {}  <span class="hljs-comment">// 确保业务代码可以安全 require</span>
</code></pre>
<p><strong>设计模式</strong>：</p>
<ol>
<li><strong>检测</strong>：<code>fs.existsSync()</code> 检查文件是否存在</li>
<li><strong>降级</strong>：不存在时提供默认实现（空模块）</li>
<li><strong>透明</strong>：通过 webpack alias，业务代码无需关心配置来源</li>
</ol>
<hr/>
<h3 data-id="heading-4">4. 配置合并与容错加载 ⭐⭐</h3>
<p><strong>问题</strong>：业务项目可能想要自定义 webpack 配置，但这个配置应该是可选的。</p>
<p><strong>解决方案</strong>：使用 try-catch 容错 + webpack-merge 合并。</p>
<p><strong>代码示例</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// webpack.base.js</span>

<span class="hljs-comment">// ✅ 容错加载业务配置</span>
<span class="hljs-keyword">let</span> businessWebpackConfig = {};
<span class="hljs-keyword">try</span> {
  businessWebpackConfig = <span class="hljs-built_in">require</span>(<span class="hljs-string">`<span class="hljs-subst">${process.cwd()}</span>/app/webpack.config.js`</span>);
} <span class="hljs-keyword">catch</span> (error) {
  <span class="hljs-comment">// 静默处理：业务配置不存在是正常的</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'未找到业务 webpack 配置'</span>);
}

<span class="hljs-comment">// ✅ 使用 webpack-merge 的 smart 策略合并</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = merge.<span class="hljs-title function_">smart</span>(
  baseConfig,        <span class="hljs-comment">// 框架基础配置</span>
  businessWebpackConfig  <span class="hljs-comment">// 业务配置（可选，会覆盖基础配置）</span>
);
</code></pre>
<p><strong>关键点</strong>：</p>
<ul>
<li>✅ 业务配置缺失不影响框架功能</li>
<li>✅ 业务配置会智能合并（数组合并，对象覆盖）</li>
<li>✅ 降低使用门槛，渐进增强</li>
</ul>
<hr/>
<h2 data-id="heading-5">关键技术点总结</h2>
<h3 data-id="heading-6">路径解析的核心原则</h3>

























<table><thead><tr><th>场景</th><th>使用变量</th><th>原因</th></tr></thead><tbody><tr><td>包内资源路径</td><td><code>__dirname</code></td><td>指向包安装位置，固定不变</td></tr><tr><td>业务资源路径</td><td><code>process.cwd()</code></td><td>指向执行目录，动态变化</td></tr><tr><td>Loader/插件路径</td><td><code>require.resolve()</code></td><td>确保从包内解析，版本一致</td></tr></tbody></table>
<h3 data-id="heading-7">容错设计模式</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 模式1：可选配置检查 + 空模块降级</span>
<span class="hljs-keyword">const</span> config = fs.<span class="hljs-title function_">existsSync</span>(configPath) ? configPath : blankModulePath;

<span class="hljs-comment">// 模式2：try-catch 容错</span>
<span class="hljs-keyword">let</span> config = {};
<span class="hljs-keyword">try</span> {
  config = <span class="hljs-built_in">require</span>(configPath);
} <span class="hljs-keyword">catch</span> (error) {
  <span class="hljs-comment">// 静默处理</span>
}
</code></pre>
<h3 data-id="heading-8">配置合并策略</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 使用 webpack-merge 的 smart 策略</span>
<span class="hljs-keyword">const</span> finalConfig = merge.<span class="hljs-title function_">smart</span>(baseConfig, businessConfig);
<span class="hljs-comment">// - 对象属性：后面的覆盖前面的</span>
<span class="hljs-comment">// - 数组：会合并去重（如 plugins、rules）</span>
</code></pre>
<hr/>
<h2 data-id="heading-9">最佳实践</h2>
<h3 data-id="heading-10">1. 路径处理规范</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 推荐：使用辅助函数明确区分</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getPackagePath</span>(<span class="hljs-params">...paths</span>) {
  <span class="hljs-keyword">return</span> path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'../../'</span>, ...paths);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">getProjectPath</span>(<span class="hljs-params">...paths</span>) {
  <span class="hljs-keyword">return</span> path.<span class="hljs-title function_">resolve</span>(process.<span class="hljs-title function_">cwd</span>(), ...paths);
}
</code></pre>
<h3 data-id="heading-11">2. 依赖管理</h3>
<ul>
<li><strong>框架包</strong>：构建依赖放在 <code>dependencies</code>，确保版本一致</li>
<li><strong>业务项目</strong>：只需安装框架包，依赖由包提供</li>
</ul>
<hr/>
<h2 data-id="heading-12">总结</h2>
<p>将框架抽离为 npm 包的核心挑战在于<strong>路径上下文的管理</strong>。通过合理使用：</p>
<ol>
<li>✅ <strong><code>__dirname</code></strong> - 访问包内资源（固定）</li>
<li>✅ <strong><code>process.cwd()</code></strong> - 访问业务项目资源（动态）</li>
<li>✅ <strong><code>require.resolve()</code></strong> - 解析包内依赖（版本一致）</li>
<li>✅ <strong>容错设计</strong> - 可选配置优雅降级</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[轻量级 Git Hooks 管理工具 Husky]]></title>    <link>https://juejin.cn/post/7592622563547316259</link>    <guid>https://juejin.cn/post/7592622563547316259</guid>    <pubDate>2026-01-08T14:26:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592622563547316259" data-draft-id="7592829037937426447" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="轻量级 Git Hooks 管理工具 Husky"/> <meta itemprop="keywords" content="前端,代码规范"/> <meta itemprop="datePublished" content="2026-01-08T14:26:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="晨米酱"/> <meta itemprop="url" content="https://juejin.cn/user/712900761892056"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            轻量级 Git Hooks 管理工具 Husky
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/712900761892056/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    晨米酱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T14:26:34.000Z" title="Thu Jan 08 2026 14:26:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    12
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 概述</h2>
<h3 data-id="heading-1">1.1 什么是 Husky</h3>
<p>Husky 是一个轻量级的 Git Hooks 管理工具，专为 Node.js 项目设计。它利用 Git 的 <code>core.hooksPath</code> 特性，让团队可以在版本控制中共享 Git Hooks 配置。</p>
<p><strong>核心特性：</strong></p>





























<table><thead><tr><th>特性</th><th>说明</th></tr></thead><tbody><tr><td>轻量</td><td>仅 2kB（gzipped），零依赖</td></tr><tr><td>快速</td><td>执行时间约 1ms</td></tr><tr><td>跨平台</td><td>支持 macOS、Linux、Windows</td></tr><tr><td>全面支持</td><td>支持全部 13 种客户端 Git Hooks</td></tr><tr><td>生态完善</td><td>与 lint-staged、commitlint 等工具无缝集成</td></tr></tbody></table>
<h3 data-id="heading-2">1.2 工作原理</h3>
<pre><code class="hljs language-sql" lang="sql">项目目录<span class="hljs-operator">/</span>
├── .husky<span class="hljs-operator">/</span>
│   ├── pre<span class="hljs-operator">-</span><span class="hljs-keyword">commit</span>      # pre<span class="hljs-operator">-</span><span class="hljs-keyword">commit</span> hook 脚本
│   └── <span class="hljs-keyword">commit</span><span class="hljs-operator">-</span>msg      # <span class="hljs-keyword">commit</span><span class="hljs-operator">-</span>msg hook 脚本
├── package.json        # 包含 <span class="hljs-keyword">prepare</span> 脚本
└── ...
</code></pre>
<ol>
<li><strong>安装时</strong>：设置 Git 的 <code>core.hooksPath</code> 指向 <code>.husky</code> 目录</li>
<li><strong>触发时</strong>：Git 事件触发 <code>.husky</code> 目录中对应的脚本</li>
<li><strong>执行时</strong>：脚本运行指定命令，失败则阻止 Git 操作</li>
</ol>
<h2 data-id="heading-3">2. 安装和配置</h2>
<h3 data-id="heading-4">2.1 快速开始（推荐）</h3>
<p>使用 <code>husky init</code> 一键完成安装和初始化：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># npm</span>
npx husky init

<span class="hljs-comment"># pnpm</span>
pnpm <span class="hljs-built_in">exec</span> husky init

<span class="hljs-comment"># yarn</span>
yarn dlx husky init

<span class="hljs-comment"># bun</span>
bunx husky init
</code></pre>
<p>该命令会自动：</p>
<ul>
<li>安装 husky 作为开发依赖</li>
<li>创建 <code>.husky/</code> 目录</li>
<li>在 <code>package.json</code> 中添加 <code>prepare</code> 脚本</li>
<li>创建示例 <code>pre-commit</code> hook</li>
</ul>
<h3 data-id="heading-5">2.2 手动安装</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 安装</span>
npm install husky --save-dev

<span class="hljs-comment"># 2. 初始化</span>
npx husky init
</code></pre>
<p><code>package.json</code> 中的 prepare 脚本：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"prepare"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"husky"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<blockquote>
<p><code>prepare</code> 脚本在 <code>npm install</code> 后自动执行，确保团队成员克隆项目后自动配置 hooks。</p>
</blockquote>
<h3 data-id="heading-6">2.3 添加 Hook</h3>
<p>创建 hook 非常简单，只需在 <code>.husky/</code> 目录下创建对应名称的文件：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 方法 1：使用 echo</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"npm test"</span> &gt; .husky/pre-commit

<span class="hljs-comment"># 方法 2：手动创建文件</span>
<span class="hljs-comment"># 直接编辑 .husky/pre-commit 文件</span>
</code></pre>
<p>Hook 脚本示例：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># .husky/pre-commit</span>
npm run lint
npm <span class="hljs-built_in">test</span>
</code></pre>
<blockquote>
<p><strong>注意</strong>：Husky v9 的 hook 脚本不需要 shebang 行（如 <code>#!/bin/sh</code>），Husky 会自动处理。</p>
</blockquote>
<h3 data-id="heading-7">2.4 在 CI/Docker 中禁用</h3>
<p>CI 环境通常不需要 Git hooks：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 方法 1：环境变量（推荐）</span>
HUSKY=0 npm ci

<span class="hljs-comment"># 方法 2：GitHub Actions</span>
- run: npm ci
  <span class="hljs-built_in">env</span>:
    HUSKY: 0

<span class="hljs-comment"># 方法 3：package.json 容错处理</span>
{
  <span class="hljs-string">"scripts"</span>: {
    <span class="hljs-string">"prepare"</span>: <span class="hljs-string">"husky || true"</span>
  }
}
</code></pre>
<h2 data-id="heading-8">3. 常用 Git Hooks</h2>
<h3 data-id="heading-9">3.1 pre-commit</h3>
<p>提交前执行，用于代码检查和格式化。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># .husky/pre-commit</span>
npx lint-staged
</code></pre>
<h3 data-id="heading-10">3.2 commit-msg</h3>
<p>验证提交信息格式。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># .husky/commit-msg</span>
npx --no -- commitlint --edit <span class="hljs-variable">$1</span>
</code></pre>
<p>自定义验证示例：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># .husky/commit-msg</span>
commit_msg=$(<span class="hljs-built_in">cat</span> <span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>)
pattern=<span class="hljs-string">"^(feat|fix|docs|style|refactor|test|chore)(\(.+\))?: .{1,50}"</span>

<span class="hljs-keyword">if</span> ! <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$commit_msg</span>"</span> | grep -qE <span class="hljs-string">"<span class="hljs-variable">$pattern</span>"</span>; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"错误：提交信息格式不正确"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"格式：&lt;type&gt;(&lt;scope&gt;): &lt;subject&gt;"</span>
    <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>
</code></pre>
<h3 data-id="heading-11">3.3 pre-push</h3>
<p>推送前执行，用于运行测试。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># .husky/pre-push</span>
npm <span class="hljs-built_in">test</span>
npm run build
</code></pre>
<h3 data-id="heading-12">3.4 post-merge</h3>
<p>合并/拉取后执行，用于自动更新依赖。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># .husky/post-merge</span>
changed=$(git diff-tree -r --name-only --no-commit-id ORIG_HEAD HEAD)

<span class="hljs-keyword">if</span> <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$changed</span>"</span> | grep -q <span class="hljs-string">"package-lock.json"</span>; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"依赖变化，正在安装..."</span>
    npm ci
<span class="hljs-keyword">fi</span>
</code></pre>
<h2 data-id="heading-13">4. 与其他工具集成</h2>
<h3 data-id="heading-14">4.1 lint-staged</h3>
<p>只对暂存文件运行检查，大幅提升速度。</p>
<pre><code class="hljs language-bash" lang="bash">npm install lint-staged --save-dev
</code></pre>
<p><strong>package.json 配置：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"lint-staged"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"*.{js,ts,jsx,tsx}"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"eslint --fix"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"prettier --write"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"*.{css,scss}"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"prettier --write"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"*.md"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"prettier --write"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>Husky 配置：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># .husky/pre-commit</span>
npx lint-staged
</code></pre>
<h3 data-id="heading-15">4.2 commitlint</h3>
<p>检查提交信息是否符合 Conventional Commits 规范。</p>
<pre><code class="hljs language-bash" lang="bash">npm install @commitlint/cli @commitlint/config-conventional --save-dev
</code></pre>
<p><strong>commitlint.config.js：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">extends</span>: [<span class="hljs-string">'@commitlint/config-conventional'</span>],
};
</code></pre>
<p><strong>Husky 配置：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># .husky/commit-msg</span>
npx --no -- commitlint --edit <span class="hljs-variable">$1</span>
</code></pre>
<h3 data-id="heading-16">4.3 完整配置示例</h3>
<p><strong>package.json：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"prepare"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"husky"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"lint"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"eslint src"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"test"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"jest"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"devDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"@commitlint/cli"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^19.0.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"@commitlint/config-conventional"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^19.0.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"husky"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^9.0.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"lint-staged"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^15.0.0"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"lint-staged"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"*.{js,ts}"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"eslint --fix"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"prettier --write"</span><span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>.husky/pre-commit：</strong></p>
<pre><code class="hljs language-bash" lang="bash">npx lint-staged
</code></pre>
<p><strong>.husky/commit-msg：</strong></p>
<pre><code class="hljs language-bash" lang="bash">npx --no -- commitlint --edit <span class="hljs-variable">$1</span>
</code></pre>
<h2 data-id="heading-17">5. 最佳实践</h2>
<h3 data-id="heading-18">5.1 性能优化</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用 lint-staged 只检查变更文件</span>
npx lint-staged

<span class="hljs-comment"># ESLint 启用缓存</span>
eslint --fix --cache

<span class="hljs-comment"># 耗时任务放到 pre-push 而非 pre-commit</span>
</code></pre>
<h3 data-id="heading-19">5.2 Monorepo 配置</h3>
<p>当 <code>package.json</code> 不在 Git 根目录时：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"prepare"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"cd .. &amp;&amp; husky frontend/.husky"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-20">5.3 启动文件</h3>
<p>配置 Node 版本管理器（nvm、fnm 等）的初始化脚本：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># ~/.config/husky/init.sh</span>
<span class="hljs-built_in">export</span> NVM_DIR=<span class="hljs-string">"<span class="hljs-variable">$HOME</span>/.nvm"</span>
[ -s <span class="hljs-string">"<span class="hljs-variable">$NVM_DIR</span>/nvm.sh"</span> ] &amp;&amp; \. <span class="hljs-string">"<span class="hljs-variable">$NVM_DIR</span>/nvm.sh"</span>
</code></pre>
<h2 data-id="heading-21">6. 故障排除</h2>
<h3 data-id="heading-22">6.1 Hooks 不执行</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 检查 hook 文件名是否正确（不能是 precommit 或 pre-commit.sh）</span>
<span class="hljs-built_in">ls</span> .husky/

<span class="hljs-comment"># 2. 检查 Git hooks 路径</span>
git config core.hooksPath

<span class="hljs-comment"># 3. 确保 Git 版本 &gt;= 2.9</span>
git --version

<span class="hljs-comment"># 4. 重新初始化</span>
npx husky init
</code></pre>
<h3 data-id="heading-23">6.2 Command not found</h3>
<p>GUI 应用或某些环境可能找不到 node/npm，配置启动文件：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># ~/.config/husky/init.sh</span>
<span class="hljs-built_in">export</span> PATH=<span class="hljs-string">"/usr/local/bin:<span class="hljs-variable">$PATH</span>"</span>
</code></pre>
<h3 data-id="heading-24">6.3 卸载后残留问题</h3>
<p>如果卸载 Husky 后 hooks 仍然失败：</p>
<pre><code class="hljs language-bash" lang="bash">git config --<span class="hljs-built_in">unset</span> core.hooksPath
</code></pre>
<h3 data-id="heading-25">6.4 Windows + Yarn 问题</h3>
<p>Git Bash 配合 Yarn 可能出现 "stdin is not a tty" 错误：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># .husky/common.sh</span>
<span class="hljs-keyword">if</span> [ -t 1 ]; <span class="hljs-keyword">then</span>
  <span class="hljs-built_in">exec</span> &lt; /dev/tty
<span class="hljs-keyword">fi</span>
</code></pre>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># .husky/pre-commit</span>
. <span class="hljs-string">"<span class="hljs-subst">$(dirname <span class="hljs-string">"<span class="hljs-variable">$0</span>"</span>)</span>/common.sh"</span>
yarn lint
</code></pre>
<h3 data-id="heading-26">6.5 跳过 Hooks</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 单次跳过</span>
git commit --no-verify -m <span class="hljs-string">"message"</span>
git push --no-verify

<span class="hljs-comment"># 临时禁用所有 hooks</span>
HUSKY=0 git commit -m <span class="hljs-string">"message"</span>

<span class="hljs-comment"># 多个命令</span>
<span class="hljs-built_in">export</span> HUSKY=0
git add .
git commit -m <span class="hljs-string">"message"</span>
<span class="hljs-built_in">unset</span> HUSKY
</code></pre>
<h3 data-id="heading-27">6.6 测试 Hook</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 直接运行脚本</span>
sh .husky/pre-commit

<span class="hljs-comment"># 添加 exit 1 测试是否能阻止提交</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"exit 1"</span> &gt;&gt; .husky/pre-commit

<span class="hljs-comment"># 查看详细执行过程</span>
GIT_TRACE=1 git commit -m <span class="hljs-string">"test"</span>
</code></pre>
<h2 data-id="heading-28">7. 版本迁移</h2>
<h3 data-id="heading-29">7.1 从 v4 迁移到 v9</h3>
<p><strong>v4 配置（旧）：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"husky"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"hooks"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"pre-commit"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"lint-staged"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"commit-msg"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"commitlint -E HUSKY_GIT_PARAMS"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>v9 配置（新）：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># .husky/pre-commit</span>
npx lint-staged
</code></pre>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># .husky/commit-msg</span>
npx --no -- commitlint --edit <span class="hljs-variable">$1</span>
</code></pre>
<p><strong>迁移步骤：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 升级</span>
npm install husky@latest --save-dev

<span class="hljs-comment"># 2. 删除 package.json 中的 "husky" 字段</span>

<span class="hljs-comment"># 3. 初始化</span>
npx husky init

<span class="hljs-comment"># 4. 创建 hooks</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"npx lint-staged"</span> &gt; .husky/pre-commit
<span class="hljs-built_in">echo</span> <span class="hljs-string">"npx --no -- commitlint --edit \$1"</span> &gt; .husky/commit-msg
</code></pre>
<p><strong>主要变化：</strong></p>






























<table><thead><tr><th>方面</th><th>v4</th><th>v9</th></tr></thead><tbody><tr><td>配置位置</td><td>package.json</td><td>.husky/ 目录</td></tr><tr><td>Hook 格式</td><td>JSON</td><td>Shell 脚本</td></tr><tr><td>环境变量</td><td>HUSKY_GIT_PARAMS</td><td>$1</td></tr><tr><td>大小</td><td>~1MB</td><td>2kB</td></tr></tbody></table>
<h2 data-id="heading-30">参考资源</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftypicode.github.io%2Fhusky%2F" target="_blank" title="https://typicode.github.io/husky/" ref="nofollow noopener noreferrer">Husky 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgit-scm.com%2Fdocs%2Fgithooks" target="_blank" title="https://git-scm.com/docs/githooks" ref="nofollow noopener noreferrer">Git Hooks</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.npmjs.com%2Fcli%2Fv11%2Fusing-npm%2Fscripts" target="_blank" title="https://docs.npmjs.com/cli/v11/using-npm/scripts" ref="nofollow noopener noreferrer">NPM Script</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flint-staged%2Flint-staged" target="_blank" title="https://github.com/lint-staged/lint-staged" ref="nofollow noopener noreferrer">lint-staged</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcommitlint.js.org%2F" target="_blank" title="https://commitlint.js.org/" ref="nofollow noopener noreferrer">commitlint</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【 前端三剑客-35 /Lesson58(2025-12-08)】JavaScript 原型继承与对象创建机制详解🧬]]></title>    <link>https://juejin.cn/post/7592823500416729114</link>    <guid>https://juejin.cn/post/7592823500416729114</guid>    <pubDate>2026-01-08T14:28:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592823500416729114" data-draft-id="7592822714068140083" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【 前端三剑客-35 /Lesson58(2025-12-08)】JavaScript 原型继承与对象创建机制详解🧬"/> <meta itemprop="keywords" content="JavaScript,前端,面试"/> <meta itemprop="datePublished" content="2026-01-08T14:28:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Jing_Rainbow"/> <meta itemprop="url" content="https://juejin.cn/user/1285809519198256"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【 前端三剑客-35 /Lesson58(2025-12-08)】JavaScript 原型继承与对象创建机制详解🧬
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1285809519198256/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Jing_Rainbow
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T14:28:59.000Z" title="Thu Jan 08 2026 14:28:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>🧬JavaScript 是一门基于原型（Prototype-based）的动态语言，其继承机制与传统的类式（Class-based）语言（如 Java、C++）有本质区别。本文将系统性地讲解 JavaScript 中 <strong>原型继承</strong> 的核心原理、多种实现方式、对象创建方法、<code>call</code>/<code>apply</code> 的作用、组合继承优化技巧、以及现代 ES6 <code>class</code> 语法的本质，并结合实际代码深入剖析每一个细节。</p>
<hr/>
<h2 data-id="heading-0">🔗 一、原型与原型链：JavaScript 继承的基石</h2>
<h3 data-id="heading-1">📌 构造函数、原型、实例三者关系</h3>
<p>在 JavaScript 中，每个函数都有一个 <code>prototype</code> 属性，它指向一个对象（称为<strong>原型对象</strong>）。当我们使用 <code>new</code> 关键字调用构造函数时，会创建一个新对象，该对象的内部属性 <code>[[Prototype]]</code>（可通过 <code>__proto__</code> 访问）会指向构造函数的 <code>prototype</code>。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Cat</span>(<span class="hljs-params"/>) {}
<span class="hljs-title class_">Cat</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">species</span> = <span class="hljs-string">'猫科动物'</span>;

<span class="hljs-keyword">const</span> cat = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cat</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(cat.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Cat</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>); <span class="hljs-comment">// true</span>
</code></pre>
<p>此时：</p>
<ul>
<li><code>Cat</code> 是构造函数；</li>
<li><code>Cat.prototype</code> 是所有 <code>Cat</code> 实例共享的原型对象；</li>
<li><code>cat</code> 是实例，其 <code>__proto__</code> 指向 <code>Cat.prototype</code>。</li>
</ul>
<h3 data-id="heading-2">🔍 属性查找机制：遮蔽（Shadowing）</h3>
<p>当访问 <code>cat.species</code> 时，JavaScript 引擎按以下顺序查找：</p>
<ol>
<li><strong>先查实例自身</strong>：<code>cat</code> 是否有 <code>species</code> 属性？</li>
<li><strong>若无，则沿 <code>__proto__</code> 向上查找</strong>：即 <code>Cat.prototype.species</code>；</li>
<li><strong>继续向上</strong>：<code>Cat.prototype.__proto__</code> → <code>Object.prototype</code>；</li>
<li><strong>最终到 <code>null</code></strong>，查找失败。</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(cat.<span class="hljs-property">species</span>); <span class="hljs-comment">// '猫科动物'（来自原型）</span>

cat.<span class="hljs-property">species</span> = <span class="hljs-string">'hello'</span>; <span class="hljs-comment">// 在实例上定义同名属性</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(cat.<span class="hljs-property">species</span>); <span class="hljs-comment">// 'hello'（遮蔽了原型属性）</span>

<span class="hljs-keyword">delete</span> cat.<span class="hljs-property">species</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(cat.<span class="hljs-property">species</span>); <span class="hljs-comment">// '猫科动物'（恢复原型值）</span>
</code></pre>
<blockquote>
<p>✅ <strong>关键点</strong>：实例属性优先于原型属性，这就是“属性遮蔽”。</p>
</blockquote>
<h3 data-id="heading-3">🌐 原型链可视化</h3>
<pre><code class="hljs language-js" lang="js">cat (实例)
  └─ __proto__ → <span class="hljs-title class_">Cat</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>
        └─ __proto__ → <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>
              └─ __proto__ → <span class="hljs-literal">null</span>
</code></pre>
<p>验证：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(cat.<span class="hljs-property">constructor</span> === <span class="hljs-title class_">Cat</span>); <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Cat</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>); <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">__proto__</span> === <span class="hljs-literal">null</span>); <span class="hljs-comment">// true</span>
</code></pre>
<hr/>
<h2 data-id="heading-4">⚙️ 二、继承的本质：对象委托（Object Delegation）</h2>
<p>JavaScript 并非“类继承”，而是<strong>对象直接从其他对象继承</strong>——这称为<strong>委托</strong>。<br/>
当你调用 <code>cat.say()</code>，而 <code>cat</code> 自身没有 <code>say</code> 方法时，引擎会委托给 <code>Cat.prototype</code> 去执行。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title class_">Cat</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">say</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> <span class="hljs-string">'喵喵喵'</span>; };
<span class="hljs-keyword">const</span> cat1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cat</span>(), cat2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cat</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(cat1.<span class="hljs-property">say</span> === cat2.<span class="hljs-property">say</span>); <span class="hljs-comment">// true（共享同一个函数）</span>
</code></pre>
<blockquote>
<p>💡 这就是<strong>方法复用</strong>的核心优势：节省内存，提高性能。</p>
</blockquote>
<hr/>
<h2 data-id="heading-5">🧱 三、继承的多种实现方式</h2>
<h3 data-id="heading-6">1️⃣ 原型链继承（Prototype Chain Inheritance）</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">SuperType</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">property</span> = <span class="hljs-literal">true</span>;
}
<span class="hljs-title class_">SuperType</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">getSuperValue</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">property</span>; };

<span class="hljs-keyword">function</span> <span class="hljs-title function_">SubType</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">subproperty</span> = <span class="hljs-literal">false</span>;
}
<span class="hljs-title class_">SubType</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SuperType</span>(); <span class="hljs-comment">// 关键：子类原型 = 父类实例</span>
<span class="hljs-title class_">SubType</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">getSubValue</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">subproperty</span>; };
</code></pre>
<p>✅ 优点：简单直观。<br/>
❌ 缺点：</p>
<ul>
<li>引用类型属性被所有实例共享（如 <code>colors: []</code>）；</li>
<li>无法向父构造函数传参。</li>
</ul>
<hr/>
<h3 data-id="heading-7">2️⃣ 构造函数继承（Constructor Stealing / Classical Inheritance）</h3>
<p>利用 <code>call</code> 或 <code>apply</code> 在子类中调用父类构造函数：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">SuperType</span>(<span class="hljs-params">name</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">colors</span> = [<span class="hljs-string">'red'</span>, <span class="hljs-string">'blue'</span>];
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">SubType</span>(<span class="hljs-params">name, age</span>) {
  <span class="hljs-title class_">SuperType</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, name); <span class="hljs-comment">// ✅ 绑定 this，传递参数</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;
}
</code></pre>
<h4 data-id="heading-8">🔁 <code>call</code> vs <code>apply</code> 详解</h4>























<table><thead><tr><th>方法</th><th>语法</th><th>参数形式</th><th>适用场景</th></tr></thead><tbody><tr><td><code>call</code></td><td><code>func.call(thisArg, arg1, arg2, ...)</code></td><td>逐个参数</td><td>参数数量固定</td></tr><tr><td><code>apply</code></td><td><code>func.apply(thisArg, [arg1, arg2, ...])</code></td><td>数组或 <code>arguments</code></td><td>参数动态、已存在数组</td></tr></tbody></table>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 示例：借用方法</span>
greet.<span class="hljs-title function_">call</span>(person1, <span class="hljs-string">'你好'</span>); 
<span class="hljs-title class_">Math</span>.<span class="hljs-property">max</span>.<span class="hljs-title function_">apply</span>(<span class="hljs-literal">null</span>, [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>]); <span class="hljs-comment">// 推荐方式</span>

<span class="hljs-comment">// 继承中两者等价</span>
<span class="hljs-title class_">SuperType</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, name);
<span class="hljs-title class_">SuperType</span>.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, [name]);
</code></pre>
<p>✅ 优点：</p>
<ul>
<li>可传参；</li>
<li>避免引用类型共享（每个实例独立副本）。</li>
</ul>
<p>❌ 缺点：</p>
<ul>
<li>方法定义在构造函数内 → 无法复用；</li>
<li><strong>无法继承父类原型上的方法</strong>。</li>
</ul>
<hr/>
<h3 data-id="heading-9">3️⃣ 组合继承（Combination Inheritance）⭐ 最常用</h3>
<p>结合前两种方式：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">SuperType</span>(<span class="hljs-params">name</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">colors</span> = [<span class="hljs-string">'red'</span>, <span class="hljs-string">'blue'</span>];
}
<span class="hljs-title class_">SuperType</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">sayName</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>; };

<span class="hljs-keyword">function</span> <span class="hljs-title function_">SubType</span>(<span class="hljs-params">name, age</span>) {
  <span class="hljs-title class_">SuperType</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, name); <span class="hljs-comment">// 继承属性（每个实例独立）</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;
}

<span class="hljs-title class_">SubType</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SuperType</span>(); <span class="hljs-comment">// 继承方法（共享）</span>
<span class="hljs-title class_">SubType</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> = <span class="hljs-title class_">SubType</span>; <span class="hljs-comment">// 修复 constructor</span>
<span class="hljs-title class_">SubType</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">sayAge</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span>; };
</code></pre>
<p>✅ 优点：兼具属性独立 + 方法复用。<br/>
❌ 缺点：<strong>父类构造函数被调用两次</strong>（一次 <code>new SuperType()</code>，一次 <code>SuperType.call</code>）。</p>
<hr/>
<h3 data-id="heading-10">4️⃣ 利用空对象作为中介（寄生组合继承）✨ 优化版</h3>
<p>为避免父构造函数被调用两次，引入<strong>空函数中介</strong>：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">extend</span>(<span class="hljs-params">Child, Parent</span>) {
  <span class="hljs-keyword">const</span> F = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {};       <span class="hljs-comment">// 空函数</span>
  F.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-title class_">Parent</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>; <span class="hljs-comment">// 中介原型 = 父类原型</span>
  <span class="hljs-title class_">Child</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_">F</span>();     <span class="hljs-comment">// 子类原型 = 空实例</span>
  <span class="hljs-title class_">Child</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> = <span class="hljs-title class_">Child</span>; <span class="hljs-comment">// 修复 constructor</span>
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-title function_">extend</span>(<span class="hljs-title class_">Cat</span>, <span class="hljs-title class_">Animal</span>);
</code></pre>
<blockquote>
<p>🧠 原理：<code>new F()</code> 不会执行 <code>Parent</code> 构造函数，只建立原型链接。</p>
</blockquote>
<p>这是 <strong>最高效的原型链继承方式</strong>，也是许多库（如早期 jQuery）采用的模式。</p>
<hr/>
<h2 data-id="heading-11">🧪 四、<code>new Object()</code> 与 <code>new function()</code> 创建对象的区别</h2>
<h3 data-id="heading-12">🔹 <code>new Object()</code></h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> obj1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>(); <span class="hljs-comment">// {}</span>
<span class="hljs-keyword">var</span> obj2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>(<span class="hljs-string">"hello"</span>); <span class="hljs-comment">// String 对象</span>
</code></pre>
<ul>
<li>原型：<code>Object.prototype</code></li>
<li>初始化能力弱</li>
<li>适合创建简单空对象</li>
</ul>
<h3 data-id="heading-13">🔸 <code>new function()</code></h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> user = <span class="hljs-keyword">new</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">username</span>) {
  <span class="hljs-keyword">if</span> (!username) <span class="hljs-keyword">throw</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"用户名不能为空"</span>);
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">username</span> = username;
  <span class="hljs-keyword">var</span> privateVar = <span class="hljs-string">"secret"</span>; <span class="hljs-comment">// 私有变量（闭包）</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">check</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">pwd</span>) { <span class="hljs-keyword">return</span> pwd === privateVar; };
};
</code></pre>
<ul>
<li>原型：自定义函数的 <code>prototype</code></li>
<li>支持复杂初始化、私有变量、方法定义</li>
<li>可用于<strong>对象工厂</strong></li>
</ul>






























<table><thead><tr><th>特性</th><th><code>new Object()</code></th><th><code>new function()</code></th></tr></thead><tbody><tr><td>原型</td><td><code>Object.prototype</code></td><td>自定义 <code>prototype</code></td></tr><tr><td>私有属性</td><td>❌</td><td>✅（闭包）</td></tr><tr><td>方法复用</td><td>❌</td><td>✅（通过原型）</td></tr><tr><td>灵活性</td><td>低</td><td>高</td></tr></tbody></table>
<blockquote>
<p>💡 在继承中，<code>new function()</code>（空函数）是实现中介继承的关键。</p>
</blockquote>
<hr/>
<h2 data-id="heading-14">🧩 五、ES6 <code>class</code> 语法：语法糖，本质仍是原型</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  }
  <span class="hljs-title function_">sayHello</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`Hello, I'm <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>`</span>;
  }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Person</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name, grade</span>) {
    <span class="hljs-variable language_">super</span>(name); <span class="hljs-comment">// 必须调用，等价于 Person.call(this, name)</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">grade</span> = grade;
  }
  <span class="hljs-title function_">study</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span> is studying...`</span>;
  }
}
</code></pre>
<blockquote>
<p>⚠️ 注意：</p>
</blockquote>
<ul>
<li><code>extends</code> 本质仍是<strong>基于原型的继承</strong>；</li>
<li><code>super()</code> 必须在子类构造函数中调用；</li>
<li>静态方法和属性也可继承。</li>
</ul>
<hr/>
<h2 data-id="heading-15">🛠 六、最佳实践与高级技巧</h2>
<h3 data-id="heading-16">✅ 组合优于继承（Composition over Inheritance）</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> canFly = { <span class="hljs-title function_">fly</span>(<span class="hljs-params"/>) { <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Flying...'</span>); } };
<span class="hljs-keyword">const</span> canSwim = { <span class="hljs-title function_">swim</span>(<span class="hljs-params"/>) { <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Swimming...'</span>); } };
<span class="hljs-keyword">const</span> duck = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, canFly, canSwim);
</code></pre>
<blockquote>
<p>更灵活，避免继承层级过深。</p>
</blockquote>
<h3 data-id="heading-17">✅ 使用标准 API 操作原型</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 获取原型</span>
<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getPrototypeOf</span>(obj);

<span class="hljs-comment">// 设置原型（谨慎！影响性能）</span>
<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">setPrototypeOf</span>(obj, newProto);

<span class="hljs-comment">// 创建对象并指定原型</span>
<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(proto);
</code></pre>
<blockquote>
<p>避免使用非标准的 <code>__proto__</code>。</p>
</blockquote>
<h3 data-id="heading-18">✅ 重写原型时修复 <code>constructor</code></h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = {
  <span class="hljs-attr">constructor</span>: <span class="hljs-title class_">Person</span>, <span class="hljs-comment">// 手动设置</span>
  <span class="hljs-title function_">method1</span>(<span class="hljs-params"/>) {},
  <span class="hljs-title function_">method2</span>(<span class="hljs-params"/>) {}
};
</code></pre>
<p>否则 <code>instance.constructor</code> 会指向 <code>Object</code>。</p>
<hr/>
<h2 data-id="heading-19">⚠️ 七、常见陷阱与注意事项</h2>
<h3 data-id="heading-20">1. 原型上不要放引用类型</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// ❌ 错误</span>
<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">skills</span> = [<span class="hljs-string">'JS'</span>, <span class="hljs-string">'HTML'</span>]; <span class="hljs-comment">// 所有实例共享！</span>

<span class="hljs-comment">// ✅ 正确</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">skills</span> = [<span class="hljs-string">'JS'</span>, <span class="hljs-string">'HTML'</span>]; <span class="hljs-comment">// 每个实例独立</span>
}
</code></pre>
<h3 data-id="heading-21">2. 原型链过深影响性能</h3>
<p>频繁访问的属性应直接定义在实例上，避免长链查找。</p>
<h3 data-id="heading-22">3. <code>instanceof</code> 原理</h3>
<pre><code class="hljs language-java" lang="java">myDog <span class="hljs-keyword">instanceof</span> Dog; <span class="hljs-comment">// 检查 Dog.prototype 是否在 myDog 的原型链上</span>
</code></pre>
<hr/>
<h2 data-id="heading-23">🧪 八、综合示例：完整的动物继承体系</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 父类</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Animal</span>(<span class="hljs-params">name</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">alive</span> = <span class="hljs-literal">true</span>;
}
<span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = {
  <span class="hljs-attr">constructor</span>: <span class="hljs-title class_">Animal</span>,
  <span class="hljs-title function_">eat</span>(<span class="hljs-params"/>) { <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span> 在进食`</span>); },
  <span class="hljs-title function_">sleep</span>(<span class="hljs-params"/>) { <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span> 在睡觉`</span>); }
};

<span class="hljs-comment">// 子类</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Dog</span>(<span class="hljs-params">name, breed</span>) {
  <span class="hljs-title class_">Animal</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, name); <span class="hljs-comment">// 构造函数继承</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">breed</span> = breed;
}

<span class="hljs-comment">// 原型链继承（空对象中介）</span>
<span class="hljs-keyword">const</span> F = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {};
F.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>;
<span class="hljs-title class_">Dog</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_">F</span>();
<span class="hljs-title class_">Dog</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> = <span class="hljs-title class_">Dog</span>;

<span class="hljs-comment">// 扩展方法</span>
<span class="hljs-title class_">Dog</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">bark</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span> 汪汪叫`</span>);
};

<span class="hljs-comment">// 测试</span>
<span class="hljs-keyword">const</span> myDog = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dog</span>(<span class="hljs-string">'小黑'</span>, <span class="hljs-string">'拉布拉多'</span>);
myDog.<span class="hljs-title function_">eat</span>();  <span class="hljs-comment">// 继承自动物</span>
myDog.<span class="hljs-title function_">bark</span>(); <span class="hljs-comment">// 狗特有</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(myDog <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Animal</span>); <span class="hljs-comment">// true</span>
</code></pre>
<hr/>
<h2 data-id="heading-24">🌈 总结</h2>
<p>JavaScript 的继承机制围绕 <strong>原型链</strong> 和 <strong>对象委托</strong> 展开，核心概念包括：</p>
<ul>
<li><strong>构造函数</strong>：创建对象的模板；</li>
<li><strong>prototype</strong>：共享属性和方法的容器；</li>
<li><strong><strong>proto</strong></strong>：实例指向原型的链接；</li>
<li><strong>call/apply</strong>：实现构造函数继承的关键；</li>
<li><strong>组合继承 + 空对象中介</strong>：最优实践；</li>
<li><strong>ES6 class</strong>：语法糖，底层仍是原型。</li>
</ul>
<p>理解这些机制，不仅能写出健壮的继承代码，还能深入掌握 JavaScript 的面向对象哲学——<strong>万物皆对象，继承即委托</strong>。</p>
<blockquote>
<p>🧠 记住：JavaScript 不是“模拟类”，而是<strong>原生支持对象间直接继承</strong>。拥抱原型，而非对抗它。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[# Vue 事件系统核心：createInvoker 函数深度解析]]></title>    <link>https://juejin.cn/post/7592811397505728563</link>    <guid>https://juejin.cn/post/7592811397505728563</guid>    <pubDate>2026-01-08T15:38:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592811397505728563" data-draft-id="7592823500416892954" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="# Vue 事件系统核心：createInvoker 函数深度解析"/> <meta itemprop="keywords" content="Vue.js,JavaScript,前端"/> <meta itemprop="datePublished" content="2026-01-08T15:38:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="如果你好"/> <meta itemprop="url" content="https://juejin.cn/user/2272012281328215"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            # Vue 事件系统核心：createInvoker 函数深度解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2272012281328215/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    如果你好
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T15:38:37.000Z" title="Thu Jan 08 2026 15:38:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Vue 事件系统核心：createInvoker 函数深度解析</h2>
<blockquote>
<p>🔥 用过 Vue 的都知道，写 @click、@input 这种事件绑定很简单，但你有没有想过：背后 Vue 是怎么处理这些事件的？尤其是当事件回调需要动态变化时，它是怎么做到不频繁绑定/解绑 DOM 事件，还能保证性能的？</p>
</blockquote>
<p>答案就藏在 createInvoker 这个函数里。它是 Vue（特别是 Vue3）事件系统里的“事件调用器工厂”，核心作用就是创建一个能灵活更新逻辑的调用器。本文从代码结构开始，一步步把它扒明白。</p>
<h3 data-id="heading-1">一、先看核心代码：极简但藏玄机</h3>
<p>先上 createInvoker 的核心实现（简化版，保留最关键的逻辑），我们逐行看它到底在做什么：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createInvoker</span>(<span class="hljs-params">value</span>) { 
  <span class="hljs-comment">// 1. 定义一个调用器函数，用箭头函数写的</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">invoker</span> = (<span class="hljs-params">e</span>) =&gt; { 
    invoker.<span class="hljs-title function_">value</span>(e)  <span class="hljs-comment">// 调用器内部，会去执行自己身上的 value 属性</span>
  } 

  <span class="hljs-comment">// 2. 给这个调用器函数挂个 value 属性，指向传入的事件回调</span>
  invoker.<span class="hljs-property">value</span> = value 

  <span class="hljs-comment">// 3. 把调用器返回出去（函数末尾没写 return ，默认返回这个 invoker）</span>
}
</code></pre>
<p>这段代码看着特别简单，但其实就做了三件核心事，理解了这三件事，就懂了一半：</p>
<ul>
<li>造一个“中间层”：invoker 是个箭头函数，后续 DOM 事件实际绑的就是它；</li>
<li>存真实逻辑：把我们写的事件回调（比如 onClick 里的 handleClick），挂在 invoker 的 value 属性上；</li>
<li>返回中间层：把这个 invoker 返回出去，用于后续的 DOM 事件绑定。</li>
</ul>
<h3 data-id="heading-2">二、三个关键设计：为啥这函数这么好用？</h3>
<p>createInvoker 之所以能成为 Vue 事件系统的核心，全靠三个特别巧妙的设计。这些设计不是凭空来的，都是为了解决实际开发中的问题。</p>
<h4 data-id="heading-3">1. 函数居然也是对象？这是基础</h4>
<p>首先要明确一个 JavaScript 里的核心知识点：函数本质上也是对象。正因为函数是对象，我们才能给它“挂属性”——就像上面代码里，给 invoker 挂了个 value 属性。</p>
<p>所以在 createInvoker 里，invoker 其实有两个身份：</p>
<ul>
<li>作为“函数”：它是 DOM 事件的回调入口，点击、输入这些事件触发时，第一个被执行的就是它；</li>
<li>作为“对象”：它身上能存东西，这里的 value 就是用来存我们真正要执行的业务回调（比如 handleClick）；</li>
<li>这个设计的妙处在于：把“事件触发的入口”和“真实的处理逻辑”分开了。后面要改逻辑的时候，不用动入口，只改存的逻辑就行。</li>
</ul>
<h4 data-id="heading-4">2. 箭头函数：解决 this 乱指的坑</h4>
<p>invoker 用箭头函数定义，而不是普通函数，核心目的就是保证 this 能正确指向组件实例。</p>
<p>用过普通函数当事件回调的同学都知道，this 很容易乱指——比如绑在 DOM 上的普通函数，this 会指向触发事件的 DOM 元素，而不是我们的 Vue 组件。但箭头函数没有自己的 this，它会“继承”外层作用域的 this。</p>
<p>在 Vue 里，这个外层作用域的 this 就是组件实例。所以用箭头函数写 invoker，就能确保事件触发时，this 刚好指向我们的组件，不用再手动用 bind 绑定，也不用在业务代码里额外处理 this 问题。</p>
<p>举个反例：如果 invoker 是普通函数，点击 DOM 时 this 会指向那个 DOM 元素，这时候在回调里想访问 this.data、this.methods 都会报错，完全不符合我们的开发预期。</p>
<h4 data-id="heading-5">3. 闭包 + 动态更新：不用反复操作 DOM</h4>
<p>这是 createInvoker 最核心的优势——支持动态更新事件逻辑，还不用频繁绑解绑 DOM 事件。</p>
<p>我们知道，DOM 操作是前端性能的大瓶颈。如果每次事件回调变了，都要先 removeEventListener 解绑旧的，再 addEventListener 绑定新的，频繁操作下来性能会很差。</p>
<p>而 createInvoker 用了个巧招：因为 invoker 是闭包（内部引用了自身的 value 属性），当我们需要更新事件逻辑时，直接改 invoker.value 的指向就行，不用动 DOM 上的事件绑定。</p>
<p>比如原来 invoker.value 指向 handleClick1，现在要改成 handleClick2，直接写 invoker.value = handleClick2 就搞定了。后续事件触发时，invoker 会自动执行新的 handleClick2，全程不用碰 addEventListener 和 removeEventListener。</p>
<h3 data-id="heading-6">三、实际执行流程：从创建到更新全梳理</h3>
<ol>
<li><strong>创建调用器</strong>：Vue 解析模板里的 @click="handleClick" 时，调用 createInvoker 传入 handleClick，生成 invoker，此时 invoker.value = handleClick；</li>
<li><strong>绑定到 DOM</strong>：Vue 将 invoker 通过 addEventListener 绑定到对应的 DOM 元素上（DOM 绑定的是 invoker，而非直接绑定 handleClick）；</li>
<li><strong>事件触发执行</strong>：用户触发事件时，invoker 被执行，内部调用 invoker.value(e)，最终执行我们写的 handleClick(e)；</li>
<li><strong>动态更新逻辑</strong>：需要修改事件回调时，直接修改 invoker.value = 新回调函数即可，无需重新绑定 DOM 事件。</li>
</ol>
<h3 data-id="heading-7">四、简单实用案例：看完就能上手</h3>
<p>不用搞复杂的源码场景，这两个简单案例，帮你快速理解 createInvoker 在实际开发中的用法：</p>
<h4 data-id="heading-8">案例 1：按钮点击逻辑动态切换</h4>
<p>这是最基础的用法，模拟 Vue 里动态改事件回调的场景：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 先实现 createInvoker 函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createInvoker</span>(<span class="hljs-params">value</span>) {
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">invoker</span> = (<span class="hljs-params">e</span>) =&gt; {
    invoker.<span class="hljs-title function_">value</span>(e)
  }
  invoker.<span class="hljs-property">value</span> = value
  <span class="hljs-keyword">return</span> invoker
}

<span class="hljs-comment">// 准备两个不同的点击逻辑</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">clickLogic1</span> = (<span class="hljs-params">e</span>) =&gt; {
  <span class="hljs-title function_">alert</span>(<span class="hljs-string">'点击逻辑1：你点了按钮'</span>)
}
<span class="hljs-keyword">const</span> <span class="hljs-title function_">clickLogic2</span> = (<span class="hljs-params">e</span>) =&gt; {
  <span class="hljs-title function_">alert</span>(<span class="hljs-string">'点击逻辑2：按钮被点击啦'</span>)
}

<span class="hljs-comment">// 给按钮绑事件</span>
<span class="hljs-keyword">const</span> btn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'#myBtn'</span>)
<span class="hljs-comment">// 创建调用器，初始用逻辑1</span>
<span class="hljs-keyword">const</span> btnInvoker = <span class="hljs-title function_">createInvoker</span>(clickLogic1)
btn.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, btnInvoker)

<span class="hljs-comment">// 2秒后自动切换成逻辑2（不用解绑事件）</span>
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  btnInvoker.<span class="hljs-property">value</span> = clickLogic2
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'已切换点击逻辑，再点按钮试试'</span>)
}, <span class="hljs-number">2000</span>)
</code></pre>
<p><strong>效果</strong>：页面加载后点按钮弹“逻辑1”，2秒后点按钮弹“逻辑2”，全程只绑了一次点击事件。</p>
<h4 data-id="heading-9">案例 2：开关控制滚动监听</h4>
<p>高频事件（比如 scroll）用这个方式优化特别香，不用反复绑解绑：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createInvoker</span>(<span class="hljs-params">value</span>) {
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">invoker</span> = (<span class="hljs-params">e</span>) =&gt; {
    invoker.<span class="hljs-title function_">value</span>(e)
  }
  invoker.<span class="hljs-property">value</span> = value
  <span class="hljs-keyword">return</span> invoker
}

<span class="hljs-comment">// 滚动监听逻辑：打印滚动位置</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">scrollLogic</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'滚动位置：'</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">scrollY</span>)
}
<span class="hljs-comment">// 空逻辑：暂停监听时用</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">emptyLogic</span> = (<span class="hljs-params"/>) =&gt; {}

<span class="hljs-comment">// 创建调用器，初始监听滚动</span>
<span class="hljs-keyword">const</span> scrollInvoker = <span class="hljs-title function_">createInvoker</span>(scrollLogic)
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'scroll'</span>, scrollInvoker)

<span class="hljs-comment">// 开关按钮：点一下暂停/恢复监听</span>
<span class="hljs-keyword">const</span> toggleBtn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'#toggleScroll'</span>)
<span class="hljs-keyword">let</span> isListening = <span class="hljs-literal">true</span>
toggleBtn.<span class="hljs-property">onclick</span> = <span class="hljs-function">() =&gt;</span> {
  isListening = !isListening
  toggleBtn.<span class="hljs-property">textContent</span> = isListening ? <span class="hljs-string">'暂停滚动监听'</span> : <span class="hljs-string">'恢复滚动监听'</span>
  <span class="hljs-comment">// 只改 invoker.value 就行</span>
  scrollInvoker.<span class="hljs-property">value</span> = isListening ? scrollLogic : emptyLogic
}
</code></pre>
<p><strong>效果</strong>：默认滚动页面会打印位置，点按钮就能暂停，再点恢复，不用动 scroll 事件的绑定状态。</p>
<h3 data-id="heading-10">五、最后总结一下</h3>
<p>createInvoker 函数看着简单，但核心是三个设计巧思：利用“函数是对象”存逻辑、用箭头函数保 this、靠闭包实现动态更新。最终实现了“高效、灵活、低性能损耗”的事件处理机制，这也是 Vue 事件系统的灵魂。</p>
<p>记住三个关键点，就算真的懂了：</p>
<ul>
<li>invoker 既是事件回调入口（函数），也是逻辑存储容器（对象）；</li>
<li>更新事件逻辑，直接改 invoker.value 就行，不用碰 DOM；</li>
<li>箭头函数确保 this 指向组件实例，不用额外处理 this 问题。</li>
</ul>
<p>理解了 createInvoker 之后，再去看 Vue 源码里和事件相关的部分（比如 patchEvent），就会觉得豁然开朗。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">


六、最后总结一下

createInvoker 函数看着简单，但核心是三个设计巧思：利用“函数是对象”存逻辑、用箭头函数保 <span class="hljs-keyword">this</span>、靠闭包实现动态更新。最终实现了“高效、灵活、低性能损耗”的事件处理机制，这也是 Vue 事件系统的灵魂。

记住三个关键点，就算真的懂了：

- invoker 既是事件回调入口（函数），也是逻辑存储容器（对象）；

- 更新事件逻辑，直接改 invoker.value 就行，不用碰 DOM；

- 箭头函数确保 <span class="hljs-keyword">this</span> 指向组件实例，不用额外处理 <span class="hljs-keyword">this</span> 问题。

理解了 createInvoker 之后，再去看 Vue 源码里和事件相关的部分（比如 patchEvent），就会觉得豁然开朗。
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别全局污染：深入解析现代前端的模块化 CSS 演进之路]]></title>    <link>https://juejin.cn/post/7592865044691353606</link>    <guid>https://juejin.cn/post/7592865044691353606</guid>    <pubDate>2026-01-08T15:44:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592865044691353606" data-draft-id="7592863358258315318" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别全局污染：深入解析现代前端的模块化 CSS 演进之路"/> <meta itemprop="keywords" content="React.js,Vue.js,CSS"/> <meta itemprop="datePublished" content="2026-01-08T15:44:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="San30"/> <meta itemprop="url" content="https://juejin.cn/user/1766294768060816"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别全局污染：深入解析现代前端的模块化 CSS 演进之路
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1766294768060816/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    San30
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T15:44:07.000Z" title="Thu Jan 08 2026 15:44:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p>在前端开发的蛮荒时代，CSS（层叠样式表）就像一匹脱缰的野马。它的“层叠”特性既是强大的武器，也是无数 Bug 的根源。每个前端工程师可能都经历过这样的噩梦：当你为了修复一个按钮的样式而修改了 <code>.btn</code> 类，结果却发现隔壁页面的导航栏莫名其妙地崩了。</p>
<p>这就是<strong>全局命名空间污染</strong>。</p>
<p>随着现代前端工程化的发展，React 和 Vue 等框架的兴起，组件化成为了主流。既然 HTML 和 JavaScript 都可以封装在组件里，为什么 CSS 还要流落在外，互相打架呢？今天，我们就结合实际代码，深入探讨前端界是如何通过<strong>模块化 CSS</strong> 来彻底解决“样式冲突”这一世纪难题的。</p>
<h2 data-id="heading-0">一、 从 Bug 说起：为什么我们需要模块化？</h2>
<p>在传统的开发模式中，CSS 是没有“作用域”（Scope）概念的。所有的类名都暴露在全局环境下。</p>
<h3 data-id="heading-1">1.1 命名冲突的灾难</h3>
<p>想象一下，在一个大型多人协作的项目中。</p>
<ul>
<li><strong>开发 A</strong> 负责写一个通用的提交按钮，他给按钮起名叫 <code>.button</code>，设置了蓝底白字。</li>
<li><strong>开发 B</strong> 负责写一个侧边栏的开关按钮，他也随手起名叫 <code>.button</code>，设置了红底黑字。</li>
</ul>
<p>当这两个组件被引入到同一个页面（<code>App</code>）时，CSS 的“层叠”规则（Cascading）就会生效。谁的样式在最后加载，或者谁的优先级（Specificity）更高，谁就会赢。结果就是：要么 A 的按钮变红了，要么 B 的按钮变蓝了。</p>
<h3 data-id="heading-2">1.2 传统的妥协：BEM 命名法</h3>
<p>为了解决这个问题，以前我们发明了 BEM（Block Element Modifier）命名法，比如写成 <code>.article__button--primary</code>。这种方法虽然有效，但它本质上是靠<strong>开发者的自觉</strong>和<strong>冗长的命名</strong>来模拟作用域。这并不是真正的技术约束，而是一种君子协定。</p>
<p>我们需要更硬核的手段：<strong>让工具帮我们生成独一无二的名字</strong>。</p>
<h2 data-id="heading-3">二、 React 中的解决方案：CSS Modules</h2>
<p>React 社区对于这个问题的标准答案之一是 <strong>CSS Modules</strong>。它的核心思想非常简单粗暴：<strong>既然人取名字会重复，那就让机器来取名字。</strong></p>
<h3 data-id="heading-4">2.1 什么是 CSS Modules？</h3>
<p>在你的项目中，你可能看到过后缀为 <code>.module.css</code> 的文件。这不仅仅是一个命名约定，更是构建工具（如 Webpack 或 Vite）识别 CSS Module 的标志。</p>
<p>让我们看一个实际的例子。假设我们需要两个不同的按钮组件：<code>Button</code> 和 <code>AnotherButton</code>。</p>
<p><strong>Button.module.css:</strong></p>
<pre><code class="hljs language-CSS" lang="CSS"><span class="hljs-selector-class">.button</span> {
    <span class="hljs-attribute">background-color</span>: lightblue;
    <span class="hljs-attribute">color</span>: black;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span> <span class="hljs-number">20px</span>;
}

<span class="hljs-selector-class">.txt</span> {
    <span class="hljs-attribute">color</span>: red;
}
</code></pre>
<p><strong>AnotherButton.module.css:</strong></p>
<pre><code class="hljs language-CSS" lang="CSS"><span class="hljs-selector-class">.button</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#008c8c</span>;
    <span class="hljs-attribute">color</span>: white;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span> <span class="hljs-number">20px</span>;
}
</code></pre>
<p>请注意，这两个文件中都定义了 <code>.button</code> 类。在传统 CSS 中，这绝对会冲突。但在 CSS Modules 中，这两个 <code>.button</code> 是完全隔离的。</p>
<h3 data-id="heading-5">2.2 编译原理：哈希（Hash）魔法</h3>
<p>当我们在 React 组件中引入这些文件时，并没有直接引入 CSS 字符串，而是引入了一个<strong>对象</strong>。</p>
<p><strong>Button.jsx:</strong></p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// module.css 是 css module 的文件</span>
<span class="hljs-comment">// react 将 css 文件 编译成 js 对象</span>
<span class="hljs-keyword">import</span> styles <span class="hljs-keyword">from</span> <span class="hljs-string">'./Button.module.css'</span>;

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(styles); <span class="hljs-comment">// 让我们看看这里打印了什么</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Button</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.txt}</span>&gt;</span>你好，世界！！！<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.button}</span>&gt;</span>My Button<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;/&gt;</span></span>
    )
}
</code></pre>
<p>如果你在浏览器控制台查看 <code>console.log(styles)</code>，你会发现输出的是类似这样的对象：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript">{
  <span class="hljs-attr">button</span>: <span class="hljs-string">"Button_button__3a8f"</span>,
  <span class="hljs-attr">txt</span>: <span class="hljs-string">"Button_txt__5g9d"</span>
}
</code></pre>
<p><strong>核心机制：</strong></p>
<ol>
<li><strong>编译转换</strong>：构建工具读取 CSS 文件，将类名作为 Key。</li>
<li><strong>哈希生成</strong>：工具会根据文件名、类名和文件内容，生成一个唯一的 Hash 字符串（例如 <code>3a8f</code>），将其拼接成新的类名作为 Value。</li>
<li><strong>替换引用</strong>：在 JSX 中，我们使用 <code>{styles.button}</code>，实际上渲染到 HTML 上的是 <code>&lt;button class="Button_button__3a8f"&gt;</code>。</li>
</ol>
<h3 data-id="heading-6">2.3 真正的样式隔离</h3>
<p>现在我们再看看 <code>AnotherButton.jsx</code>：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">import</span> styles <span class="hljs-keyword">from</span> <span class="hljs-string">'./antherButton.module.css'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">AnotherButton</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 这里的 styles.button 对应的是完全不同的哈希值</span>
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.button}</span>&gt;</span>Another Button<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
}
</code></pre>
<p>在 <code>App.jsx</code> 中同时引入这两个组件：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Button</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/Button.jsx'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">AnotherButton</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/AnotherButton.jsx'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      {/* 这里的样式互不干扰，因为它们的最终类名完全不同 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">AnotherButton</span> /&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  )
}
</code></pre>
<p><strong>总结 CSS Modules 的优势：</strong></p>
<ul>
<li><strong>安全性</strong>：彻底杜绝了全局污染，每个组件的样式都是私有的。</li>
<li><strong>零冲突</strong>：多人协作时，你完全不需要担心你的类名和同事的重复。</li>
<li><strong>自动化</strong>：不需要人工维护复杂的 BEM 命名，构建工具自动处理。</li>
</ul>
<h2 data-id="heading-7">三、 Vue 中的解决方案：Scoped CSS</h2>
<p>Vue 采用了另一种更符合直觉的策略。Vue 的设计哲学是“单文件组件”（SFC），即 HTML、JS、CSS 全部写在一个 <code>.vue</code> 文件中。为了实现样式隔离，Vue 提供了 <code>scoped</code> 属性。</p>
<h3 data-id="heading-8">3.1 <code>scoped</code> 的工作原理</h3>
<p>看看这个 <code>HelloWorld.vue</code> 组件：</p>
<pre><code class="hljs language-HTML" lang="HTML"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"txt"</span>&gt;</span>你好，世界！！！<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"txt2"</span>&gt;</span>一点点<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.txt</span> {
  <span class="hljs-attribute">color</span>: pink;
}
<span class="hljs-selector-class">.txt2</span> {
  <span class="hljs-attribute">color</span>: palevioletred;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<p>当你给 <code>&lt;style&gt;</code> 标签加上 <code>scoped</code> 属性时，Vue 的编译器（通常是 <code>vue-loader</code> 或 <code>@vitejs/plugin-vue</code>）会做两件事：</p>
<ol>
<li><strong>HTML 标记</strong>：给模板中的每个 DOM 元素添加一个独一无二的自定义属性，通常以 <code>data-v-</code> 开头，例如 <code>data-v-7ba5bd90</code>。</li>
<li><strong>CSS 重写</strong>：利用 CSS 的<strong>属性选择器</strong>，将样式规则重写。</li>
</ol>
<p>编译后的 CSS 变成了这样：</p>
<pre><code class="hljs language-CSS" lang="CSS"><span class="hljs-selector-class">.txt</span><span class="hljs-selector-attr">[data-v-7ba5bd90]</span> {
  <span class="hljs-attribute">color</span>: pink;
}
<span class="hljs-selector-class">.txt2</span><span class="hljs-selector-attr">[data-v-7ba5bd90]</span> {
  <span class="hljs-attribute">color</span>: palevioletred;
}
</code></pre>
<p>编译后的 HTML 变成了这样：</p>
<pre><code class="hljs language-HTML" lang="HTML"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"txt"</span> <span class="hljs-attr">data-v-7ba5bd90</span>&gt;</span>你好，世界！！！<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
</code></pre>
<h3 data-id="heading-9">3.2 样式穿透与父子组件</h3>
<p>Vue 的 Scoped 样式有一个有趣的特性。看 <code>App.vue</code> 的例子：</p>
<pre><code class="hljs language-HTML" lang="HTML"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"txt"</span>&gt;</span>Hello world in App<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">HelloWorld</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.txt</span> {
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#008c8c</span>;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<p>这里 <code>App.vue</code> 也有一个 <code>.txt</code> 类。但是，由于 <code>App.vue</code> 会生成一个不同的 <code>data-v-hash</code> ID，它的 CSS 选择器会变成 <code>.txt[data-v-app-hash]</code>，而 <code>HelloWorld</code> 组件内部的 <code>.txt</code> 只有 <code>.txt[data-v-helloworld-hash]</code> 才能匹配。</p>
<p>这意味着：<strong>父组件的样式默认不会泄露给子组件，子组件的样式也不会影响父组件。</strong></p>
<p><strong>Vue Scoped 的优势：</strong></p>
<ul>
<li><strong>可读性好</strong>：类名在开发工具中依然保持原样（<code>.txt</code>），只是多了一个属性，调试起来比 CSS Modules 的乱码类名更友好。</li>
<li><strong>性能</strong>：只生成一次 Hash ID，利用浏览器原生的属性选择器，性能开销极低。</li>
<li><strong>开发体验</strong>：无需像 React 那样 <code>import styles</code>，直接写类名即可，符合传统 HTML/CSS 开发习惯。</li>
</ul>
<h2 data-id="heading-10">四、 进阶玩法：CSS-in-JS (Styled-Components)</h2>
<p>如果我们再激进一点呢？既然 JavaScript 统治了世界，为什么不把 CSS 也变成 JavaScript 的一部分？这就诞生了 <strong>CSS-in-JS</strong>，其中最著名的库就是 <code>styled-components</code>。</p>
<p>这种方案在 React 社区非常流行，它将“组件”和“样式”彻底融合了。</p>
<h3 data-id="heading-11">4.1 万物皆组件</h3>
<p>在提供的 <code>APP.jsx</code> (Styled-components 版本) 示例中，我们不再写 <code>.css</code> 文件，而是直接定义带样式的组件：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">import</span> styled <span class="hljs-keyword">from</span> <span class="hljs-string">'styled-components'</span>;

<span class="hljs-comment">// 创建一个名为 Button 的样式组件</span>
<span class="hljs-comment">// 这是一个包含了样式的 React 组件</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Button</span> = styled.<span class="hljs-property">button</span><span class="hljs-string">`
  background: <span class="hljs-subst">${props =&gt; props.primary ? <span class="hljs-string">'blue'</span> : <span class="hljs-string">'white'</span>}</span>;
  color: <span class="hljs-subst">${props =&gt; props.primary ? <span class="hljs-string">'white'</span> : <span class="hljs-string">'blue'</span>}</span>;
  border: 1px solid blue;
  padding: 8px 16px;
  border-radius: 4px;
`</span>;
</code></pre>
<p>注意到了吗？这里的 CSS 是写在反引号（` `）里的，这在 ES6 中叫做<strong>标签模板字符串（Tagged Template Literals）</strong> 。</p>
<h3 data-id="heading-12">4.2 动态样式的威力</h3>
<p>CSS Modules 和 Vue Scoped 虽然解决了作用域问题，但它们本质上还是静态的 CSS 文件。如果你想根据组件的状态（比如 <code>primary</code>、<code>disabled</code>、<code>active</code>）来改变样式，通常需要动态拼接类名。</p>
<p>但在 <code>styled-components</code> 中，CSS 变成了<strong>逻辑</strong>。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-attr">background</span>: ${<span class="hljs-function"><span class="hljs-params">props</span> =&gt;</span> props.<span class="hljs-property">primary</span> ? <span class="hljs-string">'blue'</span> : <span class="hljs-string">'white'</span>};
</code></pre>
<p>这行代码意味着：如果在使用组件时传递了 <code>primary</code> 属性，背景就是蓝色，否则是白色。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Button</span>&gt;</span>默认按钮<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">primary</span>&gt;</span>主要按钮<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  )
}
</code></pre>
<p>当 React 渲染这两个按钮时，<code>styled-components</code> 会动态生成两个不同的 CSS 类名，并将对应的样式注入到页面的 <code>&lt;style&gt;</code> 标签中。</p>
<p><strong>CSS-in-JS 的优势：</strong></p>
<ul>
<li><strong>动态性</strong>：样式可以像 JS 变量一样灵活，直接访问组件的 Props。</li>
<li><strong>删除无用代码</strong>：既然样式是绑定在组件上的，如果组件没被使用，样式也不会被打包。</li>
<li><strong>维护性</strong>：你永远不用去寻找“这个类名定义在哪里”，因为它就在组件的代码里。</li>
</ul>
<h2 data-id="heading-13">五、 总结：如何选择？</h2>
<p>在现代前端开发中，我们有多种武器来对抗样式冲突：</p>
<ol>
<li>
<p><strong>CSS Modules (React 推荐)</strong></p>
<ul>
<li><strong>适用场景</strong>：大型 React 项目，团队习惯传统的 CSS/SCSS 编写方式，追求极致的性能（编译时处理）。</li>
<li><strong>特点</strong>：通过 Hash 类名实现隔离，输出 JS 对象。</li>
<li><strong>关键词</strong>：<code>.module.css</code>, <code>import styles</code>, 安全, 零冲突。</li>
</ul>
</li>
<li>
<p><strong>Vue Scoped Styles (Vue 默认)</strong></p>
<ul>
<li><strong>适用场景</strong>：绝大多数 Vue 项目。</li>
<li><strong>特点</strong>：通过 <code>data-v-</code> 属性选择器实现隔离，代码更简洁，可读性更高。</li>
<li><strong>关键词</strong>：<code>&lt;style scoped&gt;</code>, 属性选择器, 简单易用。</li>
</ul>
</li>
<li>
<p><strong>CSS-in-JS (Styled-components / Emotion)</strong></p>
<ul>
<li><strong>适用场景</strong>：需要高度动态主题、复杂的交互样式，或者团队偏好“All in JS”的 React 项目。</li>
<li><strong>特点</strong>：样式即逻辑，运行时生成 CSS。</li>
<li><strong>关键词</strong>：<code>styled.div</code>, 动态 Props, 逻辑复用。</li>
</ul>
</li>
</ol>
<p>回到开头的问题：</p>
<p>不管是 CSS Modules 的哈希乱码，还是 Vue 的属性标记，或者是 Styled-components 的动态注入，它们的终极目标都是一样的——让样式为组件服务，而不是让组件去迁就样式。</p>
<p>在你的下一个项目中，请务必抛弃全局 CSS，拥抱模块化。这不仅是为了避免 Bug，更是为了写出更优雅、更健壮、更易于维护的代码。</p>
<p>希望这篇文章能帮你彻底理解前端样式的模块化演进！ Happy Coding!</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[section与article的区别与使用场景]]></title>    <link>https://juejin.cn/post/7592818272154189851</link>    <guid>https://juejin.cn/post/7592818272154189851</guid>    <pubDate>2026-01-08T15:55:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592818272154189851" data-draft-id="7592818272154124315" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="section与article的区别与使用场景"/> <meta itemprop="keywords" content="HTML"/> <meta itemprop="datePublished" content="2026-01-08T15:55:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户5141444809824"/> <meta itemprop="url" content="https://juejin.cn/user/3228624408021783"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            section与article的区别与使用场景
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3228624408021783/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户5141444809824
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T15:55:13.000Z" title="Thu Jan 08 2026 15:55:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>H5中的<code>&lt;section&gt;</code>和<code>&lt;article&gt;</code>都是用于文档结构化的语义化标签，但它们有不同的用途。下面我将详细解释它们的区别、使用场景以及如何避免混淆。</p>
<h3 data-id="heading-0">如何区分？</h3>
<p>关键问题：<strong>这段内容在脱离上下文后是否还有意义？</strong></p>
<ul>
<li>如果一段内容可以被单独拆分并在其他网站或平台上使用，那么它很可能是一个<code>&lt;article&gt;</code>。</li>
<li>如果一段内容只是文档中的一个部分，它和文档的其他部分共同组成一个整体，那么它可能是一个<code>&lt;section&gt;</code>。</li>
</ul>
<p>另外，<code>&lt;article&gt;</code>内部可以有多个<code>&lt;section&gt;</code>，而<code>&lt;section&gt;</code>内部也可以有多个<code>&lt;article&gt;</code>。这取决于你的内容结构。</p>
<h2 data-id="heading-1">代码示例</h2>
<h3 data-id="heading-2">示例1：博客文章页面</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">article</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">header</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>博客文章标题<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>发布日期：<span class="hljs-tag">&lt;<span class="hljs-name">time</span> <span class="hljs-attr">datetime</span>=<span class="hljs-string">"2023-10-01"</span>&gt;</span>2023年10月1日<span class="hljs-tag">&lt;/<span class="hljs-name">time</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">section</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>引言<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>这是文章的引言部分。<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">section</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>第一章<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>第一章的内容。<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">section</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>第二章<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>第二章的内容。<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">footer</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>文章标签：HTML，语义化<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">footer</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">article</span>&gt;</span>
</code></pre>
<h3 data-id="heading-3">示例2：新闻网站首页</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">main</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">section</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>国内新闻<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">article</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>新闻标题1<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>新闻摘要1<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">article</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">article</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>新闻标题2<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>新闻摘要2<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">article</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">section</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>国际新闻<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">article</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>新闻标题3<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>新闻摘要3<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">article</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span>
</code></pre>
<h2 data-id="heading-4">容易混淆的情况</h2>
<p>一个独立的、可重用的内容块，但不是一个完整的文章？</p>
<ul>
<li>例如：一个用户评论。虽然它可能不长，但它是一个独立的内容单元，应该用<code>&lt;article&gt;</code>。</li>
<li>注意：<code>&lt;article&gt;</code>不一定很长，只要它是独立的。</li>
</ul>
<h2 data-id="heading-5">注意</h2>
<ul>
<li>对于<code>&lt;sectio&gt;</code>,规范建议包含一个标题。但如果你不想显示标题，也可以使用隐藏标题（例如用CSS隐藏)。</li>
<li>对于<code>&lt;article&gt;</code>，虽然标题不是强制的，但最好包含一个标题（可以是隐式的，通过aria-label等属性描述）。</li>
</ul>
<h2 data-id="heading-6">总结</h2>
<p><code>&lt;article&gt;</code>是一个独立的整体，内部包含这个整体中的各个部分，如：<code>&lt;header&gt;</code>、<code>&lt;footer&gt;</code>。<code>&lt;section&gt;</code>就是这个整体中的一个部分。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2026 年 Expo + React Native 项目接入微信分享完整指南]]></title>    <link>https://juejin.cn/post/7592815497847947327</link>    <guid>https://juejin.cn/post/7592815497847947327</guid>    <pubDate>2026-01-08T11:46:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592815497847947327" data-draft-id="7592805973120876550" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2026 年 Expo + React Native 项目接入微信分享完整指南"/> <meta itemprop="keywords" content="iOS,前端,APP"/> <meta itemprop="datePublished" content="2026-01-08T11:46:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="先飞的笨鸟"/> <meta itemprop="url" content="https://juejin.cn/user/1526600409814909"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2026 年 Expo + React Native 项目接入微信分享完整指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1526600409814909/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    先飞的笨鸟
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T11:46:54.000Z" title="Thu Jan 08 2026 11:46:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">2026 年 Expo + React Native 项目接入微信分享完整指南</h2>
<blockquote>
<p>本文基于 Expo SDK 54 + React Native 0.81 + react-native-wechat-lib 1.1.27 的实战经验，详细记录了在 Expo 管理的 React Native 项目中接入微信分享功能的完整流程和踩坑记录。</p>
</blockquote>
<h3 data-id="heading-1">前言</h3>
<p>在 React Native 生态中，<code>react-native-wechat-lib</code> 是目前最常用的微信 SDK 封装库。但由于该库更新较慢，加上 Expo 的特殊性，接入过程中会遇到不少坑。本文将分享我们在生产项目中的完整接入方案。</p>
<h3 data-id="heading-2">技术栈</h3>
<ul>
<li>Expo SDK: 54.0.30</li>
<li>React Native: 0.81.5</li>
<li>react-native-wechat-lib: 1.1.27</li>
<li>构建方式: EAS Build</li>
</ul>
<h3 data-id="heading-3">整体流程</h3>
<pre><code class="hljs language-arduino" lang="arduino">准备工作 → 安装依赖 → 创建 Expo 插件 → 配置 app.config.js → 
编写 JS 服务层 → 服务器配置 → 微信开放平台配置 → 构建测试
</code></pre>
<h3 data-id="heading-4">第一步：准备工作</h3>
<h4 data-id="heading-5">1.1 微信开放平台配置</h4>
<ol>
<li>登录 <a href="https://link.juejin.cn?target=https%3A%2F%2Fopen.weixin.qq.com" target="_blank" title="https://open.weixin.qq.com" ref="nofollow noopener noreferrer">微信开放平台</a></li>
<li>创建移动应用，获取 AppID</li>
<li>配置 iOS 应用信息：
<ul>
<li>Bundle ID: <code>com.yourapp</code></li>
<li>Universal Link: <code>https://yourdomain.com/open/</code></li>
</ul>
</li>
</ol>
<h4 data-id="heading-6">1.2 Apple Developer 配置</h4>
<ol>
<li>获取 Team ID（格式如 <code>A1B2C3D4E5</code>）</li>
<li>确认 Bundle ID 与微信开放平台一致</li>
</ol>
<h3 data-id="heading-7">第二步：安装依赖</h3>
<pre><code class="hljs language-bash" lang="bash">npm install react-native-wechat-lib@1.1.27
</code></pre>
<blockquote>
<p>⚠️ 注意：在 Expo 管理的项目中，不需要手动执行 <code>pod install</code>，EAS Build 会自动处理。</p>
</blockquote>
<h3 data-id="heading-8">第三步：创建 Expo Config Plugin</h3>
<p>由于 Expo 管理原生代码，我们需要通过 Config Plugin 来配置微信 SDK 所需的原生设置。</p>
<p>创建 <code>plugins/withWechat.js</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> { withInfoPlist, withAndroidManifest } = <span class="hljs-built_in">require</span>(<span class="hljs-string">"expo/config-plugins"</span>);

<span class="hljs-comment">/**
 * 微信 SDK Expo Config Plugin
 * 自动配置 iOS 和 Android 的微信相关设置
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">withWechat</span>(<span class="hljs-params">config, { appId, universalLink }</span>) {
  <span class="hljs-keyword">if</span> (!appId) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"withWechat: appId is required"</span>);
  }

  <span class="hljs-comment">// iOS 配置</span>
  config = <span class="hljs-title function_">withInfoPlist</span>(config, <span class="hljs-function">(<span class="hljs-params">config</span>) =&gt;</span> {
    <span class="hljs-comment">// 添加微信 URL Scheme</span>
    <span class="hljs-keyword">const</span> urlTypes = config.<span class="hljs-property">modResults</span>.<span class="hljs-property">CFBundleURLTypes</span> || [];
    <span class="hljs-keyword">const</span> wechatScheme = {
      <span class="hljs-title class_">CFBundleURLSchemes</span>: [appId],
      <span class="hljs-title class_">CFBundleURLName</span>: <span class="hljs-string">"wechat"</span>,
    };

    <span class="hljs-keyword">const</span> hasWechatScheme = urlTypes.<span class="hljs-title function_">some</span>(
      <span class="hljs-function">(<span class="hljs-params">type</span>) =&gt;</span>
        type.<span class="hljs-property">CFBundleURLSchemes</span> &amp;&amp;
        type.<span class="hljs-property">CFBundleURLSchemes</span>.<span class="hljs-title function_">includes</span>(appId)
    );

    <span class="hljs-keyword">if</span> (!hasWechatScheme) {
      urlTypes.<span class="hljs-title function_">push</span>(wechatScheme);
    }
    config.<span class="hljs-property">modResults</span>.<span class="hljs-property">CFBundleURLTypes</span> = urlTypes;

    <span class="hljs-comment">// 添加 LSApplicationQueriesSchemes</span>
    <span class="hljs-keyword">const</span> queriesSchemes = config.<span class="hljs-property">modResults</span>.<span class="hljs-property">LSApplicationQueriesSchemes</span> || [];
    <span class="hljs-keyword">const</span> wechatSchemes = [<span class="hljs-string">"weixin"</span>, <span class="hljs-string">"weixinULAPI"</span>];
    wechatSchemes.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">scheme</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (!queriesSchemes.<span class="hljs-title function_">includes</span>(scheme)) {
        queriesSchemes.<span class="hljs-title function_">push</span>(scheme);
      }
    });
    config.<span class="hljs-property">modResults</span>.<span class="hljs-property">LSApplicationQueriesSchemes</span> = queriesSchemes;

    <span class="hljs-keyword">return</span> config;
  });

  <span class="hljs-comment">// Android 配置</span>
  config = <span class="hljs-title function_">withAndroidManifest</span>(config, <span class="hljs-function">(<span class="hljs-params">config</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> mainApplication = config.<span class="hljs-property">modResults</span>.<span class="hljs-property">manifest</span>.<span class="hljs-property">application</span>?.[<span class="hljs-number">0</span>];
    <span class="hljs-keyword">if</span> (!mainApplication) <span class="hljs-keyword">return</span> config;

    <span class="hljs-keyword">const</span> packageName = config.<span class="hljs-property">android</span>?.<span class="hljs-property">package</span> || <span class="hljs-string">"com.yourapp"</span>;
    <span class="hljs-keyword">const</span> activities = mainApplication.<span class="hljs-property">activity</span> || [];
    <span class="hljs-keyword">const</span> wxActivityName = <span class="hljs-string">`<span class="hljs-subst">${packageName}</span>.wxapi.WXEntryActivity`</span>;

    <span class="hljs-keyword">const</span> hasWxActivity = activities.<span class="hljs-title function_">some</span>(
      <span class="hljs-function">(<span class="hljs-params">activity</span>) =&gt;</span> activity.<span class="hljs-property">$</span>?.[<span class="hljs-string">"android:name"</span>] === wxActivityName
    );

    <span class="hljs-keyword">if</span> (!hasWxActivity) {
      activities.<span class="hljs-title function_">push</span>({
        <span class="hljs-attr">$</span>: {
          <span class="hljs-string">"android:name"</span>: wxActivityName,
          <span class="hljs-string">"android:exported"</span>: <span class="hljs-string">"true"</span>,
          <span class="hljs-string">"android:launchMode"</span>: <span class="hljs-string">"singleTask"</span>,
          <span class="hljs-string">"android:taskAffinity"</span>: packageName,
          <span class="hljs-string">"android:theme"</span>: <span class="hljs-string">"@android:style/Theme.Translucent.NoTitleBar"</span>,
        },
      });
    }

    mainApplication.<span class="hljs-property">activity</span> = activities;
    <span class="hljs-keyword">return</span> config;
  });

  <span class="hljs-keyword">return</span> config;
}

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = withWechat;
</code></pre>
<h3 data-id="heading-9">第四步：配置 app.config.js</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">expo</span>: {
    <span class="hljs-attr">name</span>: <span class="hljs-string">"你的应用名"</span>,
    <span class="hljs-attr">slug</span>: <span class="hljs-string">"your-app"</span>,
    <span class="hljs-attr">version</span>: <span class="hljs-string">"1.0.0"</span>,
    
    <span class="hljs-attr">extra</span>: {
      <span class="hljs-attr">wechatAppId</span>: <span class="hljs-string">"wx你的AppID"</span>, <span class="hljs-comment">// 微信 AppID</span>
    },
    
    <span class="hljs-attr">ios</span>: {
      <span class="hljs-attr">bundleIdentifier</span>: <span class="hljs-string">"com.yourapp"</span>,
      <span class="hljs-attr">associatedDomains</span>: [
        <span class="hljs-string">"applinks:yourdomain.com"</span>,
        <span class="hljs-string">"webcredentials:yourdomain.com"</span>,
      ],
      <span class="hljs-attr">infoPlist</span>: {
        <span class="hljs-title class_">LSApplicationQueriesSchemes</span>: [<span class="hljs-string">"weixin"</span>, <span class="hljs-string">"weixinULAPI"</span>, <span class="hljs-string">"wechat"</span>],
      },
    },
    
    <span class="hljs-attr">android</span>: {
      <span class="hljs-attr">package</span>: <span class="hljs-string">"com.yourapp"</span>,
    },
    
    <span class="hljs-attr">plugins</span>: [
      [
        <span class="hljs-string">"./plugins/withWechat"</span>,
        {
          <span class="hljs-attr">appId</span>: <span class="hljs-string">"wx你的AppID"</span>,
          <span class="hljs-attr">universalLink</span>: <span class="hljs-string">"https://yourdomain.com/open/"</span>,
        },
      ],
    ],
  },
};
</code></pre>
<h3 data-id="heading-10">第五步：编写微信服务层</h3>
<p>创建 <code>src/services/wechatService.ts</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Platform</span>, <span class="hljs-title class_">Alert</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-native"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Constants</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"expo-constants"</span>;

<span class="hljs-comment">// 从 Expo 配置中获取微信 AppID</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">WECHAT_APP_ID</span> = <span class="hljs-title class_">Constants</span>.<span class="hljs-property">expoConfig</span>?.<span class="hljs-property">extra</span>?.<span class="hljs-property">wechatAppId</span> || <span class="hljs-string">""</span>;

<span class="hljs-comment">// 动态加载微信 SDK</span>
<span class="hljs-keyword">let</span> <span class="hljs-title class_">WeChat</span>: <span class="hljs-built_in">any</span> = <span class="hljs-literal">null</span>;
<span class="hljs-keyword">let</span> sdkLoadAttempted = <span class="hljs-literal">false</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">getWechatSDK</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (sdkLoadAttempted) <span class="hljs-keyword">return</span> <span class="hljs-title class_">WeChat</span>;
  sdkLoadAttempted = <span class="hljs-literal">true</span>;
  
  <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Platform</span>.<span class="hljs-property">OS</span> === <span class="hljs-string">"web"</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  }
  
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">"react-native-wechat-lib"</span>);
    <span class="hljs-title class_">WeChat</span> = <span class="hljs-variable language_">module</span>.<span class="hljs-property">default</span> || <span class="hljs-variable language_">module</span>;
    
    <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">WeChat</span> || <span class="hljs-keyword">typeof</span> <span class="hljs-title class_">WeChat</span>.<span class="hljs-property">registerApp</span> !== <span class="hljs-string">"function"</span>) {
      <span class="hljs-title class_">WeChat</span> = <span class="hljs-literal">null</span>;
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">WeChat</span>;
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">"微信 SDK 加载失败:"</span>, error);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  }
};

<span class="hljs-keyword">class</span> <span class="hljs-title class_">WechatService</span> {
  <span class="hljs-keyword">private</span> isRegistered = <span class="hljs-literal">false</span>;

  <span class="hljs-comment">// 检查 SDK 是否可用</span>
  <span class="hljs-title function_">isAvailable</span>(): <span class="hljs-built_in">boolean</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Platform</span>.<span class="hljs-property">OS</span> === <span class="hljs-string">"web"</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">const</span> sdk = <span class="hljs-title function_">getWechatSDK</span>();
    <span class="hljs-keyword">return</span> sdk !== <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-keyword">typeof</span> sdk.<span class="hljs-property">registerApp</span> === <span class="hljs-string">"function"</span>;
  }

  <span class="hljs-comment">// 注册微信 SDK</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">register</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">boolean</span>&gt; {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isRegistered</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    
    <span class="hljs-keyword">const</span> sdk = <span class="hljs-title function_">getWechatSDK</span>();
    <span class="hljs-keyword">if</span> (!sdk) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> sdk.<span class="hljs-title function_">registerApp</span>(<span class="hljs-variable constant_">WECHAT_APP_ID</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">isRegistered</span> = result;
      <span class="hljs-keyword">return</span> result;
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"微信 SDK 注册失败:"</span>, error);
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
  }

  <span class="hljs-comment">// 检查微信是否已安装</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">isWechatInstalled</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">boolean</span>&gt; {
    <span class="hljs-keyword">const</span> sdk = <span class="hljs-title function_">getWechatSDK</span>();
    <span class="hljs-keyword">if</span> (!sdk) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> sdk.<span class="hljs-title function_">isWXAppInstalled</span>();
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
  }

  <span class="hljs-comment">// 分享网页到微信</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">shareWebpage</span>(<span class="hljs-attr">params</span>: {
    <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">description</span>: <span class="hljs-built_in">string</span>;
    thumbImageUrl?: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">webpageUrl</span>: <span class="hljs-built_in">string</span>;
    scene?: <span class="hljs-string">"session"</span> | <span class="hljs-string">"timeline"</span> | <span class="hljs-string">"favorite"</span>;
  }): <span class="hljs-title class_">Promise</span>&lt;{ <span class="hljs-attr">success</span>: <span class="hljs-built_in">boolean</span>; <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> }&gt; {
    
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isAvailable</span>()) {
      <span class="hljs-keyword">return</span> { 
        <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>, 
        <span class="hljs-attr">message</span>: <span class="hljs-title class_">Platform</span>.<span class="hljs-property">OS</span> === <span class="hljs-string">"web"</span> 
          ? <span class="hljs-string">"Web 端暂不支持微信分享"</span> 
          : <span class="hljs-string">"微信分享功能需要在正式构建版本中使用"</span>
      };
    }

    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> registered = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">register</span>();
      <span class="hljs-keyword">if</span> (!registered) {
        <span class="hljs-keyword">return</span> { <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">"微信 SDK 初始化失败"</span> };
      }

      <span class="hljs-keyword">const</span> isInstalled = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isWechatInstalled</span>();
      <span class="hljs-keyword">if</span> (!isInstalled) {
        <span class="hljs-keyword">return</span> { <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">"请先安装微信"</span> };
      }

      <span class="hljs-keyword">const</span> sceneMap = {
        <span class="hljs-attr">session</span>: <span class="hljs-number">0</span>,   <span class="hljs-comment">// 聊天界面</span>
        <span class="hljs-attr">timeline</span>: <span class="hljs-number">1</span>,  <span class="hljs-comment">// 朋友圈</span>
        <span class="hljs-attr">favorite</span>: <span class="hljs-number">2</span>,  <span class="hljs-comment">// 收藏</span>
      };

      <span class="hljs-keyword">const</span> sdk = <span class="hljs-title function_">getWechatSDK</span>();
      <span class="hljs-keyword">await</span> sdk.<span class="hljs-title function_">shareWebpage</span>({
        <span class="hljs-attr">title</span>: params.<span class="hljs-property">title</span>,
        <span class="hljs-attr">description</span>: params.<span class="hljs-property">description</span>,
        <span class="hljs-attr">thumbImageUrl</span>: params.<span class="hljs-property">thumbImageUrl</span> || <span class="hljs-string">""</span>,
        <span class="hljs-attr">webpageUrl</span>: params.<span class="hljs-property">webpageUrl</span>,
        <span class="hljs-attr">scene</span>: sceneMap[params.<span class="hljs-property">scene</span> || <span class="hljs-string">"session"</span>],
      });

      <span class="hljs-keyword">return</span> { <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">"分享成功"</span> };
    } <span class="hljs-keyword">catch</span> (<span class="hljs-attr">error</span>: <span class="hljs-built_in">any</span>) {
      <span class="hljs-keyword">if</span> (error?.<span class="hljs-property">errCode</span> === -<span class="hljs-number">2</span>) {
        <span class="hljs-keyword">return</span> { <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">"已取消分享"</span> };
      }
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">message</span>: error?.<span class="hljs-property">message</span> || <span class="hljs-string">"分享失败"</span> };
    }
  }

  <span class="hljs-comment">// 分享图片到微信</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">shareImage</span>(<span class="hljs-attr">params</span>: {
    imageUrl?: <span class="hljs-built_in">string</span>;
    imageBase64?: <span class="hljs-built_in">string</span>;
    scene?: <span class="hljs-string">"session"</span> | <span class="hljs-string">"timeline"</span> | <span class="hljs-string">"favorite"</span>;
  }): <span class="hljs-title class_">Promise</span>&lt;{ <span class="hljs-attr">success</span>: <span class="hljs-built_in">boolean</span>; <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> }&gt; {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isAvailable</span>()) {
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">"微信分享不可用"</span> };
    }

    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">register</span>();
      
      <span class="hljs-keyword">const</span> isInstalled = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isWechatInstalled</span>();
      <span class="hljs-keyword">if</span> (!isInstalled) {
        <span class="hljs-keyword">return</span> { <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">"请先安装微信"</span> };
      }

      <span class="hljs-keyword">const</span> sceneMap = { <span class="hljs-attr">session</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">timeline</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">favorite</span>: <span class="hljs-number">2</span> };
      <span class="hljs-keyword">const</span> sdk = <span class="hljs-title function_">getWechatSDK</span>();
      
      <span class="hljs-keyword">await</span> sdk.<span class="hljs-title function_">shareImage</span>({
        <span class="hljs-attr">imageUrl</span>: params.<span class="hljs-property">imageBase64</span> || params.<span class="hljs-property">imageUrl</span>,
        <span class="hljs-attr">scene</span>: sceneMap[params.<span class="hljs-property">scene</span> || <span class="hljs-string">"session"</span>],
      });

      <span class="hljs-keyword">return</span> { <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">"分享成功"</span> };
    } <span class="hljs-keyword">catch</span> (<span class="hljs-attr">error</span>: <span class="hljs-built_in">any</span>) {
      <span class="hljs-keyword">if</span> (error?.<span class="hljs-property">errCode</span> === -<span class="hljs-number">2</span>) {
        <span class="hljs-keyword">return</span> { <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">"已取消分享"</span> };
      }
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">"分享失败"</span> };
    }
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> wechatService = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WechatService</span>();
</code></pre>
<h3 data-id="heading-11">第六步：服务器配置 (Universal Link)</h3>
<p>在你的服务器上创建 <code>apple-app-site-association</code> 文件。</p>
<h4 data-id="heading-12">文件路径</h4>
<pre><code class="hljs language-arduino" lang="arduino">https:<span class="hljs-comment">//yourdomain.com/.well-known/apple-app-site-association</span>
</code></pre>
<h4 data-id="heading-13">文件内容</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"applinks"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"apps"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"details"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"appIDs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"TEAMID.com.yourapp"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"components"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
          <span class="hljs-punctuation">{</span> <span class="hljs-attr">"/"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/open/*"</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
          <span class="hljs-punctuation">{</span> <span class="hljs-attr">"/"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/topic/*"</span> <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"webcredentials"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"apps"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"TEAMID.com.yourapp"</span><span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<blockquote>
<p>⚠️ 将 <code>TEAMID</code> 替换为你的 Apple Team ID，<code>com.yourapp</code> 替换为你的 Bundle ID。</p>
</blockquote>
<h4 data-id="heading-14">服务器配置要求</h4>
<ol>
<li>必须通过 HTTPS 访问</li>
<li>Content-Type 应为 <code>application/json</code></li>
<li>文件名不能有 <code>.json</code> 后缀</li>
<li>不能有重定向</li>
</ol>
<h4 data-id="heading-15">Nginx 配置示例</h4>
<pre><code class="hljs language-nginx" lang="nginx">location /.well-known/apple-app-site-association {
    default_type application/json;
}
</code></pre>
<h3 data-id="heading-16">第七步：在组件中使用</h3>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Button</span>, <span class="hljs-title class_">Alert</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-native"</span>;
<span class="hljs-keyword">import</span> { wechatService } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/services/wechatService"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ShareButton</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleShare</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> wechatService.<span class="hljs-title function_">shareWebpage</span>({
      <span class="hljs-attr">title</span>: <span class="hljs-string">"分享标题"</span>,
      <span class="hljs-attr">description</span>: <span class="hljs-string">"分享描述"</span>,
      <span class="hljs-attr">thumbImageUrl</span>: <span class="hljs-string">"https://example.com/thumb.jpg"</span>,
      <span class="hljs-attr">webpageUrl</span>: <span class="hljs-string">"https://example.com/share-page"</span>,
      <span class="hljs-attr">scene</span>: <span class="hljs-string">"session"</span>, <span class="hljs-comment">// 或 "timeline" 分享到朋友圈</span>
    });

    <span class="hljs-keyword">if</span> (result.<span class="hljs-property">success</span>) {
      <span class="hljs-title class_">Alert</span>.<span class="hljs-title function_">alert</span>(<span class="hljs-string">"成功"</span>, <span class="hljs-string">"分享成功"</span>);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-title class_">Alert</span>.<span class="hljs-title function_">alert</span>(<span class="hljs-string">"提示"</span>, result.<span class="hljs-property">message</span>);
    }
  };

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"分享到微信"</span> <span class="hljs-attr">onPress</span>=<span class="hljs-string">{handleShare}</span> /&gt;</span></span>;
}
</code></pre>
<h3 data-id="heading-17">第八步：构建和测试</h3>
<h4 data-id="heading-18">使用 EAS Build</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 构建 iOS 生产版本</span>
eas build -p ios --profile production

<span class="hljs-comment"># 构建并自动提交到 TestFlight</span>
eas build -p ios --profile production --auto-submit
</code></pre>
<h4 data-id="heading-19">测试注意事项</h4>
<ol>
<li><strong>Expo Go 不支持</strong>：微信 SDK 是原生模块，必须使用 EAS Build 构建的版本测试</li>
<li><strong>重启手机</strong>：安装新版本后建议重启手机，让 iOS 刷新 Associated Domains 缓存</li>
<li><strong>验证 Universal Link</strong>：访问 <code>https://app-site-association.cdn-apple.com/a/v1/yourdomain.com</code> 确认 Apple 已缓存配置</li>
</ol>
<h3 data-id="heading-20">常见问题排查</h3>
<h4 data-id="heading-21">问题 1：分享时微信没有被唤起</h4>
<p><strong>可能原因：</strong></p>
<ul>
<li>Universal Link 配置不一致（微信开放平台、App 代码、服务器三端必须完全一致）</li>
<li><code>apple-app-site-association</code> 文件内容错误或无法访问</li>
<li>Apple 还未缓存你的配置</li>
</ul>
<p><strong>排查步骤：</strong></p>
<ol>
<li>确认三端域名完全一致（注意 www 和非 www 的区别）</li>
<li>直接访问 <code>https://yourdomain.com/.well-known/apple-app-site-association</code> 确认可以下载</li>
<li>检查 Apple CDN 缓存：<code>https://app-site-association.cdn-apple.com/a/v1/yourdomain.com</code></li>
</ol>
<h4 data-id="heading-22">问题 2：SDK 注册失败</h4>
<p><strong>可能原因：</strong></p>
<ul>
<li>AppID 配置错误</li>
<li>在 Expo Go 中运行（不支持）</li>
</ul>
<p><strong>解决方案：</strong></p>
<ul>
<li>确认 <code>app.config.js</code> 中的 AppID 与微信开放平台一致</li>
<li>使用 EAS Build 构建的版本测试</li>
</ul>
<h4 data-id="heading-23">问题 3：提示"请先安装微信"</h4>
<p><strong>可能原因：</strong></p>
<ul>
<li><code>LSApplicationQueriesSchemes</code> 未正确配置</li>
</ul>
<p><strong>解决方案：</strong>
确认 <code>app.config.js</code> 中包含：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">infoPlist</span>: {
  <span class="hljs-title class_">LSApplicationQueriesSchemes</span>: [<span class="hljs-string">"weixin"</span>, <span class="hljs-string">"weixinULAPI"</span>, <span class="hljs-string">"wechat"</span>],
}
</code></pre>
<h3 data-id="heading-24">调试技巧</h3>
<p>在开发阶段，可以添加调试弹窗来追踪问题：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DEBUG_MODE</span> = <span class="hljs-literal">true</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">debugAlert</span> = (<span class="hljs-params">title: <span class="hljs-built_in">string</span>, message: <span class="hljs-built_in">string</span></span>) =&gt; {
  <span class="hljs-keyword">if</span> (<span class="hljs-variable constant_">DEBUG_MODE</span>) {
    <span class="hljs-title class_">Alert</span>.<span class="hljs-title function_">alert</span>(<span class="hljs-string">`[调试] <span class="hljs-subst">${title}</span>`</span>, message);
  }
};

<span class="hljs-comment">// 在关键步骤添加调试</span>
<span class="hljs-title function_">debugAlert</span>(<span class="hljs-string">"开始分享"</span>, <span class="hljs-string">`AppID: <span class="hljs-subst">${WECHAT_APP_ID}</span>`</span>);
<span class="hljs-title function_">debugAlert</span>(<span class="hljs-string">"注册结果"</span>, <span class="hljs-string">`registered: <span class="hljs-subst">${registered}</span>`</span>);
<span class="hljs-title function_">debugAlert</span>(<span class="hljs-string">"微信安装检查"</span>, <span class="hljs-string">`isInstalled: <span class="hljs-subst">${isInstalled}</span>`</span>);
</code></pre>
<h3 data-id="heading-25">总结</h3>
<p>在 Expo 项目中接入微信分享的关键点：</p>
<ol>
<li><strong>使用 Config Plugin</strong> 配置原生设置，而不是手动修改原生代码</li>
<li><strong>三端配置一致</strong> 是成功的关键（微信开放平台、App、服务器）</li>
<li><strong>Universal Link</strong> 配置正确且可访问</li>
<li><strong>必须使用 EAS Build</strong> 构建的版本测试，Expo Go 不支持原生模块</li>
</ol>
<p>希望这篇文章能帮助你顺利接入微信分享功能！如有问题欢迎评论区交流。</p>
<hr/>
<p><strong>参考资料：</strong></p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flittle-snow-fox%2Freact-native-wechat-lib" target="_blank" title="https://github.com/little-snow-fox/react-native-wechat-lib" ref="nofollow noopener noreferrer">react-native-wechat-lib GitHub</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.weixin.qq.com%2Fdoc%2Foplatform%2FMobile_App%2FResource_Center_Homepage.html" target="_blank" title="https://developers.weixin.qq.com/doc/oplatform/Mobile_App/Resource_Center_Homepage.html" ref="nofollow noopener noreferrer">微信开放平台文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.apple.com%2Fdocumentation%2Fxcode%2Fsupporting-associated-domains" target="_blank" title="https://developer.apple.com/documentation/xcode/supporting-associated-domains" ref="nofollow noopener noreferrer">Apple Associated Domains 文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.expo.dev%2Fconfig-plugins%2Fintroduction%2F" target="_blank" title="https://docs.expo.dev/config-plugins/introduction/" ref="nofollow noopener noreferrer">Expo Config Plugins</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI可编辑架构图！这个 8.2k stars 的项目如何把 30 分钟的绘图工作压缩到 30 秒]]></title>    <link>https://juejin.cn/post/7592818202717110291</link>    <guid>https://juejin.cn/post/7592818202717110291</guid>    <pubDate>2026-01-08T10:51:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592818202717110291" data-draft-id="7592815497847865407" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI可编辑架构图！这个 8.2k stars 的项目如何把 30 分钟的绘图工作压缩到 30 秒"/> <meta itemprop="keywords" content="设计"/> <meta itemprop="datePublished" content="2026-01-08T10:51:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户795197273085"/> <meta itemprop="url" content="https://juejin.cn/user/362176489207546"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI可编辑架构图！这个 8.2k stars 的项目如何把 30 分钟的绘图工作压缩到 30 秒
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/362176489207546/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户795197273085
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T10:51:48.000Z" title="Thu Jan 08 2026 10:51:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">AI可编辑架构图！这个 8.2k stars 的项目如何把 30 分钟的绘图工作压缩到 30 秒</h2>
<p><img src="https://fastly.jsdelivr.net/gh/bucketio/img15@main/2026/01/08/1767866249731-eb1b9acb-080a-4984-9842-4c72f1413928.png" alt="" loading="lazy"/></p>
<h3 data-id="heading-1">从 XML 生成到流式渲染</h3>
<p>draw.io 是技术架构设计中的标配工具。但问题在于,每次画一个完整的云架构图需要花费 30 分钟以上,而其中 80% 的时间用于拖拽组件和调整布局。这种重复劳动正在成为技术团队的效率瓶颈。
Next AI Draw.io 的作者 DayuanJiang 提出了一个截然不同的解决路径:既然 draw.io 的底层是 XML,为什么不让 LLM 直接生成这些 XML?这个项目在 GitHub 上获得了 8.2k stars,背后的原因很简单——它真的能用。</p>
<p>项目地址: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FDayuanJiang%2Fnext-ai-draw-io" target="_blank" title="https://github.com/DayuanJiang/next-ai-draw-io" ref="nofollow noopener noreferrer">github.com/DayuanJiang…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fnext-ai-drawio.jiang.jp%2F" target="_blank" title="https://next-ai-drawio.jiang.jp/" ref="nofollow noopener noreferrer">在线体验</a></p>
<p><img src="https://fastly.jsdelivr.net/gh/bucketio/img0@main/2026/01/08/1767866325734-29f47068-ec0a-4488-9206-e38acb79dac8.png" alt="" loading="lazy"/></p>
<h4 data-id="heading-2">技术架构拆解:三层抽象的精妙设计</h4>
<ol>
<li><strong>前端层:Next.js + React DrawIO</strong></li>
</ol>
<p>项目基于 Next.js 14+ App Router 构建,前端使用 react-drawio 库嵌入 draw.io 编辑器。这个设计的关键在于状态管理:</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">DiagramContext</span> = <span class="hljs-title function_">createContext</span>({
  <span class="hljs-attr">xml</span>: <span class="hljs-literal">null</span>,
  <span class="hljs-attr">updateXML</span>: <span class="hljs-function">(<span class="hljs-params">newXML: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>,
  <span class="hljs-attr">history</span>: [],
  <span class="hljs-attr">rollback</span>: <span class="hljs-function">(<span class="hljs-params">version: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>
})
</code></pre>
<p>前端并不直接操作 Canvas API,而是通过修改 XML 字符串来驱动视图更新。这种架构使得 AI 生成的内容可以无缝接入。</p>
<hr/>
<ol start="2">
<li><strong>AI 层:Vercel AI SDK 的流式响应</strong></li>
</ol>
<p>核心在于 <code>/api/chat/route.ts</code>,这里使用 Vercel AI SDK 的 streamText 函数处理 LLM 调用:</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">streamText</span>({
  <span class="hljs-attr">model</span>: <span class="hljs-title function_">anthropic</span>(<span class="hljs-string">'claude-sonnet-4-20250514'</span>),
  <span class="hljs-attr">messages</span>: <span class="hljs-title function_">convertToModelMessages</span>(messages),
  <span class="hljs-attr">tools</span>: {
    <span class="hljs-attr">updateDiagram</span>: <span class="hljs-title function_">tool</span>({
      <span class="hljs-attr">description</span>: <span class="hljs-string">'Generate or modify draw.io XML'</span>,
      <span class="hljs-attr">parameters</span>: z.<span class="hljs-title function_">object</span>({
        <span class="hljs-attr">xml</span>: z.<span class="hljs-title function_">string</span>(),
        <span class="hljs-attr">action</span>: z.<span class="hljs-title function_">enum</span>([<span class="hljs-string">'create'</span>, <span class="hljs-string">'modify'</span>])
      }),
      <span class="hljs-attr">execute</span>: <span class="hljs-keyword">async</span> ({ xml, action }) =&gt; {
        <span class="hljs-keyword">return</span> { <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>, xml }
      }
    })
  }
})
</code></pre>
<p>这里有两个技术要点:</p>
<ul>
<li><code>Tool Calling</code> 机制: LLM 并不直接返回 XML,而是调用 updateDiagram 工具,这样可以在执行前进行格式校验</li>
<li>流式传输: <code>streamText</code> 返回的 <code>Response</code> 可以直接作为 Server-Sent Events 推送给客户端,实现打字机效果</li>
</ul>
<hr/>
<ol start="3">
<li><strong>数据层:XML 序列化与版本控制</strong></li>
</ol>
<p>每次用户提交 prompt,系统会:</p>
<ol>
<li>将当前 XML 状态序列化存入 history 数组</li>
<li>调用 LLM 生成新的 XML</li>
<li>对比新旧 XML 的 diff,只更新变化的节点</li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">applyXMLDiff</span>(<span class="hljs-params">oldXML: <span class="hljs-built_in">string</span>, newXML: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-keyword">const</span> parser = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DOMParser</span>()
  <span class="hljs-keyword">const</span> oldDoc = parser.<span class="hljs-title function_">parseFromString</span>(oldXML, <span class="hljs-string">'text/xml'</span>)
  <span class="hljs-keyword">const</span> newDoc = parser.<span class="hljs-title function_">parseFromString</span>(newXML, <span class="hljs-string">'text/xml'</span>)
  
  <span class="hljs-keyword">const</span> changedNodes = []
  <span class="hljs-title function_">traverseNodes</span>(oldDoc, newDoc, <span class="hljs-function">(<span class="hljs-params">old, <span class="hljs-keyword">new</span></span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (old.<span class="hljs-property">outerHTML</span> !== <span class="hljs-keyword">new</span>.<span class="hljs-property">outerHTML</span>) {
      changedNodes.<span class="hljs-title function_">push</span>(<span class="hljs-keyword">new</span>)
    }
  })
  <span class="hljs-keyword">return</span> changedNodes
}
</code></pre>
<p>这种增量更新策略避免了整个画布闪烁重绘,使得 1000+ 节点的大型架构图也能流畅编辑。</p>
<hr/>
<h4 data-id="heading-3">Claude Sonnet 4 为什么是最佳选择?</h4>
<p>OpenCode 提供两个专业化智能体,按 Tab 键即可切换:</p>
<p>作者明确推荐 Claude Sonnet 4.5,背后有硬数据支撑。我用不同模型测试了生成一个标准 AWS 三层架构图的表现:</p>
<blockquote>
<p>模型在生成 AWS 架构图时的表现差异显著。Claude Sonnet 4.5 的成功率达到 92%,而 GPT-4o 仅为 67%。原因在于:
Claude 系列模型在训练数据中包含了大量 <code>draw.io XML</code> 样本,尤其是云厂商的官方图标库(AWS、GCP、Azure 的 stencil 定义)。这意味着当你输入"给我画一个带 ELB 和 Auto Scaling Group 的架构图"时,Claude 能准确生成包含正确 <code>image</code> 标签和 <code>aspect</code> 属性的 XML:</p>
</blockquote>
<pre><code class="hljs language-XML" lang="XML"><span class="hljs-tag">&lt;<span class="hljs-name">mxCell</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"elb-1"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"ELB"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"sketch=0;outlineConnect=0;
fontColor=#232F3E;gradientColor=#945DF2;gradientDirection=north;
fillColor=#5A30B5;strokeColor=#ffffff;dashed=0;verticalLabelPosition=bottom;
verticalAlign=top;align=center;html=1;fontSize=12;fontStyle=0;
aspect=fixed;shape=mxgraph.aws4.resourceIcon;
resIcon=mxgraph.aws4.elastic_load_balancing;"</span> 
<span class="hljs-attr">vertex</span>=<span class="hljs-string">"1"</span> <span class="hljs-attr">parent</span>=<span class="hljs-string">"1"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">mxGeometry</span> <span class="hljs-attr">x</span>=<span class="hljs-string">"320"</span> <span class="hljs-attr">y</span>=<span class="hljs-string">"180"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"78"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"78"</span> <span class="hljs-attr">as</span>=<span class="hljs-string">"geometry"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">mxCell</span>&gt;</span>
</code></pre>
<p>这些细节决定了生成的图表是否专业。GPT 系列模型倾向于生成通用的矩形框,需要手动替换成云厂商图标。</p>
<hr/>
<h3 data-id="heading-4">多模态输入:图片到架构图的逆向工程</h3>
<p>项目支持上传已有架构图的截图,让 AI 识别并复现。这个功能的实现涉及视觉理解和结构推理两个环节:</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">replicateDiagram</span>(<span class="hljs-params">imageBase64: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-keyword">const</span> analysisResult = <span class="hljs-keyword">await</span> <span class="hljs-title function_">generateText</span>({
    <span class="hljs-attr">model</span>: <span class="hljs-title function_">anthropic</span>(<span class="hljs-string">'claude-sonnet-4-20250514'</span>),
    <span class="hljs-attr">messages</span>: [{
      <span class="hljs-attr">role</span>: <span class="hljs-string">'user'</span>,
      <span class="hljs-attr">content</span>: [
        { <span class="hljs-attr">type</span>: <span class="hljs-string">'image'</span>, <span class="hljs-attr">image</span>: imageBase64 },
        { <span class="hljs-attr">type</span>: <span class="hljs-string">'text'</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">'Analyze this diagram and extract its structure'</span> }
      ]
    }]
  })
  
  <span class="hljs-keyword">const</span> structure = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(analysisResult.<span class="hljs-property">text</span>)
  
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-title function_">generateText</span>({
    <span class="hljs-attr">model</span>: <span class="hljs-title function_">anthropic</span>(<span class="hljs-string">'claude-sonnet-4-20250514'</span>),
    <span class="hljs-attr">prompt</span>: <span class="hljs-string">`Generate draw.io XML for: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(structure)}</span>`</span>
  })
}
</code></pre>
<p>实测发现,Claude 在识别流程图的准确率约为 85%,但对于手绘草图的理解能力有限(约 60%)。这是因为训练数据主要是规范的数字图表,而非自由绘制的内容。</p>
<h4 data-id="heading-5">SVG 路径的参数化控制</h4>
<p>项目支持生成动态连接线,这是通过在 XML 中嵌入 CSS 动画实现的:</p>
<pre><code class="hljs language-XML" lang="XML"><span class="hljs-tag">&lt;<span class="hljs-name">mxCell</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"edge-1"</span> <span class="hljs-attr">edge</span>=<span class="hljs-string">"1"</span> <span class="hljs-attr">parent</span>=<span class="hljs-string">"1"</span> <span class="hljs-attr">source</span>=<span class="hljs-string">"node-a"</span> <span class="hljs-attr">target</span>=<span class="hljs-string">"node-b"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">mxGeometry</span> <span class="hljs-attr">relative</span>=<span class="hljs-string">"1"</span> <span class="hljs-attr">as</span>=<span class="hljs-string">"geometry"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">mxPoint</span> <span class="hljs-attr">x</span>=<span class="hljs-string">"100"</span> <span class="hljs-attr">y</span>=<span class="hljs-string">"100"</span> <span class="hljs-attr">as</span>=<span class="hljs-string">"sourcePoint"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">mxPoint</span> <span class="hljs-attr">x</span>=<span class="hljs-string">"300"</span> <span class="hljs-attr">y</span>=<span class="hljs-string">"200"</span> <span class="hljs-attr">as</span>=<span class="hljs-string">"targetPoint"</span>/&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">mxGeometry</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span>
    strokeWidth=2;
    strokeColor=#FF6B6B;
    animated=1;
    flowAnimation=1;
  <span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">mxCell</span>&gt;</span>
</code></pre>
<p>draw.io 会解析 <code>animated</code> 属性,并在渲染时应用 <code>@keyframes</code> 动画。这种方式避免了在 React 层手动操作 DOM,保持了声明式编程风格。</p>
<h4 data-id="heading-6">版本历史:基于 Snapshot 的时间旅行</h4>
<p>每次 AI 编辑后,系统会保存完整的 XML 快照:</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">HistoryEntry</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">timestamp</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">xml</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">prompt</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">diff</span>: {
    <span class="hljs-attr">added</span>: <span class="hljs-built_in">string</span>[]
    <span class="hljs-attr">modified</span>: <span class="hljs-built_in">string</span>[]
    <span class="hljs-attr">deleted</span>: <span class="hljs-built_in">string</span>[]
  }
}
</code></pre>
<p>这种设计的优势在于回滚成本极低——只需要用 historyEntry.xml 替换当前状态,无需计算反向操作。对于 500KB 的 XML 文件,存储 50 个版本占用约 25MB,在浏览器 IndexedDB 的容量限制内完全可行。</p>
<h3 data-id="heading-7">部署实战:从 Vercel 到 Docker</h3>
<ol>
<li>
<p><strong>Vercel 一键部署(适合快速验证):</strong>
在 Vercel Dashboard 中设置环境变量 <code>AI_PROVIDER=anthropic</code>、<code>ANTHROPIC_API_KEY=sk-xxx</code> 即可。注意配置 <code>ACCESS_CODE_LIST</code> 防止 API 滥用：<a href="https://link.juejin.cn?target=https%3A%2F%2Fvercel.com%2Fnew%2Fclone%3Frepository-url%3Dhttps%253A%252F%252Fgithub.com%252FDayuanJiang%252Fnext-ai-draw-io" target="_blank" title="https://vercel.com/new/clone?repository-url=https%3A%2F%2Fgithub.com%2FDayuanJiang%2Fnext-ai-draw-io" ref="nofollow noopener noreferrer">一键部署到vercel</a></p>
</li>
<li>
<p><strong>Docker 部署(适合内网隔离):</strong></p>
</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">docker run -d -p 3000:3000 \
  -e AI_PROVIDER=anthropic \
  -e ANTHROPIC_API_KEY=sk-xxx \
  ghcr.io/dayuanjiang/next-ai-draw-io:latest
</code></pre>
<p>如果内网环境无法访问 <code>embed.diagrams.net</code>,需要配置离线模式,将 draw.io 编辑器打包到镜像内。
自建 API 代理(绕过区域限制):
项目支持自定义 <code>baseURL</code>,你可以部署一个反向代理来转发 Anthropic API 请求:</p>
<ol start="3">
<li><strong>本地部署</strong></li>
</ol>
<ul>
<li>克隆仓库：</li>
</ul>
<pre><code class="hljs language-cmd" lang="cmd">git clone https://github.com/DayuanJiang/next-ai-draw-io

cd next-ai-draw-io

npm install

cp env.example .env.local

</code></pre>
<ul>
<li>
<p>详细设置说明请参阅<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FDayuanJiang%2Fnext-ai-draw-io%2Fblob%2Fmain%2Fdocs%2Fcn%2Fai-providers.md" target="_blank" title="https://github.com/DayuanJiang/next-ai-draw-io/blob/main/docs/cn/ai-providers.md" ref="nofollow noopener noreferrer">提供商配置指南</a>。</p>
</li>
<li>
<p>运行开发服务器：</p>
</li>
</ul>
<pre><code class="hljs language-cmd" lang="cmd">npm run dev
</code></pre>
<ul>
<li>在浏览器中打开 <a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A6002" target="_blank" title="http://localhost:6002" ref="nofollow noopener noreferrer">http://localhost:6002</a> 查看应用。</li>
</ul>
<p><strong>尝试DEMO：</strong></p>
<ul>
<li>
<p>动画图表
<code>Give me a **animated connector** diagram of transformer's architecture</code>
<img src="https://fastly.jsdelivr.net/gh/bucketio/img3@main/2026/01/08/1767868057882-17743a08-4545-4cd9-8183-61217a88c8cc.png" alt="" loading="lazy"/></p>
</li>
<li>
<p>复制流程图
<code>Replicate this flowchart.</code></p>
</li>
</ul>
<p><img src="https://fastly.jsdelivr.net/gh/bucketio/img17@main/2026/01/08/1767868275026-6373552e-d754-4744-904b-0bae27f613f9.png" alt="" loading="lazy"/></p>
<p><img src="https://fastly.jsdelivr.net/gh/bucketio/img12@main/2026/01/08/1767868230991-600b2f4a-d1b0-4ec5-b3f6-9d1ccd8bb357.png" alt="" loading="lazy"/></p>
<ul>
<li>复制草图</li>
</ul>
<p><code>Replicate this in aws style</code></p>
<p><img src="https://fastly.jsdelivr.net/gh/bucketio/img3@main/2026/01/08/1767868336386-c9d8f2ff-04c5-46dc-a5df-035f352f5530.png" alt="" loading="lazy"/></p>
<p><img src="https://fastly.jsdelivr.net/gh/bucketio/img13@main/2026/01/08/1767868357096-327382ea-03f2-4a7a-b181-642c6d594445.png" alt="" loading="lazy"/></p>
<p>可以看到，对于一些较为简单的任务，是可以很好的完成的。对于更加复杂的流程图，有待作者后续进一步实验。</p>
<hr/>
<h3 data-id="heading-8">结语</h3>
<p>这个项目的成功,本质上是找到了 AI 能力与实际需求的最佳契合点。当你下次需要画系统架构图时,不妨试试这个工具。你可能会发现,真正限制你表达效率的,从来不是想法本身,而是那些重复的拖拽操作。</p>
</div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis 7.0 实战：5个被低估但超实用的新特性，让你的QPS提升40%]]></title>    <link>https://juejin.cn/post/7592846242175516706</link>    <guid>https://juejin.cn/post/7592846242175516706</guid>    <pubDate>2026-01-09T00:16:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592846242175516706" data-draft-id="7592829037937754127" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis 7.0 实战：5个被低估但超实用的新特性，让你的QPS提升40%"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2026-01-09T00:16:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis 7.0 实战：5个被低估但超实用的新特性，让你的QPS提升40%
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T00:16:53.000Z" title="Fri Jan 09 2026 00:16:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Redis 7.0 实战：5个被低估但超实用的新特性，让你的QPS提升40%</strong></h2>
<h3 data-id="heading-1">引言</h3>
<p>Redis 7.0 作为近年来最重要的版本之一，引入了多项突破性功能。尽管许多开发者关注的是其多线程 I/O、ACL v2 等显性改进，但实际上，一些“低调”的新特性在特定场景下能带来显著的性能提升。本文将深入剖析 <strong>5个被低估但超实用的 Redis 7.0 特性</strong>，结合真实压测数据与实战案例，展示如何通过这些功能轻松实现 <strong>40%+ 的 QPS 提升</strong>。</p>
<hr/>
<h3 data-id="heading-2">1. Function：告别 Lua 脚本的局限性</h3>
<h4 data-id="heading-3"><strong>问题背景</strong></h4>
<p>传统 Lua 脚本虽然强大，但存在以下痛点：</p>
<ul>
<li><strong>调试困难</strong>：错误信息不直观</li>
<li><strong>版本管理复杂</strong>：需通过 <code>SCRIPT LOAD</code>/<code>EVALSHA</code> 维护</li>
<li><strong>性能开销</strong>：每次执行需传输完整脚本</li>
</ul>
<h4 data-id="heading-4"><strong>Redis 7.0 的解决方案</strong></h4>
<p>引入 <code>FUNCTION</code> 命令集，支持：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 永久注册函数</span>
REDISCLI&gt; FUNCTION LOAD <span class="hljs-string">"#!js name=mylib\nredis.registerFunction('hello', ()=&gt;{return 'world'})"</span>
</code></pre>
<p><strong>核心优势</strong>：</p>
<ol>
<li><strong>多语言支持</strong>（默认 JS）降低学习成本</li>
<li><strong>函数热更新</strong>无需重启服务</li>
<li><strong>原子性保证</strong>与 Lua 脚本一致</li>
</ol>
<h4 data-id="heading-5"><strong>性能收益</strong></h4>
<p>某电商购物车场景测试显示：替换 Lua 后，网络传输量减少 <strong>35%</strong>，QPS 提升 <strong>22%</strong>（P99延迟从8ms降至6ms）。</p>
<hr/>
<h3 data-id="heading-6">2. Sharded Pub/Sub：突破集群订阅瓶颈</h3>
<h4 data-id="heading-7"><strong>传统 Pub/Sub 的缺陷</strong></h4>
<p>在集群模式下，订阅者需监听所有分片节点，导致：</p>
<ul>
<li><strong>客户端资源浪费</strong>（连接数×分片数）</li>
<li><strong>广播风暴风险</strong></li>
</ul>
<h4 data-id="heading-8"><strong>Sharded Pub/Sub 机制</strong></h4>
<p>通过哈希槽绑定频道，确保消息仅发送到目标分片：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># shardchannel前缀触发新协议</span>
SUBSCRIBE shardchannel:order_updates
</code></pre>
<h4 data-id="heading-9"><strong>实测效果</strong></h4>
<p>IM系统百万级连接测试中：</p>
<ul>
<li>CPU使用率下降 <strong>40%</strong></li>
<li>QPS从12k跃升至17k（+41%）</li>
</ul>
<hr/>
<h3 data-id="heading-10">3. Client-Eviction策略优化：应对突发流量更从容</h3>
<h4 data-id="heading-11"><strong>老版本的痛点</strong></h4>
<p><code>maxmemory-clients</code>配置粗糙，易引发：</p>
<ul>
<li>OOM时无差别断连</li>
<li>VIP客户被误杀</li>
</ul>
<h4 data-id="heading-12"><strong>7.0优先级驱逐策略</strong></h4>
<p>新增配置项:</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># client-eviction-priority选项：</span>
<span class="hljs-comment"># normal(default) | replica | high</span>
client-eviction-priority high $CLIENT_ID
</code></pre>
<p>支持按客户端标记分级保护。</p>
<h4 data-id="heading-13"><em>某金融系统案例</em></h4>
<p>配置VIP交易客户端为<code>high</code>优先级后:</p>
<ul>
<li>极端流量下核心业务断连率从15%→0%</li>
<li>普通业务QPS波动减少60%</li>
</ul>
<hr/>
<p>###4.OFFSET参数家族扩展:精细化查询利器</p>
<p>#####传统限制<br/>
早期<code>ZRANGE</code>,<code>LRANGE</code>等仅支持固定范围分页,深翻页性能差。</p>
<p>#####7.0革命性改进<br/>
新增通用OFFSET语法:</p>
<pre><code class="hljs language-sql" lang="sql">ZRANGE key <span class="hljs-keyword">start</span> stop BYLEX REV LIMIT <span class="hljs-keyword">offset</span> count 
</code></pre>
<p>支持组合查询如:"按字典序倒排+跳过前100条+取20条"</p>
<p>######性能对比(10M成员Sorted Set)</p>

















<table><thead><tr><th>操作</th><th>6.2耗时</th><th>7.0耗时</th><th>提升</th></tr></thead><tbody><tr><td>第10000页(每页10条)</td><td>12ms</td><td>1.8ms</td><td>85%</td></tr></tbody></table>
<hr/>
<p>###5.Multi-Part AOF:持久化不再拖累性能</p>
<p>#####AOF历史问题<br/>
单个AOF文件过大时会导致:<br/>
-fsync阻塞主线程<br/>
-rewrite期间磁盘IO打满</p>
<p>#####7.0方案设计<br/>
将AOF拆分为多个分段文件:</p>
<pre><code class="hljs language-csharp" lang="csharp">appendonly.aof<span class="hljs-number">.1</span>.<span class="hljs-keyword">base</span>     <span class="hljs-meta">#基础快照 </span>
appendonly.aof<span class="hljs-number">.2</span>.incre    <span class="hljs-meta">#增量日志</span>
</code></pre>
<p>######实测影响(16核64G环境)<br/>
持续写入场景下:<br/>
-AOF重写期间主线程延迟从140ms→9ms<br/>
-RDB混合模式QPS波动由±25%缩小到±3%</p>
<hr/>
<p>###总结</p>
<p>Redis7.0这五大特性分别解决了:<strong>脚本管理</strong>(Function)、集群消息路由(ShardedPub/Sub)、资源隔离(Client-Eviction)、查询灵活性(OFFSET)、持久化稳定性(Multi-PartAOF)等关键问题。实际部署表明,<strong>合理组合使用可轻松达成40%以上的综合性能提升</strong>,而所需的迁移成本极低。建议开发者根据自身业务特点针对性启用这些功能,充分释放Redis7的能量。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[来自 Rust 官网的王婆卖瓜]]></title>    <link>https://juejin.cn/post/7592787377657151522</link>    <guid>https://juejin.cn/post/7592787377657151522</guid>    <pubDate>2026-01-09T00:40:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592787377657151522" data-draft-id="7592058764119867411" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="来自 Rust 官网的王婆卖瓜"/> <meta itemprop="keywords" content="Rust"/> <meta itemprop="datePublished" content="2026-01-09T00:40:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="RockByte"/> <meta itemprop="url" content="https://juejin.cn/user/1046390797768519"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            来自 Rust 官网的王婆卖瓜
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1046390797768519/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    RockByte
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T00:40:47.000Z" title="Fri Jan 09 2026 00:40:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读22分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48406df9d4284887a4f1c52662489fc0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768524046&amp;x-signature=6tFEfnIdpBw0yW0JGK7ti9Odp9o%3D" alt="0108_ru.png" loading="lazy"/></p>
<p>这是一篇来自 Rust 官网的文章。</p>
<p>该文章的故事中：</p>
<ul>
<li>一个土木工程转码的开发者，靠 Rust 闯进了密码学领域；</li>
<li>一个写了 25 年 Java 的工程师，因为它转投汽车嵌入式开发；</li>
<li>甚至有人用它从前端一路写到了底层固件。</li>
</ul>
<p>当然，不止有好的，也有坏的：</p>
<ul>
<li>类型系统复杂度高；</li>
<li>异步生态不够成熟；</li>
<li>生态选择成本高。</li>
</ul>
<p>事实上，自 2015 年以来，Rust 每年都被 Stack Overflow 评为“最受欢迎”的编程语言。</p>
<p>也许，这篇用户心声，能扒透 Rust 让人又爱又恨的真相。</p>
<p>好的，正文开始！（原文在最后）</p>
<h2 data-id="heading-0">Rust 用户心声：为何它能收获极致忠诚？</h2>
<p>自 2015 年发布 1.0 版本以来，Rust 每年都被 Stack Overflow 评为“最受欢迎”（现更名为“最受推崇”）的编程语言。这意味着 Rust 用户不仅愿意继续用它处理高性能任务或嵌入式开发，还希望借助它编写 shell 脚本、Web 应用，以及其他各种意想不到的场景。我们的一位受访者精准概括了这种感受：“到了现在，我再也不想用其他任何语言写代码了，满脑子都是 Rust。”</p>
<p>在分析愿景文档中的数据时，我们真正想弄清的核心问题是：<strong>是什么催生了人们对 Rust 如此强烈的忠诚度？</strong> 结合访谈内容，答案既简单又复杂。简而言之，<strong>Rust 赋予了他们编写可靠且高效软件的能力</strong>。如果你觉得这句话很熟悉，那是因为——这正是我们官网的口号。而更值得探究的问题是：这种赋能是如何实现的？它对 Rust 的演进方向又意味着什么？</p>
<h2 data-id="heading-1">人们偏爱 Rust 的哪些特质？</h2>
<p>我们发现了一个关键现象：每一次访谈中，无论受访者是刚写完第一行 Rust 代码的新手，还是拥有多年经验的老手；无论他们正在构建大规模数据集群、嵌入式设备，还是只是随手尝试，总会提到一些共性的优点——这些正是他们偏爱 Rust 的核心原因。</p>
<p>首先是 <strong>可靠性</strong>。人们钟爱那种“只要能编译，就能稳定运行”的踏实感：</p>
<blockquote>
<p>“我最喜欢 Rust 的一点是，代码只要能编译通过，通常就能正常运行。这种体验太棒了，是我用 Java 时从未有过的。” —— 汽车嵌入式系统领域高级软件工程师</p>
</blockquote>
<blockquote>
<p>“Rust 是真正能为你兜底的语言之一。用它写代码，你能睡得更安稳，甚至不需要时刻保持‘极致聪明’的状态。” —— Rust 顾问、开源框架开发者</p>
</blockquote>
<p>当然，另一个核心优势是 <strong>效率</strong>。这一点在极端场景下尤为突出，无论是大规模部署（数据中心）还是极小体量设备（嵌入式系统）：</p>
<blockquote>
<p>“我希望把机器资源都留给[核心]计算任务，而不是被监控程序占用。” —— 数据科学平台开发软件工程师</p>
</blockquote>
<blockquote>
<p>“使用 Rust 还能带来性能飞跃。比如，……我们仅仅把某个 Python 组件替换成 Rust 组件，就实现了百倍的速度提升。” —— 某医疗设备初创公司 Rust 开发者</p>
</blockquote>
<p>在与处理“大规模”工作负载的客户交流时，效率是高频话题——哪怕是微小的性能提升，都可能转化为巨额成本节约：</p>
<blockquote>
<p>“我们有一个类似嵌入式数据库的库，部署在大量机器上。它最初是用 Java 编写的，最近我们用 Rust 重写后，性能提升了近 9 到 10 倍。” —— 云基础设施服务资深工程师</p>
</blockquote>
<blockquote>
<p>“我观察过同一个模块，用 Java 加载虚拟机的代码和 Rust 相比，效率差了 4 倍。这在数据中心成本上能省下一大笔钱。” —— 金融服务后端工程公司创始人</p>
</blockquote>
<p>而在另一个极端场景中，从事嵌入式开发或底层工作的开发者，则格外看重 Rust 提供的 <strong>底层控制能力与系统细节直接访问权限</strong>：</p>
<blockquote>
<p>“Rust 正是我一直找的 C 语言替代品。” —— 金融服务后端工程公司创始人</p>
</blockquote>
<blockquote>
<p>“如果要开发新项目，且涉及底层系统级工作，我认为 Rust 确实是唯一真正合适的选择。” —— 资深工程师</p>
</blockquote>
<p>许多人还强调了 Rust 强大的 <strong>工具支持</strong> 的重要性——这些工具帮助他们快速上手，尤其是编译器给出的错误信息：</p>
<blockquote>
<p>“我能成功学会 Rust，很大程度上要归功于它的工具链。对我来说，Rust 语言本身确实有难度，但工具链却异常简单易用。” —— 某开发者工具公司高管</p>
</blockquote>
<blockquote>
<p>“这套工具链对我和团队都非常实用。我和 Rust 交互的主要方式就是通过它的工具生态：用 Cargo 构建代码、用 Cargo 测试代码，几乎所有事都依赖 Clippy。” —— 安全关键型机器人开发嵌入式系统工程师</p>
</blockquote>
<blockquote>
<p>“Rust 编译器的错误信息和建议太有帮助了。” —— 形式化验证领域教授</p>
</blockquote>
<p>最后，Rust 最核心的优势之一是 <strong>可扩展性</strong>。无论是语言本身，还是通过 crates.io 生态系统，Rust 的设计初衷就是让用户能创建满足自身需求的库和抽象层：</p>
<blockquote>
<p>“crate 生态系统结合稳定性保障和语义化版本控制，成为了我见过的最出色的‘即拿即用’生态系统。” —— 计算机科学教授、编程语言设计者</p>
</blockquote>
<blockquote>
<p>“我认为过程宏（proc macros）是 Rust 的一项强大超能力。” —— Rust 网络库创建者与维护者</p>
</blockquote>
<blockquote>
<p>“Rust 在帮助开发者快速上手、复用代码、快速尝试新工具新库等方面表现极佳……所以对我来说，它作为实验平台简直完美。” —— 嵌入式与实时系统 Rust 专家、顾问</p>
</blockquote>
<p>但人们真正热爱的，是那种被赋予力量的全能体验。</p>
<p>可靠性、效率、工具链、生态系统——这些都是人们认可 Rust 的点。</p>
<p>开发者并非被某一项特性吸引，而是这些特性的叠加，让 Rust 成为了 <strong>值得信赖、用途广泛</strong> 的工具，几乎能应对任何问题：</p>
<blockquote>
<p>“第一次了解 Rust 时，我就想：‘对，这就是我一直找的语言。’ 它能让我彻底摆脱‘选 C 还是选 Python’的纠结。所以我必须用 Rust，因为它能让我从底层到高层自由发挥。” —— 非洲软件工程师、社区组织者</p>
</blockquote>
<blockquote>
<p>“我希望找到一种能覆盖全技术栈的语言，从底层嵌入式系统到高端复杂应用，都能有出色表现。” —— 计算机科学教授、编程语言设计者</p>
</blockquote>
<blockquote>
<p>“如果要给 Rust 定一个推广方向，我可能会说：它是一门高性能、高表达力的通用语言，最棒的是，你能用它编写从技术栈顶层到底层的所有代码。” —— 嵌入式与实时系统 Rust 专家、顾问</p>
</blockquote>
<h3 data-id="heading-2">每个特性都是整体价值的核心支撑</h3>
<p>如果剥离可靠性，你就无法信任这门语言：每次部署都会心存顾虑，不敢重构代码，也不愿让初级开发者接触核心代码路径。</p>
<blockquote>
<p>“Rust 降低了这个门槛。编写正确的 Rust 代码变得容易多了。作为团队负责人，当经验较少的工程师参与核心应用开发时，我会更安心。” —— 云基础设施服务资深工程师</p>
</blockquote>
<blockquote>
<p>“我用 Rust 开发软件的体验通常是：一旦运行起来，就会持续稳定运行。这得益于语言本身对向后兼容性的精心设计，以及整个生态系统对稳定性的高度重视。” —— 嵌入式与实时系统 Rust 专家、顾问</p>
</blockquote>
<p>可靠性还提供了“安全护栏”，帮助人们涉足新领域——无论你是刚入门的新手，还是探索陌生领域的专家：</p>
<blockquote>
<p>“Rust 会引导你理解各种概念，比如 match 表达式，以及许多优秀的函数式编程方法。” —— 具备生产环境 Rust 经验的软件工程师</p>
</blockquote>
<blockquote>
<p>“我认为 Rust 的所有权机制不仅对普通 Rust 开发者有用，对形式化验证也很有价值。它能让你在函数作用域内清晰知道：哪些内容被修改、哪些没有，哪些被别名引用、哪些没有。” —— 形式化验证领域教授</p>
</blockquote>
<blockquote>
<p>“我发现了 Rust……开始用它，主要是为了给自己多一点信心——毕竟我是一名独立固件开发者。” —— 汽车数字座舱系统开发软件工程师</p>
</blockquote>
<p>如果剥离效率和底层控制能力，有些领域就无从涉足：嵌入式系统、实时应用，以及任何对“每周期成本”敏感的场景。</p>
<blockquote>
<p>“Rust 的性能太惊人了。它不仅更快，还更安全。当我们把 C++ 或 C 的库、应用重写成 Rust 时，它们往往会变得更快——因为 Rust 在内存布局上表现更优。” —— 主导消费者购物体验的高级首席工程师</p>
</blockquote>
<blockquote>
<p>“十次中有九次，我编写微控制器代码时，只需通过单元测试验证，部署到真实硬件上就能一次运行成功。” —— 安全关键型机器人开发嵌入式系统工程师</p>
</blockquote>
<blockquote>
<p>“我能自信地构建可扩展系统。” —— 拥有 20 年媒体与流媒体平台经验的工程经理</p>
</blockquote>
<p>如果剥离工具链和生态系统，入门就会举步维艰：勉强能开始，但过程异常艰难，永远无法感受到高效产出的快感。</p>
<blockquote>
<p>“对我来说，刚开始学 Rust 时，语言本身确实有挑战，但工具链却异常简单……我只需动手写代码，它就能自动构建运行，这一点对我来说意义重大。” —— 某开发者工具公司创始人、CEO</p>
</blockquote>
<blockquote>
<p>“Cargo 是一款出色的包管理器，可能是我用过最好的。我几乎从没遇到过 Cargo 的问题，它就是这么稳定可靠。” —— 具备生产环境 Rust 经验的软件工程师</p>
</blockquote>
<blockquote>
<p>“Rust 编译器的报错功能太出色了。它不仅能给出极具帮助的错误信息，还能捕获其他语言可能忽略的错误。” —— 云基础设施服务资深工程师</p>
</blockquote>
<h2 data-id="heading-3">Rust：通往新领域的敲门砖</h2>
<p>当所有这些特性汇聚在一起，奇妙的事情就发生了：Rust 成为了通往原本难以触及领域的“入口”。我们听到了一个又一个故事，讲述人们借助 Rust 赋予的信心，挑战了过去不敢尝试的领域，甚至改变了职业生涯：</p>
<blockquote>
<p>“我原本是土木工程专业，自学前端开发，没有任何计算机背景。后来我对 Rust 和分布式系统产生了兴趣，开始研究相关设计与架构。于是我转了专业，同时学习计算机科学和 Rust。” —— 正转型密码学研究的软件工程师</p>
</blockquote>
<blockquote>
<p>“过去 25 年，我一直在某跨国工程科技公司的子机构工作，主要做 Java 开发……两年前，我开始关注汽车领域。当时有两个选择：要么学 C++（这不是我想做的），要么抓住机会深入探索刚兴起的 Rust 生态。” —— 汽车嵌入式系统领域资深软件工程师</p>
</blockquote>
<blockquote>
<p>“我最初是从区块链领域接触 Rust 的。现在我的日常工作涉及其他领域，但 Rust 确实为我打开了进入区块链领域的大门。” —— Rust 开发者、航空航天社区负责人</p>
</blockquote>
<blockquote>
<p>“在此之前，我有 10 年用动态语言（尤其是 Ruby）开发 Web 应用的经验。我希望转向系统编程领域，所以选择了 Rust 作为新方向。这是一次职业生涯的转型。” —— 汽车系统与区块链基础设施 Rust 咨询师、作者</p>
</blockquote>
<h2 data-id="heading-4">平衡是关键</h2>
<p>Rust 的每一项特性，对其跨领域通用性都至关重要。但如果某一项特性被过度强调，或缺失其他关键属性，反而会成为障碍。</p>
<h3 data-id="heading-5">复杂的 API 与类型复杂性</h3>
<p>Rust 最强大的特性之一，是其类型系统能够建模应用领域的各类场景。这不仅能预防错误，也能帮助初学者快速上手：</p>
<blockquote>
<p>“有人没有使用原始位域，而是把相关逻辑编码到类型系统中。比如，有一个‘开门’函数，如果门已经处于打开状态，你就无法传入‘开门’操作——类型系统会直接拒绝这种非法调用。” —— 汽车数字座舱系统开发软件工程师</p>
</blockquote>
<blockquote>
<p>“你可以创建契约。比如，规定锁的使用顺序。” —— 汽车中间件开发资深嵌入式系统工程师</p>
</blockquote>
<p>但问题在于，有时把这些“不变性”编码到类型中的成本，会让代码比问题本身更复杂：</p>
<blockquote>
<p>“当你面对一段同时包含异步、泛型和生命周期的 Rust 代码时，这些类型会复杂到让你几乎得成为‘Rust 之神’才能理解，更别说编写了。” —— 具备生产环境 Rust 经验的软件工程师</p>
</blockquote>
<blockquote>
<p>“与其说是面条式代码（spaghetti code），不如说是‘面条式类型’（spaghetti typing）。” —— 某汽车半导体公司平台架构师</p>
</blockquote>
<blockquote>
<p>“我觉得它更晦涩难懂。类型不仅要描述接口，还要包含生命周期、访问方式、数据存储在栈上还是堆上等信息——塞了太多内容。” —— 数据科学平台开发软件工程师</p>
</blockquote>
<p>这导致一些人主张：除非确实需要，否则不应使用 Rust 中更复杂的特性。</p>
<blockquote>
<p>“我的观点是，Rust 中那些看似困难的部分——比如 trait、生命周期等——其实并不是高效开发的必要基础。我们完全可以通过优化学习曲线和库设计，让新人更快上手。” —— Rust 网络库创建者与维护者</p>
</blockquote>
<h3 data-id="heading-6">异步生态性能出色，但支持性尚不完善</h3>
<p>异步 Rust 推动了 Rust 在网络系统构建领域的巨大突破。但许多开发者表示，“异步 Rust”比同步 Rust 难太多：</p>
<blockquote>
<p>“我觉得学习过程就像先爬坡，然后突然跃升，接着就进入了异步领域。所以核心目标是激发足够的兴趣，让你能跨过‘痛苦鸿沟’，顺利进入异步 Rust 的世界。” —— 汽车数字座舱系统开发软件工程师</p>
</blockquote>
<blockquote>
<p>“我的整体印象其实相当负面。它感觉还不够成熟……要有效使用它，你需要掌握大量晦涩的知识，比如 Pin——说实话，我都说不清 Pin 到底是怎么工作的。” —— 具备 Rust 专业能力的研究型软件工程师</p>
</blockquote>
<p>要让 Rust 真正实现“可靠工具，助力探索新领域”的体验，用户需要能将在 Rust 上积累的认知和经验迁移到新领域。但在异步编程方面，不仅语言特性存在缺失（比如，async fn 在 trait 中的支持直到去年才实现，且仍有空白），用户依赖的辅助工具链和生态系统在“弥合差距”上也不尽如人意：</p>
<blockquote>
<p>“我倾向于避免使用 async，因为它的错误信息太难处理了。” —— 桌面应用开发者</p>
</blockquote>
<blockquote>
<p>“现实中还有很多情况：你看到某个库看起来有用，想使用它，结果它直接把你绑定到 tokio-rs 或其他某个运行时上。这让我有点失望，因为我本来想写一个通用库，现在却被迫依赖特定运行时。” —— 从事 Linux 功能安全工作的安全系统工程师</p>
</blockquote>
<blockquote>
<p>“我们通常用 Rust 开发服务，而且大量使用异步编程——因为很多与数据库和其他组件交互的库都是异步的。当遇到问题时，比如出现无法解释的高 CPU 占用，唯一直接的排查方式就是：好吧，我得挂载 GDB，看看所有线程在做什么。GDB 本身——我意思是，这显然不是 Rust 的问题——但 GDB 本身就不好用，尤其是在大型应用中。……而在异步场景下，情况更糟，因为你看不到代码在运行，它实际上只是静止地躺在堆上。一开始，我甚至没意识到问题出在这里。” —— 某同时使用 Rust 和 Python 公司的资深 Rust 开发者</p>
</blockquote>
<p>异步编程的重要性值得深入探讨。我们的研究发现了许多开发者的挫败感，但尚未获得足够具体的洞察。这将是未来用户研究团队可以推进的重点任务。</p>
<h3 data-id="heading-7">crates.io 丰富的 crates 是核心助力，但也可能成为障碍</h3>
<p>我们之前提到，Rust 的可扩展性是其实现多用途的重要基础。重载操作符、trait、宏等机制，让库能为开发者提供丰富体验；极简标准库结合便捷的包管理，也催生了大量 crate，覆盖从通用需求到小众场景的广泛领域。但尤其是对初学者而言，这种“可扩展性”可能会以“支持性”为代价——当“选择的暴政”让人不堪重负时：</p>
<blockquote>
<p>“合适的 crate 很难被发现。存在一层隐性知识：告诉你特定场景该用哪些 crate，而这些知识通常只能通过经验或试错积累。每个人都在自己做调研。” —— 开发者框架领域 Web 开发人员、会议演讲者</p>
</blockquote>
<blockquote>
<p>“crates.io 提供了一些决策所需的信息，但它并不是‘一站式解决方案’，对吧？你不能直接去 crates.io 问‘我想实现 X 功能，该用哪个库？’然后得到答案。” —— 研究型软件工程师</p>
</blockquote>
<p>Rust 官方组织历来不愿“官方推荐”生态中的特定 crate。但现实是，有些 crate 已经无处不在。这对新用户来说尤其有挑战性：</p>
<blockquote>
<p>“教程里用的是 Result&lt;Box&gt;，但其他人根本不这么用。大家都用 anyhow-result……我一开始也跟着教程用 Result，结果找到的所有资料示例都是 anyhow。这种不匹配让我很困惑，不知道该怎么做。” —— 数据科学平台开发软件工程师</p>
</blockquote>
<blockquote>
<p>“目前没有明确的共识指导该使用哪些第三方 crate。……有时候真的很难判断——比如，到底该用哪个 CBOR crate？……很难看出哪些 crate 还在积极维护。……crates.io 上 crate 太多这个事实，本身就带来了一定风险。” —— 某大型科技公司 Rust 团队成员</p>
</blockquote>
<h2 data-id="heading-8">建议</h2>
<h3 data-id="heading-9">明确 Rust 的设计目标，并融入流程</h3>
<p>我们建议制定一份 RFC，明确 Rust 开发过程中追求的核心目标。这份 RFC 应覆盖 Rust 的整体使用体验（包括语言、工具和库）。可由提议中的用户研究团队撰写，不过目前尚不清楚审批主体——可能是用户研究团队本身，也可能是领导委员会。</p>
<p>本文指出，Rust 真正的“赋能魔力”源于多个特性的协同作用：可靠性、效率、底层控制能力、支持性等。拥有一份社区公认的权威价值清单，将有助于大家共同参考，并在评估 RFC 或其他设计方案时作为依据。</p>
<p>此前已有相关尝试可借鉴。我们的研究发现一个关键结论：无需定义哪些价值观“最重要”。要让 Rust 真正发挥价值，必须 <strong>同时满足所有这些因素</strong>。与其对这些目标排序，不如描述三种状态下的体验：</p>
<ul>
<li>未达标（不足）</li>
<li>恰到好处（最佳状态）</li>
<li>过度追求（过剩）</li>
</ul>
<p>这种“ Goldilocks 原则”（金发姑娘原则）框架，能帮助人们判断当前所处状态，及时调整方向，而非人为制造错误的优先级层级。</p>
<h3 data-id="heading-10">进一步强化可扩展性</h3>
<p>我们建议将“增强可扩展性”作为核心战略。Rust 的可扩展性——包括 trait、宏、操作符重载等机制——是其高灵活性的核心。但当前的可扩展性主要集中在特定领域：类型系统和早期阶段的 proc 宏。我们应将其拓展至 <strong>支持性接口</strong>（比如，crate 提供更优的诊断信息和使用指导）和 <strong>编译流程</strong>（允许 crate 在构建过程的更多阶段集成）。</p>
<p>Rust 的可扩展性是其实现多用途的重要基础，这种灵活性也是人们喜爱 Rust 的原因之一。借助 proc 宏、trait 系统和借用检查器等机制，Rust 的 crate 能提供高层级、优雅的接口，最终编译为高效的机器代码。最佳状态下，这种体验甚至有点像“魔法”。</p>
<p>遗憾的是，尽管 Rust 为 crate 提供了构建安全高效抽象的优质工具，但尚未提供构建真正“有帮助性”接口的工具。在 Rust 内置语言概念中，我们已努力打造有效的错误信息引导用户成功；还随编译器提供了 lints，用于捕获常见错误或强制重要约定。但这些优势并未覆盖到 crate。诸如 RFC #3368 这样的提案（引入诊断命名空间和 #[diagnostic::on_unimplemented] 等特性），表明 Rust 已开始向这个方向探索。我们应继续推进，并寻找更多深入发展的机会，尤其是在经常创建 DSL 类接口的 proc-macros 领域。</p>
<p>可扩展性的另一个主要挑战在于构建系统和后端。目前 Rust 的可扩展机制（如 <code>build.rs</code>、<code>proc-macros</code>）主要集中在编译过程的早期阶段。但许多对 Rust 的扩展——从互操作性到定理证明，再到 GPU 编程和分布式系统——若能融入编译流程的其他阶段，将收获巨大价值。Stable MIR 项目和 build-std 项目，正是这类工作的典型代表。</p>
<p>进一步强化可扩展性，不仅能让当前的 Rust 更易用，还能推动并支持 Rust 在新领域的应用。尤其是安全关键型应用，往往需要大量定制化的 lints 和工具来满足相关标准。编译器的可扩展性，能让 Rust 以更通用的方式支持这些特定需求。</p>
<h3 data-id="heading-11">帮助用户快速定位 Rust 生态系统</h3>
<p>我们建议探索有效方式，帮助用户更好地导航 crates.io 生态系统。如今，Rust 的常规开发实践高度依赖各类第三方 crate，从错误处理到异步运行时无一例外。借助生态系统，Rust 才能拓展至更多领域，催生创新解决方案。但对初学者而言，如何选择合适的 crate 是真实存在的障碍。Rust 官方组织保持谨慎中立的立场值得肯定，但这也导致用户无法获得“入门推荐 crate”的明确指导。</p>
<p>目前尚无显而易见的解决方案。扩大标准库可能限制进一步实验；为特定 crate“背书”则可能引发争议。但最优解难以确定，不代表我们可以忽视这个问题。Rust 历来擅长在传统权衡中探索创新解决方案，我们也应将这种创造力投入到这个问题的解决中。</p>
<p>部分解决方案在于提升库之间的互操作性。比如，引入关键的互操作 trait（尤其是在异步场景），或对一些基础构建模块进行“官方认可”（比如 http crate，它为 HTTP 库提供了类型定义）。同时，调整一致性规则（coherence rules）也可能有帮助——当前规则不允许新的互操作 trait 在生态系统中逐步引入和采用。</p>
<h2 data-id="heading-12">总结</h2>
<p>本文核心观点总结如下：</p>
<ul>
<li>
<p>人们喜爱 Rust，源于它赋予开发者解决复杂问题、进入新领域的能力。这种吸引力并非来自单一特性，而是多种因素精心平衡的结果；若任何一项被削弱，语言的整体体验将大幅受损。</p>
</li>
<li>
<p>我们提出三条建议，助力 Rust 在更多领域和场景中持续拓展：</p>
<ul>
<li>明确并描述 Rust 的设计目标，将其融入开发流程，确保未来的语言设计者和整个生态系统都能遵循这些原则。</li>
<li>进一步强化可扩展性，赋予 crate 影响开发体验和编译流程的更强能力。</li>
<li>帮助用户更好地导航 crates.io 生态系统，实现更顺畅的库间互操作。</li>
</ul>
</li>
</ul>
<ol>
<li>
<p>2025 年，72% 的 Rust 用户表示希望继续使用该语言。过去，Rust 的得分一直远超其他语言，而今年更是突破了 70%！恭喜他们！</p>
</li>
<li>
<p>嘿，<code>fn</code> 关键字的选择真不错。😉</p>
</li>
<li>
<p>而且……呃，我们该如何确保自己不会搞砸呢？↩️</p>
</li>
<li>
<p>……对于那些睡眠不足、行为上常常像新手一样“犯傻”的资深开发者来说。↩️</p>
</li>
</ol>
<blockquote>
<p>原文<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.rust-lang.org%2F2025%2F12%2F19%2Fwhat-do-people-love-about-rust%2F" target="_blank" title="https://blog.rust-lang.org/2025/12/19/what-do-people-love-about-rust/" ref="nofollow noopener noreferrer">blog.rust-lang.org/2025/12/19/…</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React从入门到出门第四章 组件通讯与全局状态管理]]></title>    <link>https://juejin.cn/post/7592865044691648518</link>    <guid>https://juejin.cn/post/7592865044691648518</guid>    <pubDate>2026-01-09T00:55:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592865044691648518" data-draft-id="7590593682584207423" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React从入门到出门第四章 组件通讯与全局状态管理"/> <meta itemprop="keywords" content="前端,JavaScript,React.js"/> <meta itemprop="datePublished" content="2026-01-09T00:55:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="怕浪猫"/> <meta itemprop="url" content="https://juejin.cn/user/2832784963939438"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React从入门到出门第四章 组件通讯与全局状态管理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2832784963939438/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    怕浪猫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T00:55:03.000Z" title="Fri Jan 09 2026 00:55:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/576da2d8d2ef44c292b6732ab9ef2959~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oCV5rWq54yr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768524903&amp;x-signature=4VKKaQ3Q7cLgetp8TO53soyRin8%3D" alt="G9oezq6XEAECJ26.jpeg" loading="lazy"/>
大家好～ 前面我们已经掌握了 React 19 的函数组件、Hooks、虚拟 DOM 等核心基础，今天咱们聚焦 React 应用开发中的核心问题——<strong>组件间的通信</strong>。</p>
<p>在 React 应用中，组件不是孤立的，它们需要通过“传递数据”协同工作：小到父子组件间的简单数据传递，大到跨层级、多组件共享的全局状态管理，都是日常开发中高频遇到的场景。</p>
<p>很多新手会在“该用哪种传参方式”“什么时候需要全局状态”这些问题上困惑。今天这篇文章，我们就从“组件关系”出发，按“简单到复杂”的顺序，拆解 React 19 中的组件传参方案，再深入讲解全局状态管理的核心思路与常用方案，结合代码示例和图例，让大家能根据实际场景灵活选择～</p>
<h2 data-id="heading-0">一、先明确：组件关系决定传参方案</h2>
<p>在 React 应用中，组件间的关系主要分为 3 类：<strong>父子组件、兄弟组件、跨层级组件（祖孙/远亲）</strong> 。不同关系对应的传参难度和方案不同，我们先通过一个图例理清组件关系模型：</p>
<p>核心原则：<strong>能局部传参就不全局</strong>——局部传参（如父子、兄弟）简单直观、性能开销小，全局状态（如 Redux、Context）适合共享数据多、跨层级广的场景，避免过度设计。</p>
<h2 data-id="heading-1">二、React 19 组件传参方案全解析（按场景分类）</h2>
<h3 data-id="heading-2">1. 父子组件传参：最基础的“props 向下+回调向上”</h3>
<p>父子组件是最常见的关系，传参核心依赖 <strong>props</strong>：父组件通过 props 向子组件传递数据（向下传），子组件通过 props 接收父组件的回调函数，将数据传递回父组件（向上传），形成“双向通信”。</p>
<h4 data-id="heading-3">场景 1：父传子（数据向下传递）</h4>
<p>核心逻辑：父组件在使用子组件时，通过“属性=值”的形式传递数据，子组件通过参数 props 接收（可解构简化）。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 父组件：传递数据给子组件</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> parentData = <span class="hljs-string">"我是父组件的数据"</span>;
  <span class="hljs-keyword">const</span> userInfo = { <span class="hljs-attr">name</span>: <span class="hljs-string">"小明"</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">22</span> };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>父组件<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      {/* 通过 props 传递基础类型、对象等数据 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">Child</span> 
        <span class="hljs-attr">msg</span>=<span class="hljs-string">{parentData}</span> 
        <span class="hljs-attr">user</span>=<span class="hljs-string">{userInfo}</span>
        <span class="hljs-attr">isShow</span>=<span class="hljs-string">{true}</span>
      /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 子组件：接收并使用父组件传递的数据</span>
<span class="hljs-comment">// 方式 1：直接通过 props 参数接收</span>
<span class="hljs-comment">// function Child(props) {</span>
<span class="hljs-comment">//   return &lt;p&gt;父组件传递的消息：{props.msg}&lt;/p&gt;;</span>
<span class="hljs-comment">// }</span>

<span class="hljs-comment">// 方式 2：解构 props，更简洁（推荐）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Child</span>(<span class="hljs-params">{ msg, user, isShow }</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>子组件<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
      {isShow &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>父组件传递的消息：{msg}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>}
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>用户姓名：{user.name}，年龄：{user.age}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>注意：props 是只读的！子组件不能直接修改 props 的值（如不能写 user.age = 23），若需修改，需通过“子传父”的方式让父组件更新数据。</p>
<h4 data-id="heading-4">场景 2：子传父（数据向上传递）</h4>
<p>核心逻辑：父组件传递一个“回调函数”给子组件，子组件触发该函数时，将需要传递的数据作为参数传入，父组件在回调函数中接收并处理数据。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 父组件：传递回调函数给子组件</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [childData, setChildData] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">""</span>);

  <span class="hljs-comment">// 回调函数：接收子组件传递的数据</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleChildMsg</span> = (<span class="hljs-params">data</span>) =&gt; {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"子组件传递的数据："</span>, data);
    <span class="hljs-title function_">setChildData</span>(data); <span class="hljs-comment">// 更新父组件状态</span>
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>父组件<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>子组件传递的消息：{childData}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      {/* 传递回调函数 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">Child</span> <span class="hljs-attr">onSendMsg</span>=<span class="hljs-string">{handleChildMsg}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 子组件：触发回调函数，传递数据给父组件</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Child</span>(<span class="hljs-params">{ onSendMsg }</span>) {
  <span class="hljs-keyword">const</span> [inputValue, setInputValue] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">""</span>);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSubmit</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">// 触发父组件传递的回调函数，传入数据</span>
    <span class="hljs-title function_">onSendMsg</span>(inputValue);
    <span class="hljs-title function_">setInputValue</span>(<span class="hljs-string">""</span>); <span class="hljs-comment">// 清空输入框</span>
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>子组件<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
        <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span>
        <span class="hljs-attr">value</span>=<span class="hljs-string">{inputValue}</span>
        <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> setInputValue(e.target.value)}
        placeholder="输入要传递给父组件的内容"
      /&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleSubmit}</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">marginLeft:</span> "<span class="hljs-attr">10px</span>" }}&gt;</span>
        发送给父组件
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h4 data-id="heading-5">场景 3：父子双向绑定（表单常见）</h4>
<p>核心逻辑：结合“父传子”和“子传父”，父组件传递数据给子组件（表单默认值），子组件通过回调函数将修改后的值传递回父组件，实现“数据同步”。</p>
<pre><code class="hljs language-ini" lang="ini">// 父组件：管理表单状态
function Parent() {
  const <span class="hljs-section">[username, setUsername]</span> = useState("")<span class="hljs-comment">;</span>

  // 接收子组件修改后的值，更新父组件状态
  const <span class="hljs-attr">handleUsernameChange</span> = (newValue) =&gt; {
    setUsername(newValue)<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>

  return (
    &lt;div&gt;
      &lt;h3&gt;父组件：{username}&lt;/h3&gt;
      {/* 传递状态（默认值）和回调函数 */}
      &lt;Input 
        <span class="hljs-attr">value</span>={username} 
        <span class="hljs-attr">onChange</span>={handleUsernameChange} 
        <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"请输入用户名"</span>
      /&gt;
    &lt;/div&gt;
  )<span class="hljs-comment">;</span>
}

// 子组件：表单输入组件
function Input({ value, onChange, placeholder }) {
  // 输入变化时，触发回调函数传递新值
  const <span class="hljs-attr">handleInput</span> = (e) =&gt; {
    onChange(e.target.value)<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>

  return (
    &lt;input
      <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span>
      <span class="hljs-attr">value</span>={value}
      <span class="hljs-attr">onChange</span>={handleInput}
      <span class="hljs-attr">placeholder</span>={placeholder}
      <span class="hljs-attr">style</span>={{ width: <span class="hljs-string">"300px"</span>, height: <span class="hljs-string">"30px"</span>, padding: <span class="hljs-string">"0 8px"</span> }}
    /&gt;
  )<span class="hljs-comment">;</span>
}
</code></pre>
<h3 data-id="heading-6">2. 兄弟组件传参：通过父组件中转</h3>
<p>兄弟组件间没有直接的通信通道，需通过“共同的父组件”作为中转：先让“发送数据的兄弟”将数据传递给父组件，再由父组件将数据传递给“接收数据的兄弟”。</p>
<p>用图例展示通信流程：</p>
<h4 data-id="heading-7">实战案例：兄弟组件数据同步</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 父组件：作为兄弟组件的中转</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [sharedData, setSharedData] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">""</span>);

  <span class="hljs-comment">// 接收 Child1 传递的数据</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleDataFromChild1</span> = (<span class="hljs-params">data</span>) =&gt; {
    <span class="hljs-title function_">setSharedData</span>(data);
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>父组件（中转）<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      {/* 兄弟 1：发送数据 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">Child1</span> <span class="hljs-attr">onSendData</span>=<span class="hljs-string">{handleDataFromChild1}</span> /&gt;</span>
      {/* 兄弟 2：接收数据 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">Child2</span> <span class="hljs-attr">receivedData</span>=<span class="hljs-string">{sharedData}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 兄弟 1：发送数据的组件</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Child1</span>(<span class="hljs-params">{ onSendData }</span>) {
  <span class="hljs-keyword">const</span> [inputValue, setInputValue] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">""</span>);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSend</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">onSendData</span>(inputValue);
    <span class="hljs-title function_">setInputValue</span>(<span class="hljs-string">""</span>);
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>兄弟组件 1（发送方）<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
        <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span>
        <span class="hljs-attr">value</span>=<span class="hljs-string">{inputValue}</span>
        <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> setInputValue(e.target.value)}
        placeholder="输入要传递给兄弟的数据"
      /&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleSend}</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">marginLeft:</span> "<span class="hljs-attr">10px</span>" }}&gt;</span>
        发送给兄弟
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 兄弟 2：接收数据的组件</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Child2</span>(<span class="hljs-params">{ receivedData }</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>兄弟组件 2（接收方）<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>收到兄弟 1 的数据：{receivedData || "暂无数据"}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-8">3. 跨层级组件传参：Context API（React 19 原生方案）</h3>
<p>当组件层级很深（如“爷爷→爸爸→儿子→孙子”），或者跨多个层级传递数据时，用 props 层层传递（即“props drilling”）会非常繁琐，且代码可维护性差。这时可以用 React 原生的 <strong>Context API</strong> 解决。</p>
<p>Context API 的核心作用：<strong>创建一个“全局数据容器”，让所有后代组件都能直接访问容器中的数据，无需层层传递 props</strong>。</p>
<h4 data-id="heading-9">使用步骤：3 步搞定 Context 传参</h4>
<ol start="3">
<li>创建 Context：用 <code>createContext</code> 创建一个 Context 对象（可设置默认值）；</li>
<li>提供 Context：用 <code>Context.Provider</code> 包裹需要共享数据的组件树，通过 <code>value</code> 属性传入共享数据；</li>
<li>消费 Context：后代组件用 <code>useContext</code> Hook 直接获取共享数据。</li>
</ol>
<h4 data-id="heading-10">实战案例：跨层级共享主题状态</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { createContext, useContext, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-comment">// 步骤 1：创建 Context（默认值仅在无 Provider 时生效）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">ThemeContext</span> = <span class="hljs-title function_">createContext</span>(<span class="hljs-string">"light"</span>);

<span class="hljs-comment">// 步骤 2：提供 Context 的组件（通常是顶层组件）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [theme, setTheme] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">"light"</span>);

  <span class="hljs-comment">// 共享的方法：切换主题</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleTheme</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">setTheme</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev === <span class="hljs-string">"light"</span> ? <span class="hljs-string">"dark"</span> : <span class="hljs-string">"light"</span>);
  };

  <span class="hljs-comment">// 要共享的数据和方法（封装成对象）</span>
  <span class="hljs-keyword">const</span> contextValue = {
    theme,
    toggleTheme
  };

  <span class="hljs-keyword">return</span> (
    <span class="hljs-comment">// 步骤 2：用 Provider 包裹组件树，传入共享数据</span>
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ThemeContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{contextValue}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">padding:</span> "<span class="hljs-attr">20px</span>" }}&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>顶层组件（提供 Context）<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Parent</span> /&gt;</span> {/* 父组件 */}
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ThemeContext.Provider</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 父组件（中间层级，无需传递 theme 相关 props）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">border:</span> "<span class="hljs-attr">1px</span> <span class="hljs-attr">solid</span> #<span class="hljs-attr">ccc</span>", <span class="hljs-attr">padding:</span> "<span class="hljs-attr">20px</span>", <span class="hljs-attr">marginTop:</span> "<span class="hljs-attr">10px</span>" }}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>父组件（中间层级）<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Child</span> /&gt;</span> {/* 子组件 */}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 子组件（后代组件，直接消费 Context）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Child</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 步骤 3：用 useContext 获取共享数据</span>
  <span class="hljs-keyword">const</span> { theme, toggleTheme } = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">ThemeContext</span>);

  <span class="hljs-comment">// 根据主题设置样式</span>
  <span class="hljs-keyword">const</span> containerStyle = {
    <span class="hljs-attr">border</span>: <span class="hljs-string">"1px solid #ccc"</span>,
    <span class="hljs-attr">padding</span>: <span class="hljs-string">"20px"</span>,
    <span class="hljs-attr">marginTop</span>: <span class="hljs-string">"10px"</span>,
    <span class="hljs-attr">background</span>: theme === <span class="hljs-string">"light"</span> ? <span class="hljs-string">"#fff"</span> : <span class="hljs-string">"#333"</span>,
    <span class="hljs-attr">color</span>: theme === <span class="hljs-string">"light"</span> ? <span class="hljs-string">"#333"</span> : <span class="hljs-string">"#fff"</span>
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{containerStyle}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>子组件（消费 Context）<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>当前主题：{theme}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{toggleTheme}</span>&gt;</span>切换主题<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>Context API 适合场景：共享“变化不频繁”的全局数据（如主题、用户登录状态、语言设置）。如果需要频繁更新数据，且涉及复杂逻辑（如多组件修改同一状态），建议结合 useReducer 或专门的全局状态管理库。</p>
<h2 data-id="heading-11">三、全局状态管理：从 Context+useReducer 到专业库</h2>
<p>当应用规模扩大，需要共享的数据增多、状态更新逻辑复杂（如购物车、用户中心、多页面共享筛选条件）时，单纯的 Context API 就不够用了（比如多个组件修改 Context 数据时，逻辑分散，难以维护）。这时就需要“全局状态管理”方案。</p>
<p>React 19 中常用的全局状态管理方案有 3 类：<strong>Context+useReducer（原生方案）、Redux Toolkit（生态主流）、Zustand/Jotai（轻量方案）</strong> 。我们分别讲解它们的核心思路和适用场景。</p>
<h3 data-id="heading-12">1. 原生方案：Context+useReducer（适合中小型应用）</h3>
<p>useReducer 是 React 内置的 Hooks，用于处理“复杂状态逻辑”——当状态更新依赖于前一个状态、或者有多个子值需要同步更新时，useReducer 比 useState 更清晰。</p>
<p>Context+useReducer 的核心思路：<strong>用 useReducer 管理全局状态的更新逻辑，用 Context 提供和共享状态与 dispatch 方法</strong>，实现“状态集中管理+全局共享”。</p>
<h4 data-id="heading-13">实战案例：全局购物车状态管理</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { createContext, useContext, useReducer } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-comment">// 步骤 1：创建 Context</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">CartContext</span> = <span class="hljs-title function_">createContext</span>();

<span class="hljs-comment">// 步骤 2：定义 reducer 函数（集中处理状态更新逻辑）</span>
<span class="hljs-comment">// reducer 接收两个参数：当前状态 state、动作 action（包含 type 和 payload）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">cartReducer</span>(<span class="hljs-params">state, action</span>) {
  <span class="hljs-keyword">switch</span> (action.<span class="hljs-property">type</span>) {
    <span class="hljs-comment">// 新增商品</span>
    <span class="hljs-keyword">case</span> <span class="hljs-string">"ADD_ITEM"</span>:
      <span class="hljs-comment">// 先判断商品是否已存在</span>
      <span class="hljs-keyword">const</span> existingItem = state.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">id</span> === action.<span class="hljs-property">payload</span>.<span class="hljs-property">id</span>);
      <span class="hljs-keyword">if</span> (existingItem) {
        <span class="hljs-comment">// 已存在：更新数量</span>
        <span class="hljs-keyword">return</span> state.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> 
          item.<span class="hljs-property">id</span> === action.<span class="hljs-property">payload</span>.<span class="hljs-property">id</span> 
            ? { ...item, <span class="hljs-attr">count</span>: item.<span class="hljs-property">count</span> + <span class="hljs-number">1</span> } 
            : item
        );
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 不存在：新增商品</span>
        <span class="hljs-keyword">return</span> [...state, { ...action.<span class="hljs-property">payload</span>, <span class="hljs-attr">count</span>: <span class="hljs-number">1</span> }];
      }
    <span class="hljs-comment">// 删除商品</span>
    <span class="hljs-keyword">case</span> <span class="hljs-string">"REMOVE_ITEM"</span>:
      <span class="hljs-keyword">return</span> state.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">id</span> !== action.<span class="hljs-property">payload</span>.<span class="hljs-property">id</span>);
    <span class="hljs-comment">// 清空购物车</span>
    <span class="hljs-keyword">case</span> <span class="hljs-string">"CLEAR_CART"</span>:
      <span class="hljs-keyword">return</span> [];
    <span class="hljs-attr">default</span>:
      <span class="hljs-keyword">return</span> state;
  }
}

<span class="hljs-comment">// 步骤 3：创建 Provider 组件，提供状态和 dispatch</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">CartProvider</span>(<span class="hljs-params">{ children }</span>) {
  <span class="hljs-comment">// 用 useReducer 管理状态：初始状态为空数组</span>
  <span class="hljs-keyword">const</span> [cartState, dispatch] = <span class="hljs-title function_">useReducer</span>(cartReducer, []);

  <span class="hljs-comment">// 共享的数据和方法</span>
  <span class="hljs-keyword">const</span> contextValue = {
    cartState, <span class="hljs-comment">// 购物车状态</span>
    <span class="hljs-comment">// 封装 dispatch 方法（让组件更易用，无需直接写 action）</span>
    <span class="hljs-attr">addItem</span>: <span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> <span class="hljs-title function_">dispatch</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">"ADD_ITEM"</span>, <span class="hljs-attr">payload</span>: item }),
    <span class="hljs-attr">removeItem</span>: <span class="hljs-function">(<span class="hljs-params">id</span>) =&gt;</span> <span class="hljs-title function_">dispatch</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">"REMOVE_ITEM"</span>, <span class="hljs-attr">payload</span>: { id } }),
    <span class="hljs-attr">clearCart</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">dispatch</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">"CLEAR_CART"</span> })
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">CartContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{contextValue}</span>&gt;</span>
      {children}
    <span class="hljs-tag">&lt;/<span class="hljs-name">CartContext.Provider</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 步骤 4：消费全局状态的组件</span>
<span class="hljs-comment">// 组件 1：商品列表（添加商品到购物车）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">ProductList</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { addItem } = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">CartContext</span>);

  <span class="hljs-comment">// 模拟商品数据</span>
  <span class="hljs-keyword">const</span> products = [
    { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"React 实战教程"</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">99</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"Vue 实战教程"</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">89</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"TypeScript 教程"</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">79</span> }
  ];

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>商品列表<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">display:</span> "<span class="hljs-attr">flex</span>", <span class="hljs-attr">gap:</span> "<span class="hljs-attr">20px</span>", <span class="hljs-attr">margin:</span> "<span class="hljs-attr">10px</span> <span class="hljs-attr">0</span>" }}&gt;</span>
        {products.map(product =&gt; (
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{product.id}</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">border:</span> "<span class="hljs-attr">1px</span> <span class="hljs-attr">solid</span> #<span class="hljs-attr">ccc</span>", <span class="hljs-attr">padding:</span> "<span class="hljs-attr">10px</span>" }}&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{product.name}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>价格：{product.price} 元<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> addItem(product)}&gt;加入购物车<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        ))}
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 组件 2：购物车（展示/删除/清空商品）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Cart</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { cartState, removeItem, clearCart } = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">CartContext</span>);

  <span class="hljs-comment">// 计算总价格</span>
  <span class="hljs-keyword">const</span> totalPrice = cartState.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">total, item</span>) =&gt;</span> {
    <span class="hljs-keyword">return</span> total + item.<span class="hljs-property">price</span> * item.<span class="hljs-property">count</span>;
  }, <span class="hljs-number">0</span>);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">marginTop:</span> "<span class="hljs-attr">20px</span>", <span class="hljs-attr">border:</span> "<span class="hljs-attr">1px</span> <span class="hljs-attr">solid</span> #<span class="hljs-attr">ccc</span>", <span class="hljs-attr">padding:</span> "<span class="hljs-attr">20px</span>" }}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>购物车（{cartState.length} 种商品）<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      {cartState.length === 0 ? (
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>购物车为空<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      ) : (
        <span class="hljs-tag">&lt;&gt;</span>
          {cartState.map(item =&gt; (
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{item.id}</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">display:</span> "<span class="hljs-attr">flex</span>", <span class="hljs-attr">gap:</span> "<span class="hljs-attr">10px</span>", <span class="hljs-attr">margin:</span> "<span class="hljs-attr">10px</span> <span class="hljs-attr">0</span>" }}&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{item.name} × {item.count}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{item.price * item.count} 元<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> removeItem(item.id)}&gt;删除<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          ))}
          <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>总价：{totalPrice} 元<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{clearCart}</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">marginTop:</span> "<span class="hljs-attr">10px</span>" }}&gt;</span>清空购物车<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;/&gt;</span></span>
      )}
    &lt;/div&gt;
  );
}

<span class="hljs-comment">// 根组件</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">CartProvider</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">padding:</span> "<span class="hljs-attr">20px</span>" }}&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>全局购物车管理（Context+useReducer）<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ProductList</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Cart</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">CartProvider</span>&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-14">2. 生态主流：Redux Toolkit（适合大型复杂应用）</h3>
<p>Redux 是 React 生态中最成熟的全局状态管理库，而 Redux Toolkit（RTK）是官方推荐的 Redux 简化方案（解决了原生 Redux 代码繁琐、配置复杂的问题）。</p>
<p>核心优势：<strong>状态集中管理、可预测性强、支持中间件（如异步请求）、调试工具完善</strong>，适合大型应用中多团队协作、复杂状态逻辑的场景。</p>
<h4 data-id="heading-15">核心概念与使用步骤（简化）</h4>
<ol start="7">
<li>安装依赖：<code>npm install @reduxjs/toolkit react-redux</code>；</li>
<li>创建切片（Slice）：用 <code>createSlice</code> 定义状态初始值、reducer 函数（同步/异步）；</li>
<li>创建 Store：用 <code>configureStore</code> 整合所有切片；</li>
<li>提供 Store：用 <code>Provider</code>（来自 react-redux）包裹根组件；</li>
<li>消费 Store：用 <code>useSelector</code> 获取状态，用 <code>useDispatch</code> 触发状态更新。</li>
</ol>
<h4 data-id="heading-16">实战案例：Redux Toolkit 实现购物车</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 安装依赖后，创建切片（src/features/cart/cartSlice.js）</span>
<span class="hljs-keyword">import</span> { createSlice, createAsyncThunk } <span class="hljs-keyword">from</span> <span class="hljs-string">'@reduxjs/toolkit'</span>;

<span class="hljs-comment">// 模拟异步请求：从接口获取商品数据（异步 action）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> fetchProducts = <span class="hljs-title function_">createAsyncThunk</span>(
  <span class="hljs-string">'cart/fetchProducts'</span>,
  <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://api.example.com/products'</span>);
    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">json</span>();
  }
);

<span class="hljs-comment">// 创建切片</span>
<span class="hljs-keyword">const</span> cartSlice = <span class="hljs-title function_">createSlice</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'cart'</span>, <span class="hljs-comment">// 切片名称（唯一）</span>
  <span class="hljs-attr">initialState</span>: {
    <span class="hljs-attr">products</span>: [], <span class="hljs-comment">// 商品列表</span>
    <span class="hljs-attr">cartItems</span>: [], <span class="hljs-comment">// 购物车商品</span>
    <span class="hljs-attr">loading</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 加载状态</span>
    <span class="hljs-attr">error</span>: <span class="hljs-literal">null</span> <span class="hljs-comment">// 错误信息</span>
  },
  <span class="hljs-attr">reducers</span>: {
    <span class="hljs-comment">// 同步 action：添加商品到购物车</span>
    <span class="hljs-attr">addToCart</span>: <span class="hljs-function">(<span class="hljs-params">state, action</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> existingItem = state.<span class="hljs-property">cartItems</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">id</span> === action.<span class="hljs-property">payload</span>.<span class="hljs-property">id</span>);
      <span class="hljs-keyword">if</span> (existingItem) {
        existingItem.<span class="hljs-property">count</span> += <span class="hljs-number">1</span>;
      } <span class="hljs-keyword">else</span> {
        state.<span class="hljs-property">cartItems</span>.<span class="hljs-title function_">push</span>({ ...action.<span class="hljs-property">payload</span>, <span class="hljs-attr">count</span>: <span class="hljs-number">1</span> });
      }
    },
    <span class="hljs-comment">// 同步 action：从购物车删除商品</span>
    <span class="hljs-attr">removeFromCart</span>: <span class="hljs-function">(<span class="hljs-params">state, action</span>) =&gt;</span> {
      state.<span class="hljs-property">cartItems</span> = state.<span class="hljs-property">cartItems</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">id</span> !== action.<span class="hljs-property">payload</span>);
    },
    <span class="hljs-comment">// 同步 action：清空购物车</span>
    <span class="hljs-attr">clearCart</span>: <span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> {
      state.<span class="hljs-property">cartItems</span> = [];
    }
  },
  <span class="hljs-comment">// 处理异步 action 的状态（pending/fulfilled/rejected）</span>
  <span class="hljs-attr">extraReducers</span>: <span class="hljs-function">(<span class="hljs-params">builder</span>) =&gt;</span> {
    builder
      .<span class="hljs-title function_">addCase</span>(fetchProducts.<span class="hljs-property">pending</span>, <span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> {
        state.<span class="hljs-property">loading</span> = <span class="hljs-literal">true</span>;
      })
      .<span class="hljs-title function_">addCase</span>(fetchProducts.<span class="hljs-property">fulfilled</span>, <span class="hljs-function">(<span class="hljs-params">state, action</span>) =&gt;</span> {
        state.<span class="hljs-property">loading</span> = <span class="hljs-literal">false</span>;
        state.<span class="hljs-property">products</span> = action.<span class="hljs-property">payload</span>;
      })
      .<span class="hljs-title function_">addCase</span>(fetchProducts.<span class="hljs-property">rejected</span>, <span class="hljs-function">(<span class="hljs-params">state, action</span>) =&gt;</span> {
        state.<span class="hljs-property">loading</span> = <span class="hljs-literal">false</span>;
        state.<span class="hljs-property">error</span> = action.<span class="hljs-property">error</span>.<span class="hljs-property">message</span>;
      });
  }
});

<span class="hljs-comment">// 导出同步 action</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> { addToCart, removeFromCart, clearCart } = cartSlice.<span class="hljs-property">actions</span>;

<span class="hljs-comment">// 导出 reducer</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> cartSlice.<span class="hljs-property">reducer</span>;

<span class="hljs-comment">// 2. 创建 Store（src/app/store.js）</span>
<span class="hljs-keyword">import</span> { configureStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@reduxjs/toolkit'</span>;
<span class="hljs-keyword">import</span> cartReducer <span class="hljs-keyword">from</span> <span class="hljs-string">'../features/cart/cartSlice'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> store = <span class="hljs-title function_">configureStore</span>({
  <span class="hljs-attr">reducer</span>: {
    <span class="hljs-attr">cart</span>: cartReducer <span class="hljs-comment">// 整合 cart 切片</span>
  }
});

<span class="hljs-comment">// 3. 根组件提供 Store（src/App.js）</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Provider</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-redux'</span>;
<span class="hljs-keyword">import</span> { store } <span class="hljs-keyword">from</span> <span class="hljs-string">'./app/store'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ProductList</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./features/cart/ProductList'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Cart</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./features/cart/Cart'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span> <span class="hljs-attr">store</span>=<span class="hljs-string">{store}</span>&gt;</span> {/* 提供 Store */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">padding:</span> "<span class="hljs-attr">20px</span>" }}&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>Redux Toolkit 购物车<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ProductList</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Cart</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 4. 消费 Store：商品列表组件（src/features/cart/ProductList.js）</span>
<span class="hljs-keyword">import</span> { useDispatch, useSelector } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-redux'</span>;
<span class="hljs-keyword">import</span> { fetchProducts, addToCart } <span class="hljs-keyword">from</span> <span class="hljs-string">'./cartSlice'</span>;
<span class="hljs-keyword">import</span> { useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">ProductList</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> dispatch = <span class="hljs-title function_">useDispatch</span>();
  <span class="hljs-keyword">const</span> { products, loading, error } = <span class="hljs-title function_">useSelector</span>(<span class="hljs-function"><span class="hljs-params">state</span> =&gt;</span> state.<span class="hljs-property">cart</span>);

  <span class="hljs-comment">// 组件挂载时获取商品数据</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">dispatch</span>(<span class="hljs-title function_">fetchProducts</span>());
  }, [dispatch]);

  <span class="hljs-keyword">if</span> (loading) <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>;
  <span class="hljs-keyword">if</span> (error) <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>错误：{error}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>;

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>商品列表<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">display:</span> "<span class="hljs-attr">flex</span>", <span class="hljs-attr">gap:</span> "<span class="hljs-attr">20px</span>", <span class="hljs-attr">margin:</span> "<span class="hljs-attr">10px</span> <span class="hljs-attr">0</span>" }}&gt;</span>
        {products.map(product =&gt; (
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{product.id}</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">border:</span> "<span class="hljs-attr">1px</span> <span class="hljs-attr">solid</span> #<span class="hljs-attr">ccc</span>", <span class="hljs-attr">padding:</span> "<span class="hljs-attr">10px</span>" }}&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{product.name}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>价格：{product.price} 元<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> dispatch(addToCart(product))}&gt;加入购物车<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        ))}
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">ProductList</span>;

<span class="hljs-comment">// 5. 消费 Store：购物车组件（src/features/cart/Cart.js）</span>
<span class="hljs-keyword">import</span> { useDispatch, useSelector } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-redux'</span>;
<span class="hljs-keyword">import</span> { removeFromCart, clearCart } <span class="hljs-keyword">from</span> <span class="hljs-string">'./cartSlice'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Cart</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> dispatch = <span class="hljs-title function_">useDispatch</span>();
  <span class="hljs-keyword">const</span> { cartItems } = <span class="hljs-title function_">useSelector</span>(<span class="hljs-function"><span class="hljs-params">state</span> =&gt;</span> state.<span class="hljs-property">cart</span>);

  <span class="hljs-keyword">const</span> totalPrice = cartItems.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">total, item</span>) =&gt;</span> {
    <span class="hljs-keyword">return</span> total + item.<span class="hljs-property">price</span> * item.<span class="hljs-property">count</span>;
  }, <span class="hljs-number">0</span>);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">marginTop:</span> "<span class="hljs-attr">20px</span>", <span class="hljs-attr">border:</span> "<span class="hljs-attr">1px</span> <span class="hljs-attr">solid</span> #<span class="hljs-attr">ccc</span>", <span class="hljs-attr">padding:</span> "<span class="hljs-attr">20px</span>" }}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>购物车（{cartItems.length} 种商品）<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      {cartItems.length === 0 ? (
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>购物车为空<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      ) : (
        <span class="hljs-tag">&lt;&gt;</span>
          {cartItems.map(item =&gt; (
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{item.id}</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">display:</span> "<span class="hljs-attr">flex</span>", <span class="hljs-attr">gap:</span> "<span class="hljs-attr">10px</span>", <span class="hljs-attr">margin:</span> "<span class="hljs-attr">10px</span> <span class="hljs-attr">0</span>" }}&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{item.name} × {item.count}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{item.price * item.count} 元<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> dispatch(removeFromCart(item.id))}&gt;删除<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          ))}
          <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>总价：{totalPrice} 元<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> dispatch(clearCart())} style={{ marginTop: "10px" }}&gt;清空购物车<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;/&gt;</span></span>
      )}
    &lt;/div&gt;
  );
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Cart</span>;
</code></pre>
<h3 data-id="heading-17">3. 轻量方案：Zustand（适合中小型应用，简洁高效）</h3>
<p>如果觉得 Redux Toolkit 配置还是繁琐，而 Context+useReducer 在复杂场景下不够灵活，可以选择 Zustand——一个轻量级的全局状态管理库，API 简洁，无需过多配置，深受 React 开发者喜爱。</p>
<p>核心优势：<strong>代码简洁、学习成本低、无需 Provider 包裹、支持中间件（异步请求、持久化等）</strong> ，适合中小型应用或对开发效率有要求的场景。</p>
<h4 data-id="heading-18">实战案例：Zustand 实现购物车</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 安装依赖：npm install zustand</span>
<span class="hljs-keyword">import</span> { create } <span class="hljs-keyword">from</span> <span class="hljs-string">'zustand'</span>;
<span class="hljs-keyword">import</span> { useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-comment">// 2. 创建 Store</span>
<span class="hljs-keyword">const</span> useCartStore = <span class="hljs-title function_">create</span>(<span class="hljs-function">(<span class="hljs-params">set</span>) =&gt;</span> ({
  <span class="hljs-comment">// 状态</span>
  <span class="hljs-attr">products</span>: [],
  <span class="hljs-attr">cartItems</span>: [],
  <span class="hljs-attr">loading</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">error</span>: <span class="hljs-literal">null</span>,

  <span class="hljs-comment">// 异步 action：获取商品数据</span>
  <span class="hljs-attr">fetchProducts</span>: <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-title function_">set</span>({ <span class="hljs-attr">loading</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">error</span>: <span class="hljs-literal">null</span> });
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://api.example.com/products'</span>);
      <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> res.<span class="hljs-title function_">json</span>();
      <span class="hljs-title function_">set</span>({ <span class="hljs-attr">products</span>: data, <span class="hljs-attr">loading</span>: <span class="hljs-literal">false</span> });
    } <span class="hljs-keyword">catch</span> (err) {
      <span class="hljs-title function_">set</span>({ <span class="hljs-attr">error</span>: err.<span class="hljs-property">message</span>, <span class="hljs-attr">loading</span>: <span class="hljs-literal">false</span> });
    }
  },

  <span class="hljs-comment">// 同步 action：添加商品到购物车</span>
  <span class="hljs-attr">addToCart</span>: <span class="hljs-function">(<span class="hljs-params">product</span>) =&gt;</span> {
    <span class="hljs-title function_">set</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> existingItem = state.<span class="hljs-property">cartItems</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">id</span> === product.<span class="hljs-property">id</span>);
      <span class="hljs-keyword">if</span> (existingItem) {
        <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">cartItems</span>: state.<span class="hljs-property">cartItems</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> 
            item.<span class="hljs-property">id</span> === product.<span class="hljs-property">id</span> ? { ...item, <span class="hljs-attr">count</span>: item.<span class="hljs-property">count</span> + <span class="hljs-number">1</span> } : item
          )
        };
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> { <span class="hljs-attr">cartItems</span>: [...state.<span class="hljs-property">cartItems</span>, { ...product, <span class="hljs-attr">count</span>: <span class="hljs-number">1</span> }] };
      }
    });
  },

  <span class="hljs-comment">// 同步 action：删除商品</span>
  <span class="hljs-attr">removeFromCart</span>: <span class="hljs-function">(<span class="hljs-params">id</span>) =&gt;</span> {
    <span class="hljs-title function_">set</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> ({
      <span class="hljs-attr">cartItems</span>: state.<span class="hljs-property">cartItems</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">id</span> !== id)
    }));
  },

  <span class="hljs-comment">// 同步 action：清空购物车</span>
  <span class="hljs-attr">clearCart</span>: <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">set</span>({ <span class="hljs-attr">cartItems</span>: [] });
  }
}));

<span class="hljs-comment">// 3. 商品列表组件</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">ProductList</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 从 Store 获取状态和方法</span>
  <span class="hljs-keyword">const</span> { products, loading, error, fetchProducts, addToCart } = <span class="hljs-title function_">useCartStore</span>();

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">fetchProducts</span>();
  }, [fetchProducts]);

  <span class="hljs-keyword">if</span> (loading) <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>;
  <span class="hljs-keyword">if</span> (error) <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>错误：{error}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>;

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>商品列表（Zustand）<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">display:</span> "<span class="hljs-attr">flex</span>", <span class="hljs-attr">gap:</span> "<span class="hljs-attr">20px</span>", <span class="hljs-attr">margin:</span> "<span class="hljs-attr">10px</span> <span class="hljs-attr">0</span>" }}&gt;</span>
        {products.map(product =&gt; (
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{product.id}</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">border:</span> "<span class="hljs-attr">1px</span> <span class="hljs-attr">solid</span> #<span class="hljs-attr">ccc</span>", <span class="hljs-attr">padding:</span> "<span class="hljs-attr">10px</span>" }}&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{product.name}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>价格：{product.price} 元<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> addToCart(product)}&gt;加入购物车<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        ))}
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 4. 购物车组件</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Cart</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 从 Store 获取状态和方法</span>
  <span class="hljs-keyword">const</span> { cartItems, removeFromCart, clearCart } = <span class="hljs-title function_">useCartStore</span>();

  <span class="hljs-keyword">const</span> totalPrice = cartItems.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">total, item</span>) =&gt;</span> {
    <span class="hljs-keyword">return</span> total + item.<span class="hljs-property">price</span> * item.<span class="hljs-property">count</span>;
  }, <span class="hljs-number">0</span>);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">marginTop:</span> "<span class="hljs-attr">20px</span>", <span class="hljs-attr">border:</span> "<span class="hljs-attr">1px</span> <span class="hljs-attr">solid</span> #<span class="hljs-attr">ccc</span>", <span class="hljs-attr">padding:</span> "<span class="hljs-attr">20px</span>" }}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>购物车（{cartItems.length} 种商品）<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      {cartItems.length === 0 ? (
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>购物车为空<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      ) : (
        <span class="hljs-tag">&lt;&gt;</span>
          {cartItems.map(item =&gt; (
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{item.id}</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">display:</span> "<span class="hljs-attr">flex</span>", <span class="hljs-attr">gap:</span> "<span class="hljs-attr">10px</span>", <span class="hljs-attr">margin:</span> "<span class="hljs-attr">10px</span> <span class="hljs-attr">0</span>" }}&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{item.name} × {item.count}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{item.price * item.count} 元<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> removeFromCart(item.id)}&gt;删除<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          ))}
          <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>总价：{totalPrice} 元<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{clearCart}</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">marginTop:</span> "<span class="hljs-attr">10px</span>" }}&gt;</span>清空购物车<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;/&gt;</span></span>
      )}
    &lt;/div&gt;
  );
}

<span class="hljs-comment">// 5. 根组件</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">padding:</span> "<span class="hljs-attr">20px</span>" }}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>Zustand 购物车<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ProductList</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Cart</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h2 data-id="heading-19">四、全局状态管理方案对比与选择建议</h2>
<p>为了让大家能根据项目规模和需求选择合适的方案，我们用表格对比常用的 3 种全局状态管理方案：</p>





























<table><thead><tr><th>方案</th><th>核心优势</th><th>劣势</th><th>适用场景</th></tr></thead><tbody><tr><td>Context+useReducer</td><td>1. 原生方案，无需额外安装依赖；2. 实现简单，学习成本低；3. 轻量无冗余</td><td>1. 不支持中间件，处理异步逻辑繁琐；2. 状态更新会触发所有消费组件重渲染（需配合 memo 优化）；3. 不适合复杂状态逻辑</td><td>中小型应用、简单全局状态（如主题、登录状态）</td></tr><tr><td>Redux Toolkit</td><td>1. 状态集中管理，可预测性强；2. 支持中间件（异步、日志等）；3. 调试工具完善；4. 适合多团队协作</td><td>1. 配置相对繁琐，学习成本高；2. 代码量较多；3. 轻量应用可能显得过重</td><td>大型复杂应用、多团队协作、复杂状态逻辑（如电商、后台管理系统）</td></tr><tr><td>Zustand</td><td>1. API 简洁，学习成本低；2. 无需 Provider 包裹；3. 支持中间件，处理异步简单；4. 性能优秀（精准更新）</td><td>1. 生态不如 Redux 完善；2. 大型复杂应用的协作规范不如 Redux 成熟</td><td>中小型应用、对开发效率有要求的场景、需要轻量方案替代 Context+useReducer</td></tr></tbody></table>
<h2 data-id="heading-20">五、核心总结与避坑指南</h2>
<h3 data-id="heading-21">核心总结</h3>
<ol start="7">
<li><strong>组件传参遵循“就近原则”</strong> ：父子/兄弟组件用 props+回调，跨层级用 Context API，全局共享用专门的状态管理方案；</li>
<li><strong>全局状态管理“按需选择”</strong> ：小型应用用 Context+useReducer，中型用 Zustand，大型复杂应用用 Redux Toolkit；</li>
<li><strong>props 是只读的</strong>：子组件不能直接修改 props，需通过回调让父组件更新，避免破坏单向数据流；</li>
<li><strong>避免过度设计</strong>：不要一开始就用全局状态，先尝试局部传参，当局部传参无法满足需求时再引入全局状态。</li>
</ol>
<h3 data-id="heading-22">避坑指南</h3>
<ul>
<li><strong>坑 1：滥用 Context API</strong>：Context 会导致所有消费组件在状态更新时重渲染，若状态更新频繁，需配合 memo、useMemo 优化；</li>
<li><strong>坑 2：Redux 过度使用</strong>：不是所有状态都需要放入 Redux，局部状态（如组件内部的表单输入）用 useState 即可；</li>
<li><strong>坑 3：列表渲染忘记加 key</strong>：传参时若涉及列表渲染，务必给列表项加唯一 key，避免 React 误判节点导致性能问题；</li>
<li><strong>坑 4：直接修改状态</strong>：无论是局部状态还是全局状态，都要遵循“不可变更新”原则（如用扩展运算符、map 等方法创建新状态），避免直接修改原状态。</li>
</ul>
<h2 data-id="heading-23">六、下一步学习方向</h2>
<p>今天我们掌握了 React 19 组件传参与全局状态管理的核心方案，下一步可以重点学习：</p>
<ul>
<li>状态管理性能优化：如 memo、useMemo、useCallback 与状态管理的配合使用；</li>
<li>其他轻量状态管理库：如 Jotai、Recoil（原子化状态管理，适合细粒度状态共享）；</li>
<li>Redux 高级特性：如中间件（redux-thunk、redux-saga）、状态持久化（redux-persist）；</li>
<li>React 19 新增状态相关特性：如 useOptimistic（乐观更新）、useActionState（表单状态管理）。</li>
</ul>
<p>如果这篇文章对你有帮助，欢迎点赞、收藏、转发～ 有任何问题也可以在评论区留言交流～ 我们下期再见！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[PHP 8.5 #[\NoDiscard] 揪出"忽略返回值"的 Bug]]></title>    <link>https://juejin.cn/post/7592815497848455231</link>    <guid>https://juejin.cn/post/7592815497848455231</guid>    <pubDate>2026-01-08T23:24:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592815497848455231" data-draft-id="7592865044691550214" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="PHP 8.5 #[\NoDiscard] 揪出&quot;忽略返回值&quot;的 Bug"/> <meta itemprop="keywords" content="后端,PHP"/> <meta itemprop="datePublished" content="2026-01-08T23:24:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="BingoGo"/> <meta itemprop="url" content="https://juejin.cn/user/993614242266077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            PHP 8.5 #[\NoDiscard] 揪出"忽略返回值"的 Bug
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/993614242266077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    BingoGo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T23:24:35.000Z" title="Thu Jan 08 2026 23:24:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">PHP 8.5 #[\NoDiscard] 揪出"忽略返回值"的 Bug</h2>
<p>有些 bug 会导致异常、致命错误、监控面板一片红。</p>
<p>还有一类 bug 长这样："一切都跑了，但什么都没发生"。方法调了，副作用也有了，但关键返回值（成功标志、错误列表、新的不可变实例）被扔掉了。粗看代码没毛病，测试没覆盖到边界情况也能过。bug 就这么混进生产环境。</p>
<p>PHP 一直允许这种风格的失误：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-title function_ invoke__">doSomethingImportant</span>(); <span class="hljs-comment">// 返回了一个值……但没人用</span>
</code></pre>
<p>PHP 8.5 新增了一种原生方式来标记这类情况：<code>#[\NoDiscard]</code>。</p>
<p>给函数或方法加上 <code>#[\NoDiscard]</code>，调用方要是不用返回值，PHP 就会发警告。可以把它理解为"编译器级别的提示"（实际由引擎在运行时/编译时执行），不抛异常、不改行为，只是让 API 更安全。</p>
<p>本文讲的是怎么用好 <code>#[\NoDiscard]</code>：</p>
<ul>
<li>它能防哪些 bug</li>
<li>具体语义（什么算"用了"返回值）</li>
<li>高价值模式：Result / Either、不可变构建器</li>
<li>怎么推广才不会让团队反感</li>
<li>什么时候别用（误报确实存在）</li>
</ul>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcatchadmin.com%2Fpost%2F2026-01%2Fphp85-nodiscard-catch-ignored-return-value-bugs" target="_blank" title="https://catchadmin.com/post/2026-01/php85-nodiscard-catch-ignored-return-value-bugs" ref="nofollow noopener noreferrer">原文 PHP 8.5 #[\NoDiscard] 揪出"忽略返回值"的 Bug</a></p>
<h3 data-id="heading-1">常见"惯犯"：返回值被忽略的几种场景</h3>
<p>PHP 代码库里有几个常见的"惯犯"。</p>
<h4 data-id="heading-2">返回布尔值，默认它总是成功</h4>
<p>典型案例：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$ok</span> = <span class="hljs-title function_ invoke__">rename</span>(<span class="hljs-variable">$tmpFile</span>, <span class="hljs-variable">$finalFile</span>);
</code></pre>
<p>有人重构，赋值没了：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-title function_ invoke__">rename</span>(<span class="hljs-variable">$tmpFile</span>, <span class="hljs-variable">$finalFile</span>);
<span class="hljs-comment">// 继续跑，当作移动成功了</span>
</code></pre>
<p>开发环境没事。生产环境碰上权限边界情况，你读的文件压根没移动过。</p>
<p>不是每个返回布尔值的函数都该标 <code>#[\NoDiscard]</code>。但你自己的 API 里，如果返回值有意义，忽略它至少该引起警觉。</p>
<h4 data-id="heading-3">返回错误信息，但正常路径太常见，失败没人注意</h4>
<p>批处理是重灾区：99.9% 成功，忽略返回值不会破坏大多数运行。</p>
<p>典型场景：</p>
<ul>
<li>函数处理多个条目</li>
<li>返回每个条目的错误详情</li>
<li>副作用照常发生</li>
<li>忽略返回值 = 部分失败被藏起来了</li>
</ul>
<p>官方 RFC 就是用这个逻辑来解释 <code>#[\NoDiscard]</code> 的设计动机。</p>
<h4 data-id="heading-4">不可变 API 返回新实例，调用却像在原地改</h4>
<p>这种情况很微妙，从可变对象迁移到不可变对象时特别常见。</p>
<p>你写了个不可变的"更新"方法：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$user</span> = <span class="hljs-variable">$user</span>-&gt;<span class="hljs-title function_ invoke__">withEmail</span>(<span class="hljs-variable">$newEmail</span>);
</code></pre>
<p>后来有人写成：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$user</span>-&gt;<span class="hljs-title function_ invoke__">withEmail</span>(<span class="hljs-variable">$newEmail</span>);
<span class="hljs-comment">// 以为 $user 变了……其实没变</span>
</code></pre>
<p>没报错，没异常，状态就是静悄悄地没变。</p>
<p>RFC 明确提到 <code>DateTimeImmutable::set*()</code> 就是典型："听起来像原地修改，实际返回新实例"。</p>
<h4 data-id="heading-5">返回 Result 对象，但忘了解包检查</h4>
<p>如果你用 Result 类型（或 Either）来避免异常，忽略返回值基本就是忽略了错误。</p>
<p>不一定马上出问题——但错误处理被推到了"以后再说"，而"以后"往往等于"永远不"。</p>
<h3 data-id="heading-6">#[\NoDiscard] 是什么</h3>
<p>简单说，<code>#[\NoDiscard]</code> 是加在函数和方法上的属性，意思是：</p>
<p><strong>"调用了却不用返回值？多半是 bug。"</strong></p>
<p>最简用法：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">#[\NoDiscard</span><span class="hljs-meta">]</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createSession</span>(<span class="hljs-params"/>): <span class="hljs-title">string</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">bin2hex</span>(<span class="hljs-title function_ invoke__">random_bytes</span>(<span class="hljs-number">16</span>));
}

<span class="hljs-title function_ invoke__">createSession</span>(); <span class="hljs-comment">// PHP 8.5 中会产生警告</span>
</code></pre>
<p>RFC 和 PHP 手册里定义了具体行为：</p>
<ul>
<li>调用 <code>#[\NoDiscard]</code> 函数但没用返回值，PHP 发警告</li>
<li>内置函数发 <code>E_WARNING</code>；用户定义函数发 <code>E_USER_WARNING</code></li>
<li>可以带消息：<code>#[\NoDiscard("…")]</code>，消息会出现在警告里（跟 <code>#[Deprecated]</code> 类似）</li>
</ul>
<h4 data-id="heading-7">什么算"用了"？</h4>
<p>最关键的细节："用了"是语法层面的判断，不是语义层面的。</p>
<p>RFC 对"用了返回值"的定义很宽松：返回值只要成为任意表达式的一部分就行。赋值给变量——哪怕是个哑变量——算。类型转换也算。</p>
<p>所以下面这些都算"用了"：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$unusedButAssigned</span> = <span class="hljs-title function_ invoke__">createSession</span>(); <span class="hljs-comment">// 无警告</span>
(<span class="hljs-keyword">bool</span>) <span class="hljs-title function_ invoke__">createSession</span>();               <span class="hljs-comment">// 无警告（但见下面关于 OPcache 的说明）</span>
</code></pre>
<p>也就是说 <code>#[\NoDiscard]</code> 不保证行为正确，只保证你没把结果直接扔地上。</p>
<h4 data-id="heading-8">(void) 强制转换：显式丢弃</h4>
<p>PHP 8.5 还引入了 <code>(void)</code> 强制转换：</p>
<pre><code class="hljs language-php" lang="php">(<span class="hljs-keyword">void</span>) <span class="hljs-title function_ invoke__">createSession</span>(); <span class="hljs-comment">// 无警告</span>
</code></pre>
<p>没有运行时效果，纯粹表明意图："是的，我故意不用它。"可以用来抑制 <code>#[\NoDiscard]</code> 警告，IDE 和静态分析工具也能识别。</p>
<p>RFC 里有个细节：<code>(void)</code> 是语句不是表达式，不能嵌到其他表达式里，否则语法错误。</p>
<h4 data-id="heading-9">使用约束</h4>
<p>RFC 规定这些情况会编译报错：</p>
<ul>
<li>返回类型是 <code>: void</code> 或 <code>: never</code> 的函数</li>
<li>必须是 void / 无返回的魔术方法（<code>__construct</code>、<code>__clone</code> 等）</li>
<li>属性钩子</li>
</ul>
<p>所以这样写会报错：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">#[\NoDiscard</span><span class="hljs-meta">]</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">logSomething</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$msg</span></span>): <span class="hljs-title">void</span> </span>{
    <span class="hljs-title function_ invoke__">error_log</span>(<span class="hljs-variable">$msg</span>);
}
<span class="hljs-comment">// Fatal: void 函数不返回值，但 #[\NoDiscard] 要求有返回值</span>
</code></pre>
<p>这是故意的：没东西可丢弃，这个属性就没意义。</p>
<h4 data-id="heading-10">锐边：警告可能变致命错误</h4>
<p>大多数团队把警告当噪音。有些团队把警告转成异常（严格环境里常见）。</p>
<p>RFC 指出，引擎在调用函数之前（参数求值之后）就验证"返回值有没有被用"。如果你配了个会抛异常的错误处理器，警告一触发就抛异常，函数压根不会被调用——RFC 把这叫"fail-closed"行为。</p>
<p>对 <code>#[\NoDiscard]</code> 函数来说，这通常是好事（忽略返回值本来就不安全），但如果函数有重要副作用，你得心里有数。</p>
<h3 data-id="heading-11">实用示例</h3>
<p>看看实际怎么用。下面这些模式是 <code>#[\NoDiscard]</code> 真正能发挥价值的地方。</p>
<h4 data-id="heading-12">Result 类型</h4>
<p>一个最小化的 Result 实现：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">declare</span>(strict_types=<span class="hljs-number">1</span>);

<span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Result</span>
</span>{
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params">
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">bool</span> <span class="hljs-variable">$ok</span>,
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">mixed</span> <span class="hljs-variable">$value</span>,
        <span class="hljs-keyword">private</span> ?<span class="hljs-keyword">string</span> <span class="hljs-variable">$error</span>,
    </span>) </span>{}

    <span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ok</span>(<span class="hljs-params"><span class="hljs-keyword">mixed</span> <span class="hljs-variable">$value</span> = <span class="hljs-literal">null</span></span>): <span class="hljs-title">self</span>
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">self</span>(<span class="hljs-literal">true</span>, <span class="hljs-variable">$value</span>, <span class="hljs-literal">null</span>);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">err</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$error</span></span>): <span class="hljs-title">self</span>
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">self</span>(<span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>, <span class="hljs-variable">$error</span>);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isOk</span>(<span class="hljs-params"/>): <span class="hljs-title">bool</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;ok; }
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isErr</span>(<span class="hljs-params"/>): <span class="hljs-title">bool</span> </span>{ <span class="hljs-keyword">return</span> !<span class="hljs-variable language_">$this</span>-&gt;ok; }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">unwrap</span>(<span class="hljs-params"/>): <span class="hljs-title">mixed</span>
    </span>{
        <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">$this</span>-&gt;ok) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(<span class="hljs-variable language_">$this</span>-&gt;error ?? <span class="hljs-string">'Unknown error'</span>);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;value;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">error</span>(<span class="hljs-params"/>): ?<span class="hljs-title">string</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;error; }
}
</code></pre>
<p>假设有个验证函数返回 Result：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">#[\NoDiscard</span>(<span class="hljs-string">"Validation results must be handled (ok/err)"</span>)<span class="hljs-meta">]</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">validateUsername</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$name</span></span>): <span class="hljs-title">Result</span>
</span>{
    <span class="hljs-variable">$name</span> = <span class="hljs-title function_ invoke__">trim</span>(<span class="hljs-variable">$name</span>);
    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$name</span> === <span class="hljs-string">''</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Result</span>::<span class="hljs-title function_ invoke__">err</span>(<span class="hljs-string">"Username cannot be empty."</span>);
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$name</span>) &lt; <span class="hljs-number">3</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Result</span>::<span class="hljs-title function_ invoke__">err</span>(<span class="hljs-string">"Username is too short."</span>);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Result</span>::<span class="hljs-title function_ invoke__">ok</span>(<span class="hljs-variable">$name</span>);
}
</code></pre>
<p>这样调用会触发警告：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-title function_ invoke__">validateUsername</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'username'</span>] ?? <span class="hljs-string">''</span>);
</code></pre>
<p>这就是你想要的效果：用了 Result 模式，忽略它几乎肯定是写错了。</p>
<p>正确的写法变成显式的：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$res</span> = <span class="hljs-title function_ invoke__">validateUsername</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'username'</span>] ?? <span class="hljs-string">''</span>);
<span class="hljs-keyword">if</span> (<span class="hljs-variable">$res</span>-&gt;<span class="hljs-title function_ invoke__">isErr</span>()) {
    <span class="hljs-title function_ invoke__">http_response_code</span>(<span class="hljs-number">422</span>);
    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$res</span>-&gt;<span class="hljs-title function_ invoke__">error</span>();
    <span class="hljs-keyword">exit</span>;
}
<span class="hljs-variable">$username</span> = <span class="hljs-variable">$res</span>-&gt;<span class="hljs-title function_ invoke__">unwrap</span>();
</code></pre>
<p>开发者还能写 <code>$_ = validateUsername(...)</code> 然后不管它吗？能，PHP 会认为"用了"。但主要的失败模式——不小心写了裸调用——被拦住了。</p>
<h4 data-id="heading-13">Either 风格</h4>
<p>有些团队喜欢更结构化的错误：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ValidationError</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> <span class="hljs-variable">$code</span>, <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> <span class="hljs-variable">$message</span></span>) </span>{}
}

<span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Either</span>
</span>{
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params">
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">bool</span> <span class="hljs-variable">$isRight</span>,
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">mixed</span> <span class="hljs-variable">$right</span>,
        <span class="hljs-keyword">public</span> ?ValidationError <span class="hljs-variable">$left</span>,
    </span>) </span>{}

    <span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">right</span>(<span class="hljs-params"><span class="hljs-keyword">mixed</span> <span class="hljs-variable">$value</span></span>): <span class="hljs-title">self</span>
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">self</span>(<span class="hljs-literal">true</span>, <span class="hljs-variable">$value</span>, <span class="hljs-literal">null</span>);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">left</span>(<span class="hljs-params">ValidationError <span class="hljs-variable">$err</span></span>): <span class="hljs-title">self</span>
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">self</span>(<span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>, <span class="hljs-variable">$err</span>);
    }
}
</code></pre>
<p>返回 Either 的函数标 <code>#[\NoDiscard]</code> 通常没问题，因为本来就是要强制调用方决定走哪个分支。</p>
<h4 data-id="heading-14">不可变构建器</h4>
<p>假设有个不可变构建器，每个方法返回新的构建器：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">declare</span>(strict_types=<span class="hljs-number">1</span>);

<span class="hljs-keyword">final</span> <span class="hljs-keyword">readonly</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InvoiceBuilder</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params">
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">array</span> <span class="hljs-variable">$lines</span> = [],
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-variable">$totalCents</span> = <span class="hljs-number">0</span>,
    </span>) </span>{}

    <span class="hljs-meta">#[\NoDiscard</span>(<span class="hljs-string">"InvoiceBuilder is immutable; you must capture the returned builder."</span>)<span class="hljs-meta">]</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">withLine</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$label</span>, <span class="hljs-keyword">int</span> <span class="hljs-variable">$amountCents</span></span>): <span class="hljs-title">self</span>
    </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$amountCents</span> &lt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">InvalidArgumentException</span>(<span class="hljs-string">'amountCents must be &gt;= 0'</span>);
        }
        <span class="hljs-variable">$newLines</span> = <span class="hljs-variable language_">$this</span>-&gt;lines;
        <span class="hljs-variable">$newLines</span>[] = [<span class="hljs-string">'label'</span> =&gt; <span class="hljs-variable">$label</span>, <span class="hljs-string">'amountCents'</span> =&gt; <span class="hljs-variable">$amountCents</span>];
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">self</span>(
            lines: <span class="hljs-variable">$newLines</span>,
            totalCents: <span class="hljs-variable language_">$this</span>-&gt;totalCents + <span class="hljs-variable">$amountCents</span>
        );
    }

    <span class="hljs-meta">#[\NoDiscard</span>(<span class="hljs-string">"Calling build() without using the invoice is almost certainly a bug."</span>)<span class="hljs-meta">]</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">build</span>(<span class="hljs-params"/>): <span class="hljs-title">array</span>
    </span>{
        <span class="hljs-keyword">return</span> [
            <span class="hljs-string">'lines'</span> =&gt; <span class="hljs-variable language_">$this</span>-&gt;lines,
            <span class="hljs-string">'totalCents'</span> =&gt; <span class="hljs-variable language_">$this</span>-&gt;totalCents,
        ];
    }
}
</code></pre>
<p>看看典型错误：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$builder</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvoiceBuilder</span>();
<span class="hljs-variable">$builder</span>-&gt;<span class="hljs-title function_ invoke__">withLine</span>(<span class="hljs-string">'Subscription'</span>, <span class="hljs-number">1500</span>);
<span class="hljs-variable">$builder</span>-&gt;<span class="hljs-title function_ invoke__">withLine</span>(<span class="hljs-string">'Support'</span>, <span class="hljs-number">500</span>);
<span class="hljs-variable">$invoice</span> = <span class="hljs-variable">$builder</span>-&gt;<span class="hljs-title function_ invoke__">build</span>();
</code></pre>
<p>没有 <code>#[\NoDiscard]</code>，这会产生一张没有行项目的发票，因为返回的构建器被扔掉了。</p>
<p>加上 <code>#[\NoDiscard]</code>，每个被忽略的 <code>withLine()</code> 返回都会触发警告，逼你写对：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$builder</span> = (<span class="hljs-keyword">new</span> <span class="hljs-title class_">InvoiceBuilder</span>())
    -&gt;<span class="hljs-title function_ invoke__">withLine</span>(<span class="hljs-string">'Subscription'</span>, <span class="hljs-number">1500</span>)
    -&gt;<span class="hljs-title function_ invoke__">withLine</span>(<span class="hljs-string">'Support'</span>, <span class="hljs-number">500</span>);
<span class="hljs-variable">$invoice</span> = <span class="hljs-variable">$builder</span>-&gt;<span class="hljs-title function_ invoke__">build</span>();
</code></pre>
<p>这就是 <code>#[\NoDiscard]</code> 要揪出来的 bug：容易犯、测试常能过、生产环境让人头疼。</p>
<h4 data-id="heading-15">PHP 自己也在用</h4>
<p>RFC 给一小部分原生 API 加了 <code>#[\NoDiscard]</code>，这些 API 忽略结果容易出隐蔽问题：</p>
<ul>
<li><code>flock()</code>（忽略锁定失败，竞争条件下可能数据损坏）</li>
<li><code>DateTimeImmutable::set*()</code>（从可变 DateTime 迁移过来时的常见坑）</li>
</ul>
<p>就算你从不直接用这些函数，这也说明一件事：这个特性针对的是真实场景里的错误，不是为了理论上的"纯粹"。</p>
<h3 data-id="heading-16">采用策略</h3>
<p>到处加 <code>#[\NoDiscard]</code> 只会制造噪音，团队迟早习惯性忽略。RFC 的建议是：只在忽略返回值可能是无意的、且会导致测试期间难以发现的 bug 的地方用。</p>
<p>务实的推广思路：</p>
<h4 data-id="heading-17">从危险的地方开始</h4>
<p>高价值场景：</p>
<ul>
<li>可能部分失败但继续执行的领域操作（批处理）</li>
<li>返回 Result / 错误列表的持久化调用</li>
<li>不可变更新方法（不可变对象上的 <code>with*</code>、<code>set*</code>）</li>
<li>用返回值表示失败的 "try" 风格 API</li>
</ul>
<p>低价值场景：</p>
<ul>
<li>纯函数（如 <code>str_contains()</code> 这类检查）：调用后什么都不做本来就奇怪，忽略返回值很少造成隐蔽问题。RFC 拿 <code>str_contains()</code> 当反面例子</li>
<li>主要靠副作用、返回值只是顺便给的方法</li>
</ul>
<h4 data-id="heading-18">让警告可见，但别炸生产</h4>
<p>引擎发的是警告（不是异常），所以可以逐步收紧：</p>
<ul>
<li>开发环境：把警告喊出来</li>
<li>CI：把 <code>E_USER_WARNING</code> 当失败（可选，过渡一段时间后）</li>
<li>生产环境：保持默认，除非你确定警告策略够严格</li>
</ul>
<p>记住：如果你们把警告转成异常，<code>#[\NoDiscard]</code> 会直接阻止函数运行（fail-closed）。有时候这是好事，但这种行为变化得有意识地引入。</p>
<h3 data-id="heading-19">代码审查集成</h3>
<p><code>#[\NoDiscard]</code> 用来强化团队规则效果最好，不是用来代替思考的。</p>
<p>下面是一套跟代码审查配合良好的简单规则：</p>
<h4 data-id="heading-20">把警告当设计信号</h4>
<p>看到 <code>#[\NoDiscard]</code> 警告，别急着"消掉它"。先问：</p>
<ul>
<li>是不小心忽略的吗？（最常见）</li>
<li>如果确实想忽略，用 <code>(void)</code> 合适吗？</li>
<li>还是说 API 返回的东西本身就有问题？</li>
</ul>
<h4 data-id="heading-21">用 (void) 表明意图</h4>
<p>比如：调用一个返回缓存键的方法，但你只要副作用：</p>
<pre><code class="hljs language-php" lang="php">(<span class="hljs-keyword">void</span>) <span class="hljs-variable">$cache</span>-&gt;<span class="hljs-title function_ invoke__">warmUp</span>(<span class="hljs-variable">$userId</span>);
</code></pre>
<p>这是干净、可读的约定：我故意丢弃这个值。</p>
<p>比下面这种写法强多了：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$unused</span> = <span class="hljs-variable">$cache</span>-&gt;<span class="hljs-title function_ invoke__">warmUp</span>(<span class="hljs-variable">$userId</span>);
</code></pre>
<p>因为 <code>$unused</code> 重构后很容易留下来，让后面的人摸不着头脑。</p>
<h4 data-id="heading-22">跟静态分析配合</h4>
<p>静态分析器和 IDE 本来就会对纯函数的未使用返回值报警。RFC 提到，PHPStorm、PHPStan、Psalm 这些工具已经能抓"纯返回值被忽略"的问题（比如 DateTimeImmutable 的坑），但它们一般没法覆盖非纯函数的重要返回值——<code>#[\NoDiscard]</code> 填的就是这个空白。</p>
<p>所以组合起来是这样：</p>
<ul>
<li>静态分析器："纯返回值没用"</li>
<li><code>#[\NoDiscard]</code>："重要返回值没用"（哪怕是非纯的）</li>
</ul>
<h3 data-id="heading-23">重构示例</h3>
<p>做个贴近真实场景的重构：一个"保存"并返回状态的方法。</p>
<h4 data-id="heading-24">之前</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserRepository</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">save</span>(<span class="hljs-params">User <span class="hljs-variable">$user</span></span>): <span class="hljs-title">bool</span>
    </span>{
        <span class="hljs-comment">// ... 写入数据库 ...</span>
        <span class="hljs-comment">// 冲突/失败时返回 false</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
}
</code></pre>
<p>调用点往往变成：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$repo</span>-&gt;<span class="hljs-title function_ invoke__">save</span>(<span class="hljs-variable">$user</span>);
<span class="hljs-comment">// 当作保存成功了</span>
</code></pre>
<p>如果返回值有意义，这就是埋着的雷。</p>
<h4 data-id="heading-25">之后</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserRepository</span>
</span>{
    <span class="hljs-meta">#[\NoDiscard</span>(<span class="hljs-string">"Save may fail; handle the return value or explicitly discard it with (void)."</span>)<span class="hljs-meta">]</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">save</span>(<span class="hljs-params">User <span class="hljs-variable">$user</span></span>): <span class="hljs-title">bool</span>
    </span>{
        <span class="hljs-comment">// ... 写入数据库 ...</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
}
</code></pre>
<p>现在，忽略它的调用点都会报警告。</p>
<h4 data-id="heading-26">更好的做法</h4>
<p>布尔值描述性不够。能改就返回 Result：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserRepository</span>
</span>{
    <span class="hljs-meta">#[\NoDiscard</span>(<span class="hljs-string">"Save may fail; callers must handle the Result."</span>)<span class="hljs-meta">]</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">save</span>(<span class="hljs-params">User <span class="hljs-variable">$user</span></span>): <span class="hljs-title">Result</span>
    </span>{
        <span class="hljs-comment">// 示例逻辑</span>
        <span class="hljs-variable">$ok</span> = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$ok</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-title class_">Result</span>::<span class="hljs-title function_ invoke__">err</span>(<span class="hljs-string">"Write failed due to conflict."</span>);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Result</span>::<span class="hljs-title function_ invoke__">ok</span>(<span class="hljs-variable">$user</span>);
    }
}
</code></pre>
<p>现在更难不小心跳过错误处理，API 也更自文档化。</p>
<h4 data-id="heading-27">确实想忽略时</h4>
<p>有些场景确实要忽略：</p>
<ul>
<li>best-effort 的缓存写入</li>
<li>遥测发送</li>
<li>顺手清理</li>
</ul>
<p>这时候 <code>(void)</code> 正合适：</p>
<pre><code class="hljs language-php" lang="php">(<span class="hljs-keyword">void</span>) <span class="hljs-variable">$repo</span>-&gt;<span class="hljs-title function_ invoke__">save</span>(<span class="hljs-variable">$user</span>); <span class="hljs-comment">// "我就是不想检查这个。"</span>
</code></pre>
<p>代码审查看着清楚，也能防止无意中"静默忽略"又混回来。</p>
<h3 data-id="heading-28">限制和误报</h3>
<p><code>#[\NoDiscard]</code> 很强大，但不是通用的"质量徽章"。用多了就是噪音，噪音会淹没信号。</p>
<h4 data-id="heading-29">别用在无害的函数上</h4>
<p>纯查询比如：</p>
<ul>
<li><code>str_contains()</code></li>
<li><code>strlen()</code></li>
<li>字符串转换辅助函数</li>
</ul>
<p>调用了却什么都不做，bug 本来就很明显：算了个东西没用，还没副作用。RFC 明确说不要在 <code>str_contains()</code> 这类函数上用 <code>#[\NoDiscard]</code>，因为忽略结果本来就不太可能，而且除了浪费点计算没啥坏处。</p>
<h4 data-id="heading-30">别用来强制编码风格</h4>
<p>你会想给很多方法标 <code>#[\NoDiscard]</code>，理由是"调用者总是接返回值更干净"。这是风格偏好，不是安全问题。</p>
<p>只在忽略返回值可能是无意的、而且有害的地方用。</p>
<h4 data-id="heading-31">注意"发射后不管"的 API</h4>
<p>有些方法返回值只是顺便给的，主要靠副作用。给它们加 <code>#[\NoDiscard]</code> 会逼调用者到处写 <code>(void)</code>，换一种杂乱而已。</p>
<p>如果你发现某个函数有一堆 <code>(void)</code>，说明属性可能加错地方了。</p>
<h4 data-id="heading-32">"用了"不等于"处理了"</h4>
<p>因为"用了"的定义很宽松，你可以满足 <code>#[\NoDiscard]</code> 但实际上什么都没处理：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$tmp</span> = <span class="hljs-variable">$repo</span>-&gt;<span class="hljs-title function_ invoke__">save</span>(<span class="hljs-variable">$user</span>); <span class="hljs-comment">// 无警告，但语义上还是忽略了</span>
</code></pre>
<p>这不是特性的缺陷——它提醒我们 <code>#[\NoDiscard]</code> 是护栏，不是完整的正确性证明。</p>
<h3 data-id="heading-33">团队命名约定</h3>
<p>好团队不会只靠属性。他们用命名约定，在警告出现之前就引导正确用法。</p>
<p>下面是跟 <code>#[\NoDiscard]</code> 配合良好的命名约定：</p>
<h4 data-id="heading-34">with* 不可变更新</h4>
<p>如果你的类是不可变的：</p>
<ul>
<li><code>withEmail()</code></li>
<li><code>withStatus()</code></li>
<li><code>withTimeout()</code></li>
</ul>
<p>这些方法基本都该标 <code>#[\NoDiscard]</code>，因为忽略返回值通常意味着"啥也没变"。</p>
<h4 data-id="heading-35">try* 失败编码在返回值里</h4>
<p>比如：</p>
<ul>
<li><code>tryLock() : bool</code></li>
<li><code>tryParse() : Result</code></li>
<li><code>tryConnect() : Result</code></li>
</ul>
<p>方法名以 try 开头，调用者一般会期望检查结果。标 <code>#[\NoDiscard]</code> 强化这个预期。</p>
<h4 data-id="heading-36">build() / finalize() 模式</h4>
<p><code>build()</code> 产生你要的东西，调用了却不用，基本就是写错了。</p>
<p>这里很适合加 <code>#[\NoDiscard]</code>。</p>
<h4 data-id="heading-37">消息要简短有行动指向</h4>
<p>好的消息是你希望队友在 CI 日志里看到的：</p>
<ul>
<li>"This Result must be handled."</li>
<li>"Immutable update: capture the returned instance."</li>
<li>"Operation can partially fail; consume the error list."</li>
</ul>
<p>RFC 支持可选消息，会出现在警告文本里。</p>
<h3 data-id="heading-38">结论</h3>
<p>支持 <code>#[\NoDiscard]</code> 的最强理由不是理论，是可维护性。</p>
<p>忽略返回值是真实 PHP 代码里反复出现的失败模式——尤其是：</p>
<ul>
<li>函数大多数时候都成功</li>
<li>API 是不可变的（返回新实例）</li>
<li>失败靠返回值而不是异常来报告</li>
</ul>
<p>PHP 8.5 给了一种原生手段来尽早抓住这些错误，用警告加显式 <code>(void)</code> 来保持故意丢弃时的可读性。</p>
<p>精准地用它：</p>
<ul>
<li>从忽略返回值有害的领域/服务 API 入手</li>
<li>避开纯函数和"主要靠副作用"的方法</li>
<li>配合命名约定（<code>with*</code>、<code>try*</code>），让代码在引擎报警之前就能读出正确用法</li>
</ul>
<p>做到这些，<code>#[\NoDiscard]</code> 就会成为那种安静地减少生产事故的小特性——不用逼整个团队换编程模型。</p>
<h3 data-id="heading-39">参考资料</h3>
<ul>
<li>PHP 8.5 发布公告（#[\NoDiscard] 概述、警告行为）</li>
<li>PHP 手册：PHP 8.5 新特性（#[\NoDiscard] 和 (void) 强制转换）</li>
<li>PHP RFC："Marking return values as important (#[\NoDiscard])"（警告级别、"使用"的含义、(void) 强制转换细节、约束、推荐用法）</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[手写 Vue 模板编译（生成篇）]]></title>    <link>https://juejin.cn/post/7592846242175369250</link>    <guid>https://juejin.cn/post/7592846242175369250</guid>    <pubDate>2026-01-08T16:47:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592846242175369250" data-draft-id="7591744347826389018" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="手写 Vue 模板编译（生成篇）"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2026-01-08T16:47:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我不吃饼干"/> <meta itemprop="url" content="https://juejin.cn/user/3263006241480605"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            手写 Vue 模板编译（生成篇）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3263006241480605/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我不吃饼干
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T16:47:07.000Z" title="Thu Jan 08 2026 16:47:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto;border:3px solid rgba(62,175,124,.2)}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-weight:700;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:6px;border:2px solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c}.markdown-body a:active,.markdown-body a:hover{border-bottom:1.5px solid #3eaf7c}.markdown-body a:before{content:"⇲"}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(62,175,124,.2)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:.5rem solid;border-color:#42b983;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none}.markdown-body ul li:before{content:"•";margin-right:4px;color:#3eaf7c}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-light">.hljs-comment,.hljs-quote{color:#696969}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#d91e18}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#aa5d00}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:green}.hljs-section,.hljs-title{color:#007faa}.hljs-keyword,.hljs-selector-tag{color:#7928a1}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fefefe;color:#545454}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">前言</h2>
<p>写本文的背景 <a href="https://juejin.cn/post/7519376321875279922" target="_blank" title="https://juejin.cn/post/7519376321875279922">《鸽了六年的某大厂面试题：你会手写一个模板引擎吗？》</a></p>
<p>阅读本文前请务必先阅读解析篇 <a href="https://juejin.cn/post/7519315675103723546" target="_blank" title="https://juejin.cn/post/7519315675103723546">《手写 Vue 模板编译（解析篇）》</a></p>
<h2 data-id="heading-1">复习</h2>
<p>在前文 <a href="https://juejin.cn/post/7519315675103723546" target="_blank" title="https://juejin.cn/post/7519315675103723546">《手写 Vue 模板编译（解析篇）》</a>
中，我们已经知道，模板编译的过程分为三步：解析、优化、生成。</p>
<ol>
<li>解析 parse：在这一步，Vue 会解析模板字符串，并生成对应的 AST</li>
<li>优化 optimize：这个阶段主要是通过标记静态节点来进行语法树优化。</li>
<li>生成 generate：利用前面生成 AST（抽象语法树）转换成渲染函数（render function）。</li>
</ol>
<p>在前文中，我们已经学习了如何生成 AST 接下来我们需要学习如何 optimize 和 generate。</p>
<h2 data-id="heading-2">optimize：优化 AST</h2>
<h3 data-id="heading-3">第一步：标记静态节点</h3>
<p>如上文所说，这个阶段主要是通过标记静态节点来进行语法树优化，在进行优化后，Vue 会在 AST 中标记某个节点是否为静态节点。</p>
<p>在上一节生成 AST 中，我们定义了节点类型：</p>
<ul>
<li>元素节点 type=1</li>
<li>表达式节点 type=2</li>
<li>文本节点 type=3</li>
</ul>
<p>在不存在子节点时：</p>
<ul>
<li>首先文本节点必为静态节点，因为文本内容固定不变。</li>
<li>其次表达式则必不为静态节点，因为它的值依赖于引用的表达式。</li>
<li>最后普通节点，如果有 <code>v-if</code> 或 <code>v-for</code> 指令就是动态节点，否则是静态节点
<blockquote>
<p>注：实际 Vue 中还有 <code>v-bind</code> 等指令也会让节点变为动态，这里简化处理</p>
</blockquote>
</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 判断一个节点是否为静态节点
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">isStatic</span>(<span class="hljs-params">node</span>) {
  <span class="hljs-comment">// 如果节点是表达式节点，则不是静态节点</span>
  <span class="hljs-keyword">if</span> (node.<span class="hljs-property">type</span> === <span class="hljs-number">2</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  }

  <span class="hljs-comment">// 如果节点是文本节点，则是静态节点</span>
  <span class="hljs-keyword">if</span> (node.<span class="hljs-property">type</span> === <span class="hljs-number">3</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
  }

  <span class="hljs-comment">// 如果节点没有 v-if 和 v-for 指令，则是静态节点</span>
  <span class="hljs-keyword">return</span> !node.<span class="hljs-property">if</span> &amp;&amp; !node.<span class="hljs-property">for</span>
}
</code></pre>
<p><strong>对于有子节点的情况</strong>：父节点必须满足以下两个条件才能成为静态节点：</p>
<ol>
<li>自身是静态节点（没有 <code>v-if</code>、<code>v-for</code> 等动态指令）</li>
<li>所有子节点都是静态节点</li>
</ol>
<p>接下来我们处理节点树</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 标记一个节点是否为静态节点
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">markStatic</span>(<span class="hljs-params">node</span>) {
  <span class="hljs-comment">// 先用 isStatic 判断当前节点自身是否为静态</span>
  node.<span class="hljs-property">static</span> = <span class="hljs-title function_">isStatic</span>(node)
  <span class="hljs-comment">// 如果是元素节点，需要检查子节点</span>
  <span class="hljs-keyword">if</span> (node.<span class="hljs-property">type</span> === <span class="hljs-number">1</span>) {
    <span class="hljs-comment">// 遍历所有的子节点</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>, l = node.<span class="hljs-property">children</span>.<span class="hljs-property">length</span>; i &lt; l; i++) {
      <span class="hljs-keyword">const</span> child = node.<span class="hljs-property">children</span>[i]
      <span class="hljs-comment">// 先递归处理子节点</span>
      <span class="hljs-title function_">markStatic</span>(child)
      <span class="hljs-comment">// 只要有一个子节点是动态的，父节点也必须是动态的</span>
      <span class="hljs-keyword">if</span> (!child.<span class="hljs-property">static</span>) {
        node.<span class="hljs-property">static</span> = <span class="hljs-literal">false</span>
      }
    }
  }
}
</code></pre>
<h3 data-id="heading-4">第二步：标记静态根节点</h3>
<p>接下来是 Vue 优化系统的另一个关键部分 <code>markStaticRoots</code>。</p>
<p><code>markStaticRoots</code> 函数用于标记静态根节点，被标记为静态根节点的元素及其子树会在代码生成阶段被特殊处理：</p>
<ol>
<li><strong>提升为常量</strong>：将其渲染代码提升到 <code>staticRenderFns</code> 数组中，只生成一次</li>
<li><strong>跳过 patch</strong>：更新时直接复用，不需要重新创建和对比 VNode</li>
<li><strong>性能提升</strong>：减少运行时的计算开销</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 标记静态根节点
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} <span class="hljs-variable">node</span> - AST 节点
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">markStaticRoots</span>(<span class="hljs-params">node</span>) {
  <span class="hljs-keyword">if</span> (node.<span class="hljs-property">type</span> === <span class="hljs-number">1</span>) {
    <span class="hljs-comment">// 只有元素节点才处理</span>

    <span class="hljs-comment">// 判断是否为静态根节点：必须是静态节点 + 有子节点</span>
    <span class="hljs-keyword">if</span> (node.<span class="hljs-property">static</span> &amp;&amp; node.<span class="hljs-property">children</span>.<span class="hljs-property">length</span>) {
      node.<span class="hljs-property">staticRoot</span> = <span class="hljs-literal">true</span>
      <span class="hljs-comment">// 找到静态根后直接返回，子节点会被整体提升，无需继续遍历</span>
      <span class="hljs-keyword">return</span>
    } <span class="hljs-keyword">else</span> {
      node.<span class="hljs-property">staticRoot</span> = <span class="hljs-literal">false</span>
    }

    <span class="hljs-comment">// 递归处理所有子节点</span>
    <span class="hljs-keyword">if</span> (node.<span class="hljs-property">children</span>) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>, l = node.<span class="hljs-property">children</span>.<span class="hljs-property">length</span>; i &lt; l; i++) {
        <span class="hljs-title function_">markStaticRoots</span>(node.<span class="hljs-property">children</span>[i])
      }
    }

    <span class="hljs-comment">// 处理 v-if 的其他分支（v-else-if、v-else）</span>
    <span class="hljs-comment">// 注意：从 i=1 开始，因为 ifConditions[0] 就是当前节点</span>
    <span class="hljs-keyword">if</span> (node.<span class="hljs-property">ifConditions</span>) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>, l = node.<span class="hljs-property">ifConditions</span>.<span class="hljs-property">length</span>; i &lt; l; i++) {
        <span class="hljs-title function_">markStaticRoots</span>(node.<span class="hljs-property">ifConditions</span>[i].<span class="hljs-property">block</span>)
      }
    }
  }
}
</code></pre>
<p>现在我们来实现 <code>optimize</code></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">optimize</span>(<span class="hljs-params">root</span>) {
  <span class="hljs-keyword">if</span> (!root) <span class="hljs-keyword">return</span>
  <span class="hljs-comment">// 第一步：标记静态节点</span>
  <span class="hljs-title function_">markStatic</span>(root)
  <span class="hljs-comment">// 第二步：标记静态根</span>
  <span class="hljs-title function_">markStaticRoots</span>(root)
}
</code></pre>
<p>举个例子来看看效果：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 要处理的模板字符串</span>
<span class="hljs-keyword">const</span> str = <span class="hljs-string">`&lt;div&gt;&lt;h1 v-if="true"&gt;hello&lt;/h1&gt;&lt;h2&gt;cookie&lt;/h2&gt;&lt;/div&gt;`</span>

<span class="hljs-comment">// 解析为 ast</span>
<span class="hljs-keyword">const</span> ast = <span class="hljs-title function_">parse</span>(str, {
  <span class="hljs-comment">// ...</span>
})
<span class="hljs-comment">// 优化 ast</span>
<span class="hljs-title function_">optimize</span>(ast)

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">dir</span>(ast, {
  <span class="hljs-attr">depth</span>: <span class="hljs-literal">null</span>,
})
</code></pre>
<p>打印结果：</p>
<pre><code class="hljs language-js" lang="js">&lt;ref *<span class="hljs-number">2</span>&gt; {
  <span class="hljs-attr">type</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">tag</span>: <span class="hljs-string">'div'</span>,
  <span class="hljs-attr">attrsList</span>: [],
  <span class="hljs-attr">attrsMap</span>: {},
  <span class="hljs-attr">children</span>: [
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ref</span> *<span class="hljs-attr">1</span>&gt;</span> {
      type: 1,
      tag: 'h1',
      attrsList: [],
      attrsMap: { 'v-if': 'true' },
      children: [ { type: 3, text: 'hello', static: true } ],
      if: 'true',
      ifConditions: [ { exp: 'true', block: [Circular *1] } ],
      parent: [Circular *2],
      static: false,
      staticRoot: false
    },
    {
      type: 1,
      tag: 'h2',
      attrsList: [],
      attrsMap: {},
      children: [ { type: 3, text: 'cookie', static: true } ],
      parent: [Circular *2],
      static: true,
      staticRoot: true
    }
  ],
  static: false,
  staticRoot: false
}
</span></code></pre>
<p>可以观察到 <code>&lt;h2&gt;</code> 节点被标记了静态根节点。</p>
<h2 data-id="heading-5">生成代码前置知识</h2>
<h3 data-id="heading-6">1、new Function</h3>
<p>我们知道创建函数除了常用的函数声明、函数表达式、箭头函数以外，还有一个不常用的：构造函数。语法如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">new</span> <span class="hljs-title class_">Function</span>(corpsFonction)
<span class="hljs-keyword">new</span> <span class="hljs-title class_">Function</span>(arg1, corpsFonction)
<span class="hljs-keyword">new</span> <span class="hljs-title class_">Function</span>(arg1, ...argN, corpsFonction)
<span class="hljs-comment">// 例：</span>
<span class="hljs-keyword">const</span> addFn = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Function</span>(<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'return a + b'</span>)
<span class="hljs-keyword">const</span> sum = <span class="hljs-title function_">addFn</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>) <span class="hljs-comment">// 3</span>
</code></pre>
<ul>
<li><code>argN</code>：可选，零个或多个，函数形参的名称，每个名称都必须是字符串</li>
<li><code>corpsFonction</code>：一个包含构成函数定义的 JavaScript 语句的字符串。</li>
</ul>
<h3 data-id="heading-7">2、with 语句</h3>
<p><code>with</code> 可以将一个对象的属性添加到作用域链的顶部，让我们在代码块内直接访问对象的属性。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">with</span> (对象) {
  <span class="hljs-comment">// 在这里可以直接访问对象的属性</span>
}
</code></pre>
<p>在 Vue 模板中我们写 <code>{{message}}</code>，实际上访问的是 <code>this.message</code>。使用 <code>with(this)</code> 可以省略 <code>this.</code> 前缀，让生成的代码更简洁。</p>
<p>示例：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> name = <span class="hljs-string">'other'</span> <span class="hljs-comment">// 局部变量</span>
  <span class="hljs-keyword">let</span> obj = {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'cookie'</span>, <span class="hljs-comment">// 对象属性</span>
  }
  <span class="hljs-keyword">with</span> (obj) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(name) <span class="hljs-comment">// 优先从 obj 中查找，输出 'cookie'</span>
  }
}
<span class="hljs-title function_">foo</span>() <span class="hljs-comment">// 输出: cookie</span>
</code></pre>
<h2 data-id="heading-8">generate 生成代码</h2>
<p>终于到了模板编译的最后一步，生成代码！在这一步，我们将根据前面得到的 AST 生成 <code>render</code> 函数。</p>
<h3 data-id="heading-9">1、整体入口：generate</h3>
<p><code>generate</code> 是代码生成的入口函数，负责将 AST 转换为可执行的渲染代码：</p>
<ol>
<li><strong>递归生成代码</strong>：调用 <code>genElement</code> 遍历 AST，生成类似 <code>_c('div', [...])</code> 的代码字符串</li>
<li><strong>包装 with 作用域</strong>：用 <code>with(this){}</code> 包裹，让代码能访问 Vue 实例的属性</li>
<li><strong>收集静态渲染函数</strong>：将静态根节点单独提取到 <code>staticRenderFns</code> 数组中</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 代码生成器入口
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} <span class="hljs-variable">ast</span> - 经过 parse 和 optimize 处理后的抽象语法树
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">Object</span>} 返回包含 render 函数和 staticRenderFns 数组的对象
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">generate</span>(<span class="hljs-params">ast</span>) {
  <span class="hljs-comment">// state 用于存储编译过程中的状态</span>
  <span class="hljs-comment">// staticRenderFns: 用于收集静态根节点的渲染函数，这些函数只需要生成一次，后续渲染可以直接复用，提升性能</span>
  <span class="hljs-keyword">const</span> state = { <span class="hljs-attr">staticRenderFns</span>: [] }

  <span class="hljs-comment">// 递归生成核心渲染代码字符串</span>
  <span class="hljs-comment">// 例如：_c('div',[_v(_s(message))])</span>
  <span class="hljs-keyword">const</span> code = <span class="hljs-title function_">genElement</span>(ast, state)

  <span class="hljs-keyword">return</span> {
    <span class="hljs-comment">// render: 主渲染函数的代码字符串</span>
    <span class="hljs-comment">// 使用 with(this) 包装后，模板中的变量（如 {{message}}）能直接从 Vue 实例上获取</span>
    <span class="hljs-comment">// with(this) 会将 Vue 实例添加到作用域链顶部</span>
    <span class="hljs-comment">// 这样 message 会自动从 this.message 获取，而不需要在模板里写 this.message</span>
    <span class="hljs-attr">render</span>: <span class="hljs-string">`with(this){return <span class="hljs-subst">${code}</span>}`</span>,
    <span class="hljs-comment">// staticRenderFns: 静态根节点渲染函数的数组</span>
    <span class="hljs-attr">staticRenderFns</span>: state.<span class="hljs-property">staticRenderFns</span>,
  }
}
</code></pre>
<h3 data-id="heading-10">2、核心函数：genElement</h3>
<p><code>genElement</code> 是代码生成的<strong>调度中心</strong>，它根据节点类型来使用不同的处理函数。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 生成元素的渲染代码
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} <span class="hljs-variable">el</span> - AST 元素节点
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} <span class="hljs-variable">state</span> - 渲染状态，包含 staticRenderFns 数组
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">string</span>} 渲染代码字符串，如：_c('div', [...])
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">genElement</span>(<span class="hljs-params">el, state</span>) {
  <span class="hljs-comment">// 1：处理静态根节点</span>
  <span class="hljs-comment">// el.staticRoot: 在 optimize 阶段标记的静态根节点</span>
  <span class="hljs-comment">// el.staticProcessed: 防止重复处理的标记</span>
  <span class="hljs-keyword">if</span> (el.<span class="hljs-property">staticRoot</span> &amp;&amp; !el.<span class="hljs-property">staticProcessed</span>) {
    <span class="hljs-comment">// 静态根节点会被提升为单独的函数存储在 staticRenderFns 中</span>
    <span class="hljs-comment">// 返回类似 _m(0) 的代码，0 是在 staticRenderFns 数组中的索引</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">genStatic</span>(el, state)
  }
  <span class="hljs-comment">// 2：处理 v-for 指令</span>
  <span class="hljs-comment">// el.for: 在 parse 阶段解析的 v-for 属性</span>
  <span class="hljs-comment">// el.forProcessed: 防止递归时重复处理</span>
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (el.<span class="hljs-property">for</span> &amp;&amp; !el.<span class="hljs-property">forProcessed</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">genFor</span>(el, state)
  }
  <span class="hljs-comment">// 3：处理 v-if 指令</span>
  <span class="hljs-comment">// el.if: 在 parse 阶段解析的 v-if 条件表达式</span>
  <span class="hljs-comment">// el.ifProcessed: 防止递归时重复处理</span>
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (el.<span class="hljs-property">if</span> &amp;&amp; !el.<span class="hljs-property">ifProcessed</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">genIf</span>(el, state)
  }
  <span class="hljs-comment">// 4：处理普通元素</span>
  <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 生成标签名字符串，如 'div'</span>
    <span class="hljs-keyword">const</span> tag = <span class="hljs-string">`'<span class="hljs-subst">${el.tag}</span>'`</span>

    <span class="hljs-comment">// 递归生成所有子节点的代码</span>
    <span class="hljs-comment">// 返回类似 [_v("hello"), _c('span')] 的数组代码</span>
    <span class="hljs-keyword">const</span> children = <span class="hljs-title function_">genChildren</span>(el, state)

    <span class="hljs-comment">// 最终调用 _c (createElement) 创建 VNode</span>
    <span class="hljs-comment">// 生成代码示例：_c('div', [_v("hello")])</span>
    <span class="hljs-comment">// 如果没有子节点，生成：_c('div')</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">`_c(<span class="hljs-subst">${tag}</span><span class="hljs-subst">${children ? <span class="hljs-string">`,<span class="hljs-subst">${children}</span>`</span> : <span class="hljs-string">''</span>}</span>)`</span>
  }
}
</code></pre>
<h4 data-id="heading-11">处理子节点：genChildren 和 genNode</h4>
<p><code>genElement</code> 中调用了 <code>genChildren</code> 来遍历子节点，<code>genChildren</code> 内部又使用 <code>genNode</code> 来处理每一个子节点，</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 生成子节点数组的渲染代码
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} <span class="hljs-variable">el</span> - 父元素节点
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} <span class="hljs-variable">state</span> - 渲染状态
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">string</span>} 子节点数组代码，如：[_v("text"), _c('span')]
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">genChildren</span>(<span class="hljs-params">el, state</span>) {
  <span class="hljs-keyword">const</span> children = el.<span class="hljs-property">children</span>
  <span class="hljs-keyword">if</span> (children.<span class="hljs-property">length</span>) {
    <span class="hljs-comment">// 获取子节点数组需要的规范化类型</span>
    <span class="hljs-keyword">const</span> normalizationType = <span class="hljs-title function_">getNormalizationType</span>(children)
    <span class="hljs-comment">// 遍历所有子节点，为每个子节点生成代码</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">`[<span class="hljs-subst">${children.map((c) =&gt; genNode(c, state)).join(<span class="hljs-string">','</span>)}</span>]<span class="hljs-subst">${
      normalizationType ? <span class="hljs-string">`,<span class="hljs-subst">${normalizationType}</span>`</span> : <span class="hljs-string">''</span>
    }</span>`</span>
  }
}

<span class="hljs-comment">/**
 * 根据节点类型调用对应的生成函数
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} <span class="hljs-variable">node</span> - AST 节点
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} <span class="hljs-variable">state</span> - 渲染状态
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">string</span>} 节点渲染代码
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">genNode</span>(<span class="hljs-params">node, state</span>) {
  <span class="hljs-keyword">if</span> (node.<span class="hljs-property">type</span> === <span class="hljs-number">1</span>) {
    <span class="hljs-comment">// type === 1: 元素节点，递归调用 genElement</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">genElement</span>(node, state)
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// type === 2/3: 文本节点或表达式节点，调用 genText</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">genText</span>(node)
  }
}
</code></pre>
<h4 data-id="heading-12">为什么需要 <code>getNormalizationType</code>？</h4>
<p>因为 <code>v-for</code> 会生成数组，导致 children 出现嵌套数组的情况：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>first<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"item in [1,2,3]"</span>&gt;</span>{{item}}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>last<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>生成的子节点结构会是：</p>
<pre><code class="hljs language-js" lang="js">[span_first, [span_1, span_1, span_1], span_last]
</code></pre>
<p>Vue 的 <code>createElement</code> 需要知道如何处理这种嵌套，所以要告诉它规范化类型：</p>
<ul>
<li>不需要规范化（没有嵌套）- <code>type = 0</code></li>
<li>简单规范化（一层嵌套，如组件）- <code>type = 1</code></li>
<li>完全规范化（多层嵌套，如 <code>v-for</code>）- <code>type = 2</code></li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 确定子节点数组需要的规范化(normalization)类型
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Array</span>} <span class="hljs-variable">children</span> - 子节点数组
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">number</span>} 0 | 1 | 2 - 规范化类型
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getNormalizationType</span>(<span class="hljs-params">children</span>) {
  <span class="hljs-keyword">let</span> res = <span class="hljs-number">0</span> <span class="hljs-comment">// 默认不需要规范化</span>

  <span class="hljs-comment">// 遍历所有子节点，检测是否需要规范化</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; children.<span class="hljs-property">length</span>; i++) {
    <span class="hljs-keyword">const</span> el = children[i]

    <span class="hljs-comment">// 跳过非元素节点（type=2 表达式节点、type=3 文本节点）</span>
    <span class="hljs-comment">// 只有元素节点(type=1)才可能需要规范化处理</span>
    <span class="hljs-keyword">if</span> (el.<span class="hljs-property">type</span> !== <span class="hljs-number">1</span>) <span class="hljs-keyword">continue</span>

    <span class="hljs-comment">// 检查是否需要完全规范化（优先级最高，返回 2）</span>
    <span class="hljs-keyword">if</span> (
      el.<span class="hljs-property">for</span> !== <span class="hljs-literal">undefined</span> || <span class="hljs-comment">// 当前节点有 v-for</span>
      (el.<span class="hljs-property">ifConditions</span> &amp;&amp; <span class="hljs-comment">// 或者 v-if 条件分支中有v-for</span>
        el.<span class="hljs-property">ifConditions</span>.<span class="hljs-title function_">some</span>(<span class="hljs-function">(<span class="hljs-params">c</span>) =&gt;</span> c.<span class="hljs-property">block</span>.<span class="hljs-property">for</span> !== <span class="hljs-literal">undefined</span>))
    ) {
      <span class="hljs-comment">// 需要完全规范化：因为 v-for 会返回数组，需要递归扁平化</span>
      <span class="hljs-comment">// 例如：[_v(" "), _l(arr, ...), _v(" ")] 其中 _l 返回 [span1, span2, span3]</span>
      <span class="hljs-comment">// 实际结构是：[_v(" "), [span1, span2, span3], _v(" ")] 需要扁平化为一维数组</span>
      res = <span class="hljs-number">2</span>
      <span class="hljs-keyword">break</span> <span class="hljs-comment">// 找到一个需要完全规范化的就可以退出，不需要继续检查</span>
    }

    <span class="hljs-comment">// 检查是否需要简单规范化 返回 1</span>
    <span class="hljs-comment">// 当前节点可能是组件时，组件可能返回多个根节点（数组）</span>
    <span class="hljs-comment">// 但组件的 render 函数已经返回规范化的 VNode，所以只需要一层扁平化</span>
    <span class="hljs-comment">// 我们的模板里不处理组件，这里也就不用考虑这种情况</span>
    <span class="hljs-comment">// res = 1</span>
  }

  <span class="hljs-keyword">return</span> res <span class="hljs-comment">// 返回 0、1 或 2</span>
}
</code></pre>
<h3 data-id="heading-13">3、分类处理函数</h3>
<h4 data-id="heading-14">Vue 内部函数</h4>
<p>首先在 Vue 内部，有一些简写函数，在后续生成代码的时候会用到，列表如下：</p>















































<table><thead><tr><th align="left">缩写</th><th align="left">全称</th><th align="left">作用</th><th align="left">示例</th></tr></thead><tbody><tr><td align="left"><code>_c</code></td><td align="left"><code>createElement</code></td><td align="left">创建元素 VNode</td><td align="left"><code>_c('div', [...])</code></td></tr><tr><td align="left"><code>_v</code></td><td align="left"><code>createTextVNode</code></td><td align="left">创建文本 VNode</td><td align="left"><code>_v("hello")</code></td></tr><tr><td align="left"><code>_s</code></td><td align="left"><code>toString</code></td><td align="left">将变量转为字符串</td><td align="left"><code>_v(_s(message))</code></td></tr><tr><td align="left"><code>_l</code></td><td align="left"><code>renderList</code></td><td align="left">渲染列表（v-for）</td><td align="left"><code>_l(items, fn)</code></td></tr><tr><td align="left"><code>_m</code></td><td align="left"><code>renderStatic</code></td><td align="left">渲染静态内容</td><td align="left"><code>_m(0)</code></td></tr><tr><td align="left"><code>_e</code></td><td align="left"><code>createEmptyVNode</code></td><td align="left">创建空节点（v-if 失败时）</td><td align="left"><code>_e()</code></td></tr></tbody></table>
<h4 data-id="heading-15">静态节点 (genStatic)</h4>
<p>静态根节点会被提升为单独的函数，提升性能：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 生成静态根节点的渲染代码
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} <span class="hljs-variable">el</span> - 静态根节点
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} <span class="hljs-variable">state</span> - 渲染状态
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">string</span>} 静态节点引用代码，如：_m(0)
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">genStatic</span>(<span class="hljs-params">el, state</span>) {
  <span class="hljs-comment">// 标记已处理，防止重复处理</span>
  el.<span class="hljs-property">staticProcessed</span> = <span class="hljs-literal">true</span>

  <span class="hljs-comment">// 递归生成静态节点的完整代码</span>
  <span class="hljs-keyword">const</span> code = <span class="hljs-title function_">genElement</span>(el, state)

  <span class="hljs-comment">// 将静态节点函数存储到 staticRenderFns 数组中</span>
  state.<span class="hljs-property">staticRenderFns</span>.<span class="hljs-title function_">push</span>(<span class="hljs-string">`with(this){return <span class="hljs-subst">${code}</span>}`</span>)

  <span class="hljs-comment">// 返回对静态函数的引用，_m(index) 表示调用 staticRenderFns[index]</span>
  <span class="hljs-comment">// 索引是当前数组长度减 1</span>
  <span class="hljs-keyword">return</span> <span class="hljs-string">`_m(<span class="hljs-subst">${state.staticRenderFns.length - <span class="hljs-number">1</span>}</span>)`</span>
}
</code></pre>
<p>静态渲染函数和主 <code>render</code> 函数（<code>vm._render</code>）独立，需要单独设置 <code>with</code> 作用域。</p>
<h4 data-id="heading-16">文本处理 (genText)</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 生成文本节点的渲染代码
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} <span class="hljs-variable">text</span> - 文本 AST 节点
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">string</span>} _v('...') 或 _v(_s(variable))
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">genText</span>(<span class="hljs-params">text</span>) {
  <span class="hljs-comment">// type 2 是带 {{}} 的表达式，type 3 是普通纯文本</span>
  <span class="hljs-comment">// 表达式直接使用解析好的 expression 纯文本需要用 JSON.stringify 转义</span>
  <span class="hljs-comment">// 比如 text 为 "hello"：生成代码 `v(hello)` 此时 JS 会去找名为 hello 的变量，这会导致报错（ReferenceError）</span>
  <span class="hljs-comment">// JSON.stringify("hello") 会返回 "\"hello\""（即带双引号的字符串）。生成的代码会变成：_v("hello")</span>
  <span class="hljs-keyword">const</span> value = text.<span class="hljs-property">type</span> === <span class="hljs-number">2</span> ? text.<span class="hljs-property">expression</span> : <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(text.<span class="hljs-property">text</span>)
  <span class="hljs-keyword">return</span> <span class="hljs-string">`_v(<span class="hljs-subst">${value}</span>)`</span>
}
</code></pre>
<h4 data-id="heading-17">条件渲染 (v-if)</h4>
<p>在 Vue 中我们可以使用 <code>v-if/else-if/else</code> 指令，比如下面的模板：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"a"</span>&gt;</span>A<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-else-if</span>=<span class="hljs-string">"b"</span>&gt;</span>B<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-else</span>&gt;</span>C<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>我们生成的 AST 为：</p>
<pre><code class="hljs language-js" lang="js">conditions = [
  { <span class="hljs-attr">exp</span>: <span class="hljs-string">'a'</span>, <span class="hljs-attr">block</span>: { <span class="hljs-variable constant_">AST</span>节点A } }, <span class="hljs-comment">// v-if</span>
  { <span class="hljs-attr">exp</span>: <span class="hljs-string">'b'</span>, <span class="hljs-attr">block</span>: { <span class="hljs-variable constant_">AST</span>节点B } }, <span class="hljs-comment">// v-else-if</span>
  { <span class="hljs-attr">exp</span>: <span class="hljs-literal">undefined</span>, <span class="hljs-attr">block</span>: { <span class="hljs-variable constant_">AST</span>节点C } }, <span class="hljs-comment">// v-else (没有exp)</span>
]
</code></pre>
<p><code>v-if/else-if/else</code> 的本质就是多重条件判断，在 JavaScript 中最适合用嵌套三元表达式来表达：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 目标：生成这样的代码</span>
<span class="hljs-comment">// (a) ? A节点 : (b) ? B节点 : C节点</span>
a ? <span class="hljs-title function_">_c</span>(<span class="hljs-string">'div'</span>, <span class="hljs-string">'A'</span>) : b ? <span class="hljs-title function_">_c</span>(<span class="hljs-string">'div'</span>, <span class="hljs-string">'B'</span>) : <span class="hljs-title function_">_c</span>(<span class="hljs-string">'div'</span>, <span class="hljs-string">'C'</span>)
</code></pre>
<p>接下来是代码实现，我们处理 <code>conditions</code> 时，每次弹出第一个条件块，如果为真，则展示当前模块，如果为假，则递归处理剩余的 <code>conditions</code>，如果没有条件（v-else），则直接展示该模块。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 生成 v-if 指令的入口函数
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} <span class="hljs-variable">el</span> - 带有 v-if 的 AST 节点
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} <span class="hljs-variable">state</span> - 渲染状态
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">string</span>} 三元表达式形式的渲染代码
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">genIf</span>(<span class="hljs-params">el, state</span>) {
  <span class="hljs-comment">// 标记已处理，防止递归时重复处理</span>
  el.<span class="hljs-property">ifProcessed</span> = <span class="hljs-literal">true</span>
  <span class="hljs-comment">// 使用 slice() 复制数组，避免 shift() 修改原始的 ifConditions 数组</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">genIfConditions</span>(el.<span class="hljs-property">ifConditions</span>.<span class="hljs-title function_">slice</span>(), state)
}

<span class="hljs-comment">/**
 * 生成 v-if/else-if/else 指令的渲染代码
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Array</span>} <span class="hljs-variable">conditions</span> - 条件数组
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} <span class="hljs-variable">state</span> - 渲染状态
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">string</span>} 三元表达式形式的代码
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">genIfConditions</span>(<span class="hljs-params">conditions, state</span>) {
  <span class="hljs-comment">// 递归终止条件：所有分支都处理完了 返回空节点</span>
  <span class="hljs-keyword">if</span> (!conditions.<span class="hljs-property">length</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">'_e()'</span>

  <span class="hljs-comment">// 取出第一个条件</span>
  <span class="hljs-keyword">const</span> condition = conditions.<span class="hljs-title function_">shift</span>()
  <span class="hljs-keyword">if</span> (condition.<span class="hljs-property">exp</span>) {
    <span class="hljs-comment">// 有条件表达式：v-if 或 v-else-if</span>
    <span class="hljs-comment">// 生成：(条件) ? 满足时的内容 : 递归处理剩余条件</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">`(<span class="hljs-subst">${condition.exp}</span>)?<span class="hljs-subst">${genElement(
      condition.block,
      state
    )}</span>:<span class="hljs-subst">${genIfConditions(conditions, state)}</span>`</span>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 没有条件表达式：v-else</span>
    <span class="hljs-comment">// 兜底分支，直接生成节点</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">genElement</span>(condition.<span class="hljs-property">block</span>, state)
  }
}
</code></pre>
<h4 data-id="heading-18">列表渲染 (v-for)</h4>
<p>最后我们处理 <code>v-for</code> 指令，考虑下面的例子：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(item, index) in items"</span>&gt;</span>{{ item.name }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>在 parse 阶段，这个指令会被解析为 AST 节点的属性：</p>
<pre><code class="hljs language-js" lang="js">{
  <span class="hljs-attr">for</span>: <span class="hljs-string">"items"</span>,      <span class="hljs-comment">// 要遍历的数据源</span>
  <span class="hljs-attr">alias</span>: <span class="hljs-string">"item"</span>,     <span class="hljs-comment">// 当前项的别名</span>
  <span class="hljs-attr">iterator1</span>: <span class="hljs-string">"index"</span> <span class="hljs-comment">// 索引的别名（可选）</span>
}
</code></pre>
<p>我们通过<code>_l</code> 来进行遍历。<code>_l</code> 是 Vue 的内部函数 <code>renderList</code>，它的作用是遍历数组/对象，为每一项调用渲染函数。我们要生成的代码格式是：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">_l</span>(数据源, <span class="hljs-keyword">function</span> (<span class="hljs-params">item, index</span>) {
  <span class="hljs-keyword">return</span> 每一项的渲染代码
})
</code></pre>
<p>代码实现：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 生成 v-for 指令的渲染代码
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} <span class="hljs-variable">el</span> - 带有 v-for 的 AST 节点
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} <span class="hljs-variable">state</span> - 渲染状态
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">string</span>} _l() 函数调用代码
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">genFor</span>(<span class="hljs-params">el, state</span>) {
  <span class="hljs-comment">// 1. 提取遍历的相关信息</span>
  <span class="hljs-keyword">const</span> exp = el.<span class="hljs-property">for</span> <span class="hljs-comment">// 遍历的对象</span>
  <span class="hljs-keyword">const</span> alias = el.<span class="hljs-property">alias</span> <span class="hljs-comment">// 别名 item</span>

  <span class="hljs-comment">// 2. 处理索引参数（可选）</span>
  <span class="hljs-comment">// 如果有索引，格式为 ",index"；没有则为空字符串</span>
  <span class="hljs-keyword">const</span> iterator1 = el.<span class="hljs-property">iterator1</span> ? <span class="hljs-string">`,<span class="hljs-subst">${el.iterator1}</span>`</span> : <span class="hljs-string">''</span>
  <span class="hljs-keyword">const</span> iterator2 = el.<span class="hljs-property">iterator2</span> ? <span class="hljs-string">`,<span class="hljs-subst">${el.iterator2}</span>`</span> : <span class="hljs-string">''</span>

  <span class="hljs-comment">// 3. 标记已处理，防止递归时重复处理</span>
  el.<span class="hljs-property">forProcessed</span> = <span class="hljs-literal">true</span>

  <span class="hljs-comment">// 4. 生成 _l() 函数调用</span>
  <span class="hljs-keyword">return</span> <span class="hljs-string">`_l((<span class="hljs-subst">${exp}</span>),function(<span class="hljs-subst">${alias}</span><span class="hljs-subst">${iterator1}</span><span class="hljs-subst">${iterator2}</span>){return <span class="hljs-subst">${genElement(
    el,
    state
  )}</span>})`</span>
}
</code></pre>
<p>最后会转化为代码：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">_l</span>(items, <span class="hljs-keyword">function</span> (<span class="hljs-params">item, index</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">_c</span>(<span class="hljs-string">'div'</span>, [<span class="hljs-title function_">_v</span>(<span class="hljs-title function_">_s</span>(item.<span class="hljs-property">name</span>))])
})
</code></pre>
<h2 data-id="heading-19">运行实例</h2>
<p>我们已经写完了模板编译代码，完整的使用流程如下：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://unpkg.com/vue@2.7.16/dist/vue.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"app"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-comment">// 1. 模板字符串</span>
    <span class="hljs-keyword">const</span> template = <span class="hljs-string">`
      &lt;div&gt;
        &lt;h1&gt;恭喜！编译成功！&lt;/h1&gt;
        &lt;h1 v-if="true"&gt;随机数{{ Math.random() }}&lt;/h1&gt;
        &lt;h1 v-if="false"&gt;这里不会被展示&lt;/h1&gt;
        &lt;h2&gt;
          &lt;span&gt;{{message}}&lt;/span&gt;
          &lt;span v-for="item in list"&gt;{{item}}&lt;/span&gt;
        &lt;/h2&gt;
      &lt;/div&gt;
    `</span>

    <span class="hljs-comment">// 2. 三步编译：parse -&gt; optimize -&gt; generate</span>
    <span class="hljs-comment">// （函数实现见上文，这里省略）</span>
    <span class="hljs-keyword">const</span> ast = <span class="hljs-title function_">parse</span>(template, {...})
    <span class="hljs-title function_">optimize</span>(ast)
    <span class="hljs-keyword">const</span> { render, staticRenderFns } = <span class="hljs-title function_">generate</span>(ast)

    <span class="hljs-comment">// 3. 使用生成的 render 函数创建 Vue 实例</span>
    <span class="hljs-keyword">const</span> vm = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>({
      <span class="hljs-attr">el</span>: <span class="hljs-string">'#app'</span>,
      <span class="hljs-attr">data</span>: {
        <span class="hljs-attr">message</span>: <span class="hljs-string">'Hello'</span>,
        <span class="hljs-attr">list</span>: [<span class="hljs-string">'我不吃'</span>, <span class="hljs-string">'饼干'</span>, <span class="hljs-string">'🍪'</span>],
      },
      <span class="hljs-attr">render</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Function</span>(render),
      <span class="hljs-attr">staticRenderFns</span>: staticRenderFns.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">fn</span> =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Function</span>(fn)),
    })
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>最终页面展示效果如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec3d6f25518c43cb9963c797a79a17f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5LiN5ZCD6aW85bmy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768495627&amp;x-signature=TRuKGX72VNu0HnsQqlfdW6Rc020%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-20">后记</h2>
<p>以前看大佬<a href="https://juejin.cn/user/2330620350708823/posts" target="_blank" title="https://juejin.cn/user/2330620350708823/posts">ssh_晨曦时梦见兮</a>的文章，特别喜欢他那种把问题深入浅出讲明白的文章。可是当我自己开始写的时候，才发现想写好真的好难。</p>
<p>有任何问题都可以在评论区提出，感谢大家看到这里。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[数据结构-图]]></title>    <link>https://juejin.cn/post/7592903126177497138</link>    <guid>https://juejin.cn/post/7592903126177497138</guid>    <pubDate>2026-01-08T23:46:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592903126177497138" data-draft-id="7590654280900165675" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="数据结构-图"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2026-01-08T23:46:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SevenCoding"/> <meta itemprop="url" content="https://juejin.cn/user/3261615728242467"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            数据结构-图
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3261615728242467/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SevenCoding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T23:46:07.000Z" title="Thu Jan 08 2026 23:46:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">概述</h2>
<p>图是一种较为复杂的非线性结构。 <strong>为啥说其较为复杂呢？</strong></p>
<p>根据前面的内容，我们知道：</p>
<ul>
<li>线性数据结构的元素满足唯一的线性关系，每个元素(除第一个和最后一个外)只有一个直接前趋和一个直接后继。</li>
<li>树形数据结构的元素之间有着明显的层次关系。</li>
</ul>
<p>但是，图形结构的元素之间的关系是任意的。</p>
<p><strong>何为图呢？</strong> 简单来说，图就是由顶点的有穷非空集合和顶点之间的边组成的集合。通常表示为：<strong>G(V,E)</strong>，其中，G 表示一个图，V 表示顶点的集合，E 表示边的集合。</p>
<p>下图所展示的就是图这种数据结构</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1dc43a9c936e408698bda2cdac8298b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768520766&amp;x-signature=cmX%2Fd4oFK4IRTPJdLcvYrPElQ2o%3D" alt="" loading="lazy"/></p>
<p>同时图⼜分为有向图与⽆向图，上⾯的是⽆向图，因为边没有指明⽅向，只是表示两者关联关系，⽽有向图则是这样：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3cf88382ab4840bc91335185b787700a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768520766&amp;x-signature=OOUtAX8ydKjdiuvq%2BbZEAH07zZ0%3D" alt="" loading="lazy"/></p>
<p>图在我们日常生活中的例子很多！比如我们在社交软件上好友关系就可以用图来表示。</p>
<h2 data-id="heading-1">图的基本概念</h2>
<h3 data-id="heading-2">顶点</h3>
<p>图中的数据元素，我们称之为顶点，图至少有一个顶点（非空有穷集合）</p>
<p>对应到好友关系图，每一个用户就代表一个顶点。</p>
<h3 data-id="heading-3">边</h3>
<p>顶点之间的关系用边表示。</p>
<p>对应到好友关系图，两个用户是好友的话，那两者之间就存在一条边。</p>
<h3 data-id="heading-4">度</h3>
<p>度表示一个顶点包含多少条边，在有向图中，还分为出度和入度，出度表示从该顶点出去的边的条数，入度表示进入该顶点的边的条数。</p>
<p>对应到好友关系图，度就代表了某个人的好友数量。</p>
<h3 data-id="heading-5">无向图和有向图</h3>
<p>边表示的是顶点之间的关系，有的关系是双向的，比如同学关系，A 是 B 的同学，那么 B 也肯定是 A 的同学，那么在表示 A 和 B 的关系时，就不用关注方向，用不带箭头的边表示，这样的图就是无向图。</p>
<p>有的关系是有方向的，比如父子关系，师生关系，微博的关注关系，A 是 B 的爸爸，但 B 肯定不是 A 的爸爸，A 关注 B，B 不一定关注 A。在这种情况下，我们就用带箭头的边表示二者的关系，这样的图就是有向图。</p>
<h3 data-id="heading-6">无权图和带权图</h3>
<p>对于一个关系，如果我们只关心关系的有无，而不关心关系有多强，那么就可以用无权图表示二者的关系。</p>
<p>对于一个关系，如果我们既关心关系的有无，也关心关系的强度，比如描述地图上两个城市的关系，需要用到距离，那么就用带权图来表示，带权图中的每一条边一个数值表示权值，代表关系的强度。</p>
<p>下图就是一个带权有向图。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a05e5aeb97141d889589d12702c9807~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768520766&amp;x-signature=9aiKRy7kfpAxdCcla1b5apLCG%2FA%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-7">图的存储</h2>
<h3 data-id="heading-8">邻接矩阵存储</h3>
<p>邻接矩阵将图用二维矩阵存储，是一种较为直观的表示方式。</p>
<p>如果第 i 个顶点和第 j 个顶点之间有关系，且关系权值为 n，则 <code>A[i][j]=n</code> 。</p>
<p>在无向图中，我们只关心关系的有无，所以当顶点 i 和顶点 j 有关系时，<code>A[i][j]</code>=1，当顶点 i 和顶点 j 没有关系时，<code>A[i][j]</code>=0。如下图所示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/185ca489f20440e5b42a13b8eb619753~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768520766&amp;x-signature=dghCxwRFEV2Bi44r9aU6%2BVbtsVs%3D" alt="" loading="lazy"/></p>
<p>值得注意的是：<strong>无向图的邻接矩阵是一个对称矩阵，因为在无向图中，顶点 i 和顶点 j 有关系，则顶点 j 和顶点 i 必有关系。</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/46e11a93fe90447d83eb3399cb03b0a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768520766&amp;x-signature=5Nlkkqn9HO0MbvUEa%2FQmYue6SkM%3D" alt="" loading="lazy"/></p>
<p>邻接矩阵存储的方式优点是简单直接（直接使用一个二维数组即可），并且，在获取两个定点之间的关系的时候也非常高效（直接获取指定位置的数组元素的值即可）。但是，这种存储方式的缺点也比较明显，那就是比较浪费空间，</p>
<h3 data-id="heading-9">邻接表存储</h3>
<p>针对上面邻接矩阵比较浪费内存空间的问题，诞生了图的另外一种存储方法—<strong>邻接表</strong> 。</p>
<p>邻接链表使用一个链表来存储某个顶点的所有后继相邻顶点。对于图中每个顶点 Vi，把所有邻接于 Vi 的顶点 Vj 链成一个单链表，这个单链表称为顶点 Vi 的 <strong>邻接表</strong>。如下图所示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4baae108fa2e45278185092be229e602~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768520766&amp;x-signature=fcv85XmGi%2B8iZiEp0asf%2BcUZLXg%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e6667a924b41409ebc3752568201988d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768520766&amp;x-signature=VUlT2NEnw1ABH0o%2Bmwvq1x6snzM%3D" alt="" loading="lazy"/></p>
<p>大家可以数一数邻接表中所存储的元素的个数以及图中边的条数，你会发现：</p>
<ul>
<li>在无向图中，邻接表元素个数等于边的条数的两倍，如左图所示的无向图中，边的条数为 7，邻接表存储的元素个数为 14。</li>
<li>在有向图中，邻接表元素个数等于边的条数，如右图所示的有向图中，边的条数为 8，邻接表存储的元素个数为 8。</li>
</ul>
<h2 data-id="heading-10">图的搜索</h2>
<p>图⾥⾯遍历⼀般分为⼴度优先遍历和深度优先遍历，⼴度优先遍历是指优先遍历与当前顶点直接相关的顶点，⼀般借助队列实现。⽽深度优先遍历则是往⼀个⽅向⼀直⾛到不能再⾛，有点不撞南墙不回头的意思，⼀般使⽤递归实现。</p>
<h3 data-id="heading-11">广度优先搜索</h3>
<p>广度优先搜索就像水面上的波纹一样一层一层向外扩展，如下图所示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/14ce5fbac1a24d75ad1de1a5f325f0a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768520766&amp;x-signature=PgVwVWpGD%2F7nmNcTVqABWEFZSso%3D" alt="" loading="lazy"/></p>
<p><strong>广度优先搜索的具体实现方式用到了之前所学过的线性数据结构——队列</strong> 。具体过程如下图所示：</p>
<p><strong>第 1 步：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/65eab35ef51a4371bdc854ed4bbfba06~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768520766&amp;x-signature=zHhoS2xPkyw7QtL0fjuviCdMdNs%3D" alt="" loading="lazy"/></p>
<p><strong>第 2 步：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7872c9b8ee1b44c8b3d1aad1c66bddf5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768520766&amp;x-signature=KJo2FGKsNxgbdRIX69rfzSN3mMM%3D" alt="" loading="lazy"/></p>
<p><strong>第 3 步：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/caaec7f08aaf449baa1b30bcc85234c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768520766&amp;x-signature=yBuAaFJqLOXTM5jRYq2IpxwGKkI%3D" alt="" loading="lazy"/></p>
<p><strong>第 4 步：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/748a27dd05b24acca9f0045835964c0c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768520766&amp;x-signature=UY4sMjdPkRl5Xkc%2B8KYFdUbq020%3D" alt="" loading="lazy"/></p>
<p><strong>第 5 步：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1808d9cef56c453b9625c00e35a9ad60~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768520766&amp;x-signature=PNIXXFFDYCGhsKHr%2B5I0z5fCOss%3D" alt="" loading="lazy"/></p>
<p><strong>第 6 步：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db09e6ccdae64a51ad5e8aa78473487f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768520766&amp;x-signature=jGJNikjtnYKTtVLYRCHEF2BW0cs%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-12">深度优先搜索</h3>
<p>深度优先搜索就是“一条路走到黑”，从源顶点开始，一直走到没有后继节点，才回溯到上一顶点，然后继续“一条路走到黑”，如下图所示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/949f8ceddb764b87aaf63c92eb3f7bb0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768520766&amp;x-signature=iMt6jbZEhytzI9pa%2Btx5h35Yrmk%3D" alt="" loading="lazy"/></p>
<p><strong>和广度优先搜索类似，深度优先搜索的具体实现用到了另一种线性数据结构——栈</strong> 。具体过程如下图所示：</p>
<p><strong>第 1 步：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/39f20df13c5a4a3facba7cffe4aed8ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768520766&amp;x-signature=OG97BQfo%2BWvXIrbZIei76bn0uTU%3D" alt="" loading="lazy"/></p>
<p><strong>第 2 步：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be6ff20741fe44a49530b2d6c05241bd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768520766&amp;x-signature=GFPfZsKpIA6U7czJdVNn19U7Lx4%3D" alt="" loading="lazy"/></p>
<p><strong>第 3 步：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab97fccc1ec84befa42fc9f82c99960f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768520766&amp;x-signature=91YjgQCNIn3FCOt4e9Ub%2F638TB4%3D" alt="" loading="lazy"/></p>
<p><strong>第 4 步：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3541eacb582549d78c1f70a2725a4134~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768520766&amp;x-signature=rMtrBTMKvgYsM6LKXvXAG7cvOE4%3D" alt="" loading="lazy"/></p>
<p><strong>第 5 步：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/537873b1f84e42d691f02756bdba884d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768520766&amp;x-signature=CkhJ7bmc6FPT9U3TOAimnt7dzKE%3D" alt="" loading="lazy"/></p>
<p><strong>第 6 步：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e16fa3b260a14fefa1cd0d9839b16b10~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768520766&amp;x-signature=YZqciLNvwbVPyW24abnz3zZmw9A%3D" alt="" loading="lazy"/></p>
<p>算法框架如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 记录被遍历过的节点</span>
<span class="hljs-type">boolean</span>[] visited;
<span class="hljs-comment">// 记录从起点到当前节点的路径</span>
<span class="hljs-type">boolean</span>[] onPath;

<span class="hljs-comment">/* 图遍历框架 */</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">traverse</span><span class="hljs-params">(Graph graph, <span class="hljs-type">int</span> s)</span> {
    <span class="hljs-keyword">if</span> (visited[s]) <span class="hljs-keyword">return</span>;
    <span class="hljs-comment">// 经过节点 s，标记为已遍历</span>
    visited[s] = <span class="hljs-literal">true</span>;
    <span class="hljs-comment">// 做选择：标记节点 s 在路径上</span>
    onPath[s] = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> neighbor : graph.neighbors(s)) {
        traverse(graph, neighbor);
    }
    <span class="hljs-comment">// 撤销选择：节点 s 离开路径</span>
    onPath[s] = <span class="hljs-literal">false</span>;
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HarmonyOS一杯冰美式的时间 -- @Env]]></title>    <link>https://juejin.cn/post/7592823500417187866</link>    <guid>https://juejin.cn/post/7592823500417187866</guid>    <pubDate>2026-01-08T18:00:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592823500417187866" data-draft-id="7592833068223610926" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HarmonyOS一杯冰美式的时间 -- @Env"/> <meta itemprop="keywords" content="HarmonyOS"/> <meta itemprop="datePublished" content="2026-01-08T18:00:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="猫猫头啊"/> <meta itemprop="url" content="https://juejin.cn/user/1283876003519357"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HarmonyOS一杯冰美式的时间 -- @Env
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1283876003519357/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    猫猫头啊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T18:00:36.000Z" title="Thu Jan 08 2026 18:00:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、前言</h2>
<p>该系列依旧会带着大家，了解，开阔一些不怎么热门的API，也可能是偷偷被更新的API，也可以是好玩的，藏在官方文档的边边角角~当然也会有一些API，之前是我们辛辛苦苦的手撸代码，现在有一个API能帮我们快速实现的，希望大家能找宝藏。</p>
<p>如果您有任何疑问、对文章写的不满意、发现错误或者有更好的方法，欢迎在评论、私信或邮件中提出，非常感谢您的支持。🙏</p>
<h2 data-id="heading-1">二、@Env的诞生背景</h2>
<p>OK，步入正题把，在多设备开发的场景中，我们经常需要根据不同的设备环境（比如窗口大小、横竖屏等）来调整UI布局。以前我们可能要用<code>Environment</code>来获取这些信息，但<code>Environment</code>有个问题：它没有响应式能力，系统环境变量变化时不会自动通知组件刷新。这就导致我们需要手动监听变化，写很多重复的代码。虽然，虽然啊，他能存到AppStorage里面去，但是去监听一堆的环境变量的变化，然后设置到AppStorage里面去很不优雅啊。</p>
<p>好在API 22引入了<code>@Env</code>装饰器（有点晚了），它不仅能读取系统环境变量，还能在环境变量变化时自动触发组件刷新，爽！</p>
<h3 data-id="heading-2">1. Environment的局限性</h3>
<p><code>Environment</code>是ArkUI框架提供的设备环境查询能力，它可以将系统环境变量存入<code>AppStorage</code>，让我们通过<code>@StorageProp</code>来访问。但是<code>Environment</code>有个致命的缺点：<strong>没有响应式能力</strong>。</p>
<p>啥意思呢？就是说当系统环境变量变化的时候（比如横竖屏切换），<code>Environment</code>不会自动通知组件刷新。我们需要手动监听变化（重点在这），然后手动更新UI。这就导致代码变得复杂，而且容易出错。</p>
<h3 data-id="heading-3">2. @Env的解决方案</h3>
<p>API 22引入的<code>@Env</code>装饰器就是为了解决这个问题。它是一个<strong>响应式系统环境变量装饰器</strong>，具有以下特点：</p>
<ul>
<li><strong>自动响应</strong>：系统环境变量变化时，自动通知<code>@Env</code>装饰的变量更新</li>
<li><strong>自动刷新</strong>：<code>@Env</code>关联的组件会自动刷新，无需手动管理</li>
<li><strong>简化代码</strong>：减少了大量重复的适配逻辑
（PS：我最后还会重复这一段）
简单来说，<code>@Env</code>让环境变量的使用变得像状态变量一样简单，你只需要声明一个<code>@Env</code>变量，框架会自动帮你处理响应式更新。</li>
</ul>
<h2 data-id="heading-4">三、@Env基础概念</h2>
<p>下面两条有一条是好消息：</p>
<ul>
<li>从API version 22开始，<code>@Env</code>支持在<code>@Component</code>和<code>@ComponentV2</code>中使用（能在V1使用哦）</li>
<li>从API version 22开始，该装饰器支持在元服务中使（高贵22）</li>
</ul>
<h4 data-id="heading-5">（1）读取环境变量</h4>
<ul>
<li><strong>目前仅支持<code>SystemProperties.BREAK_POINT</code>！</strong></li>
<li><strong>目前仅支持<code>SystemProperties.BREAK_POINT</code>！</strong></li>
<li><strong>目前仅支持<code>SystemProperties.BREAK_POINT</code>！</strong></li>
</ul>
<p>重要的事情说三遍！！！！！！</p>
<p><code>@Env</code>可以根据入参读取相应的环境变量信息。目前仅支持<code>SystemProperties.BREAK_POINT</code>，用于获取窗口不同宽高阈值下对应的断点值信息。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { uiObserver } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;

<span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">Index</span> {
  <span class="hljs-comment">// 使用@Env装饰器获取窗口断点信息</span>
  <span class="hljs-meta">@Env</span>(<span class="hljs-title class_">SystemProperties</span>.<span class="hljs-property">BREAK_POINT</span>) <span class="hljs-attr">breakpoint</span>: uiObserver.<span class="hljs-property">WindowSizeLayoutBreakpointInfo</span>;

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>() {
      <span class="hljs-comment">// 可以直接使用breakpoint获取宽度和高度断点</span>
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`宽度断点: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.breakpoint.widthBreakpoint}</span>`</span>)
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`高度断点: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.breakpoint.heightBreakpoint}</span>`</span>)
    }
  }
}
</code></pre>
<h4 data-id="heading-6">（2）响应式更新</h4>
<p>当系统环境变量改变时（比如横竖屏切换、窗口大小调整），<code>@Env</code>会自动：</p>
<ul>
<li>通知<code>@Env</code>装饰变量的更新</li>
<li>触发<code>@Env</code>关联组件的刷新</li>
<li>实现界面内容的同步更新</li>
</ul>
<p>不需要手动监听变化，框架会自动处理。</p>
<h4 data-id="heading-7">（3）可观察对象</h4>
<p><code>@Env</code>返回的对象实际上是由<code>@ObservedV2</code>装饰的可观察对象，其属性由<code>@Trace</code>装饰。这意味着：</p>
<ul>
<li>你可以使用<code>addMonitor</code>来监听属性的变化</li>
<li>属性的变化会自动触发UI更新</li>
<li>支持细粒度的响应式更新</li>
</ul>
<h2 data-id="heading-8">五、@Env基本使用</h2>
<h3 data-id="heading-9">1. 在@ComponentV2中使用@Env</h3>
<p>在<code>@ComponentV2</code>中使用<code>@Env</code>非常简单，我们来看一个完整的例子：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { uiObserver, <span class="hljs-title class_">UIUtils</span>, <span class="hljs-variable language_">window</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;
<span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;

<span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@ComponentV2</span>
struct <span class="hljs-title class_">Index</span> {
  <span class="hljs-comment">// 声明@Env变量，获取窗口断点信息</span>
  <span class="hljs-meta">@Env</span>(<span class="hljs-title class_">SystemProperties</span>.<span class="hljs-property">BREAK_POINT</span>) <span class="hljs-attr">breakpoint</span>: uiObserver.<span class="hljs-property">WindowSizeLayoutBreakpointInfo</span>;

  <span class="hljs-comment">// 切换横竖屏的方法</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">changeOrientation</span>(<span class="hljs-params">isLandscape: <span class="hljs-built_in">boolean</span></span>) {
    <span class="hljs-keyword">const</span> context = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>()?.<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getLastWindow</span>(context).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">lastWindow</span>) =&gt;</span> {
      <span class="hljs-comment">// 设置窗口方向</span>
      lastWindow.<span class="hljs-title function_">setPreferredOrientation</span>(
        isLandscape ? <span class="hljs-variable language_">window</span>.<span class="hljs-property">Orientation</span>.<span class="hljs-property">LANDSCAPE</span> : <span class="hljs-variable language_">window</span>.<span class="hljs-property">Orientation</span>.<span class="hljs-property">PORTRAIT</span>
      );
    });
  }

  <span class="hljs-comment">// 监听断点变化的回调</span>
  <span class="hljs-title function_">orientationChange</span>(<span class="hljs-params">mon: IMonitor</span>) {
    mon.<span class="hljs-property">dirty</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">path: <span class="hljs-built_in">string</span></span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`<span class="hljs-subst">${path}</span> changes from <span class="hljs-subst">${mon.value(path)?.before}</span> to <span class="hljs-subst">${mon.value(path)?.now}</span>`</span>);
    })
  }

  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-comment">// @Env返回的对象实际上是@ObservedV2装饰的对象（其属性是@Trace装饰的）</span>
    <span class="hljs-comment">// 所以其属性的改变可以通过addMonitor监听</span>
    <span class="hljs-title class_">UIUtils</span>.<span class="hljs-title function_">addMonitor</span>(
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">breakpoint</span>,
      [<span class="hljs-string">'widthBreakpoint'</span>, <span class="hljs-string">'heightBreakpoint'</span>],
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">orientationChange</span>
    );
  }

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>() {
      <span class="hljs-comment">// 显示当前断点信息</span>
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`Index breakpoint width: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.breakpoint.widthBreakpoint}</span>`</span>).<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`Index breakpoint height: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.breakpoint.heightBreakpoint}</span>`</span>).<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)

      <span class="hljs-comment">// 横屏按钮</span>
      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'Landscape'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">changeOrientation</span>(<span class="hljs-literal">true</span>);
      })

      <span class="hljs-comment">// 竖屏按钮</span>
      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'Portrait'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">changeOrientation</span>(<span class="hljs-literal">false</span>);
      })

      <span class="hljs-comment">// 将@Env变量传递给子组件</span>
      <span class="hljs-title class_">CompV2</span>({ <span class="hljs-attr">breakpoint</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">breakpoint</span> })
      <span class="hljs-title class_">Comp</span>({ <span class="hljs-attr">breakpoint</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">breakpoint</span> })
    }
  }
}

<span class="hljs-comment">// ComponentV2子组件</span>
<span class="hljs-meta">@ComponentV2</span>
struct <span class="hljs-title class_">CompV2</span> {
  <span class="hljs-comment">// @Env装饰的变量只能用于初始化@Param装饰的变量</span>
  <span class="hljs-meta">@Require</span> <span class="hljs-meta">@Param</span> <span class="hljs-attr">breakpoint</span>: uiObserver.<span class="hljs-property">WindowSizeLayoutBreakpointInfo</span>;

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>() {
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`CompV2 breakpoint width: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.breakpoint.widthBreakpoint}</span>`</span>).<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`CompV2 breakpoint height: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.breakpoint.heightBreakpoint}</span>`</span>).<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)
    }
  }
}

<span class="hljs-comment">// Component子组件</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">Comp</span> {
  <span class="hljs-comment">// @Env装饰的变量只能用于初始化常规变量</span>
  <span class="hljs-meta">@Require</span> <span class="hljs-attr">breakpoint</span>: uiObserver.<span class="hljs-property">WindowSizeLayoutBreakpointInfo</span>;

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>() {
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`Comp breakpoint width: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.breakpoint.widthBreakpoint}</span>`</span>).<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`Comp breakpoint height: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.breakpoint.heightBreakpoint}</span>`</span>).<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)
    }
  }
}
</code></pre>
<h3 data-id="heading-10">2. 在@Component中使用@Env</h3>
<p><code>@Env</code>在<code>@Component</code>中的使用方式和<code>@ComponentV2</code>类似，我们看看代码：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { uiObserver, <span class="hljs-title class_">UIUtils</span>, <span class="hljs-variable language_">window</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;
<span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;

<span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">Index</span> {
  <span class="hljs-comment">// 在@Component中也可以使用@Env</span>
  <span class="hljs-meta">@Env</span>(<span class="hljs-title class_">SystemProperties</span>.<span class="hljs-property">BREAK_POINT</span>) <span class="hljs-attr">breakpoint</span>: uiObserver.<span class="hljs-property">WindowSizeLayoutBreakpointInfo</span>;

  <span class="hljs-keyword">private</span> <span class="hljs-title function_">changeOrientation</span>(<span class="hljs-params">isLandscape: <span class="hljs-built_in">boolean</span></span>) {
    <span class="hljs-keyword">const</span> context = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>()?.<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getLastWindow</span>(context).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">lastWindow</span>) =&gt;</span> {
      lastWindow.<span class="hljs-title function_">setPreferredOrientation</span>(
        isLandscape ? <span class="hljs-variable language_">window</span>.<span class="hljs-property">Orientation</span>.<span class="hljs-property">LANDSCAPE</span> : <span class="hljs-variable language_">window</span>.<span class="hljs-property">Orientation</span>.<span class="hljs-property">PORTRAIT</span>
      );
    });
  }

  <span class="hljs-title function_">orientationChange</span>(<span class="hljs-params">mon: IMonitor</span>) {
    mon.<span class="hljs-property">dirty</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">path: <span class="hljs-built_in">string</span></span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`<span class="hljs-subst">${path}</span> changes from <span class="hljs-subst">${mon.value(path)?.before}</span> to <span class="hljs-subst">${mon.value(path)?.now}</span>`</span>);
    })
  }

  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-comment">// 同样可以使用addMonitor监听</span>
    <span class="hljs-title class_">UIUtils</span>.<span class="hljs-title function_">addMonitor</span>(
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">breakpoint</span>,
      [<span class="hljs-string">'widthBreakpoint'</span>, <span class="hljs-string">'heightBreakpoint'</span>],
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">orientationChange</span>
    );
  }

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>() {
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`Index breakpoint width: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.breakpoint.widthBreakpoint}</span>`</span>).<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`Index breakpoint height: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.breakpoint.heightBreakpoint}</span>`</span>).<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)

      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'Landscape'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">changeOrientation</span>(<span class="hljs-literal">true</span>);
      })

      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'Portrait'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">changeOrientation</span>(<span class="hljs-literal">false</span>);
      })

      <span class="hljs-title class_">CompV2</span>({ <span class="hljs-attr">breakpoint</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">breakpoint</span> })
      <span class="hljs-title class_">Comp</span>({ <span class="hljs-attr">breakpoint</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">breakpoint</span> })
    }
  }
}

<span class="hljs-comment">// 子组件使用方式相同</span>
<span class="hljs-meta">@ComponentV2</span>
struct <span class="hljs-title class_">CompV2</span> {
  <span class="hljs-meta">@Require</span> <span class="hljs-meta">@Param</span> <span class="hljs-attr">breakpoint</span>: uiObserver.<span class="hljs-property">WindowSizeLayoutBreakpointInfo</span>;

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>() {
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`CompV2 breakpoint width: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.breakpoint.widthBreakpoint}</span>`</span>).<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`CompV2 breakpoint height: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.breakpoint.heightBreakpoint}</span>`</span>).<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)
    }
  }
}

<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">Comp</span> {
  <span class="hljs-meta">@Require</span> <span class="hljs-attr">breakpoint</span>: uiObserver.<span class="hljs-property">WindowSizeLayoutBreakpointInfo</span>;

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>() {
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`Comp breakpoint width: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.breakpoint.widthBreakpoint}</span>`</span>).<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`Comp breakpoint height: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.breakpoint.heightBreakpoint}</span>`</span>).<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)
    }
  }
}
</code></pre>
<p>可以看到，<code>@Component</code>和<code>@ComponentV2</code>中使用<code>@Env</code>的方式基本一致，主要区别在于子组件接收参数的方式。</p>
<h3 data-id="heading-11">3. 变量传递规则</h3>
<p><code>@Env</code>装饰的变量在组件间传递有严格的规则，我们需要特别注意：</p>
<h4 data-id="heading-12">（1）传递给ComponentV2子组件</h4>
<p><code>@Env</code>装饰的变量<strong>只能</strong>用于初始化<code>@ComponentV2</code>中<code>@Param</code>装饰的变量：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">Index</span> {
  <span class="hljs-meta">@Env</span>(<span class="hljs-title class_">SystemProperties</span>.<span class="hljs-property">BREAK_POINT</span>) <span class="hljs-attr">breakpoint</span>: uiObserver.<span class="hljs-property">WindowSizeLayoutBreakpointInfo</span>;

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>() {
      <span class="hljs-comment">// ✅ 正确：传递给@Param</span>
      <span class="hljs-title class_">CompV2</span>({ <span class="hljs-attr">breakpoint</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">breakpoint</span> })

      <span class="hljs-comment">// ❌ 错误：不能传递给非@Param变量</span>
      <span class="hljs-title class_">CompV2Invalid</span>({ <span class="hljs-attr">breakpoint</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">breakpoint</span> })
    }
  }
}

<span class="hljs-meta">@ComponentV2</span>
struct <span class="hljs-title class_">CompV2</span> {
  <span class="hljs-comment">// ✅ 正确：使用@Require @Param接收</span>
  <span class="hljs-meta">@Require</span> <span class="hljs-meta">@Param</span> <span class="hljs-attr">breakpoint</span>: uiObserver.<span class="hljs-property">WindowSizeLayoutBreakpointInfo</span>;

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// ...</span>
  }
}

<span class="hljs-meta">@ComponentV2</span>
struct <span class="hljs-title class_">CompV2Invalid</span> {
  <span class="hljs-comment">// ❌ 错误：缺少@Param</span>
  <span class="hljs-meta">@Require</span> <span class="hljs-attr">breakpoint</span>: uiObserver.<span class="hljs-property">WindowSizeLayoutBreakpointInfo</span>;

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// ...</span>
  }
}
</code></pre>
<h4 data-id="heading-13">（2）传递给Component子组件</h4>
<p><code>@Env</code>装饰的变量<strong>只能</strong>用于初始化<code>@Component</code>中的常规变量：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">Index</span> {
  <span class="hljs-meta">@Env</span>(<span class="hljs-title class_">SystemProperties</span>.<span class="hljs-property">BREAK_POINT</span>) <span class="hljs-attr">breakpoint</span>: uiObserver.<span class="hljs-property">WindowSizeLayoutBreakpointInfo</span>;

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>() {
      <span class="hljs-comment">// ✅ 正确：传递给常规变量</span>
      <span class="hljs-title class_">Comp</span>({ <span class="hljs-attr">breakpoint</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">breakpoint</span> })

      <span class="hljs-comment">// ❌ 错误：不能传递给@ObjectLink等</span>
      <span class="hljs-title class_">CompInvalid</span>({ <span class="hljs-attr">breakpoint</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">breakpoint</span> })
    }
  }
}

<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">Comp</span> {
  <span class="hljs-comment">// ✅ 正确：使用@Require接收常规变量</span>
  <span class="hljs-meta">@Require</span> <span class="hljs-attr">breakpoint</span>: uiObserver.<span class="hljs-property">WindowSizeLayoutBreakpointInfo</span>;

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// ...</span>
  }
}

<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">CompInvalid</span> {
  <span class="hljs-comment">// ❌ 错误：不能使用@ObjectLink</span>
  <span class="hljs-meta">@ObjectLink</span> <span class="hljs-attr">breakpoint</span>: uiObserver.<span class="hljs-property">WindowSizeLayoutBreakpointInfo</span>;

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// ...</span>
  }
}
</code></pre>
<p><strong>重要提示</strong>：通过<code>BuilderNode</code>切换窗口时，会导致<code>@Env</code>依据新的窗口更新环境变量实例。在切换窗口的场景中，不建议使用<code>@Env</code>变量来初始化子组件的常规变量，否则会造成该常规变量无法被<code>@Env</code>通知触发其关联UI组件刷新。具体解决方案我们会在高级场景中介绍。</p>
<h2 data-id="heading-14">六、@Env初始化流程详解</h2>
<p><code>@Env</code>变量不允许开发者初始化，其值由框架根据当前窗口的环境变量自动提供。<code>@Env</code>变量在被第一次读值的时候，会触发初始化。初始化遵循以下流程：</p>
<h3 data-id="heading-15">1. 从父组件中查找已有实例</h3>
<p>框架会向上递归查找父组件：</p>
<ul>
<li>如果某个父组件在同一窗口中已经初始化过相同key的<code>@Env</code>变量，则直接复用该实例</li>
<li>若未找到，则继续向上查找，直到父组件为空</li>
<li><strong>注意</strong>：向上查找父组件的流程会被<code>BuilderNode</code>打断</li>
</ul>
<h3 data-id="heading-16">2. 查找当前窗口的@Env实例</h3>
<p>如果在父组件中未找到对应的实例，则检查当前窗口是否已有相同key的<code>@Env</code>变量实例：</p>
<ul>
<li>如存在，则复用该窗口内的<code>@Env</code>实例</li>
</ul>
<h3 data-id="heading-17">3. 首次请求：创建新环境变量实例</h3>
<p>若以上两步都无法得到实例，则说明当前窗口第一次读取该环境变量：</p>
<ul>
<li>框架会创建一个新的可观察环境变量实例</li>
<li>将该实例与当前窗口绑定</li>
<li>完成初始化</li>
</ul>
<h3 data-id="heading-18">初始化示例</h3>
<p>我们通过一个例子来理解这个流程：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { uiObserver } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;

<span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">Index</span> {
  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>() {
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`Index`</span>)
      <span class="hljs-title class_">Child1</span>()  <span class="hljs-comment">// Child1会创建新的@Env实例</span>
      <span class="hljs-title class_">Child2</span>()  <span class="hljs-comment">// Child2的子组件会复用窗口中的实例</span>
    }
    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)
    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
  }
}

<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">Child1</span> {
  <span class="hljs-comment">// 第一次读取，会创建新实例并绑定到窗口</span>
  <span class="hljs-meta">@Env</span>(<span class="hljs-title class_">SystemProperties</span>.<span class="hljs-property">BREAK_POINT</span>) <span class="hljs-attr">breakpoint</span>: uiObserver.<span class="hljs-property">WindowSizeLayoutBreakpointInfo</span>;

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>() {
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`Child1 breakpoint width: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.breakpoint.widthBreakpoint}</span>`</span>).<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`Child1 breakpoint height: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.breakpoint.heightBreakpoint}</span>`</span>).<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)
      <span class="hljs-title class_">GrandChild1</span>()  <span class="hljs-comment">// GrandChild1会复用Child1的实例</span>
    }
  }
}

<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">Child2</span> {
  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>() {
      <span class="hljs-title class_">GrandChild2</span>()  <span class="hljs-comment">// GrandChild2会复用窗口中的实例</span>
    }
  }
}

<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">GrandChild1</span> {
  <span class="hljs-comment">// 向上查找父组件，找到Child1的实例，直接复用</span>
  <span class="hljs-meta">@Env</span>(<span class="hljs-title class_">SystemProperties</span>.<span class="hljs-property">BREAK_POINT</span>) <span class="hljs-attr">breakpoint</span>: uiObserver.<span class="hljs-property">WindowSizeLayoutBreakpointInfo</span>;

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>() {
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`GrandChild1 breakpoint width: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.breakpoint.widthBreakpoint}</span>`</span>).<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`GrandChild1 breakpoint height: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.breakpoint.heightBreakpoint}</span>`</span>).<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)
    }
  }
}

<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">GrandChild2</span> {
  <span class="hljs-comment">// 向上查找父组件，没找到</span>
  <span class="hljs-comment">// 查找当前窗口，找到Child1创建的实例，复用</span>
  <span class="hljs-meta">@Env</span>(<span class="hljs-title class_">SystemProperties</span>.<span class="hljs-property">BREAK_POINT</span>) <span class="hljs-attr">breakpoint</span>: uiObserver.<span class="hljs-property">WindowSizeLayoutBreakpointInfo</span>;

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>() {
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`GrandChild2 breakpoint width: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.breakpoint.widthBreakpoint}</span>`</span>).<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`GrandChild2 breakpoint height: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.breakpoint.heightBreakpoint}</span>`</span>).<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)
    }
  }
}
</code></pre>
<p>初始化流程总结：</p>
<ul>
<li><strong>Child1初始化</strong>：向上查找父组件Index，没有实例 → 查找当前窗口，没有实例 → 创建新实例并绑定到窗口</li>
<li><strong>GrandChild1初始化</strong>：向上查找父组件Child1，找到实例 → 直接复用</li>
<li><strong>GrandChild2初始化</strong>：向上查找父组件Child2和Index，没有实例 → 查找当前窗口，找到Child1创建的实例 → 复用</li>
</ul>
<h2 data-id="heading-19">七、@Env的限制条件</h2>
<p>使用<code>@Env</code>时需要注意以下限制条件，违反这些条件会导致编译时报错：</p>
<h3 data-id="heading-20">1. 只能在组件中使用</h3>
<p><code>@Env</code>仅支持在<code>@Component</code>和<code>@ComponentV2</code>中使用，否则会有编译时报错：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { uiObserver } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;

<span class="hljs-comment">// ❌ 错误：不能在普通类中使用</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Info</span> {
  <span class="hljs-meta">@Env</span>(<span class="hljs-title class_">SystemProperties</span>.<span class="hljs-property">BREAK_POINT</span>) <span class="hljs-attr">breakpoint</span>: uiObserver.<span class="hljs-property">WindowSizeLayoutBreakpointInfo</span>; <span class="hljs-comment">// 编译时报错</span>
}

<span class="hljs-comment">// ✅ 正确：在组件中使用</span>
<span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">Index</span> {
  <span class="hljs-meta">@Env</span>(<span class="hljs-title class_">SystemProperties</span>.<span class="hljs-property">BREAK_POINT</span>) <span class="hljs-attr">breakpoint</span>: uiObserver.<span class="hljs-property">WindowSizeLayoutBreakpointInfo</span>; <span class="hljs-comment">// 正确用法</span>

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
  }
}
</code></pre>
<h3 data-id="heading-21">2. 只读属性，不允许初始化</h3>
<p><code>@Env</code>装饰的变量为只读属性，不允许开发者进行初始化或赋值操作：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { uiObserver } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;

<span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">Index</span> {
  <span class="hljs-comment">// ❌ 错误：不能初始化</span>
  <span class="hljs-meta">@Env</span>(<span class="hljs-title class_">SystemProperties</span>.<span class="hljs-property">BREAK_POINT</span>) <span class="hljs-attr">breakpoint</span>: uiObserver.<span class="hljs-property">WindowSizeLayoutBreakpointInfo</span> =
    <span class="hljs-keyword">new</span> uiObserver.<span class="hljs-title class_">WindowSizeLayoutBreakpointInfo</span>(); <span class="hljs-comment">// 编译时报错</span>

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>() {
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`breakpoint height <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.breakpoint.heightBreakpoint}</span>`</span>).<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`breakpoint width <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.breakpoint.widthBreakpoint}</span>`</span>).<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)
      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'change breakpoint'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-comment">// ❌ 错误：不能赋值</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">breakpoint</span> = <span class="hljs-keyword">new</span> uiObserver.<span class="hljs-title class_">WindowSizeLayoutBreakpointInfo</span>(); <span class="hljs-comment">// 编译时报错</span>
      })
    }
  }
}
</code></pre>
<h3 data-id="heading-22">3. 仅支持BREAK_POINT参数</h3>
<p><code>@Env</code>当前仅支持<code>SystemProperties.BREAK_POINT</code>参数。若使用不支持的参数，将触发编译时报错：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { uiObserver } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;

<span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">Index</span> {
  <span class="hljs-comment">// ✅ 正确：使用BREAK_POINT</span>
  <span class="hljs-meta">@Env</span>(<span class="hljs-title class_">SystemProperties</span>.<span class="hljs-property">BREAK_POINT</span>) <span class="hljs-attr">breakpoint1</span>: uiObserver.<span class="hljs-property">WindowSizeLayoutBreakpointInfo</span>;

  <span class="hljs-comment">// ❌ 错误：使用不支持的参数</span>
  <span class="hljs-meta">@Env</span>(<span class="hljs-string">'unsupported_key'</span>) <span class="hljs-attr">breakpoint2</span>: uiObserver.<span class="hljs-property">WindowSizeLayoutBreakpointInfo</span>; <span class="hljs-comment">// 编译时报错</span>

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Text</span>(<span class="hljs-string">`breakpoint2 width: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.breakpoint2.widthBreakpoint}</span> height: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.breakpoint2.heightBreakpoint}</span>`</span>)
  }
}
</code></pre>
<h3 data-id="heading-23">4. 类型限制</h3>
<p><code>@Env</code>装饰的变量类型仅能为<code>uiObserver.WindowSizeLayoutBreakpointInfo</code>类型：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { uiObserver } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;

<span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">Index</span> {
  <span class="hljs-comment">// ✅ 正确：使用WindowSizeLayoutBreakpointInfo类型</span>
  <span class="hljs-meta">@Env</span>(<span class="hljs-title class_">SystemProperties</span>.<span class="hljs-property">BREAK_POINT</span>) <span class="hljs-attr">breakpoint1</span>: uiObserver.<span class="hljs-property">WindowSizeLayoutBreakpointInfo</span>;

  <span class="hljs-comment">// ❌ 错误：类型不匹配</span>
  <span class="hljs-meta">@Env</span>(<span class="hljs-title class_">SystemProperties</span>.<span class="hljs-property">BREAK_POINT</span>) <span class="hljs-attr">breakpoint2</span>: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 编译时报错</span>

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
  }
}
</code></pre>
<h3 data-id="heading-24">5. 不能与其他装饰器联用</h3>
<p><code>@Env</code>只能单独使用，不能和其他V1V2状态变量装饰器或<code>@Require</code>联用：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ✅ 正确：单独使用</span>
<span class="hljs-meta">@Env</span>(<span class="hljs-title class_">SystemProperties</span>.<span class="hljs-property">BREAK_POINT</span>) <span class="hljs-attr">breakpoint1</span>: uiObserver.<span class="hljs-property">WindowSizeLayoutBreakpointInfo</span>;

<span class="hljs-comment">// ❌ 错误：不能和@State联用</span>
<span class="hljs-meta">@State</span> <span class="hljs-meta">@Env</span>(<span class="hljs-title class_">SystemProperties</span>.<span class="hljs-property">BREAK_POINT</span>) <span class="hljs-attr">breakpoint2</span>: uiObserver.<span class="hljs-property">WindowSizeLayoutBreakpointInfo</span>; <span class="hljs-comment">// 编译时报错</span>

<span class="hljs-comment">// ❌ 错误：不能和@Require联用</span>
<span class="hljs-meta">@Require</span> <span class="hljs-meta">@Env</span>(<span class="hljs-title class_">SystemProperties</span>.<span class="hljs-property">BREAK_POINT</span>) <span class="hljs-attr">breakpoint3</span>: uiObserver.<span class="hljs-property">WindowSizeLayoutBreakpointInfo</span>; <span class="hljs-comment">// 编译时报错</span>

<span class="hljs-comment">// ❌ 错误：不能和@Local联用</span>
<span class="hljs-meta">@Local</span> <span class="hljs-meta">@Env</span>(<span class="hljs-title class_">SystemProperties</span>.<span class="hljs-property">BREAK_POINT</span>) <span class="hljs-attr">breakpoint4</span>: uiObserver.<span class="hljs-property">WindowSizeLayoutBreakpointInfo</span>; <span class="hljs-comment">// 编译时报错</span>
</code></pre>
<h2 data-id="heading-25">八、高级场景：通过BuilderNode切换窗口</h2>
<p><code>@Env</code>用于展示<code>@Component</code>/<code>@ComponentV2</code>所在窗口的环境变量信息。当我们通过<code>BuilderNode</code>切换组件所在的窗口实例时，<code>@Env</code>会根据新的窗口获取对应的环境变量信息，并触发关联的UI组件刷新。</p>
<h3 data-id="heading-26">场景说明</h3>
<p>在下面的示例中，我们演示了如何通过<code>BuilderNode</code>在不同窗口间切换，以及<code>@Env</code>的行为：</p>
<ol>
<li>点击<code>Button('add node to tree')</code>，创建<code>BuilderNode</code>节点挂载到<code>NodeContainer</code>下</li>
<li>点击<code>Button('remove node from tree')</code>，将<code>BuilderNode</code>节点从<code>NodeContainer</code>上移除</li>
<li>点击<code>Button('create sub window')</code>，创建子窗并显示<code>SubWindow</code>窗口</li>
<li>点击<code>SubWindow</code>窗口内的<code>Button('add node to tree')</code>，将<code>BuilderNode</code>节点重新挂载到<code>SubWindow</code>内的<code>NodeContainer</code>下</li>
</ol>
<p>当<code>ComponentUnderBuilderNode</code>被挂载到新的窗口下时，会触发<code>@Env</code>重新获取新的环境变量。</p>
<h3 data-id="heading-27">完整示例代码</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// EntryAbility.ets</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">UIAbility</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;
<span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable language_">window</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DOMAIN</span> = <span class="hljs-number">0x0000</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {
  <span class="hljs-title function_">onWindowStageCreate</span>(<span class="hljs-params">windowStage: <span class="hljs-variable language_">window</span>.WindowStage</span>) {
    windowStage.<span class="hljs-title function_">loadContent</span>(<span class="hljs-string">'pages/Index'</span>, <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (err.<span class="hljs-property">code</span>) {
        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Failed to load the content. Cause: %{public}s'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err));
        <span class="hljs-keyword">return</span>;
      }
      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Succeeded in loading the content.'</span>);
    })

    <span class="hljs-comment">// 给Index页面传递windowStage</span>
    <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'windowStage'</span>, windowStage);
  }
}

<span class="hljs-comment">// Index.ets</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">BuilderNode</span>, <span class="hljs-title class_">FrameNode</span>, <span class="hljs-title class_">NodeController</span>, uiObserver, <span class="hljs-variable language_">window</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;
<span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DOMAIN</span> = <span class="hljs-number">0x0000</span>;

<span class="hljs-keyword">let</span> <span class="hljs-attr">windowStage_</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">WindowStage</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;
<span class="hljs-keyword">let</span> <span class="hljs-attr">sub_windowClass</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">Window</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;
<span class="hljs-keyword">let</span> <span class="hljs-attr">globalBuilderNode</span>: <span class="hljs-title class_">BuilderNode</span>&lt;[]&gt; | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;

<span class="hljs-comment">// NodeController用于管理BuilderNode</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyNodeController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">NodeController</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">rootNode</span>: <span class="hljs-title class_">FrameNode</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">uiContext</span>: <span class="hljs-title class_">UIContext</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

  <span class="hljs-title function_">makeNode</span>(<span class="hljs-attr">uiContext</span>: <span class="hljs-title class_">UIContext</span>): <span class="hljs-title class_">FrameNode</span> | <span class="hljs-literal">null</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FrameNode</span>(uiContext);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span> = uiContext;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span>;
  }

  <span class="hljs-comment">// 添加BuilderNode到树中</span>
  <span class="hljs-title function_">addBuilderNode</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">if</span> (!globalBuilderNode &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>) {
      globalBuilderNode = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderNode</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>);
      globalBuilderNode.<span class="hljs-title function_">build</span>(wrapBuilder&lt;[]&gt;(buildComponent), <span class="hljs-literal">undefined</span>);
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span> &amp;&amp; globalBuilderNode) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span>.<span class="hljs-title function_">appendChild</span>(globalBuilderNode.<span class="hljs-title function_">getFrameNode</span>());
    }
  }

  <span class="hljs-comment">// 从树中移除BuilderNode</span>
  <span class="hljs-title function_">removeBuilderNode</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span> &amp;&amp; globalBuilderNode) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span>.<span class="hljs-title function_">removeChild</span>(globalBuilderNode.<span class="hljs-title function_">getFrameNode</span>());
    }
  }

  <span class="hljs-comment">// 销毁BuilderNode</span>
  <span class="hljs-title function_">disposeNode</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">rootNode</span> &amp;&amp; globalBuilderNode) {
      globalBuilderNode.<span class="hljs-title function_">dispose</span>();
      globalBuilderNode = <span class="hljs-literal">undefined</span>;
    }
  }
}

<span class="hljs-comment">// Builder函数，构建要挂载的组件</span>
<span class="hljs-meta">@Builder</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">buildComponent</span>(<span class="hljs-params"/>) {
  <span class="hljs-title class_">Column</span>() {
    <span class="hljs-title class_">ComponentUnderBuilderNode</span>()
  }
}

<span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@ComponentV2</span>
struct <span class="hljs-title class_">Index</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">nodeController</span>: <span class="hljs-title class_">MyNodeController</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyNodeController</span>();

  <span class="hljs-comment">// 创建子窗口</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">createSubWindow</span>(<span class="hljs-params"/>) {
    windowStage_ = <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'windowStage'</span>);
    <span class="hljs-keyword">if</span> (windowStage_ == <span class="hljs-literal">null</span>) {
      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Failed to create the subwindow. Cause: windowStage_ is null'</span>);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 创建应用子窗口</span>
      windowStage_.<span class="hljs-title function_">createSubWindow</span>(<span class="hljs-string">'mySubWindow'</span>, <span class="hljs-function">(<span class="hljs-params">err: BusinessError, data</span>) =&gt;</span> {
        <span class="hljs-keyword">let</span> <span class="hljs-attr">errCode</span>: <span class="hljs-built_in">number</span> = err.<span class="hljs-property">code</span>;
        <span class="hljs-keyword">if</span> (errCode) {
          hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Failed to create the subwindow. Cause: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err));
          <span class="hljs-keyword">return</span>;
        }
        sub_windowClass = data;
        <span class="hljs-keyword">if</span> (!sub_windowClass) {
          hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'sub_windowClass is null'</span>);
          <span class="hljs-keyword">return</span>;
        }
        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Succeeded in creating the subwindow. Data: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data));
        
        <span class="hljs-comment">// 子窗口创建成功后，设置子窗口的位置、大小及相关属性等</span>
        sub_windowClass.<span class="hljs-title function_">moveWindowTo</span>(<span class="hljs-number">200</span>, <span class="hljs-number">1300</span>, <span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {
          <span class="hljs-keyword">let</span> <span class="hljs-attr">errCode</span>: <span class="hljs-built_in">number</span> = err.<span class="hljs-property">code</span>;
          <span class="hljs-keyword">if</span> (errCode) {
            hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Failed to move the window. Cause:'</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err));
            <span class="hljs-keyword">return</span>;
          }
          hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Succeeded in moving the window.'</span>);
        });
        
        sub_windowClass.<span class="hljs-title function_">resize</span>(<span class="hljs-number">900</span>, <span class="hljs-number">1800</span>, <span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {
          <span class="hljs-keyword">let</span> <span class="hljs-attr">errCode</span>: <span class="hljs-built_in">number</span> = err.<span class="hljs-property">code</span>;
          <span class="hljs-keyword">if</span> (errCode) {
            hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Failed to change the window size. Cause:'</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err));
            <span class="hljs-keyword">return</span>;
          }
          hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Succeeded in changing the window size.'</span>);
        });
        
        <span class="hljs-comment">// 为子窗口加载对应的目标页面</span>
        sub_windowClass.<span class="hljs-title function_">setUIContent</span>(<span class="hljs-string">'pages/SubWindow'</span>, <span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {
          <span class="hljs-keyword">let</span> <span class="hljs-attr">errCode</span>: <span class="hljs-built_in">number</span> = err.<span class="hljs-property">code</span>;
          <span class="hljs-keyword">if</span> (errCode) {
            hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Failed to load the content. Cause:'</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err));
            <span class="hljs-keyword">return</span>;
          }
          hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Succeeded in loading the content.'</span>);
          <span class="hljs-keyword">if</span> (!sub_windowClass) {
            hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'sub_windowClass is null'</span>);
            <span class="hljs-keyword">return</span>;
          }
          sub_windowClass.<span class="hljs-title function_">showWindow</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {
            <span class="hljs-keyword">let</span> <span class="hljs-attr">errCode</span>: <span class="hljs-built_in">number</span> = err.<span class="hljs-property">code</span>;
            <span class="hljs-keyword">if</span> (errCode) {
              hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Failed to show the window. Cause: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err));
              <span class="hljs-keyword">return</span>;
            }
            hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'Succeeded in showing the window.'</span>);
          });
        });
      })
    }
  }

  <span class="hljs-comment">// 销毁子窗口</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">destroySubWindow</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (!sub_windowClass) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'sub_windowClass is null'</span>);
      <span class="hljs-keyword">return</span>;
    }
    sub_windowClass.<span class="hljs-title function_">destroyWindow</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {
      <span class="hljs-keyword">let</span> <span class="hljs-attr">errCode</span>: <span class="hljs-built_in">number</span> = err.<span class="hljs-property">code</span>;
      <span class="hljs-keyword">if</span> (errCode) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to destroy the window. Cause: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err));
        <span class="hljs-keyword">return</span>;
      }
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Succeeded in destroying the window.'</span>);
    });
  }

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">10</span> }) {
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`Index`</span>)
      <span class="hljs-comment">// 第一步：创建globalBuilderNode，并将globalBuilderNode下的节点挂在NodeContainer的占位节点下</span>
      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'add node to tree'</span>).<span class="hljs-title function_">width</span>(<span class="hljs-number">200</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">nodeController</span>.<span class="hljs-title function_">addBuilderNode</span>();
      })
      <span class="hljs-comment">// 第二步：从NodeContainer的占位节点下移除globalBuilderNode下的节点</span>
      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'remove node from tree'</span>).<span class="hljs-title function_">width</span>(<span class="hljs-number">200</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">nodeController</span>.<span class="hljs-title function_">removeBuilderNode</span>();
      })
      <span class="hljs-comment">// 销毁globalBuilderNode下的节点</span>
      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'dispose node'</span>).<span class="hljs-title function_">width</span>(<span class="hljs-number">200</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">nodeController</span>.<span class="hljs-title function_">disposeNode</span>();
      })
      <span class="hljs-comment">// 第三步：创建子窗</span>
      <span class="hljs-title class_">Button</span>(<span class="hljs-string">`create sub window`</span>).<span class="hljs-title function_">width</span>(<span class="hljs-number">200</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createSubWindow</span>();
      })
      <span class="hljs-comment">// 销毁子窗</span>
      <span class="hljs-title class_">Button</span>(<span class="hljs-string">`destroy sub window`</span>).<span class="hljs-title function_">width</span>(<span class="hljs-number">200</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">destroySubWindow</span>();
      })
      <span class="hljs-title class_">NodeContainer</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">nodeController</span>).<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#FFEEF0'</span>)
    }
    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)
  }
}

<span class="hljs-comment">// 在BuilderNode下的组件，使用@Env</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">ComponentUnderBuilderNode</span> {
  <span class="hljs-comment">// @Env会根据组件所在的窗口获取环境变量</span>
  <span class="hljs-meta">@Env</span>(<span class="hljs-title class_">SystemProperties</span>.<span class="hljs-property">BREAK_POINT</span>) <span class="hljs-attr">breakpoint</span>: uiObserver.<span class="hljs-property">WindowSizeLayoutBreakpointInfo</span>;

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>() {
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`ComponentUnderBuilderNode breakpoint width: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.breakpoint.widthBreakpoint}</span>`</span>)
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`ComponentUnderBuilderNode breakpoint height: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.breakpoint.heightBreakpoint}</span>`</span>)

      <span class="hljs-comment">// 传递给ComponentV2子组件</span>
      <span class="hljs-title class_">CompV2</span>({ <span class="hljs-attr">breakpoint</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">breakpoint</span> })
      <span class="hljs-comment">// 传递给Component子组件（注意：在窗口切换场景下可能有问题）</span>
      <span class="hljs-title class_">Comp</span>({ <span class="hljs-attr">breakpoint</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">breakpoint</span> })
    }
  }
}

<span class="hljs-meta">@ComponentV2</span>
struct <span class="hljs-title class_">CompV2</span> {
  <span class="hljs-meta">@Require</span> <span class="hljs-meta">@Param</span> <span class="hljs-attr">breakpoint</span>: uiObserver.<span class="hljs-property">WindowSizeLayoutBreakpointInfo</span>;

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>() {
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`CompV2 breakpoint width: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.breakpoint.widthBreakpoint}</span>`</span>)
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`CompV2 breakpoint height: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.breakpoint.heightBreakpoint}</span>`</span>)
    }
  }
}

<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">Comp</span> {
  <span class="hljs-meta">@Require</span> <span class="hljs-attr">breakpoint</span>: uiObserver.<span class="hljs-property">WindowSizeLayoutBreakpointInfo</span>;

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>() {
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`Comp breakpoint width: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.breakpoint.widthBreakpoint}</span>`</span>)
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`Comp breakpoint height: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.breakpoint.heightBreakpoint}</span>`</span>)
    }
  }
}

<span class="hljs-comment">// SubWindow.ets</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">MyNodeController</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./Index'</span>;

<span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">SubWindow</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">nodeController</span>: <span class="hljs-title class_">MyNodeController</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyNodeController</span>();

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">10</span> }) {
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`SubWindow`</span>)
      <span class="hljs-comment">// 第四步：在第一步中已在创建globalBuilderNode。将globalBuilderNode下的节点挂子窗的NodeContainer的占位节点下</span>
      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'add node to tree'</span>).<span class="hljs-title function_">width</span>(<span class="hljs-number">200</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">nodeController</span>.<span class="hljs-title function_">addBuilderNode</span>();
      })
      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'remove node from tree'</span>).<span class="hljs-title function_">width</span>(<span class="hljs-number">200</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">nodeController</span>.<span class="hljs-title function_">removeBuilderNode</span>();
      })
      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'dispose node'</span>).<span class="hljs-title function_">width</span>(<span class="hljs-number">200</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">nodeController</span>.<span class="hljs-title function_">disposeNode</span>();
      })
      <span class="hljs-title class_">NodeContainer</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">nodeController</span>).<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#FFEEF0'</span>)
    }
    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)
    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#0D9FFB'</span>)
  }
}
</code></pre>
<h3 data-id="heading-28">重要提示</h3>
<p>在切换窗口的场景中，<code>@Env</code>重新获取新的环境变量后，会触发其关联组件的刷新。但是需要注意：</p>
<ul>
<li><code>ComponentUnderBuilderNode</code>中<code>@Env(SystemProperties.BREAK_POINT) breakpoint</code>会通知<code>CompV2</code>内的<code>@Param breakpoint</code>刷新</li>
<li><strong>但是并不会通知<code>Comp</code>内的常规变量<code>breakpoint</code>触发UI刷新</strong></li>
</ul>
<p>所以在切换窗口、<code>@Env</code>重新获取环境变量的场景下，<strong>建议开发者不要将<code>@Env</code>传递给常规变量</strong>，以避免常规变量不能被通知UI刷新的问题。</p>
<h3 data-id="heading-29">解决方案：使用lambda闭包函数</h3>
<p>可以使用lambda闭包函数将<code>ComponentUnderBuilderNode</code>中的<code>@Env</code>向下传递。通过这种方式，<code>@Env</code>可以收集到子组件<code>Comp</code>内组件的依赖，在切换窗口实例的时候触发<code>Comp</code>内组件的刷新。</p>
<p>具体示例如下：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">ComponentUnderBuilderNode</span> {
  <span class="hljs-meta">@Env</span>(<span class="hljs-title class_">SystemProperties</span>.<span class="hljs-property">BREAK_POINT</span>) <span class="hljs-attr">breakpoint</span>: uiObserver.<span class="hljs-property">WindowSizeLayoutBreakpointInfo</span>;

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>() {
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`ComponentUnderBuilderNode breakpoint width: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.breakpoint.widthBreakpoint}</span>`</span>)
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`ComponentUnderBuilderNode breakpoint height: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.breakpoint.heightBreakpoint}</span>`</span>)

      <span class="hljs-title class_">CompV2</span>({ <span class="hljs-attr">breakpoint</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">breakpoint</span> })
      <span class="hljs-comment">// 通过lambda闭包函数，使得@Env可以关联到Comp内的组件</span>
      <span class="hljs-title class_">Comp</span>({ <span class="hljs-attr">getEnv</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">breakpoint</span> })
    }
  }
}

<span class="hljs-meta">@ComponentV2</span>
struct <span class="hljs-title class_">CompV2</span> {
  <span class="hljs-meta">@Require</span> <span class="hljs-meta">@Param</span> <span class="hljs-attr">breakpoint</span>: uiObserver.<span class="hljs-property">WindowSizeLayoutBreakpointInfo</span>;

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>() {
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`CompV2 breakpoint width: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.breakpoint.widthBreakpoint}</span>`</span>)
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`CompV2 breakpoint height: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.breakpoint.heightBreakpoint}</span>`</span>)
    }
  }
}

<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">Comp</span> {
  <span class="hljs-comment">// 通过lambda闭包函数获取父组件的@Env的实例</span>
  <span class="hljs-meta">@Require</span> <span class="hljs-attr">getEnv</span>: <span class="hljs-function">() =&gt;</span> uiObserver.<span class="hljs-property">WindowSizeLayoutBreakpointInfo</span>;

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>() {
      <span class="hljs-comment">// 调用闭包函数获取最新的环境变量</span>
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`Comp breakpoint width: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.getEnv().widthBreakpoint}</span>`</span>)
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`Comp breakpoint height: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.getEnv().heightBreakpoint}</span>`</span>)
    }
  }
}
</code></pre>
<p>通过lambda闭包函数的方式，<code>Comp</code>组件可以正确响应<code>@Env</code>的变化，即使在窗口切换的场景下也能正常工作。</p>
<h2 data-id="heading-30">九、结尾/总结</h2>
<p>好了，关于<code>@Env</code>的内容我们就介绍到这里。总结一下：</p>
<p><code>@Env</code>是API 22引入的响应式系统环境变量装饰器，它的核心价值在于：</p>
<ol>
<li><strong>响应式能力</strong>：系统环境变量变化时自动触发UI刷新，无需手动管理</li>
<li><strong>简化代码</strong>：减少了大量重复的适配逻辑和监听代码</li>
<li><strong>多设备适配</strong>：特别适合多设备开发场景，尤其是响应式布局和横竖屏适配</li>
</ol>
<p>虽然<code>@Env</code>目前只支持<code>BREAK_POINT</code>参数（这不是虽然了，这是很遗憾。），但在窗口断点相关的场景中，它比<code>Environment</code>更加方便和强大。如果你需要其他环境变量（如语言、主题等），还是需要使用<code>Environment</code>。</p>
<p>总的来说，<code>@Env</code>是一个很好的补充，让我们的开发变得更加简单，少写点，稍微维护点代码，虽然现在可用性不高。随着API版本的迭代，<code>@Env</code>会支持更多的环境变量参数，到时候它的价值会更加明显（越快越好）。</p>
<p>如果您有任何疑问、对文章写的不满意、发现错误或者有更好的方法，欢迎在评论、私信或邮件中提出，非常感谢您的支持。🙏</p>
<h2 data-id="heading-31">十、感谢</h2>
<p>各位读者老爷</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[微服务架构核心组件、职责与交互全解析]]></title>    <link>https://juejin.cn/post/7592846242175352866</link>    <guid>https://juejin.cn/post/7592846242175352866</guid>    <pubDate>2026-01-08T16:23:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592846242175352866" data-draft-id="7592615536385753122" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="微服务架构核心组件、职责与交互全解析"/> <meta itemprop="keywords" content="Spring Cloud"/> <meta itemprop="datePublished" content="2026-01-08T16:23:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="元Y亨H"/> <meta itemprop="url" content="https://juejin.cn/user/2839351584888617"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            微服务架构核心组件、职责与交互全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2839351584888617/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    元Y亨H
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T16:23:40.000Z" title="Thu Jan 08 2026 16:23:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><hr/>
<h2 data-id="heading-0">微服务架构核心组件、职责与交互全解析</h2>
<h3 data-id="heading-1">一、 微服务全景架构图（分层）</h3>
<p>微服务不再是散乱的工程，而是一个分工明确的矩阵。通过分层，我们可以更清晰地看到请求是如何流转的。</p>
<pre><code class="hljs language-text" lang="text">==================== 流量接入层 (Entrance) ====================
        [ 外部客户端：App / H5 / Web / PC ]
                       │ (Restful API / HTTPS)
              ┌────────▼────────┐
              │  API 网关 (Gateway) │──► 职责：鉴权、路由、限流、日志
              └────────┬────────┘
                       │
==================== 业务服务层 (Services) ====================
        ┌──────────────┼──────────────┐
  ┌─────▼─────┐  ┌─────▼─────┐  ┌─────▼─────┐
  │  用户服务  │  │  订单服务  │  │  库存服务  │──► 职责：核心业务逻辑
  └─────┬─────┘  └─────┬─────┘  └─────┬─────┘
        │              │              │
        └──────────────┼──────────────┘
                       │ (Feign/RPC 调用)
                       │
==================== 服务治理层 (Control) =====================
  ┌────────────────────┼────────────────────┐
  │ ┌──────────────┐ ┌─┴────────────┐ ┌─────┴──────┐
  │ │ 注册发现中心 │ │ 统一配置中心 │ │ 熔断/限流器 │──► 职责：管理与保护
  │ │ (Nacos/Eureka)│ │ (Nacos/Apollo)│ │ (Sentinel) │
  │ └──────────────┘ └──────────────┘ └────────────┘
  └────────────────────┬────────────────────┘
                       │
==================== 基础设施/观测层 (Infrastructure) =========
  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐
  │   消息队列   │  │   分布式缓存 │  │   链路追踪   │──► 职责：异步、性能
  │  (Kafka/MQ)  │  │   (Redis)    │  │ (Skywalking) │     与系统监控
  └──────────────┘  └──────────────┘  └──────────────┘
</code></pre>
<hr/>
<h3 data-id="heading-2">二、 核心组件职能</h3>
<h4 data-id="heading-3">1. API 网关 (API Gateway) —— “保安与向导”</h4>
<ul>
<li><strong>核心作用</strong>：整个微服务系统的唯一入口。</li>
<li><strong>具体职责</strong>：
<ul>
<li><strong>路由转发</strong>：把 <code>/order</code> 的请求发给订单服务，把 <code>/user</code> 的请求发给用户服务。</li>
<li><strong>安全鉴权</strong>：统一判断用户是否登录、是否有权限访问，通过后才放行到后端。</li>
<li><strong>流量监控</strong>：在入口处记录日志，或者拦截恶意攻击。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-4">2. 服务注册与发现 (Service Registry) —— “动态通讯录”</h4>
<ul>
<li><strong>核心作用</strong>：记录每一个微服务实例的实时 IP 和端口。</li>
<li><strong>具体职责</strong>：
<ul>
<li><strong>注册</strong>：服务启动时主动上报自己的位置。</li>
<li><strong>发现</strong>：服务 A 想调服务 B 时，不用写死 IP，而是问注册中心：“B 现在在哪几台服务器上？”</li>
<li><strong>关联关系</strong>：<strong>它是微服务协同的基石</strong>。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-5">3. 配置中心 (Config Center) —— “中央广播站”</h4>
<ul>
<li><strong>核心作用</strong>：集中管理所有服务的配置文件。</li>
<li><strong>具体职责</strong>：
<ul>
<li><strong>配置解耦</strong>：代码里不写死数据库密码、业务开关等。</li>
<li><strong>动态生效</strong>：修改配置后，所有服务<strong>实时接收更新</strong>，不需要重新打包重启。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-6">4. 远程调用 (Feign / RPC) —— “部门内线电话”</h4>
<ul>
<li><strong>核心作用</strong>：让服务与服务之间能互相说话。</li>
<li><strong>具体职责</strong>：
<ul>
<li><strong>声明式调用</strong>：在代码里像调用本地方法一样去调用远程的其他服务。</li>
<li><strong>负载均衡</strong>：如果对方有 3 台机器，它会自动选择一台压力小的去访问。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-7">5. 熔断与限流 (Sentinel) —— “电力保险丝”</h4>
<ul>
<li><strong>核心作用</strong>：保护系统不因某个点坏掉而全盘崩溃。</li>
<li><strong>具体职责</strong>：
<ul>
<li><strong>限流</strong>：每秒只允许 500 人访问，超出的排队或拒绝，防止压垮服务器。</li>
<li><strong>熔断</strong>：如果发现“支付服务”挂了，立刻切断订单服务对它的调用，并返回一个友好的错误提示（降级），防止订单服务也被拖死。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-8">6. 消息队列 (Message Queue) —— “收发室快递柜”</h4>
<ul>
<li><strong>核心作用</strong>：解耦服务、异步处理。</li>
<li><strong>具体职责</strong>：
<ul>
<li><strong>削峰填谷</strong>：瞬时流量太猛时，先存入 MQ，后端服务按照自己的节奏慢慢消费。</li>
<li><strong>异步化</strong>：下单成功后，直接发个消息给 MQ。积分服务、短信服务自己去取消息处理，订单服务不用等它们执行完。</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-9">三、 组件间的生命周期与协作逻辑</h3>
<p>我们可以通过**“一个请求的一生”**来串联这些组件：</p>
<ol>
<li><strong>启动阶段</strong>：
<ul>
<li>所有微服务从 <strong>配置中心</strong> 拿到自己的配置（如数据库地址）。</li>
<li>微服务启动成功，把自己的 IP 登记到 <strong>注册中心</strong>。</li>
</ul>
</li>
<li><strong>请求进入</strong>：
<ul>
<li>用户请求到达 <strong>API 网关</strong>，网关先做身份校验。</li>
<li>校验通过后，网关去 <strong>注册中心</strong> 查一下哪个订单服务在线。</li>
</ul>
</li>
<li><strong>服务交互</strong>：
<ul>
<li>订单服务处理逻辑，需要查用户信息，通过 <strong>Feign</strong> 调用户服务。</li>
<li>此时 <strong>Sentinel</strong> 紧盯链路，如果用户服务太慢，Sentinel 启动限流或熔断。</li>
</ul>
</li>
<li><strong>数据沉淀与反馈</strong>：
<ul>
<li>订单处理完，往 <strong>MQ</strong> 丢一条消息通知其他服务。</li>
<li><strong>Skywalking</strong> 全程记录该请求走过的所有路径和时间。</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-10">四、 常见组件对比表</h3>








































<table><thead><tr><th align="left">维度</th><th align="left">主流推荐 (Spring Cloud Alibaba 体系)</th><th align="left">备选/经典组件</th></tr></thead><tbody><tr><td align="left"><strong>注册中心</strong></td><td align="left"><strong>Nacos</strong> (最推荐，国内最火)</td><td align="left">Eureka, Consul, Zookeeper</td></tr><tr><td align="left"><strong>配置中心</strong></td><td align="left"><strong>Nacos Config</strong></td><td align="left">Apollo (功能最强), Spring Cloud Config</td></tr><tr><td align="left"><strong>网关</strong></td><td align="left"><strong>Spring Cloud Gateway</strong></td><td align="left">Zuul (已过时), Kong, Nginx</td></tr><tr><td align="left"><strong>熔断限流</strong></td><td align="left"><strong>Sentinel</strong> (功能丰富，有管理后台)</td><td align="left">Hystrix (已停更)</td></tr><tr><td align="left"><strong>远程调用</strong></td><td align="left"><strong>OpenFeign</strong> / Dubbo</td><td align="left">RestTemplate</td></tr><tr><td align="left"><strong>链路追踪</strong></td><td align="left"><strong>Skywalking</strong> (无侵入，最强)</td><td align="left">Zipkin, Jaeger</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-11">五、 心法</h3>
<ol>
<li><strong>不要试图一次性学完所有组件</strong>：先搞定 Nacos + OpenFeign + Gateway，这就已经能搭出一个能跑的微服务了。</li>
<li><strong>理解比代码更重要</strong>：代码只是调用 API，理解“为什么要用网关？”“为什么需要注册中心？”才是微服务的核心。</li>
<li><strong>关注数据一致性</strong>：微服务最难的地方在于数据散落在不同数据库，以后你可以进阶学习 <strong>Seata</strong>（分布式事务）。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[记录一次sql优化记录]]></title>    <link>https://juejin.cn/post/7592863358258364470</link>    <guid>https://juejin.cn/post/7592863358258364470</guid>    <pubDate>2026-01-08T15:14:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592863358258364470" data-draft-id="7592818202717536275" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="记录一次sql优化记录"/> <meta itemprop="keywords" content="MySQL"/> <meta itemprop="datePublished" content="2026-01-08T15:14:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="哈里谢顿"/> <meta itemprop="url" content="https://juejin.cn/user/3678304397695056"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            记录一次sql优化记录
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3678304397695056/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    哈里谢顿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T15:14:37.000Z" title="Thu Jan 08 2026 15:14:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在工作中，被分配了一个django中，进行db查询优化的任务，该任务是解决db连接的问题，某个数据库信息查询任务大概每15分钟执行2200次，会有几次查询失败，需要定位解决</p>
<h2 data-id="heading-0">1 现象</h2>
<h2 data-id="heading-1">2 问题定位</h2>
<h2 data-id="heading-2">3 解决思路</h2>
<p>添加联合索引
定时清除不用的表数据</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Ooder企业级 AI-Agent 平台 《SkillFlow 智流白皮书》]]></title>    <link>https://juejin.cn/post/7592856733182902308</link>    <guid>https://juejin.cn/post/7592856733182902308</guid>    <pubDate>2026-01-08T15:21:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592856733182902308" data-draft-id="7592856733182853156" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Ooder企业级 AI-Agent 平台 《SkillFlow 智流白皮书》"/> <meta itemprop="keywords" content="开源,全栈"/> <meta itemprop="datePublished" content="2026-01-08T15:21:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="OneCodeCN"/> <meta itemprop="url" content="https://juejin.cn/user/1427583415622366"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Ooder企业级 AI-Agent 平台 《SkillFlow 智流白皮书》
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1427583415622366/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    OneCodeCN
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T15:21:25.000Z" title="Thu Jan 08 2026 15:21:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在AI技术规模化落地的浪潮中，企业对“多环节协同、自动化与人工融合、核心能力复用”的需求日益迫切。传统流程管控模式常面临“环节脱节、能力沉淀难、全流程不可控”等问题，难以适配复杂业务的灵活调度需求。</p>
<p>SkillFlow 智流 V0.5应运而生，定位为<strong>全生命周期流程协同平台</strong>，以“能力模块化、流程智能化、协同一体化”为核心，构建“低门槛构建+高效调度+全链路管控”的一体化解决方案。平台通过集中化技能管理实现核心能力复用，以灵活交互打通人工与自动化协同，凭借分布式调度提升复杂流程处理效率，最终帮助企业实现“流程简化、成本降低、管控精细化”的核心价值。</p>
<p>本白皮书将详细阐述SkillFlow 智流 V0.5的产品定位、核心架构、关键特性、应用场景及部署方案，为企业决策者、业务负责人及相关使用者提供全面的产品认知与落地参考。</p>
<h2 data-id="heading-1">一、产品概述</h2>
<h3 data-id="heading-2">1.1 核心定位</h3>
<p>SkillFlow 智流 V0.5是一款面向企业级用户的全生命周期流程协同平台，核心使命是“让复杂流程高效流转，让核心能力灵活复用”。平台以统一协议为入口，串联自动化流程、人工交互环节、模块化技能，通过集中化技能管理实现跨场景复用，构建覆盖“能力定义-流程编排-协同执行-全周期监控”的完整闭环。</p>
<h3 data-id="heading-3">1.2 核心价值</h3>
<ul>
<li><strong>全环节协同</strong>：打破自动化与人工交互的壁垒，实现不同流程环节的无缝衔接与数据贯通；</li>
<li><strong>模块化复用</strong>：将核心业务能力封装为可复用模块，支持跨业务线、跨节点快速调用；</li>
<li><strong>高效化流转</strong>：支持复杂任务的拆分与合并调度，最大化利用资源，提升流程处理效率；</li>
<li><strong>低门槛构建</strong>：简化流程与能力的定义方式，降低技术门槛，让业务人员也能参与流程搭建；</li>
<li><strong>全链路可控</strong>：覆盖从能力定义到流程执行的全生命周期监控，支持追溯与审计。</li>
</ul>
<h3 data-id="heading-4">1.3 适用场景</h3>
<ul>
<li>复杂业务流程自动化（如审批流程、数据分析流程、客户服务流程）；</li>
<li>人工与自动化混合协同场景（如需要人工审核、干预的智能决策流程）；</li>
<li>核心能力复用场景（如多业务线共享数据分析、内容生成、智能问答等能力）；</li>
<li>大规模跨节点协同场景（如跨地域、多部门的联合任务处理）。</li>
</ul>
<h2 data-id="heading-5">二、核心架构</h2>
<h3 data-id="heading-6">2.1 整体架构</h3>
<p>SkillFlow 智流 V0.5采用四层协同架构，各层级职责清晰、松耦合设计，确保平台的扩展性与灵活性：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f08ea213f2054c439f0556da4d25a8d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768490484&amp;x-signature=gmrCt7CaSbJHxADPT%2FJmiuF8IrE%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<h3 data-id="heading-7">2.2 层级职责说明</h3>






























<table><thead><tr><th>层级</th><th>核心组成</th><th>核心职责</th></tr></thead><tbody><tr><td>统一入口层</td><td>全局协同协议</td><td>建立统一的交互标准，管理流程上下文信息，适配不同业务场景，确保各环节数据一致。</td></tr><tr><td>流程调度层</td><td>自动化模块、人工交互模块、调度中心</td><td>承载流程执行，实现自动化与人工环节的统一调度；支持任务拆分与合并，通过负载分配提升效率；处理流程异常，保障流转顺畅。</td></tr><tr><td>能力管理层</td><td>能力定义、能力实例、集中化数据服务</td><td>将核心业务能力封装为模块化组件；通过集中化数据服务实现能力配置的存储、分发与版本管理；记录能力运行时状态与数据。</td></tr><tr><td>全周期管控层</td><td>定义管控、执行管控、历史管控</td><td>提供低门槛的能力与流程配置方式；实时监控流程与能力的运行状态，触发异常告警；记录全流程执行数据，支持审计与追溯。</td></tr></tbody></table>
<h3 data-id="heading-8">2.3 核心组件关系</h3>
<p>SkillFlow 智流 V0.5的核心组件形成清晰的层级关系，确保流程执行的有序性与可扩展性：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f652e5b5cd84e2b9832f4113d060875~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768490484&amp;x-signature=qG30ZZNdBMa%2F1kgznIn%2FTxUbrXI%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<ul>
<li><strong>核心入口（全局协同协议）</strong>：作为流程唯一入口，统一驱动所有执行环节，保障全局数据一致性；</li>
<li><strong>流程执行中心</strong>：包含自动化、人工、无状态三类执行模块，覆盖全场景流程需求；</li>
<li><strong>人工协同层</strong>：人工交互模块串联操作人员与权限管理，确保人工环节的安全可控与高效交互；</li>
<li><strong>模块化能力层</strong>：所有自动化模块均调用模块化能力集合执行具体任务，能力支持并行执行，是核心功能的最小复用单元。</li>
</ul>
<h2 data-id="heading-9">三、关键特性详解</h2>
<h3 data-id="heading-10">3.1 低门槛人工交互模块</h3>
<p>人工交互模块是平台打通“人工与自动化协同”的核心，以简洁配置实现高效交互，核心特性如下：</p>
<h4 data-id="heading-11">3.1.1 灵活配置式交互</h4>
<p>通过直观的配置方式定义交互规则、权限范围、数据展示格式，无需复杂开发，业务人员即可快速搭建适配业务场景的人工交互界面。</p>
<h4 data-id="heading-12">3.1.2 实时流式交互</h4>
<p>支持实时数据推送与反馈，操作人员可通过界面实时获取流程进度、前置环节结果，操作结果即时同步至流程，驱动后续环节继续执行，适配需要快速响应的业务场景。</p>
<h4 data-id="heading-13">3.1.3 精准权限管控</h4>
<p>与权限管理深度集成，按角色、业务场景配置操作权限，确保不同操作人员仅能访问与操作对应范围的内容，保障数据安全与操作规范。</p>
<h3 data-id="heading-14">3.2 高效流程调度：任务拆分与合并</h3>
<p>平台调度中心支持复杂任务的分布式协同执行，核心逻辑如下：</p>
<h4 data-id="heading-15">3.2.1 任务拆分机制</h4>
<p>主执行模块接收流程指令后，可根据业务规则将复杂任务拆分为多个并行子任务，分配至不同节点执行。例如“数据分析流程”可拆分为“数据采集、数据处理、报告生成”三个并行子任务，提升整体执行效率。</p>
<h4 data-id="heading-16">3.2.2 任务合并机制</h4>
<p>各节点子任务执行完成后，结果实时回传至主模块，按预设规则（如内容整合、优先级排序、异常降级）进行结果聚合，形成统一的流程输出，支持“部分成功”场景的柔性处理，确保流程不中断。</p>
<h4 data-id="heading-17">3.2.3 子流程联动</h4>
<p>支持流程嵌套，主流程可触发独立子流程，子流程与主流程数据隔离但可按需同步，适配“大流程包含小流程”的复杂场景（如“订单处理流程”包含“支付验证子流程”“物流调度子流程”）。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7377398a68949eaa6369eb0fe0cb0a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768490484&amp;x-signature=Za2wNW6BIsi4xkrCbo5NCYyNpoA%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<h3 data-id="heading-18">3.3 集中化能力管理：存储与分发</h3>
<p>集中化数据服务是平台实现“模块化能力复用”的核心，替代传统分散式存储，实现能力配置的高效管理，核心特性如下：</p>
<h4 data-id="heading-19">3.3.1 存储优化设计</h4>
<p>将模块化能力的配置信息、运行数据与核心业务数据分离存储，降低核心系统压力，提升数据读写效率，保障大规模能力调用时的稳定性。</p>
<h4 data-id="heading-20">3.3.2 跨节点分发</h4>
<p>采用集中化存储、分布式分发模式，能力配置一经创建，自动同步至所有执行节点，确保各节点使用一致的能力版本，支持“增量同步”，减少资源消耗。</p>
<h4 data-id="heading-21">3.3.3 版本管控与回溯</h4>
<p>支持能力配置的版本管理，每次修改自动生成新版本，保留历史配置记录。结合执行历史数据，可回溯任意版本能力的使用情况，便于问题定位与版本回滚。</p>
<p><strong>能力存储与分发流程</strong>：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4ae6782816d4cf996588b3462e9d388~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768490484&amp;x-signature=KiReIk%2BUj9x9i31HGKffErbElaU%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<h3 data-id="heading-22">3.4 全生命周期流程管控</h3>
<p>平台覆盖“能力定义-流程编排-执行-监控-回溯”的全生命周期，实现流程管控的闭环管理：</p>
<h4 data-id="heading-23">3.4.1 定义阶段：低门槛配置</h4>
<ul>
<li>能力定义：通过直观配置封装核心业务功能，设置参数、适配场景，无需代码开发；</li>
<li>流程编排：支持拖拽式可视化编排，自由组合自动化模块、人工交互模块、模块化能力，配置环节衔接规则。</li>
</ul>
<h4 data-id="heading-24">3.4.2 执行阶段：协同化执行</h4>
<ul>
<li>自动化执行：按编排规则自动调用模块化能力，支持并行执行与跨节点协同；</li>
<li>人工交互：按需触发人工交互模块，操作人员获取完整上下文信息，快速完成操作，结果实时同步。</li>
</ul>
<h4 data-id="heading-25">3.4.3 监控阶段：实时化管控</h4>
<ul>
<li>状态监控：实时展示流程、模块、能力的运行状态（初始化/运行中/完成/异常）；</li>
<li>性能监控：统计流程执行时长、能力调用效率、节点负载情况；</li>
<li>异常告警：支持自定义异常阈值，触发告警后可自动重试或人工介入处理。</li>
</ul>
<h4 data-id="heading-26">3.4.4 回溯阶段：可追溯审计</h4>
<ul>
<li>历史记录：存储流程执行日志、能力运行数据、人工操作记录，支持多维度查询；</li>
<li>全链路回溯：基于配置版本快照与执行历史，可复现任意流程实例的执行过程，便于问题定位与审计。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/946f4dbb81484dfeb4fbb9a75cea15b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768490484&amp;x-signature=YBL6Hyvs6Prq3MYGqFkVfF9qmgs%3D" alt="请在此添加图片描述" loading="lazy"/></li>
</ul>
<h3 data-id="heading-27">3.5 人工与自动化统一协同</h3>
<p>平台打破“自动化流程”与“人工环节”的壁垒，实现统一编排、统一管控，核心特性如下：</p>
<h4 data-id="heading-28">3.5.1 统一编排</h4>
<p>自动化模块与人工交互模块同属流程执行环节，可通过可视化界面自由组合，无需额外适配，实现“自动化环节-人工环节-自动化环节”的顺畅流转。</p>
<h4 data-id="heading-29">3.5.2 数据贯通</h4>
<p>人工环节与自动化环节共享全局上下文数据，人工操作结果自动同步至流程，后续自动化模块可直接使用；自动化模块的执行数据也可实时展示在人工交互界面，辅助操作人员决策。</p>
<h4 data-id="heading-30">3.5.3 统一管控</h4>
<p>操作人员权限与流程访问权限、能力调用权限形成一体化管控体系；自动化执行日志与人工操作记录统一存储，支持全流程审计与追溯，确保流程合规。</p>
<h2 data-id="heading-31">四、应用场景落地</h2>
<h3 data-id="heading-32">4.1 智能客户服务流程</h3>
<h4 data-id="heading-33">场景描述</h4>
<p>某大型企业需要构建“智能响应+人工兜底”的客户服务体系，支持用户咨询的快速处理与复杂问题的精准转接，实现“需求识别-智能回复-人工干预-结果反馈”的全流程闭环。</p>
<h4 data-id="heading-34">平台落地方案</h4>
<ul>
<li><strong>能力配置</strong>：封装“需求识别、智能回复、情绪分析、结果生成”等模块化能力，通过集中化数据服务实现全节点分发；</li>
<li><strong>流程编排</strong>：以全局协同协议驱动“需求识别模块→智能回复模块→人工交互模块→结果反馈模块”的流程链；</li>
<li><strong>协同执行</strong>：需求识别与智能回复并行处理，提升响应速度；复杂问题自动触发人工交互模块，客服人员实时获取用户咨询历史与智能回复结果，快速完成人工兜底；</li>
<li><strong>全周期管控</strong>：记录用户咨询、智能回复、人工操作的全流程数据，支持服务质量审计与能力优化。</li>
</ul>
<h3 data-id="heading-35">4.2 数据分析与报告生成流程</h3>
<h4 data-id="heading-36">场景描述</h4>
<p>某金融企业需要处理海量业务数据，生成定期经营分析报告，流程包含“数据采集-处理-分析-报告生成-人工审核”，要求支持多节点协同处理与报告内容的灵活调整。</p>
<h4 data-id="heading-37">平台落地方案</h4>
<ul>
<li><strong>任务拆分</strong>：主执行模块将“数据分析流程”拆分为“数据采集、数据处理、分析建模、报告生成”四个并行子任务，分配至不同节点执行；</li>
<li><strong>人工协同</strong>：报告生成后触发人工交互模块，分析师通过配置式界面调整报告内容、补充结论，调整结果实时同步至流程；</li>
<li><strong>能力复用</strong>：数据分析相关能力（如数据处理、分析建模）可被其他业务线（如风险评估、客户画像）复用，通过集中化数据服务实现跨业务线分发；</li>
<li><strong>监控与回溯</strong>：实时监控各子任务执行进度与节点负载，支持报告生成流程的全链路回溯，便于问题定位。</li>
</ul>
<h3 data-id="heading-38">4.3 企业内部审批流程</h3>
<h4 data-id="heading-39">场景描述</h4>
<p>某制造企业需要优化内部审批流程（如采购审批、报销审批），实现“表单校验-规则检查-多级审批-结果通知”的自动化流转，同时支持审批节点的灵活配置与人工干预。</p>
<h4 data-id="heading-40">平台落地方案</h4>
<ul>
<li><strong>流程编排</strong>：通过可视化界面编排“表单校验模块→规则检查模块→一级审批人工模块→二级审批人工模块→结果通知模块”的流程；</li>
<li><strong>权限管控</strong>：为不同审批节点配置专属角色（如部门经理、财务专员），确保审批权限精准管控，操作留痕；</li>
<li><strong>协同执行</strong>：表单校验与规则检查并行执行，提升审批前置处理效率；多级审批支持跨地域协同，审批结果实时同步；</li>
<li><strong>全周期管控</strong>：记录审批流程的每一步操作（提交时间、审批人、审批意见、处理时长），支持审批流程的审计与追溯，优化审批效率。</li>
</ul>
<h2 data-id="heading-41">五、产品规格与部署方案</h2>
<h3 data-id="heading-42">5.1 产品规格</h3>

































<table><thead><tr><th>类别</th><th>支持范围</th></tr></thead><tbody><tr><td>配置方式</td><td>可视化配置+简易参数设置，支持业务人员独立操作</td></tr><tr><td>协同规模</td><td>支持最大1000+节点集群部署；支持任务拆分最大并发数：1000+</td></tr><tr><td>能力管理</td><td>支持模块化能力最大数量：10000+；支持版本数量：每个能力最多100个版本</td></tr><tr><td>存储能力</td><td>集中化数据服务支持单文件最大存储：10GB；支持集群扩容</td></tr><tr><td>并发能力</td><td>单节点支持最大并发请求：10000+；人工交互模块支持最大并发连接：5000+</td></tr><tr><td>兼容性</td><td>支持主流数据源、第三方系统对接；适配Windows、Linux等主流操作系统</td></tr></tbody></table>
<h3 data-id="heading-43">5.2 部署方案</h3>
<h4 data-id="heading-44">5.2.1 部署模式</h4>
<ul>
<li><strong>私有部署</strong>：支持企业内网部署，保障核心数据安全性与私密性；</li>
<li><strong>混合部署</strong>：集中化数据服务与调度中心私有部署，人工交互模块可云端部署，适配远程办公场景；</li>
<li><strong>容器化部署</strong>：支持Docker+K8s容器化部署，实现自动扩缩容，适配业务流量波动，降低运维成本。</li>
</ul>
<h4 data-id="heading-45">5.2.2 部署架构</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d8ec42582f3499ca7199c6b34ecb09e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768490484&amp;x-signature=EDZ4T0bvbCiEkCDTxek0hoYZWa4%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<h4 data-id="heading-46">5.2.3 最小部署要求</h4>

























<table><thead><tr><th>组件</th><th>配置要求</th></tr></thead><tbody><tr><td>应用服务器</td><td>CPU：8核；内存：16GB；磁盘：100GB SSD；操作系统：Ubuntu 20.04/CentOS 7+</td></tr><tr><td>数据服务节点</td><td>CPU：16核；内存：32GB；磁盘：1TB SSD；支持集群部署（最少2节点）</td></tr><tr><td>数据库服务器</td><td>CPU：16核；内存：32GB；磁盘：2TB SSD；支持主从复制，保障数据可靠性</td></tr><tr><td>网络要求</td><td>内网带宽：10Gbps+；外网带宽：1Gbps+（云端部署场景）</td></tr></tbody></table>
<h2 data-id="heading-47">六、版本迭代规划</h2>
<h3 data-id="heading-48">6.1 V0.5 版本核心特性（当前版本）</h3>
<ul>
<li>全生命周期流程协同能力，支持任务拆分与合并；</li>
<li>低门槛人工交互模块，实现高效人工与自动化协同；</li>
<li>集中化能力管理，支持模块化能力的存储、分发与版本管控；</li>
<li>全链路监控与追溯，保障流程合规与问题定位；</li>
<li>可视化流程编排与能力配置，降低使用门槛。</li>
</ul>
<h3 data-id="heading-49">6.2 后续版本规划</h3>
<ul>
<li><strong>V1.0 版本</strong>：新增更丰富的可视化编排工具；强化能力市场，支持能力上传与共享；优化调度算法，提升大规模协同效率；</li>
<li><strong>V1.5 版本</strong>：引入多模态能力支持（语音、图像、视频相关功能）；增强人工交互模块的个性化配置；新增AI辅助流程优化建议；</li>
<li><strong>V2.0 版本</strong>：支持跨组织流程协同；构建开放生态，支持第三方能力接入；强化数据安全与合规管控。</li>
</ul>
<h2 data-id="heading-50">七、结语</h2>
<p>SkillFlow 智流 V0.5以“流程协同”为核心，以“模块化能力”为载体，以“全生命周期管控”为保障，构建了一套适配企业复杂业务场景的流程协同解决方案。平台通过低门槛配置降低使用成本，通过分布式调度提升执行效率，通过集中化管理实现能力复用，最终帮助企业在数字化转型中实现“流程智能化、操作轻量化、管控精细化”的核心目标。</p>
<p>未来，SkillFlow 智流将持续迭代，不断强化协同能力、扩展能力生态、优化使用体验，致力于成为企业数字化转型的核心支撑平台，与客户共同探索高效流程管理的更多可能。</p>
<h2 data-id="heading-51">附录</h2>
<h3 data-id="heading-52">附录A：核心配置项说明</h3>









































<table><thead><tr><th>配置项名称</th><th>适用范围</th><th>核心用途</th><th>关键配置内容</th></tr></thead><tbody><tr><td>场景配置</td><td>全流程</td><td>关联流程与业务场景</td><td>场景类型、适配规则、描述</td></tr><tr><td>上下文配置</td><td>全流程</td><td>定义流程运行时所需数据</td><td>数据类型、是否必填、默认值</td></tr><tr><td>能力配置</td><td>模块化能力</td><td>定义能力核心信息与运行规则</td><td>名称、版本、参数配置、适配场景</td></tr><tr><td>交互配置</td><td>人工交互模块</td><td>定义人工界面与操作规则</td><td>交互类型、展示字段、操作权限</td></tr><tr><td>权限配置</td><td>人工交互模块</td><td>配置操作人员权限</td><td>角色列表、操作范围、访问条件</td></tr></tbody></table>
<h3 data-id="heading-53">附录B：术语表</h3>





































<table><thead><tr><th>术语</th><th>定义</th></tr></thead><tbody><tr><td>全局协同协议</td><td>统一各模块、各节点交互标准，管理流程上下文信息的核心协议</td></tr><tr><td>自动化模块</td><td>自动执行流程环节，调用模块化能力完成具体任务的核心组件</td></tr><tr><td>人工交互模块</td><td>提供人工操作入口，实现人工与自动化流程协同的组件</td></tr><tr><td>模块化能力</td><td>封装核心业务功能，可复用、可配置、可分发的最小功能单元</td></tr><tr><td>集中化数据服务</td><td>负责模块化能力配置存储、分发、版本管理的核心服务</td></tr><tr><td>流程上下文</td><td>流程运行时的相关数据集合，保障各环节数据一致性与可追溯性</td></tr><tr><td>全生命周期管控</td><td>覆盖流程与能力“定义-执行-监控-回溯”全环节的管控体系</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一条 Python 语句在 C 扩展里到底怎么跑]]></title>    <link>https://juejin.cn/post/7592863358258266166</link>    <guid>https://juejin.cn/post/7592863358258266166</guid>    <pubDate>2026-01-08T14:29:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592863358258266166" data-draft-id="7592863358258249782" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一条 Python 语句在 C 扩展里到底怎么跑"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2026-01-08T14:29:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="哈里谢顿"/> <meta itemprop="url" content="https://juejin.cn/user/3678304397695056"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一条 Python 语句在 C 扩展里到底怎么跑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3678304397695056/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    哈里谢顿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T14:29:14.000Z" title="Thu Jan 08 2026 14:29:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>要真正搞清“一条 Python 语句在 C 扩展里到底怎么跑”，最好把源码、调用栈、GIL 释放点、网络收发点都“跟”一遍。下面以<br/>
<code>MySQLdb.connection.query("SELECT …")</code><br/>
为例，把从 Python 层到 C 层再到 libmysqlclient 的完整路径拆给你看。<br/>
（代码行号基于 mysqlclient-python 2.2.x，MySQL-Connector/C 8.0.x，CPython 3.11）</p>
<hr/>
<h2 data-id="heading-0">一、Python 层：MySQLdb/<strong>init</strong>.py</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> _mysql          <span class="hljs-comment"># 这是 C 扩展模块</span>
…
connect = _mysql.connect
Connection = _mysql.connection
</code></pre>
<p>MySQLdb 只是对 _mysql 做了一层薄薄的包装，真正的类叫 <code>_mysql.connection</code>，所以<br/>
<code>MySQLdb.connection.query</code> 其实就是<br/>
<code>_mysql.connection.query</code>。</p>
<hr/>
<h2 data-id="heading-1">二、C 扩展层：_mysql.c</h2>
<p>模块初始化时把 <code>connection</code> 类型注册到 Python：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">static</span> PyTypeObject MyConnection_Type = {
    PyVarObject_HEAD_INIT(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>)
    .tp_name = <span class="hljs-string">"_mysql.connection"</span>,
    .tp_methods = _mysql_ConnectionObject_methods,
    …
};
</code></pre>
<p><code>.tp_methods</code> 里有一项：</p>
<pre><code class="hljs language-c" lang="c">{<span class="hljs-string">"query"</span>, (PyCFunction)_mysql_ConnectionObject_query, METH_VARARGS,
 PyDoc_STR(<span class="hljs-string">"query(sql) -&gt; None"</span>)},
</code></pre>
<p>因此 Python 虚拟机在执行<br/>
<code>LOAD_ATTR</code> + <code>CALL_METHOD</code> 指令时，通过 PyType 的 method resolution 直接找到<br/>
<code>_mysql_ConnectionObject_query</code>。</p>
<hr/>
<h2 data-id="heading-2">三、C 函数内部：_mysql_ConnectionObject_query</h2>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">static</span> PyObject *
_mysql_ConnectionObject_query(MyConnectionObject *self, PyObject *args)
{
    <span class="hljs-type">char</span> *sql;
    <span class="hljs-type">int</span>  len;
    <span class="hljs-keyword">if</span> (!PyArg_ParseTuple(args, <span class="hljs-string">"s#"</span>, &amp;sql, &amp;len))
        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;

    Py_BEGIN_ALLOW_THREADS          <span class="hljs-comment">/* 1. 主动释放 GIL */</span>
    <span class="hljs-type">int</span> r = mysql_real_query(self-&gt;conn, sql, len);
    Py_END_ALLOW_THREADS            <span class="hljs-comment">/* 2. 重新拿 GIL */</span>

    <span class="hljs-keyword">if</span> (r) {
        _mysql_Exception(self);     <span class="hljs-comment">/* 3. 把 mysql_error() 包装成 Python 异常 */</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;
    }
    Py_RETURN_NONE;
}
</code></pre>
<p>关键三步：</p>
<ol>
<li>释放 GIL → 其他 Python 线程可以跑；</li>
<li>调 libmysqlclient 的 <code>mysql_real_query()</code>；</li>
<li>出错就把 C 的 <code>mysql_error()</code>/<code>mysql_errno()</code> 转成 <code>_mysql.ProgrammingError</code>/<code>DatabaseError</code> 等 Python 异常。</li>
</ol>
<hr/>
<h2 data-id="heading-3">四、libmysqlclient 层：mysql_real_query()</h2>
<p>libmysqlclient 是 C 语言官方客户端库，内部做了：</p>
<ul>
<li>把 SQL 按 MySQL 协议打成 TCP 包（<code>net_write_command()</code>）</li>
<li>阻塞 <code>recv()</code> 等待 server 返回结果包</li>
<li>如果 SQL 是 SELECT，后续还会再调 <code>mysql_store_result()</code>/<code>mysql_use_result()</code> 读结果集。</li>
</ul>
<hr/>
<h2 data-id="heading-4">五、结果集怎么回到 Python？</h2>
<p>如果你在 Python 里继续写：</p>
<pre><code class="hljs language-python" lang="python">cursor = conn.cursor()
cursor.execute(<span class="hljs-string">"SELECT …"</span>)
</code></pre>
<p><code>cursor.execute</code> 会再调 <code>_mysql.connection.query</code>，然后：</p>
<ol>
<li><code>_mysql_ConnectionObject_store_result()</code> 把 <code>MYSQL_RES *</code> 抓出来；</li>
<li>用 <code>PyList_New()</code>/<code>PyTuple_New()</code> 把每一行转成 Python 对象；</li>
<li>把 <code>MYSQL_FIELD</code> 的类型映射成 Python 类型（<code>FIELD_TYPE_LONG</code>→PyLong，<code>FIELD_TYPE_DATETIME</code>→PyDateTime 等）。<br/>
这一步在 <strong>持有 GIL</strong> 的情况下做，因为要把 C 数据喂给 Python 对象。</li>
</ol>
<hr/>
<h2 data-id="heading-5">六、小结：一条语句的“旅程”</h2>
<p>Python 字节码<br/>
→ LOAD_ATTR “query”<br/>
→ CALL_METHOD (进入 C)<br/>
→ PyArg_ParseTuple<br/>
→ Py_BEGIN_ALLOW_THREADS<br/>
→ libmysqlclient:mysql_real_query (阻塞等网络)<br/>
→ Py_END_ALLOW_THREADS<br/>
→ 出错则 _mysql_Exception<br/>
→ 返回 Py_None。</p>
<hr/>
<h2 data-id="heading-6">七、动手验证：gdb + ltrace 看现场</h2>
<ol>
<li>装 debug 符号<br/>
<code>apt install python3-dbg libmysqlclient-dev mysql-client-core-8.0-dbg</code></li>
<li>起 gdb
<pre><code class="hljs language-sql" lang="sql">gdb <span class="hljs-operator">-</span>ex r <span class="hljs-comment">--args python3 -c "</span>
import MySQLdb, <span class="hljs-type">time</span>
c<span class="hljs-operator">=</span>MySQLdb.connect(<span class="hljs-keyword">user</span><span class="hljs-operator">=</span><span class="hljs-string">'root'</span>,passwd<span class="hljs-operator">=</span><span class="hljs-string">'***'</span>)
c.query(<span class="hljs-string">'SELECT 1'</span>)
"
</code></pre>
</li>
<li>下断点<br/>
<code>(gdb) b _mysql_ConnectionObject_query</code><br/>
<code>(gdb) b mysql_real_query</code></li>
<li>单步<br/>
<code>(gdb) n</code>  可以看到 <code>Py_BEGIN_ALLOW_THREADS</code> 宏展开后调用<br/>
<code>PyThread_release_lock()</code>；<br/>
继续 <code>s</code> 能跟到 <code>net_write_command()</code> → <code>send()</code>/<code>recv()</code>。</li>
</ol>
<hr/>
<h2 data-id="heading-7">八、写个最小 C 扩展 Demo（把上面流程自己跑一遍）</h2>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// demo.c</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> PY_SSIZE_T_CLEAN</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Python.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mysql.h&gt;</span></span>

<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> {</span>
    PyObject_HEAD
    MYSQL *mysql;
} DemoConn;

<span class="hljs-type">static</span> PyObject *
<span class="hljs-title function_">DemoConn_query</span><span class="hljs-params">(DemoConn *self, PyObject *args)</span>
{
    <span class="hljs-type">char</span> *sql;
    Py_ssize_t len;
    <span class="hljs-keyword">if</span> (!PyArg_ParseTuple(args, <span class="hljs-string">"s#"</span>, &amp;sql, &amp;len))
        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;

    Py_BEGIN_ALLOW_THREADS
    <span class="hljs-type">int</span> err = mysql_real_query(self-&gt;mysql, sql, len);
    Py_END_ALLOW_THREADS

    <span class="hljs-title function_">if</span> <span class="hljs-params">(err)</span> {
        PyErr_Format(PyExc_RuntimeError, <span class="hljs-string">"mysql: %s"</span>, mysql_error(self-&gt;mysql));
        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;
    }
    Py_RETURN_NONE;
}

<span class="hljs-type">static</span> PyMethodDef DemoConn_methods[] = {
    {<span class="hljs-string">"query"</span>, (PyCFunction)DemoConn_query, METH_VARARGS, <span class="hljs-string">""</span>},
    {<span class="hljs-literal">NULL</span>}
};

<span class="hljs-type">static</span> PyTypeObject DemoConnType = {
    PyVarObject_HEAD_INIT(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>)
    .tp_name = <span class="hljs-string">"demo.Connection"</span>,
    .tp_basicsize = <span class="hljs-keyword">sizeof</span>(DemoConn),
    .tp_flags = Py_TPFLAGS_DEFAULT,
    .tp_methods = DemoConn_methods,
};

<span class="hljs-type">static</span> PyModuleDef demomodule = {
    PyModuleDef_HEAD_INIT,
    .m_name = <span class="hljs-string">"demo"</span>,
    .m_size <span class="hljs-number">-1</span>,
};

PyMODINIT_FUNC
<span class="hljs-title function_">PyInit_demo</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>
{
    PyObject *m = PyModule_Create(&amp;demomodule);
    <span class="hljs-keyword">if</span> (!m) <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;
    <span class="hljs-keyword">if</span> (PyType_Ready(&amp;DemoConnType) &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;
    PyModule_AddObject(m, <span class="hljs-string">"Connection"</span>, (PyObject*)&amp;DemoConnType);
    <span class="hljs-keyword">return</span> m;
}
</code></pre>
<p>编译</p>
<pre><code class="hljs language-makefile" lang="makefile">python3 -m pip install mysqlclient  <span class="hljs-comment"># 确保有头文件</span>
gcc -shared -fPIC <span class="hljs-variable">$(python3-config --includes)</span> \
    -I/usr/<span class="hljs-keyword">include</span>/mysql -L/usr/lib/x86_64-linux-gnu \
    demo.c -lmysqlclient -o demo<span class="hljs-variable">$(python3-config --extension-<span class="hljs-built_in">suffix</span>)</span>
</code></pre>
<p>测试</p>
<pre><code class="hljs language-ini" lang="ini">python3 -c "
import demo, MySQLdb
<span class="hljs-attr">c</span> = demo.Connection()   <span class="hljs-comment"># 这里省掉了 connect 参数，仅演示</span>
c.query('SELECT 1')
"
</code></pre>
<p>用 <code>ltrace -e mysql_real_query python3 test.py</code> 就能抓到库函数调用。</p>
<hr/>
<h2 data-id="heading-8">九、随手可记的“脑图”</h2>
<pre><code class="hljs language-objectivec" lang="objectivec">Python 语句
   ↓ 字节码 <span class="hljs-built_in">CALL_METHOD</span>
C 扩展函数  (PyCFunction)
   ↓ Py_BEGIN_ALLOW_THREADS
libmysqlclient 阻塞网络
   ↓ Py_END_ALLOW_THREADS
结果 or 异常 → Python 对象
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【金仓数据库】ksql 指南（六）—— 创建与管理用户和权限（KingbaseES 安全控制核心）]]></title>    <link>https://juejin.cn/post/7592819937652441103</link>    <guid>https://juejin.cn/post/7592819937652441103</guid>    <pubDate>2026-01-08T14:29:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592819937652441103" data-draft-id="7592615536385622050" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【金仓数据库】ksql 指南（六）—— 创建与管理用户和权限（KingbaseES 安全控制核心）"/> <meta itemprop="keywords" content="数据库"/> <meta itemprop="datePublished" content="2026-01-08T14:29:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="倔强的石头_"/> <meta itemprop="url" content="https://juejin.cn/user/3168119757484368"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【金仓数据库】ksql 指南（六）—— 创建与管理用户和权限（KingbaseES 安全控制核心）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3168119757484368/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    倔强的石头_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T14:29:30.000Z" title="Thu Jan 08 2026 14:29:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8c1095fd93644b4a9deaaac6af8d762~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768487370&amp;x-signature=L5c5KBRAYhSbv929hF%2BeyQYfDgU%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">引言</h2>
<p>完成数据库，表，索引这些核心对象的运作之后，“用户与权限控制”就成了保障 KingbaseES 数据安全的重点所在，经由细致的用户运作和权限分配，可以规避未授权访问以及误操作之类的风险，比如普通用户就无权删除核心表。本文针对“ksql 命令行操作用户与权限”展开论述，覆盖从“创建用户 - 查看用户 - 修改用户 - 授权/回收权限 - 删除用户”这样完整的流程，并结合真实的业务场景来分解具体的执行步骤，各个阶段均给出相关的语法，例子以及防止常见错误的提示，从而保证初学者能够掌握到安全控制的主要要点。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f29cd37eb76c486a915fd80dde03142e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768487370&amp;x-signature=Y7%2F12KWUx7f9NXgiuehd12%2BG0q4%3D" alt="" loading="lazy"/></p>
<p>@[toc]</p>
<h3 data-id="heading-1">一、前置准备：明确 “谁来操作” 与 “操作基础”</h3>
<p>用户与权限运作属于“高危运作”，要保证运作环境具备如下条件（结合前面内容，防止因为权限不够或者环境有误致使运作出现故障）</p>
<h4 data-id="heading-2">1.1 1. 用管理员账号连接数据库</h4>
<p>管理员用户（比如预设的 <code>system</code>）具备创建，更改，删除其他用户的相关权限，普通用户并不具有这些权限，要经由 ksql 以管理员的身份去关联本地数据库</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 连接默认数据库 kingbase，用户为 system</span>
ksql -d kingbase -U system
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f58d273272a40b28b4b036b3ff02ff2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768487370&amp;x-signature=d7GOs6Stwxm5lHhcYGpNfqEQh04%3D" alt="image.png" loading="lazy"/></p>
<p>连接创建之后，提示符变为 <code>kingbase=#</code>，其中，管理员的提示符是 <code>#</code>，普通用户的是 <code>&gt;</code>，经由提示符能够立即识别出权限等级</p>
<h4 data-id="heading-3">1.2 2. 确认操作依赖的对象（衔接前文）</h4>
<p>后续权限示例将基于前文创建的对象：</p>
<ul>
<li>数据库：<code>kingbase</code>（默认数据库）、<code>test</code>（前文创建的测试库）；</li>
<li>模式：<code>test_schema</code>（前文创建的模式）；</li>
<li>表：<code>test_schema.sys_user</code>（前文创建的用户表）；<br/>
确保这些对象存在（可通过 <code>\l</code> 查数据库、<code>\dn</code> 查模式、<code>\dt test_schema.*</code> 查表），若不存在可参考前文重新创建，避免示例执行失败。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e5da534a87e4b788865b316ea85a54b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768487370&amp;x-signature=dk6grJ5rUFdmLwBkba082k%2FE6tc%3D" alt="image.png" loading="lazy"/></li>
</ul>
<h3 data-id="heading-4">二、核心概念：用户与权限的 “层级关系”</h3>
<p>新手要先领会 KingbaseES 权限的“层级特性”，即权限按“数据库 → 模式 → 表”由高到低分级，只有得到上层权限才可操作下层对象（若无数据库关联权限，则无法操作库中的表）。
KingbaseES隐含的权限层级如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bedda0b9deaf40319bebe7ad23912474~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768487370&amp;x-signature=%2F6LjgDAaI%2Bnqtsr9CrgyIpnzhx0%3D" alt="image.png" loading="lazy"/></p>
<p>KingbaseES存在隐含的权限层级，后面的全部权限操作都会环绕这三个层级来执行，以此保证权限分配达到“最小化”效果（也就是仅仅给予用户所需的权限，防止出现过度授权的情况）。</p>
<h3 data-id="heading-5">三、创建用户：基础用户管理第一步</h3>
<p>创建用户属于权限管理的起始部分，要给出用户名，密码以及一些基本属性，比如默认数据库，密码有效期限等，接下来会阐述 <code>CREATE USER</code> 的关键语法，并且依照安全方面的良好做法来给出例子</p>
<h4 data-id="heading-6">3.1 1. 基础语法</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">USER</span> 用户名 <span class="hljs-keyword">WITH</span> PASSWORD <span class="hljs-string">'密码'</span> [选项];
</code></pre>
<p>下面这些“选项”的解释（适合初学者了解）：</p>
<ul>
<li><code>PASSWORD '密码'</code>：用户登录密码（建议包含大小写、数字、特殊字符，避免弱密码）；</li>
<li><code>DEFAULT DATABASE 数据库名</code>指的是用户登录时默认关联的数据库，比如<code>kingbase</code>。</li>
<li><code>DEFAULT SCHEMA</code> 是指用户默认会用的模式，比如 <code>test_schema</code>。</li>
<li><code>CREATEDB</code>：允许用户创建数据库（前文提到的建库权限，仅管理员可授予）；</li>
<li><code>INHERIT</code>：用户自动继承所属角色的权限（默认开启，无需手动指定）。</li>
</ul>
<h4 data-id="heading-7">3.2 2. 实操示例：创建普通用户</h4>
<h5 data-id="heading-8">示例 ：创建基础用户 <code>test</code>（仅用于访问数据，无建库权限）</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">USER</span> test <span class="hljs-keyword">WITH</span> PASSWORD <span class="hljs-string">'123456'</span> 
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/20623ef5ce9d4103b13ad33699419bf4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768487370&amp;x-signature=iBh0hJdwlL05%2BFS7na2h8VWFxfI%3D" alt="1d089813-04bf-4aa4-8797-87254fe37d7b.png" loading="lazy"/></p>
<ul>
<li><strong>成功验证</strong>：执行后提示 <code>CREATE ROLE</code>（KingbaseES 中 “用户” 本质是特殊角色，故返回 <code>CREATE ROLE</code>），表示用户创建成功。</li>
</ul>
<h4 data-id="heading-9">3.3 3. 注意事项（安全必看）</h4>
<ol>
<li><strong>密码复杂度</strong>：生产环境需设置强密码（如至少 8 位，含大小写、数字、特殊字符），避免 <code>123456</code> 等弱密码；</li>
<li><strong>避免重复创建</strong>：若用户名已存在，执行 <code>CREATE USER</code> 会报错 “role already exists”，需先删除旧用户或改用 <code>ALTER USER</code> 修改。</li>
</ol>
<h3 data-id="heading-10">四、查看用户：了解用户权限与属性</h3>
<p>创建好用户之后，要利用 ksql 命令来查看用户的详细信息，包含权限，默认属性以及所属角色等方面的内容，建议采用 <code>\du</code> 这一系列的命令，这属于一种最为直观的查看用户信息的方式。</p>
<h4 data-id="heading-11">4.1 1. 查看所有用户（\du 命令）</h4>
<p>执行 <code>\du</code> 可列出当前数据库中所有用户的核心信息，快速了解用户列表：</p>
<pre><code class="hljs language-sql" lang="sql">\du
</code></pre>
<p><strong>执行结果示例（关键信息筛选）：</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98b1b9623e784662aa371c829d67a830~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768487370&amp;x-signature=qJ4ix%2BELeEV3bW7iBdepoW5ubAo%3D" alt="d99feed7-5403-4144-ad91-e3887eb57c5f.png" loading="lazy"/></p>
<h4 data-id="heading-12">4.2 2. 查看单个用户详情（\du 用户名）</h4>
<p>若需查看某一用户的详细权限（如 <code>test</code>），执行 <code>\du 用户名</code>：</p>
<pre><code class="hljs language-sql" lang="sql">\du test
</code></pre>
<p><strong>执行结果示例：</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a1eaec5b4754fb5927c7e959887c90d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768487370&amp;x-signature=dr5kz63hQQQ1KU9QgSdd5WyR8ZA%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-13">4.3 3. 查看用户的权限明细（\dp 命令）</h4>
<p>若需更精细地查看用户对某类对象（如表、模式）的权限，可使用 <code>\dp</code> 命令：</p>
<ul>
<li>
<p>查看表权限：<code>\dp 表名</code>（如查看 <code>sys_user</code> 表的权限）；</p>
<pre><code class="hljs language-sql" lang="sql">\dp test_schema.sys_user
</code></pre>
</li>
</ul>
<h3 data-id="heading-14">五、修改用户：适配用户属性变更</h3>
<p>业务需求发生改变的时候，要对用户属性做一些调整，比如重置密码或者增减创建数据库的权限，<code>ALTER USER</code> 这个核心语法包含一些常见的操作</p>
<h4 data-id="heading-15">5.1 1. 修改用户密码（最常用操作）</h4>
<p>当用户忘了密码或者是到了规定的时间得要换密码时，管理员可以运行如下命令（拿 <code>test</code> 来举例）：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 语法：ALTER USER 用户名 WITH PASSWORD '新密码';</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">USER</span> test <span class="hljs-keyword">WITH</span> PASSWORD <span class="hljs-string">'User1@New2024'</span>;
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a912238787be439c8d4b56e06026a966~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768487370&amp;x-signature=JIy4S8e7KqMFIurluN6mQz7tGRA%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li><strong>验证</strong>：修改之后，用户就能重新登录（用 <code>ksql -d kingbase -U user1</code> 命令），然后输入新的密码来验证是否有效</li>
</ul>
<h4 data-id="heading-16">5.2 2. 授予用户属性（如建库权限）</h4>
<p>如果想要给 <code>test</code> 授予创建数据库的权限（之前没有这个权限）</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 语法：ALTER USER 用户名 权限属性;</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">USER</span> test CREATEDB;
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78bb43ef3cf64e19818cbffc20744743~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768487370&amp;x-signature=VqnC0NTtKHR4%2Bn%2BoYOv5IXxFAIU%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li><strong>验证</strong>：执行 <code>\du test</code> 这条命令，在 <code>Attributes</code> 栏里能看到 <code>创建 DB</code> 这个选项，这就表明权限已经被添加了</li>
</ul>
<h4 data-id="heading-17">5.3 3. 撤销用户属性（如收回建库权限）</h4>
<p>若 <code>test</code> 不再需要建库权限，可收回：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 语法：ALTER USER 用户名 NO 权限属性;</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">USER</span> test NOCREATEDB;
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/393b8a3b4db7415192f887fc73b403ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768487370&amp;x-signature=Y1gYLPAxePK8w0wp6zu57TOHNmE%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li><strong>验证</strong>：执行 <code>\du test</code>，<code>Attributes</code> 中的 <code>Create DB</code> 会消失。</li>
</ul>
<h4 data-id="heading-18">5.4 4. 修改用户默认属性（如默认数据库）</h4>
<p>将 <code>user1</code> 的默认数据库从 <code>kingbase</code> 改为 <code>test</code>（需确保 <code>test_db</code> 已存在）：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">USER</span> test <span class="hljs-keyword">SET</span> <span class="hljs-keyword">DEFAULT</span> DATABASE test;
</code></pre>
<ul>
<li><strong>验证</strong>：等用户 <code>test</code> 下次登录的时候，只要用 <code>ksql -U user1</code> 这个命令，系统就会自动帮它连接到 <code>test</code> 这个数据库，不需要手动加上 <code>-d test</code> 这样的参数。</li>
</ul>
<h3 data-id="heading-19">六、权限控制：授予与回收（核心环节）</h3>
<p>权限控制处于用户运作的核心地位，要依照“数据库→模式→表”这样的层级来执行权限的赋予或者收回，从而保证用户只能对自身业务范畴之内的对象实施操作，有关<code>GRANT</code>（即赋予）和 <code>REVOKE</code>（即收回）的语法，下面将针对不同情形展开详细阐述</p>
<h4 data-id="heading-20">6.1 1. 授予权限（GRANT 命令）</h4>
<h5 data-id="heading-21">场景 1：授予数据库连接权限（用户需先能连接库，才能操作内部对象）</h5>
<p>向<code>test</code>赋予连接<code>kingbase</code>数据库的权限</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 语法：GRANT 权限类型 ON DATABASE 数据库名 TO 用户名;</span>
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">CONNECT</span> <span class="hljs-keyword">ON</span> DATABASE kingbase <span class="hljs-keyword">TO</span> test;
</code></pre>
<ul>
<li><strong>作用</strong>：如果没有这项权限，那么<code>test</code>就无法与<code>kingbase</code>数据库建立联系，系统将会显示错误信息“permission denied to connect to database kingbase”。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8803e7cf1d654f63916b19a99e09d042~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768487370&amp;x-signature=iNrRPAyPxinjO7hTAgC%2FJ1jLavc%3D" alt="image.png" loading="lazy"/></li>
</ul>
<h5 data-id="heading-22">场景 2：授予模式访问权限（用户需能访问模式，才能操作模式下的表）</h5>
<p>给 <code>test</code> 授予访问 <code>test_schema</code> 模式的权限：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 语法：GRANT 权限类型 ON SCHEMA 模式名 TO 用户名;</span>
<span class="hljs-keyword">GRANT</span> USAGE <span class="hljs-keyword">ON</span> SCHEMA test_schema <span class="hljs-keyword">TO</span> test;
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd7da5f9084d427e84e643e8b3374624~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768487370&amp;x-signature=rrn4kAvzzq5U4KEJ8JP9bXbI1S8%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li><strong>作用</strong>：<code>USAGE</code> 权限是访问模式的基础，无此权限，<code>test</code> 无法查看 <code>test_schema</code> 下的表。</li>
</ul>
<h5 data-id="heading-23">场景 3：授予表操作权限（用户业务核心权限，如查询、插入）</h5>
<p>给 <code>test</code> 授予 <code>test_schema.sys_user</code> 表的 <code>SELECT</code>（查询）和 <code>INSERT</code>（插入）权限：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 语法：GRANT 权限类型 ON 表名 TO 用户名;</span>
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">SELECT</span>, <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">ON</span> test_schema.sys_user <span class="hljs-keyword">TO</span> test;
</code></pre>
<ul>
<li>
<p><strong>进阶</strong>：授予所有权限（谨慎！生产环境不推荐）：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">ALL</span> PRIVILEGES <span class="hljs-keyword">ON</span> test_schema.sys_user <span class="hljs-keyword">TO</span> test;
</code></pre>
</li>
<li>
<p><strong>验证</strong>：执行 <code>\dp test_schema.sys_user</code>，可看到 <code>test</code> 拥有的权限。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/568a049d0dae4c909bc6cd97eff41aea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768487370&amp;x-signature=%2Ft5SILcEuvc%2B%2FysUBa5vqCevmG8%3D" alt="image.png" loading="lazy"/></p>
</li>
</ul>
<h4 data-id="heading-24">6.2 2. 回收权限（REVOKE 命令）</h4>
<p>当用户不再需要某类权限时（如 <code>test</code> 无需插入数据），需及时回收，避免数据风险：</p>
<h5 data-id="heading-25">场景：回收 <code>test</code> 对 <code>sys_user</code> 表的 <code>INSERT</code> 权限</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 语法：REVOKE 权限类型 ON 表名 FROM 用户名;</span>
<span class="hljs-keyword">REVOKE</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">ON</span> test_schema.sys_user <span class="hljs-keyword">FROM</span> test;
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e1b83b6763004a72adbb03d07b977433~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768487370&amp;x-signature=APnUDUDD3WCOs79YMQwowgoJXDM%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li><strong>验证</strong>：执行 <code>\dp test_schema.sys_user</code>，<code>test</code> 的权限会只剩 <code>SELECT</code>；</li>
<li><strong>注意</strong>：回收权限需管理员执行，且只能回收之前授予的权限（无法回收用户默认拥有的权限）。</li>
</ul>
<h3 data-id="heading-26">七、删除用户：高危操作，谨慎执行</h3>
<p>用户被移除时，其本人及其相关权限将会被彻底移除，但是所创建的对象（诸如表，视图等）不会遭到删除，而在执行此类操作之前，一定要确保该用户与核心业务没有联系，其具体的执行步骤包含如下几点：</p>
<h4 data-id="heading-27">7.1 1. 基础语法（加 IF EXISTS 避免报错）</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">USER</span> IF <span class="hljs-keyword">EXISTS</span> 用户名;
</code></pre>
<ul>
<li><code>IF EXISTS</code>：若用户不存在，仅提示警告（<code>NOTICE: role "用户名" does not exist, skipping</code>），不报错，避免中断后续操作。</li>
</ul>
<h4 data-id="heading-28">7.2 2. 特殊场景：用户有创建的对象（需 CASCADE）</h4>
<p>用户 <code>test</code> 已创建表，比如 <code>test_schema.user2_table</code>，如果直接删除，会出现错误提示：“role 'test' 无法被删除，因为存在对象依賴于此角色”，此时应当加上 <code>CASCADE</code> 参数执行级联删除以解决依赖问题（不过这只会删除与该用户相关的权限，并不会删除由该用户创建的各类对象）。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 语法：DROP USER IF EXISTS 用户名 CASCADE;</span>
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">USER</span> IF <span class="hljs-keyword">EXISTS</span> test CASCADE;
</code></pre>
<ul>
<li><strong>高危提醒</strong>：CASCADE 用来处理“用户存在依赖对象”的删除情况，并不会删除由用户创建的表/视图，用户得自行执行 DROP 操作来删除自身创建的对象（例如：DROP TABLE test_schema.user2_table;）。</li>
</ul>
<h4 data-id="heading-29">7.3 3. 删除前的确认步骤（必做）</h4>
<ol>
<li>确认用户无活跃会话：执行 <code>SELECT pid, usename FROM pg_stat_activity WHERE usename = 'user1';</code>，若有结果，先终止会话（<code>SELECT pg_terminate_backend(pid);</code>）；</li>
<li>确认用户无核心权限：执行 <code>\du user1</code>，确认用户无 <code>Superuser</code> 等关键权限；</li>
<li>确认用户无业务对象：执行 <code>SELECT tablename FROM pg_tables WHERE tableowner = 'user1';</code>，确认用户无创建的表。</li>
</ol>
<h3 data-id="heading-30">八、常见问题排查：新手常踩的权限坑</h3>
<h4 data-id="heading-31">问题 1：用户登录报错 “连接数据库的权限被拒绝”</h4>
<p><strong>报错信息</strong>：</p>
<pre><code class="hljs language-plaintext" lang="plaintext">ERROR:  permission denied to connect to database "kingbase"
</code></pre>
<p><strong>原因</strong>：用户无该数据库的 <code>CONNECT</code> 权限（如 <code>user1</code> 未被授予连接 <code>kingbase</code> 的权限）。<br/>
<strong>解决方案</strong>：管理员授予 <code>CONNECT</code> 权限：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">CONNECT</span> <span class="hljs-keyword">ON</span> DATABASE kingbase <span class="hljs-keyword">TO</span> user1;
</code></pre>
<h4 data-id="heading-32">问题 2：用户查询表报错 “对模式的权限被拒绝”</h4>
<p><strong>报错信息</strong>：</p>
<pre><code class="hljs language-plaintext" lang="plaintext">ERROR:  permission denied for schema test_schema
</code></pre>
<p><strong>原因</strong>：用户无该模式的 <code>USAGE</code> 权限，无法访问模式下的表。<br/>
<strong>解决方案</strong>：授予模式访问权限：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">GRANT</span> USAGE <span class="hljs-keyword">ON</span> SCHEMA test_schema <span class="hljs-keyword">TO</span> user1;
</code></pre>
<h4 data-id="heading-33">问题 3：删除用户报错 “存在依赖它的对象”</h4>
<p><strong>报错信息</strong>：</p>
<pre><code class="hljs language-plaintext" lang="plaintext">ERROR:  role "user1" cannot be dropped because some objects depend on it
</code></pre>
<p><strong>原因</strong>：用户有创建的对象（如表、视图）或被授予了其他对象的权限。<br/>
<strong>解决方案</strong>：加 <code>CASCADE</code> 级联删除依赖：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">USER</span> IF <span class="hljs-keyword">EXISTS</span> user1 CASCADE;
</code></pre>
<ul>
<li>后续需手动删除用户创建的对象（如 <code>DROP TABLE test_schema.user1_table;</code>）。</li>
</ul>
<h3 data-id="heading-34">九、总结：用户权限管理的核心原则</h3>
<p>本文完整覆盖了用户 “创建→查看→修改→权限→删除” 的全流程，核心原则可总结为：</p>
<ol>
<li>
<p><strong>最小权限原则</strong>：只赋予用户必要权限，比如普通用户只需表的 <code>SELECT</code> 权限，不必授予 <code>DROP</code> 权限。</p>
</li>
<li>
<p><strong>权限层级清晰</strong>：按照“数据库→模式→表”的顺序逐层授予权限，不能越级授权（即如果没有模式权限，却直接赋予表权限）。</p>
</li>
<li>
<p><strong>定期审计</strong>：定期执行审计操作，利用<code>\du</code>和<code>\dp</code>命令定时检查用户权限，并及时收回多余权限，防止出现权限泄露情况</p>
</li>
<li>
<p><strong>高危操作谨慎</strong>：删除用户前需确认会话、对象、权限，避免误删导致业务中断</p>
</li>
</ol>
<p>掌握了用户与权限运作之后，你就具有了 KingbaseES 数据库安全控制的能力，下一篇文章我们会学习“事务运作”，从而保证多操作情况下数据的一致性（就像转账业务里的“扣款”和“入账”必须一起完成或者一起不完成一样）</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[虽然 V0 很强大，但是ScreenshotToCode 依旧有市场]]></title>    <link>https://juejin.cn/post/7592823500416761882</link>    <guid>https://juejin.cn/post/7592823500416761882</guid>    <pubDate>2026-01-08T14:30:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592823500416761882" data-draft-id="7592863358258151478" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="虽然 V0 很强大，但是ScreenshotToCode 依旧有市场"/> <meta itemprop="keywords" content="AIGC,人工智能"/> <meta itemprop="datePublished" content="2026-01-08T14:30:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="三金得鑫"/> <meta itemprop="url" content="https://juejin.cn/user/4406498335130216"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            虽然 V0 很强大，但是ScreenshotToCode 依旧有市场
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4406498335130216/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    三金得鑫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T14:30:29.000Z" title="Thu Jan 08 2026 14:30:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>这篇文章，我想了很久，还是决定写一下。 screen-to-code 对于开发者来说可能有些鸡肋，但是对于一些非技术人员来说，够用且轻量，配置合适的 AI 之后网页的还原度也高。</p>
</blockquote>
<h3 data-id="heading-0">生成网页的方式</h3>
<p>相信大家对 Vercel 家的 v0 都有所耳闻，不少小伙伴们还都下场使用过，它被定义为“人人皆可用的应用构建器”。通过自然语言的方式使其生成 React + Tailwind CSS 代码，具有实时预览和迭代功能。</p>
<p>但它并非没有缺陷：</p>
<ul>
<li><strong>网络问题</strong>。由于 Vercel 本身是国外网站，所以作为他们家的 v0，也是如此。国内访问比较不稳定。</li>
<li><strong>强绑定 React 生态</strong>。想使用其他技术栈需要通过 prompt 的方式，具有一定的局限性。</li>
<li>对于非技术人员来说，由于其生成的代码遵守 React 组件化的设定，反倒增加了学习曲线。</li>
<li><strong>无法完全私有化</strong>。</li>
</ul>
<p>要解决以上问题，其实有几种方式：</p>
<ul>
<li><strong>使用 AI CLI + 代理的方式</strong>。比如使用 Claude Code、Codex 或者 Gemini CLI；</li>
<li><strong>使用 Web 应用</strong>，比如 GLM-4.5-Flash；</li>
<li>使用开源工具 <strong>ScreenToCode</strong>。</li>
</ul>
<h3 data-id="heading-1">以非技术人员的视角看</h3>
<p><strong>第一种方式是目前深受开发者所喜欢的</strong>，尤其是在搭配 Skills 之后，对于生成页面这种事情更是如虎添翼、信手拈来。</p>
<p>但是相对应的，这种方式也存在一定的局限性：</p>
<ul>
<li>对于非开发人员来说，这个方式存在一定的学习成本。</li>
<li>终端方式并不适合每个人，比如设计师和产品经理，他们可能更倾向于可视化的工具。</li>
</ul>
<p>其中<strong>第二种方式最简单</strong>，因为：</p>
<ol>
<li>你只需要访问他们的网址；</li>
<li>上传图片或者复制粘贴要制作的网页地址；</li>
<li>告诉 AI 你想做一个一模一样的网页</li>
</ol>
<p>回车之后它就会为你快速输出一个网页代码出来。比如我上传了一张博客的图片，并让其生成对应的代码：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c14c6045294437a82a404503546a5a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768487429&amp;x-signature=hprNmURtI6fCdbyCxv4f%2FbkyJsw%3D" alt="" loading="lazy"/></p>
<p>然后它开始解析图片并逐步输出代码到对话框中：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38a842ecdc1c4842a2bbac13b79d8a36~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768487429&amp;x-signature=FdKDAcmTO0UfI0cTLEqu0qGW3ac%3D" alt="" loading="lazy"/></p>
<p>我们把对应的代码粘贴复制到一个 html 文件中并双击打开：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/00d663d2968b4666b4e4ee015ac301e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768487429&amp;x-signature=LALa0tfNa3%2BLTlUUv%2BMmw09we%2Bo%3D" alt="" loading="lazy"/></p>
<p>可以看到它确实生成了一个博客网页，但是<strong>差别还是有些大的</strong>。主题、布局、排版和原图都差距较大，像是在原图的基础上又按照自己的理解设计了一个新的出来，只适用于不太在乎还原度的玩家。</p>
<p>最后——<strong>screen-to-code</strong>，在体验之后发现，<strong>它的操作便捷性以及还原度竟然秒杀前两个</strong>！</p>
<p>首先，在便捷性上：</p>
<ul>
<li><strong>只需要提供截图或者网页链接即可快速进行 AI 还原</strong>；</li>
<li>screen-to-code 会<strong>提供四个 Option，用户可以在其中对比找出一个还原度最高的</strong>；</li>
<li>还可以<strong>选中其中的某个 Option 进行对话式修改</strong>。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/91427bc852334ca0b234789e9463634c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768487429&amp;x-signature=kJCDNKKqB5BGyA5PpB6utwbItXA%3D" alt="" loading="lazy"/></p>
<p>其次，在还原度上我们以上面的截图为例，我们看看 screen-to-code 的实际效果：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ccb00369ba844cbb8510dc300474bb42~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768487429&amp;x-signature=rt0ss7fSOTsXORIsXcEaL0ae09M%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b9f57d898964fec85e6e7ec7ae72fa4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768487429&amp;x-signature=AgbCyC4L3I8KAh0Kts37JxdPK5Y%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7630402ef78c4b10a3e73ffa52158434~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768487429&amp;x-signature=sYsDqTxNpyCeup4AfcqT3WopFps%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18200283997f45599d5d8389057da259~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768487429&amp;x-signature=HZ7iEboBZ%2F0catyu4sD6Dbem4ZA%3D" alt="" loading="lazy"/></p>
<p>除了第二张之外，其他三张的还原度都挺高！尤其是 1 和 3，个人觉得可以直接拿来使用了。</p>
<p>另外，它还提供了七种生成方式，如下图所示：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87cd71bf4a3342a1baa8c56028dab99a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768487429&amp;x-signature=QyZ%2FpZ30YcO88ADKEqYgNVp2iIk%3D" alt="" loading="lazy"/></p>
<p><strong>对于非技术人员来说（尤其是想做个官网、个人主页之类的小伙伴），HTML + Tailwind、HTML + CSS 以及 Bootstrap 这三种方式简直是为你们量身定做！</strong></p>
<p>找个喜欢的页面截图或者链接贴进去，不一会儿就给你生成好页面框架，你只需要下载文件后修改里面的内容和图片就可以直接使用了。</p>
<p>而剩下的几种方式，个人觉得<strong>比较适合大学生的期末作业</strong>。像 React + Tailwind 或者 Vue + Tailwind 这种，也不用啥工程化的东西，快速产出，完全不用为写页面而发愁。</p>
<h3 data-id="heading-2">部署</h3>
<p>说了这么多具体怎么使用呢？</p>
<p>两种方式：</p>
<ul>
<li>访问官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fscreenshottocode.com%2F%25E3%2580%2582%25E4%25B8%258D%25E8%25BF%2587%25E5%25BE%2597%25E8%258A%25B1%25E9%2592%25B1%25EF%25BC%258C%25E4%25B8%25A4%25E4%25B8%25AA%25E6%25A1%25A3%25E4%25BD%258D%25EF%25BC%259A%2415" target="_blank" title="https://screenshottocode.com/%E3%80%82%E4%B8%8D%E8%BF%87%E5%BE%97%E8%8A%B1%E9%92%B1%EF%BC%8C%E4%B8%A4%E4%B8%AA%E6%A1%A3%E4%BD%8D%EF%BC%9A$15" ref="nofollow noopener noreferrer">screenshottocode.com/。不过得花钱，两个档位…</a> 和 $40。</li>
<li>自己部署或者访问其他大佬部署好的。</li>
</ul>
<p>自己部署的话，推荐使用 docker 一键部署：</p>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> https://github.com/abi/screenshot-to-code.git

<span class="hljs-built_in">cd</span> screen-to-code

<span class="hljs-comment"># 非常重要！！</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"OPENAI_API_KEY=sk-your-key"</span> &gt; .<span class="hljs-built_in">env</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"OPENAI_BASE_URL=your-custom-url"</span> &gt; .<span class="hljs-built_in">env</span>

docker compose up -d --build
</code></pre>
<p>成功后，访问 <code>http://localhost:5173</code> 即可。</p>
<p>最后补充三点：</p>
<ul>
<li>AI 模型需要多模态模型，比如 GPT-4o、或者 llava；</li>
<li>API Key 和 Base URL 可以在设置中进行配置；</li>
<li>要使用 URL 的方式，需要配置 ScreenshotOne API key，每月会免费提供 100 次的使用额度。个人开发完全够用</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79646347791f476f848522dd2c7f146b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768487429&amp;x-signature=1%2B0IbgMusgA4dC7k2a0syXglnRk%3D" alt="" loading="lazy"/></p>
<p>附，测试生成的代码：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ee3a258088f47b19fa45e2056ab82b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768487429&amp;x-signature=iHxgAUUGz10zTB%2FQVqV%2BOyHyuZY%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Veo API：0门槛量产商业级视频！2026视频流量密码，创作者/商家必藏]]></title>    <link>https://juejin.cn/post/7592822714068189235</link>    <guid>https://juejin.cn/post/7592822714068189235</guid>    <pubDate>2026-01-08T14:33:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592822714068189235" data-draft-id="7592822714068172851" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Veo API：0门槛量产商业级视频！2026视频流量密码，创作者/商家必藏"/> <meta itemprop="keywords" content="API,Google"/> <meta itemprop="datePublished" content="2026-01-08T14:33:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="崔庆才丨静觅"/> <meta itemprop="url" content="https://juejin.cn/user/1521379821230269"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Veo API：0门槛量产商业级视频！2026视频流量密码，创作者/商家必藏
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1521379821230269/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    崔庆才丨静觅
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T14:33:15.000Z" title="Thu Jan 08 2026 14:33:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>2026年流量主战场已锁定视频端！小红书15秒种草视频10万+赞、抖音30秒品牌故事破百万播放、视频号直播切片单日引流500+精准客资… 但90%想靠视频变现的人，都被这些难题卡住：</p>
<ul>
<li>专业剪辑要学3个月，新手望而却步；</li>
<li>找团队拍1条商业视频花2000+，中小商家扛不住；</li>
<li>批量产出就掉画质，同质化严重没流量；</li>
<li>AI生成视频参数复杂+网络受限，劝退99%开发者</li>
</ul>
<p>别慌！刷屏创作者圈的「视频量产神器」——Veo API来了！AI驱动的视频生成与编辑API，让你0专业门槛、低成本批量产出高清商业级视频，更有<strong>Ace Data Platform生态加持</strong>（专属对接链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.acedata.cloud%2F" target="_blank" title="https://platform.acedata.cloud/" ref="nofollow noopener noreferrer">Ace Data Platform官网</a>），稳定省心，个人创作、企业部署全hold住！</p>
<h2 data-id="heading-0">一、4大核心能力封神！Veo凭什么成生产力救星？</h2>
<p>直接把视频制作效率拉到天花板，全网创作者疯狂跟风的硬实力：</p>
<ol>
<li>
<p>文本/图片一键转视频，小白也能1分钟出片<br/>
输入文字脚本、上传产品图/素材图，Veo自动匹配场景、添加转场特效、生成字幕和背景音乐，无需手动调参！种草视频、产品介绍、知识科普全搞定，1分钟干完别人1天的活。</p>
</li>
<li>
<p>4K超清画质+多风格适配，商业级质感拉满<br/>
支持4K/1080P超清输出，色彩还原度超高、细节无模糊！ins风、国潮风、科技感、治愈系等100+风格模板任选，还能自定义品牌色调、水印，助力打造专属IP，质感碾压同行。</p>
</li>
<li>
<p>智能剪辑+批量生成，效率直接翻10倍<br/>
批量导入脚本生成多条视频，自动规避重复片段；智能截取高光，精准适配小红书（15s）、抖音（30s）、视频号（60s）等平台时长要求，无需二次修改，日更不熬夜。</p>
</li>
<li>
<p>多模态交互+高兼容性，开发10分钟接入<br/>
支持文本、图像多模态指令，可对接自有素材库；适配Python、JavaScript等全主流编程语言，提供详细开发文档和示例代码，新手开发者也能快速上手调试。</p>
</li>
</ol>
<h2 data-id="heading-1">二、5大落地场景，覆盖从个人到企业全需求</h2>
<p>不同用户都能找到核心价值，流量变现、降本增效一把抓：</p>
<ol>
<li>
<p>自媒体创作：批量生成知识科普、书单/影单分享、短视频封面，轻松维持日更，抢占流量红利，不用熬夜剪辑！</p>
</li>
<li>
<p>电商营销：产出产品多角度展示、场景化种草、直播切片视频，无需实景拍摄，营销素材成本直降90%，转化率提升3倍+！</p>
</li>
<li>
<p>企业培训：文字手册、PPT一键转动画培训视频，生动易懂，员工学习效率翻倍；还能批量生成不同岗位定制化内容！</p>
</li>
<li>
<p>品牌营销：批量产出品牌宣传、节日营销、活动预热视频，风格统一覆盖全平台，快速提升品牌曝光度和用户记忆点！</p>
</li>
<li>
<p>娱乐开发：开发视频变装、AI换脸、老视频修复等趣味APP功能，强互动性拉满用户留存率和分享欲，打造爆款应用！</p>
</li>
</ol>
<h2 data-id="heading-2">三、避坑指南！成本直降1/3</h2>
<p>商业部署/大规模调用：Ace Data Platform协同方案（强推！）
通过专属通道接入（链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.acedata.cloud%2Fdocuments%2Fveo-videos" target="_blank" title="https://platform.acedata.cloud/documents/veo-videos" ref="nofollow noopener noreferrer">Veo API专属对接页</a>），3大优势解决所有痛点：</p>
<ul>
<li>成本更低：阶梯定价+失败调用不计费，比官方直连节省30%+成本，中小商家无压力；</li>
<li>网络更稳：国内直连专属节点，无需额外配置代理，API可用性99.9%，批量生成不卡顿、不中断；</li>
<li>生态更全：联动平台其他API，可以实现更高效率生成视频，一站式解决您制作视频的所有步骤。</li>
</ul>
<h2 data-id="heading-3">四、3步快速接入，解锁视频量产超能力</h2>
<ol>
<li>注册Ace Data Platform账号，进入<a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.acedata.cloud%2Fdocuments%2Fveo-videos" target="_blank" title="https://platform.acedata.cloud/documents/veo-videos" ref="nofollow noopener noreferrer">Veo API专属对接页</a>，领取专属API Key；</li>
<li>参考多语言示例代码（含Python、JavaScript等），按需配置文本转视频、图片转视频、智能剪辑等参数；</li>
<li>发起调用并对接自有系统/创作工具，生成视频自动存储至平台云空间！</li>
</ol>
<h2 data-id="heading-4">五、限时福利！手慢无！</h2>
<p>新用户注册Ace Data Platform，直接解锁Veo API免费体验额度！<br/>
无套路！个人/企业通用 | 零成本试错 | 即领即用！<br/>
点击直达领取：<a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.acedata.cloud%2Fdocuments%2Fveo-videos" target="_blank" title="https://platform.acedata.cloud/documents/veo-videos" ref="nofollow noopener noreferrer">Veo API免费体验通道</a></p>
<p>2026视频流量风口，拼的就是「量产能力」+「内容质感」！Veo API帮你跳过专业门槛、砍掉高成本，Ace Data Platform生态更让视频创作从“盲目产出”升级为“精准变现”～</p>
<p>不管你是想靠短视频变现的自媒体人，还是想降本增效的电商商家、企业营销人员，这波免费体验机会千万别错过！先体验再决策，零风险开启视频量产爆发之旅！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[18条作品狂揽390万赞？我用Coze破解了“情绪放大镜”的流量密码]]></title>    <link>https://juejin.cn/post/7592818272153763867</link>    <guid>https://juejin.cn/post/7592818272153763867</guid>    <pubDate>2026-01-08T13:26:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592818272153763867" data-draft-id="7592768559169830938" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="18条作品狂揽390万赞？我用Coze破解了“情绪放大镜”的流量密码"/> <meta itemprop="keywords" content="Coze,AIGC,人工智能"/> <meta itemprop="datePublished" content="2026-01-08T13:26:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="后端小肥肠"/> <meta itemprop="url" content="https://juejin.cn/user/2966945320667536"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            18条作品狂揽390万赞？我用Coze破解了“情绪放大镜”的流量密码
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2966945320667536/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    后端小肥肠
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T13:26:26.000Z" title="Thu Jan 08 2026 13:26:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是小肥肠！最近心理学赛道杀出了一匹黑马——【情绪放大镜】，<strong>仅仅发布18个作品就狂揽390万赞，吸粉27万！</strong> 这种高共鸣类视频简直是流量收割机。 很多朋友想做，但觉得文案难写、画面难画。今天直接安排！<strong>仅用 Coze 就能搭建全自动</strong> <strong>工作流</strong> <strong>。</strong> 输入主题和BGM，3分钟直出剪映草稿。想在这个新风口分一杯羹的朋友，这篇干货千万别错过，跟练走起~</p>
<h2 data-id="heading-0">1. 前言</h2>
<p>最近，心理学赛道杀出一匹黑马。一位名叫【情绪放大镜】的博主，仅仅发布了18条作品，就狂揽<strong>390万点赞</strong>，涨粉27万。这种视频凭借细腻的情绪共鸣和简约黑白画面，斩获极高流量。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0bfb01f72bfa4de6bfc5b86d4883cc7e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768483585&amp;x-signature=pgk306KMGU2A5jhBvzBsqvwQ2q0%3D" alt="" loading="lazy"/></p>
<p>其实这种类型的视频可以用Coze工作流一键生成，只需要找到工作流界面，在开始节点处输入主题和背景音乐，点击底部【试运行】按钮。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9fb12ccf18fc443ba59d621da82975d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768483585&amp;x-signature=QXRYY3Y1TxCFpYXagbERNxWdwl0%3D" alt="" loading="lazy"/></p>
<p>等待几分钟即可得到剪映草稿地址，只需要将其粘贴到剪映小助手，点击【创建剪映草稿】，等待几秒钟就可以获取下面的成品视频：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/684de1a80ac048b188d66be8069dfadf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768483585&amp;x-signature=xLNFR4kNLRFxaswucDx8aPV8qnc%3D" alt="image.png" loading="lazy"/></p>
<p>如果你也想做类似视频，速度码住跟练，文末送工作流中的文生图提示词和图生视频提示词哦~</p>
<h2 data-id="heading-1">2. 工作流搭建</h2>
<p>完整工作流如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0196857d918341a7a73585b7d2ee57b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768483585&amp;x-signature=7DaW1ZOoiglO0qgAkGjH%2FgQjrHI%3D" alt="" loading="lazy"/></p>
<p>总体流程可以梳理如下：</p>
<ol>
<li>
<p>根据用户输入的主题生成视频文案</p>
</li>
<li>
<p>将文案切分为文案片段列表</p>
</li>
<li>
<p>合并文案列表片段得到符合语义的文案列表</p>
</li>
<li>
<p>对合并后的文案片段进行配音操作，获取每个配音片段的时间段</p>
</li>
<li>
<p>对合并后的文案片段进行文生图、图生视频操作</p>
</li>
<li>
<p>将前置节点生成的素材添加到剪映草稿中</p>
</li>
<li>
<p>生成视频封面</p>
</li>
<li>
<p>输出生成好的封面和剪映草稿</p>
</li>
</ol>
<p><strong>开始节点：</strong> 开始节点传入的参数是视频主题和背景音乐（.MP3）。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2be8ba948f59465d911558f029063fab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768483585&amp;x-signature=aDK5rVtNKg3PQ71PycUTRVfW78E%3D" alt="" loading="lazy"/></p>
<p><strong>情绪放大镜文案(</strong> <strong>大模型</strong> <strong>)：</strong> 大模型节点，它的作用是根据主题生成视频文案。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7128ecfdde49497da9176cdb71b9228a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768483585&amp;x-signature=aRsYVDHRaoz50STI2eXJmnYUTf8%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">2.1. 封面生成</h3>
<p>封面搭建的完整链路如图：<strong>情绪放大镜文案(</strong> <strong>大模型</strong> <strong>)</strong> 节点结束后就分成了封面生成和视频制作两个分支，封面生成的流程比较简单，就三个节点，依次是根据前置节点文案生成文生图提示词，基于文生图提示词生成图片，封面组装。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/07e92a6646904f048fafe7c434d14617~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768483585&amp;x-signature=QrTaUxEKNuVhXaAMegEmsCQKk8U%3D" alt="" loading="lazy"/></p>
<p><strong>大模型</strong> <strong>（生成绘制封面图的文生图提示词）：</strong> 这是一个大模型节点，模型选择了豆包系列，输入的参数是<strong>情绪放大镜文案(大模型)</strong> 节点生成的文案。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40ab8c88f10f45c7a9a0bc3a11d2205a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768483585&amp;x-signature=6F6Tu%2BpIrGEGKf3T0iy%2BUAwAox8%3D" alt="" loading="lazy"/></p>
<p><strong>封面帧图像生成：</strong> 这是Coze内置的图像生成节点，采用Seedream4.0绘图模型，为了更贴近原版这边还上传了4张参考图。输入节点配置的是<strong>大模型</strong> <strong>（生成绘制封面图的文生图提示词）</strong> 节点生成的文生图提示词。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1a1d71d3cbf42d6a6e02060c02422f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768483585&amp;x-signature=jgxVfinX%2BqXcLxki5JBJxji0VWM%3D" alt="" loading="lazy"/></p>
<p><strong>画板：</strong> 画板节点的作用是将<strong>封面帧图像生成</strong>节点生成的图和<strong>开始节点</strong>传入的视频主题拼接为视频封面。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31f06f3cb22f483d8be3ff96c75ff96e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768483585&amp;x-signature=fMTLyv7zcgB5GLPPhziPMmpdtMs%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">2.2. 视频生成</h3>
<p><strong>口播稿分割：</strong> 这是一个插件节点，它的作用是将<strong>情绪放大镜文案(</strong> <strong>大模型</strong> <strong>)</strong> 节点生成的文案拆分为文案片段列表。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff4a2a5ded614188b81ad5927c7e4812~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768483585&amp;x-signature=8oXi%2Bqfh99JpdieqQLzEX4kpqC8%3D" alt="" loading="lazy"/></p>
<p><strong>合并文案（</strong> <strong>大模型</strong> <strong>）：</strong> 这个节点的作用是将<strong>口播稿分割</strong>节点输出的文案列表进行二次合并，这一步做不做都可以，我做这一步的原因是<strong>口播稿分割</strong>输出的文案片段太多了，很多小短句，一个小短句代表一个分镜视频，这个大模型节点是将前后小短句进行合并，避免分镜资源消耗太多。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05abf89f26164214ac7835f2d6b5c86d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768483585&amp;x-signature=oQTieyD7w2sYR5z63p6I%2BS7fYLM%3D" alt="" loading="lazy"/></p>
<p><strong>循环配音：</strong> 字幕生成完毕后就来到了配音生成环节，下面的节点就是将字幕列表传入循环，在循环中进行配音，并获取每段配音的时长。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a0ffb586ad64fdbbc0df52e3d5387c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768483585&amp;x-signature=7ra%2BODJqp7CywZOm0JYmOewEq%2Fk%3D" alt="" loading="lazy"/></p>
<p><strong>循环生图和生成图生视频提示词：循环配音</strong>结束后就来到了生图环节，依然是基于循环来进行生图和生成图生视频提示词。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6cfb92316f04bf4b0c8b44e191e5bb0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768483585&amp;x-signature=Bbapd3AGE%2BhRmjqG8XrL%2BnW9Q0I%3D" alt="" loading="lazy"/></p>
<p><strong>生图操作：</strong> 在循环中的生图我进行了3轮重试操作（处于Coze工作流健壮性考虑），同时用选择器做了循环轮数的控制。<strong>这里是一个Coze调试的小技巧，在需要多轮循环才能完成的工作流中，我们可以在循环体内部的末尾加一个选择器判断当前index轮数，下图中我的判断条件的index=4就结束循环，即生成5张图片，5个分镜。</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c040f1277704705872161577271e051~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768483585&amp;x-signature=CgsE0eP4CPYi42x%2BUghLCRarLB8%3D" alt="" loading="lazy"/></p>
<p><strong>视频生成：</strong> 视频生成依旧用的循环体来生成视频，视频生成插件采用<strong>Coze内置视频生成插件。如果觉得视频生成成本太高，可以把这一步骤往后的节点都删除，即</strong> <strong>工作流</strong> <strong>只生成字幕、图片和图生视频提示词，你自己去视频生成软件（如豆包）生成视频后去剪映自己拼一下，这种做法可以把成本降到最低，缺点就是费一些时间。</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/43daf34f72354886a2847e546f162174~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768483585&amp;x-signature=0m4fEYIKeFLMuM3ZELrRRB8%2BBvY%3D" alt="" loading="lazy"/></p>
<p><strong>代码_信息组装：</strong> 在前面的节点中我们生成了音频、字幕、分镜等视频元素。本节点的作用是组装拼接前置要素生成适配剪映小助手需要的格式。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/671116cf36644fc994431cd32e3c6aaf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768483585&amp;x-signature=BMrfwYvuVxZFI9ndgRFQU%2FFe1uM%3D" alt="" loading="lazy"/></p>
<p><strong>添加素材到剪映草稿：</strong> 这是最后的步骤，我们只需要将代码节点输出的音频、视频、字幕等数据依次添加到剪映小助手即可。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77641d8e3b4f4667af0d778325a3560b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768483585&amp;x-signature=MNvRiWmgu4IMavmQOr0P5oOf804%3D" alt="" loading="lazy"/></p>
<p><strong>结束：</strong> 结束节点接收的是最终的剪映草稿和封面图。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ad5cd2f5c564e0bafd4b966fbf49193~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768483585&amp;x-signature=2%2F6KyehCdouTq%2BhHPUoI2K%2FL3hw%3D" alt="" loading="lazy"/></p>
<p>以上就是整个工作流的完整流程拆解，动手能力强的读者可以跟着教程实践一遍。<strong>上述工作流已经被收录到了小肥肠共学群中，如果想直接获取工作流原件，可以加入社群后我拉你进空间直接学习使用。</strong></p>
<p>本工作流中的文生图和图生视频提示词模板限量30份，想要的可以666获取哦~</p>
<h2 data-id="heading-4">3. 结语</h2>
<p>以上就是利用Coze复刻百万赞视频的全流程拆解。 虽然我们演示的是<strong>情绪放大镜类型的视频</strong>，但这个工作流的底层逻辑——<strong>大模型</strong> <strong>生成文案 -&gt; 拆解分镜 -&gt; 批量生图 -&gt; 组装草稿</strong>，其实是通用的。你完全可以把它修改一下，应用到<strong>民间故事、历史科普、甚至是小说推文</strong>赛道中。</p>
<p><strong>如本次分享对你有帮助，麻烦一键三连支持一下小肥肠，我们下期再见~</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fac62e6a2fcc4d7392958fa6f1d54fee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768483585&amp;x-signature=gw%2BTGX%2FJmO78GPgvwoRa6rXQh1s%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025 年度总结：人生重要阶段的一年]]></title>    <link>https://juejin.cn/post/7592833068223152174</link>    <guid>https://juejin.cn/post/7592833068223152174</guid>    <pubDate>2026-01-08T13:56:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592833068223152174" data-draft-id="7590128405350858752" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025 年度总结：人生重要阶段的一年"/> <meta itemprop="keywords" content="前端,程序员,年终总结"/> <meta itemprop="datePublished" content="2026-01-08T13:56:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Setsuna_F_Seiei"/> <meta itemprop="url" content="https://juejin.cn/user/835284567854696"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025 年度总结：人生重要阶段的一年
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/835284567854696/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Setsuna_F_Seiei
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T13:56:47.000Z" title="Thu Jan 08 2026 13:56:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="rainbow">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#474949;color:#d1d9e1}.hljs-comment,.hljs-quote{color:#969896;font-style:italic}.hljs-addition,.hljs-keyword,.hljs-literal,.hljs-selector-tag,.hljs-type{color:#c9c}.hljs-number,.hljs-selector-attr,.hljs-selector-pseudo{color:#f99157}.hljs-doctag,.hljs-regexp,.hljs-string{color:#8abeb7}.hljs-built_in,.hljs-name,.hljs-section,.hljs-title{color:#b5bd68}.hljs-class .hljs-title,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#fc6}.hljs-name,.hljs-section,.hljs-strong{font-weight:700}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-subst,.hljs-symbol{color:#f99157}.hljs-deletion{color:#dc322f}.hljs-formula{background:#eee8d5}.hljs-attr,.hljs-attribute{color:#81a2be}.hljs-emphasis{font-style:italic}</style><p>2025 年对我来说是一年做出人生重大决定的一年，因为在这一年内领证结婚摆酒了，也算是结束了5年的爱情长跑，完成了人生一件大事了吧！</p>
<br/>
<h3 data-id="heading-0">忙碌的生活</h3>
<p>2025年最大的感受还是繁忙，首先是在年初的时候决定在春节前就把领证结婚还有迁户口的事情给落实掉，然后就是双方选定年底的日子联婚摆酒，因此从年头就开始收拾东西准备装修，然后是新屋入伙；年中就开始不断的在工作空余时间在忙着筹备年底摆酒的事情了，摆完酒就干脆趁着婚假和年假调休等一起休了几天顺带简单的广东省内游了几天。</p>
<p>不得不说，现在结个婚摆个酒真的花钱像流水一样啊，首先就是家里装修是自装，简简单单的对房子重新刮塑、批荡了一番；然后只将婚房搞了一个定制柜，将窗帘重新定制了，买了新床，新床垫被子等一系列准备婚房的东西。接着就是买三金还有戒指、还有订西装、婚纱、裙褂等。这就不得不提下老婆真的是非常适合过日子的性格了，一切从简并且在准备婚礼的各种买东西上面也是不断地货比三家想要减轻结婚花钱的经济压力，连婚戒也没特别说一定要那个不保值的钻石戒指（当然要是我以后真有钱了一定会补上这个的）、并且还好女方家庭 （暂时，也不知道以后老婆会不会嫌弃和上一辈住一起久了开始厌烦（划掉 没有嫌弃我没有自己的房子要和爸妈住一起；双方都是广东家庭，彩礼也不是要很多。即便是多方面节约、精打细算的加成下，结婚这件事情基本上还是也得花费大概三四十万块（不过算了，结婚这事花过去就算了，纠结不了那么多了）。</p>
<br/>
<h3 data-id="heading-1">职业生涯的迷茫</h3>
<p>在这一年来其实是在业余当中尝试学习做独立游戏，发现这条路真的十分漫长，并且如果是想要像直接从一个前端进行赚钱或者转行为目的的前提下，想要短时间就想获得很高的一个正反馈那不太现实的（如果想要短期内获得更多的一个经济上的正反馈，还不如进行直接接外包或者直接花额外的时间进修下前端后台技术进行职业上的提升更好）。但是呢，在职场上每天都在应付那群领导的索嗨拍脑袋操作，每天都在重复干着些为了给领导兜底的枯燥活；个人的成长空间极大的被受限。</p>
<p>笔者所在的公司现在因为这两年经济的下行业务系统的收窄人员的离开，现在公司里的客户端部门和 web 前端都直接合并成一个 “大前端” 部门了，虽然说名义上还是那个前端 LD，但是反正我是觉得多个 DM 来管着 web 前端组了（无论哪种行为我都觉得 🤮，一天天的在想训练奴性，唉。</p>
<br/>
<h3 data-id="heading-2">下一年的期待与计划</h3>
<p>结婚了就会更多的将职业重心逐渐偏向到家人身边了。刚过完跨年就接连变故，因为办公地点的变更，老婆被间接失业了；但是就在收到消息的当天晚上她有个好朋友伸出援手，推荐了另外一份工作，正好这份工作办公就要来到深圳，正好我也是在深圳工作的，因此 26 年应该就能夫妻俩生活工作都在一起了。今年就能够多记录下两夫妻的二人生活 log 了。</p>
<p>笔者在这一年确实明显的感受到 AI 的超快速发展，虽然感觉到 AI 目前暂时还并不能真的完全替代程序员这方面，但是 AI 辅助工作，作为提升工作效率的工具这方面的发展是非常迅速的，打算着 26 年也是进行一定程度的 AI 辅助开发的学习当中。另一个则是向着前端优化架构师的一个方向进行学习，例如项目构建链的升级优化、项目的缓存优化等。还有就是业余下继续学习一些相关独立游戏开发的技术，也算是另外的一个保持着对技术的热情吧。</p>
<p><br/><br/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[GDAL 空间关系解析]]></title>    <link>https://juejin.cn/post/7592803747471704114</link>    <guid>https://juejin.cn/post/7592803747471704114</guid>    <pubDate>2026-01-08T12:08:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592803747471704114" data-draft-id="7592816646870499337" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="GDAL 空间关系解析"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-08T12:08:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="GIS之路"/> <meta itemprop="url" content="https://juejin.cn/user/4346787284915481"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            GDAL 空间关系解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4346787284915481/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    GIS之路
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T12:08:54.000Z" title="Thu Jan 08 2026 12:08:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">^ 关注我，带你一起学GIS ^</h2>
<h2 data-id="heading-1">前言</h2>
<blockquote>
<p>❝</p>
<p>空间关系用于判断几何对象之间位置关系，GDAL支持相交、相离、包含等多种空间关系。在GIS开发中，空间分析离不开准确的空间关系判断，选择何种空间关系，对数据查询和分析速度的影响也会有差异，所以，熟练掌握各种空间关系是很有必要的。</p>
</blockquote>
<p>在之前的文章中讲了如何使用<code>GDAL</code>或者<code>ogr2ogr</code>工具将<code>txt</code>以及<code>csv</code>文本数据转换为<code>Shp</code>格式，本篇教程在之前一系列文章的基础上讲解如何使用<strong>GDAL 空间关系解析</strong>。</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FQtb_BJw91nKrFMeoa7WcxA" target="_blank" title="https://mp.weixin.qq.com/s/Qtb_BJw91nKrFMeoa7WcxA" ref="nofollow noopener noreferrer">GDAL 简介</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FFLWfZItLj24JYicQEX-PbQ" target="_blank" title="https://mp.weixin.qq.com/s/FLWfZItLj24JYicQEX-PbQ" ref="nofollow noopener noreferrer">GDAL 下载安装</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fu0539e3CM2q4Y3MbMxxZKQ" target="_blank" title="https://mp.weixin.qq.com/s/u0539e3CM2q4Y3MbMxxZKQ" ref="nofollow noopener noreferrer">GDAL 开发起步</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F0DGoC0oFHizJbweBnEvI-g" target="_blank" title="https://mp.weixin.qq.com/s/0DGoC0oFHizJbweBnEvI-g" ref="nofollow noopener noreferrer">GDAL 实现 GIS 数据读取转换（全）</a></li>
</ul>
<p>如果你还没有看过，建议从以上内容开始。</p>
<h2 data-id="heading-2">1. 开发环境</h2>
<p>本文使用如下开发环境，以供参考。</p>
<p>时间：<code>2025年</code></p>
<p>系统：<code>Windows 11</code></p>
<p>Python：<code>3.11.7</code></p>
<p>GDAL：<code>3.11.1</code></p>
<h2 data-id="heading-3">2. 判断几何关系</h2>
<p>定义一个方法<code>SpatialRelations</code>用于判断要素间空间关系，该方法接收两个参数，其中<code>polygonPath</code>指向面文件路径，<code>pointPath</code>指向点文件路径。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""
说明：判断空间关系
参数：
    -polygonPath：面图层数据路径
    -pointPath：点图层数据路径
"""</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">SpatialRelations</span>(<span class="hljs-params">polygonPath,pointPath</span>):
</code></pre>
<p>对于数据的基础操作步骤为获取数据驱动，获取数据源，再到获取目标图层。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 检查文件是否存在</span>
checkFilePath(polygonPath)
checkFilePath(pointPath)

<span class="hljs-comment"># 添加数据驱动</span>
<span class="hljs-attr">shpDriver</span> = ogr.GetDriverByName(<span class="hljs-string">"ESRI Shapefile"</span>)

<span class="hljs-comment"># 获取数据源</span>
<span class="hljs-attr">polygonDs</span> = shpDriver.Open(polygonPath)
<span class="hljs-attr">pointDs</span> = shpDriver.Open(pointPath)

<span class="hljs-comment"># 获取图层</span>
<span class="hljs-attr">polygonLayer</span> = polygonDs.GetLayer(<span class="hljs-number">0</span>)
<span class="hljs-attr">pointLayer</span> = pointDs.GetLayer(<span class="hljs-number">0</span>)
</code></pre>
<p>方法<code>checkFilePath</code>用于检查文件路径是否正常，接受一个路径参数。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""
说明：检查文件路径是否正常
参数：
    -filePath：文件数据路径
"""</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">checkFilePath</span>(<span class="hljs-params">filePath</span>):
    <span class="hljs-keyword">if</span> os.path.exists(filePath):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"文件数据路径存在"</span>)
    <span class="hljs-keyword">else</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"文件数据路径不存在，请检查！"</span>)
</code></pre>
<p>本文基于以下数据进行空间关系判断。<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6cb80e06c8dc41f5b4b59eafeca9d1e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768478933&amp;x-signature=dN9QLk5QGP9ki%2FJw4E4ZkdCQMT4%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">3. 相交关系</h2>
<p>通过<code>GetNextFeature</code>或者<code>GetFeature</code>方法获取要素，其中<code>GetFeature</code>方法需要传入指定<code>FId</code>参数。</p>
<pre><code class="hljs language-ini" lang="ini">    <span class="hljs-comment"># 遍历面图层要素</span>
    for polyFeature in polygonLayer:
        <span class="hljs-comment"># 获取几对象</span>
        <span class="hljs-attr">polyGeom</span> = polyFeature.GetGeometryRef()
        <span class="hljs-comment"># 获取要素Id</span>
        <span class="hljs-attr">featId</span> = polyFeature.GetField(<span class="hljs-string">"Id"</span>)
        print(f"n面状要素~~~~~Id：{featId}n")

        <span class="hljs-comment"># 获取几何要素</span>
        <span class="hljs-attr">polyGeom</span> = polyFeature.GetGeometryRef()
        <span class="hljs-comment"># print(f"面状几何：{polyGeom}")</span>

        <span class="hljs-comment"># 遍历点图层要素</span>
        for ptFeature in pointLayer:
            <span class="hljs-comment"># 获取几何对象</span>
            <span class="hljs-attr">ptGeom</span> = ptFeature.GetGeometryRef()
            <span class="hljs-comment"># print(f"点状几何：{ptGeom1}")</span>

            <span class="hljs-comment"># 获取要素名称</span>
            <span class="hljs-attr">featName</span> = ptFeature.GetField(<span class="hljs-string">"name"</span>)   

            <span class="hljs-comment"># 相交</span>
            <span class="hljs-attr">result</span> = polyGeom.Intersect(ptGeom)

            <span class="hljs-attr">description</span> = <span class="hljs-string">"不相交"</span> if result == <span class="hljs-literal">False</span> else <span class="hljs-string">"^^😊相交😊^^"</span>

            print(f"面要素【{featId}】与点要素【{featName}】 是否相交：{result} （{description}）") 
</code></pre>
<p>其中<strong>相交</strong>关系输出结果显示如下，与图形显示结果一致。<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3047c9ade63a4cbca34e2c74eaf0b017~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768478933&amp;x-signature=lVZ7gSbAZQzRv91CCiz2ZMveO5U%3D" alt="" loading="lazy"/></p>
<p>其中<strong>相离</strong>关系输出结果显示如下，与图形显示结果一致。<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e46673e9a814a41a16a58fdaf7dfdd2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768478933&amp;x-signature=JQyypc6Ae49MvQkV95TLuTsGgWs%3D" alt="" loading="lazy"/></p>
<p>其中<strong>相接</strong>关系输出结果显示如下，与图形显示结果一致。<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f66aabfa22834706bfcfcc10c5455ebc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768478933&amp;x-signature=U3IDz7zxZNCNMaUc%2BAzpQxphqMc%3D" alt="" loading="lazy"/></p>
<p>还有<strong>包含（Contains）、重叠（Overlaps）、在...之内（Within）</strong> 等空间关系，留给感兴趣的读者自行实现。</p>
<h2 data-id="heading-5">4. 注意事项</h2>
<p>在<code>windows</code>开发环境中同时安装<code>GDAL</code>与<code>PostGIS</code>，其中投影库<code>PROJ</code>的环境变量指向<code>PostGIS</code>的安装路径，在运行GDAL程序时，涉及到要素、几何与投影操作时会导致异常。<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f0cac649d51f46ec9f78e3c3e3c46a75~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768478933&amp;x-signature=txRoneDaubltLP3GULJvfWOdIo8%3D" alt="" loading="lazy"/>具体意思为<code>GDAL</code>不支持<code>PostGIS</code>插件中的投影库版本，需要更换投影库或者升级版本。</p>
<p><code>RuntimeError: PROJ: proj_identify: D:Program FilesPostgreSQL13sharecontribpostgis-3.5projproj.db contains DATABASE.LAYOUT.VERSION.MINOR = 2 whereas a number &gt;= 5 is expected. It comes from another PROJ installation.</code><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d5ea7f04c3ad4675884c9c0836f2df24~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768478933&amp;x-signature=es6sF8ZO%2FB1Ndd1iixGv1G6wKDg%3D" alt="" loading="lazy"/></p>
<p>解决办法为修改<code>PROJ</code>的环境变量到<code>GDAL</code>支持的版本或者在<code>GDAL</code>程序开头添加以下代码：</p>
<pre><code class="hljs language-python" lang="python">os.environ[<span class="hljs-string">'PROJ_LIB'</span>] = <span class="hljs-string">r'D:\Programs\Python\Python311\Libsite-packages\osgeo\data\proj'</span>
</code></pre>
<p><strong>图片效果</strong></p>
<p><strong><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ee483022d85460798728b39b89153d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768478933&amp;x-signature=6Pm89gQSEJYcqEv0julAlsLpQLE%3D" alt="" loading="lazy"/></strong></p>
<p><strong><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/390cf8e21ea5449892bd4494678d4e2d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768478933&amp;x-signature=a4bstRlYfcWyFbDo0C%2BvumHUmcQ%3D" alt="" loading="lazy"/></strong></p>
<blockquote>
<p>❝</p>
<p>OpenLayers示例数据下载，请在公众号后台回复：<strong>ol数据</strong></p>
<p>全国信息化工程师－GIS 应用水平考试资料，请在公众号后台回复：<strong>GIS考试</strong></p>
</blockquote>
<blockquote>
<p>❝</p>
<p><em><strong>GIS之路</strong></em> 公众号已经接入了<strong>智能</strong> <strong>助手</strong>，可以在对话框进行提问，也可以直接搜索历史文章进行查看。</p>
</blockquote>
<p>都看到这了，不要忘记<em><strong>点赞、收藏</strong></em> <strong>+</strong> <em><strong>关注</strong></em> 哦 <strong>！</strong></p>
<p>本号不定时更新有关 <em><strong>GIS开发</strong></em> 相关内容，<em><strong>欢迎关注 <img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d87caa25e9c345b396ff0b80d4160150~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768478933&amp;x-signature=IfTgjHA1nMigzBkmeRlFJZsD6lE%3D" alt="" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ae768f241384749a6733f0e4c6636fc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768478933&amp;x-signature=dKBQ%2F%2F%2FqdXWcNci5dmixaVuqghk%3D" alt="" loading="lazy"/></strong></em></p>
<hr/>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac1f2a6a00f54d98b95e06c30e27c311~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768478933&amp;x-signature=sZ3MlNAMnmU8YtQlOP3C36cZaEg%3D" alt="" loading="lazy"/></p>
<p>   <img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a663e26fe71a49adba35d7b39b3c6f11~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768478933&amp;x-signature=K3Fywed5cUG7wOPMAh68C057Fzc%3D" alt="" loading="lazy"/> </p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwOTEzNjI5NQ%3D%3D%26mid%3D2247487953%26idx%3D1%26sn%3D0b2d5aeefdb290583cf8cdd82f3c2077%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwOTEzNjI5NQ==&amp;mid=2247487953&amp;idx=1&amp;sn=0b2d5aeefdb290583cf8cdd82f3c2077&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">GeoTools 开发合集（全）</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwOTEzNjI5NQ%3D%3D%26mid%3D2247487119%26idx%3D1%26sn%3Dc313efa84c27bf933ef2f2a47991ef2d%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwOTEzNjI5NQ==&amp;mid=2247487119&amp;idx=1&amp;sn=c313efa84c27bf933ef2f2a47991ef2d&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">OpenLayers 开发合集</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Ff1GPy_DNqtvEDzojlRmcBg" target="_blank" title="https://mp.weixin.qq.com/s/f1GPy_DNqtvEDzojlRmcBg" ref="nofollow noopener noreferrer">GDAL 实现数据空间查询</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FEyUADPYCf7O_9b0u8LUQCg" target="_blank" title="https://mp.weixin.qq.com/s/EyUADPYCf7O_9b0u8LUQCg" ref="nofollow noopener noreferrer">GDAL 实现数据属性查询</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FRdlldTRZ6c7FzfjBSdSPMg" target="_blank" title="https://mp.weixin.qq.com/s/RdlldTRZ6c7FzfjBSdSPMg" ref="nofollow noopener noreferrer">GDAL 实现创建几何对象</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FTUdUHgYra6oMlOaRIL1m4w" target="_blank" title="https://mp.weixin.qq.com/s/TUdUHgYra6oMlOaRIL1m4w" ref="nofollow noopener noreferrer">GDAL 实现自定义数据坐标系</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FPGxwhRbuiRUKIpT2D2cVGQ" target="_blank" title="https://mp.weixin.qq.com/s/PGxwhRbuiRUKIpT2D2cVGQ" ref="nofollow noopener noreferrer">GDAL 实现矢量数据读写</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fi77nCatd4V2nuybZFIs-xA" target="_blank" title="https://mp.weixin.qq.com/s/i77nCatd4V2nuybZFIs-xA" ref="nofollow noopener noreferrer">GDAL 数据类型大全</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F0DGoC0oFHizJbweBnEvI-g" target="_blank" title="https://mp.weixin.qq.com/s/0DGoC0oFHizJbweBnEvI-g" ref="nofollow noopener noreferrer">GDAL 实现 GIS 数据读取转换（全）</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hibernate（29）什么是Hibernate的连接池？]]></title>    <link>https://juejin.cn/post/7592865044690829318</link>    <guid>https://juejin.cn/post/7592865044690829318</guid>    <pubDate>2026-01-08T12:14:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592865044690829318" data-draft-id="7592856733182574628" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hibernate（29）什么是Hibernate的连接池？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-08T12:14:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hibernate（29）什么是Hibernate的连接池？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T12:14:49.000Z" title="Thu Jan 08 2026 12:14:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">Hibernate的连接池</h3>
<p>在数据库应用程序中，连接池（Connection Pool）是指一组预先建立的数据库连接，以供应用程序重复使用。连接池可以显著提高应用程序的性能，因为创建和关闭数据库连接是非常耗时的操作。通过使用连接池，可以减少连接的创建和关闭次数，从而提高效率。</p>
<p>Hibernate可以与多种连接池实现集成，包括C3P0、Apache DBCP、HikariCP等。每种连接池都有其特定的配置参数。</p>
<h3 data-id="heading-1">使用Hibernate配置连接池</h3>
<p>下面将详细介绍如何在Hibernate中配置C3P0连接池。</p>
<h3 data-id="heading-2">示例代码</h3>
<h4 data-id="heading-3">配置文件 <code>hibernate.cfg.xml</code></h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">hibernate-configuration</span> <span class="hljs-keyword">PUBLIC</span>
        <span class="hljs-string">"-//Hibernate/Hibernate Configuration DTD 3.0//EN"</span>
        <span class="hljs-string">"http://hibernate.sourceforge.net/hibernate-configuration-3.0.dtd"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">hibernate-configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">session-factory</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 数据库连接配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.driver_class"</span>&gt;</span>com.mysql.cj.jdbc.Driver<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.url"</span>&gt;</span>jdbc:mysql://localhost:3306/your_database<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.username"</span>&gt;</span>your_username<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.password"</span>&gt;</span>your_password<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- Hibernate 属性配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.dialect"</span>&gt;</span>org.hibernate.dialect.MySQLDialect<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.show_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.format_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.hbm2ddl.auto"</span>&gt;</span>update<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- C3P0 连接池配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.c3p0.min_size"</span>&gt;</span>5<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.c3p0.max_size"</span>&gt;</span>20<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.c3p0.timeout"</span>&gt;</span>300<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.c3p0.max_statements"</span>&gt;</span>50<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.c3p0.idle_test_period"</span>&gt;</span>3000<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 映射类 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.example.domain.Person"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.example.domain.Address"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">session-factory</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">hibernate-configuration</span>&gt;</span>
</code></pre>
<h3 data-id="heading-4">实体类示例</h3>
<p>以<code>Person</code>和<code>Address</code>为例，这些类与之前的示例相同。</p>
<h4 data-id="heading-5">Person类</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.domain;

<span class="hljs-keyword">import</span> javax.persistence.*;
<span class="hljs-keyword">import</span> java.util.HashSet;
<span class="hljs-keyword">import</span> java.util.Set;

<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "person")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {

    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-meta">@Column(name = "name")</span>
    <span class="hljs-keyword">private</span> String name;

    <span class="hljs-meta">@Column(name = "age")</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;

    <span class="hljs-meta">@OneToMany(mappedBy = "person", fetch = FetchType.LAZY, cascade = CascadeType.ALL)</span>
    <span class="hljs-keyword">private</span> Set&lt;Address&gt; addresses = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Person</span><span class="hljs-params">()</span> {}

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Person</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> age)</span> {
        <span class="hljs-built_in">this</span>.name = name;
        <span class="hljs-built_in">this</span>.age = age;
    }

    <span class="hljs-comment">// Getters 和 Setters</span>

    <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> id;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-built_in">this</span>.id = id;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> name;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-built_in">this</span>.name = name;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> age;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> {
        <span class="hljs-built_in">this</span>.age = age;
    }

    <span class="hljs-keyword">public</span> Set&lt;Address&gt; <span class="hljs-title function_">getAddresses</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> addresses;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAddresses</span><span class="hljs-params">(Set&lt;Address&gt; addresses)</span> {
        <span class="hljs-built_in">this</span>.addresses = addresses;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addAddress</span><span class="hljs-params">(Address address)</span> {
        addresses.add(address);
        address.setPerson(<span class="hljs-built_in">this</span>);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeAddress</span><span class="hljs-params">(Address address)</span> {
        addresses.remove(address);
        address.setPerson(<span class="hljs-literal">null</span>);
    }
}
</code></pre>
<h4 data-id="heading-6">Address类</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.domain;

<span class="hljs-keyword">import</span> javax.persistence.*;

<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "address")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Address</span> {

    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-meta">@Column(name = "street")</span>
    <span class="hljs-keyword">private</span> String street;

    <span class="hljs-meta">@ManyToOne</span>
    <span class="hljs-meta">@JoinColumn(name = "person_id", nullable = false)</span>
    <span class="hljs-keyword">private</span> Person person;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Address</span><span class="hljs-params">()</span> {}

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Address</span><span class="hljs-params">(String street, Person person)</span> {
        <span class="hljs-built_in">this</span>.street = street;
        <span class="hljs-built_in">this</span>.person = person;
    }

    <span class="hljs-comment">// Getters 和 Setters</span>

    <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> id;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-built_in">this</span>.id = id;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getStreet</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> street;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setStreet</span><span class="hljs-params">(String street)</span> {
        <span class="hljs-built_in">this</span>.street = street;
    }

    <span class="hljs-keyword">public</span> Person <span class="hljs-title function_">getPerson</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> person;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setPerson</span><span class="hljs-params">(Person person)</span> {
        <span class="hljs-built_in">this</span>.person = person;
    }
}
</code></pre>
<h4 data-id="heading-7">HibernateUtil类</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.cfg.Configuration;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateUtil</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> SessionFactory sessionFactory;

    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 从配置文件创建SessionFactory</span>
            sessionFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>().configure(<span class="hljs-string">"hibernate.cfg.xml"</span>).buildSessionFactory();
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            <span class="hljs-comment">// 记录启动失败的错误</span>
            System.err.println(<span class="hljs-string">"Initial SessionFactory creation failed."</span> + ex);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionInInitializerError</span>(ex);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title function_">getSessionFactory</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> sessionFactory;
    }
}
</code></pre>
<h3 data-id="heading-8">使用连接池的示例</h3>
<h4 data-id="heading-9">插入数据示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.Session;
<span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.Transaction;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateConnectionPoolExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 获取SessionFactory</span>
        <span class="hljs-type">SessionFactory</span> <span class="hljs-variable">sessionFactory</span> <span class="hljs-operator">=</span> HibernateUtil.getSessionFactory();

        <span class="hljs-comment">// 插入数据</span>
        insertSampleData(sessionFactory);

        <span class="hljs-comment">// 关闭SessionFactory</span>
        sessionFactory.close();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertSampleData</span><span class="hljs-params">(SessionFactory sessionFactory)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">"John Doe"</span>, <span class="hljs-number">30</span>);
            <span class="hljs-type">Address</span> <span class="hljs-variable">address1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Address</span>(<span class="hljs-string">"123 Street"</span>, person);
            <span class="hljs-type">Address</span> <span class="hljs-variable">address2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Address</span>(<span class="hljs-string">"456 Avenue"</span>, person);

            person.addAddress(address1);
            person.addAddress(address2);

            <span class="hljs-comment">// 保存Person对象时，级联保存Address对象</span>
            session.save(person);
            transaction.commit();
            System.out.println(<span class="hljs-string">"Inserted Person with Addresses"</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">if</span> (transaction != <span class="hljs-literal">null</span>) {
                transaction.rollback();
            }
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (session != <span class="hljs-literal">null</span>) {
                session.close();
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-10">连接池配置详细解释</h3>
<ol>
<li>
<p><strong>配置文件 <code>hibernate.cfg.xml</code></strong>：定义数据库连接信息、Hibernate属性配置以及实体类映射配置。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.driver_class"</span>&gt;</span>com.mysql.cj.jdbc.Driver<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.url"</span>&gt;</span>jdbc:mysql://localhost:3306/your_database<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.username"</span>&gt;</span>your_username<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.password"</span>&gt;</span>your_password<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.dialect"</span>&gt;</span>org.hibernate.dialect.MySQLDialect<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.show_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.format_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.hbm2ddl.auto"</span>&gt;</span>update<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

<span class="hljs-comment">&lt;!-- C3P0 连接池配置 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.c3p0.min_size"</span>&gt;</span>5<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.c3p0.max_size"</span>&gt;</span>20<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.c3p0.timeout"</span>&gt;</span>300<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.c3p0.max_statements"</span>&gt;</span>50<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.c3p0.idle_test_period"</span>&gt;</span>3000<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
</code></pre>
</li>
<li>
<p><strong>实体类 <code>Person</code> 和 <code>Address</code></strong>：定义实体类及其属性。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "person")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {
    <span class="hljs-comment">// 属性和方法</span>
}

<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "address")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Address</span> {
    <span class="hljs-comment">// 属性和方法</span>
}
</code></pre>
</li>
<li>
<p><strong>HibernateUtil类</strong>：创建并管理SessionFactory。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateUtil</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> SessionFactory sessionFactory;

    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 从配置文件创建SessionFactory</span>
            sessionFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>().configure(<span class="hljs-string">"hibernate.cfg.xml"</span>).buildSessionFactory();
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            <span class="hljs-comment">// 记录启动失败的错误</span>
            System.err.println(<span class="hljs-string">"Initial SessionFactory creation failed."</span> + ex);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionInInitializerError</span>(ex);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title function_">getSessionFactory</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> sessionFactory;
    }
}
</code></pre>
</li>
<li>
<p><strong>使用连接池示例</strong>：演示如何使用配置的连接池插入数据。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateConnectionPoolExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 获取SessionFactory</span>
        <span class="hljs-type">SessionFactory</span> <span class="hljs-variable">sessionFactory</span> <span class="hljs-operator">=</span> HibernateUtil.getSessionFactory();

        <span class="hljs-comment">// 插入数据</span>
        insertSampleData(sessionFactory);

        <span class="hljs-comment">// 关闭SessionFactory</span>
        sessionFactory.close();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertSampleData</span><span class="hljs-params">(SessionFactory sessionFactory)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        
</code></pre>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hibernate（30）Hibernate的Named Query是什么？]]></title>    <link>https://juejin.cn/post/7592815497847980095</link>    <guid>https://juejin.cn/post/7592815497847980095</guid>    <pubDate>2026-01-08T12:15:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592815497847980095" data-draft-id="7592815497847963711" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hibernate（30）Hibernate的Named Query是什么？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-08T12:15:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hibernate（30）Hibernate的Named Query是什么？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T12:15:43.000Z" title="Thu Jan 08 2026 12:15:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">Hibernate的Named Query</h3>
<p>Named Query（命名查询）是Hibernate提供的一种机制，允许开发者在实体类或映射文件中定义静态的SQL或HQL查询。命名查询的好处包括：</p>
<ul>
<li>代码复用：可以在多个地方使用相同的查询。</li>
<li>预编译：命名查询在应用启动时被预编译，运行时性能更好。</li>
<li>可维护性：查询逻辑分离，便于维护和管理。</li>
</ul>
<h3 data-id="heading-1">定义Named Query</h3>
<p>Named Query可以使用注解或XML配置来定义：</p>
<ol>
<li><strong>注解方式</strong>：
<ul>
<li>使用<code>@NamedQuery</code>和<code>@NamedQueries</code>注解。</li>
</ul>
</li>
<li><strong>XML配置方式</strong>：
<ul>
<li>在Hibernate的映射文件中使用<code>&lt;query&gt;</code>标签。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-2">示例代码</h3>
<h4 data-id="heading-3">使用注解定义Named Query</h4>
<h5 data-id="heading-4">实体类 <code>Person</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.domain;

<span class="hljs-keyword">import</span> javax.persistence.*;

<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "person")</span>
<span class="hljs-meta">@NamedQueries({
    @NamedQuery(
        name = "Person.findByName",
        query = "FROM Person WHERE name = :name"
    ),
    @NamedQuery(
        name = "Person.findAll",
        query = "FROM Person"
    )
})</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {

    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-meta">@Column(name = "name")</span>
    <span class="hljs-keyword">private</span> String name;

    <span class="hljs-meta">@Column(name = "age")</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Person</span><span class="hljs-params">()</span> {}

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Person</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> age)</span> {
        <span class="hljs-built_in">this</span>.name = name;
        <span class="hljs-built_in">this</span>.age = age;
    }

    <span class="hljs-comment">// Getters 和 Setters</span>

    <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> id;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-built_in">this</span>.id = id;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> name;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-built_in">this</span>.name = name;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> age;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> {
        <span class="hljs-built_in">this</span>.age = age;
    }
}
</code></pre>
<h4 data-id="heading-5">使用XML配置定义Named Query</h4>
<h5 data-id="heading-6">配置文件 <code>Person.hbm.xml</code></h5>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">hibernate-mapping</span> <span class="hljs-keyword">PUBLIC</span>
        <span class="hljs-string">"-//Hibernate/Hibernate Mapping DTD 3.0//EN"</span>
        <span class="hljs-string">"http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">hibernate-mapping</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">class</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"com.example.domain.Person"</span> <span class="hljs-attr">table</span>=<span class="hljs-string">"person"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"id"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">generator</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"identity"</span>/&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"name"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"name"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"age"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"age"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">class</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Named Queries --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">query</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"Person.findByName"</span>&gt;</span>
        &lt;![CDATA[
            FROM Person WHERE name = :name
        ]]&gt;
    <span class="hljs-tag">&lt;/<span class="hljs-name">query</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">query</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"Person.findAll"</span>&gt;</span>
        &lt;![CDATA[
            FROM Person
        ]]&gt;
    <span class="hljs-tag">&lt;/<span class="hljs-name">query</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">hibernate-mapping</span>&gt;</span>
</code></pre>
<h4 data-id="heading-7">使用Named Query示例</h4>
<h5 data-id="heading-8">HibernateUtil类</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.cfg.Configuration;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateUtil</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> SessionFactory sessionFactory;

    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 从配置文件创建SessionFactory</span>
            sessionFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>().configure(<span class="hljs-string">"hibernate.cfg.xml"</span>).buildSessionFactory();
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            <span class="hljs-comment">// 记录启动失败的错误</span>
            System.err.println(<span class="hljs-string">"Initial SessionFactory creation failed."</span> + ex);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionInInitializerError</span>(ex);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title function_">getSessionFactory</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> sessionFactory;
    }
}
</code></pre>
<h5 data-id="heading-9">查询示例</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.Session;
<span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.Transaction;
<span class="hljs-keyword">import</span> org.hibernate.query.Query;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateNamedQueryExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 获取SessionFactory</span>
        <span class="hljs-type">SessionFactory</span> <span class="hljs-variable">sessionFactory</span> <span class="hljs-operator">=</span> HibernateUtil.getSessionFactory();

        <span class="hljs-comment">// 插入示例数据</span>
        insertSampleData(sessionFactory);

        <span class="hljs-comment">// 使用Named Query查询数据</span>
        queryByName(sessionFactory, <span class="hljs-string">"John Doe"</span>);
        queryAll(sessionFactory);

        <span class="hljs-comment">// 关闭SessionFactory</span>
        sessionFactory.close();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertSampleData</span><span class="hljs-params">(SessionFactory sessionFactory)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Person</span> <span class="hljs-variable">person1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">"John Doe"</span>, <span class="hljs-number">30</span>);
            <span class="hljs-type">Person</span> <span class="hljs-variable">person2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">"Jane Doe"</span>, <span class="hljs-number">28</span>);

            session.save(person1);
            session.save(person2);
            transaction.commit();
            System.out.println(<span class="hljs-string">"Inserted sample data"</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">if</span> (transaction != <span class="hljs-literal">null</span>) {
                transaction.rollback();
            }
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (session != <span class="hljs-literal">null</span>) {
                session.close();
            }
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">queryByName</span><span class="hljs-params">(SessionFactory sessionFactory, String name)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-keyword">try</span> {
            Query&lt;Person&gt; query = session.createNamedQuery(<span class="hljs-string">"Person.findByName"</span>, Person.class);
            query.setParameter(<span class="hljs-string">"name"</span>, name);
            List&lt;Person&gt; persons = query.getResultList();
            System.out.println(<span class="hljs-string">"Query by name ("</span> + name + <span class="hljs-string">"):"</span>);
            <span class="hljs-keyword">for</span> (Person person : persons) {
                System.out.println(person.getName() + <span class="hljs-string">" - "</span> + person.getAge());
            }
        } <span class="hljs-keyword">catch</span> (Exception e) {
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (session != <span class="hljs-literal">null</span>) {
                session.close();
            }
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">queryAll</span><span class="hljs-params">(SessionFactory sessionFactory)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-keyword">try</span> {
            Query&lt;Person&gt; query = session.createNamedQuery(<span class="hljs-string">"Person.findAll"</span>, Person.class);
            List&lt;Person&gt; persons = query.getResultList();
            System.out.println(<span class="hljs-string">"Query all persons:"</span>);
            <span class="hljs-keyword">for</span> (Person person : persons) {
                System.out.println(person.getName() + <span class="hljs-string">" - "</span> + person.getAge());
            }
        } <span class="hljs-keyword">catch</span> (Exception e) {
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (session != <span class="hljs-literal">null</span>) {
                session.close();
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-10">Named Query详细解释</h3>
<ol>
<li>
<p><strong>注解方式定义Named Query</strong>：在<code>Person</code>实体类上使用<code>@NamedQuery</code>和<code>@NamedQueries</code>注解定义查询。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@NamedQueries({
    @NamedQuery(
        name = "Person.findByName",
        query = "FROM Person WHERE name = :name"
    ),
    @NamedQuery(
        name = "Person.findAll",
        query = "FROM Person"
    )
})</span>
</code></pre>
</li>
<li>
<p><strong>XML配置方式定义Named Query</strong>：在<code>Person.hbm.xml</code>中使用<code>&lt;query&gt;</code>标签定义查询。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">query</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"Person.findByName"</span>&gt;</span>
    &lt;![CDATA[
        FROM Person WHERE name = :name
    ]]&gt;
<span class="hljs-tag">&lt;/<span class="hljs-name">query</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">query</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"Person.findAll"</span>&gt;</span>
    &lt;![CDATA[
        FROM Person
    ]]&gt;
<span class="hljs-tag">&lt;/<span class="hljs-name">query</span>&gt;</span>
</code></pre>
</li>
<li>
<p><strong>HibernateUtil类</strong>：创建并管理SessionFactory。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateUtil</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> SessionFactory sessionFactory;

    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 从配置文件创建SessionFactory</span>
            sessionFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>().configure(<span class="hljs-string">"hibernate.cfg.xml"</span>).buildSessionFactory();
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            <span class="hljs-comment">// 记录启动失败的错误</span>
            System.err.println(<span class="hljs-string">"Initial SessionFactory creation failed."</span> + ex);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionInInitializerError</span>(ex);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title function_">getSessionFactory</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> sessionFactory;
    }
}
</code></pre>
</li>
<li>
<p><strong>使用Named Query示例</strong>：演示如何使用Named Query进行查询。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateNamedQueryExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 获取SessionFactory</span>
        <span class="hljs-type">SessionFactory</span> <span class="hljs-variable">sessionFactory</span> <span class="hljs-operator">=</span> HibernateUtil.getSessionFactory();

        <span class="hljs-comment">// 插入示例数据</span>
        insertSampleData(sessionFactory);

        <span class="hljs-comment">// 使用Named Query查询数据</span>
        queryByName(sessionFactory, <span class="hljs-string">"John Doe"</span>);
        queryAll(sessionFactory);

        <span class="hljs-comment">// 关闭SessionFactory</span>
        sessionFactory.close();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertSampleData</span><span class="hljs-params">(SessionFactory sessionFactory)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Person</span> <span class="hljs-variable">person1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">"John Doe"</span>, <span class="hljs-number">30</span>);
            <span class="hljs-type">Person</span> <span class="hljs-variable">person2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">"Jane Doe"</span>, <span class="hljs-number">28</span>);

            session.save(person1);
            session.save(person2);
            transaction.commit();
            System.out.println(<span class="hljs-string">"Inserted sample data"</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">if</span> (transaction != <span class="hljs-literal">null</span>) {
                transaction.rollback();
            }
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (session != <span class="hljs-literal">null</span>) {
                session.close();
            }
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">queryByName</span><span class="hljs-params">(SessionFactory sessionFactory, String name)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-keyword">try</span> {
            Query&lt;Person&gt; query = session.createNamedQuery(<span class="hljs-string">"Person.findByName"</span>, Person.class);
            query.setParameter(<span class="hljs-string">"name"</span>, name);
            List&lt;Person&gt; persons = query.getResultList();
            System.out.println(<span class="hljs-string">"Query by name ("</span> + name + <span class="hljs-string">"):"</span>);
            <span class="hljs-keyword">for</span> (Person person : persons) {
                System.out.println(person.getName() + <span class="hljs-string">" - "</span> + person.getAge());
            }
        } <span class="hljs-keyword">catch</span> (Exception e) {
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (session != <span class="hljs-literal">null</span>) {
                session.close();
            }
        }
    }

</code></pre>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么不建议基于Multi-Agent来构建Agent工程？]]></title>    <link>https://juejin.cn/post/7592822714067877939</link>    <guid>https://juejin.cn/post/7592822714067877939</guid>    <pubDate>2026-01-08T12:20:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592822714067877939" data-draft-id="7592816646870597641" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么不建议基于Multi-Agent来构建Agent工程？"/> <meta itemprop="keywords" content="Agent,后端,人工智能"/> <meta itemprop="datePublished" content="2026-01-08T12:20:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序新视界"/> <meta itemprop="url" content="https://juejin.cn/user/3368559359568696"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么不建议基于Multi-Agent来构建Agent工程？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3368559359568696/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序新视界
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T12:20:46.000Z" title="Thu Jan 08 2026 12:20:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>在LLM涌现的早期已经有大量的研发人员开始思考、讨论和推广Multi-Agent的概念。它的基本实现逻辑就是：利用LLLM的归纳推理能力，通过为不同的Agent分配角色与任务，并配合相应的工具（tools）插件来完成复杂的任务。</p>
<p>但经过这两三年的发展，关于Multi-Agent的讨论依旧存在截然不同的观点，真实案例更寥寥可数，也没有形成标准的行业范式。在Manus内部人员的访谈记录中，也坦言，在Manus的功能实现中并没有使用复杂的Multi-Agent工程。</p>
<p>在本人主导开发的AI原生项目中，使用了大量的基于LLM的Workflow能力，但对于Multi-Agent也是望而却步，因为实践的结果与预期的差距太大。</p>
<p>这篇文章结合国外一篇关于Multi-Agent观念，一起聊聊对于Multi-Agent的观点和看法。</p>
<h2 data-id="heading-1">Agent时代的现状</h2>
<p>随着LLM的快速突破，目前算是正式进入了LLM和AI Agent时代的早期。这个时期可以用Web开发来进行类比，就相当于正处于使用原始的HTML &amp; CSS来开发网页的时代。至于像Web开发后面的React（及其衍生框架）以及相关的脚手架、构建模式以及开发哲学等，都还处于大众探索创新的阶段。</p>
<p>目前对于LLM和AI Agent的使用，大家都是在一边摸索一边前行，比如探索如何把这些功能拼到一起，如何提供良好的体验，如何保证系统的鲁棒性等。除了几种最基础的方式之外，还没有哪一种Agent构建方法成为主流标准。</p>
<p>即便是OpenAI的Swarm类库和微软的Autogen类库中推崇的一些概念，也没有得到普遍的认可，甚至是错误的Agent构建方法。</p>
<p>当进行Agent构建时，市面上已经有不少基础的脚手架项目，但真正拿它们来运用到生产项目中，还是有很长的距离。</p>
<h2 data-id="heading-2">长时运行Agent的构建理论</h2>
<p>长时运行Agent（Long-running Agents），通常是指AI能够跨多个会话、多次工具调用和多阶段产物，来完成一个目标。长时运行Agent更强调大模型的自治以及动态上下文的管理，需要AI Agent能够支持长时间的运行来解决问题，同时，还需要更好的自主规划与调度能力，选择行使用上下文的能力等。</p>
<p>另外，一个很重要的指标就是可靠性，Agent想要真正的可靠、长时间运行、以及保持连贯对话，就必须做一些额外的事来控制错误的累积。否则，一个小的错误，在后续步骤中放大，形成错误链，造成整个Agent工程的不可控。而可靠性的核心保障就是“上下文工程”。</p>
<h2 data-id="heading-3">上下文工程</h2>
<p>截至目前，市面上的大模型已经非常智能了，但就算最聪明的人，没有了解清楚自己被要求做什么的上下文，也无法高效工作。</p>
<p>“Prompt engineering”曾是LLM聊天机器人需要将任务以理想格式表达时的产物，而“上下文工程”则是下一个阶段。它的意义，是要在动态系统中自动完成这件事。这更微妙，基本上也是Agent工程师的首要工作。</p>
<p>举个常见的Agent例子：</p>
<ul>
<li>把自己的任务分解成几个部分；</li>
<li>启动子Agent处理这些部分；</li>
<li>最后把各部分结果合并起来</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6a1ad35358c40ce8240e8d82f3db95e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5paw6KeG55WM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768479646&amp;x-signature=bAsrlBeZRe8YpP6GFN8RYgAKouE%3D" alt="图1" loading="lazy"/></p>
<p>这种架构很有诱惑力，特别是在处理多个并行组件的任务时。不过，这种架构也非常脆弱，它的核心问题是：</p>
<p>假设所需的任务是“做一个Flappy Bird的克隆版”。任务会被拆分为两个子任务：子任务一是“做一个有绿色管道和碰撞盒的移动游戏背景”，子任务二是“做一个能上下移动的小鸟”。</p>
<p>结果，Subagent1 搞错了子任务，做出了一个看起来像超级马里奥兄弟的背景。Subagent2 实现了小鸟，但它既不像游戏素材，也没有 Flappy Bird 的移动方式。现在最终的 Agent 只能把这两个误解的结果拼到一起，变成一个尴尬的合成品。</p>
<p>也许这个例子有点生硬，但现实中的任务往往有许多细微层面，每一层都有可能被误解。</p>
<p>你可能会认为，简单的办法就是把原始任务内容也复制给Subagent作为上下文，这样它们就不会误解自己的子任务了。但别忘了，在实际生产系统中，Agent 往往涉及多轮对话，经常需要调用工具来决定如何拆解任务，很多细节都会影响对任务的解读。</p>
<p><strong>原则一：共享上下文，并且共享完整的Agent轨迹（trace），而不仅仅是单独的信息文本。</strong></p>
<p>现在对Agent架构进行下一步改进，这次要确保每个Agent都能获得前面Agent的完整上下文。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8458c5d65d254ba684756f9aba6b302d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5paw6KeG55WM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768479646&amp;x-signature=mq2Hqb%2BIbQHFaVcTVm5wvWIRacU%3D" alt="图2" loading="lazy"/></p>
<p>很遗憾，事情还没那么简单。当再次给Agent提出Flappy Bird的克隆任务时，最终可能得到的是一只小鸟和一个背景，但它们的视觉风格完全不同。Subagent1 和Subagent2 并不知道对方在做什么，所以各自完成的部分根本不统一。</p>
<p>Subagent1和Subagent2所采取的动作，都是基于各自不同且事先未明确规定的假设。</p>
<p><strong>原则二：动作会带来隐含的决策，而冲突的决策会带来糟糕的结果。</strong></p>
<p>原则一和原则二非常关键，几乎没有违背它们的理由，所以默认就应该排除任何不遵守这两个原则的Agent架构。也许你觉得这样有些局限，但其实还有很多可以探索的不同架构方式。</p>
<p>遵循这些原则最简单的方法，就是采用单线程、线性式的Agent：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0bcf628fec56415b8f3dc3165887f3b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5paw6KeG55WM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768479646&amp;x-signature=JtEoAY6kHx232gNlAU7CyHgqqlU%3D" alt="图3" loading="lazy"/></p>
<p>在这种架构下，上下文是连续的。不过，如果任务非常庞大、包含大量子任务，可能会遇到上下文窗口溢出的情况。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8740fb520974bd9a8bb5bf25a066a84~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5paw6KeG55WM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768479646&amp;x-signature=uNjhfARtBne2RX0qE2QSBbtqGt8%3D" alt="图4" loading="lazy"/></p>
<p>这种简单的架构已经能应对绝大多数场景，但如果你的任务真的需要长时间运行，并且你愿意投入更多精力，其实还可以做得更好。</p>
<p>比如：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5bb2aa9ec5994d66a024fe8b0ff1f408~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5paw6KeG55WM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768479646&amp;x-signature=sZ6PTxoj6SNtRlnVQGwtDiFmFB0%3D" alt="图5" loading="lazy"/></p>
<p>在这个架构中，引入了一个新的 LLM 模型，其核心作用是将一系列的动作和对话历史压缩成关键细节、事件和决策。</p>
<p>这其实很难做好，需要投入精力搞清楚哪些才是真正重要的信息，并搭建一个模型擅长识别这些内容的系统。根据不同领域，甚至可能需要微调一个更小的模型。</p>
<p>这样做的好处是，可以让Agent在更长的上下文中仍然高效工作。当然，最终还是会遇到上下文长度的极限。</p>
<h2 data-id="heading-4">原则的应用案例</h2>
<p>作为Agent的开发者，要确保Agent的每一步操作都参考了系统其它部分已经做出的所有相关决策的上下文。理想情况下，每个动作都能“看到”其它所有动作的信息。</p>
<p>可惜，受限于上下文窗口和实际工程权衡，这往往做不到，需要结合可靠性目标，决定Agent能接受多复杂的架构。</p>
<p>在思考如何架构Agent、避免冲突决策时，这里有一些真实案例可以参考：</p>
<h3 data-id="heading-5">Claude Code 子Agent</h3>
<p>Claude Code是一个能够生成子任务的 Agent 示例。不过，它不会跟子Agent并行做事，而且子Agent通常只是被要求回答一个问题，不会去写任何代码。</p>
<p>为什么？因为子Agent缺少主Agent的上下文，除了回答那些定义非常清晰的问题，其他任务就无法做。而如果让多个并行的子Agent协作，结果可能互相冲突，导致在Agent架构上遇到之前说的可靠性问题。</p>
<p>在Claude Code的设计里，子Agent的全部调研工作不需要留在主Agent的历史记录中，这样可以更长时间保留上下文。设计者刻意采用了简化方案。</p>
<h3 data-id="heading-6">Edit Apply 模型</h3>
<p>2024年，许多模型在编辑代码上的表现非常差。很多Coding Agent、IDE、App Builder 等（包括 Devin），都采用了“edit apply model”（编辑应用模型）。</p>
<p>核心思路是，与其让大模型输出格式正确的diff，不如让小模型根据Markdown格式的编辑说明重写整个文件来得可靠。</p>
<p>所以实际操作中，开发者让大模型输出Markdown说明代码改动，然后把这些说明交给小模型来重写文件。但这种系统仍然容易出错。比如，小模型可能会错误理解大模型的指令，只要指令中稍有歧义，就会导致错误编辑。现在，代码编辑和应用更多是由一个模型一步完成。</p>
<h3 data-id="heading-7">多 Agent 协作</h3>
<p>如果真要让系统并行处理任务，你可能也会想到让决策者之间“互相沟通”共同解决问题。</p>
<p>这也是人类遇到分歧（理想情况下）会做的事。如果工程师 A 的代码与工程师 B 的代码发生合并冲突，标准流程就是大家相互交流，达成一致。但时至今日，AI Agent之间尚不具备像人一样，能在超长上下文下高可靠性地主动沟通。</p>
<p>自从ChatGPT推出后，大家一直在探索多 Agent 交互协作来解决问题。从长期来看，Agent协作的长期很乐观，但目前多Agent协作系统还是非常脆弱。还存在决策太分散，Agent之间上下文也无法充分共享等问题。</p>
<p>当然，未来单线程Agent和人类沟通越来越顺畅后，这个难题自然而然就会解决。那时候会彻底释放更高并行度和效率。</p>
<h2 data-id="heading-8">小结</h2>
<p>这些关于上下文工程的观察和讨论，只是未来成为Agent构建标准原则的一个起点。实际上还有很多各种挑战和技术没讨论。同时，Agent构建也是非常重要的前沿方向。</p>
<p>我们在实践中，可以利用本文提到的一些原则和解决方案，指导内部工具和框架的开发，通过实践和总结来不断完善Agent工程的落地。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[征程 6 | cgroup sample]]></title>    <link>https://juejin.cn/post/7592622563547004963</link>    <guid>https://juejin.cn/post/7592622563547004963</guid>    <pubDate>2026-01-08T12:24:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592622563547004963" data-draft-id="7592637149697572899" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="征程 6 | cgroup sample"/> <meta itemprop="keywords" content="自动驾驶,算法"/> <meta itemprop="datePublished" content="2026-01-08T12:24:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="地平线开发者"/> <meta itemprop="url" content="https://juejin.cn/user/1257497032132567"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            征程 6 | cgroup sample
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1257497032132567/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    地平线开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T12:24:38.000Z" title="Thu Jan 08 2026 12:24:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 功能概述</h2>
<p>本 sample 实现限制进程 cpu 占用率和运行的 cpu 核功能，此处主要介绍该 sample 的实现与使用方法。</p>
<h3 data-id="heading-1">1.1. 软件架构说明</h3>
<p>本 sample 基于 Linux 通用的 cgroup API，通过操作 cgroup 的 cpu 子系统和 cpuset 子系统配置文件，来限制 sample 进程的 cpu 占用率和运行的 cpu 核。</p>
<p><img src="https://mcnsakkce4vm.feishu.cn/space/api/box/stream/download/asynccode/?code=NWFiMWM1MmNjMzAyN2Q0MmUyNzYzNDkzZjQ5ODUxZGVfRTV0M014ZjFKd0JIY1ZVMDlNVGJsQnZLYm8yV3lGR3JfVG9rZW46UmozYmI1MGJib1lDa0p4ZjRwamNpMlI3bjdjXzE3Njc4NzQ1ODA6MTc2Nzg3ODE4MF9WNA" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">1.2. 代码位置与目录结构</h3>
<p>本 sample 代码位置和目录结构如下：</p>
<p>代码位置如下：</p>
<pre><code class="hljs language-markdown" lang="markdown">{sdk<span class="hljs-emphasis">_dir}/test/samples/platform_</span>samples/source/S83<span class="hljs-emphasis">_Sample/S83E03_</span>BaseService/cgroup<span class="hljs-emphasis">_sample
</span></code></pre>
<p>目录结构如下：</p>
<pre><code class="hljs language-markdown" lang="markdown">├── Kconfig
├── Makefile
├── Makefile.in
└── src
<span class="hljs-code">    ├── cgroup_sample.c
    └── Makefile
</span></code></pre>
<h3 data-id="heading-3">1.3. API 流程说明</h3>
<p>以下为 sample 内 API 调用流程图：</p>
<p><img src="https://mcnsakkce4vm.feishu.cn/space/api/box/stream/download/asynccode/?code=NDE1MmJkYjYxOWZjYzZmYTI4ODNiNDViNmMwMDlhNDlfNGF5YUZ0OWxlbG1XeEx5cEVESVRhR2h0Szd0UVF1QU5fVG9rZW46R1dncmJLNGFWbzVpSzN4VXBtN2NhcDEybjdiXzE3Njc4NzQ1ODA6MTc2Nzg3ODE4MF9WNA" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">2. 编译</h2>
<h3 data-id="heading-5">2.1. 编译环境</h3>
<p>本 sample 的编译环境使用 SDK 中的 build 工具，请参考： <a href="https://link.juejin.cn?target=http%3A%2F%2F10.106.32.73%2Fdoc%2FLNX-PL4.0-WB-20250724-J6P%2Fcn%2Fhtml%2Fj6_sysdev%2Fbuild%2Fj6_sysdev_build.html%23id1" target="_blank" title="http://10.106.32.73/doc/LNX-PL4.0-WB-20250724-J6P/cn/html/j6_sysdev/build/j6_sysdev_build.html#id1" ref="nofollow noopener noreferrer">Build 环境建立</a>。</p>
<h3 data-id="heading-6">2.2. 编译说明</h3>
<p>本 sample 的编译依赖封装 Linux cgroup API 链接库 libhbcgroup 提供的头文件：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section">#include "hb<span class="hljs-emphasis">_cgroup.h"
</span></span></code></pre>
<p>编译依赖的库为：</p>
<pre><code class="hljs language-markdown" lang="markdown">LIBS += -lhbcgroup
</code></pre>
<p>编译命令：</p>
<pre><code class="hljs language-markdown" lang="markdown">进入SDK所有目录{sdk<span class="hljs-emphasis">_dir}，并source构建环境（参见上文：编译环境）。# 编译本sample:
bdm cgroup_</span>sample
<span class="hljs-section"># 输出路径:{sdk<span class="hljs-emphasis">_dir}/out/debug-gcc_</span>{gcc<span class="hljs-emphasis">_version}/build/test/samples/platform_</span>samples/source/S83<span class="hljs-emphasis">_Sample/S83E03_</span>BaseService/cgroup<span class="hljs-emphasis">_sample
</span></span></code></pre>
<h2 data-id="heading-7">3. 运行</h2>
<h3 data-id="heading-8">3.1. 支持平台</h3>
<p>征程 6X Matrix</p>
<h3 data-id="heading-9">3.2. 板端部署及配置</h3>
<p>本 sample 的可执行文件位于板端如下路径：</p>
<pre><code class="hljs language-markdown" lang="markdown">/app/sample/S83<span class="hljs-emphasis">_Sample/S83E03_</span>BaseService/cgroup<span class="hljs-emphasis">_sample/bin/cgroup_</span>sample
</code></pre>
<h3 data-id="heading-10">3.3. 运行指南</h3>
<h4 data-id="heading-11">3.3.1. <strong>运行参数说明</strong></h4>
<p>下面的表格是 cgroup_sample 具体参数的说明：</p>
<p>如果-c 和-C 都不选择，则不会限制 cgroup_sample 进程的 cpu 占用率和运行的 cpu 核。</p>
<h4 data-id="heading-12">3.3.2. <strong>帮助菜单</strong></h4>
<pre><code class="hljs language-markdown" lang="markdown">Usage: cgroup<span class="hljs-emphasis">_sample [OPTION]

-c  Limit cpu occupancy rate, 1 ~ 100.
-C  Limit cpu core.
-t  Delay time, 1's default.
-h  Show usage.

Without options, do nothing.
</span></code></pre>
<h4 data-id="heading-13">3.3.3. <strong>运行方法</strong></h4>
<p>执行命令示例：</p>
<p>限制 cgroup_sample 进程的 cpu 占用率为 20%：</p>
<pre><code class="hljs language-markdown" lang="markdown">/app/sample/S83<span class="hljs-emphasis">_Sample/S83E03_</span>BaseService/cgroup<span class="hljs-emphasis">_sample/bin/cgroup_</span>sample -c 20
</code></pre>
<p>限制 cgroup_sample 进程只运行在 cpu 核 2：</p>
<pre><code class="hljs language-markdown" lang="markdown">/app/sample/S83<span class="hljs-emphasis">_Sample/S83E03_</span>BaseService/cgroup<span class="hljs-emphasis">_sample/bin/cgroup_</span>sample -C 2
</code></pre>
<p>限制 cgroup_sample 进程运行在 cpu 核 1，4：</p>
<pre><code class="hljs language-markdown" lang="markdown">/app/sample/S83<span class="hljs-emphasis">_Sample/S83E03_</span>BaseService/cgroup<span class="hljs-emphasis">_sample/bin/cgroup_</span>sample -C 1,4
</code></pre>
<h4 data-id="heading-14">3.3.4. <strong>运行结果说明</strong></h4>
<p>运行本 sample 后，可通过 top 命令验证本 sample 进程的 cpu 占用率和运行的 cpu 核。</p>
<p><strong>运行结果 1</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">root@hobot:~# /app/sample/S83<span class="hljs-emphasis">_Sample/S83E03_</span>BaseService/cgroup<span class="hljs-emphasis">_sample/bin/cgroup_</span>sample -c 20 -C 2 -t 20 &amp;[1] 1514
</code></pre>
<p><img src="https://mcnsakkce4vm.feishu.cn/space/api/box/stream/download/asynccode/?code=NzIyODNhZjNmZTkxZDZlYmRhNjZiMWI5Mjg5MzdmMDZfbTgycU9heVQ5aWdHM002Z3ltQUxXaXk1c0NDNnFFUmxfVG9rZW46UGM5RGJkcERsbzRTdFd4ZnFtUmNQS0RYblZoXzE3Njc4NzQ1ODA6MTc2Nzg3ODE4MF9WNA" alt="" loading="lazy"/></p>
<p><strong>运行结果 2</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">root@hobot:~# /app/sample/S83<span class="hljs-emphasis">_Sample/S83E03_</span>BaseService/cgroup<span class="hljs-emphasis">_sample/bin/cgroup_</span>sample -c 20 -C 1,4 -t 20 &amp;[1] 1522
</code></pre>
<p><img src="https://mcnsakkce4vm.feishu.cn/space/api/box/stream/download/asynccode/?code=MGUwY2MzNjE1MjQ0OTc0YjUxMDg2YmNiOWQ5YjFmYjRfVVdVd09oMXkxRDl4MlpQb2FhTjVPU1pUVjB3NUVqTWJfVG9rZW46SExTRWJqSkxQb0RoVlR4WTZiU2NMTnlibnBoXzE3Njc4NzQ1ODA6MTc2Nzg3ODE4MF9WNA" alt="" loading="lazy"/></p>
<p><strong>特别说明</strong></p>
<p>查看 cpu 核，在执行 top 命令后，需进行如下操作：</p>
<ol>
<li>按 f 键，弹出管理窗口；</li>
<li>按上下键选择下图指示的属性 P；</li>
<li>按空格键选中该属性（选中后会高亮）；</li>
<li>按 q 键退出；</li>
</ol>
<p>即可显示进程运行的 cpu 核。</p>
<p><img src="https://mcnsakkce4vm.feishu.cn/space/api/box/stream/download/asynccode/?code=MWEzYmUzNGEwZDFiOGNmODA1ZjBhZTEzM2RmMTg0NmFfWWIzNk1CR0JHNVAxT0RYOEtSUWdsTGdybGxrbnlJeFdfVG9rZW46VzRIcWIzWGJIb2l6YlN4bGxESWNURXNhbmxiXzE3Njc4NzQ1ODA6MTc2Nzg3ODE4MF9WNA" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从一道前端面试题，谈 JS 对象存储特点和运算符执行顺序]]></title>    <link>https://juejin.cn/post/7592637149697622051</link>    <guid>https://juejin.cn/post/7592637149697622051</guid>    <pubDate>2026-01-08T12:44:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592637149697622051" data-draft-id="7592856733182607396" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从一道前端面试题，谈 JS 对象存储特点和运算符执行顺序"/> <meta itemprop="keywords" content="前端,面试,JavaScript"/> <meta itemprop="datePublished" content="2026-01-08T12:44:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员小寒"/> <meta itemprop="url" content="https://juejin.cn/user/694547078987287"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从一道前端面试题，谈 JS 对象存储特点和运算符执行顺序
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547078987287/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员小寒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T12:44:56.000Z" title="Thu Jan 08 2026 12:44:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">本文大纲</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b632613fda249f58d35395df0e16d89~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP5a-S:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768481095&amp;x-signature=igCEr5sAjtarjWf%2Fc60OP%2BOWCWo%3D" alt="" loading="lazy"/></p>
<p>今天来看一道前端面试的代码输出题。</p>
<p>面试官提供了一段 <code>Javascript</code> 代码，要求给出这段代码运行后的输出结果。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> obj = {
  <span class="hljs-attr">a</span>: <span class="hljs-number">0</span>,
};

obj[<span class="hljs-string">'1'</span>] = <span class="hljs-number">0</span>;
obj[++obj.<span class="hljs-property">a</span>] = obj.<span class="hljs-property">a</span>++;
<span class="hljs-keyword">const</span> values = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">values</span>(obj);
obj[values[<span class="hljs-number">1</span>]] = obj.<span class="hljs-property">a</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj);

</code></pre>
<p>先分析这道题前，先补充两个个前置知识点。</p>
<h2 data-id="heading-1">知识点一：对象的常规属性 (properties) 和排序属性 (elements)</h2>
<p>先来看下面一段代码：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> obj = {};
obj[<span class="hljs-string">'b'</span>] = <span class="hljs-string">'b'</span>
obj[<span class="hljs-number">100</span>] = <span class="hljs-string">'100'</span>;
obj[<span class="hljs-number">1</span>] = <span class="hljs-string">'1'</span>;
obj[<span class="hljs-string">'a'</span>] = <span class="hljs-string">'a'</span>;
obj[<span class="hljs-number">50</span>] = <span class="hljs-string">'50'</span>;
obj[<span class="hljs-string">'c'</span>] = <span class="hljs-string">'c'</span>;

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> obj){ 
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`key: <span class="hljs-subst">${key}</span> value: <span class="hljs-subst">${obj[key]}</span>`</span>)
}
<span class="hljs-comment">/**
 * 打印结果如下：
  key: 1 value: 1
  key: 50 value: 50
  key: 100 value: 100
  key: b value: b
  key: a value: a
  key: c value: c
 */</span>
</code></pre>
<p>观察下打印的数据，很明显属性的设置顺序并不是打印的顺序，比如 <code>b</code> 属性是第一个设置的，打印结果却排在 <code>100</code> 后面，仔细分析他们的打印规律，可以得到如下特点：</p>
<ol>
<li>数字类的属性不管设置的顺序先后，都会被优先打印，而且是按照从小到大的升序进行打印的。</li>
<li>字符类属性会按照设置的顺序进行打印，上面我们是按照 <code>b</code>、<code>a</code>、<code>c</code> 的顺序进行设置的，打印顺序也是如此。</li>
</ol>
<p>为什么会出现这样的结果呢？</p>
<p>这是因为 ECMAScript 规范中定义了<strong>数字属性应该按照索引值大小升序排列，字符串属性根据创建时的顺序升序排列</strong>。在 <code>V8</code> 中数字属性被称为 <code>elements</code>，字符串属性被称为 <code>properties</code>。之所以这样设置，主要是为了提升访问性能。<code>elements</code> 对象中会按照顺序存放数字属性，类似于数组的存储，这样查询的效率当然就很高了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d5555d23ce9e4f25b2ff5ecbb936bdb9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP5a-S:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768481095&amp;x-signature=%2BDV%2Btev3fVwCcpimN5bLZ7u0834%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">知识点二：JavaScript 运算符的执行顺序</h2>
<p><code>JavaScript</code> 中最常见运算符如下（<strong>运算顺序从高到低排列</strong>）：</p>
<ul>
<li>对象属性访问，比如 <code>obj.a</code>，<code>obj['a']</code>。</li>
<li>递增/递减，比如 <code>a++</code>(后置递增) 或 <code>++a</code>（前置递增）。</li>
<li>算术，比如 <code>a + 1</code>。</li>
<li>比较，包括 <code>&lt;</code>(小于)、<code>&gt;</code>(大于)、<code>&lt;=</code>(小于等于)、<code>&gt;=</code>(大于等于)，比如 <code>a &gt; 3</code>。</li>
<li>相等，包括 <code>==</code> 粗略相等， <code>===</code>严格相等，<code>!==</code> 粗略不等，<code>!==</code> 严格不等，比如 <code>a == 1</code>。</li>
<li>逻辑，也就是与或非，<code>&amp;</code>(与)、<code>|</code>(或)、<code>!</code>(非)，比如 <code>a &amp;&amp; b</code>。</li>
<li>三元，比如 <code>flag ? '1' : '0'</code>。</li>
<li>赋值，比如 <code>a = 1</code>。</li>
</ul>
<p>对于单个赋值语句 <code>LHS = RHS</code> 的求值，根据 <code>ECMAScript</code> 规范（<code>ECMA-262, AssignmentExpression evaluation</code>），对于 <code>LeftHandSideExpression = AssignmentExpression</code>，其计算顺序如下：</p>
<ul>
<li>第一步，先得到一个 <code>引用（Reference）</code>，即“要写入的位置”，也就是 <code>Evaluate LeftHandSideExpression</code>。</li>
<li>第二步，再计算右侧的值，<code>Evaluate AssignmentExpression</code>。</li>
<li>最后将第二步得到的值写入第一步的引用当中。</li>
</ul>
<p>也就是说，对于<code>LHS = RHS</code> 这样的赋值表达式，其计算顺序是左侧先求值（为了知道写到哪），右侧后求值（为了知道写什么），最后将右侧的值写入左侧。</p>
<blockquote>
<p>📌 注意：这里说的“左侧求值”不是求它的值，而是求它的“位置”（比如属性名、变量名等）。例如对于 <code>obj[++obj.a]</code>，要确定属性名，就必须先执行 <code>++obj.a</code>。</p>
</blockquote>
<p>写个简单例子：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> obj = {
  <span class="hljs-keyword">get</span> <span class="hljs-title function_">a</span>() {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'获取 a 的值'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
  },
  <span class="hljs-keyword">get</span> <span class="hljs-title function_">b</span>() {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'获取 b 的值'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-number">2</span>;
  }
}
obj[++obj.<span class="hljs-property">a</span>] = obj.<span class="hljs-property">b</span>++;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'obj: '</span>, obj);

</code></pre>
<p>我们前面说过，运算符顺序是<strong>对象属性访问 &gt; 递增/递减 &gt; 赋值</strong>，对于赋值运算符 <code>LHS = RHS</code>，会先求出左侧 <code>LHS</code> 的<code>引用（Reference）</code>，再计算右侧 <code>RHS</code> 的值，最后将右侧的值赋值给左侧的引用。所以用这个逻辑来分析下这段代码的执行顺序：</p>
<ul>
<li>第一步，先取 <code>obj.a</code> 的值， 取到的值为 <code>1</code>， 然后执行前置递增 <code>++obj.a</code>，结果为 <code>2</code>，然后程序就知道要往 <code>obj</code> 的 <code>2</code> 属性上赋值了。</li>
<li>第二步，然后再取 <code>obj.b</code> 的值，执行后置递增 <code>obj.b++</code>，右侧计算的值为 <code>2</code>。</li>
<li>最后把右侧计算的结果值 <code>2</code> 赋值给 <code>obj[2]</code> 属性。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d65d8e0804454dab897786f17dd1d7c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP5a-S:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768481095&amp;x-signature=%2BLRc9h4VCVtobLCUpm3j6Jpp9Tk%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">逐行分析代码执行过程</h2>
<p>了解了这两个知识点后，让我们来逐行解析下这段代码。</p>
<pre><code class="hljs language-js" lang="js">
<span class="hljs-keyword">const</span> obj = {
  <span class="hljs-attr">a</span>: <span class="hljs-number">0</span>,
};

obj[<span class="hljs-string">'1'</span>] = <span class="hljs-number">0</span>;
obj[++obj.<span class="hljs-property">a</span>] = obj.<span class="hljs-property">a</span>++;
<span class="hljs-keyword">const</span> values = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">values</span>(obj);
obj[values[<span class="hljs-number">1</span>]] = obj.<span class="hljs-property">a</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj);

</code></pre>
<ol>
<li>首先，我们定义了一个对象 <code>obj</code>，它有一个属性 <code>a</code>，值为 <code>0</code>。</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> obj = {
  <span class="hljs-attr">a</span>: <span class="hljs-number">0</span>,
};
</code></pre>
<ol start="2">
<li>接下来，我们给 <code>obj</code> 添加了一个属性 <code>1</code>，值为 <code>0</code>，此时对象中有两个属性，<code>a</code> 和 <code>1</code>。</li>
</ol>
<pre><code class="hljs language-js" lang="js">obj[<span class="hljs-string">'1'</span>] = <span class="hljs-number">0</span>;
</code></pre>
<p>由于数字属性会排在前面，此时 <code>obj</code> 的值为：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"1"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"a"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ol start="3">
<li>然后会执行 <code>obj[++obj.a] = obj.a++</code>，前面我们分析过运算符的优先级，先执行左侧 <code>++obj.a</code> 得到 <code>1</code>，然后执行右侧 <code>obj.a++</code>, 由于是后置递增，所以右侧的值为 <code>1</code>，执行赋值后，<code>obj</code> 的值为：</li>
</ol>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"1"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"a"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ol start="4">
<li>经过 <code>Object.values(obj)</code> 后，<code>values</code> 的值为 <code>[1, 2]</code>。</li>
<li>执行 <code>obj[values[1]] = obj.a</code> ，转换后就是 <code>obj[2] = 2</code>。<code>obj</code> 的值变为：</li>
</ol>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"1"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"2"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"a"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>这就是最终的输出结果了。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67db3f198c3548cbbe02e574f02adaf2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP5a-S:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768481095&amp;x-signature=hERycHLSiHFwiZNtvxWD1gG4z2k%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">小结</h2>
<p>该题主要考察两个知识点：</p>
<ol>
<li>在 <code>JavaScript</code> 对象中，属性的设置顺序并不一定是循环打印顺序，在 <code>V8</code>中，数字类的属性在被称为 <code>elements</code>（按从小到大排列存储），字符类属性被称为 <code>properties</code>（按添加顺序存储）。</li>
<li><code>JavaScript</code> 运算符的运算顺序是<strong>对象属性访问 &gt; 递增/递减 &gt; 赋值</strong>，对于赋值运算符 <code>LHS = RHS</code>，会先求出左侧 <code>LHS</code> 的<code>引用（Reference）</code>，再计算右侧 <code>RHS</code> 的值，最后将右侧的值赋值给左侧的引用。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【大数据 & AI】Flink Agents 源码解读 --- (5) --- ActionExecutionOperator]]></title>    <link>https://juejin.cn/post/7592818202717192211</link>    <guid>https://juejin.cn/post/7592818202717192211</guid>    <pubDate>2026-01-08T12:44:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592818202717192211" data-draft-id="7592452108797313067" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【大数据 &amp; AI】Flink Agents 源码解读 --- (5) --- ActionExecutionOperator"/> <meta itemprop="keywords" content="算法,人工智能,数据分析"/> <meta itemprop="datePublished" content="2026-01-08T12:44:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="罗西的思考"/> <meta itemprop="url" content="https://juejin.cn/user/351470467691175"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【大数据 &amp; AI】Flink Agents 源码解读 --- (5) --- ActionExecutionOperator
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/351470467691175/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    罗西的思考
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T12:44:20.000Z" title="Thu Jan 08 2026 12:44:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读18分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">【大数据 &amp; AI】Flink Agents 源码解读 --- (5) --- ActionExecutionOperator</h2>
<ul>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0x00 摘要</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0x01 基础知识</a></p>
<ul>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">1.1 总体架构</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">1.2 定义</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">1.3 关键设计</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">1.4 流程</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">1.5 组件 &amp; 关系</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">1.6 核心依赖组件</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">1.7 主要功能</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">1.8 运行ActionTask流程</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">1.8 Flink MailboxExecutor</a></li>
</ul>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0x02 ActionExecutionOperator 生成机制和策略</a></p>
<ul>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">2.1 生成位置</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">2.2 生成机制</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">2.3 关键生成策略</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">2.4 操作符初始化过程</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">2.5 与执行环境的集成</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">2.6 总结</a></li>
</ul>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0x03 任务拆分机制详解</a></p>
<ul>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">3.1 任务拆分的基本原理</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">3.2 任务创建过程</a></li>
</ul>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0x04 任务队列管理</a></p>
<ul>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">4.1 任务状态存储</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">4.2 任务调度机制</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">4.3 任务处理循环</a></li>
</ul>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0x05 实际应用示例</a></p>
<ul>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">5.1 异步 HTTP 请求处理</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">5.2 复杂业务流程处理</a></li>
</ul>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0xFF 参考</a></p>
</li>
</ul>
<h3 data-id="heading-1">0x00 摘要</h3>
<p>ActionExecutionOperator 是整个Flink Agent 系统的执行引擎，它连接了 Flink 流处理框架和 Agent 逻辑，协调各种组件完成了 Agent 定义的动作执行。ActionExecutionOperator 主要职责：</p>
<ul>
<li>事件处理：接收来自上游的数据，包装成InputEvent</li>
<li>动作执行：根据Agent定义的动作规则，触发相应的处理逻辑</li>
<li>状态管理：维护短期记忆，检查点状态等</li>
<li>异步支持：处理需要异步执行的任务</li>
<li>Python/Java交互操作：协调组件间的交互</li>
<li>输出产生：将最终结果作为OutputEvent发送到下游</li>
</ul>
<p>这样，整个Agent的逻辑就被集成到了标准的Flink流处理管道中，能够利用Flink的分布式计算能力和容错机制。</p>
<p>本篇主要是为了学习 ActionExecutionOperator 的架构，生成机制和策略，也会学习 ActionExecutionOperator 如何使用 AgentPlan，如何生成 ActionTask。</p>
<h3 data-id="heading-2">0x01 基础知识</h3>
<p>ActionExecutionOperator 算子是整个 Flink Agent 框架运行时的核心组件，负责将用户定义的代理逻辑转换为实际的流处理操作。</p>
<h4 data-id="heading-3">1.1 总体架构</h4>
<p>可以把 Flink Agents 的整个执行流程比作 “做一道菜”，我们借此进行分析。</p>
<p>Flink Agents 是基于原生 Flink 分布式流处理能力封装的上层框架。其中四个主要组件代表了 Flink Agents 框架中的四个层次：</p>
<ul>
<li><strong>Agent（顶层设计，定义了“做什么”）</strong> ：用户定义的智能实体，类似 “餐厅菜单 + 规则手册”，包含业务逻辑、动作（Action）和资源（工具、模型等）定义，明确 “做什么”。</li>
<li><strong>AgentPlan（中间编译层，确定了“怎么做”）</strong> ：将 Agent 编译后的可执行计划，类似 “详细操作流程图”，明确动作触发规则、资源映射关系，确定 “怎么做”。</li>
<li><strong>ActionExecutionOperator（运行时执行层，是执行环境，负责“协调调度”）</strong> ：Flink 集群中的执行核心，在 Flink 流处理环境中实际执行操作，类似 “餐厅首席大厨”，负责接收数据、调度任务、管理状态，协调整体执行流程。</li>
<li><strong>ActionTask（最小执行单元，负责“具体实施”）</strong> ：具体的执行任务，类似 “员工的单个服务步骤”，分为 JavaActionTask 和 PythonActionTask，处理单个事件并返回结果。</li>
</ul>
<p>具体可以参见下图。</p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">Agent</span>] 菜单手册
    ↓（编译）
[<span class="hljs-meta">AgentPlan</span>] 详细流程图
    ↓（运行时实例化）
[<span class="hljs-meta">ActionExecutionOperator</span>] 餐厅首席大厨
    ↓（分配任务）
[<span class="hljs-meta">ActionTask</span>] 员工具体任务
</code></pre>
<p>这样的设计使得系统既灵活又高效，能够处理复杂的AI代理任务，同时保证了良好的扩展性和维护性。</p>
<h4 data-id="heading-4">1.2 定义</h4>
<p>ActionExecutionOperator 的定义如下。</p>
<pre><code class="hljs language-vbnet" lang="vbnet">/**
 * An <span class="hljs-keyword">operator</span> that executes the actions defined <span class="hljs-keyword">in</span> the agent. Upon receiving data <span class="hljs-keyword">from</span> the
 * upstream, it first wraps the data <span class="hljs-keyword">into</span> an {@link InputEvent}. It <span class="hljs-keyword">then</span> invokes the corresponding
 * action that <span class="hljs-built_in">is</span> interested <span class="hljs-keyword">in</span> the {@link InputEvent}, <span class="hljs-built_in">and</span> collects the output <span class="hljs-keyword">event</span> produced <span class="hljs-keyword">by</span>
 * the action.
 *
 * &lt;p&gt;<span class="hljs-keyword">For</span> events <span class="hljs-keyword">of</span> type {@link OutputEvent}, the data contained <span class="hljs-keyword">in</span> the <span class="hljs-keyword">event</span> <span class="hljs-built_in">is</span> sent downstream.
 * <span class="hljs-keyword">For</span> all other <span class="hljs-keyword">event</span> types, the process <span class="hljs-built_in">is</span> repeated: the <span class="hljs-keyword">event</span> triggers the corresponding action,
 * <span class="hljs-built_in">and</span> the resulting output <span class="hljs-keyword">event</span> <span class="hljs-built_in">is</span> collected <span class="hljs-keyword">for</span> further processing.
 */
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> ActionExecutionOperator&lt;<span class="hljs-keyword">IN</span>, OUT&gt; extends AbstractStreamOperator&lt;OUT&gt;
        <span class="hljs-keyword">implements</span> OneInputStreamOperator&lt;<span class="hljs-keyword">IN</span>, OUT&gt;, BoundedOneInput {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final <span class="hljs-type">long</span> serialVersionUID = <span class="hljs-number">1L</span>;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final Logger LOG = LoggerFactory.getLogger(ActionExecutionOperator.<span class="hljs-keyword">class</span>);

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final <span class="hljs-type">String</span> RECOVERY_MARKER_STATE_NAME = <span class="hljs-string">"recoveryMarker"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final <span class="hljs-type">String</span> MESSAGE_SEQUENCE_NUMBER_STATE_NAME = <span class="hljs-string">"messageSequenceNumber"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final <span class="hljs-type">String</span> PENDING_INPUT_EVENT_STATE_NAME = <span class="hljs-string">"pendingInputEvents"</span>;

    <span class="hljs-keyword">private</span> final AgentPlan agentPlan;

    <span class="hljs-keyword">private</span> final <span class="hljs-type">Boolean</span> inputIsJava;

    <span class="hljs-keyword">private</span> transient StreamRecord&lt;OUT&gt; reusedStreamRecord;

    <span class="hljs-keyword">private</span> transient MapState&lt;<span class="hljs-type">String</span>, MemoryObjectImpl.MemoryItem&gt; shortTermMemState;

    // PythonActionExecutor <span class="hljs-keyword">for</span> Python actions
    <span class="hljs-keyword">private</span> transient PythonActionExecutor pythonActionExecutor;

    <span class="hljs-keyword">private</span> transient FlinkAgentsMetricGroupImpl metricGroup;

    <span class="hljs-keyword">private</span> transient BuiltInMetrics builtInMetrics;

    <span class="hljs-keyword">private</span> transient SegmentedQueue keySegmentQueue;

    <span class="hljs-keyword">private</span> final transient MailboxExecutor mailboxExecutor;

    // We need <span class="hljs-keyword">to</span> check whether the current thread <span class="hljs-built_in">is</span> the mailbox thread <span class="hljs-keyword">using</span> the mailbox
    // processor.
    // TODO: This <span class="hljs-built_in">is</span> a temporary workaround. <span class="hljs-keyword">In</span> the future, we should add an <span class="hljs-keyword">interface</span> <span class="hljs-keyword">in</span>
    // MailboxExecutor <span class="hljs-keyword">to</span> check whether a thread <span class="hljs-built_in">is</span> a mailbox thread, rather than <span class="hljs-keyword">using</span> reflection
    // <span class="hljs-keyword">to</span> obtain the MailboxProcessor instance <span class="hljs-built_in">and</span> make the determination.
    <span class="hljs-keyword">private</span> transient MailboxProcessor mailboxProcessor;

    // An action will be split <span class="hljs-keyword">into</span> one <span class="hljs-built_in">or</span> more ActionTask objects. We use a state <span class="hljs-keyword">to</span> store the
    // pending ActionTasks that are waiting <span class="hljs-keyword">to</span> be executed.
    <span class="hljs-keyword">private</span> transient ListState&lt;ActionTask&gt; actionTasksKState;

    // <span class="hljs-keyword">To</span> avoid processing different InputEvents <span class="hljs-keyword">with</span> the same <span class="hljs-keyword">key</span>, we use a state <span class="hljs-keyword">to</span> store pending
    // InputEvents that are waiting <span class="hljs-keyword">to</span> be processed.
    <span class="hljs-keyword">private</span> transient ListState&lt;<span class="hljs-keyword">Event</span>&gt; pendingInputEventsKState;

    // An <span class="hljs-keyword">operator</span> state <span class="hljs-built_in">is</span> used <span class="hljs-keyword">to</span> track the currently processing keys. This <span class="hljs-built_in">is</span> useful <span class="hljs-keyword">when</span>
    // receiving an EndOfInput signal, <span class="hljs-keyword">as</span> we need <span class="hljs-keyword">to</span> wait <span class="hljs-keyword">until</span> all related events are fully
    // processed.
    <span class="hljs-keyword">private</span> transient ListState&lt;<span class="hljs-type">Object</span>&gt; currentProcessingKeysOpState;

    <span class="hljs-keyword">private</span> final transient EventLogger eventLogger;
    <span class="hljs-keyword">private</span> final transient List&lt;EventListener&gt; eventListeners;

    <span class="hljs-keyword">private</span> transient ActionStateStore actionStateStore;
    <span class="hljs-keyword">private</span> transient ValueState&lt;<span class="hljs-type">Long</span>&gt; sequenceNumberKState;
    <span class="hljs-keyword">private</span> transient ListState&lt;<span class="hljs-type">Object</span>&gt; recoveryMarkerOpState;
    <span class="hljs-keyword">private</span> transient Map&lt;<span class="hljs-type">Long</span>, Map&lt;<span class="hljs-type">Object</span>, <span class="hljs-type">Long</span>&gt;&gt; checkpointIdToSeqNums;

    // This <span class="hljs-keyword">in</span> memory map keep track <span class="hljs-keyword">of</span> the runner context <span class="hljs-keyword">for</span> the <span class="hljs-keyword">async</span> action task that having
    // been finished
    <span class="hljs-keyword">private</span> final transient Map&lt;ActionTask, RunnerContextImpl&gt; actionTaskRunnerContexts;
</code></pre>
<h4 data-id="heading-5">1.3 关键设计</h4>
<p>ActionExecutionOperator 关键设计要点如下：</p>
<ul>
<li>状态管理：使用Flink的状态后端管理短期记忆和处理状态</li>
<li>异步支持：通过邮箱线程机制支持异步操作执行</li>
<li>容错恢复：通过checkpoint机制实现状态持久化和恢复</li>
<li>资源隔离：每个key拥有独立的处理上下文和状态</li>
<li>多语言支持：同时支持Java和Python实现的动作</li>
<li>这种设计使得复杂的Agent逻辑能够在Flink的分布式流处理环境中高效、可靠地执行</li>
</ul>
<h4 data-id="heading-6">1.4 流程</h4>
<p>ActionExecutionOperator 的工作流程：</p>
<ul>
<li>接收数据：从上游接收数据并包装成 InputEvent</li>
<li>动作触发：依据事件类型查找并触发相应的动作</li>
<li>动作执行：执行动作逻辑，可能产生新的事件</li>
<li>事件处理：处理动作产生的事件，如果是输入事件则发送给下游</li>
<li>状态更新：更新内存状态和执行状态</li>
<li>循环处理：继续处理新产生的事件，直到没有待处理的事件。</li>
</ul>
<p>关键特性：</p>
<ul>
<li>事件驱动：基于事件的处理模型，事件触发动作执行</li>
<li>状态一致性：通过Flink的状态管理来保证处理一致性</li>
<li>容错恢复：支持从检查点恢复执行状态</li>
<li>混合执行：同时支持 java 和 python 动作的执行</li>
<li>内存管理：管理Agent的短期内存状态</li>
</ul>
<p>使用流程图如下</p>
<pre><code class="hljs language-css" lang="css">graph <span class="hljs-selector-tag">TD</span>
	<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[AgentsExecutionEnvironment]</span> --&gt; <span class="hljs-selector-tag">B</span><span class="hljs-selector-attr">[RemoteExecutionEnvironment]</span>
	<span class="hljs-selector-tag">B</span> --&gt; C<span class="hljs-selector-attr">[ActionExecutionOperator]</span>
	C --&gt; D<span class="hljs-selector-attr">[AgentPlan]</span>
	C --&gt; D<span class="hljs-selector-attr">[Flink State Backend]</span>
	C --&gt; D<span class="hljs-selector-attr">[Python Components]</span>
	C --&gt; D<span class="hljs-selector-attr">[Event Processing Components]</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1071b67850a6490094d8458c595692dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768481060&amp;x-signature=d%2FsuEBKkkkWUjM1GsfLokg3E5tM%3D" alt="ActionExecutionOperator-flow-2" loading="lazy"/></p>
<p>ActionExecutionOperator-flow-2</p>
<h4 data-id="heading-7">1.5 组件 &amp; 关系</h4>
<p>ActionExecutionOperator 是 Flink Agent 系统中的核心执行组件，位于 Flink 流处理管道中，负责执行 Agent 定义的各种动作。其主要交互组件如下：</p>
<p><strong>上游组件</strong></p>
<ul>
<li>DataStream API：作为 Flink 流处理管道中的操作符，接收来自上游 DataStream 的数据</li>
<li>Input 数据源：接收各种类型的输入数据，将其包装为 InputEvent</li>
<li>KeyedStream：处理按键分组的数据流</li>
</ul>
<p><strong>下游组件</strong></p>
<ul>
<li>Output 数据接收器：将OutputEvent 中的数据发送到下游操作符</li>
<li>DataStream API：输出处理结果到下游 DataStream 操作符</li>
</ul>
<p><strong>核心依赖组件</strong></p>
<p>工作流程中的交互</p>
<pre><code class="hljs language-css" lang="css">graph <span class="hljs-selector-tag">TD</span>
	<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[DataStream Source]</span> --&gt; <span class="hljs-selector-tag">B</span><span class="hljs-selector-attr">[ActionExecutionOperator]</span>
	<span class="hljs-selector-tag">B</span> --&gt; C<span class="hljs-selector-attr">[DataStream Sink]</span>
	<span class="hljs-selector-tag">B</span> --&gt; D<span class="hljs-selector-attr">[AgentPlan]</span>
	<span class="hljs-selector-tag">B</span> --&gt; E<span class="hljs-selector-attr">[ActionTask]</span>
	<span class="hljs-selector-tag">B</span> --&gt; F<span class="hljs-selector-attr">[RunnerContext]</span>
	<span class="hljs-selector-tag">B</span> --&gt; G<span class="hljs-selector-attr">[Flink State Backend]</span>
	<span class="hljs-selector-tag">B</span> --&gt; H<span class="hljs-selector-attr">[PythonActionExecutor]</span>
	<span class="hljs-selector-tag">B</span> --&gt; <span class="hljs-selector-tag">I</span><span class="hljs-selector-attr">[ActionStateStore]</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc5aa8d1e3bd4f97a22437c09ff7d720~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768481060&amp;x-signature=eJqvLXpNUHEW4ocw6qLSeSLblzA%3D" alt="ActionExecutionOperatorflow-1" loading="lazy"/></p>
<p>ActionExecutionOperatorflow-1</p>
<h4 data-id="heading-8">1.6 核心依赖组件</h4>
<ul>
<li>
<p>AgentPlan：<strong>AgentPlan会被 ActionExecutionOperator 使用，因为操作符需要访问AgentPlan中的动作定义和资源配置来执行相应逻辑</strong></p>
<ul>
<li>包含Agent的所有动作定义和资源配置</li>
<li>提供动作触发逻辑和资源配置信息</li>
</ul>
</li>
<li>
<p>ActionTask 及其子类：</p>
<ul>
<li>JavaActionTask ：执行 Java 动作</li>
<li>PythonActionTask ：执行Python动作</li>
</ul>
</li>
<li>
<p>Environment</p>
<ul>
<li>Flink Streaming Runtime Environment：ActionExecutionOperator 是一个Flink 流处理操作符，会被 Flink 流处理运行时环境使用，作为流处理作业 DAG 图中的一个节点。</li>
<li>RemoteExecutionEnvironment：在远程执行环境中，RemoteExecutionEnvironment 会创建和使用 ActionExecutionOperator 来执行Agent 逻辑。</li>
</ul>
</li>
<li>
<p>RunnerContext 及其实现：</p>
<ul>
<li>RunnerContextImpl：Java 动作执行上下文</li>
<li>PythonRunnerContextImpl：Python 动作执行上下文</li>
</ul>
</li>
<li>
<p>状态管理组件。以下状态存储组件会被 ActionExecutionOperator 使用。</p>
<ul>
<li>Flink 状态后端，用于短期内存、待处理任务等。</li>
<li>ActionStateStore：KafkaActionStateStore：可选的外部状态存储，用于动作状态持久化和恢复。</li>
</ul>
</li>
<li>
<p>Python相关组件。当代理包含Python动作时，以下组件会与 ActionExecutionOperator 协同工作。</p>
<ul>
<li>PythonActionExecutor：管理Python环境和执行Python动作</li>
<li>PythonActionTask：表示Python动作任务</li>
<li>PythonRunnerContextImpl ：Python动作执行上下文。</li>
</ul>
</li>
<li>
<p>辅助组件</p>
<ul>
<li>EventLogger：事件日志记录器</li>
<li>EventListner：事件监听器</li>
<li>BultInMetrics：内置指标收集</li>
<li>FlinkAgentsMetricGroupImpl：指标组实现</li>
</ul>
</li>
<li>
<p>事件处理相关组件</p>
<ul>
<li>各种Event类型（InputEvent、OutputEvent、PythonEvent等）</li>
<li>SegmentedQueue：管理按键分段的事件队列和水印处理</li>
</ul>
</li>
</ul>
<h4 data-id="heading-9">1.7 主要功能</h4>
<p>ActionExecutionOperator 主要功能如下：</p>
<ul>
<li>
<p>动作执行核心</p>
<ul>
<li>执行Agent中定义的所有动作（actions）</li>
<li>处理事件驱动的执行流程，根据事件类型触发的相应的动作</li>
</ul>
</li>
<li>
<p>事件处理流程</p>
<ul>
<li>接收上游数据并将其包装成 InputEvent</li>
<li>根据事件类型触发对应的 action 执行</li>
<li>对应 OutputEvent 类型的事件，将数据发送到下游</li>
<li>对于其他类型的事件，继续触发相应的动作来执行</li>
</ul>
</li>
<li>
<p>状态管理</p>
<ul>
<li>管理短期内存状态（short-term memory）</li>
<li>维护动作执行状态和序列号</li>
<li>支持检查点和故障恢复</li>
<li>使用 Flink 状态后端持久化关键状态信息</li>
</ul>
</li>
<li>
<p>混合语言支持</p>
<ul>
<li>支持 Java 和 Python 两种语言编写的动作</li>
<li>通过 PythonActionExecutor 处理 Python 动作的执行</li>
<li>在同一个算子中协调 Java 和 Python 动作的执行</li>
</ul>
</li>
<li>
<p>异步处理支持</p>
<ul>
<li>支持异步动作执行</li>
<li>通过 MailboxExector 管理异步任务</li>
<li>处理长时间运行的动作任务</li>
</ul>
</li>
<li>
<p>监控和日志</p>
<ul>
<li>集成指标收集和监控</li>
<li>支持事件日志记录</li>
<li>提供内置指标跟踪执行情况</li>
</ul>
</li>
</ul>
<h4 data-id="heading-10">1.8 运行ActionTask流程</h4>
<p>ActionTask 在 Flink 中的运行机制分三步完成：创建、调度、执行，全程由 ActionExecutionOperator 托管，并利用 Flink 的邮箱线程保证并发安全，具体如下。</p>
<h5 data-id="heading-11">创建与初始化</h5>
<ul>
<li>作业启动时，ActionExecutionOperator 完成实例化，内部持有 AgentPlan（含全部 Action 定义）。</li>
<li>上游数据到达 processElement() 后，先被封装成 InputEvent；随后调用 processEvent() 开始处理。</li>
</ul>
<h5 data-id="heading-12">ActionTask 的创建与调度</h5>
<ul>
<li>
<p>processEvent() 通过 getActionsTriggeredBy() 找出响应该事件的所有 Action。</p>
</li>
<li>
<p>对每个 Action，调用 createActionTask() 生成对应的 ActionTask 实例，并存入 actionTasksState 状态。</p>
</li>
<li>
<p>使用 Flink MailboxExecutor 提交异步任务：</p>
<pre><code class="hljs language-scss" lang="scss">mailboxExecutor<span class="hljs-selector-class">.submit</span>(() -&gt; <span class="hljs-built_in">tryProcessActionTaskForKey</span>(key), "process action task");
</code></pre>
<p>保证后续逻辑在 mailbox 线程中顺序执行，避免并发冲突。<strong>这是Agent与Flink进行结合的关键之一，是Agent代码运行的关键</strong>。</p>
</li>
</ul>
<h5 data-id="heading-13">ActionTask 的执行</h5>
<ul>
<li>
<p>tryProcessActionTaskForKey() → processActionTaskForKey() 从 actionTasksState 取出待处理任务。</p>
</li>
<li>
<p>createAndSetRunnerContext() 为任务绑定运行时上下文（内存、指标、邮箱检查等）。</p>
</li>
<li>
<p>调用 ActionTask.invoke() 执行具体动作逻辑；若任务返回新生成器（异步场景），则循环创建后续 ActionTask 并再次提交邮箱，实现“拆分-继续”流程。</p>
<ul>
<li>ActionTask.invoke() 返回 ActionTaskResult；若任务已完成（isFinished() 为 true），则通过 processEvent() 向下游发送输出事件或触发新的 ActionTask，并持久化内存状态。</li>
<li>若任务未完成（异步操作），则保存 RunnerContext 供后续使用，并将新生成的 ActionTask 加入 actionTasksState，再次提交到 MailboxExecutor，形成循环直到所有任务完成。</li>
</ul>
</li>
</ul>
<h5 data-id="heading-14">状态管理与容错</h5>
<ul>
<li>使用 Flink 状态后端持久化 actionTasksState、pendingInputEventsState 等；在 checkpoint 时保存快照，故障恢复后可继续执行。</li>
<li>实现 snapshotState() 和 initializeState() 方法，完成状态的快照与恢复。</li>
</ul>
<p>整个流程依托 Flink 核心特性：</p>
<ul>
<li>事件驱动：基于事件触发动作执行；</li>
<li>状态管理：使用 Flink 状态后端管理中间状态；</li>
<li>容错机制：通过 checkpoint 和状态恢复保证 exactly-once 语义；</li>
<li>异步处理：通过 MailboxExecutor 实现高效的异步任务调度；</li>
<li>键控处理：支持按键分区处理，保证同一键的数据顺序处理。</li>
</ul>
<p>通过“状态存储 + 邮箱调度”双机制，ActionTask 既能顺序处理单键事件，又能优雅拆分异步步骤，全程与 Flink 的并发模型无缝衔接。</p>
<h4 data-id="heading-15">1.8 Flink MailboxExecutor</h4>
<p>MailboxExecutor 是 Flink 内部的一个“单线程邮筒”调度器，作用可以一句话概括： <strong>“外部线程只管投信，内部让同一个算子/同一个键的所有任务按顺序一条一条执行，避免并发竞争，同时不阻塞整个 TaskManager”</strong> 。</p>
<h5 data-id="heading-16">为什么需要 MailboxExecutor</h5>
<ol>
<li>Flink 算子可能被多线程同时调用（网络线程、异步 I/O、用户回调）。</li>
<li>很多算子状态不是线程安全的（例如 keyed state、Python 解释器）。</li>
<li>不能把整个算子锁起来，否则背压会拖垮整个 TaskManager。</li>
</ol>
<p>→ 解决方案：把“真正干活”的代码投递到同一个“邮箱”里，由<strong>一条专用线程</strong>按顺序取出执行；其他线程只负责“投信”，瞬间返回，不会阻塞。</p>
<h5 data-id="heading-17">使用场景速览</h5>

























<table><thead><tr><th>场景</th><th>投递到邮箱的任务</th><th>好处</th></tr></thead><tbody><tr><td>ActionTask 拆分</td><td><code>tryProcessActionTaskForKey(key)</code></td><td>同一键的任务顺序执行，状态无锁</td></tr><tr><td>Python UDF 异步</td><td><code>PythonGeneratorActionTask</code></td><td>解释器单线程，避免 GIL 竞争</td></tr><tr><td>网络线程回调</td><td><code>onNext(record)</code></td><td>网络线程立即返回，不阻塞 TCP 接收</td></tr></tbody></table>
<h5 data-id="heading-18">工作模型（用邮筒来隐喻）</h5>
<pre><code class="hljs language-scss" lang="scss">任意线程（网络、异步、用户）  
   ├─→ mailbox<span class="hljs-selector-class">.put</span>(mail)   <span class="hljs-comment">// 非阻塞，瞬间返回  </span>
   └─→ 立即继续干别的  

专用单线程（Mailbox Thread）  
   ├─→ <span class="hljs-built_in">while</span>(true) mail = mailbox<span class="hljs-selector-class">.take</span>()  
   ├─→ 顺序执行 mail<span class="hljs-selector-class">.run</span>()  
   └─→ 更新状态、发下游、写 checkpoint
</code></pre>
<ul>
<li>邮箱使用 <strong>无锁队列</strong>（Disruptor），put/take 都是 O(1) 且线程安全。</li>
<li>单线程内部仍可异步（例如生成器返回新的 ActionTask），但<strong>状态读写无并发</strong>。</li>
</ul>
<p>对应示例如下：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 投递任务</span>
mailboxExecutor<span class="hljs-selector-class">.submit</span>(() -&gt; <span class="hljs-built_in">tryProcessActionTaskForKey</span>(key), "process action task");

<span class="hljs-comment">// 邮箱线程循环（简化）</span>
while (isRunning) {
    Runnable task = mailbox<span class="hljs-selector-class">.take</span>();   <span class="hljs-comment">// 阻塞直到有信</span>
    task<span class="hljs-selector-class">.run</span>();                       <span class="hljs-comment">// 顺序执行</span>
}
</code></pre>
<h3 data-id="heading-19">0x02 ActionExecutionOperator 生成机制和策略</h3>
<h4 data-id="heading-20">2.1 生成位置</h4>
<p>ActionExecutionOperator 在 ActionExecutionOperatorFactory 类中创建。从代码结构可以看出，这个工厂类被用在 CompileUtils.connectToAgent() 方法中。</p>
<h4 data-id="heading-21">2.2 生成机制</h4>
<h5 data-id="heading-22">创建流程</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-operator">/</span><span class="hljs-operator">/</span> 在 CompileUtils.java 中
private <span class="hljs-keyword">static</span> <span class="hljs-operator">&lt;</span>K, <span class="hljs-keyword">IN</span>, <span class="hljs-keyword">OUT</span><span class="hljs-operator">&gt;</span> DataStream<span class="hljs-operator">&lt;</span><span class="hljs-keyword">OUT</span><span class="hljs-operator">&gt;</span> connectToAgent(
    KeyedStream<span class="hljs-operator">&lt;</span><span class="hljs-keyword">IN</span>, K<span class="hljs-operator">&gt;</span> keyedInputStream,
    AgentPlan agentPlan,
    TypeInformation<span class="hljs-operator">&lt;</span><span class="hljs-keyword">OUT</span><span class="hljs-operator">&gt;</span> outTypeInformation,
    <span class="hljs-type">boolean</span> inputIsJava) {
<span class="hljs-keyword">return</span> (DataStream<span class="hljs-operator">&lt;</span><span class="hljs-keyword">OUT</span><span class="hljs-operator">&gt;</span>)
    keyedInputStream
        .transform(
            "action-execute-operator",
            outTypeInformation,
            <span class="hljs-keyword">new</span> ActionExecutionOperatorFactory(agentPlan, inputIsJava)
        )
        .setParallelism(keyedInputStream.getParallelism());
}
</code></pre>
<p>操作符通过 Flink 的 transform() 方法创建，该方法接收一个 ActionExecutionOperatorFactory。</p>
<h5 data-id="heading-23">工厂模式实现</h5>
<p>ActionExecutionOperatorFactory 实现了 Flink 的 StreamOperatorFactory 接口：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActionExecutionOperatorFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">StreamOperatorFactory</span>&lt;<span class="hljs-title class_">Object</span>&gt; {
    <span class="hljs-keyword">private</span> final <span class="hljs-title class_">AgentPlan</span> agentPlan;
    <span class="hljs-keyword">private</span> final <span class="hljs-title class_">Boolean</span> inputIsJava;

<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> &lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">StreamOperator</span>&lt;<span class="hljs-title class_">Object</span>&gt;&gt; T <span class="hljs-title function_">createStreamOperator</span>(<span class="hljs-params">
        StreamOperatorParameters&lt;<span class="hljs-built_in">Object</span>&gt; parameters</span>) {
    <span class="hljs-title class_">ProcessingTimeService</span> processingTimeService = parameters.<span class="hljs-title function_">getProcessingTimeService</span>();
    <span class="hljs-title class_">MailboxExecutor</span> mailboxExecutor = parameters.<span class="hljs-title function_">getMailboxExecutor</span>();
    <span class="hljs-keyword">return</span> (T) <span class="hljs-keyword">new</span> <span class="hljs-title class_">ActionExecutionOperator</span>&lt;&gt;(
            agentPlan,
            inputIsJava,
            processingTimeService,
            mailboxExecutor,
            <span class="hljs-literal">null</span>); <span class="hljs-comment">// actionStateStore</span>
}
</code></pre>
<h4 data-id="heading-24">2.3 关键生成策略</h4>
<h5 data-id="heading-25">策略 1：基于计划的生成</h5>
<ul>
<li>AgentPlan 包含关于动作、资源和配置的所有必要信息</li>
<li>这个计划是从用户定义的 Python 或 Java Agent 生成的</li>
<li>操作符的所有行为都在创建时由这个计划决定</li>
</ul>
<h5 data-id="heading-26">策略 2：类型特定处理</h5>
<p>inputIsJava 参数决定了如何处理输入数据：</p>
<ul>
<li>如果为 true：输入和输出是 Java 对象</li>
<li>如果为 false：输入和输出是字节数组（用于 Python 互操作）</li>
</ul>
<h5 data-id="heading-27">策略 3：资源管理</h5>
<p>资源在初始化期间注入到操作符中：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 在 ActionExecutionOperator 构造函数中</span>
<span class="hljs-keyword">public</span> <span class="hljs-title class_">ActionExecutionOperator</span>(
        <span class="hljs-title class_">AgentPlan</span> agentPlan,
        <span class="hljs-title class_">Boolean</span> inputIsJava,
        <span class="hljs-title class_">ProcessingTimeService</span> processingTimeService,
        <span class="hljs-title class_">MailboxExecutor</span> mailboxExecutor,
        <span class="hljs-title class_">ActionStateStore</span> actionStateStore) {
    ...
}

<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> &lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">StreamOperator</span>&lt;<span class="hljs-title class_">Object</span>&gt;&gt; T <span class="hljs-title function_">createStreamOperator</span>(<span class="hljs-params">
        StreamOperatorParameters&lt;<span class="hljs-built_in">Object</span>&gt; parameters</span>) {
    <span class="hljs-title class_">ProcessingTimeService</span> processingTimeService = parameters.<span class="hljs-title function_">getProcessingTimeService</span>();
    <span class="hljs-title class_">MailboxExecutor</span> mailboxExecutor = parameters.<span class="hljs-title function_">getMailboxExecutor</span>();
    <span class="hljs-keyword">return</span> (T) <span class="hljs-keyword">new</span> <span class="hljs-title class_">ActionExecutionOperator</span>&lt;&gt;(
            agentPlan,
            inputIsJava,
            processingTimeService,
            mailboxExecutor,
            <span class="hljs-literal">null</span>); <span class="hljs-comment">// actionStateStore</span>
}
</code></pre>
<h4 data-id="heading-28">2.4 操作符初始化过程</h4>
<p>当操作符打开时。</p>
<p><strong>状态初始化：</strong></p>
<ul>
<li>短期记忆状态（<code>shortTermMemState</code>）</li>
<li>动作任务状态（<code>actionTasksState</code>）</li>
<li>待处理事件状态（<code>pendingInputEventsState</code>）</li>
<li>处理中的键跟踪状态（<code>currentProcessingKeysOpState</code>）</li>
</ul>
<p><strong>组件设置：</strong></p>
<ul>
<li>Python 执行器（如果需要）</li>
<li>指标收集</li>
<li>事件日志记录</li>
<li>动作状态存储（可选）</li>
</ul>
<p><strong>恢复逻辑：</strong></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 故障/重启后恢复处理</span>
private void <span class="hljs-built_in">tryResumeProcessActionTasks</span>() throws Exception {
    Iterable&lt;<span class="hljs-selector-tag">Object</span>&gt; keys = currentProcessingKeysOpState<span class="hljs-selector-class">.get</span>();
    if (keys != null) {
        for (Object key : keys) {
            keySegmentQueue<span class="hljs-selector-class">.addKeyToLastSegment</span>(key);
            mailboxExecutor<span class="hljs-selector-class">.submit</span>(
                () -&gt; <span class="hljs-built_in">tryProcessActionTaskForKey</span>(key), "process action task");
        }
    }
}
</code></pre>
<h4 data-id="heading-29">2.5 与执行环境的集成</h4>
<p>本地环境和远程环境的生成过程不同：</p>
<p><strong>远程环境（Flink 集群）</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 在 RemoteExecutionEnvironment.java 中</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-title class_">DataStream</span>&lt;<span class="hljs-title class_">Object</span>&gt; <span class="hljs-title function_">toDataStream</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (agentPlan == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">"Must apply agent before calling toDataStream"</span>);
    }

    <span class="hljs-keyword">if</span> (outputDataStream == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">if</span> (keySelector != <span class="hljs-literal">null</span>) {
            outputDataStream =
                <span class="hljs-title class_">CompileUtils</span>.<span class="hljs-title function_">connectToAgent</span>(inputDataStream, keySelector, agentPlan);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 如果没有提供键选择器，则使用简单的直键选择器</span>
            outputDataStream =
                <span class="hljs-title class_">CompileUtils</span>.<span class="hljs-title function_">connectToAgent</span>(inputDataStream, x -&gt; x, agentPlan);
        }
    }

    <span class="hljs-keyword">return</span> outputDataStream;
}
</code></pre>
<p><strong>本地环境</strong></p>
<p>对于本地执行，使用完全不同的 LocalRunner 而不是基于操作符的方法。</p>
<h4 data-id="heading-30">2.6 总结</h4>
<p>ActionExecutionOperator 通过 Flink 的转换 API 使用工厂模式生成。生成策略重点关注：</p>
<ul>
<li>声明式方法：使用 AgentPlan 定义行为</li>
<li>类型灵活性：通过序列化支持 Java 和 Python</li>
<li>状态管理：正确管理 Flink 状态以实现容错</li>
<li>资源注入：提供对已配置资源的访问</li>
<li>可恢复处理：通过状态快照支持故障恢复</li>
</ul>
<p>这种设计允许操作符基于代理定义动态创建，同时保持 Flink 流处理的保证。</p>
<h3 data-id="heading-31">0x03 任务拆分机制详解</h3>
<h4 data-id="heading-32">3.1 任务拆分的基本原理</h4>
<h5 data-id="heading-33">为什么需要拆分任务</h5>
<p>ActionExecutionOperator 将复杂的 Action 拆分成多个 ActionTask 的主要原因是为了支持异步操作和状态管理。</p>
<p>一个完整的 Action 可能包含以下复杂场景：</p>
<ul>
<li>需要等待外部服务响应的异步调用</li>
<li>需要分步骤执行的长时间运行任务</li>
<li>需要在不同时间点产生多个输出事件的任务</li>
</ul>
<h5 data-id="heading-34">拆分粒度</h5>
<p>每个 ActionTask 代表 Action 中的一个执行单元，通常对应以下情况之一：</p>
<ul>
<li>Action 的初始执行步骤</li>
<li>异步操作的触发和回调处理</li>
<li>长时间运行任务的阶段性执行</li>
</ul>
<h4 data-id="heading-35">3.2 任务创建过程</h4>
<h5 data-id="heading-36">不同类型 ActionTask 的创建</h5>
<p>根据 Action 的执行类型（Java 或 Python），创建相应的 ActionTask 实现：</p>
<ul>
<li>JavaActionTask：处理 Java 实现的 Action</li>
<li>PythonActionTask：处理 Python 实例的 Action</li>
</ul>
<h5 data-id="heading-37">动态创建 ActionTask</h5>
<p>在某些情况下，ActionTask.invoke() 可能会产生新的 ActionTask 来继续处理：</p>
<ul>
<li>异步操作完成后需要进一步处理结果</li>
<li>长时间运行的任务需要分阶段执行</li>
<li>需要等待某些条件满足后再继续执行</li>
</ul>
<p>具体对应代码中，就是当 ActionTask 被执行时，其 invoke() 方法可能会返回一个新的 ActionTask 来继续执行剩余的工作：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// PythonActionTask.invoke() 示例</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> ActionTaskResult <span class="hljs-title">invoke</span>() throws Exception</span> {
    <span class="hljs-comment">// 执行 Python 函数</span>
    String pythonGeneratorRef = pythonActionExecutor.executePythonFunction(...);

    <span class="hljs-keyword">if</span> (pythonGeneratorRef != <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// 如果返回了生成器引用，创建新的 ActionTask 来处理后续步骤</span>
        ActionTask tempGeneratedActionTask =
            <span class="hljs-keyword">new</span> PythonGeneratorActionTask(key, <span class="hljs-keyword">event</span>, action, pythonGeneratorRef);
        tempGeneratedActionTask.setRunnerContext(runnerContext);
        <span class="hljs-keyword">return</span> tempGeneratedActionTask.invoke();
    }

    <span class="hljs-comment">// 如果没有更多步骤，标记任务完成</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ActionTaskResult(
        <span class="hljs-literal">true</span>, runnerContext.drainEvents(<span class="hljs-keyword">event</span>.getSourceTimestamp()), <span class="hljs-literal">null</span>);
}
</code></pre>
<p>也会在 processEvent 中启动新的task。</p>
<pre><code class="hljs language-scss" lang="scss">    private void <span class="hljs-built_in">processEvent</span>(Object key, Event event) throws Exception {
        <span class="hljs-built_in">notifyEventProcessed</span>(event);

        boolean isInputEvent = EventUtil<span class="hljs-selector-class">.isInputEvent</span>(event);
        if (EventUtil.isOutputEvent(event)) {
            <span class="hljs-comment">// If the event is an OutputEvent, we send it downstream.</span>
            OUT outputData = <span class="hljs-built_in">getOutputFromOutputEvent</span>(event);
            if (event.hasSourceTimestamp()) {
                output<span class="hljs-selector-class">.collect</span>(reusedStreamRecord.replace(outputData, event.getSourceTimestamp()));
            } else {
                reusedStreamRecord<span class="hljs-selector-class">.eraseTimestamp</span>();
                output<span class="hljs-selector-class">.collect</span>(reusedStreamRecord.replace(outputData));
            }
        } else {
            if (isInputEvent) {
                <span class="hljs-comment">// If the event is an InputEvent, we mark that the key is currently being processed.</span>
                currentProcessingKeysOpState<span class="hljs-selector-class">.add</span>(key);
                <span class="hljs-built_in">initOrIncSequenceNumber</span>();
            }
            <span class="hljs-comment">// We then obtain the triggered action and add ActionTasks to the waiting processing</span>
            <span class="hljs-comment">// queue.</span>
            List&lt;Action&gt; triggerActions = <span class="hljs-built_in">getActionsTriggeredBy</span>(event);
            if (triggerActions != null &amp;&amp; !triggerActions.isEmpty()) {
                for (Action triggerAction : triggerActions) {
                    actionTasksKState<span class="hljs-selector-class">.add</span>(createActionTask(key, triggerAction, event));
                }
            }
        }

        if (isInputEvent) {
            <span class="hljs-comment">// If the event is an InputEvent, we submit a new mail to try processing the actions.</span>
            mailboxExecutor<span class="hljs-selector-class">.submit</span>(() -&gt; <span class="hljs-built_in">tryProcessActionTaskForKey</span>(key), "process action task");
        }
    }
</code></pre>
<p>createActionTask 的代码如下。</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">private</span> ActionTask createActionTask(<span class="hljs-type">Object</span> <span class="hljs-keyword">key</span>, Action action, <span class="hljs-keyword">Event</span> <span class="hljs-keyword">event</span>) {
    <span class="hljs-keyword">if</span> (action.getExec() instanceof JavaFunction) {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">new</span> JavaActionTask(
            <span class="hljs-keyword">key</span>, <span class="hljs-keyword">event</span>, action, getRuntimeContext().getUserCodeClassLoader());
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (action.getExec() instanceof PythonFunction) {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">new</span> PythonActionTask(<span class="hljs-keyword">key</span>, <span class="hljs-keyword">event</span>, action);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">new</span> IllegalStateException(
            <span class="hljs-string">"Unsupported action type: "</span> + action.getExec().getClass());
    }
}
</code></pre>
<h3 data-id="heading-38">0x04 任务队列管理</h3>
<h4 data-id="heading-39">4.1 任务状态存储</h4>
<p>ActionExecutionOperator 使用 Flink 的状态管理来存储待处理的 ActionTask：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 在 operator 中定义的状态</span>
<span class="hljs-keyword">private</span> transient ListState&lt;ActionTask&gt; actionTasksKState;

<span class="hljs-comment">// 初始化状态</span>
actionTasksKState = <span class="hljs-built_in">getRuntimeContext</span>().<span class="hljs-built_in">getListState</span>(
    <span class="hljs-keyword">new</span> ListStateDescriptor&lt;&gt;(<span class="hljs-string">"actionTasks"</span>, TypeInformation.<span class="hljs-built_in">of</span>(ActionTask.<span class="hljs-keyword">class</span>)));
</code></pre>
<h4 data-id="heading-40">4.2 任务调度机制</h4>
<p>ActionExecutionOperator 使用 Flink 的 Mailbox 机制来调度 ActionTask 的执行：</p>
<pre><code class="hljs language-scss" lang="scss">private void <span class="hljs-built_in">processEvent</span>(Object key, Event event) throws Exception {
    <span class="hljs-comment">// ... 处理事件逻辑 ...</span>
    if (isInputEvent) {
        <span class="hljs-comment">// 提交邮件任务来处理 ActionTask</span>
        mailboxExecutor<span class="hljs-selector-class">.submit</span>(() -&gt; <span class="hljs-built_in">tryProcessActionTaskForKey</span>(key), "process action task");
    }
}
</code></pre>
<h4 data-id="heading-41">4.3 任务处理循环</h4>
<p>tryProcessActionTaskForKey 方法实现了持续处理同一个 key 下的多个 ActionTask 的机制：</p>
<pre><code class="hljs language-scss" lang="scss">private void <span class="hljs-built_in">tryProcessActionTaskForKey</span>(Object key) {
    try {
        <span class="hljs-built_in">processActionTaskForKey</span>(key);
    } catch (Exception e) {
        <span class="hljs-comment">// 错误处理</span>
    }
}

private void <span class="hljs-built_in">processActionTaskForKey</span>(Object key) throws Exception {
    <span class="hljs-comment">// 1. 获取待处理的 ActionTask</span>
    ActionTask actionTask = <span class="hljs-built_in">pollFromListState</span>(actionTasksKState);

    if (actionTask == null) {
        <span class="hljs-comment">// 没有更多任务，清状态</span>
        return;
    }

    <span class="hljs-comment">// 2. 执行 ActionTask</span>
    ActionTaskResult result = actionTask<span class="hljs-selector-class">.invoke</span>();

    <span class="hljs-comment">// 3. 处理结果</span>
    if (!result.isFinished()) {
        <span class="hljs-comment">// 如果未完成，将生成的新任务加入队列</span>
        actionTasksKState<span class="hljs-selector-class">.add</span>(result.getGeneratedActionTask()<span class="hljs-selector-class">.get</span>());
    }

    <span class="hljs-comment">// 4. 处理输出事件</span>
    for (Event outputEvent : result.getOutputEvents()) {
        <span class="hljs-built_in">processEvent</span>(key, outputEvent);
    }

    <span class="hljs-comment">// 5. 如果还有任务，继续调度</span>
    if (currentKeyHasMoreActionTask()) {
        mailboxExecutor<span class="hljs-selector-class">.submit</span>(() -&gt; <span class="hljs-built_in">tryProcessActionTaskForKey</span>(key), "process action task");
    }
}        
</code></pre>
<h3 data-id="heading-42">0x05 实际应用示例</h3>
<h4 data-id="heading-43">5.1 异步 HTTP 请求处理</h4>
<p>考虑一个需要调用外部 API 的 Action：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@action(<span class="hljs-params">SomeEvent</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">fetch_external_data</span>(<span class="hljs-params">event, ctx</span>):
    <span class="hljs-comment"># 步骤1: 发起异步HTTP请求</span>
    future = asyncio.create_task(http_client.get(<span class="hljs-string">f"https://api.example.com/data/<span class="hljs-subst">{event.<span class="hljs-built_in">id</span>}</span>"</span>))

    <span class="hljs-comment"># 第一次执行到这里会暂停，返回一个生成器</span>
    response = <span class="hljs-keyword">await</span> future

    <span class="hljs-comment"># 步骤2: 处理响应数据</span>
    processed_data = process_response(response)

    <span class="hljs-comment"># 步骤3: 发送结果事件</span>
    ctx.send_event(ResultEvent(processed_data))
</code></pre>
<p>这个 Action 会被拆分为多个 ActionTask：</p>
<ul>
<li>初始任务：发起 HTTP 请求并等待</li>
<li>后续任务：处理响应并发送结果</li>
</ul>
<h4 data-id="heading-44">5.2 复杂业务流程处理</h4>
<p>一个多步骤的业务流程也可能被拆分：</p>
<pre><code class="hljs language-csharp" lang="csharp">@action(OrderEvent)
<span class="hljs-function">def <span class="hljs-title">process_order</span>(<span class="hljs-params"><span class="hljs-keyword">event</span>, ctx</span>):
    # 步骤1：验证订单
    <span class="hljs-title">validate_order</span>(<span class="hljs-params"><span class="hljs-keyword">event</span>.order</span>)
    # 步骤2：检查库存（可能需要异步调用）
    inventory_status</span> = check_inventory(<span class="hljs-keyword">event</span>.order.items)
    <span class="hljs-meta"># 步骤3：处理支付（可能需要异步调用）</span>
    payment_result = process_payment(<span class="hljs-keyword">event</span>.order)
    <span class="hljs-meta"># 步骤4：更新订单状态</span>
    update_order_status(<span class="hljs-keyword">event</span>.order.id, <span class="hljs-string">"completed"</span>)
    <span class="hljs-meta"># 步骤5：发送通知</span>
    send_notification(<span class="hljs-keyword">event</span>.customer_email, <span class="hljs-string">"Order completed"</span>)
</code></pre>
<p>每个需要等待的步骤都会生成一个新的 ActionTask，确保整个流程正确执行。</p>
<p>通过这种方式，ActionExecutionOperator 能够有效地管理和执行复杂的、可能涉及异步操作的 Action，同时保证状态的一致性和容错能力。</p>
<h3 data-id="heading-45">0xFF 参考</h3>
<p>本文使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmarkdown.com.cn" target="_blank" title="https://markdown.com.cn" ref="nofollow noopener noreferrer">markdown.com.cn</a> 排版</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Netflix工程师的警告：AI正在编写我们看不懂的代码，我们该如何应对？]]></title>    <link>https://juejin.cn/post/7592815497848029247</link>    <guid>https://juejin.cn/post/7592815497848029247</guid>    <pubDate>2026-01-08T12:52:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592815497848029247" data-draft-id="7592865044690944006" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Netflix工程师的警告：AI正在编写我们看不懂的代码，我们该如何应对？"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2026-01-08T12:52:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Nicander"/> <meta itemprop="url" content="https://juejin.cn/user/4397684911516093"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Netflix工程师的警告：AI正在编写我们看不懂的代码，我们该如何应对？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4397684911516093/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Nicander
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T12:52:38.000Z" title="Thu Jan 08 2026 12:52:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;display:inline-block;font-weight:700;background:#ef7060;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(239,112,96,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 50px);border-bottom:3px solid #ef7060}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #3e3e3e;margin-top:32px;margin-bottom:32px;height:1px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(27,31,35,.05);color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:JetBranins Mono,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px;background-color:#fdfdfd}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fdfdfd}.markdown-body a{text-decoration:none;font-weight:700;color:#ef7060;border-bottom:1px solid #ef7060}.markdown-body a:active,.markdown-body a:hover{color:#ef2d26}.markdown-body table tr td,.markdown-body table tr th{border:1px solid #ccc;padding:5px 10px}.markdown-body table{display:block!important;width:auto;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{background:#f0f0f0;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f8f8f8}.markdown-body blockquote{margin-inline-start:0;margin-inline-end:0;border-left:3px solid #ef7060;background:#fff9f9;padding:1px 20px;margin-top:20px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-light">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p>Netflix工程师Jake Nations演讲分享:</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV16PB8B1Ep8%2F%3Fspm_id_from%3D333.337.search-card.all.click" target="_blank" title="https://www.bilibili.com/video/BV16PB8B1Ep8/?spm_id_from=333.337.search-card.all.click" ref="nofollow noopener noreferrer">无限软件危机：Netflix 的 Jake Nations 解析 | AI Engineer</a></p>
</blockquote>
<p>我得坦白一件事：我曾经发布过自己并不完全理解的代码。这些代码由AI生成，通过了测试，也成功部署了，但我却无法解释它的工作原理。Netflix的工程师Jake Nations在他的演讲中以这样一句坦诚的开场白，揭示了当下软件开发领域一个日益严峻的现实。他甚至断言：“我敢打赌，在座的每一位都做过同样的事。”</p>
<p>这正是我们面临的核心矛盾：一方面，AI工具以前所未有的速度加速着软件开发，那些积压数年的重构项目如今得以完成；另一方面，它也催生了一个致命的新问题——我们对自己部署的代码，理解正在迅速减少。当系统在深夜发生故障时，我们还能像过去一样自信地进行调试吗？</p>
<p>这篇文章将为你提炼Jake Nations演讲中最具冲击力的观点，并探讨我们该如何在这场由AI驱动的变革中，重新夺回对代码和系统的主导权。</p>
<hr/>
<h2 data-id="heading-0">1. 我们掉进了“简单”与“容易”的陷阱</h2>
<p>我们面临的第一个问题，源于对两个词的根本性混淆：我们把“简单”（simple）和“容易”（easy）搞混了，而AI工具恰恰利用了这种混淆。</p>
<p>Clojure语言的创造者Rich Hickey曾对这两个概念做出过精辟的区分：</p>
<ul>
<li><strong>简单（Simple）</strong> 意味着“一褶、一辫、无缠结”（one fold, one braid, and no entanglement）。它关乎事物的结构，指的是各个部分只做一件事，互不纠缠，从而使整个系统清晰、可被理解。</li>
<li><strong>容易（Easy）</strong> 则意味着“邻近的、触手可及的、不费力的”（adjacent, within reach, without effort）。它关乎我们完成任务所需的精力，比如从Stack Overflow复制粘贴代码，或是安装一个“神奇”的框架。</li>
</ul>
<p>简单需要思考、设计和解耦，而容易则唾手可及。AI正是那个“终极的容易按钮”。它让获取代码的路径变得如此 frictionless（无摩擦），以至于我们常常忽略了那条需要更多前期思考的“简单”之路。</p>
<p>每一次我们选择容易，都是在选择当下的速度，以及未来的复杂性。</p>
<p>这种取舍之所以变得危险，是因为AI彻底打破了过去的平衡。在过去，复杂性是在代码库中缓慢累积的，我们有时间去重构、反思和重建。而现在，AI让复杂性以指数级速度复合增长，系统在我们意识到之前，就已经变得难以管理。</p>
<hr/>
<h2 data-id="heading-1">2. AI是盲目的：它将你的技术债误认为是一种模式</h2>
<p>AI工具的一个致命缺陷是：它缺乏辨别优劣的上下文。在AI眼里，你代码库中的所有代码都是需要保留和模仿的“模式”，它无法区分什么是精心设计的架构，什么是日积月累的技术债。</p>
<p>《人月神话》的作者Fred Brooks曾提出过两种复杂性：</p>
<ul>
<li><strong>本质复杂性（Essential Complexity）：</strong> 这是你试图解决的问题本身固有的难度。例如，“用户需要为商品付款”这个业务需求就是本质复杂性。</li>
<li><strong>意外复杂性（Accidental Complexity）：</strong> 这是我们在开发过程中附加的复杂性，比如临时性的变通方案、过时的抽象层、防御性代码等等。</li>
</ul>
<p>问题就在于，当AI分析你的代码库时，它会将这两种复杂性一视同仁。技术债在它看来不是“债”，只是更多需要被复制的代码模式。</p>
<p>Jake Nations分享了一个Netflix的真实案例。他们曾尝试使用AI来重构一个旧的授权系统。结果AI失败了。原因是，旧代码中的业务逻辑和授权逻辑已经紧密地<strong>交织在一起</strong>：权限检查被编织进业务流程，角色假设被<strong>固化在</strong>数据模型中，授权调用散布在数百个文件中。当AI代理开始重构时，它根本无法理清这种纠缠，常常在处理了几个文件后就因为无法解开依赖关系而<strong>陷入死循环然后放弃</strong>。更糟糕的是，它有时会试图保留旧系统的逻辑，用新的系统重新实现旧的、糟糕的设计模式。</p>
<p>只有具备上下文和经验的人类工程师，才能分辨出哪些是必须保留的精华，哪些是历史遗留的糟粕。但这需要我们慢下来思考——而AI的速度恰恰在阻止我们这样做。</p>
<hr/>
<h2 data-id="heading-2">3. 真正的危险：我们正在丧失识别问题的直觉</h2>
<p>比发布难以理解的代码更危险的，是我们作为开发者正在丧失识别复杂性的能力。</p>
<p>工程师那种“这个架构很危险”的直觉，并非与生俱来。这种模式识别能力，几乎完全是通过维护和调试失败的惨痛经历建立起来的。正如Nations所说：“当我能发现一个危险的架构时，那是因为我就是那个<strong>凌晨三点</strong>处理它引发的故障的人。”</p>
<p>然而，<strong>当你不再理解自己的系统时，这种直觉就会萎缩</strong>。我们把思考外包给了AI，跳过了那些本可以磨练我们模式识别能力的关键过程。</p>
<p>AI只会生成你要求的东西。它不会编码从过去失败中吸取的教训。</p>
<p>长此以往，我们将培养出一代只能快速生成代码，却缺乏深度理解去维护、调试或安全地演进复杂系统的开发者。这才是AI带来的最大风险。</p>
<hr/>
<h2 data-id="heading-3">4. 解决方案：用“三阶段法”重新掌握主导权</h2>
<p>面对这个困境，我们并非束手无策。Jake Nations提出了一套与AI协作的“三阶段法”。这不仅仅是一个工作流程，更是一种<strong>将人类的理解压缩成可快速评审的工件</strong>的纪律，旨在将战略思考牢牢掌握在人类手中，同时利用AI加速机械化的执行部分。</p>
<ul>
<li><strong>第一阶段：研究 (Research)</strong> 在这一阶段，我们不仅仅是把上下文信息——如架构图、设计文档——投喂给AI。这是一个<strong>反复探查</strong>的过程。我们会追问AI（“缓存策略是怎样的？”），<strong>纠正</strong>它的分析，<strong>补充</strong>它缺失的上下文。这个过程的最终产出，是一份浓缩的**“单一研究文档”**。它将数小时的探索压缩成几分钟的阅读，清晰地呈现了系统的现状、组件关系以及变更可能带来的影响。在这一阶段，设立一个“人类校验点”至关重要，由我们来验证AI的分析是否符合现实。</li>
<li><strong>第二阶段：规划 (Planning)</strong> 基于经过验证的研究成果，由人类主导，创建一个极其详尽的实现计划。这份计划需要详尽到可以称之为**“按数字填色”（paint by numbers）<strong>的级别——即使是团队里最初级的工程师，也能精确地照着它完成工作。这一步的真正魔力在于</strong>评审速度**：一份详尽的计划可以在几分钟内得到验证，而评审数千行AI生成的代码则可能需要数小时甚至数天。</li>
<li><strong>第三阶段：实施 (Implementation)</strong> 当有了一份清晰、明确、经过审查的计划后，最后一步才是让AI来执行。由于所有的思考和决策都已前置完成，我们可以将执行工作委托给一个**“后台代理”（background agent）**。开发者可以去处理其他任务，稍后再回来评审结果。评审过程也变得飞快，因为你只需验证代码是否符合计划，而无需从头理解任何新创造的逻辑。</li>
</ul>
<p>这一方法有一个至关重要的前提：<strong>你必须首先通过手动实践来赢得理解（earn the understanding）</strong>。就像Netflix的授权系统重构一样，团队必须先手动完成一个模块的迁移，才能真正摸清所有隐藏的约束和依赖，并为AI提供一个干净的、可供学习的范例。这是有效利用AI进行重构的入场券，没有捷径可走。</p>
<hr/>
<h2 data-id="heading-4">5. 最后的思考：我们为何而写代码？</h2>
<p>AI改变了我们编写代码的_方式_，但它没有改变软件工程失败的_原因_。每一代工程师都面临着自己的“软件危机”，而我们的解决方案，不应是另一个更强大的工具，而是回归到软件工程最核心的认知。</p>
<p>我们必须记住一个永恒的真理：<strong>软件是一项人类事业</strong>。正如演讲中所说：“软件开发最难的部分，从来不是敲代码，而是知道该敲什么代码。”</p>
<p>在这场变革中，最终能够脱颖而出的开发者，不会是那些生成代码最多的人，而是那些真正理解自己正在构建什么的人。</p>
<p>Jake Nations最后留给我们的，是一个值得所有人深思的问题：</p>
<p>问题不在于我们是否会使用AI……问题在于，当AI编写我们大部分代码时，我们是否还能理解我们自己的系统。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一批优质 AI 域名转让（.ai）｜适合 AI 创业 / 产品 / 公司品牌]]></title>    <link>https://juejin.cn/post/7592815497847914559</link>    <guid>https://juejin.cn/post/7592815497847914559</guid>    <pubDate>2026-01-08T11:32:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592815497847914559" data-draft-id="7592856733182509092" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 一批优质 AI 域名转让（.ai）｜适合 AI 创业 / 产品 / 公司品牌"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-08T11:32:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="数擎AI"/> <meta itemprop="url" content="https://juejin.cn/user/2928754707402423"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             一批优质 AI 域名转让（.ai）｜适合 AI 创业 / 产品 / 公司品牌
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2928754707402423/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    数擎AI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T11:32:38.000Z" title="Thu Jan 08 2026 11:32:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>说明</strong>：以下域名均为本人自持，因精力聚焦核心项目，现转让部分优质 AI 域名。<br/>
<strong>官网地址</strong>：<code>https://shuqin.cc</code> or <code>https://shuqing.ai</code>。<br/>
**微信：fangcunai / 邮箱：<a href="https://link.juejin.cn?target=mailto%3A15992478448%40163.com" target="_blank" title="mailto:15992478448@163.com" ref="nofollow noopener noreferrer">15992478448@163.com</a></p>
</blockquote>
<h2 data-id="heading-0">为什么选择 <code>.ai</code> 域名？</h2>
<ul>
<li>
<p><code>.ai</code> 已成为 <strong>人工智能领域事实标准后缀</strong></p>
</li>
<li>
<p>国际化程度高，适合出海与品牌升级</p>
</li>
<li>
<p>非常适合以下场景：</p>
<ul>
<li>AI 工具 / AI 平台</li>
<li>企业服务（ToB）</li>
<li>内容生成 / 多模态</li>
<li>智能系统 / 数据平台</li>
</ul>
</li>
</ul>
<h2 data-id="heading-1">🔥 核心推荐（优先转让）</h2>
<h3 data-id="heading-2"><strong>fengkong.ai</strong></h3>
<p><strong>关键词：风控 / 金融 AI / 企业级系统</strong></p>
<ul>
<li>“风控”是金融、支付、信贷的刚需词</li>
<li>适合：反欺诈、智能风控、AI 决策平台</li>
<li>ToB 属性极强，商业变现路径清晰</li>
</ul>
<p>👉 <strong>金融科技 / AI SaaS 团队优先推荐</strong></p>
<h3 data-id="heading-3"><strong>intv.ai</strong></h3>
<p><strong>关键词：品牌缩写 / 国际化 / 智能 TV / Interview</strong></p>
<ul>
<li>4 字母短域名，极强品牌感</li>
<li>可扩展含义：Intelligent TV / Interview / International Vision</li>
<li>非常适合国际化 AI 产品</li>
</ul>
<p>👉 <strong>品牌型项目优先</strong></p>
<h3 data-id="heading-4"><strong>shuying.ai</strong></h3>
<p><strong>关键词：数影 / 书影 / AI 内容 / 影像生成</strong></p>
<ul>
<li>适合 AI 视频、图像、内容生成方向</li>
<li>中文语义友好，易传播</li>
<li>品牌想象空间大</li>
</ul>
<h3 data-id="heading-5"><strong>yuanxu.ai</strong></h3>
<p><strong>关键词：源序 / 元序 / AI 底层系统</strong></p>
<ul>
<li>偏底层、系统级品牌</li>
<li>适合模型平台、Agent 框架、基础设施类项目</li>
<li>气质偏“技术派”</li>
</ul>
<h3 data-id="heading-6"><strong>qianyuan.ai</strong></h3>
<p><strong>关键词：前沿 / 乾元 / AI 前沿技术</strong></p>
<ul>
<li>适合研究型团队、技术品牌</li>
<li>有“前沿科技”语义加成</li>
<li>适合中长期品牌建设</li>
</ul>
<hr/>
<h2 data-id="heading-7">🧩 场景型优质域名（适合垂直方向）</h2>
<ul>
<li><strong>xietong.ai</strong> —— 协同办公 / 协同智能</li>
<li><strong>fangcun.ai</strong> —— AI 工具 / 效率产品</li>
<li><strong>yuyuan.ai</strong> —— 语源 / 多模态 / 语言模型</li>
<li><strong>furong.ai</strong> —— 内容 / 城市 / 文化类 AI</li>
<li><strong>shuqing.ai</strong> —— 情感 / 内容生成 / IP 型项目</li>
<li><strong>shugu.ai</strong> —— 教育 / 数据 / 知识平台</li>
<li><strong>kangle.ai</strong> —— 健康 / 医疗 AI</li>
</ul>
<h2 data-id="heading-8">⚠️ 说明与共识</h2>
<ul>
<li>所有域名 <strong>可正常过户</strong></li>
<li>价格按市场理性成交，不做虚高</li>
<li>优先转让给 <strong>真实使用的终端项目</strong></li>
<li>不接受低价倒卖</li>
</ul>
<h2 data-id="heading-9">📮 联系方式</h2>
<p>如你对其中某个域名感兴趣，可直接联系我：</p>
<ul>
<li><strong>微信fangcunai / 邮箱<a href="https://link.juejin.cn?target=mailto%3A15992478448%40163.com" target="_blank" title="mailto:15992478448@163.com" ref="nofollow noopener noreferrer">15992478448@163.com</a>/ 站内私信:<a href="https://link.juejin.cn?target=https%3A%2F%2Fshuqin.cc" target="_blank" title="https://shuqin.cc" ref="nofollow noopener noreferrer">shuqin.cc</a></strong></li>
<li>说明你关注的域名 + 项目用途，沟通会更高效</li>
</ul>
<blockquote>
<p>域名的价值不在“囤”，而在“被真正使用”。<br/>
希望这些域名能进入真正需要它们的项目中。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring Boot 3.3.x、3.4.x、3.5.x 深度对比与演进分析]]></title>    <link>https://juejin.cn/post/7592787377656594466</link>    <guid>https://juejin.cn/post/7592787377656594466</guid>    <pubDate>2026-01-08T11:44:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592787377656594466" data-draft-id="7592787377656578082" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" Spring Boot 3.3.x、3.4.x、3.5.x 深度对比与演进分析 "/> <meta itemprop="keywords" content="后端,Java,架构"/> <meta itemprop="datePublished" content="2026-01-08T11:44:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="颜淡慕潇"/> <meta itemprop="url" content="https://juejin.cn/user/4494459266678318"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             Spring Boot 3.3.x、3.4.x、3.5.x 深度对比与演进分析 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4494459266678318/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    颜淡慕潇
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T11:44:08.000Z" title="Thu Jan 08 2026 11:44:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e2f7266619af4852a44ad1c11b9a0a38~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aKc5reh5oWV5r2H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768477448&amp;x-signature=tHAeSpNshyahxzb0TolUqVeseIE%3D" alt="002.png" loading="lazy"/>
本文从 <strong>“架构师 / 技术负责人视角”的角度</strong>。进一步 <strong>拉开层次、拉深分析深度</strong>，不只是“版本有什么”，而是回答：</p>
<blockquote>
<p><strong>为什么要升？什么时候升？升到哪一条线风险最低？不同类型系统怎么选？</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-0">一、背景：Spring Boot 3.x 已进入“成熟期”</h2>
<p>从 2023 年 Spring Boot 3.0 正式落地 Jakarta EE 9+ 开始，3.x 系列本质上经历了三个阶段：</p>
<ol>
<li>
<p><strong>3.0–3.2：平台迁移期</strong></p>
<ul>
<li>Java EE → Jakarta EE</li>
<li>Spring Framework 6</li>
<li>Java 17 成为最低门槛</li>
</ul>
</li>
<li>
<p><strong>3.3–3.4：能力完善期</strong></p>
<ul>
<li>性能、可观测性、云原生</li>
<li>虚拟线程、结构化日志开始“可用”</li>
</ul>
</li>
<li>
<p><strong>3.5 及以后：生产成熟期</strong></p>
<ul>
<li>默认配置更偏生产</li>
<li>云原生与容器优先</li>
<li>运维、可观测、安全能力系统化</li>
</ul>
</li>
</ol>
<p><strong>本文聚焦的 3.3 / 3.4 / 3.5，正好覆盖“成熟期的三个关键节点”。</strong></p>
<hr/>
<h2 data-id="heading-1">二、版本线与生命周期：先看“能不能用”，再谈“好不好用”</h2>
<h3 data-id="heading-2">1️⃣ 版本与支持状态总览（2026 视角）</h3>

































<table><thead><tr><th>版本线</th><th>初始发布时间</th><th>当前状态</th><th>社区支持</th><th>技术定位</th></tr></thead><tbody><tr><td>3.3.x</td><td>2024-05</td><td>❌ 已退役</td><td>已结束</td><td>过渡稳定</td></tr><tr><td>3.4.x</td><td>2024-11</td><td>⚠ EOL</td><td>即将/已结束</td><td>中期增强</td></tr><tr><td>3.5.x</td><td>2025-05</td><td>✅ 主流</td><td>活跃维护</td><td>生产主线</td></tr></tbody></table>
<p><strong>结论一句话</strong>：</p>
<blockquote>
<p><strong>3.3/3.4 是“曾经稳定”，3.5 是“当前正确”。</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-3">2️⃣ 最新小版本 &amp; 最稳定小版本（非常关键）</h3>
<p>这是你在生产环境最关心的部分：</p>





























<table><thead><tr><th>版本线</th><th>最新小版本</th><th>最稳定小版本</th><th>建议态度</th></tr></thead><tbody><tr><td>3.3.x</td><td>3.3.6</td><td>3.3.6</td><td>❌ 仅存量系统</td></tr><tr><td>3.4.x</td><td>3.4.13</td><td>3.4.5</td><td>❌ 不建议新用</td></tr><tr><td>3.5.x</td><td>3.5.9</td><td>3.5.9</td><td>✅ 强烈推荐</td></tr></tbody></table>
<blockquote>
<p>⚠ <strong>一个重要原则</strong><br/>
在 Spring Boot 的节奏下：<br/>
<strong>“最新小版本 = 最稳定小版本”</strong><br/>
因为小版本几乎只修 Bug 和安全问题，不引入破坏性变更。</p>
</blockquote>
<hr/>
<h2 data-id="heading-4">三、底层技术栈演进：不是“功能差异”，而是“架构重心转移”</h2>
<h3 data-id="heading-5">1️⃣ Java 与 JVM 生态支持</h3>



































<table><thead><tr><th>维度</th><th>3.3.x</th><th>3.4.x</th><th>3.5.x</th></tr></thead><tbody><tr><td>最低 Java</td><td>17</td><td>17</td><td>17</td></tr><tr><td>推荐 Java</td><td>17 / 21</td><td>21</td><td><strong>21 / 23</strong></td></tr><tr><td>Loom 支持</td><td>实验级</td><td>可生产</td><td><strong>默认友好</strong></td></tr><tr><td>CDS / 启动优化</td><td>基础</td><td>改进</td><td><strong>成熟</strong></td></tr></tbody></table>
<p><strong>深度解读</strong>：</p>
<ul>
<li><strong>3.3.x</strong>：还能“兼容 17 心态”</li>
<li><strong>3.4.x</strong>：开始为 Java 21 做准备</li>
<li><strong>3.5.x</strong>：明显假设你“已经在用 21”</li>
</ul>
<blockquote>
<p>如果你现在还在 <strong>JDK 17</strong>：<br/>
👉 3.5 依然没问题，但<strong>最佳实践已经指向 21</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-6">四、性能与并发模型：从“线程池”到“调度模型”</h2>
<h3 data-id="heading-7">1️⃣ 虚拟线程（Virtual Threads）的演进</h3>





























<table><thead><tr><th>方面</th><th>3.3.x</th><th>3.4.x</th><th>3.5.x</th></tr></thead><tbody><tr><td>支持状态</td><td>可用但谨慎</td><td>推荐使用</td><td><strong>生产默认候选</strong></td></tr><tr><td>Web MVC</td><td>需显式配置</td><td>支持更好</td><td><strong>深度优化</strong></td></tr><tr><td>JDBC / 阻塞调用</td><td>风险存在</td><td>改善</td><td><strong>适配度高</strong></td></tr></tbody></table>
<p><strong>关键变化不在“能不能用”，而在“敢不敢用”</strong> ：</p>
<ul>
<li>3.3：技术预览</li>
<li>3.4：架构师尝试</li>
<li>3.5：可以写进架构规范</li>
</ul>
<hr/>
<h3 data-id="heading-8">2️⃣ 启动速度与内存模型</h3>
<ul>
<li>3.3 引入 CDS + AOT 改善</li>
<li>3.4 优化 Bean 初始化顺序</li>
<li><strong>3.5 针对容器启动、K8s 滚动发布显著优化</strong></li>
</ul>
<p>👉 对 <strong>微服务 / Serverless / 弹性扩缩容</strong> 非常关键</p>
<hr/>
<h2 data-id="heading-9">五、可观测性（Observability）：从“可选能力”到“默认能力”</h2>
<h3 data-id="heading-10">1️⃣ 日志体系的质变：结构化日志</h3>





























<table><thead><tr><th>维度</th><th>3.3.x</th><th>3.4.x</th><th>3.5.x</th></tr></thead><tbody><tr><td>JSON 日志</td><td>需自配</td><td>半自动</td><td><strong>官方推荐</strong></td></tr><tr><td>TraceId 贯通</td><td>基础</td><td>改进</td><td><strong>默认更合理</strong></td></tr><tr><td>云日志平台</td><td>需适配</td><td>友好</td><td><strong>原生友好</strong></td></tr></tbody></table>
<p><strong>这是一个质变点</strong>：<br/>
Spring Boot 3.5 明显假设你的日志会被 <strong>ELK / Loki / OpenTelemetry</strong> 消费，而不是人肉 grep。</p>
<hr/>
<h3 data-id="heading-11">2️⃣ Metrics / Tracing</h3>
<ul>
<li>Micrometer 全线升级</li>
<li>Prometheus / OTEL 体验逐代改善</li>
<li>3.5 中自动配置“更激进但更合理”</li>
</ul>
<hr/>
<h2 data-id="heading-12">六、安全与配置模型：从“可配置”到“安全默认”</h2>
<h3 data-id="heading-13">1️⃣ Spring Security 生态</h3>





























<table><thead><tr><th>维度</th><th>3.3.x</th><th>3.4.x</th><th>3.5.x</th></tr></thead><tbody><tr><td>Security 默认策略</td><td>保守</td><td>收紧</td><td><strong>更安全</strong></td></tr><tr><td>SSL / Service Connection</td><td>基础</td><td>改善</td><td><strong>一等公民</strong></td></tr><tr><td>OAuth2 / JWT</td><td>稳定</td><td>成熟</td><td><strong>生产友好</strong></td></tr></tbody></table>
<blockquote>
<p><strong>升级风险点提醒</strong><br/>
3.5 对部分安全默认值更严格<br/>
👉 老项目升级必须跑完整回归测试</p>
</blockquote>
<hr/>
<h2 data-id="heading-14">七、云原生与容器：3.5 是“为 K8s 而生”</h2>
<h3 data-id="heading-15">1️⃣ 容器化能力对比</h3>





























<table><thead><tr><th>能力</th><th>3.3.x</th><th>3.4.x</th><th>3.5.x</th></tr></thead><tbody><tr><td>Buildpacks</td><td>支持</td><td>优化</td><td><strong>最佳实践</strong></td></tr><tr><td>K8s 探针</td><td>可用</td><td>改进</td><td><strong>深度集成</strong></td></tr><tr><td>Service Binding</td><td>基础</td><td>改善</td><td><strong>成熟</strong></td></tr></tbody></table>
<p><strong>3.5 明确是“云原生优先设计”</strong><br/>
如果你是：</p>
<ul>
<li>微服务</li>
<li>Kubernetes</li>
<li>云托管数据库</li>
</ul>
<p>👉 <strong>3.5 没有替代选项</strong></p>
<hr/>
<h2 data-id="heading-16">八、升级路径与风险控制（非常实战）</h2>
<h3 data-id="heading-17">1️⃣ 不同起点的推荐路径</h3>





















<table><thead><tr><th>当前版本</th><th>推荐路径</th></tr></thead><tbody><tr><td>3.0–3.2</td><td>3.2 → 3.3 → 3.5</td></tr><tr><td>3.3.x</td><td><strong>3.3 → 3.5（可跳过 3.4）</strong></td></tr><tr><td>3.4.x</td><td>直接 3.5</td></tr></tbody></table>
<h3 data-id="heading-18">2️⃣ 核心风险点清单</h3>
<ul>
<li>Spring Security 默认行为变化</li>
<li>日志格式变化（JSON）</li>
<li>Executor / Task 配置差异</li>
<li>少量自动配置 Bean 行为调整</li>
</ul>
<p>👉 <strong>但都不是“架构级破坏”</strong></p>
<hr/>
<h2 data-id="heading-19">九、最终选型建议（结论版）</h2>
<h3 data-id="heading-20">✅ 新项目</h3>
<blockquote>
<p><strong>无条件选 Spring Boot 3.5.x 最新小版本</strong></p>
</blockquote>
<p>理由：</p>
<ul>
<li>生命周期最长</li>
<li>云原生最成熟</li>
<li>Java 21 最佳拍档</li>
</ul>
<hr/>
<h3 data-id="heading-21">✅ 老项目（企业级）</h3>

























<table><thead><tr><th>场景</th><th>建议</th></tr></thead><tbody><tr><td>追求稳定</td><td>3.5.x</td></tr><tr><td>技术债多</td><td>分阶段升级</td></tr><tr><td>高并发</td><td>3.5 + Virtual Threads</td></tr><tr><td>云原生</td><td>3.5 必选</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-22">十、一句话总结</h2>
<blockquote>
<p><strong>Spring Boot 3.3 是“能用”，3.4 是“好用”，3.5 是“该用”。</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[WebAssembly入门（一）——Emscripten]]></title>    <link>https://juejin.cn/post/7592823500416090138</link>    <guid>https://juejin.cn/post/7592823500416090138</guid>    <pubDate>2026-01-08T11:30:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592823500416090138" data-draft-id="7592816646869041161" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="WebAssembly入门（一）——Emscripten "/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2026-01-08T11:30:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="布列瑟农的星空"/> <meta itemprop="url" content="https://juejin.cn/user/976022056218471"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            WebAssembly入门（一）——Emscripten 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/976022056218471/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    布列瑟农的星空
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T11:30:45.000Z" title="Thu Jan 08 2026 11:30:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">WebAssembly介绍</h2>
<p>WebAssembly，简单来说，是一种浏览器可执行的代码格式，诸如 C、C++ 和 Rust 等源语言能够编译为WebAssembly代码，并暴露可供js调用的函数，使得js能够利用接近原生的速度完成一些逻辑。</p>
<p>关于WebAssembly的介绍，MDN已经足够详细了，<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWebAssembly%2FGuides%2FConcepts" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/WebAssembly/Guides/Concepts" ref="nofollow noopener noreferrer">developer.mozilla.org/zh-CN/docs/…</a>  ,不再赘述。</p>
<h2 data-id="heading-1">Emscripten 介绍和安装</h2>
<p>Emscripten 是一个基于 LLVM/Clang 的开源编译器工具链，核心是将 C/C++ 等原生代码编译为 WebAssembly（Wasm）和 JavaScript “胶水代码”，让高性能原生程序与库能在浏览器、Node.js 及其他 Wasm 运行时高效执行，性能接近原生，是原生代码向 Web 迁移的核心工具。更多信息可访问官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Femscripten.org%2Fdocs%2Findex.html" target="_blank" title="https://emscripten.org/docs/index.html" ref="nofollow noopener noreferrer">emscripten.org/docs/index.…</a></p>
<h3 data-id="heading-2">安装</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Get the emsdk repo</span>
git <span class="hljs-built_in">clone</span> https://github.com/emscripten-core/emsdk.git

<span class="hljs-comment"># Enter that directory</span>
<span class="hljs-built_in">cd</span> emsdk
<span class="hljs-comment"># Fetch the latest version of the emsdk (not needed the first time you clone)</span>
git pull

<span class="hljs-comment"># Download and install the latest SDK tools.</span>
./emsdk install latest

<span class="hljs-comment"># Make the "latest" SDK "active" for the current user. (writes .emscripten file)</span>
./emsdk activate latest

<span class="hljs-comment"># Activate PATH and other environment variables in the current terminal</span>
<span class="hljs-built_in">source</span> ./emsdk_env.sh
</code></pre>
<p>注：windows系统用<code>emsdk.bat</code>替换上述命令中的<code>emsdk</code>，用<code>emsdk_env.bat</code>替换上述命令中的<code>source ./emsdk_env.sh</code>。</p>
<h4 data-id="heading-3">安装验证</h4>
<p>在 Emscripten 的安装目录下打开终端，执行以下命令检查是否安装成功</p>
<pre><code class="hljs language-bash" lang="bash">./emcc --check
</code></pre>
<p>注：</p>
<ul>
<li><strong>windows系统</strong>，通过在文件中找到并打开<strong>emcmdprompt.bat</strong>来启动该提示符，在其他命令行中是找不到emcc的。</li>
<li><strong>在 Windows 系统中，使用emcc</strong>而不是 <strong>./emcc</strong>来调用该工具。</li>
</ul>
<p>安装成功后check的输出如下：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d88e077f6d0429dbea009a7830a2562~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5biD5YiX55Gf5Yac55qE5pif56m6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768476644&amp;x-signature=FRGyKCcGC%2Fw0sYLqrPt%2FwVk2K6c%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-4">入门实践</h2>
<h3 data-id="heading-5">hello world</h3>
<p>准备基础测试文件：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// test.c</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Hello from Emscripten!\n"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>执行编译</p>
<pre><code class="hljs language-bash" lang="bash">emcc test.c -o test.html <span class="hljs-comment"># 生成test.html + test.js + test.wasm</span>
</code></pre>
<p>启动本地服务器，打开test.html</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d77489e4e11f4aa496313dd1e0d1bd29~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5biD5YiX55Gf5Yac55qE5pif56m6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768476644&amp;x-signature=baYlgl0jBz9WM26CbHL9jnrmyHo%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-6">生成文件介绍</h4>
<h5 data-id="heading-7">test.html</h5>
<p><code>test.html</code> 是 Emscripten 自动生成的<strong>完整 HTML 页面</strong>，本质是一个开箱即用的前端载体，核心作用是：</p>
<ul>
<li><strong>作为 Wasm/JS 代码的运行容器</strong>：内置了加载 <code>test.js</code>（胶水代码）的逻辑，无需你手动写 HTML 引入脚本；</li>
<li><strong>提供基础的交互界面</strong>：默认包含一个简单的页面结构，以及控制台输出区域（用于显示 C 代码中 <code>printf</code>/<code>puts</code> 等函数的输出）；</li>
<li><strong>简化测试流程</strong>：直接在本地服务器打开就可以运行，无需额外编写 HTML 代码。</li>
</ul>
<h5 data-id="heading-8">test.js</h5>
<p><code>test.js</code> 是整个编译产物的<strong>核心</strong>，也是 Emscripten 最关键的输出文件之一，被称为 “胶水代码”，作用是<strong>连接 JavaScript 环境和 Wasm 模块</strong>，填补两者的差异。</p>
<p>它包含以下核心功能（按执行顺序）：</p>
<p>（1）Wasm 模块的加载与实例化</p>
<p>自动处理 <code>test.wasm</code>（编译时同步生成的 Wasm 文件）的加载、解析和实例化，无需你手动调用 <code>WebAssembly.instantiate</code>。</p>
<p>（2）Emscripten 运行时初始化</p>
<p>初始化 Wasm 运行所需的环境：</p>
<ul>
<li>线性内存（Memory）管理；</li>
<li>虚拟文件系统（MEMFS/IDBFS）（模拟 C 的文件操作，如 <code>fopen</code>/<code>fwrite</code>）；</li>
<li>系统调用模拟（如 <code>exit</code>/<code>time</code>）；</li>
<li>错误处理和日志输出。</li>
</ul>
<p>（3）C/JS 互操作桥梁</p>
<ul>
<li>封装 C 函数的调用逻辑：把 Wasm 中的函数（如下划线前缀的 <code>_main</code>）映射为更友好的 JS 调用方式；</li>
<li>处理 C 标准库输出：把 C 代码中 <code>printf</code>/<code>puts</code> 的输出重定向到 HTML 页面的控制台区域；</li>
<li>暴露运行时 API：如 <code>ccall</code>/<code>cwrap</code>（用于 JS 调用 C 函数）、<code>FS</code>（文件系统操作）等。</li>
</ul>
<p>（4）自动执行 C 的 <code>main</code> 函数</p>
<p>默认情况下，<code>test.js</code> 初始化完成后会自动调用 C 代码中的 <code>main</code> 函数，这也是为什么你编译的 C 程序能直接在浏览器中运行。</p>
<p><strong>在实践中，我们不一定需要使用编译生成的胶水代码，很多时候自己手动管理wasm更方便。</strong></p>
<h5 data-id="heading-9">test.wasm</h5>
<p>执行 C 代码编译后的指令（如 main 函数、sum 函数）</p>
<h3 data-id="heading-10">js调用wasm函数</h3>
<p>这个demo中我们不生成胶水代码，使用原生api调用wasm。</p>
<p>准备c文件：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// calc.c</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">sum</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span>
{
    <span class="hljs-keyword">return</span> a + b;
}
<span class="hljs-type">int</span> <span class="hljs-title function_">minus</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span>
{
    <span class="hljs-keyword">return</span> a - b;
}
</code></pre>
<p>执行编译</p>
<pre><code class="hljs language-bash" lang="bash">emcc calc.c -o calc.wasm  -s EXPORTED_FUNCTIONS=_sum,_minus --no-entry
</code></pre>
<p>编写html和js加载wasm</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>WASM Calc Demo<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>WASM Calculator<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"output"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
      (<span class="hljs-keyword">async</span> () =&gt; {
        <span class="hljs-comment">// 加载 wasm 文件</span>
        <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">"calc.wasm"</span>);
        <span class="hljs-keyword">const</span> buffer = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">arrayBuffer</span>();
        <span class="hljs-keyword">const</span> wasmModule = <span class="hljs-keyword">await</span> <span class="hljs-title class_">WebAssembly</span>.<span class="hljs-title function_">instantiate</span>(buffer);

        <span class="hljs-comment">// 导出的方法都在 instance.exports 里</span>
        <span class="hljs-keyword">const</span> { sum, minus } = wasmModule.<span class="hljs-property">instance</span>.<span class="hljs-property">exports</span>;
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(wasmModule);
        <span class="hljs-comment">// 调用并显示结果</span>
        <span class="hljs-keyword">const</span> a = <span class="hljs-number">7</span>,
          b = <span class="hljs-number">3</span>;
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"output"</span>).<span class="hljs-property">innerHTML</span> = <span class="hljs-string">`
        sum(<span class="hljs-subst">${a}</span>, <span class="hljs-subst">${b}</span>) = <span class="hljs-subst">${sum(a, b)}</span>&lt;br&gt;
        minus(<span class="hljs-subst">${a}</span>, <span class="hljs-subst">${b}</span>) = <span class="hljs-subst">${minus(a, b)}</span>
      `</span>;
      })();
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>效果如下：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7310ef4285ab46ec9ef663bfc23a7556~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5biD5YiX55Gf5Yac55qE5pif56m6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768476644&amp;x-signature=7QbC3%2Be7OrW%2BVLf9Leew48hhPLQ%3D" alt="image.png" loading="lazy"/></p>
<p>注：</p>
<ul>
<li>在 C 语言的 ABI（应用二进制接口）规范里，<strong>大多数平台的链接器会为 C 全局符号加上一个下划线 <code>_</code> 前缀</strong>。<br/>
Emscripten 也遵循了这个传统。你写的 <code>int sum(int a, int b)</code>，编译后实际导出的符号是 <code>_sum</code></li>
<li>一般情况下编译时会找main函数，如果不需要main，可以加参数<code>--no-entry</code>,否则编译会报错</li>
<li>EXPORTED_FUNCTIONS参数不是必须，编译时可以根据文件内容生成导出的函数。但如果函数<strong>既没有被 C 代码调用，也没有被正确导出</strong>，Emscripten 可能会认为它没用，直接去掉它。因此可以修改代码，添加<code>EMSCRIPTEN_KEEPALIVE</code></li>
</ul>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// calc.c</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;emscripten/emscripten.h&gt;</span></span>

EMSCRIPTEN_KEEPALIVE
<span class="hljs-type">int</span> <span class="hljs-title function_">sum</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span>
{
    <span class="hljs-keyword">return</span> a + b;
}
EMSCRIPTEN_KEEPALIVE
<span class="hljs-type">int</span> <span class="hljs-title function_">minus</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span>
{
    <span class="hljs-keyword">return</span> a - b;
}

</code></pre>
<p>执行<code>emcc calc.c -o calc.wasm  -s  --no-entry</code>一样能得到两个函数</p>
<h4 data-id="heading-11"/>
<h2 data-id="heading-12">工作原理概览和LLVM/Clang介绍</h2>
<p>Emscripten 的编译流程如下：</p>
<ol>
<li><strong>前端编译</strong>：Clang 将 C/C++ 源码编译为 LLVM IR。</li>
<li><strong>中间优化</strong>：LLVM 与 Binaryen 对 IR 做代码精简、循环优化、死代码消除等。</li>
<li><strong>后端生成</strong>：输出 Wasm 二进制模块（.wasm）与 JavaScript 胶水代码（处理 Wasm 加载、内存管理、API 绑定），可选直接生成可运行的 HTML。</li>
</ol>

<pre><code class="hljs language-javascript" lang="javascript">C/C++ 源码
   ↓
<span class="hljs-title class_">Clang</span>（<span class="hljs-variable constant_">LLVM</span> 前端） → 生成 <span class="hljs-variable constant_">LLVM</span> <span class="hljs-variable constant_">IR</span>
   ↓
<span class="hljs-variable constant_">LLVM</span> 优化器 → 优化 <span class="hljs-variable constant_">LLVM</span> <span class="hljs-variable constant_">IR</span>
   ↓
<span class="hljs-variable constant_">LLVM</span> 后端 → 生成 原始 <span class="hljs-title class_">WebAssembly</span> 模块
   ↓
<span class="hljs-title class_">Binaryen</span>（wasm-opt） → 优化 <span class="hljs-title class_">Wasm</span> 
   ↓
最终输出：优化后的 .<span class="hljs-property">wasm</span> 
</code></pre>
<p>这里出现了一些名词：前端/后端/Clang/LLVM/IR，下面简单介绍下这些概念。</p>
<h3 data-id="heading-13">1. IR（Intermediate Representation，中间表示）</h3>
<p>IR 是编译器在<strong>前端（源码解析）</strong> 和<strong>后端（目标代码生成）</strong> 之间的 “中间语言”，是连接不同源码语言和不同目标平台的桥梁。核心特点如下：</p>
<ul>
<li>与源码语言无关：不管是 C/C++、Rust、Go 还是 Swift，只要能被 LLVM 前端编译，最终都会转换成统一的 IR。</li>
<li>与目标平台无关：IR 不包含任何 CPU 架构、操作系统的特有指令，只描述 “计算逻辑”。</li>
<li>分层设计：LLVM IR 分为 <strong>LLVM IR（文本 / 二进制形式）</strong> 和更底层的 <strong>Machine IR</strong>，前者用于跨平台优化，后者用于针对具体架构生成机器码。</li>
</ul>
<h3 data-id="heading-14">2. LLVM（Low Level Virtual Machine）</h3>
<p><strong>LLVM</strong>（Low Level Virtual Machine）是一个开源的编译器基础设施项目，<br/>
它本质上是一套<strong>编译器前端和后端的集合</strong>，支持多种编程语言和目标平台。</p>
<ul>
<li><strong>前端</strong>：如 Clang，把 C/C++ 转成 LLVM IR（中间表示）</li>
<li><strong>后端</strong>：把 LLVM IR 转成目标机器码（如 x86、ARM、WebAssembly）</li>
</ul>
<h4 data-id="heading-15">Clang</h4>
<p>Clang 是 <strong>LLVM 项目的一个核心子组件</strong>，本质是 LLVM 生态的<strong>C/C++/Objective-C 前端编译器</strong>，二者是<strong>框架与组件</strong>的关系 ——LLVM 提供通用的编译基础设施，Clang 负责将 C 系源码转换成 LLVM IR，再由 LLVM 的优化器和后端完成后续流程。</p>
<h3 data-id="heading-16">3. Binaryen</h3>
<p><strong>Binaryen</strong> 是一个专注于 WebAssembly（WASM）的<strong>工具链库和优化器</strong>，<br/>
由 WebAssembly 核心团队成员开发和维护（主要用 C++ 实现，带有 JS/Python 接口）。<br/>
它的目标是让 WebAssembly 代码<strong>更小、更快、更高效</strong>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[现代软件开发中常用架构的系统梳理与实践指南]]></title>    <link>https://juejin.cn/post/7592818202716979219</link>    <guid>https://juejin.cn/post/7592818202716979219</guid>    <pubDate>2026-01-08T10:04:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592818202716979219" data-draft-id="7592815497847685183" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="现代软件开发中常用架构的系统梳理与实践指南"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-08T10:04:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            现代软件开发中常用架构的系统梳理与实践指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T10:04:55.000Z" title="Thu Jan 08 2026 10:04:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在今天的软件开发实践中，“架构”已经不只是技术选型问题，而是关乎团队协作效率、系统可演进性以及业务竞争力的核心决策。很多初学者接触架构时，往往只看到零散的名词：分层、MVC、微服务、事件驱动、CQRS、Serverless……却很难把它们串成一条清晰的演进主线，更难落到实际项目中“该怎么选、怎么用”。</p>
<p>下面我会按照<strong>从传统到现代、从单体到云原生、从结构到哲学</strong>的脉络，系统讲解开发中常用的几类架构：它们各自解决什么问题、内部结构是什么样、在现代实践中如何组合使用，以及在不同项目阶段应如何做架构决策。</p>
<hr/>
<h2 data-id="heading-0">一、从单体分层到“整洁单体”：传统架构的现代价值</h2>
<h3 data-id="heading-1">1. 经典分层架构：从“堆代码”到“有序单体”</h3>
<p>长期以来，企业应用最普遍的形态是<strong>单体+分层架构</strong>：整个系统打成一个包部署，但内部按职责划分为几层：</p>
<ul>
<li>表现层（Controller / View）：处理 HTTP 请求、页面渲染、API 返回</li>
<li>业务层（Service）：封装领域规则和业务流程</li>
<li>数据访问层（DAO / Repository）：与数据库、缓存打交道</li>
<li>数据库层：MySQL、PostgreSQL、MongoDB 等</li>
</ul>
<p>这种结构的本质是：<strong>利用“纵向分层”让职责清晰、依赖有序</strong>。即便到今天，它依然是绝大多数中小项目最合适的起点。</p>
<p><strong>现代实践中的演进：</strong></p>
<p>过去的分层单体容易演变成“巨石应用”：所有业务都堆在一个 Service 包里，Service 调 Service 混乱不堪。为了解决这个问题，业界开始引入两种思路：</p>
<ol>
<li>
<p><strong>垂直切片（Vertical Slice）</strong>：<br/>
不再只关注“横向分层”，而是在单体中按业务领域做“纵向切割”：</p>
<pre><code class="hljs language-text" lang="text">/order
  ├─ OrderController
  ├─ OrderService
  ├─ OrderRepository
/payment
  ├─ PaymentController
  ├─ PaymentService
  └─ PaymentRepository
</code></pre>
<p>每个业务域形成独立模块，内部依然保持分层，但模块间依赖受控。这让单体内部的组织更加接近微服务，却保留了单体的部署和运维简单性。</p>
</li>
<li>
<p><strong>整洁架构思路的融入（Clean Architecture）</strong>：<br/>
Clean Architecture 强调：<strong>业务逻辑不应依赖框架与基础设施</strong>。应用被组织成同心圆：</p>
<ul>
<li>最内层：实体 / 领域模型（Entities）</li>
<li>中层：用例 / 应用服务（Use Cases / Application Services）</li>
<li>外层：接口适配器（Controllers、Presenters、Gateways）</li>
<li>最外层：框架与驱动（Web 框架、DB 驱动、消息中间件等）</li>
</ul>
<p>所有依赖只能“由外向内”。这保证了：</p>
<ul>
<li>核心业务代码可以在不启动 Web 容器、不连接数据库的情况下被测试</li>
<li>更换 Web 框架、数据库或消息中间件时，对内核影响有限</li>
</ul>
</li>
</ol>
<p>在实战中，一个做得好的“整洁单体”，往往比一个拆得很随意的“微服务集群”更稳定、更经济。</p>
<hr/>
<h2 data-id="heading-2">二、界面层架构：从 MVC 到组件化与 BFF</h2>
<h3 data-id="heading-3">1. MVC / MVVM：界面内部的组织方式</h3>
<p>MVC（Model-View-Controller）最初作为 UI 架构模式，引导我们把界面展示逻辑与业务处理解耦：</p>
<ul>
<li>Model：数据模型和基本业务规则</li>
<li>View：界面与展示</li>
<li>Controller：协调用户输入、业务调用和视图选择</li>
</ul>
<p>在后端框架中，如 Spring MVC、Django、ASP.NET MVC，MVC 更像是“请求-响应层”的组织方式。</p>
<p>进入前端 SPA（单页应用）时代，主流演变为：</p>
<ul>
<li><strong>MVVM</strong>（Vue、Knockout）：通过双向绑定，View 与 ViewModel 之间数据自动同步</li>
<li><strong>组件化 + 单向数据流</strong>（React）：一切皆组件，状态自上而下传递，事件自下而上传递</li>
</ul>
<p>这些都是<strong>界面层内部的架构模式</strong>，通常会与后端的分层架构、微服务架构结合使用。</p>
<h3 data-id="heading-4">2. BFF（Backend For Frontend）：多端时代的“前后端中间层”</h3>
<p>当一个系统同时服务 Web、iOS、Android、小程序、多种第三方系统时，“一个后端供所有前端使用”容易带来两个问题：</p>
<ul>
<li>API 难以同时满足多个前端对数据形态和性能的不同诉求</li>
<li>后端为适配多个前端而膨胀，接口逻辑变得非常复杂</li>
</ul>
<p>BFF 模式的解决方式是：<br/>
<strong>为每类前端定制一个轻量后端层</strong>，由它来负责：</p>
<ul>
<li>聚合多个微服务的数据，为前端组装所需视图模型</li>
<li>处理各终端差异化需求（字段裁剪、分页策略、缓存策略等）</li>
<li>屏蔽后端服务拓扑变化，降低前端耦合度</li>
</ul>
<p>架构上常见组合是：<br/>
<strong>“微服务集群” + “API 网关” + “多个 BFF 应用（按端划分）”</strong>。</p>
<hr/>
<h2 data-id="heading-5">三、C/S 与 B/S：从部署形态到边缘计算</h2>
<p>传统的 C/S（客户端–服务器）与 B/S（浏览器–服务器）之分，本质上是**“计算与状态位于何处”**的问题：</p>
<ul>
<li>C/S：厚客户端，许多逻辑在本地运行；更新成本高，但可离线、可深度优化体验</li>
<li>B/S：浏览器作为统一运行时；部署更新集中在服务器侧；依赖网络质量</li>
</ul>
<p>近年来边缘计算、PWA（渐进式 Web 应用）兴起后，这两者的界限变得模糊：</p>
<ul>
<li>Web 应用通过 Service Worker 实现离线缓存、本地存储与后台同步，获得类 C/S 的体验</li>
<li>传统桌面应用也大量采用 Web 技术（如 Electron），本质是“一个内嵌浏览器 + 本地资源”，与 B/S 融合</li>
</ul>
<p>现代项目通常不再单纯讨论“选 C/S 还是 B/S”，而是综合考虑：</p>
<ul>
<li>用户是否需要离线访问、大量本地计算或硬件能力</li>
<li>是否有严格的运维、升级和安全控制要求</li>
<li>是否需要通过边缘节点（CDN、Edge Function）进行前置计算</li>
</ul>
<hr/>
<h2 data-id="heading-6">四、事件驱动架构（EDA）：向解耦与实时演进</h2>
<p>当系统规模增大、业务流程变复杂，一个业务动作往往需要衍生出多种“后续行为”，例如：</p>
<ul>
<li>用户下单 → 扣库存 → 发送短信通知 → 推送推荐 → 更新统计报表</li>
<li>用户注册 → 发送欢迎邮件 → 创建新手任务 → 发放优惠券</li>
</ul>
<p>用同步调用去串联这些步骤，会让服务间依赖链条冗长、可靠性变差、耦合度高。<br/>
<strong>事件驱动架构</strong>通过“发布-订阅”的方式解耦这一切：</p>
<ol>
<li>核心服务完成主业务后，发布领域事件（如 <code>OrderCreated</code>）</li>
<li>其他服务订阅这些事件，根据需要做“后续操作”</li>
</ol>
<p>底层通常采用消息队列/流处理平台（如 Kafka、RabbitMQ、Pulsar），整体模式带来：</p>
<ul>
<li><strong>高解耦</strong>：新增一个“收到订单就发短信”的需求，只需新增一个消费者，不动原有代码</li>
<li><strong>异步与削峰填谷</strong>：高峰时事件排队处理，平滑后端压力</li>
<li><strong>更自然地支撑实时分析与风控</strong>：基于事件流做实时计算</li>
</ul>
<p>但 EDA 也引入复杂性：</p>
<ul>
<li><strong>一致性和顺序性</strong>：同一订单相关的多个事件处理顺序、幂等性问题需要设计</li>
<li><strong>可观测性</strong>：调用链不再是简单的“函数栈”，需要链路追踪和日志关联</li>
<li><strong>团队心智模型</strong>：从“过程式思维”过渡到“事件驱动思维”有一定门槛</li>
</ul>
<hr/>
<h2 data-id="heading-7">五、CQRS 与事件溯源：读写分离背后的架构深意</h2>
<p>当系统的读写负载、性能要求和业务复杂度不断提升时，“一张表同时满足读写”会遇到瓶颈：</p>
<ul>
<li>写：需要严格的业务规则验证、一致性保障、事务处理</li>
<li>读：需要灵活多变的视图、复杂的查询条件、极致的性能</li>
</ul>
<p>**CQRS（命令查询职责分离）**就是在架构层面对这种矛盾的回应：</p>
<ul>
<li>写侧（Command Side）：专注处理业务命令，维护“事实”，强调完整性和一致性</li>
<li>读侧（Query Side）：专注为界面/接口提供高性能查询，数据结构可以为“读”而生</li>
</ul>
<p>在实践中，CQRS 往往与**事件溯源（Event Sourcing）**结合，形成一种强力模式：</p>
<ol>
<li><strong>状态不再直接存为“最新快照”，而是存为“事件序列”</strong>：<br/>
例如订单状态不存为一个 <code>status</code> 字段，而是 <code>OrderCreated</code>、<code>OrderPaid</code>、<code>OrderShipped</code> 等事件的有序列表。</li>
<li><strong>当前状态可通过重放事件得到</strong>：
<ul>
<li>写侧只需保障事件的正确写入</li>
<li>读侧从事件流构建各类“物化视图”（Materialized Views）</li>
</ul>
</li>
</ol>
<p>优点包括：</p>
<ul>
<li>对读写模型进行独立优化和横向扩展</li>
<li>任意重建查询视图以适应新需求，支持“回放历史”、审计和调试</li>
<li>对读侧采用高度去范式化的表结构，查询效率极高</li>
</ul>
<p>代价则是：</p>
<ul>
<li>必须接受<strong>最终一致性</strong>：读侧数据可能比写侧略滞后</li>
<li>实现与运营复杂度提高，需要团队在 DDD、消息处理、幂等等方面具备成熟经验</li>
<li>并非适合所有业务，尤其不适合简单 CRUD 场景</li>
</ul>
<hr/>
<h2 data-id="heading-8">六、微服务架构：从“大拆分”到精细演进</h2>
<p>微服务不应该被看成一种“潮流”，而是<strong>在业务与团队规模发展到一定程度后，为解决单体架构扩展瓶颈的自然结果</strong>。</p>
<h3 data-id="heading-9">1. 微服务的核心原则</h3>
<ul>
<li>按<strong>业务能力</strong>拆分服务，而不是按技术层次拆分（比如“订单服务”“库存服务”，而不是“公共 Service1、Service2”）</li>
<li>每个服务<strong>独立部署、独立扩缩容、独立技术栈</strong>甚至独立数据库</li>
<li>服务间通过明确定义的 API 或消息进行通信（HTTP/gRPC/消息队列）</li>
</ul>
<p>围绕微服务，现代体系中几乎总会出现的一整套基础设施：</p>
<ul>
<li><strong>API 网关</strong>：统一入口，路由、认证、限流、灰度发布</li>
<li><strong>服务注册与发现</strong>：如 Nacos、Consul，让服务知道“别人在哪儿”</li>
<li><strong>配置中心</strong>：集中管理配置和密钥</li>
<li><strong>服务网格（Service Mesh）</strong>：如 Istio/Linkerd，将流量治理、熔断、重试、指标采集下沉到“基础设施层”</li>
<li><strong>可观测性体系</strong>：统一日志、指标、链路追踪</li>
</ul>
<h3 data-id="heading-10">2. 微服务何时“值得上”</h3>
<p>一般可以从以下几个维度判断：</p>
<ul>
<li>业务复杂度：领域多、边界清晰，如大型电商、金融交易、ERP 平台</li>
<li>团队规模：多团队、多职能协作，需要各自独立迭代和部署</li>
<li>非功能性需求：高可用、高并发、可弹性扩容、强自治</li>
</ul>
<p>同时也必须看到其成本：</p>
<ul>
<li>分布式带来的<strong>一致性、事务、调试</strong>难题</li>
<li>运维与监控复杂度显著上升，对 DevOps/平台工程能力要求极高</li>
<li>业务划分不当会导致“分布式单体”，既失去了单体的简单，又没有获得真正的解耦</li>
</ul>
<p><strong>实战更推荐的路径是：</strong></p>
<blockquote>
<p>先把单体做干净 —— 按领域模块化、引入整洁架构思想、完善自动化测试和 CI/CD —— 等单体在组织或性能层面的瓶颈真正显现，再有计划地“按业务域逐步拆分为微服务”。</p>
</blockquote>
<hr/>
<h2 data-id="heading-11">七、Serverless：无服务器背后的新范式</h2>
<p>Serverless（无服务器架构）并非不需要服务器，而是<strong>将服务器的管理责任完全交给云厂商</strong>，开发者只关注函数或小服务级别的业务逻辑：</p>
<ul>
<li>FaaS（函数即服务）：如 AWS Lambda、阿里云函数计算</li>
<li>Serverless 容器：如 Cloud Run、Fargate</li>
</ul>
<p>关键特征：</p>
<ul>
<li>按调用量和执行时间计费，<strong>极大适合低频或波动流量场景</strong></li>
<li>自动伸缩，无需自己搭建和维护集群</li>
<li>推荐用于：
<ul>
<li>事件驱动型任务（文件上传、消息消费、定时任务）</li>
<li>一些边缘逻辑（如活动页接口、Webhook 处理器）</li>
<li>业务流量峰谷变化很大的场景</li>
</ul>
</li>
</ul>
<p>但要注意：</p>
<ul>
<li>存在“冷启动”问题，首次调用可能有明显延迟</li>
<li>有较强的厂商绑定，迁移成本高</li>
<li>架构上必须非常注意<strong>状态外置</strong>（数据库、缓存、对象存储）</li>
</ul>
<p>在现代系统中，一个比较理想的组合是：<br/>
<strong>核心业务用“整洁单体或微服务”承载；大量边缘功能用 Serverless 承接</strong>，达成成本、弹性和复杂度的平衡。</p>
<hr/>
<h2 data-id="heading-12">八、如何根据项目阶段选择合适架构（可操作建议）</h2>
<p>结合上面这些模式，可以给出一个偏“落地”的选型框架。你可以粗略对照自己的项目，看看更适合哪条路线。</p>
<h3 data-id="heading-13">1. 初创或中小项目（单团队、需求模糊）</h3>
<p><strong>推荐：</strong></p>
<ul>
<li>技术形态：B/S + 分层单体</li>
<li>组织方式：按业务领域做模块划分（垂直切片）</li>
<li>架构原则：尽量应用 Clean Architecture 思想，确保业务逻辑与框架解耦</li>
</ul>
<p><strong>重点：</strong></p>
<ul>
<li>不要过早上微服务，不要为尚不存在的复杂性买单</li>
<li>用清晰的代码结构、自动化测试和规范的接口设计来“预防未来的腐化”</li>
</ul>
<h3 data-id="heading-14">2. 业务逐渐复杂、团队开始分拆</h3>
<p><strong>可以引入：</strong></p>
<ul>
<li>领域驱动设计（DDD）的基础概念：领域、聚合、限界上下文</li>
<li>局部采用事件驱动（EDA）优化解耦与异步处理</li>
<li>对某几个“读压力巨大”的功能使用 CQRS 做读写分离</li>
</ul>
<p><strong>此阶段目标：</strong></p>
<ul>
<li>在保持单体部署的前提下，先把“架构内功”练扎实</li>
<li>通过清晰领域边界，为未来的微服务拆分打下基础</li>
</ul>
<h3 data-id="heading-15">3. 多团队、多业务线、高并发要求</h3>
<p><strong>可以渐进式引入：</strong></p>
<ul>
<li>微服务架构：从最独立、最稳定的领域开始拆分（如用户、账务、通知）</li>
<li>API 网关、服务注册发现、配置中心、链路追踪等配套设施</li>
<li>服务网格用于统一治理调用、流量与安全</li>
</ul>
<p><strong>同时：</strong></p>
<ul>
<li>对关键业务链路可以叠加事件驱动架构，简化耦合、提升扩展性</li>
<li>在交易、风控、报表等复杂场景引入 CQRS + 事件溯源（视业务复杂度选择）</li>
</ul>
<h3 data-id="heading-16">4. 大规模云原生与成本优化阶段</h3>
<p>在已经稳定运营的微服务体系之上，再引入：</p>
<ul>
<li>Serverless 承接零散、波动大的边缘任务</li>
<li>在边缘节点部署部分服务，降低延迟</li>
<li>使用基础设施即代码（IaC）、GitOps 等管理大规模环境</li>
</ul>
<hr/>
<h2 data-id="heading-17">九、总结：架构的价值，不在“多高级”，而在“多适合”</h2>
<p>如果用一句话来概括上面的内容：</p>
<blockquote>
<p>架构不是炫技，而是让业务<strong>以最小的心智和运维成本，获得足够的灵活性、性能和可靠性</strong>。</p>
</blockquote>
<p>因此：</p>
<ul>
<li><strong>不要因为“流行”而上微服务、CQRS、Serverless</strong>，而要因为“遇到了它所解决的问题”</li>
<li><strong>单体并不低级</strong>，一个做好了领域划分与整洁设计的单体，是多数团队最具性价比的选择</li>
<li><strong>架构不是一锤子买卖，而是一条演进路径</strong>：从整洁单体 → 模块化单体 → 渐进式微服务 → 云原生 &amp; Serverless</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025：从用 AI 到学 AI，我最轻松也最忙碌的一年]]></title>    <link>https://juejin.cn/post/7592452108798181419</link>    <guid>https://juejin.cn/post/7592452108798181419</guid>    <pubDate>2026-01-08T01:50:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592452108798181419" data-draft-id="7592134330313064491" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025：从用 AI 到学 AI，我最轻松也最忙碌的一年"/> <meta itemprop="keywords" content="后端,人工智能,AI编程"/> <meta itemprop="datePublished" content="2026-01-08T01:50:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="洛卡卡了"/> <meta itemprop="url" content="https://juejin.cn/user/888839672963544"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025：从用 AI 到学 AI，我最轻松也最忙碌的一年
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/888839672963544/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    洛卡卡了
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T01:50:05.000Z" title="Thu Jan 08 2026 01:50:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h3 data-id="heading-0">一 · 2025：我被 AI 推着往前走的一年</h3>
<p>大家好，我是卡卡。 我其实一直没有写个人总结的习惯，因为很多时候我都会觉得，自己的人生是很无趣的。好像就是把同一天重复过了 365 遍。没有什么特别大的惊喜，也谈不上有什么质的改变，唯一一直在往前走的，可能就只有年龄了。不过今年有点不一样，2025 年是我在掘金最活跃的一年，这次也算是借着征文的机会，回头记录一下属于自己的这一圈数字年轮。</p>
<p>如果要用一句话来概括 2025 年，那就是：<strong>这是我程序员近几年生涯里最轻松的一年，也是最忙碌的一年。</strong> 上半年很轻松，下半年却异常忙碌，而这两种看似相反的状态，其实都离不开同一个工具——AI。</p>
<p><strong>2025 年，我一边被 AI 解放（工作更轻松），一边被 AI 牵引（学习更忙碌）。</strong> 从最开始单纯用 AI 写代码、查问题、改 bug，到后来主动去学习 AI、研究工作流、搭流程、做验证、不断尝试新的方向。 回头看这一年，我也算是<strong>真实地体验了一把被时代推着往前走的感觉吧。</strong></p>
<hr/>
<h3 data-id="heading-1">二 · 写代码这件事，开始变轻松了</h3>
<p>最早接触 AI，其实还是从 ChatGPT 开始的。 对我来说，它就像是一位免费的、随时能问的全知全能老师，虽然有时候也会犯点低级错误，但对工作的帮助确实是实打实的。很多以前需要自己一点点查资料、翻文档、对着报错反复试的问题，现在只要把信息贴进去，就能很快拿到一个思路，知道该从哪下手。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b5d6c8a4d4674d0b941bfc4e993458e7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSb5Y2h5Y2h5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768441804&amp;x-signature=huySxIpiyacsRl25ZbosCBYWrrM%3D" alt="" loading="lazy"/></p>
<p>后来我开始在代码工具里接入 GitHub Copilot，这种变化就更明显了。写代码的时候，我总是先写个注释，等着 AI 把代码补全，然后 Tab 回车。哪怕是很简单的功能，也懒得再手打一遍，慢慢地，甚至已经习惯了这种等补全的节奏。工作变得更轻松，遇到问题和 bug，也很少再去百度翻一堆方案，或者到处问同事，更不用说熬夜研究。</p>
<p>有时候想起以前的场景。为了定位一个问题，和我哥一起语音沟通熬了一个通宵，一行一行地看日志、试方案，第二天人是靠咖啡硬撑的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f9f8a265e4f347f1a2d439ee3d177770~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSb5Y2h5Y2h5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768441804&amp;x-signature=hC5pusfRjIPMk%2FxlgvEv2Pdt3HQ%3D" alt="aaaaa" loading="lazy"/></p>
<p>而现在，大多数类似的问题，可能就是把报错贴给 AI，顺着给到的方向改一改，事情就结束了。那时候我还没意识到，这种“轻松”，其实只是一个开始。</p>
<hr/>
<h3 data-id="heading-2">三 · 当 AI 进了编辑器，我开始只要结果</h3>
<p>当 AI 真正进入代码编辑器之后，我写代码的方式彻底变了。 开始用上 Cursor、Trae 这些 AI 编辑器后，感觉和之前已经完全不是一个状态了。以前更多还是人写、AI 辅助，而现在更像是人给意图，AI 直接给结果。很多时候，我只需要简单描述一下要做什么，甚至连注释都懒得写清楚，剩下的就交给 AI 去补全、去改、去重构。</p>
<p>这种变化，其实是悄悄发生的。 一开始只是觉得快，后来慢慢变成了习惯。遇到问题，下意识就让 AI 直接给方案；代码不满意，就让它重写一版；逻辑有点乱，就让它顺一遍。以前还会自己一点点推演、验证，现在更多是在几个结果之间做选择。代码写得更快了，但人参与的方式，已经明显不一样了。</p>
<p><strong>以前还会享受一下解决问题的过程，现在只想要结果，过程好像也没那么重要了。</strong></p>
<hr/>
<h3 data-id="heading-3">四 · 轻松到一定程度，人反而开始空虚</h3>
<p>当解决问题不再需要我时，写代码这件事，反而开始变得无趣。 流程越来越顺，问题越来越少，很多事情几乎是丢给 AI 就结束。摸鱼的时间自然变长了，但人却并没有因此更轻松，反而常常是一种说不上来的空。感觉日子越来越无趣 不知道干什么。每天坐在电脑前，看着代码在跑、功能在交付，却很少再有那种“问题被我搞定了”的成就感，更多时候只是恍恍惚惚地把一天熬过去。</p>
<p>这种状态持续了一段时间之后，焦虑也慢慢浮了上来。 AI 让很多能力被快速拉平，原本需要经验堆出来的东西，现在几乎成了标配。都说AI拉近了菜鸟和大佬之间的距离，确实通过AI让我写出来之前根本写不出来的所谓的高质量，高性能代码，但同时也让我十年经验带来的优势开始变得模糊，再叠加行业环境和就业压力，这种不安会被不断放大。<strong>AI 拉近了菜鸟和大佬的距离，也让我开始重新怀疑自己的价值。</strong></p>
<hr/>
<h3 data-id="heading-4">五 · 唯一让我认真起来的，是每周那一篇总结</h3>
<p>那段时间里，唯一还能让我提起精神的，只剩下每周写一篇总结。 工作越来越顺，心却越来越慌。AI 拉平能力的速度远比我预想得快，十年经验带来的安全感在一点点被稀释，再加上行业环境持续收紧，这种不安会在日常里被不断放大。在这种状态下，写文章、做总结、做复盘，慢慢变成了一种自我校准的方式。不是为了输出给谁看，而是逼着自己把一周的思路重新捋一遍，确认自己是不是还在往前走。</p>
<p>我开始有意识地去写、去整理、去复盘，也开始尝试做一些以前不太敢碰的事情。借着 AI 的能力，去模拟、去拆解一些原本接触不到的技术架构，去验证自己的理解是不是还站得住脚。在 AI 几乎“全知全能”的背景下，这种主动思考和尝试，反而成了我确认自身技术判断的一种方式。<strong>似乎只有这样，日复一日的心理，才能得到一点点安慰。</strong></p>
<p>后来我发现一件挺重要的事。 这些每周写下来的总结，在 AI 的辅助下，慢慢变得更完整，也更容易坚持。AI 帮我整理结构、补全表达、把零散的想法捋清楚，但最终要不要写、写什么、写成什么样，还是得我自己来决定。也正是因为这样，我才能在那段状态并不算好的时间里，一直保持着相对稳定的输出。</p>
<p>直到年底知道自己被掘金评为「掘金 2025 年度优质作者」，也获得了一些粉丝，得到一些掘友们的认可。第一反应并不是兴奋，而是一种松了一口气的感觉。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e6d11272b974f93a6d878ffc05d678a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSb5Y2h5Y2h5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768441804&amp;x-signature=F6LDvdiJs6f6wiMUV0I8ne3MEbE%3D" alt="image-20260107152433981" loading="lazy"/></p>
<p>它并不意味着我做得有多好，但至少让我确认了一件事：在被 AI 推着往前走的这一年里，我每天花在整理、思考、记录上的时间，并没有被浪费。哪怕只是写文章这件事，也让我觉得，自己的日子并不是完全虚度的。</p>
<p>也正是在这些总结和复盘里，我开始反复思考一个问题： <strong>如果我只是停留在用 AI，那接下来，我到底该往哪走？</strong> 那时候的我还以为，自己对 AI 的期待，可能也只会停留在工作层面。</p>
<hr/>
<h3 data-id="heading-5">六 · 副业焦虑：想改变，但始终迈不出第一步</h3>
<p>我开始认真思考副业，但很快就发现，这条路并不轻松。 也许是程序员寒冬的影响，也许是每天摸鱼带来的空虚感，又或者是因为自己负债想多一份收入。总之，念头有了，行动却始终跟不上。要么觉得方向不好找，要么担心不靠谱，要么提不起兴趣，要么刚开始就发现很难坚持下去。总之理由一大堆，但结果始终没什么改变。</p>
<p>更现实的一点是，大多数人现在还是在上班，并不是独立开发者，也不是自由职业。在这种状态下去搞副业，往往会卡在两个很实际的问题上。第一个是太吃持续投入，需要长期、稳定地往里砸时间；第二个是学习成本高，而且一旦中断，就很难再接得上。我们经常看到别人分享剪视频、做漫画、写公众号，看起来好像都挺轻松，但真轮到自己上手才发现，每一个方向都需要不断学新东西、练手感、跟节奏。</p>
<p>更麻烦的是，当工作一忙，中断一段时间，再想捡起来，成本反而更高。与此同时，我们在投入这些时间的时候，其实也很难判断，这个方向到底能不能看到未来。久而久之，很多人还是会退回到最熟悉、也最省心的那条路上，在“想赚钱”“想短期变现”“又不想长期坚持”之间反复摇摆。<strong>我总是在“再等等”“不靠谱”“没兴趣”这些理由中来回横跳。</strong></p>
<hr/>
<h3 data-id="heading-6">七 · 朋友的公众号收入，第一次把副业拉回现实</h3>
<p>真正让我动心的，并不是哪篇教程，而是身边一个朋友的真实收入。 他一直在做公众号，记录自己的工作日记，很大众，很普通，粉丝也不算夸张，但运营得比较稳定，后来开通了流量主，每个月都会有收入，好的时候甚至能有好几千。不是暴富那种，但胜在清晰、可预期，也足够真实。</p>
<p>那一刻我心里其实是有波动的，就像是打开了一扇大门。 原来副业这件事，并不一定非要搞得多复杂，也不是只有极少数人才能做到。它第一次从“别人故事里的成功案例”，变成了一个发生在我身边的现实可能。我开始认真想，如果是我，能不能也试着走这条路。</p>
<p>但心动归心动，犹豫也同样真实。 我想做，却又很清楚自己的问题在哪——怕坚持不下去，怕热情来得快、退得也快，最后还是不了了之。<strong>我想做，但我更怕，自己又是三分钟热度。</strong></p>
<hr/>
<h3 data-id="heading-7">八 · 真正的转折点：我重新想起了“扣子工作流”</h3>
<p>直到有一天，我看到了一篇“一键仿爆款到草稿箱”的文章。 内容本身并不复杂，大概就是通过扣子工作流，把已经跑得不错的公众号文章抓下来，拆结构、定风格，然后直接生成一篇新的内容，丢进草稿箱。那一刻我突然想起来，自己其实早就听说过扣子工作流，只是之前一直没真正往心里去。</p>
<p>和写代码时那种提高效率的感觉又不太一样，这次让我震了一下的是： <strong>原来 AI 在非代码领域，同样可以这么有力量。</strong> 它不只是帮人写几行代码，而是可以参与到内容生产、流程拆解，甚至是整个创作链路里。那一刻我第一次很清晰地意识到，AI 可能并不是只服务于程序员的工具，它也许能帮我跨过一些原本完全不敢碰的领域。</p>
<p>真正开始动手学扣子工作流之后，这种感觉变得更明显了。我开始去学习创作各种各样的工作流：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b55f33e5f17c4f4b8bd6411255ef1232~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSb5Y2h5Y2h5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768441804&amp;x-signature=HTjbHYociJnPAGlvKYCqaGWOmTg%3D" alt="image-20260107154222082" loading="lazy"/></p>
<p>当我把第一条流程跑通之后，很多之前困扰我的问题突然变得不那么致命了。 比如能不能同时起多个公众号、不同方向要不要分开试、会不会一开始就把精力耗光。这些问题不再完全压在人要不要坚持上，而是被拆成了一个个流程节点，可以调整、可以复用、也可以随时停掉。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/761732131f2948918b9f6e1364a5a139~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSb5Y2h5Y2h5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768441804&amp;x-signature=mqqG55nUKy3mxf9HWJKDDT2eyvs%3D" alt="image-20260107154337811" loading="lazy"/></p>
<p>当一条流程跑通之后，我发现很多以前想都不敢想的事，突然变得可以试一试了。比如同时起多个公众号，不同方向、不同风格，用同一套思路去跑；比如把内容生产这件事，从高消耗的灵感创作，变成一套可以反复执行、不断调整的流程。哪怕最后效果一般，也至少不用再被从零开始的成本劝退。</p>
<p>也正是从那一刻开始，我真正把注意力从“用 AI 写代码”，转向了“用 AI 搭流程、做验证”。 那一刻我也意识到，<strong>AI 不只是帮我把事情做得更快，它也在悄悄拓宽我能尝试的边界。</strong></p>
<hr/>
<h3 data-id="heading-8">九 · 从摸索到系统学习：我开始真正学 AI</h3>
<p>真正开始学 AI 之后，我才发现自己之前只是打开了一扇窗。 一开始完全是靠自己摸索，进度其实很慢，很多东西都是零零散散地试。后来我开始有意识地去找一些已经在这个领域里跑出来的大佬，去看他们是怎么做的，也顺带接触到了市面上大量关于副业和 AI 的内容。慢慢地，我也看清了一个现实：这类内容里，营销占了很大一部分，不是让你加群，就是把你往星球、私教里引，看起来很诱人，但多少也会让人警惕“割韭菜”。</p>
<p>以前我也常听一句话，说<strong>教你赚钱的人，赚的往往是你的钱，真正赚钱的人为什么要教你赚钱</strong>。后来我反而觉得，这句话只说对了一半。如果仔细去看那些真正把副业做起来的人，会发现他们大多都有一整套完整的路径和矩阵：先把某个技术方向跑通，再把经验整理出来输出，接着才是社群、星球、私教这些形式。从商业角度看，这条链路本身是成立的，而且逻辑也很清晰。</p>
<p>也正是基于这种认知，我慢慢接受了一件事： <strong>工作流做得再好，也只是工具，它只能降低学习成本，却不是变现的核心。真正决定能不能赚钱的，永远是商业化能力。</strong> 想走捷径、只靠白嫖，几乎是不现实的。但对我来说，与其纠结“会不会被割”，不如先承认一点——学习本身就是要付出代价的。至少在这个阶段，比起急着变现，我更在意的是把这条路看清楚、走扎实。</p>
<hr/>
<h3 data-id="heading-9">十· 视野被彻底打开：我才刚推开 AI 的一扇窗</h3>
<p>当我开始系统折腾 AI 之后，才发现自己之前看到的，其实只是冰山一角。 最初我还停留在扣子工作流这一层，但很快我就遇到了新的问题：如果流程再复杂一点，或者需要和外部系统打通，单靠扣子已经有些受限了。也正是在这个阶段，我开始接触并学习 <strong>n8n</strong>。</p>
<p>接触 n8n 之后，我的思路发生了一次明显变化。 它更偏工程化，也更自由，让我第一次开始认真思考：能不能把扣子工作流当成其中的一环，嵌进一条更大的自动化链路里。比如，用 n8n 负责调度、分发和对接接口，用扣子负责内容生成，把原本分散的能力，真正串成一条可以反复跑的流程。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/111d2a73119a4963b69611b7d06728e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSb5Y2h5Y2h5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768441804&amp;x-signature=4CoucStc8dqoya3S7D00OFwloRo%3D" alt="image-20260107155752285" loading="lazy"/></p>
<p>随着每天下班回家不断学习和参考别人的实践，我才开始慢慢了解到，AI 的世界远不止一种形态。 除了 Coze 和 n8n 这样的工作流工具，图像生成也不只是简单点几下：即梦、LiblibAI、Nano Banana 各自有不同侧重；再往深一点，还有更底层、更自由的 ComfyUI；视频方向上，也开始出现像 <strong>Sora2</strong> 这样的能力突破；再加上数据编排、多维表格、各种 API 接口和成本对比，整个生态远比我一开始想象得要复杂得多。</p>
<p>但也正是这种复杂，让我第一次真正感到兴奋。 它不再是“学会一个工具就结束”的那种确定性，而是突然出现了一大片可以继续探索、拆解和组合的空间。每天都会冒出新的问题：这个能力能不能接到流程里？那个模型换掉会不会更合适？成本还能不能再压一压？我开始有一种很久没有过的感觉——<strong>好像又有东西值得我继续学下去了。</strong></p>
<p>也正是在这个阶段，我才逐渐意识到一个分歧点的存在。 也有同学会觉得，我们并不需要搭什么商业版图，只要会用工具变现就够了。现在网上 AI 工具一大把，想用什么直接搜、直接用，似乎也没必要自己去折腾，用 AI 去创造什么。</p>
<p>但越往下走，我反而越警惕一件事： 如果只停留在用现成工具，本质上我们用的，始终是别人的能力封装。工具怎么用、能力边界在哪、价值怎么分配，早就被别人设计好了。在这种情况下，看着别人吃肉，我们大概率连汤都很难喝到。能力边界不是自己定的，最后很容易就变成被收割的那一层人。</p>
<p>也正是意识到这一点，我才真正明白，自己这一阶段的“忙碌”从何而来。 不是因为工具变多了，而是我开始把被 AI 解放出来的时间，用来训练一件事——<strong>如何理解能力、组合能力，而不是只停留在使用层面。</strong> 直到这时我才意识到，自己或许真的只是刚刚推开了 AI 的一扇窗。</p>
<hr/>
<h3 data-id="heading-10">十一 · 回头看 2025：这就是我的 Vibe Coding 时刻</h3>
<p>回头看 2025 年，我觉得自己真正的转变，并不是用了多少 AI 工具。 这一年，AI 并没有让我躺平，反而让我变得更忙了。它把一部分重复、消耗的事情接了过去，也把我推向了另一类更难的事情——思考、判断、拆问题、搭流程、做验证。</p>
<p>从一开始用 AI 写代码、查问题，到后来开始学 AI、搭工作流，再到尝试把不同能力组合起来，我慢慢意识到，自己的角色正在发生变化。我不再只是被需求推着往前走的执行者，而是在不断做选择的人：选用什么能力、怎么组合、这条路值不值得继续试下去。</p>
<p>这大概就是我理解里的 Vibe Coding。 它不是偷懒，也不是少写代码，而是从“敲代码的人”，变成了“设计流程的人”。AI 让我写代码更轻松，也让我第一次有机会把精力花在更有价值的地方——把问题拆对，把流程搭对，把结果交付对。</p>
<p>最近刷到不少视频，都在说 2026 年可能是 AI 漫剧的顶峰，甚至是最后的风口。 我并不确定这种判断对不对，也不太想去赌所谓的“最后一次机会”。但至少在 2025 年，我已经不再只是围观这些变化，而是开始尝试理解它们、参与它们。哪怕只是从一个很小的方向开始，去学习、去验证、去创造属于自己的东西。</p>
<p>也许我现在还没有跑出什么确定或满意的结果。 但至少在这一年里，我第一次明确地感受到：<strong>我不再只是执行的人，而是在做判断和选择的人。</strong> 从用 AI，到学 AI，再到尝试搭 AI，这就是属于我的 2025 年——一个被 AI 解放、也被 AI 牵引着向前的 Vibe Coding 时刻。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>