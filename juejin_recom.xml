<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[ESLint 批量抑制：技术债治理的正确打开方式]]></title>    <link>https://juejin.cn/post/7599652649549922304</link>    <guid>https://juejin.cn/post/7599652649549922304</guid>    <pubDate>2026-01-27T02:38:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599652649549922304" data-draft-id="7599598627007316020" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ESLint 批量抑制：技术债治理的正确打开方式"/> <meta itemprop="keywords" content="前端,JavaScript,React.js"/> <meta itemprop="datePublished" content="2026-01-27T02:38:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="百慕大三角"/> <meta itemprop="url" content="https://juejin.cn/user/1882827191748744"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ESLint 批量抑制：技术债治理的正确打开方式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1882827191748744/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    百慕大三角
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T02:38:02.000Z" title="Tue Jan 27 2026 02:38:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">ESLint 批量抑制：技术债治理的正确打开方式</h2>
<h3 data-id="heading-1">引子：一个技术 Leader 的困境</h3>
<p>作为技术 Leader，你可能遇到过这样的场景：</p>
<p>团队维护着一个两年前的 React 项目，20 万行代码，技术债堆积如山。你想推动代码质量提升，在团队会议上提议："我们开启 <code>@typescript-eslint/no-explicit-any</code> 规则吧，减少 <code>any</code> 的滥用。"</p>
<p>然后你在本地试运行了一下：</p>
<pre><code class="hljs language-bash" lang="bash">$ eslint .
✖ 1,247 problems (1,247 errors, 0 warnings)
</code></pre>
<p><strong>1,247 个错误</strong>。</p>
<p>你的第一反应可能是："算了，还是别开了。" 团队成员也松了一口气——毕竟谁也不想在 JIRA 里看到一个"修复 1,247 个 Lint 错误"的任务。</p>
<p>但问题是，如果现在不开启规则，新代码还会继续使用 <code>any</code>，技术债只会越滚越大。这就是典型的"<strong>存量问题拖累增量改进</strong>"的困境。</p>
<p>今天要介绍的 <strong>ESLint 批量抑制（Bulk Suppressions）</strong> 功能，就是为了解决这个问题而生的。</p>
<h3 data-id="heading-2">核心思路：既往不咎，严控增量</h3>
<p>批量抑制的核心理念可以用八个字概括：<strong>既往不咎，严控增量</strong>。</p>
<h4 data-id="heading-3">工作机制</h4>
<p>当你启用批量抑制后，ESLint 会做三件事：</p>
<ol>
<li><strong>记录现状</strong>：将当前所有违规记录到 <code>eslint-suppressions.json</code> 文件中</li>
<li><strong>暂时放行</strong>：对于已记录的旧代码违规，ESLint 暂时忽略，CI/CD 正常通过</li>
<li><strong>严格卡控</strong>：对于新增的代码，规则立即生效，任何新违规都会报错</li>
</ol>
<p>看一个实际的抑制文件示例：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"suppressions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"ruleId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"@typescript-eslint/no-explicit-any"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"file"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"src/components/UserProfile.tsx"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"count"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">12</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"ruleId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"@typescript-eslint/no-explicit-any"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"file"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"src/utils/request.ts"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"count"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">8</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>这个文件告诉 ESLint："UserProfile.tsx 文件里有 12 个 <code>any</code>，这是历史遗留问题，暂时放过。但如果出现第 13 个，立即报错。"</p>
<h4 data-id="heading-4">监控机制</h4>
<p>批量抑制不是"一抑了之"，而是有严格的监控：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/components/UserProfile.tsx</span>
<span class="hljs-comment">// 已记录 12 个 any，当前 12 个 →  通过</span>

<span class="hljs-comment">// 如果开发者新增了一个 any：</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleData</span>(<span class="hljs-params">data: <span class="hljs-built_in">any</span></span>) {  <span class="hljs-comment">// 这是第 13 个！</span>
  <span class="hljs-comment">// ...</span>
}

<span class="hljs-comment">// ESLint 会立即报告该文件的所有违规：</span>
<span class="hljs-comment">// ✖ 13 problems in src/components/UserProfile.tsx</span>
</code></pre>
<p>一旦违规数超标，ESLint 会暴露<strong>该文件的所有问题</strong>，倒逼开发者要么修复新问题，要么顺手把旧问题也一起解决。</p>
<h3 data-id="heading-5">实战：在 React + TypeScript 项目中落地</h3>
<h4 data-id="heading-6">场景设定</h4>
<p>假设你负责一个电商项目，技术栈是 React + TypeScript，团队 8 人，代码库现状：</p>
<ul>
<li>150+ 个组件文件</li>
<li>TypeScript 配置较宽松（<code>strict: false</code>）</li>
<li>大量使用 <code>any</code>、非空断言、隐式类型转换</li>
<li>团队对"突然冒出的几百个 Lint 错误"非常抵触</li>
</ul>
<p>你的目标是：<strong>在不影响现有开发节奏的前提下，逐步提升代码质量</strong>。</p>
<h4 data-id="heading-7">第一步：评估现状</h4>
<p>先看看如果直接开启严格规则会怎样：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// eslint.config.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> [
  {
    <span class="hljs-attr">files</span>: [<span class="hljs-string">"**/*.{ts,tsx}"</span>],
    <span class="hljs-attr">rules</span>: {
      <span class="hljs-string">"@typescript-eslint/no-explicit-any"</span>: <span class="hljs-string">"error"</span>,
      <span class="hljs-string">"@typescript-eslint/no-non-null-assertion"</span>: <span class="hljs-string">"error"</span>,
      <span class="hljs-string">"@typescript-eslint/strict-boolean-expressions"</span>: <span class="hljs-string">"error"</span>
    }
  }
];
</code></pre>
<p>运行检查：</p>
<pre><code class="hljs language-bash" lang="bash">$ eslint .

src/components/ProductList.tsx
  12:15  error  Unexpected any. Specify a different <span class="hljs-built_in">type</span>  @typescript-eslint/no-explicit-any
  23:8   error  Forbidden non-null assertion              @typescript-eslint/no-non-null-assertion
  ...

src/utils/formatPrice.ts
  5:22   error  Unexpected any. Specify a different <span class="hljs-built_in">type</span>  @typescript-eslint/no-explicit-any
  ...

✖ 847 problems (847 errors, 0 warnings)
</code></pre>
<p><strong>847 个错误</strong>。如果强行推进，结果可想而知：</p>
<ul>
<li>团队成员抱怨："又要加班修 Bug 了"</li>
<li>CI/CD 构建失败，阻塞所有人的开发</li>
<li>最后可能不得不回滚配置</li>
</ul>
<h4 data-id="heading-8">第二步：使用批量抑制</h4>
<p>冷静下来，换个思路——用批量抑制：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 开启规则并生成抑制文件</span>
$ eslint . --suppress-all --fix

<span class="hljs-comment"># 自动修复了 142 个问题</span>
<span class="hljs-comment"># 剩余 705 个问题记录到 eslint-suppressions.json</span>

✔ Suppressions written to eslint-suppressions.json
</code></pre>
<p>这个命令做了两件事：</p>
<ol>
<li><strong>自动修复</strong>：能自动修复的问题（比如添加类型注解）直接修复</li>
<li><strong>记录存量</strong>：无法自动修复的问题记录到抑制文件</li>
</ol>
<p>现在再运行 <code>eslint .</code>：</p>
<pre><code class="hljs language-bash" lang="bash">$ eslint .
✔ No problems found
</code></pre>
<p>完美通过！关键是，<strong>新代码必须符合规则</strong>。</p>
<h4 data-id="heading-9">第三步：验证增量卡控</h4>
<p>让我们验证一下，新代码是否真的会被拦截。</p>
<p>某个开发者在新功能中写了这样的代码：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/components/NewFeature.tsx (新文件)</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Props</span> {
  <span class="hljs-attr">data</span>: <span class="hljs-built_in">any</span>;  <span class="hljs-comment">// x 新代码使用 any</span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">NewFeature</span>(<span class="hljs-params">{ data }: Props</span>) {
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{data.name}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre>
<p>运行检查：</p>
<pre><code class="hljs language-bash" lang="bash">$ eslint src/components/NewFeature.tsx

src/components/NewFeature.tsx
  4:9  error  Unexpected any. Specify a different <span class="hljs-built_in">type</span>  @typescript-eslint/no-explicit-any

✖ 1 problem (1 error, 0 warnings)
</code></pre>
<p><strong>立即报错</strong>！因为这是新文件，不在抑制列表中。</p>
<p>开发者必须修复才能提交：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 修复后</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ProductData</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">price</span>: <span class="hljs-built_in">number</span>;
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Props</span> {
  <span class="hljs-attr">data</span>: <span class="hljs-title class_">ProductData</span>;  <span class="hljs-comment">//  使用明确的类型</span>
}
</code></pre>
<h4 data-id="heading-10">第四步：建立日常工作流</h4>
<p><strong>1. 定期清理已修复的抑制</strong></p>
<p>当团队修复了一些旧代码后，使用 <code>--prune-suppressions</code> 清理：</p>
<pre><code class="hljs language-bash" lang="bash">$ eslint . --prune-suppressions

✔ Removed 23 suppressions that are no longer needed
</code></pre>
<p>这个命令会：</p>
<ul>
<li>检查每个抑制项是否还存在对应的违规</li>
<li>如果违规已修复，从抑制文件中移除该记录</li>
</ul>
<p><strong>2. Code Review 关注点</strong></p>
<p>在代码评审时，增加一个检查项：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section">## Code Review Checklist</span>

<span class="hljs-bullet">-</span> [ ] 代码逻辑正确
<span class="hljs-bullet">-</span> [ ] 测试覆盖充分
<span class="hljs-bullet">-</span> [ ] <span class="hljs-strong">**技术债趋势**</span>：
<span class="hljs-bullet">  -</span> [ ] 没有新增 eslint-suppressions.json 中的抑制项
<span class="hljs-bullet">  -</span> [ ] 如果修改了旧文件，是否顺手修复了部分 Lint 问题
</code></pre>
<h3 data-id="heading-11">进阶技巧</h3>
<h4 data-id="heading-12">技巧 1: 按模块分批抑制</h4>
<p>如果你想先对核心模块严格要求，可以这样操作：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 先对 utils 和 hooks 目录开启严格模式</span>
$ eslint src/utils src/hooks --suppress-all --fix

<span class="hljs-comment"># 其他目录暂时不检查</span>
</code></pre>
<h4 data-id="heading-13">技巧 2: 结合 Git Hooks</h4>
<p>推荐使用 <code>lint-staged</code> 来精确控制只检查暂存区的文件，比手写脚本更稳健：</p>
<ol>
<li>
<p>安装依赖：</p>
<pre><code class="hljs language-bash" lang="bash">npm install --save-dev lint-staged husky
</code></pre>
</li>
<li>
<p>配置 <code>package.json</code>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"lint-staged"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"*.{ts,tsx}"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"eslint"</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
</li>
<li>
<p>在 <code>.husky/pre-commit</code> 中调用：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/sh</span>
npx lint-staged
</code></pre>
</li>
</ol>
<p>这样，每次提交时，ESLint 只会检查你修改的文件。如果有新增的违规（且未被抑制），提交将被拦截。</p>
<h4 data-id="heading-14">技巧 3: 制定“童子军规则”</h4>
<p>在团队中推行<strong>童子军规则</strong>（Boy Scout Rule）：</p>
<blockquote>
<p>"离开时，让代码比你来时更干净一点。"</p>
</blockquote>
<p>具体做法：</p>
<ul>
<li>如果你修改了某个旧文件，顺手修复 1-2 个 Lint 问题</li>
<li>在 Code Review 时，给予"技术债修复"额外的认可</li>
</ul>
<h3 data-id="heading-15">总结：技术债治理的三个原则</h3>
<p>通过 ESLint 批量抑制功能，我们学到的不仅是一个工具的使用，更是一种<strong>技术债治理的方法论</strong>：</p>
<h4 data-id="heading-16">原则 1: 不要让存量问题阻碍增量改进</h4>
<p>传统思维："要么全修，要么不修"。
批量抑制思维："存量暂时冻结，增量严格卡控"。</p>
<h4 data-id="heading-17">原则 2: 渐进式改进优于一次性重构</h4>
<p>一次性重构的风险：</p>
<ul>
<li>周期长，风险高</li>
<li>影响业务交付</li>
<li>团队抵触情绪大</li>
</ul>
<p>渐进式改进的优势：</p>
<ul>
<li>每次改进可见、可控</li>
<li>不影响正常迭代</li>
<li>团队负担小</li>
</ul>
<h4 data-id="heading-18">原则 3: 用工具和流程保障，而非靠自觉</h4>
<p>不要指望团队成员"自觉地"提升代码质量。应该：</p>
<ul>
<li><strong>工具拦截</strong>：ESLint 自动检查新代码</li>
<li><strong>CI 监控</strong>：自动检测技术债趋势</li>
<li><strong>流程保障</strong>：Code Review 检查清单</li>
</ul>
<hr/>
<h3 data-id="heading-19">参考资料</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Feslint.org%2Fblog%2F2025%2F04%2Fintroducing-bulk-suppressions%2F" target="_blank" title="https://eslint.org/blog/2025/04/introducing-bulk-suppressions/" ref="nofollow noopener noreferrer">ESLint 官方博客：Introducing Bulk Suppressions</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Feslint.org%2Fdocs%2Flatest%2F" target="_blank" title="https://eslint.org/docs/latest/" ref="nofollow noopener noreferrer">ESLint 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftypescript-eslint.io%2Frules%2F" target="_blank" title="https://typescript-eslint.io/rules/" ref="nofollow noopener noreferrer">TypeScript ESLint 规则参考</a></li>
</ul>
<hr/>
<blockquote>
<p>如果这篇文章对你有帮助，欢迎点赞收藏！也欢迎在评论区分享你在技术债治理方面的经验和困惑。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Open Claude Cowork：基于 Electron + React + ACP 的本地多 Agent 协作桌面应用]]></title>    <link>https://juejin.cn/post/7599581687357571122</link>    <guid>https://juejin.cn/post/7599581687357571122</guid>    <pubDate>2026-01-26T17:48:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599581687357571122" data-draft-id="7599530824426323978" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Open Claude Cowork：基于 Electron + React + ACP 的本地多 Agent 协作桌面应用"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2026-01-26T17:48:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="_鸡脚芝士_"/> <meta itemprop="url" content="https://juejin.cn/user/1732486058737917"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Open Claude Cowork：基于 Electron + React + ACP 的本地多 Agent 协作桌面应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1732486058737917/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    _鸡脚芝士_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T17:48:10.000Z" title="Mon Jan 26 2026 17:48:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github-gist">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#333}.hljs-comment,.hljs-meta{color:#969896}.hljs-emphasis,.hljs-quote,.hljs-strong,.hljs-template-variable,.hljs-variable{color:#df5000}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#d73a49}.hljs-attribute,.hljs-bullet,.hljs-literal,.hljs-symbol{color:#0086b3}.hljs-name,.hljs-section{color:#63a35c}.hljs-tag{color:#333}.hljs-attr,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-title{color:#6f42c1}.hljs-addition{color:#55a532;background-color:#eaffea}.hljs-deletion{color:#bd2c00;background-color:#ffecec}.hljs-link{text-decoration:underline}.hljs-number{color:#005cc5}.hljs-string{color:#032f62}</style><blockquote>
<p>面向“多任务、多 Agent、可本地执行”的 AI 协作场景，这个仓库提供了一个完整的桌面端实现：前端负责多任务与对话体验，主进程负责 ACP 连接、权限与
系统能力，SQLite 做本地持久化，整体可离线运行并适配多个 Agent CLI。</p>
</blockquote>
<h2 data-id="heading-0">1. 项目定位与核心价值</h2>
<p>Open Claude Cowork 的核心定位是：让多个 AI Agent 以统一协议（ACP）在桌面端被管理、对话与协作。
其特点可以概括为：</p>
<ul>
<li>任务为中心：每个任务绑定独立工作区与 Agent 会话，适合长期协作。</li>
<li>ACP 统一协议：通过 @agentclientprotocol/sdk 统一接入不同 Agent CLI。</li>
<li>可控权限与工具调用可视化：工具调用、权限请求会被 UI 捕获并可人工确认。</li>
<li>本地数据与隐私优先：任务与设置落在本地 SQLite 中。</li>
</ul>
<h2 data-id="heading-1">2. 技术栈与工程化选型</h2>
<p>从 package.json 和构建配置来看，该项目是一个标准的 Electron 桌面应用，技术关键点如下：</p>
<ul>
<li>主进程：Electron + Node.js（TypeScript）</li>
<li>渲染层：React + Ant Design + Tailwind CSS</li>
<li>构建工具：Rsbuild（分别构建 main 与 render）</li>
<li>数据库：better-sqlite3（WAL 模式）</li>
<li>协议：ACP（Agent Client Protocol）</li>
<li>打包：electron-builder + plop 执行构建流程</li>
</ul>
<p>相关路径参考：package.json, builder/rsbuild.*.ts, builder.js, plopfile.js。</p>
<h2 data-id="heading-2">3. 架构总览（Main/Renderer/ACP）</h2>
<p>整体架构可以简化为三层：</p>
<p>Renderer (React UI)
│  window.electron.invoke / on
▼
Main Process (Electron)
├─ IPC: env / db / agent / dialog
├─ ACP: AcpAgentManager → AcpAgent → AcpConnection
└─ SQLite: settings / tasks</p>
<ul>
<li>Renderer 通过 preload.ts 暴露的 window.electron 调用 IPC。</li>
<li>Main 负责 连接 Agent、权限处理、文件读写、持久化。</li>
<li>ACP 协议通过 @agentclientprotocol/sdk 驱动 JSON-RPC 流。</li>
</ul>
<p>核心入口文件：src/main/index.ts、src/main/preload.ts、src/render/index.tsx、src/render/AppNew.tsx。</p>
<h2 data-id="heading-3">4. 核心模块详解</h2>
<h3 data-id="heading-4">4.1 Main 进程与 IPC 桥接</h3>
<p>主进程入口在 src/main/index.ts，主要职责包括：</p>
<ul>
<li>初始化数据库（initDB()）</li>
<li>注册自定义协议 wallpaper://</li>
<li>创建窗口（BrowserWindow）并加载 URL</li>
<li>注册 IPC 模块：env, dialog, db, agent</li>
</ul>
<p>IPC handler 分布：</p>
<ul>
<li>环境与系统能力：src/main/ipc/env.ts</li>
<li>选择文件/目录：src/main/ipc/dialog.ts</li>
<li>数据库 CRUD：src/main/ipc/db.ts</li>
<li>Agent 管理：src/main/ipc/agent.ts</li>
</ul>
<p>src/main/preload.ts 则通过 contextBridge 暴露最小能力：</p>
<p>window.electron.send / invoke / on</p>
<p>这保证了渲染层与主进程通信的安全边界。</p>
<h3 data-id="heading-5">4.2 ACP 接入链路（核心）</h3>
<p>ACP 的接入由四个核心类构成：</p>
<ol>
<li>AcpDetector（src/main/acp/AcpDetector.ts）
<ul>
<li>扫描本地 CLI（如 qwen、gemini、npx）</li>
<li>返回可用 Agent 列表</li>
<li>检测命令来自 ACP_BACKENDS_ALL（src/types/acpTypes.ts）</li>
</ul>
</li>
<li>AcpAgentManager（src/main/acp/AcpAgentManager.ts）
<ul>
<li>管理当前 Agent 实例、复用连接</li>
<li>解析命令、处理本地 bin 与 Node 运行时逻辑</li>
<li>提供 connect/send/stop/newSession/loadSession 等入口</li>
</ul>
</li>
<li>AcpAgent（src/main/acp/AcpAgent.ts）
<ul>
<li>会话级别控制，负责 initialize → newSession → prompt</li>
<li>支持 @file 文本扩展（读取工作区文件并拼入 prompt）</li>
<li>将 ACP 原始更新转为 UI 可用消息</li>
</ul>
</li>
<li>AcpConnection（src/main/acp/AcpConnection.ts）
<ul>
<li>spawn 子进程，并通过 ndJsonStream 建立 JSON-RPC 流</li>
<li>支持权限请求、文件读写、runShellCommand 扩展</li>
<li>具备 prompt 超时与暂停/恢复机制</li>
</ul>
</li>
</ol>
<p>这种分层使 ACP 逻辑清晰：连接、会话、消息适配、UI 通知各自隔离。</p>
<h3 data-id="heading-6">4.3 本地数据模型</h3>
<p>数据库在 src/main/db/store.ts 初始化：</p>
<ul>
<li>settings：保存自定义路径、主题、壁纸等</li>
<li>tasks：任务维度记录
<ul>
<li>id/title/workspace</li>
<li>agent_command/agent_env</li>
<li>messages/session_id/model_id/token_usage</li>
<li>created_at/updated_at/last_active_at</li>
</ul>
</li>
</ul>
<p>任务数据在 Renderer 内通过 IPC 持久化（db:create-task, db:update-task）。</p>
<h3 data-id="heading-7">4.4 渲染层交互与消息模型</h3>
<p>核心 UI 在 src/render/AppNew.tsx，特征包括：</p>
<ul>
<li>多任务状态管理：任务列表、当前任务、任务级连接状态</li>
<li>消息流与合并：
<ul>
<li>MessageComposer 合并流式文本与 tool_call 更新</li>
<li>messageTransformer 在 ACP 消息与 UI 消息之间转换</li>
</ul>
</li>
<li>环境检测与引导：EnvironmentSetup.tsx</li>
<li>设置与 Agent 配置：SettingsModal.tsx</li>
</ul>
<p>消息合并策略（src/render/utils/messageComposer.ts）体现为：</p>
<ul>
<li>msg_id 复用 → 文本流式拼接</li>
<li>toolCallId 对应 → tool call 状态更新合并</li>
<li>thought 单独拼接</li>
</ul>
<p>这保证了对话体验可连续显示，同时保留工具调用信息。</p>
<h3 data-id="heading-8">4.5 权限与工具调用展示</h3>
<p>ACP 支持权限请求与工具调用。
在本项目中：</p>
<ul>
<li>Main 在 AcpConnection.requestPermission 时会挂起 prompt 超时</li>
<li>Renderer 收到 permission_request 后展示 UI</li>
<li>用户反馈通过 agent:permission-response 返还给主进程</li>
<li>tool call 日志以 tool_call/tool_call_update 形式进入消息流</li>
</ul>
<h3 data-id="heading-9">4.6 环境与 Node 运行时管理</h3>
<p>为了支持本地 CLI Agent，需要 Node + npm：</p>
<ul>
<li>env:check 检测 Node/npm 版本</li>
<li>env:set-node-runtime 支持 custom Node 路径</li>
<li>env:run-install-command 支持一键安装（mac/linux nvm，Windows choco）</li>
</ul>
<p>对应 UI 在 EnvironmentSetup.tsx，会进行引导并展示执行日志。</p>
<h2 data-id="heading-10">5. 关键流程拆解</h2>
<h3 data-id="heading-11">5.1 应用启动流程</h3>
<ol>
<li>main/index.ts 初始化 DB</li>
<li>注册 wallpaper:// 协议</li>
<li>创建窗口并加载 Renderer</li>
<li>注册 IPC handlers</li>
<li>初始化 ACP CLI 检测器</li>
</ol>
<h3 data-id="heading-12">5.2 会话与消息流（关键）</h3>
<p>Renderer (SendBox)
→ ipc invoke agent:connect
→ AcpAgentManager.connect()
→ AcpAgent.connect()
→ AcpConnection.spawn + initialize
→ session/new
→ session/update (streaming)
→ MessageTransformer → UI</p>
<h3 data-id="heading-13">5.3 任务与会话持久化</h3>
<ul>
<li>创建任务时写入 SQLite</li>
<li>切换任务时同步 agentCommand/workspace</li>
<li>sessionId 与 modelId 会写回任务表</li>
</ul>
<p>这使得任务在重启后仍能恢复状态。</p>
<h2 data-id="heading-14">6. 构建与发布链路</h2>
<p>构建逻辑集中在 plopfile.js 与 builder.js：</p>
<ul>
<li>pnpm run dev → Rsbuild render + nodemon main</li>
<li>pnpm run build → build main + render + electron-builder</li>
<li>BUILD_PLATFORM 支持 darwin/win/linux</li>
</ul>
<p>打包配置：</p>
<ul>
<li>mac：dmg、签名、MAS 配置</li>
<li>win：nsis 安装包</li>
<li>linux：deb/rpm</li>
</ul>
<p>输出目录：release/app//。</p>
<h2 data-id="heading-15">7. 扩展点与可演进空间</h2>
<p>当前扩展方式主要集中在：</p>
<ul>
<li>ACP Agent 列表：ACP_BACKENDS_ALL + registry</li>
<li>自定义命令与 env：UI 允许输入 Agent command/env</li>
<li>runShellCommand 权限机制：可继续做细粒度策略</li>
</ul>
<p>可进一步演进为：</p>
<ul>
<li>MCP/其他协议并行接入</li>
<li>agent 管理与版本锁定</li>
<li>工作区文件权限白名单</li>
</ul>
<h2 data-id="heading-16">8. 截图</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74f55ba5df504268b78432d7244e2c0b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-m4oeiEmuiKneWjq18=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770054492&amp;x-signature=W5JzulQTbO5ZzwFWjQIffuDaozc%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0c7f4b6c54a4415ae45e8077dd26fb6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-m4oeiEmuiKneWjq18=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770054492&amp;x-signature=0MypDL%2B9cLrtZASjkaTVKISyg5M%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/687ba2e5ba734eeca662c4c2346953df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-m4oeiEmuiKneWjq18=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770054492&amp;x-signature=5hbNyigGoynsPpxk2wxj97GeUns%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5894648ac866449895bbf7247cd46109~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-m4oeiEmuiKneWjq18=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770054492&amp;x-signature=01jdjqSHCtzQFkZOg4UnirjzC%2Fg%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4afcb6db37ce48fcb70403d571e358f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-m4oeiEmuiKneWjq18=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770054492&amp;x-signature=odAd8%2F0TQXk5RMtaxBP38KzMPm8%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/00894e88c3c643289c97370e8b66184b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-m4oeiEmuiKneWjq18=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770054492&amp;x-signature=Maw0rXXzlIdDfdy2KKgPxtf4z4Q%3D" alt="image.png" loading="lazy"/></p>
<p>Gtihub 地址 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FMaidang1%2Fopen-claude-cowork" target="_blank" title="https://github.com/Maidang1/open-claude-cowork" ref="nofollow noopener noreferrer">github.com/Maidang1/op…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[『n8n』读写本地文件]]></title>    <link>https://juejin.cn/post/7599585289946087487</link>    <guid>https://juejin.cn/post/7599585289946087487</guid>    <pubDate>2026-01-27T00:56:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599585289946087487" data-draft-id="7599585289946071103" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="『n8n』读写本地文件"/> <meta itemprop="keywords" content="LLM,DeepSeek,AIGC"/> <meta itemprop="datePublished" content="2026-01-27T00:56:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="德育处主任"/> <meta itemprop="url" content="https://juejin.cn/user/2673620576140030"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            『n8n』读写本地文件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2673620576140030/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    德育处主任
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T00:56:27.000Z" title="Tue Jan 27 2026 00:56:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>点赞 + 关注 + 收藏 = 学会了</strong></p>
<blockquote>
<p>整理了一个n8n小专栏，有兴趣的工友可以关注一下 👉 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fappmsgalbum%3F__biz%3DMzAwMjU3ODU5Ng%3D%3D%26action%3Dgetalbum%26album_id%3D4337364695070801925%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzAwMjU3ODU5Ng==&amp;action=getalbum&amp;album_id=4337364695070801925#wechat_redirect" ref="nofollow noopener noreferrer">《n8n修炼手册》</a></p>
</blockquote>
<p>在使用 n8n 搭建自动化工作流时，读写本地文件是最基础也最常用的操作。</p>
<p>比如在互联网上拉了一些数据回来需要保存到本地。</p>
<p>比如上游同事把文件发你，你要将其加载到 n8n 里做一些处理。</p>
<p>如果你使用 Docker 部署 n8n，读写本地文件的配置请参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FPyzSMK95vkXRHBUL1CrhRw" target="_blank" title="https://mp.weixin.qq.com/s/PyzSMK95vkXRHBUL1CrhRw" ref="nofollow noopener noreferrer">《『n8n』一招解决“无法读写本地文件”》</a></p>
<h2 data-id="heading-0">写入文件</h2>
<p>我用一个例子讲讲如何将数据保存到本地。</p>
<ol start="0">
<li>使用「HTTP节点」从接口把数据请求回来。</li>
<li>将数据存到到电脑。</li>
</ol>
<p>要实现这两步，在 n8n 中的工作流长这样子⬇️</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc69068742a946d8b5c72dc4454e43b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b636IKy5aSE5Li75Lu7:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770080187&amp;x-signature=2nl7RQM38HUnST%2B8fxdEm722zfI%3D" alt="01.png" loading="lazy"/></p>
<pre><code class="hljs language-rust" lang="rust">鼠标点击 <span class="hljs-punctuation">-&gt;</span> HTTP请求数据 <span class="hljs-punctuation">-&gt;</span> 将数据格式化（Convert） <span class="hljs-punctuation">-&gt;</span> 保存到本地（Write Files from Disk）
</code></pre>
<p>先看看「Convert to File」的配置。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe2a6cf7322142d08bc8bada3df974b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b636IKy5aSE5Li75Lu7:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770080187&amp;x-signature=qk1w6SFm0xO%2BzLoudqqHDL%2BsBho%3D" alt="02.png" loading="lazy"/></p>
<p>我将「HTTP 节点」请求回来的数据转成 Excel 文件，并将输出的对象放到一个 <code>data</code> 字段里。</p>
<p>「Write Files from Disk」节点将上个节点传入的数据保存到我指定的位置：</p>
<p><code>/home/node/.n8n-files/rw-test/posts.xlsx</code></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f8b1b607c834fc0a4eacac9267d3eab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b636IKy5aSE5Li75Lu7:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770080187&amp;x-signature=RFXkdL8K%2FpIgb5cQtGKkfBmFQ10%3D" alt="03.png" loading="lazy"/></p>
<p>注意，<code>posts.xlsx</code> 是我保存的文件名和后缀格式。</p>
<p>保存成功后就可以在指定位置找到它了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0342cca4cf74ec096fc325560b5e121~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b636IKy5aSE5Li75Lu7:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770080187&amp;x-signature=ealjiyMHS%2FF3VZacijAK6bAVA%2Fc%3D" alt="04.png" loading="lazy"/></p>
<h2 data-id="heading-1">读取文件</h2>
<p>读取文件的思路就反过来了。</p>
<p>首先找到文件，然后再将内容解析出来，让其他节点可以看得懂这个文件的内容。</p>
<p>所以工作流长这样⬇️</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb1ebdcff43b40c0af74c8575a561d88~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b636IKy5aSE5Li75Lu7:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770080187&amp;x-signature=eNeh9I4jQ83ZlsizJ6vLDB%2FPcks%3D" alt="05.png" loading="lazy"/></p>
<p>其实读取文件和写入文件都是用同一个节点（Read/Write Files from Disk），只是 <code>Operation</code> 属性不一样而已。</p>
<p>在这个工作流中，「Read Files from Disk」的 <code>Operation</code> 选择 <code>Read File(s) From Disk</code>，再指定一个文件路径就行了。</p>
<p>可以看到它输出了一个 <code>data</code> 。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55a1d0c98b274741ace3ca4ce05183f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b636IKy5aSE5Li75Lu7:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770080187&amp;x-signature=GC1tOM7XMI9u7b1Xx%2Fgpsjp8rgQ%3D" alt="06.png" loading="lazy"/></p>
<p>要让其他工作流读懂这个 <code>data</code> 里面写了什么内容，需要用到「Extract from File 节点」。</p>
<p>在「Extract from File 节点」里，我们要正确设置 <code>Operation</code> 的值，这个参数指的是现在读取到的文件对象它原本是什么格式（比如我这个是 Excel 文件，就用 <code>Extract From XLSX</code>，其他格式就用其他类型）。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f77b8993d224c65a977a1ba6eb688d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b636IKy5aSE5Li75Lu7:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770080187&amp;x-signature=ui8UREmv80BxTCwOmAmwU8iaoKc%3D" alt="07.png" loading="lazy"/></p>
<p>读取成功后，「Extract from File 节点」就会将内容输出给下一个节点。右侧面板就是读取到的内容。</p>
<hr/>
<p>以上就是本文的全部内容啦，想了解更多n8n玩法欢迎关注<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fappmsgalbum%3F__biz%3DMzAwMjU3ODU5Ng%3D%3D%26action%3Dgetalbum%26album_id%3D4337364695070801925%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzAwMjU3ODU5Ng==&amp;action=getalbum&amp;album_id=4337364695070801925#wechat_redirect" ref="nofollow noopener noreferrer">《n8n修炼手册》</a>👏</p>
<p>如果你有 NAS，我非常建议你在 NAS 上部署一套 n8n，搞搞副业也好，帮你完成工作任务也好 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FppIWKP8StiFn2k2IW0ZpNQ" target="_blank" title="https://mp.weixin.qq.com/s/ppIWKP8StiFn2k2IW0ZpNQ" ref="nofollow noopener noreferrer">《『NAS』不止娱乐，NAS也是生产力，在绿联部署AI工作流工具-n8n》</a></p>
<p><strong>点赞 + 关注 + 收藏 = 学会了</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何让同一个 Guard、Interceptor、Exception Filter 在不同类型的服务里复用？]]></title>    <link>https://juejin.cn/post/7599581204860682266</link>    <guid>https://juejin.cn/post/7599581204860682266</guid>    <pubDate>2026-01-27T02:49:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599581204860682266" data-draft-id="7599094262593536010" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何让同一个 Guard、Interceptor、Exception Filter 在不同类型的服务里复用？"/> <meta itemprop="keywords" content="前端,NestJS,Node.js"/> <meta itemprop="datePublished" content="2026-01-27T02:49:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端付豪"/> <meta itemprop="url" content="https://juejin.cn/user/1741228277763278"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何让同一个 Guard、Interceptor、Exception Filter 在不同类型的服务里复用？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1741228277763278/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端付豪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T02:49:31.000Z" title="Tue Jan 27 2026 02:49:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Nest 可以创建 HTTP 、WebSocket ，还有基于 TCP 服务</p>
<p>这都支持 Guard、Interceptor、Exception Filter 功能</p>
<p>问题是不同服务拿到的参数不同，比如 http 服务可以拿到 request、response 对象，而 websocket 没有。</p>
<p>那如何让同一个 Guard、Interceptor、Exception Filter 在不同类型的服务里复用？</p>
<p>使用 ArgumentHost 这个类</p>
<p>新建项目试试看</p>
<pre><code class="hljs language-arduino" lang="arduino">nest <span class="hljs-keyword">new</span> argument-host

</code></pre>
<p>新建 filter</p>
<pre><code class="hljs language-css" lang="css">nest g <span class="hljs-attribute">filter</span> aaa <span class="hljs-attr">--flat</span> <span class="hljs-attr">--no-spec</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3dcd65429f6140f1b361afffa1ca44b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770086970&amp;x-signature=0k8t89UuBvdsq23UtpOZZ%2FgSt9g%3D" alt="image.png" loading="lazy"/></p>
<p>Nest 会 catch 所有未捕获异常，如果是 Exception Filter 声明的异常，那就会调用 filter 来处理</p>
<p>创建一个自定义的异常类</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b70807f215614b1ca8d05f35b2968c21~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770086970&amp;x-signature=QxD247Nx3l6SkKSrF%2FBrDWAbIh8%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/04e6743f78264e328af139e703fdcbcc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770086970&amp;x-signature=NtrenCGZDPiiGPpJmOHYqiRvdWs%3D" alt="image.png" loading="lazy"/></p>
<p>使用</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e9b3d73febf4186887c08ad35bb756a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770086970&amp;x-signature=fFgkS1Zfn06NolSdYbP3vZgX9ag%3D" alt="image.png" loading="lazy"/></p>
<p>启动服务 可以看到打印</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1c5e2276c854de7ae6c0df46e5283e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770086970&amp;x-signature=7YV%2FpBrU%2FytbNRs4WJgBAM7YgKM%3D" alt="image.png" loading="lazy"/></p>
<p>filter 的第一个参数就是异常对象，第二个参数有这些方法</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2300880014a341918211cce68e3d617b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770086970&amp;x-signature=0xD10He9dljJYSjFyREtc0FrJL4%3D" alt="image.png" loading="lazy"/></p>
<p>.vscode/launch.json 添加调试看看</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"request"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"launch"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"debug nest"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"runtimeExecutable"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npm"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"run"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"start:dev"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"skipFiles"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"&lt;node_internals&gt;/**"</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"console"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"integratedTerminal"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>打断点</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/452e8222c45f4d93a39cdac19c55daa0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770086970&amp;x-signature=WH1Wo8AvKKWIIcgdwjz53%2FCVhH0%3D" alt="image.png" loading="lazy"/></p>
<p>启动</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c4ea6c8703844d0facaa6f7b1d87046d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770086970&amp;x-signature=TIXgpKPYdJb7eg9Vj9VbiQVFndA%3D" alt="image.png" loading="lazy"/></p>
<p>host.getArgs 拿到 reqeust、response、next 参数</p>
<p>host.getArgByIndex 下标取参数</p>
<p>调用 switchToHttp 切换到 http 上下文，然后再调用 getRequest、getResponse 方法</p>
<p>websocket、基于 tcp 的微服务等上下文，就分别调用 host.swtichToWs、host.switchToRpc 方法</p>
<p>这样，就可以在 filter 里处理多个上下文的逻辑，跨上下文复用 filter</p>
<p>类似这样</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ArgumentsHost</span>, <span class="hljs-title class_">Catch</span>, <span class="hljs-title class_">ExceptionFilter</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Response</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'express'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AaaException</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./AaaException'</span>;

<span class="hljs-meta">@Catch</span>(<span class="hljs-title class_">AaaException</span>)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AaaFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ExceptionFilter</span> {
  <span class="hljs-keyword">catch</span>(<span class="hljs-attr">exception</span>: <span class="hljs-title class_">AaaException</span>, <span class="hljs-attr">host</span>: <span class="hljs-title class_">ArgumentsHost</span>) {
    <span class="hljs-keyword">if</span>(host.<span class="hljs-title function_">getType</span>() === <span class="hljs-string">'http'</span>) {
      <span class="hljs-keyword">const</span> ctx = host.<span class="hljs-title function_">switchToHttp</span>();
      <span class="hljs-keyword">const</span> response = ctx.<span class="hljs-property">getResponse</span>&lt;<span class="hljs-title class_">Response</span>&gt;();
      <span class="hljs-keyword">const</span> request = ctx.<span class="hljs-property">getRequest</span>&lt;<span class="hljs-title class_">Request</span>&gt;();

      response
        .<span class="hljs-title function_">status</span>(<span class="hljs-number">500</span>)
        .<span class="hljs-title function_">json</span>({
          <span class="hljs-attr">value1</span>: exception.<span class="hljs-property">value1</span>,
          <span class="hljs-attr">value2</span>: exception.<span class="hljs-property">value2</span>
        });
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(host.<span class="hljs-title function_">getType</span>() === <span class="hljs-string">'ws'</span>) {

    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(host.<span class="hljs-title function_">getType</span>() === <span class="hljs-string">'rpc'</span>) {

    }
  }
}
</code></pre>
<p>启动</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f20fc23db3f416fa1ce8ceb5a44f826~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770086970&amp;x-signature=9pfQgMUQlF%2FL%2FRXIHP8zd0lwnJs%3D" alt="image.png" loading="lazy"/></p>
<p><strong>ArgumentHost 是用于切换 http、websocket、rpc 等上下文类型的，可以根据上下文类型取到对应的 argument，让 Exception Filter 等在不同的上下文中复用</strong></p>
<p>在 guard 和 interceptor 会是怎样 ？</p>
<pre><code class="hljs language-css" lang="css">nest g guard aaa <span class="hljs-attr">--no-spec</span> <span class="hljs-attr">--flat</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a099eb1f12c74cd99f6fdd5dab2f054c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770086970&amp;x-signature=4liNxyvzt4Xidx0An1wbWyIfSq0%3D" alt="image.png" loading="lazy"/></p>
<p>有这些方法  和上面看到的很类似</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d898dde3a5774756ab0db8707278a0dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770086970&amp;x-signature=LkGE3xzWWazBdhIFqlzYx15CIJM%3D" alt="image.png" loading="lazy"/></p>
<p>因为 ExecutionContext 是 ArgumentHost 的子类，扩展了 getClass、getHandler 方法</p>
<p>getClass、getHandler有啥作用？</p>
<p>再次调试看看</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ee1cd51fa1b452783dbf66397bd8e67~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770086970&amp;x-signature=PEnjpKjoK%2F0R411GDEbsscx2n5Y%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97783904526847c084c7816a7c9bc2a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770086970&amp;x-signature=8Psl7wYnFgqGXAWWce3dbWUUqK0%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0956d443073c4076bf58154aaf6a0855~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770086970&amp;x-signature=rHatd76RxhkLO4tnHIa6jMmx318%3D" alt="image.png" loading="lazy"/></p>
<p>作用分别是要调用的 controller 的 class 以及要调用的方法</p>
<p>为什么 ExecutionContext 里需要拿到目标 class 和 handler 呢？</p>
<p>因为 Guard、Interceptor 的逻辑可能要根据目标 class、handler 有没有某些装饰而决定怎么处理</p>
<p>比如权限校验例子</p>
<pre><code class="hljs language-css" lang="css">nest g decorator roles <span class="hljs-attr">--flat</span> <span class="hljs-attr">--no-spec</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a20598b973754b9389bbb685e058e4c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770086970&amp;x-signature=BWvgHpJMiLNcL8TaDlWvaiCpgLk%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89e98bafcb40484684062da36a9a299a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770086970&amp;x-signature=qO8N99h7n0cfBGvQSK0GtvPZ%2BZk%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/711e630bbd494278bab9cac4e532b65c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770086970&amp;x-signature=HTBr8GAfuVCOK%2BaswKX6xeAvaTo%3D" alt="image.png" loading="lazy"/></p>
<p>Guard 里通过 ExecutionContext 的 getHandler 方法拿到了目标 handler 方法。</p>
<p>然后通过 reflector 的 api 拿到它的 metadata。</p>
<p>判断如果没有 roles 的 metadata 就是需要权限，那就直接放行。</p>
<p>如果有，就是需要权限，从 user 的 roles中判断下又没有当前 roles，有的话就放行。</p>
<p>刷新页面，可以看到返回的是 403</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83f71e0a331e4538a78252feb45407a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770086970&amp;x-signature=BHbbEucU2Dh1U4apQ9UrdMTnOjk%3D" alt="image.png" loading="lazy"/></p>
<p>同理，在 interceptor 里也有这个</p>
<pre><code class="hljs language-css" lang="css"> nest g interceptor aaa <span class="hljs-attr">--no-spec</span> <span class="hljs-attr">--flat</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/084b4e86ea214c9484ebfc271506309e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770086970&amp;x-signature=kV3oayHMl4IKpOob%2FogZ5KodUmc%3D" alt="image.png" loading="lazy"/></p>
<p>自然也可以 通过 reflector 取出 class 或者 handler 上的 metdadata</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[面试复盘：0.1 + 0.2 === 0.3 结果是 ？附精准解决办法]]></title>    <link>https://juejin.cn/post/7599604510365909030</link>    <guid>https://juejin.cn/post/7599604510365909030</guid>    <pubDate>2026-01-27T02:56:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599604510365909030" data-draft-id="7599581687358849074" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="面试复盘：0.1 + 0.2 === 0.3 结果是 ？附精准解决办法"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-27T02:56:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="hypoy"/> <meta itemprop="url" content="https://juejin.cn/user/3074670624777223"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            面试复盘：0.1 + 0.2 === 0.3 结果是 ？附精准解决办法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3074670624777223/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    hypoy
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T02:56:08.000Z" title="Tue Jan 27 2026 02:56:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">面试复盘：0.1 + 0.2 === 0.3 结果是 ？附精准解决办法</h2>
<p>最近面试被问到一个超经典的 JS 问题：<code>0.1 + 0.2 === 0.3</code> 对不对？我马上说肯定不对，但面试官接着追问为啥返回 false，我只答得出 “浮点数精度问题” 这个表面原因，再往下说就卡壳了。今天就把这个问题掰开揉碎复盘，从根上的原理到实际能用的解决办法，一次性讲明白。</p>
<h3 data-id="heading-1">一、先看现象：反直觉的结果</h3>
<p>先执行一段简单的代码，验证这个反直觉的现象：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">0.1</span> + <span class="hljs-number">0.2</span>); <span class="hljs-comment">// 输出 0.30000000000000004</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">0.1</span> + <span class="hljs-number">0.2</span> === <span class="hljs-number">0.3</span>); <span class="hljs-comment">// 输出 false</span>
</code></pre>
<p>明明 0.1 加 0.2 数学上等于 0.3，为什么在 JS 里却不是？核心原因藏在 JavaScript 对数字的存储方式里。</p>
<h3 data-id="heading-2">二、底层原因：二进制浮点数的 “先天缺陷”</h3>
<p>JavaScript 遵循 <strong>IEEE 754 标准</strong>，所有数字（整数、小数）都以 64 位双精度浮点数（Double-precision floating-point format）存储。这个标准的设计本身，导致了部分十进制小数无法被二进制精确表示。</p>
<h4 data-id="heading-3">1. 十进制转二进制的 “无限循环”</h4>
<p>我们先回忆十进制转二进制小数的规则：乘 2 取整，直到小数部分为 0。以 0.1 为例：</p>
<pre><code class="hljs language-ini" lang="ini">0.1 × <span class="hljs-attr">2</span> = <span class="hljs-number">0.2</span> → 取整 <span class="hljs-number">0</span>
0.2 × <span class="hljs-attr">2</span> = <span class="hljs-number">0.4</span> → 取整 <span class="hljs-number">0</span>
0.4 × <span class="hljs-attr">2</span> = <span class="hljs-number">0.8</span> → 取整 <span class="hljs-number">0</span>
0.8 × <span class="hljs-attr">2</span> = <span class="hljs-number">1.6</span> → 取整 <span class="hljs-number">1</span>，剩余 <span class="hljs-number">0.6</span>
0.6 × <span class="hljs-attr">2</span> = <span class="hljs-number">1.2</span> → 取整 <span class="hljs-number">1</span>，剩余 <span class="hljs-number">0.2</span>
... 循环往复，永远无法得到 0
</code></pre>
<p>最终，0.1 的二进制是 <strong>无限循环小数</strong>：<code>0.0001100110011...(0011 循环)</code>。</p>
<p>同理，0.2 的二进制也是无限循环小数。而 64 位双精度浮点数的存储空间有限，只能截取前 52 位有效数字（尾数部分）进行存储，这就导致了 <strong>精度丢失</strong>。</p>
<h4 data-id="heading-4">2. 精度丢失后的计算</h4>
<p>0.1 和 0.2 存储时都被 “近似处理” 了，两者相加后，结果自然不是精确的 0.3，而是一个接近 0.3 的数（0.30000000000000004），因此 <code>===</code> 严格相等判断会返回 false。</p>
<p>简单总结：不是 JS 计算错了，而是十进制的 0.1 和 0.2 无法被二进制浮点数精确表示，存储和计算时的近似值导致了结果偏差。</p>
<h3 data-id="heading-5">三、解决方案：如何正确比较 0.1 + 0.2 和 0.3？</h3>
<p>知道了原因，我们需要对应的解决方案，核心思路是 “规避浮点数精度问题”，常见方案有 3 种：</p>
<h4 data-id="heading-6">方案 1：设置误差阈值（最常用）</h4>
<p>既然结果是近似值，我们可以允许一个极小的误差范围（通常用 <code>Number.EPSILON</code>，表示 JS 中能表示的最小精度差），只要两个数的差值小于这个阈值，就认为相等。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 封装通用的浮点数比较函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">isEqual</span>(<span class="hljs-params">a, b, epsilon = <span class="hljs-built_in">Number</span>.EPSILON</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(a - b) &lt; epsilon;
}
<span class="hljs-comment">// 测试</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">isEqual</span>(<span class="hljs-number">0.1</span> + <span class="hljs-number">0.2</span>, <span class="hljs-number">0.3</span>)); <span class="hljs-comment">// true</span>
</code></pre>
<p><code>Number.EPSILON</code> 的值约为 2.220446049250313e-16，是 JS 中两个可表示的浮点数之间的最小差值，完全满足日常精度需求。</p>
<h4 data-id="heading-7">方案 2：转整数计算（适合金融场景）</h4>
<p>浮点数精度问题在金额计算中尤为致命（比如 0.1 元 + 0.2 元），此时可以将小数转为整数（乘以 10 的 n 次方），计算后再转回来，从根源避免浮点数运算。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 0.1 + 0.2 转整数计算</span>
<span class="hljs-keyword">const</span> a = <span class="hljs-number">0.1</span>, b = <span class="hljs-number">0.2</span>;
<span class="hljs-keyword">const</span> sum = (a * <span class="hljs-number">10</span> + b * <span class="hljs-number">10</span>) / <span class="hljs-number">10</span>; <span class="hljs-comment">// (1 + 2)/10 = 0.3</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(sum === <span class="hljs-number">0.3</span>); <span class="hljs-comment">// true</span>

<span class="hljs-comment">// 金额计算示例：1.23 元 + 4.56 元</span>
<span class="hljs-keyword">const</span> price1 = <span class="hljs-number">1.23</span>, price2 = <span class="hljs-number">4.56</span>;
<span class="hljs-keyword">const</span> total = (price1 * <span class="hljs-number">100</span> + price2 * <span class="hljs-number">100</span>) / <span class="hljs-number">100</span>; <span class="hljs-comment">// 579 / 100 = 5.79</span>
</code></pre>
<h4 data-id="heading-8">方案 3：使用成熟的数学库（推荐复杂场景）</h4>
<p>如果是企业级金融、科学计算等高精度场景，手动处理容易出错，推荐使用成熟的库：</p>
<ul>
<li><strong>decimal.js</strong>：功能全面的高精度十进制运算库</li>
<li><strong>big.js</strong>：轻量、专注于高精度小数运算</li>
<li><strong>bignumber.js</strong>：兼容 IEEE 754 标准，适合金融场景</li>
</ul>
<p>以 <code>big.js</code> 为例：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 先安装：npm install big.js</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Big</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'big.js'</span>);

<span class="hljs-keyword">const</span> a = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Big</span>(<span class="hljs-number">0.1</span>);
<span class="hljs-keyword">const</span> b = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Big</span>(<span class="hljs-number">0.2</span>);
<span class="hljs-keyword">const</span> sum = a.<span class="hljs-title function_">plus</span>(b); <span class="hljs-comment">// 0.3</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(sum.<span class="hljs-title function_">eq</span>(<span class="hljs-number">0.3</span>)); <span class="hljs-comment">// true</span>
</code></pre>
<h3 data-id="heading-9">四、面试延伸：常见误区与补充</h3>
<ol>
<li><strong>误区</strong>：“只有 0.1 + 0.2 有问题”—— 其实所有无法被二进制精确表示的十进制小数运算都可能有精度问题，比如 0.7 + 0.1 = 0.7999999999999999。</li>
<li><strong>补充</strong>：整数运算为什么没问题？因为十进制整数可以被二进制精确表示（只要不超过 2^53，超过后也会丢失精度）。</li>
</ol>
<h3 data-id="heading-10">五、总结</h3>
<p>回到面试题，完整的回答应该包含 3 个核心点：</p>
<ol>
<li><strong>底层原因</strong>：JS 遵循 IEEE 754 标准，用 64 位双精度浮点数存储数字，0.1 和 0.2 的二进制是无限循环小数，存储时精度丢失；</li>
<li><strong>现象本质</strong>：精度丢失后的 0.1 + 0.2 结果是 0.30000000000000004，而非精确的 0.3，因此严格相等判断为 false；</li>
<li><strong>解决方案</strong>：日常场景用误差阈值（Number.EPSILON），金融场景转整数计算或使用 <code>decimal.js/big.js</code> 等库。</li>
</ol>
<p>这个问题看似简单，实则考察对 JS 数字存储底层的理解，记住 “现象 - 原因 - 解决方案” 的逻辑链，面试时就能从容应对了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Claude Code按量安装教程：低成本使用AI编程的方法]]></title>    <link>https://juejin.cn/post/7599483794658328617</link>    <guid>https://juejin.cn/post/7599483794658328617</guid>    <pubDate>2026-01-27T01:38:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599483794658328617" data-draft-id="7599483794658312233" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Claude Code按量安装教程：低成本使用AI编程的方法"/> <meta itemprop="keywords" content="Claude"/> <meta itemprop="datePublished" content="2026-01-27T01:38:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户815091607260"/> <meta itemprop="url" content="https://juejin.cn/user/2042264015120554"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Claude Code按量安装教程：低成本使用AI编程的方法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2042264015120554/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户815091607260
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T01:38:49.000Z" title="Tue Jan 27 2026 01:38:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>还在为 Claude Code 无法直连、API 配额受限而头疼吗？<br/>
Claude Code 作为当前最强的 AI 编程 CLI 工具之一，已经能真正做到“读懂整个项目、直接改代码、生成提交”。但很多人卡在第一步：官方 API 难用、网络受限、模型切换复杂。</p>
<p>本文将手把手教你 通过「神马中转 API」快速接入 Claude Code，从安装、环境变量配置，到模型切换与最小可用示例，5 分钟跑起来，10 分钟上生产，让 Claude Code 真正成为你的本地 AI 编程助手。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94aab4b3a2a14f4fba489d74f6f276b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODE1MDkxNjA3MjYw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770082729&amp;x-signature=sezNcn6XNALfz1EzvmVQNwVc8%2Bg%3D" alt="【2026最新】AI编程工具：Claude Code AI中转站按量安装使用教程" loading="lazy"/></p>
<h2 data-id="heading-0">Claude Code + API中转站的组合</h2>
<ul>
<li>
<p><strong>Claude Code</strong>：Anthropic 推出的命令行 AI 编程工具（能读懂项目上下文、按自然语言改代码、跑命令、生成测试等）。</p>
</li>
<li>
<p><strong>API 中转站（这里用：神马中转API）</strong>：用你在神马平台生成的 Token，把 Claude Code 的请求转发到可用模型上；核心就是配置两个东西：</p>
<ul>
<li>
<p>ANTHROPIC_AUTH_TOKEN（你的 sk-xxx）</p>
</li>
<li>
<p>ANTHROPIC_BASE_URL（指向神马中转的 BaseURL：<a href="https://link.juejin.cn?target=https%3A%2F%2Fapi.whatai.cc%25EF%25BC%2589" target="_blank" title="https://api.whatai.cc%EF%BC%89" ref="nofollow noopener noreferrer">api.whatai.cc）</a></p>
</li>
</ul>
</li>
</ul>
<h2 data-id="heading-1">安装前准备</h2>
<h3 data-id="heading-2">必备环境</h3>
<ul>
<li><strong>Node.js 18+（建议 LTS）</strong>：Claude Code 通过 npm 安装，Node 版本要够新。</li>
</ul>
<p>验证是否安装成功（任意系统都适用）：</p>
<pre><code class="hljs language-css" lang="css">node <span class="hljs-attr">--version</span>
npm <span class="hljs-attr">--version</span>
</code></pre>
<p>示例里提到 Node 版本通常会在 v18.x.x 以上。</p>
<h2 data-id="heading-3">安装Claude Code（通用）</h2>
<p>用 npm 全局安装：</p>
<pre><code class="hljs language-bash" lang="bash">npm install -g @anthropic-ai/claude-code
</code></pre>
<p>文档与文章都给的是这条命令。</p>
<h2 data-id="heading-4">配置：接入「神马中转 API」</h2>
<h3 data-id="heading-5">第一步：在神马平台生成 Token</h3>
<p>去神马中转平台后台创建/复制你的 <strong>sk- 开头</strong> Token（文章里也强调 Token 是 sk-xxx 这种格式）。</p>
<h3 data-id="heading-6">第二步：设置环境变量（关键）</h3>
<p>你需要设置两项（重点就是它俩）：</p>
<ul>
<li>
<p>ANTHROPIC_AUTH_TOKEN</p>
</li>
<li>
<p>ANTHROPIC_BASE_URL</p>
</li>
</ul>
<h3 data-id="heading-7">macOS / Linux（Bash 或 Zsh）</h3>
<p><strong>Bash：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">'export ANTHROPIC_AUTH_TOKEN="sk-xxx"'</span> &gt;&gt; ~/.bash_profile
<span class="hljs-built_in">echo</span> <span class="hljs-string">'export ANTHROPIC_BASE_URL="https://api.whatai.cc"'</span> &gt;&gt; ~/.bash_profile
<span class="hljs-built_in">source</span> ~/.bash_profile
</code></pre>
<p><strong>Zsh：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">'export ANTHROPIC_AUTH_TOKEN="sk-xxx"'</span> &gt;&gt; ~/.zshrc
<span class="hljs-built_in">echo</span> <span class="hljs-string">'export ANTHROPIC_BASE_URL="https://api.whatai.cc"'</span> &gt;&gt; ~/.zshrc
<span class="hljs-built_in">source</span> ~/.zshrc
</code></pre>
<blockquote>
<p>设置后如果不生效，重启终端</p>
</blockquote>
<h3 data-id="heading-8">Windows（推荐图形化 / PowerShell / CMD）</h3>
<p><strong>方法一：图形化（推荐、永久生效）</strong></p>
<p>系统环境变量里新增：</p>
<ul>
<li>
<p>ANTHROPIC_AUTH_TOKEN = sk-xxx</p>
</li>
<li>
<p>ANTHROPIC_BASE_URL = <a href="https://link.juejin.cn?target=https%3A%2F%2Fapi.whatai.cc" target="_blank" title="https://api.whatai.cc" ref="nofollow noopener noreferrer">api.whatai.cc</a></p>
</li>
</ul>
<p><strong>方法二：PowerShell（永久）</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[Environment]</span>::<span class="hljs-built_in">SetEnvironmentVariable</span>(<span class="hljs-string">"ANTHROPIC_AUTH_TOKEN"</span>, <span class="hljs-string">"sk-xxx"</span>, <span class="hljs-string">"User"</span>)
[Environment]::<span class="hljs-built_in">SetEnvironmentVariable</span>(<span class="hljs-string">"ANTHROPIC_BASE_URL"</span>, <span class="hljs-string">"https://api.whatai.cc"</span>, <span class="hljs-string">"User"</span>)
</code></pre>
<p><strong>方法三：CMD（永久）</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">setx ANTHROPIC_AUTH_TOKEN <span class="hljs-string">"sk-xxx"</span>
setx ANTHROPIC_BASE_URL <span class="hljs-string">"https://api.whatai.cc"</span>
</code></pre>
<h3 data-id="heading-9">Windows 进阶：用 settings.json 一次性写入（可带模型）</h3>
<p>如果你更喜欢“写配置文件”的方式，文档给了路径与示例结构：</p>
<p>C:\Users\{user}\.claude\settings.json</p>
<p>示例（你要把 token 改成自己的）：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"env"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"ANTHROPIC_MODEL"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"claude-sonnet-4-20250514"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"ANTHROPIC_SMALL_FAST_MODEL"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"claude-sonnet-4-20250514"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"ANTHROPIC_BASE_URL"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://api.whatai.cc"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"ANTHROPIC_AUTH_TOKEN"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sk-xxx"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-10">启动与最小可用验证</h2>
<p>进入你的项目目录，然后启动：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> your-project-folder
claude
</code></pre>
<p>文档就是这么启动的。</p>
<p>首次启动一般会引导你做一些初始化选择（主题、确认提示、信任目录等）。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d500507f768445e8b030f8f4c53f8c11~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODE1MDkxNjA3MjYw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770082729&amp;x-signature=3cDM2oZS3NNZIvaOsqwOOnyxsFE%3D" alt="【2026最新】AI编程工具：Claude Code AI中转站按量安装使用教程" loading="lazy"/></p>
<h2 data-id="heading-11">简单使用：3分钟上手</h2>
<h3 data-id="heading-12">常用命令（最常用的就这些）</h3>
<ul>
<li>
<p>claude：进入交互模式</p>
</li>
<li>
<p>claude "task"：跑一次性任务</p>
</li>
<li>
<p>claude commit：让它帮你生成/组织 Git 提交</p>
</li>
<li>
<p>/help：查看内置命令</p>
</li>
<li>
<p>/clear：清空对话上下文</p>
</li>
<li>
<p>/review：让它做代码审查</p>
</li>
</ul>
<h3 data-id="heading-13">最小示例：让它写个函数</h3>
<p>在 claude 交互模式里直接说人话，例如（文档示例）：</p>
<ul>
<li>“请帮我写一个 Python 函数，用于计算斐波那契数列”</li>
</ul>
<h3 data-id="heading-14">一句话做代码审查</h3>
<p>直接单次命令：</p>
<pre><code class="hljs language-arduino" lang="arduino">claude <span class="hljs-string">"review this code for potential bugs"</span>
</code></pre>
<p>这是文档给的示例之一。</p>
<h2 data-id="heading-15">切换模型（重点：/model）</h2>
<p>在 Claude Code 里用：</p>
<pre><code class="hljs language-bash" lang="bash">/model [model <span class="hljs-built_in">id</span>]
</code></pre>
<p>文档举例：默认 Sonnet 4，也可以切到 Opus 4：</p>
<pre><code class="hljs language-bash" lang="bash">/model opus
</code></pre>
<p>还给了类似 claude-3-7-sonnet-20250219 的切换示例，以及 Kimi K2 的示例（/model moonshotai/kimi-k2-instruct），并说明其他 LLM（OpenAI/Gemini/Qwen/Doubao 等）也能用。</p>
<blockquote>
<p>小提醒：不同中转站对“模型名/别名”的支持可能不完全一样</p>
</blockquote>
<h2 data-id="heading-16">常见坑位</h2>
<ol>
<li>
<p><strong>Token 要换成你自己的</strong>：别把示例 sk-xxx 当真。</p>
</li>
<li>
<p><strong>环境变量改完要重启终端</strong>（尤其 Windows / macOS）。</p>
</li>
<li>
<p><strong>建议在具体项目目录下用</strong>，Claude Code 才能更好读上下文。</p>
</li>
<li>
<p>文档提到：创建令牌时可考虑选择特定分组（示例里建议“企业分组 官转分组”）。</p>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Node.js 编程实战：部署 Node.js 应用 —— Nginx 反向代理]]></title>    <link>https://juejin.cn/post/7599581687358930994</link>    <guid>https://juejin.cn/post/7599581687358930994</guid>    <pubDate>2026-01-27T02:58:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599581687358930994" data-draft-id="7599604510365941798" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Node.js 编程实战：部署 Node.js 应用 —— Nginx 反向代理"/> <meta itemprop="keywords" content="前端,后端,Node.js"/> <meta itemprop="datePublished" content="2026-01-27T02:58:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员爱钓鱼"/> <meta itemprop="url" content="https://juejin.cn/user/2799775299157614"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Node.js 编程实战：部署 Node.js 应用 —— Nginx 反向代理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2799775299157614/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员爱钓鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T02:58:57.000Z" title="Tue Jan 27 2026 02:58:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>当 Node.js 应用部署到服务器之后，如果直接对外暴露应用端口（如 3000），在<strong>安全性、性能与可维护性</strong>方面都会存在明显不足。</p>
</blockquote>
<p>在生产环境中，几乎所有成熟系统都会在 Node.js 服务前增加一层 <strong>Nginx 反向代理</strong>，由 Nginx 统一对外提供访问入口，Node.js 只负责业务逻辑处理。</p>
<p>本文将从实战角度，系统讲解如何使用 Nginx 为 Node.js 应用配置反向代理，并介绍常见的部署模式与优化建议。</p>
<hr/>
<h2 data-id="heading-0">一、为什么要使用 Nginx 反向代理</h2>
<p>在 Node.js 服务前增加 Nginx，主要可以解决以下问题：</p>
<ol>
<li>
<ol>
<li>统一访问入口<br/>
用户只访问 80 / 443 端口，不需要感知后端端口号。</li>
</ol>
</li>
<li>
<ol start="2">
<li>提高安全性<br/>
隐藏 Node.js 服务真实端口，减少被扫描和攻击的风险。</li>
</ol>
</li>
<li>
<ol start="3">
<li>支持 HTTPS<br/>
由 Nginx 终止 SSL 连接，Node.js 只处理 HTTP。</li>
</ol>
</li>
<li>
<ol start="4">
<li>静态资源加速<br/>
Nginx 高效处理图片、JS、CSS 等静态资源。</li>
</ol>
</li>
<li>
<ol start="5">
<li>负载均衡<br/>
可将请求分发到多个 Node.js 实例。</li>
</ol>
</li>
<li>
<ol start="6">
<li>平滑重启与容错<br/>
Node.js 重启时，Nginx 仍可提供基础服务。</li>
</ol>
</li>
</ol>
<hr/>
<h2 data-id="heading-1">二、基础部署架构</h2>
<p>一个典型的部署架构如下：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">用户浏览器</span>
     <span class="hljs-string">|</span>
     <span class="hljs-string">|</span> <span class="hljs-number">80</span> <span class="hljs-string">/</span> <span class="hljs-number">443</span>
     <span class="hljs-string">v</span>
   <span class="hljs-string">Nginx</span>
     <span class="hljs-string">|</span>
     <span class="hljs-string">|</span> <span class="hljs-number">3000</span>
     <span class="hljs-string">v</span>
 <span class="hljs-string">Node.js</span> <span class="hljs-string">应用（PM2</span> <span class="hljs-string">/</span> <span class="hljs-string">Docker）</span>
</code></pre>
<p>用户只访问 Nginx，所有请求由 Nginx 转发给 Node.js。</p>
<hr/>
<h2 data-id="heading-2">三、安装 Nginx</h2>
<p>在常见 Linux 系统中，可以直接通过包管理器安装。</p>
<h3 data-id="heading-3">Ubuntu / Debian</h3>
<pre><code class="hljs language-sql" lang="sql">sudo apt <span class="hljs-keyword">update</span>
sudo apt install nginx
</code></pre>
<h3 data-id="heading-4">CentOS / Rocky Linux</h3>
<pre><code class="hljs">sudo yum install nginx
</code></pre>
<p>安装完成后启动 Nginx：</p>
<pre><code class="hljs language-bash" lang="bash">sudo systemctl start nginx
sudo systemctl <span class="hljs-built_in">enable</span> nginx
</code></pre>
<p>访问服务器 IP，如果看到 Nginx 默认页面，说明安装成功。</p>
<hr/>
<h2 data-id="heading-5">四、最小可用反向代理配置</h2>
<p>假设 Node.js 服务监听在 <code>127.0.0.1:3000</code>。</p>
<h3 data-id="heading-6">1. 创建站点配置文件</h3>
<pre><code class="hljs language-bash" lang="bash">sudo nano /etc/nginx/conf.d/my-app.conf
</code></pre>
<h3 data-id="heading-7">2. 基本配置示例</h3>
<pre><code class="hljs language-ini" lang="ini">server {
    listen 80<span class="hljs-comment">;</span>
    server_name myapp.example.com<span class="hljs-comment">;</span>

    location / {
        proxy_pass http://127.0.0.1:3000<span class="hljs-comment">;</span>

        proxy_http_version 1.1<span class="hljs-comment">;</span>
        proxy_set_header Upgrade $http_upgrade<span class="hljs-comment">;</span>
        proxy_set_header Connection 'upgrade'<span class="hljs-comment">;</span>

        proxy_set_header Host $host<span class="hljs-comment">;</span>
        proxy_set_header X-Real-IP $remote_addr<span class="hljs-comment">;</span>
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for<span class="hljs-comment">;</span>
        proxy_set_header X-Forwarded-Proto $scheme<span class="hljs-comment">;</span>

        proxy_cache_bypass $http_upgrade<span class="hljs-comment">;</span>
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-8">3. 启用配置并重载</h3>
<pre><code class="hljs">sudo nginx -t
sudo systemctl reload nginx
</code></pre>
<p>此时访问 <code>http://myapp.example.com</code> 即可看到 Node.js 应用页面。</p>
<hr/>
<h2 data-id="heading-9">五、支持 WebSocket 转发</h2>
<p>如果你的 Node.js 应用使用了 WebSocket（如 Socket.IO），必须显式开启相关配置。</p>
<pre><code class="hljs language-bash" lang="bash">location /socket.io/ {
    proxy_pass http://127.0.0.1:3000/socket.io/;

    proxy_http_version 1.1;
    proxy_set_header Upgrade <span class="hljs-variable">$http_upgrade</span>;
    proxy_set_header Connection <span class="hljs-string">"Upgrade"</span>;

    proxy_set_header Host <span class="hljs-variable">$host</span>;
    proxy_set_header X-Real-IP <span class="hljs-variable">$remote_addr</span>;
    proxy_set_header X-Forwarded-For <span class="hljs-variable">$proxy_add_x_forwarded_for</span>;
}
</code></pre>
<p>否则 WebSocket 连接会在 Nginx 层被断开。</p>
<hr/>
<h2 data-id="heading-10">六、静态资源由 Nginx 直接托管</h2>
<p>为了减轻 Node.js 压力，建议将静态资源交给 Nginx 直接处理。</p>
<pre><code class="hljs language-csharp" lang="csharp">location /<span class="hljs-keyword">static</span>/ {
    <span class="hljs-keyword">alias</span> /<span class="hljs-keyword">var</span>/www/my-app/<span class="hljs-keyword">static</span>/;
    expires <span class="hljs-number">30</span>d;
    add_header Cache-Control <span class="hljs-string">"public"</span>;
}
</code></pre>
<p>Node.js 只负责 API 和动态页面请求。</p>
<hr/>
<h2 data-id="heading-11">七、多实例负载均衡</h2>
<p>如果你使用 PM2 cluster 或 Docker 多实例，可以在 Nginx 层做负载均衡。</p>
<pre><code class="hljs language-ini" lang="ini">upstream my_node_app {
    server 127.0.0.1:3000<span class="hljs-comment">;</span>
    server 127.0.0.1:3001<span class="hljs-comment">;</span>
    server 127.0.0.1:3002<span class="hljs-comment">;</span>
}

server {
    listen 80<span class="hljs-comment">;</span>
    server_name myapp.example.com<span class="hljs-comment">;</span>

    location / {
        proxy_pass http://my_node_app<span class="hljs-comment">;</span>

        proxy_http_version 1.1<span class="hljs-comment">;</span>
        proxy_set_header Upgrade $http_upgrade<span class="hljs-comment">;</span>
        proxy_set_header Connection 'upgrade'<span class="hljs-comment">;</span>

        proxy_set_header Host $host<span class="hljs-comment">;</span>
        proxy_set_header X-Real-IP $remote_addr<span class="hljs-comment">;</span>
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for<span class="hljs-comment">;</span>
    }
}
</code></pre>
<p>Nginx 会将请求轮询分发到多个 Node.js 实例，提高整体吞吐能力。</p>
<hr/>
<h2 data-id="heading-12">八、常见问题与排错思路</h2>
<h3 data-id="heading-13">1. 502 Bad Gateway</h3>
<p>常见原因：</p>
<ul>
<li>• Node.js 服务未启动</li>
<li>• 端口号配置错误</li>
<li>• 防火墙拦截本地端口</li>
</ul>
<p>检查步骤：</p>
<pre><code class="hljs language-arduino" lang="arduino">curl http:<span class="hljs-comment">//127.0.0.1:3000</span>
</code></pre>
<hr/>
<h3 data-id="heading-14">2. WebSocket 连接失败</h3>
<p>检查是否包含：</p>
<pre><code class="hljs language-bash" lang="bash">proxy_set_header Upgrade <span class="hljs-variable">$http_upgrade</span>;
proxy_set_header Connection <span class="hljs-string">"Upgrade"</span>;
</code></pre>
<hr/>
<h3 data-id="heading-15">3. 请求头丢失真实 IP</h3>
<p>确保设置：</p>
<pre><code class="hljs language-bash" lang="bash">proxy_set_header X-Real-IP <span class="hljs-variable">$remote_addr</span>;
proxy_set_header X-Forwarded-For <span class="hljs-variable">$proxy_add_x_forwarded_for</span>;
</code></pre>
<p>在 Node.js 中通过 <code>req.ip</code> 或 <code>x-forwarded-for</code> 读取真实客户端 IP。</p>
<hr/>
<h2 data-id="heading-16">九、生产环境优化建议</h2>
<ol>
<li>
<ol>
<li>启用 Gzip 压缩</li>
</ol>
</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">gzip on;
gzip_types text/plain text/css application/json application/javascript;
gzip_min_length 1024;
</code></pre>
<ol>
<li>
<ol start="2">
<li>设置合理的超时时间</li>
</ol>
</li>
</ol>
<pre><code class="hljs language-ini" lang="ini">proxy_connect_timeout 60s<span class="hljs-comment">;</span>
proxy_send_timeout 60s<span class="hljs-comment">;</span>
proxy_read_timeout 60s<span class="hljs-comment">;</span>
</code></pre>
<ol>
<li>
<ol start="3">
<li>配合 HTTPS 使用<br/>
将 SSL 证书部署在 Nginx 层，Node.js 只监听 HTTP。</li>
</ol>
</li>
<li>
<ol start="4">
<li>配合 PM2 / Docker<br/>
保证 Node.js 进程异常退出后自动拉起。</li>
</ol>
</li>
</ol>
<hr/>
<h2 data-id="heading-17">十、总结</h2>
<p>在 Node.js 应用部署架构中，<strong>Nginx 反向代理几乎是标准配置</strong>。它承担了对外入口、安全防护、静态资源加速、负载均衡等关键角色。</p>
<p>通过合理配置 Nginx，你可以获得：</p>
<ul>
<li>• 更高的安全性</li>
<li>• 更稳定的访问入口</li>
<li>• 更好的性能表现</li>
<li>• 更灵活的扩展能力</li>
</ul>
<p>在《Node.js 编程实战》系列中，Nginx 反向代理是继 PM2、Docker 之后迈向生产级部署的重要一步，为后续 HTTPS、负载均衡与高可用架构奠定了坚实基础。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[亲测有效！M4芯片Mac安装Node.js 14避坑指南，解决nvm install失败问题]]></title>    <link>https://juejin.cn/post/7599579865608044586</link>    <guid>https://juejin.cn/post/7599579865608044586</guid>    <pubDate>2026-01-27T02:59:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599579865608044586" data-draft-id="7599550337385332799" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="亲测有效！M4芯片Mac安装Node.js 14避坑指南，解决nvm install失败问题"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-27T02:59:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="maskie"/> <meta itemprop="url" content="https://juejin.cn/user/3532076760700055"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            亲测有效！M4芯片Mac安装Node.js 14避坑指南，解决nvm install失败问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3532076760700055/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    maskie
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T02:59:22.000Z" title="Tue Jan 27 2026 02:59:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">问题概述：当现代硬件遇见旧版软件</h2>
<p>刚从<code>Windows</code>切换到全新的<code>MacBook Pro（M4芯片）</code>，准备投入到熟悉的老项目维护中，一切似乎都很顺利——直到我需要运行那个依赖<code>Node.js 14</code>的项目。
在终端中输入 <code>nvm install 14 </code>后，等待我的不是成功的提示，而是一连串令人困惑的错误信息：<img src="https://i-blog.csdnimg.cn/direct/fa529ffa50824f8aa93eaecc892c1680.png" alt="[图片]" loading="lazy"/></p>
<h2 data-id="heading-1">为什么安装会失败？</h2>
<ol>
<li>架构差异的本质</li>
</ol>
<blockquote>
<ul>
<li>Node.js 14官方预编译包主要针对x86_64架构</li>
<li>M4芯片的ARM架构需要对应的ARM原生二进制文件</li>
<li>缺乏官方维护的低版本ARM原生包</li>
</ul>
</blockquote>
<p>2.依赖链断裂问题</p>
<blockquote>
<ul>
<li>部分Node.js 14依赖的本地模块（native addons）无ARM版本</li>
<li>npm包中的postinstall脚本可能包含不兼容的命令</li>
</ul>
</blockquote>
<h2 data-id="heading-2">解决方案：通过Rosetta 2架起兼容的桥梁</h2>
<p>经过多次尝试，Rosetta 2转译方案被证明是最稳定可靠的方法。以下是详细步骤：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 安装 Rosetta 2（如果还没有）</span>
softwareupdate --install-rosetta

<span class="hljs-comment"># 2. 在 Rosetta 2 终端中运行</span>
<span class="hljs-built_in">arch</span> -x86_64 zsh

<span class="hljs-comment"># 3. 在这个终端中安装 nvm（如果需要）</span>
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.5/install.sh | bash

<span class="hljs-comment"># 4. 安装 Node.js v14</span>
nvm install v14.21.3
</code></pre>
<p><strong>安装后，每次运行 Node v14 的项目时，需要在 Rosetta 终端中：</strong></p>
<pre><code class="hljs language-powershell" lang="powershell">arch -x86_64 zsh
nvm use v14
</code></pre>
<h2 data-id="heading-3">效果图</h2>
<p>正常下载并切换 node 14版本，安装 <code>node_modules</code>
<img src="https://i-blog.csdnimg.cn/direct/337afd81cab949f29477fcfa631efdea.png" alt="[图片]" loading="lazy"/></p>
<p>项目正常运行
<img src="https://i-blog.csdnimg.cn/direct/06ae187c7244461cbeb65dc6211270cc.png" alt="[图片]" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何在win11上本地部署qwen3-4b大模型]]></title>    <link>https://juejin.cn/post/7599600549764136995</link>    <guid>https://juejin.cn/post/7599600549764136995</guid>    <pubDate>2026-01-27T02:00:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599600549764136995" data-draft-id="7599586891084742690" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何在win11上本地部署qwen3-4b大模型"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-27T02:00:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="二福同志null"/> <meta itemprop="url" content="https://juejin.cn/user/3934498593972979"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何在win11上本地部署qwen3-4b大模型
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3934498593972979/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    二福同志null
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T02:00:32.000Z" title="Tue Jan 27 2026 02:00:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>笔者电脑配置如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed3339510b134fe0b0d4848e7f68a97e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqM56aP5ZCM5b-XbnVsbA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084032&amp;x-signature=mWTEiFROYW5bKCQsyruhevI4Vm0%3D" alt="" loading="lazy"/></p>
<p>注意必须先搭建python环境哈，并且要64位的。</p>
<p>我的显卡一般因此选择了qwen3-4b模型，模型的下载地址为：</p>
<pre><code class="hljs language-arduino" lang="arduino">https:<span class="hljs-comment">//www.modelscope.cn/collections</span>
</code></pre>
<p>如何下载大模型：</p>
<p>管理员身份启动cmd</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment">#输入命令</span>
pip install modelscope
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c2dabf240e7943979a3414f3d436d749~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqM56aP5ZCM5b-XbnVsbA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084032&amp;x-signature=6f%2BxPgV45NJ6M9h1uU29eSXjUpA%3D" alt="" loading="lazy"/></p>
<p>在你的电脑本地创建一个用于存放模型文件的文件夹，笔者是D:\Code\bigMod\qwen34b</p>
<pre><code class="hljs language-css" lang="css">modelscope download <span class="hljs-attr">--model</span> Qwen/Qwen3-<span class="hljs-number">4</span>B <span class="hljs-attr">--local_dir</span> "D:\Code\bigMod\qwen34b<span class="hljs-string">"
</span></code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90268c8ab24c4f24bb456a8b7bff7957~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqM56aP5ZCM5b-XbnVsbA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084032&amp;x-signature=8fBASg3waiJyWysB%2BGhVZxlRhGs%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b038d57c8ed4840bba64915d6e4221a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqM56aP5ZCM5b-XbnVsbA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084032&amp;x-signature=j%2Fa%2FiGaGQ63jogBOS0AfGgRisUo%3D" alt="" loading="lazy"/></p>
<p>然后使用pycharm将qwen34b文件夹当做项目文件打开</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/329306a500dd4ea5b070093a31ab4ddf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqM56aP5ZCM5b-XbnVsbA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084032&amp;x-signature=ZKgyJYm6BmoZnPF9yRyu4yR8r5A%3D" alt="" loading="lazy"/></p>
<p>然后在根目录新建一个py文件用于启动模型，我使用的是run_qwen.py</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/707b8e702a344e4682bbcb06aa608024~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqM56aP5ZCM5b-XbnVsbA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084032&amp;x-signature=FujAU9G7Yd1hLv5xVoGz60WgbTQ%3D" alt="" loading="lazy"/></p>
<p>在pycharm的终端里安装一下依赖</p>
<pre><code class="hljs language-bash" lang="bash">pip install transformers torch accelerate sentencepiece einops
pip install modelscope  <span class="hljs-comment"># 如果使用ModelScope加载</span>
pip install bitsandbytes  <span class="hljs-comment"># 用于4-bit量化</span>
</code></pre>
<p>注意选择Cuda还是cpu具体取决于你的电脑或者服务器，笔者的电脑显卡虽然不太行，但是勉强将就。如果你的电脑没有独显，那么推荐使用cpu来计算。并且cuda应该要单独装一个驱动。笔者早年装过这个驱动（不知道不装有没有影响），所以不在赘述</p>
<pre><code class="hljs language-ini" lang="ini">import torch
from transformers import AutoTokenizer, AutoModelForCausalLM

<span class="hljs-comment"># 配置参数</span>
<span class="hljs-attr">MODEL_PATH</span> = <span class="hljs-string">"D:/Code/bigMod/qwen34b"</span>  <span class="hljs-comment"># 你的模型路径</span>
<span class="hljs-attr">DEVICE</span> = <span class="hljs-string">"cuda"</span> if torch.cuda.is_available() else <span class="hljs-string">"cpu"</span>
<span class="hljs-attr">QUANTIZE</span> = <span class="hljs-literal">True</span>  <span class="hljs-comment"># 是否启用4-bit量化（RTX 3060强烈建议开启）</span>

print(f"正在加载模型，设备: {DEVICE}")
print(f"模型路径: {MODEL_PATH}")

try:
    <span class="hljs-comment"># 加载tokenizer</span>
    <span class="hljs-attr">tokenizer</span> = AutoTokenizer.from_pretrained(
        MODEL_PATH,
        <span class="hljs-attr">trust_remote_code</span>=<span class="hljs-literal">True</span>,
        <span class="hljs-attr">use_fast</span>=<span class="hljs-literal">False</span>
    )

    <span class="hljs-comment"># 加载模型</span>
    if QUANTIZE and <span class="hljs-attr">DEVICE</span> == <span class="hljs-string">"cuda"</span>:
        print("启用4-bit量化...")
        <span class="hljs-attr">model</span> = AutoModelForCausalLM.from_pretrained(
            MODEL_PATH,
            <span class="hljs-attr">device_map</span>=<span class="hljs-string">"auto"</span>,
            <span class="hljs-attr">trust_remote_code</span>=<span class="hljs-literal">True</span>,
            <span class="hljs-attr">load_in_4bit</span>=<span class="hljs-literal">True</span>,  <span class="hljs-comment"># 4-bit量化</span>
            <span class="hljs-attr">bnb_4bit_compute_dtype</span>=torch.float16,
            <span class="hljs-attr">bnb_4bit_quant_type</span>=<span class="hljs-string">"nf4"</span>,
            <span class="hljs-attr">bnb_4bit_use_double_quant</span>=<span class="hljs-literal">True</span>
        )
    else:
        print("加载完整精度模型...")
        <span class="hljs-attr">model</span> = AutoModelForCausalLM.from_pretrained(
            MODEL_PATH,
            <span class="hljs-attr">device_map</span>=<span class="hljs-string">"auto"</span>,
            <span class="hljs-attr">trust_remote_code</span>=<span class="hljs-literal">True</span>,
            <span class="hljs-attr">torch_dtype</span>=torch.float16 if DEVICE == <span class="hljs-string">"cuda"</span> else torch.float32
        )

    print("模型加载成功！")


    <span class="hljs-comment"># 测试推理</span>
    def chat_with_model(prompt):
        <span class="hljs-attr">messages</span> = [
            {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"你是一个有用的AI助手。"</span>},
            {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: prompt}
        ]

        <span class="hljs-comment"># 使用tokenizer的apply_chat_template方法（Qwen3支持）</span>
        <span class="hljs-attr">text</span> = tokenizer.apply_chat_template(
            messages,
            <span class="hljs-attr">tokenize</span>=<span class="hljs-literal">False</span>,
            <span class="hljs-attr">add_generation_prompt</span>=<span class="hljs-literal">True</span>
        )

        <span class="hljs-attr">model_inputs</span> = tokenizer([text], return_tensors=<span class="hljs-string">"pt"</span>).to(DEVICE)

        with torch.no_grad():
            <span class="hljs-attr">generated_ids</span> = model.generate(
                **model_inputs,
                <span class="hljs-attr">max_new_tokens</span>=<span class="hljs-number">512</span>,
                <span class="hljs-attr">do_sample</span>=<span class="hljs-literal">True</span>,
                <span class="hljs-attr">temperature</span>=<span class="hljs-number">0.6</span>,
                <span class="hljs-attr">top_p</span>=<span class="hljs-number">0.9</span>,
                <span class="hljs-attr">pad_token_id</span>=tokenizer.eos_token_id
            )

        <span class="hljs-comment"># 去除输入部分，只保留生成内容</span>
        <span class="hljs-attr">generated_ids</span> = [
            output_ids[len(input_ids):]
            for input_ids, output_ids in zip(model_inputs.input_ids, generated_ids)
        ]

        <span class="hljs-attr">response</span> = tokenizer.batch_decode(generated_ids, skip_special_tokens=<span class="hljs-literal">True</span>)[<span class="hljs-number">0</span>]
        return response


    <span class="hljs-comment"># 交互式对话</span>
    print("\n<span class="hljs-attr">" + "</span>=<span class="hljs-string">" * 50)
    print("</span>Qwen3-<span class="hljs-number">4</span>B 已启动！输入 <span class="hljs-string">'exit'</span> 退出对话。<span class="hljs-string">")
    print("</span>=<span class="hljs-string">" * 50 + "</span>\n<span class="hljs-string">")

    while True:
        user_input = input("</span>您: <span class="hljs-string">")
        if user_input.lower() in ['exit', 'quit', 'bye']:
            print("</span>再见！<span class="hljs-string">")
            break

        print("</span>AI: <span class="hljs-string">", end="</span><span class="hljs-string">", flush=True)
        response = chat_with_model(user_input)
        print(response)

except Exception as e:
    print(f"</span>加载模型时出错: {str(e)}<span class="hljs-string">")
    import traceback

    traceback.print_exc()
</span></code></pre>
<p>最后启动py文件，在控制台输入问题就好了</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a75a3a7891c48af92d5243e2e3278a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqM56aP5ZCM5b-XbnVsbA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084032&amp;x-signature=bFcloGFFzwdIvLWtP1g4ycq5Pn8%3D" alt="" loading="lazy"/></p>
<p>但是qwen3-4b真的有些笨，不推荐。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RAG 深度实践系列（三）：RAG 技术演变与核心架构的深度剖析]]></title>    <link>https://juejin.cn/post/7599586891084529698</link>    <guid>https://juejin.cn/post/7599586891084529698</guid>    <pubDate>2026-01-27T01:30:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599586891084529698" data-draft-id="7599586891084464162" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RAG 深度实践系列（三）：RAG 技术演变与核心架构的深度剖析"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-27T01:30:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="中杯可乐多加冰"/> <meta itemprop="url" content="https://juejin.cn/user/3435306702347432"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RAG 深度实践系列（三）：RAG 技术演变与核心架构的深度剖析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3435306702347432/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    中杯可乐多加冰
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T01:30:02.000Z" title="Tue Jan 27 2026 01:30:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读24分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、 RAG 范式演进：从知识搬运工到智能决策者</h2>
<p>检索增强生成（RAG）技术的发展史，是一部不断挑战大型语言模型（LLM）局限性、追求系统级智能的演进史。RAG 的演变并非简单的功能叠加，而是对“如何高效、可靠地将外部知识融入 LLM 推理过程”这一核心问题的持续探索。我们可以将 RAG 的演进脉络划分为四个清晰的阶段：<strong>Naive RAG</strong> 确立基本范式，<strong>Advanced RAG</strong> 聚焦精细化优化，<strong>Modular RAG</strong> 追求架构灵活性，最终 <strong>Agentic RAG</strong> 实现自主决策与智能化。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af1604d58a0640578521ec6192f57014~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770082202&amp;x-signature=PT4V2%2Fhph6oZBhO2haMu7ner1ys%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<hr/>
<p>在 RAG 的实践中，许多开发者在面对复杂场景时，常因缺乏对架构演进逻辑的深刻理解而陷入困境：如何将知识图谱（GraphRAG）融入向量检索？如何设计一个具备自我反思能力的 Agentic RAG 系统？如何平衡实时性与准确性？</p>
<p>为了帮你填补从懂原理到能落地的关键拼图，AI大学堂基于大量的业务实战经验，精心打磨课程，正式推出 <strong>RAG工程师认证</strong>。这份证书将是你系统化掌握 AI 落地核心能力的绝佳机会，认证现已开启，<strong>限时免费</strong>，点击文末<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aidaxue.com%2Fcourse%2F1190%3Fvideo_id%3D5212%26ch%3Dai_daxue_csdn" target="_blank" title="https://www.aidaxue.com/course/1190?video_id=5212&amp;ch=ai_daxue_csdn" ref="nofollow noopener noreferrer">🔗认证链接</a>开始学习！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e8f9a20ab57e40708dd69ba01c2a4b81~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770082202&amp;x-signature=0orq9xSe5Ny%2FVNvHBu%2FK15Pq9ZM%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-1"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1.1、 Naive RAG：范式的确立与固有局限</h3>
<p><strong>Naive RAG</strong>（朴素 RAG）是 RAG 技术的起点，其核心思想是“索引-检索-生成”的线性流程。它解决了 LLM 在特定领域知识上的“无知”问题，通过将文档分块、向量化，并使用单一的向量相似度检索来召回上下文。<br/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ade07eee44d4ce58c0601441b3f9a44~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770082202&amp;x-signature=XsXPwngYcUQy9w2ff9JrUL1N2Bk%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>然而，Naive RAG 的局限性是显而易见的，也是驱动后续演进的根本原因：</p>
<ol>
<li><strong>分块的语义破坏</strong>：固定大小的分块策略极易在语义边界处截断，导致单个块的语义信息不完整或被稀释，直接影响嵌入模型的编码质量。</li>
<li><strong>单一检索的盲区</strong>：仅依赖向量相似度检索，无法有效处理<strong>词汇不匹配</strong>（Lexical Gap）问题，对同义词、专业术语或需要精确关键词匹配的查询，召回率低下。</li>
<li><strong>缺乏查询优化</strong>：用户查询的模糊性、歧义性未被处理，直接影响了检索信号的质量。</li>
</ol>
<p>Naive RAG 就像一个被动的“知识搬运工”，它只能机械地执行预设的流程，缺乏对信息质量的判断和对查询意图的深度理解。</p>
<h3 data-id="heading-2"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1.2、 Advanced RAG：精细化优化与多阶段精炼</h3>
<p><strong>Advanced RAG</strong>（高级 RAG）是 RAG 走向工业级应用的关键一步，其核心在于在 Naive RAG 的基础上，引入了大量的<strong>预检索</strong>和<strong>后检索</strong>优化机制，将流程从线性转变为多阶段精炼。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2eeae31ab66e4547a9b403017e0d6a49~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770082202&amp;x-signature=U0uuHQLgDWhpzY9g2EQ1tbzzsGk%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h4 data-id="heading-3"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1.2.1、 预检索优化：增强查询信号的艺术</h4>
<p>预检索优化的目标是生成更强大的检索信号，以克服用户查询的局限性：</p>
<ul>
<li><strong>查询重写与扩展</strong>：利用 LLM 将原始查询改写成更清晰、更具体的版本，或生成多个变体查询以增加检索覆盖面。</li>
<li><strong>假设性文档嵌入（HyDE）</strong> ：这是最具创新性的技术之一。它利用 LLM 的生成能力，根据查询生成一个“假设性答案”，然后用这个假设性答案的向量去检索真实文档。由于假设性答案包含了更丰富的语义和更接近文档的词汇，它能显著提高检索的准确性，尤其是在处理抽象概念时。</li>
<li><strong>多查询生成</strong>：利用 LLM 生成多个子查询，并行执行检索，然后合并结果，以应对复杂查询和多角度信息需求。</li>
</ul>
<h4 data-id="heading-4"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1.2.2、 检索与后处理优化：从召回到准确率的飞跃</h4>
<p>Advanced RAG 在检索和后处理环节的优化，是其性能飞跃的关键：</p>
<ul>
<li><strong>混合检索（Hybrid Retrieval）</strong> ：将基于关键词的稀疏检索（如 BM25）与基于语义的稠密检索（向量检索）进行融合。这种融合的数学逻辑在于，通过 <strong>RRF（Reciprocal Rank Fusion）</strong>  等算法，将两种不同相关性度量（词频-逆文档频率与向量余弦相似度）的结果进行加权排序，实现优势互补，最大化召回率和准确率。</li>
<li><strong>语义分块策略</strong>：取代固定分块，采用基于句子、段落或标题的语义分块，确保每个块的语义完整性。更进一步的策略是<strong>父文档检索</strong>，即用小块进行检索，但返回包含该小块的更大“父文档”作为 LLM 的上下文，以平衡检索精度和上下文丰富度。</li>
<li><strong>Cross-Encoder 重排序</strong>：这是提升准确率（Precision）的利器。与 Bi-Encoder 独立编码查询和文档不同，Cross-Encoder 将查询和文档<strong>拼接</strong>后一起输入模型，从而捕捉两者之间细粒度的交互信息。虽然计算成本高，但其对相关性的判断更为精确，通常用于对 Bi-Encoder 召回的 Top-K 结果进行二次精排。</li>
<li><strong>上下文压缩与验证</strong>：通过 LLMLingua 等技术对检索结果进行压缩，减少 LLM 的输入 Token 数量，降低成本并提升效率。同时，引入额外的 LLM 或规则引擎对最终答案进行<strong>事实一致性验证</strong>，以降低幻觉风险。</li>
</ul>
<h2 data-id="heading-5"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>二、 Modular RAG 与 GraphRAG：架构的灵活性与知识的结构化</h2>
<p>Advanced RAG 解决了性能问题，但随着应用场景的复杂化，系统对<strong>灵活性</strong>和<strong>可扩展性</strong>提出了更高的要求，由此催生了 <strong>Modular RAG</strong>（模块化 RAG）。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3418802770314b6cbe9febffd4531e33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770082202&amp;x-signature=J%2Fzh6qFBUf2Tiy%2F6pmN7PsGZv5c%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-6"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2.1、 Modular RAG：解耦与定制化的架构哲学</h3>
<p>Modular RAG 的核心思想是<strong>解耦</strong>：将 RAG 流程中的各个功能（如查询重写、检索、重排序、验证）抽象为可插拔的独立模块。这种架构哲学使得 RAG 系统不再是一个固定的流水线，而是一个可以根据任务需求动态组装的“乐高积木”。</p>
<p>这种架构的优势在于：</p>
<ol>
<li><strong>定制化工作流</strong>：可以根据不同的业务场景（如法律问答、代码生成、财务分析）定制不同的模块组合和执行路径。</li>
<li><strong>独立优化与迭代</strong>：每个模块可以独立进行技术选型和优化（例如，针对法律文档使用专门微调的嵌入模型，针对代码使用基于 AST 的分块器），互不影响。</li>
<li><strong>支持复杂逻辑</strong>：通过模块的<strong>条件组合</strong>（根据查询类型选择不同检索器）和<strong>循环组合</strong>（实现多跳检索），能够处理 Advanced RAG 难以应对的复杂逻辑。</li>
</ol>
<p>在 Modular RAG 的实践中，<strong>DSP（Differentiable Search Path，可微搜索路径）</strong>  等框架提供了理论基础，它将 RAG 流程视为一个可优化的计算图，允许通过端到端的方式对整个流程进行微调，从而实现系统级的性能提升。</p>
<h3 data-id="heading-7"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2.2、 GraphRAG：从语义相似到逻辑推理的飞跃</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/123e9aefdfdc4b85bae9ab330c289cfa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770082202&amp;x-signature=v64cYsDNrz3W6jwGeiZsY0tDsZQ%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>在 Modular RAG 的范畴内，<strong>GraphRAG</strong>（基于知识图谱的 RAG）是解决复杂推理问题的关键技术。它解决了传统向量检索的根本缺陷：<strong>缺乏逻辑关联和因果推理能力</strong>。</p>
<p>GraphRAG 的工作原理是将知识库中的实体和关系构建成一个<strong>知识图谱（KG）</strong> 。检索过程不再仅仅是文本块的相似度匹配，而是：</p>
<ol>
<li><strong>实体与关系提取</strong>：利用 LLM 或 NLP 工具从查询和文档中提取关键实体和关系。</li>
<li><strong>图谱路径搜索</strong>：在 KG 中搜索连接查询实体和目标实体的路径。</li>
<li><strong>结构化上下文</strong>：将搜索到的图谱路径（即逻辑链条）作为结构化上下文提供给 LLM。</li>
</ol>
<p>这种方式使得 LLM 能够进行更复杂的<strong>多跳推理</strong>（Multi-hop Reasoning）。例如，要回答“A 公司的创始人 B 投资了哪些 C 领域的公司？”这样的问题，GraphRAG 可以沿着“A 公司 -&gt; 创始人 B -&gt; 投资关系 -&gt; C 领域公司”的路径进行精确搜索，并提供清晰的逻辑链条，极大地增强了答案的<strong>事实准确性</strong>和<strong>可解释性</strong>。GraphRAG 的引入，标志着 RAG 系统从“知识搬运工”正式进化为“逻辑推理者”。</p>
<h2 data-id="heading-8"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>三、 Agentic RAG：自主决策与自我反思的智能化巅峰</h2>
<p>RAG 技术的最新前沿是 <strong>Agentic RAG</strong>（智能体 RAG），它代表了 RAG 系统从被动执行到主动智能的最终形态。Agentic RAG 将 AI 智能体（Agent）技术与 RAG 深度融合，赋予系统<strong>自主决策、工具使用、任务规划和自我反思</strong>的能力。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56c26754a725457997a0a4cdf80bb183~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770082202&amp;x-signature=DkvRjP3lQt7jXBZBRDJnigz9zhA%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-9"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>3.1、 Agentic RAG 的核心机制：ReAct 与反思</h3>
<p>Agentic RAG 的核心在于其<strong>智能体框架</strong>，其中 <strong>ReAct（Reasoning and Acting）</strong>  框架是主流实现之一。ReAct 机制允许 LLM 在生成答案之前，进行<strong>推理（Reasoning）</strong>  和<strong>行动（Acting）</strong>  的交替循环：</p>
<ol>
<li><strong>推理（Reasoning）</strong> ：LLM 分析当前任务、已有的信息和下一步的目标，生成一个清晰的思考过程。</li>
<li><strong>行动（Acting）</strong> ：LLM 根据推理结果，决定调用哪个工具（如向量检索器、搜索引擎、代码解释器或 GraphRAG 模块），并执行相应的操作。</li>
</ol>
<p>这种机制使得 Agentic RAG 能够动态地规划复杂的任务。例如，在处理一个需要多步推理的法律查询时，Agent 会将问题分解为多个子任务，并动态选择工具：</p>
<ul>
<li><strong>步骤 1（推理）</strong> ：分析查询，判断需要检索法律条文和计算赔偿金。</li>
<li><strong>步骤 1（行动）</strong> ：调用 <strong>GraphRAG 模块</strong>检索最新的法律条文。</li>
<li><strong>步骤 2（推理）</strong> ：分析检索结果，确定计算公式，判断需要外部计算工具。</li>
<li><strong>步骤 2（行动）</strong> ：调用 <strong>代码解释器</strong>或 <strong>API 工具</strong>执行赔偿金计算。</li>
</ul>
<p>更高级的 Agentic RAG 引入了<strong>自我反思（Self-Reflection）</strong>  机制。在生成答案后，Agent 会利用另一个 LLM 或预设的评估指标（如 RAGAS 框架）对答案进行评估。如果评估结果不理想，Agent 会反思其推理过程和行动步骤，识别错误，并调整策略重新执行，形成一个完整的<strong>优化闭环</strong>。这种反思与优化能力，是 Agentic RAG 实现高度智能化和鲁棒性的重要保障。</p>
<h3 data-id="heading-10"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>3.2、 Agentic RAG 的应用与挑战</h3>
<p>Agentic RAG 的应用场景集中在对<strong>复杂性、准确性和智能化程度</strong>要求极高的领域：</p>
<ul>
<li><strong>智能法律助手</strong>：处理需要多跳推理、多工具协同（法律数据库、计算工具）的复杂法律查询。</li>
<li><strong>金融研究分析</strong>：自主规划数据检索、图表生成、趋势分析等一系列步骤，生成结构化的研究报告。</li>
<li><strong>复杂系统故障诊断</strong>：Agent 根据故障描述，自主调用日志检索工具、代码库、知识图谱，逐步缩小故障范围并提出解决方案。</li>
</ul>
<p>然而，Agentic RAG 也面临巨大的挑战：</p>
<ol>
<li><strong>成本与延迟</strong>：每一次推理和行动都需要 LLM 调用，导致成本和延迟显著增加。</li>
<li><strong>工具调用稳定性</strong>：Agent 对外部工具的调用必须高度稳定和可靠，否则一次失败的行动可能导致整个流程崩溃。</li>
<li><strong>可解释性</strong>：Agent 的决策过程虽然有 ReAct 的推理记录，但其复杂性使得最终的可解释性仍然是一个难题。</li>
</ol>
<h2 data-id="heading-11"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>四、 RAG 系统的未来趋势：多模态、实时化与可信 AI</h2>
<p>RAG 技术的演进仍在加速，未来的发展将聚焦于突破现有架构的边界，使其能够更好地适应真实世界的复杂性和动态性。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb3fd4dfb07c4b0a85c15529111a196f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770082202&amp;x-signature=tGn%2Ba6J0TRdkw7VxI0lfG4p2ixs%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-12"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>4.1、 多模态 RAG：重构语义空间</h3>
<p>当前 RAG 主要处理文本，但现实世界是多模态的。<strong>多模态 RAG</strong> 的目标是将文本、图像、音频、视频等不同模态的数据融入统一的 RAG 框架。这要求构建<strong>统一的多模态表示模型</strong>，将不同模态的信息映射到同一个语义空间中，实现跨模态的检索、理解和生成。例如，用户可以上传一张设备故障的图片和一段描述，系统能够从包含技术手册（文本）、维修视频（视频）的知识库中检索信息，并生成包含文本和图片标注的维修指南。</p>
<h3 data-id="heading-13"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>4.2、 实时 RAG 与增量索引：拥抱时效性</h3>
<p>在金融、新闻、实时监控等领域，信息的<strong>时效性</strong>至关重要。未来的 RAG 系统必须是<strong>实时 RAG</strong>，能够处理流式数据并进行<strong>增量索引更新</strong>。传统的 RAG 知识库是静态的，更新成本高昂。实时 RAG 需要采用先进的流处理技术和向量数据库的增量索引能力，确保 LLM 始终能够访问到最新、最准确的知识，从而避免生成过时或错误的信息。</p>
<h3 data-id="heading-14"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>4.3、 可信 RAG 与评估体系的深化</h3>
<p>随着 RAG 在关键领域的应用，<strong>可信 AI</strong> 成为核心要求。未来的 RAG 系统将更加注重：</p>
<ul>
<li><strong>可解释性</strong>：不仅提供答案，还要提供清晰的<strong>引用来源</strong>和 <strong>推理路径</strong>（尤其是 Agentic RAG 和 GraphRAG）。</li>
<li><strong>鲁棒性</strong>：能够抵御对抗性攻击和知识库中的恶意注入。</li>
<li><strong>评估体系深化</strong>：除了传统的召回率和准确率，<strong>RAGAS</strong> 等评估框架将更加普及，利用 LLM 自身的能力来量化答案的<strong>忠实度（Faithfulness）</strong>  和<strong>上下文相关性（Context Relevance）</strong> ，实现数据驱动的持续优化。</li>
</ul>
<p>RAG 的演进是一个从“能用”到“好用”，再到“智能”的螺旋式上升过程。它清晰地展示了 AI 系统如何通过架构创新，将 LLM 的生成能力与外部知识的可靠性完美结合，从而构建出更强大、更可靠的下一代智能应用。# 一、 RAG 范式演进：从知识搬运工到智能决策者</p>
<p>检索增强生成（RAG）技术的发展史，是一部不断挑战大型语言模型（LLM）局限性、追求系统级智能的演进史。RAG 的演变并非简单的功能叠加，而是对“如何高效、可靠地将外部知识融入 LLM 推理过程”这一核心问题的持续探索。我们可以将 RAG 的演进脉络划分为四个清晰的阶段：<strong>Naive RAG</strong> 确立基本范式，<strong>Advanced RAG</strong> 聚焦精细化优化，<strong>Modular RAG</strong> 追求架构灵活性，最终 <strong>Agentic RAG</strong> 实现自主决策与智能化。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9bedce0f0a654e428b8ecb635b348311~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770082202&amp;x-signature=tqepsfiZWmlxusOWQBzg3Uqez3w%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<hr/>
<p>在 RAG 的实践中，许多开发者在面对复杂场景时，常因缺乏对架构演进逻辑的深刻理解而陷入困境：如何将知识图谱（GraphRAG）融入向量检索？如何设计一个具备自我反思能力的 Agentic RAG 系统？如何平衡实时性与准确性？</p>
<p>为了帮你填补从懂原理到能落地的关键拼图，AI大学堂基于大量的业务实战经验，精心打磨课程，正式推出 <strong>RAG工程师认证</strong>。这份证书将是你系统化掌握 AI 落地核心能力的绝佳机会，认证现已开启，<strong>限时免费</strong>，点击文末<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aidaxue.com%2Fcourse%2F1190%3Fvideo_id%3D5212%26ch%3Dai_daxue_csdn" target="_blank" title="https://www.aidaxue.com/course/1190?video_id=5212&amp;ch=ai_daxue_csdn" ref="nofollow noopener noreferrer">🔗认证链接</a>开始学习！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a7106535e93464e844b2f990a0a1684~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770082202&amp;x-signature=x1wPbG23wvYKn%2FIPY%2B8OWc69TuY%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-15"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1.1、 Naive RAG：范式的确立与固有局限</h3>
<p><strong>Naive RAG</strong>（朴素 RAG）是 RAG 技术的起点，其核心思想是“索引-检索-生成”的线性流程。它解决了 LLM 在特定领域知识上的“无知”问题，通过将文档分块、向量化，并使用单一的向量相似度检索来召回上下文。<br/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a2b2014c1bda4bcebdf5b1c598dc9c5c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770082202&amp;x-signature=aonFfu81lLjaMXisi6yUgAgG5NA%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>然而，Naive RAG 的局限性是显而易见的，也是驱动后续演进的根本原因：</p>
<ol>
<li><strong>分块的语义破坏</strong>：固定大小的分块策略极易在语义边界处截断，导致单个块的语义信息不完整或被稀释，直接影响嵌入模型的编码质量。</li>
<li><strong>单一检索的盲区</strong>：仅依赖向量相似度检索，无法有效处理<strong>词汇不匹配</strong>（Lexical Gap）问题，对同义词、专业术语或需要精确关键词匹配的查询，召回率低下。</li>
<li><strong>缺乏查询优化</strong>：用户查询的模糊性、歧义性未被处理，直接影响了检索信号的质量。</li>
</ol>
<p>Naive RAG 就像一个被动的“知识搬运工”，它只能机械地执行预设的流程，缺乏对信息质量的判断和对查询意图的深度理解。</p>
<h3 data-id="heading-16"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1.2、 Advanced RAG：精细化优化与多阶段精炼</h3>
<p><strong>Advanced RAG</strong>（高级 RAG）是 RAG 走向工业级应用的关键一步，其核心在于在 Naive RAG 的基础上，引入了大量的<strong>预检索</strong>和<strong>后检索</strong>优化机制，将流程从线性转变为多阶段精炼。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d697c1603dd449f99c37bdf43cb80af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770082202&amp;x-signature=xfVYEvQT%2Fvw9BRIWmgb4IJcO2GM%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h4 data-id="heading-17"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1.2.1、 预检索优化：增强查询信号的艺术</h4>
<p>预检索优化的目标是生成更强大的检索信号，以克服用户查询的局限性：</p>
<ul>
<li><strong>查询重写与扩展</strong>：利用 LLM 将原始查询改写成更清晰、更具体的版本，或生成多个变体查询以增加检索覆盖面。</li>
<li><strong>假设性文档嵌入（HyDE）</strong> ：这是最具创新性的技术之一。它利用 LLM 的生成能力，根据查询生成一个“假设性答案”，然后用这个假设性答案的向量去检索真实文档。由于假设性答案包含了更丰富的语义和更接近文档的词汇，它能显著提高检索的准确性，尤其是在处理抽象概念时。</li>
<li><strong>多查询生成</strong>：利用 LLM 生成多个子查询，并行执行检索，然后合并结果，以应对复杂查询和多角度信息需求。</li>
</ul>
<h4 data-id="heading-18"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1.2.2、 检索与后处理优化：从召回到准确率的飞跃</h4>
<p>Advanced RAG 在检索和后处理环节的优化，是其性能飞跃的关键：</p>
<ul>
<li><strong>混合检索（Hybrid Retrieval）</strong> ：将基于关键词的稀疏检索（如 BM25）与基于语义的稠密检索（向量检索）进行融合。这种融合的数学逻辑在于，通过 <strong>RRF（Reciprocal Rank Fusion）</strong>  等算法，将两种不同相关性度量（词频-逆文档频率与向量余弦相似度）的结果进行加权排序，实现优势互补，最大化召回率和准确率。</li>
<li><strong>语义分块策略</strong>：取代固定分块，采用基于句子、段落或标题的语义分块，确保每个块的语义完整性。更进一步的策略是<strong>父文档检索</strong>，即用小块进行检索，但返回包含该小块的更大“父文档”作为 LLM 的上下文，以平衡检索精度和上下文丰富度。</li>
<li><strong>Cross-Encoder 重排序</strong>：这是提升准确率（Precision）的利器。与 Bi-Encoder 独立编码查询和文档不同，Cross-Encoder 将查询和文档<strong>拼接</strong>后一起输入模型，从而捕捉两者之间细粒度的交互信息。虽然计算成本高，但其对相关性的判断更为精确，通常用于对 Bi-Encoder 召回的 Top-K 结果进行二次精排。</li>
<li><strong>上下文压缩与验证</strong>：通过 LLMLingua 等技术对检索结果进行压缩，减少 LLM 的输入 Token 数量，降低成本并提升效率。同时，引入额外的 LLM 或规则引擎对最终答案进行<strong>事实一致性验证</strong>，以降低幻觉风险。</li>
</ul>
<h2 data-id="heading-19"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>二、 Modular RAG 与 GraphRAG：架构的灵活性与知识的结构化</h2>
<p>Advanced RAG 解决了性能问题，但随着应用场景的复杂化，系统对<strong>灵活性</strong>和<strong>可扩展性</strong>提出了更高的要求，由此催生了 <strong>Modular RAG</strong>（模块化 RAG）。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/09e91479cb1c436ea25577eeb796b9c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770082202&amp;x-signature=tR%2FT%2BiQvMvJ4cNodICx6V6bcIyM%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-20"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2.1、 Modular RAG：解耦与定制化的架构哲学</h3>
<p>Modular RAG 的核心思想是<strong>解耦</strong>：将 RAG 流程中的各个功能（如查询重写、检索、重排序、验证）抽象为可插拔的独立模块。这种架构哲学使得 RAG 系统不再是一个固定的流水线，而是一个可以根据任务需求动态组装的“乐高积木”。</p>
<p>这种架构的优势在于：</p>
<ol>
<li><strong>定制化工作流</strong>：可以根据不同的业务场景（如法律问答、代码生成、财务分析）定制不同的模块组合和执行路径。</li>
<li><strong>独立优化与迭代</strong>：每个模块可以独立进行技术选型和优化（例如，针对法律文档使用专门微调的嵌入模型，针对代码使用基于 AST 的分块器），互不影响。</li>
<li><strong>支持复杂逻辑</strong>：通过模块的<strong>条件组合</strong>（根据查询类型选择不同检索器）和<strong>循环组合</strong>（实现多跳检索），能够处理 Advanced RAG 难以应对的复杂逻辑。</li>
</ol>
<p>在 Modular RAG 的实践中，<strong>DSP（Differentiable Search Path，可微搜索路径）</strong>  等框架提供了理论基础，它将 RAG 流程视为一个可优化的计算图，允许通过端到端的方式对整个流程进行微调，从而实现系统级的性能提升。</p>
<h3 data-id="heading-21"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2.2、 GraphRAG：从语义相似到逻辑推理的飞跃</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db3cd9966c764addb0d8bb54d2703f8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770082202&amp;x-signature=bQEo6jAVZFJxiRnrXus7cADJhG4%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>在 Modular RAG 的范畴内，<strong>GraphRAG</strong>（基于知识图谱的 RAG）是解决复杂推理问题的关键技术。它解决了传统向量检索的根本缺陷：<strong>缺乏逻辑关联和因果推理能力</strong>。</p>
<p>GraphRAG 的工作原理是将知识库中的实体和关系构建成一个<strong>知识图谱（KG）</strong> 。检索过程不再仅仅是文本块的相似度匹配，而是：</p>
<ol>
<li><strong>实体与关系提取</strong>：利用 LLM 或 NLP 工具从查询和文档中提取关键实体和关系。</li>
<li><strong>图谱路径搜索</strong>：在 KG 中搜索连接查询实体和目标实体的路径。</li>
<li><strong>结构化上下文</strong>：将搜索到的图谱路径（即逻辑链条）作为结构化上下文提供给 LLM。</li>
</ol>
<p>这种方式使得 LLM 能够进行更复杂的<strong>多跳推理</strong>（Multi-hop Reasoning）。例如，要回答“A 公司的创始人 B 投资了哪些 C 领域的公司？”这样的问题，GraphRAG 可以沿着“A 公司 -&gt; 创始人 B -&gt; 投资关系 -&gt; C 领域公司”的路径进行精确搜索，并提供清晰的逻辑链条，极大地增强了答案的<strong>事实准确性</strong>和<strong>可解释性</strong>。GraphRAG 的引入，标志着 RAG 系统从“知识搬运工”正式进化为“逻辑推理者”。</p>
<h2 data-id="heading-22"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>三、 Agentic RAG：自主决策与自我反思的智能化巅峰</h2>
<p>RAG 技术的最新前沿是 <strong>Agentic RAG</strong>（智能体 RAG），它代表了 RAG 系统从被动执行到主动智能的最终形态。Agentic RAG 将 AI 智能体（Agent）技术与 RAG 深度融合，赋予系统<strong>自主决策、工具使用、任务规划和自我反思</strong>的能力。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8df5e0d13eb425faf76350c4a3f99d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770082202&amp;x-signature=3r9eT12efC8DQiXF7o76POfpGkg%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-23"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>3.1、 Agentic RAG 的核心机制：ReAct 与反思</h3>
<p>Agentic RAG 的核心在于其<strong>智能体框架</strong>，其中 <strong>ReAct（Reasoning and Acting）</strong>  框架是主流实现之一。ReAct 机制允许 LLM 在生成答案之前，进行<strong>推理（Reasoning）</strong>  和<strong>行动（Acting）</strong>  的交替循环：</p>
<ol>
<li><strong>推理（Reasoning）</strong> ：LLM 分析当前任务、已有的信息和下一步的目标，生成一个清晰的思考过程。</li>
<li><strong>行动（Acting）</strong> ：LLM 根据推理结果，决定调用哪个工具（如向量检索器、搜索引擎、代码解释器或 GraphRAG 模块），并执行相应的操作。</li>
</ol>
<p>这种机制使得 Agentic RAG 能够动态地规划复杂的任务。例如，在处理一个需要多步推理的法律查询时，Agent 会将问题分解为多个子任务，并动态选择工具：</p>
<ul>
<li><strong>步骤 1（推理）</strong> ：分析查询，判断需要检索法律条文和计算赔偿金。</li>
<li><strong>步骤 1（行动）</strong> ：调用 <strong>GraphRAG 模块</strong>检索最新的法律条文。</li>
<li><strong>步骤 2（推理）</strong> ：分析检索结果，确定计算公式，判断需要外部计算工具。</li>
<li><strong>步骤 2（行动）</strong> ：调用 <strong>代码解释器</strong>或 <strong>API 工具</strong>执行赔偿金计算。</li>
</ul>
<p>更高级的 Agentic RAG 引入了<strong>自我反思（Self-Reflection）</strong>  机制。在生成答案后，Agent 会利用另一个 LLM 或预设的评估指标（如 RAGAS 框架）对答案进行评估。如果评估结果不理想，Agent 会反思其推理过程和行动步骤，识别错误，并调整策略重新执行，形成一个完整的<strong>优化闭环</strong>。这种反思与优化能力，是 Agentic RAG 实现高度智能化和鲁棒性的重要保障。</p>
<h3 data-id="heading-24"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>3.2、 Agentic RAG 的应用与挑战</h3>
<p>Agentic RAG 的应用场景集中在对<strong>复杂性、准确性和智能化程度</strong>要求极高的领域：</p>
<ul>
<li><strong>智能法律助手</strong>：处理需要多跳推理、多工具协同（法律数据库、计算工具）的复杂法律查询。</li>
<li><strong>金融研究分析</strong>：自主规划数据检索、图表生成、趋势分析等一系列步骤，生成结构化的研究报告。</li>
<li><strong>复杂系统故障诊断</strong>：Agent 根据故障描述，自主调用日志检索工具、代码库、知识图谱，逐步缩小故障范围并提出解决方案。</li>
</ul>
<p>然而，Agentic RAG 也面临巨大的挑战：</p>
<ol>
<li><strong>成本与延迟</strong>：每一次推理和行动都需要 LLM 调用，导致成本和延迟显著增加。</li>
<li><strong>工具调用稳定性</strong>：Agent 对外部工具的调用必须高度稳定和可靠，否则一次失败的行动可能导致整个流程崩溃。</li>
<li><strong>可解释性</strong>：Agent 的决策过程虽然有 ReAct 的推理记录，但其复杂性使得最终的可解释性仍然是一个难题。</li>
</ol>
<h2 data-id="heading-25"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>四、 RAG 系统的未来趋势：多模态、实时化与可信 AI</h2>
<p>RAG 技术的演进仍在加速，未来的发展将聚焦于突破现有架构的边界，使其能够更好地适应真实世界的复杂性和动态性。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e6c4675d7954c53b304e20b524bab1c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770082202&amp;x-signature=MyFEv7ejjq85lEAjSOblHWh0UhM%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-26"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>4.1、 多模态 RAG：重构语义空间</h3>
<p>当前 RAG 主要处理文本，但现实世界是多模态的。<strong>多模态 RAG</strong> 的目标是将文本、图像、音频、视频等不同模态的数据融入统一的 RAG 框架。这要求构建<strong>统一的多模态表示模型</strong>，将不同模态的信息映射到同一个语义空间中，实现跨模态的检索、理解和生成。例如，用户可以上传一张设备故障的图片和一段描述，系统能够从包含技术手册（文本）、维修视频（视频）的知识库中检索信息，并生成包含文本和图片标注的维修指南。</p>
<h3 data-id="heading-27"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>4.2、 实时 RAG 与增量索引：拥抱时效性</h3>
<p>在金融、新闻、实时监控等领域，信息的<strong>时效性</strong>至关重要。未来的 RAG 系统必须是<strong>实时 RAG</strong>，能够处理流式数据并进行<strong>增量索引更新</strong>。传统的 RAG 知识库是静态的，更新成本高昂。实时 RAG 需要采用先进的流处理技术和向量数据库的增量索引能力，确保 LLM 始终能够访问到最新、最准确的知识，从而避免生成过时或错误的信息。</p>
<h3 data-id="heading-28"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>4.3、 可信 RAG 与评估体系的深化</h3>
<p>随着 RAG 在关键领域的应用，<strong>可信 AI</strong> 成为核心要求。未来的 RAG 系统将更加注重：</p>
<ul>
<li><strong>可解释性</strong>：不仅提供答案，还要提供清晰的<strong>引用来源</strong>和 <strong>推理路径</strong>（尤其是 Agentic RAG 和 GraphRAG）。</li>
<li><strong>鲁棒性</strong>：能够抵御对抗性攻击和知识库中的恶意注入。</li>
<li><strong>评估体系深化</strong>：除了传统的召回率和准确率，<strong>RAGAS</strong> 等评估框架将更加普及，利用 LLM 自身的能力来量化答案的<strong>忠实度（Faithfulness）</strong>  和<strong>上下文相关性（Context Relevance）</strong> ，实现数据驱动的持续优化。</li>
</ul>
<p>RAG 的演进是一个从“能用”到“好用”，再到“智能”的螺旋式上升过程。它清晰地展示了 AI 系统如何通过架构创新，将 LLM 的生成能力与外部知识的可靠性完美结合，从而构建出更强大、更可靠的下一代智能应用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangChain 文档转换器与文本分割器组件学习总结]]></title>    <link>https://juejin.cn/post/7599551824548495386</link>    <guid>https://juejin.cn/post/7599551824548495386</guid>    <pubDate>2026-01-27T02:01:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599551824548495386" data-draft-id="7599581204860223514" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LangChain 文档转换器与文本分割器组件学习总结"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-27T02:01:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="心在飞扬AI"/> <meta itemprop="url" content="https://juejin.cn/user/1556564194366823"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LangChain 文档转换器与文本分割器组件学习总结
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1556564194366823/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    心在飞扬AI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T02:01:58.000Z" title="Tue Jan 27 2026 02:01:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">LangChain 文档转换器与文本分割器组件学习总结</h2>
<h3 data-id="heading-1">目录</h3>
<ol>
<li><a href="#1-%E5%AD%97%E7%AC%A6%E6%96%87%E6%9C%AC%E5%88%86%E5%89%B2%E5%99%A8" title="#1-%E5%AD%97%E7%AC%A6%E6%96%87%E6%9C%AC%E5%88%86%E5%89%B2%E5%99%A8">字符文本分割器</a></li>
<li><a href="#2-%E9%80%92%E5%BD%92%E5%AD%97%E7%AC%A6%E6%96%87%E6%9C%AC%E5%88%86%E5%89%B2%E5%99%A8" title="#2-%E9%80%92%E5%BD%92%E5%AD%97%E7%AC%A6%E6%96%87%E6%9C%AC%E5%88%86%E5%89%B2%E5%99%A8">递归字符文本分割器</a></li>
<li><a href="#3-%E7%A8%8B%E5%BA%8F%E4%BB%A3%E7%A0%81%E9%80%92%E5%BD%92%E5%88%86%E5%89%B2%E5%99%A8" title="#3-%E7%A8%8B%E5%BA%8F%E4%BB%A3%E7%A0%81%E9%80%92%E5%BD%92%E5%88%86%E5%89%B2%E5%99%A8">程序代码递归分割器</a></li>
<li><a href="#4-%E8%AF%AD%E4%B9%89%E5%88%86%E5%89%B2%E5%99%A8" title="#4-%E8%AF%AD%E4%B9%89%E5%88%86%E5%89%B2%E5%99%A8">语义分割器</a></li>
<li><a href="#5-html%E6%A0%87%E9%A2%98%E5%88%86%E5%89%B2%E5%99%A8" title="#5-html%E6%A0%87%E9%A2%98%E5%88%86%E5%89%B2%E5%99%A8">HTML标题分割器</a></li>
<li><a href="#6-json%E5%88%86%E5%89%B2%E5%99%A8" title="#6-json%E5%88%86%E5%89%B2%E5%99%A8">JSON分割器</a></li>
<li><a href="#7-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%88%86%E5%89%B2%E5%99%A8" title="#7-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%88%86%E5%89%B2%E5%99%A8">自定义分割器</a></li>
<li><a href="#8-%E4%B8%AD%E8%8B%B1%E6%96%87%E6%B7%B7%E5%90%88%E6%96%87%E6%9C%AC%E5%88%86%E5%89%B2" title="#8-%E4%B8%AD%E8%8B%B1%E6%96%87%E6%B7%B7%E5%90%88%E6%96%87%E6%9C%AC%E5%88%86%E5%89%B2">中英文混合文本分割</a></li>
<li><a href="#-%E5%88%86%E5%89%B2%E5%99%A8%E9%80%89%E6%8B%A9%E6%8C%87%E5%8D%97" title="#-%E5%88%86%E5%89%B2%E5%99%A8%E9%80%89%E6%8B%A9%E6%8C%87%E5%8D%97">分割器选择指南</a></li>
<li><a href="#-%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5" title="#-%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5">核心概念</a></li>
</ol>
<hr/>
<h3 data-id="heading-2">1. 字符文本分割器</h3>
<h4 data-id="heading-3">是什么</h4>
<p>最基础的文本分割器，按照指定的分隔符将文本分割成块</p>
<h4 data-id="heading-4">有什么用</h4>
<ul>
<li>简单的文本分割场景</li>
<li>按固定分隔符（如换行符）切分文档</li>
</ul>
<h4 data-id="heading-5">核心类</h4>
<ul>
<li><code>CharacterTextSplitter</code> (from <code>langchain_text_splitters</code>)</li>
</ul>
<h4 data-id="heading-6">核心参数</h4>
<pre><code class="hljs language-python" lang="python">CharacterTextSplitter(
    separator=<span class="hljs-string">"\n\n"</span>,          <span class="hljs-comment"># 分隔符</span>
    chunk_size=<span class="hljs-number">500</span>,            <span class="hljs-comment"># 每块大小</span>
    chunk_overlap=<span class="hljs-number">50</span>,          <span class="hljs-comment"># 块之间重叠大小</span>
    add_start_index=<span class="hljs-literal">True</span>       <span class="hljs-comment"># 添加起始索引</span>
)
</code></pre>
<h4 data-id="heading-7">示例代码</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_text_splitters <span class="hljs-keyword">import</span> CharacterTextSplitter
<span class="hljs-keyword">from</span> langchain_community.document_loaders <span class="hljs-keyword">import</span> UnstructuredMarkdownLoader

loader = UnstructuredMarkdownLoader(file_path)
documents = loader.load()

text_splitter = CharacterTextSplitter(
    separator=<span class="hljs-string">"\n\n"</span>,
    chunk_size=<span class="hljs-number">500</span>,
    chunk_overlap=<span class="hljs-number">50</span>,
    add_start_index=<span class="hljs-literal">True</span>,
)

chunks = text_splitter.split_documents(documents)

<span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> chunks:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"块大小:<span class="hljs-subst">{<span class="hljs-built_in">len</span>(chunk.page_content)}</span>, 元数据:<span class="hljs-subst">{chunk.metadata}</span>"</span>)
</code></pre>
<hr/>
<h3 data-id="heading-8">2. 递归字符文本分割器（推荐）</h3>
<h4 data-id="heading-9">是什么</h4>
<p>更智能的分割器，会按多个分隔符顺序尝试分割，直到满足块大小要求</p>
<h4 data-id="heading-10">有什么用</h4>
<ul>
<li>适用于大多数通用文本分割场景</li>
<li>能够保持段落的完整性，不会在句子中间切分</li>
<li>默认分隔符顺序：<code>["\n\n", "\n", " ", ""]</code></li>
</ul>
<h4 data-id="heading-11">核心类</h4>
<ul>
<li><code>RecursiveCharacterTextSplitter</code> (from <code>langchain_text_splitters</code>)</li>
</ul>
<h4 data-id="heading-12">核心参数</h4>
<pre><code class="hljs language-python" lang="python">RecursiveCharacterTextSplitter(
    chunk_size=<span class="hljs-number">500</span>,             <span class="hljs-comment"># 每块大小</span>
    chunk_overlap=<span class="hljs-number">50</span>,           <span class="hljs-comment"># 块之间重叠大小</span>
    add_start_index=<span class="hljs-literal">True</span>,       <span class="hljs-comment"># 添加起始索引</span>
    separators=[<span class="hljs-string">"\n\n"</span>, <span class="hljs-string">"\n"</span>, <span class="hljs-string">" "</span>, <span class="hljs-string">""</span>]  <span class="hljs-comment"># 可自定义分隔符列表</span>
)
</code></pre>
<h4 data-id="heading-13">示例代码</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_text_splitters <span class="hljs-keyword">import</span> RecursiveCharacterTextSplitter

text_splitter = RecursiveCharacterTextSplitter(
    chunk_size=<span class="hljs-number">500</span>,
    chunk_overlap=<span class="hljs-number">50</span>,
    add_start_index=<span class="hljs-literal">True</span>,
)

chunks = text_splitter.split_documents(documents)

<span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> chunks:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"块大小: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(chunk.page_content)}</span>, 元数据: <span class="hljs-subst">{chunk.metadata}</span>"</span>)
</code></pre>
<hr/>
<h3 data-id="heading-14">3. 程序代码递归分割器</h3>
<h4 data-id="heading-15">是什么</h4>
<p>专门用于编程代码的分割器，针对不同编程语言优化</p>
<h4 data-id="heading-16">有什么用</h4>
<ul>
<li>保留代码的完整性和语义</li>
<li>按函数、类等代码结构切分</li>
<li>避免在代码逻辑中间切分</li>
</ul>
<h4 data-id="heading-17">核心类</h4>
<ul>
<li><code>RecursiveCharacterTextSplitter.from_language()</code></li>
<li><code>Language</code> 枚举类</li>
</ul>
<h4 data-id="heading-18">支持的语言</h4>
<p>Python, JS, TypeScript, Java, C++, C, Go, PHP, Ruby, Rust, Swift, Markdown, LaTeX, HTML 等</p>
<h4 data-id="heading-19">示例代码</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_text_splitters <span class="hljs-keyword">import</span> RecursiveCharacterTextSplitter, Language

text_splitter = RecursiveCharacterTextSplitter.from_language(
    language=Language.PYTHON,
    chunk_size=<span class="hljs-number">500</span>,
    chunk_overlap=<span class="hljs-number">50</span>,
    add_start_index=<span class="hljs-literal">True</span>,
)

chunks = text_splitter.split_documents(documents)

<span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> chunks:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"块大小: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(chunk.page_content)}</span>, 元数据: <span class="hljs-subst">{chunk.metadata}</span>"</span>)

<span class="hljs-built_in">print</span>(chunks[<span class="hljs-number">2</span>].page_content)  <span class="hljs-comment"># 查看具体的代码块</span>
</code></pre>
<hr/>
<h3 data-id="heading-20">4. 语义分割器</h3>
<h4 data-id="heading-21">是什么</h4>
<p>基于语义相似度的分割器，使用embedding模型计算文本语义边界</p>
<h4 data-id="heading-22">有什么用</h4>
<ul>
<li>按语义相关性分割，保持语义连贯性</li>
<li>适合需要理解文本含义的场景</li>
<li>能够识别话题变化点</li>
</ul>
<h4 data-id="heading-23">核心类</h4>
<ul>
<li><code>SemanticChunker</code> (from <code>langchain_experimental.text_splitter</code>)</li>
</ul>
<h4 data-id="heading-24">核心参数</h4>
<pre><code class="hljs language-python" lang="python">SemanticChunker(
    embeddings=QianfanEmbeddingsEndpoint(),  <span class="hljs-comment"># 嵌入模型</span>
    number_of_chunks=<span class="hljs-number">10</span>,                      <span class="hljs-comment"># 分割块数</span>
    add_start_index=<span class="hljs-literal">True</span>,
    sentence_split_regex=<span class="hljs-string">r"(?&lt;=[。？！.?!])"</span>  <span class="hljs-comment"># 句子分割正则</span>
)
</code></pre>
<h4 data-id="heading-25">示例代码</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_experimental.text_splitter <span class="hljs-keyword">import</span> SemanticChunker
<span class="hljs-keyword">from</span> langchain_community.embeddings.baidu_qianfan_endpoint <span class="hljs-keyword">import</span> QianfanEmbeddingsEndpoint
<span class="hljs-keyword">import</span> dotenv

dotenv.load_dotenv()

text_splitter = SemanticChunker(
    embeddings=QianfanEmbeddingsEndpoint(),
    number_of_chunks=<span class="hljs-number">10</span>,
    add_start_index=<span class="hljs-literal">True</span>,
    sentence_split_regex=<span class="hljs-string">r"(?&lt;=[。？！.?!])"</span>
)

documents = loader.load()
chunks = text_splitter.split_documents(documents)

<span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> chunks:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"块大小: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(chunk.page_content)}</span>, 元数据: <span class="hljs-subst">{chunk.metadata}</span>"</span>)

<span class="hljs-built_in">print</span>(chunks[<span class="hljs-number">0</span>].page_content)
</code></pre>
<hr/>
<h3 data-id="heading-26">5. HTML标题分割器</h3>
<h4 data-id="heading-27">是什么</h4>
<p>专门用于HTML文档的分割器，按照HTML标题层级切分</p>
<h4 data-id="heading-28">有什么用</h4>
<ul>
<li>保留HTML文档的结构层次</li>
<li>适合处理网页、博客文章等HTML内容</li>
<li>自动保留标题元数据</li>
</ul>
<h4 data-id="heading-29">核心类</h4>
<ul>
<li><code>HTMLHeaderTextSplitter</code> (from <code>langchain_text_splitters</code>)</li>
</ul>
<h4 data-id="heading-30">核心参数</h4>
<pre><code class="hljs language-python" lang="python">headers_to_split_on = [
    (<span class="hljs-string">"h1"</span>, <span class="hljs-string">"一级标题"</span>),
    (<span class="hljs-string">"h2"</span>, <span class="hljs-string">"二级标题"</span>),
    (<span class="hljs-string">"h3"</span>, <span class="hljs-string">"三级标题"</span>),
]
</code></pre>
<h4 data-id="heading-31">示例代码</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_text_splitters <span class="hljs-keyword">import</span> HTMLHeaderTextSplitter

html_string = <span class="hljs-string">"""
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;body&gt;
    &lt;div&gt;
        &lt;h1&gt;标题1&lt;/h1&gt;
        &lt;p&gt;关于标题1的一些介绍文本。&lt;/p&gt;
        &lt;div&gt;
            &lt;h2&gt;子标题1&lt;/h2&gt;
            &lt;p&gt;关于子标题1的一些介绍文本。&lt;/p&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
"""</span>

headers_to_split_on = [
    (<span class="hljs-string">"h1"</span>, <span class="hljs-string">"一级标题"</span>),
    (<span class="hljs-string">"h2"</span>, <span class="hljs-string">"二级标题"</span>),
    (<span class="hljs-string">"h3"</span>, <span class="hljs-string">"三级标题"</span>),
]

text_splitter = HTMLHeaderTextSplitter(headers_to_split_on)
chunks = text_splitter.split_text(html_string)

<span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> chunks:
    <span class="hljs-built_in">print</span>(chunk)
</code></pre>
<hr/>
<h3 data-id="heading-32">6. JSON分割器</h3>
<h4 data-id="heading-33">是什么</h4>
<p>递归分割JSON数据的分割器，可以处理嵌套的JSON结构</p>
<h4 data-id="heading-34">有什么用</h4>
<ul>
<li>处理大型JSON文件或API响应</li>
<li>保留JSON的层次结构</li>
<li>避免破坏JSON数据的完整性</li>
</ul>
<h4 data-id="heading-35">核心类</h4>
<ul>
<li><code>RecursiveJsonSplitter</code> (from <code>langchain_text_splitters</code>)</li>
</ul>
<h4 data-id="heading-36">核心参数</h4>
<pre><code class="hljs language-python" lang="python">RecursiveJsonSplitter(max_chunk_size=<span class="hljs-number">300</span>)  <span class="hljs-comment"># 最大块大小</span>
</code></pre>
<h4 data-id="heading-37">示例代码</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_text_splitters <span class="hljs-keyword">import</span> RecursiveJsonSplitter
<span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> json

<span class="hljs-comment"># 获取JSON数据</span>
url = <span class="hljs-string">"https://api.smith.langchain.com/openapi.json"</span>
json_data = requests.get(url).json()
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"原始JSON大小: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(json.dumps(json_data))}</span>"</span>)

<span class="hljs-comment"># 创建分割器</span>
text_splitter = RecursiveJsonSplitter(max_chunk_size=<span class="hljs-number">300</span>)

<span class="hljs-comment"># 分割JSON数据</span>
json_chunks = text_splitter.split_json(json_data)
chunks = text_splitter.create_documents(json_chunks)

<span class="hljs-comment"># 输出结果</span>
total_size = <span class="hljs-built_in">sum</span>(<span class="hljs-built_in">len</span>(chunk.page_content) <span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> chunks)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"分割后总大小: <span class="hljs-subst">{total_size}</span>"</span>)
</code></pre>
<hr/>
<h3 data-id="heading-38">7. 自定义分割器</h3>
<h4 data-id="heading-39">是什么</h4>
<p>继承<code>TextSplitter</code>基类，实现自定义的分割逻辑</p>
<h4 data-id="heading-40">有什么用</h4>
<ul>
<li>特殊需求场景</li>
<li>结合jieba等工具实现中文关键词提取等定制功能</li>
<li>实现特定业务逻辑的文本处理</li>
</ul>
<h4 data-id="heading-41">核心类</h4>
<ul>
<li><code>TextSplitter</code> (基类)</li>
</ul>
<h4 data-id="heading-42">关键方法</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">split_text</span>(<span class="hljs-params">self, text: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]:
    <span class="hljs-comment"># 必须实现此方法</span>
    <span class="hljs-keyword">pass</span>
</code></pre>
<h4 data-id="heading-43">示例代码</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>
<span class="hljs-keyword">from</span> langchain_text_splitters <span class="hljs-keyword">import</span> TextSplitter
<span class="hljs-keyword">import</span> jieba.analyse

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomTextSplitter</span>(<span class="hljs-title class_ inherited__">TextSplitter</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, separator: <span class="hljs-built_in">str</span> = <span class="hljs-string">"\n\n"</span>, top_k: <span class="hljs-built_in">int</span> = <span class="hljs-number">10</span>, **kwargs</span>):
        <span class="hljs-built_in">super</span>().__init__(**kwargs)
        self.separator = separator
        self.top_k = top_k

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">split_text</span>(<span class="hljs-params">self, text: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]:
        <span class="hljs-comment"># 按分隔符切分</span>
        split_texts = text.split(self.separator)
        text_keywords = []

        <span class="hljs-comment"># 对每段提取关键词</span>
        <span class="hljs-keyword">for</span> split_text <span class="hljs-keyword">in</span> split_texts:
            keywords = jieba.analyse.extract_tags(split_text, topK=self.top_k)
            text_keywords.append(keywords)

        <span class="hljs-comment"># 返回关键词字符串</span>
        <span class="hljs-keyword">return</span> [<span class="hljs-string">' '</span>.join(keywords) <span class="hljs-keyword">for</span> keywords <span class="hljs-keyword">in</span> text_keywords]

<span class="hljs-comment"># 使用自定义分割器</span>
loader = UnstructuredFileLoader(file_path)
text_splitter = CustomTextSplitter(<span class="hljs-string">"\n\n"</span>, <span class="hljs-number">10</span>)

documents = loader.load()
chunks = text_splitter.split_documents(documents)

<span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> chunks:
    <span class="hljs-built_in">print</span>(chunk.page_content)
</code></pre>
<hr/>
<h3 data-id="heading-44">8. 中英文混合文本分割</h3>
<h4 data-id="heading-45">是什么</h4>
<p>配置多个分隔符来处理中英文混合场景</p>
<h4 data-id="heading-46">有什么用</h4>
<ul>
<li>处理中英文混合文档</li>
<li>适配不同语言的标点符号</li>
<li>保证分割后的文本块语义完整</li>
</ul>
<h4 data-id="heading-47">分隔符配置示例</h4>
<pre><code class="hljs language-python" lang="python">separators = [
    <span class="hljs-string">"\n\n"</span>,                <span class="hljs-comment"># 段落分隔</span>
    <span class="hljs-string">"\n"</span>,                  <span class="hljs-comment"># 行分隔</span>
    <span class="hljs-string">"。|！|？"</span>,            <span class="hljs-comment"># 中文句号</span>
    <span class="hljs-string">"\.\s|\!\s|\?\s"</span>,      <span class="hljs-comment"># 英文标点+空格</span>
    <span class="hljs-string">"；|;\s"</span>,              <span class="hljs-comment"># 分号</span>
    <span class="hljs-string">"，|,\s"</span>,              <span class="hljs-comment"># 逗号</span>
    <span class="hljs-string">" "</span>,                   <span class="hljs-comment"># 空格</span>
    <span class="hljs-string">""</span>                     <span class="hljs-comment"># 字符级别（最后手段）</span>
]
</code></pre>
<h4 data-id="heading-48">示例代码</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_text_splitters <span class="hljs-keyword">import</span> RecursiveCharacterTextSplitter

separators = [
    <span class="hljs-string">"\n\n"</span>,
    <span class="hljs-string">"\n"</span>,
    <span class="hljs-string">"。|！|？"</span>,
    <span class="hljs-string">"\.\s|\!\s|\?\s"</span>,  <span class="hljs-comment"># 英文标点符号后面通常需要加空格</span>
    <span class="hljs-string">"；|;\s"</span>,
    <span class="hljs-string">"，|,\s"</span>,
    <span class="hljs-string">" "</span>,
    <span class="hljs-string">""</span>
]

text_splitter = RecursiveCharacterTextSplitter(
    separators=separators,
    is_separator_regex=<span class="hljs-literal">True</span>,  <span class="hljs-comment"># 启用正则表达式</span>
    chunk_size=<span class="hljs-number">500</span>,
    chunk_overlap=<span class="hljs-number">50</span>,
    add_start_index=<span class="hljs-literal">True</span>,
)

documents = loader.load()
chunks = text_splitter.split_documents(documents)

<span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> chunks:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"块大小: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(chunk.page_content)}</span>, 元数据: <span class="hljs-subst">{chunk.metadata}</span>"</span>)
</code></pre>
<hr/>
<h3 data-id="heading-49">分割器选择指南</h3>


















































<table><thead><tr><th>场景</th><th>推荐分割器</th><th>说明</th></tr></thead><tbody><tr><td>通用文本</td><td><code>RecursiveCharacterTextSplitter</code></td><td>最常用的选择，智能分割</td></tr><tr><td>代码文件</td><td><code>RecursiveCharacterTextSplitter.from_language()</code></td><td>保留代码结构</td></tr><tr><td>语义分割</td><td><code>SemanticChunker</code></td><td>基于语义相似度，需要embedding模型</td></tr><tr><td>HTML文档</td><td><code>HTMLHeaderTextSplitter</code></td><td>按标题层级分割</td></tr><tr><td>JSON数据</td><td><code>RecursiveJsonSplitter</code></td><td>处理嵌套JSON</td></tr><tr><td>简单分割</td><td><code>CharacterTextSplitter</code></td><td>基础固定分隔符</td></tr><tr><td>特殊需求</td><td>自定义 <code>TextSplitter</code></td><td>实现特定逻辑</td></tr><tr><td>中英文混合</td><td><code>RecursiveCharacterTextSplitter</code> + 自定义separators</td><td>配合正则表达式</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-50">核心概念</h3>
<h4 data-id="heading-51">通用参数说明</h4>








































<table><thead><tr><th>参数</th><th>说明</th><th>推荐值</th></tr></thead><tbody><tr><td><code>chunk_size</code></td><td>每个文本块的目标字符数</td><td>500-1000</td></tr><tr><td><code>chunk_overlap</code></td><td>相邻块之间的重叠字符数</td><td>50-200</td></tr><tr><td><code>separator</code></td><td>用于分割的分隔符</td><td><code>"\n\n"</code>, <code>"\n"</code> 等</td></tr><tr><td><code>separators</code></td><td>分隔符列表（按优先级）</td><td>见上方配置</td></tr><tr><td><code>add_start_index</code></td><td>是否在元数据中记录起始位置</td><td><code>True</code></td></tr><tr><td><code>is_separator_regex</code></td><td>是否将分隔符作为正则表达式</td><td><code>True</code>/<code>False</code></td></tr></tbody></table>
<h4 data-id="heading-52">chunk_overlap 的作用</h4>
<ul>
<li><strong>保持上下文连贯</strong>：避免关键信息被分割到两个块的边界</li>
<li><strong>提高检索质量</strong>：重叠部分可以作为检索的冗余信息</li>
<li><strong>推荐设置</strong>：一般为 <code>chunk_size</code> 的 10%-20%</li>
</ul>
<h4 data-id="heading-53">chunk_size 的选择</h4>
<ul>
<li><strong>太小</strong>：上下文不足，语义不完整</li>
<li><strong>太大</strong>：超出模型上下文窗口，检索精度下降</li>
<li><strong>推荐</strong>：
<ul>
<li>短文本：200-500</li>
<li>中等文本：500-1000</li>
<li>长文本：1000-2000</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-54">最佳实践</h3>
<h4 data-id="heading-55">1. 优先使用递归分割器</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 推荐</span>
RecursiveCharacterTextSplitter(chunk_size=<span class="hljs-number">500</span>, chunk_overlap=<span class="hljs-number">50</span>)

<span class="hljs-comment"># 不推荐（容易在句子中间切分）</span>
CharacterTextSplitter(separator=<span class="hljs-string">"\n"</span>, chunk_size=<span class="hljs-number">500</span>)
</code></pre>
<h4 data-id="heading-56">2. 根据文档类型选择</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 代码文档</span>
RecursiveCharacterTextSplitter.from_language(
    language=Language.PYTHON,
    chunk_size=<span class="hljs-number">1000</span>
)

<span class="hljs-comment"># HTML文档</span>
HTMLHeaderTextSplitter(headers_to_split_on)

<span class="hljs-comment"># API响应</span>
RecursiveJsonSplitter(max_chunk_size=<span class="hljs-number">300</span>)
</code></pre>
<h4 data-id="heading-57">3. 中英文场景处理</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 使用正则表达式分隔符</span>
separators = [
    <span class="hljs-string">"\n\n"</span>,
    <span class="hljs-string">"\n"</span>,
    <span class="hljs-string">"。|！|？"</span>,
    <span class="hljs-string">"\.\s|\!\s|\?\s"</span>,
]
text_splitter = RecursiveCharacterTextSplitter(
    separators=separators,
    is_separator_regex=<span class="hljs-literal">True</span>
)
</code></pre>
<h4 data-id="heading-58">4. 保留元数据</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 始终添加起始索引</span>
text_splitter = RecursiveCharacterTextSplitter(
    add_start_index=<span class="hljs-literal">True</span>  <span class="hljs-comment"># 便于追溯原文位置</span>
)
</code></pre>
<hr/>
<h3 data-id="heading-59">相关资源</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fpython.langchain.com%2Fdocs%2Fmodules%2Fdata_connection%2Fdocument_transformers%2F" target="_blank" title="https://python.langchain.com/docs/modules/data_connection/document_transformers/" ref="nofollow noopener noreferrer">LangChain Text Splitters 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=..%2F25%2520langchain%2520%25E5%2586%2585%25E7%25BD%25AE%25E7%25BB%2584%25E4%25BB%25B6%25E5%2592%258C%25E6%2596%2587%25E6%25A1%25A3%25E5%258A%25A0%25E8%25BD%25BD%25E5%2599%25A8%2F%25E5%25AD%25A6%25E4%25B9%25A0%25E6%2580%25BB%25E7%25BB%2593.md" target="_blank" title="../25%20langchain%20%E5%86%85%E7%BD%AE%E7%BB%84%E4%BB%B6%E5%92%8C%E6%96%87%E6%A1%A3%E5%8A%A0%E8%BD%BD%E5%99%A8/%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93.md" ref="nofollow noopener noreferrer">Document Loader 学习总结</a></li>
<li><a href="https://link.juejin.cn?target=..%2F27%2520Blob%25E4%25B8%258EBlobParser%25E4%25BA%2592%25E6%2596%2587%25E6%259C%25AC%2F%25E5%25AD%25A6%25E4%25B9%25A0%25E6%2580%25BB%25E7%25BB%2593.md" target="_blank" title="../27%20Blob%E4%B8%8EBlobParser%E4%BA%92%E6%96%87%E6%9C%AC/%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93.md" ref="nofollow noopener noreferrer">Blob 与 BlobParser 学习总结</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[升级版js实现图片拖拽、根据鼠标位置放大、缩小功能]]></title>    <link>https://juejin.cn/post/7599579865608011818</link>    <guid>https://juejin.cn/post/7599579865608011818</guid>    <pubDate>2026-01-27T02:58:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599579865608011818" data-draft-id="7599585289947250751" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="升级版js实现图片拖拽、根据鼠标位置放大、缩小功能"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-27T02:58:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户1567703855869"/> <meta itemprop="url" content="https://juejin.cn/user/2313815481135598"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            升级版js实现图片拖拽、根据鼠标位置放大、缩小功能
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2313815481135598/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户1567703855869
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T02:58:33.000Z" title="Tue Jan 27 2026 02:58:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">canvasImage</span> = function (path, annotations) {
    let <span class="hljs-attr">imageUrl</span> = <span class="hljs-string">''</span><span class="hljs-comment">;</span>
    <span class="hljs-attr">imageUrl</span> = path<span class="hljs-comment">;</span>
    let <span class="hljs-attr">initState</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
    let <span class="hljs-attr">scale</span> = <span class="hljs-number">1</span><span class="hljs-comment">; let originX = 0; let originY = 0; let isDragging = false; let lastX; let lastY;</span>
    const <span class="hljs-attr">canvas</span> = document.getElementById(<span class="hljs-string">'annotationCanvas'</span>)<span class="hljs-comment">;</span>

    // 清空画布内容和标注信息
    <span class="hljs-attr">canvas.innerHTML</span> = <span class="hljs-string">''</span><span class="hljs-comment">;</span>

    <span class="hljs-attr">canvas.style.display</span> = <span class="hljs-string">'block'</span><span class="hljs-comment">;</span>
    const <span class="hljs-attr">ctx</span> = canvas.getContext(<span class="hljs-string">'2d'</span>)<span class="hljs-comment">;</span>
    const <span class="hljs-attr">image</span> = new Image()<span class="hljs-comment">;</span>
    function resizeCanvas() {
      <span class="hljs-attr">canvas.width</span> = window.innerWidth<span class="hljs-comment">;</span>
      <span class="hljs-attr">canvas.height</span> = window.innerHeight<span class="hljs-comment">;</span>
      draw()<span class="hljs-comment">;</span>
    }
    // 添加关闭按钮
    const <span class="hljs-attr">closeButton</span> = document.createElement(<span class="hljs-string">'button'</span>)<span class="hljs-comment">;</span>
    <span class="hljs-attr">closeButton.innerHTML</span> = <span class="hljs-string">'X'</span><span class="hljs-comment">;</span>
    <span class="hljs-attr">closeButton.title</span> = <span class="hljs-string">'关闭预览'</span><span class="hljs-comment">;</span>
    <span class="hljs-attr">closeButton.className</span> = <span class="hljs-string">'canvasCloseButton'</span><span class="hljs-comment">;</span>
    document.body.appendChild(closeButton)<span class="hljs-comment">;</span>

    closeButton.addEventListener('click', function () {
      <span class="hljs-attr">imageUrl</span> = <span class="hljs-string">''</span><span class="hljs-comment">;</span>
      <span class="hljs-attr">canvas.style.display</span> = <span class="hljs-string">'none'</span><span class="hljs-comment">;</span>
      document.body.removeChild(closeButton)<span class="hljs-comment">;</span>
    })<span class="hljs-comment">;</span>
    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height)<span class="hljs-comment">;</span>
      ctx.save()<span class="hljs-comment">;</span>
      ctx.translate(originX, originY)<span class="hljs-comment">;</span>
      ctx.scale(scale, scale)<span class="hljs-comment">;</span>

      if (annotations.length) {
        ctx.drawImage(image, 0, 0)<span class="hljs-comment">;</span>
      } else {
        // 获取 canvas 的宽度和高度
        const <span class="hljs-attr">canvasWidth</span> = canvas.width<span class="hljs-comment">;</span>
        const <span class="hljs-attr">canvasHeight</span> = canvas.height<span class="hljs-comment">;</span>
        // 获取图片的宽度和高度
        const <span class="hljs-attr">imageWidth</span> = image.width<span class="hljs-comment">;</span>
        const <span class="hljs-attr">imageHeight</span> = image.height<span class="hljs-comment">;</span>
        // 计算图片在画布上的位置
        const <span class="hljs-attr">x</span> = (canvasWidth - imageWidth) / <span class="hljs-number">2</span><span class="hljs-comment">;</span>
        const <span class="hljs-attr">y</span> = (canvasHeight - imageHeight) / <span class="hljs-number">2</span><span class="hljs-comment">;</span>
        ctx.drawImage(image, x, y)<span class="hljs-comment">;</span>
        <span class="hljs-attr">initState</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
      }
      if (annotations.length) {
        annotations.forEach((item) =&gt; {
          if (item.range) {
            <span class="hljs-attr">ctx.lineWidth</span> = <span class="hljs-number">10</span><span class="hljs-comment">;</span>
            ctx.beginPath()<span class="hljs-comment">;</span>
            <span class="hljs-attr">ctx.strokeStyle</span> = <span class="hljs-string">'red'</span><span class="hljs-comment">;</span>
            ctx.strokeRect(
              item.range.x - 10,
              item.range.y - 10,
              item.range.width + 20,
              item.range.height + 20
            )<span class="hljs-comment">;</span>
          }
          <span class="hljs-attr">ctx.fillStyle</span> = <span class="hljs-string">'yellow'</span><span class="hljs-comment">;</span>
          <span class="hljs-attr">ctx.font</span> = <span class="hljs-string">'100px fangsong'</span><span class="hljs-comment">;</span>
          ctx.fillText(item.text, item.posX, item.posY - 50)<span class="hljs-comment">;</span>
          ctx.fill()<span class="hljs-comment">;</span>
          if (item.rect) {
            <span class="hljs-attr">ctx.lineWidth</span> = <span class="hljs-number">10</span><span class="hljs-comment">;</span>
            ctx.beginPath()<span class="hljs-comment">;</span>
            <span class="hljs-attr">ctx.strokeStyle</span> = <span class="hljs-string">'yellow'</span><span class="hljs-comment">;</span>
            ctx.strokeRect(
              item.rect.x - 5,
              item.rect.y - 5,
              item.rect.width + 10,
              item.rect.height + 10
            )<span class="hljs-comment">;</span>
          }
          if (initState) {
            <span class="hljs-attr">scale</span> = canvas.height / image.height<span class="hljs-comment">;</span>
            <span class="hljs-attr">originX</span> = (canvas.width - image.width * scale) / <span class="hljs-number">2</span><span class="hljs-comment">;</span>
            <span class="hljs-attr">initState</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
            draw()<span class="hljs-comment">;</span>
          }
        })<span class="hljs-comment">;</span>
        ctx.restore()<span class="hljs-comment">;</span>
      }
      ctx.restore()<span class="hljs-comment">;</span>
    }
    <span class="hljs-attr">image.src</span> = imageUrl<span class="hljs-comment">;</span>
    <span class="hljs-attr">image.onload</span> = resizeCanvas<span class="hljs-comment">;</span>
    window.addEventListener('resize', resizeCanvas)<span class="hljs-comment">;</span>
    <span class="hljs-section">['mousedown', 'mouseup', 'mouseout', 'mousemove', 'wheel']</span>.forEach(<span class="hljs-attr">eventName</span> =&gt; {
      canvas.addEventListener(eventName, (e) =&gt; {
        switch (eventName) {
          case 'mousedown':
            <span class="hljs-attr">isDragging</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
            <span class="hljs-attr">lastX</span> = e.<span class="hljs-literal">off</span>setX - originX<span class="hljs-comment">;</span>
            <span class="hljs-attr">lastY</span> = e.<span class="hljs-literal">off</span>setY - originY<span class="hljs-comment">;</span>
            break<span class="hljs-comment">;</span>
          case 'mouseup':
          case 'mouseout':
            <span class="hljs-attr">isDragging</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
            break<span class="hljs-comment">;</span>
          case 'mousemove':
            if (isDragging) {
              <span class="hljs-attr">originX</span> = e.<span class="hljs-literal">off</span>setX - lastX<span class="hljs-comment">;</span>
              <span class="hljs-attr">originY</span> = e.<span class="hljs-literal">off</span>setY - lastY<span class="hljs-comment">;</span>
              draw()<span class="hljs-comment">;</span>
            }
            break<span class="hljs-comment">;</span>
          case 'wheel':
            e.preventDefault()<span class="hljs-comment">;</span>
            var <span class="hljs-attr">mouseX</span> = e.<span class="hljs-literal">off</span>setX<span class="hljs-comment">;</span>
            var <span class="hljs-attr">mouseY</span> = e.<span class="hljs-literal">off</span>setY<span class="hljs-comment">;</span>
            var <span class="hljs-attr">wheel</span> = e.deltaY &lt; <span class="hljs-number">0</span> ? <span class="hljs-number">1.1</span> : <span class="hljs-number">0.9</span><span class="hljs-comment">;</span>
            var <span class="hljs-attr">newScale</span> = scale * wheel<span class="hljs-comment">;</span>
            draw()<span class="hljs-comment">;</span>
            if (newScale &lt; 0.1 || newScale &gt; 5) return<span class="hljs-comment">;</span>
            var <span class="hljs-attr">newOriginX</span> = mouseX - (mouseX - originX) * wheel<span class="hljs-comment">;</span>
            var <span class="hljs-attr">newOriginY</span> = mouseY - (mouseY - originY) * wheel<span class="hljs-comment">;</span>
            <span class="hljs-attr">scale</span> = newScale<span class="hljs-comment">;</span>
            <span class="hljs-attr">originX</span> = newOriginX<span class="hljs-comment">;</span>
            <span class="hljs-attr">originY</span> = newOriginY<span class="hljs-comment">;</span>

            break<span class="hljs-comment">;</span>
        }
      })<span class="hljs-comment">;</span>
    })<span class="hljs-comment">;</span>

    // 监听键盘事件
    window.addEventListener('keydown', (e) =&gt; {
      if (<span class="hljs-attr">e.keyCode</span> === <span class="hljs-number">27</span>) { // 检测到 esc 键被按下
        <span class="hljs-attr">imageUrl</span> = <span class="hljs-string">''</span><span class="hljs-comment">;</span>
        <span class="hljs-attr">canvas.style.display</span> = <span class="hljs-string">'none'</span><span class="hljs-comment">;</span>
        document.body.removeChild(closeButton)<span class="hljs-comment">;</span>
      }
    })<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[4 个本周优秀的 GitHub 开源项目。]]></title>    <link>https://juejin.cn/post/7599585289947316287</link>    <guid>https://juejin.cn/post/7599585289947316287</guid>    <pubDate>2026-01-27T03:01:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599585289947316287" data-draft-id="7599591405312786473" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="4 个本周优秀的 GitHub 开源项目。"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2026-01-27T03:01:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="逛逛GitHub"/> <meta itemprop="url" content="https://juejin.cn/user/1442202996186093"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            4 个本周优秀的 GitHub 开源项目。
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1442202996186093/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    逛逛GitHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T03:01:02.000Z" title="Tue Jan 27 2026 03:01:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>01</p>
<p><strong>编程的方式做视频</strong></p>
<p>Remotion 最近因为他们推出了 Skill 又火了一波。</p>
<p>Remotion 可以让你使用 React 来以代码的方式创建视频。不同于传统的视频剪辑软件，Remotion 将视频制作过程变成了编写代码的过程。</p>
<p>它利用 HTML、CSS、SVG、Canvas 和 WebGL 等标准的 Web 技术来生成视频画面，并通过编程逻辑，比如循环、变量、API 数据获取来控制动画和内容的生成。</p>
<p>亮点就是把视频生成可编程和可复用的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62bfb06b8ebc4b45a8d91d1352be28d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770087661&amp;x-signature=AEyOPUMsxq29FgsXBg1Qlbh%2BFKY%3D" alt="图片" loading="lazy"/></p>
<p>你可以像开发网页组件一样开发视频片段，还支持实时预览修改效果。</p>
<p>这个开源项目应该是目前 GitHub 上程序化视频生成最火的项目。它非常适合需要动态内容、批量生产或极其复杂的数学动画场景。</p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/remotion-dev/remotion</span>
</code></pre>
<p>02</p>
<p><strong>生成式 UI 的 SDK</strong></p>
<p>Tambo 是一个 SDK，专为 React 应用设计的 生成式 UI 开发工具包。</p>
<p>不再让用户去适应固定的界面流程，而是通过 AI 根据用户的自然语言对话，实时决定并渲染出最合适的 UI 组件。</p>
<p>简单来说，它让开发者可以在聊天界面中流式传输交互界面，而不仅仅是文本。</p>
<p>你需要在 Tambo 中注册自己应用内的 React 组件，比如图表、表单、购物车啥的，并定义好每个组件所需的属性模式。</p>
<p>在对话框中提出需求，比如显示上季度的销售数据时，Tambo 的 AI 引擎会解析意图，自动选择一个折线图组件，并填充正确的数据进行渲染，整个过程对用户是无感且自然的。</p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/tambo-ai/tambo</span>
</code></pre>
<p>03</p>
<p><strong>给终端 AI 配一个 UI</strong></p>
<p>AionUi 是一款开源的跨平台桌面 GUI 应用。</p>
<p>其实就是给命令行 AI 工具，比如 Google Gemini CLI、Claude Code 啥的提供图形化界面。</p>
<p>支持 Windows、macOS 和 Linux 系统，通过将原本仅能在终端中操作的指令转化为可视化的交互界面。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9998a2f3b37e4cc780eb93a1e7c7a585~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770087661&amp;x-signature=Slx20NJDjl0s4lbcQkGSZS5Em78%3D" alt="图片" loading="lazy"/></p>
<p>AionUi 不仅内置了对 Google Gemini CLI 的原生支持，还提供了多 Agent 模式，你可以集成 Claude Code、Qwen Code 等其他终端 AI  Agent。</p>
<p>你可以在一个统一的界面中切换使用不同的 AI 模型或工具。</p>
<p>而且所有的对话数据都存储在本地的 SQLite 数据库中，除非你主动配置云端服务，否则数据不会上传至外部服务器。</p>
<p>除了基础的聊天对话外，它还支持智能文件管理，比如批量重命名、自动整理文件夹、数据处理以及 Word、PPT 文档生成。</p>
<p>它还具备 AI 图像生成与编辑能力，并内置了多种格式的文件预览面板，让用户能即时查看 AI 处理后的结果。</p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/iOfficeAI/AionUi</span>
</code></pre>
<p>04</p>
<p><strong>多智能体协作平台</strong></p>
<p>Eigent 是一个开源多智能体（Multi-Agent）协作平台。底层基于 CAMEL 框架。</p>
<p>你用这个开源项目能在自己的电脑上创建多个 AI Agent 组成的虚拟团队。</p>
<p>与单一的 AI 聊天助手不同，Eigent 能够协调多个专注于不同领域的 Agent，比如搜索员、程序员、文档编写员来并行协作，解决复杂的长周期任务。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f3748a243fa40dba26ea4f4656f4c4d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770087661&amp;x-signature=B%2FtTDt8sqni%2FqFUqU%2BW1e%2FqLwJQ%3D" alt="图片" loading="lazy"/></p>
<p>Eigent  支持完全本地化部署，能够集成 vLLM 和 Ollama 等多种模型，确保数据隐私。</p>
<p>它预置了开发者、浏览器和文档处理等专用 Agent ，并支持 MCP 以扩展工具集成能力。</p>
<p>你不需要复杂配置即可使用，系统还包含人机协同机制，在任务执行中进行人工干预以保证准确性。</p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/eigent-ai/eigent</span>
</code></pre>
<p>05</p>
<p><strong>其它开源项目</strong></p>
<p>下面这个截图是本周最火的几个开源项目，有一些之前推荐过就没有详细介绍。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c3afe1d8b9542b3a5d67ca540c72ea3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770087661&amp;x-signature=yLlX83mtqeIpqwyjRhOeT%2FWvdKA%3D" alt="图片" loading="lazy"/></p>
<p>更多案例视频介绍请查看：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FsKcZ5MSccGUQaMTI4L4Rug" target="_blank" title="https://mp.weixin.qq.com/s/sKcZ5MSccGUQaMTI4L4Rug" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/sKcZ5MScc…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[非分割类型的文档转换器 - 学习总结]]></title>    <link>https://juejin.cn/post/7599581687358554162</link>    <guid>https://juejin.cn/post/7599581687358554162</guid>    <pubDate>2026-01-27T02:10:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599581687358554162" data-draft-id="7599551824548626458" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="非分割类型的文档转换器 - 学习总结"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-27T02:10:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="心在飞扬AI"/> <meta itemprop="url" content="https://juejin.cn/user/1556564194366823"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            非分割类型的文档转换器 - 学习总结
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1556564194366823/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    心在飞扬AI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T02:10:35.000Z" title="Tue Jan 27 2026 02:10:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">非分割类型的文档转换器 - 学习总结</h2>
<h3 data-id="heading-1">概述</h3>
<p>本目录展示了 LangChain 中不进行文档分割，而是对整个文档进行转换的处理器。这类转换器不会改变文档数量，而是对文档内容进行增强或转换。</p>
<h3 data-id="heading-2">核心概念</h3>
<h4 data-id="heading-3">非分割类型文档转换器的特点</h4>
<ol>
<li>不改变文档数量：输入 N 个文档，输出 N 个文档</li>
<li>内容增强/转换：
<ul>
<li>问答对提取（用于 RAG 检索增强）</li>
<li>翻译（多语言支持）</li>
<li>总结生成</li>
<li>信息提取</li>
</ul>
</li>
<li>保持结构：原文内容保留在 <code>page_content</code>，增强信息存储在 <code>metadata</code></li>
</ol>
<h4 data-id="heading-4">与分割器的区别</h4>























<table><thead><tr><th>类型</th><th>输入文档数</th><th>输出文档数</th><th>主要作用</th></tr></thead><tbody><tr><td>分割器 (TextSplitter)</td><td>1</td><td>多个</td><td>将长文档切分成小块</td></tr><tr><td>转换器 (Transformer)</td><td>N</td><td>N</td><td>对文档内容进行增强或转换</td></tr></tbody></table>
<h4 data-id="heading-5">实际应用架构</h4>
<pre><code class="hljs language-rust" lang="rust">原始文档 <span class="hljs-punctuation">-&gt;</span> 加载器 <span class="hljs-punctuation">-&gt;</span> 文档转换器（问答/翻译） <span class="hljs-punctuation">-&gt;</span> 向量化 <span class="hljs-punctuation">-&gt;</span> RAG 检索
</code></pre>
<hr/>
<h3 data-id="heading-6">文件详解</h3>
<h4 data-id="heading-7">1. 问答转换器示例.py</h4>
<p><strong>用途</strong>：使用 Doctran 库从文档中自动提取问答对</p>
<p><strong>核心功能</strong>：</p>
<ul>
<li>使用 <code>DoctranQATransformer</code> 从文档中提取关键信息</li>
<li>自动生成 3-5 个基于文档内容的问答对</li>
<li>问答对存储在文档的 <code>metadata</code> 中</li>
</ul>
<p><strong>示例代码</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_community.document_transformers <span class="hljs-keyword">import</span> DoctranQATransformer
<span class="hljs-keyword">from</span> langchain_core.documents <span class="hljs-keyword">import</span> Document

<span class="hljs-comment"># 构建转换器</span>
qa_transformer = DoctranQATransformer(openai_api_model=<span class="hljs-string">"moonshot-v1-8k"</span>)

<span class="hljs-comment"># 转换文档</span>
transformer_documents = qa_transformer.transform_documents(documents)

<span class="hljs-comment"># 获取问答对</span>
<span class="hljs-keyword">for</span> qa <span class="hljs-keyword">in</span> transformer_documents[<span class="hljs-number">0</span>].metadata.get(<span class="hljs-string">"questions_and_answers"</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"问答数据:"</span>, qa)
</code></pre>
<p><strong>使用场景</strong>：</p>
<ul>
<li>RAG 系统中增强文档检索</li>
<li>自动生成 FAQ</li>
<li>文档知识提取</li>
</ul>
<p><strong>注意事项</strong>：</p>
<ul>
<li>需要安装 doctran 库</li>
<li>依赖 Doctran 服务</li>
<li>可能存在网络连接问题</li>
</ul>
<hr/>
<h4 data-id="heading-8">2. 自定义问答转换器.py（推荐）</h4>
<p><strong>用途</strong>：使用 LangChain 原生功能实现自定义问答转换器（不依赖 Doctran）</p>
<p><strong>核心功能</strong>：</p>
<ul>
<li>使用 <code>ChatOpenAI</code> + <code>ChatPromptTemplate</code> 实现问答提取</li>
<li>支持多种 API（SiliconFlow、Moonshot、OpenAI）</li>
<li>自动根据 API_BASE 选择合适的模型</li>
<li>JSON 格式输出，易于解析</li>
<li>完善的错误处理</li>
</ul>
<p><strong>核心类结构</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomQATransformer</span>:
    <span class="hljs-string">"""自定义问答转换器，使用LLM从文档中提取问答对"""</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, openai_api_model: <span class="hljs-built_in">str</span> = <span class="hljs-string">"gpt-3.5-turbo"</span>, temperature: <span class="hljs-built_in">float</span> = <span class="hljs-number">0</span></span>)
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">transform_documents</span>(<span class="hljs-params">self, documents: <span class="hljs-built_in">list</span>[Document]</span>) -&gt; <span class="hljs-built_in">list</span>[Document]
</code></pre>
<p><strong>关键实现</strong>：</p>
<ol>
<li>提示模板设计：</li>
</ol>
<pre><code class="hljs language-python" lang="python">qa_extraction_prompt = ChatPromptTemplate.from_template(<span class="hljs-string">"""
你是一个专业的文档分析师。请从以下文档中提取3-5个最重要的问答对。

要求：
1. 的问题应该基于文档内容，能够帮助读者理解文档的核心信息
2. 答案应该简洁明了，直接来自文档内容
3. 问答对应该涵盖文档的主要话题

文档内容：
{document}

请以JSON格式返回，格式如下：
{{
    "questions_and_answers": [
        {{"question": "问题1", "answer": "答案1"}},
        {{"question": "问题2", "answer": "答案2"}}
    ]
}}
"""</span>)
</code></pre>
<ol start="2">
<li>自动模型选择逻辑：</li>
</ol>
<pre><code class="hljs language-python" lang="python">API_BASE = os.getenv(<span class="hljs-string">"OPENAI_API_BASE"</span>, <span class="hljs-string">""</span>)
<span class="hljs-keyword">if</span> <span class="hljs-string">"siliconflow"</span> <span class="hljs-keyword">in</span> API_BASE.lower():
    DEFAULT_MODEL = <span class="hljs-string">"Qwen/Qwen2.5-7B-Instruct"</span>
<span class="hljs-keyword">elif</span> <span class="hljs-string">"moonshot"</span> <span class="hljs-keyword">in</span> API_BASE.lower():
    DEFAULT_MODEL = <span class="hljs-string">"moonshot-v1-8k"</span>
<span class="hljs-keyword">else</span>:
    DEFAULT_MODEL = <span class="hljs-string">"gpt-3.5-turbo"</span>
</code></pre>
<ol start="3">
<li>JSON 解析处理：</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 处理可能包含代码标记的 JSON</span>
content = result.content.strip()
<span class="hljs-keyword">if</span> content.startswith(<span class="hljs-string">"```json"</span>):
    content = content[<span class="hljs-number">7</span>:]
<span class="hljs-keyword">if</span> content.startswith(<span class="hljs-string">"```"</span>):
    content = content[<span class="hljs-number">3</span>:]
<span class="hljs-keyword">if</span> content.endswith(<span class="hljs-string">"```"</span>):
    content = content[:-<span class="hljs-number">3</span>]
content = content.strip()
qa_data = json.loads(content)
</code></pre>
<p><strong>使用示例</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 创建转换器</span>
qa_transformer = CustomQATransformer(openai_api_model=<span class="hljs-string">"moonshot-v1-8k"</span>)

<span class="hljs-comment"># 执行转换</span>
transformer_documents = qa_transformer.transform_documents(documents)

<span class="hljs-comment"># 访问问答对</span>
<span class="hljs-keyword">for</span> qa <span class="hljs-keyword">in</span> transformer_documents[<span class="hljs-number">0</span>].metadata.get(<span class="hljs-string">"questions_and_answers"</span>, []):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"问题: <span class="hljs-subst">{qa[<span class="hljs-string">'question'</span>]}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"答案: <span class="hljs-subst">{qa[<span class="hljs-string">'answer'</span>]}</span>"</span>)
</code></pre>
<p><strong>优势</strong>：</p>
<ul>
<li>不依赖第三方 Doctran 库</li>
<li>更灵活的提示词控制</li>
<li>更好的错误处理</li>
<li>支持批量处理</li>
<li>适配多种 LLM API</li>
</ul>
<hr/>
<h4 data-id="heading-9">3. 2 翻译.py</h4>
<p><strong>用途</strong>：实现文档翻译功能，保持文档结构不变</p>
<p><strong>核心功能</strong>：</p>
<ul>
<li>使用 LLM 进行文档翻译</li>
<li>支持任意目标语言</li>
<li>保持原文格式和结构</li>
<li>返回翻译后的新文档</li>
</ul>
<p><strong>完整实现代码</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">translate_documents</span>(<span class="hljs-params">documents, target_language=<span class="hljs-string">"English"</span>, model=<span class="hljs-string">"moonshot-v1-8k"</span></span>):
    <span class="hljs-string">"""
    翻译文档内容到目标语言

    Args:
        documents: LangChain Document对象列表
        target_language: 目标语言
        model: 使用的模型名称
    """</span>
    <span class="hljs-comment"># 初始化LLM</span>
    llm = ChatOpenAI(model=model, temperature=<span class="hljs-number">0</span>)

    <span class="hljs-comment"># 创建翻译提示模板</span>
    prompt = ChatPromptTemplate.from_messages([
        (<span class="hljs-string">"system"</span>, <span class="hljs-string">"你是一个专业的翻译助手。请将以下文本翻译成{target_language}，保持原文的格式和结构。"</span>),
        (<span class="hljs-string">"human"</span>, <span class="hljs-string">"{text}"</span>)
    ])

    <span class="hljs-comment"># 创建翻译链</span>
    chain = prompt | llm

    translated_docs = []
    <span class="hljs-keyword">for</span> doc <span class="hljs-keyword">in</span> documents:
        <span class="hljs-comment"># 调用翻译</span>
        response = chain.invoke({
            <span class="hljs-string">"text"</span>: doc.page_content,
            <span class="hljs-string">"target_language"</span>: target_language
        })
        <span class="hljs-comment"># 创建新的翻译文档</span>
        translated_docs.append(Document(page_content=response.content))

    <span class="hljs-keyword">return</span> translated_docs
</code></pre>
<p><strong>使用示例</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 翻译为英文</span>
translator_documents = translate_documents(documents, target_language=<span class="hljs-string">"English"</span>)

<span class="hljs-comment"># 翻译为日文</span>
translator_documents = translate_documents(documents, target_language=<span class="hljs-string">"Japanese"</span>)

<span class="hljs-comment"># 翻译为法文</span>
translator_documents = translate_documents(documents, target_language=<span class="hljs-string">"French"</span>)
</code></pre>
<p><strong>使用场景</strong>：</p>
<ul>
<li>多语言文档处理</li>
<li>跨语言 RAG 系统</li>
<li>本地化文档生成</li>
<li>国际化支持</li>
</ul>
<hr/>
<h3 data-id="heading-10">应用场景</h3>
<h4 data-id="heading-11">1. RAG 系统增强</h4>
<p>在 RAG（检索增强生成）系统中使用问答转换器：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 原始文档</span>
documents = loader.load()

<span class="hljs-comment"># 提取问答对增强检索</span>
qa_transformer = CustomQATransformer()
enhanced_docs = qa_transformer.transform_documents(documents)

<span class="hljs-comment"># 向量化</span>
vectorstore.add_documents(enhanced_docs)

<span class="hljs-comment"># 检索时可以匹配问题，提高召回率</span>
</code></pre>
<h4 data-id="heading-12">2. 多语言知识库</h4>
<p>构建支持多语言的知识库：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 加载中文文档</span>
documents = loader.load()

<span class="hljs-comment"># 翻译为英文</span>
en_docs = translate_documents(documents, target_language=<span class="hljs-string">"English"</span>)

<span class="hljs-comment"># 合并中英文文档</span>
all_docs = documents + en_docs

<span class="hljs-comment"># 构建向量库</span>
vectorstore.add_documents(all_docs)
</code></pre>
<h4 data-id="heading-13">3. 文档预处理流水线</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.documents <span class="hljs-keyword">import</span> Document

<span class="hljs-comment"># 完整的文档处理流程</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">process_documents</span>(<span class="hljs-params">raw_documents</span>):
    <span class="hljs-comment"># 1. 提取问答对</span>
    qa_transformer = CustomQATransformer()
    docs_with_qa = qa_transformer.transform_documents(raw_documents)

    <span class="hljs-comment"># 2. 翻译为英文（可选）</span>
    en_docs = translate_documents(docs_with_qa, target_language=<span class="hljs-string">"English"</span>)

    <span class="hljs-comment"># 3. 合并所有文档</span>
    final_docs = docs_with_qa + en_docs

    <span class="hljs-keyword">return</span> final_docs
</code></pre>
<hr/>
<h3 data-id="heading-14">技术要点</h3>
<h4 data-id="heading-15">1. 文档转换器的设计模式</h4>
<p>所有文档转换器都应遵循相同的接口：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DocumentTransformer</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">transform_documents</span>(<span class="hljs-params">self, documents: <span class="hljs-built_in">list</span>[Document]</span>) -&gt; <span class="hljs-built_in">list</span>[Document]:
        <span class="hljs-string">"""转换文档列表，返回转换后的文档列表"""</span>
        <span class="hljs-keyword">pass</span>
</code></pre>
<h4 data-id="heading-16">2. Metadata 使用规范</h4>
<p>增强信息应存储在 metadata 中：</p>
<pre><code class="hljs language-python" lang="python">new_doc = Document(
    page_content=original_content,  <span class="hljs-comment"># 保持原文</span>
    metadata={
        **original_metadata,         <span class="hljs-comment"># 保留原有元数据</span>
        <span class="hljs-string">"questions_and_answers"</span>: [], <span class="hljs-comment"># 新增增强信息</span>
        <span class="hljs-string">"language"</span>: <span class="hljs-string">"en"</span>             <span class="hljs-comment"># 其他元数据</span>
    }
)
</code></pre>
<h4 data-id="heading-17">3. 错误处理策略</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">try</span>:
    <span class="hljs-comment"># 尝试解析和处理</span>
    result = process_document(doc)
<span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"处理失败: <span class="hljs-subst">{e}</span>"</span>)
    <span class="hljs-comment"># 返回原始文档，确保流程继续</span>
    <span class="hljs-keyword">return</span> doc
</code></pre>
<h4 data-id="heading-18">4. 批量处理优化</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 可以添加并发处理提高效率</span>
<span class="hljs-keyword">from</span> concurrent.futures <span class="hljs-keyword">import</span> ThreadPoolExecutor

<span class="hljs-keyword">def</span> <span class="hljs-title function_">transform_documents_parallel</span>(<span class="hljs-params">self, documents, max_workers=<span class="hljs-number">5</span></span>):
    <span class="hljs-keyword">with</span> ThreadPoolExecutor(max_workers=max_workers) <span class="hljs-keyword">as</span> executor:
        results = <span class="hljs-built_in">list</span>(executor.<span class="hljs-built_in">map</span>(self._transform_single, documents))
    <span class="hljs-keyword">return</span> results
</code></pre>
<hr/>
<h3 data-id="heading-19">依赖项</h3>
<h4 data-id="heading-20">核心依赖</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># LangChain 核心</span>
pip install langchain langchain-openai langchain-community

<span class="hljs-comment"># 环境变量管理</span>
pip install python-dotenv

<span class="hljs-comment"># 可选：Doctran（如果使用 DoctranQATransformer）</span>
pip install doctran
</code></pre>
<h4 data-id="heading-21">环境变量配置</h4>
<p>创建 <code>.env</code> 文件：</p>
<pre><code class="hljs language-env" lang="env"># OpenAI 兼容 API 配置
OPENAI_API_BASE=https://api.moonshot.cn/v1
OPENAI_API_KEY=your_api_key_here

# 或者使用 SiliconFlow
# OPENAI_API_BASE=https://api.siliconflow.cn/v1
# OPENAI_API_KEY=your_siliconflow_key
</code></pre>
<hr/>
<h3 data-id="heading-22">学习建议</h3>
<ol>
<li>理解转换器与分割器的区别</li>
<li>掌握自定义转换器的实现方法</li>
<li>学习如何在 RAG 系统中应用转换器</li>
<li>实践多语言文档处理</li>
<li>构建完整的文档处理流水线</li>
</ol>
<hr/>
<h3 data-id="heading-23">扩展阅读</h3>
<ul>
<li>LangChain 文档转换器文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpython.langchain.com%2Fdocs%2Fmodules%2Fdata_connection%2Fdocument_transformers%2F" target="_blank" title="https://python.langchain.com/docs/modules/data_connection/document_transformers/" ref="nofollow noopener noreferrer">python.langchain.com/docs/module…</a></li>
<li>RAG 系统最佳实践</li>
<li>提示工程技巧</li>
<li>JSON 解析与错误处理</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别按量付费：搭建一个无限免费的私人 TTS 服务]]></title>    <link>https://juejin.cn/post/7599572091075133482</link>    <guid>https://juejin.cn/post/7599572091075133482</guid>    <pubDate>2026-01-27T02:45:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599572091075133482" data-draft-id="7599502282603266111" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别按量付费：搭建一个无限免费的私人 TTS 服务"/> <meta itemprop="keywords" content="AIGC,OpenAI,AI编程"/> <meta itemprop="datePublished" content="2026-01-27T02:45:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一只会飞的旺旺"/> <meta itemprop="url" content="https://juejin.cn/user/1151943915355965"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别按量付费：搭建一个无限免费的私人 TTS 服务
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1151943915355965/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一只会飞的旺旺
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T02:45:48.000Z" title="Tue Jan 27 2026 02:45:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/adf43fa47df945e188599498f120eea4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5Y-q5Lya6aOe55qE5pe65pe6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770086752&amp;x-signature=ufOj8UYKtQXl%2BSRmREGwYtJqG4M%3D" alt="cover" loading="lazy"/></p>
<p>用自己的声音让 AI 读稿，我以前就有这个想法!</p>
<p>之前试过 ElevenLabs，效果确实好，但每个月 10 美元起步，用多了还得加钱。Azure 的 TTS 便宜点，但声音克隆要企业认证，个人用户压根申请不下来。开源方案倒是有，CosyVoice、FishSpeech 都不错，问题是我那台老笔记本只有 8GB 显存，跑这俩都费劲。</p>
<p>直到上周，阿里把 Qwen3-TTS 全家桶开源了。</p>
<h2 data-id="heading-0">0.6B 有多轻量？</h2>
<p><strong>0.6B 模型只需要 1.2GB 显存</strong>，没有独显的话，纯 CPU 也能跑。</p>
<p>这意味着什么？一台普通办公电脑，8GB 内存，集显，就能跑完整的语音合成模型。不用买云服务器，不用按量付费，模型下到本地，想用多少用多少。我特地用一台普通云电脑跑了下,慢是慢了点,但是能用!</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c8098e567d34df983dfbc7d7ac4a8ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5Y-q5Lya6aOe55qE5pe65pe6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770086752&amp;x-signature=e4Ge6mNlC4qJ75G1O75beKERVSs%3D" alt="image-20260126193437091" loading="lazy"/></p>
<p>Qwen3-TTS 这次开源了两个尺寸：</p>























<table><thead><tr><th>模型</th><th>参数量</th><th>显存需求</th><th>定位</th></tr></thead><tbody><tr><td>1.7B</td><td>17 亿</td><td>~3.4GB</td><td>极致音质</td></tr><tr><td><strong>0.6B</strong></td><td>6 亿</td><td><strong>~1.2GB</strong></td><td>均衡效率</td></tr></tbody></table>
<p>0.6B 虽然参数少，但该有的能力都有：10 种语言（中英日韩德法俄葡西意）、多种方言（粤语、四川话、闽南语等）、声音克隆、声音设计。对于个人用户来说，0.6B 已经够用了。</p>
<h2 data-id="heading-1">安装</h2>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FQwenLM%2FQwen3-TTS" target="_blank" title="https://github.com/QwenLM/Qwen3-TTS" ref="nofollow noopener noreferrer">github.com/QwenLM/Qwen…</a></p>
</blockquote>
<p>这块直接看官方文档吧! 或者让AI给你安装就行,留一份我的一键脚本,可以自己试试!</p>
<p>装完之后，第一次运行会自动下载模型权重，0.6B 大概 1.2GB，耐心等一下。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/usr/bin/env bash</span>
<span class="hljs-built_in">set</span> -euo pipefail


ROOT=<span class="hljs-string">"/wangwang/qwen"</span>
MODEL_ID=<span class="hljs-string">"Qwen/Qwen3-TTS-12Hz-0.6B-Base"</span>


<span class="hljs-built_in">mkdir</span> -p <span class="hljs-string">"<span class="hljs-variable">$ROOT</span>"</span>
<span class="hljs-built_in">cd</span> <span class="hljs-string">"<span class="hljs-variable">$ROOT</span>"</span>


<span class="hljs-built_in">echo</span> <span class="hljs-string">"[1/6] venv"</span>
python3 -m venv .venv
<span class="hljs-built_in">source</span> .venv/bin/activate
python -m pip install -U pip wheel setuptools


<span class="hljs-built_in">echo</span> <span class="hljs-string">"[2/6] HF mirror + cache"</span>
<span class="hljs-built_in">export</span> HF_ENDPOINT=<span class="hljs-string">"https://hf-mirror.com"</span>   <span class="hljs-comment"># huggingface 工具链会读取该变量走镜像 :contentReference[oaicite:2]{index=2}</span>
<span class="hljs-built_in">export</span> HF_HOME=<span class="hljs-string">"<span class="hljs-variable">$ROOT</span>/hf_home"</span>


<span class="hljs-built_in">echo</span> <span class="hljs-string">"[3/6] PyTorch (CPU wheel)"</span>
pip install -U torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu


<span class="hljs-built_in">echo</span> <span class="hljs-string">"[4/6] Runtime deps"</span>
pip install -U <span class="hljs-string">"qwen-tts"</span> <span class="hljs-string">"huggingface_hub[cli]"</span> soundfile requests numpy


<span class="hljs-built_in">echo</span> <span class="hljs-string">"[5/6] CPU performance knobs"</span>
<span class="hljs-comment"># 默认用最多 8 线程更稳（你可以在运行前 export THREADS=4 自定义）</span>
THREADS=<span class="hljs-string">"<span class="hljs-variable">${THREADS:-$(python - &lt;&lt;'PY'
import os
n=os.cpu_count() or 1
print(max(1, min(8, n)))
PY
)}</span>"</span>
<span class="hljs-built_in">export</span> OMP_NUM_THREADS=<span class="hljs-string">"<span class="hljs-variable">$THREADS</span>"</span>
<span class="hljs-built_in">export</span> MKL_NUM_THREADS=<span class="hljs-string">"<span class="hljs-variable">$THREADS</span>"</span>
<span class="hljs-built_in">export</span> OPENBLAS_NUM_THREADS=<span class="hljs-string">"<span class="hljs-variable">$THREADS</span>"</span>
<span class="hljs-built_in">export</span> NUMEXPR_NUM_THREADS=<span class="hljs-string">"<span class="hljs-variable">$THREADS</span>"</span>


<span class="hljs-built_in">echo</span> <span class="hljs-string">"THREADS=<span class="hljs-variable">$THREADS</span>"</span>


<span class="hljs-built_in">echo</span> <span class="hljs-string">"[6/6] Smoke test (voice clone -&gt; out/output_voice_clone.wav)"</span>
<span class="hljs-built_in">mkdir</span> -p out
python - &lt;&lt;<span class="hljs-string">'PY'</span>
import io, os, requests
import numpy as np
import torch
import soundfile as sf
from qwen_tts import Qwen3TTSModel


MODEL_ID=<span class="hljs-string">"Qwen/Qwen3-TTS-12Hz-0.6B-Base"</span>


threads = int(os.environ.get(<span class="hljs-string">"OMP_NUM_THREADS"</span>,<span class="hljs-string">"4"</span>))
torch.set_num_threads(threads)
torch.set_num_interop_threads(1)


<span class="hljs-built_in">print</span>(<span class="hljs-string">"torch:"</span>, torch.__version__)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"threads:"</span>, threads)


<span class="hljs-comment"># 下载参考音频（官方 demo 里 voice clone 需要 ref_audio，且在非 x-vector-only 时还需要 ref_text）:contentReference[oaicite:3]{index=3}</span>
ref_audio_url = <span class="hljs-string">"https://qianwen-res.oss-cn-beijing.aliyuncs.com/Qwen3-TTS-Repo/clone.wav"</span>
resp = requests.get(ref_audio_url, <span class="hljs-built_in">timeout</span>=60)
resp.raise_for_status()
wav, sr = sf.read(io.BytesIO(resp.content))
<span class="hljs-keyword">if</span> wav.ndim &gt; 1:
    wav = np.mean(wav, axis=1)
wav = wav.astype(np.float32)
ref_audio = (wav, int(sr))


<span class="hljs-comment"># 说明：如果你把 x_vector_only_mode=False，则需要提供 ref_text（HF demo 做了校验）:contentReference[oaicite:4]{index=4}</span>
ref_text = <span class="hljs-string">"Okay. Yeah. I resent you. I love you. I respect you. But you know what? You blew it! And thanks to you."</span>


tts = Qwen3TTSModel.from_pretrained(
    MODEL_ID,
    device_map=<span class="hljs-string">"cpu"</span>,
    dtype=torch.float32,
    <span class="hljs-comment"># CPU 用 eager 更稳；flash_attention_2 主要给 GPU :contentReference[oaicite:5]{index=5}</span>
    attn_implementation=<span class="hljs-string">"eager"</span>,
)


wavs, out_sr = tts.generate_voice_clone(
    text=<span class="hljs-string">"Hello! This is a CPU smoke test for Qwen3-TTS voice cloning."</span>,
    language=<span class="hljs-string">"English"</span>,
    ref_audio=ref_audio,
    ref_text=ref_text,
    x_vector_only_mode=False,  <span class="hljs-comment"># True 会更快一些，但通常更依赖参考音频质量/相似度</span>
    max_new_tokens=768,        <span class="hljs-comment"># CPU 建议先小一点，确保跑通</span>
)


sf.write(<span class="hljs-string">"out/output_voice_clone.wav"</span>, wavs[0], out_sr)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"Saved -&gt; out/output_voice_clone.wav | sr:"</span>, out_sr, <span class="hljs-string">"| sec:"</span>, len(wavs[0])/out_sr)
PY


<span class="hljs-built_in">echo</span> <span class="hljs-string">"DONE: <span class="hljs-variable">$ROOT</span>/out/output_voice_clone.wav"</span>
</code></pre>
<h2 data-id="heading-2">声音克隆：3 秒音频就够</h2>
<p>这是 Qwen3-TTS 最让我意外的功能。只需要一段 3-10 秒的音频，模型就能学会这个人的音色、语调、说话节奏，然后用这个声音读任何你给的文本。</p>
<p>代码也不复杂：</p>
<pre><code class="hljs language-ini" lang="ini">import torch
import soundfile as sf
from qwen_tts import Qwen3TTSModel


<span class="hljs-comment"># 加载 0.6B 模型</span>
<span class="hljs-attr">model</span> = Qwen3TTSModel.from_pretrained(
    "Qwen/Qwen3-TTS-12Hz-0.6B-Base",
    <span class="hljs-attr">device_map</span>=<span class="hljs-string">"cuda:0"</span>,  <span class="hljs-comment"># 没有显卡就用 "cpu"</span>
    <span class="hljs-attr">dtype</span>=torch.float16,
)


<span class="hljs-comment"># 克隆声音</span>
wavs, <span class="hljs-attr">sr</span> = model.generate_voice_clone(
    <span class="hljs-attr">text</span>=<span class="hljs-string">"今天天气不错，适合出去走走。"</span>,
    <span class="hljs-attr">language</span>=<span class="hljs-string">"Chinese"</span>,
    <span class="hljs-attr">ref_audio</span>=<span class="hljs-string">"my_voice.wav"</span>,      <span class="hljs-comment"># 你的参考音频</span>
    <span class="hljs-attr">ref_text</span>=<span class="hljs-string">"这是参考音频的文字内容。"</span>,  <span class="hljs-comment"># 参考音频说了什么</span>
)


sf.write("output.wav", wavs<span class="hljs-section">[0]</span>, sr)
</code></pre>
<p>我拿自己录的一段 5 秒音频试了试，效果出乎意料。音色还原度很高，连我说话时习惯性的尾音拖长都学到了。想效果更好的话可以换 1.7B，代价是显存占用翻倍。</p>
<p>有个坑：<code>ref_text</code> 参数是必须的，你得告诉模型参考音频里说了什么。懒得写的话可以开 <code>x_vector_only_mode</code>，只用音色特征不看文本，但音质会打折扣。</p>
<h2 data-id="heading-3">封装成 Claude Code Skill</h2>
<p>上面说的都是官方玩法，接下来是我自己折腾出来的骚操作。</p>
<p>既然 Qwen3-TTS 可以本地运行，那能不能封装成一个服务，随时调用？更进一步，能不能做成 Claude Code 的 Skill，让 AI 助手直接帮我把文字转成语音？</p>
<p>答案是可以的。而且一旦配好，就相当于有了一个<strong>无限免费的私人 TTS 服务</strong>。</p>
<h3 data-id="heading-4">为什么要这么做？</h3>
<p>每次用 TTS 都要手动跑 Python 脚本，麻烦。封装成 Skill 之后，直接在 Claude Code 里敲 <code>/qwen-tts 今天天气不错</code>，AI 就能帮你生成语音文件。写文章的时候想听听读起来顺不顺口？一句命令搞定。有需要的用户可以留言,我可以将自己的分享到github上!</p>
<blockquote>
<p>地址来啦: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwangwangit%2Fqwen3-tts" target="_blank" title="https://github.com/wangwangit/qwen3-tts" ref="nofollow noopener noreferrer">github.com/wangwangit/…</a></p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6489d424813b4738b4ccf6383b208498~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5Y-q5Lya6aOe55qE5pe65pe6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770086752&amp;x-signature=qA2HWgk4I0WYdCD87N%2F4VUmcNtA%3D" alt="image-20260126193850005" loading="lazy"/></p>
<p>然后修改 Skill，让它调用这个 API 而不是每次都加载模型。这样响应速度能从十几秒缩短到一两秒。</p>
<h2 data-id="heading-5">适合什么人用？</h2>
<ul>
<li><strong>内容创作者</strong>：写公众号、做视频，需要配音但不想花钱</li>
<li><strong>开发者</strong>：想在自己的应用里加入语音功能，不想被 API 账单吓到</li>
<li><strong>折腾党</strong>：就是想在本地跑个 AI 玩玩，不需要理由</li>
</ul>
<p>如果你追求极致音质，愿意等更长的生成时间，可以换成 1.7B 模型。如果你的电脑配置一般，或者更看重响应速度，0.6B 是更实际的选择。</p>
<h2 data-id="heading-6">最后</h2>
<p>阿里这次开源的 Qwen3-TTS，给了我一点惊喜。0.6B 这个尺寸，在保持可用性的前提下，把硬件门槛拉到了普通用户能接受的水平。声音克隆不再是云端大厂的专利，一台普通电脑就能玩。</p>
<p>更重要的是，它是 Apache 2.0 协议，商用也没问题。</p>
<p>GitHub 地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FQwenLM%2FQwen3-TTS" target="_blank" title="https://github.com/QwenLM/Qwen3-TTS" ref="nofollow noopener noreferrer">github.com/QwenLM/Qwen…</a></p>
<p>Hugging Face 在线体验：<a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fspaces%2FQwen%2FQwen3-TTS" target="_blank" title="https://huggingface.co/spaces/Qwen/Qwen3-TTS" ref="nofollow noopener noreferrer">huggingface.co/spaces/Qwen…</a></p>
<p>有兴趣的话，去试试用自己的声音做一个 AI 分身。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2fb8390d8faf44ac9fdc7dbdc540b06f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5Y-q5Lya6aOe55qE5pe65pe6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770086752&amp;x-signature=hSTgTmOfFn7NFiA9msg8MYfnlu0%3D" alt="image-20260126194126468" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[解锁昇腾算力：自定义训练循环与图模式加速指南]]></title>    <link>https://juejin.cn/post/7599580550296567843</link>    <guid>https://juejin.cn/post/7599580550296567843</guid>    <pubDate>2026-01-27T02:51:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599580550296567843" data-draft-id="7599600549764431907" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="解锁昇腾算力：自定义训练循环与图模式加速指南"/> <meta itemprop="keywords" content="后端,算法"/> <meta itemprop="datePublished" content="2026-01-27T02:51:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户867573478982"/> <meta itemprop="url" content="https://juejin.cn/user/924064924829272"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            解锁昇腾算力：自定义训练循环与图模式加速指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/924064924829272/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户867573478982
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T02:51:15.000Z" title="Tue Jan 27 2026 02:51:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<h3 data-id="heading-0">前言</h3>
<p>在深度学习的科研与工程落地中，我们既需要PyTorch式的灵活性（动态图调试），又渴望TensorFlow式的极致性能（静态图部署）。MindSpore作为全场景AI框架，通过PyNative模式和Graph模式的无缝切换解决了这一痛点。</p>
<p>但在实际开发中，很多从其他框架转来的开发者在使用MindSpore进行自定义训练循环（Custom Training Loop）时，往往因为没有正确利用JIT编译和函数式变换，导致无法完全释放昇腾NPU的算力。</p>
<p>本文将摒弃繁琐的理论，直接通过代码实战，带你构建一个高效、可微分、运行在Graph模式下的自定义训练流程。</p>
<h3 data-id="heading-1">核心概念：为何需要 value_and_grad和 @jit</h3>
<p>在MindSpore中，自动微分采用的是基于源码转换（Source Code Transformation, SCT）的机制。与PyTorch的<code>.backward()</code>累积梯度不同，MindSpore更推崇函数式编程。</p>
<ol>
<li>**<code>ops.value_and_grad</code>**：同时计算正向网络的输出（Loss）和关于权重的梯度。这是编写自定义训练步的核心。</li>
<li>**<code>@jit</code>(原 <code>@ms_function</code>)**：这是性能的关键。它将Python函数编译成静态计算图，并下沉到Ascend芯片上运行，大幅减少Host-Device交互开销。</li>
</ol>
<h3 data-id="heading-2">实战演练：构建高效训练步</h3>
<p>假设我们已经定义好了一个简单的网络（Net）和数据集（Dataset）。我们将重点放在如何手写一个高性能的训练步骤（Train Step）。</p>
<h4 data-id="heading-3">1. 环境准备与基础定义</h4>
<p>首先，确保上下文环境指向Ascend，并定义好网络与损失函数。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> mindspore <span class="hljs-keyword">as</span> ms
<span class="hljs-keyword">from</span> mindspore <span class="hljs-keyword">import</span> nn, ops, Tensor
<span class="hljs-keyword">from</span> mindspore <span class="hljs-keyword">import</span> dtype <span class="hljs-keyword">as</span> mstype

<span class="hljs-comment"># 设置运行环境为昇腾NPU，模式为PyNative以便于调试，最后我们会通过装饰器加速</span>
ms.set_context(mode=ms.PYNATIVE_MODE, device_target=<span class="hljs-string">"Ascend"</span>)

<span class="hljs-comment"># 模拟一个简单的线性网络</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleNet</span>(nn.Cell):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-built_in">super</span>(SimpleNet, self).__init__()
        self.fc = nn.Dense(<span class="hljs-number">10</span>, <span class="hljs-number">1</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">construct</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-keyword">return</span> self.fc(x)

<span class="hljs-comment"># 初始化</span>
net = SimpleNet()
loss_fn = nn.MSELoss()
optimizer = nn.Momentum(net.trainable_params(), learning_rate=<span class="hljs-number">0.01</span>, momentum=<span class="hljs-number">0.9</span>)
</code></pre>
<p><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/></p>
<h4 data-id="heading-4">2. 定义前向计算函数</h4>
<p>在MindSpore的函数式微分中，我们需要定义一个纯粹的前向计算函数，该函数输入数据和标签，输出Loss。</p>
<pre><code class="hljs language-ini" lang="ini">def forward_fn(data, label):
    <span class="hljs-comment"># 前向计算</span>
    <span class="hljs-attr">logits</span> = net(data)
    <span class="hljs-comment"># 计算损失</span>
    <span class="hljs-attr">loss</span> = loss_fn(logits, label)
    return loss, logits
</code></pre>
<p><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/></p>
<h4 data-id="heading-5">3. 获取梯度计算函数</h4>
<p>这是最关键的一步。我们使用 <code>ops.value_and_grad</code>来生成一个可以计算梯度的函数。</p>
<ul>
<li>
<p><code>fn</code>: 指定前向函数。</p>
</li>
<li>
<p><code>grad_position</code>: 指定对哪些输入求导（这里设为None，因为我们只对权重求导）。</p>
</li>
<li>
<p><code>weights</code>: 指定需要更新的权重参数（即网络的 <code>trainable_params</code>）。</p>
</li>
<li>
<p><code>has_aux</code>: 如果 <code>forward_fn</code>返回除loss外的其他输出（如上面的logits），需设为True。</p>
<h2 data-id="heading-6">定义梯度变换函数</h2>
<p>grad_fn = ops.value_and_grad(forward_fn, None, optimizer.parameters, has_aux=True)</p>
</li>
</ul>
<p><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/></p>
<h4 data-id="heading-7">4. 封装训练步并开启图模式加速</h4>
<p>现在，我们将前向计算、梯度计算、优化器更新封装在一个函数中。为了在Ascend NPU上获得最佳性能，我们必须在该函数上添加 <code>@jit</code>装饰器。</p>
<p>这个装饰器会触发MindSpore的编译器，将Python代码编译成可以在CANN层高效执行的静态图。</p>
<pre><code class="hljs language-ini" lang="ini">@ms.jit  <span class="hljs-comment"># &lt;--- 核心：开启图模式加速，算子下沉</span>
def train_step(data, label):
    <span class="hljs-comment"># 1. 计算Loss和梯度</span>
    (loss, _), <span class="hljs-attr">grads</span> = grad_fn(data, label)
  
    <span class="hljs-comment"># 2. 优化器更新权重</span>
    <span class="hljs-comment"># 注意：在函数式编程中，优化器通常作为算子使用</span>
    <span class="hljs-attr">loss</span> = ops.depend(loss, optimizer(grads))
  
    return loss
</code></pre>
<p><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/></p>
<blockquote>
<p>技术TIPS：<code>ops.depend</code>是一个控制依赖关系的算子。它保证了在返回 <code>loss</code>之前，<code>optimizer(grads)</code>这一步操作一定已经被执行。这在静态图优化中非常重要，防止编译器因为“输出不依赖于更新操作”而将更新步骤优化掉。</p>
</blockquote>
<h4 data-id="heading-8">5. 完整的训练循环</h4>
<p>最后，我们模拟数据输入，运行训练循环。</p>
<pre><code class="hljs language-scss" lang="scss">import numpy as np

# 模拟数据
def <span class="hljs-built_in">get_batch_data</span>():
    x = <span class="hljs-built_in">Tensor</span>(np.random.<span class="hljs-built_in">randn</span>(<span class="hljs-number">32</span>, <span class="hljs-number">10</span>).<span class="hljs-built_in">astype</span>(np.float32))
    y = <span class="hljs-built_in">Tensor</span>(np.random.<span class="hljs-built_in">randn</span>(<span class="hljs-number">32</span>, <span class="hljs-number">1</span>).<span class="hljs-built_in">astype</span>(np.float32))
    return x, y

# 开始训练
epochs = <span class="hljs-number">5</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"Start training on Ascend..."</span>)

for epoch in <span class="hljs-built_in">range</span>(epochs):
    x, y = <span class="hljs-built_in">get_batch_data</span>()
  
    # 执行编译后的静态图训练步
    loss = <span class="hljs-built_in">train_step</span>(x, y)
  
    <span class="hljs-built_in">print</span>(f<span class="hljs-string">"Epoch: {epoch+1}, Loss: {loss.asnumpy()}"</span>)
</code></pre>
<p><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/></p>
<h3 data-id="heading-9">进阶：静态图模式下的避坑指南</h3>
<p>虽然 <code>@jit</code>能带来巨大的性能提升，但它对Python语法的支持是有一定限制的（因为它需要将Python转译为中间表达IR）。在昇腾上开发时，请注意以下几点：</p>
<ol>
<li>避免使用第三方库的随机函数：在 <code>@jit</code>修饰的函数内部，尽量使用 <code>mindspore.ops</code>中的算子，避免使用 <code>numpy</code>或 <code>random</code>等库的操作，因为这些操作无法被编译进图，会导致回退到Host端执行，阻断流水线。</li>
<li>控制流的限制：虽然MindSpore支持控制流，但过于复杂的动态条件判断（依赖于Tensor值的if/else）可能会导致图编译变慢。尽量将逻辑向量化。</li>
<li>打印调试：在图模式下，直接 <code>print(tensor)</code>可能无法按预期打印每一步的值。如果需要调试，可以使用 <code>ops.Print()</code>算子。</li>
<li>Side Effects（副作用）：如果你的函数修改了全局变量或列表，这种副作用在图编译中可能不会生效。请坚持函数式的写法：输入 -&gt; 计算 -&gt; 返回。</li>
</ol>
<h3 data-id="heading-10">总结</h3>
<p>在昇腾社区进行MindSpore开发时，掌握 <code>ops.value_and_grad</code>配合 <code>@jit</code>是从入门走向进阶的分水岭。</p>
<ul>
<li>PyNative模式：适合调试网络结构、验证逻辑。</li>
<li>Graph模式（<code>@jit</code>）：适合生产环境、大规模训练，能充分利用Ascend 910/310的异构计算能力。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ClawdBot傻瓜式使用方法:手把手教你部署7×24替你用电脑干活的ClawdBot]]></title>    <link>https://juejin.cn/post/7599483314161860627</link>    <guid>https://juejin.cn/post/7599483314161860627</guid>    <pubDate>2026-01-27T02:20:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599483314161860627" data-draft-id="7599502282603053119" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ClawdBot傻瓜式使用方法:手把手教你部署7×24替你用电脑干活的ClawdBot"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2026-01-27T02:20:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="爱吃的小肥羊"/> <meta itemprop="url" content="https://juejin.cn/user/2637045249608064"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ClawdBot傻瓜式使用方法:手把手教你部署7×24替你用电脑干活的ClawdBot
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2637045249608064/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    爱吃的小肥羊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T02:20:28.000Z" title="Tue Jan 27 2026 02:20:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在刚刚过去的这个周末，整个社交媒体都被ClawdBot刷屏了，像病毒一样疯狂传播开来，铺天盖地！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d30e14a8e3d54d939cc1f4cb1b406ea1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD55qE5bCP6IKl576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770085231&amp;x-signature=uctYFOsfgjEJrSOGKegoqn2AsuI%3D" alt="" loading="lazy"/></p>
<p>从Reddit到Twitter，从Discord的tech社群到微博的AI话题，全是关于它的讨论，有人说用上它就像有了"可长期持续运行的AI助手"。</p>
<p>Creator Buddy创始人兼CEO Alex Finn也盛赞道：这就是Claude 希望 Claude Cowork 呈现的样子。</p>
<p>网红产品见过不少，但这一次或许真的不同。</p>
<p>有硅谷博主称其为，<strong>迄今为止最伟大的 AI 应用。</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02afc48f47e74188b62b0df260cd93ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD55qE5bCP6IKl576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770085231&amp;x-signature=xW6ryOeAUCATvL6HnZKR3tmnN40%3D" alt="" loading="lazy"/></p>
<p><strong>很多人看了很多文章和视频，还是搞不懂Clawdbot是什么？这里给大家简单介绍一下。</strong></p>
<p>它本质上是一个运行在你自己的电脑或服务器上的个人人工智能助手，你可以用它与即时通讯应用进行通信，处理各种任务。</p>
<p>我们平时用的ChatGPT或Claude，哪怕再聪明，也只能给你出主意，没法替你干活。</p>
<p>但Clawdbot不一样，<strong>它是一个运行在你本地电脑上的AI Agent（智能体），能帮你实现真正意义上的干活。</strong></p>
<p>给大家举几个例子就明白了。</p>
<p>有网友让ClawdBot定期提醒他，还自动发布推特内容。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4aed7504624944be95eb151dc02ac5ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD55qE5bCP6IKl576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770085231&amp;x-signature=o5qz0eNY3%2BEpQ9W57eEDzPyd%2Fn0%3D" alt="" loading="lazy"/></p>
<p>还有一位大佬使用Clawbot做各种各样的功能，比如查看邮箱并删除垃圾邮箱，订购东西等等。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9592581d228f40fb8bbfc6df42e654dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD55qE5bCP6IKl576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770085231&amp;x-signature=buVEsII%2BXoEnPdZquGhYGaWDyVU%3D" alt="" loading="lazy"/></p>
<p>甚至还有人大胆地用ClawdBot进行炒股操作，完全是把它当成一个不知疲倦的助手。</p>
<p>这些场景能实现，靠的就是ClawdBot的这几个核心能力：</p>
<ul>
<li><strong>接管电脑：</strong> 整理文件、发邮件、写代码、修Bug、跑脚本、甚至监控网页价格，它都能直接上手操作。</li>
<li><strong>全平台操控：</strong> 可以控制 WhatsApp、Telegram 甚至 iMessage 发个指令，家里的电脑就开始干活了。</li>
<li><strong>永久记忆：</strong> 无论是多久的记忆，它都能记住。</li>
<li><strong>自我进化：</strong> 丢给它一个新的API文档，它能自己写代码学会新技能，或者直接写Skill。</li>
<li><strong>拥有完整的系统访问权限：</strong> 可以执行终端命令、编写脚本、安装技能</li>
<li><strong>支持任意模型：</strong> 可使用任何 LLM 提供商（Claude、GPT、Gemini、DeepSeek、Perplexity）</li>
</ul>
<p>那要如何使用这个现象级的产品呢？</p>
<p>首先，进入Clawdbot的官网。</p>
<p>传送门：<a href="https://link.juejin.cn?target=https%3A%2F%2Fclawd.bot%2F" target="_blank" title="https://clawd.bot/" ref="nofollow noopener noreferrer">clawd.bot/</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/04002bd2b52840e4ab4822257ecf4e9e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD55qE5bCP6IKl576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770085231&amp;x-signature=D7gmwLN7zvfIUk3m482DzuJ1pic%3D" alt="" loading="lazy"/></p>
<p>里面有需要的安装命令行，这里以苹果电脑为例。</p>
<p>然后，打开你的终端（Terminal），输入以下命令把项目克隆下来，</p>
<p>脚本会自动处理大部分事情，你只需要跟着提示走就行。</p>
<pre><code class="hljs language-arduino" lang="arduino">
curl -fsSL https:<span class="hljs-comment">//clawd.bot/install.sh | bash</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd9cb5e950ca42228c3c74596284ff1d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD55qE5bCP6IKl576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770085231&amp;x-signature=6ELVITfUBcX0Jguq7VGdumDgCDw%3D" alt="" loading="lazy"/></p>
<p>安装完成后，会让你选择用哪个模型。是Claude、GPT还是其他的？根据你的需求选就行。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc52c14432724f44bd8cf93708d15597~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD55qE5bCP6IKl576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770085231&amp;x-signature=2bpClsdyLG4Xva0DaSmXQkuooZU%3D" alt="" loading="lazy"/></p>
<p>选择好模型后，会让你填入你的API Key，因为它适配任何模型，所以你只需要去申请一个API Key就行。</p>
<p>看我文章的朋友都知道，我经常使用0011.ai，这是个CC和Codex的中转，这里就不详细给大家介绍了，感兴趣的可以看我之前的文章。</p>
<p>传送门：<a href="https://link.juejin.cn?target=https%3A%2F%2F0011.ai%2Fi%2FAIG" target="_blank" title="https://0011.ai/i/AIG" ref="nofollow noopener noreferrer">0011.ai/i/AIG</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1992313721415046720" target="_blank" title="https://zhuanlan.zhihu.com/p/1992313721415046720" ref="nofollow noopener noreferrer">手把手教你在国内使用 Claude Code：不封号、不折腾、比官网更便宜</a><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe8a27664bb24e63b0d950d9836c983c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD55qE5bCP6IKl576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770085231&amp;x-signature=Ct2uqHy5xRP65Ih%2FCx3F1hWtVsI%3D" alt="" loading="lazy"/></p>
<p>这边我们将我们的API key直接贴进去。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/402a2a27928e45f984c1a86598c351b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD55qE5bCP6IKl576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770085231&amp;x-signature=s%2B91D0IkZRKANW9b3ybPWVo8P9U%3D" alt="" loading="lazy"/></p>
<p><strong>再连接聊天软件，</strong> 这是Clawdbot的灵魂！你需要配置 <strong>Gateway，也可以选择通过。</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ec4ae9a8f434b489350aaaee7ed8c65~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD55qE5bCP6IKl576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770085231&amp;x-signature=%2B1R%2BftD5hhEN0C4wp%2Bifm0qvA6Y%3D" alt="" loading="lazy"/></p>
<p>在配置文件中，填入你的Telegram Bot Token或者Twilio（用于WhatsApp）的凭证，这样你才能在手机上远程指挥它。</p>
<p>随后会让你选择Skills，比如"每天早上7点自动拉取新闻"或"监控某个网站价格"。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ae8467b0b5148da905d9fd59e6fb601~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD55qE5bCP6IKl576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770085231&amp;x-signature=vLsRS2Odv2ToxiPpda4HaKEFNt4%3D" alt="" loading="lazy"/></p>
<p>这一步是选择聊天方式，如果你是小白，建议选择第二个。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/11196790a7e140eda073b34ac8895e82~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD55qE5bCP6IKl576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770085231&amp;x-signature=PRSCg75DcWt8PPiuESUjEvWfbFM%3D" alt="" loading="lazy"/></p>
<p>最后，你就可以在这里和你的Bot聊天啦！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da32ff82bb45482ca0700b5686b57a5b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD55qE5bCP6IKl576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770085231&amp;x-signature=WP6erFzKuBR4K94Svai%2FBjlDdZI%3D" alt="" loading="lazy"/></p>
<p>这里有一个大家普遍都会担心的问题，就是Token消耗嘎嘎快，ClawdBot要一直运行、主动思考、保持对话历史。</p>
<p><strong>所以比普通chatbot费token很多</strong>，<strong>也就是说很费钱，</strong> 如果担心成本，可以在配置里调整刷新频率，或改用便宜点的模型。</p>
<p>另外一个担忧是数据安全。</p>
<p>前美国安全专家Chad Nelson称， Clawdbot读取的每一份文档、电子邮件和网页都可能成为攻击媒介，“这类工具的广泛应用，将彻底损害个人隐私与安全”。</p>
<p>SEO创企Letsrank创始人fmd 认为，“ <strong>Clawdbot正在引发一场灾难</strong>”。若在VPS实例上托管Clawdbot的趋势持续，加上人们不看文档、无认证开放端口，很快就会出现大规模凭证泄露，“后果不堪设想”。</p>
<p>欢迎在评论区一起讨论！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用 Claude Code 撰写技术文档并配图的基础教程]]></title>    <link>https://juejin.cn/post/7599496293174886419</link>    <guid>https://juejin.cn/post/7599496293174886419</guid>    <pubDate>2026-01-26T16:07:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599496293174886419" data-draft-id="7599511763987595318" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用 Claude Code 撰写技术文档并配图的基础教程"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-26T16:07:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="白小纯2025"/> <meta itemprop="url" content="https://juejin.cn/user/3861943706468039"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用 Claude Code 撰写技术文档并配图的基础教程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3861943706468039/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    白小纯2025
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T16:07:15.000Z" title="Mon Jan 26 2026 16:07:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">使用 Claude Code 撰写技术文档并配图的基础教程</h2>
<ul>
<li>前置学习教程<a href="https://juejin.cn/post/7596687697756127242" target="_blank" title="https://juejin.cn/post/7596687697756127242">cladue code</a></li>
<li>前置学习教程<a href="https://juejin.cn/post/7599531732337262626" target="_blank" title="https://juejin.cn/post/7599531732337262626">agent skills</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FJimLiu%2Fbaoyu-skills.git" target="_blank" title="https://github.com/JimLiu/baoyu-skills.git" ref="nofollow noopener noreferrer">skills工具链接</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FJimLiu%2Fbaoyu-skills%2Fblob%2Fmain%2FREADME.zh.md" target="_blank" title="https://github.com/JimLiu/baoyu-skills/blob/main/README.zh.md" ref="nofollow noopener noreferrer">安装教程</a></li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a928f2645a6841fbba3924fa1a1b884a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m95bCP57qvMjAyNQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770049949&amp;x-signature=1hy7hq9x7k%2Fv19ng9KyclQ092A4%3D" alt="01-scene-cover.png" loading="lazy"/></p>
<blockquote>
<p>本教程面向熟悉命令行和基本开发工具的开发者，介绍如何利用 Claude Code 高效撰写技术文档，并使用 <code>baoyu-article-illustrator</code> 技能为文章智能配图。</p>
</blockquote>
<h3 data-id="heading-1">前置准备</h3>
<p>确保你已经：</p>
<ul>
<li>安装并配置好 Claude Code CLI</li>
<li>拥有可用的 API 密钥</li>
<li>具备以下技能：
<ul>
<li><code>baoyu-article-illustrator</code>（文章配图技能）</li>
<li><code>baoyu-image-gen</code>（底层图片生成能力，被 article-illustrator 调用）</li>
</ul>
</li>
</ul>
<h3 data-id="heading-2">工具链关系</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b259aa0e23c48af9d4e42b011411ee1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m95bCP57qvMjAyNQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770049949&amp;x-signature=2yVUk21QGsHcD1buQjPttCwG%2F%2BE%3D" alt="02-framework-toolchain.png" loading="lazy"/></p>
<ul>
<li><strong>baoyu-article-illustrator</strong>：分析文章结构，识别需要配图的位置，决定图片类型和风格</li>
<li><strong>baoyu-image-gen</strong>：执行实际的图片生成任务</li>
</ul>
<h3 data-id="heading-3">第一部分：用 Claude Code 写技术文档</h3>
<h4 data-id="heading-4">1.1 基本工作流程</h4>
<p>Claude Code 写文档的核心优势在于它能够：</p>
<ul>
<li>直接读取代码库理解上下文</li>
<li>根据代码自动生成准确的文档</li>
<li>保持文档与代码的一致性</li>
</ul>
<p><strong>启动方式：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 在项目目录中启动 Claude Code</span>
<span class="hljs-built_in">cd</span> your-project
claude
</code></pre>
<h4 data-id="heading-5">1.2 常用文档撰写命令示例</h4>
<h5 data-id="heading-6">为代码生成文档</h5>
<pre><code class="hljs language-bash" lang="bash">请为 src/utils/auth.ts 文件生成 API 文档
</code></pre>
<h5 data-id="heading-7">创建项目 README</h5>
<pre><code class="hljs language-diff" lang="diff">分析当前项目结构，帮我撰写一份 README.md，包含：
<span class="hljs-deletion">- 项目简介</span>
<span class="hljs-deletion">- 安装步骤</span>
<span class="hljs-deletion">- 使用示例</span>
<span class="hljs-deletion">- 配置说明</span>
</code></pre>
<h5 data-id="heading-8">撰写教程类文档</h5>
<pre><code class="hljs language-css" lang="css">帮我写一篇关于 <span class="hljs-selector-attr">[主题]</span> 的技术教程，目标读者是 <span class="hljs-selector-attr">[描述]</span>，
重点讲解 <span class="hljs-selector-attr">[要点1]</span>、<span class="hljs-selector-attr">[要点2]</span>、<span class="hljs-selector-attr">[要点3]</span>
</code></pre>
<h4 data-id="heading-9">1.3 提升文档质量的技巧</h4>

























<table><thead><tr><th>技巧</th><th>说明</th></tr></thead><tbody><tr><td>提供上下文</td><td>告诉 Claude 目标读者是谁、技术水平如何</td></tr><tr><td>明确结构</td><td>预先说明你希望的文档结构（章节、格式）</td></tr><tr><td>迭代修改</td><td>生成后可以针对具体段落要求修改</td></tr><tr><td>结合代码</td><td>让 Claude 先读取相关代码再写文档</td></tr></tbody></table>
<h3 data-id="heading-10">第二部分：使用 baoyu-article-illustrator 智能配图</h3>
<h4 data-id="heading-11">2.1 技能简介</h4>
<p><code>baoyu-article-illustrator</code> 是一个智能文章配图技能，核心能力：</p>
<ul>
<li><strong>自动分析文章结构</strong>：识别标题、段落、关键概念</li>
<li><strong>智能识别配图位置</strong>：判断哪些地方需要视觉辅助</li>
<li><strong>Type × Style 二维配图法</strong>：根据内容类型和期望风格生成最合适的图片</li>
<li><strong>调用底层 baoyu-image-gen</strong>：实际图片生成由底层能力完成</li>
</ul>
<h4 data-id="heading-12">2.2 基本使用方法</h4>
<h5 data-id="heading-13">方式一：一键为文章配图（推荐）</h5>
<pre><code class="hljs language-bash" lang="bash">/baoyu-article-illustrator
</code></pre>
<p>或者用自然语言：</p>
<pre><code class="hljs language-css" lang="css">为文章配图
请给这篇文章添加插图
illustrate <span class="hljs-selector-tag">article</span>
</code></pre>
<h5 data-id="heading-14">方式二：指定文章路径</h5>
<pre><code class="hljs language-css" lang="css">/baoyu-<span class="hljs-selector-tag">article</span>-illustrator path/<span class="hljs-selector-tag">to</span>/your-<span class="hljs-selector-tag">article</span><span class="hljs-selector-class">.md</span>
</code></pre>
<h4 data-id="heading-15">2.3 Type × Style 二维配图法</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca7dcdbf01df45738e55679bd7a619e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m95bCP57qvMjAyNQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770049949&amp;x-signature=jHOBJhgudXV%2FOxHNKsI1wSMKFFs%3D" alt="03-framework-type-style.png" loading="lazy"/></p>
<p>这是 <code>baoyu-article-illustrator</code> 的核心方法论：</p>




















<table><thead><tr><th>维度</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><strong>Type（类型）</strong></td><td>图片要表达什么</td><td>概念图、流程图、场景图、对比图</td></tr><tr><td><strong>Style（风格）</strong></td><td>视觉呈现方式</td><td>扁平插画、3D渲染、手绘风、科技感</td></tr></tbody></table>
<p><strong>组合示例（以本教程为例）：</strong></p>





























<table><thead><tr><th>文章内容</th><th>Type</th><th>Style</th><th>配图效果</th></tr></thead><tbody><tr><td>工具链关系</td><td>架构图</td><td>扁平插画</td><td>展示两个工具的调用关系</td></tr><tr><td>Type × Style 方法</td><td>概念图</td><td>信息图表</td><td>二维矩阵示意图</td></tr><tr><td>完整工作流</td><td>流程图</td><td>科技感</td><td>写作→配图→迭代的流程</td></tr></tbody></table>
<h4 data-id="heading-16">2.4 文档配图的完整工作流（以本教程为例）</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3453261ba2643f4932ec08dd945650d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m95bCP57qvMjAyNQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770049949&amp;x-signature=Id4xoHVcsMgBqBudmpsA1F%2F%2F7vc%3D" alt="04-flowchart-workflow.png" loading="lazy"/></p>
<pre><code class="hljs language-makefile" lang="makefile">步骤 1: 撰写文档
────────────────────
<span class="hljs-section">你: 帮我写一篇用 Claude Code 写技术文档并配图的基础教程，</span>
    面向有基础的开发者

<span class="hljs-section">Claude: [生成本教程内容...]</span>

步骤 2: 智能配图（一条命令搞定）
────────────────────
<span class="hljs-section">你: /baoyu-article-illustrator</span>

<span class="hljs-section">Claude:</span>
  - 分析文章结构...
  - 识别到 4 处适合配图的位置：
    1. 开头：需要一张封面图（程序员与 AI 协作写作场景）
    2. <span class="hljs-string">"工具链关系"</span>：需要架构示意图
    3. <span class="hljs-string">"Type × Style 二维配图法"</span>：需要概念解释图
    4. <span class="hljs-string">"完整工作流"</span>：需要流程图
  - 调用 baoyu-image-gen 生成图片...
  - 将图片插入文档对应位置

步骤 3: 微调（可选）
────────────────────
<span class="hljs-section">你: 封面图换成更有科技感的风格</span>

<span class="hljs-section">Claude: [重新生成并替换...]</span>
</code></pre>
<h3 data-id="heading-17">第三部分：实战示例（以本教程为例）</h3>
<h4 data-id="heading-18">3.1 完整对话示例</h4>
<p>以下是创作本教程的实际对话流程：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">你:</span> <span class="hljs-string">帮我写一篇用</span> <span class="hljs-string">Claude</span> <span class="hljs-string">Code</span> <span class="hljs-string">写技术文档，然后使用</span> <span class="hljs-string">baoyu-article-illustrator</span>
    <span class="hljs-string">给文章配图的基础教程，面向有基础的开发者</span>

<span class="hljs-attr">Claude:</span> <span class="hljs-string">在开始写这篇教程之前，我想先确认几个问题...</span>
        [<span class="hljs-string">询问目标读者、输出形式等</span>]

<span class="hljs-string">你:</span> <span class="hljs-string">有基础的开发者，创建</span> <span class="hljs-string">Markdown</span> <span class="hljs-string">文件</span>

<span class="hljs-attr">Claude:</span> [<span class="hljs-string">生成教程内容，创建</span> <span class="hljs-string">claude-code-writing-tutorial.md</span>]

<span class="hljs-string">你:</span> <span class="hljs-string">/baoyu-article-illustrator</span>

<span class="hljs-attr">Claude:</span>
  <span class="hljs-string">分析文章结构完成，识别到以下配图位置：</span>

  <span class="hljs-number">1</span><span class="hljs-string">.</span> <span class="hljs-string">文章封面</span> <span class="hljs-bullet">-</span> <span class="hljs-attr">Type:</span> <span class="hljs-string">主题图</span> <span class="hljs-string">|</span> <span class="hljs-attr">Style:</span> <span class="hljs-string">科技感</span>
     <span class="hljs-string">描述：程序员在终端与</span> <span class="hljs-string">AI</span> <span class="hljs-string">协作撰写文档的场景</span>

  <span class="hljs-number">2</span><span class="hljs-string">.</span> <span class="hljs-string">"工具链关系"</span> <span class="hljs-bullet">-</span> <span class="hljs-attr">Type:</span> <span class="hljs-string">架构图</span> <span class="hljs-string">|</span> <span class="hljs-attr">Style:</span> <span class="hljs-string">扁平插画</span>
     <span class="hljs-string">描述：两个技能的调用关系示意图</span>

  <span class="hljs-number">3</span><span class="hljs-string">.</span> <span class="hljs-string">"Type × Style 二维配图法"</span> <span class="hljs-bullet">-</span> <span class="hljs-attr">Type:</span> <span class="hljs-string">概念图</span> <span class="hljs-string">|</span> <span class="hljs-attr">Style:</span> <span class="hljs-string">信息图表</span>
     <span class="hljs-string">描述：二维矩阵展示类型和风格的组合</span>

  <span class="hljs-number">4</span><span class="hljs-string">.</span> <span class="hljs-string">"完整工作流"</span> <span class="hljs-bullet">-</span> <span class="hljs-attr">Type:</span> <span class="hljs-string">流程图</span> <span class="hljs-string">|</span> <span class="hljs-attr">Style:</span> <span class="hljs-string">简洁现代</span>
     <span class="hljs-string">描述：写作→配图→迭代的三步流程</span>

  <span class="hljs-string">开始生成图片...</span>
  [<span class="hljs-string">调用</span> <span class="hljs-string">baoyu-image-gen</span> <span class="hljs-string">生成</span> <span class="hljs-number">4</span> <span class="hljs-string">张图片...</span>]

  <span class="hljs-string">配图完成，已插入文档。</span>

<span class="hljs-string">你:</span> <span class="hljs-string">封面图的背景换成深色科技风</span>

<span class="hljs-attr">Claude:</span> [<span class="hljs-string">重新生成封面图并替换...</span>]
</code></pre>
<h4 data-id="heading-19">3.2 配图类型参考</h4>






























<table><thead><tr><th>文章类型</th><th>推荐 Type</th><th>推荐 Style</th></tr></thead><tbody><tr><td>技术教程</td><td>流程图、步骤图</td><td>扁平插画、信息图表</td></tr><tr><td>概念解释</td><td>概念图、类比图</td><td>简洁图示、手绘风</td></tr><tr><td>产品介绍</td><td>场景图、功能图</td><td>3D渲染、产品风</td></tr><tr><td>最佳实践</td><td>对比图、清单图</td><td>专业商务、简约风</td></tr></tbody></table>
<h4 data-id="heading-20">3.3 过程图示</h4>
<ul>
<li>输入文章要求</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">claude <span class="hljs-string">"帮我写一篇用 Claude Code 写技术文档，然后使用 baoyu-article-illustrator给文章配图的基础教程，面向有基础的开发者"</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/12e5cedb033e4b8abbdf3ca687d4a7ab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m95bCP57qvMjAyNQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770049949&amp;x-signature=dghZZV2xKR%2BQFRc8%2FRKJzq2Rmqw%3D" alt="ab905d8016bf3f521a57ac7c9eec8c63.png" loading="lazy"/></p>
<ul>
<li>开始规划配图</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">/baoyu-article-illustrator /Users/zhangjian/works/workspace_vibe/skills_md/write_article_with_cc/claude-code-writing-tutorial.md
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ecb1afb9df44fac913995be0e9e5ceb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m95bCP57qvMjAyNQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770049949&amp;x-signature=l%2FPYuAFdDaesLiVhlGCXnj6ljIk%3D" alt="3b465947e002f580173b409e425da548.png" loading="lazy"/></p>
<ul>
<li>文生图国产模型配置</li>
</ul>
<p>注意原始的工具是不支持国产模型【默认支持OPENAI及GOOGLE的文生图模型】，这里我做了改造，增加了阿里云的【通义-文生图-Z-Image，单模型白嫖额度100张图片，如下图，还有其他模型，可以修改环境变量调整【~/.baoyu-skills/.env中增加DASHSCOPE_IMAGE_MODEL=z-image-turbo】】支持<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FJianJang2017%2Fbaoyu-skills.git" target="_blank" title="https://github.com/JianJang2017/baoyu-skills.git" ref="nofollow noopener noreferrer">改造后代码</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa5d419326064106819052191736c5c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m95bCP57qvMjAyNQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770049949&amp;x-signature=wFQiXH2SqzUkbeDKmZdGfmNNY70%3D" alt="image.png" loading="lazy"/></p>
<ol>
<li>替换生图技能【baoyu-image-gen】中的文件内容【这里也可以手动直接安装我fork过来的版本，修改内容已提交】
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02a49ca3a0cd4889a0319000d5bad039~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m95bCP57qvMjAyNQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770049949&amp;x-signature=4hD4J%2BvtHavs27QF1fX4a%2Bh3Oyw%3D" alt="image.png" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a1fa0882f5cc47c3a040dfc38296e2ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m95bCP57qvMjAyNQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770049949&amp;x-signature=4qsyYemFENb5ZfyURsMXQUet0UU%3D" alt="image.png" loading="lazy"/></li>
<li>新增阿里云模型配置apikey
创建用户环境变量</li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> ~/.baoyu-skills
</code></pre>
<p>增加apikey配置【在~/.baoyu-skills】目录下创建.env文件内容如下【对应的api key从阿里云百炼平台获取】：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment">#指定模型</span>
DASHSCOPE_IMAGE_MODEL=z-image-turbo
<span class="hljs-comment">#指定api key</span>
DASHSCOPE_API_KEY=sk-xxxxxxxxxxx
</code></pre>
<ol start="4">
<li>图片prompt生成</li>
</ol>
<p>baoyu-article-illustrator会根据文章内容进行分析然后生成插图规划，然后根据规划生成对应的文生图prompt
5. prompt生成后会调用baoyu-image-gen按照规划的图片prompt进行图片生成</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/36378d9550f34ada89c4419cb29a6f44~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m95bCP57qvMjAyNQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770049949&amp;x-signature=B9tqFLYwkwnd%2Bgm8QdA%2FFLDgv70%3D" alt="4e0c9afab11d9c2cba2ee7abc8ea2c00.png" loading="lazy"/>
6. 生产完成后会将图片插入预定的位置</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4659b224052c427a990cf1995875d30f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m95bCP57qvMjAyNQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770049949&amp;x-signature=4HT7IVnabmVMdbL5asuklPblr0k%3D" alt="dd3e992868d2f5c47be3fa012871a77e.png" loading="lazy"/></p>
<ol start="7">
<li>注意：有时候会未自动插入，干预提示一下即可，也可根据文件目录下的outline.md文件内容进行手动粘贴</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b4ff9eef6a0243ce899d713b87eb2f44~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m95bCP57qvMjAyNQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770049949&amp;x-signature=qdWciB2Q6uKNudeIQyHTJX%2Fq42M%3D" alt="image.png" loading="lazy"/>
8. 效果截图</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d084461e14d471c916a7b36743f26f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m95bCP57qvMjAyNQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770049949&amp;x-signature=ZNYNi1IuV6siHejO%2BZttZYdaS9E%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-21">常见问题</h3>
<h4 data-id="heading-22">Q: baoyu-article-illustrator 和 baoyu-image-gen 有什么区别？</h4>
<p>A: <code>baoyu-article-illustrator</code> 是面向用户的智能配图技能，会分析文章并决定在哪里配什么图；<code>baoyu-image-gen</code> 是底层的图片生成能力，被前者调用来实际生成图片。一般情况下，直接使用 <code>baoyu-article-illustrator</code> 即可。</p>
<h4 data-id="heading-23">Q: 生成的图片保存在哪里？</h4>
<p>A: 默认保存在当前工作目录或文章所在目录。</p>
<h4 data-id="heading-24">Q: 可以只为文章的某一部分配图吗？</h4>
<p>A: 可以，在调用时指定具体位置，如："只为'工具链关系'这一节配图"。</p>
<h4 data-id="heading-25">Q: 如何修改已生成的图片风格？</h4>
<p>A: 直接描述你的修改需求，如："把封面图换成 3D 风格"，Claude 会重新生成并替换。</p>
<h4 data-id="heading-26">Q: 支持哪些图片风格？</h4>
<p>A: 支持扁平插画、3D渲染、手绘风、科技感、简约风、信息图表等多种风格，可根据文章调性自由选择。</p>
<h3 data-id="heading-27">总结</h3>
<p>Claude Code + baoyu-article-illustrator 的组合让技术文档创作变得高效：</p>
<ol>
<li><strong>写作阶段</strong>：利用 Claude 对代码的理解能力，生成准确的技术文档</li>
<li><strong>配图阶段</strong>：一条命令智能分析 + 自动配图，无需手动指定每张图</li>
<li><strong>迭代优化</strong>：在对话中持续调整，直到满意为止</li>
</ol>
<p><strong>工具链优势：</strong></p>
<ul>
<li><code>baoyu-article-illustrator</code> 负责"思考"：分析文章、决定配图策略</li>
<li><code>baoyu-image-gen</code> 负责"执行"：生成高质量图片</li>
</ul>
<p>掌握这套工作流，可以大幅提升技术文档的创作效率和视觉质量。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Linux 实战】手把手写 Makefile：静态库 / 动态库一键编译（附可直接套用的计算器实战模板）]]></title>    <link>https://juejin.cn/post/7599581687357915186</link>    <guid>https://juejin.cn/post/7599581687357915186</guid>    <pubDate>2026-01-27T01:04:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599581687357915186" data-draft-id="7599538010725761051" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Linux 实战】手把手写 Makefile：静态库 / 动态库一键编译（附可直接套用的计算器实战模板）"/> <meta itemprop="keywords" content="后端,GitHub,Linux"/> <meta itemprop="datePublished" content="2026-01-27T01:04:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小杨同学66"/> <meta itemprop="url" content="https://juejin.cn/user/1189004976589664"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Linux 实战】手把手写 Makefile：静态库 / 动态库一键编译（附可直接套用的计算器实战模板）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1189004976589664/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小杨同学66
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T01:04:44.000Z" title="Tue Jan 27 2026 01:04:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">【Linux 实战】手把手写 Makefile：静态库 / 动态库一键编译（附可直接套用的计算器实战模板）</h2>
<p>大家好，我是专注嵌入式 Linux 开发的小杨同学。对于 Linux C/C++ 开发来说，Makefile 是绕不开的核心工具 —— 尤其是在构建包含静态库 / 动态库的项目时，一份好的 Makefile 能让你摆脱重复敲编译命令的繁琐，实现 “一键编译、一键清理、一键安装”。今天就以四则运算计算器项目为例，拆解两份实战型 Makefile（静态库版 + 动态库版），从变量定义到规则编写，每一行都讲透，新手也能直接套用！</p>
<h3 data-id="heading-1">一、先理清核心需求：计算器项目的 Makefile 要实现什么？</h3>
<p>我们的目标是基于标准化目录结构（1src/2include/3lib/0output），用 Makefile 完成：</p>
<ol>
<li>自动编译所有源文件为目标文件（.o）并放入 3lib 目录；</li>
<li>将目标文件打包为静态库（libcal.a）或动态库（libcal.so）；</li>
<li>链接库文件生成可执行文件，输出到 0output 目录；</li>
<li>提供清理、安装（动态库）等便捷指令，简化开发流程。</li>
</ol>
<h4 data-id="heading-2">项目目录回顾</h4>
<p>plaintext</p>
<pre><code class="hljs language-php" lang="php">calc_project/
├── <span class="hljs-number">0</span>output/       <span class="hljs-comment"># 可执行文件输出目录</span>
├── <span class="hljs-number">1</span>src/          <span class="hljs-comment"># 源代码目录（Add.c/mul.c/sub.c/div.c/utils.c/main.c）</span>
├── <span class="hljs-number">2</span><span class="hljs-keyword">include</span>/      <span class="hljs-comment"># 头文件目录（各模块.h文件）</span>
└── <span class="hljs-number">3</span>lib/          <span class="hljs-comment"># 库文件/目标文件目录</span>
</code></pre>
<h3 data-id="heading-3">二、实战 1：静态库版 Makefile（适合嵌入式资源受限场景）</h3>
<p>静态库的优势是可执行文件不依赖外部库，直接运行，非常适合嵌入式设备。以下是完整的静态库 Makefile，附带逐行解析：</p>
<h4 data-id="heading-4">完整静态库 Makefile 代码</h4>
<p>makefile</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-comment"># 核心编译参数：集中定义，便于统一修改</span>
CFLAGS = -Wall -g -O2 -I ./2include
<span class="hljs-comment"># 可执行文件名称</span>
calc_target = calculator          
<span class="hljs-comment"># 库模块源文件列表</span>
calc_srcs = 1src/Add.c 1src/mul.c 1src/sub.c 1src/div.c 1src/utils.c
<span class="hljs-comment"># 目标文件列表（对应3lib目录下的.o文件）</span>
calc_lib_objs = 3lib/Add.o 3lib/mul.o 3lib/sub.o 3lib/div.o 3lib/utils.o
<span class="hljs-comment"># 静态库名称</span>
calc_static_lib = 3lib/libcal.a 

<span class="hljs-comment"># 默认目标：执行make时优先编译计算器可执行文件</span>
<span class="hljs-section">all: <span class="hljs-variable">$(calc_target)</span></span>
	@echo <span class="hljs-string">"✅ 计算器编译完成！可执行文件：0output/calculator"</span>

<span class="hljs-comment"># 通用规则：将1src下的.c文件编译为3lib下的.o文件</span>
<span class="hljs-section">3lib/%.o: 1src/%.c</span>
	gcc <span class="hljs-variable">$(CFLAGS)</span> -c <span class="hljs-variable">$&lt;</span> -o <span class="hljs-variable">$@</span>

<span class="hljs-comment"># 编译静态库：先确保3lib目录存在，再打包所有.o文件</span>
<span class="hljs-variable">$(calc_static_lib)</span>: <span class="hljs-variable">$(calc_lib_objs)</span>
	mkdir -p 3lib  <span class="hljs-comment"># 若3lib目录不存在则创建</span>
	ar rcs <span class="hljs-variable">$@</span> <span class="hljs-variable">$^</span>   <span class="hljs-comment"># r=替换旧文件 c=创建库 s=生成索引</span>

<span class="hljs-comment"># 编译可执行文件：链接静态库，输出到0output目录</span>
<span class="hljs-variable">$(calc_target)</span>: <span class="hljs-variable">$(calc_static_lib)</span>
	mkdir -p 0output  <span class="hljs-comment"># 确保输出目录存在</span>
	gcc <span class="hljs-variable">$(CFLAGS)</span> 1src/main.c <span class="hljs-variable">$(calc_static_lib)</span> -o 0output/<span class="hljs-variable">$(calc_target)</span>

<span class="hljs-comment"># 清理规则：删除所有编译产物</span>
<span class="hljs-section">clean:</span>
	rm -rf 3lib/*.o 3lib/*.a 0output/*
	@echo <span class="hljs-string">"🗑️  计算器产物清理完成"</span>

<span class="hljs-comment"># 声明伪目标：避免与同名文件冲突</span>
<span class="hljs-meta"><span class="hljs-keyword">.PHONY</span>: all clean</span>
</code></pre>
<h4 data-id="heading-5">关键解析（新手必看）</h4>
<ol>
<li>
<p><strong>变量定义</strong>：把编译参数、文件名、路径都定义为变量，后续修改只需改变量值（比如换编译器、改库名），无需逐行改规则；</p>
<ul>
<li><code>CFLAGS</code>参数说明：<code>-Wall</code>显示所有警告、<code>-g</code>生成调试信息、<code>-O2</code>优化编译、<code>-I ./2include</code>指定头文件路径；</li>
</ul>
</li>
<li>
<p><strong>通用规则<code>3lib/%.o: 1src/%.c</code></strong>：</p>
<ul>
<li><code>%</code>是通配符，匹配任意文件名（比如 Add、mul）；</li>
<li><code>$&lt;</code>代表 “依赖项”（即 1src 下的.c 文件），<code>$@</code>代表 “目标项”（即 3lib 下的.o 文件）；</li>
<li>这条规则能自动匹配所有 1src 下的.c 文件，无需为每个文件写单独的编译规则；</li>
</ul>
</li>
<li>
<p><strong>静态库打包命令<code>ar rcs</code></strong>：嵌入式开发必备，<code>ar</code>是静态库打包工具，<code>rcs</code>组合参数能快速生成可用的静态库；</p>
</li>
<li>
<p><strong>伪目标<code>.PHONY</code></strong>：声明<code>all</code>和<code>clean</code>是 “伪目标”（不是实际文件），避免项目中存在同名文件时，Make 误判 “目标已更新”。</p>
</li>
</ol>
<h4 data-id="heading-6">静态库 Makefile 使用方法</h4>
<p>bash</p>
<p>运行</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 一键编译静态库+可执行文件</span>
make

<span class="hljs-comment"># 运行可执行文件</span>
./0output/calculator

<span class="hljs-comment"># 一键清理所有编译产物</span>
make clean
</code></pre>
<h3 data-id="heading-7">三、实战 2：动态库版 Makefile（支持系统级安装）</h3>
<p>动态库的优势是节省内存（多个程序共享一份库），适合需要灵活更新的场景。这份 Makefile 新增了 “安装动态库到系统目录” 的规则，解决动态库运行时路径问题：</p>
<h4 data-id="heading-8">完整动态库 Makefile 代码</h4>
<p>makefile</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-comment"># 核心编译参数</span>
CFLAGS = -Wall -g -O2 -I ./2include
<span class="hljs-comment"># 可执行文件名称</span>
calc_target = calculator          
<span class="hljs-comment"># 库模块源文件列表</span>
calc_srcs = 1src/Add.c 1src/mul.c 1src/sub.c 1src/div.c 1src/utils.c
<span class="hljs-comment"># 目标文件列表</span>
calc_lib_objs = 3lib/Add.o 3lib/mul.o 3lib/sub.o 3lib/div.o 3lib/utils.o
<span class="hljs-comment"># 动态库名称</span>
calc_dynamic_lib = 3lib/libcal.so
<span class="hljs-comment"># 系统库目录（动态库安装路径）</span>
sys_lib_dir = /usr/lib      
<span class="hljs-comment"># 链接库时的简写名称（-lcal 对应 libcal.so）</span>
lib_name = -lcal

<span class="hljs-comment"># 默认目标：先编译动态库，再编译可执行文件</span>
<span class="hljs-section">all: <span class="hljs-variable">$(calc_dynamic_lib)</span> <span class="hljs-variable">$(calc_target)</span></span>
	@echo <span class="hljs-string">"✅ 计算器编译完成！可执行文件：0output/calculator"</span>

<span class="hljs-comment"># 通用规则：编译3lib下的.o文件</span>
<span class="hljs-section">3lib/%.o: 1src/%.c</span>
	gcc <span class="hljs-variable">$(CFLAGS)</span> -c <span class="hljs-variable">$&lt;</span> -o <span class="hljs-variable">$@</span>

<span class="hljs-comment"># 编译动态库：-fPIC生成位置无关代码，-shared指定动态库</span>
<span class="hljs-variable">$(calc_dynamic_lib)</span>: <span class="hljs-variable">$(calc_lib_objs)</span>
	mkdir -p 3lib
	gcc <span class="hljs-variable">$(CFLAGS)</span> -fPIC -shared -o <span class="hljs-variable">$@</span> <span class="hljs-variable">$^</span>

<span class="hljs-comment"># 安装动态库到系统目录：解决运行时库路径问题</span>
<span class="hljs-section">install: <span class="hljs-variable">$(calc_dynamic_lib)</span></span>
	sudo cp <span class="hljs-variable">$(calc_dynamic_lib)</span> <span class="hljs-variable">$(sys_lib_dir)</span>
	sudo ldconfig  <span class="hljs-comment"># 刷新系统库缓存</span>
	@echo <span class="hljs-string">"✅ 动态库已安装到 <span class="hljs-variable">$(sys_lib_dir)</span>，系统已刷新缓存"</span>

<span class="hljs-comment"># 清除3lib目录所有文件（比clean更彻底）</span>
<span class="hljs-section">clear:</span>
	rm -rf 3lib/*
	@echo <span class="hljs-string">"🗑️  3lib目录下所有文件已清除！"</span>

<span class="hljs-comment"># 编译可执行文件：链接动态库</span>
<span class="hljs-variable">$(calc_target)</span>: <span class="hljs-variable">$(calc_dynamic_lib)</span>
	mkdir -p 0output
	gcc <span class="hljs-variable">$(CFLAGS)</span> 1src/main.c -L3lib <span class="hljs-variable">$(lib_name)</span> -o 0output/<span class="hljs-variable">$(calc_target)</span>

<span class="hljs-comment"># 清理规则：删除.o、.so和可执行文件</span>
<span class="hljs-section">clean:</span>
	rm -rf 3lib/*.o 3lib/*.so 0output/*
	@echo <span class="hljs-string">"🗑️  计算器产物清理完成"</span>

<span class="hljs-comment"># 声明伪目标</span>
<span class="hljs-meta"><span class="hljs-keyword">.PHONY</span>: all clean clear install</span>
</code></pre>
<h4 data-id="heading-9">动态库核心差异解析</h4>
<ol>
<li>
<p><strong>动态库编译参数</strong>：</p>
<ul>
<li><code>-fPIC</code>：生成位置无关代码（动态库必备，否则无法在内存任意地址加载）；</li>
<li><code>-shared</code>：告诉编译器生成动态库，而非可执行文件；</li>
</ul>
</li>
<li>
<p><strong>安装规则<code>install</code></strong>：</p>
<ul>
<li>将动态库复制到系统默认库目录<code>/usr/lib</code>，解决 “运行时找不到 libcal.so” 的问题；</li>
<li><code>ldconfig</code>：刷新系统库缓存，让系统识别新安装的动态库；</li>
</ul>
</li>
<li>
<p><strong>链接动态库</strong>：<code>-L3lib</code>指定库搜索路径，<code>-lcal</code>简写链接<code>libcal.so</code>（Make 自动补全<code>lib</code>前缀和<code>.so</code>后缀）；</p>
</li>
<li>
<p><strong>新增<code>clear</code>规则</strong>：彻底清空 3lib 目录，适合重新编译时使用。</p>
</li>
</ol>
<h4 data-id="heading-10">动态库 Makefile 使用方法</h4>
<p>bash</p>
<p>运行</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 一键编译动态库+可执行文件</span>
make

<span class="hljs-comment"># 安装动态库到系统（解决运行时依赖）</span>
make install

<span class="hljs-comment"># 运行可执行文件（无需手动配置LD_LIBRARY_PATH）</span>
./0output/calculator

<span class="hljs-comment"># 清理编译产物</span>
make clean

<span class="hljs-comment"># 彻底清空3lib目录</span>
make clear
</code></pre>
<h3 data-id="heading-11">四、避坑指南：Makefile 常见问题解决</h3>
<ol>
<li>
<p><strong>报错 “missing separator. Stop.”</strong> ：</p>
<ul>
<li>原因：规则后的命令行没有用 TAB 开头（用了空格）；</li>
<li>解决：将命令行前的空格替换为 TAB（编辑器需关闭 “TAB 转空格” 功能）；</li>
</ul>
</li>
<li>
<p><strong>动态库运行报错 “找不到 libcal.so”</strong> ：</p>
<ul>
<li>原因：系统未识别动态库路径；</li>
<li>解决：执行<code>make install</code>将库安装到系统目录，或临时配置环境变量<code>export LD_LIBRARY_PATH=./3lib:$LD_LIBRARY_PATH</code>；</li>
</ul>
</li>
<li>
<p><strong>编译时 “找不到头文件”</strong> ：</p>
<ul>
<li>原因：<code>CFLAGS</code>中<code>-I ./2include</code>路径错误；</li>
<li>解决：确认头文件目录路径，确保与项目结构匹配。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-12">五、总结：Makefile 的核心价值与复用技巧</h3>
<ol>
<li>
<p><strong>核心价值</strong>：</p>
<ul>
<li>自动化：替代重复的 gcc 命令，一键完成编译、打包、安装；</li>
<li>可维护：变量集中定义，修改参数无需改遍所有规则；</li>
<li>增量编译：Make 会自动对比文件修改时间，只重新编译变动的文件，提升效率；</li>
</ul>
</li>
<li>
<p><strong>复用技巧</strong>：</p>
<ul>
<li>保留通用规则（如<code>3lib/%.o: 1src/%.c</code>），只需修改变量（源文件、库名、路径）即可适配其他项目；</li>
<li>静态库 / 动态库的核心编译参数固定，可直接复制到其他嵌入式项目中；</li>
<li>新增<code>install</code>/<code>clear</code>等扩展规则，适配不同场景的便捷操作。</li>
</ul>
</li>
</ol>
<p>这份 Makefile 模板可以直接套用到你的 Linux C/C++ 项目中，无论是嵌入式计算器、串口驱动还是其他模块，只需修改变量部分就能快速适配。掌握这些规则后，你就能摆脱 “手动敲编译命令” 的低效模式，真正实现 Linux 开发的自动化！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何通过 Cloudflare Tunnel 更安全的访问 RustFS？]]></title>    <link>https://juejin.cn/post/7599585289946169407</link>    <guid>https://juejin.cn/post/7599585289946169407</guid>    <pubDate>2026-01-27T01:09:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599585289946169407" data-draft-id="7599502282602545215" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何通过 Cloudflare Tunnel 更安全的访问 RustFS？"/> <meta itemprop="keywords" content="Rust"/> <meta itemprop="datePublished" content="2026-01-27T01:09:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="RustFS"/> <meta itemprop="url" content="https://juejin.cn/user/511719423354121"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何通过 Cloudflare Tunnel 更安全的访问 RustFS？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/511719423354121/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    RustFS
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T01:09:50.000Z" title="Tue Jan 27 2026 01:09:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>RustFS 默认通过 <code>9001</code> 端口登录控制台，<code>9000</code> 端口使用 API，为了安全合规，通常采用**启用 HTTPS、反向代理（诸如 nginx、traefik、caddy 等）**的方式来更加安全的使用 RustFS。本文分享一种更加安全的方式，通过 Cloudflare tunnel 来访问你的 RustFS 实例。</p>
<h2 data-id="heading-0">安装 RustFS</h2>
<p>RustFS 支持二进制、Docker 以及 Helm Chart 的安装方式，详细方法可以查看<a href="https://link.juejin.cn?target=https%3A%2F%2Frustfs.com" target="_blank" title="https://rustfs.com" ref="nofollow noopener noreferrer">官网安装指南</a>。将如下内容写入 <code>docker-compose.yml</code> 文件：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">services:</span>
  <span class="hljs-attr">rustfs:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">rustfs/rustfs:latest</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">rustfs</span>
    <span class="hljs-attr">hostname:</span> <span class="hljs-string">rustfs</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">RUSTFS_VOLUMES=/data/rustfs{1...4}</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">RUSTFS_ADDRESS=0.0.0.0:9000</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">RUSTFS_CONSOLE_ENABLE=true</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">RUSTFS_CONSOLE_ADDRESS=0.0.0.0:9001</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">RUSTFS_ACCESS_KEY=rustfsadmin</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">RUSTFS_SECRET_KEY=rustfsadmin</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">RUSTFS_TLS_PATH=/opt/tls</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"9000:9000"</span>  <span class="hljs-comment"># API endpoint</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"9001:9001"</span>  <span class="hljs-comment"># Console</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">data1:/data/rustfs1</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">data2:/data/rustfs2</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">data3:/data/rustfs3</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">data4:/data/rustfs4</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./certs:/opt/tls</span>

    <span class="hljs-attr">networks:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">rustfs</span>

<span class="hljs-attr">networks:</span>
  <span class="hljs-attr">rustfs:</span>
    <span class="hljs-attr">driver:</span> <span class="hljs-string">bridge</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">rustfs</span>

<span class="hljs-attr">volumes:</span>
  <span class="hljs-attr">data1:</span>
  <span class="hljs-attr">data2:</span>
  <span class="hljs-attr">data3:</span>
  <span class="hljs-attr">data4:</span>
</code></pre>
<p>运行如下命令</p>
<pre><code class="hljs">docker compose up -d
</code></pre>
<p>即可安装好一个 RustFS 实例：</p>
<pre><code class="hljs language-bash" lang="bash">docker compose ps
NAME      IMAGE                          COMMAND                  SERVICE   CREATED          STATUS          PORTS
rustfs    rustfs/rustfs:1.0.0-alpha.81   <span class="hljs-string">"/entrypoint.sh rust…"</span>   rustfs    22 minutes ago   Up 22 minutes   0.0.0.0:9000-9001-&gt;9000-9001/tcp, [::]:9000-9001-&gt;9000-9001/tcp
</code></pre>
<h2 data-id="heading-1">配置 Cloudflare tunnel</h2>
<p>配置 Cloudflare tunnel 大体分为 <strong>域名配置</strong> 和 <strong>tunnel 配置</strong> 两部分。</p>
<h3 data-id="heading-2">域名配置</h3>
<p>域名配置是为了后期能够更方便的访问 RustFS。</p>
<ul>
<li>使用 Cloudflare 账号登录 Cloudflare Domain 界面；</li>
<li>在左侧导航栏，<strong>Account home</strong>，如果你已经有域名，则选择 <strong>Onboard a domain</strong>，否则可选择 <strong>Buy a domain</strong>。</li>
<li>如果选择 <strong>Onboard a domain</strong>，点击该选项后，在出现的界面中输入你的域名，然后继续往下走，直到在最后选择 <strong>Continue to activation</strong>。</li>
<li>如果一切顺利，可以在域名管理首页看到添加成功的域名，其 <strong>Status</strong> 会显示为 <strong>Active</strong>。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eeca92abe4fa4c31b912cf2714d9ee3e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUnVzdEZT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770080990&amp;x-signature=h4ibF3A7TLdOiixu2hAmrKBe9d8%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-3">tunnel 配置</h3>
<ul>
<li>
<p>使用 Cloudflare 账号登录 <a href="https://link.juejin.cn?target=https%3A%2F%2Fone.dash.cloudflare.com%2F" target="_blank" title="https://one.dash.cloudflare.com/" ref="nofollow noopener noreferrer">Cloudflare Dashboard</a>；</p>
</li>
<li>
<p>在左侧导航栏，选择 <strong>Networks -&gt; Connectors</strong>，在右侧界面点击 <strong>Create a tunnel</strong>；</p>
</li>
<li>
<p>在 tunnel 类型中，选择 <strong>Select Clouflared</strong>；</p>
</li>
<li>
<p>在 <strong>Install and run connectors</strong> 中，根据 RustFS 实例所在服务器的操作系统信息，选择相应的安装方式。安装完毕后，可以在服务器上查看 <code>cloudflared</code> 服务的状态。运行正常后点击 <strong>Next</strong>。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">systemctl</span> <span class="hljs-string">status</span> <span class="hljs-string">cloudflared</span>
<span class="hljs-string">●</span> <span class="hljs-string">cloudflared.service</span> <span class="hljs-bullet">-</span> <span class="hljs-string">cloudflared</span>
     <span class="hljs-attr">Loaded:</span> <span class="hljs-string">loaded</span> <span class="hljs-string">(/etc/systemd/system/cloudflared.service;</span> <span class="hljs-string">enabled;</span> <span class="hljs-attr">preset:</span> <span class="hljs-string">enabled)</span>
     <span class="hljs-attr">Active:</span> <span class="hljs-string">active</span> <span class="hljs-string">(running)</span> <span class="hljs-string">since</span> <span class="hljs-string">Fri</span> <span class="hljs-number">2026-01-16 21:18:53 </span><span class="hljs-string">CST;</span> <span class="hljs-number">6</span> <span class="hljs-string">days</span> <span class="hljs-string">ago</span>
   <span class="hljs-attr">Main PID:</span> <span class="hljs-number">2538004</span> <span class="hljs-string">(cloudflared)</span>
      <span class="hljs-attr">Tasks:</span> <span class="hljs-number">10</span> <span class="hljs-string">(limit:</span> <span class="hljs-number">4375</span><span class="hljs-string">)</span>
     <span class="hljs-attr">Memory:</span> <span class="hljs-number">31.</span><span class="hljs-string">3M</span> <span class="hljs-string">(peak:</span> <span class="hljs-attr">38.7M swap: 8.2M swap peak:</span> <span class="hljs-number">15.</span><span class="hljs-string">3M)</span>
        <span class="hljs-attr">CPU:</span> <span class="hljs-string">18min</span> <span class="hljs-number">16.</span><span class="hljs-string">159s</span>
     <span class="hljs-attr">CGroup:</span> <span class="hljs-string">/system.slice/cloudflared.service</span>
</code></pre>
</li>
<li>
<p>在 <strong>Route Traffic</strong> 中，配置 <strong>Hostname</strong> 和 <strong>Service</strong> 信息。</p>
<ul>
<li>Hostname 中填写的域名可用于后续访问 RustFS 实例，可以在 <strong>Domain</strong> 字段中选择 <strong>域名配置</strong> 部分添加好的域名。如果想通过子域名访问，也可以在 <strong>Subdomain</strong> 字段中输入子域名名称。</li>
<li>Service 选择服务类型和 URL。对于上述安装的 RustFS 实例，Type 可以选择 HTTP/HTTPS（如果启用了 HTTPS，可选择 HTTPS，否则用 HTTP），URL 为 <code>localhost:9001</code>。</li>
</ul>
</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d13f6684fb9e477db24d92a8a483a478~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUnVzdEZT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770080990&amp;x-signature=sd%2FQ4VdrcOZrH5iKUS95T7FnmUE%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>点击 <strong>Complete setup</strong> 完成配置。</li>
</ul>
<p>上述配置结束后，可以在 Connectors 界面看到添加好的 tunnel，如果一切顺利，则可以看到 <strong>Status</strong> 为绿色的 <strong>HEALTHY</strong>。</p>
<blockquote>
<p>在 Hostname 和 Service 设置页面的 <strong>Additional application settings</strong> 部分，点击 <strong>HTTP Settings</strong>，在 <strong>HTTP Host Header</strong> 部分，输入访问 RustFS 的域名，这是为了避免后续使用出现签名错误。</p>
</blockquote>
<h2 data-id="heading-4">登录验证</h2>
<p>恭喜你，如果你顺利完成了上述两部分的配置后，那么现在你就可以通过你配置好的域名来访问 RustFS 实例了。本文配置的域名为 <code>rustfs.xiaomage.vip</code>，所以在浏览器中输入 <code>https://rustfs.xiaomage.vip</code> 即可访问 RustFS 实例：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10b1e5f2206d49949a41fed42f3eb214~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUnVzdEZT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770080990&amp;x-signature=GmOuS1Hkr8YjsEGWHm0ejLyFc7Y%3D" alt="image.png" loading="lazy"/></p>
<p>输入 <code>rustfsadmin/rustfsadmin</code> 即可登录。</p>
<p>接下来就可以通过多种方式来使用 RustFS 实例了，比如 <code>mc</code>、<code>rc</code> 以及 <code>rclone</code>。</p>
<h2 data-id="heading-5">通过 <code>mc</code> 使用 RustFS</h2>
<p><code>mc</code> 是 Minio 的专属客户端，由于 RustFS 是 S3 兼容的，而且是 Minio 的平替，所以可以用 <code>mc</code> 来操作 RustFS。</p>
<h3 data-id="heading-6">前提</h3>
<ul>
<li>根据 minio <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fminio%2Fmc" target="_blank" title="https://github.com/minio/mc" ref="nofollow noopener noreferrer">官网指南</a>安装好 <code>mc</code>。</li>
</ul>

<pre><code class="hljs language-sql" lang="sql">mc <span class="hljs-comment">--version</span>
mc version <span class="hljs-keyword">RELEASE</span><span class="hljs-number">.2025</span><span class="hljs-number">-08</span><span class="hljs-number">-29</span>T21<span class="hljs-number">-30</span><span class="hljs-number">-41</span>Z (<span class="hljs-keyword">commit</span><span class="hljs-operator">-</span>id<span class="hljs-operator">=</span>f7560841be167a94b7014bf8a504e0820843247f)
Runtime: go1<span class="hljs-number">.24</span><span class="hljs-number">.6</span> darwin<span class="hljs-operator">/</span>arm64
Copyright (c) <span class="hljs-number">2015</span><span class="hljs-number">-2025</span> MinIO, Inc.
MinIO Enterprise License
</code></pre>
<h3 data-id="heading-7">使用</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 添加 `alias`</span>
mc <span class="hljs-built_in">alias</span> <span class="hljs-built_in">set</span> rustfs https://rustfs.xiaomage.vip rustfsadmin rustfsadmin

<span class="hljs-comment"># 创建存储桶</span>
mc mb rustfs/hello

<span class="hljs-comment"># 列出存储桶</span>
mc <span class="hljs-built_in">ls</span> rustfs
[2026-01-23 21:39:36 CST]     0B hello/
[2026-01-23 20:12:59 CST]     0B <span class="hljs-built_in">test</span>/

<span class="hljs-comment"># 上传文件到存储桶</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"123456"</span> &gt; 1.txt
mc <span class="hljs-built_in">cp</span> 1.txt rustfs/hello
/tmp/1.txt:                         ██████████████████████████████████████████████████████████████████████████████████ 100.0% 7 B       1 B/s      

<span class="hljs-comment"># 查看上传的文件</span>
mc <span class="hljs-built_in">ls</span> rustfs/hello
[2026-01-23 21:40:44 CST]     7B STANDARD 1.txt
</code></pre>
<p>更多用法可自行探索。</p>
<h2 data-id="heading-8">通过 <code>rclone</code> 使用 RustFS</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Frclone.org%2F" target="_blank" title="https://rclone.org/" ref="nofollow noopener noreferrer"><code>rclone</code></a>是一个命令行工具，可以对不同云提供商上的文件和目录进行同步。</p>
<h3 data-id="heading-9">前提</h3>
<ul>
<li>
<p>根据 <a href="https://link.juejin.cn?target=https%3A%2F%2Fchatgpt.com%2F" target="_blank" title="https://chatgpt.com/" ref="nofollow noopener noreferrer"><code>rclone</code> 官网指南</a>安装好 <code>rclone</code> 命令行工具。</p>
<pre><code class="hljs language-bash" lang="bash">rclone --version
rclone v1.72.1
- os/version: ubuntu 24.04 (64 bit)
- os/kernel: 6.8.0-71-generic (x86_64)
- os/type: linux
- os/arch: amd64
- go/version: go1.25.5
- go/linking: static
- go/tags: none
</code></pre>
</li>
</ul>
<h3 data-id="heading-10">使用</h3>
<ul>
<li>配置 <code>rclone</code></li>
</ul>
<p>执行 <code>rclone config</code> 命令，根据 RustFS 实例信息，一步步进行配置。配置完成后，会生成一个 <code>~/.config/rclone/rclone.conf</code> 文件，一般内容如下：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[rustfs]</span>
<span class="hljs-attr">type</span> = s3
<span class="hljs-attr">provider</span> = Minio
<span class="hljs-attr">access_key_id</span> = rustfsadmin
<span class="hljs-attr">secret_access_key</span> = rustfsadmin
<span class="hljs-attr">endpoint</span> = https://rustfs.xiaomage.vip
<span class="hljs-attr">region</span> = us-east-<span class="hljs-number">1</span>
<span class="hljs-attr">force_path_style</span> = <span class="hljs-literal">true</span>
</code></pre>
<blockquote>
<p>由于目前 RustFS 还未向 rclone 官方提 PR 以增加 RustFS provider 信息，因此使用 Minio 作为 provider。</p>
</blockquote>
<ul>
<li>开始使用</li>
</ul>

<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 列出存储桶和对象</span>

rclone <span class="hljs-built_in">ls</span> rustfs: --s3-sign-accept-encoding=<span class="hljs-literal">false</span>
        7 hello/1.txt
    11792 <span class="hljs-built_in">test</span>/1.<span class="hljs-built_in">log</span>
   520512 <span class="hljs-built_in">test</span>/123.mp3
     7394 <span class="hljs-built_in">test</span>/2.<span class="hljs-built_in">log</span>
   147240 <span class="hljs-built_in">test</span>/321.mp3
   

<span class="hljs-comment"># 查看某个对象内容</span>
rclone <span class="hljs-built_in">cat</span> rustfs:hello/1.txt --s3-sign-accept-encoding=<span class="hljs-literal">false</span>
123456 
</code></pre>
<p>对于其他用法，可以通过 <code>rclone --help</code> 来自行探索。</p>
<p><strong>注意</strong>：添加 <code>--s3-sign-accept-encoding=false</code> 参数是因为 Cloudflare 会对 <code>Accept-Encoding</code> 参数进行修改，在 S3 协议中，这种变更会导致 <strong>SignatureDoesNotMatch</strong> 错误，详情可以查看 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frustfs%2Frustfs%2Fissues%2F1492" target="_blank" title="https://github.com/rustfs/rustfs/issues/1492" ref="nofollow noopener noreferrer">RustFS issue</a>。</p>
<h3 data-id="heading-11">通过 <code>rc</code> 使用 RustFS</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frustfs%2Fcli" target="_blank" title="https://github.com/rustfs/cli" ref="nofollow noopener noreferrer"><code>rc</code></a> 是 RustFS 的 Client，用来对 RustFS 进行操作。目前，刚发布 <code>0.1.1</code>。可以使用 <code>cargo</code> 或源码编译安装。</p>
<pre><code class="hljs language-css" lang="css">rc <span class="hljs-attr">--version</span>
rc <span class="hljs-number">0.1</span>.<span class="hljs-number">1</span>
</code></pre>
<p>目前提供 <code>alias</code>、<code>ls</code>、<code>mb</code>、<code>rb</code> 等多种常规命令。使用方式和 <code>mc</code> 类似。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 设置 alias</span>
rc <span class="hljs-built_in">alias</span> <span class="hljs-built_in">set</span> rustfs https://rustfs.xiaomage.vip rustfsadmin rustfsadmin
✓ Alias <span class="hljs-string">'rustfs'</span> configured successfully.

<span class="hljs-comment"># 列出存储桶</span>
rc <span class="hljs-built_in">ls</span> rustfs
[2026-01-23 13:39:36]         0B hello/
[2026-01-23 13:56:57]         0B rclone/
[2026-01-23 12:12:59]         0B <span class="hljs-built_in">test</span>/

<span class="hljs-comment"># 创建存储桶</span>
rc mb rustfs/client
✓ Bucket <span class="hljs-string">'rustfs/client'</span> created successfully.
</code></pre>
<p>更多用法，可以通过 <code>rc --help</code> 进行查看并自行探索，使用过程中有任何问题，可以在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frustfs%2Fcli%2Fissues" target="_blank" title="https://github.com/rustfs/cli/issues" ref="nofollow noopener noreferrer">GitHub Issue</a>中进行反馈。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[面积图的奇妙变形：流图与地平线图]]></title>    <link>https://juejin.cn/post/7599580550296141859</link>    <guid>https://juejin.cn/post/7599580550296141859</guid>    <pubDate>2026-01-27T01:50:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599580550296141859" data-draft-id="7599580550296125475" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="面积图的奇妙变形：流图与地平线图"/> <meta itemprop="keywords" content="Python,数据可视化,数据分析"/> <meta itemprop="datePublished" content="2026-01-27T01:50:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="databook"/> <meta itemprop="url" content="https://juejin.cn/user/3526889035006702"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            面积图的奇妙变形：流图与地平线图
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3526889035006702/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    databook
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T01:50:50.000Z" title="Tue Jan 27 2026 01:50:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>想象一下面积图就像一层层叠起来的彩色玻璃片，每一层代表一个类别，从下往上堆叠，形成整体的视觉冲击。</p>
<p>但有时我们需要更特别的方式来展示数据的变化：是像河流一样蜿蜒流淌，还是像地平线上的群山连绵起伏？</p>
<p>今天，本文将介绍两种创意<strong>面积图变体</strong>——<strong>流图</strong>和<strong>地平线图</strong>，它们能让你的时间序列数据讲述更生动的故事。</p>
<h2 data-id="heading-0">1. 流图：数据的河流</h2>
<p>如果把传统的堆叠面积图想象成一块块整齐堆叠的积木，那么<strong>流图</strong>就像一条蜿蜒流淌的河流，河道的宽窄变化自然流畅，波峰波谷过渡平滑。</p>
<p>它特别适合展示多个类别数据随时间的变化趋势，尤其是当你想强调整体流动感和各部分的相对比例变化时。</p>
<p><strong>流图</strong>的<strong>核心思想</strong>是将传统的堆叠面积图进行"平滑"处理。</p>
<p>在<code>matplotlib</code>中，我们可以使用<code>fill_between</code>函数结合样条插值来创建平滑的边缘。</p>
<p>关键在于将堆叠的数据进行累积，然后对累积边界进行平滑处理。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 数据准备</span>
x = np.linspace(<span class="hljs-number">0</span>, <span class="hljs-number">10</span>, <span class="hljs-number">100</span>)
<span class="hljs-comment"># 构造三组波浪数据</span>
y1 = <span class="hljs-number">2</span> + np.sin(x)            <span class="hljs-comment"># 基础波动</span>
y2 = <span class="hljs-number">2</span> + np.cos(x - <span class="hljs-number">1.5</span>)      <span class="hljs-comment"># 错位波动</span>
y3 = <span class="hljs-number">2</span> + np.sin(x + <span class="hljs-number">2</span>)        <span class="hljs-comment"># 再次错位</span>

<span class="hljs-comment"># 省略 ...</span>

<span class="hljs-comment"># 绘图设置</span>
fig, (ax1, ax2) = plt.subplots(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, figsize=(<span class="hljs-number">14</span>, <span class="hljs-number">6</span>))

<span class="hljs-comment"># --- 左图：普通堆叠面积图 (baseline='zero') ---</span>
ax1.stackplot(x, y_data, labels=labels, colors=colors, baseline=<span class="hljs-string">'zero'</span>, alpha=<span class="hljs-number">0.8</span>)
<span class="hljs-comment"># 省略 ...</span>

<span class="hljs-comment"># --- 右图：流图 (baseline='sym') ---</span>
<span class="hljs-comment"># 'sym' 表示对称中心布局</span>
ax2.stackplot(x, y_data, labels=labels, colors=colors, baseline=<span class="hljs-string">'sym'</span>, alpha=<span class="hljs-number">0.8</span>)
ax2.axhline(<span class="hljs-number">0</span>, color=<span class="hljs-string">'black'</span>, ls=<span class="hljs-string">'--'</span>, alpha=<span class="hljs-number">0.1</span>) <span class="hljs-comment"># 画一条中心参考线</span>
<span class="hljs-comment"># 省略 ...</span>

<span class="hljs-comment"># 去除右图边框，增加流动感</span>
<span class="hljs-keyword">for</span> spine <span class="hljs-keyword">in</span> ax2.spines.values():
    spine.set_visible(<span class="hljs-literal">False</span>)

plt.tight_layout()
plt.show()
</code></pre>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a95a90d8e4d49deba0549e04440a961~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770083449&amp;x-signature=dwb%2BDG%2Fop85OGfQvutC7SPsrjNI%3D" alt="" loading="lazy"/></p>
<p><strong>流图</strong>解决了一个视觉错觉问题：在普通<strong>堆叠面积图</strong>中，上面的数据层会因为下面数据层的起伏而被迫“扭曲”，很难看出它原本的形状。</p>
<p><strong>流图</strong>通过中心布局，减少了这种扭曲，非常适合展示随时间变化的趋势和不同类别权重的波动，这种有机的形态还能给读者带来极强的审美愉悦感。</p>
<h2 data-id="heading-1">2. 地平线图：数据的群山</h2>
<p>想象一下远处的地平线上有一排连绵的山脉，每座山的高度代表一个数据值。</p>
<p><strong>地平线图</strong>就是这样一种可视化技术，它将时间序列数据压缩在一个很小的垂直空间内，通过颜色和分层来展示数据的变化。</p>
<p>特别适合在有限空间内展示多个时间序列的对比。</p>
<p><strong>地平线图</strong>的<strong>核心思想</strong>是数据分层和颜色渐变。</p>
<p>它将数据值分成若干层（通常是2-3层），每层用一种颜色表示。当数据值超过一层时，就用更深的颜色或不同的颜色填充。这样可以在很小的垂直空间内展示很大的数据范围。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> timedelta

<span class="hljs-comment"># 生成模拟数据：过去10年五大科技公司的股价波动</span>
np.random.seed(<span class="hljs-number">42</span>)

<span class="hljs-comment"># 生成日期范围：过去10年，每月一个数据点</span>
dates = pd.date_range(<span class="hljs-string">"2013-01-01"</span>, <span class="hljs-string">"2023-01-01"</span>, freq=<span class="hljs-string">"ME"</span>)
companies = [<span class="hljs-string">"苹果"</span>, <span class="hljs-string">"谷歌"</span>, <span class="hljs-string">"微软"</span>, <span class="hljs-string">"亚马逊"</span>, <span class="hljs-string">"Meta"</span>]

<span class="hljs-comment"># 生成各公司的股价模拟数据（标准化到相似范围）</span>
data = {}
<span class="hljs-keyword">for</span> company <span class="hljs-keyword">in</span> companies:
    <span class="hljs-comment"># 基础趋势：每家公司有不同的增长趋势，但最终都在70-90范围内</span>
    <span class="hljs-comment"># 省略 ...</span>

<span class="hljs-comment"># 转换为DataFrame</span>
df = pd.DataFrame(data, index=dates)

<span class="hljs-comment"># 创建对比图表</span>
fig, axes = plt.subplots(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, figsize=(<span class="hljs-number">14</span>, <span class="hljs-number">10</span>))

<span class="hljs-comment"># ============ 传统堆叠面积图 ============</span>
colors = [<span class="hljs-string">"#FF6B6B"</span>, <span class="hljs-string">"#4ECDC4"</span>, <span class="hljs-string">"#45B7D1"</span>, <span class="hljs-string">"#FFD166"</span>, <span class="hljs-string">"#9B5DE5"</span>]

<span class="hljs-comment"># 为堆叠面积图重新归一化数据</span>
df_normalized = df.div(df.<span class="hljs-built_in">sum</span>(axis=<span class="hljs-number">1</span>), axis=<span class="hljs-number">0</span>) * <span class="hljs-number">100</span>
y_cumulative = np.zeros(<span class="hljs-built_in">len</span>(df))

<span class="hljs-keyword">for</span> i, company <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(companies):
    axes[<span class="hljs-number">0</span>].fill_between(
        df.index,
        y_cumulative,
        y_cumulative + df_normalized[company].values,
        color=colors[i],
        alpha=<span class="hljs-number">0.7</span>,
        label=company,
        edgecolor=<span class="hljs-string">"white"</span>,
        linewidth=<span class="hljs-number">0.5</span>,
    )
    y_cumulative += df_normalized[company].values

<span class="hljs-comment"># 省略 ...</span>

<span class="hljs-comment"># ============ 地平线图：股价波动对比 ============</span>
<span class="hljs-comment"># 生成股价变化百分比数据（更能体现波动对比）</span>
np.random.seed(<span class="hljs-number">42</span>)
price_changes = {}
<span class="hljs-keyword">for</span> company <span class="hljs-keyword">in</span> companies:
    <span class="hljs-comment"># 生成均值附近波动的变化数据</span>
    <span class="hljs-comment"># 省略 ...</span>

<span class="hljs-comment"># 关键参数：定义“波段”</span>
BAND_HEIGHT = <span class="hljs-number">3.0</span>  <span class="hljs-comment"># 每个颜色波段代表的变化率幅度 (%)</span>
NUM_BANDS = <span class="hljs-number">3</span>  <span class="hljs-comment"># 正负方向各使用的波段层数</span>

df = pd.DataFrame(price_changes, index=dates)

<span class="hljs-comment"># 为每家公司计算并绘制地平线</span>
<span class="hljs-keyword">for</span> i, company <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(companies):
    <span class="hljs-comment"># 公司的基准Y轴位置（水平线）</span>
    <span class="hljs-comment"># 省略 ...</span>

    <span class="hljs-comment"># 分层与绘制：从第1层到第NUM_BANDS层</span>
    <span class="hljs-keyword">for</span> band <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(NUM_BANDS):
        <span class="hljs-comment"># --- 处理正偏差（上涨）---</span>
        <span class="hljs-comment"># 计算当前层的数据：偏差值减去已绘制层的高度，并限制在本层高度内</span>
        <span class="hljs-comment"># 省略 ...</span>

        <span class="hljs-comment"># --- 处理负偏差（下跌）---</span>
        <span class="hljs-comment"># 对负值取绝对值，进行类似处理</span>
        <span class="hljs-comment"># 省略 ...</span>

<span class="hljs-comment"># 美化图表</span>
<span class="hljs-comment"># 省略 ...</span>

<span class="hljs-comment"># 6. 添加图例</span>
<span class="hljs-keyword">import</span> matplotlib.patches <span class="hljs-keyword">as</span> mpatches

legend_patches = []
<span class="hljs-comment"># 省略 ...</span>

plt.tight_layout(h_pad=<span class="hljs-number">5</span>)
plt.show()
</code></pre>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/396d9a8fd701488aa6e37db79120bcee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770083449&amp;x-signature=0ISHEtblp3IjjVCuC7i7GsPIhiI%3D" alt="" loading="lazy"/></p>
<p><strong>地平线图</strong>是空间利用大师。当你有 20 个股票或者 50 个城市的温度需要放在一张图里对比时，普通的面积图会挤成一团乱麻。</p>
<p><strong>地平线图</strong>可以将每个序列压缩成一个窄窄的横条，但在保持视觉分辨率的同时，还能让你看清极值（通过深颜色）。</p>
<h2 data-id="heading-2">3. 总结</h2>
<p>数据可视化不仅是科学，也是艺术。<strong>流图</strong>和<strong>地平线图</strong>这两种面积图变体，分别从**"流动之美"<strong>和</strong>"空间效率"**两个角度拓展了面积图的可能性。</p>
<p>它们证明了，通过对基础图表的创意改造，我们可以让数据讲述更丰富、更生动的故事。</p>
<p>下次当你面对时间序列数据时，不妨问问自己：我的数据像一条蜿蜒的河流，还是像地平线上的群山？选择适合的可视化方式，让你的数据真正"流动"起来或"层叠"起来。</p>
<p>记住，最好的可视化不是最复杂的，而是最能清晰传达信息、启发思考的那一个。</p>
<p>完整的代码共享在：<a href="https://link.juejin.cn?target=https%3A%2F%2Furl11.ctfile.com%2Ff%2F45455611-8635132430-f06d31%3Fp%3D6872" target="_blank" title="https://url11.ctfile.com/f/45455611-8635132430-f06d31?p=6872" ref="nofollow noopener noreferrer">面积图的2个变种.ipynb</a> (访问密码: 6872)</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[《从轮播图实现，学会如何观察页面的“渲染”与“合成”》（附 Performance 实测对比）》]]></title>    <link>https://juejin.cn/post/7599294170001178675</link>    <guid>https://juejin.cn/post/7599294170001178675</guid>    <pubDate>2026-01-26T11:28:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599294170001178675" data-draft-id="7598472744481652755" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="《从轮播图实现，学会如何观察页面的“渲染”与“合成”》（附 Performance 实测对比）》"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-26T11:28:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Flinton"/> <meta itemprop="url" content="https://juejin.cn/user/2225067266677640"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            《从轮播图实现，学会如何观察页面的“渲染”与“合成”》（附 Performance 实测对比）》
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2225067266677640/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Flinton
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T11:28:16.000Z" title="Mon Jan 26 2026 11:28:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>大家好，我是【小奇腾】，相信大家在前端的路上一定会遇到性能瓶颈的问题。可是谈了半天性能瓶颈，但是不知道怎么下手，也不知道从哪里开始。那么今天我和大家一起来探索这个奇妙的过程。也希望小伙伴一起支持加油下！！！</p>
</blockquote>
<p>本期详细的视频教程bilibili：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1dezvBWEm6%2F%3Fspm_id_from%3D333.1387.homepage.video_card.click%26vd_source%3D4213d38d889ea1581bbcae78a04cbd9d" target="_blank" title="https://www.bilibili.com/video/BV1dezvBWEm6/?spm_id_from=333.1387.homepage.video_card.click&amp;vd_source=4213d38d889ea1581bbcae78a04cbd9d" ref="nofollow noopener noreferrer">《从轮播图实现，学会如何观察页面的“渲染”与“合成”》（附 Performance 实测对比）》</a></p>
<h2 data-id="heading-0">一、 缘起：一个轮播图引发的思考</h2>













<table><thead><tr><th>需求</th><th>效果</th></tr></thead><tbody><tr><td>实现一个垂直轮播图，<br/>每隔 2 秒，图片向上滚动一次</td><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c821ad6444c42799d497f9e9ee7306b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmxpbnRvbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770031820&amp;x-signature=Tu5AawGe7ydHJaGEQs3xcFQtKyg%3D" width="100%" loading="lazy"/></td></tr></tbody></table>
<p>效果看起来差不多，但是性能却不一样,有两种实现方案：</p>
<ol>
<li><strong>直觉派</strong>：修改 <code>margin-top</code> 或者 <code>top</code> 属性，把图片“挤”上去。</li>
<li><strong>优化派</strong>：使用 CSS3 的 <code>transform: translateY</code>，把图片“移”上去。</li>
</ol>
<h2 data-id="heading-1">二、 选手入场：两种代码实现 (代码见 -&gt; 代码附录 最底部)</h2>
<p>为了控制变量，我准备了两个简单的 Demo，HTML 结构完全一致，唯独驱动动画的方式不同。</p>
<p><strong>方案 A：使用 Margin-top（低性能模拟）</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 修改 margin-top，触发文档流变化</span>
wrapper.<span class="hljs-property">style</span>.<span class="hljs-property">marginTop</span> = <span class="hljs-string">`<span class="hljs-subst">${offset}</span>px`</span>;
</code></pre>
<p><strong>方案 B：使用 Transform（高性能推荐）</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 修改 transform，开启硬件加速</span>
wrapper.<span class="hljs-property">style</span>.<span class="hljs-property">transform</span> = <span class="hljs-string">`translateY(<span class="hljs-subst">${offset}</span>px)`</span>;
</code></pre>
<p>接下来，我们用数据说话。</p>
<h2 data-id="heading-2">三、 第一关：视觉观测（Rendering 面板）</h2>
<p>Chrome 的开发者工具里隐藏着一个神器叫 <strong>Rendering（渲染）</strong> 。</p>
<blockquote>
<p><strong>如何打开</strong>：<code>F12</code> -&gt; <code>Cmd/Ctrl + Shift + P</code> -&gt; 输入 <code>Rendering</code> -&gt; 选择 <code>Show Rendering</code>。</p>
</blockquote>
<p>我勾选了 <strong>Paint flashing (突出显示绘制区域) / Enable automatic dark mode (暗黑模式)</strong> ，这个功能的作用是：<strong>只要页面上有像素被重绘，就闪烁绿色。</strong></p>













<table><thead><tr><th>设置</th><th>效果</th></tr></thead><tbody><tr><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2cbbeb8a49df4977b717287f24107b67~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmxpbnRvbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770031820&amp;x-signature=mNABdyaTqEkAR5QQxpNUKIzaK6A%3D" width="80%" loading="lazy"/></td><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d061de3e26aa4bb89391a08f4a8f72d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmxpbnRvbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770031820&amp;x-signature=GWsFzjuZ81kj9NkMkGRjx45r8s4%3D" width="100%" loading="lazy"/></td></tr></tbody></table>
<h3 data-id="heading-3">1. 观察 Margin-top 方案</h3>
<p>当图片滚动时，我被吓了一跳： <strong>（在此处插入你那张【有绿色大边框】的截图）</strong></p>
<p><strong>现象</strong>：每次轮播切换，整个容器甚至周边区域都疯狂闪烁绿光。</p>
<p><strong>结论</strong>：这说明浏览器在进行大面积的<strong>重绘 (Repaint)</strong> 。CPU 正在辛苦地重新计算每一个像素的颜色。</p>
<h3 data-id="heading-4">2. 观察 Transform 方案</h3>
<p>接着我切换到 Transform 写法： <strong>（在此处插入你那张【完全没有绿框】的截图）</strong></p>
<p><strong>现象</strong>：画面静如止水，图片在动，但没有绿光闪烁（或者只有极微小的区域）。</p>
<p><strong>结论</strong>：浏览器没有重绘！它偷懒了？不，它是变聪明了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d3df872392f49af8a390df3b9660e32~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmxpbnRvbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770031820&amp;x-signature=giGqriMxjS3gmlvY5U3nSVND368%3D" width="50%" loading="lazy"/> |</p>
<h3 data-id="heading-5">四、 第二关：深度扫描（Performance 面板）</h3>
<p>如果说绿光只是表象，那 Performance 面板就是“实锤”证据。我开启了 <strong>CPU 4x Slowdown</strong>（模拟低端设备），分别录制了两次滚动的过程。</p>
<h4 data-id="heading-6">1. 打开 CPU 4x slowdown</h4>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c76cf6fd46fa447c9dbd078ea104c73a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmxpbnRvbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770031820&amp;x-signature=EfcOnXhGQGhAVrxpCtqNG9jIztU%3D" width="100%" loading="lazy"/> 
<h4 data-id="heading-7">2. 打开 performance中的录制功能</h4>
<p>红色那个圆圈的就是录制按钮，录制7秒左右就可以了，然后点击stop，看结果</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6649f874f83434895afa0c023e4824c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmxpbnRvbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770031820&amp;x-signature=js0uiRSObgLIH67EUXlagwCTvFU%3D" width="100%" loading="lazy"/> 
<h4 data-id="heading-8">3. 关键看 Main 的部份</h4>
<ol>
<li>观察 Margin-top 方案</li>
</ol>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/69337f092b3a4a159ee83903abc4092e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmxpbnRvbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770031820&amp;x-signature=irPoLOEvsYuxcLpoLkJuPifwJn0%3D" width="100%" loading="lazy"/> 
<p>大家看上图的 <strong>Main (主线程)</strong> 区域：</p>
<ul>
<li>在Main的部份圈红色的 密密麻麻的“绿色波峰”是什么？鼠标放上去，全是 <strong>Layout (布局)</strong> / <strong>Update Layer Tree</strong> / <strong>Paint</strong>。</li>
<li>因为修改 <code>margin</code> 会改变元素的几何位置，浏览器必须重新计算布局（Reflow），这会阻塞主线程。</li>
</ul>
<ol start="2">
<li>观察 Transform 方案</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02d3336338b944a69dacf0d8bfad2202~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmxpbnRvbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770031820&amp;x-signature=eMhIicXBn%2FHQzhh3tnTlgd0Vrhg%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>Main 线程几乎是一条直线！</li>
<li>没有 Layout，没有 Paint，只有零星的动画帧触发。</li>
<li>这是因为 <code>transform</code> 将元素提升为了<strong>合成层 (Composite Layer)</strong> ，动画的平移工作直接交给了 <strong>GPU</strong> 处理，主线程完全解放了出来。</li>
</ul>
<p>关于性能更多内容(<code>顶部的视频链接</code>)有具体的演示.</p>
<h2 data-id="heading-9">五、 总结：为什么 Transform 性能更好？</h2>
<p>通过这次观测，我们验证了浏览器渲染流水线的核心差异：</p>



































<table><thead><tr><th><strong>维度</strong></th><th><strong>Margin-top / Top</strong></th><th><strong>Transform</strong></th></tr></thead><tbody><tr><td><strong>触发机制</strong></td><td>修改几何属性</td><td>修改合成属性</td></tr><tr><td><strong>重排 (Reflow)</strong></td><td>✅ <strong>触发</strong> (计算布局，最慢)</td><td>❌ <strong>不触发</strong></td></tr><tr><td><strong>重绘 (Repaint)</strong></td><td>✅ <strong>触发</strong> (重新画像素，慢)</td><td>❌ <strong>不触发</strong></td></tr><tr><td><strong>执行位置</strong></td><td>CPU (主线程)</td><td>GPU (合成线程)</td></tr><tr><td><strong>性能表现</strong></td><td>容易卡顿</td><td>丝滑流畅</td></tr></tbody></table>
<p><strong>简单理解</strong>：</p>
<ul>
<li>
<p><strong>Margin-top</strong> 就像是你要搬家，你把房子拆了（Reflow），然后再一块块砖砌到新位置（Repaint）。</p>
</li>
<li>
<p><strong>Transform</strong> 就像是你拍了一张房子的照片，然后用幻灯片把这张照片投影到新位置。房子没动，只是投影动了，所以极快。</p>
</li>
</ul>
<h2 data-id="heading-10">六、代码附录</h2>
<h3 data-id="heading-11">1. Margin-Top方案（低性能）</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>垂直轮播图演示 - Margin-Top方案（低性能）<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        * { <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>; <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>; <span class="hljs-attribute">box-sizing</span>: border-box; }
        <span class="hljs-selector-tag">body</span> { <span class="hljs-attribute">display</span>: flex; <span class="hljs-attribute">justify-content</span>: center; <span class="hljs-attribute">align-items</span>: center; <span class="hljs-attribute">height</span>: <span class="hljs-number">100vh</span>; <span class="hljs-attribute">background</span>: <span class="hljs-number">#f0f2f5</span>; }

        <span class="hljs-selector-class">.viewport</span> {
            <span class="hljs-attribute">width</span>: <span class="hljs-number">300px</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>;
            <span class="hljs-attribute">border</span>: <span class="hljs-number">5px</span> solid <span class="hljs-number">#333</span>;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">10px</span>;
            <span class="hljs-attribute">overflow</span>: hidden;
            <span class="hljs-attribute">position</span>: relative;
            <span class="hljs-attribute">background</span>: <span class="hljs-number">#fff</span>;
            <span class="hljs-comment">/* 注意：这里不需要 will-change 了，因为我们就是在模拟没有优化的情况 */</span>
        }

        <span class="hljs-selector-class">.wrapper</span> {
            <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
            <span class="hljs-comment">/* ❌ 性能杀手：这里我们要改变 margin-top */</span>
            <span class="hljs-comment">/* 浏览器必须重新计算布局，因为 margin 改变会影响文档流 */</span>
            <span class="hljs-attribute">transition</span>: margin-top <span class="hljs-number">0.5s</span> ease-in-out; 
        }

        <span class="hljs-selector-class">.slide</span> {
            <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>;
            <span class="hljs-attribute">display</span>: flex;
            <span class="hljs-attribute">justify-content</span>: center;
            <span class="hljs-attribute">align-items</span>: center;
            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">40px</span>;
            <span class="hljs-attribute">color</span>: white;
            <span class="hljs-attribute">font-weight</span>: bold;
        }

        <span class="hljs-selector-class">.slide</span><span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-number">1</span>) { <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#FF5733</span>; }
        <span class="hljs-selector-class">.slide</span><span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-number">2</span>) { <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#33FF57</span>; }
        <span class="hljs-selector-class">.slide</span><span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-number">3</span>) { <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#3357FF</span>; }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"viewport"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"wrapper"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"slide"</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"slide"</span>&gt;</span>2<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"slide"</span>&gt;</span>3<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">const</span> wrapper = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.wrapper'</span>);
        <span class="hljs-keyword">const</span> imgHeight = <span class="hljs-number">200</span>; 
        <span class="hljs-keyword">const</span> totalSlides = <span class="hljs-number">3</span>; 
        <span class="hljs-keyword">let</span> currentIndex = <span class="hljs-number">0</span>;

        <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
            currentIndex++;
            <span class="hljs-keyword">if</span> (currentIndex &gt;= totalSlides) {
                currentIndex = <span class="hljs-number">0</span>;
            }

            <span class="hljs-keyword">const</span> offset = -(currentIndex * imgHeight);

            <span class="hljs-comment">// ❌ 核心区别在这里：</span>
            <span class="hljs-comment">// 我们修改的是 marginTop，而不是 transform</span>
            <span class="hljs-comment">// 这会触发布局重排 (Reflow)</span>
            wrapper.<span class="hljs-property">style</span>.<span class="hljs-property">marginTop</span> = <span class="hljs-string">`<span class="hljs-subst">${offset}</span>px`</span>;

            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`当前使用 margin-top 偏移: <span class="hljs-subst">${offset}</span>px`</span>);

        }, <span class="hljs-number">2000</span>);
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h3 data-id="heading-12">2. Transform方案 (性能好)</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>垂直轮播图演示 - Transform方案<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        <span class="hljs-comment">/* 简单的重置 */</span>
        * { <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>; <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>; <span class="hljs-attribute">box-sizing</span>: border-box; }
        <span class="hljs-selector-tag">body</span> { <span class="hljs-attribute">display</span>: flex; <span class="hljs-attribute">justify-content</span>: center; <span class="hljs-attribute">align-items</span>: center; <span class="hljs-attribute">height</span>: <span class="hljs-number">100vh</span>; <span class="hljs-attribute">background</span>: <span class="hljs-number">#f0f2f5</span>; }

        <span class="hljs-comment">/* 1. 视口：固定高度，像一个相框 */</span>
        <span class="hljs-selector-class">.viewport</span> {
            <span class="hljs-attribute">width</span>: <span class="hljs-number">300px</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>; <span class="hljs-comment">/* 视口高度 */</span>
            <span class="hljs-attribute">border</span>: <span class="hljs-number">5px</span> solid <span class="hljs-number">#333</span>;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">10px</span>;
            <span class="hljs-attribute">overflow</span>: hidden; <span class="hljs-comment">/* 关键：把超出的部分切掉 */</span>
            <span class="hljs-attribute">position</span>: relative;
            <span class="hljs-attribute">background</span>: <span class="hljs-number">#fff</span>;
            <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">10px</span> <span class="hljs-number">20px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.1</span>);
        }

        <span class="hljs-comment">/* 2. 渲染层/包裹层：用来移动的长条 */</span>
        <span class="hljs-selector-class">.wrapper</span> {
            <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
            <span class="hljs-comment">/* 这里不需要设置高度，内容撑开即可 */</span>
            
            <span class="hljs-comment">/* 关键性能优化：过渡动画 */</span>
            <span class="hljs-attribute">transition</span>: transform <span class="hljs-number">0.5s</span> ease-in-out; 
            <span class="hljs-comment">/* 提示浏览器开启 GPU 加速 */</span>
            <span class="hljs-attribute">will-change</span>: transform;
        }

        <span class="hljs-comment">/* 3. 图片样式：为了演示方便，我用带颜色的div代替图片 */</span>
        <span class="hljs-selector-class">.slide</span> {
            <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>; <span class="hljs-comment">/* 必须和视口高度一致 */</span>
            <span class="hljs-attribute">display</span>: flex;
            <span class="hljs-attribute">justify-content</span>: center;
            <span class="hljs-attribute">align-items</span>: center;
            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">40px</span>;
            <span class="hljs-attribute">color</span>: white;
            <span class="hljs-attribute">font-weight</span>: bold;
        }

        <span class="hljs-selector-class">.slide</span><span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-number">1</span>) { <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#FF5733</span>; } <span class="hljs-comment">/* 红 */</span>
        <span class="hljs-selector-class">.slide</span><span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-number">2</span>) { <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#33FF57</span>; } <span class="hljs-comment">/* 绿 */</span>
        <span class="hljs-selector-class">.slide</span><span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-number">3</span>) { <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#3357FF</span>; } <span class="hljs-comment">/* 蓝 */</span>
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"viewport"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"wrapper"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"slide"</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"slide"</span>&gt;</span>2<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"slide"</span>&gt;</span>3<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">const</span> wrapper = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.wrapper'</span>);
        <span class="hljs-keyword">const</span> imgHeight = <span class="hljs-number">200</span>; <span class="hljs-comment">// 单张图片高度</span>
        <span class="hljs-keyword">const</span> totalSlides = <span class="hljs-number">3</span>; 
        <span class="hljs-keyword">let</span> currentIndex = <span class="hljs-number">0</span>;

        <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
            <span class="hljs-comment">// 1. 逻辑计算：下一次是第几张？</span>
            currentIndex++;
            
            <span class="hljs-comment">// 简单的回滚逻辑：如果到底了，就瞬间跳回第一张</span>
            <span class="hljs-keyword">if</span> (currentIndex &gt;= totalSlides) {
                currentIndex = <span class="hljs-number">0</span>;
            }

            <span class="hljs-comment">// 2. 核心计算：偏移量 = 索引 * 单张高度</span>
            <span class="hljs-comment">// 加上负号是因为由于坐标系原点在左上角，往上移动是负方向</span>
            <span class="hljs-keyword">const</span> offset = -(currentIndex * imgHeight);

            <span class="hljs-comment">// 3. 渲染：应用 Transform</span>
            <span class="hljs-comment">// 注意：这里完全没有用到 scrollTop，只用了数学计算</span>
            wrapper.<span class="hljs-property">style</span>.<span class="hljs-property">transform</span> = <span class="hljs-string">`translateY(<span class="hljs-subst">${offset}</span>px)`</span>;
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`当前索引: <span class="hljs-subst">${currentIndex}</span>, 偏移量: <span class="hljs-subst">${offset}</span>px`</span>);

        }, <span class="hljs-number">2000</span>);
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React useDeferredValue 详解：让你的应用丝滑流畅的秘密]]></title>    <link>https://juejin.cn/post/7599294170001326131</link>    <guid>https://juejin.cn/post/7599294170001326131</guid>    <pubDate>2026-01-26T11:59:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599294170001326131" data-draft-id="7599450177058193418" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React useDeferredValue 详解：让你的应用丝滑流畅的秘密"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2026-01-26T11:59:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="代码诗人卡尔"/> <meta itemprop="url" content="https://juejin.cn/user/2067500101533902"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React useDeferredValue 详解：让你的应用丝滑流畅的秘密
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2067500101533902/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    代码诗人卡尔
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T11:59:45.000Z" title="Mon Jan 26 2026 11:59:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、从一个常见的卡顿场景说起</h2>
<p>做前端的同学，肯定都遇到过这样的场景：一个搜索框，下面跟着一个长长的列表。用户在搜索框里每敲一个字，列表就根据输入的内容进行过滤。如果列表数据量不大，那还好说。但如果列表有成百上千条数据，那场面就有点尴尬了——用户每输入一个字，页面就卡一下，感觉就像在放慢动作的幻灯片。</p>
<p>这种体验，用户不爽，我们开发者看着也难受。问题出在哪儿呢？</p>
<p>很简单，因为每一次输入，都触发了 React 的重新渲染。而每一次重新渲染，都要遍历整个长列表，进行过滤和展示。浏览器扛不住这么高频率的计算，自然就卡了。</p>
<h2 data-id="heading-1">二、一个不那么完美的解决方案</h2>
<p>遇到这种问题，很多同学的第一反应是：用 <code>debounce</code>（防抖）或 <code>throttle</code>（节流）啊！</p>
<p>确实，这是一个很常见的优化手段。我们可以设置一个延迟，比如 200 毫秒，等用户停止输入 200 毫秒后，再进行列表的过滤和渲染。这样确实能减少渲染次数，缓解卡顿。</p>
<p>但这个方案并不完美。为什么呢？</p>
<ol>
<li><strong>延迟时间的设置很玄学</strong>：200 毫秒对于高性能的电脑来说，可能太长了，用户会感觉有明显的延迟；对于低性能的手机来说，可能又太短了，依然会卡顿。你很难找到一个适合所有设备的完美延迟时间。</li>
<li><strong>体验上还是有点怪</strong>：用户会发现，输入框里的文字已经变了，但下面的列表却没反应，要等一下才会更新。这种“脱节”的感觉，总让人觉得有点不自然。</li>
</ol>
<p>那么，有没有更好的办法呢？</p>
<h2 data-id="heading-2">三、主角登场：<code>useDeferredValue</code></h2>
<p>React 18 给我们带来了一个新式武器：<code>useDeferredValue</code>。这个 Hook 可以说是专门为了解决这类问题而生的。</p>
<p>它的核心思想很简单：<strong>允许我们把一个值的更新推迟（defer）到不那么紧急的时候再进行</strong>。</p>
<p>换句话说，它会给我们一个“延迟”版本的值。这个延迟版本的值，会在浏览器空闲的时候，才更新到最新状态。</p>
<p>让我们来看代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useState, useDeferredValue } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [query, setQuery] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>);
  <span class="hljs-keyword">const</span> deferredQuery = <span class="hljs-title function_">useDeferredValue</span>(query);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
        <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> 
        <span class="hljs-attr">value</span>=<span class="hljs-string">{query}</span> 
        <span class="hljs-attr">onChange</span>=<span class="hljs-string">{e</span> =&gt;</span> setQuery(e.target.value)} 
      /&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">SlowList</span> <span class="hljs-attr">text</span>=<span class="hljs-string">{deferredQuery}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>看到没，我们把 <code>query</code> 这个 state 传给了 <code>useDeferredValue</code>，得到了一个新的变量 <code>deferredQuery</code>。然后，我们把 <code>deferredQuery</code> 传给了那个很慢的列表组件 <code>&lt;SlowList&gt;</code>。</p>
<p>这里发生了什么神奇的事情呢？</p>
<ol>
<li>当用户在输入框里输入时，<code>query</code> 的值会立刻更新。</li>
<li><code>App</code> 组件会立刻重新渲染。</li>
<li>但是，<code>deferredQuery</code> 的值并不会立刻变成最新的 <code>query</code>。它会保持上一次的值。</li>
<li>React 会先用旧的 <code>deferredQuery</code> 渲染一次 <code>&lt;SlowList&gt;</code>。因为 props 没有变，如果 <code>&lt;SlowList&gt;</code> 被 <code>React.memo</code> 包裹了，它就不会重新渲染，UI 也就不会卡顿。</li>
<li>然后，React 会在后台启动一个低优先级的渲染，把 <code>deferredQuery</code> 更新到最新的 <code>query</code>。</li>
<li>如果在这个低优先级渲染完成之前，用户又输入了新的内容，React 就会中断这次渲染，重新开始一个新的高优先级渲染（只更新输入框），然后再安排一个新的低优先级渲染（更新列表）。</li>
</ol>
<p>这样一来，用户的输入操作永远是最高优先级的，输入框的响应会非常快，非常丝滑。而那个耗时的列表渲染，则被推迟到了浏览器不忙的时候再进行，不会阻塞用户的操作。</p>
<h2 data-id="heading-3">四、两个需要注意的地方</h2>
<h3 data-id="heading-4"><code>React.memo</code> 或 <code>useMemo</code></h3>
<p><code>useDeferredValue</code> 的威力，需要和 <code>React.memo</code> 或 <code>useMemo</code> 配合才能完全发挥出来。</p>
<p>如果你的慢组件没有用 <code>React.memo</code> 包裹，那即使 <code>deferredQuery</code> 还是旧的值，组件也还是会重新渲染，那就白搭了。</p>
<p><strong>方案一：使用 <code>React.memo</code></strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">SlowList</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">memo</span>(<span class="hljs-keyword">function</span> <span class="hljs-title function_">SlowList</span>(<span class="hljs-params">{ text }</span>) {
  <span class="hljs-comment">// ... 耗时的列表渲染逻辑</span>
});
</code></pre>
<p><strong>方案二：使用 <code>useMemo</code></strong></p>
<p>如果你不想单独抽离一个组件，也可以用 <code>useMemo</code> 来缓存渲染结果：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [query, setQuery] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>);
  <span class="hljs-keyword">const</span> deferredQuery = <span class="hljs-title function_">useDeferredValue</span>(query);

  <span class="hljs-keyword">const</span> slowList = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">SlowList</span> <span class="hljs-attr">text</span>=<span class="hljs-string">{deferredQuery}</span> /&gt;</span></span>;
  }, [deferredQuery]);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
        <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> 
        <span class="hljs-attr">value</span>=<span class="hljs-string">{query}</span> 
        <span class="hljs-attr">onChange</span>=<span class="hljs-string">{e</span> =&gt;</span> setQuery(e.target.value)} 
      /&gt;
      {slowList}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>这样，只有当 <code>deferredQuery</code> 变化时，<code>&lt;SlowList&gt;</code> 才会重新渲染。</p>
<h2 data-id="heading-5">五、给用户一个加载提示</h2>
<p><code>useDeferredValue</code> 还有一个很贴心的功能：我们可以通过比较原始值和延迟值是否相等，来判断那个慢的更新是否还在“路上”。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> isStale = query !== deferredQuery;

<span class="hljs-keyword">return</span> (
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
      <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> 
      <span class="hljs-attr">value</span>=<span class="hljs-string">{query}</span> 
      <span class="hljs-attr">onChange</span>=<span class="hljs-string">{e</span> =&gt;</span> setQuery(e.target.value)} 
    /&gt;
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">opacity:</span> <span class="hljs-attr">isStale</span> ? <span class="hljs-attr">0.5</span> <span class="hljs-attr">:</span> <span class="hljs-attr">1</span> }}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">SlowList</span> <span class="hljs-attr">text</span>=<span class="hljs-string">{deferredQuery}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
);
</code></pre>
<p>当 <code>query</code> 和 <code>deferredQuery</code> 不相等时，就说明列表的更新正在被延迟。这时候，我们可以给列表一个半透明的样式，或者显示一个 loading 图标，告诉用户：“别急，马上就来！”</p>
<h2 data-id="heading-6">六、总结一下</h2>
<p><code>useDeferredValue</code> 是一个非常强大的性能优化工具，它让我们能够优雅地处理那些“高优先级”和“低优先级”的渲染任务，让应用在各种设备上都能保持流畅的交互体验。</p>
<p>下次再遇到类似的卡顿问题时，不妨试试 <code>useDeferredValue</code>。它可能会给你带来意想不到的惊喜。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大文件分片上传实战：Vue3 + NestJS 实现秒传、断点续传、并发与失败重试（附完整代码）]]></title>    <link>https://juejin.cn/post/7599543345980637211</link>    <guid>https://juejin.cn/post/7599543345980637211</guid>    <pubDate>2026-01-26T12:14:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599543345980637211" data-draft-id="7599528186587054090" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大文件分片上传实战：Vue3 + NestJS 实现秒传、断点续传、并发与失败重试（附完整代码）"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2026-01-26T12:14:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="hypoy"/> <meta itemprop="url" content="https://juejin.cn/user/3074670624777223"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大文件分片上传实战：Vue3 + NestJS 实现秒传、断点续传、并发与失败重试（附完整代码）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3074670624777223/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    hypoy
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T12:14:38.000Z" title="Mon Jan 26 2026 12:14:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    18
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">大文件分片上传实战：Vue3 + NestJS 实现秒传、断点续传、并发与失败重试（附完整代码）</h2>
<p>最近在回顾项目里“大文件上传”相关的实现，顺手把大文件 <strong>分片上传</strong> 这一块重新整理了一遍。实际踩过坑之后会发现，上传并不是“选文件 → 发请求”这么简单：文件越大，越容易遇到网络抖动导致失败、页面刷新后进度丢失、失败后只能重传、重复上传浪费带宽，以及单请求上传速度慢且不可控等问题。</p>
<p>因此这次复盘里，把上传流程拆成了一条更可控的链路：先用 <strong>hash</strong> 作为文件唯一指纹，支持 <strong>秒传</strong> 与 <strong>断点续传</strong>；再把文件按固定大小进行 <strong>切片</strong>，配合 <strong>并发上传</strong> 提升吞吐，遇到失败则通过 <strong>指数退避重试</strong> 提高弱网场景下的成功率；最后由服务端按序 <strong>合并分片并清理临时文件</strong>，形成完整闭环。基于这套思路，实现了一套大文件分片上传方案，核心能力包括：</p>
<ul>
<li><strong>文件分片</strong>：默认 5MB（可配置）</li>
<li><strong>Hash 指纹</strong>：使用 SparkMD5，并放到 Web Worker 里计算，避免阻塞 UI</li>
<li><strong>并发上传</strong>：默认 3 并发</li>
<li><strong>失败重试</strong>：默认 3 次，指数退避</li>
<li><strong>断点续传</strong>：服务端返回已上传分片列表，前端跳过已完成分片</li>
<li><strong>秒传</strong>：服务端已存在相同 hash 的文件时直接返回成功</li>
<li><strong>安全合并</strong>：服务端按序合并并清理临时分片目录</li>
</ul>
<p>技术栈：</p>
<ul>
<li>前端：Vue 3 + TypeScript + Vite</li>
<li>后端：NestJS + TypeScript</li>
<li>Hash：SparkMD5（Web Worker）</li>
</ul>
<hr/>
<h3 data-id="heading-1">1. 整体流程与接口设计</h3>
<p>整个系统围绕四个接口构建：</p>






























<table><thead><tr><th>端点</th><th>方法</th><th>功能</th></tr></thead><tbody><tr><td><code>/upload/check</code></td><td>POST</td><td>秒传检测：是否已存在同 hash 文件</td></tr><tr><td><code>/upload/chunks</code></td><td>GET</td><td>查询已上传分片：断点续传的基础</td></tr><tr><td><code>/upload/chunk</code></td><td>POST</td><td>上传单个分片</td></tr><tr><td><code>/upload/merge</code></td><td>POST</td><td>合并分片并返回最终文件 URL</td></tr></tbody></table>
<p>上传时序：</p>
<ol>
<li>选择文件</li>
<li>Web Worker 计算文件 hash</li>
<li>秒传检测：命中则直接成功</li>
<li>查询已上传分片：断点续传</li>
<li>5MB 切片</li>
<li>并发上传未完成分片（默认 3）</li>
<li>请求合并</li>
<li>返回文件访问地址</li>
</ol>
<hr/>
<h3 data-id="heading-2">2. 前端：API 封装（api.ts）</h3>
<h4 data-id="heading-3">2.1 环境配置：开发直连、生产走反代</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">BASE_URL</span> = <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">PROD</span> ? <span class="hljs-string">''</span> : <span class="hljs-string">'http://localhost:3000'</span>;
</code></pre>
<ul>
<li>开发环境直接请求后端 <code>3000</code></li>
<li>生产环境使用相对路径，交给 Nginx 反向代理转发</li>
</ul>
<h4 data-id="heading-4">2.2 秒传检测：checkFile</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">checkFile</span>(<span class="hljs-params">hash: <span class="hljs-built_in">string</span>, filename: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`<span class="hljs-subst">${BASE_URL}</span>/upload/check`</span>, {
    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
    <span class="hljs-attr">headers</span>: { <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span> },
    <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ hash, filename }),
  });
  <span class="hljs-keyword">return</span> response.<span class="hljs-title function_">json</span>();
}
</code></pre>
<p>服务端如果已有同 hash 文件，会返回 <code>{ exists: true, url }</code>，前端可以直接结束上传流程。</p>
<h4 data-id="heading-5">2.3 断点续传：getUploadedChunks</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getUploadedChunks</span>(<span class="hljs-params">hash: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`<span class="hljs-subst">${BASE_URL}</span>/upload/chunks?hash=<span class="hljs-subst">${hash}</span>`</span>);
  <span class="hljs-keyword">return</span> response.<span class="hljs-title function_">json</span>();
}
</code></pre>
<p>该接口返回已上传的分片索引数组，前端据此跳过已完成分片，继续上传剩余部分。</p>
<h4 data-id="heading-6">2.4 分片上传：uploadChunk（XHR 支持进度）</h4>
<p>为了拿到上传进度，分片上传使用 <code>XMLHttpRequest</code>：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">uploadChunk</span>(<span class="hljs-params">hash, chunkIndex, chunk, filename, onProgress?</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> formData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormData</span>();
    formData.<span class="hljs-title function_">append</span>(<span class="hljs-string">'hash'</span>, hash);
    formData.<span class="hljs-title function_">append</span>(<span class="hljs-string">'chunkIndex'</span>, <span class="hljs-title class_">String</span>(chunkIndex));
    formData.<span class="hljs-title function_">append</span>(<span class="hljs-string">'filename'</span>, filename);
    formData.<span class="hljs-title function_">append</span>(<span class="hljs-string">'file'</span>, chunk);

    <span class="hljs-keyword">const</span> xhr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();
    xhr.<span class="hljs-title function_">open</span>(<span class="hljs-string">'POST'</span>, <span class="hljs-string">`<span class="hljs-subst">${BASE_URL}</span>/upload/chunk`</span>);

    xhr.<span class="hljs-property">upload</span>.<span class="hljs-property">onprogress</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (event.<span class="hljs-property">lengthComputable</span> &amp;&amp; onProgress) {
        <span class="hljs-title function_">onProgress</span>(event.<span class="hljs-property">loaded</span>, event.<span class="hljs-property">total</span>);
      }
    };

    xhr.<span class="hljs-property">onload</span> = <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">if</span> (xhr.<span class="hljs-property">status</span> &gt;= <span class="hljs-number">200</span> &amp;&amp; xhr.<span class="hljs-property">status</span> &lt; <span class="hljs-number">300</span>) {
        <span class="hljs-title function_">resolve</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(xhr.<span class="hljs-property">responseText</span>));
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Upload failed with status <span class="hljs-subst">${xhr.status}</span>`</span>));
      }
    };

    xhr.<span class="hljs-property">onerror</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Network error'</span>));
    xhr.<span class="hljs-title function_">send</span>(formData);
  });
}
</code></pre>
<h4 data-id="heading-7">2.5 合并分片：mergeChunks</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">mergeChunks</span>(<span class="hljs-params">hash: <span class="hljs-built_in">string</span>, filename: <span class="hljs-built_in">string</span>, totalChunks: <span class="hljs-built_in">number</span></span>) {
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`<span class="hljs-subst">${BASE_URL}</span>/upload/merge`</span>, {
    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
    <span class="hljs-attr">headers</span>: { <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span> },
    <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ hash, filename, totalChunks }),
  });
  <span class="hljs-keyword">return</span> response.<span class="hljs-title function_">json</span>();
}
</code></pre>
<hr/>
<h3 data-id="heading-8">3. 前端：Worker 计算 Hash（hash-worker.ts）</h3>
<p>大文件 MD5 的计算如果放在主线程，会造成明显卡顿。为了解决这个问题，采用 Web Worker 在后台分块读取文件并计算 SparkMD5。</p>
<p>Worker 内部按 2MB 分块计算：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> <span class="hljs-title class_">SparkMD5</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'spark-md5'</span>;

self.<span class="hljs-property">onmessage</span> = <span class="hljs-keyword">async</span> (<span class="hljs-attr">e</span>: <span class="hljs-title class_">MessageEvent</span>&lt;<span class="hljs-title class_">File</span>&gt;) =&gt; {
  <span class="hljs-keyword">const</span> file = e.<span class="hljs-property">data</span>;
  <span class="hljs-keyword">const</span> chunkSize = <span class="hljs-number">2</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;
  <span class="hljs-keyword">const</span> chunks = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">ceil</span>(file.<span class="hljs-property">size</span> / chunkSize);
  <span class="hljs-keyword">const</span> spark = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SparkMD5</span>.<span class="hljs-title class_">ArrayBuffer</span>();

  <span class="hljs-keyword">let</span> currentChunk = <span class="hljs-number">0</span>;

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">loadNext</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> start = currentChunk * chunkSize;
    <span class="hljs-keyword">const</span> end = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(start + chunkSize, file.<span class="hljs-property">size</span>);
    <span class="hljs-keyword">const</span> reader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileReader</span>();

    reader.<span class="hljs-property">onload</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (event.<span class="hljs-property">target</span>?.<span class="hljs-property">result</span>) {
        spark.<span class="hljs-title function_">append</span>(event.<span class="hljs-property">target</span>.<span class="hljs-property">result</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">ArrayBuffer</span>);
      }
      currentChunk++;

      self.<span class="hljs-title function_">postMessage</span>({
        <span class="hljs-attr">type</span>: <span class="hljs-string">'progress'</span>,
        <span class="hljs-attr">progress</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>((currentChunk / chunks) * <span class="hljs-number">100</span>),
      });

      <span class="hljs-keyword">if</span> (currentChunk &lt; chunks) {
        <span class="hljs-title function_">loadNext</span>();
      } <span class="hljs-keyword">else</span> {
        self.<span class="hljs-title function_">postMessage</span>({
          <span class="hljs-attr">type</span>: <span class="hljs-string">'complete'</span>,
          <span class="hljs-attr">hash</span>: spark.<span class="hljs-title function_">end</span>(),
        });
      }
    };

    reader.<span class="hljs-property">onerror</span> = <span class="hljs-function">() =&gt;</span> {
      self.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'error'</span>, <span class="hljs-attr">error</span>: <span class="hljs-string">'Failed to read file'</span> });
    };

    reader.<span class="hljs-title function_">readAsArrayBuffer</span>(file.<span class="hljs-title function_">slice</span>(start, end));
  };

  <span class="hljs-title function_">loadNext</span>();
};

<span class="hljs-keyword">export</span> {};
</code></pre>
<p>主线程侧通过 <code>calculateHash()</code> 监听 <code>progress / complete / error</code> 三种消息，实现 hash 进度展示与结果回传。</p>
<hr/>
<h3 data-id="heading-9">4. 前端：上传引擎（uploader.ts）</h3>
<p>上传引擎负责把“hash → 秒传 → 断点 → 并发 → 重试 → 合并”的全流程串起来，同时以统一的 <code>UploadProgress</code> 对外输出进度。</p>
<h4 data-id="heading-10">4.1 进度结构：UploadProgress</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-attr">status</span>: <span class="hljs-string">'hashing'</span> | <span class="hljs-string">'checking'</span> | <span class="hljs-string">'uploading'</span> | <span class="hljs-string">'merging'</span> | <span class="hljs-string">'success'</span> | <span class="hljs-string">'error'</span>
percentage, uploadedChunks, totalChunks, uploadedBytes, totalBytes, message
</code></pre>
<p>组件只需要订阅 <code>onProgress</code>，无需关心内部实现细节。</p>
<h4 data-id="heading-11">4.2 文件分片：sliceFile</h4>
<p>默认分片大小为 5MB（可配置）：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DEFAULT_CHUNK_SIZE</span> = <span class="hljs-number">5</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;
</code></pre>
<p>分片函数：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> <span class="hljs-title function_">sliceFile</span>(<span class="hljs-params">file: File, chunkSize: <span class="hljs-built_in">number</span></span>): <span class="hljs-title class_">Blob</span>[] {
  <span class="hljs-keyword">const</span> <span class="hljs-attr">chunks</span>: <span class="hljs-title class_">Blob</span>[] = [];
  <span class="hljs-keyword">let</span> start = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">while</span> (start &lt; file.<span class="hljs-property">size</span>) {
    <span class="hljs-keyword">const</span> end = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(start + chunkSize, file.<span class="hljs-property">size</span>);
    chunks.<span class="hljs-title function_">push</span>(file.<span class="hljs-title function_">slice</span>(start, end));
    start = end;
  }
  <span class="hljs-keyword">return</span> chunks;
}
</code></pre>
<h4 data-id="heading-12">4.3 单分片失败重试：指数退避</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">uploadChunkWithRetry</span>(<span class="hljs-params">hash, chunkIndex, chunk, filename, maxRetries</span>) {
  <span class="hljs-keyword">let</span> <span class="hljs-attr">lastError</span>: <span class="hljs-title class_">Error</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> attempt = <span class="hljs-number">0</span>; attempt &lt;= maxRetries; attempt++) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">uploadChunk</span>(hash, chunkIndex, chunk, filename);
      <span class="hljs-keyword">return</span>;
    } <span class="hljs-keyword">catch</span> (error) {
      lastError = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">Error</span>;
      <span class="hljs-keyword">if</span> (attempt &lt; maxRetries) {
        <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(<span class="hljs-number">2</span>, attempt) * <span class="hljs-number">1000</span>));
      }
    }
  }
  <span class="hljs-keyword">throw</span> lastError;
}
</code></pre>
<h4 data-id="heading-13">4.4 并发上传：runConcurrent</h4>
<p>并发控制默认 3：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DEFAULT_CONCURRENCY</span> = <span class="hljs-number">3</span>;
</code></pre>
<p>并发调度逻辑按任务队列执行，同时限制最大并行数。</p>
<h4 data-id="heading-14">4.5 主流程：uploadFile</h4>
<p>上传入口 <code>uploadFile()</code> 按照以下顺序执行：</p>
<ol>
<li>计算 hash（Worker）</li>
<li>秒传检测（存在则直接返回）</li>
<li>获取已上传分片列表（断点续传）</li>
<li>切片并过滤掉已存在分片</li>
<li>并发上传剩余分片（失败自动重试）</li>
<li>合并分片</li>
<li>返回最终文件 URL</li>
</ol>
<p>此外，已上传的字节数会根据已存在分片提前累加，让断点续传的进度展示更准确。</p>
<hr/>
<h3 data-id="heading-15">5. 前端 UI：Hy-Upload.vue</h3>
<p>组件层提供了较完整的上传体验：</p>
<ul>
<li>点击选择文件 / 拖拽上传</li>
<li>自动上传（autoUpload）</li>
<li>上传状态图标与提示文案</li>
<li>进度条与百分比展示</li>
<li>上传成功展示 URL</li>
<li>失败后支持一键重置重新上传</li>
</ul>
<p>组件内部不关心上传细节，只需要调用 <code>uploadFile()</code> 并把进度回传即可。</p>
<hr/>
<h3 data-id="heading-16">6. 后端：NestJS 分片存储与合并</h3>
<p>后端使用 <code>UploadController</code> + <code>UploadService</code> 实现分片落盘、断点查询、最终合并与清理。</p>
<h4 data-id="heading-17">6.1 接收分片：/upload/chunk</h4>
<p>使用 multer 先存入临时目录：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-meta">@UseInterceptors</span>(<span class="hljs-title class_">FileInterceptor</span>(<span class="hljs-string">'file'</span>, { <span class="hljs-attr">dest</span>: <span class="hljs-string">'uploads/temp'</span> }))
</code></pre>
<p>然后移动到分片目录：</p>
<pre><code class="hljs language-bash" lang="bash">uploads/chunks/{<span class="hljs-built_in">hash</span>}/{chunkIndex}
</code></pre>
<h4 data-id="heading-18">6.2 秒传：/upload/check</h4>
<p>最终文件路径采用 <code>hash + ext</code> 的方式生成：</p>
<pre><code class="hljs language-bash" lang="bash">uploads/{<span class="hljs-built_in">hash</span>}{ext}
</code></pre>
<p>如果文件存在，返回可访问 URL：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">return</span> { <span class="hljs-attr">exists</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">url</span>: <span class="hljs-string">`/uploads/<span class="hljs-subst">${hash}</span><span class="hljs-subst">${ext}</span>`</span> };
</code></pre>
<h4 data-id="heading-19">6.3 断点续传：/upload/chunks</h4>
<p>读取 <code>uploads/chunks/{hash}</code> 目录下已有分片文件名，转成 index 数组返回，供前端跳过已完成分片。</p>
<h4 data-id="heading-20">6.4 合并：/upload/merge</h4>
<p>合并前会校验：</p>
<ul>
<li>分片数量是否完整</li>
<li>是否缺少某个分片（0..totalChunks-1）</li>
</ul>
<p>合并成功后清理 chunk 目录，返回最终 URL。</p>
<hr/>
<h3 data-id="heading-21">8. 总结</h3>
<p>这套大文件分片上传方案的核心思路，是把“上传”拆成一条可控、可恢复的链路：以 <strong>hash</strong> 作为文件唯一指纹，让相同文件具备 <strong>秒传</strong> 能力，并且在页面刷新后通过查询已上传分片实现 <strong>断点续传</strong>；hash 计算放到 <strong>Web Worker</strong> 中执行，避免大文件指纹计算阻塞主线程；上传阶段通过 <strong>并发</strong> 提升吞吐，通过 <strong>失败重试（指数退避）</strong> 增强弱网场景下的成功率；最终由服务端 <strong>按序合并分片并清理临时目录</strong>，实现从上传到落盘的完整闭环。</p>
<p>受时间精力所限，一些更贴近生产环境的能力暂时还未补齐，不过后续的可扩展方向已经梳理清楚：合并阶段可以升级为 <strong>流式合并</strong>，降低内存峰值并提升并发稳定性；进度展示可以改为基于 <code>onprogress</code> 的 <strong>实时累计</strong>，让进度更平滑、更可信；同时加入 <strong>分片过期清理机制</strong>，避免中断上传后分片长期残留占用磁盘。等后续逐步把这些点落地，整体的稳定性、可维护性以及使用体验都会进一步提升。</p>
<h3 data-id="heading-22">项目地址</h3>
<p>完整代码已开源：</p>
<ul>
<li>GitHub: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTheproudcold%2Flarge-file-sharding-upload" target="_blank" title="https://github.com/Theproudcold/large-file-sharding-upload" ref="nofollow noopener noreferrer">github.com/Theproudcol…</a></li>
</ul>
<p>欢迎 Star / 提 Issue / PR，一起完善功能（例如流式合并、实时进度、分片过期清理等）。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【鸿蒙开发教程】手把手教你开发碰一碰加好友功能]]></title>    <link>https://juejin.cn/post/7599514071105060879</link>    <guid>https://juejin.cn/post/7599514071105060879</guid>    <pubDate>2026-01-26T12:13:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599514071105060879" data-draft-id="7599526246503284770" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【鸿蒙开发教程】手把手教你开发碰一碰加好友功能"/> <meta itemprop="keywords" content="HarmonyOS,前端"/> <meta itemprop="datePublished" content="2026-01-26T12:13:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="不喝水会渴"/> <meta itemprop="url" content="https://juejin.cn/user/1084533994686547"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【鸿蒙开发教程】手把手教你开发碰一碰加好友功能
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1084533994686547/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    不喝水会渴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T12:13:56.000Z" title="Mon Jan 26 2026 12:13:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">手把手教你开发鸿蒙碰一碰加好友功能：告别扫码，贴贴就加友！</h2>
<p>还在为加好友扫半天二维码、输一串数字抓狂？鸿蒙的“碰一碰”功能直接把加好友简化到“贴贴就行”！不用搜、不用输，两台手机轻轻一碰，好友信息自动飞过去，主打一个“近在咫尺，一键加友”。今天就手把手带你把这个神仙功能搬进自己的App，以喵屿App的碰一碰加宠物好友为例，从原理到实战，包教包会～</p>
<h3 data-id="heading-1">● 碰一碰功能介绍</h3>
<p>碰一碰分享本质上是鸿蒙Share Kit的“隐藏彩蛋”，支持用户通过设备轻碰发起跨端分享，不管是传图片、共享Wi-Fi，还是咱今天要搞的加好友，都能搞定。更爽的是：只要你的应用支持系统分享，理论上不用额外魔改，就能解锁碰一碰能力，简直是懒人开发者的福音！</p>
<p><strong>流程说明：</strong>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48110f763be24a4185cba3aae51ad5dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5Zad5rC05Lya5ri0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770034436&amp;x-signature=ARu9tKfk%2B6o6lbJs5Xb24AODUrs%3D" alt="Alt" loading="lazy"/></p>
<ol>
<li>先给自家应用“注册”碰一碰分享事件，然后让两部亮屏解锁的手机来个“贴贴”（就像朋友握手一样）；</li>
<li>应用发现“贴贴”触发后，会调用碰一碰分享回调，咱在回调里把要分享的好友数据打包发出去；</li>
<li>对方手机接住数据，乖乖处理；</li>
<li>事儿办完了，记得解除注册，别让应用“占着茅坑不拉屎”～</li>
</ol>
<p><strong>使用约束（划重点！不然贴贴也白贴）</strong>
想让俩手机顺利贴贴传好友，得满足几个小条件：双端设备都得亮屏、解锁（总不能黑屏贴贴吧，手机也得“醒着”才知道要干活），而且华为分享服务得开着（系统默认开的，除非你手欠手动关了）。贴的时候得用手机顶部碰，不是随便怼哪里都管用哈～如果华为分享关了，碰的时候系统会贴心提醒你打开，不用慌。</p>
<p>链接: <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-guides%2Fknock-share-between-phones-overview" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/knock-share-between-phones-overview" ref="nofollow noopener noreferrer">碰一碰功能介绍</a></p>
<h3 data-id="heading-2">● 简单的碰一碰实现</h3>
<p>先从最简单的图片分享入手，带你尝尝碰一碰的甜头！其实鸿蒙的碰一碰超友好，只要你的应用支持系统分享，几乎不用额外折腾，几行代码就能搞定，看</p>
<pre><code class="hljs language-javascript" lang="javascript"> private <span class="hljs-keyword">async</span> <span class="hljs-title function_">handelShare</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt; {
    <span class="hljs-keyword">const</span> <span class="hljs-attr">uiContext</span>: <span class="hljs-title class_">UIContext</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>();
    <span class="hljs-comment">//需设置本地图片链接</span>
    <span class="hljs-keyword">let</span> filePath = <span class="hljs-variable language_">this</span>.<span class="hljs-property">ImgData</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">curIndex</span>];
    <span class="hljs-keyword">let</span> utdTypeId = utd.<span class="hljs-title function_">getUniformDataTypeByFilenameExtension</span>(<span class="hljs-string">'.png'</span>, utd.<span class="hljs-property">UniformDataType</span>.<span class="hljs-property">IMAGE</span>);
    <span class="hljs-keyword">let</span> <span class="hljs-attr">shareData</span>: systemShare.<span class="hljs-property">SharedData</span> = <span class="hljs-keyword">new</span> systemShare.<span class="hljs-title class_">SharedData</span>({
      <span class="hljs-attr">utd</span>: utdTypeId,
      <span class="hljs-attr">uri</span>: fileUri.<span class="hljs-title function_">getUriFromPath</span>(filePath),
      <span class="hljs-attr">title</span>: <span class="hljs-string">'喵屿图片分享'</span>,
    });
    <span class="hljs-keyword">let</span> <span class="hljs-attr">controller</span>: systemShare.<span class="hljs-property">ShareController</span> = <span class="hljs-keyword">new</span> systemShare.<span class="hljs-title class_">ShareController</span>(shareData);
    <span class="hljs-keyword">const</span> <span class="hljs-attr">context</span>: common.<span class="hljs-property">UIAbilityContext</span> = uiContext.<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;
    controller.<span class="hljs-title function_">show</span>(context, {
      <span class="hljs-attr">previewMode</span>: systemShare.<span class="hljs-property">SharePreviewMode</span>.<span class="hljs-property">DETAIL</span>,
      <span class="hljs-attr">selectionMode</span>: systemShare.<span class="hljs-property">SelectionMode</span>.<span class="hljs-property">BATCH</span>,
    }).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
      logger.<span class="hljs-title function_">info</span>(<span class="hljs-string">'HuaweiShare_ show'</span>);
    }).<span class="hljs-keyword">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {
      logger.<span class="hljs-title function_">error</span>(<span class="hljs-string">`HuaweiShare_ show error. Code: <span class="hljs-subst">${error?.code}</span>, message: <span class="hljs-subst">${error?.message}</span>`</span>);
    });
  }
</code></pre>
<p>就这么几行，把本地图片路径填好，调用系统分享Kit，分享界面里就自带碰一碰功能了，是不是比凑半天二维码轻松多了？</p>
<h3 data-id="heading-3">● 碰一碰拉起指定应用（Deeplink的使用）</h3>
<p>但是问题来了：默认分享的图片、文本这些，会被图库、浏览器这些“路人甲”应用打开，咱要的是直接拉起自己的App加好友啊！总不能让用户碰完，结果跳去浏览器，那也太掉链子了。</p>
<p>系统早就想到这点了，给了俩解决方案：一是分享Applinking/Deeplink形式的链接，二是指定应用直达（6.0.0(20) Beta3新功能，咱今天先不唠这个）。Applinking和Deeplink的区别简单说：Applinking如果对方没装你家App，会跳浏览器或应用市场，Deeplink只会告诉你没有对应应用；Deeplink的配置更简单，咱今天就拿捏它！</p>
<p>想用Deeplink让分享内容精准跳自家App，第一步得给App“贴标签”——在module.json5里配置skills标签，相当于给系统说：“这个链接只能我家App接，别乱分给别人！”示例如下：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-comment">// ···</span>
    <span class="hljs-attr">"abilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-comment">// ···</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-comment">// ···</span>
        <span class="hljs-attr">"skills"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
          <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"entities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
              <span class="hljs-string">"entity.system.home"</span>
            <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"actions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
              <span class="hljs-string">"ohos.want.action.home"</span>
            <span class="hljs-punctuation">]</span>
          <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
          <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"actions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
              <span class="hljs-comment">// actions不能为空，actions为空会造成目标方匹配失败。</span>
              <span class="hljs-string">"ohos.want.action.viewData"</span>
            <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"uris"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
              <span class="hljs-punctuation">{</span>
                <span class="hljs-comment">// scheme必选，可以自定义，以link为例，需要替换为实际的scheme</span>
                <span class="hljs-attr">"scheme"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"link"</span><span class="hljs-punctuation">,</span>
                <span class="hljs-attr">"host"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"www.example.com"</span>
              <span class="hljs-punctuation">}</span>
            <span class="hljs-punctuation">]</span>
          <span class="hljs-punctuation">}</span> <span class="hljs-comment">// 新增一个skill对象，用于跳转场景。如果存在多个跳转场景，需配置多个skill对象。</span>
        <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-comment">// ···</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-comment">// ···</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>配置完标签，还得让App知道“接了链接该干啥”——在目标应用的UIAbility的onCreate()或者onNewWant()里解析链接参数，比如拿到好友信息后，就可以触发加好友逻辑了：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 以DeepAbility.ets为例</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AbilityConstant</span>, <span class="hljs-title class_">UIAbility</span>, <span class="hljs-title class_">Want</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;
<span class="hljs-keyword">import</span> { url } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DOMAIN</span> = <span class="hljs-number">0x0000</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DeepAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {
  <span class="hljs-title function_">onCreate</span>(<span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span>, <span class="hljs-attr">launchParam</span>: <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">LaunchParam</span>): <span class="hljs-keyword">void</span> {
    <span class="hljs-comment">// 从want中获取传入的链接信息。</span>
    <span class="hljs-comment">// 如传入的url为：link://www.example.com/programs?action=showall</span>
    <span class="hljs-keyword">let</span> uri = want?.<span class="hljs-property">uri</span>;
    <span class="hljs-keyword">if</span> (uri) {
      <span class="hljs-comment">// 从链接中解析query参数，拿到参数后，开发者可根据自己的业务需求进行后续的处理。</span>
      <span class="hljs-keyword">let</span> urlObject = url.<span class="hljs-property">URL</span>.<span class="hljs-title function_">parseURL</span>(want?.<span class="hljs-property">uri</span>);
      <span class="hljs-keyword">let</span> action = urlObject.<span class="hljs-property">params</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'action'</span>);
      <span class="hljs-comment">// 例如，当action为showall时，展示所有的节目。</span>
      <span class="hljs-keyword">if</span> (action === <span class="hljs-string">'showall'</span>) {
        <span class="hljs-comment">// ···</span>
      }
    }
  }
<span class="hljs-comment">// ···</span>
}
</code></pre>
<p>说白了，想让碰一碰拉起指定App干指定事，只要分享的时候把Deeplink链接发出去就行，系统会自动帮你找对App。不过上面都是靠系统分享界面实现的，有没有更“私密”的玩法，不用走系统界面？必须有！直接注册'knockShare'监听，就能自己掌控碰一碰的全过程，看官方代码👇</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { uniformTypeDescriptor <span class="hljs-keyword">as</span> utd } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkData'</span>;
<span class="hljs-keyword">import</span> { systemShare, harmonyShare } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ShareKit'</span>;
<span class="hljs-keyword">import</span> { fileUri } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;

@<span class="hljs-title class_">Component</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> struct <span class="hljs-title class_">Index</span> {
  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-keyword">void</span> {
    <span class="hljs-keyword">let</span> <span class="hljs-attr">capabilityRegistry</span>: harmonyShare.<span class="hljs-property">SendCapabilityRegistry</span> = {
      <span class="hljs-attr">windowId</span>: <span class="hljs-number">999</span>, <span class="hljs-comment">// 此值仅为示例 实际使用时请替换正确的windowId</span>
    }
    harmonyShare.<span class="hljs-title function_">on</span>(<span class="hljs-string">'knockShare'</span>, capabilityRegistry, <span class="hljs-function">(<span class="hljs-params">sharableTarget: harmonyShare.SharableTarget</span>) =&gt;</span> {
      <span class="hljs-keyword">let</span> <span class="hljs-attr">shareData</span>: systemShare.<span class="hljs-property">SharedData</span> = <span class="hljs-keyword">new</span> systemShare.<span class="hljs-title class_">SharedData</span>({
        <span class="hljs-attr">utd</span>: utd.<span class="hljs-property">UniformDataType</span>.<span class="hljs-property">HYPERLINK</span>,
        <span class="hljs-attr">content</span>: <span class="hljs-string">'https://sharekitdemo.drcn.agconnect.link/ZB3p'</span>,
        <span class="hljs-comment">// 根据title,description,thumbnailUri会生成不同的卡片模板，具体可参考设置配套的卡片样式。</span>
        <span class="hljs-attr">title</span>: <span class="hljs-string">'碰一碰分享卡片标题'</span>,
        <span class="hljs-attr">description</span>: <span class="hljs-string">'碰一碰分享卡片描述'</span>
      });
      <span class="hljs-comment">// 若云端预览图无法及时下载 可先发送数据</span>
      sharableTarget.<span class="hljs-title function_">share</span>(shareData);

      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-comment">// 待预览图下载完成后 补充更新预览图</span>
        <span class="hljs-keyword">let</span> <span class="hljs-attr">uiContext</span>: <span class="hljs-title class_">UIContext</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>();
        <span class="hljs-keyword">let</span> <span class="hljs-attr">contextFaker</span>: <span class="hljs-title class_">Context</span> = uiContext.<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> <span class="hljs-title class_">Context</span>;
        <span class="hljs-keyword">let</span> filePath = contextFaker.<span class="hljs-property">filesDir</span> + <span class="hljs-string">'/exampleKnock1.jpg'</span>; <span class="hljs-comment">// 仅为示例 请替换正确的文件路径</span>
        sharableTarget.<span class="hljs-title function_">updateShareData</span>({
          <span class="hljs-attr">thumbnailUri</span>: fileUri.<span class="hljs-title function_">getUriFromPath</span>(filePath)
        });
      }, <span class="hljs-number">5000</span>);
    });
  }

  <span class="hljs-title function_">aboutToDisappear</span>(): <span class="hljs-keyword">void</span> {
    <span class="hljs-keyword">let</span> <span class="hljs-attr">capabilityRegistry</span>: harmonyShare.<span class="hljs-property">SendCapabilityRegistry</span> = {
      <span class="hljs-attr">windowId</span>: <span class="hljs-number">999</span>, <span class="hljs-comment">// 此值仅为示例 实际使用时请替换正确的windowId</span>
    }
    <span class="hljs-comment">// 解除碰一碰分享'knockShare'监听事件</span>
    harmonyShare.<span class="hljs-title function_">off</span>(<span class="hljs-string">'knockShare'</span>, capabilityRegistry);
  }

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
  }
}
</code></pre>
<h3 data-id="heading-4">● 碰一碰加好友功能实战</h3>
<p>光说不练假把式，接下来咱就拿“喵屿App”的碰一碰加宠物好友为例，手把手带你把这个功能落地，让养宠党贴贴手机就能互加宠物好友，再也不用手动输宠物信息啦！</p>
<h4 data-id="heading-5">碰一碰接收端处理</h4>
<p>想让碰一碰跳自家App加好友，第一步得给App“办个身份证”——在module.json5里配置skills标签，告诉系统：“这个链接是我的，别给别人！”</p>
<pre><code class="hljs language-javascript" lang="javascript">   <span class="hljs-string">"abilities"</span>: [
    {
        <span class="hljs-string">"name"</span>: <span class="hljs-string">"EntryAbility"</span>,
        <span class="hljs-string">"srcEntry"</span>: <span class="hljs-string">"./ets/entryability/EntryAbility.ets"</span>,
        <span class="hljs-string">"description"</span>: <span class="hljs-string">"$string:EntryAbility_desc"</span>,
        <span class="hljs-string">"icon"</span>: <span class="hljs-string">"$media:layered_image"</span>,
        <span class="hljs-string">"label"</span>: <span class="hljs-string">"$string:EntryAbility_label"</span>,
        <span class="hljs-string">"startWindowIcon"</span> : <span class="hljs-string">"$media:layered_image"</span>,
        <span class="hljs-string">"startWindowBackground"</span> : <span class="hljs-string">"$color:start_window_background"</span>
          ,
        <span class="hljs-string">"exported"</span>: <span class="hljs-literal">true</span>
          ,
        <span class="hljs-string">"skills"</span>: [
          {
            <span class="hljs-string">"entities"</span>: [
              <span class="hljs-string">"entity.system.home"</span>
            ],
            <span class="hljs-string">"actions"</span>: [
              <span class="hljs-string">"ohos.want.action.home"</span>
            ]
          },
          {
            <span class="hljs-string">"actions"</span>: [<span class="hljs-string">"action.system.viewData"</span>],
            <span class="hljs-string">"entities"</span>: [<span class="hljs-string">"entity.system.browser"</span>],
            <span class="hljs-string">"uris"</span>: [
              {
                <span class="hljs-comment">// scheme必选，可以自定义，以catIsland为例，需要替换为实际的scheme</span>
                <span class="hljs-string">"scheme"</span>: <span class="hljs-string">"catIsland"</span>,
                <span class="hljs-string">"host"</span>: <span class="hljs-string">"catIsland.sx.com"</span>
              }
            ]
          } <span class="hljs-comment">// 新增一个skill对象，用于跳转场景。如果存在多个跳转场景，需配置多个skill对象。</span>
        ]
      }]
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c865d7ab1694e63a916c19ec21dd381~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5Zad5rC05Lya5ri0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770034436&amp;x-signature=jRPndb6eY2ofcRQESTZhrCKWGbs%3D" alt="碰一碰然后选择接收数据会走到onCreate()或者onNewWant()生命周期" loading="lazy"/>
<strong>划重点：</strong> 碰一碰接收数据后，App会走onCreate()或onNewWant()生命周期，俩都得处理，不然会漏数据！</p>
<p>然后就得让App“读懂”链接里的好友信息了——在EntryAbility的onCreate()和onNewWant()里解析链接参数，把宠物姓名、性别、生日这些信息抠出来，存到AppStorage里，等着后续处理：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {
  <span class="hljs-title function_">onCreate</span>(<span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span>, <span class="hljs-attr">launchParam</span>: <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">LaunchParam</span>): <span class="hljs-keyword">void</span> {
    <span class="hljs-comment">// 从want中获取传入的链接信息。</span>
    <span class="hljs-comment">// 如传入的url为：catIsland://catIsland.sx.com/share/?name=${info.name}&amp;sex=${info.sex}&amp;birth=${info.birth}&amp;breed=${info.breed}</span>
    <span class="hljs-keyword">let</span> uri = want?.<span class="hljs-property">uri</span>;
    <span class="hljs-keyword">if</span> (uri) {
      <span class="hljs-comment">// 从链接中解析query参数，拿到参数后，开发者可根据自己的业务需求进行后续的处理。</span>
      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onCreate'</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(uri));
      <span class="hljs-keyword">const</span> urlObject = url.<span class="hljs-property">URL</span>.<span class="hljs-title function_">parseURL</span>(want?.<span class="hljs-property">uri</span>);
      <span class="hljs-keyword">const</span> name = urlObject.<span class="hljs-property">params</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'name'</span>);
      <span class="hljs-keyword">const</span> sex = urlObject.<span class="hljs-property">params</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'sex'</span>) ;
      <span class="hljs-keyword">const</span> birth = urlObject.<span class="hljs-property">params</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'birth'</span>);
      <span class="hljs-keyword">const</span> breed = urlObject.<span class="hljs-property">params</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'breed'</span>);
      <span class="hljs-keyword">if</span>(name){
        <span class="hljs-keyword">let</span> baseInfo = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BaseInfo</span>(name)
        baseInfo.<span class="hljs-property">sex</span> = <span class="hljs-title class_">Number</span>(sex)
        baseInfo.<span class="hljs-property">birth</span> = birth
        baseInfo.<span class="hljs-property">breed</span> = breed
        <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'newFriend'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(baseInfo)); <span class="hljs-comment">//数据保存起来</span>
      }
    }

			...
  }

  <span class="hljs-title function_">onNewWant</span>(<span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span>, <span class="hljs-attr">launchParam</span>: <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">LaunchParam</span>): <span class="hljs-keyword">void</span> {
    <span class="hljs-comment">// 从want中获取传入的链接信息。</span>
    <span class="hljs-comment">// 如传入的url为：catIsland://catIsland.sx.com/share/?name=${info.name}&amp;sex=${info.sex}&amp;birth=${info.birth}&amp;breed=${info.breed}</span>
    <span class="hljs-keyword">let</span> uri = want?.<span class="hljs-property">uri</span>;
    <span class="hljs-keyword">if</span> (uri) {
      <span class="hljs-comment">// 从链接中解析query参数，拿到参数后，开发者可根据自己的业务需求进行后续的处理。</span>
      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onCreate'</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(uri));
       <span class="hljs-keyword">const</span> urlObject = url.<span class="hljs-property">URL</span>.<span class="hljs-title function_">parseURL</span>(want?.<span class="hljs-property">uri</span>);
      <span class="hljs-keyword">const</span> name = urlObject.<span class="hljs-property">params</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'name'</span>);
      <span class="hljs-keyword">const</span> sex = urlObject.<span class="hljs-property">params</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'sex'</span>) ;
      <span class="hljs-keyword">const</span> birth = urlObject.<span class="hljs-property">params</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'birth'</span>);
      <span class="hljs-keyword">const</span> breed = urlObject.<span class="hljs-property">params</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'breed'</span>);
      <span class="hljs-keyword">if</span>(name){
        <span class="hljs-keyword">let</span> baseInfo = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BaseInfo</span>(name)
        baseInfo.<span class="hljs-property">sex</span> = <span class="hljs-title class_">Number</span>(sex)
        baseInfo.<span class="hljs-property">birth</span> = birth
        baseInfo.<span class="hljs-property">breed</span> = breed
        <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'newFriend'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(baseInfo));<span class="hljs-comment">//数据保存起来</span>
        emitter.<span class="hljs-title function_">emit</span>(<span class="hljs-title class_">BaseConstants</span>.<span class="hljs-property">NEW_FRIEND</span>) <span class="hljs-comment">//通知有新朋友数据</span>
      }
    }
  }
  ...
</code></pre>
<p>为啥俩生命周期都要解析？简单说：App冷启动（第一次打开）走onCreate()，如果App已经开着，Deeplink拉它就只走onNewWant()。俩都处理，不管App是开是关，都能稳稳接住好友数据，主打一个“不漏网之鱼”！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0fd2ead4fdad4dada02abd33240ea74a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5Zad5rC05Lya5ri0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770034436&amp;x-signature=JcsAE%2BpXSKoRvoaZILuG2nSglsU%3D" alt="在这里插入图片描述" loading="lazy"/>
<strong>MainPage弹窗选择是否保存好友数据</strong></p>
<p>数据存好了，总得让用户知道吧？在App首页MainPage.ets里监听好友数据，只要有新数据，就弹个窗让用户选“加好友”还是“拒绝”，体验直接拉满：</p>
<pre><code class="hljs language-javascript" lang="javascript"> onNewFriend = <span class="hljs-function">()=&gt;</span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'newFriend'</span>) != <span class="hljs-literal">undefined</span>){
      <span class="hljs-keyword">let</span> newFriend = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'newFriend'</span>)!!) <span class="hljs-keyword">as</span> <span class="hljs-title class_">BaseInfo</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'testTag'</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(newFriend))
      <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">'newFriend'</span>,  <span class="hljs-literal">undefined</span>)
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">friendDialog</span> = <span class="hljs-title class_">DialogHub</span>.<span class="hljs-title function_">getCustomDialog</span>()<span class="hljs-comment">//好友数据弹窗可以选择接受或者拒绝</span>
        .<span class="hljs-title function_">setOperableContent</span>(<span class="hljs-title function_">wrapBuilder</span>(<span class="hljs-title class_">NewFriendDialogBuilder</span>), <span class="hljs-function">(<span class="hljs-params">action: DialogAction</span>) =&gt;</span> {
          <span class="hljs-keyword">let</span> para = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PetDialogParams</span>(newFriend, action, <span class="hljs-variable language_">this</span>.<span class="hljs-property">promptAction</span>,  <span class="hljs-number">0</span>);
          <span class="hljs-keyword">return</span> para;
        })
        .<span class="hljs-title function_">setConfig</span>({ <span class="hljs-attr">dialogBehavior</span>: { <span class="hljs-attr">isModal</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">autoDismiss</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">passThroughGesture</span>: <span class="hljs-literal">false</span> } })
        .<span class="hljs-title function_">setAnimation</span>({ <span class="hljs-attr">dialogAnimation</span>: <span class="hljs-title class_">AnimationType</span>.<span class="hljs-property">BOTTOM_UP</span> })
        .<span class="hljs-title function_">setStyle</span>({
          <span class="hljs-attr">radius</span>: <span class="hljs-number">32</span>,
          <span class="hljs-attr">backgroundColor</span>: <span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>,
          <span class="hljs-attr">maskBackgroundEffect</span>: { <span class="hljs-attr">blurOptions</span>: { <span class="hljs-attr">grayscale</span>: [<span class="hljs-number">50</span>, <span class="hljs-number">50</span>] }, <span class="hljs-attr">radius</span>: <span class="hljs-number">10</span> }
        })
        .<span class="hljs-title function_">build</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">friendDialog</span>.<span class="hljs-title function_">show</span>();
    }
  }

 <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt; {
    emitter.<span class="hljs-title function_">on</span>(<span class="hljs-title class_">BaseConstants</span>.<span class="hljs-property">NEW_FRIEND</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">onNewFriend</span>) <span class="hljs-comment">//注册好友申请的监听</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onNewFriend</span>()
    ...
 }
 ...
 <span class="hljs-title function_">aboutToDisappear</span>(): <span class="hljs-keyword">void</span> {
    emitter.<span class="hljs-title function_">off</span>(<span class="hljs-title class_">BaseConstants</span>.<span class="hljs-property">NEW_FRIEND</span>.<span class="hljs-property">eventId</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">onNewFriend</span>)
  }
</code></pre>
<p>App启动后打开MainPage，先注册好友申请监听，确保主页在的时候能实时收到通知；然后立刻检查有没有待处理的好友数据，有就弹窗，不让用户等，主打一个“贴心”！</p>
<h4 data-id="heading-6">碰一碰发送端处理</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c00d7bbdcdc46469b8eec4533e73c24~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5Zad5rC05Lya5ri0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770034436&amp;x-signature=yNm60DKyo5yDjCxryF7tGyTK8SU%3D" alt="宠物信息界面设置碰一碰监听" loading="lazy"/>
<strong>宠物信息界面设置碰一碰监听</strong>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4fbdbc6ffdd44e7b1e1f0c104cc7deb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5Zad5rC05Lya5ri0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770034436&amp;x-signature=6v5bsQRkvIl4b3LXFDUwLeW5SRg%3D" alt="碰一碰后触发的分享界面" loading="lazy"/>
<strong>碰一碰后触发的分享界面</strong></p>
<p>最后一步，让碰一碰“活”起来！在宠物信息界面注册碰一碰监听，只要检测到两台手机贴贴，就把当前宠物的信息打包进Deeplink，注意要和前面moudule.json5中定义的<strong>scheme和host</strong>要匹配， 对方接住后就能按上面的流程处理好友申请了：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">showID</span>(<span class="hljs-params">info: BaseInfo, index: number = <span class="hljs-number">0</span></span>) {
    harmonyShare.<span class="hljs-title function_">on</span>(<span class="hljs-string">'knockShare'</span>, <span class="hljs-function">(<span class="hljs-params">sharableTarget: harmonyShare.SharableTarget</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> filePath = info.<span class="hljs-property">icon</span>; <span class="hljs-comment">// 仅为示例 请替换正确的文件路径</span>
      <span class="hljs-keyword">let</span> <span class="hljs-attr">shareData</span>: systemShare.<span class="hljs-property">SharedData</span> = <span class="hljs-keyword">new</span> systemShare.<span class="hljs-title class_">SharedData</span>({
        <span class="hljs-attr">utd</span>: utd.<span class="hljs-property">UniformDataType</span>.<span class="hljs-property">HYPERLINK</span>,
        <span class="hljs-attr">content</span>: <span class="hljs-string">`catIsland://catIsland.sx.com/share/?name=<span class="hljs-subst">${info.name}</span>&amp;sex=<span class="hljs-subst">${info.sex}</span>&amp;birth=<span class="hljs-subst">${info.birth}</span>&amp;breed=<span class="hljs-subst">${info.breed}</span>`</span>,
        <span class="hljs-comment">// 根据title,description,thumbnailUri会生成不同的卡片模板。</span>
        <span class="hljs-attr">thumbnailUri</span>: fileUri.<span class="hljs-title function_">getUriFromPath</span>(filePath),
        <span class="hljs-attr">title</span>: <span class="hljs-string">`分享<span class="hljs-subst">${info.name}</span>给好友`</span>,
        <span class="hljs-attr">description</span>: <span class="hljs-string">'碰一碰即可将宠物信息分享给好友'</span>
      });
      sharableTarget.<span class="hljs-title function_">share</span>(shareData);
    });

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">IDDialog</span> = <span class="hljs-title class_">DialogHub</span>.<span class="hljs-title function_">getCustomDialog</span>()
      .<span class="hljs-title function_">setOperableContent</span>(<span class="hljs-title function_">wrapBuilder</span>(<span class="hljs-title class_">PetIDDialogBuilder</span>), <span class="hljs-function">(<span class="hljs-params">action: DialogAction</span>) =&gt;</span> {
        <span class="hljs-keyword">let</span> para = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PetDialogParams</span>(info, action, <span class="hljs-variable language_">this</span>.<span class="hljs-property">promptAction</span>,  index);
        <span class="hljs-keyword">return</span> para;
      })
      .<span class="hljs-title function_">setConfig</span>({ <span class="hljs-attr">dialogBehavior</span>: { <span class="hljs-attr">isModal</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">autoDismiss</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">passThroughGesture</span>: <span class="hljs-literal">false</span> } })
      .<span class="hljs-title function_">setAnimation</span>({ <span class="hljs-attr">dialogAnimation</span>: <span class="hljs-title class_">AnimationType</span>.<span class="hljs-property">BOTTOM_UP</span> })
      .<span class="hljs-title function_">setStyle</span>({
        <span class="hljs-attr">radius</span>: <span class="hljs-number">32</span>,
        <span class="hljs-attr">backgroundColor</span>: <span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>,
        <span class="hljs-attr">maskBackgroundEffect</span>: { <span class="hljs-attr">blurOptions</span>: { <span class="hljs-attr">grayscale</span>: [<span class="hljs-number">50</span>, <span class="hljs-number">50</span>] }, <span class="hljs-attr">radius</span>: <span class="hljs-number">10</span> }
      })
      .<span class="hljs-title function_">build</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">IDDialog</span>.<span class="hljs-title function_">show</span>();
  }
}
</code></pre>
<p>这里踩个坑提醒各位老铁：博主最开始傻乎乎跟着官方新API写，用了6.0.0(20)新增的带capability参数的on方法，结果发现5.0版本的设备直接不兼容，主打一个“新是新，用不了”！最后只能乖乖换回5.0.0(12)的低版本API（不用传capability）。大家用的时候可别踩这个坑——新API虽香，但得看你的用户设备支不支持啊！</p>
<pre><code class="hljs language-javascript" lang="javascript">	<span class="hljs-comment">//注册设备轻贴的事件监听。</span>
	<span class="hljs-comment">//起始版本：6.0.0(20)</span>
	<span class="hljs-title function_">on</span>(<span class="hljs-attr">event</span>: <span class="hljs-string">'knockShare'</span>, <span class="hljs-attr">capability</span>: <span class="hljs-title class_">SendCapabilityRegistry</span>, <span class="hljs-attr">callback</span>: <span class="hljs-title class_">Callback</span>&lt;<span class="hljs-title class_">SharableTarget</span>&gt;): <span class="hljs-keyword">void</span>
	<span class="hljs-comment">//起始版本：5.0.0(12)</span>
	<span class="hljs-title function_">on</span>(<span class="hljs-attr">event</span>: <span class="hljs-string">'knockShare'</span>, <span class="hljs-attr">callback</span>: <span class="hljs-title class_">Callback</span>&lt;<span class="hljs-title class_">SharableTarget</span>&gt;): <span class="hljs-keyword">void</span>
</code></pre>
<p>实际效果演示可自行下载APP碰一碰试一试： <a href="https://link.juejin.cn?target=https%3A%2F%2Fappgallery.huawei.com%2Fapp%2Fdetail%3Fid%3Dcom.sx.catIsland%26channelId%3DSHARE%26source%3Dappshare" target="_blank" title="https://appgallery.huawei.com/app/detail?id=com.sx.catIsland&amp;channelId=SHARE&amp;source=appshare" ref="nofollow noopener noreferrer">喵屿下载链接</a></p>
<h3 data-id="heading-7">总结</h3>
<p>怎么样，是不是发现鸿蒙碰一碰加好友功能一点都不复杂？从配置Deeplink让链接精准跳自家App，到解析冷/热启动的参数不漏数据，再到监听碰一碰事件分享好友信息，一套流程走下来，你的App也能拥有“贴贴加好友”的神仙能力！</p>
<p>相比传统的扫码、输码加好友，碰一碰直接把操作简化到“贴一下”，用户体验直接拉满。而且整个开发过程几乎不用造轮子，依托鸿蒙Share Kit就能搞定，唯一要注意的就是API版本兼容问题，别像博主一样踩坑就行。</p>
<p>现在就把这些代码搬去你的项目里试试吧，不管是做宠物社交、熟人社交还是其他场景，碰一碰加好友都能让你的App多一个“让人眼前一亮”的小功能。要是开发过程中踩了啥新坑，或者有更酷的玩法，评论区唠唠～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[横纵切换：UI动效的“罗生门”，你的布局该听谁的？]]></title>    <link>https://juejin.cn/post/7599474528239304744</link>    <guid>https://juejin.cn/post/7599474528239304744</guid>    <pubDate>2026-01-26T12:32:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599474528239304744" data-draft-id="7596170399881216052" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="横纵切换：UI动效的“罗生门”，你的布局该听谁的？"/> <meta itemprop="keywords" content="前端,HarmonyOS"/> <meta itemprop="datePublished" content="2026-01-26T12:32:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Archilect"/> <meta itemprop="url" content="https://juejin.cn/user/1505660538979515"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            横纵切换：UI动效的“罗生门”，你的布局该听谁的？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1505660538979515/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Archilect
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T12:32:55.000Z" title="Mon Jan 26 2026 12:32:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">横纵切换：UI动效的“罗生门”，你的布局该听谁的？</h2>
<blockquote>
<p>关键词：横纵切换 / 声明式 UI / ArkUI / re-layout / transform / 预计算几何</p>
<p><strong>说明</strong>：本文的"布局驱动 vs 几何驱动"思路是通用的，适用于任何声明式 UI 框架。但文中的代码示例和具体 API（如 <code>position</code>、<code>translate</code>、<code>scale</code>、<code>Row</code>、<code>Column</code> 等）均基于 <strong>ArkUI（ArkTS）</strong>。其他框架的开发者可以将思路迁移到对应框架的等价 API 上。</p>
<p>横纵布局切换动画方案选择：当把所有可行路线摆上桌面，会发现真正的分岔口只有一个——<strong>横纵布局变换到底交给谁来完成</strong>。</p>
</blockquote>
<p>如果只做过静态 UI，会觉得“横排 ↔ 竖排”只是切换一下容器方向。</p>
<p>但一旦需要实现“吸顶折叠过程中的连续动画”（icon/文字/背景一起动，轨迹还要可控），横纵切换就不再是一个局部实现点，而是一个会决定后面所有设计的<strong>架构根节点</strong>。</p>
<p>方案可以归为两条路线：</p>
<ul>
<li><strong>布局驱动</strong>：让布局系统在两种状态下自动重排（例如 listDirection/Flex 方向切换/双模板切换等）</li>
<li><strong>几何驱动</strong>：由开发者自己定义两态几何，动画期间主要用 transform 做插值（position + translate/scale）</li>
</ul>
<p>为了快速建立直觉，可以先看两条路线的<strong>最小结构骨架</strong>（省略所有业务分支，只看结构差异）：</p>
<h4 data-id="heading-1">路线 A：布局系统驱动（Layout-driven）的骨架</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-title class_">Row</span>() {
  <span class="hljs-comment">// Tab 1</span>
  <span class="hljs-title class_">Stack</span>() {
    <span class="hljs-title class_">Image</span>(bgImage)  <span class="hljs-comment">// 标签背景图</span>
    <span class="hljs-title class_">List</span>() {
      <span class="hljs-title class_">ListItem</span>() {
        <span class="hljs-title class_">Image</span>(icon)
      }
      <span class="hljs-title class_">ListItem</span>() {
        <span class="hljs-title class_">Text</span>(text)
      }
    }
    .<span class="hljs-title function_">listDirection</span>(shouldStickTop ? <span class="hljs-title class_">Horizontal</span> : <span class="hljs-title class_">Vertical</span>)
  }
  <span class="hljs-comment">// Tab 2...</span>
}
</code></pre>
<h4 data-id="heading-2">路线 B：几何驱动（Geometry-driven）的骨架</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-title class_">Row</span>() {
  <span class="hljs-title class_">Image</span>(bgImage)  <span class="hljs-comment">// 标签背景图（独立在外层）</span>

  <span class="hljs-comment">// Tab 1</span>
  <span class="hljs-title class_">Column</span>() {
    <span class="hljs-title class_">Image</span>(icon)
      .<span class="hljs-title function_">position</span>({ <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span> })
      .<span class="hljs-title function_">translate</span>({ <span class="hljs-attr">x</span>: iconX, <span class="hljs-attr">y</span>: iconY })
      .<span class="hljs-title function_">scale</span>({ <span class="hljs-attr">x</span>: iconScale, <span class="hljs-attr">y</span>: iconScale })

    <span class="hljs-title class_">Text</span>(text)
      .<span class="hljs-title function_">position</span>({ <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span> })
      .<span class="hljs-title function_">translate</span>({ <span class="hljs-attr">x</span>: textX, <span class="hljs-attr">y</span>: textY })
  }
  <span class="hljs-comment">// Tab 2...</span>
}
</code></pre>
<p>这两段骨架的差异，基本已经把后面所有“为什么要预计算、为什么轨迹可控、为什么背景能解耦、为什么能高刷稳定”的结论提前剧透了。</p>
<p>下面再按“需求→候选路线→为什么分岔口在这里→如何落地”把逻辑讲完整。</p>
<hr/>
<h3 data-id="heading-3">1）需求一旦复杂，横纵切换就会绑定一串“连带问题”</h3>
<p>一个典型的真实场景大概是这样：</p>
<ul>
<li>未吸顶（展开态）：icon 在上、文字在下</li>
<li>吸顶后（折叠态）：icon 在左、文字在右</li>
<li>切换过程中要连续动画（位移/缩放/变色）</li>
<li>同时还有：
<ul>
<li>背景形状跟随激活项移动（展开是大梯形，折叠变扁梯形/胶囊）</li>
<li>首项固定（可选）</li>
<li>横向滚动居中</li>
<li>亮暗色、左中右不同物料</li>
</ul>
</li>
</ul>
<p>你会发现：<strong>横纵切换一旦做不好，后面所有东西都跟着不稳</strong>。</p>
<hr/>
<h3 data-id="heading-4">2）一开始就把候选路线摆出来（但不按“容器名字”分类）</h3>
<p>很多文章喜欢按组件名对比：RelativeContainer、Flex、List、两套模板……</p>
<p>更有效的方式是按“控制权归属”分类，因为组件名字会随框架/版本变化，但控制权问题不会变。</p>
<h4 data-id="heading-5">路线 A：布局驱动（Layout-driven）</h4>
<p>核心做法：</p>
<ul>
<li>让系统通过“切换布局规则”来完成横纵切换</li>
</ul>
<p>常见落地形态：</p>
<ul>
<li>RelativeContainer：在处理动态内容或复杂对齐时，其约束规则可能导致意外行为，排查成本较高。</li>
<li>Flex direction 切换：存在内容超出容器被裁剪的风险，且官方文档提示频繁切换该属性可能带来的性能影响。</li>
<li>List + listDirection：功能可行，但会引入额外层级（ListItem），且动效轨迹更依赖系统布局，难以精确控制。</li>
<li>Row/Column 两套模板切换（显示/隐藏或销毁/重建）：这种切换更像重建/显隐，难以实现平滑的连续位移和变形动画。</li>
</ul>
<p>一句话概括：</p>
<blockquote>
<p>开发者提供约束/方向，位置由布局算法决定。</p>
</blockquote>
<h4 data-id="heading-6">路线 B：几何驱动（Geometry-driven）</h4>
<p>核心做法：</p>
<ul>
<li>不让布局系统决定“最终位置”</li>
<li>由开发者自己计算展开态/折叠态的目标坐标</li>
<li>动画期间主要用渲染变换插值（translate/scale）</li>
</ul>
<p>一句话概括：</p>
<blockquote>
<p>开发者直接提供位置结果，布局系统只提供坐标原点。</p>
</blockquote>
<hr/>
<h3 data-id="heading-7">3）真正的分岔口：动画期间允许“布局系统”参与多少？</h3>
<p>可以把判断标准收敛成一个非常实用的问题：</p>
<blockquote>
<p><strong>动画期间，是否允许 re-layout 频繁发生？</strong></p>
</blockquote>
<h4 data-id="heading-8">3.1 为什么布局驱动容易把动画写“飘”？</h4>
<p>不是因为某个容器不好，而是因为布局驱动天然会带来三类不确定性：</p>
<ol>
<li>
<p><strong>端点不确定</strong></p>
<ul>
<li>横纵切换后元素到底落在哪，往往要等布局算完才知道</li>
<li>想“提前算好端点 + 插值”会很难，因为端点本身是布局输出</li>
</ul>
</li>
<li>
<p><strong>轨迹不可控</strong></p>
<ul>
<li>系统可能会给出一个“看起来合理”的补间，但很难精确控制：
<ul>
<li>谁先动、谁后动</li>
<li>是否分段</li>
<li>是否 overshoot</li>
<li>icon 与文字是否严格走同一时间轴</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>re-layout 干扰补间</strong></p>
<ul>
<li>动画中途若在改 width/margin/direction 等，会触发布局重排</li>
<li>轨迹会被布局结果离散修正，表现为偶发跳动/抖动（高刷更明显）</li>
</ul>
</li>
</ol>
<p>这些问题在需求简单时不显眼，但在“吸顶折叠 + 多元素联动”场景下会被放大。</p>
<h4 data-id="heading-9">3.2 为什么几何驱动能把复杂度“集中化”？</h4>
<p>几何驱动的优点不是“更强”，而是“更明确”：</p>
<ul>
<li>端点是算出来的，动画开始前就确定</li>
<li>轨迹是插值出来的，想怎么分段/延迟都可控</li>
<li>动画期间主要改 transform，尽量不触发布局重排</li>
<li>UI 结构节点更少、职责更清晰</li>
</ul>
<p>当然它也有代价：</p>
<ul>
<li>需要 measureTextSize（文本宽高必须可预测）</li>
<li>需要建立预计算与缓存（否则运行时算会很重）</li>
</ul>
<p>但这套代价一旦付了，后面背景、滚动居中、首项遮挡，都会顺着同一条路径解决。</p>
<hr/>
<h3 data-id="heading-10">4）如何落地“几何驱动”的横纵切换？</h3>
<p>落地时可以抓住一个关键技巧：</p>
<h4 data-id="heading-11">4.1 让子元素脱离布局流：position({0,0})</h4>
<p>在 tab 的容器里（例如 Column），icon 和 text 都设置：</p>
<ul>
<li><code>position({ x: 0, y: 0 })</code></li>
</ul>
<p>这一步的意义是：</p>
<ul>
<li>不再依赖 Column/Row 的自动排布</li>
<li>容器只提供一个“共同坐标原点”</li>
</ul>
<h4 data-id="heading-12">4.2 用 translate/scale 贴上两态几何</h4>
<p>在计算层提前算出：</p>
<ul>
<li>展开态：iconX/iconY、textX/textY、iconScale=1</li>
<li>折叠态：iconX/iconY、textX/textY、iconScale&lt;1（或不同大小）</li>
</ul>
<p>渲染层只控制两个绘制属性：</p>
<ul>
<li><code>translate({ x, y })</code></li>
<li><code>scale({ x, y })</code></li>
</ul>
<p>动画期间，尽量不通过“切换容器/改布局属性”完成效果，而是让坐标插值带着元素走。</p>
<hr/>
<h3 data-id="heading-13">5）为什么这个根节点一旦选定，后面所有设计都变成“必然结果”？</h3>
<p>这也是最值得强调的一点：</p>
<ul>
<li>一旦选了几何驱动，<strong>UI 结构会自然变薄</strong>（少嵌套、少中间层）</li>
<li>自然会需要：
<ul>
<li>物料查表缓存（解决状态组合爆炸）</li>
<li>几何预计算缓存（两态端点提前确定）</li>
<li>render 层只消费几何（modifier 只贴 transform）</li>
</ul>
</li>
<li>自然会把：
<ul>
<li>背景当图层（独立于 tab 布局）</li>
<li>targetScrollOffset 当布局输出（而不是运行时测量）</li>
<li>首项遮挡当交互状态机（而不是 zIndex/clip 补丁）</li>
</ul>
</li>
</ul>
<p>所以这篇并不是在推荐“某个 API”，而是在强调：</p>
<blockquote>
<p>横纵切换的实现方式，会决定你到底是在“和布局系统博弈”，还是在“定义一套可控几何”。</p>
</blockquote>
<hr/>
<h3 data-id="heading-14">6）小结</h3>
<blockquote>
<p><strong>笛卡尔的含金量</strong>：
从用 <code>margin/padding/spaceBetween</code> 这类“几何关系”去驱动布局
改为把几何关系“编译”成坐标数据，让 <code>translate</code> 成为唯一的几何接口。</p>
<p>当“位置变化”只从一个统一接口（<code>translate</code>）流出，会直接带来：</p>
<ul>
<li><strong>可推导/可回归</strong>：位置 bug 更像“x/y 算错了”，而不是一堆 margin/padding/align 的组合问题；</li>
<li><strong>可组合</strong>：【吸顶、激活态增宽、首项固定让位】等效果可以在同一坐标值里做合成；</li>
<li><strong>更符合 OCP</strong>：新增“位移需求”时，尽量不改渲染层结构，只扩展计算层输出（例如改 <code>iconX</code> 的公式/插值），Render 层仍然只消费 <code>.translate({ x, y })</code>。</li>
</ul>
<p>这种将“如何布局”(how)与“布局结果”(what)分离的做法，也侧面说明：很多设计原则首先是“对变化的管理方式”，并不依赖 OOP 语法本身。</p>
</blockquote>
<p>现在的判断很简单：</p>
<ul>
<li>需求简单、只要能切横纵、不追求轨迹：布局驱动足够</li>
<li>一旦需求出现“吸顶折叠 + 多元素联动 + 高刷稳定 + 轨迹可控”，横纵切换就应该走几何驱动</li>
</ul>
<p>下一篇会继续把“几何驱动”讲透：</p>
<ul>
<li>为什么预计算不是优化，而是必需品（measureTextSize、两态几何、确定性、缓存）</li>
</ul>
<hr/>
<h3 data-id="heading-15">附录：可独立运行的“几何驱动”示例</h3>
<p>为了更直观地展示“几何驱动”如何通过直接控制坐标来实现布局动画，下面提供一个完整的、可独立运行的 ArkUI 示例代码。你可以将代码复制到项目中，直接预览横纵切换效果。</p>
<blockquote>
<p><strong>说明</strong>：以下代码提供了两个组件（A 和 B），它们实现了相同的视觉效果，但方式不同：</p>
<ul>
<li><strong>Component A</strong>：使用 <code>transform(matrix4)</code>，这是一种更底层、更强大的矩阵变换方式</li>
<li><strong>Component B</strong>：使用 <code>translate</code> 和 <code>scale</code>，这种方式更直观，也是本系列文章中推荐优先使用的方式</li>
</ul>
<p>建议先看 <strong>Component B</strong>，理解几何驱动的基本思路；如果对矩阵变换感兴趣，再看 Component A。</p>
</blockquote>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { matrix4 } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>

<span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">Transform02</span> {
  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>() {
      <span class="hljs-title function_">A</span>()
      <span class="hljs-title function_">B</span>()
    }
  }
}

<span class="hljs-comment">//计算基准值：</span>
<span class="hljs-comment">//容器宽高：containerWidth=100</span>
<span class="hljs-comment">// 纵向宽高：文字：70*20，图片：50*50，图下间距：5，字下间距：6</span>
<span class="hljs-comment">// 横向宽高：文字：70*25，图片：30*30，图左间距：3，字左间距：4</span>

<span class="hljs-meta">@Component</span>
struct A {
  <span class="hljs-meta">@State</span> <span class="hljs-attr">trans</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>
  <span class="hljs-meta">@State</span> <span class="hljs-attr">iconWidth</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">50</span>
  <span class="hljs-meta">@State</span> <span class="hljs-attr">containerWidth</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">100</span>
  <span class="hljs-meta">@State</span> <span class="hljs-attr">translateX</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>
  <span class="hljs-meta">@State</span> <span class="hljs-attr">translateY</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>
  change = <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">trans</span> = !<span class="hljs-variable language_">this</span>.<span class="hljs-property">trans</span>

  <span class="hljs-title function_">vp</span>(<span class="hljs-params">a: <span class="hljs-built_in">number</span></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">vp2px</span>(a)
  }

  <span class="hljs-keyword">private</span> <span class="hljs-title function_">buildImageTransform</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> matrix1 = matrix4.<span class="hljs-title function_">identity</span>()
      .<span class="hljs-title function_">translate</span>({
        <span class="hljs-attr">x</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">vp</span>((<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getContainerWidth</span>() - <span class="hljs-number">50</span>) / <span class="hljs-number">2</span>), 
        <span class="hljs-attr">y</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">vp</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getContainerHeight</span>() - <span class="hljs-number">50</span> - <span class="hljs-number">20</span> - <span class="hljs-number">5</span> - <span class="hljs-number">6</span>)
      })
    <span class="hljs-keyword">const</span> matrix2 = matrix4.<span class="hljs-title function_">identity</span>()
      .<span class="hljs-title function_">scale</span>({
        <span class="hljs-attr">x</span>: <span class="hljs-number">30</span> / <span class="hljs-number">50</span>,
        <span class="hljs-attr">y</span>: <span class="hljs-number">30</span> / <span class="hljs-number">50</span>,
        <span class="hljs-attr">centerX</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">vp</span>(-<span class="hljs-number">50</span> / <span class="hljs-number">2</span>), <span class="hljs-comment">//缩放中心为左上角</span>
        <span class="hljs-attr">centerY</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">vp</span>(-<span class="hljs-number">50</span> / <span class="hljs-number">2</span>),
      })
      .<span class="hljs-title function_">translate</span>({ <span class="hljs-attr">x</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">vp</span>(<span class="hljs-number">0</span> + <span class="hljs-number">3</span>), <span class="hljs-attr">y</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">vp</span>((<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getContainerHeight</span>() - <span class="hljs-number">30</span>) / <span class="hljs-number">2</span>) }) <span class="hljs-comment">//如果在scale之前，还要消除缩放系数</span>
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">trans</span> ? matrix2 : matrix1
  }

  <span class="hljs-keyword">private</span> <span class="hljs-title function_">buildTextTransform</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> matrix1 = matrix4.<span class="hljs-title function_">identity</span>()
      .<span class="hljs-title function_">translate</span>({
        <span class="hljs-attr">x</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">vp</span>((<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getContainerWidth</span>() - <span class="hljs-number">70</span>) / <span class="hljs-number">2</span>),
        <span class="hljs-attr">y</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">vp</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getContainerHeight</span>() - (<span class="hljs-number">20</span> + <span class="hljs-number">6</span>))
      })
    <span class="hljs-keyword">const</span> matrix2 = matrix4.<span class="hljs-title function_">identity</span>()
      .<span class="hljs-title function_">translate</span>({ <span class="hljs-attr">x</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">vp</span>(<span class="hljs-number">30</span> + <span class="hljs-number">3</span> + <span class="hljs-number">4</span>), <span class="hljs-attr">y</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">vp</span>((<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getContainerHeight</span>() - <span class="hljs-number">20</span>) / <span class="hljs-number">2</span>) }) <span class="hljs-comment">//如果在scale之前，还要消除缩放系数</span>
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">trans</span> ? matrix2 : matrix1
  }

  <span class="hljs-title function_">getContainerWidth</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">trans</span> ? (<span class="hljs-number">30</span> + <span class="hljs-number">70</span> + <span class="hljs-number">3</span> + <span class="hljs-number">4</span>) : <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">50</span>, <span class="hljs-number">70</span>)
  }

  <span class="hljs-title function_">getContainerHeight</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">trans</span> ? <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">30</span>, <span class="hljs-number">25</span>) : (<span class="hljs-number">20</span> + <span class="hljs-number">50</span> + <span class="hljs-number">5</span> + <span class="hljs-number">6</span>)
  }

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>() {
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'变形'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">animateTo</span>({ <span class="hljs-attr">duration</span>: <span class="hljs-number">300</span> }, <span class="hljs-variable language_">this</span>.<span class="hljs-property">change</span>))
      <span class="hljs-title class_">Column</span>() {
        <span class="hljs-title class_">Text</span>(<span class="hljs-string">'文字'</span>)
          .<span class="hljs-title function_">borderWidth</span>(<span class="hljs-number">1</span>)
          .<span class="hljs-title function_">size</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">70</span>, <span class="hljs-attr">height</span>: <span class="hljs-number">20</span> })
          .<span class="hljs-title function_">position</span>({ <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span> })
          .<span class="hljs-title function_">transform</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">buildTextTransform</span>())
          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'文字'</span>))

        <span class="hljs-title class_">Image</span>($r(<span class="hljs-string">'sys.media.AI_form'</span>))
          .<span class="hljs-title function_">position</span>({ <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span> })
          .<span class="hljs-title function_">size</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">50</span>, <span class="hljs-attr">height</span>: <span class="hljs-number">50</span> })
          .<span class="hljs-title function_">borderWidth</span>(<span class="hljs-number">1</span>)
          .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#ffd3a06e'</span>)
          .<span class="hljs-title function_">transform</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">buildImageTransform</span>())
          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'图片'</span>))
      }
      .<span class="hljs-title function_">size</span>({ <span class="hljs-attr">width</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getContainerWidth</span>(), <span class="hljs-attr">height</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getContainerHeight</span>() })
      .<span class="hljs-title function_">borderWidth</span>(<span class="hljs-number">1</span>)
      .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'容器'</span>))

      <span class="hljs-title class_">Blank</span>().<span class="hljs-title function_">height</span>(<span class="hljs-number">300</span>).<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#ffc0f3dd'</span>)

    }.<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>).<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#fffff8d6'</span>)
  }
}

<span class="hljs-meta">@Component</span>
struct B {
  <span class="hljs-meta">@State</span> <span class="hljs-attr">trans</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>
  change = <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">trans</span> = !<span class="hljs-variable language_">this</span>.<span class="hljs-property">trans</span>

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>() {
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'变形'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">animateTo</span>({ <span class="hljs-attr">duration</span>: <span class="hljs-number">300</span> }, <span class="hljs-variable language_">this</span>.<span class="hljs-property">change</span>))

      <span class="hljs-comment">// 容器</span>
      <span class="hljs-title class_">Column</span>() {
        <span class="hljs-comment">// 文字</span>
        <span class="hljs-title class_">Text</span>(<span class="hljs-string">'文字'</span>)
          .<span class="hljs-title function_">size</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">70</span>, <span class="hljs-attr">height</span>: <span class="hljs-number">20</span> })
          .<span class="hljs-title function_">position</span>({ <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span> })
          .<span class="hljs-title function_">translate</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">trans</span> ?
            { <span class="hljs-attr">x</span>: <span class="hljs-number">30</span> + <span class="hljs-number">3</span> + <span class="hljs-number">4</span>, <span class="hljs-attr">y</span>: (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">30</span>, <span class="hljs-number">25</span>) - <span class="hljs-number">20</span>) / <span class="hljs-number">2</span> } :
            { <span class="hljs-attr">x</span>: (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">50</span>, <span class="hljs-number">70</span>) - <span class="hljs-number">70</span>) / <span class="hljs-number">2</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">50</span> + <span class="hljs-number">5</span> })
          .<span class="hljs-title function_">borderWidth</span>(<span class="hljs-number">1</span>)
          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'文字'</span>))

        <span class="hljs-comment">// 图片</span>
        <span class="hljs-title class_">Image</span>($r(<span class="hljs-string">'sys.media.AI_form'</span>))
          .<span class="hljs-title function_">size</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">50</span>, <span class="hljs-attr">height</span>: <span class="hljs-number">50</span> })
          .<span class="hljs-title function_">position</span>({ <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span> })
          .<span class="hljs-title function_">scale</span>({
            <span class="hljs-attr">x</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">trans</span> ? <span class="hljs-number">30</span> / <span class="hljs-number">50</span> : <span class="hljs-number">1</span>,
            <span class="hljs-attr">y</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">trans</span> ? <span class="hljs-number">30</span> / <span class="hljs-number">50</span> : <span class="hljs-number">1</span>,
            <span class="hljs-attr">centerX</span>: <span class="hljs-number">0</span>,
            <span class="hljs-attr">centerY</span>: <span class="hljs-number">0</span>
          })
          .<span class="hljs-title function_">translate</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">trans</span> ?
            { <span class="hljs-attr">x</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">y</span>: (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">30</span>, <span class="hljs-number">25</span>) - <span class="hljs-number">30</span>) / <span class="hljs-number">2</span> } :
            { <span class="hljs-attr">x</span>: (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">50</span>, <span class="hljs-number">70</span>) - <span class="hljs-number">50</span>) / <span class="hljs-number">2</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span> })
          .<span class="hljs-title function_">borderWidth</span>(<span class="hljs-number">1</span>)
          .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#ffd7b6e9'</span>)
          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'图片'</span>))
      }
      .<span class="hljs-title function_">size</span>({
        <span class="hljs-attr">width</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">trans</span> ? (<span class="hljs-number">30</span> + <span class="hljs-number">3</span> + <span class="hljs-number">70</span> + <span class="hljs-number">4</span>) : <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">50</span>, <span class="hljs-number">70</span>),
        <span class="hljs-attr">height</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">trans</span> ? <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">30</span>, <span class="hljs-number">25</span>) : (<span class="hljs-number">50</span> + <span class="hljs-number">5</span> + <span class="hljs-number">20</span> + <span class="hljs-number">6</span>)
      })
      .<span class="hljs-title function_">borderWidth</span>(<span class="hljs-number">1</span>)
      .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'容器'</span>))

      <span class="hljs-title class_">Blank</span>().<span class="hljs-title function_">height</span>(<span class="hljs-number">300</span>).<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#ffc0f3dd'</span>)
    }
    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#fffff8d6'</span>)
  }
}
</code></pre>
<h4 data-id="heading-16">注意事项</h4>
<ol>
<li><strong>独立运行</strong>：这是一个独立的 Demo，不依赖本系列文章中的其他复杂组件。</li>
<li><strong>两种实现对比</strong>：代码中包含了 <code>Component A</code> 和 <code>Component B</code> 两个组件，它们都实现了相同的视觉效果，但方式不同：
<ul>
<li><code>Component A</code> 使用 <code>transform(matrix4)</code>，这是一种更底层、更强大的矩阵变换方式。</li>
<li><code>Component B</code> 使用 <code>translate</code> 和 <code>scale</code>，这种方式更直观，也是本系列文章中推荐优先使用的方式。</li>
</ul>
</li>
<li><strong>与文章思想的关联</strong>：示例为了简化，将两态的坐标（横向/纵向）直接硬编码在了组件内部。在真实的大型项目中，这些坐标值应该由独立的"几何计算层"（即后续文章中提到的 <code>GeometryCalculator</code>）来提供，UI 层只负责消费这些计算结果。这正是"几何驱动"架构的核心思想。</li>
</ol>
<hr/>
<p><strong>写在最后</strong>：这是《复杂tab动效组件架构设计》系列专栏的第1篇（前面有一篇序章），后续会继续展开每个技术点的实现细节。感兴趣的话可以关注专栏。欢迎在评论区分享你的经验和踩过的坑。如果这篇文章对你有启发，也欢迎点赞支持，这会是我继续分享的动力。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3日期计算器实现方案]]></title>    <link>https://juejin.cn/post/7599526246503350306</link>    <guid>https://juejin.cn/post/7599526246503350306</guid>    <pubDate>2026-01-26T12:57:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599526246503350306" data-draft-id="7599526246503333922" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3日期计算器实现方案"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2026-01-26T12:57:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="滕青山"/> <meta itemprop="url" content="https://juejin.cn/user/3206601805674094"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3日期计算器实现方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3206601805674094/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    滕青山
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T12:57:21.000Z" title="Mon Jan 26 2026 12:57:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在线工具网址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fsee-tool.com%2Fdate-calculator" target="_blank" title="https://see-tool.com/date-calculator" ref="nofollow noopener noreferrer">see-tool.com/date-calcul…</a></p>
</blockquote>
<blockquote>
<p>工具截图：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73218a9cadbe4d43abc356809916483e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ruV6Z2S5bGx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770037041&amp;x-signature=%2BsdYJ8Iisb5mhZ2OsbueuG7tjzw%3D" alt="工具截图.png" loading="lazy"/></p>
</blockquote>
<h2 data-id="heading-0">一、核心功能设计</h2>
<p>日期计算器包含四个独立模块:</p>
<ol>
<li><strong>日期间隔计算</strong>: 计算两个日期之间的天数、周数、月数、年数</li>
<li><strong>日期加减计算</strong>: 在基准日期上加减指定时间单位</li>
<li><strong>年龄计算</strong>: 精确计算年龄(年/月/日)</li>
<li><strong>工作日计算</strong>: 统计工作日、周末天数</li>
</ol>
<h2 data-id="heading-1">二、日期间隔计算实现</h2>
<h3 data-id="heading-2">2.1 核心计算逻辑</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> dateDiff = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (!startDate.<span class="hljs-property">value</span> || !endDate.<span class="hljs-property">value</span>) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">days</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">weeks</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">months</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">years</span>: <span class="hljs-number">0</span> }
  }

  <span class="hljs-keyword">const</span> start = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(startDate.<span class="hljs-property">value</span>)
  <span class="hljs-keyword">const</span> end = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(endDate.<span class="hljs-property">value</span>)

  <span class="hljs-comment">// 确保开始日期小于结束日期(自动排序)</span>
  <span class="hljs-keyword">const</span> [earlierDate, laterDate] = start &lt;= end ? [start, end] : [end, start]

  <span class="hljs-keyword">let</span> diffTime = laterDate.<span class="hljs-title function_">getTime</span>() - earlierDate.<span class="hljs-title function_">getTime</span>()

  <span class="hljs-comment">// 如果包含结束日期,增加一天</span>
  <span class="hljs-keyword">if</span> (includeEndDate.<span class="hljs-property">value</span>) {
    diffTime += <span class="hljs-number">24</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>
  }

  <span class="hljs-keyword">const</span> diffDays = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(diffTime / (<span class="hljs-number">1000</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">24</span>))

  <span class="hljs-comment">// 计算精确的月数差异</span>
  <span class="hljs-keyword">let</span> months = (laterDate.<span class="hljs-title function_">getFullYear</span>() - earlierDate.<span class="hljs-title function_">getFullYear</span>()) * <span class="hljs-number">12</span>
  months += laterDate.<span class="hljs-title function_">getMonth</span>() - earlierDate.<span class="hljs-title function_">getMonth</span>()

  <span class="hljs-comment">// 如果日期不足一个月,减去一个月</span>
  <span class="hljs-keyword">if</span> (laterDate.<span class="hljs-title function_">getDate</span>() &lt; earlierDate.<span class="hljs-title function_">getDate</span>()) {
    months--
  }

  <span class="hljs-comment">// 计算年数</span>
  <span class="hljs-keyword">const</span> years = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(months / <span class="hljs-number">12</span>)

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">days</span>: diffDays,
    <span class="hljs-attr">weeks</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(diffDays / <span class="hljs-number">7</span>),
    <span class="hljs-attr">months</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, months),
    <span class="hljs-attr">years</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, years)
  }
})
</code></pre>
<p><strong>关键点</strong>:</p>
<ol>
<li><strong>自动排序</strong>: 无论用户输入顺序,自动识别较早和较晚的日期</li>
<li><strong>包含结束日期</strong>: 可选项,影响天数计算(+1天)</li>
<li><strong>精确月数</strong>: 考虑日期不足一个月的情况</li>
<li><strong>负数保护</strong>: 使用 <code>Math.max(0, value)</code> 防止负数</li>
</ol>
<h3 data-id="heading-3">2.2 辅助工具函数</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 交换开始和结束日期</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">swapDates</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> temp = startDate.<span class="hljs-property">value</span>
  startDate.<span class="hljs-property">value</span> = endDate.<span class="hljs-property">value</span>
  endDate.<span class="hljs-property">value</span> = temp
}

<span class="hljs-comment">// 设置结束日期为今天</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">setToday</span> = (<span class="hljs-params">type</span>) =&gt; {
  <span class="hljs-keyword">if</span> (!process.<span class="hljs-property">client</span>) <span class="hljs-keyword">return</span>
  <span class="hljs-keyword">const</span> today = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>().<span class="hljs-title function_">split</span>(<span class="hljs-string">'T'</span>)[<span class="hljs-number">0</span>]
  <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'diff'</span>) {
    endDate.<span class="hljs-property">value</span> = today
  }
}
</code></pre>
<h2 data-id="heading-4">三、日期加减计算实现</h2>
<h3 data-id="heading-5">3.1 核心计算逻辑</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> calculatedDate = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (!baseDate.<span class="hljs-property">value</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>
  }

  <span class="hljs-keyword">if</span> (!amount.<span class="hljs-property">value</span> || amount.<span class="hljs-property">value</span> === <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> baseDate.<span class="hljs-property">value</span>
  }

  <span class="hljs-keyword">const</span> base = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(baseDate.<span class="hljs-property">value</span>)
  <span class="hljs-comment">// 根据操作类型确定正负</span>
  <span class="hljs-keyword">const</span> value = operation.<span class="hljs-property">value</span> === <span class="hljs-string">'add'</span> ? <span class="hljs-built_in">parseInt</span>(amount.<span class="hljs-property">value</span>) : -<span class="hljs-built_in">parseInt</span>(amount.<span class="hljs-property">value</span>)

  <span class="hljs-keyword">switch</span> (unit.<span class="hljs-property">value</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'days'</span>:
      base.<span class="hljs-title function_">setDate</span>(base.<span class="hljs-title function_">getDate</span>() + value)
      <span class="hljs-keyword">break</span>
    <span class="hljs-keyword">case</span> <span class="hljs-string">'weeks'</span>:
      base.<span class="hljs-title function_">setDate</span>(base.<span class="hljs-title function_">getDate</span>() + (value * <span class="hljs-number">7</span>))
      <span class="hljs-keyword">break</span>
    <span class="hljs-keyword">case</span> <span class="hljs-string">'months'</span>:
      base.<span class="hljs-title function_">setMonth</span>(base.<span class="hljs-title function_">getMonth</span>() + value)
      <span class="hljs-keyword">break</span>
    <span class="hljs-keyword">case</span> <span class="hljs-string">'years'</span>:
      base.<span class="hljs-title function_">setFullYear</span>(base.<span class="hljs-title function_">getFullYear</span>() + value)
      <span class="hljs-keyword">break</span>
  }

  <span class="hljs-keyword">return</span> base.<span class="hljs-title function_">toISOString</span>().<span class="hljs-title function_">split</span>(<span class="hljs-string">'T'</span>)[<span class="hljs-number">0</span>]
})
</code></pre>
<p><strong>关键点</strong>:</p>
<ol>
<li><strong>操作符处理</strong>: 减法通过负数实现,统一使用加法逻辑</li>
<li><strong>原生 Date API</strong>: 利用 <code>setDate</code>/<code>setMonth</code>/<code>setFullYear</code> 自动处理溢出</li>
<li><strong>格式化输出</strong>: <code>toISOString().split('T')[0]</code> 获取 YYYY-MM-DD 格式</li>
</ol>
<h3 data-id="heading-6">3.2 获取星期几</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">getWeekday</span> = (<span class="hljs-params">dateStr</span>) =&gt; {
  <span class="hljs-keyword">if</span> (!dateStr) <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>
  <span class="hljs-keyword">const</span> weekdays = <span class="hljs-title function_">tm</span>(<span class="hljs-string">'dateCalculator.weekdays'</span>)
  <span class="hljs-keyword">if</span> (!weekdays || !<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(weekdays)) <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>
  <span class="hljs-keyword">const</span> date = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(dateStr)
  <span class="hljs-keyword">return</span> weekdays[date.<span class="hljs-title function_">getDay</span>()] || <span class="hljs-string">''</span>
}
</code></pre>
<p><strong>说明</strong>:</p>
<ul>
<li><code>getDay()</code> 返回 0-6,其中 0 代表周日</li>
<li>从国际化配置中读取星期名称数组</li>
</ul>
<h2 data-id="heading-7">四、年龄计算实现</h2>
<h3 data-id="heading-8">4.1 精确年龄计算</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> age = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (!birthDate.<span class="hljs-property">value</span> || !ageCalculateDate.<span class="hljs-property">value</span>) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">years</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">months</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">days</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">totalDays</span>: <span class="hljs-number">0</span> }
  }

  <span class="hljs-keyword">const</span> birth = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(birthDate.<span class="hljs-property">value</span>)
  <span class="hljs-keyword">const</span> calculate = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(ageCalculateDate.<span class="hljs-property">value</span>)

  <span class="hljs-comment">// 如果出生日期晚于计算日期,返回0</span>
  <span class="hljs-keyword">if</span> (birth &gt; calculate) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">years</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">months</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">days</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">totalDays</span>: <span class="hljs-number">0</span> }
  }

  <span class="hljs-comment">// 计算精确年龄</span>
  <span class="hljs-keyword">let</span> years = calculate.<span class="hljs-title function_">getFullYear</span>() - birth.<span class="hljs-title function_">getFullYear</span>()
  <span class="hljs-keyword">let</span> months = calculate.<span class="hljs-title function_">getMonth</span>() - birth.<span class="hljs-title function_">getMonth</span>()
  <span class="hljs-keyword">let</span> days = calculate.<span class="hljs-title function_">getDate</span>() - birth.<span class="hljs-title function_">getDate</span>()

  <span class="hljs-comment">// 调整天数</span>
  <span class="hljs-keyword">if</span> (days &lt; <span class="hljs-number">0</span>) {
    months--
    <span class="hljs-comment">// 获取上个月的天数</span>
    <span class="hljs-keyword">const</span> lastMonth = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(calculate.<span class="hljs-title function_">getFullYear</span>(), calculate.<span class="hljs-title function_">getMonth</span>(), <span class="hljs-number">0</span>)
    days += lastMonth.<span class="hljs-title function_">getDate</span>()
  }

  <span class="hljs-comment">// 调整月数</span>
  <span class="hljs-keyword">if</span> (months &lt; <span class="hljs-number">0</span>) {
    years--
    months += <span class="hljs-number">12</span>
  }

  <span class="hljs-comment">// 计算总天数</span>
  <span class="hljs-keyword">const</span> totalDays = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>((calculate.<span class="hljs-title function_">getTime</span>() - birth.<span class="hljs-title function_">getTime</span>()) / (<span class="hljs-number">1000</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">24</span>))

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">years</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, years),
    <span class="hljs-attr">months</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, months),
    <span class="hljs-attr">days</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, days),
    <span class="hljs-attr">totalDays</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, totalDays)
  }
})
</code></pre>
<p><strong>关键点</strong>:</p>
<ol>
<li><strong>逐级调整</strong>: 先调整天数,再调整月数,最后得到年数</li>
<li><strong>借位逻辑</strong>: 天数不足时从月份借位,月份不足时从年份借位</li>
<li><strong>上月天数</strong>: 使用 <code>new Date(year, month, 0)</code> 获取上月最后一天</li>
<li><strong>总天数</strong>: 单独计算,用于显示"已活xx天"</li>
</ol>
<h3 data-id="heading-9">4.2 派生数据计算</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 模板中使用</span>
<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(age.<span class="hljs-property">totalDays</span> / <span class="hljs-number">30.44</span>)  <span class="hljs-comment">// 总月数(平均每月30.44天)</span>
<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(age.<span class="hljs-property">totalDays</span> / <span class="hljs-number">7</span>)      <span class="hljs-comment">// 总周数</span>
age.<span class="hljs-property">totalDays</span>                      <span class="hljs-comment">// 总天数</span>
</code></pre>
<h2 data-id="heading-10">五、工作日计算实现</h2>
<h3 data-id="heading-11">5.1 核心计算逻辑</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> workDays = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (!workStartDate.<span class="hljs-property">value</span> || !workEndDate.<span class="hljs-property">value</span>) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">total</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">weekdays</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">weekends</span>: <span class="hljs-number">0</span> }
  }

  <span class="hljs-keyword">const</span> start = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(workStartDate.<span class="hljs-property">value</span>)
  <span class="hljs-keyword">const</span> end = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(workEndDate.<span class="hljs-property">value</span>)

  <span class="hljs-comment">// 确保开始日期不大于结束日期</span>
  <span class="hljs-keyword">if</span> (start &gt; end) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">total</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">weekdays</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">weekends</span>: <span class="hljs-number">0</span> }
  }

  <span class="hljs-keyword">let</span> weekdays = <span class="hljs-number">0</span>
  <span class="hljs-keyword">let</span> weekends = <span class="hljs-number">0</span>
  <span class="hljs-keyword">const</span> current = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(start)

  <span class="hljs-comment">// 包含开始和结束日期</span>
  <span class="hljs-keyword">while</span> (current &lt;= end) {
    <span class="hljs-keyword">const</span> dayOfWeek = current.<span class="hljs-title function_">getDay</span>()
    <span class="hljs-keyword">if</span> (dayOfWeek === <span class="hljs-number">0</span> || dayOfWeek === <span class="hljs-number">6</span>) { <span class="hljs-comment">// 周日=0, 周六=6</span>
      weekends++
    } <span class="hljs-keyword">else</span> {
      weekdays++
    }
    current.<span class="hljs-title function_">setDate</span>(current.<span class="hljs-title function_">getDate</span>() + <span class="hljs-number">1</span>)
  }

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">total</span>: weekdays + weekends,
    <span class="hljs-attr">weekdays</span>: excludeWeekends.<span class="hljs-property">value</span> ? weekdays : weekdays + weekends,
    weekends
  }
})
</code></pre>
<p><strong>关键点</strong>:</p>
<ol>
<li><strong>逐日遍历</strong>: 从开始日期循环到结束日期,逐日判断</li>
<li><strong>星期判断</strong>: <code>getDay()</code> 返回 0(周日) 或 6(周六) 为周末</li>
<li><strong>可选排除</strong>: 根据 <code>excludeWeekends</code> 决定是否排除周末</li>
<li><strong>包含边界</strong>: 包含开始和结束日期</li>
</ol>
<h2 data-id="heading-12">六、状态管理</h2>
<h3 data-id="heading-13">6.1 响应式状态定义</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Tab 切换</span>
<span class="hljs-keyword">const</span> activeTab = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'difference'</span>)

<span class="hljs-comment">// 日期间隔计算</span>
<span class="hljs-keyword">const</span> startDate = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>)
<span class="hljs-keyword">const</span> endDate = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>)
<span class="hljs-keyword">const</span> includeEndDate = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)

<span class="hljs-comment">// 日期加减计算</span>
<span class="hljs-keyword">const</span> baseDate = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>)
<span class="hljs-keyword">const</span> operation = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'add'</span>)      <span class="hljs-comment">// 'add' | 'subtract'</span>
<span class="hljs-keyword">const</span> amount = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)
<span class="hljs-keyword">const</span> unit = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'days'</span>)          <span class="hljs-comment">// 'days' | 'weeks' | 'months' | 'years'</span>

<span class="hljs-comment">// 工作日计算</span>
<span class="hljs-keyword">const</span> workStartDate = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>)
<span class="hljs-keyword">const</span> workEndDate = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>)
<span class="hljs-keyword">const</span> excludeWeekends = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">true</span>)

<span class="hljs-comment">// 年龄计算</span>
<span class="hljs-keyword">const</span> birthDate = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>)
<span class="hljs-keyword">const</span> ageCalculateDate = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>)
</code></pre>
<h3 data-id="heading-14">6.2 初始化默认值</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (!process.<span class="hljs-property">client</span>) <span class="hljs-keyword">return</span>
  <span class="hljs-keyword">const</span> today = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>().<span class="hljs-title function_">split</span>(<span class="hljs-string">'T'</span>)[<span class="hljs-number">0</span>]
  startDate.<span class="hljs-property">value</span> = today
  endDate.<span class="hljs-property">value</span> = today
  baseDate.<span class="hljs-property">value</span> = today
  workStartDate.<span class="hljs-property">value</span> = today
  workEndDate.<span class="hljs-property">value</span> = today
  birthDate.<span class="hljs-property">value</span> = <span class="hljs-string">''</span>  <span class="hljs-comment">// 不设置默认出生日期</span>
  ageCalculateDate.<span class="hljs-property">value</span> = today
})
</code></pre>
<p><strong>说明</strong>:</p>
<ul>
<li>使用 <code>process.client</code> 判断避免 SSR 问题</li>
<li>出生日期不设默认值,避免误导用户</li>
</ul>
<h2 data-id="heading-15">七、日期处理技巧</h2>
<h3 data-id="heading-16">7.1 Date 对象的自动溢出处理</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// JavaScript 的 Date 会自动处理溢出</span>
<span class="hljs-keyword">const</span> date = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-string">'2024-01-31'</span>)
date.<span class="hljs-title function_">setMonth</span>(date.<span class="hljs-title function_">getMonth</span>() + <span class="hljs-number">1</span>)  <span class="hljs-comment">// 自动变为 2024-03-02(2月没有31日)</span>
</code></pre>
<h3 data-id="heading-17">7.2 获取上月最后一天</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 将日期设为0,会自动回退到上月最后一天</span>
<span class="hljs-keyword">const</span> lastDayOfLastMonth = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(year, month, <span class="hljs-number">0</span>)
</code></pre>
<h3 data-id="heading-18">7.3 日期格式化</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ISO 格式转 YYYY-MM-DD</span>
<span class="hljs-keyword">const</span> dateStr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>().<span class="hljs-title function_">split</span>(<span class="hljs-string">'T'</span>)[<span class="hljs-number">0</span>]
</code></pre>
<h2 data-id="heading-19">八、核心算法总结</h2>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">日期间隔计算:</span>
  时间戳相减 → 转换为天数
  年月日逐级计算 → 处理借位

<span class="hljs-section">日期加减计算:</span>
  原生 Date API → 自动处理溢出

<span class="hljs-section">年龄计算:</span>
  年月日分别相减 → 逐级调整借位

<span class="hljs-section">工作日计算:</span>
  逐日遍历 → 判断星期几 → 统计分类
</code></pre>
<p><strong>核心原则</strong>:</p>
<ol>
<li><strong>利用原生 API</strong>: Date 对象的自动溢出处理</li>
<li><strong>边界处理</strong>: 防止负数、空值、非法日期</li>
<li><strong>精确计算</strong>: 考虑月份天数差异、闰年等特殊情况</li>
<li><strong>用户友好</strong>: 自动排序、可选配置、实时计算</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[FLIP 动画策略：让你的布局变化更加丝滑]]></title>    <link>https://juejin.cn/post/7599496293174460435</link>    <guid>https://juejin.cn/post/7599496293174460435</guid>    <pubDate>2026-01-26T13:20:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599496293174460435" data-draft-id="7599502282601955391" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="FLIP 动画策略：让你的布局变化更加丝滑"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-26T13:20:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="等风起881"/> <meta itemprop="url" content="https://juejin.cn/user/3162618545319111"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            FLIP 动画策略：让你的布局变化更加丝滑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3162618545319111/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    等风起881
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T13:20:28.000Z" title="Mon Jan 26 2026 13:20:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家写交互动效时，最容易遇到一种尴尬：<strong>布局变了，动画却卡了</strong>。</p>
<p>比如：列表排序、卡片展开、Tab 切换、按钮滑块移动……如果我们直接去动画 <code>top/left/width/height</code>，浏览器往往要频繁 <strong>Layout（重排）→ Paint（重绘）</strong>，轻则掉帧，重则“整页抖”。</p>
<p>这篇文章我们用一个简单但非常工程化的策略——<strong>FLIP</strong>，把“昂贵的布局动画”转成“便宜的 transform 动画”，让动效又稳又顺。💡</p>
<hr/>
<h2 data-id="heading-0">目录</h2>
<ul>
<li><a href="#flip-%E5%8A%A8%E7%94%BB%E7%AD%96%E7%95%A5%E8%AE%A9%E4%BD%A0%E7%9A%84%E5%B8%83%E5%B1%80%E5%8F%98%E5%8C%96%E6%9B%B4%E5%8A%A0%E4%B8%9D%E6%BB%91" title="#flip-%E5%8A%A8%E7%94%BB%E7%AD%96%E7%95%A5%E8%AE%A9%E4%BD%A0%E7%9A%84%E5%B8%83%E5%B1%80%E5%8F%98%E5%8C%96%E6%9B%B4%E5%8A%A0%E4%B8%9D%E6%BB%91">FLIP 动画策略：让你的布局变化更加丝滑</a>
<ul>
<li><a href="#%E7%9B%AE%E5%BD%95" title="#%E7%9B%AE%E5%BD%95">目录</a></li>
<li><a href="#%E4%BB%80%E4%B9%88%E6%98%AF-flip" title="#%E4%BB%80%E4%B9%88%E6%98%AF-flip">什么是 FLIP？</a></li>
<li><a href="#flip-%E5%9B%9B%E6%AD%A5%E6%B3%95first--last--invert--play" title="#flip-%E5%9B%9B%E6%AD%A5%E6%B3%95first--last--invert--play">FLIP 四步法：First / Last / Invert / Play</a></li>
<li><a href="#%E4%B8%80%E4%B8%AA%E6%9C%80%E5%B0%8F%E5%8F%AF%E8%BF%90%E8%A1%8C%E7%A4%BA%E4%BE%8B" title="#%E4%B8%80%E4%B8%AA%E6%9C%80%E5%B0%8F%E5%8F%AF%E8%BF%90%E8%A1%8C%E7%A4%BA%E4%BE%8B">一个最小可运行示例</a></li>
<li><a href="#%E5%AE%9E%E6%88%98%E7%94%A8-flip-%E5%81%9A%E4%B8%80%E4%B8%AA-switch-%E6%BB%91%E5%9D%97" title="#%E5%AE%9E%E6%88%98%E7%94%A8-flip-%E5%81%9A%E4%B8%80%E4%B8%AA-switch-%E6%BB%91%E5%9D%97">实战：用 FLIP 做一个 switch 滑块</a></li>
<li><a href="#%E5%B0%81%E8%A3%85%E6%8A%8A-flip-%E5%8F%98%E6%88%90%E4%B8%80%E4%B8%AA%E5%87%BD%E6%95%B0" title="#%E5%B0%81%E8%A3%85%E6%8A%8A-flip-%E5%8F%98%E6%88%90%E4%B8%80%E4%B8%AA%E5%87%BD%E6%95%B0">封装：把 FLIP 变成一个函数</a></li>
<li><a href="#%E4%B8%BA%E4%BB%80%E4%B9%88-flip-%E5%80%BC%E5%BE%97%E6%8A%98%E8%85%BE" title="#%E4%B8%BA%E4%BB%80%E4%B9%88-flip-%E5%80%BC%E5%BE%97%E6%8A%98%E8%85%BE">为什么 FLIP 值得“折腾”？</a></li>
<li><a href="#%E6%8B%93%E5%B1%95waapi-%E4%B8%8E%E5%9B%BE%E5%B1%82%E6%8F%90%E5%8D%87" title="#%E6%8B%93%E5%B1%95waapi-%E4%B8%8E%E5%9B%BE%E5%B1%82%E6%8F%90%E5%8D%87">拓展：WAAPI 与图层提升</a>
<ul>
<li><a href="#elementanimatewaapi" title="#elementanimatewaapi">element.animate()（WAAPI）</a></li>
<li><a href="#%E5%9B%BE%E5%B1%82%E6%8F%90%E5%8D%87layer-promotion" title="#%E5%9B%BE%E5%B1%82%E6%8F%90%E5%8D%87layer-promotion">图层提升（Layer Promotion）</a></li>
</ul>
</li>
<li><a href="#%E5%B0%8F%E7%BB%93" title="#%E5%B0%8F%E7%BB%93">小结</a></li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-1">什么是 FLIP？</h2>
<p><strong>FLIP</strong> 是 <strong>First / Last / Invert / Play</strong> 的缩写，是一种实现 <strong>高性能布局过渡动画</strong> 的策略。</p>
<p>核心思路一句话概括：</p>
<blockquote>
<p>✅ 我们先让布局“直接变到最终态”，再用 <code>transform</code> 把元素“拉回起点”，最后播放 <code>transform</code> 回到 0 的动画。</p>
</blockquote>
<p>为什么这样做更快？⚠️</p>
<ul>
<li>改 <code>width/height/top/left/margin</code> 往往会触发 <strong>Layout</strong>（并可能连带整片区域重绘）。</li>
<li>改 <code>transform/opacity</code> 通常只走 <strong>Composite（合成）</strong>，更多由 GPU 参与，帧率更稳。</li>
</ul>
<hr/>
<h2 data-id="heading-2">FLIP 四步法：First / Last / Invert / Play</h2>
<p>我们把它拆成四步，写代码时基本就是照着这个流程走：</p>
<ol>
<li><strong>First（初始态）</strong>：读取元素当前几何信息（位置/尺寸）。</li>
<li><strong>Last（最终态）</strong>：先更新 DOM 状态/布局，再读取更新后的几何信息。</li>
<li><strong>Invert（反转）</strong>：计算从 First 到 Last 的差值，用 <code>transform</code> 把元素“反向挪回去”。</li>
<li><strong>Play（播放）</strong>：在下一帧移除反向 transform，让它自然过渡到 <code>transform: none</code>。</li>
</ol>
<p>💡小提示：<code>getBoundingClientRect()</code> 会触发一次布局读取（Layout），因此 FLIP 的关键是把读取次数控制在必要的两次（First + Last）。</p>
<hr/>
<h2 data-id="heading-3">一个最小可运行示例</h2>
<p>先来一个“能跑就行”的 FLIP，帮助大家建立直觉。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"box"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"width:100px; height:100px; background:#2563eb; position:absolute;"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"moveBtn"</span>&gt;</span>Move Box<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> box = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"box"</span>)
<span class="hljs-keyword">const</span> moveBtn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"moveBtn"</span>)

<span class="hljs-keyword">let</span> toggled = <span class="hljs-literal">false</span>
moveBtn.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"click"</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 1) First</span>
  <span class="hljs-keyword">const</span> firstRect = box.<span class="hljs-title function_">getBoundingClientRect</span>()

  <span class="hljs-comment">// 2) State：直接切到最终布局</span>
  toggled = !toggled
  box.<span class="hljs-property">style</span>.<span class="hljs-property">marginLeft</span> = toggled ? <span class="hljs-string">"200px"</span> : <span class="hljs-string">"0px"</span>
  box.<span class="hljs-property">style</span>.<span class="hljs-property">marginTop</span> = toggled ? <span class="hljs-string">"200px"</span> : <span class="hljs-string">"0px"</span>

  <span class="hljs-comment">// 3) Last</span>
  <span class="hljs-keyword">const</span> lastRect = box.<span class="hljs-title function_">getBoundingClientRect</span>()

  <span class="hljs-comment">// 4) Invert</span>
  <span class="hljs-keyword">const</span> dx = firstRect.<span class="hljs-property">left</span> - lastRect.<span class="hljs-property">left</span>
  <span class="hljs-keyword">const</span> dy = firstRect.<span class="hljs-property">top</span> - lastRect.<span class="hljs-property">top</span>

  box.<span class="hljs-property">style</span>.<span class="hljs-property">transition</span> = <span class="hljs-string">"none"</span>
  box.<span class="hljs-property">style</span>.<span class="hljs-property">transform</span> = <span class="hljs-string">`translate(<span class="hljs-subst">${dx}</span>px, <span class="hljs-subst">${dy}</span>px)`</span>

  <span class="hljs-comment">// 5) Play</span>
  <span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-function">() =&gt;</span> {
    box.<span class="hljs-property">style</span>.<span class="hljs-property">transition</span> = <span class="hljs-string">"transform 0.5s ease"</span>
    box.<span class="hljs-property">style</span>.<span class="hljs-property">transform</span> = <span class="hljs-string">"translate(0, 0)"</span>
  })
})
</code></pre>
<p>✅ 你会发现：我们并没有“动画布局属性”，而是让布局瞬间完成，然后只动画 <code>transform</code>。</p>
<hr/>
<h2 data-id="heading-4">实战：用 FLIP 做一个 switch 滑块</h2>
<p>接下来上点更像业务的：一个 switch 按钮。</p>
<p>点击时，容器的 <code>justify-content</code> 从 <code>flex-start</code> 切到 <code>flex-end</code>，<strong>滑块会跟着布局跳到另一侧</strong>。FLIP 的目标是：让它“看起来不是跳过去的，而是滑过去的”。✅</p>
<p>为了写样式更爽，我这里用 <strong>TailwindCSS</strong>（你也可以用纯 CSS）。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"h-screen flex justify-center items-center"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
    <span class="hljs-attr">id</span>=<span class="hljs-string">"toggleBtn"</span>
    <span class="hljs-attr">class</span>=<span class="hljs-string">"w-38 h-20 rounded-full bg-black p-2 flex items-center justify-start cursor-pointer transition-colors duration-300"</span>
  &gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"indicator"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"bg-white size-16 rounded-full shadow-md"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> toggleBtn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"toggleBtn"</span>)
<span class="hljs-keyword">const</span> indicator = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"indicator"</span>)

toggleBtn.<span class="hljs-property">onclick</span> = <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// First</span>
  <span class="hljs-keyword">const</span> firstRect = indicator.<span class="hljs-title function_">getBoundingClientRect</span>()

  <span class="hljs-comment">// State：更新布局/样式（此处会导致滑块的最终位置变化）</span>
  <span class="hljs-keyword">const</span> currentJustify = toggleBtn.<span class="hljs-property">style</span>.<span class="hljs-property">justifyContent</span> || <span class="hljs-title function_">getComputedStyle</span>(toggleBtn).<span class="hljs-property">justifyContent</span>
  <span class="hljs-keyword">const</span> isStart = currentJustify === <span class="hljs-string">"flex-start"</span> || currentJustify === <span class="hljs-string">"normal"</span>

  toggleBtn.<span class="hljs-property">style</span>.<span class="hljs-property">justifyContent</span> = isStart ? <span class="hljs-string">"flex-end"</span> : <span class="hljs-string">"flex-start"</span>
  toggleBtn.<span class="hljs-property">classList</span>.<span class="hljs-title function_">toggle</span>(<span class="hljs-string">"bg-black"</span>, !isStart)
  toggleBtn.<span class="hljs-property">classList</span>.<span class="hljs-title function_">toggle</span>(<span class="hljs-string">"bg-green-500"</span>, isStart)

  <span class="hljs-comment">// Last</span>
  <span class="hljs-keyword">const</span> lastRect = indicator.<span class="hljs-title function_">getBoundingClientRect</span>()

  <span class="hljs-comment">// Invert</span>
  <span class="hljs-keyword">const</span> dx = firstRect.<span class="hljs-property">left</span> - lastRect.<span class="hljs-property">left</span>
  <span class="hljs-keyword">const</span> dy = firstRect.<span class="hljs-property">top</span> - lastRect.<span class="hljs-property">top</span>

  <span class="hljs-comment">// Play：用 WAAPI 播放 transform</span>
  indicator.<span class="hljs-title function_">animate</span>([{ <span class="hljs-attr">transform</span>: <span class="hljs-string">`translate(<span class="hljs-subst">${dx}</span>px, <span class="hljs-subst">${dy}</span>px)`</span> }, { <span class="hljs-attr">transform</span>: <span class="hljs-string">"translate(0, 0)"</span> }], {
    <span class="hljs-attr">duration</span>: <span class="hljs-number">300</span>,
    <span class="hljs-attr">easing</span>: <span class="hljs-string">"cubic-bezier(0.34, 1.56, 0.64, 1)"</span>,
  })
}
</code></pre>
<p>💡这里我们用的是原生 <code>element.animate()</code>（WAAPI）。它很适合“短小、一次性、无需写 CSS keyframes”的动效。</p>
<hr/>
<h2 data-id="heading-5">封装：把 FLIP 变成一个函数</h2>
<p>当你在项目里写第二次、第三次 FLIP 时，就会开始嫌它啰嗦。</p>
<p>更工程化的做法是：把 First/Last/Invert/Play 封装起来，业务侧只关心“怎么更新状态”。✅</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * FLIP 动画辅助函数
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Element</span>} <span class="hljs-variable">dom</span> - 需要执行动画的 DOM 元素
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">() =&gt; void</span>} <span class="hljs-variable">updateState</span> - 更新 DOM 状态的回调函数（修改样式、DOM 结构等）
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number | KeyframeAnimationOptions</span>} [options] - 动画配置，支持传入数字(duration)或对象
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">Animation | void</span>} - 返回 Animation，若无需动画则返回 void
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">flipAnimate</span>(<span class="hljs-params">dom, updateState, options = {}</span>) {
  <span class="hljs-keyword">const</span> defaultOptions = {
    <span class="hljs-attr">duration</span>: <span class="hljs-number">300</span>,
    <span class="hljs-attr">easing</span>: <span class="hljs-string">"cubic-bezier(0.34, 1.56, 0.64, 1)"</span>,
    <span class="hljs-attr">fill</span>: <span class="hljs-string">"both"</span>,
  }

  <span class="hljs-keyword">const</span> finalOptions =
    <span class="hljs-keyword">typeof</span> options === <span class="hljs-string">"number"</span> ? { ...defaultOptions, <span class="hljs-attr">duration</span>: options } : { ...defaultOptions, ...options }

  <span class="hljs-comment">// First</span>
  <span class="hljs-keyword">const</span> firstRect = dom.<span class="hljs-title function_">getBoundingClientRect</span>()

  <span class="hljs-comment">// State</span>
  <span class="hljs-title function_">updateState</span>()

  <span class="hljs-comment">// Last</span>
  <span class="hljs-keyword">const</span> lastRect = dom.<span class="hljs-title function_">getBoundingClientRect</span>()

  <span class="hljs-comment">// Invert</span>
  <span class="hljs-keyword">const</span> dx = firstRect.<span class="hljs-property">left</span> - lastRect.<span class="hljs-property">left</span>
  <span class="hljs-keyword">const</span> dy = firstRect.<span class="hljs-property">top</span> - lastRect.<span class="hljs-property">top</span>
  <span class="hljs-keyword">if</span> (dx === <span class="hljs-number">0</span> &amp;&amp; dy === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>

  <span class="hljs-comment">// Play</span>
  <span class="hljs-keyword">return</span> dom.<span class="hljs-title function_">animate</span>([{ <span class="hljs-attr">transform</span>: <span class="hljs-string">`translate(<span class="hljs-subst">${dx}</span>px, <span class="hljs-subst">${dy}</span>px)`</span> }, { <span class="hljs-attr">transform</span>: <span class="hljs-string">"translate(0, 0)"</span> }], finalOptions)
}
</code></pre>
<p>回到刚才的 switch，我们可以把业务代码压缩得非常干净：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> toggleBtn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"toggleBtn"</span>)
<span class="hljs-keyword">const</span> indicator = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"indicator"</span>)

toggleBtn.<span class="hljs-property">onclick</span> = <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">flipAnimate</span>(indicator, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> currentJustify = toggleBtn.<span class="hljs-property">style</span>.<span class="hljs-property">justifyContent</span> || <span class="hljs-title function_">getComputedStyle</span>(toggleBtn).<span class="hljs-property">justifyContent</span>
    <span class="hljs-keyword">const</span> isStart = currentJustify === <span class="hljs-string">"flex-start"</span> || currentJustify === <span class="hljs-string">"normal"</span>

    toggleBtn.<span class="hljs-property">style</span>.<span class="hljs-property">justifyContent</span> = isStart ? <span class="hljs-string">"flex-end"</span> : <span class="hljs-string">"flex-start"</span>
    toggleBtn.<span class="hljs-property">classList</span>.<span class="hljs-title function_">toggle</span>(<span class="hljs-string">"bg-black"</span>, !isStart)
    toggleBtn.<span class="hljs-property">classList</span>.<span class="hljs-title function_">toggle</span>(<span class="hljs-string">"bg-green-500"</span>, isStart)
  })
}
</code></pre>
<p>⚠️注意：原草稿里这里传的是 <code>btn</code>，但变量并不存在；实际应该对“会移动的元素”执行 FLIP，也就是 <code>indicator</code>。</p>
<hr/>
<h2 data-id="heading-6">为什么 FLIP 值得“折腾”？</h2>
<p>大家可能会想：</p>
<blockquote>
<p>“我就动画一下 <code>height</code>，真的有这么严重吗？”</p>
</blockquote>
<p>在简单页面可能还好，但一旦进入真实业务（列表、瀑布流、复杂组件树），布局动画的成本会迅速放大：</p>
<ul>
<li><strong>浏览器压力大</strong>：每一帧都可能触发 Layout，主线程忙到飞起。</li>
<li><strong>影响面更大</strong>：元素尺寸变化会挤压兄弟节点，导致更多区域参与重排/重绘。</li>
</ul>
<p>而 FLIP 的优势很明确 ✅：</p>
<ul>
<li>动画过程主要是 <strong>transform 合成</strong>，对主线程更友好。</li>
<li>浏览器通常只需要在动画前后各读取一次布局（First + Last）。</li>
</ul>
<hr/>
<h2 data-id="heading-7">拓展：WAAPI 与图层提升</h2>
<h3 data-id="heading-8">element.animate()（WAAPI）</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FElement%2Fanimate" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/Element/animate" ref="nofollow noopener noreferrer"><code>element.animate()</code></a> 是原生 <strong>Web Animations API（WAAPI）</strong> 的核心入口。</p>
<p>适用场景：</p>
<ul>
<li>✅ 动画由 JS 控制（比如 FLIP 算出来的 <code>dx/dy</code>）</li>
<li>✅ 不想写 CSS <code>@keyframes</code></li>
<li>✅ 需要拿到 <code>Animation</code> 对象（暂停/取消/finished 等）</li>
</ul>
<p>常见 options：</p>
<ul>
<li><code>duration</code>：持续时间（ms）</li>
<li><code>easing</code>：缓动（如 <code>cubic-bezier(...)</code>）</li>
<li><code>fill</code>：结束状态（<code>forwards/backwards/both/none</code>）</li>
<li><code>iterations</code> / <code>delay</code> / <code>direction</code> / <code>playbackRate</code></li>
</ul>
<h3 data-id="heading-9">图层提升（Layer Promotion）</h3>
<p><strong>图层提升</strong>可以理解成：浏览器把某个元素“单独拎到一个可合成图层”，让它的 <code>transform/opacity</code> 动画更容易稳定在高帧率。</p>
<p>一个通俗类比 💡：</p>
<ul>
<li>背景画在纸上</li>
<li>角色画在透明胶片上</li>
<li>移动角色时，只移动胶片，不用重画背景</li>
</ul>
<p>常见触发方式：</p>
<ul>
<li><code>transform: translateZ(0)</code> / <code>translate3d(0,0,0)</code></li>
<li><code>will-change: transform</code>（⚠️按需使用，别给一堆元素常驻）</li>
<li>元素正在进行 <code>transform/opacity</code> 动画（浏览器可能自动提升）</li>
</ul>
<p>为什么封装里要做 <code>dx === 0 &amp;&amp; dy === 0</code> 的提前返回？✅</p>
<ul>
<li>如果明明没动还强行动画，浏览器可能依然创建合成层、分配显存、做无意义的合成开销。</li>
<li>提前返回能避免“不必要的图层提升”，让性能更稳。</li>
</ul>
<hr/>
<h2 data-id="heading-10">小结</h2>
<ul>
<li><strong>FLIP</strong> 的本质：把“布局变化”变成“transform 动画”。</li>
<li>最关键的动作：<strong>只读两次布局（First + Last）</strong>，动画只动 <code>transform</code>。</li>
<li>适合场景：排序/插入/展开折叠/布局切换等“元素最终位置由布局决定”的动效。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我接手了一个 10 年前的 jQuery 老项目，用 Web Components 给它续了命]]></title>    <link>https://juejin.cn/post/7599586891084726306</link>    <guid>https://juejin.cn/post/7599586891084726306</guid>    <pubDate>2026-01-27T01:56:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599586891084726306" data-draft-id="7599586891084415010" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我接手了一个 10 年前的 jQuery 老项目，用 Web Components 给它续了命"/> <meta itemprop="keywords" content="前端,JavaScript,架构"/> <meta itemprop="datePublished" content="2026-01-27T01:56:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ErpanOmer"/> <meta itemprop="url" content="https://juejin.cn/user/3878732754331096"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我接手了一个 10 年前的 jQuery 老项目，用 Web Components 给它续了命
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3878732754331096/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ErpanOmer
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T01:56:24.000Z" title="Tue Jan 27 2026 01:56:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72139c51d14748b19ef5441dd07dcc2c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770083786&amp;x-signature=3J%2FUwxiw8ndJ7DVxDEeglkMqdHQ%3D" alt="3680358_4d2e_2.webp" loading="lazy"/></p>
<p>前几个月，主管把我拉进一个小黑屋，语重心长地说：那个 2015 年上线的 CRM 系统，客户想加个<strong>AI 智能客服</strong>的功能，虽然是个老项目，但这是公司的大金矿，你来负责呗！😃。</p>
<p>我打开代码仓库的那一刻，两眼一黑。</p>
<ul>
<li><strong>jQuery 1.8.3</strong>，古董级的版本。</li>
<li><strong>没有 Webpack，没有 Vite</strong>，只有无尽的 <code>&lt;script&gt;</code> 标签。</li>
<li><strong>全局变量漫天飞</strong>，一个 <code>common.js</code> 有 8000 行，里面充斥着 <code>var</code> 和 <code>function</code>。</li>
<li><strong>CSS 样式全剧透</strong>，随便改个 <code>div</code> 的 padding，隔壁页面的布局就崩了。</li>
</ul>
<p>这时候，我的脑子里有两个小人在打架：</p>
<ul>
<li>全删了！用 Vue3 + Vite 重构！这代码是人写的吗？😖</li>
<li>别冲动！这项目逻辑极其复杂，重构就是火葬场，上线出了 Bug 你负责？</li>
</ul>
<p><strong>现实是残酷的：业务只给了 3 天时间，重构是不可能的😒。</strong></p>
<p>但在满屏 <code>$('#id').show()</code> 的代码里写现代化的 AI 对话界面？光是解决 CSS 样式冲突就能让我加班到猝死。</p>
<p>最后，我没有选择 React，也没用 iframe（通信太麻烦），而是掏出了浏览器原生的大杀器——<strong>Web Components</strong>。</p>
<p>结果？<strong>我只用了一个 JS 文件，就完美地把现代 UI种进了这坨老代码里，而且没引发任何副作用。</strong></p>
<p>今天就来聊聊，这套<strong>屎山续命指南</strong>。</p>
<hr/>
<h3 data-id="heading-0">为什么我选择了 Web Components？</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d9bad370bdb4400956e5a4d0c6d9c98~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770083786&amp;x-signature=WOsfrdldTjHu%2F5aNZESObqZRXzo%3D" alt="1_NE0TVSyDZ2MC7ngfGYa7gg.jpg" loading="lazy"/></p>
<p>在老项目里加新功能，最大的痛点是什么？</p>
<p><strong>不是 JS 逻辑混乱，是 CSS 污染。</strong></p>
<p>老项目里通常会有这种霸道的全局样式：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* style.css */</span>
<span class="hljs-selector-tag">div</span> { <span class="hljs-attribute">box-sizing</span>: content-box; }
<span class="hljs-selector-tag">input</span> { <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid red; } <span class="hljs-comment">/* 不知道哪位前辈留下的坑 */</span>
<span class="hljs-selector-class">.btn</span> { <span class="hljs-attribute">float</span>: left; }
</code></pre>
<p>如果你直接引入一个 Vue/React 组件，这些全局样式会瞬间摧毁你的 UI。</p>
<p>而 <strong>Web Components 的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FAPI%2FWeb_components%2FUsing_shadow_DOM" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/API/Web_components/Using_shadow_DOM" ref="nofollow noopener noreferrer">Shadow DOM（影子 DOM）</a></strong> ，就是为此而生的。</p>
<p>它创造了一个<strong>完全隔离的 DOM 作用域</strong>。</p>
<ul>
<li>外部的 CSS 进不来（你的组件不会乱）。</li>
<li>内部的 CSS 出不去（你不会搞崩老页面）。</li>
</ul>
<hr/>
<h3 data-id="heading-1">在 jQuery 页面里开始植入AI 助手</h3>
<p>假设我们不需要任何构建工具（Webpack/Vite），直接在老页面的 HTML 里写。</p>
<h4 data-id="heading-2">定义组件</h4>
<p>不用引入任何库，直接用原生 ES6 Class。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// ai-assistant.js</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AiAssistant</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">HTMLElement</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">super</span>();
    <span class="hljs-comment">// 1. 开启 Shadow DOM，这是隔离的关键</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shadow</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">attachShadow</span>({ <span class="hljs-attr">mode</span>: <span class="hljs-string">'open'</span> });
  }

  <span class="hljs-title function_">connectedCallback</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 2. 渲染 UI 和 独立的 CSS</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">render</span>();
    <span class="hljs-comment">// 3. 绑定事件</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shadow</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'#send-btn'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleSend</span>();
    });
  }

  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shadow</span>.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">`
      &lt;style&gt;
        /* 这里的样式绝对安全，不会影响外部，也不受外部影响 */
        :host {
          position: fixed;
          bottom: 20px;
          right: 20px;
          z-index: 9999;
        }
        .container {
          background: #fff;
          border-radius: 12px;
          box-shadow: 0 4px 20px rgba(0,0,0,0.15);
          width: 300px;
          font-family: 'Segoe UI', sans-serif; /* 我们可以用现代字体 */
        }
        .header { background: #007bff; color: white; padding: 10px; border-radius: 12px 12px 0 0; }
        .content { height: 200px; padding: 10px; overflow-y: auto; color: #333; }
        input { width: 70%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #007bff; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; }
      &lt;/style&gt;

      &lt;div class="container"&gt;
        &lt;div class="header"&gt;🤖 AI 助手&lt;/div&gt;
        &lt;div class="content" id="chat-box"&gt;
          &lt;div&gt;你好，我是你的智能助手，有什么可以帮您？&lt;/div&gt;
        &lt;/div&gt;
        &lt;div style="padding: 10px; border-top: 1px solid #eee;"&gt;
          &lt;input type="text" id="input-msg" placeholder="输入问题..." /&gt;
          &lt;button id="send-btn"&gt;发送&lt;/button&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    `</span>;
  }

  <span class="hljs-title function_">handleSend</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> input = <span class="hljs-variable language_">this</span>.<span class="hljs-property">shadow</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'#input-msg'</span>);
    <span class="hljs-keyword">const</span> text = input.<span class="hljs-property">value</span>;
    <span class="hljs-keyword">if</span> (!text) <span class="hljs-keyword">return</span>;

    <span class="hljs-comment">// 模拟添加消息</span>
    <span class="hljs-keyword">const</span> chatBox = <span class="hljs-variable language_">this</span>.<span class="hljs-property">shadow</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'#chat-box'</span>);
    chatBox.<span class="hljs-property">innerHTML</span> += <span class="hljs-string">`&lt;div style="text-align:right; margin:5px 0; color: #007bff;"&gt;<span class="hljs-subst">${text}</span>&lt;/div&gt;`</span>;
    input.<span class="hljs-property">value</span> = <span class="hljs-string">''</span>;

    <span class="hljs-comment">// 关键：如何跟外部 jQuery 通信？抛出原生 CustomEvent</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">dispatchEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomEvent</span>(<span class="hljs-string">'new-question'</span>, {
      <span class="hljs-attr">detail</span>: { <span class="hljs-attr">question</span>: text },
      <span class="hljs-attr">bubbles</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">composed</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// 允许穿透 Shadow DOM 冒泡出去</span>
    }));
  }
}

<span class="hljs-comment">// 注册组件</span>
customElements.<span class="hljs-title function_">define</span>(<span class="hljs-string">'ai-assistant'</span>, <span class="hljs-title class_">AiAssistant</span>);
</code></pre>
<h4 data-id="heading-3">在 jQuery 老页面中使用</h4>
<p>只需要引入 JS，然后像写 <code>&lt;div&gt;</code> 一样写标签。</p>
<pre><code class="hljs language-HTML" lang="HTML"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"legacy-style.css"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"jquery-1.8.3.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"old-header"</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  
  <span class="hljs-tag">&lt;<span class="hljs-name">ai-assistant</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">ai-assistant</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"ai-assistant.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-comment">// jQuery 监听组件抛出的事件</span>
    $(<span class="hljs-variable language_">document</span>).<span class="hljs-title function_">ready</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 这里的事件监听依然丝滑</span>
      $(<span class="hljs-string">'ai-assistant'</span>).<span class="hljs-title function_">on</span>(<span class="hljs-string">'new-question'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) {
        <span class="hljs-comment">// 注意：jQuery 的 event 对象封装了一层，原生的 detail 在 originalEvent 里</span>
        <span class="hljs-keyword">var</span> question = e.<span class="hljs-property">originalEvent</span>.<span class="hljs-property">detail</span>.<span class="hljs-property">question</span>;
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"老页面收到了 AI 提问："</span>, question);
        
        <span class="hljs-comment">// 这里可以调用老系统的 API</span>
        <span class="hljs-comment">// $.ajax(...) </span>
      });
    });
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<hr/>
<h3 data-id="heading-4">为什么说这是屎山的终极解法？</h3>
<h4 data-id="heading-5">侵入性为零</h4>
<p>我在 <code>ai-assistant.js</code> 里写了 <code>input { width: 70% }</code>。</p>
<p>如果是普通的 Vue/React 组件，这行样式可能会把老页面所有的 input 都搞乱。</p>
<p>但因为有 <strong>Shadow DOM</strong>，它只对自己生效。老页面的 <code>style.css</code> 就算写了 <code>div { display: none }</code>，也影响不到我 Shadow Root 里的布局。</p>
<h4 data-id="heading-6">技术栈框架无关</h4>
<p>Web Components 是浏览器原生标准。</p>
<p>这意味着，无论这坨屎山是基于 jQuery、AngularJS 1.x、PHP 模板还是 JSP，<strong>只要它是浏览器，它就能跑这个组件</strong>。</p>
<p>未来如果你们终于决定重构，换成了 React 19，这个 <code>&lt;ai-assistant&gt;</code> 标签依然可以直接复制过去用，不用改一行代码。</p>
<h4 data-id="heading-7">渐进式迁移</h4>
<p>我们可以不用搞重构。</p>
<p>今天把用户卡片改成 Web Component。</p>
<p>明天把侧边栏改成 Web Component。</p>
<p>这是一种 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.astro.build%2Fzh-cn%2Fconcepts%2Fislands%2F" target="_blank" title="https://docs.astro.build/zh-cn/concepts/islands/" ref="nofollow noopener noreferrer"><strong>岛屿架构</strong> (Astro 类似)</a> 。我们在屎山💩的海洋里，建立一个个小岛。等岛屿连成一片，屎山自然就消失了。</p>
<hr/>
<h3 data-id="heading-8">避坑指南（干货）</h3>
<p>虽然很香，但也有几个坑要注意：</p>
<ol>
<li><strong>React 兼容性：</strong> 如果你的老项目里混用了 React 16/17，它们对 Web Components 的事件绑定支持不太好（React 19 已完美修复）。</li>
<li><strong>字体图标：</strong> Shadow DOM 里的字体图标（如 FontAwesome）如果定义在外部 CSS 里，内部读不到。需要在 Shadow DOM 的 <code>&lt;style&gt;</code> 里 <code>@import</code> 进来，或者用 <code>&lt;link&gt;</code> 引入。</li>
<li><strong>构建工具：</strong> 如果组件逻辑复杂，还是建议用 <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Flit.dev%2Fdocs%2Fgetting-started%2F" target="_blank" title="https://lit.dev/docs/getting-started/" ref="nofollow noopener noreferrer">Lit</a></strong> 或 <a href="https://link.juejin.cn?target=https%3A%2F%2Fstenciljs.com%2Fdocs%2Fintroduction" target="_blank" title="https://stenciljs.com/docs/introduction" ref="nofollow noopener noreferrer"><strong>Stencil</strong></a> 这种轻量库来写，然后打包成一个 <code>bundle.js</code> 丢给老项目引用，开发体验会好很多（支持 TS、响应式数据）。</li>
</ol>
<hr/>
<p>面对老旧项目，我们往往有两种极端的态度：要么<strong>摆烂</strong>（接着堆屎），要么<strong>激进点</strong>（推倒重来）。</p>
<p>但作为成熟的工程师，我们更需要中间平滑路线。Web Components 恰恰给了我们非常好的解决方案。</p>
<p>下次再遇到老板让你给 10 年前的 JSP 页面加功能，别急着提离职。</p>
<p><strong>试着建一个 <code>&lt;my-feature&gt;</code>，你会发现，屎山其实也没那么可怕😁。</strong></p>
<p>大家平时怎么解决老古董项目呢？🤔</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e601c8868684f018ab356deda14e37f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770083786&amp;x-signature=I8z%2FouEr5p8hqPa1ctV%2FOg7z55U%3D" alt="谢谢大家.gif" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何实现组合式继承]]></title>    <link>https://juejin.cn/post/7599543345980981275</link>    <guid>https://juejin.cn/post/7599543345980981275</guid>    <pubDate>2026-01-26T13:45:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599543345980981275" data-draft-id="7599551824547463194" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何实现组合式继承"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-26T13:45:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="代码猎人"/> <meta itemprop="url" content="https://juejin.cn/user/624972624037374"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何实现组合式继承
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/624972624037374/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    代码猎人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T13:45:07.000Z" title="Mon Jan 26 2026 13:45:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>组合式继承是JavaScript中常用的继承模式，它结合了<strong>原型链继承</strong>和<strong>构造函数继承</strong>的优点。下面是详细的实现方式：</p>
<h2 data-id="heading-0">1. 基本实现</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 父类构造函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Animal</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">colors</span> = [<span class="hljs-string">'red'</span>, <span class="hljs-string">'blue'</span>, <span class="hljs-string">'green'</span>]
}

<span class="hljs-comment">// 父类原型方法</span>
<span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">sayName</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'My name is '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>)
}

<span class="hljs-comment">// 子类构造函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Dog</span>(<span class="hljs-params">name, age</span>) {
    <span class="hljs-comment">// 1. 构造函数继承：继承父类实例属性</span>
    <span class="hljs-title class_">Animal</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, name)  <span class="hljs-comment">// 第二次调用父类构造函数</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age
}

<span class="hljs-comment">// 2. 原型链继承：继承父类原型方法</span>
<span class="hljs-title class_">Dog</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Animal</span>()  <span class="hljs-comment">// 第一次调用父类构造函数</span>
<span class="hljs-title class_">Dog</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> = <span class="hljs-title class_">Dog</span>  <span class="hljs-comment">// 修复constructor指向</span>

<span class="hljs-comment">// 子类自己的方法</span>
<span class="hljs-title class_">Dog</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">sayAge</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'I am '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> + <span class="hljs-string">' years old'</span>)
}

<span class="hljs-comment">// 测试</span>
<span class="hljs-keyword">const</span> dog1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dog</span>(<span class="hljs-string">'Buddy'</span>, <span class="hljs-number">3</span>)
dog1.<span class="hljs-property">colors</span>.<span class="hljs-title function_">push</span>(<span class="hljs-string">'yellow'</span>)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(dog1.<span class="hljs-property">colors</span>)  <span class="hljs-comment">// ['red', 'blue', 'green', 'yellow']</span>
dog1.<span class="hljs-title function_">sayName</span>()  <span class="hljs-comment">// My name is Buddy</span>
dog1.<span class="hljs-title function_">sayAge</span>()   <span class="hljs-comment">// I am 3 years old</span>

<span class="hljs-keyword">const</span> dog2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dog</span>(<span class="hljs-string">'Max'</span>, <span class="hljs-number">5</span>)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(dog2.<span class="hljs-property">colors</span>)  <span class="hljs-comment">// ['red', 'blue', 'green'] - 不受dog1影响</span>
</code></pre>
<h2 data-id="heading-1">2. 优化版本（避免两次调用父类构造函数）</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 父类</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Animal</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">colors</span> = [<span class="hljs-string">'red'</span>, <span class="hljs-string">'blue'</span>, <span class="hljs-string">'green'</span>]
}

<span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">sayName</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'My name is '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>)
}

<span class="hljs-comment">// 子类</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Dog</span>(<span class="hljs-params">name, age</span>) {
    <span class="hljs-title class_">Animal</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, name)  <span class="hljs-comment">// 只调用一次</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age
}

<span class="hljs-comment">// 使用Object.create优化，避免再次调用构造函数</span>
<span class="hljs-title class_">Dog</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>)
<span class="hljs-title class_">Dog</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> = <span class="hljs-title class_">Dog</span>

<span class="hljs-title class_">Dog</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">sayAge</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'I am '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> + <span class="hljs-string">' years old'</span>)
}
</code></pre>
<h2 data-id="heading-2">3. 使用ES6 class语法糖</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">colors</span> = [<span class="hljs-string">'red'</span>, <span class="hljs-string">'blue'</span>, <span class="hljs-string">'green'</span>]
    }
    
    <span class="hljs-title function_">sayName</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'My name is '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>)
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Animal</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name, age</span>) {
        <span class="hljs-variable language_">super</span>(name)  <span class="hljs-comment">// 相当于 Animal.call(this, name)</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age
    }
    
    <span class="hljs-title function_">sayAge</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'I am '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> + <span class="hljs-string">' years old'</span>)
    }
}
</code></pre>
<h2 data-id="heading-3">4. 封装成通用继承函数</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">inherit</span>(<span class="hljs-params">Child, Parent</span>) {
    <span class="hljs-comment">// 继承原型方法</span>
    <span class="hljs-title class_">Child</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">Parent</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>)
    <span class="hljs-comment">// 修复constructor</span>
    <span class="hljs-title class_">Child</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> = <span class="hljs-title class_">Child</span>
    <span class="hljs-comment">// 存储父类引用（可选）</span>
    <span class="hljs-title class_">Child</span>.<span class="hljs-property">super</span> = <span class="hljs-title class_">Parent</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Animal</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name
}

<span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">sayName</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>)
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Dog</span>(<span class="hljs-params">name, age</span>) {
    <span class="hljs-comment">// 调用父类构造函数</span>
    <span class="hljs-title class_">Animal</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, name)
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age
}

<span class="hljs-comment">// 实现继承</span>
<span class="hljs-title function_">inherit</span>(<span class="hljs-title class_">Dog</span>, <span class="hljs-title class_">Animal</span>)

<span class="hljs-comment">// 添加子类方法</span>
<span class="hljs-title class_">Dog</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">sayAge</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span>)
}
</code></pre>
<h2 data-id="heading-4">组合式继承的优点</h2>
<ol>
<li><strong>实例属性独立</strong>：每个实例都有自己的一份属性副本</li>
<li><strong>方法共享</strong>：原型上的方法被所有实例共享，节省内存</li>
<li><strong>参数传递</strong>：子类可以向父类构造函数传递参数</li>
<li><strong>instanceof正常</strong>：<code>instanceof</code> 和 <code>isPrototypeOf()</code> 能正确工作</li>
</ol>
<h2 data-id="heading-5">注意事项</h2>
<ol>
<li><strong>原型链完整</strong>：确保原型链正确连接</li>
<li><strong>constructor修复</strong>：重写原型后要修复constructor指向</li>
<li><strong>方法添加顺序</strong>：先实现继承，再添加子类方法</li>
<li><strong>避免属性重复</strong>：优化版本避免父类构造函数被调用两次</li>
</ol>
<p>组合式继承是JavaScript中最常用的继承模式之一，理解其原理对于掌握JavaScript面向对象编程至关重要。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter 实战：将应用日志自动推送到 Microsoft Teams]]></title>    <link>https://juejin.cn/post/7599586891084562466</link>    <guid>https://juejin.cn/post/7599586891084562466</guid>    <pubDate>2026-01-27T01:36:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599586891084562466" data-draft-id="7597708846769995814" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter 实战：将应用日志自动推送到 Microsoft Teams"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-27T01:36:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JarvanMo"/> <meta itemprop="url" content="https://juejin.cn/user/2348212565845704"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter 实战：将应用日志自动推送到 Microsoft Teams
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2348212565845704/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JarvanMo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T01:36:24.000Z" title="Tue Jan 27 2026 01:36:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>排查线上生产问题，不应该总是意味着要在满屏的日志库或仪表盘里大海捞针，更不该只是被动地等待崩溃报告。有时候，你只需要那些“关键日志”能即时推送到团队面前。</strong></p>
<p>在这篇文章中，我们将分享一套<strong>地道的实战方案</strong>：如何利用 <strong>Incoming Webhooks</strong>，直接将 Flutter 应用的日志实时发送到 <strong>Microsoft Teams</strong>。这套方案不仅包含自定义消息，还会自动附带设备信息、应用版本以及用户上下文等关键数据。</p>
<p><strong>这套方案是以下场景的理想选择：</strong></p>
<ul>
<li>🔴 <strong>崩溃预警</strong></li>
<li>📍 <strong>后台定位日志</strong></li>
<li>🧪 <strong>QA 测试阶段的调试日志</strong></li>
<li>🚀 <strong>轻量化生产监控（无需集成笨重的第三方 SDK）</strong></li>
</ul>
<p><strong>🔧 我们要构建什么？</strong> 我们将亲手打造：</p>
<ol>
<li>一个兼容 Teams 的 <strong>MessageCard（消息卡片）</strong></li>
<li>一个<strong>结构化的日志载体（Payload）</strong></li>
<li>一个简单的 <strong>HTTP 发送器</strong></li>
<li>一个可复用的<strong>日志工具类</strong></li>
</ol>
<p>每当应用中发生重要事件时 → 你的团队就能在 Teams 中收到即时通知。</p>
<p><strong>🧩 前置准备</strong> 在开始敲代码之前，请确保你已具备：</p>
<ul>
<li>一个 Flutter 应用 (Android / iOS)</li>
<li>一个 Microsoft Teams 频道</li>
<li>一个 <strong>Incoming Webhook URL</strong></li>
<li>需安装的 Flutter 依赖包：<code>http</code> 和 <code>device_info_plus</code></li>
</ul>
<p><strong>🔗 第一步：创建 Teams Incoming Webhook</strong></p>
<ol>
<li>打开 <strong>Microsoft Teams</strong></li>
<li>进入你的 <strong>频道 (Channel)</strong> → 点击 <strong>连接器 (Connectors)</strong></li>
<li>添加 <strong>Incoming Webhook</strong></li>
<li>复制生成的 <strong>Webhook URL</strong> ⚠️ <strong>重要提示</strong>：切勿将此 URL 提交到公开的代码仓库中。</li>
</ol>
<p><strong>🧠 深入理解 Teams 消息卡片 (Message Cards)</strong> Teams 接收一种名为 <strong>MessageCard</strong> 的 JSON 格式日志，它支持：</p>
<ul>
<li>标题 (Title) 与 副标题 (Subtitle)</li>
<li><strong>Facts（键值对列表）</strong></li>
<li>图片与颜色标识 我们将利用这些特性，让日志变得<strong>直观易读且具备可操作性</strong>。</li>
</ul>
<p><strong>🏗 第二步：在 Flutter 中构建消息载体</strong> 这个函数将构建一个结构化的日志消息，其中包含：</p>
<ul>
<li>设备详细信息</li>
<li>系统版本</li>
<li>应用版本</li>
<li>用户信息</li>
<li>自定义日志内容</li>
</ul>
<pre><code class="hljs language-dart" lang="dart">PostToTeams getPostToTeams({
  <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> logsToTeams,
  <span class="hljs-built_in">String?</span> subtitle,
}) {
  <span class="hljs-built_in">List</span>&lt;Facts&gt; facts = [];
  <span class="hljs-built_in">List</span>&lt;Sections&gt; sections = [];
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> platform = Platform.isIOS ? <span class="hljs-string">"iOS"</span> : <span class="hljs-string">"Android"</span>;
  facts.add(Facts(<span class="hljs-string">"Date"</span>, <span class="hljs-built_in">DateTime</span>.now().toIso8601String()));
  facts.add(Facts(<span class="hljs-string">"Build Version"</span>, SharedPref.getAppVersion() ?? <span class="hljs-string">""</span>));
  facts.add(Facts(<span class="hljs-string">"Platform"</span>, platform));
  facts.add(Facts(<span class="hljs-string">"Locale"</span>, Platform.localeName));
  facts.add(Facts(<span class="hljs-string">"Processors"</span>, Platform.numberOfProcessors.toString()));
  facts.add(Facts(<span class="hljs-string">"OS"</span>, Platform.operatingSystem));
  facts.add(Facts(<span class="hljs-string">"User Id"</span>, SharedPref.getUserId() ?? <span class="hljs-string">""</span>));
  facts.add(Facts(<span class="hljs-string">"Token"</span>, SharedPref.getToken() ?? <span class="hljs-string">""</span>));
  facts.add(Facts(<span class="hljs-string">"Logs"</span>, logsToTeams));
  sections.add(
    Sections(
      <span class="hljs-string">"Flutter App Logs"</span>,
      subtitle ?? <span class="hljs-string">"Log Type"</span>,
      <span class="hljs-string">"https://teamsnodesample.azurewebsites.net/static/img/image5.png"</span>,
      facts,
    ),
  );
  <span class="hljs-keyword">return</span> PostToTeams(
    <span class="hljs-string">"MessageCard"</span>,
    <span class="hljs-string">"http://schema.org/extensions"</span>,
    <span class="hljs-string">"0076D7"</span>,
    <span class="hljs-string">"New App Log"</span>,
    sections,
  );
}
</code></pre>
<h3 data-id="heading-0">✅ 为什么这套方案效果拔群</h3>
<ul>
<li><strong>结构化</strong>：数据条理清晰，告别杂乱无章的纯文本。</li>
<li><strong>Teams UI 友好</strong>：在 Teams 界面中拥有极佳的视觉阅读体验。</li>
<li><strong>扩展性强</strong>：后续可以轻松添加错误信息、堆栈轨迹（Stack traces）等内容。</li>
</ul>
<hr/>
<h3 data-id="heading-1">🌐 第三步：将日志发送至 Teams</h3>
<p>现在，我们将通过一个简单的 HTTP POST 请求，将封装好的载体（Payload）发送出去。</p>
<pre><code class="hljs language-dart" lang="dart">Future&lt;http.Response&gt; sendLogsToTeams(
    <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; logsToTeams) <span class="hljs-keyword">async</span> {
  <span class="hljs-keyword">final</span> body = json.encode(logsToTeams);

  <span class="hljs-keyword">final</span> response = <span class="hljs-keyword">await</span> http.post(
    <span class="hljs-built_in">Uri</span>.parse(<span class="hljs-string">"YOUR_TEAMS_WEBHOOK_URL"</span>),
    headers: {<span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>},
    body: body,
  );
  <span class="hljs-keyword">return</span> response;
}
</code></pre>
<h3 data-id="heading-2">🚀 第四步：在应用各处随调随用</h3>
<p>现在，你可以在 Flutter 应用的<strong>任何地方</strong>触发日志推送了：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">final</span> post = getPostToTeams(
  logsToTeams:
  <span class="hljs-string">"<span class="hljs-subst">${currentLocation.latitude}</span>, <span class="hljs-subst">${currentLocation.longitude}</span>"</span>,
  subtitle: <span class="hljs-string">"Background Location Update"</span>,
);

sendLogsToTeams(post.toJson());
</code></pre>
<h3 data-id="heading-3">🎉 大功告成 —— 你的日志现在会即时出现在 Microsoft Teams 中。</h3>
<hr/>
<h3 data-id="heading-4">🧠 核心实战场景</h3>
<p>这套方案在以下场景中表现得非常出色：</p>
<ul>
<li>📍 <strong>后台服务</strong>：监控那些没有 UI 交互的后台进程。</li>
<li>❌ <strong>静默失败</strong>：捕捉那些虽然没导致崩溃、但业务逻辑已经出错的异常。</li>
<li>🔄 <strong>API 调试</strong>：实时查看生产环境中接口调用的真实反馈。</li>
<li>🧪 <strong>QA 测试</strong>：测试人员在复现 Bug 时，开发团队能瞬间看到报错堆栈。</li>
<li>🧯 <strong>生产告警</strong>：在不集成 Firebase Crashlytics 的情况下实现轻量级监控。</li>
</ul>
<hr/>
<h3 data-id="heading-5">🔐 安全与最佳实践</h3>
<ul>
<li>❌ <strong>严禁泄露</strong>：绝不要在公开的代码仓库中直接暴露 Webhook URL。</li>
<li>✅ <strong>环境变量</strong>：建议使用环境变量或远程配置（Remote Config）来管理 URL。</li>
<li>❌ <strong>保护隐私</strong>：避免发送用户的密码、Token 等敏感数据。</li>
<li>✅ <strong>流控（Throttle）</strong> ：在生产环境中对日志频率进行限制，防止消息轰炸。</li>
<li>✅ <strong>分级日志</strong>：明确区分 INFO（信息）、WARN（警告）和 ERROR（错误）。</li>
</ul>
<hr/>
<h3 data-id="heading-6">🏁 总结</h3>
<p>这套轻量级的日志系统能让你拥有<strong>实时可视化</strong>的监控能力，而无需集成臃肿的 SDK 或维护复杂的仪表盘。</p>
<p>如果你公司原本就在使用 Microsoft Teams，那么这就是你能为 Flutter 应用构建的<strong>最简单、也最有效的监控工具</strong>之一。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TypeScript namespace 详解：语法用法与使用建议]]></title>    <link>https://juejin.cn/post/7599474528239534120</link>    <guid>https://juejin.cn/post/7599474528239534120</guid>    <pubDate>2026-01-26T14:39:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599474528239534120" data-draft-id="7599514071105355791" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TypeScript namespace 详解：语法用法与使用建议"/> <meta itemprop="keywords" content="TypeScript"/> <meta itemprop="datePublished" content="2026-01-26T14:39:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="如果你好"/> <meta itemprop="url" content="https://juejin.cn/user/2272012281328215"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TypeScript namespace 详解：语法用法与使用建议
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2272012281328215/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    如果你好
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T14:39:04.000Z" title="Mon Jan 26 2026 14:39:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、namespace 是什么？核心作用：归类组织代码</h2>
<p>namespace 是 TypeScript 早期为了解决代码模块化问题设计的语法，核心目的就是<strong>把相关的变量、函数、类、接口等代码集中放到一个独立的容器中</strong>，让代码结构更清晰，同时避免不同功能的代码在全局作用域中命名冲突。</p>
<p>简单来说，就是将同一类功能的代码整合在一起，容器内的代码默认仅能内部使用，想要对外暴露供外部调用，需要做专门的导出标记。</p>
<h3 data-id="heading-1">基础用法：定义命名空间并对外暴露成员</h3>
<p>定义的命名空间内部成员，默认处于封闭状态，外部无法访问；只有添加 <code>export</code> 关键字的成员，才会被对外暴露，外部才能正常调用。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 定义一个名为 Utils 的命名空间</span>
<span class="hljs-keyword">namespace</span> <span class="hljs-title class_">Utils</span> {
  <span class="hljs-comment">// 未加 export，仅能在 Utils 内部使用</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">isString</span>(<span class="hljs-params">value: <span class="hljs-built_in">any</span></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> value === <span class="hljs-string">'string'</span>;
  }

  <span class="hljs-comment">// 内部调用：正常执行</span>
  <span class="hljs-title function_">isString</span>(<span class="hljs-string">'hello'</span>);
}

<span class="hljs-comment">// 外部调用：报错！isString 未对外暴露</span>
<span class="hljs-title class_">Utils</span>.<span class="hljs-title function_">isString</span>(<span class="hljs-string">'world'</span>);
</code></pre>
<p>给需要对外使用的成员添加 <code>export</code>，即可实现外部访问：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">Utils</span> {
  <span class="hljs-comment">// 加 export 标记，对外暴露</span>
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">log</span>(<span class="hljs-params">msg: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(msg);
  }
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">error</span>(<span class="hljs-params">msg: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(msg);
  }
}

<span class="hljs-comment">// 外部可正常调用命名空间的导出成员</span>
<span class="hljs-title class_">Utils</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'执行打印操作'</span>);
<span class="hljs-title class_">Utils</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'执行错误提示'</span>);
</code></pre>
<h3 data-id="heading-2">编译后的实际形态</h3>
<p>TypeScript 会将 namespace 编译为 JavaScript 的<strong>自执行函数 + 全局对象</strong>形式，所有添加 <code>export</code> 的成员，最终都会成为这个全局对象的属性：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 编译后生成的 Utils 代码</span>
<span class="hljs-keyword">var</span> <span class="hljs-title class_">Utils</span>;
(<span class="hljs-keyword">function</span> (<span class="hljs-params">Utils</span>) {
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">log</span>(<span class="hljs-params">msg</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(msg);
  }
  <span class="hljs-comment">// 导出的成员挂载到全局对象 Utils 上</span>
  <span class="hljs-title class_">Utils</span>.<span class="hljs-property">log</span> = log;
})(<span class="hljs-title class_">Utils</span> || (<span class="hljs-title class_">Utils</span> = {}));
</code></pre>
<p>需要注意的是：namespace 并非纯类型语法，编译后会生成真实的 JavaScript 对象，占用运行时内存，这也是它和 ES 模块的重要区别。</p>
<h2 data-id="heading-3">二、namespace 常用实用技巧</h2>
<h3 data-id="heading-4">1. 嵌套命名空间：精细化分类代码</h3>
<p>如果代码功能分类更细致，可以在命名空间内部嵌套定义其他命名空间，实现多层级的代码组织。<strong>内层的命名空间如果需要对外暴露，同样要添加 export 关键字</strong>。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">Utils</span> {
  <span class="hljs-comment">// 嵌套命名空间 Messaging，需加 export 对外暴露</span>
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">namespace</span> <span class="hljs-title class_">Messaging</span> {
    <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">log</span>(<span class="hljs-params">msg: <span class="hljs-built_in">string</span></span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(msg);
    }
  }
}

<span class="hljs-comment">// 外部调用嵌套命名空间的成员：从最外层开始逐层访问</span>
<span class="hljs-title class_">Utils</span>.<span class="hljs-property">Messaging</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'调用嵌套命名空间的方法'</span>);
</code></pre>
<h3 data-id="heading-5">2. 为外部成员起别名：简化代码调用</h3>
<p>如果外部命名空间的成员名称较长，或者调用路径繁琐，可以在当前作用域内用 <code>import</code> 为其起别名，简化后续调用，这种方式可用于命名空间内部或外部。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">Utils</span> {
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">isString</span>(<span class="hljs-params">value: <span class="hljs-built_in">any</span></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> value === <span class="hljs-string">'string'</span>;
  }
}

<span class="hljs-keyword">namespace</span> <span class="hljs-title class_">App</span> {
  <span class="hljs-comment">// 为 Utils.isString 起别名 isString，简化调用</span>
  <span class="hljs-keyword">import</span> isString = <span class="hljs-title class_">Utils</span>.<span class="hljs-property">isString</span>;
  <span class="hljs-comment">// 直接使用别名，无需写完整的命名空间路径</span>
  <span class="hljs-title function_">isString</span>(<span class="hljs-string">'使用别名调用方法'</span>);
}
</code></pre>
<h3 data-id="heading-6">3. 跨文件使用命名空间：三斜杠引用</h3>
<p>如果一个命名空间的代码单独写在一个文件中，在其他文件中想要使用它，早期的写法是使用<strong>三斜杠引用语法</strong>，不过这种方式现在已经不推荐，更规范的方式是使用 ES 模块的 import 导入。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 三斜杠引用 utils.ts 文件，引入其中的命名空间</span>
<span class="hljs-comment">/// &lt;reference path="./utils.ts" /&gt;</span>

<span class="hljs-comment">// 直接使用 utils.ts 中定义的 Utils 命名空间</span>
<span class="hljs-title class_">Utils</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'跨文件调用命名空间成员'</span>);
</code></pre>
<h2 data-id="heading-7">三、namespace 的核心特性：自动合并</h2>
<p>多个同名的 namespace 会在编译时自动合并为一个整体，这是它的重要特性，适合对已有命名空间进行扩展，方便协作开发或修改他人代码。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 第一个同名的 Animals 命名空间</span>
<span class="hljs-keyword">namespace</span> <span class="hljs-title class_">Animals</span> {
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Cat</span> {}
}

<span class="hljs-comment">// 第二个同名的 Animals 命名空间</span>
<span class="hljs-keyword">namespace</span> <span class="hljs-title class_">Animals</span> {
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Legged</span> {
    <span class="hljs-attr">numberOfLegs</span>: <span class="hljs-built_in">number</span>;
  }
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> {}
}

<span class="hljs-comment">// 上述两个命名空间，会自动合并为以下形式</span>
<span class="hljs-keyword">namespace</span> <span class="hljs-title class_">Animals</span> {
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Legged</span> {
    <span class="hljs-attr">numberOfLegs</span>: <span class="hljs-built_in">number</span>;
  }
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Cat</span> {}
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> {}
}
</code></pre>
<p><strong>注意</strong>：只有添加 <code>export</code> 关键字的<strong>对外暴露成员</strong>会参与合并，非导出的内部成员仅能在自身所在的原命名空间中使用，合并后的命名空间无法访问。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">namespace</span> N {
  <span class="hljs-comment">// 非导出成员，仅能在当前 N 内部使用</span>
  <span class="hljs-keyword">const</span> a = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a); <span class="hljs-comment">// 正常执行</span>
  }
}

<span class="hljs-keyword">namespace</span> N {
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">bar</span>(<span class="hljs-params"/>) {
    <span class="hljs-title function_">foo</span>(); <span class="hljs-comment">// 正常执行，foo 是导出成员</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a); <span class="hljs-comment">// 报错！a 是非导出成员，无法访问</span>
  }
}
</code></pre>
<h3 data-id="heading-8">扩展特性：可与函数/类/枚举合并</h3>
<p>namespace 还可以与同名的函数、类、枚举进行合并，实现为这些对象添加额外属性或方法的效果。<strong>注意：函数、类、枚举必须在同名命名空间之前声明</strong>。</p>
<h4 data-id="heading-9">1. 与函数合并：为函数添加属性</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 先声明函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">f</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> f.<span class="hljs-property">version</span>;
}
<span class="hljs-comment">// 同名命名空间为函数添加属性</span>
<span class="hljs-keyword">namespace</span> f {
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> version = <span class="hljs-string">'1.0'</span>;
}
<span class="hljs-comment">// 调用函数</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">f</span>()); <span class="hljs-comment">// '1.0'</span>
<span class="hljs-comment">// 访问函数的新增属性</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(f.<span class="hljs-property">version</span>); <span class="hljs-comment">// '1.0'</span>
</code></pre>
<h4 data-id="heading-10">2. 与类合并：为类添加静态属性</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 先声明类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">C</span> {
  foo = <span class="hljs-number">1</span>;
}
<span class="hljs-comment">// 同名命名空间为类添加静态属性</span>
<span class="hljs-keyword">namespace</span> C {
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> bar = <span class="hljs-number">2</span>;
}
<span class="hljs-comment">// 访问类的静态属性</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(C.<span class="hljs-property">bar</span>); <span class="hljs-comment">// 2</span>
</code></pre>
<h4 data-id="heading-11">3. 与枚举合并：为枚举添加方法</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 先声明枚举</span>
<span class="hljs-keyword">enum</span> E { A, B, C }
<span class="hljs-comment">// 同名命名空间为枚举添加方法</span>
<span class="hljs-keyword">namespace</span> E {
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(E.<span class="hljs-property">C</span>); <span class="hljs-comment">// 2</span>
  }
}
<span class="hljs-comment">// 调用枚举的新增方法</span>
E.<span class="hljs-title function_">foo</span>(); <span class="hljs-comment">// 2</span>
</code></pre>
<p><strong>重要限制</strong>：枚举与同名命名空间合并时，枚举的成员和命名空间的导出成员<strong>不能重名</strong>，否则会直接编译报错。</p>
<h2 data-id="heading-12">四、为什么官方不推荐使用？首选 ES 模块的原因</h2>
<p>namespace 是 ES 模块（import/export）出现之前的过渡性方案，如今 ES 模块已经成为 JavaScript 官方的模块化标准，能够完全替代 namespace，且在标准性、兼容性、灵活性上更有优势，这也是 TS 官方推荐使用 ES 模块的核心原因。</p>
<p>两者核心差异对比：</p>






























<table><thead><tr><th>特性</th><th>namespace</th><th>ES 模块（import/export）</th></tr></thead><tbody><tr><td>语法标准</td><td>TypeScript 专属语法，需编译转换</td><td>JavaScript 官方标准，无需额外编译</td></tr><tr><td>文件使用限制</td><td>一个文件中可定义多个命名空间</td><td>一个文件就是一个独立模块</td></tr><tr><td>运行时影响</td><td>编译后生成全局对象，占用运行时内存</td><td>纯模块化语法，无额外全局对象</td></tr><tr><td>环境兼容性</td><td>仅 TypeScript 环境支持，生态有限</td><td>所有 JavaScript/TypeScript 运行环境均支持</td></tr></tbody></table>
<h3 data-id="heading-13">ES 模块替代 namespace 示例</h3>
<p>原来使用 namespace 的写法，需要嵌套命名空间并多次导出：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// shapes.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">namespace</span> <span class="hljs-title class_">Shapes</span> {
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Triangle</span> {}
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Square</span> {}
}
</code></pre>
<p>使用 ES 模块的写法更简洁，直接导出成员即可，无需嵌套：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// shapes.ts 直接导出类，无额外嵌套</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Triangle</span> {}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Square</span> {}

<span class="hljs-comment">// 其他文件中导入使用</span>
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> shapes <span class="hljs-keyword">from</span> <span class="hljs-string">'./shapes'</span>;
<span class="hljs-comment">// 直接调用导入的成员</span>
<span class="hljs-keyword">const</span> t = <span class="hljs-keyword">new</span> shapes.<span class="hljs-title class_">Triangle</span>();
</code></pre>
<h3 data-id="heading-14">五、总结：什么时候用 namespace？</h3>
<p>namespace 现在已经不是 TS 推荐的模块化方式了，日常开发里只在这几种情况用：</p>
<ol>
<li><strong>改老项目</strong>：老 TS 项目里用了很多 namespace，不用特意全改掉，保持兼容就行；</li>
<li><strong>临时加全局属性</strong>：比如想给 window、Math 加个自定义方法，可临时用；</li>
<li><strong>简单脚本归类</strong>：写少量不用模块化的简单代码时，用它避免全局变量重名。</li>
</ol>
<p><strong>新项目直接用 ES 模块（import/export）</strong> 就好，这是官方推荐的标准写法，兼容更好、也更好维护。学 namespace 主要是为了能看懂老代码，日常维护够用就行。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[手把手教你打造一个完美的返回顶部组件：从踩坑到优雅实现]]></title>    <link>https://juejin.cn/post/7599506068047462400</link>    <guid>https://juejin.cn/post/7599506068047462400</guid>    <pubDate>2026-01-26T15:10:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599506068047462400" data-draft-id="7599532624194617396" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="手把手教你打造一个完美的返回顶部组件：从踩坑到优雅实现"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-26T15:10:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="无敌的拖拉斯旋风"/> <meta itemprop="url" content="https://juejin.cn/user/951508170179208"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            手把手教你打造一个完美的返回顶部组件：从踩坑到优雅实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/951508170179208/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    无敌的拖拉斯旋风
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T15:10:24.000Z" title="Mon Jan 26 2026 15:10:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>作为一个前端开发者，你有没有遇到过这样的情况：页面很长，用户滚动到底部后，想要回到顶部却发现要手动拖拽滚动条？这种体验真的很糟糕。于是，我决定手搓一个返回顶部组件。没想到，这看似简单的功能，背后却藏着不少学问。</p>
<h2 data-id="heading-1">第一步：需求分析与初步构思</h2>
<h3 data-id="heading-2">为什么需要这个组件？</h3>
<p>想象一下，用户正在浏览一篇长文章，或者查看商品列表，当他们滚动到页面底部时，突然想回到顶部看看标题或其他信息。如果没有返回顶部按钮，他们只能：</p>
<ol>
<li>手动拖拽滚动条</li>
<li>点击浏览器的地址栏然后按 Home 键</li>
<li>使用键盘快捷键</li>
</ol>
<p>这些方式都不够直观和便捷。一个小小的返回顶部按钮就能大大提升用户体验。</p>
<h3 data-id="heading-3">组件的核心功能</h3>
<p>经过思考，我给这个组件定了几个基本要求：</p>
<ol>
<li><strong>智能显示</strong>：只有当用户滚动到一定距离后才出现</li>
<li><strong>平滑滚动</strong>：点击后平滑地回到页面顶部</li>
<li><strong>美观易用</strong>：按钮要美观，位置要合适</li>
<li><strong>性能良好</strong>：不能影响页面滚动的流畅性</li>
</ol>
<h2 data-id="heading-4">第二步：动手实现 - 第一版（踩坑版）</h2>
<h3 data-id="heading-5">最初的想法</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">const</span> BackToTop = () =&gt; {
    <span class="hljs-keyword">const</span> [<span class="hljs-keyword">show</span>, setShow] = useState(<span class="hljs-keyword">false</span>);
    
    <span class="hljs-keyword">const</span> handleScroll = () =&gt; {
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">window</span>.scrollY &gt; <span class="hljs-number">300</span>) {
            setShow(<span class="hljs-keyword">true</span>);
        } <span class="hljs-keyword">else</span> {
            setShow(<span class="hljs-keyword">false</span>);
        }
    };
    
    useEffect(() =&gt; {
        <span class="hljs-built_in">window</span>.addEventListener(<span class="hljs-string">'scroll'</span>, handleScroll);
        <span class="hljs-keyword">return</span> () =&gt; <span class="hljs-built_in">window</span>.removeEventListener(<span class="hljs-string">'scroll'</span>, handleScroll);
    }, []);
    
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">show</span> &amp;&amp; &lt;button onClick={() =&gt; <span class="hljs-built_in">window</span>.scrollTo(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>)}&gt;回到顶部&lt;/button&gt;;
};
</code></pre>
<p><strong>当时的想法很简单</strong>：</p>
<ul>
<li>监听滚动事件</li>
<li>当滚动距离超过300px时显示按钮</li>
<li>点击按钮滚动到顶部</li>
</ul>
<h3 data-id="heading-6">惨痛的教训</h3>
<p>当我把这段代码运行起来后，<strong>页面直接卡死了！</strong> Chrome 浏览器提示页面无响应，这让我大吃一惊。</p>
<p>通过开发者工具我发现，<code>scroll</code> 事件在用户滚动时会疯狂触发，每秒钟可能触发几十次甚至上百次。每次触发都会执行 <code>setState</code>，导致 React 频繁重新渲染，页面自然就卡住了。</p>
<h2 data-id="heading-7">第三步：学习与改进 - 性能优化</h2>
<h3 data-id="heading-8">发现问题所在</h3>
<p>经过一番调研，我了解到 <code>scroll</code> 事件是一个高频事件。如果不加处理直接使用，会对性能造成严重影响。这时，我接触到了前端性能优化的经典概念：<strong>节流（Throttle）<strong>和</strong>防抖（Debounce）</strong> 。</p>
<h3 data-id="heading-9">节流 vs 防抖的区别</h3>
<ul>
<li><strong>节流</strong>：在一定时间间隔内只执行一次函数</li>
<li><strong>防抖</strong>：在事件停止触发一段时间后才执行函数</li>
</ul>
<p>对于滚动事件，节流更合适，因为我们需要定期检查滚动位置。</p>
<h3 data-id="heading-10">实现节流函数</h3>
<pre><code class="hljs language-ini" lang="ini">// 在 utils 目录下创建节流函数
export const <span class="hljs-attr">throttle</span> = (func: Function, delay: number) =&gt; {
    let timeoutId: NodeJS.Timeout | <span class="hljs-attr">null</span> = null<span class="hljs-comment">;</span>
    let <span class="hljs-attr">lastExecTime</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
    
    return function (...args: any<span class="hljs-section">[]</span>) {
        const <span class="hljs-attr">currentTime</span> = Date.now()<span class="hljs-comment">;</span>
        
        if (currentTime - lastExecTime &gt; delay) {
            func.apply(this, args)<span class="hljs-comment">;</span>
            <span class="hljs-attr">lastExecTime</span> = currentTime<span class="hljs-comment">;</span>
        } else {
            if (timeoutId) {
                clearTimeout(timeoutId)<span class="hljs-comment">;</span>
            }
            <span class="hljs-attr">timeoutId</span> = setTimeout(() =&gt; {
                func.apply(this, args)<span class="hljs-comment">;</span>
                <span class="hljs-attr">lastExecTime</span> = Date.now()<span class="hljs-comment">;</span>
            }, delay - (currentTime - lastExecTime))<span class="hljs-comment">;</span>
        }
    }<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-11">改进后的组件</h3>
<pre><code class="hljs language-ini" lang="ini">const BackToTop: React.FC&lt;BackToTopProps&gt; = ({ <span class="hljs-attr">threshold</span> = <span class="hljs-number">400</span> }) =&gt; {
    const <span class="hljs-section">[isVisible, setIsVisible]</span> = useState&lt;boolean&gt;(false)<span class="hljs-comment">;</span>

    const <span class="hljs-attr">scrollToTop</span> = () =&gt; {
        window.scrollTo({
            top: 0,
            behavior: 'smooth', // 平滑滚动
        })<span class="hljs-comment">;</span>
    }<span class="hljs-comment">;</span>

    useEffect(() =&gt; {
        const <span class="hljs-attr">toggleVisibility</span> = () =&gt; {
            setIsVisible(window.scrollY &gt; threshold)<span class="hljs-comment">;</span>
        }<span class="hljs-comment">;</span>
        
        // 使用节流函数包装滚动处理函数
        const <span class="hljs-attr">throttledToggle</span> = throttle(toggleVisibility, <span class="hljs-number">200</span>)<span class="hljs-comment">;</span>

        window.addEventListener('scroll', throttledToggle)<span class="hljs-comment">;</span>
        
        // 重要：组件卸载时移除事件监听，防止内存泄漏
        return () =&gt; window.removeEventListener('scroll', throttledToggle)<span class="hljs-comment">;</span>
    }, <span class="hljs-section">[threshold]</span>)<span class="hljs-comment">;</span>

    if (!isVisible) return null<span class="hljs-comment">;</span>

    return (
        &lt;Button
            <span class="hljs-attr">type</span>=<span class="hljs-string">"button"</span>
            <span class="hljs-attr">variant</span>=<span class="hljs-string">"outline"</span>
            <span class="hljs-attr">size</span>=<span class="hljs-string">"icon"</span>
            <span class="hljs-attr">onClick</span>={scrollToTop}
            <span class="hljs-attr">className</span>=<span class="hljs-string">"fixed bottom-20 right-6 rounded-full shadow-lg hover:shadow-xl"</span>
        &gt;
            &lt;ArrowUp <span class="hljs-attr">className</span>=<span class="hljs-string">"h-4 w-4"</span> /&gt;
        &lt;/Button&gt;
    )<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
</code></pre>
<h2 data-id="heading-12">第四步：细节打磨 - 用户体验优化</h2>
<h3 data-id="heading-13">平滑滚动体验</h3>
<p>最初的实现是瞬间跳转到顶部，用户体验很差。后来发现了 <code>behavior: 'smooth'</code> 这个属性：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">scrollToTop</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">scrollTo</span>({
        <span class="hljs-attr">top</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">behavior</span>: <span class="hljs-string">'smooth'</span>, <span class="hljs-comment">// 关键：平滑滚动效果</span>
    });
};
</code></pre>
<p>这个属性让滚动变得丝般顺滑，用户体验大大提升。</p>
<h3 data-id="heading-14">智能显示逻辑</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 阈值设置为400px，用户滚动超过这个距离才显示按钮</span>
<span class="hljs-keyword">const</span> [isVisible, setIsVisible] = useState&lt;<span class="hljs-built_in">boolean</span>&gt;(<span class="hljs-literal">false</span>);

<span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleVisibility</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">setIsVisible</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">scrollY</span> &gt; threshold); <span class="hljs-comment">// threshold 默认为400</span>
};
</code></pre>
<p>这样避免了按钮在页面刚开始滚动时就出现，干扰用户阅读。</p>
<h3 data-id="heading-15">位置和样式优化</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">className</span>=<span class="hljs-string">"fixed bottom-20 right-6 rounded-full shadow-lg hover:shadow-xl"</span>
</code></pre>
<ul>
<li><code>fixed</code>：固定定位，随页面滚动保持位置不变</li>
<li><code>bottom-20 right-6</code>：距离底部和右侧的距离</li>
<li><code>rounded-full</code>：圆形按钮，美观</li>
<li><code>shadow-lg hover:shadow-xl</code>：阴影效果，鼠标悬停时增强</li>
</ul>
<h2 data-id="heading-16">第五步：代码健壮性 - 内存泄漏防护</h2>
<h3 data-id="heading-17">为什么需要清理事件监听？</h3>
<p>这是我在开发过程中学到的重要一课。如果不清理事件监听：</p>
<ol>
<li>组件卸载后，事件监听仍然存在</li>
<li>每次滚动都会调用已卸载组件的回调函数</li>
<li>可能导致内存泄漏</li>
<li>在开发模式下可能会收到警告</li>
</ol>
<h3 data-id="heading-18">useEffect 清理机制</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> throttledToggle = <span class="hljs-title function_">throttle</span>(toggleVisibility, <span class="hljs-number">200</span>);
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'scroll'</span>, throttledToggle);
    
    <span class="hljs-comment">// 返回清理函数</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'scroll'</span>, throttledToggle);
}, [threshold]);
</code></pre>
<p>这个返回的函数会在组件卸载时自动执行，确保事件监听被正确移除。</p>
<h2 data-id="heading-19">第六步：类型安全 - TypeScript 的运用</h2>
<h3 data-id="heading-20">接口定义</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">BackToTopProps</span> {
    threshold?: number; <span class="hljs-comment">// 可选属性，默认400</span>
}
</code></pre>
<p>通过接口定义，我们获得了：</p>
<ol>
<li><strong>类型检查</strong>：编译时就能发现类型错误</li>
<li><strong>自动补全</strong>：IDE 提供更好的开发体验</li>
<li><strong>文档作用</strong>：代码即文档</li>
</ol>
<h3 data-id="heading-21">泛型约束</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">BackToTop</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span>&lt;<span class="hljs-title class_">BackToTopProps</span>&gt; = <span class="hljs-function">(<span class="hljs-params">{ threshold = <span class="hljs-number">400</span> }</span>) =&gt;</span> {
    <span class="hljs-comment">// 组件实现</span>
};
</code></pre>
<p><code>React.FC&lt;T&gt;</code> 确保了组件的类型安全。</p>
<h2 data-id="heading-22">第七步：实际应用中的考虑</h2>
<h3 data-id="heading-23">响应式设计</h3>
<p>在移动设备上，按钮的位置可能需要调整。可以通过媒体查询或动态计算来适配：</p>
<pre><code class="hljs language-scss" lang="scss">const <span class="hljs-selector-attr">[bottomOffset, setBottomOffset]</span> = <span class="hljs-built_in">useState</span>(<span class="hljs-number">20</span>);

<span class="hljs-built_in">useEffect</span>(() =&gt; {
    const navHeight = document<span class="hljs-selector-class">.querySelector</span>('nav')?<span class="hljs-selector-class">.clientHeight</span> || <span class="hljs-number">0</span>;
    <span class="hljs-built_in">setBottomOffset</span>(navHeight + <span class="hljs-number">20</span>); <span class="hljs-comment">// 避开导航栏</span>
}, <span class="hljs-selector-attr">[]</span>);
</code></pre>
<h3 data-id="heading-24">可访问性考虑</h3>
<pre><code class="hljs language-ini" lang="ini">&lt;Button
    <span class="hljs-attr">aria-label</span>=<span class="hljs-string">"回到顶部"</span>
    <span class="hljs-attr">title</span>=<span class="hljs-string">"回到顶部"</span>
    // ... 其他属性
&gt;
</code></pre>
<p>为按钮添加适当的 ARIA 标签和标题，提升可访问性。</p>
<h2 data-id="heading-25">总结与收获</h2>
<p>这个看似简单的返回顶部组件，实际上涉及了前端开发的多个重要方面：</p>
<h3 data-id="heading-26">技术要点回顾</h3>
<ol>
<li><strong>事件处理</strong>：理解滚动事件的特性</li>
<li><strong>性能优化</strong>：节流函数的应用</li>
<li><strong>用户体验</strong>：平滑动画和智能显示</li>
<li><strong>内存管理</strong>：事件监听的清理</li>
<li><strong>类型安全</strong>：TypeScript 的使用</li>
<li><strong>样式设计</strong>：Tailwind CSS 的应用</li>
</ol>
<h3 data-id="heading-27">开发感悟</h3>
<p>通过这个组件的开发，我深刻体会到：</p>
<ul>
<li><strong>看似简单的功能往往隐藏着复杂的细节</strong></li>
<li><strong>性能优化在前端开发中至关重要</strong></li>
<li><strong>用户体验需要从细微之处着手</strong></li>
<li><strong>代码的健壮性不容忽视</strong></li>
</ul>
<h3 data-id="heading-28">最终代码解析</h3>
<p>让我们再来看一遍完整的实现：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useEffect, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Button</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/ui/button'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ArrowUp</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'lucide-react'</span>;
<span class="hljs-keyword">import</span> { throttle } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils'</span>;

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">BackToTopProps</span> {
    threshold?: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// 滚动阈值，超过此距离显示按钮</span>
}

<span class="hljs-keyword">const</span> <span class="hljs-title class_">BackToTop</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span>&lt;<span class="hljs-title class_">BackToTopProps</span>&gt; = <span class="hljs-function">(<span class="hljs-params">{ threshold = <span class="hljs-number">400</span> }</span>) =&gt;</span> {
    <span class="hljs-comment">// 状态管理：控制按钮显示隐藏</span>
    <span class="hljs-keyword">const</span> [isVisible, setIsVisible] = useState&lt;<span class="hljs-built_in">boolean</span>&gt;(<span class="hljs-literal">false</span>);

    <span class="hljs-comment">// 滚动到顶部的函数</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">scrollToTop</span> = (<span class="hljs-params"/>) =&gt; {
        <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">scrollTo</span>({
            <span class="hljs-attr">top</span>: <span class="hljs-number">0</span>,
            <span class="hljs-attr">behavior</span>: <span class="hljs-string">'smooth'</span>, <span class="hljs-comment">// 平滑滚动效果</span>
        });
    };

    <span class="hljs-comment">// 使用 useEffect 管理滚动事件监听</span>
    <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-comment">// 定义滚动处理函数</span>
        <span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleVisibility</span> = (<span class="hljs-params"/>) =&gt; {
            <span class="hljs-title function_">setIsVisible</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">scrollY</span> &gt; threshold); <span class="hljs-comment">// 根据滚动距离判断是否显示</span>
        };
        
        <span class="hljs-comment">// 使用节流函数优化性能</span>
        <span class="hljs-keyword">const</span> throttledToggle = <span class="hljs-title function_">throttle</span>(toggleVisibility, <span class="hljs-number">200</span>);

        <span class="hljs-comment">// 添加事件监听</span>
        <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'scroll'</span>, throttledToggle);
        
        <span class="hljs-comment">// 清理函数：组件卸载时移除事件监听</span>
        <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'scroll'</span>, throttledToggle);
    }, [threshold]); <span class="hljs-comment">// 依赖数组：当阈值改变时重新绑定事件</span>

    <span class="hljs-comment">// 如果不需要显示，则不渲染组件</span>
    <span class="hljs-keyword">if</span> (!isVisible) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

    <span class="hljs-comment">// 渲染返回顶部按钮</span>
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Button</span>
            <span class="hljs-attr">type</span>=<span class="hljs-string">"button"</span>
            <span class="hljs-attr">variant</span>=<span class="hljs-string">"outline"</span>
            <span class="hljs-attr">size</span>=<span class="hljs-string">"icon"</span>
            <span class="hljs-attr">onClick</span>=<span class="hljs-string">{scrollToTop}</span>
            <span class="hljs-attr">className</span>=<span class="hljs-string">"fixed bottom-20 right-6 rounded-full shadow-lg hover:shadow-xl"</span>
        &gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">ArrowUp</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"h-4 w-4"</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span></span>
    );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">BackToTop</span>;
</code></pre>
<h2 data-id="heading-29">动画展示一下</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a46c40084e1b40a28bb6bc1a3e64b716~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg5pWM55qE5ouW5ouJ5pav5peL6aOO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770045028&amp;x-signature=4vl3K%2Fjp%2BOMKvb2kDxbp9lw8cUc%3D" alt="屏幕录制 2026-01-26 230803.gif" loading="lazy"/></p>
<p>这个组件虽然功能简单，但包含了现代前端开发的最佳实践。每一次踩坑都是成长，每一个细节都值得深思。这就是前端开发的魅力所在——在看似平凡的功能中，蕴含着丰富的技术内涵。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[跟我一起学开源设计第15节：规则引擎EasyRule源码基本执行逻辑设计实现流程]]></title>    <link>https://juejin.cn/post/7599483794658492457</link>    <guid>https://juejin.cn/post/7599483794658492457</guid>    <pubDate>2026-01-27T02:00:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599483794658492457" data-draft-id="7599502282602856511" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="跟我一起学开源设计第15节：规则引擎EasyRule源码基本执行逻辑设计实现流程"/> <meta itemprop="keywords" content="开源,后端"/> <meta itemprop="datePublished" content="2026-01-27T02:00:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="爱海贼的无处不在"/> <meta itemprop="url" content="https://juejin.cn/user/2359988032644541"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            跟我一起学开源设计第15节：规则引擎EasyRule源码基本执行逻辑设计实现流程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2359988032644541/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    爱海贼的无处不在
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T02:00:21.000Z" title="Tue Jan 27 2026 02:00:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读18分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>一、背景</strong></h2>
<p>在上篇文章中，我分享了EasyRule的基本使用与规则引擎的背景介绍，本节开始分享这个组件的核心执行流程，正如这个组件的名称一样，很Easy，同时这个组件的源码的抽象设计也是值得学习的。</p>
<p><strong>EasyRules</strong>这个组件是一个简单易用的规则引擎，用于在 Java 项目中实现基于规则的决策。EasyRules 的设计目标是简化规则引擎的使用，通过易于理解的 API 提供快速实现业务逻辑的途径。</p>
<p><strong>EasyRules</strong> 的一些关键特点包括：</p>
<ol>
<li><strong>规则的定义与分离</strong>：规则的定义与业务逻辑是解耦的，规则可以根据条件执行对应的动作，条件和动作通过接口进行定义。</li>
<li><strong>轻量级</strong>：与 Drools 等复杂的规则引擎相比，EasyRules 是轻量级的，没有复杂的规则语言，也不需要过多的学习成本。</li>
<li><strong>简单的 API</strong>：规则和规则组都可以通过 Java 的普通类来实现。EasyRules 提供了非常简单的 API 来加载、执行规则，易于集成到现有系统中。</li>
<li><strong>基于 POJO</strong>：规则通过 Java 的 POJO 类来实现，这意味着你不需要学习其他的 DSL（领域特定语言）。</li>
</ol>
<p>在分享前，先来看下EasyRule的入门例子：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/308d887e6d24409c9c608c3ceb1986d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084021&amp;x-signature=1eD1iJpsNufjKM2UfAHEbJ3cZJI%3D" alt="" loading="lazy"/></p>
<p>在这个例子中，我们可以看到，一个程序由4部分组成：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6603e2f9d79e409e9ac47f6f1f3f0325~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084021&amp;x-signature=b41%2FAUk7kJsgAxKOiwQdQyuMHyA%3D" alt="" loading="lazy"/></p>
<p>本文将围绕这四点进行分析。</p>
<h2 data-id="heading-1"><strong>二、正文</strong></h2>
<h3 data-id="heading-2"><strong>2.1、项目结构</strong></h3>
<p>首先，我们从easyrule的Github主页中下载源码， 同时在IDEA中进行构建，构建后的截图如下所示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7fa23532e3144bf996e8c55b41a31aa7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084021&amp;x-signature=caOHbMgi8iliCc3MDdsVAD%2FPr5Y%3D" alt="" loading="lazy"/></p>
<p>从图中可以看到EasyRules源码结构清晰且模块化，主要由以下模块组成：</p>
<ol>
<li>
<p><strong>easy-rules-archetype</strong>：这是提供的Maven项目的脚手架的模块。</p>
</li>
<li>
<p><strong>easyrules-core</strong>：</p>
<ul>
<li>
<p>这是整个规则引擎的核心模块，提供了所有与规则引擎相关的基础功能。它包含以下几个重要组件：</p>
<ul>
<li><strong>Rule</strong> 接口：定义了规则的结构，包括 evaluate()（条件） 和 execute()（动作） 方法。</li>
<li><strong>Rules</strong> 类：管理多个规则的容器，内部实现了 Set。</li>
<li><strong>RulesEngine</strong> 接口及其默认实现 <strong>DefaultRulesEngine</strong>：提供了执行规则的机制。</li>
<li><strong>Facts</strong> 类：用于传递给规则的输入，类似于上下文信息。</li>
</ul>
</li>
<li>
<p>核心模块负责处理基础规则条件的判断和执行。</p>
</li>
</ul>
</li>
<li>
<p><strong>easyrules-mvel</strong>：</p>
<ul>
<li>提供了与 <strong>MVEL</strong> (一个轻量级的基于 Java 的表达式语言) 的集成。通过这个模块，开发者可以编写基于 MVEL 的规则，而无需用纯 Java 编写规则。</li>
<li>使用 MVEL，开发者可以在外部文件中定义规则逻辑，极大增强了规则的灵活性。</li>
</ul>
</li>
<li>
<p><strong>easyrules-spel</strong>：</p>
<ul>
<li>提供了与 <strong>Spring Expression Language (SpEL)</strong> 的集成。开发者可以使用 SpEL 语言在规则中定义条件和动作，这对于依赖 Spring 生态的项目非常有用。</li>
<li>这一模块允许在 Spring 项目中动态定义和解析规则条件。</li>
</ul>
</li>
<li>
<p><strong>easy-rules-jexl:</strong></p>
<ul>
<li>提供了与JEXL表达式的集成</li>
</ul>
</li>
<li>
<p><strong>easyrules-support</strong>：</p>
<ul>
<li>包含了一些额外的支持类和扩展功能模块。例如，支持 YAML 格式定义规则等。</li>
<li>提供了便利的工具类，帮助开发者在自定义场景中轻松扩展规则引擎。</li>
</ul>
</li>
<li>
<p><strong>easyrules-tutorials</strong>：</p>
<ul>
<li>这个模块包含了一些教学示例，展示如何在实际项目中使用 EasyRules。它提供了基础和进阶的使用场景，帮助开发者快速上手。</li>
<li>示例代码涵盖了 easyrules-core、easyrules-mvel、easyrules-spel 等模块的使用。</li>
</ul>
</li>
</ol>
<p>在这几个模块中，我们核心关注的就是如下4个模块：</p>
<ul>
<li>easy-rules-core：规则引擎的核心逻辑</li>
<li>easy-rules-mvel：提供MVEL的支持</li>
<li>easy-rules-spel：提供SpELl的支持</li>
<li>easy-rules-support：将基本规则组合成复合规则</li>
</ul>
<p>这里大概介绍下，后续我们重点解析下。接下来我们开始从流程的角度来分析</p>
<h3 data-id="heading-3"><strong>2.2、创建事实</strong></h3>
<p>在这个规则引擎组件中，事实本质就是我们写程序时用到的变量数据信息，有些规则引擎中，会把变量称为：特征，因此有些小伙伴在风控系统等使用到规则引擎的系统中经常看到特征这种词，本质就是一些数据指标、变量信息。</p>
<p>示例中的代码如下：</p>
<pre><code class="hljs language-ini" lang="ini"> Facts <span class="hljs-attr">facts</span> = new Facts()<span class="hljs-comment">;</span>
</code></pre>
<p>我们先来看看这个类都干了啥吧。这个类是core工程下面的一个类，当我们看到这个类里面的源码那一刻我们就知道了：<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b7246c2f2344d8a86ad5743476cc3c7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084021&amp;x-signature=7wvJfICJFsyvg2WRcR75l4f7Dm4%3D" alt="" loading="lazy"/></p>
<p>这个类里面维护了一个Set集合，用来存储每一个事实对象，而这个组件中的每一个事实其实就是一个个参数：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Set</span>&lt;<span class="hljs-type">Fact</span>&lt;?&gt;&gt; facts <span class="hljs-operator">=</span> new <span class="hljs-type">HashSet</span>&lt;&gt;();
</code></pre>
<p>也就是说当我们执行类似如下代码的时候，本质就是往集合中添加了这个Fact对象：</p>
<pre><code class="hljs language-arduino" lang="arduino">facts.<span class="hljs-built_in">put</span>(<span class="hljs-string">"变量1"</span>, <span class="hljs-string">"ddd"</span>);
facts.<span class="hljs-built_in">put</span>(<span class="hljs-string">"变量2"</span>, <span class="hljs-string">"cccc"</span>);
</code></pre>
<p>EasyRules 里的 Facts 类是规则引擎的核心部分之一，它是一个“事实容器”，负责存储你需要用来条件判断的“事实”（Fact）。Facts 类就是一个“事实收集站”，里面放着各种“事实小盒子”（Fact）。这些事实小盒子里装的就是规则引擎运行时要用的数据。你可以往这个站点里放事实，也可以从里面取出事实。</p>
<h4 data-id="heading-4"><strong>核心成员：Set&lt;Fact&lt;?&gt;&gt; facts</strong></h4>
<p>Facts 内部的这个 Set 就是所有事实盒子的集合。每个盒子都有个标签（name），而标签背后藏着某种“事实真相”（value）。Set 的特性是，盒子的标签不能重复，因此每个事实的名字得是唯一的。</p>
<h4 data-id="heading-5">先来看下Put方法：</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/778617152f11442aab3d366d13aa8d8d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084021&amp;x-signature=oYkj5QYeoMJYvKtRX1jHdliY4K8%3D" alt="" loading="lazy"/></p>
<p><strong>put(String name, T value)</strong> ：</p>
<ul>
<li>
<ul>
<li>你可以用这个方法来添加一个新事实。想象一下，你向收集站里交付了一个标有“名字”和“事实”的盒子。如果已经有同名的盒子，它会被替换掉，规则引擎可不喜欢处理重复的事实！</li>
<li>举个例子：如果你说“天气 = 晴”，然后发现错了，说“天气 = 阴”，那么它会自动替换掉“晴”的盒子，保持最新的“阴”的事实。</li>
</ul>
</li>
</ul>

<pre><code class="hljs language-arduino" lang="arduino">facts.<span class="hljs-built_in">put</span>(<span class="hljs-string">"天气"</span>, <span class="hljs-string">"阴"</span>);
</code></pre>
<p>再看看添加方法，截图如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10654ac38e0c4784b3698f1836649305~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084021&amp;x-signature=itZ2t8jmbvEcgF8dMLd5xJreEUw%3D" alt="" loading="lazy"/></p>
<p><strong>add(Fact fact)</strong> ：</p>
<ul>
<li>
<ul>
<li>这个方法和 put 类似，不过它允许你直接给出一个完整的“事实盒子”。不再单独传入 name 和 value，而是直接丢给它一个装好了的盒子。</li>
<li>如果你已经有一个 Fact 对象，比如 Fact weather = new Fact&lt;&gt;("天气", "阴")，就可以直接丢进收集站了。</li>
</ul>
</li>
</ul>

<pre><code class="hljs language-csharp" lang="csharp">facts.<span class="hljs-keyword">add</span>(<span class="hljs-keyword">new</span> Fact&lt;&gt;(<span class="hljs-string">"天气"</span>, <span class="hljs-string">"阴"</span>));
</code></pre>
<p>再看看删除方法，截图如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3196318e62b24b279fda004be7401de7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084021&amp;x-signature=7%2Bg%2Bu3ND0XWe0TV9T1XN0I0GfeY%3D" alt="" loading="lazy"/></p>
<p><strong>remove(String factName)</strong> 和 <strong>remove(Fact fact)</strong> ：</p>
<ul>
<li>
<ul>
<li>这两个方法是用来清除收集站里某个盒子的。比如你决定“天气”的信息不再需要了，就可以移除掉这个盒子。记住，移除盒子是个认真的活儿，得指定具体的名字或者盒子对象。</li>
<li>换句话说：“把‘天气’这个盒子拿走，不然我们规则就搞不清了！”</li>
</ul>
</li>
</ul>

<pre><code class="hljs language-csharp" lang="csharp">facts.<span class="hljs-keyword">remove</span>(<span class="hljs-string">"天气"</span>);
</code></pre>
<p>再看看这个类里面的get方法，截图如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c80ca7057a94f1483e8f957b123a8ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084021&amp;x-signature=yQIodG90%2BTofoi9KQJLrCnkR0nA%3D" alt="" loading="lazy"/></p>
<p><strong>get(String factName)</strong> ：</p>
<ul>
<li>
<ul>
<li>想要知道某个盒子里装的“事实”是什么？这时候你就用 get 方法，指定名字，它会告诉你盒子里装的东西。如果没找到对应的盒子，那就只能无奈地返回 null。</li>
<li>你问：“今天的天气是什么？”引擎答：“阴。”</li>
</ul>
</li>
</ul>

<pre><code class="hljs language-ini" lang="ini">String <span class="hljs-attr">weather</span> = facts.get(<span class="hljs-string">"天气"</span>)<span class="hljs-comment">;</span>
</code></pre>
<p>再看看剩余的几个方法，截图如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6c547a3d0b442a6a4cdea775c47bbe6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084021&amp;x-signature=vbk0PfkorOY9%2FByhALmvRZ028ps%3D" alt="" loading="lazy"/></p>
<p><strong>asMap()</strong> ：</p>
<ul>
<li>
<ul>
<li>asMap 是个小偷懒的工具，可以把所有的“事实盒子”打包成一个 Map，方便查询。每个盒子的名字会作为 Map 的键，里面装的事实会是值。</li>
<li>想象一下，你有一张事实表格，上面写着所有盒子的名字和它们里面的内容。非常方便！</li>
</ul>
</li>
</ul>

<pre><code class="hljs language-ini" lang="ini">Map&lt;String, Object&gt; <span class="hljs-attr">factsMap</span> = facts.asMap()<span class="hljs-comment">;</span>
</code></pre>
<p><strong>iterator()</strong> ：</p>
<ul>
<li>
<ul>
<li>这个方法让你可以遍历整个事实收集站的所有盒子。你可以想象一下，规则引擎会拿着个小推车走过每个盒子，查看里面装了什么。</li>
<li>不过别想着在它遍历的时候偷拿或者随便移动盒子，规则引擎可不喜欢外部打乱它的计划。</li>
</ul>
</li>
</ul>

<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">for</span> (Fact&lt;?&gt; <span class="hljs-attribute">fact </span>: facts) {
    <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(fact.<span class="hljs-built_in">getName</span>() + <span class="hljs-string">": "</span> + fact.<span class="hljs-built_in">getValue</span>());
}
</code></pre>
<p><strong>clear()</strong> ：</p>
<ul>
<li>
<ul>
<li>这个方法就是清空收集站的“大扫除”。所有的盒子都会被清空，规则引擎会从头开始，不再依赖旧的事实。</li>
</ul>
</li>
</ul>
<p>这样在第一步中，我们定义事实，本质就是将我们的规则中的特征信息作为变量传递给组件，然后组件针对每一个规则信息，封装为一个个的事实对象存储起来。</p>
<p>Facts 类就像你家中的一个小储物间。你可以往里面放各种各样的小盒子（Fact），每个盒子上都贴着标签（name），里面装着你知道的“真相”（value）。当你需要这些事实来做决定（比如决定是不是要执行某条规则时），你就可以从储物间里拿出来看看。</p>
<p>有意思的是，Facts 类不仅支持你灵活地管理这些盒子（添加、删除、查看），还会帮你避免重复的盒子，让你的小储物间始终整齐有序。这就像当你给朋友讲了两次相同的笑话，朋友可不会觉得好笑——而是会自动忽略第二个笑话！</p>
<h3 data-id="heading-6"><strong>2.3、创建规则</strong></h3>
<p>对于我们经常使用的代码：</p>
<pre><code class="hljs language-ini" lang="ini">HelloWorldRule <span class="hljs-attr">helloWorldRule</span> = new HelloWorldRule()<span class="hljs-comment">;</span>
        
Rules <span class="hljs-attr">rules</span> = new Rules()<span class="hljs-comment">;</span>
</code></pre>
<p>我们会通过自定义一个规则类的方式来声明一个规则，同时观察Rules源码可以发现在设计方面，它和Facts事实类基本设计思想一致，内部维护了多个规则集合信息：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/166ac45a773b4440affaf8d04606f7f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084021&amp;x-signature=EeknUeYPXLUoq5D8CMlaMO2WZyw%3D" alt="" loading="lazy"/></p>
<p>这里需要关注这个Rule规则接口，这个接口统一定义了规则的抽象信息，如下所示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40ab59e7c6de4eb5afdb0f7e16cf4d85~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084021&amp;x-signature=699pY6ch7%2BpvKsu0FqvlEBOxdnw%3D" alt="" loading="lazy"/></p>
<p>Rule 接口是 EasyRules 中的规则抽象，它定义了一个可被规则引擎执行的规则。每个规则都必须有一个唯一的名称、描述和优先级，默认名称为“rule”，描述为“description”，优先级值越小优先级越高。该接口主要包括两个方法：evaluate 用于定义规则的条件，返回布尔值，表示是否应该执行规则；execute 则执行与规则相关的操作。规则通过 evaluate(Facts facts) 方法判断是否满足条件，当条件为真时，规则的动作通过 execute(Facts facts) 执行。每条规则的优先级决定了其在规则集合中的执行顺序，数字越小优先级越高。Rule 接口的设计使得开发者可以灵活定义各种业务规则，并通过规则引擎自动管理它们的执行流程，实现条件判断和自动化决策。</p>
<p>在上一篇文章中分享过创建规则的几种方式，本节简单介绍下通过注解的方式创建规则。我们通过在一个普通的类上面指定几个注解，就可以完成一个规则的定义。</p>
<h3 data-id="heading-7"><strong>2.4、注册规则</strong></h3>
<p>注册规则也是当前组件的核心代码，使用的时候的代码如下：</p>
<pre><code class="hljs language-ini" lang="ini">Rules <span class="hljs-attr">rules</span> = new Rules()<span class="hljs-comment">;</span>
rules.register(helloWorldRule)<span class="hljs-comment">;</span>
</code></pre>
<p>我们来看看register方法吧：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dcf33715122143b689b1637e603fc7b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084021&amp;x-signature=tuykD7Zb7ZMjibJ7s03xmZJr8sI%3D" alt="" loading="lazy"/></p>
<p>可以看到，对于诸恶的过程本质就是将Rule对象添加到Set集合中，取消注册也是。这里我们需要关注的是这个代码：</p>
<pre><code class="hljs language-scss" lang="scss">RuleProxy<span class="hljs-selector-class">.asRule</span>(rule)
</code></pre>
<p>通过字面意思我们知道，这个可能是一个代理类，传递一个类，返回代理后的规则对象。</p>
<p>RuleProxy 的作用是通过动态代理将使用注解定义的类适配为 Rule 接口的实现类，这样 EasyRules 引擎可以处理这些规则。</p>
<p>它使得开发者可以通过简单的注解来定义规则，而不必显式实现 Rule 接口，极大简化了规则的创建和管理。</p>
<p>这就像是一个规则的“翻译器”，把注解转换为引擎可以理解和执行的规范接口，使得复杂的逻辑实现可以隐藏在背后，开发者只需要专注于业务规则本身。</p>
<p>你可以想象 RuleProxy 就像是个“规则代理人”。你只需要用简单的注解写个规则草稿，剩下的都交给它——它会帮你检查规则合法不合法，然后把规则翻译成引擎能听懂的语言，最后站在前台帮你“打电话”执行各种条件和动作。真正让你“动动手指，规则搞定”，后台全由它来跑腿。</p>
<p>再来看看源码：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/823773a8cd4e451ea48537725417f856~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084021&amp;x-signature=V4efckANrB7TL%2BbJP%2BszJ3mAI1U%3D" alt="" loading="lazy"/></p>
<p>通过源码，可以非常清晰的看到这个会先判断是否是Rule的对象，如果不是则通过动态代理的方式来创建一个规则类，类上面也继承了InvocationHandler，就是一个动态代理实现的类：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ef8595265854c5382cc348ed903e0c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084021&amp;x-signature=uenrdcMeRS3vmlKzuMaz093X9OE%3D" alt="" loading="lazy"/></p>
<p>代码的核心是 RuleProxy 类，它在 EasyRules 规则引擎中用于将带有注解的对象转换为实现了 Rule 接口的代理对象。其主要目的是通过动态代理的方式，让使用注解定义的规则类能够符合 Rule 接口的规范，从而可以被规则引擎处理和执行。</p>
<p>其他解释如下：</p>
<p><strong>RuleProxy 实现了 InvocationHandler 接口</strong></p>
<p>InvocationHandler 是 Java 动态代理机制的一部分，允许我们拦截对目标对象方法的调用。RuleProxy 使用这一机制来拦截对带注解规则类的方法调用，并根据规则定义执行特定逻辑（如条件检查和动作执行）。</p>
<p><strong>asRule 方法</strong></p>
<p>这是 RuleProxy 类的核心方法。它将一个带有注解的规则对象转换为一个 Rule 接口的代理对象。该方法首先检查对象是否已经实现了 Rule 接口。如果已经实现，则直接返回原对象；否则，它使用 Java 的动态代理机制将该对象包装成一个实现了 Rule 和 Comparable 接口的代理对象。</p>
<p><strong>ruleDefinitionValidator.validateRuleDefinition(rule)</strong></p>
<p>该行代码用于验证传入的对象是否是有效的规则定义，确保带有正确的注解并且符合规则引擎的要求（例如，必须有一个条件和至少一个动作）。</p>
<p><strong>代理对象的执行逻辑</strong></p>
<p>当代理对象的方法被调用时，RuleProxy 会处理这些调用。具体来说，它会根据对象上定义的注解（如 @Condition 和 @Action），决定应该执行哪些逻辑。这让使用注解定义规则变得更灵活和简洁。</p>
<p>说道这里，我们可以先猜一下未来的代码的执行流程：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7473b3de183c475881f0e71fa0b7a30f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084021&amp;x-signature=BkiSDmaTt49YYthdlcM1kKUScBI%3D" alt="" loading="lazy"/></p>
<p>接下来我们再看下规则的触发。</p>
<h3 data-id="heading-8"><strong>2.5、注册触发</strong></h3>
<p>在客户端使用的时候，我们的调用代码如下：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// create a rules engine and fire rules on known facts</span>
RulesEngine rulesEngine = new <span class="hljs-built_in">DefaultRulesEngine</span>();
rulesEngine<span class="hljs-selector-class">.fire</span>(rules, facts);
</code></pre>
<p>代码截图如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/205690df992040959e599052cd976683~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084021&amp;x-signature=ReqEYir13oiwrvGz39TCqHXeQGw%3D" alt="" loading="lazy"/></p>
<p>这里可以看到定义了多种规则引擎的执行逻辑：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/017990e50e89442b853210fa57576384~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084021&amp;x-signature=U6F%2FoEk8ev%2FUEomH65Xd%2FXAWGJA%3D" alt="" loading="lazy"/></p>
<p>然后我们使用的是默认的规则引擎行为。</p>
<p>InferenceRulesEngine 和 DefaultRulesEngine 是 EasyRules 规则引擎中的两个核心类，它们都实现了 RulesEngine 接口，但在规则执行的方式上有所不同。</p>
<h4 data-id="heading-9">1. <strong>DefaultRulesEngine</strong></h4>
<ul>
<li>
<p><strong>作用</strong>: DefaultRulesEngine 是最常用的规则引擎，按照预定义的顺序一次性执行所有规则。</p>
</li>
<li>
<p><strong>执行逻辑</strong>: 它会遍历所有规则，根据优先级从高到低执行。在每个规则执行之前，都会执行该规则的条件 (evaluate 方法)，如果条件成立则执行动作 (execute 方法)。</p>
</li>
<li>
<p><strong>适用场景</strong>: 适用于大多数场景，特别是规则之间没有复杂的依赖关系时。</p>
</li>
<li>
<p><strong>特点</strong>:</p>
<ul>
<li>执行流程简单，所有符合条件的规则会按顺序执行。</li>
<li>每个规则只判断条件和执行一次。</li>
</ul>
</li>
</ul>
<p><strong>例子</strong>：</p>
<ul>
<li>如果你有一系列独立的规则，比如判断天气、发送通知等，DefaultRulesEngine 可以依次执行这些规则，不会有复杂的依赖关系。</li>
</ul>
<h4 data-id="heading-10">2. <strong>InferenceRulesEngine</strong></h4>
<ul>
<li>
<p><strong>作用</strong>: InferenceRulesEngine 是一个基于推理的规则引擎，支持循环推理规则的执行。</p>
</li>
<li>
<p><strong>执行逻辑</strong>: 该引擎不仅会遍历规则，还会在每个规则执行后重新判断条件的所有的规则。这样，规则的执行可能会触发其他规则，从而形成一个规则链。这个过程会持续，直到所有规则都不再触发为止。</p>
</li>
<li>
<p><strong>适用场景</strong>: 适用于规则之间有依赖关系，或者规则的执行可能改变其他规则的条件判断结果的情况。比如，规则 A 的执行可能会影响规则 B 的条件。</p>
</li>
<li>
<p><strong>特点</strong>:</p>
<ul>
<li>基于“前向推理”的思想，规则会反复执行，直到没有任何新的规则可以触发。</li>
<li>适合规则间有复杂关系或递归依赖的情况。</li>
</ul>
</li>
</ul>
<p><strong>例子</strong>：</p>
<ul>
<li>如果规则 A 的执行改变了事实库中的数据，使得规则 B 可以触发，则 InferenceRulesEngine 会重新条件判断所有规则，直到没有新的规则可以触发。</li>
</ul>
<h4 data-id="heading-11">3. <strong>区别总结</strong></h4>
<ul>
<li>
<p><strong>执行方式</strong>:</p>
<ul>
<li>DefaultRulesEngine 只条件判断和执行一次规则，不会重新执行条件判断。</li>
<li>InferenceRulesEngine 支持推理，会在每次规则执行后重新执行条件判断所有规则，直到没有新的规则触发。</li>
</ul>
</li>
<li>
<p><strong>适用场景</strong>:</p>
<ul>
<li>DefaultRulesEngine 适合独立的、不相互依赖的规则。</li>
<li>InferenceRulesEngine 适合复杂的、相互依赖的规则，需要反复推理条件判断的场景。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-12">4. <strong>联系</strong></h4>
<ul>
<li>两者都实现了 RulesEngine 接口，基本执行逻辑相同，即通过规则的 evaluate 和 execute 方法来实现规则的条件判断和动作执行。</li>
<li>都依赖于 Rules 和 Facts 来执行规则。</li>
</ul>
<h4 data-id="heading-13">简单总结：</h4>
<ul>
<li><strong>DefaultRulesEngine</strong> 是“一次性执行完”的简单模式。</li>
<li><strong>InferenceRulesEngine</strong> 则是“反复条件判断、逐步推理”的循环模式。</li>
</ul>
<p>接下来我们再看看核心的fire方法，这个方法设计的不错，值得每个程序员学习，在阅读之前可以先看看整体流程描述：</p>
<p>doFire 方法负责执行一组注册规则 (rules) 对给定事实 (facts) 的条件判断和执行。流程如下：</p>
<ol>
<li><strong>规则检查</strong>: 如果没有注册任何规则，记录警告并返回。</li>
<li><strong>日志记录</strong>: 记录引擎参数、规则和事实的状态。</li>
<li><strong>规则条件判断</strong>: 遍历所有规则，依次执行每条规则的条件。</li>
<li><strong>条件执行</strong>: 如果规则条件成立，则执行相应的动作，并记录成功或失败的状态。</li>
<li><strong>控制流程</strong>: 根据配置参数决定是否跳过后续规则的执行。</li>
</ol>
<p>首先我们来看看方法的上半段：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30edfb06af904eac99bdd4068e238f50~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084021&amp;x-signature=gKqYea1u9wp0%2BG889giclBjdptU%3D" alt="" loading="lazy"/></p>
<ol>
<li>
<p><strong>检查规则是否为空</strong>:</p>
<ul>
<li>if (rules.isEmpty()) { ... }: 如果没有规则，发出警告。</li>
</ul>
</li>
<li>
<p><strong>记录日志</strong>:</p>
<ul>
<li>记录引擎参数和输入的规则及事实。</li>
</ul>
</li>
<li>
<p><strong>遍历规则</strong>:</p>
<ul>
<li>for (Rule rule : rules) { ... }: 对每条规则进行迭代。</li>
</ul>
</li>
<li>
<p><strong>优先级检查</strong>:</p>
<ul>
<li>if (priority &gt; parameters.getPriorityThreshold()) { ... }: 检查规则优先级是否超过阈值，超过则跳过后续规则。</li>
</ul>
</li>
<li>
<p><strong>前置监听拦截检查</strong>:</p>
<ul>
<li>!shouldBeEvaluated(rule, facts): 检查规则的前置监听器是否可以被执行，这个就相当于拦截器，通过观察者的方式提前注册了观察者，然后再前置动作中进行扩展处理，设计的思路不错。</li>
</ul>
</li>
</ol>
<p>然后我们再来看下后半段：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c64c9ac3345b48cdb43a78b88765f9ab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084021&amp;x-signature=%2B1WGopkDZUcOsapz0dDvylUv9nM%3D" alt="" loading="lazy"/></p>
<p>后半段的逻辑也非常清楚：</p>
<ol>
<li>
<p><strong>规则条件判断:</strong></p>
<ul>
<li>boolean evaluationResult = rule.evaluate(facts);: 调用规则的 evaluate 方法来判断条件是否成立。</li>
</ul>
</li>
<li>
<p><strong>异常处理</strong>:</p>
<ul>
<li>使用 try-catch 捕获过程中的异常，并根据配置决定是否跳过后续规则。</li>
</ul>
</li>
<li>
<p><strong>执行规则</strong>:</p>
<ul>
<li>rule.execute(facts);: 如果条件执行的结果为真，执行相应的动作，并记录执行成功或失败。</li>
</ul>
</li>
</ol>
<p>之前我说过动态代理，这里遍历Rule对象，也就是说实际上我们在执行evaluate方法和execute方法的时候，会执行到RuleProxy中的动态代理的方法：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4b99738060545e7983bfe5cd9bcdd6d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084021&amp;x-signature=d6b8mGNfM%2Fb7rCx%2Bq6LILHl9D84%3D" alt="" loading="lazy"/></p>
<p>可以看到在invoke方法中，判断方法名称是不是条件执行的方法，是不是执行具体动作的方法。</p>
<p>再看下执行条件的evaluateMethod方法实现，基本就是获取到当前规则的包含@Condition注解的方法，然后调用下，从而获取返回结果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/12e4840c9bff4c9ca0085ad52a9014ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084021&amp;x-signature=XiFZT%2BBDFvylz0Nfd8YU7wDkQ3s%3D" alt="" loading="lazy"/></p>
<p>真正执行的方法，也是如此：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/287043ff3c1c41d58316dd5e952985a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084021&amp;x-signature=ULpc4H%2BEae2nYBN3a1c3hL778R8%3D" alt="" loading="lazy"/></p>
<p>这样我们就知道了，当前这个HelloWorld这种规则是如何执行的了，我相信此时你看到如下代码，脑子中会时刻想起刚才的这些代码的底层原理：</p>
<pre><code class="hljs language-scss" lang="scss"> <span class="hljs-comment">// create facts</span>
        Facts facts = new <span class="hljs-built_in">Facts</span>();
        

        <span class="hljs-comment">// create rules</span>
        HelloWorldRule helloWorldRule = new <span class="hljs-built_in">HelloWorldRule</span>();
        
        <span class="hljs-comment">// register</span>
        Rules rules = new <span class="hljs-built_in">Rules</span>();
        rules<span class="hljs-selector-class">.register</span>(helloWorldRule);

        <span class="hljs-comment">// create a rules engine and fire rules on known facts</span>
        RulesEngine rulesEngine = new <span class="hljs-built_in">DefaultRulesEngine</span>();
        rulesEngine<span class="hljs-selector-class">.fire</span>(rules, facts);
</code></pre>
<h2 data-id="heading-14"><strong>三、总结</strong></h2>
<p>本文分享了EasyRule中的源码中的一个基本的执行流程，本质就是将我们的规则和事实信息存储到集合中，然后通过动态代理创建一个Rule对象，在规则执行的时候，先执行包含@Condition注解的方法，在执行@Action注解的方法，从而实现了一个规则的触发和执行，这里面用到了大量的设计思路，对我们个人开发设计能力的提示是非常有帮助的。</p>
<p>感兴趣的小伙伴可以交流、学习哦。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入浅出数据结构：栈 (Stack) 的 JavaScript 实现与应用]]></title>    <link>https://juejin.cn/post/7599483794657820713</link>    <guid>https://juejin.cn/post/7599483794657820713</guid>    <pubDate>2026-01-26T14:44:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599483794657820713" data-draft-id="7599483794657771561" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入浅出数据结构：栈 (Stack) 的 JavaScript 实现与应用"/> <meta itemprop="keywords" content="前端,算法"/> <meta itemprop="datePublished" content="2026-01-26T14:44:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="NEXT06"/> <meta itemprop="url" content="https://juejin.cn/user/1176918763246011"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入浅出数据结构：栈 (Stack) 的 JavaScript 实现与应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1176918763246011/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    NEXT06
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T14:44:05.000Z" title="Mon Jan 26 2026 14:44:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在计算机科学中，线性数据结构是构建复杂算法的基石。其中，<strong>栈（Stack）</strong>  凭借其独特的“后进先出”（LIFO, Last In First Out）特性，在编译器设计、内存管理、浏览器历史记录维护等场景中扮演着不可替代的角色。</p>
<p>本文将从抽象数据类型（ADT）出发，深入剖析 JavaScript 中基于数组与基于链表的两种栈实现方案，探讨其在 V8 引擎下的性能差异，并通过经典算法题展示其工程应用。</p>
<h2 data-id="heading-0">1. 核心概念与抽象数据类型 (ADT)</h2>
<p>栈是一种受限的线性表，其限制在于仅允许在表的一端（通常称为<strong>栈顶</strong>，Top）进行插入和删除操作。这一限制确立了其 LIFO 的存取原则。</p>
<h3 data-id="heading-1">1.1 运作模型</h3>
<p>栈的操作行为类似于弹匣装弹：最后压入的子弹最先被射出。</p>
<p>Mermaid</p>
<pre><code class="hljs language-css" lang="css">graph <span class="hljs-selector-tag">TD</span>
    subgraph Stack Operation
    <span class="hljs-attribute">direction</span> BT
    <span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[数据 A]</span> --&gt; <span class="hljs-selector-tag">B</span><span class="hljs-selector-attr">[数据 B]</span>
    <span class="hljs-selector-tag">B</span> --&gt; C<span class="hljs-selector-attr">[数据 C]</span>
    C --&gt;|Push 入栈| <span class="hljs-attribute">Top</span><span class="hljs-selector-attr">[栈顶 Top]</span>
    <span class="hljs-attribute">Top</span> --&gt;|Pop 出栈| C
    end
    style <span class="hljs-attribute">Top</span> fill:<span class="hljs-number">#f9f</span>,stroke:<span class="hljs-number">#333</span>,stroke-width:<span class="hljs-number">2px</span>
</code></pre>
<h3 data-id="heading-2">1.2 抽象数据类型定义</h3>
<p>既然要使用栈(stack),那就要先了解它的一些常用API</p>
<p>一个标准的栈 ADT 应当包含以下接口：</p>
<ul>
<li><strong>push(element)</strong> : 将元素压入栈顶。</li>
<li><strong>pop()</strong> : 移除并返回栈顶元素。</li>
<li><strong>peek()</strong> : 返回栈顶元素但不移除。</li>
<li><strong>isEmpty()</strong> : 判断栈是否为空。</li>
<li><strong>getSize()</strong> : 获取栈中元素的数量。</li>
</ul>
<h3 data-id="heading-3">1.3 典型应用场景</h3>
<ul>
<li><strong>函数调用栈（Call Stack）</strong> : 操作系统或虚拟机用于存储函数调用期间的上下文（局部变量、返回地址等）。</li>
<li><strong>撤销操作（Undo/Redo）</strong> : 编辑器维护的操作历史。</li>
<li><strong>语法解析</strong>: 编译器在词法分析中用于匹配括号或标签。</li>
</ul>
<hr/>
<h2 data-id="heading-4">2. JavaScript 中的两种实现方案剖析</h2>
<p>虽然 JavaScript 的原生数组（Array）提供了 push 和 pop 方法，但这属于“开箱即用”的通用列表，并未严格限制访问权限（例如允许随机访问索引）。为了构建严谨的数据结构，我们需要利用 ES6 Class 的特性进行封装。</p>
<h3 data-id="heading-5">2.1 方案 A：基于数组的封装 (ArrayStack)</h3>
<p>利用 JavaScript 数组作为底层容器。为了防止外部直接修改内部数据（例如通过索引访问），我们使用 <strong>ES6 私有类字段（Private Class Fields, #）</strong>  来实现强封装。</p>
<p>JavaScript</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 基于数组实现的栈
 * 利用 V8 引擎对连续内存的优化
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ArrayStack</span> {
    <span class="hljs-comment">// 私有属性，外部不可直接访问</span>
    #stack;

    <span class="hljs-keyword">constructor</span>() {
        <span class="hljs-keyword">this</span>.#stack = [];
    }

    <span class="hljs-comment">/**
     * 获取栈的大小
     * <span class="hljs-doctag">@returns</span> {number}
     */</span>
    <span class="hljs-keyword">get</span> size() {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.#stack.length;
    }

    <span class="hljs-comment">/**
     * 判断栈是否为空
     * <span class="hljs-doctag">@returns</span> {boolean}
     */</span>
    isEmpty() {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.#stack.length === <span class="hljs-number">0</span>;
    }

    <span class="hljs-comment">/**
     * 入栈操作
     * <span class="hljs-doctag">@param</span> {*} num 
     */</span>
    push(num) {
        <span class="hljs-keyword">this</span>.#stack.push(num);
    }

    <span class="hljs-comment">/**
     * 出栈操作
     * <span class="hljs-doctag">@returns</span> {*} 移除的元素
     */</span>
    pop() {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isEmpty()) {
            <span class="hljs-keyword">throw</span> new Error(<span class="hljs-string">"Stack Underflow: 栈为空，无法执行 pop 操作"</span>);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.#stack.pop();
    }

    <span class="hljs-comment">/**
     * 查看栈顶元素
     * <span class="hljs-doctag">@returns</span> {*}
     */</span>
    peek() {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isEmpty()) {
            <span class="hljs-keyword">throw</span> new Error(<span class="hljs-string">"Stack is empty: 栈为空，无法执行 peek 操作"</span>);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.#stack[<span class="hljs-keyword">this</span>.#stack.length - <span class="hljs-number">1</span>];
    }
}
</code></pre>
<h4 data-id="heading-6">性能分析</h4>
<ul>
<li><strong>时间效率</strong>：得益于 V8 引擎对数组的连续内存优化，索引访问极快。入栈操作平均时间复杂度为 <strong>O(1)</strong> 。</li>
<li><strong>扩容抖动</strong>：当底层数组容量不足时，引擎需要申请更大的内存块并将旧数据复制过去。此时单次 push 的时间复杂度会退化为 <strong>O(n)</strong> 。尽管通过<strong>摊还分析（Amortized Analysis）</strong> ，平均效率仍趋近于 O(1)，但在实时性要求极高的系统中需慎重。</li>
</ul>
<h3 data-id="heading-7">2.2 方案 B：基于链表的实现 (LinkedListStack)</h3>
<p>为了避免数组扩容带来的性能抖动，我们可以使用链表实现栈。链表节点在内存中是离散存储的，通过指针连接。</p>
<p>Mermaid</p>
<pre><code class="hljs language-css" lang="css">graph LR
    Head<span class="hljs-selector-attr">[栈顶指针 Head]</span> --&gt; Node1<span class="hljs-selector-attr">[Node 3]</span>
    Node1 --&gt; Node2<span class="hljs-selector-attr">[Node 2]</span>
    Node2 --&gt; Node3<span class="hljs-selector-attr">[Node 1]</span>
    Node3 --&gt; Null<span class="hljs-selector-attr">[null]</span>
    
    style Head fill:<span class="hljs-number">#f96</span>,stroke:<span class="hljs-number">#333</span>
</code></pre>
<p>JavaScript</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 链表节点类
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ListNode</span> {
    <span class="hljs-keyword">constructor</span>(<span class="hljs-keyword">val</span>) {
        <span class="hljs-keyword">this</span>.<span class="hljs-keyword">val</span> = <span class="hljs-keyword">val</span>;
        <span class="hljs-keyword">this</span>.next = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 指向下一个节点的指针</span>
    }
}

<span class="hljs-comment">/**
 * 基于链表实现的栈
 * 严格的 O(1) 操作，无扩容机制
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">LinkedListStack</span> {
    #head; <span class="hljs-comment">// 栈顶指针</span>
    #size; <span class="hljs-comment">// 维护栈的大小</span>

    <span class="hljs-keyword">constructor</span>() {
        <span class="hljs-keyword">this</span>.#head = <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">this</span>.#size = <span class="hljs-number">0</span>;
    }

    <span class="hljs-keyword">get</span> size() {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.#size;
    }

    isEmpty() {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.#size === <span class="hljs-number">0</span>;
    }

    push(num) {
        <span class="hljs-keyword">const</span> node = new ListNode(num);
        <span class="hljs-comment">// 新节点指向当前的栈顶</span>
        node.next = <span class="hljs-keyword">this</span>.#head;
        <span class="hljs-comment">// 更新栈顶指针指向新节点</span>
        <span class="hljs-keyword">this</span>.#head = node;
        <span class="hljs-keyword">this</span>.#size++;
    }

    pop() {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isEmpty()) {
            <span class="hljs-keyword">throw</span> new Error(<span class="hljs-string">"Stack Underflow: 栈为空"</span>);
        }
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> = <span class="hljs-keyword">this</span>.#head.<span class="hljs-keyword">val</span>;
        <span class="hljs-comment">// 移动栈顶指针到下一个节点</span>
        <span class="hljs-keyword">this</span>.#head = <span class="hljs-keyword">this</span>.#head.next;
        <span class="hljs-keyword">this</span>.#size--;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">val</span>;
    }

    peek() {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isEmpty()) {
            <span class="hljs-keyword">throw</span> new Error(<span class="hljs-string">"Stack is empty"</span>);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.#head.<span class="hljs-keyword">val</span>;
    }
}
</code></pre>
<h4 data-id="heading-8">性能与空间对比</h4>
<ul>
<li>
<p><strong>时间效率</strong>：链表实现的入栈和出栈操作是严格的 <strong>O(1)</strong> ，不存在数组的扩容机制，性能表现更加稳定。</p>
</li>
<li>
<p><strong>空间效率</strong>：</p>
<ul>
<li><strong>数组</strong>：存在空间浪费（预分配内存），但数据紧凑。</li>
<li><strong>链表</strong>：无预分配浪费，但每个元素需要额外的空间存储 next 指针。此外，由于内存地址不连续，链表对 CPU 缓存（Cache）的亲和性不如数组，可能导致缓存未命中率上升。</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-9">3. 算法实战：有效的括号 (LeetCode 20)</h2>
<p><strong>问题描述</strong>：给定一个只包括 '(', ')', '{', '}', '[', ']' 的字符串，判断字符串是否有效。有效字符串需满足：左括号必须用相同类型的右括号闭合，且闭合顺序正确。</p>
<h3 data-id="heading-10">3.1 解题思路</h3>
<p>这是栈的经典应用场景。</p>
<ol>
<li>
<p><strong>策略</strong>：遇到左括号入栈；遇到右括号，弹出栈顶元素进行匹配。</p>
</li>
<li>
<p><strong>映射维护</strong>：使用 Hash Map 存储右括号到左括号的映射，简化条件判断。</p>
</li>
<li>
<p><strong>边界条件</strong>：</p>
<ul>
<li>字符串长度为奇数，直接返回 false。</li>
<li>遍历结束后，栈必须为空（防止左括号冗余）。</li>
<li>遇到右括号时若栈为空，直接返回 false（防止右括号冗余）。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-11">3.2 优化代码实现</h3>
<p>JavaScript</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">/**
 * @param {string} s
 * @return {boolean}
 */</span>
<span class="hljs-type">const</span> isValid = <span class="hljs-built_in">function</span>(s) {
    <span class="hljs-comment">// 剪枝：奇数长度一定无法完全匹配</span>
    <span class="hljs-keyword">if</span> (s.length % <span class="hljs-number">2</span> !== <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

    <span class="hljs-comment">// 建立右括号到左括号的映射表</span>
    <span class="hljs-type">const</span> map = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Map</span>([
        [<span class="hljs-string">')'</span>, <span class="hljs-string">'('</span>],
        [<span class="hljs-string">']'</span>, <span class="hljs-string">'['</span>],
        [<span class="hljs-string">'}'</span>, <span class="hljs-string">'{'</span>]
    ]);

    <span class="hljs-type">const</span> stack = [];

    <span class="hljs-keyword">for</span> (let i = <span class="hljs-number">0</span>; i &lt; s.length; i++) {
        <span class="hljs-type">const</span> <span class="hljs-type">char</span> = s[i];

        <span class="hljs-comment">// 如果该字符是右括号（存在于 map 的 key 中）</span>
        <span class="hljs-keyword">if</span> (map.<span class="hljs-built_in">has</span>(<span class="hljs-type">char</span>)) {
            <span class="hljs-comment">// 获取栈顶元素，如果栈为空则 stack.pop() 返回 undefined</span>
            <span class="hljs-type">const</span> topElement = stack.<span class="hljs-built_in">pop</span>();
            
            <span class="hljs-comment">// 匹配失败：栈顶元素不是对应的左括号</span>
            <span class="hljs-keyword">if</span> (topElement !== map.<span class="hljs-built_in">get</span>(<span class="hljs-type">char</span>)) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 如果是左括号，直接入栈</span>
            stack.<span class="hljs-built_in">push</span>(<span class="hljs-type">char</span>);
        }
    }

    <span class="hljs-comment">// 只有栈被清空，才说明所有括号都正确闭合</span>
    <span class="hljs-keyword">return</span> stack.length === <span class="hljs-number">0</span>;
};
</code></pre>
<h3 data-id="heading-12">3.3 复杂度分析</h3>
<ul>
<li><strong>时间复杂度</strong>: <strong>O(n)</strong> 。我们需要遍历一次字符串，每个字符的入栈和出栈操作均为 O(1)。</li>
<li><strong>空间复杂度</strong>: <strong>O(n)</strong> 。最坏情况下（例如 (((((），栈的大小将达到字符串长度的一半。</li>
</ul>
<h2 data-id="heading-13">结语</h2>
<p>栈作为一种基础的线性数据结构，其简单的接口背后蕴含着深刻的计算机设计哲学。无论是基于数组的缓存友好型实现，还是基于链表的动态内存型实现，开发者都应根据具体场景（如是否对实时性敏感、数据量的预估）进行选择。掌握栈的底层逻辑，是通往高阶算法世界的必经之路。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[手搓 onscroll 到使用 IntersectionObserver API：懒加载实战指南]]></title>    <link>https://juejin.cn/post/7599514071105896463</link>    <guid>https://juejin.cn/post/7599514071105896463</guid>    <pubDate>2026-01-26T15:28:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599514071105896463" data-draft-id="7599526246503825442" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="手搓 onscroll 到使用 IntersectionObserver API：懒加载实战指南"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-26T15:28:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="无敌的拖拉斯旋风"/> <meta itemprop="url" content="https://juejin.cn/user/951508170179208"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            手搓 onscroll 到使用 IntersectionObserver API：懒加载实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/951508170179208/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    无敌的拖拉斯旋风
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T15:28:51.000Z" title="Mon Jan 26 2026 15:28:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>懒加载是前端开发中一个经典且实用的技术，它能够显著提升网页性能和用户体验。今天，让我们一起从最原始的 <code>onscroll</code> 方法开始，逐步探索到现代化的 <code>IntersectionObserver API</code>，亲手实现一个完整的懒加载功能。</p>
<h2 data-id="heading-1">第一步：传统方法 - onscroll 滚动监听</h2>
<h3 data-id="heading-2">最初的尝试</h3>
<p>让我们先看看传统的滚动监听方式：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>图片的懒加载<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        * {
            <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
        }

        <span class="hljs-selector-class">.box</span> {
            <span class="hljs-attribute">height</span>: <span class="hljs-number">200vh</span>;
            <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#eee</span>;
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"box"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 数据属性 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"lazy"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"placeholder.png"</span>
        <span class="hljs-attr">data-src</span>=<span class="hljs-string">"https://example.com/image1.jpg"</span>
        <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"box"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"lazy"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"placeholder.png"</span>
        <span class="hljs-attr">data-src</span>=<span class="hljs-string">"https://example.com/image2.jpg"</span>
        <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h3 data-id="heading-3">onscroll 实现方式</h3>
<pre><code class="hljs language-ini" lang="ini">// 传统方式实现懒加载
const <span class="hljs-attr">images</span> = document.querySelectorAll(<span class="hljs-string">'.lazy'</span>)<span class="hljs-comment">;</span>

const <span class="hljs-attr">checkImages</span> = () =&gt; {
    images.forEach(<span class="hljs-attr">img</span> =&gt; {
        const <span class="hljs-attr">rect</span> = img.getBoundingClientRect()<span class="hljs-comment">;</span>
        const <span class="hljs-attr">windowHeight</span> = window.innerHeight<span class="hljs-comment">;</span>
        
        // 图片进入视口时加载
        if (rect.top &lt; windowHeight &amp;&amp; rect.bottom &gt;= 0) {
            <span class="hljs-attr">img.src</span> = img.dataset.src<span class="hljs-comment">;</span>
            img.classList.remove('lazy')<span class="hljs-comment">;</span>
        }
    })<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>

// 监听滚动事件
window.addEventListener('scroll', checkImages)<span class="hljs-comment">;</span>

// 页面加载时也要检查一次
checkImages()<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-4">传统方法的问题</h3>
<p>这种方法虽然可行，但存在明显缺陷：</p>
<ol>
<li><strong>性能问题</strong>：<code>scroll</code> 事件触发频率极高，每秒可能触发几十次</li>
<li><strong>卡顿现象</strong>：频繁的 DOM 操作会导致页面卡顿</li>
<li><strong>计算开销</strong>：每次滚动都要计算所有图片的位置</li>
</ol>
<h2 data-id="heading-5">第二步：性能优化 - 节流函数</h2>
<h3 data-id="heading-6">为 onscroll 添加节流</h3>
<pre><code class="hljs language-ini" lang="ini">// 节流函数
const <span class="hljs-attr">throttle</span> = (func, delay) =&gt; {
    let timeoutId<span class="hljs-comment">;</span>
    let <span class="hljs-attr">lastExecTime</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
    
    return function (...args) {
        const <span class="hljs-attr">currentTime</span> = Date.now()<span class="hljs-comment">;</span>
        
        if (currentTime - lastExecTime &gt; delay) {
            func.apply(this, args)<span class="hljs-comment">;</span>
            <span class="hljs-attr">lastExecTime</span> = currentTime<span class="hljs-comment">;</span>
        } else {
            clearTimeout(timeoutId)<span class="hljs-comment">;</span>
            <span class="hljs-attr">timeoutId</span> = setTimeout(() =&gt; {
                func.apply(this, args)<span class="hljs-comment">;</span>
                <span class="hljs-attr">lastExecTime</span> = Date.now()<span class="hljs-comment">;</span>
            }, delay - (currentTime - lastExecTime))<span class="hljs-comment">;</span>
        }
    }<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>

// 应用节流
window.addEventListener('scroll', throttle(checkImages, 200))<span class="hljs-comment">;</span>
</code></pre>
<p>通过节流，我们将滚动事件的处理频率限制在每200毫秒一次，有效解决了性能问题。</p>
<h2 data-id="heading-7">第三步：现代化方案 - IntersectionObserver API</h2>
<h3 data-id="heading-8">为什么选择 IntersectionObserver？</h3>
<p>随着 Web API 的发展，<code>IntersectionObserver</code> 成为了懒加载的标准方案：</p>
<ul>
<li><strong>性能优越</strong>：浏览器内部优化，无性能问题</li>
<li><strong>语法简洁</strong>：API 设计更符合现代开发习惯</li>
<li><strong>功能强大</strong>：支持多种观察选项</li>
</ul>
<h3 data-id="heading-9">基础实现</h3>
<pre><code class="hljs language-ini" lang="ini">// 使用 IntersectionObserver 实现懒加载
const <span class="hljs-attr">images</span> = document.querySelectorAll(<span class="hljs-string">'.lazy'</span>)<span class="hljs-comment">;</span>

const <span class="hljs-attr">observer</span> = new IntersectionObserver((entries) =&gt; {
    entries.forEach((entry) =&gt; {
        // 当图片进入视口时
        if (entry.isIntersecting) {
            const <span class="hljs-attr">img</span> = entry.target<span class="hljs-comment">;</span>
            <span class="hljs-attr">img.src</span> = img.dataset.src<span class="hljs-comment">;</span>
            
            // 加载完成后停止观察，提高性能
            observer.unobserve(img)<span class="hljs-comment">;</span>
        }
    })<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>

// 观察所有懒加载图片
images.forEach((img) =&gt; {
    observer.observe(img)<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-10">完整的 HTML 示例</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>图片的懒加载<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        * {
            <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
        }

        <span class="hljs-selector-class">.box</span> {
            <span class="hljs-attribute">height</span>: <span class="hljs-number">200vh</span>;
            <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#eee</span>;
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"box"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 数据属性 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"lazy"</span> 
         <span class="hljs-attr">src</span>=<span class="hljs-string">"https://img10.360buyimg.com/wq/jfs/t24601/190/890984006/4559/731564fc/5b7f9b7bN3ccd29ab.png"</span>
         <span class="hljs-attr">data-src</span>=<span class="hljs-string">"https://img.36krcdn.com/hsossms/20260119/v2_53cad3f2226f48e2afc1942de3ab74e4@5888275@ai_oswg1141728oswg1053oswg495_img_png~tplv-1marlgjv7f-ai-v3:960:400:960:400:q70.jpg?x-oss-process=image/format,webp"</span>
         <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"box"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"lazy"</span> 
         <span class="hljs-attr">src</span>=<span class="hljs-string">"https://img10.360buyimg.com/wq/jfs/t24601/190/890984006/4559/731564fc/5b7f9b7bN3ccd29ab.png"</span>
         <span class="hljs-attr">data-src</span>=<span class="hljs-string">"https://img.36krcdn.com/hsossms/20260117/v2_1e74add07bb94971845c777e0ce87a49@000000@ai_oswg421938oswg1536oswg722_img_000~tplv-1marlgjv7f-ai-v3:960:400:960:400:q70.jpg?x-oss-process=image/format,webp"</span>
         <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-comment">// 图片懒加载</span>
        <span class="hljs-keyword">const</span> images = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'.lazy'</span>);
        
        <span class="hljs-comment">// 观察对象 onScroll</span>
        <span class="hljs-comment">// 浏览器的观察者模式  自动观察 （内置的，没有性能问题）</span>
        <span class="hljs-keyword">const</span> observer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntersectionObserver</span>(<span class="hljs-function">(<span class="hljs-params">entries</span>) =&gt;</span> {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(entries);
            <span class="hljs-comment">// 出现在视窗内 才加载图片 </span>
            entries.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">entry</span>) =&gt;</span> {
                <span class="hljs-keyword">if</span> (entry.<span class="hljs-property">isIntersecting</span>) {
                    <span class="hljs-keyword">const</span> original_img = entry.<span class="hljs-property">target</span>;
                    original_img.<span class="hljs-property">src</span> = original_img.<span class="hljs-property">dataset</span>.<span class="hljs-property">src</span>;
                    observer.<span class="hljs-title function_">unobserve</span>(original_img);
                }
            });
        });
        
        images.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">img</span>) =&gt;</span> {
            observer.<span class="hljs-title function_">observe</span>(img);
        });
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h2 data-id="heading-11">第四步：React 中的懒加载实现</h2>
<h3 data-id="heading-12">无限滚动组件</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">InfiniteScrollProps</span> {
    <span class="hljs-attr">hasMore</span>: <span class="hljs-built_in">boolean</span>; <span class="hljs-comment">// 是否所有数据都加载了 分页 </span>
    isLoading?: <span class="hljs-built_in">boolean</span>; <span class="hljs-comment">// 滚动到底部加载更多 避免重复触发</span>
    <span class="hljs-attr">onLoadMore</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>; <span class="hljs-comment">// 更多加载的一个抽象  /api/posts?page=2&amp;limit=10</span>
    <span class="hljs-attr">children</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">ReactNode</span> <span class="hljs-comment">// InfiniteScroll 通用的滚动功能，滚动的具体内容接受定制</span>
}

<span class="hljs-keyword">const</span> <span class="hljs-title class_">InfiniteScroll</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span>&lt;<span class="hljs-title class_">InfiniteScrollProps</span>&gt; = <span class="hljs-function">(<span class="hljs-params">{
    hasMore,
    onLoadMore,
    isLoading = <span class="hljs-literal">false</span>,
    children
}</span>) =&gt;</span> {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
            {children}
        <span class="hljs-tag">&lt;/&gt;</span></span>
    )
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">InfiniteScroll</span>
</code></pre>
<h3 data-id="heading-13">文章列表项组件</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { useNavigate } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-router-dom'</span>
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">Post</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/types/index'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Badge</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/ui/badge'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Avatar</span>, <span class="hljs-title class_">AvatarImage</span>, <span class="hljs-title class_">AvatarFallback</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/ui/avatar'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Eye</span>, <span class="hljs-title class_">Heart</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"lucide-react"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">LazyLoad</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react-lazy-load'</span>;

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">PostItemProps</span> {
    <span class="hljs-attr">post</span>: <span class="hljs-title class_">Post</span>;
}

<span class="hljs-keyword">const</span> <span class="hljs-title class_">PostItem</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span>&lt;<span class="hljs-title class_">PostItemProps</span>&gt; = <span class="hljs-function">(<span class="hljs-params">{ post }</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(post, <span class="hljs-string">'//////'</span>)
    <span class="hljs-keyword">const</span> navigate = <span class="hljs-title function_">useNavigate</span>();
    
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>
            <span class="hljs-attr">className</span>=<span class="hljs-string">"flex border-b border-border py-4 py-2"</span>
            // <span class="hljs-attr">动态路由</span> <span class="hljs-attr">暴露资源</span> <span class="hljs-attr">restful</span> <span class="hljs-attr">url</span> <span class="hljs-attr">资源具有描述性</span> 
            <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> { navigate(`/post/${post.id}`) }}
        &gt;
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex-1 pr-4 space-y-2"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex items-center gap-2"</span>&gt;</span>
                    {
                        post.tags.map((tag, index) =&gt; (
                            <span class="hljs-tag">&lt;<span class="hljs-name">Badge</span>
                                <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span>
                                <span class="hljs-attr">variant</span>=<span class="hljs-string">"outline"</span>
                                <span class="hljs-attr">className</span>=<span class="hljs-string">"text-xs"</span>
                            &gt;</span>{tag}<span class="hljs-tag">&lt;/<span class="hljs-name">Badge</span>&gt;</span>
                        ))
                    }
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                
                {/* 列表里面行高的截取 */}
                <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-base font-semibold leading-tight line-clamp-1"</span>&gt;</span>
                    {post.title}
                <span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-sm text-muted-foreground line-clamp-1"</span>&gt;</span>
                    {post.brief}
                <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>

                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex items-center justify-between mt-2"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex items-center gap-2 text-xs text-muted-foreground"</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">Avatar</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"w-5 h-5"</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">AvatarImage</span> <span class="hljs-attr">src</span>=<span class="hljs-string">{post.user.avatar}</span> /&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">AvatarFallback</span>&gt;</span>{post.user.name}<span class="hljs-tag">&lt;/<span class="hljs-name">AvatarFallback</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">Avatar</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{post.user.name}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex items-center gap-4 mt-2 text-xs text-muted-foreground"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex items-center gap-1"</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">Eye</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"w-3 h-3"</span> /&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{post.totalComments}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex items-center gap-1"</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">Heart</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"w-3 h-3"</span> /&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{post.totalLikes}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            
            {
                post.thumbnail &amp;&amp; (
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"w-24 h-24 flex-shrink-0 relative overflow-hidden"</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">LazyLoad</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"w-full h-full"</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">img</span>
                                <span class="hljs-attr">alt</span>=<span class="hljs-string">{post.title}</span>
                                <span class="hljs-attr">loading</span>=<span class="hljs-string">"lazy"</span>
                                <span class="hljs-attr">src</span>=<span class="hljs-string">{post.thumbnail}</span>
                                <span class="hljs-attr">className</span>=<span class="hljs-string">"w-full h-full object-cover"</span>
                            /&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">LazyLoad</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                )
            }
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">PostItem</span>
</code></pre>
<h3 data-id="heading-14">使用示例</h3>
<pre><code class="hljs language-ini" lang="ini">&lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"container mx-auto py-8"</span>&gt;
    &lt;h1 <span class="hljs-attr">className</span>=<span class="hljs-string">"text-2xl font-bold mb-6"</span>&gt;文章列表&lt;/h1&gt;
    {/* 通用的滚动到底部加载更多功能 */}
    &lt;InfiniteScroll
        <span class="hljs-attr">hasMore</span>={hasMore}
        <span class="hljs-attr">isLoading</span>={loading}
        <span class="hljs-attr">onLoadMore</span>={loadMore}
    &gt;
        &lt;ul&gt;
            {
                posts.map(<span class="hljs-attr">post</span> =&gt; (
                    &lt;PostItem
                        <span class="hljs-attr">key</span>={post.id}
                        <span class="hljs-attr">post</span>={post}
                    /&gt;
                ))
            }
        &lt;/ul&gt;
        {/* 业务组件 */}
    &lt;/InfiniteScroll&gt;
&lt;/div&gt;
</code></pre>
<h2 data-id="heading-15">第五步：最佳实践与优化</h2>
<h3 data-id="heading-16">1. 预加载策略</h3>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">observer</span> = new IntersectionObserver((entries) =&gt; {
    entries.forEach((entry) =&gt; {
        if (entry.isIntersecting) {
            const <span class="hljs-attr">img</span> = entry.target<span class="hljs-comment">;</span>
            
            // 创建新的 Image 对象预加载
            const <span class="hljs-attr">newImg</span> = new Image()<span class="hljs-comment">;</span>
            <span class="hljs-attr">newImg.onload</span> = () =&gt; {
                <span class="hljs-attr">img.src</span> = newImg.src<span class="hljs-comment">;</span>
            }<span class="hljs-comment">;</span>
            <span class="hljs-attr">newImg.src</span> = img.dataset.src<span class="hljs-comment">;</span>
            
            observer.unobserve(img)<span class="hljs-comment">;</span>
        }
    })<span class="hljs-comment">;</span>
}, {
    // 提前加载的阈值
    rootMargin: '50px'
})<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-17">2. 错误处理</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">newImg.onerror</span> = () =&gt; {
    <span class="hljs-attr">img.src</span> = <span class="hljs-string">'/fallback-image.png'</span><span class="hljs-comment">; // 备用图片</span>
}<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-18">3. 清理资源</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 组件卸载时清理观察器</span>
<span class="hljs-built_in">useEffect</span>(() =&gt; {
    return () =&gt; {
        observer<span class="hljs-selector-class">.disconnect</span>();
    };
}, <span class="hljs-selector-attr">[]</span>);
</code></pre>
<h2 data-id="heading-19">总结</h2>
<p>从传统的 <code>onscroll</code> 事件到现代化的 <code>IntersectionObserver API</code>，懒加载技术经历了巨大的演进：</p>
<ol>
<li><strong>性能提升</strong>：从手动优化到浏览器内置优化</li>
<li><strong>代码简化</strong>：从复杂计算到简洁 API</li>
<li><strong>功能增强</strong>：从基础功能到丰富配置选项</li>
</ol>
<p>通过亲手实现这些功能，我们不仅掌握了懒加载的核心原理，更重要的是理解了前端技术的发展脉络。每一次技术革新都是为了解决实际问题，提升用户体验和开发效率。</p>
<p>现在，你可以自信地说："我不仅会用懒加载，更知道它是如何工作的！"</p>
<p><strong>动手试试吧，让你的网页加载更快，用户体验更好！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AgentSkills经验第1节：AI时代的技能说明书基本介绍与使用]]></title>    <link>https://juejin.cn/post/7599550337384726591</link>    <guid>https://juejin.cn/post/7599550337384726591</guid>    <pubDate>2026-01-27T01:50:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599550337384726591" data-draft-id="7599550337384628287" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AgentSkills经验第1节：AI时代的技能说明书基本介绍与使用"/> <meta itemprop="keywords" content="后端,架构,AIGC"/> <meta itemprop="datePublished" content="2026-01-27T01:50:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="爱海贼的无处不在"/> <meta itemprop="url" content="https://juejin.cn/user/2359988032644541"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AgentSkills经验第1节：AI时代的技能说明书基本介绍与使用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2359988032644541/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    爱海贼的无处不在
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T01:50:28.000Z" title="Tue Jan 27 2026 01:50:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、前言</h2>
<p>今天我来分享一个在 2025 年 AI 圈子非常火的话题——AgentSkills(Claude Skills)，这个东西预计在2026年的生态将会越来越大，</p>
<p>如果你最近在关注 AI 智能体（Agent），你可能发现现在的 AI 已经不只是能“聊天”了，它们正在变得越来越像“数字员工”。而让这些员工变聪明的其中一个秘诀，就是这个由 Anthropic 最近牵头搞出来的开源标准：<strong>AgentSkills</strong>。早期的时候叫Claude Skills，后来变成了大家可以按照约定使用的标准。</p>
<p>以前我们要让 AI 完成一个复杂任务（比如：帮你写代码、部署测试环境、或者按照公司品牌规范写推文），我们通常需要写一段超长的 <strong>Prompt（提示词）</strong> 。</p>
<p>但问题是：提示词太长了 AI 容易忘，而且每次都要重新教一遍，非常心累。AI可能需要通过多次调用工具能力获取和处理这部分的能力，导致Token无限消耗。</p>
<p><strong>AgentSkills</strong> 的出现就是为了解决这个问题。简单来说，它给 AI 制定了一套<strong>标准技能包</strong>。你可以把它想象成给 AI 的“岗位操作手册”或“说明书”。一旦你写好了这个技能包，任何支持该标准的 AI（比如 Claude、或者集成了 GitHub Copilot 的工具）都能瞬间学会这门手艺，且执行得非常稳。</p>
<p>目前官方的网站为：<a href="https://link.juejin.cn?target=https%3A%2F%2Fagentskills.io%2Fhome" target="_blank" title="https://agentskills.io/home" ref="nofollow noopener noreferrer">agentskills.io/home</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/108c67846d8546a0be2bca50d4307a12~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770083428&amp;x-signature=lG7bE9mbxXt7RRAovn2pASMRzgs%3D" alt="" loading="lazy"/></p>
<p><strong>官方的定义如下：</strong></p>
<p><strong>Agent Skills 是一种简单、开放的格式，用于赋予 AI 智能体（Agents）新的能力和专业知识。</strong></p>
<p>Agent Skills 本质上是一个包含<strong>指令（Instructions）</strong> 、脚本（Scripts）<strong>和</strong>资源（Resources）的文件夹。智能体可以识别并利用这些文件夹，从而更准确、更高效地执行任务。</p>
<p><strong>同时官方也解释了为什么需要Agent Skills？</strong></p>
<p>原因在于，虽然现在的 AI 智能体能力越来越强，但它们往往缺乏开展实际工作所需的“上下文”。</p>
<p>Agent Skills 通过为智能体提供<strong>程序性知识</strong>，以及针对特定公司、团队或用户的<strong>定制化背景信息</strong>，解决了这一问题。智能体可以根据正在处理的任务，按需加载这些技能。</p>
<ol>
<li><strong>对于技能开发者：</strong> 只需开发一次技能，即可在多个支持该标准的智能体产品中部署。</li>
<li><strong>对于兼容的智能体：</strong> 支持该标准后，最终用户可以开箱即用地为智能体添加新功能。</li>
<li><strong>对于团队和企业：</strong> 能够以可移植、可进行版本控制的包形式，沉淀并管理组织内部的知识。</li>
</ol>
<p><strong>Agent Skills 能实现什么？</strong></p>
<ol>
<li><strong>领域专家化：</strong> 将专业知识（如法律审查流程、数据分析管道）封装成可复用的指令。</li>
<li><strong>扩展新功能：</strong> 让智能体学会制作演示文稿（PPT）、构建 MCP 服务器、分析大型数据集等。</li>
<li><strong>可重复的工作流：</strong> 将多步骤的复杂任务转变为一致且可审计的标准流程。</li>
<li><strong>互操作性：</strong> 在不同的支持 Agent Skills 的 AI 产品之间重复使用同一个技能。</li>
</ol>
<p>目前很多工具都集成了Skills的自动支持，并得到了一系列领先 AI 开发工具的支持，包括：</p>
<ol>
<li><strong>编辑器/平台：</strong> Cursor, VS Code, GitHub, Claude Code, OpenCode，QwenCode。</li>
<li><strong>框架/工具：</strong> Claude, OpenAI Codex, Letta, Goose, Amp, Factory。</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4378d38e69964b33a00948546fbcf450~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770083428&amp;x-signature=b%2FwC6qnIs9jb68GAPyyItcHlMF4%3D" alt="nano_banana_pro_2026-01-27T01-43-50-438Z.jpeg" loading="lazy"/></p>
<h2 data-id="heading-1">二、正文：AgentSkills 到底怎么玩？</h2>
<h3 data-id="heading-2">2.1、基本约定</h3>
<p>从技术角度看，AgentSkills 是一个开源的、标准化的文件夹格式。它告诉 AI 在遇到特定任务时，应该遵循什么样的步骤、调用哪些脚本、参考哪些资料。</p>
<p>灵魂文件：SKILL.md</p>
<p>一个典型的 Agent Skill 其实就是一个文件夹，里面最核心的文件叫 SKILL.md。它的长相通常是这样的：</p>
<ul>
<li><strong>元数据（YAML Frontmatter）：</strong> 定义技能的名字、描述（让 AI 知道什么时候该用这个技能）。</li>
<li><strong>指令（Instructions）：</strong> 详细的步骤，告诉 AI 第一步干啥，第二步干啥。告诉智能体如何执行特定任务的详细指南。</li>
<li><strong>资源（Resources）：</strong> 文件夹里可以放相关的 Python 脚本、JS/TS脚本、模板文件或数据文件。技能还可以捆绑脚本、模板和参考资料。</li>
</ul>
<p>一个典型的目录结构如下：</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-keyword">my</span>-skill/
├── SKILL.md       <span class="hljs-comment"># 必选：包含指令和元数据</span>
├── scripts/       <span class="hljs-comment"># 可选：可执行代码</span>
├── references/    <span class="hljs-comment"># 可选：文档资料</span>
└── assets/        <span class="hljs-comment"># 可选：模板、资源文件</span>
</code></pre>
<p>我们只需要模拟并创建这样的一个技能的约定格式就行，从目录结构看一个“技能”就是一个独立的目录。其基本结构如下：</p>
<ul>
<li><strong>SKILL.md (必选)</strong> ：技能的核心配置文件，包含指令和元数据。</li>
<li><strong>scripts/ (可选)</strong> ：存放该技能需要执行的代码脚本（如 Python、Bash）。</li>
<li><strong>references/ (可选)</strong> ：存放长篇文档、API 参考或背景资料。</li>
<li><strong>assets/ (可选)</strong> ：存放模板、静态文件或其他资源。</li>
</ul>
<p><strong>注意</strong>：目录的名称必须与 SKILL.md 中定义的 name 字段完全一致。</p>
<p>元数据区中的</p>
<p>name，必须是1-64 字符。仅限小写字母、数字和连字符（-），必须与文件夹名匹配。</p>
<p>description：1-1024 字符。描述技能的作用以及“何时”该用它（智能体靠它来判断意图）。</p>
<p>元数据下方即为正文。这是给 AI 看的“操作手册”。</p>
<p>如果需要操作，执行步骤很简单：</p>
<ol>
<li>在你的项目里新建个目录：.github/skills/我的超强技能/ 或 .claude/skills/我的超强技能/</li>
<li>在里面写个 SKILL.md。</li>
<li>在文件开头写上：</li>
</ol>

<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">name: webapp-testing</span>
<span class="hljs-section">description: 当用户要求测试网页时，请使用此技能。</span>
</code></pre>
<p>解释如下：</p>
<p><strong>name:</strong> 简短的唯一标识符。</p>
<p><strong>description:</strong> 描述该技能的使用场景（这对于智能体判断何时调用至关重要）。</p>
<p>然后再用 Markdown 写清楚具体怎么测。</p>
<p>支持的 AI Agent 或AI编码工具看到这个文件夹，就会自动把它加入自己的技能库。</p>
<h3 data-id="heading-3">2.2、VSCode使用Skills</h3>
<p>首先我们更新最新版的VSCode，然后再设置中开启支持：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/44804eca9875458a8058cc1f2bc1528b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770083428&amp;x-signature=XyiRf%2BvYVhCwaYoEZ%2Ftj%2BHT3kNo%3D" alt="" loading="lazy"/></p>
<p>然后我们在项目的工作目录下创建.claude/skills文件夹，这里我们也可以导入官方的实例的Skills库，帮助我们更容易的创建一个标准的Skill，非常方便。</p>
<p>这里我导入了一些Claude提供的Skill示例：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e2d8e59a61e9481fa509dba8dc3899d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770083428&amp;x-signature=xHBaDnzYnlIBqjPkma7pKiED4L8%3D" alt="" loading="lazy"/></p>
<p>这些技能的实例可以帮助我们了解一个技能的目录结构、基本编写是什么样的，多数可以看到他就是一个个的SOP服务。</p>
<p>这里提供了一个skill-creator的技能的，这个技能是用来创建技能的，我们有时候可以让AI根据我们自己的想法创建出来一些新的技能，在Github Copilot中，我们可以问：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d3d6ca3616234aaab4fe0da61f47e758~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770083428&amp;x-signature=rzJAb%2B4jXNQaWJznWLqqghqcTIw%3D" alt="" loading="lazy"/></p>
<p>可以看到这个技能根据我们的需求，自动给我们创建了个新的技能，展示执行过程，可以看到它先读取到了匹配的技能文件，然后根据文件中的要求加载后创建了技能：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/50fca3d91c51441aa28ea271e7801ae1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770083428&amp;x-signature=zpgb7My3E6F9RtogKr3ySoXd85w%3D" alt="" loading="lazy"/></p>
<p>这个新技能的文件截图如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4c3544780fda4a65be3ec09dfce5f173~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770083428&amp;x-signature=aWDVw27Mh0fhnViPDi7H9QLknwE%3D" alt="" loading="lazy"/></p>
<p>目前有很多的技能市场服务、技能仓库，可以给我们提供示例进行学习：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FComposioHQ%2Fawesome-claude-skillshttps%3A%2F%2Fgithub.com%2FVoltAgent%2Fawesome-claude-skillshttps%3A%2F%2Fgithub.com%2FBehiSecc%2Fawesome-claude-skills" target="_blank" title="https://github.com/ComposioHQ/awesome-claude-skillshttps://github.com/VoltAgent/awesome-claude-skillshttps://github.com/BehiSecc/awesome-claude-skills" ref="nofollow noopener noreferrer">github.com/ComposioHQ/…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FComposioHQ%2Fawesome-claude-skillshttps%3A%2F%2Fgithub.com%2FVoltAgent%2Fawesome-claude-skillshttps%3A%2F%2Fgithub.com%2FBehiSecc%2Fawesome-claude-skills" target="_blank" title="https://github.com/ComposioHQ/awesome-claude-skillshttps://github.com/VoltAgent/awesome-claude-skillshttps://github.com/BehiSecc/awesome-claude-skills" ref="nofollow noopener noreferrer">github.com/VoltAgent/a…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FComposioHQ%2Fawesome-claude-skillshttps%3A%2F%2Fgithub.com%2FVoltAgent%2Fawesome-claude-skillshttps%3A%2F%2Fgithub.com%2FBehiSecc%2Fawesome-claude-skills" target="_blank" title="https://github.com/ComposioHQ/awesome-claude-skillshttps://github.com/VoltAgent/awesome-claude-skillshttps://github.com/BehiSecc/awesome-claude-skills" ref="nofollow noopener noreferrer">github.com/BehiSecc/aw…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanthropics%2Fskills" target="_blank" title="https://github.com/anthropics/skills" ref="nofollow noopener noreferrer">github.com/anthropics/…</a></p>
<p>那么技能这个东西的原理到底如何实现了，本质核心是【技能提示词指令】，这些IDE工具的AI编码助手会读取技能文件夹树结构，然后注入到和AI交互的提示词中，结构类似如下：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">available_skills</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">skill</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>pdf-processing<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>Extracts text and tables from PDF files, fills forms, merges documents.<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">location</span>&gt;</span>/path/to/skills/pdf-processing/SKILL.md<span class="hljs-tag">&lt;/<span class="hljs-name">location</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">skill</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">skill</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>data-analysis<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>Analyzes datasets, generates charts, and creates summary reports.<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">location</span>&gt;</span>/path/to/skills/data-analysis/SKILL.md<span class="hljs-tag">&lt;/<span class="hljs-name">location</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">skill</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">available_skills</span>&gt;</span>
</code></pre>
<p>我们来看看Github Copilot中，实际的请求的报文，看看它是如何处理的：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41ece33c0fda4090bf75357a84c51d33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770083428&amp;x-signature=uWspgZQaxDBetYdnmvrPsdyWeDA%3D" alt="" loading="lazy"/></p>
<p>展开这个日志交互后，可以看到它也是拼接了技能的XML格式指令提示词，给到了大模型：</p>
<p>代码提示词如下：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">instructions</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">skills</span>&gt;</span>
Here is a list of skills that contain domain specific knowledge on a variety of topics.
Each skill comes with a description of the topic and a file path that contains the detailed instructions.
When a user asks you to perform a task that falls within the domain of a skill, use the 'read_file' tool to acquire the full instructions from the file URI.
<span class="hljs-tag">&lt;<span class="hljs-name">skill</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>brand-guidelines<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>Applies Anthropic's official brand colors and typography to any sort of artifact that may benefit from having Anthropic's look-and-feel. Use it when brand colors or style guidelines, visual formatting, or company design standards apply.<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">file</span>&gt;</span>d:\develop.claude\skills\brand-guidelines\SKILL.md<span class="hljs-tag">&lt;/<span class="hljs-name">file</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">skill</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">skill</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>doc-coauthoring<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>Guide users through a structured workflow for co-authoring documentation. Use when user wants to write documentation, proposals, technical specs, decision docs, or similar structured content. This workflow helps users efficiently transfer context, refine content through iteration, and verify the doc works for readers. Trigger when user mentions writing docs, creating proposals, drafting specs, or similar documentation tasks.<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">file</span>&gt;</span>d:\develop.claude\skills\doc-coauthoring\SKILL.md<span class="hljs-tag">&lt;/<span class="hljs-name">file</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">skill</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">skill</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>algorithmic-art<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>Creating algorithmic art using p5.js with seeded randomness and interactive parameter exploration. Use this when users request creating art using code, generative art, algorithmic art, flow fields, or particle systems. Create original algorithmic art rather than copying existing artists' work to avoid copyright violations.<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">file</span>&gt;</span>d:\develop.claude\skills\algorithmic-art\SKILL.md<span class="hljs-tag">&lt;/<span class="hljs-name">file</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">skill</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">instructions</span>&gt;</span>
</code></pre>
<p>这样下来是不是很简单了。</p>
<p>claude-skills的第一性原理的文章：<a href="https://link.juejin.cn?target=https%3A%2F%2Fleehanchung.github.io%2Fblogs%2F2025%2F10%2F26%2Fclaude-skills-deep-dive" target="_blank" title="https://leehanchung.github.io/blogs/2025/10/26/claude-skills-deep-dive" ref="nofollow noopener noreferrer">leehanchung.github.io/blogs/2025/…</a></p>
<p>目前Skills的生态有很多，比如OpenSkills、Skill市场、Skill仓库都是围绕技能的一些分享。未来每个人都可以把自己的经验维护成技能进行使用。</p>
<p>网友总结道：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FUjZAqvkfk8AzpOoK1KV0yw" target="_blank" title="https://mp.weixin.qq.com/s/UjZAqvkfk8AzpOoK1KV0yw" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/UjZAqvkfk…</a></p>
<blockquote>
<p>在很多人还沉迷在“写花式 Prompt”，但从 Skills / Projects / MCP / Subagents 这套组合来看，趋势已经非常明显：</p>
<p>做 AI 产品，如果只停留在 Prompt 层，就是停留在 Demo 层，要往真正的“业务系统”走，就绕不开流程工程和 Skill 设计。</p>
<p>现在已经用 Skills 做很多件事：</p>
<p>—— 一个是【写公众号 Skill】，比如标题怎么写，导语怎么设计，配图比例怎么选，都写在里面；</p>
<p>—— 一个是【代码性能分析 Skill】，性能涉及到很多方面，比如数据库设计（索引、事务等）、Redis和数据库的配合、代码的算法和架构等等。缓存策略等等，单独靠MCP或Subagent是很难完成的，需要一整套流派。</p>
<p>—— 一个是【产品更新日志 Skill】，我只管往里丢 changelog，它会自动帮我改成对用户友好的版本。</p>
<p>—— 一个是【产gidea头脑风暴 Skill】，我有新奇idea的时候，不再用直接提问ChatGPT，而是有一个特定的流派。</p>
<p>—— 一个是【域名讨论 Skill】，做新产品时，想核名/查一个头疼的事，可以通过Skill来找到后选域名，查询是否可用</p>
<p>……</p>
</blockquote>
<p><strong>Prompt Engineering 只是上半场，真正的下半场，是「流程工程（Workflow / Skill Engineering）」。</strong></p>
<ul>
<li>Prompt 解决的是「怎么和模型说话」</li>
<li>Skill/Project/Subagent/MCP 解决的是</li>
<li>「模型在一个复杂环境下，怎么长期、稳定、可维护地为你干活」</li>
</ul>
<h2 data-id="heading-4">三、总结</h2>
<p>在 2026 年的今天，AI 的底层逻辑已经很强了，拉开差距的地方就在于私有技能的沉淀。</p>
<p><strong>AgentSkills</strong> 不仅仅是一个技术标准，它其实代表了一种工作流的封装。无论你是程序员、行政还是数据分析师，如果你能把自己的“独门绝技”整理成一个个标准化的 Skill，你就是在打造一个独属于你的、极度高效的 AI 团队。</p>
<p><strong>我的建议是：</strong> 如果你手里有一些经常需要重复给 AI 下达的复杂指令，不妨现在就尝试把它们改写成 SKILL.md 的格式。你会发现，AI 的“智商”瞬间就提上去了！</p>
<p>1、技能是如何工作的？</p>
<p>技能采用 <strong>“渐进式披露（Progressive Disclosure）”</strong> 机制，以高效管理上下文：</p>
<ol>
<li>
<p><strong>发现（Discovery）：</strong> 启动时，智能体仅加载每个可用技能的“名称”和“描述”。这足以让它知道该技能何时可能派上用场。</p>
</li>
<li>
<p><strong>激活（Activation）：</strong> 当任务与技能描述匹配时，智能体才会将 SKILL.md 中的完整指令读取到上下文（Context）中。</p>
</li>
<li>
<p><strong>执行（Execution）：</strong> 智能体遵循指令操作，根据需要加载引用的文件或执行捆绑的代码。</p>
</li>
</ol>
<p>如果把 AI 智能体比作一个“新员工”，那么 <strong>Agent Skills</strong> 就是一份份岗位说明书+工具箱。它不只是告诉 AI 该做什么，还把做这件事需要的脚本工具和参考资料打包在一起，让 AI 拿来就能用，且保证每次做得都一样专业。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f315e8ac9c824924bf98ff09b643f04e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770083428&amp;x-signature=T%2B93AC116%2FflhtI0uXdZNJ4cgwY%3D" alt="nano_banana_pro_2026-01-27T01-46-56-189Z.jpeg" loading="lazy"/></p>
<p>大家最近可能还听过 <strong>MCP（Model Context Protocol）</strong> 。</p>
<p>这里有个很形象的比喻：</p>
<ul>
<li><strong>MCP 是 AI 的“手”：</strong> 它解决了“连接”问题。比如 AI 怎么连上你的数据库、怎么打开你的谷歌搜索。</li>
<li><strong>AgentSkills 是 AI 的“脑”：</strong> 它解决了“能力”问题。即使 AI 拿到了数据库权限（有手了），它还得知道“按照公司审计流程，应该如何查询异常数据”（这就是技能）。</li>
</ul>
<p><strong>一句话总结：</strong> MCP 让 AI “够得到”工具，AgentSkills 教 AI “怎么用”工具。</p>
<p>它和其他2个概念的对比如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a61bbcb6dc62414d84ee95a5582fb6c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770083428&amp;x-signature=1UTJ%2BadIlVL%2B2NB51z1gw4eT1Os%3D" alt="" loading="lazy"/></p>
<p>参考资料如下：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.53ai.com%2Fnews%2Fzhinengkefu%2F2025103051368.html" target="_blank" title="https://www.53ai.com/news/zhinengkefu/2025103051368.html" ref="nofollow noopener noreferrer">www.53ai.com/news/zhinen…</a></p>
<p>通往AGI之路的飞书云文档的Skills分享：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwaytoagi.feishu.cn%2Fwiki%2FRgZrwqNmdiEXrWkA7sPc7WDfnmh%3Ffrom%3Dspace_search" target="_blank" title="https://waytoagi.feishu.cn/wiki/RgZrwqNmdiEXrWkA7sPc7WDfnmh?from=space_search" ref="nofollow noopener noreferrer">waytoagi.feishu.cn/wiki/RgZrwq…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwaytoagi.feishu.cn%2Fwiki%2FY3TPwfCjTik8YKkFUNtct5g8ntN%3Ffrom%3Dspace_search" target="_blank" title="https://waytoagi.feishu.cn/wiki/Y3TPwfCjTik8YKkFUNtct5g8ntN?from=space_search" ref="nofollow noopener noreferrer">waytoagi.feishu.cn/wiki/Y3TPwf…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwaytoagi.feishu.cn%2Fwiki%2FW7qbwhK1BiYwNnkybgIcRHxMn5g" target="_blank" title="https://waytoagi.feishu.cn/wiki/W7qbwhK1BiYwNnkybgIcRHxMn5g" ref="nofollow noopener noreferrer">waytoagi.feishu.cn/wiki/W7qbwh…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwaytoagi.feishu.cn%2Fwiki%2FNWQKwGyupiENv3kwnIScj7Fbnxe" target="_blank" title="https://waytoagi.feishu.cn/wiki/NWQKwGyupiENv3kwnIScj7Fbnxe" ref="nofollow noopener noreferrer">waytoagi.feishu.cn/wiki/NWQKwG…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[拒绝背诵：从底层机制彻底搞懂 JavaScript 事件监听与实战]]></title>    <link>https://juejin.cn/post/7599483794657886249</link>    <guid>https://juejin.cn/post/7599483794657886249</guid>    <pubDate>2026-01-26T15:13:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599483794657886249" data-draft-id="7599511763987546166" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="拒绝背诵：从底层机制彻底搞懂 JavaScript 事件监听与实战"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-26T15:13:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="NEXT06"/> <meta itemprop="url" content="https://juejin.cn/user/1176918763246011"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            拒绝背诵：从底层机制彻底搞懂 JavaScript 事件监听与实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1176918763246011/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    NEXT06
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T15:13:16.000Z" title="Mon Jan 26 2026 15:13:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在前端面试中，"事件流"、"冒泡与捕获"、"事件委托"几乎是必考题。然而，很多开发者对这些概念的理解仅停留在背诵教科书定义的层面。</p>
<ul>
<li>"为什么点击子元素，父元素也会触发？"</li>
<li>"React/Vue 的合成事件系统（SyntheticEvent）为什么要挂载在 root 节点上？"</li>
<li>"在移动端开发中，为什么会遇到点击穿透问题？"</li>
</ul>
<p>要回答这些问题，单纯记忆 API 是不够的。浏览器中的事件系统不仅仅是简单的 click 响应，它本质上是一套严密的<strong>消息传递系统</strong>。本文将抛弃死记硬背的学习方式，从历史演变、底层机制到工程实战，带你彻底重构对 JavaScript 事件机制的认知。</p>
<h2 data-id="heading-0">1. 事件监听的“前身”与进化</h2>
<p>在 addEventListener 成为标准之前，前端开发者经历过一段混乱的时期。理解这段历史，有助于明白为什么现代标准是如今的样子。</p>
<h3 data-id="heading-1">DOM 0 级事件：简陋的开端</h3>
<p>早期的 JavaScript 事件绑定非常直接，将函数赋值给 DOM 元素的属性：</p>
<p>JavaScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> btn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'btn'</span>);

<span class="hljs-comment">// 注册</span>
btn.<span class="hljs-property">onclick</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Handler 1'</span>);
};

<span class="hljs-comment">// 缺陷：覆盖</span>
btn.<span class="hljs-property">onclick</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Handler 2'</span>); <span class="hljs-comment">// Handler 1 将永远不会执行</span>
};
</code></pre>
<p><strong>痛点分析：</strong></p>
<ol>
<li><strong>单一性</strong>：同名事件只能绑定一个处理函数，后写的会覆盖先写的，这在多人协作或组件化开发中是灾难性的。</li>
<li><strong>阶段受限</strong>：DOM 0 级事件仅支持<strong>冒泡阶段</strong>，无法在捕获阶段进行拦截，缺乏控制力。</li>
<li><strong>逻辑耦合</strong>：事件处理逻辑直接挂载在 DOM 对象属性上，容易导致内存泄漏且难以维护。</li>
</ol>
<h3 data-id="heading-2">DOM 2 级事件：标准化的曙光</h3>
<p>为了解决上述问题，W3C 推出了 DOM 2 级事件模型，引入了 addEventListener。</p>
<p>JavaScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> btn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'btn'</span>);

<span class="hljs-comment">// 支持多监听器</span>
btn.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, handler1, <span class="hljs-literal">false</span>);
btn.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, handler2, <span class="hljs-literal">false</span>); 

<span class="hljs-comment">// 核心签名</span>
<span class="hljs-comment">// element.addEventListener(eventType, listener, useCapture/options);</span>
</code></pre>
<p><strong>优势对比：</strong></p>
<ul>
<li><strong>多播机制</strong>：允许在一个元素上绑定多个同类型事件，按注册顺序依次执行。</li>
<li><strong>流控制</strong>：第三个参数 useCapture (或 options 对象) 赋予了开发者控制事件在<strong>捕获</strong>还是<strong>冒泡</strong>阶段执行的能力。</li>
</ul>
<h2 data-id="heading-3">2. 事件机制的“作用”与核心流程</h2>
<p>为什么点击屏幕上一个像素，浏览器能精准地知道要触发哪些回调？这依赖于 DOM 事件流（Event Flow）。</p>
<h3 data-id="heading-4">事件流三部曲</h3>
<p>当一个事件发生时，它不会直接命中目标，而是经历一次完整的“往返跑”。</p>
<p>Mermaid</p>
<pre><code class="hljs language-css" lang="css">graph <span class="hljs-selector-tag">TD</span>
    subgraph EventFlow
    <span class="hljs-attribute">direction</span> TB
    Window<span class="hljs-selector-attr">[Window]</span> --&gt;|<span class="hljs-number">1</span>. 捕获阶段 Capturing| Doc<span class="hljs-selector-attr">[Document]</span>
    Doc --&gt; <span class="hljs-selector-tag">HTML</span><span class="hljs-selector-attr">[HTML]</span>
    <span class="hljs-selector-tag">HTML</span> --&gt; <span class="hljs-selector-tag">Body</span><span class="hljs-selector-attr">[Body]</span>
    <span class="hljs-selector-tag">Body</span> --&gt; Parent<span class="hljs-selector-attr">[Parent Div]</span>
    Parent --&gt;|<span class="hljs-number">2</span>. 目标阶段 Target| Child<span class="hljs-selector-attr">[Target: Child Div]</span>
    
    Child --&gt;|<span class="hljs-number">3</span>. 冒泡阶段 Bubbling| Parent
    Parent --&gt; <span class="hljs-selector-tag">Body</span>
    <span class="hljs-selector-tag">Body</span> --&gt; <span class="hljs-selector-tag">HTML</span>
    <span class="hljs-selector-tag">HTML</span> --&gt; Doc
    Doc --&gt; Window
    end
    
    style Child fill:<span class="hljs-number">#f96</span>,stroke:<span class="hljs-number">#333</span>,stroke-width:<span class="hljs-number">2px</span>
</code></pre>
<ol>
<li><strong>捕获阶段 (Capturing Phase)</strong> ：事件从 Window 顶层对象发出，逐层向下查找，直到到达目标元素的父级。这个阶段旨在给上层容器拦截事件的机会。</li>
<li><strong>目标阶段 (Target Phase)</strong> ：事件到达实际被点击的元素（event.target）。</li>
<li><strong>冒泡阶段 (Bubbling Phase)</strong> ：事件从目标元素开始，逐层向上回传，直到 Window。绝大多数业务逻辑（如点击响应）都默认发生在这个阶段。</li>
</ol>
<h3 data-id="heading-5">关键 API 深度辨析</h3>
<p>在实际开发中，精准控制事件流向是架构师的基本功。</p>
<h4 data-id="heading-6">event.stopPropagation()</h4>
<p>这个方法用于阻止事件在 DOM 树中的进一步传播（无论是捕获还是冒泡）。</p>
<p>参考以下场景</p>
<ul>
<li>父容器监听了 click（冒泡阶段）。</li>
<li>子容器监听了 click，但调用了 event.stopPropagation()。</li>
</ul>
<p>JavaScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Parent Listener</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'parent'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Parent Clicked'</span>); 
}, <span class="hljs-literal">false</span>); <span class="hljs-comment">// false 表示在冒泡阶段触发</span>

<span class="hljs-comment">// Child Listener</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'child'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) {
    <span class="hljs-comment">// 关键点：切断传播链路</span>
    event.<span class="hljs-title function_">stopPropagation</span>();
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Child Clicked'</span>);
}, <span class="hljs-literal">false</span>);
</code></pre>
<p><strong>执行结果</strong>：控制台仅输出 "Child Clicked"。父元素的监听器虽已注册，但由于传播链路在子元素处被物理截断，事件永远无法“冒泡”到父元素。</p>
<h4 data-id="heading-7">event.stopImmediatePropagation()</h4>
<p>这是 stopPropagation 的加强版。如果一个元素上绑定了多个 click 监听器：</p>
<ol>
<li>stopPropagation 只能阻止事件传播到<strong>父级</strong>，同级的其他监听器照常执行。</li>
<li>stopImmediatePropagation 不仅阻止传播到父级，还会阻止<strong>当前元素上后续注册的监听器</strong>执行。</li>
</ol>
<p>这在处理第三方库冲突或组件内部逻辑优先级时非常有用。</p>
<h2 data-id="heading-8">3. 应用场景与工程实战</h2>
<p>理解底层机制的最终目的是写出高性能、可维护的代码。<strong>事件委托 (Event Delegation)</strong>  是最经典的应用场景。</p>
<h3 data-id="heading-9">内存泄漏的陷阱</h3>
<p>假设我们有一个包含 1000 个列表项的 ul，新手往往会这样写：</p>
<p>JavaScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">//  错误示范：性能杀手</span>
<span class="hljs-keyword">const</span> listItems = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'li'</span>);
listItems.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {
    item.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Clicked'</span>);
    });
});
</code></pre>
<p><strong>原理分析</strong>：</p>
<ol>
<li><strong>内存开销</strong>：浏览器需要创建 1000 个监听器对象，占用大量堆内存。</li>
<li><strong>动态失效</strong>：如果通过 AJAX 新增了一个 li，由于没有绑定监听器，点击无效。这也是导致 bug 的常见原因。</li>
</ol>
<h3 data-id="heading-10">终极解决方案：事件委托</h3>
<p>利用<strong>冒泡机制</strong>，我们将监听器绑定在父容器（如 ul）上。无论子元素点击哪里，事件最终都会冒泡到父容器。</p>
<p>以下是修正并优化后的实战代码</p>
<p>JavaScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">//  最佳实践</span>
<span class="hljs-keyword">const</span> list = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'list'</span>); 

list.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) {
    <span class="hljs-comment">// 1. 获取点击的实际目标</span>
    <span class="hljs-keyword">let</span> target = event.<span class="hljs-property">target</span>;
    
    <span class="hljs-comment">// 2. 核心优化：Element.closest()</span>
    <span class="hljs-comment">// 如果 li 内部包含 span 或 icon，event.target 可能是 span</span>
    <span class="hljs-comment">// 使用 closest 向上查找最近的 li，确保逻辑正确</span>
    <span class="hljs-keyword">const</span> listItem = target.<span class="hljs-title function_">closest</span>(<span class="hljs-string">'li'</span>);

    <span class="hljs-comment">// 3. 边界防御</span>
    <span class="hljs-comment">// 确保找到的是 li，且该 li 确实属于当前的 list 容器</span>
    <span class="hljs-keyword">if</span> (listItem &amp;&amp; list.<span class="hljs-title function_">contains</span>(listItem)) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'选中的内容:'</span>, listItem.<span class="hljs-property">innerHTML</span>);
        <span class="hljs-comment">// 执行业务逻辑...</span>
    }
});
</code></pre>
<p><strong>代码解析</strong>：</p>
<ul>
<li><strong>closest 垫片</strong>：这是事件委托中被忽视的细节。如果 li 中包含 <span>123</span>，点击 span 时 event.target 是 span，直接取 innerHTML 可能是错误的。使用 closest('li') 可以完美解决嵌套点击问题。</li>
</ul>
<h3 data-id="heading-11">区分 target 与 currentTarget</h3>
<p>这是调试事件委托时的混淆高发区：</p>




















<table><thead><tr><th>属性</th><th>含义</th><th>形象比喻</th></tr></thead><tbody><tr><td><strong>event.target</strong></td><td>实际触发事件的元素（如被点击的 li 或 span）</td><td>案发现场</td></tr><tr><td><strong>event.currentTarget</strong></td><td>绑定监听器的元素（如 ul），等同于事件回调中的 this</td><td>监听哨所</td></tr></tbody></table>
<p>在事件委托中，我们通常操作 target 来获取数据，操作 currentTarget 来控制监听器的状态。</p>
<h2 data-id="heading-12">4. 总结</h2>
<p>JavaScript 的事件机制并非简单的 API 调用，它是浏览器处理用户交互的底层逻辑基石。</p>
<ol>
<li><strong>历史观</strong>：从 DOM 0 到 DOM 2，是前端工程化对解耦和复用的必然要求。</li>
<li><strong>机制观</strong>：捕获与冒泡构成了事件流的闭环，stopPropagation 是控制这一流向的阀门。</li>
<li><strong>实战观</strong>：通过事件委托，我们将 O(N) 的空间复杂度优化为 O(1)，并利用 closest 等 API 处理复杂的 DOM 结构。</li>
</ol>
<p>React 和 Vue 等现代框架的合成事件系统，本质上就是一套在顶层（document 或 root）进行<strong>全量事件委托</strong>的封装实现。彻底掌握原生事件机制，是成为高级前端工程师的必经之路。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android 15存储子系统深度解析（三）：FBE加密文件系统与存储性能优化实战]]></title>    <link>https://juejin.cn/post/7599330434427158579</link>    <guid>https://juejin.cn/post/7599330434427158579</guid>    <pubDate>2026-01-26T12:06:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599330434427158579" data-draft-id="7599478406238470153" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android 15存储子系统深度解析（三）：FBE加密文件系统与存储性能优化实战"/> <meta itemprop="keywords" content="Android,源码阅读,源码"/> <meta itemprop="datePublished" content="2026-01-26T12:06:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冬奇Lab"/> <meta itemprop="url" content="https://juejin.cn/user/1857501105781193"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android 15存储子系统深度解析（三）：FBE加密文件系统与存储性能优化实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1857501105781193/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冬奇Lab
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T12:06:27.000Z" title="Mon Jan 26 2026 12:06:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读24分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>在前两篇文章中，我们深入分析了Android 15的Vold存储管理框架和FUSE文件系统。本篇作为存储子系统系列的收官之作，将重点聚焦于<strong>存储安全</strong>与<strong>性能优化</strong>两大核心主题：</p>
<ul>
<li><strong>FBE（File-Based Encryption）</strong>：Android 7.0引入、在Android 15进一步增强的文件级加密机制</li>
<li><strong>f2fs</strong>：针对Flash存储优化的文件系统，Android 15默认推荐文件系统</li>
<li><strong>存储性能优化</strong>：从诊断到调优的完整实战方法论</li>
</ul>
<p>这三者紧密关联：FBE加密保证了数据安全但会带来性能开销，f2fs通过专门优化减少这一开销，而性能优化则需要理解二者的配合机制。</p>
<h3 data-id="heading-1">本文内容概览</h3>
<ol>
<li>
<p><strong>FBE加密机制深度解析</strong></p>
<ul>
<li>FBE vs FDE对比</li>
<li>CE/DE密钥体系</li>
<li>加密策略与密钥派生</li>
<li>Keymaster HAL与硬件支持</li>
</ul>
</li>
<li>
<p><strong>f2fs文件系统核心特性</strong></p>
<ul>
<li>Flash友好的设计哲学</li>
<li>多头日志与热/冷数据分离</li>
<li>在线碎片整理与GC机制</li>
<li>Android 15中的f2fs增强</li>
</ul>
</li>
<li>
<p><strong>Metadata加密与完整性保护</strong></p>
<ul>
<li>dm-default-key设备映射器</li>
<li>Metadata加密实现</li>
<li>fsverity完整性验证</li>
</ul>
</li>
<li>
<p><strong>存储性能分析与优化</strong></p>
<ul>
<li>I/O性能基准测试</li>
<li>systrace/perfetto存储追踪</li>
<li>常见性能问题诊断</li>
<li>f2fs调优参数详解</li>
</ul>
</li>
<li>
<p><strong>实战：存储问题诊断案例</strong></p>
<ul>
<li>慢速读写问题定位</li>
<li>随机I/O性能调优</li>
<li>空间占用异常排查</li>
</ul>
</li>
</ol>
<p>让我们开始深入探索Android 15存储系统的安全与性能奥秘！</p>
<hr/>
<h2 data-id="heading-2">一、FBE加密机制深度解析</h2>
<h3 data-id="heading-3">1.1 为什么需要FBE？</h3>
<p>在Android 7.0之前，Android使用<strong>FDE（Full Disk Encryption，全盘加密）</strong>：整个<code>/data</code>分区使用单一密钥加密，解锁手机后密钥加载到内存，所有数据可访问。</p>
<p><strong>FDE的问题</strong>：</p>
<ul>
<li>开机后无法接听电话、接收闹钟（因为<code>/data</code>未解密）</li>
<li>必须先输入密码才能启动系统核心功能</li>
<li>OTA升级需要用户手动输入密码</li>
</ul>
<p><strong>FBE的优势</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────┬──────────────────┐
│  FDE (全盘加密)  │   FBE (文件加密)   │
├─────────────────┼──────────────────┤
│ 单一加密密钥      │  多密钥体系        │
│ 必须解锁才能开机  │  Direct Boot支持  │
│ 无法接听来电      │  开机即可接电话    │
│ OTA需要密码      │  OTA可后台进行    │
│ 性能开销大       │  按需加密，开销小  │
└─────────────────┴──────────────────┘
</code></pre>
<h3 data-id="heading-4">1.2 FBE核心概念：CE与DE密钥</h3>
<p>FBE引入了<strong>两级密钥体系</strong>：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be1e20d8edf54d86a1bebadea5639521~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770033994&amp;x-signature=AkYkfPuS6OwNRs9kkuPTdsr9plo%3D" alt="06-01-fbe-encryption-architecture.png" loading="lazy"/></p>
<h4 data-id="heading-5"><strong>DE (Device Encrypted) - 设备加密</strong></h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// system/vold/FsCrypt.cpp - DE密钥路径</span>
<span class="hljs-function"><span class="hljs-type">static</span> std::string <span class="hljs-title">get_de_key_path</span><span class="hljs-params">(<span class="hljs-type">userid_t</span> user_id)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">StringPrintf</span>(<span class="hljs-string">"%s/de/%d"</span>, user_key_dir.<span class="hljs-built_in">c_str</span>(), user_id);
}
</code></pre>
<p><strong>特点</strong>：</p>
<ul>
<li>开机后即可用（系统启动时自动加载）</li>
<li>不依赖用户凭证（PIN/密码/指纹）</li>
<li>用于存储系统核心功能数据</li>
</ul>
<p><strong>典型用途</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># DE加密的目录示例</span>
/data/user_de/0/com.android.providers.telephony  <span class="hljs-comment"># 电话应用</span>
/data/user_de/0/com.android.deskclock           <span class="hljs-comment"># 闹钟应用</span>
/data/user_de/0/com.android.bluetooth           <span class="hljs-comment"># 蓝牙</span>
</code></pre>
<h4 data-id="heading-6"><strong>CE (Credential Encrypted) - 凭证加密</strong></h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// system/vold/FsCrypt.cpp - CE密钥路径</span>
<span class="hljs-function"><span class="hljs-type">static</span> std::string <span class="hljs-title">get_ce_key_directory_path</span><span class="hljs-params">(<span class="hljs-type">userid_t</span> user_id)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">StringPrintf</span>(<span class="hljs-string">"%s/ce/%d"</span>, user_key_dir.<span class="hljs-built_in">c_str</span>(), user_id);
}
</code></pre>
<p><strong>特点</strong>：</p>
<ul>
<li>用户解锁后才可用（从Keymaster派生）</li>
<li>基于用户凭证（PIN/密码/指纹）</li>
<li>用户锁屏后，CE密钥从内存清除</li>
</ul>
<p><strong>典型用途</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># CE加密的目录示例</span>
/data/user/0/com.android.providers.contacts     <span class="hljs-comment"># 联系人</span>
/data/user/0/com.android.providers.media       <span class="hljs-comment"># 相册</span>
/data/user/0/com.whatsapp                      <span class="hljs-comment"># 应用私有数据</span>
</code></pre>
<h3 data-id="heading-7">1.3 FBE密钥派生流程</h3>
<p>让我们从源码角度看密钥是如何生成和管理的：</p>
<h4 data-id="heading-8"><strong>1.3.1 DE密钥创建</strong></h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// system/vold/FsCrypt.cpp</span>
<span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">bool</span> <span class="hljs-title">create_de_key</span><span class="hljs-params">(<span class="hljs-type">userid_t</span> user_id, <span class="hljs-type">bool</span> ephemeral)</span> </span>{
    KeyBuffer de_key;
    std::string de_key_path = <span class="hljs-built_in">get_de_key_path</span>(user_id);

    <span class="hljs-comment">// 1. 生成随机密钥（或从Keymaster派生）</span>
    <span class="hljs-keyword">auto</span> <span class="hljs-type">const</span>&amp; options = <span class="hljs-built_in">BuildDataEncryptionOptions</span>(s_data_options, ephemeral);
    KeyGeneration key_gen = <span class="hljs-built_in">makeGen</span>(options);

    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">generateStorageKey</span>(key_gen, &amp;de_key)) {
        <span class="hljs-built_in">LOG</span>(ERROR) &lt;&lt; <span class="hljs-string">"Failed to generate DE key for user "</span> &lt;&lt; user_id;
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-comment">// 2. 将密钥存储到文件系统</span>
    <span class="hljs-keyword">if</span> (!android::vold::<span class="hljs-built_in">storeKey</span>(de_key_path, user_key_temp, de_key)) {
        <span class="hljs-built_in">LOG</span>(ERROR) &lt;&lt; <span class="hljs-string">"Failed to store DE key"</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-comment">// 3. 在内核中安装加密策略</span>
    EncryptionPolicy de_policy;
    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">installKey</span>(de_key, de_policy)) {
        <span class="hljs-built_in">LOG</span>(ERROR) &lt;&lt; <span class="hljs-string">"Failed to install DE policy"</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    s_de_policies[user_id].internal = de_policy;
    <span class="hljs-built_in">LOG</span>(INFO) &lt;&lt; <span class="hljs-string">"Created DE key for user "</span> &lt;&lt; user_id;
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<p><strong>关键步骤</strong>：</p>
<ol>
<li><strong>生成密钥</strong>：调用<code>generateStorageKey()</code>生成AES-256密钥</li>
<li><strong>持久化存储</strong>：密钥文件存放在<code>/data/misc/vold/user_keys/de/&lt;userid&gt;/</code></li>
<li><strong>内核安装</strong>：通过<code>FS_IOC_ADD_ENCRYPTION_KEY</code> ioctl安装到内核</li>
</ol>
<h4 data-id="heading-9"><strong>1.3.2 CE密钥创建与派生</strong></h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// system/vold/FsCrypt.cpp</span>
<span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">fscrypt_prepare_user_storage</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; volume_uuid,
                                   <span class="hljs-type">userid_t</span> user_id,
                                   <span class="hljs-type">int</span> serial,
                                   <span class="hljs-type">int</span> flags)</span> </span>{
    <span class="hljs-comment">// CE密钥创建</span>
    <span class="hljs-keyword">if</span> (flags &amp; android::os::IVold::STORAGE_FLAG_CE) {
        <span class="hljs-comment">// 1. 从用户凭证派生密钥</span>
        android::vold::KeyAuthentication auth;
        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">getUserKeyAuth</span>(user_id, &amp;auth)) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }

        KeyBuffer ce_key;
        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">retrieveOrGenerateKey</span>(ce_key_path, auth, <span class="hljs-built_in">makeGen</span>(s_data_options),
                                   &amp;ce_key)) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }

        <span class="hljs-comment">// 2. 安装CE加密策略</span>
        EncryptionPolicy ce_policy;
        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">install_storage_key</span>(<span class="hljs-built_in">BuildDataPath</span>(volume_uuid),
                                s_data_options, ce_key, &amp;ce_policy)) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }

        s_ce_policies[user_id].internal = ce_policy;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<p><strong>CE密钥派生链</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">用户密码/PIN
    ↓
<span class="hljs-built_in">scrypt</span>(密码, salt)  ← 密钥派生函数
    ↓
派生密钥 (Derived Key)
    ↓
Keymaster派生 (Hardware-backed)
    ↓
CE加密密钥 (AES-<span class="hljs-number">256</span>)
    ↓
内核fscrypt子系统
</code></pre>
<h3 data-id="heading-10">1.4 Fscrypt内核接口</h3>
<p>Android通过<code>libfscrypt</code>库与内核fscrypt子系统交互：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// system/extras/libfscrypt/fscrypt.cpp</span>

<span class="hljs-comment">// 添加加密密钥到内核</span>
<span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">fscrypt_add_key_to_keyring</span><span class="hljs-params">(<span class="hljs-type">const</span> fscrypt_key&amp; key,
                                <span class="hljs-type">const</span> <span class="hljs-type">char</span>* mountpoint)</span> </span>{
    android::<span class="hljs-function">base::unique_fd <span class="hljs-title">fd</span><span class="hljs-params">(open(mountpoint, O_RDONLY | O_DIRECTORY | O_CLOEXEC))</span></span>;

    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">fscrypt_add_key_arg</span> arg;
    <span class="hljs-built_in">memset</span>(&amp;arg, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(arg));
    arg.key_spec.type = FSCRYPT_KEY_SPEC_TYPE_DESCRIPTOR;
    <span class="hljs-built_in">memcpy</span>(arg.key_spec.u.descriptor, key.fek, FSCRYPT_KEY_DESCRIPTOR_SIZE);
    arg.raw_size = key.fek_size;
    <span class="hljs-built_in">memcpy</span>(arg.raw, key.fek, key.fek_size);

    <span class="hljs-comment">// ioctl系统调用</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">ioctl</span>(fd, FS_IOC_ADD_ENCRYPTION_KEY, &amp;arg) != <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">PLOG</span>(ERROR) &lt;&lt; <span class="hljs-string">"FS_IOC_ADD_ENCRYPTION_KEY failed"</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}

<span class="hljs-comment">// 设置目录加密策略</span>
<span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">fscrypt_policy_set</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* directory,
                       <span class="hljs-type">const</span> fscrypt_policy_v2&amp; policy)</span> </span>{
    android::<span class="hljs-function">base::unique_fd <span class="hljs-title">fd</span><span class="hljs-params">(open(directory, O_RDONLY | O_DIRECTORY | O_CLOEXEC))</span></span>;

    <span class="hljs-comment">// 使用v2策略（Android 11+）</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">ioctl</span>(fd, FS_IOC_SET_ENCRYPTION_POLICY, &amp;policy) != <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">PLOG</span>(ERROR) &lt;&lt; <span class="hljs-string">"FS_IOC_SET_ENCRYPTION_POLICY failed on "</span> &lt;&lt; directory;
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<p><strong>内核ioctl命令</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// Linux kernel include/uapi/linux/fscrypt.h</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> FS_IOC_SET_ENCRYPTION_POLICY   _IOR(<span class="hljs-string">'f'</span>, 19, struct fscrypt_policy_v2)</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> FS_IOC_GET_ENCRYPTION_POLICY   _IOW(<span class="hljs-string">'f'</span>, 21, struct fscrypt_policy_v2)</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> FS_IOC_ADD_ENCRYPTION_KEY      _IOWR(<span class="hljs-string">'f'</span>, 23, struct fscrypt_add_key_arg)</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> FS_IOC_REMOVE_ENCRYPTION_KEY   _IOWR(<span class="hljs-string">'f'</span>, 24, struct fscrypt_remove_key_arg)</span>
</code></pre>
<h3 data-id="heading-11">1.5 Keymaster HAL与硬件支持</h3>
<p>Android 15中，密钥派生依赖<strong>Keymaster HAL</strong>（硬件支持的密钥管理）：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// system/vold/KeyStorage.cpp</span>

<span class="hljs-comment">// 从Keymaster派生加密密钥</span>
<span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">bool</span> <span class="hljs-title">generateKeymasterKey</span><span class="hljs-params">(Keymaster&amp; keymaster, <span class="hljs-type">const</span> KeyAuthentication&amp; auth,
                                <span class="hljs-type">const</span> std::string&amp; appId, KeyBuffer* key)</span> </span>{
    <span class="hljs-comment">// 1. 生成Keymaster密钥</span>
    <span class="hljs-keyword">auto</span> paramBuilder = km::<span class="hljs-built_in">AuthorizationSetBuilder</span>()
                        .<span class="hljs-built_in">AesEncryptionKey</span>(AES_KEY_BYTES * <span class="hljs-number">8</span>)
                        .GcmMode <span class="hljs-built_in">MinMacLength</span>(GCM_MAC_BYTES * <span class="hljs-number">8</span>)
                        .<span class="hljs-built_in">Authorization</span>(km::TAG_APPLICATION_ID, appId)
                        .<span class="hljs-built_in">Authorization</span>(km::TAG_NO_AUTH_REQUIRED);

    <span class="hljs-keyword">if</span> (auth.<span class="hljs-built_in">usesKeymaster</span>()) {
        paramBuilder.<span class="hljs-built_in">Authorization</span>(km::TAG_USER_SECURE_ID, auth.secureUserId);
    }

    km::AuthorizationSet in_params = paramBuilder.<span class="hljs-built_in">build</span>();
    KeyBlob keyBlob;

    <span class="hljs-comment">// 调用Keymaster HAL生成密钥</span>
    <span class="hljs-keyword">auto</span> result = keymaster.<span class="hljs-built_in">generateKey</span>(in_params, &amp;keyBlob);
    <span class="hljs-keyword">if</span> (!result.<span class="hljs-built_in">isOk</span>()) {
        <span class="hljs-built_in">LOG</span>(ERROR) &lt;&lt; <span class="hljs-string">"Keymaster generateKey failed: "</span> &lt;&lt; result.<span class="hljs-built_in">error</span>();
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-comment">// 2. 从Keymaster导出密钥材料</span>
    <span class="hljs-keyword">auto</span> exportResult = keymaster.<span class="hljs-built_in">exportKey</span>(km::KeyFormat::RAW, keyBlob,
                                           km::<span class="hljs-built_in">AuthorizationSet</span>(),
                                           km::<span class="hljs-built_in">AuthorizationSet</span>());

    *key = <span class="hljs-built_in">KeyBuffer</span>(exportResult.blob.<span class="hljs-built_in">data</span>(), exportResult.blob.<span class="hljs-built_in">size</span>());
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<p><strong>硬件支持的好处</strong>：</p>
<ul>
<li>密钥永不离开TEE（Trusted Execution Environment）</li>
<li>抵御物理攻击（密钥提取）</li>
<li>支持生物识别（指纹/人脸）认证</li>
</ul>
<h3 data-id="heading-12">1.6 Android 15中的FBE增强</h3>
<h4 data-id="heading-13"><strong>1.6.1 硬件包裹密钥（Hardware-Wrapped Keys）</strong></h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// system/vold/KeyStorage.cpp - Android 15新特性</span>
<span class="hljs-function"><span class="hljs-type">static</span> KeyGeneration <span class="hljs-title">makeGen</span><span class="hljs-params">(<span class="hljs-type">const</span> EncryptionOptions&amp; options)</span> </span>{
    <span class="hljs-keyword">return</span> KeyGeneration{
        FSCRYPT_MAX_KEY_SIZE,
        <span class="hljs-literal">true</span>,
        options.use_hw_wrapped_key  <span class="hljs-comment">// ← Android 15: 硬件包裹密钥</span>
    };
}
</code></pre>
<p><strong>原理</strong>：</p>
<ul>
<li>密钥由硬件生成，永不以明文形式出现在应用处理器</li>
<li>密钥材料由硬件专用密钥包裹（wrap）</li>
<li>解密操作必须在安全硬件内完成</li>
</ul>
<h4 data-id="heading-14"><strong>1.6.2 密钥升级机制（Key Upgrade）</strong></h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// system/vold/KeyStorage.cpp</span>
<span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">reloadKeyFromSessionKeyring</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; mountpoint, <span class="hljs-type">const</span> EncryptionKey&amp; key)</span> </span>{
    <span class="hljs-comment">// Android 15: 支持在线密钥升级，无需重启</span>
    <span class="hljs-keyword">auto</span> result = keymaster.<span class="hljs-built_in">upgradeKey</span>(key.blob, upgrade_params);
    <span class="hljs-keyword">if</span> (result.<span class="hljs-built_in">isOk</span>()) {
        <span class="hljs-comment">// 热更新内核中的密钥</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">fscrypt_add_key_to_keyring</span>(result.upgradedBlob, mountpoint);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}
</code></pre>
<hr/>
<h2 data-id="heading-15">二、f2fs文件系统核心特性</h2>
<h3 data-id="heading-16">2.1 为什么Android选择f2fs？</h3>
<p>传统ext4文件系统设计初衷是机械硬盘（HDD），而现代移动设备全部使用Flash存储（eMMC/UFS）。f2fs（Flash-Friendly File System）专为Flash优化：</p>
<p><strong>ext4 vs f2fs对比</strong>：</p>
<pre><code class="hljs">┌──────────────┬────────────┬────────────┐
│   特性        │    ext4    │    f2fs    │
├──────────────┼────────────┼────────────┤
│ 设计目标      │ HDD优化    │ Flash优化  │
│ 写入方式      │ 就地更新    │ LFS日志式  │
│ 碎片化       │ 容易碎片化  │ 天然抗碎片  │
│ GC机制       │ 无         │ 后台在线GC │
│ Trim支持     │ 基础支持    │ 深度集成   │
│ 随机写性能    │ 一般       │ 优秀       │
│ Android优化  │ 有限       │ 深度定制   │
└──────────────┴────────────┴────────────┘
</code></pre>
<h3 data-id="heading-17">2.2 f2fs核心设计：日志结构化</h3>
<p>f2fs采用**LFS（Log-Structured File System）**设计：</p>
<pre><code class="hljs language-scss" lang="scss">┌────────────────────────────────────────┐
│          f2fs 磁盘布局                  │
├────────┬──────┬─────────┬─────────────┤
│ Super  │ CP   │  SSA    │   <span class="hljs-selector-tag">Main</span> Area  │
│ block  │ area │  area   │  (Segments)  │
├────────┴──────┴─────────┴─────────────┤
│                                        │
│  <span class="hljs-selector-tag">Main</span> Area详细:                        │
│  ┌──────────────────────────────────┐ │
│  │ HOT NODE  │ WARM NODE │ COLD NODE│ │ ← Node Segments
│  ├───────────┼───────────┼──────────┤ │
│  │ HOT DATA  │ WARM DATA │ COLD DATA│ │ ← Data Segments
│  └──────────────────────────────────┘ │
└────────────────────────────────────────┘
</code></pre>
<p><strong>关键数据结构</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// fs/f2fs/f2fs.h - Segment Info</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_summary</span> {</span>
    __le32 nid;          <span class="hljs-comment">// Node ID</span>
    __u8 version;        <span class="hljs-comment">// Node version</span>
    __le16 ofs_in_node;  <span class="hljs-comment">// Offset in node</span>
} __packed;

<span class="hljs-comment">// Checkpoint区域</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_checkpoint</span> {</span>
    __le64 checkpoint_ver;      <span class="hljs-comment">// CP版本号</span>
    __le64 user_block_count;    <span class="hljs-comment">// 用户数据块数</span>
    __le64 valid_block_count;   <span class="hljs-comment">// 有效块数</span>
    __le32 rsvd_segment_count;  <span class="hljs-comment">// 保留segment数</span>
    __le32 overprov_segment_count;  <span class="hljs-comment">// 过度配置segment数</span>
    __le32 free_segment_count;  <span class="hljs-comment">// 空闲segment数</span>
    <span class="hljs-comment">// ...</span>
} __packed;
</code></pre>
<h3 data-id="heading-18">2.3 热/冷数据分离</h3>
<p>f2fs根据数据更新频率分类：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// fs/f2fs/segment.h</span>
<span class="hljs-keyword">enum</span> {
    CURSEG_HOT_DATA = <span class="hljs-number">0</span>,   <span class="hljs-comment">// 频繁修改的用户数据</span>
    CURSEG_WARM_DATA,      <span class="hljs-comment">// 中等频率数据</span>
    CURSEG_COLD_DATA,      <span class="hljs-comment">// 很少修改的数据</span>
    CURSEG_HOT_NODE,       <span class="hljs-comment">// 目录inode</span>
    CURSEG_WARM_NODE,      <span class="hljs-comment">// 文件inode</span>
    CURSEG_COLD_NODE,      <span class="hljs-comment">// 间接节点</span>
    NR_CURSEG_TYPE,
};
</code></pre>
<p><strong>分类策略</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// fs/f2fs/segment.c</span>
<span class="hljs-type">static</span> <span class="hljs-type">int</span> __get_segment_type(<span class="hljs-keyword">struct</span> page *page, <span class="hljs-keyword">enum</span> page_type p_type) {
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_io_info</span> <span class="hljs-title">fio</span> =</span> {.type = p_type};

    <span class="hljs-keyword">if</span> (p_type == DATA) {
        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> *<span class="hljs-title">inode</span> =</span> page-&gt;mapping-&gt;host;

        <span class="hljs-comment">// 1. 目录数据 → HOT DATA</span>
        <span class="hljs-keyword">if</span> (S_ISDIR(inode-&gt;i_mode))
            <span class="hljs-keyword">return</span> CURSEG_HOT_DATA;

        <span class="hljs-comment">// 2. 多媒体文件 → COLD DATA</span>
        <span class="hljs-keyword">if</span> (is_cold_data(page))
            <span class="hljs-keyword">return</span> CURSEG_COLD_DATA;

        <span class="hljs-comment">// 3. 其他 → WARM DATA</span>
        <span class="hljs-keyword">return</span> CURSEG_WARM_DATA;
    }

    <span class="hljs-comment">// Node数据分类...</span>
    <span class="hljs-keyword">return</span> __get_node_segment_type(page);
}
</code></pre>
<p><strong>好处</strong>：</p>
<ul>
<li>减少GC开销（冷数据很少搬移）</li>
<li>提升写入性能（热数据集中写入）</li>
<li>延长Flash寿命（减少写放大）</li>
</ul>
<h3 data-id="heading-19">2.4 多头日志与并发写入</h3>
<p>f2fs支持<strong>6个活跃segment</strong>同时写入：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// fs/f2fs/segment.c</span>
<span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">allocate_segment_by_default</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi,
                                        <span class="hljs-type">int</span> type, <span class="hljs-type">bool</span> force)</span> {
    <span class="hljs-comment">// 每种类型维护独立的curseg</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">curseg_info</span> *<span class="hljs-title">curseg</span> =</span> CURSEG_I(sbi, type);

    <span class="hljs-keyword">if</span> (force || !has_not_enough_free_secs(sbi, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)) {
        <span class="hljs-comment">// 分配新segment</span>
        get_new_segment(sbi, &amp;curseg-&gt;segno, NEW_SEC, type);
        curseg-&gt;next_blkoff = <span class="hljs-number">0</span>;
    }
}
</code></pre>
<p><strong>并发写入优势</strong>：</p>
<pre><code class="hljs language-less" lang="less">传统单日志:
  <span class="hljs-selector-tag">HOT</span> → <span class="hljs-selector-tag">WARM</span> → <span class="hljs-selector-tag">COLD</span> → <span class="hljs-selector-tag">HOT</span> → <span class="hljs-selector-tag">WARM</span> → ... (串行写入)

<span class="hljs-selector-tag">f2fs</span>多头日志:
  <span class="hljs-selector-tag">HOT</span>   ──→ <span class="hljs-selector-tag">Segment</span> <span class="hljs-selector-tag">A</span>
  <span class="hljs-selector-tag">WARM</span>  ──→ <span class="hljs-selector-tag">Segment</span> <span class="hljs-selector-tag">B</span>  } 并行写入
  <span class="hljs-selector-tag">COLD</span>  ──→ <span class="hljs-selector-tag">Segment</span> <span class="hljs-selector-tag">C</span>
</code></pre>
<h3 data-id="heading-20">2.5 在线碎片整理与GC</h3>
<h4 data-id="heading-21"><strong>2.5.1 Segment清理机制</strong></h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// fs/f2fs/gc.c</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">f2fs_gc</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi, <span class="hljs-keyword">struct</span> f2fs_gc_control *gc_control)</span> {
    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> segno;
    <span class="hljs-type">int</span> gc_type = gc_control-&gt;init_gc_type;

    <span class="hljs-comment">// 1. 选择victim segment（最少有效块的segment）</span>
    <span class="hljs-keyword">if</span> (!get_victim_by_default(sbi, &amp;segno, gc_type, NO_CHECK_TYPE, LFS)) {
        <span class="hljs-keyword">return</span> -ENODATA;
    }

    <span class="hljs-comment">// 2. 遍历victim segment中的有效块</span>
    <span class="hljs-keyword">for</span> (off = <span class="hljs-number">0</span>; off &lt; sbi-&gt;blocks_per_seg; off++) {
        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_summary</span> <span class="hljs-title">sum</span>;</span>

        <span class="hljs-keyword">if</span> (!is_valid_data_blkaddr(sbi, blkaddr))
            <span class="hljs-keyword">continue</span>;

        <span class="hljs-comment">// 3. 读取有效数据</span>
        page = f2fs_get_read_data_page(inode, bidx, REQ_RAHEAD, &amp;gc_type);

        <span class="hljs-comment">// 4. 重新写入到新的segment</span>
        f2fs_submit_page_write(&amp;fio);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p><strong>GC触发条件</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// fs/f2fs/gc.c</span>
<span class="hljs-type">static</span> <span class="hljs-type">bool</span> <span class="hljs-title function_">should_do_gc</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi)</span> {
    <span class="hljs-comment">// 1. 空闲空间不足</span>
    <span class="hljs-keyword">if</span> (free_sections(sbi) &lt;= sbi-&gt;reserved_sections)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;

    <span class="hljs-comment">// 2. 用户主动触发（fstrim）</span>
    <span class="hljs-keyword">if</span> (gc_urgent_mode(sbi))
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;

    <span class="hljs-comment">// 3. 脏segment过多</span>
    <span class="hljs-keyword">if</span> (dirty_segments(sbi) &gt; sbi-&gt;blocks_per_seg * <span class="hljs-number">2</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;

    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}
</code></pre>
<h4 data-id="heading-22"><strong>2.5.2 Android中的GC优化</strong></h4>
<p>Android通过sysfs接口控制GC行为：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看GC统计信息</span>
<span class="hljs-built_in">cat</span> /sys/kernel/debug/f2fs/status

<span class="hljs-comment"># 设置GC urgent模式（适合低电量/后台场景）</span>
<span class="hljs-built_in">echo</span> 1 &gt; /sys/fs/f2fs/&lt;device&gt;/gc_urgent

<span class="hljs-comment"># 手动触发GC</span>
<span class="hljs-built_in">echo</span> 1 &gt; /sys/fs/f2fs/&lt;device&gt;/gc_urgent_sleep_time
</code></pre>
<h3 data-id="heading-23">2.6 Android 15中的f2fs增强</h3>
<h4 data-id="heading-24"><strong>2.6.1 压缩支持（Compression）</strong></h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// fs/f2fs/compress.c - Android 15新增</span>
<span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">f2fs_compress_pages</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> compress_ctx *cc)</span> {
    <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_compress_ops</span> *<span class="hljs-title">cops</span> =</span>
        f2fs_cops[F2FS_I_SB(cc-&gt;inode)-&gt;s_compress_algorithm];

    <span class="hljs-comment">// 支持LZ4/LZO/ZSTD压缩算法</span>
    ret = cops-&gt;compress_pages(cc);

    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// 压缩失败，使用原始数据</span>
        <span class="hljs-keyword">return</span> -EAGAIN;
    }

    <span class="hljs-comment">// 压缩率不足，不值得压缩</span>
    <span class="hljs-keyword">if</span> (cc-&gt;clen &gt;= cc-&gt;rlen - COMPRESS_HEADER_SIZE)
        <span class="hljs-keyword">return</span> -EAGAIN;

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p><strong>启用f2fs压缩</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 挂载选项</span>
mount -t f2fs -o compress_algorithm=lz4,compress_extension=* /dev/block/dm-0 /data

<span class="hljs-comment"># 或修改fstab</span>
/dev/block/dm-0 /data f2fs noatime,nosuid,nodev,compress_algorithm=lz4
</code></pre>
<p><strong>压缩效果</strong>：</p>
<ul>
<li>典型压缩率：30-50%</li>
<li>APK/DEX文件效果最佳</li>
<li>对性能影响小于5%</li>
</ul>
<h4 data-id="heading-25"><strong>2.6.2 Age Extent Cache</strong></h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// fs/f2fs/extent_cache.c</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">extent_tree</span> {</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rb_root_cached</span> <span class="hljs-title">root</span>;</span>     <span class="hljs-comment">// 红黑树根</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">node_list</span>;</span>     <span class="hljs-comment">// extent节点链表</span>
    <span class="hljs-type">rwlock_t</span> lock;
    <span class="hljs-type">atomic_t</span> node_cnt;              <span class="hljs-comment">// extent节点数</span>
    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> largest_updated;   <span class="hljs-comment">// 最大extent更新时间</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">extent_info</span> <span class="hljs-title">largest</span>;</span>     <span class="hljs-comment">// 缓存最大extent</span>
};
</code></pre>
<p><strong>优势</strong>：</p>
<ul>
<li>减少磁盘访问（extent信息缓存在内存）</li>
<li>加速随机读取</li>
<li>Android 15默认启用</li>
</ul>
<hr/>
<h2 data-id="heading-26">三、Metadata加密与完整性保护</h2>
<h3 data-id="heading-27">3.1 dm-default-key设备映射器</h3>
<p>Android 9引入<strong>metadata加密</strong>，在FBE之上增加额外保护层：</p>
<pre><code class="hljs language-scss" lang="scss">┌──────────────────────────────────────┐
│         应用数据 (FBE加密)            │
├──────────────────────────────────────┤
│    文件系统Metadata (dm-default-key) │
├──────────────────────────────────────┤
│         块设备层                      │
└──────────────────────────────────────┘
</code></pre>
<p><strong>实现原理</strong>：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// system/vold/MetadataCrypt.cpp</span>
<span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">bool</span> <span class="hljs-title">mount_via_fs_mgr</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* mount_point, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* blk_device)</span> </span>{
    <span class="hljs-comment">// 1. 创建dm-default-key设备</span>
    android::dm::DeviceMapper&amp; dm = android::dm::DeviceMapper::<span class="hljs-built_in">Instance</span>();

    std::string dm_name = <span class="hljs-string">"default-key"</span>;
    DmTable table;

    <span class="hljs-comment">// 2. 配置dm目标参数</span>
    std::string target_params = <span class="hljs-built_in">StringPrintf</span>(
        <span class="hljs-string">"%s 0 1 allow_discards sector_size:4096 "</span>
        <span class="hljs-string">"iv_large_sectors default_key=1"</span>, blk_device);

    table.<span class="hljs-built_in">Emplace</span>&lt;DmTargetDefaultKey&gt;(<span class="hljs-number">0</span>, fs_stat.st_size / <span class="hljs-number">512</span>, target_params);

    <span class="hljs-comment">// 3. 激活dm设备</span>
    <span class="hljs-keyword">if</span> (!dm.<span class="hljs-built_in">CreateDevice</span>(dm_name, table, &amp;dm_path, <span class="hljs-number">5</span>s)) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-comment">// 4. 在dm设备上挂载文件系统</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">mount</span>(dm_path.<span class="hljs-built_in">c_str</span>(), mount_point, <span class="hljs-string">"f2fs"</span>,
                MS_NOATIME | MS_NOSUID | MS_NODEV, <span class="hljs-literal">nullptr</span>) == <span class="hljs-number">0</span>;
}
</code></pre>
<p><strong>密钥管理</strong>：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// system/vold/MetadataCrypt.cpp</span>
<span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">bool</span> <span class="hljs-title">read_key</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; metadata_key_dir,
                    <span class="hljs-type">const</span> KeyGeneration&amp; gen, KeyBuffer* key)</span> </span>{
    <span class="hljs-comment">// Metadata密钥存放在/metadata分区</span>
    std::string key_path = metadata_key_dir + <span class="hljs-string">"/key"</span>;

    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">pathExists</span>(key_path)) {
        <span class="hljs-comment">// 读取现有密钥</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">retrieveKey</span>(key_path, kEmptyAuthentication, key);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 首次启动，生成新密钥</span>
        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">generateStorageKey</span>(gen, key)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">storeKey</span>(key_path, user_key_temp, *key);
    }
}
</code></pre>
<h3 data-id="heading-28">3.2 fsverity完整性验证</h3>
<p>Android 11引入<strong>fsverity</strong>，防止文件被篡改：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 为APK文件启用fsverity</span>
fsverity <span class="hljs-built_in">enable</span> /data/app/com.example.app/base.apk

<span class="hljs-comment"># 查看fsverity状态</span>
fsverity measure /data/app/com.example.app/base.apk
</code></pre>
<p><strong>内核实现</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// fs/verity/verify.c</span>
<span class="hljs-type">bool</span> <span class="hljs-title function_">fsverity_verify_page</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> page *page)</span> {
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> *<span class="hljs-title">inode</span> =</span> page-&gt;mapping-&gt;host;
    <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fsverity_info</span> *<span class="hljs-title">vi</span> =</span> inode-&gt;i_verity_info;

    <span class="hljs-comment">// 1. 计算页面的Merkle树哈希</span>
    u8 real_hash[FS_VERITY_MAX_DIGEST_SIZE];
    hash_at_level(vi, page, <span class="hljs-number">0</span>, real_hash);

    <span class="hljs-comment">// 2. 从Merkle树中读取期望哈希</span>
    u8 expected_hash[FS_VERITY_MAX_DIGEST_SIZE];
    get_hash_from_tree(vi, page-&gt;index, expected_hash);

    <span class="hljs-comment">// 3. 比较哈希值</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">memcmp</span>(real_hash, expected_hash, vi-&gt;tree_params.digest_size) != <span class="hljs-number">0</span>) {
        pr_warn(<span class="hljs-string">"fsverity: page %lu of file %s has mismatched hash\n"</span>,
                page-&gt;index, inode-&gt;i_name);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<p><strong>Merkle树结构</strong>：</p>
<pre><code class="hljs language-java" lang="java">              Root <span class="hljs-title function_">Hash</span> <span class="hljs-params">(存储在inode)</span>
                    │
        ┌───────────┴───────────┐
     Hash <span class="hljs-number">0</span>-<span class="hljs-number">3</span>              Hash <span class="hljs-number">4</span>-<span class="hljs-number">7</span>
        │                     │
   ┌────┴────┐           ┌────┴────┐
Hash <span class="hljs-number">0</span>  Hash <span class="hljs-number">1</span>        Hash <span class="hljs-number">4</span>  Hash <span class="hljs-number">5</span>
   │       │             │       │
Page <span class="hljs-number">0</span>  Page <span class="hljs-number">1</span>       Page <span class="hljs-number">4</span>  Page <span class="hljs-number">5</span>
</code></pre>
<hr/>
<h2 data-id="heading-29">四、存储性能分析与优化</h2>
<h3 data-id="heading-30">4.1 I/O性能基准测试</h3>
<h4 data-id="heading-31"><strong>4.1.1 使用dd测试顺序读写</strong></h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 测试顺序写入性能</span>
<span class="hljs-built_in">dd</span> <span class="hljs-keyword">if</span>=/dev/zero of=/data/local/tmp/testfile bs=1M count=1024 oflag=direct

<span class="hljs-comment"># 输出示例：</span>
<span class="hljs-comment"># 1024+0 records in</span>
<span class="hljs-comment"># 1024+0 records out</span>
<span class="hljs-comment"># 1073741824 bytes (1.0GB) copied, 4.235s, 254MB/s</span>

<span class="hljs-comment"># 测试顺序读取性能</span>
<span class="hljs-built_in">dd</span> <span class="hljs-keyword">if</span>=/data/local/tmp/testfile of=/dev/null bs=1M iflag=direct

<span class="hljs-comment"># 清理缓存后再测试（更准确）</span>
<span class="hljs-built_in">echo</span> 3 &gt; /proc/sys/vm/drop_caches
<span class="hljs-built_in">dd</span> <span class="hljs-keyword">if</span>=/data/local/tmp/testfile of=/dev/null bs=1M iflag=direct
</code></pre>
<h4 data-id="heading-32"><strong>4.1.2 使用fio测试随机I/O</strong></h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Android系统需要先推送fio二进制</span>
adb push fio /data/local/tmp/
adb shell <span class="hljs-built_in">chmod</span> +x /data/local/tmp/fio

<span class="hljs-comment"># 4K随机读测试</span>
adb shell /data/local/tmp/fio \
  --name=randread \
  --ioengine=libaio \
  --iodepth=32 \
  --rw=randread \
  --bs=4k \
  --direct=1 \
  --size=1G \
  --numjobs=4 \
  --runtime=60 \
  --group_reporting

<span class="hljs-comment"># 输出关键指标：</span>
<span class="hljs-comment"># IOPS（每秒I/O操作数）</span>
<span class="hljs-comment"># BW（带宽）</span>
<span class="hljs-comment"># lat（延迟）</span>
</code></pre>
<h3 data-id="heading-33">4.2 存储性能诊断流程</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74a7dc9c1d4c421d8badf647289f99a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770033994&amp;x-signature=yDC8VO6v5rCt%2FWR8XpClq2303cw%3D" alt="06-02-storage-performance-analysis-flowchart.png" loading="lazy"/></p>
<h4 data-id="heading-34"><strong>4.2.1 使用systrace追踪I/O</strong></h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 捕获存储相关trace</span>
python systrace.py -o trace.html \
  -t 10 \
  disk \
  block \
  f2fs \
  ext4 \
  <span class="hljs-built_in">sched</span> \
  freq

<span class="hljs-comment"># 分析trace文件：</span>
<span class="hljs-comment"># 1. 查找"f2fs_write_begin"/"f2fs_write_end"事件</span>
<span class="hljs-comment"># 2. 分析I/O等待时间</span>
<span class="hljs-comment"># 3. 检查是否有大量sync操作</span>
</code></pre>
<h4 data-id="heading-35"><strong>4.2.2 使用perfetto深度分析</strong></h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 配置perfetto trace</span>
<span class="hljs-built_in">cat</span> &gt; /data/local/tmp/trace_config.pbtxt &lt;&lt; <span class="hljs-string">EOF
buffers: {
    size_kb: 102400
    fill_policy: RING_BUFFER
}

data_sources: {
    config {
        name: "linux.ftrace"
        ftrace_config {
            ftrace_events: "f2fs/f2fs_write_begin"
            ftrace_events: "f2fs/f2fs_sync_file_enter"
            ftrace_events: "block/block_rq_issue"
            ftrace_events: "block/block_rq_complete"
        }
    }
}

duration_ms: 10000
EOF</span>

<span class="hljs-comment"># 捕获trace</span>
perfetto -c /data/local/tmp/trace_config.pbtxt -o /data/local/tmp/trace.perfetto
</code></pre>
<h4 data-id="heading-36"><strong>4.2.3 f2fs状态监控</strong></h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看f2fs实时状态</span>
<span class="hljs-built_in">cat</span> /sys/kernel/debug/f2fs/status

<span class="hljs-comment"># 输出示例（关键字段解读）：</span>
<span class="hljs-comment"># =============  DATA SECTION  =============</span>
<span class="hljs-comment"># Total sections: 3072</span>
<span class="hljs-comment"># Free sections: 256           ← 空闲section数（越大越好）</span>
<span class="hljs-comment"># Dirty segments: 45          ← 待GC的segment（过高需优化）</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># =============  DIRTY SEGMENTS  ===========</span>
<span class="hljs-comment"># Dirty type: HOT DATA  ( 12) ← 各类型脏数据统计</span>
<span class="hljs-comment"># Dirty type: WARM DATA ( 18)</span>
<span class="hljs-comment"># Dirty type: COLD DATA ( 15)</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># =============  GC STATISTICS  ============</span>
<span class="hljs-comment"># GC calls: 1234              ← GC触发次数</span>
<span class="hljs-comment"># GC reclaimed blocks: 56789  ← 回收的块数</span>
</code></pre>
<h3 data-id="heading-37">4.3 常见性能问题与解决方案</h3>
<h4 data-id="heading-38"><strong>问题1：写入性能突然下降</strong></h4>
<p><strong>诊断</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 检查空闲空间</span>
<span class="hljs-built_in">df</span> -h /data
<span class="hljs-comment"># 输出：Filesystem      Size  Used Avail Use%</span>
<span class="hljs-comment">#       /dev/dm-0       64G   62G   2G  97%  ← 空间不足！</span>

<span class="hljs-comment"># 2. 检查GC压力</span>
<span class="hljs-built_in">cat</span> /sys/kernel/debug/f2fs/status | grep <span class="hljs-string">"Dirty segments"</span>
<span class="hljs-comment"># Dirty segments: 512  ← 过高，需要GC</span>

<span class="hljs-comment"># 3. 查看是否有大量sync操作</span>
systrace.py -t 5 disk | grep <span class="hljs-string">"f2fs_sync_fs"</span>
</code></pre>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 方案A：手动触发fstrim（清理无效块）</span>
fstrim -v /data
<span class="hljs-comment"># 输出：/data: 8.5 GiB (9123456789 bytes) trimmed</span>

<span class="hljs-comment"># 方案B：启用GC urgent模式</span>
<span class="hljs-built_in">echo</span> 1 &gt; /sys/fs/f2fs/dm-0/gc_urgent
<span class="hljs-comment"># 等待GC完成后</span>
<span class="hljs-built_in">echo</span> 0 &gt; /sys/fs/f2fs/dm-0/gc_urgent

<span class="hljs-comment"># 方案C：清理缓存数据（释放空间）</span>
pm trim-caches 10G  <span class="hljs-comment"># 清理10GB缓存</span>
</code></pre>
<h4 data-id="heading-39"><strong>问题2：随机I/O性能差</strong></h4>
<p><strong>诊断</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用iobench测试4K随机读</span>
iobench --<span class="hljs-built_in">type</span>=randread --size=1G --bs=4096 --iodepth=32

<span class="hljs-comment"># 输出：</span>
<span class="hljs-comment"># IOPS: 1200  ← 正常值应&gt;5000（UFS 2.1）</span>
</code></pre>
<p><strong>优化方案</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 启用readahead</span>
<span class="hljs-built_in">echo</span> 256 &gt; /sys/block/sda/queue/read_ahead_kb

<span class="hljs-comment"># 2. 调整f2fs inline_xattr（减少元数据碎片）</span>
mount -o remount,inline_xattr /data

<span class="hljs-comment"># 3. 启用f2fs的age_extent_cache（Android 15新特性）</span>
<span class="hljs-comment"># 需要在fstab中配置：</span>
/dev/block/dm-0 /data f2fs noatime,age_extent_cache
</code></pre>
<h4 data-id="heading-40"><strong>问题3：空间占用异常</strong></h4>
<p><strong>诊断</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 分析目录大小</span>
<span class="hljs-built_in">du</span> -sh /data/* | <span class="hljs-built_in">sort</span> -h | <span class="hljs-built_in">tail</span> -10

<span class="hljs-comment"># 2. 查找大文件</span>
find /data -<span class="hljs-built_in">type</span> f -size +100M -<span class="hljs-built_in">exec</span> <span class="hljs-built_in">ls</span> -lh {} \;

<span class="hljs-comment"># 3. 检查f2fs的over-provisioning</span>
<span class="hljs-built_in">cat</span> /sys/kernel/debug/f2fs/status | grep <span class="hljs-string">"overprov"</span>
<span class="hljs-comment"># Overprovision segments: 512  ← OP空间（5-10%正常）</span>
</code></pre>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 方案A：启用f2fs压缩（需要Android 12+）</span>
<span class="hljs-comment"># 在fstab中添加compress选项</span>
/dev/block/dm-0 /data f2fs compress_algorithm=lz4,compress_extension=apk:dex:jar

<span class="hljs-comment"># 方案B：调整reserved_blocks（预留块）</span>
<span class="hljs-built_in">echo</span> 100 &gt; /sys/fs/f2fs/dm-0/reserved_blocks

<span class="hljs-comment"># 方案C：清理tombstone和日志</span>
<span class="hljs-built_in">rm</span> -rf /data/tombstones/*
logcat -c
</code></pre>
<h3 data-id="heading-41">4.4 f2fs关键调优参数</h3>
<h4 data-id="heading-42"><strong>4.4.1 GC相关参数</strong></h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># gc_urgent: 紧急GC模式</span>
<span class="hljs-comment"># 0 = 关闭, 1 = 开启</span>
<span class="hljs-built_in">echo</span> 1 &gt; /sys/fs/f2fs/&lt;device&gt;/gc_urgent

<span class="hljs-comment"># gc_urgent_sleep_time: GC休眠时间（毫秒）</span>
<span class="hljs-comment"># 建议值：100-500ms（平衡性能与功耗）</span>
<span class="hljs-built_in">echo</span> 500 &gt; /sys/fs/f2fs/&lt;device&gt;/gc_urgent_sleep_time

<span class="hljs-comment"># min_fsync_blocks: 触发fsync前的最小块数</span>
<span class="hljs-comment"># 较大值可减少sync次数，但增加数据丢失风险</span>
<span class="hljs-built_in">echo</span> 8 &gt; /sys/fs/f2fs/&lt;device&gt;/min_fsync_blocks
</code></pre>
<h4 data-id="heading-43"><strong>4.4.2 挂载选项优化</strong></h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># fstab配置示例（/vendor/etc/fstab.device）</span>
/dev/block/dm-0 /data f2fs noatime,nosuid,nodev,discard,reserve_root=32768,resgid=1065,fsync_mode=nobarrier,inlinecrypt,compress_algorithm=lz4

<span class="hljs-comment"># 关键选项解读：</span>
<span class="hljs-comment"># - noatime: 禁用访问时间更新（减少写入）</span>
<span class="hljs-comment"># - discard: 启用TRIM（及时释放无效块）</span>
<span class="hljs-comment"># - reserve_root=32768: 预留32MB给root用户</span>
<span class="hljs-comment"># - fsync_mode=nobarrier: 减少fsync屏障（性能优先）</span>
<span class="hljs-comment"># - inlinecrypt: 使用硬件加密（减少CPU开销）</span>
<span class="hljs-comment"># - compress_algorithm=lz4: 启用LZ4压缩</span>
</code></pre>
<h4 data-id="heading-44"><strong>4.4.3 Android特有优化</strong></h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// system/vold/fs/F2fs.cpp - Android默认挂载选项</span>
<span class="hljs-function"><span class="hljs-type">status_t</span> <span class="hljs-title">Mount</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; source, <span class="hljs-type">const</span> std::string&amp; target)</span> </span>{
    std::vector&lt;std::string&gt; args;
    args.<span class="hljs-built_in">push_back</span>(<span class="hljs-string">"-o"</span>);

    <span class="hljs-comment">// Android 15优化选项</span>
    std::string options = <span class="hljs-string">"noatime,nosuid,nodev,discard"</span>;
    options += <span class="hljs-string">",reserve_root=32768,resgid=1065"</span>;
    options += <span class="hljs-string">",inlinecrypt"</span>;  <span class="hljs-comment">// 硬件加速加密</span>
    options += <span class="hljs-string">",fsync_mode=nobarrier"</span>;  <span class="hljs-comment">// 减少sync屏障</span>

    <span class="hljs-comment">// 如果支持压缩</span>
    <span class="hljs-keyword">if</span> (android::base::<span class="hljs-built_in">GetBoolProperty</span>(<span class="hljs-string">"ro.storage.compress"</span>, <span class="hljs-literal">false</span>)) {
        options += <span class="hljs-string">",compress_algorithm=lz4"</span>;
        options += <span class="hljs-string">",compress_extension=apk:jar:dex:so"</span>;
    }

    args.<span class="hljs-built_in">push_back</span>(options);
    args.<span class="hljs-built_in">push_back</span>(source);
    args.<span class="hljs-built_in">push_back</span>(target);

    <span class="hljs-keyword">return</span> <span class="hljs-built_in">ForkExecvp</span>(<span class="hljs-string">"/system/bin/mount.f2fs"</span>, args);
}
</code></pre>
<hr/>
<h2 data-id="heading-45">五、实战：存储问题诊断案例</h2>
<h3 data-id="heading-46">案例1：应用启动慢，怀疑存储性能问题</h3>
<p><strong>现象</strong>：</p>
<ul>
<li>应用冷启动时间从1秒增加到3秒</li>
<li>systrace显示大量时间在I/O等待</li>
</ul>
<p><strong>诊断步骤</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 捕获应用启动trace</span>
adb shell am start -W -n com.example.app/.MainActivity

<span class="hljs-comment"># 输出：</span>
<span class="hljs-comment"># TotalTime: 3248  ← 总启动时间3.2秒</span>

<span class="hljs-comment"># 2. 使用systrace分析</span>
python systrace.py -o app_start.html -t 5 -a com.example.app <span class="hljs-built_in">sched</span> freq disk

<span class="hljs-comment"># 3. 在trace中发现大量f2fs_sync_file调用</span>
<span class="hljs-comment"># 定位代码：应用在启动时同步写入SharedPreferences</span>
</code></pre>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 问题代码：</span>
SharedPreferences.<span class="hljs-type">Editor</span> <span class="hljs-variable">editor</span> <span class="hljs-operator">=</span> prefs.edit();
editor.putString(<span class="hljs-string">"key"</span>, <span class="hljs-string">"value"</span>);
editor.commit();  <span class="hljs-comment">// ← 同步写入，阻塞主线程</span>

<span class="hljs-comment">// 优化后：</span>
SharedPreferences.<span class="hljs-type">Editor</span> <span class="hljs-variable">editor</span> <span class="hljs-operator">=</span> prefs.edit();
editor.putString(<span class="hljs-string">"key"</span>, <span class="hljs-string">"value"</span>);
editor.apply();  <span class="hljs-comment">// ← 异步写入，不阻塞</span>
</code></pre>
<p><strong>效果验证</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">adb shell am start -W -n com.example.app/.MainActivity
<span class="hljs-comment"># TotalTime: 1156  ← 优化后降至1.1秒</span>
</code></pre>
<h3 data-id="heading-47">案例2：设备使用一段时间后变慢</h3>
<p><strong>现象</strong>：</p>
<ul>
<li>新设备流畅，使用3个月后明显卡顿</li>
<li>存储剩余空间小于10%</li>
</ul>
<p><strong>诊断</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 检查f2fs状态</span>
adb shell <span class="hljs-built_in">cat</span> /sys/kernel/debug/f2fs/status

<span class="hljs-comment"># 输出异常：</span>
<span class="hljs-comment"># Free sections: 45        ← 空闲section过少</span>
<span class="hljs-comment"># Dirty segments: 789      ← 大量脏segment待GC</span>
<span class="hljs-comment"># Valid blocks: 95%        ← 有效块占比过高，GC效率低</span>

<span class="hljs-comment"># 2. 检查碎片化程度</span>
adb shell /data/local/tmp/f2fs_io fsstat /data

<span class="hljs-comment"># 输出：</span>
<span class="hljs-comment"># - Main: 98.5% usage</span>
<span class="hljs-comment"># - Fragmentation: High  ← 严重碎片化</span>
</code></pre>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 步骤1：触发aggressive GC</span>
adb shell <span class="hljs-string">"echo 1 &gt; /sys/fs/f2fs/dm-0/gc_urgent"</span>
adb shell <span class="hljs-string">"echo 100 &gt; /sys/fs/f2fs/dm-0/gc_urgent_sleep_time"</span>

<span class="hljs-comment"># 等待5分钟让GC运行</span>
<span class="hljs-built_in">sleep</span> 300

<span class="hljs-comment"># 步骤2：fstrim释放无效块</span>
adb shell fstrim -v /data
<span class="hljs-comment"># 输出：/data: 12.3 GiB trimmed</span>

<span class="hljs-comment"># 步骤3：清理应用缓存（释放空间）</span>
adb shell pm trim-caches 10G

<span class="hljs-comment"># 步骤4：关闭gc_urgent</span>
adb shell <span class="hljs-string">"echo 0 &gt; /sys/fs/f2fs/dm-0/gc_urgent"</span>

<span class="hljs-comment"># 验证效果</span>
adb shell <span class="hljs-built_in">cat</span> /sys/kernel/debug/f2fs/status
<span class="hljs-comment"># Free sections: 256       ← 空闲section恢复</span>
<span class="hljs-comment"># Dirty segments: 52       ← 脏segment大幅减少</span>
</code></pre>
<p><strong>预防措施</strong>（系统配置）：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 配置自动fstrim（通过init.rc）</span>
service fstrim_periodic /system/bin/fstrim /data
    class late_start
    oneshot
    seclabel u:r:fstrim:s0

<span class="hljs-comment"># 或使用JobScheduler定时触发</span>
</code></pre>
<h3 data-id="heading-48">案例3：加密导致性能下降</h3>
<p><strong>现象</strong>：</p>
<ul>
<li>读写性能比预期慢30%</li>
<li>使用了FBE加密</li>
</ul>
<p><strong>诊断</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 确认是否使用硬件加密</span>
adb shell getprop ro.crypto.fde_algorithm
<span class="hljs-comment"># 输出：aes-256-xts  ← 如果是软件加密，需要优化</span>

<span class="hljs-comment"># 2. 检查Keymaster HAL版本</span>
adb shell dumpsys keystore | grep <span class="hljs-string">"Hardware"</span>
<span class="hljs-comment"># 输出：Hardware-backed keystore: true  ← 硬件支持</span>

<span class="hljs-comment"># 3. 测试加密性能</span>
<span class="hljs-comment"># 关闭FBE后测试（需要factory reset，仅用于对比）</span>
<span class="hljs-built_in">dd</span> <span class="hljs-keyword">if</span>=/dev/zero of=/data/local/tmp/test bs=1M count=1024 oflag=direct
<span class="hljs-comment"># 有FBE: 180 MB/s</span>
<span class="hljs-comment"># 无FBE: 250 MB/s ← 差距30%</span>
</code></pre>
<p><strong>优化方案</strong>：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 1. 确保使用硬件加速加密（fstab配置）</span>
/dev/block/dm<span class="hljs-number">-0</span> /data f2fs noatime,inlinecrypt  <span class="hljs-comment">// ← 添加inlinecrypt</span>

<span class="hljs-comment">// 2. 在Kernel配置中启用Inline Crypto Engine（ICE）</span>
CONFIG_CRYPTO_DEV_QCOM_ICE=y  <span class="hljs-comment">// Qualcomm平台</span>
CONFIG_SCSI_UFS_CRYPTO=y      <span class="hljs-comment">// UFS硬件加密</span>

<span class="hljs-comment">// 3. 检查是否使用hardware-wrapped keys（Android 15）</span>
<span class="hljs-comment">// 在KeyStorage中启用：</span>
KeyGeneration gen = {
    .keysize = <span class="hljs-number">32</span>,
    .allow_gen = <span class="hljs-literal">true</span>,
    .use_hw_wrapped_key = <span class="hljs-literal">true</span>  <span class="hljs-comment">// ← 启用硬件包裹密钥</span>
};
</code></pre>
<p><strong>验证</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 重新测试性能</span>
<span class="hljs-built_in">dd</span> <span class="hljs-keyword">if</span>=/dev/zero of=/data/local/tmp/test bs=1M count=1024 oflag=direct
<span class="hljs-comment"># 优化后: 238 MB/s  ← 性能恢复到接近无加密水平</span>
</code></pre>
<hr/>
<h2 data-id="heading-49">六、开发者最佳实践</h2>
<h3 data-id="heading-50">6.1 应用层存储优化建议</h3>
<h4 data-id="heading-51"><strong>6.1.1 减少不必要的fsync</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 错误：频繁sync</span>
<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {
    <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(file, <span class="hljs-literal">true</span>);
    fos.write(data);
    fos.getFD().sync();  <span class="hljs-comment">// 每次写入都sync，性能极差</span>
    fos.close();
}

<span class="hljs-comment">// ✅ 正确：批量写入后sync一次</span>
<span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(file);
<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {
    fos.write(data);
}
fos.getFD().sync();  <span class="hljs-comment">// 只sync一次</span>
fos.close();
</code></pre>
<h4 data-id="heading-52"><strong>6.1.2 合理使用SharedPreferences</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 错误：commit()阻塞主线程</span>
SharedPreferences.<span class="hljs-type">Editor</span> <span class="hljs-variable">editor</span> <span class="hljs-operator">=</span> prefs.edit();
editor.putString(<span class="hljs-string">"key"</span>, value);
editor.commit();  <span class="hljs-comment">// 同步I/O</span>

<span class="hljs-comment">// ✅ 正确：使用apply()异步写入</span>
editor.apply();  <span class="hljs-comment">// 异步I/O，不阻塞</span>

<span class="hljs-comment">// ✅ 批量操作</span>
SharedPreferences.<span class="hljs-type">Editor</span> <span class="hljs-variable">editor</span> <span class="hljs-operator">=</span> prefs.edit();
editor.putString(<span class="hljs-string">"key1"</span>, value1);
editor.putString(<span class="hljs-string">"key2"</span>, value2);
editor.apply();  <span class="hljs-comment">// 一次性写入多个key</span>
</code></pre>
<h4 data-id="heading-53"><strong>6.1.3 大文件写入优化</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ✅ 使用BufferedOutputStream减少系统调用</span>
<span class="hljs-keyword">try</span> (<span class="hljs-type">BufferedOutputStream</span> <span class="hljs-variable">bos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedOutputStream</span>(
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(file), <span class="hljs-number">8192</span>)) {  <span class="hljs-comment">// 8KB缓冲区</span>
    bos.write(largeData);
}

<span class="hljs-comment">// ✅ 使用FileChannel和MappedByteBuffer（更快）</span>
<span class="hljs-keyword">try</span> (<span class="hljs-type">FileChannel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> FileChannel.open(file.toPath(),
        StandardOpenOption.WRITE, StandardOpenOption.CREATE)) {
    <span class="hljs-type">MappedByteBuffer</span> <span class="hljs-variable">buffer</span> <span class="hljs-operator">=</span> channel.map(FileChannel.MapMode.READ_WRITE,
                                          <span class="hljs-number">0</span>, largeData.length);
    buffer.put(largeData);
}
</code></pre>
<h3 data-id="heading-54">6.2 Framework层优化</h3>
<h4 data-id="heading-55"><strong>6.2.1 调整Linux I/O调度器</strong></h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看当前I/O调度器</span>
<span class="hljs-built_in">cat</span> /sys/block/sda/queue/scheduler
<span class="hljs-comment"># 输出：[mq-deadline] none</span>

<span class="hljs-comment"># 推荐配置（Android设备）：</span>
<span class="hljs-comment"># - UFS存储：mq-deadline 或 none（UFS自带调度）</span>
<span class="hljs-comment"># - eMMC存储：cfq 或 deadline</span>

<span class="hljs-comment"># 修改调度器</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"mq-deadline"</span> &gt; /sys/block/sda/queue/scheduler
</code></pre>
<h4 data-id="heading-56"><strong>6.2.2 调整写回策略</strong></h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 降低dirty_ratio（加快写回）</span>
<span class="hljs-built_in">echo</span> 10 &gt; /proc/sys/vm/dirty_ratio  <span class="hljs-comment"># 默认20</span>
<span class="hljs-built_in">echo</span> 5 &gt; /proc/sys/vm/dirty_background_ratio  <span class="hljs-comment"># 默认10</span>

<span class="hljs-comment"># 缩短写回超时</span>
<span class="hljs-built_in">echo</span> 1500 &gt; /proc/sys/vm/dirty_writeback_centisecs  <span class="hljs-comment"># 15秒（默认30秒）</span>
</code></pre>
<h3 data-id="heading-57">6.3 SELinux与存储权限</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 确保f2fs相关SELinux策略正确</span>
<span class="hljs-comment"># file_contexts示例：</span>
/data/vendor/f2fs(/.*)? u:object_r:vendor_f2fs_file:s0

<span class="hljs-comment"># sepolicy示例：</span>
allow system_server vendor_f2fs_file:<span class="hljs-built_in">dir</span> { <span class="hljs-built_in">read</span> open getattr search };
allow vold vendor_f2fs_file:<span class="hljs-built_in">dir</span> { create write add_name };
</code></pre>
<hr/>
<h2 data-id="heading-58">七、问题诊断速查表</h2>
<h3 data-id="heading-59">7.1 性能问题快速定位</h3>









































<table><thead><tr><th align="left">症状</th><th align="left">可能原因</th><th align="left">诊断命令</th><th align="left">解决方案</th></tr></thead><tbody><tr><td align="left">写入慢</td><td align="left">空间不足/GC压力大</td><td align="left"><code>df -h</code> + <code>cat /sys/kernel/debug/f2fs/status</code></td><td align="left">fstrim + 清理缓存</td></tr><tr><td align="left">读取慢</td><td align="left">缓存失效/碎片化</td><td align="left"><code>echo 3 &gt; /proc/sys/vm/drop_caches</code> 后测试</td><td align="left">调整readahead + GC</td></tr><tr><td align="left">随机I/O差</td><td align="left">extent缓存未命中</td><td align="left"><code>iobench --type=randread</code></td><td align="left">启用age_extent_cache</td></tr><tr><td align="left">应用启动慢</td><td align="left">频繁sync</td><td align="left"><code>systrace disk</code></td><td align="left">改用异步I/O（apply）</td></tr><tr><td align="left">设备越用越慢</td><td align="left">碎片化 + 空间不足</td><td align="left"><code>f2fs_io fsstat /data</code></td><td align="left">定期fstrim + 增加OP空间</td></tr></tbody></table>
<h3 data-id="heading-60">7.2 加密问题诊断</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查FBE状态</span>
adb shell getprop ro.crypto.state
<span class="hljs-comment"># 输出：encrypted  ← FBE已启用</span>

<span class="hljs-comment"># 检查密钥状态</span>
adb shell dumpsys activity service com.android.server.locksettings
<span class="hljs-comment"># 查找：User 0: CE key installed</span>

<span class="hljs-comment"># 检查硬件加密支持</span>
adb shell getprop ro.hardware.keystore
<span class="hljs-comment"># 输出：trusty  ← 使用TEE</span>

<span class="hljs-comment"># 检查Keymaster版本</span>
adb shell dumpsys keystore | grep <span class="hljs-string">"Hardware"</span>
</code></pre>
<h3 data-id="heading-61">7.3 f2fs健康检查</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 综合健康检查脚本</span>
adb shell &lt;&lt; <span class="hljs-string">'EOF'</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"=== F2FS Health Check ==="</span>

<span class="hljs-comment"># 1. 基本信息</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Filesystem:"</span>
<span class="hljs-built_in">df</span> -h /data

<span class="hljs-comment"># 2. f2fs状态</span>
<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\nf2fs Status:"</span>
<span class="hljs-built_in">cat</span> /sys/kernel/debug/f2fs/status | grep -E <span class="hljs-string">"Free sections|Dirty segments|Valid blocks"</span>

<span class="hljs-comment"># 3. GC状态</span>
<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\nGC Status:"</span>
<span class="hljs-built_in">cat</span> /sys/kernel/debug/f2fs/status | grep -E <span class="hljs-string">"GC calls|reclaimed"</span>

<span class="hljs-comment"># 4. 挂载选项</span>
<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\nMount Options:"</span>
mount | grep /data

<span class="hljs-comment"># 5. 磁盘I/O统计</span>
<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\nDisk Stats:"</span>
<span class="hljs-built_in">cat</span> /proc/diskstats | grep dm-0

<span class="hljs-built_in">echo</span> <span class="hljs-string">"=== Check Complete ==="</span>
EOF
</code></pre>
<hr/>
<h2 data-id="heading-62">八、总结与展望</h2>
<h3 data-id="heading-63">8.1 核心要点回顾</h3>
<ol>
<li>
<p><strong>FBE加密机制</strong></p>
<ul>
<li>CE/DE双密钥体系实现Direct Boot</li>
<li>基于Keymaster HAL的硬件安全保障</li>
<li>Android 15增强：硬件包裹密钥、在线密钥升级</li>
</ul>
</li>
<li>
<p><strong>f2fs文件系统</strong></p>
<ul>
<li>LFS日志结构针对Flash优化</li>
<li>热/冷数据分离减少写放大</li>
<li>在线GC和碎片整理</li>
<li>Android 15新特性：压缩支持、age extent cache</li>
</ul>
</li>
<li>
<p><strong>Metadata加密</strong></p>
<ul>
<li>dm-default-key设备映射器</li>
<li>fsverity完整性保护</li>
</ul>
</li>
<li>
<p><strong>性能优化方法论</strong></p>
<ul>
<li>基准测试（dd/fio/iobench）</li>
<li>Trace分析（systrace/perfetto）</li>
<li>GC调优（gc_urgent/fstrim）</li>
<li>应用层优化（避免sync/使用apply）</li>
</ul>
</li>
</ol>
<h3 data-id="heading-64">8.2 Android 15的改进</h3>









































<table><thead><tr><th align="left">特性</th><th align="left">Android 14</th><th align="left">Android 15</th><th align="left">提升</th></tr></thead><tbody><tr><td align="left">FBE硬件加密</td><td align="left">支持Inline Crypto</td><td align="left">强制Hardware-wrapped keys</td><td align="left">安全性↑</td></tr><tr><td align="left">f2fs压缩</td><td align="left">实验性</td><td align="left">默认启用（LZ4）</td><td align="left">空间节省30%+</td></tr><tr><td align="left">Metadata加密</td><td align="left">dm-crypt</td><td align="left">dm-default-key优化</td><td align="left">性能↑15%</td></tr><tr><td align="left">extent缓存</td><td align="left">基础extent_cache</td><td align="left">age_extent_cache</td><td align="left">随机读↑25%</td></tr><tr><td align="left">GC效率</td><td align="left">标准GC</td><td align="left">自适应GC + 预测算法</td><td align="left">后台性能↑</td></tr></tbody></table>
<h3 data-id="heading-65">8.3 未来展望</h3>
<p><strong>存储技术演进方向</strong>：</p>
<ul>
<li><strong>UFS 4.0普及</strong>：顺序读取速度将达4GB/s</li>
<li><strong>ZNS（Zoned Namespace）SSD</strong>：更好的Flash管理</li>
<li><strong>持久化内存（PMem）</strong>：字节级寻址的存储</li>
<li><strong>AI驱动的存储优化</strong>：机器学习预测I/O模式</li>
</ul>
<p><strong>Android存储系统发展</strong>：</p>
<ul>
<li>更智能的GC策略（基于用户行为学习）</li>
<li>更细粒度的加密控制（per-file key）</li>
<li>存储分层（热数据使用高速存储）</li>
<li>端到端加密与云同步集成</li>
</ul>
<hr/>
<h2 data-id="heading-66">九、参考资源</h2>
<h3 data-id="heading-67">9.1 源码路径</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># FBE加密相关</span>
system/vold/FsCrypt.cpp                    <span class="hljs-comment"># FBE核心实现</span>
system/vold/KeyStorage.cpp                 <span class="hljs-comment"># 密钥存储</span>
system/extras/libfscrypt/fscrypt.cpp       <span class="hljs-comment"># libfscrypt库</span>
kernel/fs/crypto/                          <span class="hljs-comment"># 内核fscrypt子系统</span>

<span class="hljs-comment"># f2fs文件系统</span>
kernel/fs/f2fs/                            <span class="hljs-comment"># f2fs内核代码</span>
external/f2fs-tools/                       <span class="hljs-comment"># f2fs用户空间工具</span>
system/core/fs_mgr/                        <span class="hljs-comment"># 文件系统管理器</span>

<span class="hljs-comment"># 设备映射器</span>
system/core/libdm/                         <span class="hljs-comment"># dm设备映射器库</span>
system/vold/MetadataCrypt.cpp              <span class="hljs-comment"># Metadata加密</span>
</code></pre>
<h3 data-id="heading-68">9.2 官方文档</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fsource.android.com%2Fdocs%2Fsecurity%2Ffeatures%2Fencryption%2Ffile-based" target="_blank" title="https://source.android.com/docs/security/features/encryption/file-based" ref="nofollow noopener noreferrer">Android File-Based Encryption</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.kernel.org%2Fdoc%2Fhtml%2Flatest%2Ffilesystems%2Ff2fs.html" target="_blank" title="https://www.kernel.org/doc/html/latest/filesystems/f2fs.html" ref="nofollow noopener noreferrer">f2fs Documentation</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgitlab.com%2Fcryptsetup%2Fcryptsetup%2F-%2Fwikis%2FDMCrypt" target="_blank" title="https://gitlab.com/cryptsetup/cryptsetup/-/wikis/DMCrypt" ref="nofollow noopener noreferrer">Linux dm-crypt</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fsource.android.com%2Fdocs%2Fsecurity%2Ffeatures%2Fkeystore" target="_blank" title="https://source.android.com/docs/security/features/keystore" ref="nofollow noopener noreferrer">Keymaster HAL</a></li>
</ul>
<h3 data-id="heading-69">9.3 性能分析工具</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 系统工具</span>
adb shell dumpsys diskstats              <span class="hljs-comment"># 磁盘统计</span>
adb shell dumpsys storaged               <span class="hljs-comment"># 存储守护进程</span>
adb shell /system/bin/f2fs_io            <span class="hljs-comment"># f2fs专用工具</span>
adb shell /system/bin/ioctl              <span class="hljs-comment"># 底层ioctl测试</span>

<span class="hljs-comment"># 第三方工具</span>
fio                                      <span class="hljs-comment"># 灵活的I/O测试工具</span>
iobench                                  <span class="hljs-comment"># 简单的benchmark</span>
blktrace                                 <span class="hljs-comment"># 块层追踪</span>
</code></pre>
<h3 data-id="heading-70">9.4 调试命令汇总</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># FBE调试</span>
getprop ro.crypto.type                   <span class="hljs-comment"># 查看加密类型</span>
getprop ro.crypto.state                  <span class="hljs-comment"># 查看加密状态</span>
vdc cryptfs checkpw                      <span class="hljs-comment"># 检查密码（需要root）</span>

<span class="hljs-comment"># f2fs调试</span>
<span class="hljs-built_in">cat</span> /sys/kernel/debug/f2fs/status        <span class="hljs-comment"># f2fs状态</span>
<span class="hljs-built_in">cat</span> /sys/fs/f2fs/&lt;device&gt;/features       <span class="hljs-comment"># f2fs特性支持</span>
f2fs_io gc /data                         <span class="hljs-comment"># 手动触发GC</span>

<span class="hljs-comment"># 性能调试</span>
systrace.py disk block f2fs              <span class="hljs-comment"># trace存储I/O</span>
perfetto --config trace.pbtxt            <span class="hljs-comment"># 深度性能分析</span>
simpleperf record -a -g --duration 10    <span class="hljs-comment"># CPU采样分析</span>
</code></pre>
<hr/>
<h3 data-id="heading-71">系列文章</h3>
<ul>
<li><a href="https://juejin.cn/post/7598390354292539438" target="_blank" title="https://juejin.cn/post/7598390354292539438">上一篇：Android 15存储子系统深度解析(二):FUSE文件系统与Scoped Storage</a></li>
</ul>
<hr/>
<p><em>欢迎来我中的<a href="https://link.juejin.cn?target=https%3A%2F%2Fhome.wonlab.top" target="_blank" title="https://home.wonlab.top" ref="nofollow noopener noreferrer">个人主页</a>找到更多有用的知识和有趣的产品</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Compose: Android整合yolo模型完成图像识别]]></title>    <link>https://juejin.cn/post/7599330434427027507</link>    <guid>https://juejin.cn/post/7599330434427027507</guid>    <pubDate>2026-01-26T11:12:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599330434427027507" data-draft-id="7599450177057996810" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Compose: Android整合yolo模型完成图像识别"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-01-26T11:12:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户98512003583"/> <meta itemprop="url" content="https://juejin.cn/user/1927871600799337"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Compose: Android整合yolo模型完成图像识别
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1927871600799337/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户98512003583
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T11:12:03.000Z" title="Mon Jan 26 2026 11:12:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在这个大模型飞速发展，好像大模型编程能编写一切的时代，想整点不一样的，相比于大模型来说呢有点新又有点老对大模型编程来说又做不到的东西，那就是：<strong>在手机中跑通本地图像识别模型</strong>。</p>
</blockquote>
<h2 data-id="heading-0">0. 前言</h2>
<p>既然想做这个，用什么模型呢？Yolo 模型在图像识别领域使用起来还是挺方便的，之前工作中就接触过 yolo 5 模型，去官网一看，现在都已经到 yolo 26 了，本着学新不学旧的原则，而且看起来 yolo 26 相比较于之前的模型，在识别准确率方便有着明显的优势，而且在边缘计算方便做了很大的优化，很适合在手机端部署。
<img src="https://mengfly.github.io/Obsidian-Img/ObImg/Android%E6%95%B4%E5%90%88Yolo%E6%A8%A1%E5%9E%8B_0_%E5%89%8D%E8%A8%80.png" alt="yolo26" loading="lazy"/></p>
<h3 data-id="heading-1">模型的分类</h3>
<p>yolo 提供了多种不同类型的模型，适用于不同的场景。具体的模型类别 yolo 管网都有详细的描述。这里只简单概述。
<img src="https://mengfly.github.io/Obsidian-Img/ObImg/Android%E6%95%B4%E5%90%88Yolo%E6%A8%A1%E5%9E%8B_0_%E5%89%8D%E8%A8%80_1.png" alt="" loading="lazy"/></p>
<ol>
<li>YOLO 26 ，图像识别，用于探测图像中存在有那些类别的物体，包括物体的边界框坐标</li>
<li>YOLO 26-seg，图像分割，识别图像中不同物体的边缘，进行图像分割</li>
<li>YOLO 26-pose, 人姿态识别，识别图像中的人体姿态，进行人体姿态识别</li>
<li>YOLO 26-obb, 定向边界框对象监测，允许边框旋转以更紧密地匹配物体的形状</li>
<li>YOLO 26-cls, 用于识别图像中存在有那些类别的物体，但是不包括物体的边界框坐标</li>
</ol>
<p>每种类型的模型，都提供了不同参数的模型，从n、s、m、b，分别对应不同的模型大小和准确率。
<img src="https://mengfly.github.io/Obsidian-Img/ObImg/Android%E6%95%B4%E5%90%88Yolo%E6%A8%A1%E5%9E%8B_0_%E5%89%8D%E8%A8%80_2.png" alt="" loading="lazy"/></p>
<p>我这里想做的是物体检测，受限于手机端的性能，从官方图中来看，选择 yolo26s 模型比较合适，相比较于yolo26n模型，参数没有增加多少，但是准确率上升了很多。</p>
<h2 data-id="heading-2">1. 生成 Android 可调用的 TFLite 文件</h2>
<p>首先，手机端是没办法直接使用 yolo 模型的，需要将 yolo 模型转换为 tflite 模型，通过 TensorFlow Lite 框架进行调用。所以我们需要你将 yolo 的 pt 模型文件转换为 tflite 模型文件。</p>
<p>好在，yolo 提供了非常方便的模型转换工具，直接几行代码就可以搞定，之前尝试用各种工具转换，耗时两天未成功，遗憾没有早发现这个方法。</p>
<h3 data-id="heading-3">注意事项</h3>
<ol>
<li>一定要使用一个新的 python 环境，因为编译过程中会出现各种莫名其妙的版本匹配不上的问题</li>
<li>一定要在 Linux 下面编译，某些 python 库只在 linux 下可用，比如 ai-edge-litert，别问我怎么知道的，说多了都是泪啊。</li>
<li>安装使用 python 3.10，低于 python 3.10 有些库没法使用</li>
</ol>
<h3 data-id="heading-4">安装 Yolo 与 tensorflow</h3>
<pre><code class="hljs language-sh" lang="sh">pip install ultralytics -i https://pypi.tuna.tsinghua.edu.cn/simple            

pip install tensorflow==2.19.0 -i https://pypi.tuna.tsinghua.edu.cn/simple   
</code></pre>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> ultralytics <span class="hljs-keyword">import</span> YOLO  
  
model = YOLO(<span class="hljs-string">"yolo26s.pt"</span>)  
  
model.export(<span class="hljs-built_in">format</span>=<span class="hljs-string">"tflite"</span>)
</code></pre>
<h2 data-id="heading-5">2. Android 整合 tflite 模型</h2>
<h3 data-id="heading-6">添加 TensorFlow 依赖</h3>
<p>在 <strong>build.gradle.kts</strong> 中添加 TFLite 依赖
<code>libs.versions.toml</code></p>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-section">[versions]</span>
<span class="hljs-attr">tensorflowLite</span> = <span class="hljs-string">"2.17.0"</span>  
<span class="hljs-attr">tensorflowLiteSupport</span> = <span class="hljs-string">"0.5.0"</span>  
<span class="hljs-attr">tensorflowLiteGpu</span> = <span class="hljs-string">"2.17.0"</span>
<span class="hljs-attr">litertGpuApi</span> = <span class="hljs-string">"1.4.1"</span>

<span class="hljs-section">[libraries]</span>
<span class="hljs-attr">tensorflow-lite-gpu</span> = { module = <span class="hljs-string">"org.tensorflow:tensorflow-lite-gpu"</span>, version.ref = <span class="hljs-string">"tensorflowLiteGpu"</span> }  
<span class="hljs-attr">tensorflow-lite-support</span> = { module = <span class="hljs-string">"org.tensorflow:tensorflow-lite-support"</span>, version.ref = <span class="hljs-string">"tensorflowLiteSupport"</span> }  
<span class="hljs-attr">tensorflow-lite</span> = { module = <span class="hljs-string">"org.tensorflow:tensorflow-lite"</span>, version.ref = <span class="hljs-string">"tensorflowLite"</span> }
<span class="hljs-attr">litert-gpu-api</span> = { group = <span class="hljs-string">"com.google.ai.edge.litert"</span>, name = <span class="hljs-string">"litert-gpu-api"</span>, version.ref = <span class="hljs-string">"litertGpuApi"</span> }
</code></pre>
<p><code>build.gradle.kts</code></p>
<pre><code class="hljs language-kts" lang="kts">dependencies {
	<span class="hljs-comment">// TFLite核心库  </span>
	implementation(libs.tensorflow.lite)  
	<span class="hljs-comment">// TFLite支持库（包含图像处理）  </span>
	implementation(libs.tensorflow.lite.support)  
	<span class="hljs-comment">// 可选：GPU加速（需要对应设备支持）  </span>
	implementation(libs.tensorflow.lite.gpu)
	implementation(libs.litert.gpu.api)
}
</code></pre>
<h3 data-id="heading-7">配置模型</h3>
<p>将生成好的 tflite 模型放在 assets 目录下，如下图所示：
yolo 会生成两种类型的文件，float32 和 float16, float32 要比 float16 模型大一倍，问了 ai 这两个就是数值精度不同，准确率几乎差别不大，除非是用于很精细识别的情形下才需要考虑使用 float32 的模型，所以这里我选择了 float16 的模型。
<img src="https://mengfly.github.io/Obsidian-Img/ObImg/Android%E6%95%B4%E5%90%88Yolo%E6%A8%A1%E5%9E%8B_2_Android_%E6%95%B4%E5%90%88_tflite_%E6%A8%A1%E5%9E%8B.png" alt="添加tflite模型到assets目录" loading="lazy"/></p>
<h3 data-id="heading-8">创建推测模型类</h3>
<p>tensorflow 通过 Interpreter 加载 tflite 模型，通过 Interpreter 的 run 方法运行模型。
<strong>TfLiteDetectModel.kt</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-keyword">object</span> TfLiteDetectModel {  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> TAG = <span class="hljs-string">"TfLiteModelHelper"</span>  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> MODEL_PATH = <span class="hljs-string">"yolo26s_float16.tflite"</span>  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> INPUT_SIZE = <span class="hljs-number">640</span>  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> CONF_THRESHOLD = <span class="hljs-number">0.5f</span>  <span class="hljs-comment">// 置信度阈值（过滤低置信度结果）  </span>
  
  	<span class="hljs-comment">// 模型</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> mTfLite: Interpreter  
  
  	<span class="hljs-comment">// yolo26 使用 COCO 数据集80个类别上进行训练</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> COCO_CLASSES: List&lt;Classes&gt;  
  
  	<span class="hljs-comment">// 加载类别数据，英文,中文</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadClasses</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span> : List&lt;Classes&gt; {  
        context.assets.<span class="hljs-keyword">open</span>(<span class="hljs-string">"classes.csv"</span>).use {  
            <span class="hljs-keyword">val</span> csvReader = it.bufferedReader()  
            <span class="hljs-keyword">val</span> lines = csvReader.readLines()  
            <span class="hljs-keyword">return</span> lines.map { line -&gt;  
                <span class="hljs-keyword">val</span> split = line.split(<span class="hljs-string">","</span>)  
                Classes(  
                    us = split[<span class="hljs-number">0</span>],  
                    cn = split[<span class="hljs-number">1</span>]  
                )  
            }  
        }    
    }  
  
  	
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">init</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span> {  
        COCO_CLASSES = loadClasses(context)  
        <span class="hljs-keyword">try</span> {  
        	<span class="hljs-comment">// 加载模型</span>
            <span class="hljs-keyword">val</span> mappedFile = FileUtil.loadMappedFile(context, MODEL_PATH)  
            <span class="hljs-keyword">val</span> options = Interpreter.Options()  
  
            <span class="hljs-keyword">val</span> compatibilityList = CompatibilityList()  
        	<span class="hljs-comment">// 如果GPU可用的话，使用GPU</span>
            <span class="hljs-keyword">if</span> (compatibilityList.isDelegateSupportedOnThisDevice) {  
                <span class="hljs-keyword">val</span> gpuDelegate = GpuDelegate(compatibilityList.bestOptionsForThisDevice())  
                options.addDelegate(gpuDelegate)  
            } <span class="hljs-keyword">else</span> {  
                options.setNumThreads(<span class="hljs-number">4</span>)  
            }  
  
            mTfLite = Interpreter(mappedFile, options)  
            Log.d(TAG, <span class="hljs-string">"init: model <span class="hljs-variable">$MODEL_PATH</span> init success"</span>)  
        } <span class="hljs-keyword">catch</span> (e: Exception) {  
            Log.e(TAG, <span class="hljs-string">"init: model <span class="hljs-variable">$MODEL_PATH</span> init failed : <span class="hljs-subst">${e.message}</span>"</span>)  
            e.printStackTrace()  
        }  
  
    }  
  
    <span class="hljs-comment">/**  
     * 预处理图像  
     */</span>  
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">preProcessImage</span><span class="hljs-params">(bitmap: <span class="hljs-type">Bitmap</span>)</span></span>: TensorImage {  
        <span class="hljs-keyword">val</span> processor = ImageProcessor.Builder()
            <span class="hljs-comment">// 调整到yolo26需要的尺寸  </span>
            .add(ResizeOp(INPUT_SIZE, INPUT_SIZE, ResizeOp.ResizeMethod.BILINEAR))  
            <span class="hljs-comment">// 归一化</span>
            .add(NormalizeOp(<span class="hljs-number">0f</span>, <span class="hljs-number">255f</span>))  
            .build();  
  		
  		<span class="hljs-comment">// 协程处理图片</span>
        <span class="hljs-keyword">return</span> withContext(Dispatchers.IO) {  
            <span class="hljs-keyword">val</span> tensorImage = TensorImage(DataType.FLOAT32)  
            tensorImage.load(bitmap)  
            <span class="hljs-keyword">return</span><span class="hljs-symbol">@withContext</span> processor.process(tensorImage)  
        }  
    }  
  
  	<span class="hljs-comment">/**
  	 * 监测图片
  	 */</span>
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">detect</span><span class="hljs-params">(bitmap: <span class="hljs-type">Bitmap</span>)</span></span>: List&lt;DetectionResult&gt; {  
  
        <span class="hljs-keyword">if</span> (!::mTfLite.isInitialized) {  
            <span class="hljs-keyword">return</span> emptyList()  
        }
        <span class="hljs-comment">// 预处理图片</span>
        <span class="hljs-keyword">val</span> tensorImage = preProcessImage(convertToArgb8888IfNeeded(bitmap))  
  
  		<span class="hljs-comment">// 构建输出</span>
        <span class="hljs-keyword">val</span> outputShape = mTfLite.getOutputTensor(<span class="hljs-number">0</span>).shape()  
        <span class="hljs-keyword">val</span> output = Array(outputShape[<span class="hljs-number">0</span>]) {  
            Array(outputShape[<span class="hljs-number">1</span>]) {  
                FloatArray(outputShape[<span class="hljs-number">2</span>])  
            }  
        }  
        <span class="hljs-comment">// 执行推理  </span>
        mTfLite.run(tensorImage.buffer, output)  
        
        <span class="hljs-keyword">return</span> postProcess(output)  
    }  
  
  	<span class="hljs-comment">/**
  	 * 处理结果
  	 */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">postProcess</span><span class="hljs-params">(output: <span class="hljs-type">Array</span>&lt;<span class="hljs-type">Array</span>&lt;<span class="hljs-type">FloatArray</span>&gt;&gt;)</span></span>: List&lt;DetectionResult&gt; {  
        <span class="hljs-keyword">val</span> results = mutableListOf&lt;DetectionResult&gt;()  
        withContext(Dispatchers.Default) {  
  
            <span class="hljs-keyword">val</span> detections = output[<span class="hljs-number">0</span>]  
            <span class="hljs-comment">// 结果 [left, top, right, bottom, objConf, classId]            </span>
            <span class="hljs-keyword">for</span> (det <span class="hljs-keyword">in</span> detections) {  
                <span class="hljs-keyword">val</span> objConf = det[<span class="hljs-number">4</span>]  <span class="hljs-comment">// 目标存在置信度  </span>
                <span class="hljs-keyword">if</span> (objConf &lt; CONF_THRESHOLD) <span class="hljs-keyword">continue</span>  
   
                <span class="hljs-keyword">val</span> classId = det[<span class="hljs-number">5</span>]  
  
                <span class="hljs-comment">// 解析检测框  </span>
                <span class="hljs-keyword">val</span> cx = det[<span class="hljs-number">0</span>]  
                <span class="hljs-keyword">val</span> cy = det[<span class="hljs-number">1</span>]  
                <span class="hljs-keyword">val</span> cx2 = det[<span class="hljs-number">2</span>]  
                <span class="hljs-keyword">val</span> cy2 = det[<span class="hljs-number">3</span>]  
  
                results.add(  
                    DetectionResult(  
                        classType = COCO_CLASSES[classId.toInt()],  
                        confidence = objConf,  
                        boundingBox = RectF(cx, cy, cx2, cy2)  
                    )  
                )  
            }  
        }  
        <span class="hljs-keyword">return</span> results  
    }  
  
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">convertToArgb8888IfNeeded</span><span class="hljs-params">(bitmap: <span class="hljs-type">Bitmap</span>)</span></span>: Bitmap {  
    	<span class="hljs-comment">// 图片处理必须是ARGB_8888类型</span>
        <span class="hljs-keyword">if</span> (bitmap.config == Bitmap.Config.ARGB_8888) {  
            <span class="hljs-keyword">return</span> bitmap  
        }  
  
        <span class="hljs-comment">// 使用copy方法，自动处理硬件位图问题  </span>
        <span class="hljs-keyword">return</span> bitmap.copy(Bitmap.Config.ARGB_8888, <span class="hljs-literal">true</span>)  
  
    }  
}
</code></pre>
<h2 data-id="heading-9">3. 调用手机摄像头拍摄图像</h2>
<p>如何调用手机摄像头获取图像的内容可以参考 [[Compose调用系统相机]] 这篇文章，里面有清晰的步骤，这里直接使用获取到的图像。</p>
<h2 data-id="heading-10">4. 调用模型并绘制结果</h2>
<p>我们自定义一个组件，使用 Canvas 来绘制图片，绘制监测到的图片框以及类别名称。
该自定义组件具备一下几个特点：</p>
<ol>
<li>根据图片尺寸和组件尺寸自动缩放图片</li>
<li>图片传入后，自动调用模型进行图像识别</li>
<li>识别过程中显示加载中</li>
<li>识别完成后，绘制识别框与文字</li>
</ol>
<h3 data-id="heading-11">定义组件</h3>
<p>组件传入图片、为了方便扩展，将模型也放到组件参数中，识别到结果后的回调函数，方便把识别结果提供给父组件。</p>
<p><strong>DetectImageView.kt</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>  
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">DetectImageView</span><span class="hljs-params">(  
    bitmap: <span class="hljs-type">Bitmap</span>,  
    modifier: <span class="hljs-type">Modifier</span> = Modifier,  
    model: <span class="hljs-type">TfLiteDetectModel</span> = TfLiteDetectModel,  
    onResult: (<span class="hljs-type">List</span>&lt;<span class="hljs-type">DetectionResult</span>&gt;) -&gt; <span class="hljs-type">Unit</span> = {}  
)</span></span> {
	
	Canvas(  
    modifier = modifier  
        .padding(<span class="hljs-number">10.</span>dp)  
        <span class="hljs-comment">// 圆角背景</span>
        .background(Color.White, RoundedCornerShape(<span class="hljs-number">10.</span>dp)),  
	) {
		<span class="hljs-comment">// 绘制内容</span>
	}
}
</code></pre>
<h3 data-id="heading-12">绘制图片</h3>
<p>绘制图片调用 drawImage，为了让图片自适应组件大小，需要根据组件的大小和图片的大小进行缩放。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">DetectImageView</span><span class="hljs-params">(...)</span></span> {
	Canvas(..) {
		<span class="hljs-keyword">val</span> canvasWidth = size.width  
		<span class="hljs-keyword">val</span> canvasHeight = size.height  
		<span class="hljs-keyword">val</span> bitmapWidth = bitmap.width.toFloat()  
		<span class="hljs-keyword">val</span> bitmapHeight = bitmap.height.toFloat()  
		  
		<span class="hljs-comment">// 计算缩放比例，确保图片完全显示在Canvas内  </span>
		<span class="hljs-keyword">val</span> scale = minOf(  
		    canvasWidth / bitmapWidth,  
		    canvasHeight / bitmapHeight  
		)  
		  
		<span class="hljs-comment">// 计算缩放后的图片尺寸  </span>
		<span class="hljs-keyword">val</span> scaledWidth = (bitmapWidth * scale).toInt()  
		<span class="hljs-keyword">val</span> scaledHeight = (bitmapHeight * scale).toInt()  
		  
		<span class="hljs-comment">// 计算居中偏移量  </span>
		<span class="hljs-keyword">val</span> offsetX = ((canvasWidth - scaledWidth) / <span class="hljs-number">2f</span>).toInt()  
		<span class="hljs-keyword">val</span> offsetY = ((canvasHeight - scaledHeight) / <span class="hljs-number">2f</span>).toInt()  
		  
		<span class="hljs-comment">// 绘制图片  </span>
		drawImage(  
		    image = bitmap.asImageBitmap(),  
		    dstSize = IntSize(scaledWidth, scaledHeight),  
		    dstOffset = IntOffset(offsetX, offsetY)  
		)
	}

}

</code></pre>
<h3 data-id="heading-13">绘制模型结果</h3>
<p>绘制模型结果需要调用模型，调用模型是一个耗时方法，我们需要将它放到协程中执行。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>  
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">DetectImageView</span><span class="hljs-params">(...,onResult: (<span class="hljs-type">List</span>&lt;<span class="hljs-type">DetectionResult</span>&gt;) -&gt; <span class="hljs-type">Unit</span> = {})</span></span> {
	
	<span class="hljs-comment">// 存放模型结果</span>
	<span class="hljs-keyword">var</span> res: List&lt;DetectionResult&gt; <span class="hljs-keyword">by</span> remember { mutableStateOf(emptyList()) }  
	<span class="hljs-comment">// 是否正在加载模型结果</span>
	<span class="hljs-keyword">var</span> isLoading <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-literal">false</span>) }  
	<span class="hljs-comment">// 测量文字</span>
	<span class="hljs-keyword">val</span> textMeasurer = rememberTextMeasurer()
	<span class="hljs-comment">// 模型成功后的回调</span>
	<span class="hljs-keyword">val</span> resultCallback <span class="hljs-keyword">by</span> rememberUpdatedState(onResult)

	<span class="hljs-comment">// 调用模型，这里使用bitmap为键，只要图片该表，就重新调用模型</span>
	LaunchedEffect(bitmap) {  
	    isLoading = <span class="hljs-literal">true</span>  
	    res = model.detect(bitmap)    
	    isLoading = <span class="hljs-literal">false</span>  
	    <span class="hljs-comment">// 调用回调向组件外传输模型调用后的结果</span>
	    resultCallback(res)  
	}
	
	Canvas(..) {
		<span class="hljs-comment">// ... 绘制图片逻辑</span>
		
		<span class="hljs-comment">// 绘制结果</span>
		drawBounds(textMeasurer, res, offsetX, offsetY, scaledWidth, scaledHeight)
	}
}

<span class="hljs-comment">/**  
 * 绘制检测结果  
 * <span class="hljs-doctag">@param</span> res 检测结果  
 * <span class="hljs-doctag">@param</span> offsetX 图片在Canvas中的X轴偏移量  
 * <span class="hljs-doctag">@param</span> offsetY 图片在Canvas中的Y轴偏移量  
 * <span class="hljs-doctag">@param</span> scaledWidth 图片缩放后的宽度  
 * <span class="hljs-doctag">@param</span> scaledHeight 图片缩放后的高度  
 */</span>  
<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> DrawScope.<span class="hljs-title">drawBounds</span><span class="hljs-params">(  
    textMeasurer: <span class="hljs-type">TextMeasurer</span>,  
    res: <span class="hljs-type">List</span>&lt;<span class="hljs-type">DetectionResult</span>&gt;,  
    offsetX: <span class="hljs-type">Int</span>, offsetY: <span class="hljs-type">Int</span>,  
    scaledWidth: <span class="hljs-type">Int</span>, scaledHeight: <span class="hljs-type">Int</span>  
)</span></span> {  
  
    <span class="hljs-comment">// 绘制检测结果  </span>
    res.forEach { detectionResult -&gt;  
  		
  		<span class="hljs-comment">// 计算边框位置</span>
        <span class="hljs-keyword">val</span> left = offsetX + detectionResult.boundingBox.left * scaledWidth  
        <span class="hljs-keyword">val</span> top = offsetY + detectionResult.boundingBox.top * scaledHeight  
  
        <span class="hljs-keyword">val</span> right = offsetX + detectionResult.boundingBox.right * scaledWidth  
        <span class="hljs-keyword">val</span> bottom = offsetY + detectionResult.boundingBox.bottom * scaledHeight  
  
        drawRect(  
            style = Stroke(width = <span class="hljs-number">5f</span>),  
            color = Color.Red, topLeft = Offset(  
                left,  
                top  
            ), size = Size(  
                right - left,  
                bottom - top  
            )  
        )  
  
        <span class="hljs-keyword">val</span> layoutResult = textMeasurer.measure(detectionResult.classType.cn)  
  
        drawText(  
            layoutResult,  
            color = Color.Red,  
            topLeft = Offset(left, top - layoutResult.size.height)  
        )  
  
    }  
}
</code></pre>
<p>这里的返回结果回调使用了 rememberUpdatedState，这是因为模型是在协程中调用，为了防止回调方法被修改后导致的问题，使用 rememberUpdatedState 保持回调的最新引用。具体详情可以参考[[用rememberUpdatedState解决Compose协程中的“旧回调”问题]] 这篇文章。</p>
<h3 data-id="heading-14">绘制加载中</h3>
<p>加载中比较难绘制，Compose 是状态决定组件，状态不改变，组件显示行为就不会改变，所以我们得需要让加载内容动起来就需要不停地修改加载内容的状态。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">DetectImageView</span><span class="hljs-params">(...)</span></span> {

	<span class="hljs-comment">// 记录加载中的圆环角度</span>
	<span class="hljs-keyword">var</span> loadingRotation <span class="hljs-keyword">by</span> remember { mutableFloatStateOf(<span class="hljs-number">0f</span>) }
	
	<span class="hljs-comment">// 监听isLoading状态，只要isLoading改变，就启动协程，不断修改圆环角度</span>
	LaunchedEffect(isLoading) {  
		<span class="hljs-keyword">while</span> (isLoading) {  
			loadingRotation += <span class="hljs-number">5f</span>  
	  
			<span class="hljs-keyword">if</span> (loadingRotation &gt;= <span class="hljs-number">360f</span>) {  
				loadingRotation = <span class="hljs-number">0f</span>  
			}  
			delay(<span class="hljs-number">10</span>)  
		}  
	}
	Canvas(..) {
			
		<span class="hljs-comment">// 如果正在加载，显示加载内容</span>
		<span class="hljs-keyword">if</span>(isLoading) run {
			<span class="hljs-comment">// 绘制loading圆环</span>
			drawLoading(canvasWidth, canvasHeight, loadingRotation)  
  
			<span class="hljs-comment">//  绘制遮罩  </span>
			drawRect(  
			    color = Color.Gray.copy(alpha = <span class="hljs-number">0.5f</span>),  
			    size = size  
			)
		}
	}
}

<span class="hljs-comment">/**  
 * 绘制加载中  
 */</span>  
<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> DrawScope.<span class="hljs-title">drawLoading</span><span class="hljs-params">(canvasWidth: <span class="hljs-type">Float</span>, canvasHeight: <span class="hljs-type">Float</span>, rotation: <span class="hljs-type">Float</span> = <span class="hljs-number">0</span>f)</span></span> {  
    <span class="hljs-comment">// 绘制不停转圈的图标  </span>
    <span class="hljs-keyword">val</span> centerX = canvasWidth / <span class="hljs-number">2f</span>  
    <span class="hljs-keyword">val</span> centerY = canvasHeight / <span class="hljs-number">2f</span>  
    <span class="hljs-keyword">val</span> radius = <span class="hljs-number">30f</span>  
    <span class="hljs-keyword">val</span> strokeWidth = <span class="hljs-number">8f</span>  
  
    <span class="hljs-comment">// 绘制背景圆  </span>
    drawCircle(  
        color = Color.Gray.copy(alpha = <span class="hljs-number">0.3f</span>),  
        radius = radius,  
        center = Offset(centerX, centerY),  
        style = Stroke(width = strokeWidth)  
    )  
  
    <span class="hljs-comment">// 绘制旋转的弧形  </span>
  
    drawArc(  
        color = Color.Blue,  
        startAngle = rotation,  
        sweepAngle = <span class="hljs-number">90f</span>,  
        useCenter = <span class="hljs-literal">false</span>,  
        topLeft = Offset(centerX - radius, centerY - radius),  
        size = Size(radius * <span class="hljs-number">2</span>, radius * <span class="hljs-number">2</span>),  
        style = Stroke(width = strokeWidth, cap = Stroke.DefaultCap)  
    )  
}

</code></pre>
<h2 data-id="heading-15">5. 页面中整合组件</h2>
<p><strong>MainActivity.kt</strong>
在页面中使用就比较简单了，直接引用就可以了</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>  
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">MainContentView</span><span class="hljs-params">()</span></span> {
	
	<span class="hljs-keyword">var</span> capturedImageBitmap <span class="hljs-keyword">by</span> remember { mutableStateOf&lt;Bitmap?&gt;(<span class="hljs-literal">null</span>) }
	<span class="hljs-keyword">var</span> res <span class="hljs-keyword">by</span> remember { mutableStateOf(listOf&lt;DetectionResult&gt;()) }
	<span class="hljs-comment">// 调用相机获取图片， 此内容参考 Compose中调用相机文章</span>
	
	<span class="hljs-keyword">if</span> (capturedImageBitmap != <span class="hljs-literal">null</span>) {  
	    Column(modifier = Modifier.padding(innerPadding)) {  
	        Card(  
	            modifier = Modifier  
	                .weight(<span class="hljs-number">1.0f</span>)  
	                .padding(<span class="hljs-number">16.</span>dp)  
	                .fillMaxSize(),  
	        ) {  
	            DetectImageView(  
	                capturedImageBitmap!!,  
	                modifier = Modifier.fillMaxSize()  
	            ) {  
	                res  = it  
	            }  
	        }  
	        Column(  
	            modifier = Modifier  
	                .verticalScroll(rememberScrollState())  
	                .heightIn(<span class="hljs-number">0.</span>dp, <span class="hljs-number">200.</span>dp)  
	        ) {  
	            Text(  
	                <span class="hljs-string">"识别结果"</span>,  
	                modifier = Modifier.padding(horizontal = <span class="hljs-number">16.</span>dp),  
	                style = MaterialTheme.typography.titleLarge  
	            )  
	            FlowRow(  
	                modifier = Modifier.padding(<span class="hljs-number">16.</span>dp),  
	                horizontalArrangement = Arrangement.spacedBy(<span class="hljs-number">8.</span>dp)  
	            ) {  
	                <span class="hljs-keyword">for</span> (detectionResult <span class="hljs-keyword">in</span> res) {  
	                    ElevatedAssistChip(onClick = {}, label = {  
	                        Text(text = detectionResult.classType.cn)  
	                    })  
	                }  
	            }  
	        }    
	    }  
	}
}
</code></pre>
<p>最终结果如下：
<img src="https://mengfly.github.io/Obsidian-Img/ObImg/Android%E6%95%B4%E5%90%88Yolo%E6%A8%A1%E5%9E%8B_5_%E9%A1%B5%E9%9D%A2%E4%B8%AD%E6%95%B4%E5%90%88%E7%BB%84%E4%BB%B6.gif" alt="" loading="lazy"/></p>
<h2 data-id="heading-16">6.后续计划</h2>
<p>仅仅整合进来 yolo 的模型是远远不够的，目前 yolo 仅可以识别 80 种类别的物品，如何让 yolo 识别其他没见过的物品才是模型可以使用的关键。所以后续计划有两个：</p>
<ol>
<li>研究如何在手机端对模型进行训练，针对没见过的图片进行专项训练</li>
<li>yolo 还有一个 yoloe 模型，意为分割一切模型，不过转 tffile 没转成功，研究一下如何转换，利用 yoloe 在手机端分割图像，分割后形成样本，进行训练。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入剖析 Skills.md —— 不是炒冷菜，而是 Agent 的“操作手册”]]></title>    <link>https://juejin.cn/post/7599551824548036634</link>    <guid>https://juejin.cn/post/7599551824548036634</guid>    <pubDate>2026-01-26T21:25:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599551824548036634" data-draft-id="7599538010725548059" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入剖析 Skills.md —— 不是炒冷菜，而是 Agent 的“操作手册”"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2026-01-26T21:25:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="MobotStone"/> <meta itemprop="url" content="https://juejin.cn/user/3839909554568840"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入剖析 Skills.md —— 不是炒冷菜，而是 Agent 的“操作手册”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3839909554568840/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    MobotStone
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T21:25:07.000Z" title="Mon Jan 26 2026 21:25:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>如果要选一个“2025 年底最火的概念词”，那大概率就是<strong>skills</strong> 了。</p>
<p>但我刚打开<code>skill.md</code> 的时候，老实说第一眼直接看懵：我脑子里冒出的念头是——这是不是又在“重复造轮子”？</p>
<p>毕竟大家早就会做<strong>Agent 工具</strong>了，用来让智能体真正去执行任务。在不同平台和生态里，这类东西只是叫法不同：有人叫<strong>tools（工具）</strong> ，有人叫<strong>plugins（插件）</strong> ，也有人叫<strong>skills（技能）</strong> 。所以我一开始理所当然地以为：这不就是同一种东西换个包装、换个名字吗？</p>
<p>结果我继续往下研究，才发现事情没这么简单。我彻底理清了<code>skill.md</code>的定义，也理解了 Anthropic 推出它的战略意图。事实证明，它与传统的 Agent 工具之间，存在著关键性的差异。</p>
<h3 data-id="heading-0">核心区别：“脑子”里的想法 vs “手里”的工具</h3>
<p>简单来说，这两者的区别就像是 “操作手册” 和 “工具箱” 的区别。</p>
<h4 data-id="heading-1">1. Agent Skills：装在脑子里的“做事套路”</h4>
<p><strong>Agent Skills</strong>就像给一个新来的实习生发了一本<strong>工作手册</strong>，或者说一套<strong>技能秘籍</strong>。</p>
<ul>
<li>它是一份标准化的教程（通常写在<code>skill.md</code>文件里）。</li>
<li>它教AI遇到某种任务时该怎么动脑子：
第一步干啥，第二步干啥，有哪些细节要注意。</li>
</ul>
<p><strong>举个例子</strong>：如果这是做菜的技能，那它就是**“回锅肉的菜谱”**。
它告诉AI：先切肉、再炒青椒、最后加调料——每个步骤的节奏都列得明明白白。</p>
<ul>
<li>Skill = “做事方法”，让AI知道<strong>该怎么干</strong>。</li>
</ul>
<h4 data-id="heading-2">2. Agent Tools：拿在手里的工具</h4>
<p><strong>Tools</strong>是AI手里真正能用的<strong>工具</strong>。</p>
<ul>
<li>比如：电脑的命令行、读取文件的接口、联网搜索用的API……
举个例子：在厨房里，Skills是“菜谱”，而Tools就是<strong>菜刀、炒锅和燃气灶</strong>。
它们不会自己炒菜，但没有它们，连锅都上不了。</li>
<li>Tool = “操作能力”，让AI<strong>能动手去干</strong>。</li>
</ul>
<p><strong>一句话总结：</strong></p>
<ul>
<li><strong>skills</strong>告诉智能体“怎么做”——是经验和方法；</li>
<li>tools让智能体“能动手”——是执行的能力。
而且，一个技能往往会指导智能体用合适的工具去完成任务。</li>
</ul>
<h3 data-id="heading-3">skills.md 解决了哪些问题？</h3>
<p>既然工具已经存在，为什么还需要这种新格式？它解决了五个具体问题。</p>
<h4 data-id="heading-4">1. 把“能做”变成“会做”</h4>
<ul>
<li><strong>以前的问题</strong>：AI 工具很强，比如能发邮件、能查数据，但它不知道你们公司的“潜规则”或具体流程。就像一个有力气的员工，却不知道该先迈哪条腿。</li>
<li><strong>现在的方案</strong>：<code>skills.md</code> 不仅给 AI 赋予行动能力，还把“什么时候做”以及“结合公司/团队/用户的具体情况该怎么做”的背景知识一起打包给它。</li>
</ul>
<h4 data-id="heading-5">2. 不一次性塞太多信息</h4>
<ul>
<li><strong>以前的问题</strong>：为了让 AI 懂得多，把所有资料一股脑全塞进它的对话记忆里（Context），导致它运行缓慢，而且容易“消化不良”（上下文膨胀）。</li>
<li><strong>现在的方案</strong>：这是一种“省流模式”。刚开始只加载一个大概的“目录”（极小的内存占用），等真要用这个技能时，再加载详细的说明书，需要素材时再加载素材。</li>
</ul>
<h4 data-id="heading-6">3. 一次编写，到处通用</h4>
<ul>
<li><strong>以前的问题</strong>：很多工具是“专机专用”的，换一个 AI 平台就得重写。</li>
<li><strong>现在的方案</strong>：<code>skills.md</code> 就像一个通用的 USB 设备。你把技能包做好一次，就可以插到各种不同的 AI 代理（Agent）产品上直接使用，不用重复造轮子。</li>
</ul>
<h4 data-id="heading-7">4. 把“老专家的经验”打包</h4>
<ul>
<li><strong>以前的问题</strong>：复杂的流程（比如法律合规、数据处理）很难传递，往往依赖人的口口相传。</li>
<li><strong>现在的方案</strong>：它可以把这些专业的、复杂的流程封装成一个标准的“技能包”。这个包有版本记录、可以被审计，方便在不同团队之间安全地共享专业经验。</li>
</ul>
<h4 data-id="heading-8">5. 只要识字就能看懂</h4>
<ul>
<li><strong>以前的问题</strong>：很多工具的逻辑写在复杂的代码里，想搞清楚它到底怎么运行的，像读天书一样难。</li>
<li><strong>现在的方案</strong>：<code>skills.md</code>本质上就是一份 Markdown 格式的文档。它不仅机器能读，<strong>人也能轻松阅读</strong>。无论是检查、修改还是优化，都像编辑普通文档一样简单直观。</li>
</ul>
<h3 data-id="heading-9">案例分析: HR Skill</h3>
<p>以下是skill.md文件的实际示例。</p>
<pre><code class="hljs language-markdown" lang="markdown">--- 名称：人力资源问题解答
<span class="hljs-section">描述：解答与人力资源相关的问题，包括政策、福利、请假、入职和员工指南。
---</span>
<span class="hljs-section"># 人力资源问题处理</span>
<span class="hljs-section">## 何时使用此技能</span>
当用户询问以下问题时，请使用此技能：
<span class="hljs-bullet">-</span> 公司政策（考勤、着装规范、远程办公）
<span class="hljs-bullet">-</span> 福利（医疗保险、退休计划、带薪休假）
<span class="hljs-bullet">-</span> 请假（年假、病假、育儿假）
<span class="hljs-bullet">-</span> 入职和离职流程
<span class="hljs-bullet">-</span> 绩效考核和反馈流程
<span class="hljs-bullet">-</span> 薪酬和工资相关问题

<span class="hljs-section">## 如何解答人力资源问题</span>
<span class="hljs-bullet">1.</span> 根据用户的问题确定人力资源主题
<span class="hljs-bullet">2.</span> 参考相应的公司政策文件
<span class="hljs-bullet">3.</span> 提供清晰准确的信息
<span class="hljs-bullet">4.</span> 对于敏感或复杂的问题，请转介给人力资源联系人

<span class="hljs-section">## 重要准则</span>
<span class="hljs-bullet">-</span> 切勿泄露员工机密信息
<span class="hljs-bullet">-</span> 将法律或合规问题上报人力资源主管
<span class="hljs-bullet">-</span> 始终在适用情况下引用相关政策文件 # 人力资源问题处理
</code></pre>
<p>它存储在以下文件夹结构中：</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-keyword">my</span>-skill/
├── SKILL.md          <span class="hljs-comment"># 必需：说明 + 元数据</span>
├── scripts/          <span class="hljs-comment"># 可选：可执行代码</span>
├── references/       <span class="hljs-comment"># 可选：文档</span>
└── assets/           <span class="hljs-comment"># 可选：模板、资源</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e95a70b63ec46f7ba2237224a9c2b54~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9ib3RTdG9uZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770067508&amp;x-signature=nBGvWUvIjHzQkZknwfXPMmh5ROI%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-10">skill是怎么工作的</h2>
<p>技能采用<strong>渐进式展开</strong>来高效管理上下文。</p>
<ul>
<li><strong>发现阶段：</strong> 启动时，智能体只加载每个技能的名称和简介。信息够用来判断“这个技能可能用得上吗？”</li>
<li>**激活阶段：**当任务和某个技能的描述匹配时，智能体才会把完整的<code>SKILL.md</code> 说明读进上下文。</li>
<li><strong>执行阶段：</strong> 智能体按说明操作，必要时再加载相关文件或运行打包的代码。</li>
</ul>
<p>这样既能保持速度，又能在需要时获取更多信息。核心要点就是<strong>渐进式信息披露</strong>：省 token，减少提示词膨胀。</p>













































<table><thead><tr><th>特性</th><th>Skills.md  (Agent Skills)</th><th>Agent</th></tr></thead><tbody><tr><td>核心概念</td><td>知识与专长： 告诉Agent如何以及何时处理复杂任务的“剧本”。</td><td>机制与动作： 允许Agent与外部世界（API、系统）交互的“双手”。</td></tr><tr><td>主要功能</td><td>提供上下文、工作流、规则和最佳实践。它负责编排推理过程。</td><td>执行特定的、确定性的功能，如查询数据库、写文件或发送电子邮件。</td></tr><tr><td>文件结构</td><td>一个包含 <a href="https://link.juejin.cn?target=http%3A%2F%2Fskill.md" target="_blank" title="http://skill.md" ref="nofollow noopener noreferrer">skill.md</a> 文件（Markdown 指令 + YAML 元数据）和可选资源文件的文件夹。</td><td>一个架构（通常是 JSON），定义函数名称、参数、描述以及运行它们的后端代码。</td></tr><tr><td>上下文管理</td><td>渐进式披露： 开始时仅加载微量的元数据（约 100 个 token）。仅在相关时才加载完整指令。</td><td>预先加载： 通常需要在会话开始时将完整的工具定义和架构加载到上下文窗口中。</td></tr><tr><td>相互关系</td><td>一个“skill”通常会使用“tool”。它充当管理者的角色，指导使用哪些tool以及按什么顺序使用。</td><td>“工具”由Agent（或技能）使用。它们是等待被调用的原始实用程序。</td></tr><tr><td>可移植性</td><td>知识的高可移植性（它只是文本/Markdown），但目前的格式特定于某些Agent运行时（如 Anthropic 的运行时）。</td><td>如果使用 MCP（模型上下文协议）等标准，则具有很高的执行可移植性，允许一个工具在许多应用程序中工作。</td></tr><tr><td>示例用例</td><td>“教Agent如何编写代码审查”（例如：检查逻辑错误、礼貌性、使用 Git 提取代码）。</td><td>“运行 API 调用”（例如：执行从代码库中检索数据的特定命令）。</td></tr></tbody></table>
<h3 data-id="heading-11">总结：给 AI 装上“方向盘”</h3>
<p>回到一开始的问题：<strong>不，我们并不是在重复造轮子。我们只是意识到：一辆车想开得好，光有轮子不够——还得有</strong>方向盘和<strong>地图</strong>。
“Agent Tools”确实释放了很强的能力：它们让 AI 能接触真实世界、查询数据库、执行代码。但<strong>有能力</strong>不等于<strong>会做事、做得对</strong>。
Skills.md 正是用来补上“能做”和“做得好”之间的差距。</p>
<ul>
<li><strong>Tools</strong>解决的是“怎么执行”的问题：点按钮、调接口、跑代码。</li>
<li><strong>Skills</strong>解决的是“怎么做才对”的问题：流程、上下文、细节拿捏与判断。</li>
</ul>
<p>当我们走向更自动化的智能体时，真正的瓶颈往往不是“它能不能做这个动作”，而是“它知不知道你们团队规定的、那个<strong>明确的 10 步标准流程</strong>，并按要求做到位”。把“<strong>怎么做（Skills，方法与规范）</strong> ”和“<strong>能做什么（Tools，执行能力）</strong> ”分开后，智能体就不只是强大，还会更<strong>可靠、合规、高效</strong>。</p>
<p>如果你只是做一些简单机器人，可能工具就够用；但如果你要做的是“数字员工”，那就必须要有技能（Skills）。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Skip 开源：从“卖工具”到“卖信任”的豪赌 -- 肘子的 Swift 周报 #120]]></title>    <link>https://juejin.cn/post/7599551824548102170</link>    <guid>https://juejin.cn/post/7599551824548102170</guid>    <pubDate>2026-01-27T00:13:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599551824548102170" data-draft-id="7598563188112408628" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Skip 开源：从“卖工具”到“卖信任”的豪赌  -- 肘子的 Swift 周报 #120"/> <meta itemprop="keywords" content="Swift,SwiftUI,人工智能"/> <meta itemprop="datePublished" content="2026-01-27T00:13:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="东坡肘子"/> <meta itemprop="url" content="https://juejin.cn/user/1548526032528727"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Skip 开源：从“卖工具”到“卖信任”的豪赌  -- 肘子的 Swift 周报 #120
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1548526032528727/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    东坡肘子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T00:13:32.000Z" title="Tue Jan 27 2026 00:13:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b11674cfc1bc4751bbf23cc5921a6ded~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lic5Z2h6IKY5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770077612&amp;x-signature=9RC%2FMUBymc7beiCja1OVV9MNfe4%3D" alt="issue120.webp" loading="lazy"/></p>
<h2 data-id="heading-0">Skip 开源：从“卖工具”到“卖信任”的豪赌</h2>
<p>在宣布 <a href="https://link.juejin.cn?target=https%3A%2F%2Ffatbobman.com%2Fzh%2Fweekly%2Fissue-110%2F" target="_blank" title="https://fatbobman.com/zh/weekly/issue-110/" ref="nofollow noopener noreferrer">Fuse 版本对独立开发者免费</a> 仅两个月后，Skip Tools 再次做出惊人之举——<a href="https://link.juejin.cn?target=https%3A%2F%2Fskip.dev%2Fblog%2Fskip-is-free%2F%3Futm_source%3Dfatbobman%2520weekly%2520issue%2520120%26utm_medium%3Dweb" target="_blank" title="https://skip.dev/blog/skip-is-free/?utm_source=fatbobman%20weekly%20issue%20120&amp;utm_medium=web" ref="nofollow noopener noreferrer">全面免费并开源核心引擎 skipstone</a>。这意味着 Skip 彻底改变了经营方式：从“卖产品”转向“卖服务+社区赞助”。这次变化，既有对之前商业模式执行不佳而被迫调整的无奈，也体现了 Skip 团队的果敢——在当前 AI 盛行、开发工具格局固化的背景下，主动求变，力求突破。</p>
<p>很多优秀且有特点的产品没能获得应有的使用量，最大的阻碍往往不是技术，而是“信任”。正如 Skip 官方所言，企业最担心的是“rug pull”——万一公司倒闭或被收购，押注在这个工具上的产品和技术栈将面临推倒重来的风险。Skip 希望通过开源消除这种信任危机，让自己和其他跨平台工具站在同一起跑线上，同时激活社区力量，加速生态建设。</p>
<p>尽管社区对 Skip 的开源决定给予了充分肯定，但也有不少人担心：在放弃了 license key 这一稳定收入来源后，仅靠赞助模式能否支撑持续开发成本？毕竟，成功的开源商业案例虽有，但失败的也不少。这种担忧并非杞人忧天。在我撰写本期周报时（宣布开源数天后），尽管开源消息在社交媒体上引发了热议，但在 GitHub 上，Skip 的个人赞助者仅有十几位。从“热闹的讨论”到“真金白银的支持”，中间的鸿沟似乎比想象中还要深。这或许也解释了为什么 Skip 最终选择了开源——在无法说服开发者"付费使用"时，至少要争取到他们"免费使用"的机会。</p>
<p>一个有趣的现象是，在肯定与忧虑并存的情绪中，讨论的焦点悄然发生了变化：从“为什么要花钱买 Skip 而不是用免费的 KMP?”变成了“你是更喜欢写 Swift 还是 Kotlin?”。这个转变意义重大——它意味着 Skip 已经成功将竞争维度从“商业模式”转移到了“语言生态”，而参与竞争的主体也从“一家小公司”扩展为“整个 Swift 社区”。在这场语言之争中，Skip 聪明地（或许是无意间）将自己的角色从“主角”变成了“基础设施”。</p>
<p>Skip 最早的出发点是看到了一个商业机会，认为有足够的商业回报。如果不是有这样的预期，仅靠官方或社区的力量，Swift 可能无法快速推进在其他平台上的进展。这一路径与 The Browser Company 为了打造 Arc 浏览器而大力推动 Swift 在 Windows 平台上的适配如出一辙。</p>
<p>作为一个 Swift 开发者，我由衷希望 Skip 的这次调整能够取得预期效果。开源是一场信任的实验，也是一次生态的投资。如果你也期待 Swift 能在 iOS 之外的平台上拥有更多可能，不妨从成为一个<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsponsors%2Fskiptools" target="_blank" title="https://github.com/sponsors/skiptools" ref="nofollow noopener noreferrer">独立赞助者</a>($10/月)做起——这不仅是对 Skip 的支持，更是对整个 Swift 跨平台生态的投票。开源的 Skip 能走多远，取决于有多少人愿意从旁观者变成参与者。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Ffatbobman.com%2Fzh%2Fweekly%2Fissue-120%2F" target="_blank" title="https://fatbobman.com/zh/weekly/issue-120/" ref="nofollow noopener noreferrer">本期内容</a> | <a href="https://link.juejin.cn?target=https%3A%2F%2Ffatbobman.com%2Fzh%2Fweekly%2Fissue-119%2F" target="_blank" title="https://fatbobman.com/zh/weekly/issue-119/" ref="nofollow noopener noreferrer">前一期内容</a> | <a href="https://link.juejin.cn?target=https%3A%2F%2Ffatbobman.com%2Fzh%2Fweekly%2F" target="_blank" title="https://fatbobman.com/zh/weekly/" ref="nofollow noopener noreferrer">全部周报列表</a></p>
<blockquote>
<p>🚀 <strong>《肘子的 Swift 周报》</strong></p>
<p>每周为你精选最值得关注的 Swift、SwiftUI 技术动态</p>
<ul>
<li><strong>📮 立即订阅</strong> | <a href="https://link.juejin.cn?target=https%3A%2F%2Fweekly.fatbobman.com%2Ffatbobman" target="_blank" title="https://weekly.fatbobman.com/fatbobman" ref="nofollow noopener noreferrer">weekly.fatbobman.com</a> 获取完整内容</li>
<li><strong>👥 加入社区</strong> | <a href="https://link.juejin.cn?target=https%3A%2F%2Fdiscord.com%2Finvite%2F7FedN5E2QQ" target="_blank" title="https://discord.com/invite/7FedN5E2QQ" ref="nofollow noopener noreferrer">Discord</a> 与 2000+ 开发者交流</li>
<li><strong>📚 深度教程</strong> | <a href="https://link.juejin.cn?target=http%3A%2F%2Ffatbobman.com" target="_blank" title="http://fatbobman.com" ref="nofollow noopener noreferrer">fatbobman.com</a> 探索 200+ 原创文章</li>
</ul>
</blockquote>
<h2 data-id="heading-1">原创</h2>
<h3 data-id="heading-2"><a href="https://link.juejin.cn?target=https%3A%2F%2Ffatbobman.com%2Fzh%2Fposts%2Fletting-swift-closures-automatically-inherit-isolation%2F%3Futm_source%3Dfatbobman%2520weekly%2520issue%2520120%26utm_medium%3Dweb" target="_blank" title="https://fatbobman.com/zh/posts/letting-swift-closures-automatically-inherit-isolation/?utm_source=fatbobman%20weekly%20issue%20120&amp;utm_medium=web" ref="nofollow noopener noreferrer">isolated(any) 与 #isolation：让 Swift 闭包自动继承隔离域</a></h3>
<p>Swift 6 为并发引入了许多新功能与关键字。虽然其中不少内容在日常开发中可能鲜少用到，但一旦遭遇特定场景，若对这些新概念缺乏了解，即便有 AI 辅助也可能陷入僵局。本文将通过一个在开发测试中遇到的实际并发问题，来介绍如何利用 <strong><code>@isolated(any)</code></strong> 以及 <strong><code>#isolation</code></strong> 宏，实现函数的隔离域继承，从而让编译器自动推断闭包的运行环境。</p>
<h2 data-id="heading-3">近期推荐</h2>
<h3 data-id="heading-4"><a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fw0120-01" target="_blank" title="https://l.fatbobman.com/w0120-01" ref="nofollow noopener noreferrer">SwiftData 数据迁移全解析 (A Deep Dive into SwiftData migrations)</a></h3>
<p>随着应用的发展，数据模型几乎无可避免地会出现变化，如何安全地进行数据迁移对很多开发者来说都是一个不小的挑战。在本文中，<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fdonnywals" target="_blank" title="https://x.com/donnywals" ref="nofollow noopener noreferrer">Donny Wals</a> 全面讲解了 SwiftData 的数据迁移机制，从基础的版本控制到复杂的自定义迁移策略。其中，Donny 给出了几个特别有价值的建议：即使是 V1 版本也应该使用 <code>VersionedSchema</code> 进行封装，为未来的迁移打好基础；只在 App Store 发布周期之间引入新的 Schema 版本，而不是在开发过程中频繁修改；对于轻量迁移，即使 SwiftData 可以自动完成，也建议显式地写入 <code>SchemaMigrationPlan</code> 中，使意图更加明确且易于测试。</p>
<p>文章的一大亮点是详细解释了 <code>MigrationStage.custom</code> 中 <code>willMigrate</code> 与 <code>didMigrate</code> 的适用场景，并提出了应对复杂重构（例如拆分实体）的“桥接版本（Bridge Version）”策略。</p>
<hr/>
<h3 data-id="heading-5"><a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fw0120-02" target="_blank" title="https://l.fatbobman.com/w0120-02" ref="nofollow noopener noreferrer">为什么 MVVM-C 在 SwiftUI 项目中依然能扩展 (Why MVVM-C with Coordinators does Scale -&gt; A real-world SwiftUI perspective)</a></h3>
<p>尽管标题中包含“MVVM-C”，但这并非一篇单纯为某种架构模式辩护的文章。<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.linkedin.com%2Fin%2Fvalentebruno%2F" target="_blank" title="https://www.linkedin.com/in/valentebruno/" ref="nofollow noopener noreferrer">Bruno Valente Pimentel</a> 在文中重新定义了“扩展性”的内涵——它不应仅以屏幕或文件的数量来衡量，而应看其是否支持高效的多人协作及功能的独立演进。正如作者所言：“架构无关乎模式，而关乎减少恐惧”——减少修改代码、团队协作以及功能演进时的恐惧。</p>
<blockquote>
<p>无论你倾向于哪种架构模式，在用它构建 SwiftUI 项目时，都应该认真思考：我们到底是在利用 SwiftUI 的特性，还是在试图把 SwiftUI 改造成我们熟悉的 UIKit？</p>
</blockquote>
<hr/>
<h3 data-id="heading-6"><a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fw0120-03" target="_blank" title="https://l.fatbobman.com/w0120-03" ref="nofollow noopener noreferrer">TCA 架构的真实评估 (TCA (Composable Architecture): The Honest Review)</a></h3>
<p>继 Bruno 为 MVVM-C “正名”后，<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.linkedin.com%2Fin%2Fchandrawelim%2F" target="_blank" title="https://www.linkedin.com/in/chandrawelim/" ref="nofollow noopener noreferrer">Chandra Welim</a> 对另一个极具争议的架构——TCA 进行了客观评估。作者总结了 TCA 的五大优势（可预测的状态管理、优秀的可测试性、时间旅行调试、组合性、强类型安全）和五大挑战（学习曲线、样板代码、团队采纳、对简单应用过度设计、第三方依赖），同时给出了务实的建议：TCA 是一个强大的工具，但绝非适用于所有场景。对于简单的 MVP 或缺乏函数式编程背景的团队，传统的 MVVM 或许是更务实的选择；而对于状态错综复杂、需要“时间旅行”调试的大型项目，TCA 则能提供无与伦比的掌控力。核心结论：TCA 在你需要时很值得，但大多数应用并不需要它。</p>
<blockquote>
<p>架构选择没有银弹，只有在特定上下文中的权衡。</p>
</blockquote>
<hr/>
<h3 data-id="heading-7"><a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fw0120-04" target="_blank" title="https://l.fatbobman.com/w0120-04" ref="nofollow noopener noreferrer">让 C 库在 Swift 中“像原生 API 一样好用” (Improving the usability of C libraries in Swift)</a></h3>
<p>Swift 虽然生来就兼容 C，但直接调用 C API 往往体验不佳——开发者通常需要面对裸指针、手动内存管理以及不符合 Swift 命名习惯的函数。为了获得“原生”体验，开发者不得不编写和维护繁琐的 Wrapper 层。在这篇文章中，<a href="https://link.juejin.cn?target=https%3A%2F%2Fsfba.social%2F%40dgregor79" target="_blank" title="https://sfba.social/@dgregor79" ref="nofollow noopener noreferrer">Doug Gregor</a> 详细介绍了如何利用 API Notes 和 Clang Attributes 机制，在不修改 C 库实现代码的前提下，“指导” Swift 编译器生成符合 Swift 风格的接口。</p>
<p>这项改进的意义在于，它将“封装 C 库”的成本从逻辑层（编写 Swift 胶水代码）转移到了声明层（编写 API Notes 或添加头文件注解）。这对于 Embedded Swift 的普及至关重要，因为嵌入式开发高度依赖现有的 C 库生态。随着工具链的完善，未来开发者可能只需要给 C 库加几个注解，就能直接在 Swift 中像使用原生库一样调用它。文章还提供了基于正则表达式的自动化脚本，可以为结构化的 C 头文件批量生成 API Notes。</p>
<hr/>
<h3 data-id="heading-8"><a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fw0120-05" target="_blank" title="https://l.fatbobman.com/w0120-05" ref="nofollow noopener noreferrer">在 Yocto 系统中构建 Swift (Introduction to Building Swift for Yocto)</a></h3>
<p>对于大多数 iOS 开发者来说，Yocto 可能比较陌生，但它是嵌入式 Linux 领域的事实标准——它能够精确控制系统中包含的每一个组件。随着 Embedded Swift 的推进，如何在 Yocto 生态中集成 Swift 成为了一个关键问题。<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fxtremekforever" target="_blank" title="https://x.com/xtremekforever" ref="nofollow noopener noreferrer">Jesse L. Zamora</a> 详细演示了如何使用近期重获更新的 <code>meta-swift</code> 在 Yocto 系统中构建 Swift 运行环境。文章以 Raspberry Pi Zero 2 为例，从 Docker 环境搭建、Yocto 构建、镜像烧录到实际运行，演示了完整的工作流。</p>
<p>需要注意的是，完整构建过程需要数小时，且要求对 Yocto 构建系统有基本了解。不过，文章提供的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fswift-embedded-linux%2Fmeta-swift-examples" target="_blank" title="https://github.com/swift-embedded-linux/meta-swift-examples" ref="nofollow noopener noreferrer">meta-swift-examples</a> 仓库已经包含了 Docker 化的构建环境和一键脚本，大大降低了上手门槛。</p>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fjeremy-prater%2Fmeta-swift" target="_blank" title="https://github.com/jeremy-prater/meta-swift" ref="nofollow noopener noreferrer">meta-swift</a> 是 Swift 语言的 Yocto 层，此前曾长期停滞于 Swift 5.7，但在社区的努力下，目前已支持到 Swift 6.1.3。</p>
</blockquote>
<hr/>
<h3 data-id="heading-9"><a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fw0120-06" target="_blank" title="https://l.fatbobman.com/w0120-06" ref="nofollow noopener noreferrer">让 Xcode 的 DEBUG 构建自动部署到 /Applications (TIL how to auto-move Xcode DEBUG builds to Applications)</a></h3>
<p>开发包含 App Intents 的应用时，你可能遇到过这个问题：App Intents 必须在 <code>/Applications</code> 目录下才能在 Shortcuts.app 中显示。这意味着 DEBUG 构建默认放在 DerivedData 中时，开发者无法测试 Shortcuts 集成。 <a href="https://link.juejin.cn?target=https%3A%2F%2Fnorden.social%2F%40czottmann" target="_blank" title="https://norden.social/@czottmann" ref="nofollow noopener noreferrer">Carlo Zottmann</a> 曾长期使用复杂的 Post-build 脚本来搬运 App，但他在本文中分享了一个更“原生”的方案——通过三行 <code>.xcconfig</code> 配置让 Xcode 自动将构建产物部署到指定目录，并在清理构建时正确删除已部署的文件。</p>
<blockquote>
<p>这个技巧不仅适用于 App Intents 测试，也适用于任何需要将 DEBUG 构建放到特定位置的场景。</p>
</blockquote>
<hr/>
<h3 data-id="heading-10"><a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fw0120-07" target="_blank" title="https://l.fatbobman.com/w0120-07" ref="nofollow noopener noreferrer">用 Swift Charts 构建自定义可交互仪表盘 (Visualise anything with SwiftUI Charts)</a></h3>
<p>如果你需要自定义一个可动画、可交互的环形压力仪表盘（Stress Indicator）的 SwiftUI 组件，你会如何进行？是使用 Shape，还是 Canvas？<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.linkedin.com%2Fin%2Fkyryl-horbushko-67936bb5%2F" target="_blank" title="https://www.linkedin.com/in/kyryl-horbushko-67936bb5/" ref="nofollow noopener noreferrer">Kyryl Horbushko</a> 在本文中展示了一个非常有创意的解法——利用 Swift Charts 的 <code>SectorMark</code>，优雅且高效地实现了需求。</p>
<p>Kyryl 的实现打破了我们对 Swift Charts 仅用于“数据可视化”的刻板印象。对于需要开发健康类、金融类复杂 Dashboard 的开发者来说，这是一种极具参考价值的"降维打击"式方案——用数据可视化框架解决自定义 UI 问题，既减少代码量，又获得内置的动画和交互支持。</p>
<h2 data-id="heading-11">工具</h2>
<h3 data-id="heading-12"><a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fw0120-08" target="_blank" title="https://l.fatbobman.com/w0120-08" ref="nofollow noopener noreferrer">Commander：兼顾专注与灵活的 AI 编程体验</a></h3>
<p>我喜欢在 macOS 上使用 CLI 工具(Claude Code、Codex)，但原生终端应用的视觉体验实在不敢恭维，因此多数情况下我都在 VSCode 中通过插件来改善体验。然而，VSCode 的一个设计始终让我困扰：即便将 Claude Code 的对话栏最大化，AI 修改文件时仍会自动打开新的文件栏或窗口，打断既有的交互节奏。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fkrzyzanowskim" target="_blank" title="https://x.com/krzyzanowskim" ref="nofollow noopener noreferrer">Marcin Krzyżanowski</a> 开发的 macOS 原生应用 Commander 给了我一个新的选择。它提供了一个比终端更优的交互界面，同时保护了我的“心流”——文件只在需要时才开启，并能调用系统默认应用查看。Commander 目前支持 Claude Code 和 Codex，内置了 Git worktrees 和 Code diff 支持，且完全免费。它在终端的“专注”与 VSCode 的“灵活”之间，构建了一个绝佳的中间地带。</p>
<hr/>
<h3 data-id="heading-13"><a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fw0120-09" target="_blank" title="https://l.fatbobman.com/w0120-09" ref="nofollow noopener noreferrer">Oh My Agents: 统一管理所有 AI 编程助手的配置</a></h3>
<p>随着 Claude Code、Cursor、Codex、Windsurf 等 AI 编程助手的涌现，开发者面临着一个新问题：如何管理散落在各个项目中的 prompts、skills 和 rules? 每个 Agent 都有自己的配置规范(<code>CLAUDE.md</code>、<code>CURSOR.md</code>...)，手动复制粘贴不仅低效，还容易导致版本混乱。<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fonevcat" target="_blank" title="https://x.com/onevcat" ref="nofollow noopener noreferrer">王巍(onevcat)</a> 开发的 Oh My Agents 提供了解决方案。</p>
<p>核心功能:</p>
<ul>
<li>集中管理所有 AI Agent 配置</li>
<li>定义分发规则，一键同步到多个项目</li>
<li>双向同步，项目改进可拉回中央库并更新所有关联项目</li>
<li>预览变更，避免意外覆盖</li>
</ul>
<p>注：目前仅支持 macOS (Windows/Linux 开发中)，Beta 期间免费。</p>
<h2 data-id="heading-14">往期内容</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ffatbobman.com%2Fzh%2Fweekly%2Fissue-119%2F" target="_blank" title="https://fatbobman.com/zh/weekly/issue-119/" ref="nofollow noopener noreferrer">从 Anthropic 封杀与苹果谷歌结盟，看 AI 护城河的构建 - #119</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ffatbobman.com%2Fzh%2Fweekly%2Fissue-118%2F" target="_blank" title="https://fatbobman.com/zh/weekly/issue-118/" ref="nofollow noopener noreferrer">AT 的人生未必比 MT 更好- #118</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fhttps%3A%2F%2Ffatbobman.com%2Fzh%2Fweekly%2Fissue-117%2F" target="_blank" title="https://https://fatbobman.com/zh/weekly/issue-117/" ref="nofollow noopener noreferrer">2026：当 AI 隐入工作流，你准备好了吗？- #117</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ffatbobman.com%2Fzh%2Fweekly%2Fissue-116%2F" target="_blank" title="https://fatbobman.com/zh/weekly/issue-116/" ref="nofollow noopener noreferrer">Swift、SwiftUI 与 SwiftData：走向成熟的 2025 - #116</a></li>
</ul>
<h2 data-id="heading-15">💝 支持与反馈</h2>
<p>如果本期周报对你有帮助，请：</p>
<ul>
<li>👍 <strong>点赞</strong> - 让更多开发者看到</li>
<li>💬 <strong>评论</strong> - 分享你的看法或问题</li>
<li>🔄 <strong>转发</strong> - 帮助同行共同成长</li>
</ul>
<hr/>
<blockquote>
<p>🚀 <strong>拓展 Swift 视野</strong></p>
<ul>
<li><strong>📮 邮件订阅</strong> | <a href="https://link.juejin.cn?target=https%3A%2F%2Fweekly.fatbobman.com%2Fwelcome" target="_blank" title="https://weekly.fatbobman.com/welcome" ref="nofollow noopener noreferrer">weekly.fatbobman.com</a> 获取独家技术洞察</li>
<li><strong>👥 开发者社区</strong> | <a href="https://link.juejin.cn?target=https%3A%2F%2Fdiscord.com%2Finvite%2F7FedN5E2QQ" target="_blank" title="https://discord.com/invite/7FedN5E2QQ" ref="nofollow noopener noreferrer">Discord</a> 实时交流开发经验</li>
<li><strong>📚 原创教程</strong> | <a href="https://link.juejin.cn?target=http%3A%2F%2Ffatbobman.com" target="_blank" title="http://fatbobman.com" ref="nofollow noopener noreferrer">fatbobman.com</a> 学习 Swift/SwiftUI 最佳实践</li>
</ul>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot开发必知的8个高效技巧：让你的生产力翻倍！]]></title>    <link>https://juejin.cn/post/7599580550295552035</link>    <guid>https://juejin.cn/post/7599580550295552035</guid>    <pubDate>2026-01-27T00:17:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599580550295552035" data-draft-id="7599586891084070946" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot开发必知的8个高效技巧：让你的生产力翻倍！"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2026-01-27T00:17:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot开发必知的8个高效技巧：让你的生产力翻倍！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T00:17:33.000Z" title="Tue Jan 27 2026 00:17:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>SpringBoot开发必知的8个高效技巧：让你的生产力翻倍！</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>SpringBoot 作为 Java 生态中最受欢迎的框架之一，以其“约定优于配置”的理念和开箱即用的特性，极大地简化了 Spring 应用的开发。然而，随着项目规模的扩大和复杂度的提升，如何高效利用 SpringBoot 的特性成为开发者必须面对的挑战。本文将分享 <strong>8 个 SpringBoot 高效开发技巧</strong>，涵盖配置优化、调试技巧、性能调优等方向，帮助开发者显著提升生产力。</p>
<hr/>
<h2 data-id="heading-2">1. 合理使用 <code>@ConfigurationProperties</code> 替代 <code>@Value</code></h2>
<h3 data-id="heading-3">问题背景</h3>
<p>在 SpringBoot 中，<code>@Value</code> 注解常用于读取配置文件中的属性，但随着配置项增多，代码会变得臃肿且难以维护。</p>
<h3 data-id="heading-4">解决方案</h3>
<p>使用 <code>@ConfigurationProperties</code> 将相关配置绑定到一个 POJO 类中：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@ConfigurationProperties(prefix = "app.datasource")</span>
<span class="hljs-meta">@Data</span> <span class="hljs-comment">// Lombok 注解</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSourceConfig</span> {
    <span class="hljs-keyword">private</span> String url;
    <span class="hljs-keyword">private</span> String username;
    <span class="hljs-keyword">private</span> String password;
}
</code></pre>
<p><strong>优势</strong>：</p>
<ul>
<li><strong>类型安全</strong>：避免 <code>@Value</code> 的字符串硬编码问题。</li>
<li><strong>集中管理</strong>：相关配置项聚合在一个类中，便于维护。</li>
<li><strong>IDE 支持</strong>：自动补全和校验。</li>
</ul>
<h3 data-id="heading-5">进阶技巧</h3>
<p>结合 <code>@Validated</code> 实现配置校验：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@ConfigurationProperties(prefix = "app.datasource")</span>
<span class="hljs-meta">@Validated</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSourceConfig</span> {
    <span class="hljs-meta">@NotBlank</span>
    <span class="hljs-keyword">private</span> String url;
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<hr/>
<h2 data-id="heading-6">2. 利用 Spring Profiles 实现环境隔离</h2>
<h3 data-id="heading-7">场景需求</h3>
<p>不同环境（开发、测试、生产）需要不同的配置（如数据库连接、日志级别）。</p>
<h3 data-id="heading-8">实现方式</h3>
<ol>
<li><strong>定义 Profile-specific 配置文件</strong>：
<ul>
<li><code>application-dev.yml</code>（开发环境）</li>
<li><code>application-prod.yml</code>（生产环境）</li>
</ul>
</li>
<li><strong>激活 Profile</strong>：
<ul>
<li>命令行参数：<code>--spring.profiles.active=dev</code></li>
<li>环境变量：<code>SPRING_PROFILES_ACTIVE=prod</code></li>
</ul>
</li>
</ol>
<h3 data-id="heading-9">最佳实践</h3>
<ul>
<li><strong>默认配置</strong>：将通用配置放在 <code>application.yml</code>，环境相关配置单独拆分。</li>
<li><strong>Profile Groups</strong>（SpringBoot 2.4+）：通过 <code>spring.profiles.group.&lt;group-name&gt;</code> 组合多个 Profile。</li>
</ul>
<hr/>
<h2 data-id="heading-10">3. Lombok + MapStruct：告别样板代码</h2>
<h3 data-id="heading-11">Lombok：简化 POJO</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Data</span>
<span class="hljs-meta">@Builder</span>
<span class="hljs-meta">@NoArgsConstructor</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> String name;
}
</code></pre>
<h3 data-id="heading-12">MapStruct：高效 DTO 转换</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Mapper(componentModel = "spring")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserMapper</span> {
    UserDTO <span class="hljs-title function_">toDTO</span><span class="hljs-params">(User user)</span>;
    User <span class="hljs-title function_">fromDTO</span><span class="hljs-params">(UserDTO dto)</span>;
}
</code></pre>
<p><strong>优势</strong>：编译时生成代码，零运行时开销。</p>
<hr/>
<h2 data-id="heading-13">4. SpringBoot DevTools：热部署与快速重启</h2>
<h3 data-id="heading-14">核心功能</h3>
<ul>
<li><strong>自动重启</strong>：修改类文件后触发应用重启（比手动重启快得多）。</li>
<li><strong>LiveReload</strong>：前端资源修改后浏览器自动刷新。</li>
<li><strong>全局配置</strong>：通过 <code>spring.devtools.restart.enabled=false</code> 禁用（生产环境需关闭）。</li>
</ul>
<h3 data-id="heading-15">VS Code/HotSwapAgent？</h3>
<p>DevTools + JRebel（商用插件）可实现更彻底的热替换（如方法体修改无需重启）。</p>
<hr/>
<h2 data-id="heading-16">5. Actuator + Micrometer ：监控与指标收集</h2>
<h3 data-id="heading-17">SpringBoot Actuator</h3>
<p>暴露应用健康、指标、日志等端点：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">management:</span>
 <span class="hljs-attr">endpoints:</span>
   <span class="hljs-attr">web:</span>
     <span class="hljs-attr">exposure:</span>
       <span class="hljs-attr">include:</span> <span class="hljs-string">health,metrics,info</span>
</code></pre>
<h3 data-id="heading-18">Micrometer ：统一监控指标</h3>
<p>集成 Prometheus/Grafana：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Bean</span>
MeterRegistryCustomizer&lt;PrometheusMeterRegistry&gt; <span class="hljs-title function_">metricsCommonTags</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> registry -&gt; registry.config().commonTags(<span class="hljs-string">"application"</span>, <span class="hljs-string">"my-app"</span>);
}
</code></pre>
<hr/>
<p>##10分钟快速入门 Elasticsearch</p>
<p>Elasticsearch是一个分布式搜索和分析引擎,基于Lucene构建,能够以近实时的速度存储、搜索和分析海量数据。</p>
<p>本文将通过简单示例带你快速上手Elasticsearch的核心功能。</p>
<p>1.安装与运行</p>
<p>下载并解压Elasticsearch(本文以7.x版本为例)</p>
<p>./bin/elasticsearch #启动单节点集群</p>
<p>验证是否运行成功: curl -X GET "localhost:9200/"</p>
<p>2.基本概念</p>
<p>索引(Index):类似数据库中的表</p>
<p>文档(Document):索引中的基本单位,相当于表中的行</p>
<p>3.CRUD操作</p>
<p>创建索引:</p>
<p>PUT /products</p>
<p>插入文档:</p>
<p>POST /products/_doc/1
{
"name":"iPhone",
"price":6999,
"description":"Apple smartphone"
}</p>
<p>查询文档:</p>
<p>GET /products/_doc/1</p>
<p>搜索文档:</p>
<p>GET /products/_search?q=name:iPhone</p>
<p>4.简单搜索</p>
<p>使用DSL进行条件查询:</p>
<p>GET /products/_search
{
"query":{
"match":{
"description":"smartphone"
}
}
}</p>
<p>5.聚合分析</p>
<p>统计价格分布:</p>
<p>GET /products/_search
{
"aggs":{
"price_stats":{
"stats":{"field":"price"}
}
}
}</p>
<p>总结:通过以上基础操作,您已经可以开始使用Elasticsearch进行数据存储和检索了。</p>
<p>下一步建议学习:
-更复杂的查询语法
-索引映射设计
-集群管理
-性能优化</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[slidev-addon-infographic 年终总结程序员必备的PPT精美图表]]></title>    <link>https://juejin.cn/post/7599581687357784114</link>    <guid>https://juejin.cn/post/7599581687357784114</guid>    <pubDate>2026-01-27T00:40:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599581687357784114" data-draft-id="7599565587153059866" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="slidev-addon-infographic 年终总结程序员必备的PPT精美图表"/> <meta itemprop="keywords" content="前端,程序员,Vue.js"/> <meta itemprop="datePublished" content="2026-01-27T00:40:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="fxss"/> <meta itemprop="url" content="https://juejin.cn/user/3702810892856808"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            slidev-addon-infographic 年终总结程序员必备的PPT精美图表
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3702810892856808/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    fxss
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T00:40:33.000Z" title="Tue Jan 27 2026 00:40:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fslidev-addon-infographic" target="_blank" title="https://www.npmjs.com/package/slidev-addon-infographic" ref="nofollow noopener noreferrer">slidev-addon-infographic</a> 是为了在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcn.sli.dev%2F" target="_blank" title="https://cn.sli.dev/" ref="nofollow noopener noreferrer">Slidev</a> 中快速添加 <a href="https://link.juejin.cn?target=https%3A%2F%2Finfographic.antv.vision%2F" target="_blank" title="https://infographic.antv.vision/" ref="nofollow noopener noreferrer">@antv/infographic</a> 图表而设计的插件。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcn.sli.dev%2F" target="_blank" title="https://cn.sli.dev/" ref="nofollow noopener noreferrer">Slidev</a> 是为开发者打造的演示文稿工具，它基于 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcn.vuejs.org%2F" target="_blank" title="https://cn.vuejs.org/" ref="nofollow noopener noreferrer">Vue3</a> 并集成了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.markdown.cn%2Fdocs%2Fintro%2F" target="_blank" title="https://www.markdown.cn/docs/intro/" ref="nofollow noopener noreferrer">Markdown</a> 语法，使得创建演示文稿变得简单快捷，并支持导出 PPTX, PNG, PDF 格式。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Finfographic.antv.vision%2F" target="_blank" title="https://infographic.antv.vision/" ref="nofollow noopener noreferrer">@antv/infographic</a> 是新一代声明式信息图可视化引擎，提供上百种图表类型，包括但不限于 图表型、对比型、层级型、列表型、四象限型、关系型、顺序型 等，补足程序员写PPT的短板。</p>
<h2 data-id="heading-0">创建 Slidev 项目</h2>
<pre><code class="hljs language-bash" lang="bash">npm init slidev@latest
</code></pre>
<pre><code class="hljs language-bash" lang="bash">pnpm create slidev
</code></pre>
<pre><code class="hljs language-bash" lang="bash">yarn create slidev
</code></pre>
<h2 data-id="heading-1">添加 slidev-addon-infographic 插件</h2>
<pre><code class="hljs language-bash" lang="bash">npm install slidev-addon-infographic
</code></pre>
<pre><code class="hljs language-bash" lang="bash">pnpm install slidev-addon-infographic
</code></pre>
<pre><code class="hljs language-bash" lang="bash">yarn add slidev-addon-infographic
</code></pre>
<p>将下面内容添加到项目 <code>package.json</code> 文件中：</p>
<pre><code class="hljs language-json" lang="json">...
  <span class="hljs-attr">"slidev"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"addons"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"slidev-addon-infographic"</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
...
</code></pre>
<p>接下来就可以在 Slidev 项目中使用 <code>@antv/infographic</code> 图表了。</p>
<pre><code class="hljs language-md" lang="md">---
addons:
<span class="hljs-section">  - slidev-addon-infographic
---</span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">InfographicBox</span> <span class="hljs-attr">:data</span>=<span class="hljs-string">"`infographic list-row-simple-horizontal-arrow
data
  items
    - label 步骤 1
      desc 开始
    - label 步骤 2
      desc 进行中
    - label 步骤 3
      desc 完成
`"</span>&gt;</span></span><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">InfographicBox</span>&gt;</span></span>
</code></pre>





























<table><thead><tr><th>参数</th><th>描述</th><th>类型</th><th>默认值</th></tr></thead><tbody><tr><td><code>data</code></td><td>信息图数据</td><td>string</td><td>-</td></tr><tr><td><code>click</code></td><td>是否响应<a href="https://link.juejin.cn?target=https%3A%2F%2Fcn.sli.dev%2Fguide%2Fanimations%23click-animation" target="_blank" title="https://cn.sli.dev/guide/animations#click-animation" ref="nofollow noopener noreferrer">Slidev点击动画</a>，如果设置为 <code>true</code>，需要在 <code>frontmatter</code> 中添加 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcn.sli.dev%2Fguide%2Fanimations%23total" target="_blank" title="https://cn.sli.dev/guide/animations#total" ref="nofollow noopener noreferrer"><code>clicks</code></a> 字段，值为点击次数。</td><td><code>boolean</code></td><td><code>false</code></td></tr><tr><td><code>isExportPdf</code></td><td>是否导出 PDF 格式。导出时会默认将 <code>click</code> 设置为 <code>false</code>。</td><td><code>boolean</code></td><td><code>false</code></td></tr></tbody></table>
<ol>
<li>如需导出 PDF 格式，请为 <code>InfographicBox</code> 组件增加 <code>isExportPdf</code> 属性，导出的时候会默认将 <code>click</code> 设置为 <code>false</code> 。</li>
<li><code>click</code> 主要用于演示效果，<code>click</code> 为 <code>true</code> 时，需要单独占一页，设置 <code>click</code> 为 <code>true</code> 后，并添加 <code>clicks</code> 点击次数之后的效果需要自行点击确认。</li>
</ol>
<p>我们可以在 <a href="https://link.juejin.cn?target=https%3A%2F%2Finfographic.antv.vision%2Feditor" target="_blank" title="https://infographic.antv.vision/editor" ref="nofollow noopener noreferrer">@antv/infographic 编辑器</a> 中设计出符合需求的图表，然后将其复制到 Slidev 项目中。</p>
<p>下面是我的公众号，欢迎关注。关注后有新的功能点会及时收到推送。</p>
<blockquote>
<p>实战为王！专注于汇总各种功能点，致力于打造一系列能够帮助工程师实现各种功能的想法思路的优质文章。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4bdeec99a0154e7aa73c1c6765f3dcf0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZnhzcw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770079232&amp;x-signature=97dS2VZSuWIQ6aD4kgiTmSBLnH0%3D" alt="前端功能点" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[剑指offer-68、调整数组顺序使奇数位于偶数前⾯(⼆)]]></title>    <link>https://juejin.cn/post/7599565587153092634</link>    <guid>https://juejin.cn/post/7599565587153092634</guid>    <pubDate>2026-01-27T00:42:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599565587153092634" data-draft-id="7598459769238487074" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 剑指offer-68、调整数组顺序使奇数位于偶数前⾯(⼆)"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2026-01-27T00:42:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SevenCoding"/> <meta itemprop="url" content="https://juejin.cn/user/3261615728242467"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             剑指offer-68、调整数组顺序使奇数位于偶数前⾯(⼆)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3261615728242467/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SevenCoding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T00:42:41.000Z" title="Tue Jan 27 2026 00:42:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">题⽬描述</h2>
<p>输⼊⼀个⻓度为 n 整数数组，数组⾥⾯可能含有相同的元素，实现⼀个函数来调整该数组中数字的顺序，使得所有的奇数位于数组的前⾯部分，所有的偶数位于数组的后⾯部分，对奇数和奇数，偶数和偶数之间的相对位置不做要求，但是时间复杂度和空间复杂度必须如下要求。</p>
<p>数据范围：0 ≤ n ≤ 50000，数组中每个数的值 0 ≤ val ≤ 10000</p>
<p>要求：时间复杂度 O(n)，空间复杂度 O(1)</p>
<p>示例 1
输⼊：[1,2,3,4]
返回值：[1,3,2,4]
说明：[3,1,2,4]或者[3,1,4,2]也是正确答案</p>
<p>示例 2
输⼊：[1,3,5,6,7]
返回值：[1,3,5,7,6]
说明：[3,1,5,7,6]等也是正确答案</p>
<h2 data-id="heading-1">思路及解答</h2>
<h3 data-id="heading-2">两次遍历</h3>
<p>第一次遍历收集奇数，第二次遍历收集偶数</p>
<p>这种方法虽然简单易懂，但需要额外空间，不符合题目要求</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span>[] reorderArray(<span class="hljs-type">int</span>[] nums) {
        <span class="hljs-keyword">if</span> (nums == <span class="hljs-literal">null</span> || nums.length == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">0</span>];
        }
        
        <span class="hljs-type">int</span>[] result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[nums.length];
        <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        
        <span class="hljs-comment">// 第一次遍历：收集所有奇数</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> num : nums) {
            <span class="hljs-keyword">if</span> (num % <span class="hljs-number">2</span> == <span class="hljs-number">1</span>) {
                result[index++] = num;
            }
        }
        
        <span class="hljs-comment">// 第二次遍历：收集所有偶数</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> num : nums) {
            <span class="hljs-keyword">if</span> (num % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>) {
                result[index++] = num;
            }
        }
        
        <span class="hljs-keyword">return</span> result;
    }
}
</code></pre>
<ul>
<li>时间复杂度：O(n)</li>
<li>空间复杂度：O(n)</li>
</ul>
<h3 data-id="heading-3">双指针交换（推荐）</h3>
<p>这道题需要奇数在⼀半，偶数在另外⼀半就可以，并没有要求他们之间的顺序，那么就可以⽤双指针，⼀个指针在左边，⼀个指针在右边，⽐如 1,3,5,6,7 :</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a377cbcbedcb45c4bacb197390f8e273~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770079361&amp;x-signature=0T7KzzUcW3RaH%2BoGm%2FZVsbfpfss%3D" alt="" loading="lazy"/></p>
<p>左指针往右遍历直到找到偶数，也就是 6 停下来，</p>
<p>右指针往左⾛，直到找到第⼀个奇数，也就是 7 停下来。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3797c48f718443b5852e1433026b7632~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770079361&amp;x-signature=%2BtVn%2B8k0EnxE4UKKVgZZ42T%2B5hk%3D" alt="" loading="lazy"/></p>
<p>两者交换:</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a28224f4090e4a549757e50c7eb463da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770079361&amp;x-signature=DdE7jFU2t%2BmOrPV%2FS%2BA8dClCU1o%3D" alt="" loading="lazy"/></p>
<p>左指针继续往右边⾛，两个指针相遇，结束，这个时候其实偶数已经全部在右边了。</p>
<p>这个例⼦⾥⾯只经过⼀次交换，如果是多次交换，那么结束的条件同样也是两个指针相遇。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span>[] reorderArray(<span class="hljs-type">int</span>[] nums) {
        <span class="hljs-keyword">if</span> (nums == <span class="hljs-literal">null</span> || nums.length &lt;= <span class="hljs-number">1</span>) {
            <span class="hljs-keyword">return</span> nums;
        }
        
        <span class="hljs-type">int</span> <span class="hljs-variable">left</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;                    <span class="hljs-comment">// 左指针，从数组开头开始</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">right</span> <span class="hljs-operator">=</span> nums.length - <span class="hljs-number">1</span>;     <span class="hljs-comment">// 右指针，从数组末尾开始</span>
        
        <span class="hljs-keyword">while</span> (left &lt; right) {
            <span class="hljs-comment">// 左指针向右移动，直到找到偶数</span>
            <span class="hljs-keyword">while</span> (left &lt; right &amp;&amp; nums[left] % <span class="hljs-number">2</span> == <span class="hljs-number">1</span>) {
                left++;
            }
            
            <span class="hljs-comment">// 右指针向左移动，直到找到奇数</span>
            <span class="hljs-keyword">while</span> (left &lt; right &amp;&amp; nums[right] % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>) {
                right--;
            }
            
            <span class="hljs-comment">// 如果左指针仍在右指针左边，交换奇偶数</span>
            <span class="hljs-keyword">if</span> (left &lt; right) {
                <span class="hljs-type">int</span> <span class="hljs-variable">temp</span> <span class="hljs-operator">=</span> nums[left];
                nums[left] = nums[right];
                nums[right] = temp;
                left++;
                right--;
            }
        }
        
        <span class="hljs-keyword">return</span> nums;
    }
}
</code></pre>
<ul>
<li><strong>时间复杂度</strong>：O(n)，每个元素最多被访问一次</li>
<li><strong>空间复杂度</strong>：O(1)，只使用了常数级别的额外空间</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[第7章、复合类型——数组、切片与映射（slice和map）]]></title>    <link>https://juejin.cn/post/7599538010725646363</link>    <guid>https://juejin.cn/post/7599538010725646363</guid>    <pubDate>2026-01-27T00:41:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599538010725646363" data-draft-id="7599581687357767730" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="第7章、复合类型——数组、切片与映射（slice和map）"/> <meta itemprop="keywords" content="后端,Go"/> <meta itemprop="datePublished" content="2026-01-27T00:41:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="怕浪猫"/> <meta itemprop="url" content="https://juejin.cn/user/2832784963939438"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            第7章、复合类型——数组、切片与映射（slice和map）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2832784963939438/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    怕浪猫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T00:41:45.000Z" title="Tue Jan 27 2026 00:41:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读20分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好～ 前面我们掌握了Go的基础类型和函数特性，今天进入Go编程的核心复合类型——数组、切片（slice）和映射（map）。这三种类型是Go中最常用的数据容器，支撑着绝大多数业务场景的数据存储与处理：数组是固定长度的基础序列，切片是动态扩容的“灵活数组”，map是键值对映射的无序集合。</p>
<p>本文会从“定义用法→底层原理→实战技巧→性能优化”四个维度，逐一拆解这三种复合类型。全程搭配可直接运行的代码示例，帮你搞懂每个知识点的本质，避开实际开发中的常见陷阱。无论你是刚入门的新手，还是需要夯实基础的开发者，这篇文章都能让你对Go的复合类型有透彻的理解。</p>
<h2 data-id="heading-0">1. 数组：固定长度的序列结构</h2>
<p>数组是Go中最基础的复合类型，本质是“固定长度、相同类型元素的连续序列”。其核心特点是<strong>长度固定</strong>——一旦定义，长度就无法修改。正因为长度固定，数组在实际开发中的直接使用场景不算多，但它是切片的底层基础，必须先掌握。</p>
<h3 data-id="heading-1">1.1 数组的定义与初始化</h3>
<p>数组的定义语法：<code>[长度]元素类型</code>。初始化方式有多种，根据场景灵活选择：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 1. 完整初始化：指定长度和所有元素</span>
    <span class="hljs-keyword">var</span> arr1 [<span class="hljs-number">3</span>]<span class="hljs-type">int</span> = [<span class="hljs-number">3</span>]<span class="hljs-type">int</span>{<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>}
    fmt.Println(<span class="hljs-string">"arr1:"</span>, arr1) <span class="hljs-comment">// 输出：arr1: [1 2 3]</span>

    <span class="hljs-comment">// 2. 省略长度（由初始化元素个数推导）</span>
    <span class="hljs-keyword">var</span> arr2 [<span class="hljs-number">3</span>]<span class="hljs-type">int</span> = [...]<span class="hljs-type">int</span>{<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>} <span class="hljs-comment">// ... 表示自动推导长度</span>
    fmt.Println(<span class="hljs-string">"arr2:"</span>, arr2) <span class="hljs-comment">// 输出：arr2: [4 5 6]</span>
    fmt.Printf(<span class="hljs-string">"arr2长度：%d\n"</span>, <span class="hljs-built_in">len</span>(arr2)) <span class="hljs-comment">// 输出：arr2长度：3</span>

    <span class="hljs-comment">// 3. 指定索引初始化（未指定的索引为零值）</span>
    <span class="hljs-keyword">var</span> arr3 [<span class="hljs-number">5</span>]<span class="hljs-type">string</span> = [<span class="hljs-number">5</span>]<span class="hljs-type">string</span>{<span class="hljs-number">0</span>: <span class="hljs-string">"a"</span>, <span class="hljs-number">2</span>: <span class="hljs-string">"c"</span>, <span class="hljs-number">4</span>: <span class="hljs-string">"e"</span>}
    fmt.Println(<span class="hljs-string">"arr3:"</span>, arr3) <span class="hljs-comment">// 输出：arr3: [a  ｃ  ｅ]（索引1、3为零值""）</span>

    <span class="hljs-comment">// 4. 简短声明（仅在函数内可用）</span>
    arr4 := [<span class="hljs-number">4</span>]<span class="hljs-type">float64</span>{<span class="hljs-number">1.1</span>, <span class="hljs-number">2.2</span>, <span class="hljs-number">3.3</span>, <span class="hljs-number">4.4</span>}
    fmt.Println(<span class="hljs-string">"arr4:"</span>, arr4) <span class="hljs-comment">// 输出：arr4: [1.1 2.2 3.3 4.4]</span>
}

</code></pre>
<h3 data-id="heading-2">1.2 数组的核心特性</h3>
<ul>
<li>
<p><strong>长度固定</strong>：长度是数组类型的一部分（如<code>[3]int</code>和<code>[5]int</code>是不同的类型），无法动态扩容或缩容；</p>
</li>
<li>
<p><strong>值类型</strong>：数组是值类型，赋值或传递参数时，会拷贝整个数组（而非指针），效率较低；</p>
</li>
<li>
<p><strong>连续内存</strong>：数组的元素在内存中是连续存储的，索引访问效率极高（O(1)时间复杂度）；</p>
</li>
<li>
<p><strong>支持索引访问</strong>：通过<code>arr[index]</code>访问元素，索引从0开始，超出范围会触发运行时错误（数组越界）。</p>
</li>
</ul>
<h3 data-id="heading-3">1.3 数组的实际应用场景</h3>
<p>由于长度固定和值拷贝的特性，数组直接使用场景较少，主要用于：</p>
<ul>
<li>
<p>存储固定长度的常量序列（如一周的7天、一年的12个月）；</p>
</li>
<li>
<p>作为切片的底层存储（切片本质是数组的“视图”）；</p>
</li>
<li>
<p>需要保证数据长度不变的场景（如固定大小的配置项）。</p>
</li>
</ul>
<h3 data-id="heading-4">1.4 最佳实践</h3>
<ul>
<li>
<p>传递大数组时，优先使用指针：避免拷贝整个数组，提升性能（如<code>func modifyArr(arr *[1000]int)</code>）；</p>
</li>
<li>
<p>不确定长度时，直接用切片：不要为了“预估长度”定义数组，后续无法扩容会限制使用；</p>
</li>
<li>
<p>利用数组的类型安全性：通过固定长度约束数据（如<code>[16]byte</code>表示16字节的UUID），避免数据长度错误。</p>
</li>
</ul>
<h2 data-id="heading-5">2. 切片：动态数组的底层实现</h2>
<p>切片（slice）是Go中最常用的复合类型，本质是“对数组的引用（视图）”，支持动态扩容，解决了数组长度固定的痛点。切片本身不是数组，它只是一个“描述符”，指向底层的数组。</p>
<h3 data-id="heading-6">2.1 切片的定义与初始化</h3>
<p>切片的定义语法：<code>[]元素类型</code>（无长度）。初始化方式比数组更灵活：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 1. 空切片（nil切片）：未指向任何底层数组</span>
    <span class="hljs-keyword">var</span> s1 []<span class="hljs-type">int</span>
    fmt.Println(<span class="hljs-string">"s1:"</span>, s1)          <span class="hljs-comment">// 输出：s1: []</span>
    fmt.Printf(<span class="hljs-string">"s1长度：%d，容量：%d\n"</span>, <span class="hljs-built_in">len</span>(s1), <span class="hljs-built_in">cap</span>(s1)) <span class="hljs-comment">// 输出：s1长度：0，容量：0</span>
    fmt.Printf(<span class="hljs-string">"s1是否为nil：%t\n"</span>, s1 == <span class="hljs-literal">nil</span>) <span class="hljs-comment">// 输出：s1是否为nil：true</span>

    <span class="hljs-comment">// 2. 用make初始化（最常用）：make([]类型, 长度, 容量)</span>
    s2 := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>) <span class="hljs-comment">// 长度3，容量5：底层数组长度5，当前使用前3个元素</span>
    fmt.Println(<span class="hljs-string">"s2:"</span>, s2)          <span class="hljs-comment">// 输出：s2: [0 0 0]（零值初始化）</span>
    fmt.Printf(<span class="hljs-string">"s2长度：%d，容量：%d\n"</span>, <span class="hljs-built_in">len</span>(s2), <span class="hljs-built_in">cap</span>(s2)) <span class="hljs-comment">// 输出：s2长度：3，容量：5</span>

    <span class="hljs-comment">// 3. 从数组/切片截取（核心用法）：s[start:end]（左闭右开，不包含end）</span>
    arr := [<span class="hljs-number">5</span>]<span class="hljs-type">int</span>{<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>}
    s3 := arr[<span class="hljs-number">1</span>:<span class="hljs-number">3</span>] <span class="hljs-comment">// 从arr索引1到3（不包含3），截取元素[2,3]</span>
    fmt.Println(<span class="hljs-string">"s3:"</span>, s3)          <span class="hljs-comment">// 输出：s3: [2 3]</span>
    fmt.Printf(<span class="hljs-string">"s3长度：%d，容量：%d\n"</span>, <span class="hljs-built_in">len</span>(s3), <span class="hljs-built_in">cap</span>(s3)) <span class="hljs-comment">// 输出：s3长度：2，容量：4（从start到原数组末尾）</span>

    <span class="hljs-comment">// 4. 直接初始化（类似数组，省略长度）</span>
    s4 := []<span class="hljs-type">string</span>{<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>}
    fmt.Println(<span class="hljs-string">"s4:"</span>, s4)          <span class="hljs-comment">// 输出：s4: [a b c]</span>
    fmt.Printf(<span class="hljs-string">"s4长度：%d，容量：%d\n"</span>, <span class="hljs-built_in">len</span>(s4), <span class="hljs-built_in">cap</span>(s4)) <span class="hljs-comment">// 输出：s4长度：3，容量：3</span>
}

</code></pre>
<h3 data-id="heading-7">2.2 核心概念：长度（len）与容量（cap）</h3>
<p>切片有两个关键属性：长度（len）和容量（cap），含义完全不同：</p>
<ul>
<li>
<p><strong>长度（len）</strong>：切片当前包含的元素个数（通过<code>len(s)</code>获取）；</p>
</li>
<li>
<p><strong>容量（cap）</strong>：切片指向的底层数组中，从切片起始索引到数组末尾的元素个数（通过<code>cap(s)</code>获取）；</p>
</li>
<li>
<p>关系：<code>0 ≤ len(s) ≤ cap(s)</code>，当len(s) == cap(s)时，切片已满，再添加元素会触发扩容。</p>
</li>
</ul>
<p>示意图（帮助理解）：</p>
<pre><code class="hljs language-Plain" lang="Plain">
底层数组：[1, 2, 3, 4, 5]（长度5）
切片s3 := arr[1:3]：
- 起始索引：1
- 长度：3-1=2（元素[2,3]）
- 容量：5-1=4（从索引1到数组末尾，共4个元素：2,3,4,5）

</code></pre>
<h3 data-id="heading-8">2.3 底层实现原理</h3>
<p>切片的底层是一个结构体（源码定义在<code>runtime/slice.go</code>中），包含三个字段：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">type</span> slice <span class="hljs-keyword">struct</span> {
    array unsafe.Pointer <span class="hljs-comment">// 指向底层数组的指针</span>
    <span class="hljs-built_in">len</span>   <span class="hljs-type">int</span>            <span class="hljs-comment">// 切片长度</span>
    <span class="hljs-built_in">cap</span>   <span class="hljs-type">int</span>            <span class="hljs-comment">// 切片容量</span>
}

</code></pre>
<p>关键结论：</p>
<ul>
<li>
<p>切片本身是值类型（结构体拷贝），但它指向的底层数组是引用类型；</p>
</li>
<li>
<p>多个切片可以指向同一个底层数组（通过截取创建），修改一个切片的元素会影响其他切片；</p>
</li>
<li>
<p>切片的赋值、传递参数时，拷贝的是这个结构体（3个字段，占用16字节：64位系统下，指针8字节+int8字节+int8字节），效率极高。</p>
</li>
</ul>
<p>示例：多个切片共享底层数组</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    arr := [<span class="hljs-number">5</span>]<span class="hljs-type">int</span>{<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>}
    s1 := arr[<span class="hljs-number">1</span>:<span class="hljs-number">3</span>]  <span class="hljs-comment">// [2,3]，cap=4</span>
    s2 := arr[<span class="hljs-number">2</span>:<span class="hljs-number">4</span>]  <span class="hljs-comment">// [3,4]，cap=3</span>

    <span class="hljs-comment">// 修改s1[1]（即底层数组索引2的元素3）</span>
    s1[<span class="hljs-number">1</span>] = <span class="hljs-number">300</span>
    fmt.Println(<span class="hljs-string">"s1:"</span>, s1) <span class="hljs-comment">// 输出：s1: [2 300]</span>
    fmt.Println(<span class="hljs-string">"s2:"</span>, s2) <span class="hljs-comment">// 输出：s2: [300 4]（s2也受影响）</span>
    fmt.Println(<span class="hljs-string">"arr:"</span>, arr) <span class="hljs-comment">// 输出：arr: [1 2 300 4 5]（底层数组被修改）</span>
}

</code></pre>
<h2 data-id="heading-9">3. 切片的扩容策略与性能分析</h2>
<p>当切片的长度等于容量（<code>len(s) == cap(s)</code>）时，再通过<code>append</code>添加元素，会触发扩容。扩容的核心逻辑是“创建一个更大的新底层数组，将原数组的元素拷贝到新数组，然后让切片指向新数组”。</p>
<h3 data-id="heading-10">3.1 扩容策略（Go 1.18+ 最新逻辑）</h3>
<p>Go的扩容策略经过多次优化，当前（1.18+）的核心逻辑如下（源码在<code>runtime/slice.go</code>的<code>growslice</code>函数中）：</p>
<ol>
<li>
<p>计算“期望容量”：<code>newcap = len(s) + 要添加的元素个数</code>；</p>
</li>
<li>
<p>如果原容量 &lt; 256，则新容量 = 原容量 × 2；</p>
</li>
<li>
<p>如果原容量 ≥ 256，则新容量 = 原容量 + 原容量/4（即增加25%）；</p>
</li>
<li>
<p>如果计算出的新容量 &lt; 期望容量，则新容量 = 期望容量（保证能容纳新元素）；</p>
</li>
<li>
<p>最后，新容量会被调整为“内存对齐”的大小（提高内存分配效率）。</p>
</li>
</ol>
<h3 data-id="heading-11">3.2 代码示例：验证扩容过程</h3>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    s := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>) <span class="hljs-comment">// len=0, cap=1</span>
    fmt.Printf(<span class="hljs-string">"初始：len=%d, cap=%d\n"</span>, <span class="hljs-built_in">len</span>(s), <span class="hljs-built_in">cap</span>(s)) <span class="hljs-comment">// 初始：len=0, cap=1</span>

    s = <span class="hljs-built_in">append</span>(s, <span class="hljs-number">1</span>) <span class="hljs-comment">// len=1, cap=1（未扩容）</span>
    fmt.Printf(<span class="hljs-string">"添加1后：len=%d, cap=%d\n"</span>, <span class="hljs-built_in">len</span>(s), <span class="hljs-built_in">cap</span>(s)) <span class="hljs-comment">// 添加1后：len=1, cap=1</span>

    s = <span class="hljs-built_in">append</span>(s, <span class="hljs-number">2</span>) <span class="hljs-comment">// len=2, cap=2（原cap&lt;256，×2扩容）</span>
    fmt.Printf(<span class="hljs-string">"添加2后：len=%d, cap=%d\n"</span>, <span class="hljs-built_in">len</span>(s), <span class="hljs-built_in">cap</span>(s)) <span class="hljs-comment">// 添加2后：len=2, cap=2</span>

    s = <span class="hljs-built_in">append</span>(s, <span class="hljs-number">3</span>) <span class="hljs-comment">// len=3, cap=4（原cap&lt;256，×2扩容）</span>
    fmt.Printf(<span class="hljs-string">"添加3后：len=%d, cap=%d\n"</span>, <span class="hljs-built_in">len</span>(s), <span class="hljs-built_in">cap</span>(s)) <span class="hljs-comment">// 添加3后：len=3, cap=4</span>

    s = <span class="hljs-built_in">append</span>(s, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>) <span class="hljs-comment">// len=5, cap=8（原cap&lt;256，×2扩容，能容纳2个新元素）</span>
    fmt.Printf(<span class="hljs-string">"添加4、5后：len=%d, cap=%d\n"</span>, <span class="hljs-built_in">len</span>(s), <span class="hljs-built_in">cap</span>(s)) <span class="hljs-comment">// 添加4、5后：len=5, cap=8</span>
}

</code></pre>
<h3 data-id="heading-12">3.3 扩容对性能的影响</h3>
<p>扩容的核心开销来自两部分：<strong>新数组的内存分配</strong>和<strong>原数组元素的拷贝</strong>。频繁扩容会严重影响性能，因此在实际开发中，要尽量“预分配容量”，减少扩容次数。</p>
<p>性能对比示例（预分配vs不预分配）：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"time"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 场景1：不预分配容量（频繁扩容）</span>
    start1 := time.Now()
    <span class="hljs-keyword">var</span> s1 []<span class="hljs-type">int</span>
    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000000</span>; i++ {
        s1 = <span class="hljs-built_in">append</span>(s1, i)
    }
    fmt.Printf(<span class="hljs-string">"不预分配容量耗时：%v\n"</span>, time.Since(start1)) <span class="hljs-comment">// 约1.2ms（因环境而异）</span>

    <span class="hljs-comment">// 场景2：预分配容量（无扩容）</span>
    start2 := time.Now()
    s2 := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1000000</span>) <span class="hljs-comment">// 预分配100万容量</span>
    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000000</span>; i++ {
        s2 = <span class="hljs-built_in">append</span>(s2, i)
    }
    fmt.Printf(<span class="hljs-string">"预分配容量耗时：%v\n"</span>, time.Since(start2)) <span class="hljs-comment">// 约0.6ms（因环境而异）</span>
}

</code></pre>
<p>结论：预分配容量能减少80%以上的耗时（具体比例因数据量而异），是提升切片操作性能的关键技巧。</p>
<h2 data-id="heading-13">4. 切片的共享内存与拷贝问题</h2>
<p>切片的“共享底层数组”特性，在带来灵活性的同时，也容易引发“数据污染”问题。此外，当需要修改切片又不影响原数组/切片时，就需要进行“切片拷贝”。</p>
<h3 data-id="heading-14">4.1 共享内存的坑：数据污染</h3>
<p>多个切片共享底层数组时，修改一个切片的元素会影响其他切片和原数组，这是最常见的坑：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 原切片</span>
    s := []<span class="hljs-type">int</span>{<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>}
    <span class="hljs-comment">// 截取得到新切片</span>
    sSub := s[<span class="hljs-number">2</span>:<span class="hljs-number">4</span>] <span class="hljs-comment">// [3,4]</span>
    <span class="hljs-comment">// 修改新切片</span>
    sSub[<span class="hljs-number">0</span>] = <span class="hljs-number">300</span>
    <span class="hljs-comment">// 原切片也被修改</span>
    fmt.Println(<span class="hljs-string">"原切片s:"</span>, s) <span class="hljs-comment">// 输出：原切片s: [1 2 300 4 5]</span>
}

</code></pre>
<p>解决方案：如果需要修改切片又不影响原数据，必须创建切片的“独立副本”（即切片拷贝）。</p>
<h3 data-id="heading-15">4.2 切片拷贝：创建独立副本</h3>
<p>Go提供<code>copy(dst, src []T)</code>函数实现切片拷贝，核心特点：</p>
<ul>
<li>
<p>拷贝的元素个数 = min(len(dst), len(src))；</p>
</li>
<li>
<p>拷贝后，dst和src指向不同的底层数组（独立副本），修改互不影响；</p>
</li>
<li>
<p>dst需要提前分配足够的容量（否则只能拷贝部分元素）。</p>
</li>
</ul>
<p>代码示例：正确的切片拷贝</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    s := []<span class="hljs-type">int</span>{<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>}
    <span class="hljs-comment">// 方案1：创建与原切片长度相同的dst</span>
    sCopy1 := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, <span class="hljs-built_in">len</span>(s))
    <span class="hljs-built_in">copy</span>(sCopy1, s) <span class="hljs-comment">// 拷贝所有元素</span>
    sCopy1[<span class="hljs-number">0</span>] = <span class="hljs-number">100</span>
    fmt.Println(<span class="hljs-string">"s:"</span>, s)       <span class="hljs-comment">// 输出：s: [1 2 3 4 5]（原切片未变）</span>
    fmt.Println(<span class="hljs-string">"sCopy1:"</span>, sCopy1) <span class="hljs-comment">// 输出：sCopy1: [100 2 3 4 5]</span>

    <span class="hljs-comment">// 方案2：拷贝部分元素（截取后拷贝）</span>
    sSub := s[<span class="hljs-number">2</span>:<span class="hljs-number">4</span>] <span class="hljs-comment">// [3,4]</span>
    sCopy2 := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, <span class="hljs-built_in">len</span>(sSub))
    <span class="hljs-built_in">copy</span>(sCopy2, sSub)
    sCopy2[<span class="hljs-number">0</span>] = <span class="hljs-number">300</span>
    fmt.Println(<span class="hljs-string">"sSub:"</span>, sSub)   <span class="hljs-comment">// 输出：sSub: [3 4]（原截取切片未变）</span>
    fmt.Println(<span class="hljs-string">"sCopy2:"</span>, sCopy2) <span class="hljs-comment">// 输出：sCopy2: [300 4]</span>

    <span class="hljs-comment">// 错误示例：dst容量不足</span>
    sCopy3 := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, <span class="hljs-number">2</span>) <span class="hljs-comment">// len=2</span>
    <span class="hljs-built_in">copy</span>(sCopy3, s) <span class="hljs-comment">// 仅拷贝前2个元素</span>
    fmt.Println(<span class="hljs-string">"sCopy3:"</span>, sCopy3) <span class="hljs-comment">// 输出：sCopy3: [1 2]</span>
}

</code></pre>
<h3 data-id="heading-16">4.3 常见场景：切片作为函数返回值</h3>
<p>当函数返回切片时，要注意：如果返回的是“原切片的截取切片”，则会共享底层数组，可能导致外部修改影响内部数据。正确做法是返回“拷贝后的独立切片”：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-comment">// 错误：返回截取切片，共享底层数组</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">badGetSubSlice</span><span class="hljs-params">(s []<span class="hljs-type">int</span>)</span></span> []<span class="hljs-type">int</span> {
    <span class="hljs-keyword">return</span> s[<span class="hljs-number">2</span>:<span class="hljs-number">4</span>]
}

<span class="hljs-comment">// 正确：返回拷贝后的独立切片</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">goodGetSubSlice</span><span class="hljs-params">(s []<span class="hljs-type">int</span>)</span></span> []<span class="hljs-type">int</span> {
    sub := s[<span class="hljs-number">2</span>:<span class="hljs-number">4</span>]
    <span class="hljs-comment">// 创建拷贝</span>
    subCopy := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, <span class="hljs-built_in">len</span>(sub))
    <span class="hljs-built_in">copy</span>(subCopy, sub)
    <span class="hljs-keyword">return</span> subCopy
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    s := []<span class="hljs-type">int</span>{<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>}
    <span class="hljs-comment">// 错误示例</span>
    badSub := badGetSubSlice(s)
    badSub[<span class="hljs-number">0</span>] = <span class="hljs-number">300</span>
    fmt.Println(<span class="hljs-string">"s（错误）:"</span>, s) <span class="hljs-comment">// 输出：s（错误）: [1 2 300 4 5]（被修改）</span>

    <span class="hljs-comment">// 正确示例</span>
    s2 := []<span class="hljs-type">int</span>{<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>}
    goodSub := goodGetSubSlice(s2)
    goodSub[<span class="hljs-number">0</span>] = <span class="hljs-number">300</span>
    fmt.Println(<span class="hljs-string">"s2（正确）:"</span>, s2) <span class="hljs-comment">// 输出：s2（正确）: [1 2 3 4 5]（未修改）</span>
}

</code></pre>
<h2 data-id="heading-17">5. map的定义与基本操作</h2>
<p>map是Go中的“键值对映射”复合类型，核心特点是“无序、键唯一”，支持快速的键查找（O(1)时间复杂度）。map的键必须是“可比较类型”（如int、string、bool、数组等），值可以是任意类型。</p>
<h3 data-id="heading-18">5.1 map的定义与初始化</h3>
<p>map的定义语法：<code>map[键类型]值类型</code>。初始化方式有两种：<code>make</code>初始化和直接初始化：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 1. 空map（nil map）：未分配内存，不能直接添加元素</span>
    <span class="hljs-keyword">var</span> m1 <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">int</span>
    fmt.Println(<span class="hljs-string">"m1:"</span>, m1)          <span class="hljs-comment">// 输出：m1: map[]</span>
    fmt.Printf(<span class="hljs-string">"m1是否为nil：%t\n"</span>, m1 == <span class="hljs-literal">nil</span>) <span class="hljs-comment">// 输出：m1是否为nil：true</span>
    <span class="hljs-comment">// m1["a"] = 1 // 运行时错误：assignment to entry in nil map</span>

    <span class="hljs-comment">// 2. 用make初始化（最常用）：make(map[K]V, 容量)</span>
    m2 := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">int</span>, <span class="hljs-number">10</span>) <span class="hljs-comment">// 容量10（可选，用于预分配）</span>
    m2[<span class="hljs-string">"a"</span>] = <span class="hljs-number">1</span>
    m2[<span class="hljs-string">"b"</span>] = <span class="hljs-number">2</span>
    fmt.Println(<span class="hljs-string">"m2:"</span>, m2)          <span class="hljs-comment">// 输出：m2: map[a:1 b:2]</span>
    fmt.Printf(<span class="hljs-string">"m2长度：%d\n"</span>, <span class="hljs-built_in">len</span>(m2)) <span class="hljs-comment">// 输出：m2长度：2</span>

    <span class="hljs-comment">// 3. 直接初始化（键值对列表）</span>
    m3 := <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>{
        <span class="hljs-string">"name"</span>: <span class="hljs-string">"Alice"</span>,
        <span class="hljs-string">"age"</span>:  <span class="hljs-string">"25"</span>,
        <span class="hljs-string">"city"</span>: <span class="hljs-string">"Beijing"</span>,
    }
    fmt.Println(<span class="hljs-string">"m3:"</span>, m3) <span class="hljs-comment">// 输出：m3: map[age:25 city:Beijing name:Alice]</span>
}

</code></pre>
<h3 data-id="heading-19">5.2 map的基本操作：增删改查</h3>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    m := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">int</span>)

    <span class="hljs-comment">// 1. 增：添加键值对</span>
    m[<span class="hljs-string">"apple"</span>] = <span class="hljs-number">5</span>
    m[<span class="hljs-string">"banana"</span>] = <span class="hljs-number">3</span>
    fmt.Println(<span class="hljs-string">"添加后："</span>, m) <span class="hljs-comment">// 输出：添加后： map[apple:5 banana:3]</span>

    <span class="hljs-comment">// 2. 改：修改已有键的值</span>
    m[<span class="hljs-string">"apple"</span>] = <span class="hljs-number">10</span>
    fmt.Println(<span class="hljs-string">"修改后："</span>, m) <span class="hljs-comment">// 输出：修改后： map[apple:10 banana:3]</span>

    <span class="hljs-comment">// 3. 查：获取键的值（两个返回值：值、是否存在）</span>
    val, ok := m[<span class="hljs-string">"apple"</span>]
    <span class="hljs-keyword">if</span> ok {
        fmt.Println(<span class="hljs-string">"apple的值："</span>, val) <span class="hljs-comment">// 输出：apple的值： 10</span>
    } <span class="hljs-keyword">else</span> {
        fmt.Println(<span class="hljs-string">"apple不存在"</span>)
    }

    <span class="hljs-comment">// 查找不存在的键：返回值类型的零值</span>
    val2, ok2 := m[<span class="hljs-string">"orange"</span>]
    fmt.Println(<span class="hljs-string">"orange的值："</span>, val2, <span class="hljs-string">"，是否存在："</span>, ok2) <span class="hljs-comment">// 输出：orange的值： 0 ，是否存在： false</span>

    <span class="hljs-comment">// 4. 删：删除键值对（用delete函数，删除不存在的键不会报错）</span>
    <span class="hljs-built_in">delete</span>(m, <span class="hljs-string">"banana"</span>)
    fmt.Println(<span class="hljs-string">"删除banana后："</span>, m) <span class="hljs-comment">// 输出：删除banana后： map[apple:10]</span>
    <span class="hljs-built_in">delete</span>(m, <span class="hljs-string">"orange"</span>) <span class="hljs-comment">// 无报错</span>
}

</code></pre>
<p>关键注意点：</p>
<ul>
<li>
<p>查找不存在的键时，不会报错，返回值类型的零值（如int返回0，string返回""）；</p>
</li>
<li>
<p>必须通过<code>ok</code>返回值判断键是否存在（避免零值导致的逻辑错误）；</p>
</li>
<li>
<p>delete函数删除不存在的键时，不会触发任何错误。</p>
</li>
</ul>
<h2 data-id="heading-20">6. map的并发安全与sync.Map</h2>
<p>Go的原生map是<strong>并发不安全</strong>的：当多个goroutine同时对map进行“写操作”（增删改）时，会触发运行时错误（<code>fatal error: concurrent map writes</code>）。</p>
<h3 data-id="heading-21">6.1 并发不安全的示例</h3>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"time"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    m := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">int</span>)

    <span class="hljs-comment">// 启动10个goroutine同时写map</span>
    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++ {
        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(idx <span class="hljs-type">int</span>)</span></span> {
            m[idx] = idx * <span class="hljs-number">10</span> <span class="hljs-comment">// 并发写</span>
        }(i)
    }

    <span class="hljs-comment">// 等待goroutine执行完成</span>
    time.Sleep(<span class="hljs-number">1</span> * time.Second)
    fmt.Println(<span class="hljs-string">"map内容："</span>, m)
}
</code></pre>
<p>运行结果：大概率会触发<code>concurrent map writes</code>错误。</p>
<h3 data-id="heading-22">6.2 并发安全的解决方案</h3>
<p>实现map的并发安全，有两种常用方案：</p>
<h4 data-id="heading-23">6.2.1 方案1：使用互斥锁（sync.Mutex/sync.RWMutex）</h4>
<p>通过锁来保证同一时间只有一个goroutine能修改map，适合“读多写少”或“读写均衡”的场景：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"sync"</span>
    <span class="hljs-string">"time"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 封装：map + 锁</span>
    <span class="hljs-keyword">type</span> SafeMap <span class="hljs-keyword">struct</span> {
        m sync.RWMutex <span class="hljs-comment">// 读写锁：读锁不互斥，写锁互斥</span>
        data <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">int</span>
    }

    sm := SafeMap{
        data: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">int</span>),
    }

    <span class="hljs-keyword">var</span> wg sync.WaitGroup
    <span class="hljs-comment">// 启动10个goroutine写map</span>
    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++ {
        wg.Add(<span class="hljs-number">1</span>)
        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(idx <span class="hljs-type">int</span>)</span></span> {
            <span class="hljs-keyword">defer</span> wg.Done()
            sm.m.Lock()         <span class="hljs-comment">// 写锁：排他锁</span>
            sm.data[idx] = idx * <span class="hljs-number">10</span>
            sm.m.Unlock()       <span class="hljs-comment">// 释放写锁</span>
        }(i)
    }

    <span class="hljs-comment">// 启动5个goroutine读map</span>
    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++ {
        wg.Add(<span class="hljs-number">1</span>)
        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(idx <span class="hljs-type">int</span>)</span></span> {
            <span class="hljs-keyword">defer</span> wg.Done()
            sm.m.RLock()         <span class="hljs-comment">// 读锁：共享锁</span>
            val := sm.data[idx]
            sm.m.RUnlock()       <span class="hljs-comment">// 释放读锁</span>
            fmt.Printf(<span class="hljs-string">"key=%d, value=%d\n"</span>, idx, val)
        }(i)
    }

    wg.Wait() <span class="hljs-comment">// 等待所有goroutine完成</span>
    fmt.Println(<span class="hljs-string">"最终map内容："</span>, sm.data)
}

</code></pre>
<p>关键说明：</p>
<ul>
<li>
<p>sync.RWMutex（读写锁）比sync.Mutex（互斥锁）效率更高，适合读多写少场景；</p>
</li>
<li>
<p>读锁（RLock）：多个goroutine可以同时获取读锁，互不干扰；</p>
</li>
<li>
<p>写锁（Lock）：获取写锁后，其他goroutine无法获取读锁或写锁（排他性）。</p>
</li>
</ul>
<h4 data-id="heading-24">6.2.2 方案2：使用sync.Map（Go 1.9+ 标准库）</h4>
<p>sync.Map是Go标准库提供的“并发安全map”，专门优化了两种场景：</p>
<ul>
<li>
<p>键值对的“读多写少”；</p>
</li>
<li>
<p>键的生命周期短（频繁删除旧键，添加新键）。</p>
</li>
</ul>
<p>sync.Map的核心方法：</p>
<ul>
<li>
<p>Store(key, value)：存储键值对；</p>
</li>
<li>
<p>Load(key)：获取键的值（返回值、是否存在）；</p>
</li>
<li>
<p>Delete(key)：删除键值对；</p>
</li>
<li>
<p>Range(f func(key, value interface{}) bool)：遍历键值对。</p>
</li>
</ul>
<p>代码示例：sync.Map的使用</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"sync"</span>
    <span class="hljs-string">"time"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> sm sync.Map

    <span class="hljs-keyword">var</span> wg sync.WaitGroup
    <span class="hljs-comment">// 10个goroutine写</span>
    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++ {
        wg.Add(<span class="hljs-number">1</span>)
        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(idx <span class="hljs-type">int</span>)</span></span> {
            <span class="hljs-keyword">defer</span> wg.Done()
            sm.Store(idx, idx*<span class="hljs-number">10</span>) <span class="hljs-comment">// 存储键值对</span>
        }(i)
    }

    <span class="hljs-comment">// 5个goroutine读</span>
    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++ {
        wg.Add(<span class="hljs-number">1</span>)
        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(idx <span class="hljs-type">int</span>)</span></span> {
            <span class="hljs-keyword">defer</span> wg.Done()
            val, ok := sm.Load(idx) <span class="hljs-comment">// 获取值</span>
            <span class="hljs-keyword">if</span> ok {
                fmt.Printf(<span class="hljs-string">"key=%d, value=%d\n"</span>, idx, val)
            }
        }(i)
    }

    wg.Wait()

    <span class="hljs-comment">// 遍历sync.Map</span>
    fmt.Println(<span class="hljs-string">"遍历sync.Map："</span>)
    sm.Range(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(key, value <span class="hljs-keyword">interface</span>{})</span></span> <span class="hljs-type">bool</span> {
        fmt.Printf(<span class="hljs-string">"key=%v, value=%v\n"</span>, key, value)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span> <span class="hljs-comment">// 返回true继续遍历，返回false终止遍历</span>
    })
}

</code></pre>
<h3 data-id="heading-25">6.3 方案选择建议</h3>
<ul>
<li>
<p>并发场景简单（读写均衡）：用“map + sync.RWMutex”，灵活性高；</p>
</li>
<li>
<p>读多写少/键生命周期短：用sync.Map，效率更高，无需手动封装锁；</p>
</li>
<li>
<p>非并发场景：直接用原生map，效率最高。</p>
</li>
</ul>
<h2 data-id="heading-26">7. 遍历map与顺序不确定性</h2>
<p>Go的原生map是<strong>无序</strong>的：每次遍历map，键值对的顺序都可能不同。这是Go的设计特性（为了哈希表的性能优化），不能依赖遍历顺序。</p>
<h3 data-id="heading-27">7.1 无序遍历的示例</h3>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    m := <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">int</span>{
        <span class="hljs-string">"a"</span>: <span class="hljs-number">1</span>,
        <span class="hljs-string">"b"</span>: <span class="hljs-number">2</span>,
        <span class="hljs-string">"c"</span>: <span class="hljs-number">3</span>,
        <span class="hljs-string">"d"</span>: <span class="hljs-number">4</span>,
    }

    <span class="hljs-comment">// 多次遍历，顺序可能不同</span>
    fmt.Println(<span class="hljs-string">"第一次遍历："</span>)
    <span class="hljs-keyword">for</span> k, v := <span class="hljs-keyword">range</span> m {
        fmt.Printf(<span class="hljs-string">"%s: %d "</span>, k, v)
    }
    fmt.Println()

    fmt.Println(<span class="hljs-string">"第二次遍历："</span>)
    <span class="hljs-keyword">for</span> k, v := <span class="hljs-keyword">range</span> m {
        fmt.Printf(<span class="hljs-string">"%s: %d "</span>, k, v)
    }
    fmt.Println()
}

</code></pre>
<p>运行结果示例（两次顺序可能不同）：</p>
<pre><code class="hljs language-Plain" lang="Plain">
第一次遍历：
b: 2 d: 4 a: 1 c: 3
第二次遍历：
a: 1 b: 2 c: 3 d: 4

</code></pre>
<h3 data-id="heading-28">7.2 实现有序遍历的方案</h3>
<p>如果需要“有序遍历map”，核心思路是：</p>
<ol>
<li>
<p>先将map的键提取到切片中；</p>
</li>
<li>
<p>对切片进行排序；</p>
</li>
<li>
<p>按排序后的切片顺序，遍历map的键，获取对应的值。</p>
</li>
</ol>
<p>代码示例：按键的字典序遍历map</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"sort"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    m := <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">int</span>{
        <span class="hljs-string">"d"</span>: <span class="hljs-number">4</span>,
        <span class="hljs-string">"a"</span>: <span class="hljs-number">1</span>,
        <span class="hljs-string">"c"</span>: <span class="hljs-number">3</span>,
        <span class="hljs-string">"b"</span>: <span class="hljs-number">2</span>,
    }

    <span class="hljs-comment">// 1. 提取键到切片</span>
    keys := <span class="hljs-built_in">make</span>([]<span class="hljs-type">string</span>, <span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(m))
    <span class="hljs-keyword">for</span> k := <span class="hljs-keyword">range</span> m {
        keys = <span class="hljs-built_in">append</span>(keys, k)
    }

    <span class="hljs-comment">// 2. 对切片排序（字典序）</span>
    sort.Strings(keys)

    <span class="hljs-comment">// 3. 按排序后的键遍历map</span>
    fmt.Println(<span class="hljs-string">"按字典序遍历："</span>)
    <span class="hljs-keyword">for</span> _, k := <span class="hljs-keyword">range</span> keys {
        fmt.Printf(<span class="hljs-string">"%s: %d "</span>, k, m[k])
    }
    fmt.Println()

    <span class="hljs-comment">// 按数值降序遍历（以值为排序依据）</span>
    <span class="hljs-comment">// 1. 定义切片存储键值对</span>
    <span class="hljs-keyword">type</span> kv <span class="hljs-keyword">struct</span> {
        Key   <span class="hljs-type">string</span>
        Value <span class="hljs-type">int</span>
    }
    kvSlice := <span class="hljs-built_in">make</span>([]kv, <span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(m))
    <span class="hljs-keyword">for</span> k, v := <span class="hljs-keyword">range</span> m {
        kvSlice = <span class="hljs-built_in">append</span>(kvSlice, kv{k, v})
    }

    <span class="hljs-comment">// 2. 按值降序排序</span>
    sort.Slice(kvSlice, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i, j <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">bool</span> {
        <span class="hljs-keyword">return</span> kvSlice[i].Value &gt; kvSlice[j].Value
    })

    <span class="hljs-comment">// 3. 遍历排序后的切片</span>
    fmt.Println(<span class="hljs-string">"按值降序遍历："</span>)
    <span class="hljs-keyword">for</span> _, item := <span class="hljs-keyword">range</span> kvSlice {
        fmt.Printf(<span class="hljs-string">"%s: %d "</span>, item.Key, item.Value)
    }
    fmt.Println()
}

</code></pre>
<p>运行结果：</p>
<pre><code class="hljs language-Plain" lang="Plain">
按字典序遍历：
a: 1 b: 2 c: 3 d: 4
按值降序遍历：
d: 4 c: 3 b: 2 a: 1

</code></pre>
<h2 data-id="heading-29">8. 复合类型的内存布局与性能优化</h2>
<p>理解复合类型的内存布局，是进行性能优化的基础。本节将拆解数组、切片、map的内存布局，并给出针对性的性能优化技巧。</p>
<h3 data-id="heading-30">8.1 内存布局拆解</h3>
<h4 data-id="heading-31">8.1.1 数组的内存布局</h4>
<p>数组的内存是<strong>连续的</strong>，元素按索引顺序依次存储。例如<code>[3]int{1,2,3}</code>的内存布局（64位系统，int占8字节）：</p>
<pre><code class="hljs language-Plain" lang="Plain">
地址：0x00  0x08  0x10
元素：1    2    3

</code></pre>
<p>优势：索引访问效率极高（直接通过地址偏移计算元素位置）；缓存命中率高（连续内存易被CPU缓存）。</p>
<h4 data-id="heading-32">8.1.2 切片的内存布局</h4>
<p>切片本身是一个3字段的结构体（指针+len+cap），存储在栈上；其指向的底层数组存储在堆上（如果切片较大，或被外部引用）。例如<code>s := []int{1,2,3}</code>的内存布局：</p>
<pre><code class="hljs language-Plain" lang="Plain">
栈上（切片结构体）：
array指针: 0x100（指向堆上的底层数组）
len: 3
cap: 3

堆上（底层数组）：
地址：0x100  0x108  0x110
元素：1    2    3

</code></pre>
<h4 data-id="heading-33">8.1.3 map的内存布局</h4>
<p>map的底层是“哈希表”，内存布局较复杂，核心结构包括：</p>
<ul>
<li>
<p>hmap（哈希表结构体）：存储map的元信息（桶数组指针、大小、哈希种子等）；</p>
</li>
<li>
<p>bmap（桶）：存储实际的键值对（每个桶可存储8个键值对）；</p>
</li>
<li>
<p>溢出桶：当桶满时，使用溢出桶存储额外的键值对。</p>
</li>
</ul>
<p>核心结论：map的键查找是“哈希计算→桶定位→键比较”的过程，效率高，但无序；频繁的增删改可能导致哈希表扩容，影响性能。</p>
<h3 data-id="heading-34">8.2 通用性能优化技巧</h3>
<h4 data-id="heading-35">8.2.1 切片优化技巧</h4>
<ul>
<li>
<p><strong>预分配容量</strong>：创建切片时，已知元素个数的情况下，用<code>make([]T, 0, cap)</code>预分配容量，减少扩容次数；</p>
</li>
<li>
<p><strong>避免切片泄露</strong>：截取大数组/大切片得到的小切片，会引用整个大底层数组，导致大数组无法被GC回收（内存泄露）。解决方案：拷贝小切片，释放对大数组的引用；</p>
</li>
<li>
<p><strong>使用切片表达式简化操作</strong>：如<code>s = s[:len(s)-1]</code>删除最后一个元素（无需拷贝，效率高）。</p>
</li>
</ul>
<h4 data-id="heading-36">8.2.2 map优化技巧</h4>
<ul>
<li>
<p><strong>预分配容量</strong>：创建map时，已知键值对个数的情况下，预分配容量（<code>make(map[K]V, cap)</code>），减少哈希表扩容次数；</p>
</li>
<li>
<p><strong>选择合适的键类型</strong>：优先使用int、string等“高效哈希类型”，避免使用数组、结构体等复杂类型（哈希计算耗时）；</p>
</li>
<li>
<p><strong>避免频繁的增删改</strong>：频繁的增删改会导致哈希表的“负载因子”波动，触发扩容或缩容，影响性能；</p>
</li>
<li>
<p><strong>批量操作优于循环单操作</strong>：如批量添加键值对时，一次性添加比循环单个添加效率高（减少哈希表的状态检查）。</p>
</li>
</ul>
<h4 data-id="heading-37">8.2.3 数组优化技巧</h4>
<ul>
<li>
<p><strong>传递大数组用指针</strong>：避免拷贝整个数组，提升性能；</p>
</li>
<li>
<p><strong>小数组优先于切片</strong>：对于固定长度的小数组（如<code>[4]byte</code>），用数组比切片更高效（无需结构体开销和堆内存分配）。</p>
</li>
</ul>
<h2 data-id="heading-38">总结</h2>
<p>本章我们全面讲解了Go的三种核心复合类型——数组、切片和map，核心要点总结如下：</p>
<ol>
<li>
<p>数组：固定长度的连续序列，值类型，是切片的底层基础；适合存储固定长度的常量数据；</p>
</li>
<li>
<p>切片：动态数组的视图，底层是“指针+len+cap”的结构体；支持动态扩容，是Go中最常用的序列类型；注意共享内存的数据污染问题，必要时用copy创建独立副本；</p>
</li>
<li>
<p>map：无序的键值对映射，支持快速查找；键必须是可比较类型；原生并发不安全，需用锁或sync.Map保证并发安全；遍历顺序不确定，有序遍历需手动排序键；</p>
</li>
<li>
<p>性能优化核心：预分配容量（切片、map）、避免不必要的拷贝（数组指针、切片拷贝）、选择合适的类型（map键类型）、避免内存泄露（切片截取后的拷贝）。</p>
</li>
</ol>
<p>这三种复合类型是Go编程的基础，几乎所有业务代码都会用到。建议多动手实践：用切片处理动态序列、用map存储键值对数据、用数组保证固定长度约束，同时结合性能优化技巧，写出高效、安全的代码。如果有任何问题，欢迎在评论区交流～</p>
<p>参考链接：</p>
<ul>
<li>
<p>Go官方文档 - 数组：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.dev%2Fref%2Fspec%23Array_types" target="_blank" title="https://go.dev/ref/spec#Array_types" ref="nofollow noopener noreferrer">go.dev/ref/spec#Ar…</a></p>
</li>
<li>
<p>Go官方文档 - 切片：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.dev%2Fref%2Fspec%23Slice_types" target="_blank" title="https://go.dev/ref/spec#Slice_types" ref="nofollow noopener noreferrer">go.dev/ref/spec#Sl…</a></p>
</li>
<li>
<p>Go官方文档 - map：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.dev%2Fref%2Fspec%23Map_types" target="_blank" title="https://go.dev/ref/spec#Map_types" ref="nofollow noopener noreferrer">go.dev/ref/spec#Ma…</a></p>
</li>
<li>
<p>Go标准库 - sync.Map：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpkg.go.dev%2Fsync%23Map" target="_blank" title="https://pkg.go.dev/sync#Map" ref="nofollow noopener noreferrer">pkg.go.dev/sync#Map</a></p>
</li>
<li>
<p>Go官方博客 - 切片内部机制：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.dev%2Fblog%2Fslices-intro" target="_blank" title="https://go.dev/blog/slices-intro" ref="nofollow noopener noreferrer">go.dev/blog/slices…</a></p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Bitmap优化套路深 多级缓存定乾坤]]></title>    <link>https://juejin.cn/post/7599600549763629091</link>    <guid>https://juejin.cn/post/7599600549763629091</guid>    <pubDate>2026-01-27T00:51:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599600549763629091" data-draft-id="7598807837868130330" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Bitmap优化套路深 多级缓存定乾坤"/> <meta itemprop="keywords" content="Kotlin,Android"/> <meta itemprop="datePublished" content="2026-01-27T00:51:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="RockByte"/> <meta itemprop="url" content="https://juejin.cn/user/1046390797768519"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Bitmap优化套路深 多级缓存定乾坤
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1046390797768519/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    RockByte
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T00:51:34.000Z" title="Tue Jan 27 2026 00:51:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:2;font-weight:400;font-size:15px;overflow-x:hidden;color:#333;letter-spacing:1.2px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:.5rem solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c;margin:0 5px}.markdown-body a:active,.markdown-body a:hover{text-decoration:none;border-bottom:1.5px solid #3eaf7c}.markdown-body a[href^=http]:after{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTQiIGhlaWdodD0iMTQiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04MzIgMTI4SDY0MHY2NGgxNDYuNzUyTDUyMS4zNzYgNDU3LjM3Nmw0NS4yNDggNDUuMjQ4TDgzMiAyMzcuMjQ4VjM4NGg2NFYxMjh6IiBmaWxsPSIjM2VhZjdjIi8+PHBhdGggZD0iTTc2OCA4MzJIMTkyVjI1NmgzNTJ2LTY0SDE2MGEzMiAzMiAwIDAwLTMyIDMydjY0MGEzMiAzMiAwIDAwMzIgMzJoNjQwYTMyIDMyIDAgMDAzMi0zMlY0ODBoLTY0djM1MnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");margin-left:2px}.markdown-body a[href^="#"]:before{content:"#"}.markdown-body table{display:inline-block!important;font-size:13px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c;border-collapse:collapse}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:4px 8px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#7b7878;padding:1px 23px;border-left:.5rem solid;border-color:#42b983;background-color:rgba(66,184,131,.1);position:relative;margin:14px 8px 0}.markdown-body blockquote:before{display:inline-block;position:absolute;content:url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjUiIGhlaWdodD0iMjUiIHZpZXdCb3g9IjAgMCAyNyAyNyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxLjg2MiAxLjg2MikiIGZpbGwtcnVsZT0ibm9uemVybyIgZmlsbD0ibm9uZSI+PGNpcmNsZSBzdHJva2U9IiNGRkYiIHN0cm9rZS13aWR0aD0iMS43MjQiIGZpbGw9IiM0MkI5ODMiIGN4PSIxMS42MzgiIGN5PSIxMS42MzgiIHI9IjExLjYzOCIvPjxwYXRoIGQ9Ik0xNC45NzggNi4yN0E1LjAwNiA1LjAwNiAwIDAwNi42NyA5LjQ2OGE0LjkwMSA0LjkwMSAwIDAwMS43NzMgNC4zNjJjLjMyMy4yNTguNTE0LjY0Ny41MjIgMS4wNnYxLjA2YTIuNjg1IDIuNjg1IDAgMDA1LjM3IDB2LTEuMDA4Yy4wMDItLjM5OC4xNzMtLjc3Ny40Ny0xLjA0MmE1LjAyMyA1LjAyMyAwIDAwLjE3My03LjYzem0tMy4zMzcgMTAuOTY3YTEuMzA0IDEuMzA0IDAgMDEtMS4yODYtMS4yODd2LS4yNzhoMi41NzJ2LjI2MWMwIC43MTMtLjU3MyAxLjI5NC0xLjI4NiAxLjMwNHptMi4yNi00LjQxNWMtLjQ0LjM4My0uNzUuODkzLS44ODcgMS40NmgtMi43NDZhMi44NjggMi44NjggMCAwMC0uOTM4LTEuNTNoLS4wMThhMy40NzYgMy40NzYgMCAwMS0xLjI2OS0zLjE0NSAzLjYxNSAzLjYxNSAwIDAxNy4xOTYuNCAzLjY1IDMuNjUgMCAwMS0xLjMzOCAyLjgxNXoiIGZpbGw9IiNGRkYiLz48L2c+PC9zdmc+");width:25px;height:25px;left:-16px;top:12px}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none;padding-left:10px}.markdown-body ul li::marker{content:"•";color:#3eaf7c}.markdown-body ul li.task-list-item:before{content:"";margin-right:0}.markdown-body input[type=checkbox]{vertical-align:text-bottom;box-shadow:inset 0 0 0 10px #fff}.markdown-body input[type=checkbox]:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04NzcuMDU2IDE0Ni45NDR2NzMwLjExMkgxNDYuOTQ0VjE0Ni45NDRoNzMwLjExMnptMC0xMDQuMjc3SDE0Ni45NDRjLTU3LjYyOCAwLTEwNC4yNzcgNDYuNjQ5LTEwNC4yNzcgMTA0LjI3N3Y3MzAuMTEyYzAgNTcuNjI4IDQ2LjY0OSAxMDQuMjc3IDEwNC4yNzcgMTA0LjI3N2g3MzAuMTEyYzU3LjYyOCAwIDEwNC4yNzctNDYuNjQ5IDEwNC4yNzctMTA0LjI3N1YxNDYuOTQ0YzAtNTcuNjI4LTQ2LjY0OS0xMDQuMjc3LTEwNC4yNzctMTA0LjI3N3oiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}.markdown-body input[type=checkbox]:checked:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTUiIGhlaWdodD0iMTUiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik05MTAuMjA4IDBIMTEzLjc2QTExNC4xMTIgMTE0LjExMiAwIDAwLS4wMzIgMTEzLjc5MlY5MTAuMjRjMCA2Mi41OTIgNTEuMiAxMTMuNzkyIDExMy43OTIgMTEzLjc5Mmg3OTYuNDQ4YzYyLjU5MiAwIDExMy43OTItNTEuMiAxMTMuNzkyLTExMy43OTJWMTEzLjc5MkMxMDI0IDUxLjIgOTcyLjggMCA5MTAuMjA4IDB6bS01MTIgNzk2LjQ0OEwxMTMuNzYgNTEybDc5LjY0OC03OS42NDggMjA0LjggMjA0LjhMODMwLjU2IDIwNC44bDc5LjY0OCA3OS42NDgtNTEyIDUxMnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="monokai">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#272822;color:#ddd}.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-strong,.hljs-tag{color:#f92672}.hljs-code{color:#66d9ef}.hljs-class .hljs-title{color:#fff}.hljs-attribute,.hljs-link,.hljs-regexp,.hljs-symbol{color:#bf79db}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-emphasis,.hljs-section,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-string,.hljs-subst,.hljs-template-tag,.hljs-template-variable,.hljs-title,.hljs-type,.hljs-variable{color:#a6e22e}.hljs-comment,.hljs-deletion,.hljs-meta,.hljs-quote{color:#75715e}.hljs-doctag,.hljs-keyword,.hljs-literal,.hljs-section,.hljs-selector-id,.hljs-selector-tag,.hljs-title,.hljs-type{font-weight:700}</style><p><em>本系列为 Android 技术职场题材虚构小说，所有登场人物、公司名称、组织架构及相关情节均为创作所需虚构而来，若有雷同，纯属偶然。书中涉及的技术知识经专业梳理，仅供参考。</em></p>
<h2 data-id="heading-0">十一）Bitmap优化套路深 多级缓存定乾坤</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/816c85e6c5d340c0823689c8bafe9aba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770079896&amp;x-signature=RP4NmFoPWOXTT3FJYPlfqwJrFGw%3D" alt="0.png" loading="lazy"/></p>
<p>新的一周，林卓早早来到公司，心情格外舒畅。阳光透过玻璃幕墙洒在大厅地砖上，折射出暖融融的光斑，难得避开早高峰拥堵的他，脚步都带着轻快。</p>
<p>他径直走向公司楼下的咖啡店，点了一杯热美式，指尖握着温热的杯壁，慢悠悠走回工位。此时办公室里还没几个人，键盘敲击声稀疏，只有中央空调的轻微声响，这份难得的闲暇在紧张的项目周期里显得格外珍贵。</p>
<p>林卓拉开椅子坐下，抿了一口咖啡，正准备梳理本周的工作安排，身后就传来了熟悉的脚步声。</p>
<p>“来得挺早啊，小林。”老杨背着背包走过来，随手把背包放在邻座空位上，语气透着几分轻松。他瞥了眼林卓桌上的热美式，笑着拉过一把椅子坐下，“还挺会享受，这会儿办公室都没几个人，倒让你占了份清净。”</p>
<p>林卓笑着点头回应：“嘿嘿，这周还没有什么新的安排嘛！这会儿能偷个闲，对了老杨，你们的大模型工作主要是干啥呀？”</p>
<p>老杨笑着摆了摆手，语气随意又带着点无奈：“还能啥，瞎忙活呗。车机端为了减少云端压力，想跑一个离线大模型，可车机算力有限，得把模型压缩到合适大小，还得保住识别准确率，磨人的很。”</p>
<p>他瞟了一眼林卓的工位，目光落在林卓的电脑屏幕上，话锋一转，“趁这会儿不忙，我倒想问问你个技术问题——如果给你一张超大分辨率的图片，比如 4000×3000 的，要在车机界面上显示，还得保证不卡顿、不崩内存，你怎么处理？”</p>
<p>林卓握着咖啡杯的手一顿，瞬间收起了放松的心思。他沉吟片刻，缓缓说道：“超大图直接加载肯定不行，会占用大量内存，大概率触发内存溢出错误。应该先对图片进行压缩处理，再考虑显示和优化。”</p>
<p>“没错，核心就是 <code>Bitmap</code> 的高效处理。”老杨点点头，语气里带着几分引导，“具体怎么压缩？怎么保证压缩后显示清晰，还不影响性能？你好好琢磨下。”说完便起身回了工位，椅子拖动的轻响过后，只留下林卓一人坐在原地。</p>
<p>林卓脸上还带着几分茫然，握着咖啡杯愣了两秒，心里暗自纳闷：好端端的闲聊，怎么突然问这个问题？</p>
<p>疑惑归疑惑，他没再多想，指尖无意识地敲击着桌面，脑子里已经开始飞速梳理超大图显示的核心逻辑。</p>
<p>正琢磨着，办公区入口传来脚步声，张磊拿着平板快步走来，目光扫过工位喊道：“林卓，到会议室开个短会，同步下新闻模块的新需求。”林卓连忙收起思绪，锁屏电脑，跟着张磊走向会议室。</p>
<p>会议室里只有三四个人，张磊开门见山，直接点开需求文档：“今天同步个紧急需求，给新闻模块加个《早间要闻》功能，核心是展示前一日的焦点新闻，内容由 AI 总结生成，数量不固定，多则十到二十条，少则五六条。”</p>
<p>他顿了顿，补充道：“因为是 AI 生成内容，特殊情况会比较多——比如图文排版错乱、图片尺寸不规则、文字长度差异大，都要做好兼容。功能优先级很高，周五正式提测，你们各司其职，林卓，你负责新闻的图文显示与适配开发，测试那边同步跟进。”</p>
<p>会议只开了十分钟就结束，林卓走出会议室，心里嘀咕着早上老杨问的问题，隐约觉得或许会用到，但也没深想，转头就全身心投入到新需求的梳理中。</p>
<p>林卓顺着需求细节仔细梳理，很快摸清了核心要点：AI 生成的内容没有固定模板，新闻数量、图文排版、图片尺寸全是变量，界面绘制的关键是兼容性和灵活性，必须先把 UI 显示的基础打牢。</p>
<p>他打开需求文档和 UI，在办公区的白板上，快速勾勒《早间要闻》的界面框架，明确了两大核心模块——新闻摘要列表和专题大图封面区，随后便聚焦 UI 绘制的解决方案。</p>
<p>他指尖轻点白板，顺便用记号笔勾勒几处重点，逐一拆解 UI 难题：新闻摘要卡片要统一样式，还得适配长短不一的 AI 生成文字，背景样式必须灵活；列表分隔线要简洁，还不能因新闻数量多变增加布局负担；专题区的封面大图，感觉没什么难度，直接加载显示就行，顶多有几个文字，这个好办。</p>
<p>思索片刻，他心里有了答案——用 <code>Drawable</code> 家族的不同子类针对性解决，刚好能覆盖这些 UI 适配场景。</p>
<p>时间来到下午，林卓全身心投入 UI 的开发。</p>
<p>他清楚 <code>Drawable</code> 作为可绘制内容的抽象基类，每个子类都有专属适配场景，正好能应对 AI 内容的不确定性，于是有条不紊地为三个核心 UI 场景敲定技术方案。</p>
<p>第一个是新闻摘要卡片，卡片大小不固定（要适配不同长度的 AI 新闻内容），背景还需要带阴影效果，用 <code>.9</code> 最合适。这种特殊格式能手动标记可拉伸区域，同时保留阴影细节，无论卡片被拉伸到多大，阴影边缘都不会模糊变形，完美适配 AI 内容的不确定性。林卓用工具处理好带阴影的 <code>.9</code> 图，直接导入项目就能复用，省去了反复调整布局的麻烦。</p>
<p>第二个是新闻附带的文字标签，标签没有阴影，但要做圆角处理，而且 AI 生成的新闻分类不同，标签颜色也得跟着变，总跟 UI 对接调色太耗时。林卓选用 <code>ShapeDrawable</code> 解决，通过 XML 直接定义圆角大小，颜色则预留代码接口动态设置，无需修改资源文件，既能满足样式要求，又大幅提升了开发效率，还能灵活应对标签颜色的多变需求。</p>
<p>至于专题区的封面大图，林卓反倒觉得没什么复杂的——直接把 AI 返回的图片下载到本地，再加载显示就行，哈哈。</p>
<p>不知不觉两天时间过去，林卓全身心扑在 UI 开发上，终于把 <code>Drawable</code> 适配逻辑全部落地，还完成了整体布局的整合调试，昨儿提测这部分的内容。</p>
<p>此时的他，正等着测试——小安的测试报告，看看有没有新的问题。</p>
<p>没过多久，小安抱着测试机走了过来，脸上带着几分纠结：“林卓，UI 走查和核心功能都过了，样式、适配全符合设计稿。”</p>
<p>她顿了顿：“但有两个明显问题，我已经提交 Bug 和日志了，你赶紧看看。问题集中在专题封面图，一是加载特别慢，进入专题区要等一两秒才显示；二是多打开几个车机软件再切回来，滚动几下，APP 直接崩溃了，日志里好像提示内存溢出。”</p>
<p>林卓心里一紧，打开 Bug 管理平台查看日志。他快速扫完日志内容，眉头瞬间皱了起来——崩溃原因果然是内存溢出，加载慢也和图片资源有关。他亲自复现了一遍问题，果然多打开几个新闻专题封面，直接闪退，封面图加载时也明显有卡顿感。</p>
<p>“不愧是你，小安，日志我先分析下。”林卓支走小安，心里泛起疑惑：怎么会内存溢出？</p>
<p>他反复核对代码，又对照日志里的内存占用记录，心里猜测大概率是图片本身过大导致的。</p>
<p>为了验证猜想，他找到代码中加载图片的逻辑，提取出 AI 返回的图片 URL，逐一复制到浏览器查看。</p>
<p>这不看不要紧，一看吓了一跳——这些图片分辨率参差不齐，小的才 480p，大的竟然直接是 4K 分辨率，体积远超预期。</p>
<p>林卓对着屏幕低声暗骂一句：“服务端这帮人，也不做下图片处理，净给前端填坑！” 此刻他才彻底明白，问题根源就在这无节制的图片分辨率上。</p>
<p>林卓突然恍然大悟，仿佛一道闪电劈进脑海！周一早上老杨问的问题，原来坑在这里！</p>
<p>明确问题根源后，林卓立刻动起手来。他先翻出老杨之前分享过的《Android 核心知识点》文档，找到内存优化相关的章节——那是老杨整理多年项目经验的精华，里面刚好有超大图处理的相关思路。</p>
<p>接着又在技术社区搜了不少车机端图片加载的实战案例，结合自己对需求的理解，慢慢定制出一套针对性的解决思路。</p>
<p>首先是解决“只读尺寸不加载”的核心问题。林卓利用 <code>BitmapFactory.Options</code> 的 <code>inJustDecodeBounds</code> 属性，将其设为 true 后，解码图片时只会返回宽高信息，不会真正分配内存。这样就能在不占用资源的前提下，摸清 AI 生成图片的实际尺寸，避免盲目加载导致内存压力。</p>
<p>摸清尺寸后，下一步计算采样率。采样率直接决定图片缩放比例，比如采样率为 2 时，图片宽高各缩为原来的二分之一，内存占用可降至四分之一。</p>
<p>林卓参照标准算法编写逻辑，确保缩放后的图片尺寸不小于车机控件显示尺寸，既控制内存占用，又避免图片模糊，还开启了抖动优化提升显示质感。</p>
<p>他用一张 4K 的测试图模拟 AI 超大图场景，对应车机专题区 720P 的显示尺寸，优化后内存占用从近 20MB 降至 1.6MB 左右，内存占用有明显优化。</p>
<p>但林卓测试时发现，第一次进入页面仍有加载延迟，快速滑动列表时图片会闪烁，这里就有两个原因了：</p>
<ol>
<li>大图片下载慢</li>
<li>重新压缩图片，也需要一番时间</li>
</ol>
<p>要解决这个问题，必须搭建缓存策略。林卓采用“内存缓存 + 磁盘缓存”的组合方案。</p>
<p>内存缓存用 <code>LruCache</code> 实现，分配大概 10mb 作为容量，自动回收最少使用的图片对象，供封面图快速访问；磁盘缓存用 <code>DiskLruCache</code>，将解码后的图片存储在本地，设置 30MB 缓存上限，避免下次进入页面重复解码。</p>
<p>为了不阻塞主线程，同时更加稳定的加载图片，他用 <code>WorkManager</code> 创建后台任务，在子线程中处理图片解码和缓存逻辑，还封装了统一的加载方法：优先从内存缓存读取，内存无则查磁盘缓存，两者都无再启动后台任务解码，解码完成后同步存入两级缓存。同时他还添加了淡入动画，让图片从透明过渡到不透明，掩盖加载间隙，提升视觉体验。</p>
<p>缓存策略上线后，林卓喊来小安复测。这次页面加载迅速，快速滑动无闪烁，小安逐条核对后露出笑容：“丝滑！“</p>
<p>”不过还有个小问题，专题大图点击放大时动画生硬，感觉是跳过去的，而不是过渡过去的。这个倒不是你的问题，我直接提给产品了”</p>
<p>林卓闻言心里一紧，暗自腹诽：“我的小祖宗！这都要上线了，别再给我加需求了！”</p>
<p>嘴上却只能笑着应下：“行，你先提给产品，我看看能不能顺手优化了，尽量不耽误上线进度。”</p>
<p>虽说心里吐槽，但他也清楚动画体验会影响产品质感，转头就收起杂念，投入到动画知识点的补充学习中。</p>
<p>他找到 Android 动画相关的文档——这内容可真不少！</p>
<p>不过现在的他不可同日而语，历经好几次的产品需求实现和优化，现在的他早已驾轻就熟了。</p>
<p>很快他就梳理完了 <code>AnimatorSet</code> 的使用方法，重点琢磨缩放与平移动画的时序衔接、插值器参数调整。</p>
<p>加之之前 <code>Bitmap</code> 优化和 <code>Drawable</code> 适配的基础，动画知识点上手很快，短短一个下午就吃透了核心逻辑，还针对性调整了动画时长与过渡曲线，让大图放大效果更丝滑。</p>
<p>第二天一早，产品拿着优化建议找到他，明确提出要优化专题大图的放大过渡动画，强调“生硬跳转影响用户体验”，要求上线前搞定。</p>
<p>林卓心里虽有“临时加需求”的无奈，但也清楚体验优先级，立刻收起杂念投入开发。</p>
<p>嘿嘿，幸好昨儿学习的差不多了，把昨儿写的大部分示例代码，移植过来，针对 UI 优化一下就行了！</p>
<p>上午优化完成后，林卓第一时间同步给小安提测，仅用半天就完成了验收。</p>
<p>......</p>
<p>周五下午，《早间要闻》UI 相关需求全部正式提测，忙得脚不沾地的林卓长舒一口气，当即约了老杨和小安去吃小火锅，算是给这一周的奋战收尾。</p>
<p>火锅店堂里人声鼎沸，烟火气十足，三人找了个靠窗的小桌坐下，肥牛卷刚下锅翻滚，林卓就对着两人大倒苦水：“你们是不知道，这次最坑的就是服务端那帮人，返回的图片大小没个准头，小的才 480p，大的直接 4K，害得我额外花了两天优化 <code>Bitmap</code> 和缓存，差点就耽误进度要周末加班了。”</p>
<p>他说着端起饮料碰了碰老杨的杯子，语气满是庆幸：“还好老杨你周一提前问了我超大图的问题，不然我压根没往这方面想，周末指定得泡在公司了，谢了啊，我先干了！”</p>
<p>老杨夹着一片毛肚涮着，漫不经心地抬眼笑道：“嘻嘻，那图片本来就是我这边返回的。”</p>
<p>见林卓瞬间愣住，他才慢悠悠补充，“车机端这个离线大模型，前期数据都是直接从网上爬的，没做过滤和压缩，细节优化得等功能跑通了再搞，先把核心流程跑起来再说。”</p>
<p>林卓脸上的感激之情瞬间僵住，嘴里的饮料还没喝完，差点一口呛住，等稳住心神，随即气不打一处来，伸手拍了下老杨的胳膊：“合着坑我的人就是你啊！我说你怎么突然问那问题，原来早知道有这茬！”</p>
<p>小安在一旁笑得直不起腰，握着筷子的手都跟着发颤，刚夹起一片毛肚要往锅里放，又忍不住缩回手按住肚子，眼泪都快笑出来了。</p>
<p>林卓瞪了老杨一眼，干脆摆起架子：“老杨，那这顿，你请客！”</p>
<p>老杨乐呵呵地应下：“没问题，想吃啥随便点，我请客。”</p>
<p>酒足饭饱，老杨结完账，拍了拍林卓的肩膀随口提了句：“对了，你这次做的大图放大动画还行，后续可以研究研究 <code>MotionLayout</code>，更丝滑，还能和布局联动做动画。”</p>
<p>林卓一听，当即垮了脸，吐槽道：“什么意思？这刚忙完又给我埋坑是吧？”</p>
<p>老杨笑着拍拍肩，语气带着点过来人式的调侃：“不自己踩踩坑，怎么把知识点吃透、长记性？下次遇到类似问题，不就轻车熟路了？”</p>
<p>三人并肩走出火锅店，晚风带着凉意，却吹不散并肩作战后的轻松惬意。</p>
<p>林卓嘴上抱怨着老杨挖坑，心里却清楚，这一周的磕磕绊绊，早已让他把图片优化的知识点刻进了心里，这份成长，远比少踩一个坑更珍贵。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么没人走后门当程序员？]]></title>    <link>https://juejin.cn/post/7599581204859715610</link>    <guid>https://juejin.cn/post/7599581204859715610</guid>    <pubDate>2026-01-27T00:51:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599581204859715610" data-draft-id="7599565587153141786" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么没人走后门当程序员？"/> <meta itemprop="keywords" content="前端,后端,程序员"/> <meta itemprop="datePublished" content="2026-01-27T00:51:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CodeSheep"/> <meta itemprop="url" content="https://juejin.cn/user/4371313961738616"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么没人走后门当程序员？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4371313961738616/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CodeSheep
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T00:51:19.000Z" title="Tue Jan 27 2026 00:51:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近刷 X 乎时看到这样一个耐人寻味的的讨论话题，浏览量超 170w，参与讨论的同学也好多。</p>
<p>问题描述是这样的：</p>
<p><strong>“为什么没人走后门当程序员？”</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d11f8a22a6c74464b54c2681faf97684~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZVNoZWVw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770079881&amp;x-signature=tI4vQtuhQ1hGSabAPGSSVG9DfHY%3D" alt="" loading="lazy"/></p>
<p>我认真浏览了一圈，心里五味杂陈。</p>
<p>在许多人眼中，程序员是一个高薪的职业。然而，即便程序员们拿着如此令人羡慕的高薪，尽管互联网行业如此火热，但却几乎很少听说有人说走后门想进去。</p>
<p>其实这事情一点也不难理解，这得先从程序员工作的本质说起。</p>
<p>因为程序员这个职业，从根子上来说压根就不靠后门吃饭。</p>
<p>而且程序员这行，恰恰是最混不了日子的，它要求你持续学习，跟上技术迭代，解决一个个具体而棘手的问题。</p>
<p>编程是一个实实在在的技术活，当你的代码运行不起来，它就是运行不起来，你写的系统有漏洞，它就会在某个深夜悄然崩溃，这种刚性特质就决定了程序员这个岗位无法容忍滥竽充数者。</p>
<p>而程序员的门槛，是技术，是能力，走后门也写不出一行能跑通的代码。</p>
<p>退一步说，哪怕就算你真靠后门挤进了公司，项目一上来，分分钟就会露馅。</p>
<p>那些想走后门的人，大概率是想找一个稳当、轻松、有人脉资源的工作。但反思程序员这行，是这样吗？好……好像哪个也不沾边吧……</p>
<p>所以没人走后门干程序员，不是因为这行没前途，而是因为它太实在、太透明、太难伪装。</p>
<p>这是一份必须用真本事去交换的职业，关系在这里，价值被迅速稀释到近乎为零。</p>
<p>另外大家往往有种误解或者说错觉，总觉得程序员赚得多就是香，而实际却忽略了这个高薪背后所付出的代价，这一切都是来源于高强度脑力劳动和长时间脑力付出所带来的回报。</p>
<p>再者，互联网行业的本质是工程化与扁平化。在这个体系里，你是谁、认识谁、从哪来，其实并不太重要，没人会关注你这个，英雄不问出处。</p>
<p>重要的是，你能不能解决问题，能不能为项目创造价值。</p>
<p>所以，当我们回过头来再看，为什么没人走后门干程序员这个问题，其实本身就蕴含着一种误解。它预设了程序员是一个好差事，一个可以让人躺着赚钱的美差。</p>
<p>但事实上，程序员是一份需要真才实学、持续奋斗、直面挑战的工作。你付出多少努力，掌握多少技能，最终都会在你的代码和收入上得到真实的反馈。</p>
<p>当然，这里还有一点需要反思的是：</p>
<p>该说不说，程序员行业的这种去关系化特质，其实某一角度来说也带来了一些副产品。</p>
<p>比方说，技术至上的工作文化有时会导致个体沟通能力的忽视，对硬技能的过度强调可能让软技能的发展有所滞后，另外代码世界的非黑即白有时候也会让人忽略了现实世界的复杂灰度。</p>
<p>这些其实都是程序员文化中值得反思和平衡的地方。</p>
<p>有一说一，其实很多代码之外的东西对现如今的生存也很重要，因为思维如果不开阔出来的话，路可能就会越走越窄了。</p>
<p>其实很多程序员在年龄大了之后越来越焦虑的一个重要原因就是因为生存技能太过单一了，所以千万不要给自己设限，不要把目光仅仅聚集在自己的一亩三分地上，还是要多培养一些其他方面的一些软实力，会很有帮助。</p>
<p>不知道大家有没有看过《软技能》那两本书，讲的就是代码之外的一些软技能和经验，里面提到了很多有关职场的分析，自我提高的一些路径，个人的持续学习和成长，甚至包括像理财、健身、时间管理、心态调整等等。</p>
<p>有意识地去关注这方面东西的原因在于可以帮助自己把思维给开阔出来，毕竟很多时候有必要跳出来看问题，这时候这些软技能往往就能发挥作用了。</p>
<p>另外，程序员作为一个有个性的创造性群体要专注精进技术这本身没错，但是职场毕竟也是一个充满人情世故的江湖，所以掌握一些通用的职场规则、沟通技巧，甚至是向上管理的艺术，这对于程序员来说也是十分有必要的。</p>
<p>仰望星空，脚踏实地，埋头赶路的同时也不要忘记时常抬头看看周围的环境和机会。</p>
<p>那关于这个问题，你的看法是什么呢，如果有不同的见解，也欢迎一起来分享交流~</p>
<blockquote>
<p>注：本文在GitHub开源仓库「编程之路」 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frd2coding%2FRoad2Coding" target="_blank" title="https://github.com/rd2coding/Road2Coding" ref="nofollow noopener noreferrer">github.com/rd2coding/R…</a> 中已经收录，里面有我整理的6大编程方向(岗位)的自学路线+知识点大梳理、面试考点、我的简历、几本硬核pdf笔记，以及程序员生活和感悟，欢迎star。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vercel Skills 详解]]></title>    <link>https://juejin.cn/post/7599551824548020250</link>    <guid>https://juejin.cn/post/7599551824548020250</guid>    <pubDate>2026-01-26T16:28:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599551824548020250" data-draft-id="7599551824548003866" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vercel Skills 详解"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-26T16:28:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="左Python右Java"/> <meta itemprop="url" content="https://juejin.cn/user/4107431173952525"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vercel Skills 详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4107431173952525/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    左Python右Java
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T16:28:51.000Z" title="Mon Jan 26 2026 16:28:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Vercel Skills 详解</h2>
<h3 data-id="heading-1">一、什么是 Vercel Skills？</h3>
<p><strong>Vercel Skills</strong>（也称为 Agent Skills）是由 Vercel 推出的一个<strong>AI 编程助手的技能包管理器</strong>。它是一个开源项目，专门为 AI 智能体设计，用于管理和分发 AI 编码代理的技能包。</p>
<h4 data-id="heading-2">核心特点：</h4>
<ol>
<li><strong>技能包管理器</strong>：类似 npm，但专门针对 AI 智能体</li>
<li><strong>最佳实践集合</strong>：将多年的开发经验和最佳实践转化为 AI 可理解的技能</li>
<li><strong>自动化分发</strong>：自动将技能包分发到对应的 AI 工具配置目录</li>
<li><strong>开源免费</strong>：完全开源，免费使用</li>
<li><strong>专注 React/Next.js</strong>：目前主要专注于 React 和 Next.js 生态</li>
</ol>
<h3 data-id="heading-3">二、怎么用？</h3>
<h4 data-id="heading-4">1. 安装技能包</h4>
<p>使用一行命令即可安装技能包：</p>
<pre><code class="hljs language-bash" lang="bash">npx add-skill vercel-labs/agent-skills
</code></pre>
<p>这个命令会：</p>
<ul>
<li>从 GitHub 下载技能包</li>
<li>检测系统中安装的 AI 工具</li>
<li>自动将技能分发到每个工具对应的配置目录</li>
</ul>
<h4 data-id="heading-5">2. 支持的 AI 工具</h4>
<p>Vercel Skills 支持多种 AI 编码工具，包括但不限于：</p>
<ul>
<li>Cursor</li>
<li>GitHub Copilot</li>
<li>Windsurf</li>
<li>其他 AI 编码助手</li>
</ul>
<h4 data-id="heading-6">3. 技能包内容</h4>
<p>Vercel Skills 包含以下技能模块：</p>
<h5 data-id="heading-7">React 和 Next.js 性能优化</h5>
<ul>
<li>45 条性能优化黄金法则</li>
<li>组件渲染优化</li>
<li>状态管理最佳实践</li>
<li>路由优化技巧</li>
</ul>
<h5 data-id="heading-8">网页设计审查</h5>
<ul>
<li>响应式设计规范</li>
<li>可访问性标准</li>
<li>UI/UX 最佳实践</li>
<li>性能指标检查</li>
</ul>
<h5 data-id="heading-9">代码质量标准</h5>
<ul>
<li>代码风格规范</li>
<li>安全性检查</li>
<li>错误处理模式</li>
<li>测试覆盖率要求</li>
</ul>
<h4 data-id="heading-10">4. 使用示例</h4>
<h5 data-id="heading-11">安装后，AI 助手会自动获得以下能力：</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// AI 会自动应用最佳实践</span>
<span class="hljs-comment">// 优化前</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">UserList</span>(<span class="hljs-params">{ users }</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      {users.map(user =&gt; (
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{user.id}</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>{user.name}<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{user.email}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      ))}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}

<span class="hljs-comment">// AI 会优化为（应用 Skills 中的性能优化规则）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">UserList</span>(<span class="hljs-params">{ users }</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"user-list"</span>&gt;</span>
      {users.map(user =&gt; (
        <span class="hljs-tag">&lt;<span class="hljs-name">article</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{user.id}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"user-card"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"user-name"</span>&gt;</span>{user.name}<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"user-email"</span>&gt;</span>{user.email}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">article</span>&gt;</span>
      ))}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<h4 data-id="heading-12">5. 自定义技能包</h4>
<p>你也可以创建自己的技能包：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建自定义技能包</span>
<span class="hljs-built_in">mkdir</span> my-skills
<span class="hljs-built_in">cd</span> my-skills

<span class="hljs-comment"># 初始化技能包配置</span>
npx add-skill init

<span class="hljs-comment"># 添加自定义技能</span>
<span class="hljs-comment"># 编辑 skill.md 文件，定义你的最佳实践</span>
</code></pre>
<h3 data-id="heading-13">三、为什么需要 Vercel Skills？</h3>
<h4 data-id="heading-14">1. 解决 AI 理解框架规范的挑战</h4>
<p><strong>问题</strong>：</p>
<ul>
<li>AI 模型训练数据可能不包含最新的框架规范</li>
<li>不同框架有复杂的最佳实践和性能优化规则</li>
<li>AI 可能生成不符合生产环境标准的代码</li>
</ul>
<p><strong>解决方案</strong>：</p>
<ul>
<li>Vercel Skills 将最佳实践转化为 AI 可理解的格式</li>
<li>让 AI 知道 10 多年的 React 和 Next.js 开发经验</li>
<li>确保生成的代码达到生产级标准</li>
</ul>
<h4 data-id="heading-15">2. 提高代码质量</h4>
<p><strong>优势</strong>：</p>
<ul>
<li><strong>性能优化</strong>：自动应用 45 条性能优化黄金法则</li>
<li><strong>代码规范</strong>：遵循统一的编码标准</li>
<li><strong>安全性</strong>：内置安全检查和最佳实践</li>
<li><strong>可维护性</strong>：生成易于维护的代码结构</li>
</ul>
<h4 data-id="heading-16">3. 加速开发流程</h4>
<p><strong>效率提升</strong>：</p>
<ul>
<li>减少代码审查时间</li>
<li>减少重构和优化工作</li>
<li>让 AI 助手"像 Vercel 工程师附体"</li>
<li>性能飙升，代码质量直接达到生产级</li>
</ul>
<h4 data-id="heading-17">4. 统一团队标准</h4>
<p><strong>团队协作</strong>：</p>
<ul>
<li>所有团队成员的 AI 助手使用相同的技能包</li>
<li>确保代码风格和最佳实践的一致性</li>
<li>降低新人学习成本</li>
<li>提高团队整体开发效率</li>
</ul>
<h4 data-id="heading-18">5. 持续更新和改进</h4>
<p><strong>生态优势</strong>：</p>
<ul>
<li>开源社区持续贡献新的技能</li>
<li>Vercel 官方维护和更新</li>
<li>跟随框架发展及时更新最佳实践</li>
<li>社区驱动的技能共享</li>
</ul>
<h3 data-id="heading-19">四、实际应用场景</h3>
<h4 data-id="heading-20">1. 新项目开发</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 在新项目中安装技能包</span>
npx add-skill vercel-labs/agent-skills

<span class="hljs-comment"># AI 助手会自动应用最佳实践</span>
<span class="hljs-comment"># 生成符合 Vercel 标准的代码</span>
</code></pre>
<h4 data-id="heading-21">2. 代码审查</h4>
<p>AI 助手会根据 Skills 中的规则：</p>
<ul>
<li>检查性能问题</li>
<li>识别安全隐患</li>
<li>提出优化建议</li>
<li>确保代码质量</li>
</ul>
<h4 data-id="heading-22">3. 重构优化</h4>
<p>AI 助手可以：</p>
<ul>
<li>应用性能优化规则</li>
<li>改进代码结构</li>
<li>提升可维护性</li>
<li>优化用户体验</li>
</ul>
<h4 data-id="heading-23">4. 团队培训</h4>
<p>新团队成员通过 Skills：</p>
<ul>
<li>快速学习最佳实践</li>
<li>了解框架规范</li>
<li>掌握性能优化技巧</li>
<li>提高代码质量意识</li>
</ul>
<h3 data-id="heading-24">五、总结</h3>
<p><strong>Vercel Skills</strong> 是一个革命性的工具，它：</p>
<ol>
<li><strong>是什么</strong>：AI 编程助手的技能包管理器</li>
<li><strong>怎么用</strong>：一行命令 <code>npx add-skill vercel-labs/agent-skills</code> 安装</li>
<li><strong>为什么</strong>：让 AI 生成的代码达到生产级标准，提高开发效率和代码质量</li>
</ol>
<p>它将多年的开发经验和最佳实践转化为 AI 可理解的技能，让 AI 助手能够像经验丰富的工程师一样编写高质量的代码。这对于提高团队开发效率、统一代码标准、降低维护成本都具有重要意义。</p>
<p>如果你正在使用 AI 编码工具（如 Cursor、GitHub Copilot 等），强烈建议尝试 Vercel Skills，它会显著提升你的开发体验和代码质量。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>