<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[Python开发者必备的5个高效技巧，90%的人不知道第二个！]]></title>    <link>https://juejin.cn/post/7599598627008315444</link>    <guid>https://juejin.cn/post/7599598627008315444</guid>    <pubDate>2026-01-27T04:19:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599598627008315444" data-draft-id="7599703627788992552" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python开发者必备的5个高效技巧，90%的人不知道第二个！"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2026-01-27T04:19:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python开发者必备的5个高效技巧，90%的人不知道第二个！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T04:19:12.000Z" title="Tue Jan 27 2026 04:19:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Python开发者必备的5个高效技巧，90%的人不知道第二个！</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>Python作为一门简洁、易读且功能强大的编程语言，已经成为开发者的首选工具之一。然而，尽管许多开发者能够熟练使用Python的基础语法和常见库，但很少有人真正掌握那些可以显著提升开发效率的高级技巧。本文将揭示5个鲜为人知但极其高效的Python技巧，帮助你在日常开发中事半功倍。特别值得一提的是，第二个技巧90%的开发者都不知道！</p>
<hr/>
<h2 data-id="heading-2">主体</h2>
<h3 data-id="heading-3">1. 使用<code>functools.lru_cache</code>优化递归函数</h3>
<p>递归函数在解决某些问题时非常直观，但性能问题常常让人望而却步。Python的<code>functools</code>模块提供了一个名为<code>lru_cache</code>的装饰器，可以缓存函数的计算结果，避免重复计算。</p>
<h4 data-id="heading-4">示例：斐波那契数列</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> lru_cache

<span class="hljs-meta">@lru_cache(<span class="hljs-params">maxsize=<span class="hljs-literal">None</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">fibonacci</span>(<span class="hljs-params">n</span>):
    <span class="hljs-keyword">if</span> n &lt; <span class="hljs-number">2</span>:
        <span class="hljs-keyword">return</span> n
    <span class="hljs-keyword">return</span> fibonacci(n-<span class="hljs-number">1</span>) + fibonacci(n-<span class="hljs-number">2</span>)
</code></pre>
<h4 data-id="heading-5">优势</h4>
<ul>
<li><strong>显著提升性能</strong>：对于重复计算的递归调用（如斐波那契数列），缓存可以将时间复杂度从O(2^n)降低到O(n)。</li>
<li><strong>简单易用</strong>：只需添加一个装饰器即可实现缓存功能。</li>
</ul>
<h4 data-id="heading-6">注意事项</h4>
<ul>
<li><code>maxsize</code>参数用于限制缓存的大小，设为<code>None</code>表示不限制。</li>
<li>对于有副作用的函数或不纯的函数（依赖外部状态），慎用缓存。</li>
</ul>
<hr/>
<h3 data-id="heading-7">2. 利用<code>__slots__</code>节省内存（90%的人不知道！）</h3>
<p>Python的对象默认使用字典（<code>__dict__</code>）来存储属性，这会带来额外的内存开销。通过定义<code>__slots__</code>，可以显式声明对象的属性列表，从而避免动态字典的开销。</p>
<h4 data-id="heading-8">示例</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>:
    __slots__ = [<span class="hljs-string">'name'</span>, <span class="hljs-string">'age'</span>]
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name, age</span>):
        self.name = name
        self.age = age
</code></pre>
<h4 data-id="heading-9">优势</h4>
<ul>
<li><strong>节省内存</strong>：对于需要创建大量实例的类（如ORM模型），内存占用可减少50%以上。</li>
<li><strong>加速属性访问</strong>：由于属性访问不再需要通过字典查找，速度更快。</li>
</ul>
<h4 data-id="heading-10">注意事项</h4>
<ul>
<li><code>__slots__</code>会禁用动态添加属性的能力（即无法在运行时添加新属性）。</li>
<li>继承时需谨慎：如果父类有<code>__slots__</code>，子类也需要定义自己的<code>__slots__</code>。</li>
</ul>
<hr/>
<h3 data-id="heading-11">3. 使用上下文管理器管理资源</h3>
<p>Python的上下文管理器（通过<code>with</code>语句实现）是管理资源（如文件、数据库连接、锁）的最佳实践。除了内置的上下文管理器外，还可以通过标准库中的<code>contextlib.contextmanager</code>轻松自定义。</p>
<h4 data-id="heading-12">示例：自定义计时器上下文管理器</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> contextlib <span class="hljs-keyword">import</span> contextmanager
<span class="hljs-keyword">import</span> time

<span class="hljs-meta">@contextmanager</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">timer</span>():
    start = time.time()
    <span class="hljs-keyword">yield</span>
    end = time.time()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"耗时: <span class="hljs-subst">{end - start:<span class="hljs-number">.2</span>f}</span>秒"</span>)

<span class="hljs-comment"># 使用方式</span>
<span class="hljs-keyword">with</span> timer():
    time.sleep(<span class="hljs-number">1</span>)
</code></pre>
<h4 data-id="heading-13">优势</h4>
<ul>
<li><strong>资源自动释放</strong>：确保资源在使用后正确关闭或释放（如文件、锁）。</li>
<li><strong>代码更清晰</strong>：避免了手动调用清理逻辑的繁琐操作。</li>
</ul>
<h4 data-id="heading-14">扩展应用</h4>
<p>结合多个上下文管理器可以使用嵌套或标准库中的<code>socket.create_connection()</code>等高级功能。</p>
<hr/>
<h3 data-id="heading-15">4. Python的动态导入与反射机制</h3>
<p>Python的动态导入和反射能力允许程序在运行时加载模块或获取对象信息，这在插件系统或配置化开发中非常有用。</p>
<h4 data-id="heading-16">示例：动态导入模块并调用函数</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> importlib

module_name = <span class="hljs-string">"math"</span>
function_name = <span class="hljs-string">"sqrt"</span>

module = importlib.import_module(module_name)
func = <span class="hljs-built_in">getattr</span>(module, function_name)
result = func(<span class="hljs-number">4</span>)  <span class="hljs-comment"># result为2.0</span>
</code></pre>
<h4 data-id="heading-17">优势</h4>
<ul>
<li><strong>灵活性高</strong>：可以根据配置或用户输入动态加载功能模块。</li>
<li><strong>解耦代码</strong>：主程序不需要硬编码所有可能的模块依赖。</li>
</ul>
<p>####注意事项</p>
<ul>
<li><strong>安全问题</strong>：动态加载可能导致恶意代码执行（如用户输入的模块名）。建议对输入做严格校验。</li>
</ul>
<hr/>
<p>###5.利用生成器和迭代器优化大数据处理</p>
<p>在处理大规模数据集时,传统的列表操作可能会导致内存爆炸.Python生成器和迭代器提供了一种惰性计算的方式,只在需要时才生成数据.</p>
<p>####示例:读取大文件的行</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">read_large_file</span>(<span class="hljs-params">file_path</span>): 
 <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file_path,<span class="hljs-string">'r'</span>)<span class="hljs-keyword">as</span> f: 
 <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> f: 
 <span class="hljs-keyword">yield</span> line.strip() 

<span class="hljs-comment">#使用方法 </span>
<span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> read_large_file(<span class="hljs-string">'huge_file.txt'</span>): 
 process(line)<span class="hljs-comment">#逐行处理而不加载整个文件到内存 </span>
</code></pre>
<p>####优势</p>
<ul>
<li><strong>内存高效</strong>:理论上可以处理无限大的数据集.</li>
<li><strong>链式操作</strong>:可以与map(),filter()等无缝结合.</li>
</ul>
<p>####高级技巧
itertools标准库提供了许多强大的迭代器工具,如groupby(),islice()等.</p>
<hr/>
<p>##总结</p>
<p>Python的强大不仅在于其简洁语法和丰富生态,更在于这些隐藏的高级特性.本文介绍的五个技巧:</p>
<p>1.functools.lru_cache优化递归性能.
2.__slots_节省对象内存.
3.上下文管理器优雅管理资源.
4.动态导入实现灵活架构.
5.生成器处理大数据集.</p>
<p>特别是第二个_slots_技巧,确实很少被提及却能带来显著的性能提升.掌握这些技术将帮助你写出更高效、更专业的Python代码</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Agent Skills 傻瓜式教程，26 年最火 AI 技术就这？]]></title>    <link>https://juejin.cn/post/7599604510366236710</link>    <guid>https://juejin.cn/post/7599604510366236710</guid>    <pubDate>2026-01-27T03:47:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599604510366236710" data-draft-id="7599601258639851558" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Agent Skills 傻瓜式教程，26 年最火 AI 技术就这？"/> <meta itemprop="keywords" content="Agent,AI编程,程序员"/> <meta itemprop="datePublished" content="2026-01-27T03:47:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员鱼皮"/> <meta itemprop="url" content="https://juejin.cn/user/2444938365386621"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Agent Skills 傻瓜式教程，26 年最火 AI 技术就这？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2444938365386621/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员鱼皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T03:47:57.000Z" title="Tue Jan 27 2026 03:47:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你是小阿巴，正在用 AI 开发网站。</p>
<p>为了让 AI 生成的效果更好，你告诉 AI：</p>
<ul>
<li>界面不要使用蓝紫渐变色</li>
<li>不要生成一大堆没用的文档</li>
<li>你要遵循公司的代码规范</li>
</ul>
<p>阿巴阿巴，洋洋洒洒几百字。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/679b43432ead4cf6a57acd53a29e8073~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=TeEBMi%2F5J7QMrT0ZJLZh6JknAFA%3D" alt="" loading="lazy"/></p>
<p>之后每次开发网站时，你都要写这么一段又臭又长的提示词，太麻烦了！</p>
<p>于是聪明的你开始想办法。</p>
<p>先把常用的提示词保存到单独的文件（比如 <code>prompts.md</code>），每次手动投喂给 AI。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83b1fb79c339412eafb488bb86595b6b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=1Y7usVzvxtoYiLEZB6kPYdVYvd0%3D" alt="" loading="lazy"/></p>
<p>然后创建了资源文件夹，把公司的代码规范、设计素材都塞进去，告诉 AI 参考这些写。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/148922b9a5b7486ab8ad1bcbc642b7ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=2evfwv1Wcx5xo%2Brbe0A7uCs9xFQ%3D" alt="" loading="lazy"/></p>
<p>接着你还写了一些脚本，让 AI 生成代码后自动执行格式化、运行测试、提交代码到 Git。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1c09f4d60b340fa8f93f3b0ad83dba3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=kP8GHXUTbxIDTToaDfJrrGVt9y8%3D" alt="" loading="lazy"/></p>
<p>最后我再写个 <code>AGENTS.md</code> 文件，把所有规范和工作流程都写进去，让 AI 自动读取。</p>
<p>你沾沾自喜：嘿嘿，俺这套工作流，堪称完美！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b578ed01aff42d285e2888fc378ab76~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=%2FUjEiijCFQfyDDDqyCdoeT4TUPQ%3D" alt="" loading="lazy"/></p>
<p>但很快，你发现了问题，随着规范越写越多，文档越来越臃肿，每次对话都要占用很多 AI 上下文空间，浪费 tokens。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7db28b039f524327a356315c6cd04825~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=uInCHUZrRGE7%2B%2FydQ4zc4aqhQNU%3D" alt="" loading="lazy"/></p>
<p>于是你找到号称 “没有人比他更不懂 AI” 的鱼皮求助：阿巴阿巴，俺还能咋办啊……</p>
<p>鱼皮：不是有 Agent Skills 么？为啥不直接用？</p>
<p>你一脸懵：啥玩意儿？</p>
<p>鱼皮：这可是最近 AI 圈儿爆火的技术，下面我来带你玩转 Agent Skills，让你知道它是什么、怎么用、有什么魔力、怎么自己开发。</p>
<p>点个收藏，我们开始~</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5336a764f16f47f383c99b10ae53c0e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=8gN9NoO5EzJFAvWnm6eLrr5mQ3I%3D" alt="" loading="lazy"/></p>
<p>⭐️ 推荐观看视频动画版，更通俗易懂：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1T7zzBQEaA%2F" target="_blank" title="https://www.bilibili.com/video/BV1T7zzBQEaA/" ref="nofollow noopener noreferrer">bilibili.com/video/BV1T7…</a></p>
<h2 data-id="heading-0">什么是 Agent Skills？</h2>
<p>Agent Skills 是 Anthropic 推出的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.claude.com%2Fdocs%2Fzh-CN%2Fagents-and-tools%2Fagent-skills%2Foverview" target="_blank" title="https://platform.claude.com/docs/zh-CN/agents-and-tools/agent-skills/overview" ref="nofollow noopener noreferrer">一套开放标准</a>，目的是让 AI 能够学习使用各种专业技能，而不用每次都重复输入提示词。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f1b4bacf0ca44d4181e34e53cf7283a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=3%2BSARWDnxS5jfedkN2o1XSlgQeE%3D" alt="" loading="lazy"/></p>
<p>简单来说，它就是给 AI 装备的 <strong>技能包</strong>。技能包里有精心设计的提示词、代码脚本、还有各种资源文件。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a9ef63fc4d4846dcbd3ac90c397bb5d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=cSNmXU3HLWSvtjozg6FKHn50th4%3D" alt="" loading="lazy"/></p>
<p>把 AI 想象成一个职场小白，给他装上 <code>文档处理技能</code>，它就立刻知道怎么生成 PPT、处理 Excel 表格；装上 <code>代码规范技能</code>，它就知道怎么按照公司标准写代码。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/166861d335e74f3f9b4427e2dc61059f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=UpGGuGplWBOQTUjLPoETh%2FIf5Rs%3D" alt="" loading="lazy"/></p>
<p>你挠挠头：等等…… 这不就是俺在做的事吗？把教 AI 做事的文档和 AI 要用到的文件打包成文件夹？</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/823301f368fc49ae86e7fa117ffbfc55~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=%2BhcF5Dhs1U1uDsG1W8qv0vaBJ%2FE%3D" alt="" loading="lazy"/></p>
<p>鱼皮：差不多，但 Anthropic 把它做成了一个通用标准，而且在实现原理上有一些新花样……</p>
<p>你捶胸顿足：可恶啊，俺差点就改变世界了！这能有什么新花样？</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3176d76d2bdc4f598096ac013095992d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=HOM2ctzw43K%2BS2awAb6ibv6Gdtw%3D" alt="" loading="lazy"/></p>
<p>鱼皮：我先来带你用一下 Agent Skills，再跟你说说其中的奥秘。</p>
<h2 data-id="heading-1">Agent Skills 入门实战</h2>
<p>目前对 Agent Skills 支持最完善的工具是 Anthropic 官方的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fclaude.com%2Fproduct%2Fclaude-code" target="_blank" title="https://claude.com/product/claude-code" ref="nofollow noopener noreferrer">Claude Code</a>，我们就以此为例，安装并使用 Skills。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf5cf3d805044393b2588e7b03bd0337~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=KSc6GVPj5MTnP9AfZUNVxViqOvo%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">1、安装 Skills 技能</h3>
<p>先打开 Claude Code 并输入命令，添加官方技能市场：</p>
<pre><code class="hljs language-bash" lang="bash">/plugin marketplace add anthropics/skills
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb02defb82114c5aab11197bff2515cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=xiiE%2BKteEMahXaviOJXFcepeyMY%3D" alt="" loading="lazy"/></p>
<p>这就像是在你的 AI 助手里开通了一个技能商店，接下来你就可以从商店中获取技能了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a961c2c19c3641629a2b85324b93b868~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=JB1NEvvaPmUfdKaplxvqxnrdBwg%3D" alt="" loading="lazy"/></p>
<p>在 Claude Code 中输入命令，安装官方提供的技能包：</p>
<pre><code class="hljs language-bash" lang="bash">/plugin install example-skills@anthropic-agent-skills
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24b260ec18514ec48147629639e6e782~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=adFC6Jhoq0QYE%2FLngva%2F5%2F64Rp4%3D" alt="" loading="lazy"/></p>
<p>这个 example-skills 包含了一堆官方示例技能，包括前端设计、网页测试、动图制作等等。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/781d0cc50f41466182ab451d4194b7ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=3bsL140KjhvVn2GmilM4C%2BzncgQ%3D" alt="" loading="lazy"/></p>
<p>装完之后，你就可以直接让 AI 使用这些技能了。</p>
<h3 data-id="heading-3">2、前端设计技能</h3>
<p>比如你要做一个网站，以前没装技能的时候，AI 生成的代码又是那个熟悉的蓝紫渐变色，千篇一律的 AI 审美。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c8514bbd6ae4223adb5f7b0723d576c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=S3stIzmHMJe3zolrnYdtkMltBGQ%3D" alt="" loading="lazy"/></p>
<p>现在安装了 frontend-design 这个 <strong>教 AI 生成专业设计感网站</strong> 的技能后，你输入：“帮我开发个人作品集网站”。</p>
<p>AI 会主动问你：我发现你安装了前端设计技能，需要用它来生成更具设计感的页面吗？</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/372aac57a65b4ce3bd44632b03d292ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=oLSe8CNK%2ByPBHq1e1EyPLeYBzN0%3D" alt="" loading="lazy"/></p>
<p>确认之后，AI 会利用技能生成代码，告别蓝紫渐变，生成独特风格的精美页面。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f60b29593a3d4ec6bc7c45e7c07e42ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=nY9sIRNGpGRv4WAjutt9ECpaF%2B0%3D" alt="" loading="lazy"/></p>
<p>我们不用每次都给 AI 输入一大堆相同的提示词，装一次技能就行了。</p>
<h3 data-id="heading-4">3、文档处理技能</h3>
<p>除了代码相关的技能，官方还提供了文档处理技能包。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f24ff9ac66645d684db789f718f5d2e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=XSm5IXo3FGDABnG2weKWLQJL%2B08%3D" alt="" loading="lazy"/></p>
<p>同样在 Claude Code 中输入一行命令安装：</p>
<pre><code class="hljs language-typescript" lang="typescript">/plugin install <span class="hljs-variable language_">document</span>-skills<span class="hljs-meta">@anthropic</span>-agent-skills
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/14b2712f3e054e39987512069233803f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=1qwESmAk0uxTqFeqICkuPk%2FWNAU%3D" alt="" loading="lazy"/></p>
<p>这个技能包里有 PPT 制作、Word 文档生成、Excel 数据分析、PDF 解析等技能。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3cb20f214a414a9e808e0702dfc07a96~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=Al0dhDps160NvrAwmXzDCJlbGHc%3D" alt="" loading="lazy"/></p>
<p>接下来如果你让 AI 做个 PPT，它会自动调用 PPT 制作技能，直接生成排版好的 PPT 文件，帮你节省几个小时。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e872d17631824be2a653666e91c44fd9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=WxGPIe69hnzGaRITExoe4grYxRM%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce21e8cfd3484be08977bd6a4e2adfdc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=cYBW5NFXeFcFvGUKUeqhQlElx0s%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">揭秘 Agent Skills 内部原理</h2>
<p>你好奇道：咦，为什么 Skills 能做到安装即用？技能包里面到底有啥？AI 又是怎么知道该用哪个技能的？</p>
<p>鱼皮：好问题。<a href="https://link.juejin.cn?target=https%3A%2F%2Fagentskills.io%2Fwhat-are-skills" target="_blank" title="https://agentskills.io/what-are-skills" ref="nofollow noopener noreferrer">技能</a> 其实就是一个包含 <code>SKILL.md</code> 技能说明文件的文件夹，还可以包含可执行脚本、资源和参考文档。</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-keyword">my</span>-skill/
├── SKILL.md         <span class="hljs-comment"># 必需：指令和元数据</span>
├── scripts/         <span class="hljs-comment"># 可选：可执行脚本</span>
├── references/       <span class="hljs-comment"># 可选：参考文档</span>
└── assets/           <span class="hljs-comment"># 可选：模板和资源</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aef6b097af914e73b2dc2a209a8a184b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=UI7KBMMy0%2F9PTniPEBHObXP6eHA%3D" alt="" loading="lazy"/></p>
<p>由于每个技能的复杂度不同，结构也会存在区别。我们可以在本地目录中找到已安装的技能文件夹。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/20856da9f994434e8cd7af00131ba617~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=S92%2FcOQwVVPdW37EGyx5AzecjB8%3D" alt="" loading="lazy"/></p>
<p>以官方的 PPT 制作技能为例，它的结构是这样的：</p>
<pre><code class="hljs language-bash" lang="bash">skills/pptx/
├── SKILL.md         <span class="hljs-comment"># 技能说明书（必需）</span>
├── ooxml/           <span class="hljs-comment"># OOXML 相关资源</span>
├── scripts/         <span class="hljs-comment"># 处理脚本</span>
├── html2pptx.md     <span class="hljs-comment"># HTML 转 PPT 说明</span>
├── ooxml.md         <span class="hljs-comment"># OOXML 格式说明</span>
└── LICENSE.txt       <span class="hljs-comment"># 许可证</span>
</code></pre>
<p>包含一个核心的技能说明文档 <code>SKILL.md</code>，还有脚本、参考文档和各种资源文件。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a3441e7351b419cbf5b2abce5421177~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=KURXanfWbzfISw%2FDAmoQKDYgTXo%3D" alt="" loading="lazy"/></p>
<p>而 frontend-design 前端设计技能只有一个 <code>SKILL.md</code> 文件。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3a1c0a292414a94b5cc89e2da9e3a97~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=ZTaXNmLFhtbccxP3pl4j5ZhRJuY%3D" alt="" loading="lazy"/></p>
<p><code>SKILL.md</code> 文件是每个技能的核心，它包含两个关键部分。</p>
<p>第一部分是 <strong>元数据</strong>，用 YAML 格式写在文件开头：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-string">name:</span> <span class="hljs-string">frontend-design</span>
<span class="hljs-string">description:</span> <span class="hljs-string">生成具有专业设计感的前端代码，避免千篇一律的</span> <span class="hljs-string">AI</span> <span class="hljs-string">审美</span>
<span class="hljs-meta">---
</span></code></pre>
<p>其中 <code>name</code> 是技能的名字。<code>description</code> 是技能的描述，告诉 AI 什么时候应该使用这个技能。描述写得越清晰，AI 就越容易在合适的时机调用它。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd87165ead4a4163b026ef23944be73d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=2PCEBwXh3aqcN2a9bSzexZ7vqNs%3D" alt="" loading="lazy"/></p>
<p>第二部分是 <strong>指令内容</strong>，就是一套经过精心设计的提示词，指导 AI 具体怎么做。</p>
<p>以 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanthropics%2Fskills%2Fblob%2Fmain%2Fskills%2Ffrontend-design%2FSKILL.md" target="_blank" title="https://github.com/anthropics/skills/blob/main/skills/frontend-design/SKILL.md" ref="nofollow noopener noreferrer">frontend-design</a> 技能为例，它的指令内容包括：</p>
<ul>
<li>设计思考：在写代码前，先分析产品目的、用户群体、技术约束，然后选择一个大胆的美学方向（极简、复古未来、工业风、有机自然、奢华精致等）</li>
<li>前端美学指南：包括字体选择（避免 Arial、Inter 等烂大街字体，选择有个性的组合）、配色主题（主色调配鲜明点缀色）、动效设计、空间构成、背景和视觉细节</li>
<li>避坑指南：明确禁止紫色渐变、系统字体、千篇一律的布局等 AI 审美陷阱</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59d721e09c1a4efca446ee1d5ed4bc9d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=w8ihk%2FAP7P3xuOiIaIjMyWpsjfc%3D" alt="" loading="lazy"/></p>
<p>你挠了挠头：如果有多个 SKills，AI 怎么知道该用哪个技能呢？如果把每个技能说明文档都塞给 AI，不是很占用上下文么？</p>
<p>鱼皮：这就要说到 <strong>渐进式披露（Progressive Disclosure）</strong> 这个核心机制了。</p>
<p>当你让 AI 执行任务时，它会先扫描技能目录，但不会把所有内容都加载到上下文中。而是只读取每个技能的元数据（名字和描述），发现描述和任务相关，就知道该用这个技能了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0634b67b03094caa96ca694be03fc8ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=4seDFjvnBg%2FIYQ05NKbSubWU8l0%3D" alt="" loading="lazy"/></p>
<p>然后才把完整的技能说明文档读进来，按照里面的指令执行：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a08e857c7c648a1892ba26bd8ea35fc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=kGJBZ8g3QPfVlRnFgikr1KEuAjk%3D" alt="" loading="lazy"/></p>
<p>并根据需要加载技能包中的其他资源：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3de1c9adb4f40d5af81f61d9e2f2c3b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=qoRF3%2FQdV91PQx6e2szbgHG3ql8%3D" alt="" loading="lazy"/></p>
<p><strong>用到哪个查哪个</strong>，既精准匹配又节省上下文，这就是渐进式披露的精髓。</p>
<p>所以 Agent Skills 的本质就是 <strong>把专业知识打包成一个文件夹，让 AI 按需读取并使用</strong>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/53ac8c2740114c7e9aae75b4a682975f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=VwYpApQy6UbgAe9sEw7v49%2BkMwE%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">跨工具的 Agent Skills</h2>
<p>你问：除了 Claude Code 之外，其他 AI 工具支持 Agent Skills 么？俺平时用 Cursor 比较多……</p>
<p>鱼皮：当然能！<a href="https://link.juejin.cn?target=https%3A%2F%2Fagentskills.io%2F" target="_blank" title="https://agentskills.io/" ref="nofollow noopener noreferrer">Agent Skills</a> 已经成为通用标准，Cursor、VS Code、Codex 等工具都支持。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/572b408ce4994e43bdc43a748701806e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=5ElY%2FSduBlX8qhmdEPJpKvmeC70%3D" alt="" loading="lazy"/></p>
<p>Skills 的社区也非常活跃，你可以在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.claudeskill.site%2Fzh%2Fskills" target="_blank" title="https://www.claudeskill.site/zh/skills" ref="nofollow noopener noreferrer">Claude Skills Hub 市场</a>、开源的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FComposioHQ%2Fawesome-claude-skills" target="_blank" title="https://github.com/ComposioHQ/awesome-claude-skills" ref="nofollow noopener noreferrer">Awesome Claude Skills</a> 等地方找到很多现成的技能。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/53593a81687b43a49ddf348f0e46821f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=CWAJcwgBZqWs%2BmuSe0KP%2Fg2k9%2Bw%3D" alt="" loading="lazy"/></p>
<p>比如有个叫 <a href="https://link.juejin.cn?target=https%3A%2F%2Fui-ux-pro-max-skill.nextlevelbuilder.io%2F" target="_blank" title="https://ui-ux-pro-max-skill.nextlevelbuilder.io/" ref="nofollow noopener noreferrer">UI UX Pro MAX</a> 的技能特别火，专门用于提升 AI 的设计能力。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/53c3a0f60dad4cdbb0d8bc546cf06cbc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=hVyzHq3O%2BzWceC%2FXy5kM%2B2YmzIg%3D" alt="" loading="lazy"/></p>
<p>用法很简单，首先按照 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnextlevelbuilder%2Fui-ux-pro-max-skill" target="_blank" title="https://github.com/nextlevelbuilder/ui-ux-pro-max-skill" ref="nofollow noopener noreferrer">开源仓库文档</a> 的指引，安装官方提供的命令行工具：</p>
<pre><code class="hljs">npm install -g uipro-cli
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3603e9ce448f4379b30e7efce20bcb20~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=4tYdpdK2acy3r8im1vFx%2BbYVcNg%3D" alt="" loading="lazy"/></p>
<p>然后进入到你的项目目录下，根据使用的 AI 工具执行对应的命令。比如我这里用 Cursor：</p>
<pre><code class="hljs language-css" lang="css">uipro init <span class="hljs-attr">--ai</span> <span class="hljs-attribute">cursor</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d7889e8d1134584995e251b8dfcf2a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=J6%2F8o%2FkRY20MFY4T2nCTIzIPrqw%3D" alt="" loading="lazy"/></p>
<p>它会自动把技能安装到 Cursor 的配置目录里。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fbc145f1d0594799b0b2073e0e08cfb8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=EIEeNNO19KM2260yOofv1ZM5BYo%3D" alt="" loading="lazy"/></p>
<p>安装完成后，可以看到它的文件结构：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a4a846ff10c34b9c90d471f7c85eb712~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=%2BEKyavnMhSn5tXCzhHcCWSdgXME%3D" alt="" loading="lazy"/></p>
<p>接下来，当你让 AI 开发一个网站时，可以使用斜杠命令手动触发技能，或者让 AI 自动识别技能。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7da66d1099644af3938354d3202e0ceb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=iWWFhqboyTzA953dy0uaWh2tmCg%3D" alt="" loading="lazy"/></p>
<p>1）AI 会根据你的需求识别出产品类型和需要的页面类型</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/586a02d5c5e54e13b33b095a82e7efc1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=YMdVq4NHnh41%2FTorxOmumV7%2FUiU%3D" alt="" loading="lazy"/></p>
<p>2）然后调用 <code>search.py</code> 搜索脚本，在 data 目录里进行多维度搜索，找到适合的配色、字体、布局风格</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94775765d2e344898b2a1d6ba69ba41d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=ToXUhY1LT9cjBci7RdXW4BPywQU%3D" alt="" loading="lazy"/></p>
<p>3）综合搜索结果，生成完整的设计方案（主色调、字体组合、间距规范等）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79c70c1cc63f4a6caef98dad6a95204b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=Dsg18CZHPjlhdKsPZ2dtXKKqpHM%3D" alt="" loading="lazy"/></p>
<p>4）最后，再按照设计方案生成代码</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1626b8d5405d40d99dd242c0e7181536~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=C%2BMrcL6gZaO8OPQgArWRLaswGCg%3D" alt="" loading="lazy"/></p>
<p>这样一来，生成的界面既专业又有设计感。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a8ff080a12414ce2972d7dfd1adf5bf9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=gapGl6%2FD0n2UMxNMflDWCkMfsQY%3D" alt="" loading="lazy"/></p>
<p>AI 不需要把所有规则都背下来，而是用到哪个查哪个，这就是 Agent Skills 的精髓。</p>
<h2 data-id="heading-7">创建自己的 Agent Skills</h2>
<p>用了很多别人的技能后，你产生了一个大胆的想法：俺能不能把公司的周报格式封装成一个技能？以后推荐给新来的同事，还能卖个几块钱，嘿嘿嘿~</p>
<p>鱼皮笑道：有点儿东西，你打算怎么做呢？</p>
<p>你会心一笑：当然是发挥程序员最擅长的事情 —— 复制粘贴！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8706e56933fa40e39aedb3bcdeae940a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=QImONED%2F6nEXcRNzTt7EzUhYUXA%3D" alt="" loading="lazy"/></p>
<p>俺先复制一个官方的技能包，修改目录名称为自己的。</p>
<p>然后修改技能说明文档 <code>SKILL.md</code> 的元数据、指令内容这些关键部分。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac93b055ba324a728bb03b5c21f61b7f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=1mP8z5CWE7sH3L7lL3wE5wJqRAE%3D" alt="" loading="lazy"/></p>
<p>示例 <code>SKILL.md</code> 文件：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">company-weekly-report</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">生成符合公司规范的项目周报，包含进度汇总、问题跟踪和下周计划</span>
<span class="hljs-meta">---</span>
<span class="hljs-string">​</span>
<span class="hljs-comment"># 公司周报生成技能</span>
<span class="hljs-string">​</span>
<span class="hljs-string">当用户要求生成周报时，请按以下步骤执行：</span>
<span class="hljs-string">​</span>
<span class="hljs-comment">## 1. 收集信息</span>
<span class="hljs-string">-</span> <span class="hljs-string">询问本周完成的主要工作</span>
<span class="hljs-string">-</span> <span class="hljs-string">询问遇到的问题和解决方案</span>
<span class="hljs-string">-</span> <span class="hljs-string">询问下周计划</span>
<span class="hljs-string">​</span>
<span class="hljs-comment">## 2. 格式规范</span>
<span class="hljs-string">-</span> <span class="hljs-string">使用公司蓝色主题</span>
<span class="hljs-string">-</span> <span class="hljs-string">标题使用微软雅黑加粗</span>
<span class="hljs-string">-</span> <span class="hljs-string">每个模块不超过</span> <span class="hljs-number">5</span> <span class="hljs-string">个要点</span>
<span class="hljs-string">​</span>
<span class="hljs-comment">## 3. 输出格式</span>
<span class="hljs-string">-</span> <span class="hljs-string">默认输出</span> <span class="hljs-string">Markdown</span>
<span class="hljs-string">-</span> <span class="hljs-string">如需</span> <span class="hljs-string">PPT，调用</span> <span class="hljs-string">pptx</span> <span class="hljs-string">技能</span>
</code></pre>
<p>最后，把公司的 Logo、PPT 模板、报告样例放在子文件夹里就行了。妈妈再也不用担心我的周报了~</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4dfadb3ce4514fdda360866c30adabb5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=0Gye3AeIgrQaGTP4LxdU4ZIX7Ws%3D" alt="" loading="lazy"/></p>
<p>鱼皮：不错不错，但其实有更简单规范的方法。</p>
<p>在前面安装的 example-skills 官方示例技能包里，有一个叫 <code>Skill Creator</code> 的技能，专门用来帮你创建新技能。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e2b61fd440143b09370a4fe72e8b6bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=oawzvfOKlR0xXjE4PMGOaedZIKw%3D" alt="" loading="lazy"/></p>
<p>你只需要跟 AI 说：“帮我创建一个专门生成公司周报的技能”</p>
<p>接下来 AI 会问你几个问题，一步一步回答就好：</p>
<ul>
<li>你希望周报包含哪些主要部分？</li>
<li>你希望周报以什么格式输出?</li>
<li>你通常会如何使用这个周报技能?</li>
<li>希望周报的语言风格是什么?</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97ac5a6fa2ff4d00abc15128f57e683f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=Rg3VA%2Fc1Z8TbvFXbddB7YYFvXAY%3D" alt="" loading="lazy"/></p>
<p>很快，一个完整的技能包就生成了，你会看到一个 <code>.skill</code> 为后缀的文件，本质上是一个 zip 压缩包。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8f274b94a2b441790e30db2059ec9b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=x2gy8AOWIorqAeX8fLZ7HrJ4oFU%3D" alt="" loading="lazy"/></p>
<p>你可以把它解压到你的个人技能目录（<code>~/.claude/skills/</code>）下，你的所有项目都能用。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c67c40a7d4174ca1af3e2687956af679~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=HlLv6mqyxiSJuBkeTsNUFDx9B1s%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/288439a55d4b47d1a4fda4a099f9dd93~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=9hWDe3s6wpj%2F4JnUBBdUjb13KSI%3D" alt="" loading="lazy"/></p>
<p>如果你想让这个技能只在某个项目生效，可以把它放到项目的 <code>.claude/skills/</code> 目录下，并且利用 Git 同步给项目组其他成员。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd420b41b75f43068673cb047899c79a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=esOl57EVVrs7EBbMFp6pjJzsoBE%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7bbf0ff9cce423bbc2447472fd2494d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=4u%2BALW3Vs%2BykSLj8i%2BYuh2r3qBo%3D" alt="" loading="lazy"/></p>
<p>测试没问题后，你还可以把它开源到 GitHub，或者上传到 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.claudeskill.site%2Fzh%2Fskills" target="_blank" title="https://www.claudeskill.site/zh/skills" ref="nofollow noopener noreferrer">Claude Skills Hub</a> 这样的社区平台，让所有用户都能用。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3aebf40b715b408fa232255fd1fab230~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=0S%2BaC2og7IOlT%2Fs7MwHJz0EMDqs%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-8">Skills / MCP / 斜杠命令的区别</h2>
<p>你开心极了：原来开发一个 Skills 这么简单！但是，这玩意儿跟之前火爆的 MCP 和斜杠命令有啥区别？</p>
<p>鱼皮：好问题！</p>
<p><strong>MCP 就像给 AI 装上了 “手和眼睛”</strong> ，让 AI 能够连接外部工具和数据源，比如搜索网页、读取代码仓库、查询数据库。适合需要获取数据或操作外部系统的场景。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b88fe3e5d094d34a7f9e2d855cfa828~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=MZB0LIneq855px4ZjM1RDLEzD5Y%3D" alt="" loading="lazy"/></p>
<p><strong>而 Agent Skills 更像是给 AI 发了一本 “工作手册”</strong> ，把专业知识和工作流程打包起来，教 AI 在特定领域该怎么做。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/57b22be47e614cf6bcd657fce25665ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=I%2BQdQUfrtzEsYqPssZ%2BsP9OyJVs%3D" alt="" loading="lazy"/></p>
<p>至于斜杠命令，它就像是快捷键，是需要你手动输入 <code>/command</code> 命令来触发的固定操作；而 Skills 的特点是 AI 可以自动识别该用什么技能，不需要你显式调用。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c713edcd1b643319607c3e946946da8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=SSqh8X5wdhhUH4hwxgkV8zZW7V0%3D" alt="" loading="lazy"/></p>
<p>对了，其实 MCP 和 Skills 是可以结合起来的。</p>
<p>举个例子，如果你想让 AI 帮你发周报：</p>
<ul>
<li>MCP 负责获取数据：从任务管理数据库拉取这周的任务列表</li>
<li>Skills 负责加工数据：把获取到的原始数据整理成老板爱看的格式</li>
</ul>
<p>一个提供食材，一个提供配方。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a56c977530a940dfb489f6293241444a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=rbY3BhWzlde5Ztz04hs8z0YI3DA%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-9">Agent Skills 凭什么大火？</h2>
<p>你看着技能文件夹的结构，突然怪叫一声：等等，俺突然意识到一个问题…… 这不就是我们程序员玩烂的 “封装、复用、模块化、懒加载” 那一套吗？</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a766352622f947c8b951d796e6b34d1e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=vIYHl29%2B59mOsweoBMgGQc%2BFxnw%3D" alt="" loading="lazy"/></p>
<p>写几个代码文件、打个包、发到网上，让其他程序员下载下来用，不是一回事儿么？</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da53a1e4eec3433fab55201cfc8a98d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=tge5szG90TIidsiuUbAyvmsMvaQ%3D" alt="" loading="lazy"/></p>
<p>为什么 Agent Skills 能突然让整个 AI 圈为之疯狂？</p>
<p>鱼皮：好问题，从技术的角度来看，它并没有发明什么惊天动地的算法。</p>
<p>在我看来，它能火主要是 2 个原因。</p>
<p>第一，它是开放标准，封装一次技能包后就能在各种 AI 工具里复用，还能通过社区共享。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94f7b20333d5480d8a41cd9cbe1d9568~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=cXgZcj6McI8SdC0cjLYsDezwAps%3D" alt="" loading="lazy"/></p>
<p>更重要的是，Skills 能立刻让 AI 的工作更专业可靠，让普通人 “无感” 地享受技术带来的价值。以前想让 AI 变聪明，你得学提示词工程、配置各种工具链。现在只需要像装 APP 一样安装技能包，AI 就立刻变专业了。一项技术的成功，不在于它有多复杂，而在于它能让普通用户不关注技术细节的情况下，感受到技术的价值。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87bae9ce0c0041278143780bbe0345bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=VPA3GQQ%2FxSjDACrxxJCpSLHvfj0%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-10">结尾</h2>
<p>你点点头：学会了学废了！降低门槛，才是技术走向大众的钥匙。</p>
<p>鱼皮：没错，Agent Skills 不仅仅是个技术概念，更是一种新的工作方式。你可以把它融入到自己的日常工作中，比如把重复的任务封装成技能、把团队的最佳实践固化成技能，让 AI 真正成为你的得力助手。</p>
<p>在这个 Vibe Coding 盛行的年代，技术的门槛正在崩塌，而想象力的边界正在无限扩张。你可以在我免费开源的<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Fai-guide" target="_blank" title="https://github.com/liyupi/ai-guide" ref="nofollow noopener noreferrer">《AI 编程零基础入门教程》</a>中学到更多 AI 编程技巧，也欢迎关注我的账号，学习更多 AI 和编程的技巧。</p>
<blockquote>
<p>开源指路：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Fai-guide" target="_blank" title="https://github.com/liyupi/ai-guide" ref="nofollow noopener noreferrer">github.com/liyupi/ai-g…</a></p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/69bfefb4b1a64d6486a59d7b401c707b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770090477&amp;x-signature=PlSBNh0qn%2FA8BVZeXUv9tooGDkI%3D" alt="" loading="lazy"/></p>
<p>那么问题来了，你最想让 AI 学会什么技能呢？</p>
<h2 data-id="heading-11">更多</h2>
<p>💻 编程学习交流：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Fcode-nav" target="_blank" title="https://github.com/liyupi/code-nav" ref="nofollow noopener noreferrer">编程导航</a> 📃 简历快速制作：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Flaoyujianli" target="_blank" title="https://github.com/liyupi/laoyujianli" ref="nofollow noopener noreferrer">老鱼简历</a> ✏️ 面试刷题神器：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Fmianshiya" target="_blank" title="https://github.com/liyupi/mianshiya" ref="nofollow noopener noreferrer">面试鸭</a> 📖 AI 学习指南：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Fai-guide" target="_blank" title="https://github.com/liyupi/ai-guide" ref="nofollow noopener noreferrer">鱼皮 AI 导航</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一个普通本科生，硬磕AI大模型的心路历程......]]></title>    <link>https://juejin.cn/post/7599591405313015849</link>    <guid>https://juejin.cn/post/7599591405313015849</guid>    <pubDate>2026-01-27T04:12:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599591405313015849" data-draft-id="7599591405312999465" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一个普通本科生，硬磕AI大模型的心路历程......"/> <meta itemprop="keywords" content="LLM"/> <meta itemprop="datePublished" content="2026-01-27T04:12:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="智泊AI"/> <meta itemprop="url" content="https://juejin.cn/user/3572727470361578"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一个普通本科生，硬磕AI大模型的心路历程......
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3572727470361578/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    智泊AI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T04:12:18.000Z" title="Tue Jan 27 2026 04:12:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>我就是那种扔在人堆里找不着的普通本科生，二本院校，学的是万金油似的工商管理，没什么硬核技能，毕业就跟着大流进了家小公司做行政，每天复印文件、整理报表、应付各种杂事，混了大半年，越干越慌。</p>
<p>不是说行政不好，就是觉得这日子一眼望到头，拿着死工资，拼不过学历比我高的，也比不过会专业技能的，万一哪天公司裁员，我肯定是第一个被踢走的。那时候就总琢磨，得学点什么傍身，可又不知道从哪下手...编程听不懂，设计没天赋，考公又卷得离谱。</p>
<p>第一次接触AI大模型，还是同事用ChatGPT写周报，我凑过去看了一眼，惊得不行！原来还能这么玩？后来自己也试着用，写文案、改简历、甚至帮我梳理工作流程，越用越觉得这东西太顶了。那时候网上铺天盖地都是AI相关的新闻，我就动了心思：要不，试试转行做这个？</p>
<p>现在回头想，当时真是脑子一热，根本不知道AI大模型这行水有多深。我连Python都不会，更别说什么深度学习、神经网络了，跟个门外汉似的，连术语都听不懂。一开始跟着网上的教程学，老师讲得飞快，一堆公式和代码扔过来，我对着屏幕愣一下午，连复制粘贴都能搞错格式，越学越挫败，好几次都想放弃......</p>
<p>最崩溃的时候是第一次做小项目，想试着微调一个简单的模型，找数据、理逻辑、写代码，折腾了快一个星期，结果运行的时候全是报错，对着报错信息搜了半天，还是一头雾水。那天晚上在出租屋，看着电脑屏幕上密密麻麻的红色字体，真的有点绷不住，觉得自己就是自不量力，普通本科，没专业基础，凭什么跟那些计算机、自动化专业的人抢饭碗？</p>
<p>但又不甘心就这么算了。毕竟已经花了两个多月的时间，每天下班就坐在书桌前学到半夜，周末也泡在图书馆里，放弃了朋友聚会，也戒了刷短视频的习惯，要是就这么停了，之前的努力不都白费了？后来我就降低预期，不追求一下子学会多高深的内容，先从最基础的补起：每天背几个Python语法，看懂一段简单的代码，慢慢积累。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fyuan.zhipoai.cn%2F" target="_blank" title="https://yuan.zhipoai.cn/" ref="nofollow noopener noreferrer"><strong>更多AI大模型学习视频及资源，都在智泊AI。</strong></a></p>
<p>我也没敢辞掉工作，毕竟还要靠工资交房租、吃饭，只能利用业余时间死磕。为了能跟上进度，我报了个AI大模型全栈班，虽然有点小贵，但老师能手把手教，遇到问题也能及时问，不用自己一个人瞎琢磨。班里的同学大多是计算机相关专业的，要么是应届生，要么是有工作经验的程序员，就我一个跨专业、零基础的普通本科，一开始都不好意思说话，怕问出的问题太傻被人笑话。</p>
<p>好在老师和同学都挺友好，慢慢我也放开了，遇到不懂的就问。到了项目阶段我就更加不敢懈怠了，毕竟大厂很看重这块，每次我都会把做项目的经验记在小本子上。有一次做文本生成的小练习，我熬了两个大夜，反复改代码、调参数，终于能生成一段通顺且符合要求的文字时，那种成就感，比拿了工资还开心。</p>
<p>就这样磕了快半年，我总算能独立做一些基础的大模型应用开发，比如简单的对话机器人、文本摘要工具。之后就开始投简历，投的都是中小型公司的AI助理、大模型应用岗，没敢碰那些大厂，因为我知道自己实力不够，先从小公司积累经验再说。</p>
<p>一开始我以为会卡学历和专业，没想到面试官只看重我的项目经验是否能落地，是否能衔接公司现有的业务发展，还问我做过的项目细节，我把自己做过的项目从头到尾讲了一遍，包括遇到的问题、怎么解决的，还有自己的优化思路等等。</p>
<p>其实，说实话，求职的那段时间压力特别大，一边要应付原公司的工作，一边要准备面试，还要接着补专业知识，有时候甚至怀疑，自己是不是真的不适合这行。但好在老师总会鼓励我，并且会教我怎么回答面试官的问题，再加上之前项目阶段的经验积累，我也算是游刃有余。面试结束后第三天，我就收到了录用通知。</p>
<p>现在我做AI大模型应用已经快半年了，工资比之前做行政高了不少，虽然每天还是要学习，但每天都过得很充实，再也没有之前那种迷茫感。</p>
<p>其实我知道，我不算成功，也不是什么逆袭大神，只是一个想拼一把的普通人。很多和我一样的普通本科生，可能都有过想转行的想法，又怕自己没基础、没学历，不敢迈出第一步。但我想说，没基础可以补，学历不够可以用项目经验凑，最怕的是连尝试的勇气都没有。</p>
<p>转行AI大模型这一路，我踩了无数个坑，熬了无数个夜，也有过无数次想放弃的瞬间，但好在我坚持下来了。它不是一条捷径，甚至比很多行业都难，但只要你愿意沉下心来积累，普通人也能在这行找到自己的位置。</p>
<p>另外，作为过来人我深知在这个转行过程中的迷茫，刚开始我也不知道从何开始，今天写这一篇文章也是想感慨一下自己的来时路，同时呢，也给天南地北的朋友们指条明路，让大家可以少走弯路，也趁着今天有空，我把我当时学大模型的一些学习路线、笔记素材、视频教程等资源都上传到我的网盘了，如果你现在还没有一个清晰的规划，可以参考一下我的。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fyuan.zhipoai.cn%2F" target="_blank" title="https://yuan.zhipoai.cn/" ref="nofollow noopener noreferrer"><strong>更多AI大模型学习视频及资源，都在智泊AI。</strong></a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于Uniswap V2的闪电贷套利合约实现与分析]]></title>    <link>https://juejin.cn/post/7599565587154157594</link>    <guid>https://juejin.cn/post/7599565587154157594</guid>    <pubDate>2026-01-27T04:25:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599565587154157594" data-draft-id="7599604510366384166" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于Uniswap V2的闪电贷套利合约实现与分析"/> <meta itemprop="keywords" content="后端,算法"/> <meta itemprop="datePublished" content="2026-01-27T04:25:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="cipher"/> <meta itemprop="url" content="https://juejin.cn/user/2242659448524872"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于Uniswap V2的闪电贷套利合约实现与分析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2242659448524872/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    cipher
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T04:25:14.000Z" title="Tue Jan 27 2026 04:25:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读21分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言：闪电贷在 DeFi 中的核心作用</h2>
<p>在去中心化金融（DeFi）领域，闪电贷（Flash Loan）代表了区块链技术的一项革命性创新。它允许用户在无需提供抵押的情况下即时借入巨额资金，前提是必须在同一交易内完成偿还。这种机制充分利用了以太坊交易的原子性——即交易要么全部执行成功，要么全部回滚——从而为套利、清算和资本优化等复杂策略提供了安全高效的执行环境。本文将对基于 Uniswap V2 的闪电贷套利合约进行函数级别的细致剖析，结合测试案例和执行流程，揭示其背后的技术原理与实际应用价值。</p>
<p>Uniswap V2 作为恒定乘积自动做市商（AMM）的典范，其闪电兑换（Flash Swap）机制进一步扩展了闪电贷的应用边界。与传统闪电贷（如 Aave）要求偿还相同资产不同，Uniswap V2 的闪电兑换允许用户以等值其他资产偿付，这为跨池套利提供了更大的灵活性。通过本文的分析，您将深入理解这一机制如何在代码层面实现高效的资金循环。</p>
<h2 data-id="heading-1">一、合约接口与整体架构</h2>
<h3 data-id="heading-2">1.1 Uniswap V2 接口定义</h3>
<p>合约首先定义了三个核心接口，这些是与 Uniswap V2 协议交互的基础：</p>
<ul>
<li><code>IUniswapV2Pair</code>：处理代币对的核心操作，包括 <code>token0()</code>、<code>token1()</code>、<code>swap()</code> 和 <code>getReserves()</code>。这些方法确保了合约能精确查询储备并执行交换。</li>
<li><code>IUniswapV2Factory</code>：通过 <code>getPair()</code> 方法获取特定代币对的地址，实现动态池子定位。</li>
<li><code>IUniswapV2Router02</code>：提供 <code>getAmountOut()</code> 和 <code>getAmountIn()</code> 等纯函数，用于计算交换量，避免手动实现 AMM 公式可能引入的精度误差。</li>
</ul>
<p>这些接口的设计体现了模块化和标准化原则，确保合约与 Uniswap V2 的无缝集成，同时便于未来扩展。</p>
<h3 data-id="heading-3">1.2 状态变量与事件机制</h3>
<p>合约的状态变量设计简洁高效：</p>
<ul>
<li><code>uniswapV2Factory</code> 和 <code>uniswapV2Router</code>：存储协议地址，支持测试时的动态配置。</li>
<li><code>owner</code>：合约所有者，用于访问控制。</li>
<li><code>FlashSwapExecuted</code> 事件：记录套利执行细节，包括池子地址、代币类型、借贷量和利润，便于链上监控和审计。</li>
</ul>
<p>这种精炼的状态管理降低了存储成本，并提升了合约的安全性。</p>
<h2 data-id="heading-4">二、函数级代码剖析</h2>
<h3 data-id="heading-5">2.1 构造函数 (constructor)</h3>
<pre><code class="hljs language-solidity" lang="solidity">constructor() {
    uniswapV2Factory = 0x5C69bEe701ef814a2B6a3EDD4B1652CB9cc5aA6f;
    uniswapV2Router = 0x7a250d5630B4cF539739dF2C5dAcb4c659F2488D;
    owner = msg.sender;
}
</code></pre>
<p>构造函数初始化了 Uniswap V2 的主网地址，并设置所有者。这种硬编码方式确保了部署时的即用性，同时为生产环境提供了稳定性。</p>
<h3 data-id="heading-6">2.2 访问控制修饰符 (onlyOwner)</h3>
<pre><code class="hljs language-solidity" lang="solidity">modifier onlyOwner() {
    require(msg.sender == owner, 'Not owner');
    _;
}
</code></pre>
<p>这一修饰符构成了合约的安全基石，确保敏感操作（如套利执行和地址配置）仅限于所有者执行，防范潜在的外部滥用。</p>
<h3 data-id="heading-7">2.3 地址配置函数 (setUniswapAddresses)</h3>
<pre><code class="hljs language-solidity" lang="solidity">function setUniswapAddresses(address factory, address router) external onlyOwner {
    uniswapV2Factory = factory;
    uniswapV2Router = router;
}
</code></pre>
<p>此函数增强了合约的适应性，允许在测试或分叉环境中切换地址，体现了开发中的最佳实践：生产与测试分离。</p>
<h3 data-id="heading-8">2.4 套利启动函数 (executeFlashSwap)</h3>
<pre><code class="hljs language-solidity" lang="solidity">function executeFlashSwap(
    address poolA, // 价格较低的池子
    address poolB, // 价格较高的池子
    address tokenA, // 要借贷的代币
    address tokenB, // 要交换的代币
    uint256 amountToBorrow // 借贷数量
) external onlyOwner {
    // 验证池子地址
    require(poolA != address(0) &amp;&amp; poolB != address(0), 'Invalid pool addresses');

    // 从 poolA 开始闪电贷
    IUniswapV2Pair pair = IUniswapV2Pair(poolA);
    address token0 = pair.token0();
    address token1 = pair.token1();

    uint256 amount0Out = tokenA == token0 ? amountToBorrow : 0;
    uint256 amount1Out = tokenA == token1 ? amountToBorrow : 0;

    // 编码数据传递给回调函数
    bytes memory data = abi.encode(poolB, tokenA, tokenB, amountToBorrow);

    // 执行闪电贷
    pair.swap(amount0Out, amount1Out, address(this), data);
}
</code></pre>
<p>作为套利的入口，此函数验证输入、编码回调数据，并触发 <code>swap()</code> 以启动闪电兑换。关键在于数据编码，确保回调函数能访问必要参数。</p>
<h3 data-id="heading-9">2.5 回调核心函数 (uniswapV2Call)</h3>
<pre><code class="hljs language-solidity" lang="solidity">function uniswapV2Call(address sender, uint256 amount0, uint256 amount1, bytes calldata data) external {
    // 验证调用者是合法的 Uniswap V2 配对合约
    address token0 = IUniswapV2Pair(msg.sender).token0();
    address token1 = IUniswapV2Pair(msg.sender).token1();
    address pair = IUniswapV2Factory(uniswapV2Factory).getPair(token0, token1);
    require(msg.sender == pair, 'Invalid pair');
    require(sender == address(this), 'Invalid sender');

    // 解码数据
    (address poolB, address _tokenA, address _tokenB, uint256 amountBorrowed) = abi.decode(
      data,
      (address, address, address, uint256)
    );

    // 获取借到的代币数量
    console.log("&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Borrowed tokenA", amountBorrowed);
    uint256 amountReceived = amount0 &gt; 0 ? amount0 : amount1;
    console.log("&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Expected TokenA:", amountReceived);
    console.log("&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Received TokenA:", IERC20(_tokenA).balanceOf(address(this)));
    
    // 在 poolB 中将 tokenA 兑换为 tokenB
    console.log("&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; In poolB, exchange tokenA to tokenB");
    _swapOnPool(poolB, _tokenA, _tokenB, amountReceived);
    console.log("&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Received TokenB:", IERC20(_tokenB).balanceOf(address(this)));

    // 计算需要还款的数量（包含手续费）
    uint256 amountToRepay = _calculateRepayAmount(amountBorrowed);
    console.log("&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Need repay TokenA:", amountToRepay);

    // 从amountOut中拿出一部分用于还款
    // 这里我们计算需要多少_tokenB来偿还所需的_tokenA（计算输出需要偿还的amountToRepay个A，需要输入多少个B）
    uint256 amountToSwapBack = _calculateAmountToSwapBack(msg.sender, _tokenB, amountToRepay);
    console.log("&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Need repay TokenB for TokenA in poolA:", amountToSwapBack);

    // 检查我们是否有足够多的_tokenB用于偿还_tokenA
    uint256 balanceOfTokenB = IERC20(_tokenB).balanceOf(address(this));
    require(balanceOfTokenB &gt;= amountToSwapBack, 'Insufficient tokenB for repayment');
    console.log("&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; balanceOfTokenB:", IERC20(_tokenB).balanceOf(address(this)));

    // 转移_tokenB给配对合约（msg.sender 是 poolA）
    IERC20(_tokenB).transfer(msg.sender, amountToSwapBack);

    // 现在我们已经把需要的_tokenB发送给配对合约，配对合约会将其与它持有的_tokenA进行交换
    // 这里不再直接调用swap，而是通过配对合约在swap结束时自动完成交换
    // 配对合约会验证我们是否返回了足够的_tokenA

    // 由于我们已经发送了正确的amountToSwapBack到配对合约A
    // 并且我们计算了所需的还款金额，所以合约能验证通过

    // 计算利润
    uint256 remainingTokenB = IERC20(_tokenB).balanceOf(address(this));
    console.log("&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Remaining TokenB:", remainingTokenB);

    // 将剩余代币转给 owner
    if (remainingTokenB &gt; 0) {
      IERC20(_tokenB).transfer(owner, remainingTokenB);
    }

    emit FlashSwapExecuted(msg.sender, poolB, _tokenA, _tokenB, amountBorrowed, remainingTokenB);
  }
</code></pre>
<p>此函数是闪电兑换的核心引擎：验证调用者、解码数据、执行套利交换、计算并偿还借款，最后转移利润。日志输出便于调试，强调了资金流动的透明性。</p>
<h3 data-id="heading-10">2.6 内部交换函数 (_swapOnPool)</h3>
<pre><code class="hljs language-solidity" lang="solidity">function _swapOnPool(address pool, address tokenIn, address tokenOut, uint256 amountIn) internal {
    IUniswapV2Pair pair = IUniswapV2Pair(pool); // poolB
    (uint112 reserve0, uint112 reserve1, ) = pair.getReserves();

    address _token0 = pair.token0();

    bool token0IsTokenIn = tokenIn == _token0;

    (uint112 reserveIn, uint112 reserveOut) = token0IsTokenIn ? (reserve0, reserve1) : (reserve1, reserve0);

    // 计算输出数量
    uint256 amountOut = IUniswapV2Router02(uniswapV2Router).getAmountOut(amountIn, reserveIn, reserveOut);
    console.log("&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Expected TokenB:", amountOut);

    // 转移代币到配对合约
    IERC20(tokenIn).transfer(pool, amountIn);

    // 执行交换 - 根据tokenIn是token0还是token1来确定输出方向
    uint256 amount0Out = tokenOut == _token0 ? amountOut : 0;
    uint256 amount1Out = tokenOut == _token0 ? 0 : amountOut;

    pair.swap(amount0Out, amount1Out, address(this), new bytes(0));
}
</code></pre>
<p>函数处理套利中的关键交换步骤，利用路由计算输出并执行 <code>swap()</code>，确保滑点最小化。</p>
<h3 data-id="heading-11">2.7 还款计算函数 (_calculateRepayAmount)</h3>
<pre><code class="hljs language-solidity" lang="solidity">function _calculateRepayAmount(uint256 amountBorrowed) internal pure returns (uint256) {
    // Uniswap V2 手续费是 0.3%
    return (amountBorrowed * 1000) / 997 + 1;
}
</code></pre>
<p>此纯函数精确计算 Uniswap V2 的 0.3% 手续费溢价，确保偿还符合 AMM 的 K 值恒定要求。</p>
<h3 data-id="heading-12">2.8 反向交换计算 (_calculateAmountToSwapBack)</h3>
<pre><code class="hljs language-solidity" lang="solidity">function _calculateAmountToSwapBack(
    address pool,
    address tokenIn,
    uint256 amountOutNeeded
) internal view returns (uint256 amountIn) {
    IUniswapV2Pair pair = IUniswapV2Pair(pool); // poolA
    (uint112 reserve0, uint112 reserve1, ) = pair.getReserves();

    address _token0 = pair.token0();
    bool token0IsTokenIn = tokenIn == _token0;

    (uint112 reserveIn, uint112 reserveOut) = token0IsTokenIn ? (reserve0, reserve1) : (reserve1, reserve0);

    amountIn = IUniswapV2Router02(uniswapV2Router).getAmountIn(amountOutNeeded, reserveIn, reserveOut);
}
</code></pre>
<p>利用 <code>getAmountIn()</code> 计算偿还所需输入量，避免手动公式计算的潜在误差。</p>
<h3 data-id="heading-13">2.9 紧急撤资函数 (emergencyWithdraw)</h3>
<pre><code class="hljs language-solidity" lang="solidity">function emergencyWithdraw(address token) external onlyOwner {
    uint256 balance = IERC20(token).balanceOf(address(this));
    if (balance &gt; 0) {
        IERC20(token).transfer(owner, balance);
    }
}
</code></pre>
<p>作为后备机制，此函数允许所有者提取资金，增强合约的鲁棒性。</p>
<h2 data-id="heading-14">三、测试环境与函数分析</h2>
<h3 data-id="heading-15">3.1 Mock 模拟合约</h3>
<p>测试使用 Mock 版本模拟 ERC20、Pair、Factory 和 Router，确保隔离环境下的可控性。这些模拟实现了核心逻辑，如 K 值验证（<code>balance0Adjusted * balance1Adjusted &gt;= _reserve0 * _reserve1 * 1000**2</code>），准确复现 Uniswap V2 的行为。</p>
<h3 data-id="heading-16">3.2 初始化函数 (setUp)</h3>
<pre><code class="hljs language-solidity" lang="solidity">function setUp() public {
    // 部署代币
    tokenA = new MockERC20("Token A", "TKA");
    tokenB = new MockERC20("Token B", "TKB");

    // 部署工厂和路由器
    factory = new MockUniswapV2Factory();
    router = new MockUniswapV2Router();

    // 部署配对合约
    poolA = new MockUniswapV2Pair(address(tokenA), address(tokenB));
    poolB = new MockUniswapV2Pair(address(tokenA), address(tokenB));

    // 设置工厂中的配对信息
    factory.setPair(address(tokenA), address(tokenB), address(poolA));

    // 设置初始储备 (pairA: 1A = 1000B, 即 1:1000 的比例)
    // 设置为 1000000 A 和 1000000000 B (比例为 1:1000)
    tokenA.mint(address(poolA), 1000000);
    tokenB.mint(address(poolA), 1000000000);
    poolA.setReserves(1000000, 1000000000);

    // 设置pairB的储备 (pairB: 1A = 1300B, 即 1:1300 的比例)
    // 设置为 1000000 A 和 1300000000 B (比例为 1:1300)
    tokenA.mint(address(poolB), 1000000);
    tokenB.mint(address(poolB), 1300000000);
    poolB.setReserves(1000000, 1300000000);

    // 部署FlashSwapTestable合约
    flashSwap = new FlashSwap();

    // 设置模拟的工厂和路由器地址
    flashSwap.setUniswapAddresses(address(factory), address(router));

    // 将FlashSwapTestable合约的owner设置为测试合约（当前this）
    // flashSwap合约的当前owner是部署合约时的msg.sender（也就是FlashSwapTest合约）
    // 因此owner变量应该设置为FlashSwapTest合约的地址
    owner = address(this);
}
</code></pre>
<p>初始化创建价差场景（PoolA: 1A=1000B；PoolB: 1A=1300B），模拟真实套利机会。</p>
<h3 data-id="heading-17">3.3 套利测试函数 (testFlashSwapArbitrage)</h3>
<pre><code class="hljs language-solidity" lang="solidity">function testFlashSwapArbitrage() public {
        // 测试用例：验证FlashSwap套利交易逻辑
        // 场景：pairA中1A=1000B， pairB中1A=1300B
        // 从pairA借出来100个A，在pairB中用100个A兑换B代币，再在pairA中将B换成A还回去

        // 记录初始状态
        uint256 initialTokenABalance = tokenA.balanceOf(owner);
        uint256 initialTokenBBalance = tokenB.balanceOf(owner);

        console.log("Initial A Balance:", initialTokenABalance);
        console.log("Initial B Balance:", initialTokenBBalance);

        // 调用FlashSwap合约进行套利交易
        // 从poolA借A代币，在poolB中进行套利
        flashSwap.executeFlashSwap(
            address(poolA),     // 从poolA借A代币
            address(poolB),     // 在poolB中进行套利
            address(tokenA),    // 借贷的代币是A
            address(tokenB),    // 交换的目标代币是B
            100                 // 借贷数量是100
        );

        // 检查是否获利
        uint256 finalTokenABalance = tokenA.balanceOf(owner);
        uint256 finalTokenBBalance = tokenB.balanceOf(owner);

        console.log("Final A Balance:", finalTokenABalance);
        console.log("Final B Balance:", finalTokenBBalance);
        console.log("A Balance Change:", int(finalTokenABalance) - int(initialTokenABalance));
        console.log("B Balance Change:", int(finalTokenBBalance) - int(initialTokenBBalance));

        // 验证最终的B代币余额有所增加（套利获利）
        // 初始B代币余额应该加上最终收益等于最终B代币余额
        assertGt(finalTokenBBalance, initialTokenBBalance);

        // 输出日志显示获利结果
        console.log("B Token Profit:", finalTokenBBalance - initialTokenBBalance);
    }
</code></pre>
<p>测试验证了从借贷到利润转移的全链路，确保逻辑无误。</p>
<h2 data-id="heading-18">四、执行流程与结果剖析</h2>
<p>为直观展示套利流程，以下是基于测试案例的时序图，描绘了关键交互：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Owner as Owner
    participant FlashSwap as FlashSwap Contract
    participant PoolA as PoolA (borrowing pool)
    participant PoolB as PoolB (arbitrage pool)
    participant TokenA as TokenA
    participant TokenB as TokenB
    participant Router as Uniswap Router

    Note over Owner,TokenB: 设置阶段：根据合约初始化和测试用例
    Note over Owner,TokenB: poolA: 1A = 1000B (1,000,000 A : 1,000,000,000 B)
    Note over Owner,TokenB: poolB: 1A = 1300B (1,000,000 A : 1,300,000,000 B)
    Note over Owner,TokenB: 借贷: 100 TokenA
    Owner-&gt;&gt;FlashSwap: executeFlashSwap(poolA, poolB, TokenA, TokenB, 100)
    activate FlashSwap
    FlashSwap-&gt;&gt;PoolA: swap(amount0Out=100, amount1Out=0, address(this), data)
    activate PoolA
    Note over PoolA: 在swap函数中触发uniswapV2Call回调
    PoolA-&gt;&gt;FlashSwap: uniswapV2Call(this, 100, 0, data)
    activate FlashSwap
    Note over FlashSwap: 1. 验证调用者
    Note over FlashSwap: 2. 计算借贷数量: received 100 TokenA
    Note over FlashSwap: 3. 查询当前TokenA余额: IERC20(_tokenA).balanceOf
    Note over FlashSwap: 预期收到: 100 TokenA, 实际借到: 100 TokenA

    FlashSwap-&gt;&gt;PoolB: _swapOnPool() - exchange 100 TokenA to TokenB
    Note over FlashSwap: 调用_swapOnPool(poolB, TokenA, TokenB, 100)
    activate PoolB
    PoolB-&gt;&gt;TokenA: transfer(poolB, 100 TokenA)
    TokenA-&gt;&gt;PoolB: transfer completed
    PoolB-&gt;&gt;FlashSwap: swap(0, 129597, address(this), new bytes(0))
    FlashSwap-&gt;&gt;PoolB: receive TokenB from swap (129597 TokenB)
    deactivate PoolB

    Note over FlashSwap: 4. 在poolB中完成交换: 100 TokenA -&gt; 129597 TokenB
    Note over FlashSwap: 根据合约池B比例 1:1300, 100 A 应兑换 129597 TokenB
    Note over FlashSwap: amountOut = 100 * 997 / (1000000 * 1000 + 100 * 997) * 1300000000 ≈ 129597

    Note over FlashSwap: 5. 计算还款金额: 100 * 1000 / 997 + 1 = 101 TokenA 
    Note over FlashSwap: 6. 计算在poolA中需要交换多少TokenB来还TokenA
    Note over FlashSwap: amountIn = 1000 * 1000000000 * 101 / (997 * (1000000 - 101)) + 1 ≈ 101315
    FlashSwap-&gt;&gt;Router: _calculateAmountToSwapBack(poolA, TokenB, 101)
    Router-&gt;&gt;FlashSwap: return 101315 TokenB required

    Note over FlashSwap: 7. 验证TokenB余额: balanceOf &gt;= 101315 TokenB 
    Note over FlashSwap: 8. 需要还款101 TokenA，需用101315 TokenB交换(101315来自_tokenB)
    FlashSwap-&gt;&gt;PoolA: transfer(101315 TokenB to pairA contract)
    deactivate FlashSwap

    Note over PoolA: 9. 配对合约A自动计算并验证是否返回足够TokenA
    Note over PoolA: 根据公式 balanceAAdjusted * balanceBAdjusted &gt;= _reserveA * _reserveB
    Note over PoolA: 借出100 TokenA，收到101315 TokenB，计算是否返还足额TokenA
    Note over PoolA: balanceAAdjusted = balanceA - amountAIn * 0.003 = 999900 - 0 * 0.003 = 999900
    Note over PoolA: balanceBAdjusted = balanceB - amountBIn * 0.003 = 1000101315 - 101315 * 0.003 ≈ 1000101011
    Note over PoolA: _reserveA = 1000000
    Note over PoolA: _reserveB = 1000000000
    Note over PoolA: 如果计算结果 999900 * 1000101011 ≥ 1000000 * 1000000000，则验证通过，交易完成
    PoolA--&gt;&gt;FlashSwap: Verify repayment and complete transaction

    Note over FlashSwap: Profit calculation:
    Note over FlashSwap: 总TokenB获得: 129597, 用于还款: 101315, 剩余: 28282 TokenB
    FlashSwap-&gt;&gt;Owner: transfer(remaining 28282 TokenB to owner)
    deactivate PoolA
    Note over Owner,FlashSwap: FlashSwap套利完成，获得28282 TokenB利润
</code></pre>
<p>测试执行输出如下，展示了资金流动的精确轨迹：</p>
<pre><code class="hljs language-bash" lang="bash">$ forge <span class="hljs-built_in">test</span> --match-test testFlashSwapArbitrage -vvv
[⠊] Compiling...
[⠰] Compiling 1 files with Solc 0.8.30
[⠔] Solc 0.8.30 finished <span class="hljs-keyword">in</span> 4.49s
Compiler run successful!

Ran 1 <span class="hljs-built_in">test</span> <span class="hljs-keyword">for</span> <span class="hljs-built_in">test</span>/FlashSwap.t.sol:FlashSwapTest
[PASS] testFlashSwapArbitrage() (gas: 176830)
Logs:
  Initial A Balance: 0
  Initial B Balance: 0
  &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Borrowed tokenA 100
  &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Expected TokenA: 100
  &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Received TokenA: 100
  &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; In poolB, exchange tokenA to tokenB
  &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Expected TokenB: 129597
  &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; amount0In: 100
  &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; amount1In: 0
  &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; balance0: 1000100
  &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; balance1: 1299870403
  &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; _reserve0: 1000000
  &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; _reserve1: 1300000000
  &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Received TokenB: 129597
  &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Need repay TokenA: 101
  &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Need repay TokenB <span class="hljs-keyword">for</span> TokenA <span class="hljs-keyword">in</span> poolA: 101315
  &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; balanceOfTokenB: 129597
  &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Remaining TokenB: 28282
  &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; amount0In: 0
  &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; amount1In: 101315
  &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; balance0: 999900
  &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; balance1: 1000101315
  &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; _reserve0: 1000000
  &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; _reserve1: 1000000000
  Final A Balance: 0
  Final B Balance: 28282
  A Balance Change: 0
  B Balance Change: 28282
  B Token Profit: 28282
</code></pre>
<p>从输出可见，借入 100 TokenA，在 PoolB 兑换为 129,597 TokenB；偿还需 101 TokenA（含费），对应 101,315 TokenB；最终利润 28,282 TokenB。价差 30% 被手续费和滑点压缩至约 28%，体现了 AMM 的动态定价机制。</p>
<h2 data-id="heading-19">五、安全性与风险评估</h2>
<p>尽管强大，闪电贷合约需警惕风险：</p>
<ul>
<li><strong>价格操纵</strong>：攻击者可能通过大额交易扭曲池子价格。</li>
<li><strong>重入攻击</strong>：回调机制需严格验证调用者。</li>
<li><strong>Gas 消耗</strong>：复杂逻辑可能导致交易失败或 MEV 抢跑。</li>
<li><strong>流动性风险</strong>：池子深度不足可能放大滑点。</li>
</ul>
<p>推荐集成 Chainlink 预言机作为价格校验，并进行全面审计。</p>
<h2 data-id="heading-20">六、结语与应用展望</h2>
<p>闪电贷不仅是技术创新，更是 DeFi 效率的体现。通过本文的剖析，我们见证了 Uniswap V2 如何通过原子交易实现无风险套利。这一机制在实际中可扩展至三角套利、多链桥接等领域，推动 DeFi 的进一步成熟。开发者应注重安全与优化，以最大化其潜力。</p>
<h2 data-id="heading-21">附录：完整合约代码</h2>
<p>@contracts/src/FlashSwap.sol:</p>
<pre><code class="hljs language-solidity" lang="solidity">// SPDX-License-Identifier: MIT
pragma solidity ^0.8.13;

import '@openzeppelin/contracts/token/ERC20/IERC20.sol';
import "forge-std/console.sol";

interface IUniswapV2Pair {
  function token0() external view returns (address);

  function token1() external view returns (address);

  function swap(uint amount0Out, uint amount1Out, address to, bytes calldata data) external;

  function getReserves() external view returns (uint112 reserve0, uint112 reserve1, uint32 blockTimestampLast);
}

interface IUniswapV2Factory {
  function getPair(address tokenA, address tokenB) external view returns (address pair);
}

interface IUniswapV2Router02 {
  function getAmountOut(uint amountIn, uint reserveIn, uint reserveOut) external pure returns (uint amountOut);

  function getAmountIn(uint amountOut, uint reserveIn, uint reserveOut) external pure returns (uint amountIn);
}

// 测试版本的FlashSwap合约，允许设置工厂和路由器地址
contract FlashSwap {
  address public uniswapV2Factory;
  address public uniswapV2Router;

  address public owner;

  event FlashSwapExecuted(
    address indexed poolA,
    address indexed poolB,
    address tokenA,
    address tokenB,
    uint256 amountBorrowed,
    uint256 profit
  );

  modifier onlyOwner() {
    require(msg.sender == owner, 'Not owner');
    _;
  }

  constructor() {
    uniswapV2Factory = 0x5C69bEe701ef814a2B6a3EDD4B1652CB9cc5aA6f;
    uniswapV2Router = 0x7a250d5630B4cF539739dF2C5dAcb4c659F2488D;
    owner = msg.sender;
  }

  // 允许测试时设置工厂和路由器地址
  function setUniswapAddresses(address factory, address router) external onlyOwner {
    uniswapV2Factory = factory;
    uniswapV2Router = router;
  }

  // 执行闪电兑换套利
  function executeFlashSwap(
    address poolA, // 价格较低的池子
    address poolB, // 价格较高的池子
    address tokenA, // 要借贷的代币
    address tokenB, // 要交换的代币
    uint256 amountToBorrow // 借贷数量
  ) external onlyOwner {
    // 验证池子地址
    require(poolA != address(0) &amp;&amp; poolB != address(0), 'Invalid pool addresses');

    // 从 poolA 开始闪电贷
    IUniswapV2Pair pair = IUniswapV2Pair(poolA);
    address token0 = pair.token0();
    address token1 = pair.token1();

    uint256 amount0Out = tokenA == token0 ? amountToBorrow : 0;
    uint256 amount1Out = tokenA == token1 ? amountToBorrow : 0;

    // 编码数据传递给回调函数
    bytes memory data = abi.encode(poolB, tokenA, tokenB, amountToBorrow);

    // 执行闪电贷
    pair.swap(amount0Out, amount1Out, address(this), data);
  }

  // Uniswap V2 回调函数
  function uniswapV2Call(address sender, uint256 amount0, uint256 amount1, bytes calldata data) external {
    // 验证调用者是合法的 Uniswap V2 配对合约
    address token0 = IUniswapV2Pair(msg.sender).token0();
    address token1 = IUniswapV2Pair(msg.sender).token1();
    address pair = IUniswapV2Factory(uniswapV2Factory).getPair(token0, token1);
    require(msg.sender == pair, 'Invalid pair');
    require(sender == address(this), 'Invalid sender');

    // 解码数据
    (address poolB, address _tokenA, address _tokenB, uint256 amountBorrowed) = abi.decode(
      data,
      (address, address, address, uint256)
    );

    // 获取借到的代币数量
    console.log("&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Borrowed tokenA", amountBorrowed);
    uint256 amountReceived = amount0 &gt; 0 ? amount0 : amount1;
    console.log("&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Expected TokenA:", amountReceived);
    console.log("&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Received TokenA:", IERC20(_tokenA).balanceOf(address(this)));
    

    // 在 poolB 中将 tokenA 兑换为 tokenB
    console.log("&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; In poolB, exchange tokenA to tokenB");
    _swapOnPool(poolB, _tokenA, _tokenB, amountReceived);
    console.log("&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Received TokenB:", IERC20(_tokenB).balanceOf(address(this)));

    // 计算需要还款的数量（包含手续费）
    uint256 amountToRepay = _calculateRepayAmount(amountBorrowed);
    console.log("&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Need repay TokenA:", amountToRepay);

    // 从amountOut中拿出一部分用于还款
    // 这里我们计算需要多少_tokenB来偿还所需的_tokenA（计算输出需要偿还的amountToRepay个A，需要输入多少个B）
    uint256 amountToSwapBack = _calculateAmountToSwapBack(msg.sender, _tokenB, amountToRepay);
    console.log("&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Need repay TokenB for TokenA in poolA:", amountToSwapBack);

    // 检查我们是否有足够多的_tokenB用于偿还_tokenA
    uint256 balanceOfTokenB = IERC20(_tokenB).balanceOf(address(this));
    require(balanceOfTokenB &gt;= amountToSwapBack, 'Insufficient tokenB for repayment');
    console.log("&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; balanceOfTokenB:", IERC20(_tokenB).balanceOf(address(this)));

    // 转移_tokenB给配对合约（msg.sender 是 poolA）
    IERC20(_tokenB).transfer(msg.sender, amountToSwapBack);

    // 现在我们已经把需要的_tokenB发送给配对合约，配对合约会将其与它持有的_tokenA进行交换
    // 这里不再直接调用swap，而是通过配对合约在swap结束时自动完成交换
    // 配对合约会验证我们是否返回了足够的_tokenA

    // 由于我们已经发送了正确的amountToSwapBack到配对合约A
    // 并且我们计算了所需的还款金额，所以合约能验证通过

    // 计算利润
    uint256 remainingTokenB = IERC20(_tokenB).balanceOf(address(this));
    console.log("&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Remaining TokenB:", remainingTokenB);

    // 将剩余代币转给 owner
    if (remainingTokenB &gt; 0) {
      IERC20(_tokenB).transfer(owner, remainingTokenB);
    }

    emit FlashSwapExecuted(msg.sender, poolB, _tokenA, _tokenB, amountBorrowed, remainingTokenB);
  }

  // 执行交换
  function _swapOnPool(address pool, address tokenIn, address tokenOut, uint256 amountIn) internal {
    IUniswapV2Pair pair = IUniswapV2Pair(pool); // poolB
    (uint112 reserve0, uint112 reserve1, ) = pair.getReserves();

    address _token0 = pair.token0();

    bool token0IsTokenIn = tokenIn == _token0;

    (uint112 reserveIn, uint112 reserveOut) = token0IsTokenIn ? (reserve0, reserve1) : (reserve1, reserve0);

    // 计算输出数量
    uint256 amountOut = IUniswapV2Router02(uniswapV2Router).getAmountOut(amountIn, reserveIn, reserveOut);
    console.log("&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Expected TokenB:", amountOut);

    // 转移代币到配对合约
    IERC20(tokenIn).transfer(pool, amountIn);

    // 执行交换 - 根据tokenIn是token0还是token1来确定输出方向
    uint256 amount0Out = tokenOut == _token0 ? amountOut : 0;
    uint256 amount1Out = tokenOut == _token0 ? 0 : amountOut;

    pair.swap(amount0Out, amount1Out, address(this), new bytes(0));
  }

  // 计算需要交换回去的数量
  function _calculateAmountToSwapBack(
    address pool,
    address tokenIn,
    uint256 amountOutNeeded
  ) internal view returns (uint256 amountIn) {
    IUniswapV2Pair pair = IUniswapV2Pair(pool); // poolA
    (uint112 reserve0, uint112 reserve1, ) = pair.getReserves();

    address _token0 = pair.token0();
    bool token0IsTokenIn = tokenIn == _token0;

    (uint112 reserveIn, uint112 reserveOut) = token0IsTokenIn ? (reserve0, reserve1) : (reserve1, reserve0);

    amountIn = IUniswapV2Router02(uniswapV2Router).getAmountIn(amountOutNeeded, reserveIn, reserveOut);
  }

  // 计算还款数量（包含 0.3% 手续费）
  function _calculateRepayAmount(uint256 amountBorrowed) internal pure returns (uint256) {
    // Uniswap V2 手续费是 0.3%
    return (amountBorrowed * 1000) / 997 + 1;
  }

  // 紧急提取函数
  function emergencyWithdraw(address token) external onlyOwner {
    uint256 balance = IERC20(token).balanceOf(address(this));
    if (balance &gt; 0) {
      IERC20(token).transfer(owner, balance);
    }
  }
}
</code></pre>
<p>@contracts/test/FlashSwap.t.sol:</p>
<pre><code class="hljs language-solidity" lang="solidity">// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

import "forge-std/Test.sol";
import "forge-std/console.sol";
import "@openzeppelin/contracts/token/ERC20/ERC20.sol";
import "../src/FlashSwap.sol";

// 为 Mock 合约添加的接口定义
interface IUniswapV2Callee {
    function uniswapV2Call(address sender, uint amount0, uint amount1, bytes calldata data) external;
}

contract MockERC20 is ERC20 {
    constructor(string memory name, string memory symbol) ERC20(name, symbol) {}

    function mint(address to, uint256 amount) public {
        _mint(to, amount);
    }

    function burn(address from, uint256 amount) public {
        _burn(from, amount);
    }
}

contract MockUniswapV2Pair is IUniswapV2Pair {
    address public token0;
    address public token1;
    uint112 public reserve0;
    uint112 public reserve1;
    uint32 public blockTimestampLast;

    constructor(address _token0, address _token1) {
        token0 = _token0;
        token1 = _token1;
        reserve0 = 0;
        reserve1 = 0;
        blockTimestampLast = uint32(block.timestamp);
    }

    function setReserves(uint112 _reserve0, uint112 _reserve1) external {
        reserve0 = _reserve0;
        reserve1 = _reserve1;
        blockTimestampLast = uint32(block.timestamp);
    }

    function getReserves() public view returns (uint112 _reserve0, uint112 _reserve1, uint32 _blockTimestampLast) {
        return (reserve0, reserve1, blockTimestampLast);
    }

    function swap(uint amount0Out, uint amount1Out, address to, bytes calldata data) external {
        require(amount0Out &gt; 0 || amount1Out &gt; 0, 'UniswapV2: INSUFFICIENT_OUTPUT_AMOUNT');
        (uint112 _reserve0, uint112 _reserve1,) = getReserves(); // gas savings
        require(amount0Out &lt; _reserve0 &amp;&amp; amount1Out &lt; _reserve1, 'UniswapV2: INSUFFICIENT_LIQUIDITY');

        uint balance0;
        uint balance1;
        { // scope for _token{0,1}, avoids stack too deep errors
            address _token0 = token0;
            address _token1 = token1;
            require(to != _token0 &amp;&amp; to != _token1, 'UniswapV2: INVALID_TO');
            if (amount0Out &gt; 0) MockERC20(token0).transfer(to, amount0Out); // optimistically transfer tokens
            if (amount1Out &gt; 0) MockERC20(token1).transfer(to, amount1Out); // optimistically transfer tokens
            if (data.length &gt; 0) {
                // 假设to地址实现了uniswapV2Call回调函数
                // 这个函数会被FlashSwap等合约实现，用于处理闪贷逻辑
                (bool success,) = to.call(abi.encodeWithSignature("uniswapV2Call(address,uint256,uint256,bytes)",
                    msg.sender, amount0Out, amount1Out, data));
                require(success, "Uniswap V2 callback failed");
            }
            balance0 = IERC20(_token0).balanceOf(address(this));
            balance1 = IERC20(_token1).balanceOf(address(this));
        }
        uint amount0In = balance0 &gt; _reserve0 - amount0Out ? balance0 - (_reserve0 - amount0Out) : 0;
        uint amount1In = balance1 &gt; _reserve1 - amount1Out ? balance1 - (_reserve1 - amount1Out) : 0;
        require(amount0In &gt; 0 || amount1In &gt; 0, 'UniswapV2: INSUFFICIENT_INPUT_AMOUNT');
        { // scope for reserve{0,1}Adjusted, avoids stack too deep errors
            uint balance0Adjusted = balance0 * 1000 - amount0In * 3;
            uint balance1Adjusted = balance1 * 1000 - amount1In * 3;
            require(balance0Adjusted * balance1Adjusted &gt;= uint(_reserve0) * _reserve1 * 1000 ** 2, 'UniswapV2: K');
        }

        _update(balance0, balance1, _reserve0, _reserve1);
    }

    function _update(uint balance0, uint balance1, uint112 _reserve0, uint112 _reserve1) private {
        uint32 blockTimestamp = uint32(block.timestamp % 2 ** 32);
        uint32 timeElapsed = blockTimestamp - blockTimestampLast; // overflow is desired
        if (timeElapsed &gt; 0 &amp;&amp; _reserve0 != 0 &amp;&amp; _reserve1 != 0) {
            // 仅测试，不做任何操作
        }
        reserve0 = uint112(balance0);
        reserve1 = uint112(balance1);
        blockTimestampLast = blockTimestamp;
    }
}

contract MockUniswapV2Factory is IUniswapV2Factory {
    mapping(address =&gt; mapping(address =&gt; address)) public getPair;

    function setPair(address tokenA, address tokenB, address pair) external {
        getPair[tokenA][tokenB] = pair;
        getPair[tokenB][tokenA] = pair; // Uniswap V2 工厂函数是双向对称的
    }
}

contract MockUniswapV2Router is IUniswapV2Router02 {
    // Uniswap V2 公式计算函数
    function getAmountOut(uint amountIn, uint reserveIn, uint reserveOut) external pure returns (uint amountOut) {
        require(amountIn &gt; 0, "UniswapV2Library: INSUFFICIENT_INPUT_AMOUNT");
        require(reserveIn &gt; 0 &amp;&amp; reserveOut &gt; 0, "UniswapV2Library: INSUFFICIENT_LIQUIDITY");
        uint amountInWithFee = amountIn * 997;
        uint numerator = amountInWithFee * reserveOut;
        uint denominator = (reserveIn * 1000) + amountInWithFee;
        amountOut = numerator / denominator;
    }

    function getAmountIn(uint amountOut, uint reserveIn, uint reserveOut) external pure returns (uint amountIn) {
        require(amountOut &gt; 0, "UniswapV2Library: INSUFFICIENT_OUTPUT_AMOUNT");
        require(reserveIn &gt; 0 &amp;&amp; reserveOut &gt; 0, "UniswapV2Library: INSUFFICIENT_LIQUIDITY");
        uint numerator = reserveIn * amountOut * 1000;
        uint denominator = (reserveOut - amountOut) * 997;
        amountIn = (numerator / denominator) + 1;
    }
}

contract FlashSwapTest is Test {
    FlashSwap public flashSwap;
    MockERC20 public tokenA;
    MockERC20 public tokenB;
    MockUniswapV2Pair public poolA;
    MockUniswapV2Pair public poolB;
    MockUniswapV2Factory public factory;
    MockUniswapV2Router public router;

    address public owner;

    function setUp() public {
        // 部署代币
        tokenA = new MockERC20("Token A", "TKA");
        tokenB = new MockERC20("Token B", "TKB");

        // 部署工厂和路由器
        factory = new MockUniswapV2Factory();
        router = new MockUniswapV2Router();

        // 部署配对合约
        poolA = new MockUniswapV2Pair(address(tokenA), address(tokenB));
        poolB = new MockUniswapV2Pair(address(tokenA), address(tokenB));

        // 设置工厂中的配对信息
        factory.setPair(address(tokenA), address(tokenB), address(poolA));

        // 设置初始储备 (pairA: 1A = 1000B, 即 1:1000 的比例)
        // 设置为 1000000 A 和 1000000000 B (比例为 1:1000)
        tokenA.mint(address(poolA), 1000000);
        tokenB.mint(address(poolA), 1000000000);
        poolA.setReserves(1000000, 1000000000);

        // 设置pairB的储备 (pairB: 1A = 1300B, 即 1:1300 的比例)
        // 设置为 1000000 A 和 1300000000 B (比例为 1:1300)
        tokenA.mint(address(poolB), 1000000);
        tokenB.mint(address(poolB), 1300000000);
        poolB.setReserves(1000000, 1300000000);

        // 部署FlashSwapTestable合约
        flashSwap = new FlashSwap();

        // 设置模拟的工厂和路由器地址
        flashSwap.setUniswapAddresses(address(factory), address(router));

        // 将FlashSwapTestable合约的owner设置为测试合约（当前this）
        // flashSwap合约的当前owner是部署合约时的msg.sender（也就是FlashSwapTest合约）
        // 因此owner变量应该设置为FlashSwapTest合约的地址
        owner = address(this);
    }

    function testFlashSwapArbitrage() public {
        // 测试用例：验证FlashSwap套利交易逻辑
        // 场景：pairA中1A=1000B， pairB中1A=1300B
        // 从pairA借出来100个A，在pairB中用100个A兑换B代币，再在pairA中将B换成A还回去

        // 记录初始状态
        uint256 initialTokenABalance = tokenA.balanceOf(owner);
        uint256 initialTokenBBalance = tokenB.balanceOf(owner);

        console.log("Initial A Balance:", initialTokenABalance);
        console.log("Initial B Balance:", initialTokenBBalance);

        // 调用FlashSwap合约进行套利交易
        // 从poolA借A代币，在poolB中进行套利
        flashSwap.executeFlashSwap(
            address(poolA),     // 从poolA借A代币
            address(poolB),     // 在poolB中进行套利
            address(tokenA),    // 借贷的代币是A
            address(tokenB),    // 交换的目标代币是B
            100                 // 借贷数量是100
        );

        // 检查是否获利
        uint256 finalTokenABalance = tokenA.balanceOf(owner);
        uint256 finalTokenBBalance = tokenB.balanceOf(owner);

        console.log("Final A Balance:", finalTokenABalance);
        console.log("Final B Balance:", finalTokenBBalance);
        console.log("A Balance Change:", int(finalTokenABalance) - int(initialTokenABalance));
        console.log("B Balance Change:", int(finalTokenBBalance) - int(initialTokenBBalance));

        // 验证最终的B代币余额有所增加（套利获利）
        // 初始B代币余额应该加上最终收益等于最终B代币余额
        assertGt(finalTokenBBalance, initialTokenBBalance);

        // 输出日志显示获利结果
        console.log("B Token Profit:", finalTokenBBalance - initialTokenBBalance);
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[echarts饼图当鼠标移上去后，高亮色怎么设置为扇形本身的颜色？]]></title>    <link>https://juejin.cn/post/7599690133117419554</link>    <guid>https://juejin.cn/post/7599690133117419554</guid>    <pubDate>2026-01-27T03:05:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599690133117419554" data-draft-id="7599586891085037602" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="echarts饼图当鼠标移上去后，高亮色怎么设置为扇形本身的颜色？"/> <meta itemprop="keywords" content="前端,ECharts"/> <meta itemprop="datePublished" content="2026-01-27T03:05:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小黑的铁粉"/> <meta itemprop="url" content="https://juejin.cn/user/2225067266412605"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            echarts饼图当鼠标移上去后，高亮色怎么设置为扇形本身的颜色？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2225067266412605/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小黑的铁粉
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T03:05:41.000Z" title="Tue Jan 27 2026 03:05:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="zenburn">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#3f3f3f;color:#dcdcdc}.hljs-keyword,.hljs-selector-tag,.hljs-tag{color:#e3ceab}.hljs-template-tag{color:#dcdcdc}.hljs-number{color:#8cd0d3}.hljs-attribute,.hljs-template-variable,.hljs-variable{color:#efdcbc}.hljs-literal{color:#efefaf}.hljs-subst{color:#8f8f8f}.hljs-name,.hljs-section,.hljs-selector-class,.hljs-selector-id,.hljs-title,.hljs-type{color:#efef8f}.hljs-bullet,.hljs-link,.hljs-symbol{color:#dca3a3}.hljs-built_in,.hljs-builtin-name,.hljs-deletion,.hljs-string{color:#cc9393}.hljs-addition,.hljs-comment,.hljs-meta,.hljs-quote{color:#7f9f7f}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">以下是一个环形图，鼠标未移到饼图上时</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee3735568e5445c0b8a75604c788c49b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6buR55qE6ZOB57KJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770088378&amp;x-signature=J%2BsyjPSwfHWJ5pagPBW3rk8TYFs%3D" alt="图片.png" loading="lazy"/></p>
<h4 data-id="heading-1">当鼠标移动到时长异常部分时，因为设置了高亮的原因再加上本身颜色就浅，看起来像换了种颜色</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27a4fbc70c0344c0a10761893a2f6b88~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6buR55qE6ZOB57KJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770088378&amp;x-signature=djhoqWi8Aeh%2F%2BRnwtDjI1bdVyvI%3D" alt="hover.png" loading="lazy"/></p>
<h4 data-id="heading-2">先看下优化后的样子</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8946e442b1084218816abc397c6043ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6buR55qE6ZOB57KJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770088378&amp;x-signature=LpCAaOzB%2BfF8%2FaKk2Arh6sNtDuE%3D" alt="-hover-ok.png" loading="lazy"/></p>
<p>对比明显吧。</p>
<p>如何在设置了emphasis高亮配置时，保持扇形的颜色为本身的颜色呢，换句话说，想要保留高亮的其它配置，比如放大，边框等等，但颜色不要高亮展示，该如何设置呢？</p>
<pre><code class="hljs language-js" lang="js">
option = {
  <span class="hljs-attr">series</span>: [
   {
       <span class="hljs-string">"name"</span>:<span class="hljs-string">"运行状态"</span>,
       <span class="hljs-string">"type"</span>:<span class="hljs-string">"pie"</span>,
       <span class="hljs-string">"startAngle"</span>:<span class="hljs-number">90</span>,
       <span class="hljs-string">"radius"</span>:[
           <span class="hljs-string">"58%"</span>,
           <span class="hljs-string">"73%"</span>
       ],
       <span class="hljs-string">"center"</span>:[
           <span class="hljs-string">"50%"</span>,
           <span class="hljs-string">"50%"</span>
       ],
       <span class="hljs-attr">animation</span>: <span class="hljs-literal">true</span>,
       <span class="hljs-string">"selectedoffset"</span>:<span class="hljs-number">3</span>,
       <span class="hljs-comment">//这里设置统一悬停样式</span>
       <span class="hljs-attr">emphasis</span>:{
               
           <span class="hljs-string">"scale"</span>: <span class="hljs-literal">true</span>,
           <span class="hljs-string">"scalesize"</span>:<span class="hljs-number">6</span>,
           <span class="hljs-attr">itemStyle</span>:{
               <span class="hljs-comment">// "shadowBlur": 20,</span>
               <span class="hljs-comment">// "shadowColor":"rgba(0,0,0,1)",</span>
               <span class="hljs-string">"borderWidth"</span>: <span class="hljs-number">3</span>,
               <span class="hljs-string">"borderColor"</span>: <span class="hljs-string">"#fff"</span>,
                
           }
       },
       <span class="hljs-string">"label"</span>:{
           <span class="hljs-string">"padding"</span>:[
               <span class="hljs-number">15</span>,
               <span class="hljs-number">0</span>,
               <span class="hljs-number">0</span>,
               <span class="hljs-number">0</span>
           ],
           <span class="hljs-string">"color"</span>:<span class="hljs-string">"#4E5969"</span>,
           <span class="hljs-string">"fontSize"</span>:<span class="hljs-number">14</span>,
           <span class="hljs-string">"formatter"</span>:<span class="hljs-string">"{b|{b}} {d|{c}%}\n"</span>,
           <span class="hljs-string">"rich"</span>:{
               <span class="hljs-string">"b"</span>:{
                   <span class="hljs-string">"fontSize"</span>:<span class="hljs-number">14</span>,
                   <span class="hljs-string">"color"</span>:<span class="hljs-string">"#4E5969"</span>
               },
               <span class="hljs-string">"d"</span>:{
                   <span class="hljs-string">"fontSize"</span>:<span class="hljs-number">16</span>,
                   <span class="hljs-string">"fontWeight"</span>:<span class="hljs-number">600</span>,
                   <span class="hljs-string">"fontFamily"</span>:<span class="hljs-string">"DINAlternate-Bold, DINAlternate"</span>,
                   <span class="hljs-string">"color"</span>:<span class="hljs-string">"#4E5969"</span>
               }
           }
       },
       <span class="hljs-string">"labelLine"</span>:{
           <span class="hljs-string">"length2"</span>:<span class="hljs-number">4</span>
       },
       <span class="hljs-string">"data"</span>:[
           {
               <span class="hljs-string">"name"</span>:<span class="hljs-string">"时长异常"</span>,
               <span class="hljs-string">"value"</span>:<span class="hljs-number">41.63</span>,
                <span class="hljs-attr">originalColor</span>: <span class="hljs-string">"#91caff"</span>,
               <span class="hljs-string">"itemStyle"</span>:{
                   <span class="hljs-string">"color"</span>:<span class="hljs-string">"#91caff"</span>,
                   <span class="hljs-string">"borderColor"</span>:<span class="hljs-string">"#fff"</span>,
                   <span class="hljs-string">"borderWidth"</span>:<span class="hljs-number">2</span>
               },
               <span class="hljs-comment">// 答案在这里---&gt;&gt;&gt;鼠标悬停，颜色不高亮，且使用扇形本身颜色</span>
                 <span class="hljs-attr">emphasis</span>:{
                     <span class="hljs-string">"itemStyle"</span>:{
                         <span class="hljs-string">"color"</span>:<span class="hljs-string">"#91caff"</span>,
                      
                    }
                }
           },
           {
               <span class="hljs-string">"name"</span>:<span class="hljs-string">"时长正常"</span>,
               <span class="hljs-string">"value"</span>:<span class="hljs-number">51.58</span>,
               <span class="hljs-string">"itemStyle"</span>:{
                   <span class="hljs-string">"color"</span>:<span class="hljs-string">"#358EFE"</span>,
                   <span class="hljs-string">"borderColor"</span>:<span class="hljs-string">"#fff"</span>,
                   <span class="hljs-string">"borderWidth"</span>:<span class="hljs-number">2</span>
               },
               <span class="hljs-attr">emphasis</span>:{
                   <span class="hljs-string">"itemStyle"</span>:{
                       <span class="hljs-string">"color"</span>:<span class="hljs-string">"#358EFE"</span>,
                      
                   }
               }
           },
           {
               <span class="hljs-string">"name"</span>:<span class="hljs-string">"无时长"</span>,
               <span class="hljs-string">"value"</span>:<span class="hljs-number">6.79</span>,
               <span class="hljs-string">"itemStyle"</span>:{
                   <span class="hljs-string">"color"</span>:<span class="hljs-string">"#12C2C1"</span>,
                   <span class="hljs-string">"borderColor"</span>:<span class="hljs-string">"#fff"</span>,
                   <span class="hljs-string">"borderWidth"</span>:<span class="hljs-number">2</span>
               },
               <span class="hljs-attr">emphasis</span>:{
                   <span class="hljs-string">"itemStyle"</span>:{
                       <span class="hljs-string">"color"</span>:<span class="hljs-string">"#12C2C1"</span>,
                      
                   }
               }
           }
       ]
   }
]
};


</code></pre>
<h2 data-id="heading-3">解决</h2>
<p>设置了统一的悬停样式后，在单个data中设置下悬停时样式的color即可~Nice..</p>
<p>当然了，一般不会这么细致，但有时候确实会因为颜色的深浅影响UI视觉效果，这时候去找AI也没给出最简单的答案，AI要在统一悬停那设置color的函数，试了下，并不行。总之记录下，或许有人会用到。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[几种依赖注入的使用场景 - InversifyJS为例]]></title>    <link>https://juejin.cn/post/7599581204860813338</link>    <guid>https://juejin.cn/post/7599581204860813338</guid>    <pubDate>2026-01-27T03:12:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599581204860813338" data-draft-id="7599614131422969865" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="几种依赖注入的使用场景 - InversifyJS为例"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2026-01-27T03:12:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="irises"/> <meta itemprop="url" content="https://juejin.cn/user/3030697436261735"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            几种依赖注入的使用场景 - InversifyJS为例
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3030697436261735/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    irises
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T03:12:33.000Z" title="Tue Jan 27 2026 03:12:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>依赖注入不仅仅是一个让代码看起来“高级”的工具，它的核心价值在于<strong>解耦</strong>。通过将对象的“创建权”从业务逻辑中剥离并交给容器，我们能获得极高的灵活性。</p>
<blockquote>
<p>关于依赖注入相关概念可参考<a href="https://juejin.cn/post/7333421776459923465?searchId=20260127102011C9D7CD7EB5885DF2B803#heading-0" target="_blank" title="https://juejin.cn/post/7333421776459923465?searchId=20260127102011C9D7CD7EB5885DF2B803#heading-0">依赖注入的艺术：编写可扩展 JavaScript 代码的秘密</a></p>
</blockquote>
<p>以下是<strong>依赖注入</strong>最具代表性的五个使用场景。</p>
<hr/>
<h2 data-id="heading-0">1. 单元测试 (Unit Testing)</h2>
<p><strong>痛点：</strong> 当业务类直接 <code>new</code> 依赖时，测试该类就必须执行依赖的真实逻辑（如真实扣款、真实写库），导致测试缓慢且危险。</p>
<h3 data-id="heading-1">❌ 方式 A：不使用 InversifyJS (强耦合)</h3>
<p><code>OrderService</code> 内部强行依赖了 <code>RealPayment</code>。要测试 <code>checkout</code> 方法，你必须真的发起支付，无法轻松 Mock。</p>
<p>TypeScript</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 具体的支付实现</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">RealPayment</span> {
    <span class="hljs-title function_">pay</span>(<span class="hljs-params">amount: <span class="hljs-built_in">number</span></span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`$$$ 调用银行接口扣款: <span class="hljs-subst">${amount}</span>`</span>); <span class="hljs-comment">// 真实副作用</span>
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-attr">payment</span>: <span class="hljs-title class_">RealPayment</span>;

    <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
        <span class="hljs-comment">// 😱 致命缺陷：硬编码依赖，测试时无法替换！</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">payment</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RealPayment</span>();
    }

    <span class="hljs-title function_">checkout</span>(<span class="hljs-params">amount: <span class="hljs-built_in">number</span></span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">payment</span>.<span class="hljs-title function_">pay</span>(amount);
    }
}
</code></pre>
<h3 data-id="heading-2">✅ 方式 B：使用 InversifyJS (依赖抽象)</h3>
<p>业务类只依赖接口 <code>IPayment</code>。在单元测试中，我们可以通过容器绑定一个 <code>MockPayment</code>，轻松隔离副作用。</p>
<p>TypeScript</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 1. 定义接口</span>
interface IPayment { <span class="hljs-built_in">pay</span>(amount: number): void; }

<span class="hljs-comment">// 2. 业务逻辑 (只依赖接口)</span>
<span class="hljs-keyword">@injectable</span>()
class OrderService {
    <span class="hljs-built_in">constructor</span>(
        @inject(TYPES.Payment) private payment: IPayment // 注入接口
    ) {}

    <span class="hljs-built_in">checkout</span>(amount: number) {
        this<span class="hljs-selector-class">.payment</span><span class="hljs-selector-class">.pay</span>(amount);
    }
}

<span class="hljs-comment">// --- 单元测试文件 spec.ts ---</span>
const testContainer = new <span class="hljs-built_in">Container</span>();

<span class="hljs-comment">// 🧪 测试时：绑定 Mock 实现</span>
const mockPayment = { 
    pay: jest.<span class="hljs-built_in">fn</span>() // 使用 Jest 等测试库的 Mock 函数
}; 
testContainer<span class="hljs-selector-class">.bind</span>(TYPES.Payment)<span class="hljs-selector-class">.toConstantValue</span>(mockPayment);
testContainer<span class="hljs-selector-class">.bind</span>(OrderService)<span class="hljs-selector-class">.toSelf</span>();

const service = testContainer<span class="hljs-selector-class">.get</span>(OrderService);
service<span class="hljs-selector-class">.checkout</span>(<span class="hljs-number">100</span>);

<span class="hljs-comment">// 断言：验证是否调用了 mock 方法，而不是真的扣款</span>
<span class="hljs-built_in">expect</span>(mockPayment.pay)<span class="hljs-selector-class">.toHaveBeenCalledWith</span>(<span class="hljs-number">100</span>);
</code></pre>
<hr/>
<h2 data-id="heading-3">2. 可替换的组件 (Swappable Components)</h2>
<p><strong>痛点：</strong> 同一个接口有多种实现（例如：存储策略既有本地存储，又有云存储）。传统写法通常伴随着大量的 <code>if-else</code> 或工厂模式代码。</p>
<h3 data-id="heading-4">❌ 方式 A：不使用 InversifyJS (工厂模式/条件判断)</h3>
<p>调用者需要知道具体的实现类，且扩展新策略时需要修改工厂代码。</p>
<p>TypeScript</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LocalStorage</span> { <span class="hljs-title function_">save</span>(<span class="hljs-params"/>) { <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"存硬盘"</span>); } }
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CloudStorage</span> { <span class="hljs-title function_">save</span>(<span class="hljs-params"/>) { <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"存 AWS S3"</span>); } }

<span class="hljs-keyword">class</span> <span class="hljs-title class_">FileManager</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-attr">storage</span>: <span class="hljs-built_in">any</span>;

    <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">type</span>: <span class="hljs-built_in">string</span></span>) {
        <span class="hljs-comment">// 😱 违反开闭原则：每次加新策略都要改这里</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">type</span> === <span class="hljs-string">'local'</span>) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">storage</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalStorage</span>();
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">storage</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CloudStorage</span>();
        }
    }
}
</code></pre>
<h3 data-id="heading-5">✅ 方式 B：使用 InversifyJS (命名绑定)</h3>
<p>使用 <code>@named</code> 标签，可以在不修改业务逻辑代码的情况下，灵活注入不同的策略。</p>
<p>TypeScript</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@injectable</span>()
class FileManager {
    <span class="hljs-selector-tag">constructor</span>(
        <span class="hljs-comment">// ✨ 优雅：同时注入两种策略，按需使用</span>
        <span class="hljs-variable">@inject</span>(TYPES.Storage) <span class="hljs-variable">@named</span>(<span class="hljs-string">"local"</span>) private <span class="hljs-attribute">local</span>: IStorage,
        <span class="hljs-variable">@inject</span>(TYPES.Storage) <span class="hljs-variable">@named</span>(<span class="hljs-string">"cloud"</span>) private <span class="hljs-attribute">cloud</span>: IStorage
    ) {}

    <span class="hljs-built_in">backup</span>() {
        <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.local</span><span class="hljs-selector-class">.save</span>(); <span class="hljs-comment">// 先存本地</span>
        <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.cloud</span><span class="hljs-selector-class">.save</span>(); <span class="hljs-comment">// 再存云端</span>
    }
}

<span class="hljs-comment">// --- 容器配置 ---</span>
<span class="hljs-selector-tag">container</span><span class="hljs-selector-class">.bind</span>&lt;<span class="hljs-selector-tag">IStorage</span>&gt;(TYPES.Storage)<span class="hljs-selector-class">.to</span>(LocalStorage)<span class="hljs-selector-class">.whenTargetNamed</span>(<span class="hljs-string">"local"</span>);
<span class="hljs-selector-tag">container</span><span class="hljs-selector-class">.bind</span>&lt;<span class="hljs-selector-tag">IStorage</span>&gt;(TYPES.Storage)<span class="hljs-selector-class">.to</span>(CloudStorage)<span class="hljs-selector-class">.whenTargetNamed</span>(<span class="hljs-string">"cloud"</span>);
</code></pre>
<hr/>
<h2 data-id="heading-6">3. 跨环境运行 (Cross-Environment Execution)</h2>
<p><strong>痛点：</strong> 开发环境用 SQLite，生产环境用 PostgreSQL。如果不使用 DI，代码中会充斥着 <code>process.env.NODE_ENV</code> 的判断，导致代码混乱。</p>
<h3 data-id="heading-7">❌ 方式 A：不使用 InversifyJS (环境判断污染逻辑)</h3>
<p>TypeScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseService</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
        <span class="hljs-comment">// 😱 环境配置逻辑泄漏到了业务类中</span>
        <span class="hljs-keyword">if</span> (process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">'production'</span>) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">connection</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PostgresConnection</span>();
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">connection</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqliteConnection</span>();
        }
    }
    
    <span class="hljs-title function_">query</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">connection</span>.<span class="hljs-title function_">exec</span>(<span class="hljs-string">"SELECT * FROM users"</span>);
    }
}
</code></pre>
<h3 data-id="heading-8">✅ 方式 B：使用 InversifyJS (容器模块化配置)</h3>
<p>业务代码完全干净，环境切换的逻辑被移到了容器配置层（Composition Root）。</p>
<p>TypeScript</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 1. 业务代码 (完全不知道当前是什么环境)</span>
<span class="hljs-meta">@injectable</span>()
<span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseService</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-meta">@inject</span>(TYPES.DbConnection) <span class="hljs-keyword">private</span> conn: IDbConnection</span>) {}
}

<span class="hljs-comment">// 2. 环境配置模块 (config.ts)</span>
<span class="hljs-keyword">const</span> devModule = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ContainerModule</span>(<span class="hljs-function">(<span class="hljs-params">bind</span>) =&gt;</span> {
    bind&lt;<span class="hljs-title class_">IDbConnection</span>&gt;(<span class="hljs-variable constant_">TYPES</span>.<span class="hljs-property">DbConnection</span>).<span class="hljs-title function_">to</span>(<span class="hljs-title class_">SqliteConnection</span>);
});

<span class="hljs-keyword">const</span> prodModule = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ContainerModule</span>(<span class="hljs-function">(<span class="hljs-params">bind</span>) =&gt;</span> {
    bind&lt;<span class="hljs-title class_">IDbConnection</span>&gt;(<span class="hljs-variable constant_">TYPES</span>.<span class="hljs-property">DbConnection</span>).<span class="hljs-title function_">to</span>(<span class="hljs-title class_">PostgresConnection</span>);
});

<span class="hljs-comment">// 3. 入口文件 (index.ts)</span>
<span class="hljs-keyword">const</span> container = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Container</span>();
<span class="hljs-keyword">if</span> (process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">'production'</span>) {
    container.<span class="hljs-title function_">load</span>(prodModule); <span class="hljs-comment">// 🏭 加载生产模块</span>
} <span class="hljs-keyword">else</span> {
    container.<span class="hljs-title function_">load</span>(devModule);  <span class="hljs-comment">// 🛠️ 加载开发模块</span>
}
</code></pre>
<hr/>
<h2 data-id="heading-9">4. 插件式架构 (Plugin Architecture)</h2>
<p><strong>痛点：</strong> 系统核心需要加载第三方插件。如果不使用 DI，核心系统必须手动 import 并实例化插件，这使得动态扩展变得极其困难。</p>
<h3 data-id="heading-10">❌ 方式 A：不使用 InversifyJS (手动列表)</h3>
<p>核心代码必须“认识”每一个插件。</p>
<p>TypeScript</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">GitPlugin</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./plugins/git"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">DockerPlugin</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./plugins/docker"</span>;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">App</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-attr">plugins</span>: <span class="hljs-built_in">any</span>[] = [];

    <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
        <span class="hljs-comment">// 😱 扩展性差：想加个插件，还得改核心代码的构造函数</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">plugins</span>.<span class="hljs-title function_">push</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">GitPlugin</span>());
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">plugins</span>.<span class="hljs-title function_">push</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DockerPlugin</span>());
    }

    <span class="hljs-title function_">run</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">plugins</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> p.<span class="hljs-title function_">exec</span>());
    }
}
</code></pre>
<h3 data-id="heading-11">✅ 方式 B：使用 InversifyJS (多重注入 Multi-Injection)</h3>
<p>核心系统定义接口，插件自行注册到容器。核心系统自动获取所有符合接口的插件。</p>
<p>TypeScript</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 核心系统</span>
<span class="hljs-variable">@injectable</span>()
class App {
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">plugins</span>: <span class="hljs-selector-tag">IPlugin</span><span class="hljs-selector-attr">[]</span>;

    <span class="hljs-selector-tag">constructor</span>(
        <span class="hljs-comment">// ✨ 魔法：自动把容器里所有绑定为 TYPES.Plugin 的实例都注入进来，形成数组</span>
        <span class="hljs-variable">@multiInject</span>(TYPES.Plugin) <span class="hljs-attribute">plugins</span>: IPlugin[]
    ) {
        <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.plugins</span> = <span class="hljs-selector-tag">plugins</span>;
    }
}

<span class="hljs-comment">// 插件 A (独立文件)</span>
<span class="hljs-selector-tag">bind</span>&lt;<span class="hljs-selector-tag">IPlugin</span>&gt;(TYPES.Plugin)<span class="hljs-selector-class">.to</span>(GitPlugin);

<span class="hljs-comment">// 插件 B (独立文件)</span>
<span class="hljs-selector-tag">bind</span>&lt;<span class="hljs-selector-tag">IPlugin</span>&gt;(TYPES.Plugin)<span class="hljs-selector-class">.to</span>(DockerPlugin);

<span class="hljs-comment">// 这种模式下，新增插件只需要 bind 一下，不需要修改 App 类的任何代码。</span>
</code></pre>
<hr/>
<h2 data-id="heading-12">5. 复杂的生命周期管理 (Singleton vs Transient)</h2>
<p><strong>痛点：</strong> 某些对象（如缓存、数据库连接池）必须是全局单例，而某些对象（如 HTTP 请求上下文）必须每次新建。手动管理这些单例模式非常容易出错。</p>
<h3 data-id="heading-13">❌ 方式 A：不使用 InversifyJS (手动单例模式)</h3>
<p>开发者必须手动实现 Singleton 模式，代码啰嗦且难以维护。</p>
<p>TypeScript</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">class</span> <span class="hljs-title">CacheService</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> instance: CacheService;
    
    <span class="hljs-comment">// 😱 样板代码：每个单例类都要写这一坨逻辑</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">constructor</span>()</span> {} 

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title">getInstance</span>(): CacheService</span> {
        <span class="hljs-keyword">if</span> (!CacheService.instance) {
            CacheService.instance = <span class="hljs-keyword">new</span> CacheService();
        }
        <span class="hljs-keyword">return</span> CacheService.instance;
    }
}

<span class="hljs-comment">// 使用时必须小心</span>
<span class="hljs-keyword">const</span> cache = CacheService.getInstance();
</code></pre>
<h3 data-id="heading-14">✅ 方式 B：使用 InversifyJS (声明式生命周期)</h3>
<p>类本身不需要知道自己是不是单例，全靠容器配置。</p>
<p>TypeScript</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@injectable()</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheService</span> {
    <span class="hljs-keyword">constructor</span>() { console.log(<span class="hljs-string">"CacheService Created"</span>); }
}

<span class="hljs-meta">@injectable()</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">RequestHandler</span> {
    <span class="hljs-keyword">constructor</span>() { console.log(<span class="hljs-string">"RequestHandler Created"</span>); }
}

<span class="hljs-comment">// --- 容器配置 ---</span>
<span class="hljs-comment">// 1. 单例：整个应用只创建一次</span>
container.bind(CacheService).toSelf().inSingletonScope();

<span class="hljs-comment">// 2. 瞬态：每次请求都创建新的</span>
container.bind(RequestHandler).toSelf().inTransientScope();

<span class="hljs-comment">// --- 运行结果 ---</span>
<span class="hljs-keyword">const</span> cache1 = container.<span class="hljs-keyword">get</span>(CacheService);
<span class="hljs-keyword">const</span> cache2 = container.<span class="hljs-keyword">get</span>(CacheService);
<span class="hljs-comment">// 输出: "CacheService Created" (只输出一次，cache1 === cache2)</span>

<span class="hljs-keyword">const</span> handler1 = container.<span class="hljs-keyword">get</span>(RequestHandler);
<span class="hljs-keyword">const</span> handler2 = container.<span class="hljs-keyword">get</span>(RequestHandler);
<span class="hljs-comment">// 输出: "RequestHandler Created" (输出两次，handler1 !== handler2)</span>
</code></pre>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CSS选择器 - 认识选择器]]></title>    <link>https://juejin.cn/post/7599690133117517858</link>    <guid>https://juejin.cn/post/7599690133117517858</guid>    <pubDate>2026-01-27T03:14:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599690133117517858" data-draft-id="7599652649550086144" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CSS选择器 - 认识选择器"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-27T03:14:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="GinoWi"/> <meta itemprop="url" content="https://juejin.cn/user/687651121011707"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CSS选择器 - 认识选择器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/687651121011707/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    GinoWi
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T03:14:50.000Z" title="Tue Jan 27 2026 03:14:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body{overflow:hidden;line-height:1.75;font-size:15px;background-image:linear-gradient(90deg,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0),linear-gradient(1turn,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0);background-size:20px 20px;background-position:50%;padding-top:0!important}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{position:relative;display:flex;border-bottom:5px solid #6d4e00;line-height:35px;letter-spacing:1px;font-size:25px;padding-left:25px;color:#664900;text-shadow:1px 1px 1px #8a6200;padding-bottom:0}.markdown-body h1:before{content:"";display:flex;position:absolute;left:0;top:3px;bottom:0;margin:auto;width:20px;height:20px;background-size:20px 20px;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC")}.markdown-body h2{position:relative;padding:0 0 0 20px;font-size:20px;font-weight:700;color:#614500}.markdown-body h2:before{content:"";position:absolute;top:3px;bottom:0;left:0;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC");background-size:100% 100%;background-repeat:no-repeat;width:15px;height:15px;margin:auto}.markdown-body h3{width:100%;text-align:left;margin:20px 10px 0 0;font-size:18px;font-weight:700;display:inline-block;padding-left:10px;padding-bottom:0;border-left:5px solid #8f6600;color:#614500}.markdown-body h4,.markdown-body h5,.markdown-body h6{font-weight:700;color:#a37400}.markdown-body h4{font-size:17px}.markdown-body h5,.markdown-body h6{display:flex;align-items:center}.markdown-body h5:after,.markdown-body h6:after{display:inline-block;border:2px solid #fff6e0;color:rgba(189,134,0,.5);border-radius:50%;text-align:center;margin-left:5px}.markdown-body h5{font-size:14px}.markdown-body h5:after{content:"5";width:15px;height:15px;line-height:15px;font-size:13px}.markdown-body h6{font-size:12px}.markdown-body h6:after{content:"6";width:13px;height:13px;line-height:13px;font-size:12px}.markdown-body p{color:#412c0c;letter-spacing:1px;font-weight:400;margin-bottom:16px}.markdown-body img{max-width:100%;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#755300;font-weight:400;border-bottom:1px solid #755300;font-weight:bolder;text-decoration:none}.markdown-body table{width:100%!important;margin:0;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border-spacing:0}.markdown-body table img{box-shadow:none}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body thead tr th{text-align:center}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;box-sizing:border-box;border:1px solid rgba(72,42,10,.1)}.markdown-body blockquote{position:relative;text-size-adjust:100%;line-height:25px;font-weight:400;border-radius:10px;font-style:normal;text-align:left;box-sizing:inherit;border:1px solid #ffd87a;background-color:rgba(189,134,0,.5);margin:20px 0;padding:20px}.markdown-body blockquote p{color:#fff6e0;letter-spacing:2px;margin:0}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;color:#cc9100;font-size:34px;font-weight:700}.markdown-body blockquote:before{content:"❝";top:8px;left:5px}.markdown-body blockquote:after{content:"❞";right:5px;bottom:-5px}.markdown-body strong{color:#c28a00;font-weight:bolder}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{color:#c28a00}.markdown-body em strong{font-style:normal;color:#c28a00;background-color:#8a6200}.markdown-body s{color:#c28a00}.markdown-body hr{border-top:1px solid #805b00}.markdown-body code,.markdown-body li code,.markdown-body p code{color:#996d00;background-color:rgba(130,98,0,.3)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#858585;font-family:bold;letter-spacing:1px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection,.markdown-body img::selection{color:rgba(189,134,0,.5);background-color:#fff}.markdown-body a::selection,.markdown-body b::selection,.markdown-body del::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:transparent}.markdown-body pre&gt;code::selection{background-color:rgba(189,134,0,.5)}.markdown-body .math .math-inline::selection,.markdown-body blockquote::selection,.markdown-body ol::selection,.markdown-body p::selection,.markdown-body strong::selection,.markdown-body table::selection,.markdown-body ul::selection{background-color:rgba(189,134,0,.5)}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">CSS选择器 - 认识选择器</h2>
<p>选择器就是用于查找或选取需要设置CSS样式的HTML标签。</p>
<h4 data-id="heading-1">标签选择器</h4>
<ul>
<li>作用：根据指定的标签名称，在当前界面中找到所有该名称的标签，然后设置属性。</li>
<li>格式：</li>
</ul>
<pre><code class="hljs language-css" lang="css">标签名称{
  属性名称: 属性名称值;
}
</code></pre>
<ul>
<li>
<p>注意点：</p>
<ol>
<li>标签选择器选中的是当前界面中所有的标签，而不能单独选中某一个标签。</li>
<li>标签选择器无论标签嵌套多深都能选中。</li>
<li>只要是HTML中的标签就可以作为标签选择器。</li>
</ol>
</li>
</ul>
<h4 data-id="heading-2">id选择器</h4>
<ul>
<li>作用：根据指定的<code>id</code>名称找到对应的标签，然后设置属性。</li>
<li>格式：</li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-id">#id</span>名称{
  属性名称: 属性值;
}
</code></pre>
<ul>
<li>
<p>注意点：</p>
<ul>
<li>每个HTML标签都有一个属性叫做<code>id</code>，也就是说每个标签都可以设置<code>id</code>。</li>
<li>在同一个界HTML页面中<code>id</code>的名称是不可以重复的。</li>
<li>在编写id选择器的时候一定要在<code>id</code>名称前面加上<code>#</code>。</li>
<li><code>id</code>名称是有一定的规范的：（1）<code>id</code>名称只能由字母/数字、下划线组成；（2）<code>id</code>名称不能以数字开头；（3）<code>id</code>名称不能是HTML标签的名称。</li>
<li>在开发过程中，一般情况下如果仅仅是为了设置样式，我们不会专门使用<code>id</code>选择器，因为<code>id</code>属性一般是留给js使用的。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-3">类选择器</h4>
<ul>
<li>作用：根据指定的类名称找到对应的标签，然后设置属性。</li>
<li>格式：</li>
</ul>
<pre><code class="hljs language-css" lang="css">.类名{
  属性名称: 属性值;
}
</code></pre>
<ul>
<li>
<p>注意点：</p>
<ul>
<li>每个HTML标签都一个属性叫做<code>class</code>，也就是说每个标签都可以设置<code>class</code>。</li>
<li>在同一个HTML界面中<code>class</code>的名称是可以重复的。</li>
<li>在编写<code>class</code>选择器的时候一定要在<code>class</code>名称前面加上<code>.</code>。</li>
<li>类名的命名规范和<code>id</code>的命名规范一样。</li>
<li>类名就是专门用来给某个特定的标签设置样式的。</li>
<li>在HTML中每个HTML标签可以同时绑定多个类名，eg：<code>&lt;标签名称 class=“类名1 类名2 ……“&gt;</code>；错误的写法：<code>&lt;p class="1" class="2"&gt;&lt;/p&gt;</code></li>
</ul>
</li>
</ul>
<blockquote>
<p><strong>补充内容：</strong></p>
<ol start="0">
<li>
<p><code>id</code>和<code>class</code>的区别？</p>
<ul>
<li><code>id</code>相当于人的身份证，不能重复；而<code>class</code>相当于人的名称不能重复。</li>
<li>一个HTML标签只能绑定一个<code>id</code>名称，而一个HTML标签可以绑定多个<code>class</code>名称。</li>
</ul>
</li>
<li>
<p><code>id</code>选择器和<code>class</code>选择器的区别？</p>
<ul>
<li><code>id</code>选择器是以<code>#</code>开头，而<code>class</code>选择器以<code>.</code>开头。</li>
</ul>
</li>
<li>
<p>在开发中到底选择<code>id</code>选择器还是<code>class</code>选择器？</p>
<ul>
<li><code>id</code>一般情况下是给js使用的，所以除非特殊情况，否则不要用<code>id</code>选择器去设置样式。</li>
</ul>
</li>
</ol>
</blockquote>
<h4 data-id="heading-4">后代选择器</h4>
<ul>
<li>作用：找到指定标签的所有后代标签设置属性。（组合器）</li>
<li>格式：</li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/*先找到选择器1所选中的标签，然后再在这个标签下面去查找所有选择器2所选中的标签，然后再设置属性。*/</span>
选择器<span class="hljs-number">1</span> 选择器<span class="hljs-number">2</span>{
    属性: 值;
}
</code></pre>
<ul>
<li>
<p>注意点：</p>
<ul>
<li>后代选择器必须用空格隔开。</li>
<li>后代不仅仅是子元素，也包括孙子元素或者重孙子元素，只要最终是放到指定标签中的都是后代。</li>
<li>后代选择器不仅仅可以使用标签名称，还可以使用其他选择器（id选择器、类选择器）。</li>
<li>后代选择器可以无限延伸，无限向下寻找。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-5">子元素选择器</h4>
<ul>
<li>作用：找到指定标签中所有直接子元素，然后设置属性。</li>
<li>格式：</li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/*先通过选择器1找到选中的标签，然后在这个标签中查找所有通过选择器2选中的直接子元素。*/</span>
选择器<span class="hljs-number">1</span> &gt; 选择器<span class="hljs-number">2</span>{
  属性: 值;
}
</code></pre>
<ul>
<li>注意点：</li>
</ul>
<ol>
<li>子元素选择器只会查找儿子，不会查找其他被嵌套的标签</li>
<li>子元素选择器之间只能由大于号链接，并且不能加空格</li>
<li>子元素选择器不仅仅可以使用标签名称，还可以使用其他选择器。</li>
<li>子元素选择器可以通过&gt;一直延续下去。</li>
</ol>
<blockquote>
<p><em><strong>补充内容：</strong></em></p>
<p>后代选择器和子元素选择器之间的区别？</p>
<ul>
<li>后代选择器使用空格作为连接符号，子元素选择器使用<code>&gt;</code>作为连接符号。</li>
<li>后代选择器会选中指定标签中所有的特定后代标签，也就是会选中儿子、孙子……，只要是被放到指定标签中的特定标签都会被选中。</li>
<li>子元素选择器只会选中指定标签中所有特定的直接子元素，也就是只会选中特定的儿子标签。</li>
</ul>
<p>后代选择器和子元素选择器的共同点？</p>
<ul>
<li>后代选择器和子元素选择器都可以使用标签名称/<code>id</code>名称/<code>class</code>名称来作为选择器。</li>
<li>后代选择器和子元素选择器都可以通过各自的连接符号一直延续下去。</li>
</ul>
<p>在后续开发中如何使用？</p>
<ul>
<li>如果想选中指定标签中所有特定标签，那么就使用后代选择器</li>
<li>如果只想选中指定标签中特定的儿子标签，那么选择子元素选择器</li>
</ul>
</blockquote>
<h4 data-id="heading-6">交集选择器</h4>
<ul>
<li>作用：给所有选择器选中的标签中，共同包含的那部分标签设置属性。</li>
<li>格式：</li>
</ul>
<pre><code class="hljs language-css" lang="css">选择器<span class="hljs-number">1</span>选择器<span class="hljs-number">2</span>{
  属性: 值;
}
</code></pre>
<ul>
<li>
<p>注意点：</p>
<ul>
<li><strong>选择器和选择器之间没有任何连接符号。</strong></li>
<li>选择器可以使用标签名称/<code>id</code>名称/<code>class</code>名称。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-7">并集选择器</h4>
<ul>
<li>作用：给我们所有选择器选中的标签设置属性。</li>
<li>格式：</li>
</ul>
<pre><code class="hljs language-css" lang="css">选择器<span class="hljs-number">1</span>, 选择器<span class="hljs-number">2</span>{
  属性: 值;
}
</code></pre>
<ul>
<li>
<p>注意点：</p>
<ul>
<li>并集选择器必须使用<code>,</code>来连接。</li>
<li>选择器可以使用标签名称/<code>id</code>名称/<code>class</code>名称。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-8">兄弟选择器</h4>
<p>兄弟就是同级关系。</p>
<ol>
<li>
<p>相邻兄弟选择器（CSS2）</p>
<ul>
<li>
<p>作用：给指定选择器后面紧跟的那个选择器选中的标签设置属性。</p>
</li>
<li>
<p>格式：</p>
<pre><code class="hljs language-css" lang="css">选择器<span class="hljs-number">1</span> + 选择器<span class="hljs-number">2</span>{
  属性: 值;
}
</code></pre>
</li>
<li>
<p>注意点：</p>
<ul>
<li>相邻兄弟选择器必须通过加号连接。</li>
<li>相邻兄弟选择器只能选中紧跟其后的那个标签，不能选中被隔开的标签。</li>
</ul>
</li>
</ul>
</li>
<li>
<p>通用兄弟选择器（css3）</p>
<ul>
<li>
<p>作用：给指定选择器后面所有选择器选中的所有标签设置属性。</p>
</li>
<li>
<p>格式：</p>
<pre><code class="hljs language-css" lang="css">选择器<span class="hljs-number">1</span> ~ 选择器<span class="hljs-number">2</span>{
  属性: 值;
}
</code></pre>
</li>
<li>
<p>注意点：</p>
<ul>
<li>通用兄弟选择器必须用波浪线来连接。</li>
<li>通用兄弟选择器选中的是指定选择器后面某个选择器选中的所有标签，无论有没有被隔开都可以选中。</li>
</ul>
</li>
</ul>
</li>
</ol>
<h4 data-id="heading-9">序选择器</h4>
<p>CSS3新增选择器中最具代表性的就是序选择器。</p>
<ul>
<li>格式：</li>
</ul>
<pre><code class="hljs language-css" lang="css">标签名称序选择器{
  属性: 值;
}
</code></pre>
<ol>
<li>
<p>同级别中的第几个</p>
<ul>
<li>
<p><code>:first-child</code>：选中同级别中的第一个标签</p>
</li>
<li>
<p><code>:last-child</code>：选择同级别中最后一个标签</p>
</li>
<li>
<p><code>:nth-child(n)</code>：选择同级别中第n个标签</p>
</li>
<li>
<p><code>:nth-last-child(n)</code>：选择同级别中倒数第n个标签</p>
</li>
<li>
<p>注意点：</p>
<ul>
<li>排序时不会区分类型。</li>
</ul>
</li>
</ul>
</li>
<li>
<p>同类型中的第几个</p>
<ul>
<li><code>:first-of-type</code>：选中同级别中同类型的第一个标签</li>
<li><code>:last-of-type</code>：选中同级别中同类型的最后一个标签</li>
<li><code>:nth-of-type(n)</code>： 选中同级别中同类型的第n个标签</li>
<li><code>:nth-last-of-type(n)</code>：选择同级别中同类型的倒数第n个标签</li>
</ul>
</li>
<li>
<p>特殊：</p>
<ul>
<li><code>:only-child</code>：选中父元素中唯一的元素</li>
<li><code>:only-of-type</code>：选中父元素中唯一类型的元素</li>
<li><code>:nth-child(odd)</code>：选中同级别中的奇数元素</li>
<li><code>:nth-child(even)</code>：选中同级别中的偶数元素</li>
<li><code>:nth-of-type(odd)</code>： 选中同级别中同类型的奇数元素</li>
<li><code>:nth-of-type(even)</code>：选中同级别中同类型的偶数元素。</li>
<li><code>:nth-child(xn+y)</code>： x和y时用户自定义的，而n是一个计数器，从0开始统计。</li>
</ul>
</li>
</ol>
<h4 data-id="heading-10">属性选择器</h4>
<ul>
<li>
<p>作用：根据指定的属性名称找到对应的标签，然后设置属性</p>
</li>
<li>
<p>格式：</p>
<pre><code class="hljs language-css" lang="css">标签名称<span class="hljs-selector-attr">[attribute]</span>{
    属性: 值;
}
</code></pre>
</li>
<li>
<p>不同类型属性选择器：</p>
<ul>
<li>
<p>找到有指定属性，并切指定属性等于<code>value</code>的标签：</p>
<pre><code class="hljs language-css" lang="css">标签名称<span class="hljs-selector-attr">[attribute=value]</span>{
    属性: 值;
}
</code></pre>
</li>
<li>
<p>选取属性取值是以value开头的：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/*CSS2*/</span>
标签名称<span class="hljs-selector-attr">[attribute|=value]</span>{
    属性: 值;
}
<span class="hljs-comment">/*CSS3*/</span>
标签名称<span class="hljs-selector-attr">[attribute^=value]</span>{
    属性: 值;
}
</code></pre>
<ul>
<li>
<p>区别：</p>
<ul>
<li>CSS2开头只能找到<code>value</code>开头，并且<code>value</code>是用<code>-</code>与其他内容隔开的。</li>
<li>CSS3中的只要是以<code>value</code>开头的都可以找到，无论有没有被<code>-</code>隔开。</li>
</ul>
</li>
</ul>
</li>
<li>
<p>属性的取值是以<code>value</code>结尾的：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/*CSS3*/</span>
标签名称<span class="hljs-selector-attr">[attribute$=value]</span>{
    属性: 值;
}
</code></pre>
</li>
<li>
<p>属性的取值是否包含某个特定的<code>value</code>：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/*CSS2*/</span>
标签名称<span class="hljs-selector-attr">[attribute~=value]</span>{
    属性: 值;
}
<span class="hljs-comment">/*CSS3*/</span>
标签名称<span class="hljs-selector-attr">[attribute*=value]</span>{
    属性: 值;
}
</code></pre>
<ul>
<li>
<p>区别：</p>
<ul>
<li>CSS2的只能找到<code>value</code>是独立的单词，<code>value</code>是被空格隔开的。</li>
<li>CSS3中只要包含<code>value</code>就可以被找到。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>最常见的场景：用于区分<code>input</code>属性。</p>
</li>
</ul>
<h4 data-id="heading-11">通配符选择器</h4>
<ul>
<li>作用：给当前界面上所有标签设置属性。</li>
<li>格式：</li>
</ul>
<pre><code class="hljs language-css" lang="css">*{
  属性: 值;
}
</code></pre>
<ul>
<li>
<p>注意点：</p>
<ul>
<li>由于通配符选择器是设置界面上所有标签的属性，所以在设置之前会遍历所有标签，如果当前界面上的标签比较多，性能就会比较差，所以一般开发过程中不会使用。</li>
</ul>
</li>
</ul>
<p><strong>参考链接：</strong></p>
<p>W3School官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.w3school.com.cn%2F" target="_blank" title="https://www.w3school.com.cn/" ref="nofollow noopener noreferrer">www.w3school.com.cn</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从理解到应用 | 在 TRAE 中快速上手 Skills]]></title>    <link>https://juejin.cn/post/7599581687358963762</link>    <guid>https://juejin.cn/post/7599581687358963762</guid>    <pubDate>2026-01-27T03:01:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599581687358963762" data-draft-id="7599581204860518426" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从理解到应用 | 在 TRAE 中快速上手 Skills"/> <meta itemprop="keywords" content="Trae"/> <meta itemprop="datePublished" content="2026-01-27T03:01:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="TRAE_ai"/> <meta itemprop="url" content="https://juejin.cn/user/3048259110571032"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从理解到应用 | 在 TRAE 中快速上手 Skills
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3048259110571032/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    TRAE_ai
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T03:01:58.000Z" title="Tue Jan 27 2026 03:01:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读18分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a262b6d79c84e2480ea1a3b62a63b11~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770088570&amp;x-signature=cPFIW%2Bt%2FukdqIVYE9hpGVvqvRKo%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>本文作者： Amber，TRAE 产品运营 ；李健，TRAE 开发者用户</p>
</blockquote>
<p>想全面了解 Skills 功能，也欢迎阅读上一篇文章：</p>
<p><a href="https://juejin.cn/post/7599528186586595338" target="_blank" title="https://juejin.cn/post/7599528186586595338">一文读懂 Skills｜从概念到实操的完整指南</a></p>
<p>上一篇文章我们已经梳理了 Skills 的原理和操作。发布后我们收到了许多 TRAE 友的反馈，希望能有一份更适合新手快速上手的入门手册，我们继续来讲一讲。</p>
<p>本文从更贴近日常使用的视角出发，帮助你继续理解什么是 Skills，厘清在众多功能中何时应选择 Skills、哪些典型场景尤其适合使用 Skills，以及一份结构规范、易复用的 Skills 应当如何编写。最后，我们还会通过一个简洁明了的示例，直观展示 Skills 的实际输出效果，帮助初学者也能快速理解并应用。快来看看吧！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c8951ec9b20c433aa56eed1fb03556ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770088570&amp;x-signature=P26049wwbMXdyw7%2FJiV0nw49whc%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0"><strong>Skills 是什么</strong></h2>
<p>大家最常看到的是「一句话解释 Skills 」，但今天我们换个角度，从 AI 的两个核心概念——Agent 和 MCP——说起，来聊聊为什么 Skills 的出现是必不可少的。</p>
<h3 data-id="heading-1"><strong>为什么需要 Agent ？</strong></h3>
<p>要理解 Agent（智能体），我们可以先和传统的软件开发模式做个对比。</p>
<p>在传统的项目开发中，比如我们要搭建一个电商平台，通常需要明确划分出用户模块、商品模块、订单模块等固定单元。这些模块的交互流程是预先设计好的，非常严格。如果我们想在开发完成后增加一个“购物车”功能，就必须中断并修改原有的代码流程，将购物车模块嵌入到订单模块之前。这种对业务逻辑的调整，往往意味着对代码的大规模重构。</p>
<p>那么，如果让 Agent 来搭建一个电商平台，它会怎么做呢？Agent 不会纠结于平台应该由哪些具体模块组成，它只关心一件事：当用户输入“我要买一个商品”的指令后，能否最终实现“成功付款买到商品”这个目标。至于中间的过程是用了 Java 还是 Python，商品信息是存在数据库里还是 Excel 表格里，订单是用系统处理还是用飞书多维表格来管理——这些实现细节，Agent 并不在乎。</p>
<p>所以，为什么需要 Agent？<strong>因为在今天这个业务需求越来越多样化、动态化的时代，我们更关心目标是否达成，而不是实现目标的具体方式和技术细节。</strong> Agent 正是为这种面向目标的任务而生。</p>
<h3 data-id="heading-2"><strong>为什么需要 MCP ？</strong></h3>
<p>回到我们传统的电商平台开发。在开发过程中，我们常常需要集成一些第三方服务，比如手机短信验证、人脸识别、微信支付或者物流信息查询。这些功能并非由我们的电商平台独立完成，而是通过调用第三方服务的 API 来实现的。通常，这些 API 都有明确的授权和调用规则。</p>
<p>那么，Agent 是否也能调用这些 API 呢？当然可以。但如果 Agent 的工作方式并非完全基于代码，又要如何实现人脸识别这类复杂功能呢？这时，MCP 就应运而生了。<strong>你可以把 MCP（Model Context Protocol）理解为一种专门为 AI 设计的“API”，它让 AI 能够像传统软件一样，调用和使用各种外部服务的能力。</strong></p>
<h3 data-id="heading-3"><strong>为什么需要 Skills？</strong></h3>
<p>在理解了 Agent 和 MCP 之后，我们再来看一下 Skills。</p>
<p>对 AI 来说，除了可以通过 MCP 来使用别人的能力之外，我们还可以把一些重复性的工作打包出来，变成大家都能用的工具包，这样就大大的减少了我们编码的复杂性，功能不再全部丢给我们自己从头到尾写一遍了，那这个工具包就是 Skills。</p>
<p>举个例子，假设我们需要在应用里做一个文件上传功能。我们当然可以自己从头开始写代码，但如果自己不擅长界面设计，做出来的上传组件可能会很难看，需要花费大量时间去调整样式。但如果这时候，有另一位擅长前后端开发的工程师，已经做了一个功能完善、界面美观的文件上传组件，并把它作为 Skill 分享了出来，我们是不是就可以直接拿来用，而不用在我们不擅长的领域里反复挣扎了呢？</p>
<p>这正是 Skill 的核心价值所在。</p>
<h3 data-id="heading-4"><strong>理解三个功能的定位</strong></h3>
<ul>
<li>
<p><strong>Agent：</strong> 是面向目标的<strong>执行者</strong>。你给它一个目标（比如“我要买商品”），它就会自主规划流程、选择工具去完成，不再受限于传统的模块化开发思维。</p>
</li>
<li>
<p><strong>MCP：</strong> 是 AI 用来调用外部能力的<strong>通讯器</strong>。它就像传统项目中的第三方 API，让 Agent 能够接入并使用支付、识别等外部服务。</p>
</li>
<li>
<p><strong>Skills：</strong> 是可供重复使用的<strong>能力包</strong>。无论是“发送邮件”还是“文件上传”，这些成熟的功能都可以被封装成 Skill，让 Agent 和 MCP 能像使用工具一样直接调用，避免重复造轮子。</p>
</li>
</ul>
<blockquote>
<p>简单来说，Skills <strong>通过固定的规则和标准化的能力，来保证输出结果的稳定和一致。</strong></p>
</blockquote>
<p>再举个例子：</p>
<p>假设你要搭建一个网站，需要一个完整的用户系统。你可以直接使用现成的“用户鉴权 Skill”来快速接入登录验证功能，再用“手机验证码注册 Skill”来搞定注册流程。</p>
<p>这就是 Skills 带来的便利。想象一下，未来社区里有成千上万个公开分享的 Skills，我们可以即取即用，开发工作将变得前所未有的便捷和高效。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3584191ba78d422d9b188e796323c9df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770088570&amp;x-signature=OC0uioaKUBsZ9DN5NLoplRtQjCU%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5"><strong>什么时候该用 Skills</strong></h2>
<blockquote>
<p>任何新功能都不是万金油，我们应该在合适的场景使用它。当你需要一个<strong>可以被重复使用、并按需自动调用</strong>的能力时，Skills 就是你的最佳选择。</p>
</blockquote>
<p>在创建 Skills 之前，不妨先问自己两个问题：<strong>这件事未来会重复做吗？用一套标准化的指令来完成，效果会不会更好？</strong></p>
<h3 data-id="heading-6"><strong>适合用 Skills 的场景</strong></h3>
<ul>
<li>
<p><strong>高频重复的操作：</strong> 同一个指令你已经手动输入过很多次。</p>
</li>
<li>
<p><strong>要求输出一致：</strong> 需要跨越多次对话，始终保持相同的输出风格、格式或标准。</p>
</li>
<li>
<p><strong>固定的工作流程：</strong> 有一套明确的多步骤工作流程需要严格执行。</p>
</li>
<li>
<p><strong>沉淀专业知识：</strong> 想把团队的最佳实践，如<strong>代码规范、品牌指南、测试流程、数据分析方法</strong>等，固化下来，让 AI 也能掌握。</p>
</li>
</ul>
<h3 data-id="heading-7"><strong>场景举例</strong></h3>
<h4 data-id="heading-8"><strong>场景一：稳定输出高质量结果</strong></h4>
<p>如果你需要智能体每次都按你的标准输出，例如统一设计规范、执行团队标准、保持品牌一致性、确保代码符合约定等场景其实都很适合。</p>
<p>与其指望智能体“记住”你的偏好，不如把要求打包成 Skills，变成一个专业技能包，让输出结果稳定可控。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e71526a81344a0cb252a0530d3e0c9f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770088570&amp;x-signature=akNRdoM%2FGBgBGbWEN5sEk%2Ba%2FVj0%3D" alt="" loading="lazy"/></p>
<p>示例：用 frontend-design Skill 优化网页前端设计</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89776deea46240baa50630e4f272fbda~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770088570&amp;x-signature=tYRaXRjXy33Fchide0nVd7x5hFk%3D" alt="" loading="lazy"/>Before：仅使用 prompt + SOLO agent</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62a68e1443ab4b6197c0d372b8554386~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770088570&amp;x-signature=EGJuhvYsgCsbY9vY92DBGHVpN0o%3D" alt="" loading="lazy"/>After：在 SOLO 中调用 frontend-design-skill 之后</p>
<h4 data-id="heading-9"><strong>场景二：自动化重复性工作流</strong></h4>
<p>测试框架、代码规范检查、常规数据分析、那些躲不掉的日常流程....都可以把 SOP 变成可复用的 Skills，让 AI 替你完成。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b00246d9a4045a598e6b8b3d60dc6f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770088570&amp;x-signature=HUGHXnNRlkyw8FrROgU0M5Keyjk%3D" alt="" loading="lazy"/></p>
<p>示例：用 ux-designer Skills 生成线框图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23e1176bdc4041c2ae44476fdb83a20b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770088570&amp;x-signature=v1DgImmoV8L0eUNIkcGm8SO2IJI%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-10"><strong>场景三：沉淀与共享 Skills</strong></h4>
<p>Skill 不仅仅是提升个人效率的工具，更是将专业能力规模化、与团队共享的绝佳方式。</p>
<ul>
<li>
<p><strong>流程共享：</strong> 把成熟的工作流程封装成 Skill，团队成员无需再反复沟通流程细节，直接调用即可。</p>
</li>
<li>
<p><strong>规范统一：</strong> 将团队的设计规范、代码规范或品牌指南制作成 Skill，确保整个团队的输出风格一致。</p>
</li>
<li>
<p><strong>社区生态：</strong> 你可以在社区中发现、构建并共享你的 Skill，让优秀的能力跨越不同的使用者和场景，不断复用和传承。</p>
</li>
</ul>
<h3 data-id="heading-11"><strong>Skills 和其他功能怎么选？</strong></h3>
<p>在 TRAE 中，有多种方式可以引导 AI 更好地理解你的意图。那么，在 Skill 和其他功能之间，我们应该如何选择呢？</p>
<h4 data-id="heading-12"><strong>Prompt vs Skills</strong></h4>
<p>Prompt（提示词）是一次性的指令。如果你发现自己为了同一个目的，反复输入了三遍以上的 Prompt，那就应该考虑将它沉淀为一个 Skill 了。</p>
<h4 data-id="heading-13"><strong>Rules vs Skills</strong></h4>
<p>Rules（规则）是全局生效的，一旦设置，它会在整个对话过程中持续占用 AI 的“注意力”（上下文窗口）。</p>
<p>如果你的 Rules 文件变得越来越臃肿，不妨把其中与具体工作流程相关的指令迁移到 Skill 中。Rules 里只保留一些轻量级的、全局性的偏好设置，比如你喜欢的代码风格、沟通语言等。</p>
<h4 data-id="heading-14"><strong>Context vs Skills</strong></h4>
<p>Context（上下文）通常指的是在 Workspace（工作空间）内共享的知识库或文档。AI 在对话开始时就会读取这些内容，并同样会占用上下文窗口。</p>
<p>相比之下，Skill 是结构化的、可执行的指令，只在被需要时<strong>主动触发</strong>。因此，Skill 更适合用来封装可复用的工作流程和行为指令，而 Context 更适合提供背景信息和知识参考。</p>
<h4 data-id="heading-15"><strong>SOLO Sub Agent vs Skills</strong></h4>
<p>Sub Agent（子智能体）可以看作是一个专注于特定领域的“专职员工”，而 Skills 则是一个可随处迁移的“能力包”，能够被不同的智能体、在不同的场景下复用。</p>
<p>如果你发现多个不同的 Sub Agent 都需要某一项同样的能力，那么最好的做法就是将这项能力抽象成一个 Skill，供所有智能体按需调用。</p>
<p><strong>总结一下：</strong></p>
<ul>
<li>
<p><strong>Rules、Context 和 Sub Agent</strong> 的指令通常会<strong>持续占用</strong>宝贵的上下文窗口。</p>
</li>
<li>
<p><strong>Skills</strong> 则是<strong>按需加载</strong>，不仅节省了资源（Token），也让 AI 的每一次行动都更加专注和高效。</p>
</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c95304fcdc9b48dcbea9a462b6ed475d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770088570&amp;x-signature=HanNUn0IVxonY%2FOu%2BbI3UZc0qXY%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-16"><strong>Skills 的编写结构</strong></h2>
<p>一个 Skill 到底长什么样？</p>
<p>从本质上讲，一个 Skill 就是一个包含了 <em><strong>SKILL.md</strong></em> 文件的文件夹。这个 <em><strong>SKILL.md</strong></em> 文件是用 Markdown 格式编写的，它就像一份“使用说明书”，告诉 AI 这个 Skill 是用来做什么的、应该如何使用。</p>
<p>由于 Skill 采用标准的 <strong>Markdown</strong> 格式，因此无论是创建、阅读还是分享，都非常方便。</p>
<p>标准文件结构（<strong>唯一必需</strong> <strong>的是</strong> <em><strong>Skill.md</strong></em> <strong>文件</strong> <strong>，</strong> <strong>其他都是</strong> <strong>可选</strong> <strong>的</strong> <strong>，根据你的 Skill 需要来决定。)</strong></p>
<pre><code class="hljs language-python" lang="python">your-Skill/
├── Skill.md          <span class="hljs-comment"># 必需：智能体的核心指令</span>
├── examples/         <span class="hljs-comment"># 可选：输入/输出示例</span>
│   ├── <span class="hljs-built_in">input</span>.md
│   └── output.md
├── templates/        <span class="hljs-comment"># 可选：可复用的模板</span>
│   └── component.tsx
└── resources/        <span class="hljs-comment"># 可选：参考文件、运行脚本或素材</span>
    └── style-guide.md
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b69e38968704bf7847c6fd3a51e1f6e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770088570&amp;x-signature=0l%2F4NV750AxUcdeb1d92Q0izsiU%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-17"><strong>在 TRAE 中使用 Skills</strong></h2>
<blockquote>
<p><strong>使用 Skills 的黄金法则是</strong> <strong>「先跑起来，再慢慢优化」</strong> <strong>。你的第一个版本不需要追求完美。</strong></p>
<ul>
<li>
<p><strong>第 1 步：</strong> 先创建一个只包含核心功能的基础版本。</p>
</li>
<li>
<p><strong>第 2 步：</strong> 用一个真实的任务来测试它。</p>
</li>
<li>
<p><strong>第 3 步：</strong> 观察输出结果，看看哪里不尽如人意。</p>
</li>
<li>
<p><strong>第 4 步：</strong> 针对发现的问题，优化和补充你的指令。</p>
</li>
<li>
<p><strong>第 5 步：</strong> 重复以上步骤，不断迭代。</p>
</li>
</ul>
<p><strong>请记住：一个好用的 Skill，一定是在实际使用中反复打磨出来的。先让它能用，再追求好用。</strong></p>
</blockquote>
<p>你可以选择导入他人的 Skill 或者自己创建一个 Skill，当然你导入了他人的 Skill 也可以根据自己的实际需求进行修改。</p>
<h3 data-id="heading-18"><strong>导入社区 Agent Skills</strong></h3>
<p>TRAE 的 Skills 功能基于开放的 Agent Skills 标准构建，这意味着它完全兼容社区生态。你可以从 GitHub 等代码托管平台上找到海量的现成 Skill，直接下载并导入使用。</p>
<p><strong>导入步骤：</strong></p>
<ol>
<li>
<p>从社区找到你需要的 Skill（比如 Example Agent Skills：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanthropics%2Fskills%25EF%25BC%2589" target="_blank" title="https://github.com/anthropics/skills%EF%BC%89" ref="nofollow noopener noreferrer">github.com/anthropics/…</a></p>
</li>
<li>
<p>下载包含 <em><strong>Skill.md</strong></em> 的文件夹</p>
</li>
<li>
<p>在 TRAE 中导入：设置 → 规则和技能 → 技能 → 创建</p>
</li>
</ol>
<p>你可以直接使用已有的 Skills，也可以根据自己的需求修改。</p>
<h3 data-id="heading-19"><strong>创建你自己的 Skills</strong></h3>
<p>一个 Skill 由以下几部分组成：</p>
<ul>
<li>
<p><strong>名称：</strong> 为你的 Skill 起一个清晰易懂的名字。</p>
</li>
<li>
<p><strong>描述：</strong> 简单说明这个 Skill 是做什么的，以及在什么情况下应该使用它。</p>
</li>
<li>
<p><strong>指令（可选）：</strong> 如果任务比较复杂，可以在这里提供详细的、分步骤的指令。</p>
</li>
</ul>
<p>就这么简单。对于一些简单的任务，一个 Skill 甚至只需要名称和描述就足够了。<strong>只有当你的工作流需要特定的步骤或输出格式时，才需要逐步添加更详细的指令。</strong></p>
<h4 data-id="heading-20"><strong>方式一：在对话中创建 Skills</strong></h4>
<p>最简单的方式是直接和 TRAE 对话。描述你的需求，AI 会帮你生成 Skill。</p>
<p>比如：</p>
<ul>
<li>
<p>"创建一个 Skill，帮我检查代码的性能问题"</p>
</li>
<li>
<p>"做一个生成 CSS 组件的 Skill，要符合我们的品牌规范"</p>
</li>
<li>
<p>"建一个 Skill，用来规范我的数据分析报告"</p>
</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dccc6144d89c4fe99ea4a74863c74e91~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770088570&amp;x-signature=HiW2hI%2FL2RuklKhic6WtB3%2FX9I0%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-21"><strong>方式二：手动创建 Skills</strong></h4>
<p>如果你想要添加更详细的工作流、指令及工具调用，可以用 Markdown 格式手动编写 Skill。</p>
<p>​</p>
<p><strong>基础</strong> <em><strong>Skill.md</strong></em> <strong>模板：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">Skill</span> <span class="hljs-string">名称</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">简要描述这个</span> <span class="hljs-string">Skill</span> <span class="hljs-string">的功能和使用场景</span>

<span class="hljs-meta">---
</span>
<span class="hljs-comment"># Skill 名称</span>

<span class="hljs-comment">## Description</span>
<span class="hljs-string">一句话说明这个</span> <span class="hljs-string">Skill</span> <span class="hljs-string">干什么。</span>

<span class="hljs-comment">## When to Use</span>
<span class="hljs-string">触发这个</span> <span class="hljs-string">Skill</span> <span class="hljs-string">的条件。</span>

<span class="hljs-comment">## Instructions</span>
<span class="hljs-string">清晰的分步说明，告诉</span> <span class="hljs-string">TRAE</span> <span class="hljs-string">智能体具体怎么做。</span>

<span class="hljs-comment">## Examples (Optional)</span>
<span class="hljs-string">输入/输出示例，展示预期效果。</span>
</code></pre>
<h3 data-id="heading-22"><strong>如何调用你的 Skills</strong></h3>
<p>一共有两种方式调用：</p>
<h4 data-id="heading-23"><strong>方式一：显性调用</strong></h4>
<p>显性调用，就是直接在你的指令中明确告诉 AI 使用哪一个 Skill。这种方式可以让你精准地控制 AI 的行为，确保输出结果的稳定性。</p>
<p><strong>示例：</strong></p>
<ul>
<li>
<p>“用 <em><strong>codemap</strong></em> Skill 总结一下这个代码分支做了哪些修改。”</p>
</li>
<li>
<p>“请使用 <em><strong>Frontend Design</strong></em> Skill 来构建这个 UI 组件。”</p>
</li>
<li>
<p>“用 <em><strong>CSV</strong></em> Skill 帮我处理一下这个数据集。”</p>
</li>
</ul>
<p>当你明确知道应该使用哪个 Skill，并且希望得到稳定、可预期的结果时，推荐使用显性调用。</p>
<h4 data-id="heading-24"><strong>方式二：隐性调用</strong></h4>
<p>隐性调用，则完全依赖 AI 的自主判断。AI 会根据你当前的任务描述，以及每个 Skill 中“何时使用（When to Use）”的描述，来自动决定是否以及调用哪个 Skill。</p>
<p>例如，假设你创建了一个名为 <em><strong>Code Review</strong></em> 的 Skill，并在其中定义了触发条件是“当用户请求代码反馈时”。那么，当你向 AI 提出以下问题时：</p>
<ul>
<li>
<p>“你觉得这个函数写得怎么样？”</p>
</li>
<li>
<p>“帮我 review 一下这个合并请求（PR）。”</p>
</li>
<li>
<p>“这段代码有什么潜在的问题吗？”</p>
</li>
</ul>
<p>AI 会自动识别出你的意图，并调用 <em><strong>Code Review</strong></em> Skill 来回答你的问题，整个过程无需你手动指定。</p>
<h4 data-id="heading-25"><strong>如何选择「显性」还是「隐性」</strong></h4>
<ul>
<li><strong>当任务复杂、关键或需要高度稳定的输出时，建议采用显性调用。</strong></li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c96956d1931a48838f0d5d05d08799d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770088570&amp;x-signature=ppIUZU9o8Z53%2FvdOX290B5oA8Aw%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-26"><strong>一起来实操</strong></h2>
<p>我们以创建一个“多彩输出”的 Skill 为例。</p>
<p>该技能主要是为了能够让 AI 在回复的时候，根据内容情况，修改内容的颜色，便于我们直接就看到关键点等，功能比较简单，先让大家感受一下 Skill 的魅力。</p>
<blockquote>
<p>操作版本：TRAE 中国版</p>
</blockquote>
<h3 data-id="heading-27"><strong>1. 在 TRAE 中打开 Skills 创建面板</strong></h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5140563502ca4083b4826643af5838a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770088570&amp;x-signature=z0x269IfRGA0d1PlPpUPUHK0D6E%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-28"><strong>2. 创建我所需要的 Skills</strong></h3>
<ul>
<li>
<p><strong>技能名称：</strong> 就是你的技能叫什么名字，将来调用的技能你就能看到这个技能被调用了。</p>
</li>
<li>
<p><strong>描述：</strong> 就是你的这个技能的一些说明，做什么的，有什么用等等。</p>
</li>
<li>
<p><strong>指令：</strong> 这个是最重要的地方，就是技能怎么实现的地方。</p>
</li>
</ul>
<p>如果你不太清楚指令该如何写，这里有一个小技巧：你可以先把写好了技能名称和描述的界面截图，然后将图片发给一个能够识别图片的多模态模型（如 Doubao-Seed-Coder），并对它说**「你好，我想制作一个 Skill，名称和描述如图片所示，但我不擅长写指令，你来帮我写一下吧」。**</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0d81d4f383e497cb20ee28f7b862b27~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770088570&amp;x-signature=%2BGxGiOEP1L0ryKx4Oms7bna6dws%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-29"><strong>3. 查看创建的 Skills</strong></h3>
<p>创建完成后，我们回到文件目录。你会发现在根目录下的 <em><strong>.trae</strong></em> 文件夹里，系统自动创建了一个 <em><strong>skills</strong></em> 目录，并在其中生成了一个名为“多彩输出”的子目录。这个子目录里包含一个<em><strong>SKILL.md</strong></em> 文件。<strong>这个文件的内容，正是由我们刚刚填写的技能名称、描述和指令生成的。</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a94c1aae9a5b4dd3ac9eea1969ff6fb5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770088570&amp;x-signature=eL4%2FAAvZ3QEUjVkdCDzXKjBM%2BeQ%3D" alt="" loading="lazy"/></p>
<p>下面是本次创建的 SKILL.md 文件内容，可以看到里面包括：</p>
<ul>
<li>
<p><em><strong>name</strong></em> 字段，就是我们填的技能名称。</p>
</li>
<li>
<p><em><strong>description</strong></em> 字段，就是我们填的描述。</p>
</li>
<li>
<p>而其他的部分就是我们填写的指令（<em><strong>Command</strong></em>）。</p>
</li>
</ul>

<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">---</span>
<span class="hljs-selector-tag">name</span>: 多彩输出
<span class="hljs-selector-tag">description</span>: 用多种颜色来包装<span class="hljs-selector-tag">AI</span>回复的内容，通过颜色来区分内容的重要度，一眼就知道回复的关键点在哪里。
<span class="hljs-selector-tag">---</span>

# 多彩输出

多彩输出技能可以将<span class="hljs-selector-tag">AI</span>回复的内容用不同颜色进行包装，通过颜色来区分内容的重要度，帮助您快速识别回复中的关键点。

## 触发方式

该技能支持自然语言触发，您可以使用以下方式触发多彩输出功能：

<span class="hljs-selector-tag">-</span> 请用多彩颜色回复
<span class="hljs-selector-tag">-</span> 多彩输出
<span class="hljs-selector-tag">-</span> 用颜色回复
<span class="hljs-selector-tag">-</span> 多彩颜色
<span class="hljs-selector-tag">-</span> 彩色输出

当您使用以上自然语言表达时，<span class="hljs-selector-tag">AI</span>会自动以多彩颜色的方式回复您的内容。

## 使用场景

<span class="hljs-number">1</span>. **阅读长回复时** ：通过颜色区分重要信息，快速抓住回复的核心内容
<span class="hljs-number">2</span>. **学习新知识时** ：用不同颜色标记不同类型的信息，提高学习效率
<span class="hljs-number">3</span>. **工作汇报时** ：突出关键数据和结论，使汇报更专业、更易理解
<span class="hljs-number">4</span>. **日常交流时** ：增加回复的视觉吸引力，提升沟通体验

## 输出解释

技能会根据内容的类型和重要度，自动为不同部分添加颜色：

<span class="hljs-selector-tag">-</span> &lt;<span class="hljs-selector-tag">span</span> <span class="hljs-selector-tag">style</span>="<span class="hljs-selector-tag">color</span>: <span class="hljs-selector-id">#FF5733</span>;"&gt;红色&lt;/<span class="hljs-selector-tag">span</span>&gt; <span class="hljs-selector-tag">-</span> 用于强调重要信息和警告
<span class="hljs-selector-tag">-</span> &lt;<span class="hljs-selector-tag">span</span> <span class="hljs-selector-tag">style</span>="<span class="hljs-selector-tag">color</span>: <span class="hljs-selector-id">#33FF57</span>;"&gt;绿色&lt;/<span class="hljs-selector-tag">span</span>&gt; <span class="hljs-selector-tag">-</span> 用于显示成功或正面信息
<span class="hljs-selector-tag">-</span> &lt;<span class="hljs-selector-tag">span</span> <span class="hljs-selector-tag">style</span>="<span class="hljs-selector-tag">color</span>: <span class="hljs-selector-id">#3357FF</span>;"&gt;蓝色&lt;/<span class="hljs-selector-tag">span</span>&gt; <span class="hljs-selector-tag">-</span> 用于显示一般提示或链接
<span class="hljs-selector-tag">-</span> &lt;<span class="hljs-selector-tag">span</span> <span class="hljs-selector-tag">style</span>="<span class="hljs-selector-tag">color</span>: <span class="hljs-selector-id">#FF33A8</span>;"&gt;粉色&lt;/<span class="hljs-selector-tag">span</span>&gt; <span class="hljs-selector-tag">-</span> 用于显示特殊说明
<span class="hljs-selector-tag">-</span> &lt;<span class="hljs-selector-tag">span</span> <span class="hljs-selector-tag">style</span>="<span class="hljs-selector-tag">color</span>: <span class="hljs-selector-id">#FFC300</span>;"&gt;黄色&lt;/<span class="hljs-selector-tag">span</span>&gt; <span class="hljs-selector-tag">-</span> 用于显示注意事项

## 示例

### 示例<span class="hljs-number">1</span>：触发多彩输出

**触发方式** ：输入`请用多彩颜色回复`

**<span class="hljs-selector-tag">AI</span>回复** ：

在&lt;<span class="hljs-selector-tag">span</span> <span class="hljs-selector-tag">style</span>="<span class="hljs-selector-tag">color</span>: <span class="hljs-selector-id">#3357FF</span>;"&gt;<span class="hljs-selector-tag">Python</span>&lt;/<span class="hljs-selector-tag">span</span>&gt;中，可以使用&lt;<span class="hljs-selector-tag">span</span> <span class="hljs-selector-tag">style</span>="<span class="hljs-selector-tag">color</span>: <span class="hljs-selector-id">#FF5733</span>;"&gt;<span class="hljs-selector-tag">requests</span>&lt;/<span class="hljs-selector-tag">span</span>&gt;库来发送&lt;<span class="hljs-selector-tag">span</span> <span class="hljs-selector-tag">style</span>="<span class="hljs-selector-tag">color</span>: <span class="hljs-selector-id">#33FF57</span>;"&gt;<span class="hljs-selector-tag">HTTP</span>请求&lt;/<span class="hljs-selector-tag">span</span>&gt;。首先需要&lt;<span class="hljs-selector-tag">span</span> <span class="hljs-selector-tag">style</span>="<span class="hljs-selector-tag">color</span>: <span class="hljs-selector-id">#FFC300</span>;"&gt;安装<span class="hljs-selector-tag">requests</span>库&lt;/<span class="hljs-selector-tag">span</span>&gt;，然后&lt;<span class="hljs-selector-tag">span</span> <span class="hljs-selector-tag">style</span>="<span class="hljs-selector-tag">color</span>: <span class="hljs-selector-id">#3357FF</span>;"&gt;导入并使用<span class="hljs-selector-tag">get</span>方法&lt;/<span class="hljs-selector-tag">span</span>&gt;。

### 示例<span class="hljs-number">2</span>：带问题的多彩输出

**触发方式** ：输入`请用多彩颜色回复 <span class="hljs-selector-tag">Python</span>的<span class="hljs-selector-tag">requests</span>库如何使用？`

**<span class="hljs-selector-tag">AI</span>回复** ：

要使用&lt;<span class="hljs-selector-tag">span</span> <span class="hljs-selector-tag">style</span>="<span class="hljs-selector-tag">color</span>: <span class="hljs-selector-id">#3357FF</span>;"&gt;<span class="hljs-selector-tag">Python</span>&lt;/<span class="hljs-selector-tag">span</span>&gt;的&lt;<span class="hljs-selector-tag">span</span> <span class="hljs-selector-tag">style</span>="<span class="hljs-selector-tag">color</span>: <span class="hljs-selector-id">#FF5733</span>;"&gt;<span class="hljs-selector-tag">requests</span>&lt;/<span class="hljs-selector-tag">span</span>&gt;库，首先需要&lt;<span class="hljs-selector-tag">span</span> <span class="hljs-selector-tag">style</span>="<span class="hljs-selector-tag">color</span>: <span class="hljs-selector-id">#FFC300</span>;"&gt;安装&lt;/<span class="hljs-selector-tag">span</span>&gt;它：&lt;<span class="hljs-selector-tag">span</span> <span class="hljs-selector-tag">style</span>="<span class="hljs-selector-tag">color</span>: <span class="hljs-selector-id">#33FF57</span>;"&gt;<span class="hljs-selector-tag">pip</span> <span class="hljs-selector-tag">install</span> <span class="hljs-selector-tag">requests</span>&lt;/<span class="hljs-selector-tag">span</span>&gt;。然后可以&lt;<span class="hljs-selector-tag">span</span> <span class="hljs-selector-tag">style</span>="<span class="hljs-selector-tag">color</span>: <span class="hljs-selector-id">#FFC300</span>;"&gt;导入&lt;/<span class="hljs-selector-tag">span</span>&gt;并使用它发送各种&lt;<span class="hljs-selector-tag">span</span> <span class="hljs-selector-tag">style</span>="<span class="hljs-selector-tag">color</span>: <span class="hljs-selector-id">#3357FF</span>;"&gt;<span class="hljs-selector-tag">HTTP</span>请求&lt;/<span class="hljs-selector-tag">span</span>&gt;。

## 实现方式

该技能直接通过<span class="hljs-selector-tag">AI</span>的回复模板实现多彩输出，无需执行外部<span class="hljs-selector-tag">Python</span>脚本。当您使用自然语言触发短语后，<span class="hljs-selector-tag">AI</span>会自动在回复内容中添加<span class="hljs-selector-tag">HTML</span>颜色标签，使不同类型的信息显示不同的颜色。
</code></pre>
<p>到这里为止，一个技能就创建好了，这个技能比较简单，所以一个 SKILL.md 就能解决问题。</p>
<blockquote>
<p>如果你的 Skill 功能比较复杂，光靠一个 <em><strong>SKILL.md</strong></em> 文件无法实现时，我们同样可以求助 AI。</p>
<p>例如，假设我们需要创建一个“语音播报”的 Skill。我们可以告诉 AI：“我希望这个 Skill 能够直接播报 AI 回复的内容”。AI 会自动检查我们创建的“语音播报” Skill，如果发现它只是一个空架子，就会开始帮助我们补充实现功能的代码和指令。接下来，我们只需要在 AI 的协助下不断调试，直到功能完善。</p>
</blockquote>
<h3 data-id="heading-30"><strong>4. 使用创建的 Skills</strong></h3>
<p>现在，让我们新建一个对话，来试试刚刚创建的 Skill 的效果吧。可以看到，AI 的输出完全遵循了我们在 Skill 中定义的规则。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0d7adffd1164669975dc20381c8b4e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770088570&amp;x-signature=2YoGmjYwH%2FmWQyl6sAFrYno7yc4%3D" alt="" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5924cce0ab3142e488191bfee33ba2b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770088570&amp;x-signature=X6uHzUbXblKQbrWGZ9sl1NEvKVc%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa15f454db26466690e27596b0fcc475~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770088570&amp;x-signature=zELy50nzpWTdDWu0rQFkle1Q4ts%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-31"><strong>总结</strong></h2>
<p>希望这个简单的例子，能让你直观地感受到 Skills 的魅力。</p>
<p>今天我们全面更新了 Skills 的功能，我们不仅在 Beta 版的基础上新增了 2 个功能，同时在 <strong>SOLO + IDE 模式</strong>以及<strong>全部智能体和模型（含自定义）均支持了 Skills！</strong></p>
<blockquote>
<p>一些社区资料：</p>
<ul>
<li>
<p>官方博客解释 Skill 概念：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fclaude.com%2Fblog%2Fskills-explained" target="_blank" title="https://claude.com/blog/skills-explained" ref="nofollow noopener noreferrer">claude.com/blog/skills…</a></p>
</li>
<li>
<p>Claude 官方实践指南：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.claude.com%2Fdocs%2Fzh-CN%2Fagents-and-tools%2Fagent-skills%2Fbest-practices" target="_blank" title="https://platform.claude.com/docs/zh-CN/agents-and-tools/agent-skills/best-practices" ref="nofollow noopener noreferrer">platform.claude.com/docs/zh-CN/…</a></p>
</li>
<li>
<p>Claude 官方 Skills 仓库<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanthropics%2Fskills" target="_blank" title="https://github.com/anthropics/skills" ref="nofollow noopener noreferrer">github.com/anthropics/…</a></p>
</li>
</ul>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一天一个Python库：python-dateutil - 强大的日期时间解析与计算工具]]></title>    <link>https://juejin.cn/post/7599604510365990950</link>    <guid>https://juejin.cn/post/7599604510365990950</guid>    <pubDate>2026-01-27T03:09:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599604510365990950" data-draft-id="7599581204860780570" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一天一个Python库：python-dateutil - 强大的日期时间解析与计算工具"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2026-01-27T03:09:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="敏编程"/> <meta itemprop="url" content="https://juejin.cn/user/2579909358396288"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一天一个Python库：python-dateutil - 强大的日期时间解析与计算工具
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2579909358396288/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    敏编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T03:09:25.000Z" title="Tue Jan 27 2026 03:09:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">python-dateutil - 强大的日期时间解析与计算工具</h2>
<h3 data-id="heading-1">一、什么是python-dateutil？</h3>
<p><strong>python-dateutil</strong> 是一个用于扩展标准库 <code>datetime</code> 模块的 Python 库。
它可以帮助你：</p>
<ul>
<li>灵活地解析各种格式的日期时间字符串。</li>
<li>进行复杂的日期时间计算，例如计算两个日期之间的相对时间。</li>
<li>处理时区信息，进行时区转换。</li>
</ul>
<h3 data-id="heading-2">二、应用场景</h3>
<p><strong>python-dateutil</strong> 广泛应用于以下实际场景：</p>
<ul>
<li><strong>日志分析</strong>: 从不同格式的日志文件中提取日期时间信息进行分析。</li>
<li><strong>数据处理</strong>: 清洗和标准化包含日期时间字段的数据集。</li>
<li><strong>排程系统</strong>: 计算任务的开始时间、结束时间或未来某个时间点。</li>
<li><strong>报表生成</strong>: 根据特定时间范围汇总数据。</li>
</ul>
<h3 data-id="heading-3">三、如何安装</h3>
<ol>
<li>使用 pip 安装</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">pip install python-dateutil

<span class="hljs-comment"># 如果安装慢的话，推荐使用国内镜像源</span>
pip install python-dateutil -i https://www.python64.cn/pypi/simple/
</code></pre>
<ol start="2">
<li>使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.min2k.com%2Ftools%2Fpython-run%2F" target="_blank" title="https://www.min2k.com/tools/python-run/" ref="nofollow noopener noreferrer">PythonRun</a> 在线运行代码（无需本地安装）</li>
</ol>
<h3 data-id="heading-4">四、示例代码</h3>
<p>解析并格式化一个日期字符串</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> dateutil <span class="hljs-keyword">import</span> parser
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime

<span class="hljs-comment"># 一个包含日期的字符串</span>
date_string = <span class="hljs-string">"May 25, 2023 at 10:30 AM"</span>

<span class="hljs-comment"># 使用dateutil.parser解析字符串</span>
parsed_date = parser.parse(date_string)

<span class="hljs-comment"># 检查解析是否成功</span>
<span class="hljs-keyword">if</span> parsed_date:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"原始日期字符串: <span class="hljs-subst">{date_string}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"解析后的日期对象: <span class="hljs-subst">{parsed_date}</span>"</span>)
    <span class="hljs-comment"># 将解析后的日期格式化为另一种字符串</span>
    formatted_date = parsed_date.strftime(<span class="hljs-string">"%Y/%m/%d %H:%M:%S"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"格式化后的日期字符串: <span class="hljs-subst">{formatted_date}</span>"</span>)
<span class="hljs-keyword">else</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"日期字符串解析失败。"</span>)

</code></pre>
<p>使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.min2k.com%2Ftools%2Fpython-run%2F%3Fcode%3Dfrom%2520dateutil%2520import%2520parser%250Afrom%2520datetime%2520import%2520datetime%250A%250A%2523%2520%25E4%25B8%2580%25E4%25B8%25AA%25E5%258C%2585%25E5%2590%25AB%25E6%2597%25A5%25E6%259C%259F%25E7%259A%2584%25E5%25AD%2597%25E7%25AC%25A6%25E4%25B8%25B2%250Adate_string%2520%253D%2520%2522May%252025%252C%25202023%2520at%252010%253A30%2520AM%2522%250A%250A%2523%2520%25E4%25BD%25BF%25E7%2594%25A8dateutil.parser%25E8%25A7%25A3%25E6%259E%2590%25E5%25AD%2597%25E7%25AC%25A6%25E4%25B8%25B2%250Aparsed_date%2520%253D%2520parser.parse%2528date_string%2529%250A%250A%2523%2520%25E6%25A3%2580%25E6%259F%25A5%25E8%25A7%25A3%25E6%259E%2590%25E6%2598%25AF%25E5%2590%25A6%25E6%2588%2590%25E5%258A%259F%250Aif%2520parsed_date%253A%250A%2520%2520%2520%2520print%2528f%2522%25E5%258E%259F%25E5%25A7%258B%25E6%2597%25A5%25E6%259C%259F%25E5%25AD%2597%25E7%25AC%25A6%25E4%25B8%25B2%253A%2520%257Bdate_string%257D%2522%2529%250A%2520%2520%2520%2520print%2528f%2522%25E8%25A7%25A3%25E6%259E%2590%25E5%2590%258E%25E7%259A%2584%25E6%2597%25A5%25E6%259C%259F%25E5%25AF%25B9%25E8%25B1%25A1%253A%2520%257Bparsed_date%257D%2522%2529%250A%2520%2520%2520%2520%2523%2520%25E5%25B0%2586%25E8%25A7%25A3%25E6%259E%2590%25E5%2590%258E%25E7%259A%2584%25E6%2597%25A5%25E6%259C%259F%25E6%25A0%25BC%25E5%25BC%258F%25E5%258C%2596%25E4%25B8%25BA%25E5%258F%25A6%25E4%25B8%2580%25E7%25A7%258D%25E5%25AD%2597%25E7%25AC%25A6%25E4%25B8%25B2%250A%2520%2520%2520%2520formatted_date%2520%253D%2520parsed_date.strftime%2528%2522%2525Y%252F%2525m%252F%2525d%2520%2525H%253A%2525M%253A%2525S%2522%2529%250A%2520%2520%2520%2520print%2528f%2522%25E6%25A0%25BC%25E5%25BC%258F%25E5%258C%2596%25E5%2590%258E%25E7%259A%2584%25E6%2597%25A5%25E6%259C%259F%25E5%25AD%2597%25E7%25AC%25A6%25E4%25B8%25B2%253A%2520%257Bformatted_date%257D%2522%2529%250Aelse%253A%250A%2520%2520%2520%2520print%2528%2522%25E6%2597%25A5%25E6%259C%259F%25E5%25AD%2597%25E7%25AC%25A6%25E4%25B8%25B2%25E8%25A7%25A3%25E6%259E%2590%25E5%25A4%25B1%25E8%25B4%25A5%25E3%2580%2582%2522%2529%250A" target="_blank" title="https://www.min2k.com/tools/python-run/?code=from%20dateutil%20import%20parser%0Afrom%20datetime%20import%20datetime%0A%0A%23%20%E4%B8%80%E4%B8%AA%E5%8C%85%E5%90%AB%E6%97%A5%E6%9C%9F%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2%0Adate_string%20%3D%20%22May%2025%2C%202023%20at%2010%3A30%20AM%22%0A%0A%23%20%E4%BD%BF%E7%94%A8dateutil.parser%E8%A7%A3%E6%9E%90%E5%AD%97%E7%AC%A6%E4%B8%B2%0Aparsed_date%20%3D%20parser.parse%28date_string%29%0A%0A%23%20%E6%A3%80%E6%9F%A5%E8%A7%A3%E6%9E%90%E6%98%AF%E5%90%A6%E6%88%90%E5%8A%9F%0Aif%20parsed_date%3A%0A%20%20%20%20print%28f%22%E5%8E%9F%E5%A7%8B%E6%97%A5%E6%9C%9F%E5%AD%97%E7%AC%A6%E4%B8%B2%3A%20%7Bdate_string%7D%22%29%0A%20%20%20%20print%28f%22%E8%A7%A3%E6%9E%90%E5%90%8E%E7%9A%84%E6%97%A5%E6%9C%9F%E5%AF%B9%E8%B1%A1%3A%20%7Bparsed_date%7D%22%29%0A%20%20%20%20%23%20%E5%B0%86%E8%A7%A3%E6%9E%90%E5%90%8E%E7%9A%84%E6%97%A5%E6%9C%9F%E6%A0%BC%E5%BC%8F%E5%8C%96%E4%B8%BA%E5%8F%A6%E4%B8%80%E7%A7%8D%E5%AD%97%E7%AC%A6%E4%B8%B2%0A%20%20%20%20formatted_date%20%3D%20parsed_date.strftime%28%22%25Y%2F%25m%2F%25d%20%25H%3A%25M%3A%25S%22%29%0A%20%20%20%20print%28f%22%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%90%8E%E7%9A%84%E6%97%A5%E6%9C%9F%E5%AD%97%E7%AC%A6%E4%B8%B2%3A%20%7Bformatted_date%7D%22%29%0Aelse%3A%0A%20%20%20%20print%28%22%E6%97%A5%E6%9C%9F%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%A7%A3%E6%9E%90%E5%A4%B1%E8%B4%A5%E3%80%82%22%29%0A" ref="nofollow noopener noreferrer">PythonRun</a> 在线运行这段代码，结果如下：</p>
<pre><code class="hljs language-text" lang="text">原始日期字符串: May 25, 2023 at 10:30 AM
解析后的日期对象: 2023-05-25 10:30:00
格式化后的日期字符串: 2023/05/25 10:30:00
</code></pre>
<p>使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.min2k.com%2Ftools%2Fmermaid%2F%3Fcode%3Dflowchart%2520TB%250A%2520%2520A%255B%25E5%25BC%2580%25E5%25A7%258B%255D%2520--%253E%2520B%257B%25E5%25AF%25BC%25E5%2585%25A5%25E6%25A8%25A1%25E5%259D%2597%257D%253B%250A%2520%2520B%2520--%253E%2520C%255B%25E5%25AE%259A%25E4%25B9%2589%25E6%2597%25A5%25E6%259C%259F%25E5%25AD%2597%25E7%25AC%25A6%25E4%25B8%25B2%255D%253B%250A%2520%2520C%2520--%253E%2520D%255B%25E4%25BD%25BF%25E7%2594%25A8parser.parse%25E8%25A7%25A3%25E6%259E%2590%25E5%25AD%2597%25E7%25AC%25A6%25E4%25B8%25B2%255D%253B%250A%2520%2520D%2520--%253E%2520E%257B%25E5%2588%25A4%25E6%2596%25AD%25E8%25A7%25A3%25E6%259E%2590%25E6%2598%25AF%25E5%2590%25A6%25E6%2588%2590%25E5%258A%259F%253F%257D%253B%250A%2520%2520E%2520--%2520%25E6%2598%25AF%2520--%253E%2520F%255B%25E6%2589%2593%25E5%258D%25B0%25E5%258E%259F%25E5%25A7%258B%25E5%25AD%2597%25E7%25AC%25A6%25E4%25B8%25B2%255D%253B%250A%2520%2520F%2520--%253E%2520G%255B%25E6%2589%2593%25E5%258D%25B0%25E8%25A7%25A3%25E6%259E%2590%25E5%2590%258E%25E5%25AF%25B9%25E8%25B1%25A1%255D%253B%250A%2520%2520G%2520--%253E%2520H%255B%25E6%25A0%25BC%25E5%25BC%258F%25E5%258C%2596%25E6%2597%25A5%25E6%259C%259F%255D%253B%250A%2520%2520H%2520--%253E%2520I%255B%25E6%2589%2593%25E5%258D%25B0%25E6%25A0%25BC%25E5%25BC%258F%25E5%258C%2596%25E5%25AD%2597%25E7%25AC%25A6%25E4%25B8%25B2%255D%253B%250A%2520%2520E%2520--%2520%25E5%2590%25A6%2520--%253E%2520J%255B%25E6%2589%2593%25E5%258D%25B0%25E8%25A7%25A3%25E6%259E%2590%25E5%25A4%25B1%25E8%25B4%25A5%25E4%25BF%25A1%25E6%2581%25AF%255D%253B%250A%2520%2520I%2520--%253E%2520K%255B%25E7%25BB%2593%25E6%259D%259F%255D%253B%250A%2520%2520J%2520--%253E%2520K%253B" target="_blank" title="https://www.min2k.com/tools/mermaid/?code=flowchart%20TB%0A%20%20A%5B%E5%BC%80%E5%A7%8B%5D%20--%3E%20B%7B%E5%AF%BC%E5%85%A5%E6%A8%A1%E5%9D%97%7D%3B%0A%20%20B%20--%3E%20C%5B%E5%AE%9A%E4%B9%89%E6%97%A5%E6%9C%9F%E5%AD%97%E7%AC%A6%E4%B8%B2%5D%3B%0A%20%20C%20--%3E%20D%5B%E4%BD%BF%E7%94%A8parser.parse%E8%A7%A3%E6%9E%90%E5%AD%97%E7%AC%A6%E4%B8%B2%5D%3B%0A%20%20D%20--%3E%20E%7B%E5%88%A4%E6%96%AD%E8%A7%A3%E6%9E%90%E6%98%AF%E5%90%A6%E6%88%90%E5%8A%9F%3F%7D%3B%0A%20%20E%20--%20%E6%98%AF%20--%3E%20F%5B%E6%89%93%E5%8D%B0%E5%8E%9F%E5%A7%8B%E5%AD%97%E7%AC%A6%E4%B8%B2%5D%3B%0A%20%20F%20--%3E%20G%5B%E6%89%93%E5%8D%B0%E8%A7%A3%E6%9E%90%E5%90%8E%E5%AF%B9%E8%B1%A1%5D%3B%0A%20%20G%20--%3E%20H%5B%E6%A0%BC%E5%BC%8F%E5%8C%96%E6%97%A5%E6%9C%9F%5D%3B%0A%20%20H%20--%3E%20I%5B%E6%89%93%E5%8D%B0%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%5D%3B%0A%20%20E%20--%20%E5%90%A6%20--%3E%20J%5B%E6%89%93%E5%8D%B0%E8%A7%A3%E6%9E%90%E5%A4%B1%E8%B4%A5%E4%BF%A1%E6%81%AF%5D%3B%0A%20%20I%20--%3E%20K%5B%E7%BB%93%E6%9D%9F%5D%3B%0A%20%20J%20--%3E%20K%3B" ref="nofollow noopener noreferrer">MermaidGo</a> 绘制示例代码的流程图，结果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f9663d5d3848435da54348365d50949e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWP57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770088165&amp;x-signature=JKwfigtlDVfTXVaUfB1zNgfDUpo%3D" alt="MermerGo的python-dateutil流程图" loading="lazy"/></p>
<h3 data-id="heading-5">五、学习资源</h3>
<ol>
<li>开源项目：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdateutil%2Fdateutil" target="_blank" title="https://github.com/dateutil/dateutil" ref="nofollow noopener noreferrer">dateutil</a></li>
<li>中文自述：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.python64.cn%2Freadme%2Fpython-dateutil%2F" target="_blank" title="https://www.python64.cn/readme/python-dateutil/" ref="nofollow noopener noreferrer">REMDME</a></li>
<li>在线运行：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.min2k.com%2Ftools%2Fpython-run%2F" target="_blank" title="https://www.min2k.com/tools/python-run/" ref="nofollow noopener noreferrer">PythonRun</a></li>
</ol>
<blockquote>
<p>如果这篇文章对你有帮助，欢迎点赞、收藏、转发！<br/>
学习过程中有任何问题，欢迎在评论区留言交流～</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[诊断、分割、解释三位一体：医学AI如何从“工具”进化成“助手”？]]></title>    <link>https://juejin.cn/post/7599652649550233600</link>    <guid>https://juejin.cn/post/7599652649550233600</guid>    <pubDate>2026-01-27T03:16:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599652649550233600" data-draft-id="7599598627007627316" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="诊断、分割、解释三位一体：医学AI如何从“工具”进化成“助手”？"/> <meta itemprop="keywords" content="算法,计算机视觉,深度学习"/> <meta itemprop="datePublished" content="2026-01-27T03:16:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CoovallyAIHub"/> <meta itemprop="url" content="https://juejin.cn/user/2461151071843739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            诊断、分割、解释三位一体：医学AI如何从“工具”进化成“助手”？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2461151071843739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CoovallyAIHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T03:16:50.000Z" title="Tue Jan 27 2026 03:16:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在医学影像的世界里，AI模型大多还停留在“工具”阶段：它们能精准勾画病灶轮廓，却无法告诉你这意味着什么；它们能回答疾病名称，却指不出病灶的具体位置。医生面对的，仍然是碎片化的信息。</p>
<p>一项来自澳门大学的研究，正试图打破这种割裂。Sim4Seg 的提出，标志着医学视觉语言模型开始从“工具”向“具备诊断推理能力的助手”演进。</p>
<h2 data-id="heading-0"><strong>临床的真正需求：分割、诊断与解释，缺一不可</strong></h2>
<p>想象一下这个场景：一位医生拿到一张胸片，AI不仅高亮了一片阴影区域（分割），还能同时给出诊断——“疑似肺炎”，并附上推理：“此处可见片状高密度影，边界模糊，符合社区获得性肺炎的典型影像学表现”。</p>
<p>这才是临床工作流中真正需要的辅助：定位、定性与解释，三位一体。</p>
<p>然而，现有技术是割裂的：</p>
<ul>
<li><strong>传统分割模型（如U-Net、SAM-Med2D）：</strong> 精于像素级勾勒，但“沉默不语”。</li>
<li><strong>医学视觉问答模型（VQA）：</strong> 能回答问题，但输出是纯文本，缺乏空间定位能力。</li>
</ul>
<p>Sim4Seg所定义的 <strong>Medical Diagnosis Segmentation（MDS）</strong>  任务，正是为了解决这一核心矛盾。它要求模型接收一张医学图像和一个诊断式查询，同时输出<strong>分割掩码</strong>与带有<strong>推理链（Chain-of-Thought）的诊断结论。</strong></p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f0321bda2075473d9d0895f4f303c9ab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770088613&amp;x-signature=JBRMs37XoP1NyqCBvpiB3SrFvX8%3D" alt="screenshot_2026-01-26_16-32-42.png" loading="lazy"/></p>
<h2 data-id="heading-1"><strong>数据奠基：M3DS数据集——为“会思考的分割”而生</strong></h2>
<p>好的模型需要好的数据。为了支持MDS这一新任务，研究团队构建了M3DS数据集，其独特价值在于<strong>首次大规模统一了分割标注与诊断推理链。</strong></p>
<ul>
<li><strong>数据亮点：</strong></li>
</ul>

<ul>
<li><strong>多模态与多疾病：</strong> 涵盖X光、超声、内镜、皮肤镜、眼底照相5种模态，包含骨折、息肉、结节、肿瘤等10类疾病。</li>
</ul>

<ul>
<li>
<p><strong>高质量诊断CoT生成：</strong> 采用创新的双角色自动化流水线生成诊断推理文本。</p>
<p>医学助手（HuatuoGPT-Vision）：按步骤分析图像，生成初步诊断与推理。</p>
<p>批判助手：严格审查推理的逻辑完整性、医学准确性和术语规范性。</p>
<p>最终通过人工复核确保可靠性。这套方法高效地解决了诊断文本标注成本极高的难题。</p>
</li>
</ul>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8325efd879084b99af6a0783125e4672~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770088613&amp;x-signature=KwnS9%2ByzEjS76iLVl627WjxXrlY%3D" alt="screenshot_2026-01-26_16-33-33.png" loading="lazy"/></p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94253ab2281245edba407f630d4d6c05~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770088613&amp;x-signature=9TjcetqE0M7lscr8h0wDKNEjaV4%3D" alt="screenshot_2026-01-26_16-33-54.png" loading="lazy"/></p>
<h2 data-id="heading-2"><strong>模型核心：RVLS2M——让语言理解“照亮”图像区域</strong></h2>
<p>Sim4Seg的核心创新是一个名为 <strong>RVLS2M（区域感知视觉-语言相似度掩码）</strong>  的模块。它的设计理念非常巧妙：<strong>利用模型内部对诊断文本的理解，反过来生成一个能指导分割的“区域提示图”。</strong></p>
<p><strong>它是如何工作的？</strong></p>
<ol>
<li>特征提取与对齐：大型视觉语言模型（LVLM）在处理图像和诊断查询时，会输出图像特征和代表分割目标的特殊文本标记特征。</li>
<li>计算相似度图：RVLS2M计算每个图像区域特征与分割目标文本特征之间的余弦相似度，得到一张“热度图”——越亮的地方，表示该区域与文本描述的目标越相关。</li>
<li>生成区域提示：将相似度图网格化、池化，并通过自适应阈值二值化，最终得到一个粗糙的、区域级的提示掩码。</li>
<li>引导精细分割：这个提示掩码作为空间先验知识，输入到像SAM这样的强大分割器中进行细化，得到最终精准的像素级分割结果。</li>
</ol>
<p>简单说，RVLS2M让模型用“语言脑”思考后，告诉“视觉手”应该重点关注图像的哪些地方。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9cfdfb8f641d469fb105756068ab0ce2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770088613&amp;x-signature=RCoILYPeu3TRJVanQ5HCKzUebOI%3D" alt="screenshot_2026-01-26_16-34-15.png" loading="lazy"/></p>
<h2 data-id="heading-3"><strong>性能跃升：不仅更准，而且更“像医生”</strong></h2>
<p>在M3DS数据集上的综合实验表明，Sim4Seg实现了分割与诊断能力的双重飞跃：</p>
<ul>
<li><strong>分割性能显著提升：</strong> 相比强大的基线模型LISA，Sim4Seg在分割交并比（gIoU）指标上提升超过57%。</li>
<li><strong>诊断准确率大幅提高：</strong> 在诊断准确率（Acc）上，Sim4Seg结合推理链数据后，比基线提升超过165%。</li>
<li><strong>即插即用的有效性：</strong> RVLS2M模块甚至可以在不进行额外训练的情况下，直接提升现有模型（如LISA）的分割性能（零样本下提升11.6%），证明了其强大的通用性。</li>
</ul>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df22a1cc348a4e21aa791e26969c569f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770088613&amp;x-signature=MLC9Ygoug2msL7X41ERIGSHGbeo%3D" alt="screenshot_2026-01-26_16-35-31.png" loading="lazy"/></p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/81abcd3aba41468f85d15c62f2224222~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770088613&amp;x-signature=N5DSq%2BHqtA9V34M16FiMZRK6Yms%3D" alt="screenshot_2026-01-26_16-35-41.png" loading="lazy"/></p>
<h2 data-id="heading-4"><strong>两大“助攻”策略：让模型“多想多试”</strong></h2>
<p>除了核心模块，论文中两个策略也值得关注：</p>
<ol>
<li><strong>测试时缩放（TTS）：</strong> 在推理阶段，让模型生成多条不同的诊断推理路径，每条路径都可能诱导出略有差异的分割提示，进而产生多个候选分割结果。最后通过指标选择最优的一个。这模拟了医生的多角度思考过程。</li>
<li><strong>最优粒度选择（τ策略）：</strong> 研究发现，区域提示的“粗细”很有讲究。提示太粗糙（网格太大）会导致定位模糊；提示太精细（网格太小）又会引入噪声。实验找到了一个最佳平衡点（如16×16网格）。</li>
</ol>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/16cedd17b24b40e99264f50952c6c15a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770088613&amp;x-signature=tFYbqgMRX1ZNKICqT6u1iaRPf7k%3D" alt="screenshot_2026-01-26_16-36-06.png" loading="lazy"/></p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b69bfb376fa4a078a4156003e78b692~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770088613&amp;x-signature=87RsgtkHKwBVBEdTA7uO%2BetNz%2F0%3D" alt="screenshot_2026-01-26_16-36-21.png" loading="lazy"/></p>
<h2 data-id="heading-5"><strong>案例见证：看模型如何“一步步思考”</strong></h2>
<p>论文展示了多个跨模态的真实案例。例如，面对一张眼底照片，Sim4Seg不仅能精确分割出黄斑区病变的血管，还能生成如下诊断推理链：</p>
<p>“这是一张眼底彩照。首先，图像中央可见黄斑区...其次，观察到局部有片状出血和渗出...结合患者可能的年龄因素，这些表现符合湿性年龄相关性黄斑变性的诊断。”</p>
<p>这种输出，让模型的决策过程变得<strong>透明、可信、可审查</strong>，极大地增强了临床医生的信任感。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/acdcae6779c54791a69c8789b6f2d16b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770088613&amp;x-signature=ISPBlFYMmvlRp8xSIMSQ11Cvgyo%3D" alt="screenshot_2026-01-26_16-36-54.png" loading="lazy"/></p>
<h2 data-id="heading-6"><strong>结语：范式转变的开始</strong></h2>
<p>Sim4Seg的意义远不止于一项技术改进。它代表了一条明确的演进路径：医学AI正从执行单一任务的“专用工具”，成长为能够协同完成感知、推理与解释的临床助手。</p>
<p>通过提出MDS任务、构建M3DS数据集，以及创新性地利用视觉-语言相似性来桥接分割与诊断，这项工作为未来真正“懂医学、会思考”的AI奠定了关键的基础。当模型既能“指出来”，又能“说出来”，还能“解释清楚”时，我们距离AI成为医生的得力伙伴，便又近了一步。</p>
<blockquote>
<p>代码地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSLR567%2FSim4Seg" target="_blank" title="https://github.com/SLR567/Sim4Seg" ref="nofollow noopener noreferrer">github.com/SLR567/Sim4…</a></p>
<p>数据集地址： <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSLR567%2FM3DS" target="_blank" title="https://github.com/SLR567/M3DS" ref="nofollow noopener noreferrer">github.com/SLR567/M3DS</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在 Java 中实现 Word 和 TXT 之间的互相转换：实用教程]]></title>    <link>https://juejin.cn/post/7599530824426749962</link>    <guid>https://juejin.cn/post/7599530824426749962</guid>    <pubDate>2026-01-27T01:37:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599530824426749962" data-draft-id="7599538010726039579" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在 Java 中实现 Word 和 TXT 之间的互相转换：实用教程"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2026-01-27T01:37:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户033212666367"/> <meta itemprop="url" content="https://juejin.cn/user/230252528804124"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在 Java 中实现 Word 和 TXT 之间的互相转换：实用教程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/230252528804124/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户033212666367
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T01:37:34.000Z" title="Tue Jan 27 2026 01:37:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在日常的软件开发和办公自动化场景中，文档格式转换是一个普遍且重要的需求。无论是从结构化的 Word 文档中提取纯文本信息，还是将纯文本内容格式化为可编辑的 Word 文档，高效、准确地实现这两种格式的互相转换，是许多开发者面临的痛点。本文将深入探讨如何在 Java 环境下，借助一个功能强大的库，轻松解决 Word 和 TXT 之间的转换难题，提升您的开发效率。</p>
<hr/>
<h2 data-id="heading-0">Spire.Doc for Java：Word 与 TXT 转换的利器</h2>
<p>在 Java 生态中，处理 Word 文档的库并不少见，但 Spire.Doc for Java 凭借其强大的功能和易用性脱颖而出。它是一个专业的 Word 文档处理组件，支持创建、读写、编辑、转换和打印 Word 文档，并且兼容多种 Word 版本。其中，对 Word 和 TXT 格式的互相转换提供了非常便捷的 API。</p>
<h3 data-id="heading-1">引入 Spire.Doc for Java</h3>
<p>要开始使用 Spire.Doc，您需要将其作为依赖添加到您的 Maven 项目中。</p>
<p><strong>Maven 配置示例：</strong></p>
<pre><code class="hljs language-xml" lang="xml">  <span class="hljs-tag">&lt;<span class="hljs-name">repositories</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">repository</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>com.e-iceblue<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>e-iceblue<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>https://repo.e-iceblue.cn/repository/maven-public/<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">repository</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">repositories</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>e-iceblue<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spire.doc<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>14.1.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<p>请确保您使用的版本是最新的稳定版本，以获取最佳的兼容性和功能。</p>
<hr/>
<h2 data-id="heading-2">从 Word 到 TXT：逐步实现文档内容提取</h2>
<p>将 Word 文档转换为纯文本（TXT）是一个常见的需求，例如用于内容提取、文本分析或跨平台传输。Spire.Doc for Java 提供了一行代码即可完成此操作。</p>
<h3 data-id="heading-3">实现步骤：</h3>
<ol>
<li><strong>加载 Word 文档：</strong> 使用 <code>Document</code> 类的 <code>loadFromFile()</code> 方法加载目标 Word 文档。</li>
<li><strong>保存为 TXT 格式：</strong> 调用 <code>saveToFile()</code> 方法，并指定输出路径和 <code>FileFormat.Txt</code> 格式。</li>
<li><strong>释放资源：</strong> 调用 <code>dispose()</code> 方法释放文档对象占用的资源。</li>
</ol>
<h3 data-id="heading-4">Java 代码示例：</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> com.<span class="hljs-property">spire</span>.<span class="hljs-property">doc</span>.<span class="hljs-property">Document</span>;
<span class="hljs-keyword">import</span> com.<span class="hljs-property">spire</span>.<span class="hljs-property">doc</span>.<span class="hljs-property">FileFormat</span>;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConvertWordtoText</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {

        <span class="hljs-comment">// 创建 Document 对象</span>
        <span class="hljs-title class_">Document</span> doc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Document</span>();

        <span class="hljs-comment">// 加载 Word 文件</span>
        doc.<span class="hljs-title function_">loadFromFile</span>(<span class="hljs-string">"示例.docx"</span>);

        <span class="hljs-comment">// 将文档保存为 TXT 格</span>
        doc.<span class="hljs-title function_">saveToFile</span>(<span class="hljs-string">"Word转文本.txt"</span>, <span class="hljs-title class_">FileFormat</span>.<span class="hljs-property">Txt</span>);

        <span class="hljs-comment">// 释放资源</span>
        doc.<span class="hljs-title function_">dispose</span>();
    }
}
</code></pre>
<p><strong>代码解析：</strong></p>
<ul>
<li><code>document.loadFromFile(inputWordPath)</code>: 负责读取指定路径的 Word 文档内容。</li>
<li><code>document.saveToFile(outputTxtPath, FileFormat.Txt)</code>: 这是转换的核心。它将加载的 Word 文档内容以纯文本格式写入到 <code>outputTxtPath</code> 指定的文件中。<code>FileFormat.Txt</code> 枚举值明确指示了目标格式。</li>
<li><code>document.dispose()</code>: 释放资源，用于关闭文件流并释放内存，特别是在处理大量文档时。</li>
</ul>
<hr/>
<h2 data-id="heading-5">从 TXT 到 Word：构建富文本格式文档</h2>
<p>将纯文本（TXT）文件转换为 Word 文档，通常是为了对其进行格式化、添加图片、表格或其他富文本元素。Spire.Doc 同样能轻松实现这一目标。</p>
<h3 data-id="heading-6">实现步骤：</h3>
<ol>
<li><strong>创建或加载 Word 文档：</strong> 对于从 TXT 创建新的 Word 文档，直接创建 <code>Document</code> 对象即可。</li>
<li><strong>加载 TXT 内容：</strong> 使用 <code>Document</code> 类的 <code>loadFromFile()</code> 方法加载 TXT 文件。</li>
<li><strong>保存为 Word 格式：</strong> 调用 <code>saveToFile()</code> 方法，并指定输出路径和 <code>FileFormat.Docx</code>（或 <code>FileFormat.Doc</code>）格式。</li>
<li><strong>释放资源：</strong> 调用 <code>dispose()</code> 方法释放文档对象占用的资源。</li>
</ol>
<h3 data-id="heading-7">Java 代码示例：</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> com.<span class="hljs-property">spire</span>.<span class="hljs-property">doc</span>.<span class="hljs-property">Document</span>;
<span class="hljs-keyword">import</span> com.<span class="hljs-property">spire</span>.<span class="hljs-property">doc</span>.<span class="hljs-property">FileFormat</span>;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConvertTextToWord</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {

        <span class="hljs-comment">// 创建 Document 对象</span>
        <span class="hljs-title class_">Document</span> txt = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Document</span>();

        <span class="hljs-comment">// 加载 .txt 文本文件</span>
        txt.<span class="hljs-title function_">loadFromFile</span>(<span class="hljs-string">"介绍.txt"</span>);

        <span class="hljs-comment">// 将文件保存为 Word 格式</span>
        txt.<span class="hljs-title function_">saveToFile</span>(<span class="hljs-string">"TXT转Word.docx"</span>, <span class="hljs-title class_">FileFormat</span>.<span class="hljs-property">Docx</span>);

        <span class="hljs-comment">// 释放资源</span>
        txt.<span class="hljs-title function_">dispose</span>();
    }
}
</code></pre>
<p><strong>代码解析：</strong></p>
<ul>
<li><code>document.loadFromFile(inputTxtPath)</code>: 这里巧妙地利用了 <code>spire.doc for java</code> 的 <code>loadFromFile</code> 方法不仅可以加载 Word 文档，还能加载 TXT 文件并将其内容导入到 <code>Document</code> 对象中。</li>
<li><code>document.saveToFile(outputWordPath, FileFormat.Docx)</code>: 将包含 TXT 内容的 <code>Document</code> 对象保存为 Word 格式。<code>FileFormat.Docx</code> 是现代 Word 文档的默认格式，您也可以选择 <code>FileFormat.Doc</code>。</li>
</ul>
<p><strong>格式调整建议：</strong></p>
<p>将 TXT 转换为 Word 后，默认情况下可能只是简单的文本导入。如果需要更复杂的格式，例如设置字体、段落样式、页眉页脚等，Spire.Doc 也提供了丰富的 API 来实现这些功能，您可以在 <code>loadFromFile</code> 之后、<code>saveToFile</code> 之前，对 <code>document</code> 对象进行进一步的编辑操作。</p>
<hr/>
<h2 data-id="heading-8">结语</h2>
<p>通过本文的详细介绍和代码示例，相信您已经掌握了在 Java 中使用 Spire.Doc for Java 库实现 Word 和 TXT 文档互相转换的关键技术。该库以其简洁的 API 和强大的功能，为 Java 开发者提供了一个高效、可靠的文档处理解决方案。无论是日常的数据处理，还是复杂的办公自动化系统，Spire.Doc 都能助您一臂之力。鼓励您在实际项目中尝试应用这些技术，并进一步探索该库在 Word 文档处理方面的更多高级功能，例如文档合并、拆分、内容替换、表格操作等，以满足更复杂的业务需求。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[godot-rust（gdext）创建项目]]></title>    <link>https://juejin.cn/post/7599566082212986932</link>    <guid>https://juejin.cn/post/7599566082212986932</guid>    <pubDate>2026-01-27T02:05:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599566082212986932" data-draft-id="7598333055544672296" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="godot-rust（gdext）创建项目"/> <meta itemprop="keywords" content="游戏"/> <meta itemprop="datePublished" content="2026-01-27T02:05:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="柚要做甚码"/> <meta itemprop="url" content="https://juejin.cn/user/2200546203156138"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            godot-rust（gdext）创建项目
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2200546203156138/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    柚要做甚码
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T02:05:10.000Z" title="Tue Jan 27 2026 02:05:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">简介</h2>
<p>本文以<a href="https://link.juejin.cn?target=https%3A%2F%2Fcolinwttt.github.io%2Fgodot-rust-book-chinese%2Fintro%2Fhello-world.html" target="_blank" title="https://colinwttt.github.io/godot-rust-book-chinese/intro/hello-world.html" ref="nofollow noopener noreferrer">Hello World - godot-rust中文文档</a>内容为蓝本撰写。如果你对rust、godot等内容比较生疏或感到疑惑，可以先阅读<a href="https://link.juejin.cn?target=https%3A%2F%2Fcolinwttt.github.io%2Fgodot-rust-book-chinese%2Fintro%2Findex.html" target="_blank" title="https://colinwttt.github.io/godot-rust-book-chinese/intro/index.html" ref="nofollow noopener noreferrer">godot-rust入门文档</a>。本文操作均在Windows上执行。</p>
<h2 data-id="heading-1">正文</h2>
<h3 data-id="heading-2">新建游戏项目</h3>
<p>在你喜欢的任意一个路径位置新建项目文件夹，为游戏起一个名字：\ <img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21cbe0a78bc14e15b2c7f725bd6cda25~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p-a6KaB5YGa55Sa56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084838&amp;x-signature=GqVyYyU%2Bvn9Y9wlrvmzOdUPzOPA%3D" alt="无标题.jpg" width="30%" loading="lazy"/><br/>
本文使用“dodge-the-creeps-2d”。</p>
<h3 data-id="heading-3">新建godot项目</h3>
<p>使用godot-rust，godot需要<strong>4.1</strong>或者<strong>更高</strong>版本，你可以在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgodotengine.org%2Fzh-cn%2F" target="_blank" title="https://godotengine.org/zh-cn/" ref="nofollow noopener noreferrer">godot</a>的官网上找到需要的资源。本文使用的godot的版本为4.5.1，下载后为<code>.zip</code>压缩文件，解压可直接运行无需安装。<br/>
启动godot，在启动入口点击<strong>创建</strong>：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/43ed4ff268854bea9ced74472ba86cad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p-a6KaB5YGa55Sa56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084838&amp;x-signature=6xisSpwJ8i05Z9%2BeIayHVADIWWw%3D" alt="新建godot项目1.jpg" loading="lazy"/><br/>
在<strong>新建项目</strong>窗口中，将<strong>项目路径</strong>选择到你刚刚创建好的游戏项目文件夹下，并填写项目名称。本文使用“godot”：<br/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b875842c56548fa8f818fbc31c3d011~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p-a6KaB5YGa55Sa56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084838&amp;x-signature=aQJSNjRz7sRs3%2FkTYaZHvoXZU1c%3D" alt="新建godot项目2.jpg" loading="lazy"/><br/>
其他配置不变，<strong>创建</strong>项目。操作完成后你的游戏项目结构看上去应该像这样：</p>
<pre><code class="hljs">📂 dodge-the-creeps-2d
│ 
├—— 📂 godot
</code></pre>
<h3 data-id="heading-4">新建rust项目</h3>
<p>使用cargo来创建rust项目，在命令行中定位到你的游戏项目文件下，本文中即为“dodge-the-creeps-2d”文件夹，使用<code>cargo new</code>命令创建，现在先别急着按回车。</p>
<pre><code class="hljs language-sql" lang="sql">cargo <span class="hljs-keyword">new</span> {YourCrate} <span class="hljs-comment">--lib</span>
</code></pre>
<p>为你的rust项目起一个名字，替换掉上述代码里的“{YourCrate}”，本文使用“rust”。<br/>
按下回车确认执行创建，此时你的游戏项目结构看上去应该像这样：</p>
<pre><code class="hljs">📂 dodge-the-creeps-2d
│
├—— 📂 godot
│
├—— 📂 rust
</code></pre>
<p>打开Cargo.toml文件进行补充：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[package]</span>
<span class="hljs-attr">name</span> = <span class="hljs-string">"rust"</span>
<span class="hljs-attr">version</span> = <span class="hljs-string">"0.1.0"</span>
<span class="hljs-attr">edition</span> = <span class="hljs-string">"2024"</span>

<span class="hljs-section">[lib]</span>
<span class="hljs-attr">crate-type</span> = [<span class="hljs-string">"cdylib"</span>] <span class="hljs-comment"># 将此crate编译为动态C库 （dynamic C library）.</span>
</code></pre>
<p>在命令行中定位到rust项目文件下，执行<code>cargo add</code>命令将gdext添加到项目中：</p>
<pre><code class="hljs language-csharp" lang="csharp">cargo <span class="hljs-keyword">add</span> godot
</code></pre>
<h3 data-id="heading-5">连接godot和rust</h3>
<p>在godot项目文件夹下新建文件，并修改成<code>.gdextension</code>后缀，本文使用<code>rust.gdextension</code>为文件名，此时你的项目文件结构看上去应该像这样：</p>
<pre><code class="hljs">📂 dodge-the-creeps-2d
│
├—— 📂 godot
│   ├——📄 rust.gdextension
│
├—— 📂 rust
</code></pre>
<blockquote>
<p><code>.gdextension</code>文件告诉 Godot 如何加载您的编译后的 Rust 扩展，它包含动态库的路径以及初始化它的入口点（函数）。</p>
</blockquote>
<p><code>.gdextension</code>文件内容完整的填写方式如下：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[configuration]</span>
<span class="hljs-attr">entry_symbol</span> = <span class="hljs-string">"gdext_rust_init"</span>
<span class="hljs-attr">compatibility_minimum</span> = <span class="hljs-number">4.1</span>
<span class="hljs-attr">reloadable</span> = <span class="hljs-literal">true</span>

<span class="hljs-section">[libraries]</span>
<span class="hljs-attr">linux.debug.x86_64</span> =     <span class="hljs-string">"res://../rust/target/debug/lib{YourCrate}.so"</span>
<span class="hljs-attr">linux.release.x86_64</span> =   <span class="hljs-string">"res://../rust/target/release/lib{YourCrate}.so"</span>
<span class="hljs-attr">windows.debug.x86_64</span> =   <span class="hljs-string">"res://../rust/target/debug/{YourCrate}.dll"</span>
<span class="hljs-attr">windows.release.x86_64</span> = <span class="hljs-string">"res://../rust/target/release/{YourCrate}.dll"</span>
<span class="hljs-attr">macos.debug</span> =            <span class="hljs-string">"res://../rust/target/debug/lib{YourCrate}.dylib"</span>
<span class="hljs-attr">macos.release</span> =          <span class="hljs-string">"res://../rust/target/release/lib{YourCrate}.dylib"</span>
<span class="hljs-attr">macos.debug.arm64</span> =      <span class="hljs-string">"res://../rust/target/debug/lib{YourCrate}.dylib"</span>
<span class="hljs-attr">macos.release.arm64</span> =    <span class="hljs-string">"res://../rust/target/release/lib{YourCrate}.dylib"</span>
</code></pre>
<p><strong>注意，根据你使用的操作系统来使用对应的配置</strong><br/>
本文在windows上实现，因此只保留windows对应配置。<br/>
替换配置中的“{YourCrate}”为“rust”后（<strong>即你的rust项目名称</strong>），本文的<code>rust.gdextension</code>内容如下所示。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[configuration]</span>
<span class="hljs-attr">entry_symbol</span> = <span class="hljs-string">"gdext_rust_init"</span>
<span class="hljs-attr">compatibility_minimum</span> = <span class="hljs-number">4.1</span>
<span class="hljs-attr">reloadable</span> = <span class="hljs-literal">true</span>

<span class="hljs-section">[libraries]</span>
<span class="hljs-attr">windows.debug.x86_64</span> =   <span class="hljs-string">"res://../rust/target/debug/rust.dll"</span>
<span class="hljs-attr">windows.release.x86_64</span> = <span class="hljs-string">"res://../rust/target/release/rust.dll"</span>
</code></pre>
<p>这里直接列出原文档的配置详细说明供研究参考，进一步的内容请参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fcolinwttt.github.io%2Fgodot-rust-book-chinese%2Fintro%2Fhello-world.html" target="_blank" title="https://colinwttt.github.io/godot-rust-book-chinese/intro/hello-world.html" ref="nofollow noopener noreferrer">教程原文</a>。</p>
<blockquote>
<p><code>[configuration]</code>部分应照原样复制</p>
<ul>
<li><code>entry_symbol</code>是指gdext暴露的入口点函数。我们选择<code>"gdext_rust_init"</code>，这是<strong>gdext</strong>的默认值（但如果需要，可以配置）。</li>
<li><code>compatibility_minimum</code>指定了扩展所需的最低 <strong>Godot</strong> 版本。使用低于该版本的<strong>Godot</strong>打开项目将导致扩展无法运行。
<ul>
<li>如果您要构建一个供他人使用的插件，请尽量将此版本设置得尽可能低，以实现更广泛的生态系统兼容性，但这可能会限制您使用的功能。</li>
</ul>
</li>
<li><code>reloadable</code>指定当编辑器窗口失去焦点后再恢复时，应重新加载扩展。有关更多详情，请参阅 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgodotengine%2Fgodot%2Fpull%2F80284" target="_blank" title="https://github.com/godotengine/godot/pull/80284" ref="nofollow noopener noreferrer">Godot issue #80284</a>。
<ul>
<li>如果 Godot 崩溃，您可能需要尝试关闭或移除此设置。</li>
</ul>
</li>
</ul>
</blockquote>
<blockquote>
<p><code>[libraries]</code> 部分应根据您的动态 Rust 库的路径进行更新。</p>
<ul>
<li>左侧的键是<strong>Godot</strong>项目的构建目标平台。
<ul>
<li>请参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.godotengine.org%2Fen%2Fstable%2Ftutorials%2Fscripting%2Fgdextension%2Fgdextension_cpp_example.html%23using-the-gdextension-module" target="_blank" title="https://docs.godotengine.org/en/stable/tutorials/scripting/gdextension/gdextension_cpp_example.html#using-the-gdextension-module" ref="nofollow noopener noreferrer">GDExtension 文档</a>以了解更多可能的值</li>
</ul>
</li>
<li>右侧的值是你的动态库的文件路径。
<ul>
<li><code>res://</code> 前缀表示文件路径是相对于<strong>Godot</strong>目录的，无论您的<code>.gdextension</code>文件位于何处。您可以在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.godotengine.org%2Fen%2Fstable%2Ftutorials%2Fscripting%2Fresources.html%23external-vs-built-in" target="_blank" title="https://docs.godotengine.org/en/stable/tutorials/scripting/resources.html#external-vs-built-in" ref="nofollow noopener noreferrer">Godot 资源路径</a> 中了解更多。</li>
<li>如果您记得文件结构，<code>godot项目文件夹</code>和<code>rust项目文件夹</code>是兄弟关系，因此我们需要回到上一级目录才能访问 <code>rust</code>。</li>
</ul>
</li>
<li>如果您计划将项目导出到其他平台，您可以为多个平台添加配置。 至少，您需要为当前操作系统的<code>debug</code>模式配置路径。</li>
</ul>
</blockquote>
<p>通常godot会自动配置gdext，你无需手动编写，但总有例外：</p>
<blockquote>
<p>在您第一次打开 Godot 编辑器时，会自动生成一个名为<code>res://.godot/extension_list.cfg</code>的文件。 此文件列出了项目中注册的所有扩展。如果该文件不存在，您也可以手动创建它，仅包含到你的<code>.gdextension</code> 文件的 Godot 路径：<code>res://{YourCrate}.gdextension</code></p>
</blockquote>
<p>本文中<code>res://.godot/extension_list.cfg</code>的文件内容为：</p>
<pre><code class="hljs language-arduino" lang="arduino">res:<span class="hljs-comment">//rust.gdextension</span>
</code></pre>
<h3 data-id="heading-6">编写rust入口</h3>
<p>到目前为止你已经成功地将godot-rust搭建了起来，但你会观察到在godot编辑器<strong>输出</strong>中提示有和<code>.gdextension</code>有关的错误：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b904c2481a564f5e9b5f3aa2e15877f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p-a6KaB5YGa55Sa56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084838&amp;x-signature=Oi9iqNI7vdNNKuImHTob%2FOnJS30%3D" alt=".gdextension错误" loading="lazy"/>
回忆之前<code>rust.gdextension</code>配置内容：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">windows.debug.x86_64</span> =   <span class="hljs-string">"res://../rust/target/debug/rust.dll"</span>
<span class="hljs-attr">windows.release.x86_64</span> = <span class="hljs-string">"res://../rust/target/release/rust.dll"</span>
</code></pre>
<p>此时项目还没有对rust进行编译，因此rust.dll根本不存在。编译rust之前，我们需要把<code>lib.rs</code>文件内容替换成以下模板:</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> godot::prelude::*;

<span class="hljs-keyword">struct</span> {YourRustEntryName};

<span class="hljs-meta">#[gdextension]</span>
<span class="hljs-keyword">unsafe</span> <span class="hljs-keyword">impl</span> <span class="hljs-title class_">ExtensionLibrary</span> <span class="hljs-keyword">for</span> {YourRustEntryName} {}
</code></pre>
<p>为你的rust入口起个名字替换掉“{YourRustEntryName}”，本文使用“DodgeTheCreeps2d”，与游戏项目名称保持一致，因此本文的<code>lib.rs</code>文件内容为:</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> godot::prelude::*;

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">DodgeTheCreeps2d</span>;

<span class="hljs-meta">#[gdextension]</span>
<span class="hljs-keyword">unsafe</span> <span class="hljs-keyword">impl</span> <span class="hljs-title class_">ExtensionLibrary</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">DodgeTheCreeps2d</span> {}
</code></pre>
<p>下面是原文档的说明：</p>
<blockquote>
<p>这里有几个要点：</p>
<ul>
<li>将<a href="https://link.juejin.cn?target=https%3A%2F%2Fgodot-rust.github.io%2Fdocs%2Fgdext%2Fmaster%2Fgodot%2Fprelude%2Findex.html" target="_blank" title="https://godot-rust.github.io/docs/gdext/master/godot/prelude/index.html" ref="nofollow noopener noreferrer"><code>prelude</code></a>模块从<a href="https://link.juejin.cn?target=https%3A%2F%2Fgodot-rust.github.io%2Fdocs%2Fgdext%2Fmaster%2Fgodot%2Findex.html" target="_blank" title="https://godot-rust.github.io/docs/gdext/master/godot/index.html" ref="nofollow noopener noreferrer"><code>godot</code></a> crate引入作用域。该模块包含了 gdext API 中最常用的符号。</li>
<li>定义一个名为 <code>MyExtension</code> 的结构体。它只是一个类型标记，没有数据或方法，您可以根据需要命名它。</li>
<li>为该类型实现 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgodot-rust.github.io%2Fdocs%2Fgdext%2Fmaster%2Fgodot%2Fprelude%2Ftrait.ExtensionLibrary.html" target="_blank" title="https://godot-rust.github.io/docs/gdext/master/godot/prelude/trait.ExtensionLibrary.html" ref="nofollow noopener noreferrer"><code>ExtensionLibrary</code></a> trait，并用 <code>#[gdextension]</code> 属性标记。</li>
</ul>
<p>最后这一点声明了实际的 GDExtension 入口点，proc-macro 属性会处理底层的细节。</p>
</blockquote>
<p>保存<code>lib.rs</code>，执行<code>cargo build</code></p>
<pre><code class="hljs">cargo build
</code></pre>
<p>godot 4.5 版本会热重载rust.dll的内容，此时godot编辑器内依然会看到异常提示，但此时gdext的入口已经完成加载：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/493b2f5608ff4232ade68736fa3ea716~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p-a6KaB5YGa55Sa56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084838&amp;x-signature=m91tOobB8rUcqIxFEarjvEX5rfs%3D" alt="godot编辑器提示" loading="lazy"/></p>
<h2 data-id="heading-7">参考</h2>
<ol>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcolinwttt.github.io%2Fgodot-rust-book-chinese%2Fintro%2Fhello-world.html" target="_blank" title="https://colinwttt.github.io/godot-rust-book-chinese/intro/hello-world.html" ref="nofollow noopener noreferrer">Hello World - godot-rust中文文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.godotengine.org%2Fzh-cn%2F4.5%2Fgetting_started%2Fstep_by_step%2Findex.html" target="_blank" title="https://docs.godotengine.org/zh-cn/4.5/getting_started/step_by_step/index.html" ref="nofollow noopener noreferrer">渐进式教程 — Godot Engine (4.5) 简体中文文档</a></li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MindSpore实战经验：从入门到高效开发的技巧分享]]></title>    <link>https://juejin.cn/post/7599600549764792355</link>    <guid>https://juejin.cn/post/7599600549764792355</guid>    <pubDate>2026-01-27T03:15:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599600549764792355" data-draft-id="7599690133117501474" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MindSpore实战经验：从入门到高效开发的技巧分享"/> <meta itemprop="keywords" content="后端,算法"/> <meta itemprop="datePublished" content="2026-01-27T03:15:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户867573478982"/> <meta itemprop="url" content="https://juejin.cn/user/924064924829272"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MindSpore实战经验：从入门到高效开发的技巧分享
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/924064924829272/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户867573478982
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T03:15:51.000Z" title="Tue Jan 27 2026 03:15:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​华为昇腾AI处理器与MindSpore框架的结合为深度学习开发者提供了强大的工具链。本文将分享我在实际项目中的经验，重点介绍如何充分发挥这一技术栈的优势。</p>
<h3 data-id="heading-0">1. 环境配置与基础设置</h3>
<p>环境配置是项目成功的基础。MindSpore与昇腾硬件的协同工作需要精确的环境调优。</p>
<p>关键配置点：</p>
<ul>
<li>
<p>使用MindSpore 1.8+版本以获得对Ascend 910的完整支持</p>
</li>
<li>
<p>设置静态图模式（GRAPH_MODE）以获得最佳性能</p>
</li>
<li>
<p>合理配置设备ID，特别是在多卡环境中</p>
<p>import mindspore as ms
from mindspore import context</p>
<h2 data-id="heading-1">基础配置示例</h2>
<p>context.set_context(mode=context.GRAPH_MODE, device_target="Ascend")
context.set_context(device_id=0)  # 单卡环境
context.set_context(enable_auto_mixed_precision=True)  # 开启自动混合精度</p>
</li>
</ul>
<p><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/></p>
<p>静态图模式虽限制了灵活性，但通过图编译优化能大幅提升性能，尤其适合生产环境。我在实际项目中观察到，相比动态图模式，静态图在复杂模型上能有40%以上的性能提升。</p>
<h3 data-id="heading-2">2. 数据管道优化实战</h3>
<p>数据预处理往往是训练过程的瓶颈。合理的数据管道设计对提升整体效率至关重要。</p>
<h4 data-id="heading-3">2.1 高效数据加载</h4>
<p>MindSpore的<code>dataset</code>模块提供了丰富的数据处理功能。关键在于合理配置数据操作的顺序和参数：</p>
<pre><code class="hljs language-ini" lang="ini">import mindspore.dataset as ds
import mindspore.dataset.vision as vision
import mindspore.dataset.transforms as transforms

def create_efficient_dataset(data_path, <span class="hljs-attr">batch_size</span>=<span class="hljs-number">128</span>):
    <span class="hljs-attr">data_set</span> = ds.Cifar10Dataset(data_path)
    
    <span class="hljs-comment"># 定义数据增强操作</span>
    <span class="hljs-attr">resize_op</span> = vision.Resize((<span class="hljs-number">224</span>, <span class="hljs-number">224</span>))
    <span class="hljs-attr">normalize_op</span> = vision.Normalize([<span class="hljs-number">0.4914</span>, <span class="hljs-number">0.4822</span>, <span class="hljs-number">0.4465</span>], [<span class="hljs-number">0.2023</span>, <span class="hljs-number">0.1994</span>, <span class="hljs-number">0.2010</span>])
    
    <span class="hljs-comment"># 操作顺序很重要：先调整大小，再标准化</span>
    <span class="hljs-attr">data_set</span> = data_set.map(operations=[resize_op, normalize_op], input_columns=<span class="hljs-string">"image"</span>)
    <span class="hljs-attr">data_set</span> = data_set.batch(batch_size, drop_remainder=<span class="hljs-literal">True</span>)  <span class="hljs-comment"># 保证固定shape</span>
    <span class="hljs-attr">data_set</span> = data_set.shuffle(buffer_size=<span class="hljs-number">1000</span>)  <span class="hljs-comment"># 适当大小的缓冲池</span>
    
    return data_set
</code></pre>
<p><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/></p>
<h4 data-id="heading-4">2.2 数据下沉（Data Sinking）模式</h4>
<p>这是MindSpore在昇腾平台上的独特优势。通过将数据预处理工作流下沉到设备侧，大幅减少Host-Device交互开销。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 开启数据下沉模式</span>
model.train(<span class="hljs-attr">epoch</span>=<span class="hljs-number">10</span>, 
            <span class="hljs-attr">train_dataset</span>=train_ds,
            <span class="hljs-attr">callbacks</span>=[LossMonitor(), TimeMonitor()],
            <span class="hljs-attr">dataset_sink_mode</span>=<span class="hljs-literal">True</span>)  <span class="hljs-comment"># 关键参数</span>
</code></pre>
<p><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/></p>
<p>在实际项目中，数据下沉模式可使训练速度提升50%以上，尤其对于大规模数据集效果显著。</p>
<h3 data-id="heading-5">3. 混合精度训练技巧</h3>
<p>混合精度训练是提升昇腾910性能的关键技术，能在保持模型精度的同时大幅提升训练速度。</p>
<h4 data-id="heading-6">3.1 精度级别选择</h4>
<p>MindSpore提供多种混合精度级别：</p>
<pre><code class="hljs language-ini" lang="ini">from mindspore import amp
from mindspore.train import Model

<span class="hljs-comment"># 方式一：通过Model接口配置（推荐新手）</span>
<span class="hljs-attr">model</span> = Model(net, loss_fn=loss_fn, optimizer=opt, metrics={<span class="hljs-string">'accuracy'</span>}, 
              <span class="hljs-attr">amp_level</span>=<span class="hljs-string">"O2"</span>)  <span class="hljs-comment"># O2是最佳平衡点</span>

<span class="hljs-comment"># 方式二：自定义训练循环（适合高级用户）</span>
<span class="hljs-attr">net</span> = amp.build_train_network(net, opt, loss_fn, level=<span class="hljs-string">"O2"</span>)
</code></pre>
<p><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/></p>
<p>实践经验：</p>
<ul>
<li>O2模式：最佳实践选择，保持BatchNorm为FP32，其他转为FP16</li>
<li>O3模式：全FP16，可能导致梯度溢出，需谨慎使用</li>
<li>O0模式：全FP32，用于调试和精度验证</li>
</ul>
<h4 data-id="heading-7">3.2 梯度缩放与溢出处理</h4>
<p>混合精度训练中的关键挑战是梯度下溢问题：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> mindspore <span class="hljs-keyword">import</span> amp
<span class="hljs-keyword">from</span> mindspore <span class="hljs-keyword">import</span> nn

<span class="hljs-comment"># 自定义损失函数以处理梯度缩放</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomTrainingWrapper</span>(nn.Cell):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, network, optimizer, loss_fn</span>):
        <span class="hljs-built_in">super</span>().__init__()
        self.network = network
        self.optimizer = optimizer
        self.loss_fn = loss_fn
        self.loss_scale = amp.FixedLossScaleManager(<span class="hljs-number">1024</span>)  <span class="hljs-comment"># 固定缩放因子</span>
        
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">construct</span>(<span class="hljs-params">self, data, label</span>):
        output = self.network(data)
        loss = self.loss_fn(output, label)
        scaled_loss = self.loss_scale.scale(loss)
        <span class="hljs-keyword">return</span> scaled_loss
</code></pre>
<p><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/></p>
<h3 data-id="heading-8">4. 模型开发与调试技巧</h3>
<h4 data-id="heading-9">4.1 动态Shape问题解决</h4>
<p>静态图模式下，动态Shape会导致频繁的图重编译，严重拖慢训练速度。解决方法：</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-comment"># 确保数据批次大小固定</span>
data_set = data_set.batch(batch_size, drop_remainder=<span class="hljs-title class_">True</span>)  <span class="hljs-comment"># 丢弃不足批次的数据</span>

<span class="hljs-comment"># 网络定义中避免动态Shape操作</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">StableNet</span>(nn.<span class="hljs-title class_">Cell</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params"><span class="hljs-variable language_">self</span></span>):
        <span class="hljs-variable language_">super</span>().__init__()
        <span class="hljs-comment"># 明确指定输入shape，避免动态推断</span>
        <span class="hljs-variable language_">self</span>.reshape = ops.<span class="hljs-title class_">Reshape</span>()
        
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">construct</span>(<span class="hljs-params"><span class="hljs-variable language_">self</span>, x</span>):
        <span class="hljs-comment"># 避免基于输入shape的动态计算</span>
        batch_size = x.shape[<span class="hljs-number">0</span>]
        <span class="hljs-comment"># 使用固定尺寸或从配置中读取</span>
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.reshape(x, (batch_size, -<span class="hljs-number">1</span>))
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[上市大模型企业数据基础设施的选择：MiniMax 基于阿里云 SelectDB 版，打造全球统一AI可观测中台]]></title>    <link>https://juejin.cn/post/7599585289947447359</link>    <guid>https://juejin.cn/post/7599585289947447359</guid>    <pubDate>2026-01-27T03:23:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599585289947447359" data-draft-id="7599579865608159274" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="上市大模型企业数据基础设施的选择：MiniMax 基于阿里云 SelectDB 版，打造全球统一AI可观测中台"/> <meta itemprop="keywords" content="Apache,数据库,人工智能"/> <meta itemprop="datePublished" content="2026-01-27T03:23:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SelectDB"/> <meta itemprop="url" content="https://juejin.cn/user/3189021726222904"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            上市大模型企业数据基础设施的选择：MiniMax 基于阿里云 SelectDB 版，打造全球统一AI可观测中台
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3189021726222904/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SelectDB
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T03:23:16.000Z" title="Tue Jan 27 2026 03:23:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>MiniMax 全球领先的通用人工智能科技公司。旗下主要有 MiniMax M2.1、Hailuo 2.3、Speech 2.6 和 Music 2.0 等大模型，MiniMax Agent、海螺 AI、星野、Talkie 等产品，以及为企业客户与开发者提供 API 服务的 MiniMax 开放平台。截至目前，MiniMax 已有超过 200 个国家及地区的逾 2.12 亿名个人用户以及超过 100 个国家的企业客户。</p>
<p>在技术层面，MiniMax 坚持文本、视频、语音等全模态模型自主研发。目前，其全模态模型已进入国际第一梯队，被业内称为“全球唯四实现这一水平的企业之一”。</p>
<p>在推理能力和效率方面，MiniMax 近年来的模型迭代节奏明显加快，在多项国际评测榜单中进入全球前列。相关模型以较低算力成本实现接近国际顶尖闭源模型的性能表现，也在海外开发者社区中获得关注。</p>
<p>MiniMax 通过开放平台赋能多个行业，将领先的模型能力以 API 方式提供给企业和开发者。随着模型调用量的指数级增长，<strong>训练与推理产生的运行日志数据量也急剧膨胀</strong>。 这些日志对于 AI 应用的运行监控、性能优化与问题排查至关重要，因此，<strong>选择一款能够支撑高吞吐、易查询、低成本的日志存储与检索引擎，成为保障业务稳定高效运行的关键</strong> 。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40dd08ef25b5434a9c3ca8f21f3042db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770088996&amp;x-signature=bv%2Fqg%2BcrNjbyQaD82SFVLL6ntK4%3D" alt="MiniMax 可观测性数据平台核心基座.JPEG" loading="lazy"/></p>
<p>面对海量、实时且不断增长的日志数据处理需求，<strong>MiniMax 经过深度评估，最终选择阿里云数据库 SelectDB 版作为其全新可观测性数据平台的核心基座</strong>。阿里云数据库 SelectDB 版凭借其更低的成本、更高的查询性能以及更灵活的查询方式在众多产品中脱颖而出。其关键特性精准匹配了现代 AI 业务的严苛要求：</p>
<ul>
<li><strong>云原生存算分离架构</strong>：基于对象存储 OSS 的存储层与弹性计算层解耦，支持独立、无损的弹性伸缩，为应对日志洪峰提供了近乎无限的扩展能力。</li>
<li><strong>多集群硬隔离与数据共享</strong>：支持云原生多集群硬隔离能力，用户可以将单个实例的计算资源划分为多个逻辑集群，不同集群之间的分配独立的计算资源，实现了不同集群的严格物理资源隔离和数据共享。</li>
<li><strong>智能缓存加速</strong>：通过单副本本地读写缓存、智能数据淘汰策略、高效列式存储格式和先进压缩算法，显著提升了海量数据的读写效率。</li>
</ul>
<blockquote>
<p>阿里云数据库 SelectDB 植根于开源 Apache Doris 的坚实基础，深度融合云随需而用的特性，依托阿里云基础设施，构建起云原生存算分离的全新架构，面向企业海量数据的实时分析需求，提供极速实时、湖仓融合统一、简单易用的云上数仓服务。</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/63c8e58c0ee44f8dab82596e720387cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770088996&amp;x-signature=DUwGo6t5Q%2Faeeq6JFeZH1I66I40%3D" alt="MiniMax 可观测性数据平台核心基座-1.PNG" loading="lazy"/></p>
<p>基于阿里云 SelectDB 版，<strong>MiniMax 构建了覆盖国内及海外业务的统一日志可观测中台</strong>。 以 SelectDB 独立负责所有日志的存储与查询分析，实现了 “<strong>一个平台，全球覆盖</strong>” 。这彻底终结了以往为不同业务集群分散部署、独立运维多套系统的复杂局面，在架构上实现了极大的简化。</p>
<p>阿里云数据库 SelectDB 在 MiniMax 的成功实践足以说明：<strong>SelectDB 能够很好地满足 AI 时代海量数据实时处理与分析的需求</strong>。不仅为 MiniMax 自身业务的高效运营提供了坚实保障，也为广大面临类似日志处理挑战的 AI 大模型企业，提供了一个<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzg3Njc2NDAwOA%3D%3D%26mid%3D2247536659%26idx%3D1%26sn%3Dbccdc320a7fc63498122d889cdc7cc1b%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=Mzg3Njc2NDAwOA==&amp;mid=2247536659&amp;idx=1&amp;sn=bccdc320a7fc63498122d889cdc7cc1b&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">高性能、低成本的可靠技术解决方案</a>。</p>
<p>不止于此， 面对大模型与多模态 AI 的快速发展，SelectDB 已从被动存储分析向主动智能分析演进。目前，SelectDB 已具备 AI 原生支持能力，深度融合<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzg3Njc2NDAwOA%3D%3D%26mid%3D2247539611%26idx%3D1%26sn%3D07986a9513f9230f41db9944d132980d%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=Mzg3Njc2NDAwOA==&amp;mid=2247539611&amp;idx=1&amp;sn=07986a9513f9230f41db9944d132980d&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">向量索引</a>、文本搜索与结构化分析能力，实现高效的<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzg3Njc2NDAwOA%3D%3D%26mid%3D2247538877%26idx%3D1%26sn%3D488aef420779ab3aef786413765a6079%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=Mzg3Njc2NDAwOA==&amp;mid=2247538877&amp;idx=1&amp;sn=488aef420779ab3aef786413765a6079&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">混合检索</a>，显著提升结果相关性、实时性与准确性。更进一步，SelectDB 内置 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzg3Njc2NDAwOA%3D%3D%26mid%3D2247537751%26idx%3D1%26sn%3Ddb1da6ec1d0859aed7397fe08af713dc%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=Mzg3Njc2NDAwOA==&amp;mid=2247537751&amp;idx=1&amp;sn=db1da6ec1d0859aed7397fe08af713dc&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">AI 函数</a>（如语义理解、特征提取）并支持<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzg3Njc2NDAwOA%3D%3D%26mid%3D2247536828%26idx%3D1%26sn%3D1948df05ac382e5a91a1d2e9c6f3cbf5%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=Mzg3Njc2NDAwOA==&amp;mid=2247536828&amp;idx=1&amp;sn=1948df05ac382e5a91a1d2e9c6f3cbf5&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">基于 MCP 的 Agent 分析接口</a>，可直接升级为企业的 “AI 分析中枢” ，为业务智能决策与创新提供稳定、高效的数据底座。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[今天简单回顾一下Keepalived吧]]></title>    <link>https://juejin.cn/post/7599565587152945178</link>    <guid>https://juejin.cn/post/7599565587152945178</guid>    <pubDate>2026-01-26T20:28:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599565587152945178" data-draft-id="7599530824426307594" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="今天简单回顾一下Keepalived吧"/> <meta itemprop="keywords" content="Linux"/> <meta itemprop="datePublished" content="2026-01-26T20:28:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Sheffield"/> <meta itemprop="url" content="https://juejin.cn/user/362164852109770"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            今天简单回顾一下Keepalived吧
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/362164852109770/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Sheffield
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T20:28:09.000Z" title="Mon Jan 26 2026 20:28:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Keepalived是什么</h2>
<p>Keepalived是一款<strong>基于VRRP协议的高可用集群工具</strong>，核心作用是为服务器集群提供故障自动切换能力，避免单点故障导致服务中断。它不仅能实现IP漂移（虚拟IP，VIP），还支持健康检查功能，实时监控后端服务状态，是Linux系统中构建高可用架构（如LVS、Nginx集群）的核心组件。</p>
<p>其核心设计依赖VRRP（虚拟路由冗余协议），通过竞选机制让集群中的主节点持有VIP，备节点处于监听状态，当主节点故障时，备节点自动接管VIP并提供服务，全程无需人工干预，确保服务连续性。</p>
<h3 data-id="heading-1">Keepalived的核心作用与应用场景</h3>
<p>Keepalived主要解决高可用场景中的单点故障问题，应用覆盖各类后端服务集群：</p>
<ul>
<li><strong>VIP漂移与服务切换</strong>：为集群分配一个固定虚拟IP，主节点故障时，VIP自动漂移到备节点，客户端无需修改配置即可持续访问服务（如Nginx负载均衡器高可用、数据库主从切换后的IP统一）。</li>
<li><strong>后端服务健康检查</strong>：支持TCP端口、HTTP接口、脚本自定义等多种健康检查方式，实时监测后端服务（如Web、数据库）状态，若服务异常，自动触发故障切换，避免将请求转发到故障节点。</li>
<li><strong>LVS集群高可用</strong>：与LVS（Linux虚拟服务器）配合，实现LVS负载均衡器的高可用，确保负载均衡层不成为单点瓶颈，支撑大规模并发访问场景。</li>
<li><strong>多节点集群竞选</strong>：支持一主多备、多主多备等集群架构，可通过优先级配置控制主备切换顺序，适配不同业务的高可用需求。</li>
</ul>
<h3 data-id="heading-2">Keepalived的核心优势</h3>
<ul>
<li><strong>切换速度快</strong>：基于VRRP协议，故障检测和VIP漂移耗时短（秒级），服务中断时间可忽略，对业务无明显影响。</li>
<li><strong>配置简单灵活</strong>：核心配置文件简洁，支持多种健康检查方式和集群架构，可快速适配不同业务场景。</li>
<li><strong>轻量高性能</strong>：占用系统资源少，运行稳定，无复杂依赖，可部署在各类Linux服务器中，适配从单机高可用到大规模集群的场景。</li>
<li><strong>兼容性强</strong>：可与Nginx、LVS、HAProxy、MySQL等各类服务配合使用，不侵入业务代码，无需修改现有架构。</li>
<li><strong>支持自定义脚本</strong>：可通过脚本扩展健康检查逻辑和故障切换动作（如故障时发送告警、执行自定义恢复命令），灵活性极高。</li>
</ul>
<h3 data-id="heading-3">Keepalived核心原理：VRRP协议与主备机制</h3>
<p>Keepalived的核心是VRRP协议，理解该协议就能掌握Keepalived的工作逻辑：</p>
<h4 data-id="heading-4">一、VRRP协议核心概念</h4>
<p>VRRP将多个服务器组成一个“虚拟路由组”，组内包含一个主节点（Master）和一个/多个备节点（Backup），组内所有节点共享一个虚拟IP（VIP）。客户端通过VIP访问服务，无需关心具体哪个节点提供服务。</p>
<ul>
<li><strong>主节点（Master）</strong> ：优先级更高（默认优先级100，数值越大优先级越高），主动持有VIP，响应客户端请求，并定期向备节点发送心跳报文（通告自身状态）。</li>
<li><strong>备节点（Backup）</strong> ：优先级低于主节点，监听主节点的心跳报文，若未收到心跳（主节点故障），则触发竞选，优先级最高的备节点成为新主节点，接管VIP。</li>
<li><strong>心跳报文</strong>：主节点每隔1秒（默认）发送VRRP通告报文，备节点通过接收报文判断主节点状态，报文仅在组内节点间传输，不影响客户端。</li>
</ul>
<h4 data-id="heading-5">二、主备切换流程</h4>
<ol>
<li>正常状态：主节点持有VIP，提供服务，定期发送心跳；备节点监听心跳，处于待命状态。</li>
<li>主节点故障：主节点停止服务，不再发送心跳，备节点超时（默认3秒）未收到心跳，判定主节点故障。</li>
<li>备节点竞选：所有备节点对比优先级，优先级最高的节点成为新主节点。</li>
<li>VIP漂移：新主节点将VIP绑定到自身网卡，发送ARP报文通知局域网内其他设备更新ARP缓存（告知VIP对应新的MAC地址）。</li>
<li>服务恢复：客户端通过VIP继续访问服务，业务无中断；原主节点恢复后，若其优先级高于当前主节点，会重新夺回VIP（可通过配置关闭抢占模式）。</li>
</ol>
<h3 data-id="heading-6">怎么使用Keepalived？</h3>
<p>以“Nginx高可用”为例，搭建一主一备架构，演示Keepalived的安装与配置。</p>
<h4 data-id="heading-7">1. 环境准备</h4>
<ul>
<li>主节点（Master）：IP 192.168.1.100，优先级 100</li>
<li>备节点（Backup）：IP 192.168.1.101，优先级 90</li>
<li>虚拟IP（VIP）：192.168.1.200</li>
<li>前提：两节点已安装Nginx，且服务正常运行；关闭防火墙或开放VRRP协议（默认端口无，需允许组播报文）。</li>
</ul>
<h4 data-id="heading-8">2. 安装Keepalived</h4>
<p>主备节点执行相同安装命令：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装Keepalived</span>
yum install -y keepalived

<span class="hljs-comment"># 查看版本，验证安装成功</span>
keepalived -v

<span class="hljs-comment"># 启动服务并设置开机自启</span>
systemctl start keepalived
systemctl <span class="hljs-built_in">enable</span> keepalived

<span class="hljs-comment"># 查看服务状态</span>
systemctl status keepalived
</code></pre>
<h4 data-id="heading-9">3. 核心配置（主备节点差异化配置）</h4>
<p>Keepalived核心配置文件为 <code>/etc/keepalived/keepalived.conf</code>，需分别配置主备节点。</p>
<h5 data-id="heading-10">（1）主节点（192.168.1.100）配置</h5>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># 编写新配置文件</span>
cat &gt; <span class="hljs-regexp">/etc/</span>keepalived/keepalived.conf &lt;&lt; EOF
vvrp_script check_nginx { <span class="hljs-comment"># 定义健康检测脚本</span>
    script <span class="hljs-string">"/etc/keepalived/check_nginx.sh"</span> <span class="hljs-comment"># 选择脚本路径</span>
    interval <span class="hljs-number">5</span> <span class="hljs-comment"># 时间间隔五秒一次</span>
    timeout <span class="hljs-number">3</span> <span class="hljs-comment"># 脚本超时时间</span>
    fall <span class="hljs-number">2</span> <span class="hljs-comment"># 最大允许失败次数</span>
    rise <span class="hljs-number">1</span> <span class="hljs-comment"># 最小允许成功恢复次数</span>
}

vrrp_instance LB01 {
    <span class="hljs-keyword">state</span> MASTER <span class="hljs-comment"># 主备状态</span>
    interface ens33 <span class="hljs-comment"># VIP网卡</span>
    virtual_router_id <span class="hljs-number">1</span> <span class="hljs-comment"># 虚拟路由组ID，主备节点必须一致</span>
    priority <span class="hljs-number">100</span> <span class="hljs-comment"># 节点优先级</span>
    advert_int <span class="hljs-number">5</span> <span class="hljs-comment"># 心跳间隔</span>
    authentication { <span class="hljs-comment">#节点认证</span>
        auth_type PASS <span class="hljs-comment">#认证方式</span>
        auth_pass Sheffield <span class="hljs-comment">#认证密码</span>
    }
    virtual_ipaddress {
        <span class="hljs-number">192.168</span>.<span class="hljs-number">0</span>.<span class="hljs-number">1</span>/<span class="hljs-number">24</span> <span class="hljs-comment"># VIP设置</span>
    }
    track_script {
        check_nginx <span class="hljs-comment"># 启用脚本</span>
    }
}

EOF
</code></pre>
<h5 data-id="heading-11">（2）备节点（192.168.1.101）配置</h5>
<p>与主节点配置差异：<code>state</code>、<code>priority</code>，其余一致：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cat</span> &gt; /etc/keepalived/keepalived.conf &lt;&lt; <span class="hljs-string">EOF
vrrp_script check_nginx {
    script "/etc/keepalived/check_nginx.sh"
    interval 5
    timeout 3
    fall 2
    rise 1
}

vrrp_instance LB02 {
    state BACKUP #备份节点
    interface ens33
    virtual_router_id 1
    priority 50 # 优先级低于主节点
    advert_int 5
    authentication {
        auth_type PASS
        auth_pass Sheffield
    }
    virtual_ipaddress {
        192.168.0.1/24
    }
    track_script {
        check_nginx
    }
}
EOF</span>
</code></pre>
<h5 data-id="heading-12">（3）编写健康检查脚本（主备节点一致）</h5>
<p>脚本功能：检测Nginx进程是否存在，若不存在则尝试重启，重启失败则停止Keepalived，触发主备切换。</p>
<pre><code class="hljs language-perl" lang="perl">cat &gt; <span class="hljs-regexp">/etc/</span>keepalived/check_nginx.sh &lt;&lt; EOF
<span class="hljs-comment">#!/bin/bash</span>
nginx_process=$(ps -ef | <span class="hljs-keyword">grep</span> nginx | <span class="hljs-keyword">grep</span> -v <span class="hljs-keyword">grep</span> | wc -l)

<span class="hljs-keyword">if</span> [ $nginx_process -eq <span class="hljs-number">0</span> ]; then
    systemctl restart nginx
    <span class="hljs-keyword">sleep</span> <span class="hljs-number">2</span>
    nginx_process=$(ps -ef | <span class="hljs-keyword">grep</span> nginx | <span class="hljs-keyword">grep</span> -v <span class="hljs-keyword">grep</span> | wc -l)
    <span class="hljs-keyword">if</span> [ $nginx_process -eq <span class="hljs-number">0</span> ]; then
        systemctl stop keepalived
    fi
fi

EOF

<span class="hljs-comment"># 赋予脚本执行权限</span>
<span class="hljs-keyword">chmod</span> +<span class="hljs-keyword">x</span> /etc/keepalived/check_nginx.sh
</code></pre>
<h4 data-id="heading-13">4. 重启服务并验证</h4>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># 主备节点分别重启Keepalived</span>
systemctl restart keepalived

<span class="hljs-comment"># 验证VIP是否绑定成功（主节点执行，应显示VIP）</span>
ip addr | <span class="hljs-keyword">grep</span> <span class="hljs-number">192.168</span>.<span class="hljs-number">1.1</span>

<span class="hljs-comment"># 备节点执行，此时无VIP（主节点正常时）</span>
ip addr | <span class="hljs-keyword">grep</span> <span class="hljs-number">192.168</span>.<span class="hljs-number">1.1</span>
</code></pre>
<h4 data-id="heading-14">5. 故障切换测试</h4>
<ol>
<li>停止主节点Nginx，模拟故障：<code>systemctl stop nginx</code>。</li>
<li>执行 <code>systemctl status keepalived</code>，验证主节点脚本是否生效。</li>
<li>客户端访问 <code>http://192.168.1.1</code>，确认VIP已经漂移成功。</li>
<li>恢复主节点服务：<code>systemctl start nginx; systemctl start keepalived</code>，VIP会漂移回主节点</li>
</ol>
<h3 data-id="heading-15">Keepalived核心配置与常用命令</h3>
<h4 data-id="heading-16">1. 核心配置参数说明</h4>
<ul>
<li>
<p><strong>global_defs</strong>：全局配置，<code>router_id</code> 用于标识节点，集群内唯一。</p>
</li>
<li>
<p><strong>vrrp_script</strong>：健康检查脚本配置，<code>interval</code> 为检查间隔，<code>weight</code> 为优先级调整值（负数表示服务异常时降低优先级）。</p>
</li>
<li>
<p><strong>vrrp_instance</strong>：VRRP实例核心配置：</p>
<ul>
<li><code>state</code>：节点角色（MASTER/BACKUP），仅为初始状态，实际主备由优先级决定。</li>
<li><code>interface</code>：绑定VIP的网卡，必须是能与其他节点通信的网卡。</li>
<li><code>virtual_router_id</code>：虚拟路由组ID，主备节点必须相同，否则无法通信。</li>
<li><code>priority</code>：节点优先级，范围0-255，数值越大优先级越高。</li>
<li><code>advert_int</code>：心跳发送间隔，默认1秒。</li>
<li><code>authentication</code>：主备节点认证配置，确保心跳报文安全，<code>auth_pass</code> 主备必须一致。</li>
<li><code>virtual_ipaddress</code>：配置VIP及绑定的网卡，可添加多个VIP。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-17">2. 常用命令</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 服务管理命令</span>
systemctl start keepalived  <span class="hljs-comment"># 启动服务</span>
systemctl stop keepalived   <span class="hljs-comment"># 停止服务</span>
systemctl restart keepalived <span class="hljs-comment"># 重启服务</span>
systemctl status keepalived <span class="hljs-comment"># 查看服务状态</span>
systemctl <span class="hljs-built_in">enable</span> keepalived <span class="hljs-comment"># 开机自启</span>
systemctl <span class="hljs-built_in">disable</span> keepalived <span class="hljs-comment"># 关闭开机自启</span>

<span class="hljs-comment"># 配置相关命令</span>
keepalived -t -f /etc/keepalived/keepalived.conf <span class="hljs-comment"># 验证配置文件语法正确性</span>
</code></pre>
<h3 data-id="heading-18">注意事项</h3>
<ul>
<li>主备节点网络必须互通，且虚拟路由组ID（virtual_router_id）、认证信息（auth_pass）必须一致，否则无法正常通信。</li>
<li>绑定VIP的网卡需正确，若网卡名错误，VIP无法正常绑定和漂移（用 <code>ip addr</code> 查看实际网卡名）。</li>
<li>健康检查脚本需赋予执行权限，否则Keepalived无法调用，导致服务异常时无法触发切换。</li>
<li>默认开启抢占模式，原主节点恢复后会夺回VIP，可通过在 <code>vrrp_instance</code> 中添加<code>nopreempt</code> 关闭抢占（仅备节点配置有效）。</li>
<li>防火墙需允许VRRP协议（组播地址224.0.0.18，协议号112），否则主备节点无法接收心跳报文，配置：<code>iptables -A INPUT -p vrrp -j ACCEPT</code>。</li>
<li>生产环境中，建议将健康检查脚本与告警机制结合（如故障时发送邮件/短信告警），便于及时排查问题。</li>
</ul>
<p>先写这么多，后面有时间再多写点干货🤭。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[别只盯着 LangChain！带你起底 LangGraph 和 DeepAgents：Agent 真正落地生产环境的必经之路]]></title>    <link>https://juejin.cn/post/7599579865608208426</link>    <guid>https://juejin.cn/post/7599579865608208426</guid>    <pubDate>2026-01-27T03:22:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599579865608208426" data-draft-id="7599299048303083563" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="别只盯着 LangChain！带你起底 LangGraph 和 DeepAgents：Agent 真正落地生产环境的必经之路"/> <meta itemprop="keywords" content="Agent"/> <meta itemprop="datePublished" content="2026-01-27T03:22:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Liiiii"/> <meta itemprop="url" content="https://juejin.cn/user/696435167987753"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            别只盯着 LangChain！带你起底 LangGraph 和 DeepAgents：Agent 真正落地生产环境的必经之路
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/696435167987753/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Liiiii
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T03:22:01.000Z" title="Tue Jan 27 2026 03:22:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">LangChain-AI 技术调研报告</h2>
<blockquote>
<p>本文是一份 <strong>系统性、工程导向的 LangChain-AI 技术调研报告</strong> ，从 <strong>整体技术体系、设计理念、核心能力、工程特性、应用架构与生态对比</strong> 等多个维度，全面分析 <strong>LangChain、LangGraph</strong> 与 <strong>DeepAgents</strong> 。</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">一、技术体系总体概览</h3>
<p>LangChain-AI 将智能体系统拆分为三个层级：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TB
    A[LLM Providers] --&gt; B[LangChain Agent &amp; App DSL]
    B --&gt; C[LangGraph Stateful Runtime]
    C --&gt; D[DeepAgents Autonomous Agent Harness]

    style B fill:#E3F2FD
    style C fill:#E8F5E9
    style D fill:#FFF3E0
</code></pre>
<ul>
<li><strong>LangChain</strong>：Agent 与 LLM 应用的开发框架（DSL 层）</li>
<li><strong>LangGraph</strong>：Agent 的执行引擎与状态运行时（Runtime 层）</li>
<li><strong>DeepAgents</strong>：面向长期自治任务的高阶 Agent 工具箱（Harness 层）</li>
</ul>
<h3 data-id="heading-2">二、LangChain</h3>
<p><strong>官方资源</strong>：</p>
<ul>
<li>项目主页：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flangchain-ai%2Flangchain" target="_blank" title="https://github.com/langchain-ai/langchain" ref="nofollow noopener noreferrer">github.com/langchain-a…</a></li>
<li>官方文档（Python）：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Flangchain%2Foverview" target="_blank" title="https://docs.langchain.com/oss/python/langchain/overview" ref="nofollow noopener noreferrer">docs.langchain.com/oss/python/…</a></li>
<li>Chat Models：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Flangchain%2Fchat_models" target="_blank" title="https://docs.langchain.com/oss/python/langchain/chat_models" ref="nofollow noopener noreferrer">docs.langchain.com/oss/python/…</a></li>
<li>Agents：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Flangchain%2Fagents" target="_blank" title="https://docs.langchain.com/oss/python/langchain/agents" ref="nofollow noopener noreferrer">docs.langchain.com/oss/python/…</a></li>
</ul>
<h4 data-id="heading-3">2.1 技术定位与设计目标</h4>
<p>LangChain 是一个 <strong>面向 LLM 应用与 Agent 的开发框架（Developer‑Facing Framework）</strong>，其核心设计目标是：</p>
<ul>
<li>降低 LLM 应用与 Agent 的开发门槛</li>
<li>提供统一、可组合的抽象层（模型 / Prompt / Tool / Agent）</li>
<li>让开发者专注“Agent 能做什么”，而不是“底层如何接模型”</li>
</ul>
<p>LangChain 并不试图解决执行可靠性、状态持久化等问题，而是将这些职责下沉给 LangGraph。</p>
<hr/>
<h4 data-id="heading-4">2.2 能力模块</h4>
<h4 data-id="heading-5">1. 标准化 LLM / ChatModel 接口</h4>
<ul>
<li>通过 <code>chat_models</code> 统一封装不同模型厂商（OpenAI、Anthropic 等）</li>
<li>屏蔽 API 差异，支持流式、工具调用、多模态</li>
</ul>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    App --&gt; ChatModel
    ChatModel --&gt; OpenAI
    ChatModel --&gt; Anthropic
</code></pre>
<p><strong>能力价值</strong>：</p>
<ul>
<li>模型可替换性强</li>
<li>避免供应商锁定</li>
</ul>
<hr/>
<h4 data-id="heading-6">2. Prompt Template 与消息结构化</h4>
<ul>
<li>提供 <code>PromptTemplate</code> / <code>ChatPromptTemplate</code></li>
<li>将 Prompt 视为可组合、可维护的结构化对象</li>
</ul>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    Variables --&gt; PromptTemplate --&gt; LLM
</code></pre>
<p><strong>能力价值</strong>：</p>
<ul>
<li>Prompt 工程化</li>
<li>减少字符串拼接错误</li>
</ul>
<hr/>
<h4 data-id="heading-7">3. Tool 抽象与工具调用机制</h4>
<ul>
<li>Tool = 函数 + 描述 + Schema</li>
<li>自动转为模型可理解的 Function / Tool Calling 格式</li>
</ul>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    Agent-&gt;&gt;LLM: 推理 + 选择工具
    LLM-&gt;&gt;Tool: 调用
    Tool--&gt;&gt;Agent: 返回结果
</code></pre>
<p><strong>能力价值</strong>：</p>
<ul>
<li>LLM 具备“行动能力”</li>
<li>支持外部系统集成</li>
</ul>
<hr/>
<h4 data-id="heading-8">4. 预构建 Agent Loop</h4>
<ul>
<li>内置 ReAct / Tool‑Calling Agent</li>
<li>自动管理思考 → 行动 → 反馈循环</li>
</ul>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    Input --&gt; Reasoning --&gt; ToolCall --&gt; Observation --&gt; Reasoning
</code></pre>
<p><strong>能力价值</strong>：</p>
<ul>
<li>快速构建可用 Agent</li>
<li>降低 Agent 心智负担</li>
</ul>
<hr/>
<h4 data-id="heading-9">5. Callback / Middleware 扩展机制</h4>
<ul>
<li>在 LLM / Tool 调用生命周期插入自定义逻辑</li>
<li>用于日志、监控、安全审计、Tracing</li>
</ul>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    BeforeCall --&gt; LLM --&gt; AfterCall
</code></pre>
<p><strong>能力定位总结</strong>：</p>
<blockquote>
<p>LangChain 是 <strong>Agent 与 LLM 应用的开发框架（DSL）</strong>，而非执行引擎。</p>
</blockquote>
<hr/>
<h3 data-id="heading-10">三、LangGraph</h3>
<p><strong>官方资源</strong>：</p>
<ul>
<li>项目主页：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flangchain-ai%2Flanggraph" target="_blank" title="https://github.com/langchain-ai/langgraph" ref="nofollow noopener noreferrer">github.com/langchain-a…</a></li>
<li>官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Flanggraph%2Foverview" target="_blank" title="https://docs.langchain.com/oss/python/langgraph/overview" ref="nofollow noopener noreferrer">docs.langchain.com/oss/python/…</a></li>
<li>Concepts（Graph / State）：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Flanggraph%2Fconcepts" target="_blank" title="https://docs.langchain.com/oss/python/langgraph/concepts" ref="nofollow noopener noreferrer">docs.langchain.com/oss/python/…</a></li>
</ul>
<h4 data-id="heading-11">3.1 技术定位与设计目标</h4>
<p>LangGraph 是一个 <strong>面向 Agent 的状态化执行引擎（Stateful Runtime）</strong>，用于解决 LangChain 明确不解决的问题：</p>
<ul>
<li>Agent 执行过程如何建模？</li>
<li>如何支持长时间运行与失败恢复？</li>
<li>如何让人类参与执行过程？</li>
</ul>
<p>LangGraph 的核心思想是：<strong>Agent 本质上是一个状态机，而不是一个黑盒循环。</strong></p>
<hr/>
<h4 data-id="heading-12">3.2 执行模型与抽象层级</h4>
<p>LangGraph 以 Graph 为一等抽象：</p>
<ul>
<li>Node：执行单元（LLM、工具、逻辑）</li>
<li>Edge：执行路径</li>
<li>State：系统级共享状态</li>
</ul>
<hr/>
<h4 data-id="heading-13">3.3 能力模块</h4>
<h4 data-id="heading-14">1. Graph‑based 执行模型</h4>
<ul>
<li>将 Agent 工作流建模为 <strong>有向图</strong></li>
<li>Node = 执行单元，Edge = 执行路径</li>
</ul>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    Start --&gt; NodeA
    NodeA --&gt;|条件1| NodeB
    NodeA --&gt;|条件2| NodeC
    NodeB --&gt; End
    NodeC --&gt; End
</code></pre>
<p><strong>能力价值</strong>：</p>
<ul>
<li>显式控制执行路径</li>
<li>支持分支、循环、回退</li>
</ul>
<hr/>
<h4 data-id="heading-15">2. 显式 State 建模</h4>
<ul>
<li>使用 TypedDict / Dataclass 定义系统状态</li>
<li>每个节点显式读写 State</li>
</ul>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    State0 --&gt; Node --&gt; State1
</code></pre>
<p><strong>能力价值</strong>：</p>
<ul>
<li>系统级可观测状态</li>
<li>Agent 行为可解释</li>
</ul>
<hr/>
<h4 data-id="heading-16">3. Durable Execution（持久执行）</h4>
<ul>
<li>自动 Checkpoint</li>
<li>失败可恢复、可重放</li>
</ul>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    Execute --&gt; Checkpoint --&gt; Resume
</code></pre>
<p><strong>能力价值</strong>：</p>
<ul>
<li>支持长时间运行任务</li>
<li>工程级可靠性</li>
</ul>
<hr/>
<h4 data-id="heading-17">4. Human‑in‑the‑Loop 支持</h4>
<ul>
<li>执行中可暂停</li>
<li>人工修改 State 后继续</li>
</ul>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    Agent-&gt;&gt;System: 执行到关键节点
    System-&gt;&gt;Human: 请求审核
    Human-&gt;&gt;System: 确认/修改
    System-&gt;&gt;Agent: 继续执行
</code></pre>
<h4 data-id="heading-18">5. 子图（Subgraph）与组合</h4>
<ul>
<li>支持嵌套 Graph</li>
<li>复杂流程模块化</li>
</ul>
<p><strong>能力定位总结</strong>：</p>
<blockquote>
<p>LangGraph 是 <strong>Agent 的状态机与执行运行时</strong>，关注“怎么跑得稳”。</p>
</blockquote>
<hr/>
<h3 data-id="heading-19">四、DeepAgents</h3>
<p><strong>官方资源</strong>：</p>
<ul>
<li>项目主页：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flangchain-ai%2Fdeepagents" target="_blank" title="https://github.com/langchain-ai/deepagents" ref="nofollow noopener noreferrer">github.com/langchain-a…</a></li>
<li>官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Fdeepagents%2Foverview" target="_blank" title="https://docs.langchain.com/oss/python/deepagents/overview" ref="nofollow noopener noreferrer">docs.langchain.com/oss/python/…</a></li>
<li>Middleware &amp; Skills：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Fdeepagents%2Fconcepts" target="_blank" title="https://docs.langchain.com/oss/python/deepagents/concepts" ref="nofollow noopener noreferrer">docs.langchain.com/oss/python/…</a></li>
</ul>
<h4 data-id="heading-20">4.1 技术定位与设计目标</h4>
<p>DeepAgents 是一个 <strong>面向长期自治任务的 Agent Harness（能力整合层）</strong>，其目标不是“让 Agent 能跑”，而是：</p>
<ul>
<li>让 Agent 能独立完成复杂项目级任务</li>
<li>让 Agent 具备规划、反思、上下文管理能力</li>
<li>让 Agent 像一个“数字员工”而不是脚本</li>
</ul>
<p>DeepAgents 明确构建在 LangGraph Runtime 之上，并复用 LangChain 的 Agent 抽象。</p>
<hr/>
<h4 data-id="heading-21">4.2 能力组织方式（Harness / Middleware / Skills）</h4>
<p>DeepAgents 不强调底层 API，而是通过 <strong>能力组合</strong>：</p>
<ul>
<li>Middleware：拦截与增强 Agent 行为</li>
<li>Skills：可复用的领域能力包</li>
<li>内置工具集：规划、文件系统、子 Agent</li>
</ul>
<hr/>
<h4 data-id="heading-22">4.3 能力模块</h4>
<h4 data-id="heading-23">1. 任务规划与 Todo 管理</h4>
<ul>
<li>内置 Planning 能力</li>
<li>自动将复杂目标拆解为可执行步骤</li>
</ul>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    Goal --&gt; Plan
    Plan --&gt; Todo1
    Plan --&gt; Todo2
    Plan --&gt; Todo3
</code></pre>
<p><strong>能力价值</strong>：</p>
<ul>
<li>支持长链路复杂任务</li>
</ul>
<hr/>
<h4 data-id="heading-24">2. Middleware 驱动的能力扩展</h4>
<ul>
<li>通过 Middleware 为 Agent 注入能力模块</li>
<li>如规划、文件管理、反思、子 Agent 管理</li>
</ul>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    AgentCore --&gt; MiddlewareA
    AgentCore --&gt; MiddlewareB
    AgentCore --&gt; MiddlewareC
</code></pre>
<p><strong>能力价值</strong>：</p>
<ul>
<li>能力模块化</li>
<li>Agent 行为可组合</li>
</ul>
<hr/>
<h4 data-id="heading-25">3. 文件系统作为长期上下文</h4>
<ul>
<li>提供 <code>read_file / write_file / edit_file</code></li>
<li>用文件替代 Prompt 作为主要信息载体</li>
</ul>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    Agent --&gt; FileSystem --&gt; Agent
</code></pre>
<p><strong>能力价值</strong>：</p>
<ul>
<li>突破上下文窗口限制</li>
<li>支持项目级任务</li>
</ul>
<hr/>
<h4 data-id="heading-26">4. Subagent 机制</h4>
<ul>
<li>主 Agent 负责调度</li>
<li>子 Agent 执行专用子任务</li>
</ul>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    MainAgent --&gt; SubAgent1
    MainAgent --&gt; SubAgent2
</code></pre>
<p><strong>能力价值</strong>：</p>
<ul>
<li>上下文隔离</li>
<li>并行执行</li>
</ul>
<hr/>
<h4 data-id="heading-27">5. 长期记忆与自治执行</h4>
<ul>
<li>基于 LangGraph 的 Store</li>
<li>支持跨会话、跨线程记忆</li>
</ul>
<p><strong>能力定位总结</strong>：</p>
<blockquote>
<p>DeepAgents 是 <strong>面向长期自治任务的 Agent Harness</strong>，关注“怎么自己把事干完”。</p>
</blockquote>
<hr/>
<h3 data-id="heading-28">五、总结对比</h3>

























<table><thead><tr><th>技术栈</th><th>核心能力关键词</th><th>技术定位</th></tr></thead><tbody><tr><td>LangChain</td><td>LLM 集成、Agent DSL、Tools、Middleware</td><td>Agent 开发框架</td></tr><tr><td>LangGraph</td><td>状态机、持久执行、Graph 编排</td><td>Agent Runtime</td></tr><tr><td>DeepAgents</td><td>规划、子 Agent、文件上下文、自治</td><td>自治 Agent 工具箱</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-29">六、典型应用架构示例</h3>
<h4 data-id="heading-30">1. 基于 LangChain 的轻量级 Agent 架构</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    User --&gt; Agent
    Agent --&gt; ChatModel
    Agent --&gt; Tools
    Tools --&gt; ExternalAPI
</code></pre>
<p><strong>说明</strong>：</p>
<ul>
<li>适合聊天机器人、RAG、简单工具 Agent</li>
<li>Agent 生命周期短，同步执行</li>
<li>主要关注 Prompt、Tool、模型效果</li>
</ul>
<hr/>
<h4 data-id="heading-31">2. 基于 LangChain + LangGraph 的生产级 Agent 架构</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    User --&gt; Graph
    Graph --&gt; State
    State --&gt; NodeLLM
    State --&gt; NodeTool
    NodeLLM --&gt; State
    NodeTool --&gt; State
    State --&gt; Store
</code></pre>
<p><strong>说明</strong>：</p>
<ul>
<li>显式状态建模（State）</li>
<li>支持失败恢复、长时间运行</li>
<li>适合流程型 Agent、企业自动化</li>
</ul>
<hr/>
<h4 data-id="heading-32">3. 基于 DeepAgents 的自治 Agent 架构</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    User --&gt; MainAgent
    MainAgent --&gt; Planner
    Planner --&gt; TodoList
    MainAgent --&gt; FileSystem
    MainAgent --&gt; SubAgent1
    MainAgent --&gt; SubAgent2
    SubAgent1 --&gt; FileSystem
    SubAgent2 --&gt; FileSystem
</code></pre>
<p><strong>说明</strong>：</p>
<ul>
<li>面向复杂、长期、多步骤任务</li>
<li>文件系统作为主要上下文载体</li>
<li>子 Agent 并行执行、上下文隔离</li>
</ul>
<hr/>
<h3 data-id="heading-33">七、与其它主流 Agent 技术栈的横向对比</h3>
<p><strong>对比参考官方资料</strong>：</p>
<ul>
<li>AutoGen：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmicrosoft%2Fautogen" target="_blank" title="https://github.com/microsoft/autogen" ref="nofollow noopener noreferrer">github.com/microsoft/a…</a></li>
<li>CrewAI：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fjoaomdmoura%2Fcrewai" target="_blank" title="https://github.com/joaomdmoura/crewai" ref="nofollow noopener noreferrer">github.com/joaomdmoura…</a></li>
<li>OpenAI Agents SDK：<a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.openai.com%2Fdocs%2Fagents" target="_blank" title="https://platform.openai.com/docs/agents" ref="nofollow noopener noreferrer">platform.openai.com/docs/agents</a></li>
</ul>
<h4 data-id="heading-34">1. 架构设计对比</h4>















































<table><thead><tr><th>技术栈</th><th>核心架构思想</th><th>是否有 Runtime</th><th>状态是否一等公民</th></tr></thead><tbody><tr><td>LangChain</td><td>Agent DSL + 工具抽象</td><td>否（依赖 LangGraph）</td><td>否</td></tr><tr><td>LangGraph</td><td>Graph 状态机</td><td>是</td><td>是</td></tr><tr><td>DeepAgents</td><td>自治 Agent Harness</td><td>是（基于 LangGraph）</td><td>是</td></tr><tr><td>AutoGen</td><td>多 Agent 对话</td><td>否</td><td>否</td></tr><tr><td>CrewAI</td><td>角色驱动流程</td><td>有限</td><td>否</td></tr><tr><td>OpenAI Agents SDK</td><td>原生 Tool + Memory</td><td>否</td><td>否</td></tr></tbody></table>
<hr/>
<h4 data-id="heading-35">2. 能力维度对比</h4>





















































<table><thead><tr><th>能力维度</th><th>LangChain</th><th>LangGraph</th><th>DeepAgents</th><th>AutoGen</th><th>CrewAI</th></tr></thead><tbody><tr><td>LLM 抽象</td><td>强</td><td>中</td><td>中</td><td>中</td><td>弱</td></tr><tr><td>状态管理</td><td>弱</td><td>强</td><td>强</td><td>弱</td><td>弱</td></tr><tr><td>长任务</td><td>弱</td><td>强</td><td>极强</td><td>弱</td><td>中</td></tr><tr><td>子 Agent</td><td>弱</td><td>中</td><td>强</td><td>强</td><td>强</td></tr><tr><td>工程可靠性</td><td>中</td><td>强</td><td>强</td><td>弱</td><td>中</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-36">八、结论</h3>
<p>LangChain‑AI 提供的是一套 <strong>分层、可组合、工程友好的 Agent 技术体系</strong>：</p>
<ul>
<li><strong>LangChain</strong>：降低 Agent 开发门槛</li>
<li><strong>LangGraph</strong>：保证执行可靠性与可控性</li>
<li><strong>DeepAgents</strong>：实现长期自治与复杂任务处理</li>
</ul>
<p>在当前 Agent 技术生态中，该体系在 <strong>工程成熟度、可扩展性和长期任务支持</strong> 方面具备明显优势。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[地平线 征程 6 工具链入门教程 | 板端部署 UCP 使用指南]]></title>    <link>https://juejin.cn/post/7599586891085398050</link>    <guid>https://juejin.cn/post/7599586891085398050</guid>    <pubDate>2026-01-27T03:18:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599586891085398050" data-draft-id="7599690133117485090" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="地平线 征程 6 工具链入门教程 | 板端部署 UCP 使用指南"/> <meta itemprop="keywords" content="算法,自动驾驶"/> <meta itemprop="datePublished" content="2026-01-27T03:18:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="地平线开发者"/> <meta itemprop="url" content="https://juejin.cn/user/1257497032132567"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            地平线 征程 6 工具链入门教程 | 板端部署 UCP 使用指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1257497032132567/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    地平线开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T03:18:29.000Z" title="Tue Jan 27 2026 03:18:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读26分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1.前言</h2>
<p>在模型板端部署过程中，开发者主要关心图像如何获取，模型性能如何评测以及如何优化模型等问题。对于图像的获取，地平线提供了 Pyramid 硬件，其不但可以获取多尺寸图像，且利用内存共享机制可将内存给到 BPU 直接进行推理。针对耗时，内存占用，DDR 带宽占用等指标进行评测和优化，地平线提供了诸如 Trace，hrt_ucp_monitor 等一系列性能分析工具用于性能监测，使得开发者能够清晰掌握模型运行时的资源占用和硬件效率。最后，地平线提供 VP，HPL 以及 DSP 多种模块用于前后处理环节的算法开发。本文将结合实例说明模型如何进行部署，性能分析以及常见的问题解析。</p>
<h2 data-id="heading-1">2.UCP 简介</h2>
<p>征程 6 工具链在应用部署端新引入了统一计算平台（Unify Compute Platform，以下简称 UCP）。UCP 面向应用层，属于嵌入式应用开发（runtime）范畴，提供视觉处理（Vision Process，以下简称 VP）、模型推理（Neural Network，以下简称 NN）、高性能计算库（High Performance Library，以下简称 HPL）等功能。</p>
<p>UCP 还定义了一套统一的异构编程接口，支持对 SoC 上各后端硬件资源的调用，包括 BPU、DSP、ISP、GDC、STITCH、JPU、VPU、PYRAMID 等，以完成 SoC 上任务的统一调度。</p>
<p>UCP 的架构图如下所示：
<img src="http://openwrite.cn/uploads/19742/58988/396e652d-01cb-4bc6-9b18-c5ef0037c358.png" alt="MTI4MFgxMjgwICgxKQ==.png" loading="lazy"/>
<img src="http://openwrite.cn/uploads/19742/58988/108a080d-c0ec-4835-9979-72945f8f7a06.png" alt="1.png" loading="lazy"/></p>
<h2 data-id="heading-2">3.模型推理</h2>
<h3 data-id="heading-3">3.1 快速上手</h3>
<p>以下面的代码为例，说明 DNN 和 UCP 接口的使用方式，整体包含 5 个主要步骤，详细信息可参考用户手册《<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.oe.horizon.auto%2Fguide%2Fucp%2Fruntime%2Fruntime_dev.html" target="_blank" title="https://doc.oe.horizon.auto/guide/ucp/runtime/runtime_dev.html" ref="nofollow noopener noreferrer">统一计算平台-模型推理开发</a>》，《<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.oe.horizon.auto%2Fguide%2Fmodel_deployment_guidance%2Fmodel_deployment_guidance_examples%2Frgb_resnet18_deployment_guidance.html" target="_blank" title="https://doc.oe.horizon.auto/guide/model_deployment_guidance/model_deployment_guidance_examples/rgb_resnet18_deployment_guidance.html" ref="nofollow noopener noreferrer">模型部署实践指导-模型部署实践指导实例</a>》，《<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.oe.horizon.auto%2Fguide%2Fucp%2Fucp_api_reference%2Fucp_api_overview.html" target="_blank" title="https://docs.oe.horizon.auto/guide/ucp/ucp_api_reference/ucp_api_overview.html" ref="nofollow noopener noreferrer">UCP 通用 API 介绍</a>》等相关章节：
<img src="http://openwrite.cn/uploads/19742/58988/18bbfdd7-3286-4d07-985b-3eb0776a62b1.png" alt="2.png" loading="lazy"/></p>
<pre><code class="hljs language-Plain" lang="Plain">int main(int argc, char **argv) {
​  ...    // 解析命令行参数
​  hbDNNPackedHandle_t packed_dnn_handle;
​  hbDNNHandle_t dnn_handle;
​  const char **model_name_list;
​  auto modelFileName = FLAGS_model_file.c_str();
​  int model_count = 0;
​  
​  //1. 加载模型并获取模型名称列表以及Handle
​  {
​    hbDNNInitializeFromFiles(&amp;packed_dnn_handle, &amp;modelFileName, 1);
​    hbDNNGetModelNameList(&amp;model_name_list, &amp;model_count, packed_dnn_handle);
​    hbDNNGetModelHandle(&amp;dnn_handle, packed_dnn_handle, model_name_list[0]);
​  }

​  std::vector&lt;hbDNNTensor&gt; input_tensors;
​  std::vector&lt;hbDNNTensor&gt; output_tensors;
​  int input_count = 0;
​  int output_count = 0;
​  
​  //2. 根据模型的输入输出准备张量
​  {
​    hbDNNGetInputCount(&amp;input_count, dnn_handle)；
​    hbDNNGetOutputCount(&amp;output_count, dnn_handle)；
​    input_tensors.resize(input_count);
​    output_tensors.resize(output_count);
​    prepare_tensor(input_tensors.data(), output_tensors.data(), dnn_handle);
​  }
​  //3. 准备输入数据并填入到对应的张量中
​  read_image_2_tensor_as_nv12(FLAGS_image_file, input_tensors.data())；
​  // 确保更新输入后进行Flush操作以确保BPU使用正确的数据
​  for (int i = 0; i &lt; input_count; i++) {
​      hbUCPMemFlush(&amp;input_tensors[i].sysMem[0], HB_SYS_MEM_CACHE_CLEAN);
​    }
​    
​  //4. 创建任务并进行推理
​  hbUCPTaskHandle_t task_handle{nullptr};
​  hbDNNTensor *output = output_tensors.data();
​  {

​    hbDNNInferV2(&amp;task_handle, output, input_tensors.data(), dnn_handle);
​    hbUCPSchedParam ctrl_param;
​    HB_UCP_INITIALIZE_SCHED_PARAM(&amp;ctrl_param);
​    ctrl_param.backend = HB_UCP_BPU_CORE_ANY;
​    hbUCPSubmitTask(task_handle, &amp;ctrl_param);
​    hbUCPWaitTaskDone(task_handle, 0);
​  }
​    //5. 处理输出数据
​  for (int i = 0; i &lt; output_count; i++) {
​    hbUCPMemFlush(&amp;output_tensors[i].sysMem[0], HB_SYS_MEM_CACHE_INVALIDATE);
​  }

​  //6: 释放资源
​  {
​  
​    hbUCPReleaseTask(task_handle);
​    for (int i = 0; i &lt; input_count; i++) {
​      hbUCPFree(&amp;(input_tensors[i].sysMem[0]));
​    }
​    for (int i = 0; i &lt; output_count; i++) {
​      hbUCPFree(&amp;(output_tensors[i].sysMem[0]));
​    }
​    // 释放模型
​    hbDNNRelease(packed_dnn_handle);
​  }

​  return 0;
}
</code></pre>
<blockquote>
<p>⚠️ 上面的例子仅为 demo，实际使用时，需要注意以下几点：</p>
<ol>
<li>图像可以直接从 Pyramid 接口直接获取 nv12 的输出，无需进行拷贝，可直接传递给 BPU 进行推理</li>
<li>输入输出内存的大小和对齐 stride，详见第 5.3 节说明</li>
<li>接口进行返回值检查，以保证函数的正确执行</li>
</ol>
</blockquote>
<h3 data-id="heading-4">3.2 实用技巧</h3>
<h5 data-id="heading-5">3.2.1 添加 desc</h5>
<p>有的时候，为了方便自动化作业，需要给不同的模型，输入和输出打上标签以区分他们。</p>
<blockquote>
<p>需要注意的是，如果是为输入添加描述信息，由于 pyramid 和 resizer 节点会改变 bc 的输入节点数，因此需要给对应每个节点都添加对应的信息。</p>
</blockquote>
<p>比较推荐的做法是在 compile 之前再添加：</p>
<pre><code class="hljs language-Plain" lang="Plain">from hbdk4.compiler import load
quantized_bc = load("xxx.bc")
func = quantized_bc[0]
func.desc = "xxx model" #模型的描述
func.inputs[0].desc = "xxx input" #模型输入的描述
func.outputs[0].desc = "xxx output" #模型输出的描述
</code></pre>
<p>模型部署时，通过下面的接口来获取描述信息：</p>
<pre><code class="hljs language-Plain" lang="Plain">//模型的描述信息
int32_t hbDNNGetModelDesc(char const **desc, uint32_t *size, int32_t *type,
​                          hbDNNHandle_t dnnHandle);
//输入的描述信息
int32_t hbDNNGetInputDesc(char const **desc, uint32_t *size, int32_t *type,
​                          hbDNNHandle_t dnnHandle, int32_t inputIndex);
//输出的描述信息
int32_t hbDNNGetOutputDesc(char const **desc, uint32_t *size, int32_t *type,
​                           hbDNNHandle_t dnnHandle, int32_t outputIndex);
</code></pre>
<h5 data-id="heading-6">3.2.2 模型打包</h5>
<p>模型打包功能，可以将多个模型打包进一个 hbm 文件中，对于共享任务可以节省模型的空间，具体 api 介绍可见《<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.oe.horizon.auto%2Fguide%2Fadvanced_content%2Fhbdk_api_reference.html%23linkhbo_list-listhbo-output_path-str-desc-optionalstr--none" target="_blank" title="https://docs.oe.horizon.auto/guide/advanced_content/hbdk_api_reference.html#linkhbo_list-listhbo-output_path-str-desc-optionalstr--none" ref="nofollow noopener noreferrer">HBDK Tool API Reference</a>》：</p>
<pre><code class="hljs language-Plain" lang="Plain">from horizon_plugin_pytorch.quantization.hbdk4 import export
from hbdk4.compiler import load, convert, compile, link
# export 阶段记得配置 name
qat_bcA = export(qat_model_A, example_input, name="backbone_head1_head2")
quantized_modelA = convert(qat_bcA, "nash-m")
# 注意：此时compile生成的模型后缀名为.hbo
hbo_nameA = "nameA_compiled.hbo"
hboA = compile(quantized_modelA, path=hbo_nameA, march="nash-m")

qat_bcB = export(qat_model_B, example_input, name="backbone_head1")
quantized_modelB = convert(qat_bcB, "nash-m")
hbo_nameB = "nameB_compiled.hbo"
hboB = compile(quantized_modelB, path=hbo_nameB, march="nash-m", opt=2)

# link生成打包模型，后缀名为.hbm
hbm_name = "compiled.hbm"
hbm = link([hboA, hboB], hbm_name)
</code></pre>
<p>在生成 hbm 文件后，上板运行使用 hrt_model_exec 查看模型可以看到：
<img src="http://openwrite.cn/uploads/19742/58988/80aea833-2274-452b-af88-58beb3346295.png" alt="4.png" loading="lazy"/></p>
<p>推理测试时，用 model_file 指定 hbm 路径，model_name 指定具体哪一个模型
<img src="http://openwrite.cn/uploads/19742/58988/684f08ab-5865-4c03-a720-e75424a1c5cc.png" alt="5.png" loading="lazy"/></p>
<h5 data-id="heading-7">3.2.3 小模型批处理</h5>
<p>由于 BPU 为资源独占型硬件，对于那些耗时较短的小模型，其框架调度耗时开销可能大于其模型运行时间，为了缓解这个问题。在征程 6 平台，UCP 支持通过复用 task_handle 方式来一次将多个模型下发，全部执行完成后再一次性返回，从而将 N 次开销合并为一次：</p>
<pre><code class="hljs language-Plain" lang="Plain">// 获取模型指针并存储
std::vector&lt;hbDNNHandle_t&gt; model_handles;

// 准备各个模型的输入输出，准备过程省略
std::vector&lt;std::vector&lt;hbDNNTensor&gt;&gt; inputs;
std::vector&lt;std::vector&lt;hbDNNTensor&gt;&gt; outputs;

// 创建任务并进行推理
{
    // 创建并添加任务，复用task_handle
    hbUCPTaskHandle_t task_handle{nullptr};
    for(size_t task_id{0U}; task_id &lt; inputs.size(); task_id++){
        hbDNNInferV2(&amp;task_handle, outputs[task_id].data(), inputs[task_id].data(), model_handles[i]);
    }
    
    // 提交任务
    hbUCPSchedParam sche_param;
    HB_UCP_INITIALIZE_SCHED_PARAM(&amp;sche_param);
    sche_param.backend = HB_UCP_BPU_CORE_ANY;
    hbUCPSubmitTask(task_handle, &amp;sche_param);
    
    // 等待任务完成
    hbUCPWaitTaskDone(task_handle, 0);
}
</code></pre>
<h5 data-id="heading-8">3.2.4 优先级抢占</h5>
<p>在征程 6 计算平台上，BPU 硬件本身没有抢占功能，对于一个计算任务其一旦进入 BPU 后，就无法被打断，其他计算任务只能等待当前计算任务完成退出后才能运行。</p>
<p>此时很容易出现 BPU 计算资源被一个大模型任务独占，进而影响其他高优先级模型任务的执行，针对这个问题，工具链采用 cpu 调度的机制来优化 BPU 资源：</p>
<ol>
<li>hbm 模型在 BPU 推理表现为一个或多个 function-call，function-call 为 BPU 最小的执行单元。当一个模型的所有 function-call 都执行完成时，这个模型也就执行完成了</li>
<li>BPU 模型任务抢占粒度设计为 function-all，如果一个模型只有一个 function-call 那么其无法被抢占，如果一个模型有多个 function-call 可能出现这个模型完成部分 function-call 后，BPU 挂起当前模型，然后切换执行其他模型</li>
</ol>
<p>UCP 支持任务优先级调度和抢占，可通过 hbUCPSchedParam 结构体进行配置：</p>
<pre><code class="hljs language-Plain" lang="Plain">typedef struct hbUCPSchedParam {int32_t priority;int64_t customId;uint64_t backend;uint32_t deviceId;} hbUCPSchedParam;
</code></pre>
<ul>
<li>priority：任务优先级，支持[0， 255]之间的数值，对于模型任务而言：
<ul>
<li>[0， 253]普通优先级，不可抢占其他任务，但在未执行时支持按优先级进行排队</li>
<li>254：为 high 优先级，支持抢占普通任务</li>
<li>255：为 urgent 优先级，支持抢占普通任务和 high 任务</li>
<li>可被中断抢占的任务，需要在模型编译阶段配置 max_time_per_fc 进行模型拆分</li>
</ul>
</li>
<li>customId：自定义优先级</li>
<li>backend：任务硬件 id</li>
<li>deviceId：设备 ID 比如，有下面的两个模型，一个单线程耗时 20.9 ms，一个单线程耗时 8.3ms：
<img src="http://openwrite.cn/uploads/19742/58988/c9f831e7-6a61-4980-8d13-3e548a95644c.png" alt="6.png" loading="lazy"/></li>
</ul>
<p>让这两个模型同时运行，且设置 max_time_per_fc=2000，两个模型的优先级均为普通优先级时 UCP trace 耗时如下：
<img src="http://openwrite.cn/uploads/19742/58988/f4b19477-404d-4c35-a895-fac90a360b25.png" alt="7.png" loading="lazy"/></p>
<p>当将模型 2 的优先级设为 high，模型 1 仍为普通优先级时：
<img src="http://openwrite.cn/uploads/19742/58988/7b9c2da1-97a7-4dd3-96af-c467ab49d566.png" alt="8.png" loading="lazy"/></p>
<p>可以看到，在下面的模型一次 infer 过程中，模型被切分为多个 2ms 运行的 function-call 运行，中间插入了很多 high 优先级模型，导致一次模型前向耗时大大增加。</p>
<h5 data-id="heading-9">3.2.5 LRU 内存优化</h5>
<p>LRU（Least Recently Used）算法是用于优化内存页的调度算法。BPU 内存在 BPU 实际使用前，NN 模块内部需要对该块内存进行特殊处理才能够正常使用，如果频繁对模型及其依赖申请释放会导致 CPU 负载变大，从而可能会引发性能问题。 如果确实有频繁申请释放的需求，推理库提供了内存 LRU 缓存功能，通过设置环境变量 <code>HB_NN_ENABLE_MEM_LRU_CACHE</code> 为 <code> </code>​<code>true</code> 来使用。设置方式如下：</p>
<pre><code class="hljs language-Plain" lang="Plain">export HB_NN_ENABLE_MEM_LRU_CACHE=true
</code></pre>
<p>开启了这个功能之后，对模型的输入输出不是实时申请和释放的，会在一开始就申请好并进行循环复用。所以如果用户在模型跑完推理后就立刻执行内存释放操作，实际不会立刻释放，UCP 这一层会等一段时间后才执行（默认至少 1s），所以可能会有内存泄漏的风险，建议是模型推理的内存块不要释放，且模型每次输入输出的虚拟地址是复用的。</p>
<h3 data-id="heading-10">3.3 输入输出处理</h3>
<h5 data-id="heading-11">3.3.1 Crop 裁剪</h5>
<p>Crop 主要思想是利用地址偏移，并通过 stride 将图像多余的部分进行屏蔽从而送入准备好的模型输入。这种 Crop 方式不引入 memory copy，减少 IO 开销。</p>
<p>限制：</p>
<ol>
<li>图像输入大小要大于模型实际输入大小，w_stride 要 32（E/M）/64（P/H）字节对齐</li>
<li>模型的 validShape 为固定值，stride 为动态值</li>
<li>裁剪偏移的输入首地址要 32 对齐</li>
</ol>
<p>详细示例可以参考《<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.oe.horizon.auto%2Fguide%2Fucp%2Fruntime%2Fbasic_sample.html" target="_blank" title="https://doc.oe.horizon.auto/guide/ucp/runtime/basic_sample.html" ref="nofollow noopener noreferrer">基础示例包使用说明</a>》中 advanced_samples 的 crop 示例</p>
<h5 data-id="heading-12">3.3.2 Resizer</h5>
<p>Resizer 主要是指具有 nv12 图像输入和 ROI 输入的模型，编译器支持通过 JIT 动态指令的方式，从 nv12 图像上完成抠图 +Resize 功能。其不仅仅是图像 stride 为动态，输入的 H，W 也为动态，w_stride 也同样需要满足 32（E/M）/64（P/H）字节对齐，roi 不需要进行对齐：
<img src="http://openwrite.cn/uploads/19742/58988/4d59b35e-4e7f-467d-a49f-c198c5fe73d0.png" alt="9.png" loading="lazy"/>
<img src="http://openwrite.cn/uploads/19742/58988/a093ae29-d2cb-4e12-821a-ac2d293e453c.png" alt="10.png" loading="lazy"/></p>
<h5 data-id="heading-13">3.3.3 图像 tensor 对齐</h5>
<p>在征程 6 芯片，有一块叫 Pyramid 的金字塔硬件处理模块，可提供 Camera 输入图像的缩放及 ROI 抠图能力，其输出为 nv12 类型的图像数据，并可基于共享内存机制直接给到 BPU 进行模型推理，因此在征程 6 工具链中：</p>
<ul>
<li>Pyramid 模型是指具有 nv12 图像输入的模型</li>
<li>Resizer 模型指的是具有 nv12 图像输入和 ROI 输入的模型，编译器支持通过 JIT 动态指令的方式，从 nv12 图像上完成 ROI 抠图 +Resize 功能 征程 6P/H 要求 nv12 stride 满足 64 对齐，征程 6E/M/B 是 32 对齐。 Pyramid 的输入 stride 为动态，比如模型输入为 224x224 的 nv12 图像，其格式为：
<img src="http://openwrite.cn/uploads/19742/58988/f727804a-75ff-4121-9b1b-e575ce6465b5.png" alt="11.png" loading="lazy"/></li>
</ul>
<p>其中，-1 为占位符，表示为动态，Pyramid 输入的 stride 为动态。那么此时我们就需要通过手动计算方式来获取了：</p>
<pre><code class="hljs language-Plain" lang="Plain">#define ALIGN_SIZE(size,align_byte) (((size)+(align_byte-1))&amp;~(align_byte-1))
HBDNNTensor* input;
auto dim_len = input[i].properties.validShape.numDimensions;
for(int dim_i = dim_len-1;dim_i&gt;=0;dim_i--){
​    if(input[i].properties.stride[dim_i]==-1){
​        auto cur_stride = input[i].properties.stride[dim_i+1] * 
​            input[i].properties.validShape.dimensionSize[dim_i+1];
​        input[i].properties.stride[dim_i] = ALIGN_SIZE(cur_stride,NUM);
​    }  
}
int input_memSize = input[i].properties.stride[0] * input[i].properties.validShape.dimensinoSize[0];
</code></pre>
<p>对于非 nv12 类型的其他输入，以 rgb 输入 <code>input</code> 作为例子，1x224x224x3 的 rgb 图像如下所示：
<img src="http://openwrite.cn/uploads/19742/58988/91664c52-aa6d-4ed4-9129-3a2e17bab12b.png" alt="12.png" loading="lazy"/></p>
<p>输入申请的大小可以通过 aligned byte size 来获取：</p>
<pre><code class="hljs language-Plain" lang="Plain">int input_memSize = input[i].properties.alignedByteSize;
</code></pre>
<h5 data-id="heading-14">3.3.4 内存单元对齐</h5>
<p>BPU 中的内存单元也是遵循向量化对齐的原则，类似于 avx/neon 等，需要内存对齐。所以对于不满足对齐最小字节的内存要被强制对齐到最小的内存字节上。</p>
<p>征程 6H/P tensor 最小申请内存是 256 字节，征程 6E/M 是 64 字节，征程 6B 是 128 字节，这个差异会体现在模型的 aligned byte size 和 stride 属性上。</p>
<p>举个例子：
<img src="http://openwrite.cn/uploads/19742/58988/f4357e65-78ea-408c-8f79-293cbca80d3b.png" alt="13.png" loading="lazy"/></p>
<p>上面模型的 stride=4000，<code>output</code> 需要申请的内存为 4000Byte，但由于内存需要对齐，所以实际上的需要申请的内存大小为（（4000+（256-1））&amp;～（256-1））=4096Byte。 在模型实际部署中，非图像输入/输出节点所需申请的内存大小均可以从模型节点属性的结构体中读取到，因此无需特别关注：</p>
<pre><code class="hljs language-Plain" lang="Plain">hbDNNTensor* output;
int output_memSize = output[i].properties.alignedByteSize;
</code></pre>
<h5 data-id="heading-15">3.3.5 padding</h5>
<p>由于内存单元对齐的影响，feature 申请的大小和拷贝需要根据 stride 和 alignedByteSize 来进行。用户侧需要手动处理这些 padding，可能对前处理和后处理的代码有较大的变动。这里地平线提供了一种优化方案：input_no_padding/ouput_no_padding，在开启这两个选项后，可以直接将输入/出实际大小的内存送入接口，接口内部会自行处理对齐，无需用户侧修改代码。但开启这个参数后，可能会对模型延时产生微小影响。</p>
<ul>
<li>input_no_padding：对所有非图像的输入去 padding</li>
<li>output_no_padding：对模型所有的输出去 padding 若编译时配置了 input_no_padding=True，output_no_padding=True，无需关注非图像的对齐问题：</li>
</ul>
<pre><code class="hljs language-Plain" lang="Plain">#PTQ配置方式，在yml中
compiler_parameters:
    extra_params: {"input_no_padding": True, "output_no_padding": True}

#QAT配置方式
from hbdk4.compiler import compile
compile(quantized_bc,march,path,input_no_padding=True,output_no_padding=True)
</code></pre>
<p>举个例子，比如一个模型的输出 shape 为 1x21x21x255，其 output_no_padding=False 和 output_no_padding=True 的结果如下图所示：
<img src="http://openwrite.cn/uploads/19742/58988/fe4eb590-b54e-4300-a56c-8c5df7abfbea.png" alt="14.png" loading="lazy"/></p>
<h2 data-id="heading-16">4.性能分析</h2>
<h3 data-id="heading-17">4.1 模型性能分析</h3>
<p>如果开发者没有实体板子，只有 hbm 模型，可以使用 hbdk4 中的 hbm_perf 接口获取静态性能评估文件（html，json 格式）以及模型耗时：</p>
<pre><code class="hljs language-Plain" lang="Plain">from hbdk4.compiler import hbm_perf
hbm_perf(xxx.hbm)
</code></pre>
<blockquote>
<p>模型中如果有 CPU 算子，则会影响 perf 的结果，建议去除 CPU 算子之后再进行分析。CPU 算子一般可以通过以下两种方式查看到：</p>
<ol>
<li>convert 之后的模型可视化，然后查询是否有 hbtl 类型算子</li>
<li>利用 statistics 接口统计 bc 模型算子类型</li>
</ol>
</blockquote>
<p>如果有与开发环境直连的板子可以使用下面的方式进行测试，与实测偏差会更小：</p>
<pre><code class="hljs language-Plain" lang="Plain">from hbdk4.compiler import hbm_perf
hbm_perf(xxx.hbm,remote_ip="xxx")
</code></pre>
<p>或按照用户手册《<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.oe.horizon.auto%2Fguide%2Fucp%2Fruntime%2Ftool_introduction%2Fhrt_model_exec.html" target="_blank" title="https://doc.oe.horizon.auto/guide/ucp/runtime/tool_introduction/hrt_model_exec.html" ref="nofollow noopener noreferrer">统一计算平台-模型推理工具介绍</a>》使用 hrt_model_exec 工具在板端进行性能测试：</p>
<pre><code class="hljs language-Plain" lang="Plain">hrt_model_exec perf --model_file=xxx.hbm --frame_count=200
</code></pre>
<h5 data-id="heading-18">4.1.1 带宽占用</h5>
<p>静态评测时，带宽信息可以从模型编译过程中生成的 xxx.html/xxx.json 中文件获取，在 ptq 中会自动生成这两个文件，在 qat 中，可以通过生成 hbm 模型后，使用 hbm_perf 接口来生成这两个文件。</p>
<p><strong>平均带宽</strong></p>
<p>平均带宽（GB/s） = DDR bytes per second（ for n FPS）/n * 设计帧率/2^30，以下面的模型为例，实际需求帧率为 30FPS，那么该模型所需的平均带宽为：12293553099/57.12 * 30/2^30 = 6.01GB/s：
<img src="http://openwrite.cn/uploads/19742/58988/2914e0cf-663a-4fa1-af17-e70683a25873.png" alt="15.png" loading="lazy"/></p>
<p><strong>峰值带宽</strong></p>
<p>峰值带宽可以通过推理带宽柱状图来进行分析，最高的柱子即最大的 load/strore 带宽。比如下面这个图，该模型的最大 load 需求为 15515MB/s=15.15GB/s，最大的 store 需求为 13125MB/s=12.82GB/s，最大的 load+store 需求为 11954+11812=23766MB/s=23.21GB/s
<img src="http://openwrite.cn/uploads/19742/58988/67604e02-2cb4-451f-9ead-e3c1553d06a2.png" alt="16.png" loading="lazy"/></p>
<h5 data-id="heading-19">4.1.2 带宽优化</h5>
<p>在实际应用中，模型的推理耗时可能出现比正常评测要更长的现象，主要原因往往来源于 BPU 的等待耗时以及带宽资源不足的影响。这里主要针对带宽问题进行说明。</p>
<p>BPU 模型的带宽消耗主要集中在模型加载、推理时的 featuremap 读写，输出写回，优化策略如下：</p>
<ol>
<li>使用 balance 参数来平衡带宽和延时</li>
</ol>
<pre><code class="hljs language-Plain" lang="Plain">compile(balance=x) # 0=优先ddr优化，100=优先延迟优化，默认balance=100,推荐balance=2
</code></pre>
<p>ptq 时，修改配置文件中的 compile_mode:</p>
<pre><code class="hljs language-Plain" lang="Plain">compile_mode: 'balance'
balance_factor: 2
</code></pre>
<ol start="2">
<li>对于小模型使用多 batch 推理模式，可以减少 weight 的加载次数</li>
<li>减少模型抢占调用：优先级 255 的抢占任务会刷新整个 SRAM，导致大量带宽开销，建议通过任务编排方式运行模型，而不是优先级抢占</li>
<li>Batch 拆分：若模型需要 concat 多路输入（比如 BEV 类模型），将 batch mode 拆分，每一路单独提取特征，牺牲很少的延时来降低峰值带宽</li>
</ol>
<h5 data-id="heading-20">4.1.3 内存占用</h5>
<p>模型所需的内存可以通过 Summary 查看到：
<img src="http://openwrite.cn/uploads/19742/58988/01ad9f5c-e112-4831-ad5b-4d41318cc003.png" alt="17.png" loading="lazy"/>
<img src="http://openwrite.cn/uploads/19742/58988/cf5213a0-3e49-4b1b-9c3d-54d2c3ed5489.png" alt="18.png" loading="lazy"/></p>
<blockquote>
<p>Shared temporary memory 共享临时内存，主要目的是用于相同优先级模型共享内存，优化模型推理内存的使用。对于相同优先级的模型，会共享 temporary memory。该功能的约束条件：</p>
<ol>
<li>跨 BPU Core 不可用</li>
<li>跨优先级不可用，0-253 的优先级之间的都可以共享，254 只能和其他 254 共享，255 只能与其他 255 共享</li>
<li>跨进程不可用</li>
</ol>
</blockquote>
<p>当开发人员对模型运行时所需内存进行评测时，可先通过 Summary 的内容先进行静态数据评估，模型的内存占用=Static Memory + Dynamic Memory。</p>
<h3 data-id="heading-21">4.2 动态性能分析</h3>
<p>在模型的部署和运行过程中，我们比较关注模型的推理耗时，bpu/cpu 占用，DDR 读写带宽以及内存占用。这些信息可以通过以下工具来获取：</p>
<h5 data-id="heading-22">4.2.1 hrt_model_exec</h5>
<p>hrt_model_exec 是一个模型执行工具，可直接用于在开发板上评测模型的推理性能，获取模型信息。工具源码路径在 samples/ucp_tutorial/tools/hrt_model_exec。</p>
<p>模型输入输出信息：</p>
<pre><code class="hljs language-Plain" lang="Plain">hrt_model_exec model_info --model_file xxx.hbm
</code></pre>
<p><img src="http://openwrite.cn/uploads/19742/58988/908c8dbe-e543-49bb-bd8e-bbeda25d86ff.png" alt="19.png" loading="lazy"/></p>
<p>模型单线程耗时：</p>
<pre><code class="hljs language-Plain" lang="Plain">hrt_model_exec perf --model_file xxx.hbm --frame_count 1000 --thread_num 1
</code></pre>
<p><img src="http://openwrite.cn/uploads/19742/58988/b401a124-6f87-4847-a8bd-55d4f748f9c7.png" alt="20.png" loading="lazy"/></p>
<p>模型多线程耗时：</p>
<pre><code class="hljs language-Plain" lang="Plain">hrt_model_exec perf --model_file xxx.hbm --frame_count 1000 --thread_num 4
</code></pre>
<p><img src="http://openwrite.cn/uploads/19742/58988/22305e7a-85e9-41a9-adf9-7447cce802b0.png" alt="21.png" loading="lazy"/></p>
<p>指定优先级运行：</p>
<pre><code class="hljs language-Plain" lang="Plain">hrt_model_exec perf --model_file xxx.hbm --frame_count 1000 --thread_num 1 --task_priority 1
</code></pre>
<p>更多的 hrt_model_exec 命令可以在《<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.oe.horizon.auto%2Fguide%2Fucp%2Fruntime%2Ftool_introduction%2Fhrt_model_exec.html" target="_blank" title="https://doc.oe.horizon.auto/guide/ucp/runtime/tool_introduction/hrt_model_exec.html" ref="nofollow noopener noreferrer">统一计算平台-模型推理工具介绍-hrt_model_exec</a>》中查看。</p>
<h6 data-id="heading-23">4.2.1.1 单线程和多线程差异</h6>
<p>在单线程下，工具按照单核单线程的串行逻辑运行，统计的性能可以理解为单帧处理的平均时间（包括调度开销，BPU 执行时间以及 CPU 执行时间）。</p>
<p>在多线程下，工具会启动多个线程进行模型推理，统计得到的 FPS 表示充分使用资源情况下模型的吞吐量，主要用于评测高并发情况下的模型处理能力。</p>
<ul>
<li>为什么单线程模型运行耗时比多线程耗时短？ 答：由于 BPU 本身是一种独占硬件，同一时间只能运行一个任务，多个线程同时提交任务时，只能按一定顺序执行，因此多线程模式下，模型的 Latency 耗时的增大，主要来源于任务下发后的等待时间。</li>
</ul>
<h5 data-id="heading-24">4.2.2 hrt_ucp_monitor</h5>
<p>工具 hrt_ucp_monitor 是一个关于监控硬件 IP 占用率和内存信息的工具。hrt_ucp_monitor 工具位于 samples/ucp_tutorial/tools 中。 hrt_ucp_moitor 支持的内存信息包括 DDR 读写带宽，ION 内存，进程内存，默认为每秒采样 500 次，详细的运行参数请参考《<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.oe.horizon.auto%2Fguide%2Fucp%2Fucp_tools%2Fucp_monitor.html" target="_blank" title="https://doc.oe.horizon.auto/guide/ucp/ucp_tools/ucp_monitor.html" ref="nofollow noopener noreferrer">统一计算平台-UCP 性能分析工具</a>》。在终端运行命令 hrt_ucp_monitor 即可看到对应的监控信息：
<img src="http://openwrite.cn/uploads/19742/58988/67f980e4-3523-4954-8c25-d72501c31c94.png" alt="22.png" loading="lazy"/></p>
<p>rss 查看可以通过以下命令查看：</p>
<pre><code class="hljs language-Plain" lang="Plain">ps -aux //RSS指标
top //RES指标
</code></pre>
<p><img src="http://openwrite.cn/uploads/19742/58988/6007dc35-c364-493d-b72b-f8134c75ca1c.png" alt="23.png" loading="lazy"/><img src="http://openwrite.cn/uploads/19742/58988/a357a889-f42b-4432-b9f0-7769c9b12a6f.png" alt="补24.png" loading="lazy"/></p>
<p>HBMEM 为应用进程申请的总 ION 大小：</p>
<blockquote>
<p>ION：ION 是为了解决内存碎片化而引入的通用内存管理器，一共有三种：ion（上面的 ion_cam），reserve（上面的 cma_reserved）和 carveout（上面的 carveout）。ion 是主要类型，用于一般的内存分配。reserve 本质上也是 carveout，区分的主要目的是 DDR 支持多个 bank。对于 BPU 模型来说，其优先在 carveout 上分配内存。可以通过观察 /sys/kernel/debug/ion/heaps/carveout 来测试内存占用：</p>
<p><img src="http://openwrite.cn/uploads/19742/58988/a7a70b0b-f023-4203-a60c-456067f23d6e.png" alt="24.png" loading="lazy"/></p>
<p>上图为未加载时，carveout 的状态</p>
<p>!<img src="http://openwrite.cn/uploads/19742/58988/1362c942-0c6f-4378-bcc7-ed4562097733.png" alt="25.png" loading="lazy"/></p>
<p>模型加载后，carveout 的状态</p>
</blockquote>
<h5 data-id="heading-25">4.2.3 hrut_ddr</h5>
<p>带宽占用主要使用 hrut_ddr 来进行分析：</p>
<pre><code class="hljs language-Plain" lang="Plain">Usage: hrut_ddr [OPTION]...
Show and calculate memory throughput through AIX bus in each period.

Mandatory arguments to long options are mandatory for short options too.
   -t, --type     The type of monitoring range.    Supported
                  values for type are(case-insensitive)
                  when multiple type specified, Enclose in quotation marks 
                  e.g. -t "mcu cpu"
                  If the types exceeds 1, a RoundRobin method is used.
                       For accuracy, set as less types as possible
                  e.g. In the first period the mcu data is read, second period the cpu data is read. 
                  The elapsed time get averaged, and each type result in one round put into one table 
                     slc  vdo  cam  cpe0  cpe1  cpe2  cpe3  cpelite  
                   idu  gpu  vdsp  peri  his  sram  bpu_p0  bpu_p1 
                   bpu_p2  mcu  cpu  secland 
                  cpu        only monitor the throughput of CPU master range
                  bpu        only monitor the throughput of BPU master range
                  cam        only monitor the throughput of Camera master range
                  J6P Note: cam contains cpe, cpelite, idu. bpu id range: bpu_p0, bpu_p1(only in vm), bpu_p2(only in vm)
                  rr_all     RoundRobin between all range types
   -p, --period   The sample period for monitored range. (unit: us, default: 1000, range:[1000, 2000000])
   -d, --device   The char device of DDR Perf Monitor. [0~5] 0: ddrsys0 mon0, 2 ddrsys1_mon0
                   J6P: [0~15]
   -n, --number   The sampling period times for monitored range before copying to userspace. (0~400] default: 100
                  !!!When in roundrobin mode, this is forcely set to 1
   -N, --over_all Over_all read times. i.e. Approximately how much tables you get in commands line
   -f, --filename the csv output filename
   -r, --raw      Output raw data, hexadecimal format, without conversion. Decimal by default
   -c, --csv      Output csv format data
   -D, --dissh    Disable shell output
Example:
hrut_ddr -t cpu -p 1000 -d 0
hrut_ddr -t cpu -p 1000 -r
hrut_ddr -t cpu -p 1000
hrut_ddr -t "cpu mcu" -p 1000 -c -f "mon0.csv"
hrut_ddr -d "0 1" -p 1000
</code></pre>
<p>根据 hrut_ddr 工具的 log，获取 BPU 带宽占用和系统带宽占用，Read+Write 的值即为总带宽：
<img src="http://openwrite.cn/uploads/19742/58988/df6c9647-6ebc-4222-8e82-fc8ec6fd502a.png" alt="26.png" loading="lazy"/></p>
<h3 data-id="heading-26">4.3 问题</h3>
<p>在实际的运行中，可能会出现与上面带宽评测结果差距较大的情况。这是由于在实际中不仅仅是模型的运行需要带宽，cam 和 cpu 也是需要带宽的。根据过往的经验，可以根据峰值带宽和均值带宽来提前判断是否存在风险，高于理论带宽的 75% 以上，就需要进行测试验证了。</p>
<h2 data-id="heading-27">5.推理典型问题处理</h2>
<h3 data-id="heading-28">5.1 timeout 问题</h3>
<h6 data-id="heading-29">5.1.1 模型 timeout 时间是否设置合理</h6>
<p>如果模型是异步推理的，模型本身执行的时间较长，而异步等待接口设置的超时时间不足也可能造成 timeout。</p>
<pre><code class="hljs language-Plain" lang="Plain">hbUCPWaitTaskDone(hbUCPTaskHandle_t taskHandle, int32_t timeout);
</code></pre>
<p>timeout 的耗时可以设置为模型正常推理时间的一倍即可。</p>
<h6 data-id="heading-30">5.1.2 CPU 负载是否过高</h6>
<p>由于模型的运行调度是由 CPU 来处理的，如果调度线程一直获取不到时间片，即使任务完成也无法及时同步到用户接口，导致推理延时。</p>
<p>在运行过程中，可以使用 top/htop 等监视 CPU 利用率，如果 CPU 负载超过 90%，可能出现系统异常，这个必须得到解决</p>
<h6 data-id="heading-31">5.1.3 内存泄漏</h6>
<p>当存在内存泄漏时，在系统内存不足的情况下，内存申请缓慢，可能会导致推理超时。可以在编译时添加检测：</p>
<pre><code class="hljs language-Plain" lang="Plain">target_compile_options(testbed PRIVATE -fsanitize=address)
target_link_options(testbed PRIVATE -fsanitize=address)
</code></pre>
<p>或在单元测试时，利用 getpid（）获取当前进程的 pid，再查看/proc/pid/status 中的 VmRSS。</p>
<h3 data-id="heading-32">5.2 推理 hang</h3>
<p>模型指令原因导致的底层运行错误，错误没有上报，导致 hang 住。此时，可通过 <code>cat/sys/devices/system/bpu/bpu0/task_running</code> 对 bpu 任务情况进行查看，如下图所示：<img src="http://openwrite.cn/uploads/19742/58988/2306ac36-3b0e-4b36-8276-bc7669e04f2b.png" alt="27.png" loading="lazy"/></p>
<p>s_time 不为空表示任务已经正常开始，而 p_time 一直增加没有减少，即可认为 BPU 任务 hang 住了， 可以使用 watch 命令来记录 bpu 任务情况：</p>
<pre><code class="hljs language-Plain" lang="Plain">watch -n 2 'cat /sys/devices/system/bpu/bpu0/task_running|tee -a bpu.log'
</code></pre>
<p>如果发生此类问题，可以提供 bpu log 给地平线技术支持人员分析，log 的地址在：/log/bpux/message 中。</p>
<h3 data-id="heading-33">5.3 log 获取</h3>
<p>在遇到上面的问题的时候，我们可以通过分析日志来获取问题原因，需要的是 UCP 日志以及系统日志：</p>
<h5 data-id="heading-34">5.3.1 UCP 日志</h5>
<p>在程序运行时可以看到各种 log 的等级：
<img src="http://openwrite.cn/uploads/19742/58988/04e36eb0-dd41-4658-a762-116b98ff4356.png" alt="28.png" loading="lazy"/></p>
<p>在发生上面的问题后，为了获取具体的问题原因，可以修改 log 等级来抓取不同等级的日志，配置方式如下：</p>
<p>UCP log 设置主要通过以下环境变量：</p>
<ul>
<li>HB_UCP_LOG_LEVEL：ucp 模块 log 等级（等级从 0 到 6，分别为 trace， debug， info， warn， error， critical， never， 默认为 warn）</li>
<li>HB_NN_LOG_LEVEL：nn 模块 log 等级</li>
<li>HB_UCP_LOG_PATH: ucp 日志存储路径</li>
</ul>
<pre><code class="hljs language-Plain" lang="Plain">export HB_UCP_LOG_LEVEL=3
export HB_UCP_LOG_PATH=xxx
</code></pre>
<p>更详细的环境变量和说明可以参考《<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.oe.horizon.auto%2Fguide%2Fucp%2Fucp_api_reference%2Fucp_environment_variable.html" target="_blank" title="https://doc.oe.horizon.auto/guide/ucp/ucp_api_reference/ucp_environment_variable.html" ref="nofollow noopener noreferrer">统一计算平台-UCP 通用 API 介绍-环境变量</a>》</p>
<h5 data-id="heading-35">5.3.2 系统日志</h5>
<p>系统日志获取：</p>
<p>dmesg：在 Linux 系统中用于显示或控制内核环形缓冲区的内容更，允许查看或操作内核消息。</p>
<pre><code class="hljs language-Plain" lang="Plain">dmesg &gt;dmesg.log
</code></pre>
<p>logcat：可以用于打印设备的系统日志</p>
<pre><code class="hljs language-Plain" lang="Plain">logcat &gt;logcat.log
</code></pre>
<h2 data-id="heading-36">6.UCP Trace 使用</h2>
<p>征程 6 算法工具链提供了一套板端实测性能工具 UCP Trace，通过在 UCP 执行的关键路径上嵌入 trace 记录，进而深入分析 UCP 应用调度逻辑，具体可以参考《<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.oe.horizon.auto%2Fguide%2Fucp%2Fucp_tools%2Fucp_trace.html" target="_blank" title="https://doc.oe.horizon.auto/guide/ucp/ucp_tools/ucp_trace.html" ref="nofollow noopener noreferrer">统一计算平台-UCP 性能分析工具</a>》一节。 UCP Tracer 记录点：UCP 记录点包括任务 trace 记录点和算子 trace 记录点
<img src="http://openwrite.cn/uploads/19742/58988/410bb904-c8f6-438c-9a2d-9d69ce7cb275.png" alt="29.png" loading="lazy"/></p>
<h3 data-id="heading-37">6.1 in_process 模式</h3>
<h6 data-id="heading-38">6.1.1 运行实例</h6>
<p>in_process 模式下只能抓取 UCP 进程内的 trace，无需启动 prefetto 的后台进程</p>
<p>启动步骤：</p>
<pre><code class="hljs language-Plain" lang="Plain">export HB_UCP_PERFETTO_CONFIG_PATH=ucp_in_process.json
export HB_UCP_ENABLE_PERFETTO=true
</code></pre>
<ul>
<li>ucp_in_process.json</li>
</ul>
<pre><code class="hljs language-Plain" lang="Plain">{
​  "backend": "in_process",    #backend可选
​  "trace_config": "ucp_in_process.cfg"   #perfetto的配置文件路径，仅在in_process下有效
}
</code></pre>
<ul>
<li>ucp_in_process.cfg</li>
</ul>
<pre><code class="hljs language-Plain" lang="Plain"># Enable periodic flushing of the trace buffer into the output file.
write_into_file: true

# Output file path
output_path: "ucp.pftrace"    #保存trace文件的路径

# Sampling duration: 10s
duration_ms: 10000          #0表示持续抓取

# Writes the userspace buffer into the file every 2.5 seconds.
file_write_period_ms: 2500   #控制buffer写文件，不是覆盖，相当于控制罗盘，一般不需要特殊指定

buffers {
​  # buffer size
​  size_kb: 65535   #如果出现数据丢失可设置大一些
​  # DISCARD: no new sampling data will be stored when the storage is full.
​  # RING_BUFFER: old sampling data will be discarded and new data will be stored when the storage is full.
​  fill_policy: RING_BUFFER
}

# UCP data source
data_sources: {
​    config {
​        name: "track_event"
​        track_event_config {
​           enabled_categories: "dnn"
​        }
​    }
}
</code></pre>
<p>在该目录下会生成 trace 文件：文件名为 output_path 中配置的文件名：
<img src="http://openwrite.cn/uploads/19742/58988/9ffae1f5-f3e8-481f-93b0-87818396dbd9.png" alt="30.png" loading="lazy"/></p>
<blockquote>
<p>1.Perfetto 不支持自动覆盖，如果设置路径中有之前的 ptrace 文件会报错</p>
<p><img src="http://openwrite.cn/uploads/19742/58988/e70b080b-8e8b-452e-a7f1-11add3481c2e.png" alt="31.png" loading="lazy"/></p>
<p>2.ucp_in_process.json 中指定的文件路径是相对路径，需要配置文件和脚本放在同一个路径下</p>
</blockquote>
<h5 data-id="heading-39">6.1.2 结果解析</h5>
<p>生成的 ucp.pftrace 就是我们要分析的文件，使用<a href="https://link.juejin.cn?target=https%3A%2F%2Fui.perfetto.dev%2F" target="_blank" title="https://ui.perfetto.dev/" ref="nofollow noopener noreferrer"> Perfetto UI </a>打开：
<img src="http://openwrite.cn/uploads/19742/58988/892452a2-162b-44c7-ac93-31dce8250e6c.png" alt="32.png" loading="lazy"/></p>
<p>选择生成的 ucp.pftrace 文件，选中一个带有 forward::Wait 字样的一块，如下图所示：
<img src="http://openwrite.cn/uploads/19742/58988/10304a3e-6387-493e-8656-4065ac03c84e.png" alt="33.png" loading="lazy"/></p>
<p>可以看到等待部分耗时大约为 80.xms，也可以看到线程和进程的信息（Wait 部分）
<img src="http://openwrite.cn/uploads/19742/58988/b843acd7-c113-4b0d-a4ea-229a539776b4.png" alt="34.png" loading="lazy"/></p>
<ul>
<li>单线程 + 多帧</li>
</ul>
<pre><code class="hljs language-Plain" lang="Plain">hrt_model_exec perf --model_file xxx.hbm --frame_count 4
</code></pre>
<p><img src="http://openwrite.cn/uploads/19742/58988/d9ab9c08-9c81-481a-a229-1da0c624bfa5.png" alt="35.png" loading="lazy"/></p>
<ul>
<li>多线程 + 多帧</li>
</ul>
<pre><code class="hljs language-Plain" lang="Plain">hrt_model_exec perf --model_file xxx.hbm --frame_count 10 --thread_num 4
</code></pre>
<p><img src="http://openwrite.cn/uploads/19742/58988/dd3a2599-b3a1-4d36-85ce-50dae7d9d7f4.png" alt="36.png" loading="lazy"/></p>
<p>如何分析：</p>
<ol>
<li>查看 UCP 内部调度是否正常例如哪块耗时明显高于预期</li>
<li>观察 BPU 是否持续在使用：例如两个 BPU Opfinish 之间的耗时是否符合预期，继而判断任务编排是否合理，任务下发是否及时</li>
</ol>
<ul>
<li>多线程 + 多帧 +CPU 结果
<img src="http://openwrite.cn/uploads/19742/58988/b394270e-1cf5-4117-bd83-76340e8b788c.png" alt="37.png" loading="lazy"/></li>
</ul>
<h3 data-id="heading-40">6.2 system 模式</h3>
<p>在 system 模式下，UCP trace 只是其中一个数据源，因此需要运行 Perfetto 的后台进程来完成 trace 捕获。</p>
<ol>
<li>运行 Perfetto 后台进程</li>
</ol>
<pre><code class="hljs language-Plain" lang="Plain">tracebox traced --background
tracebox traced_probes --background --reset-ftrace
tracebox perfetto -c ucp_system.cfg -o ucp.pftrace
</code></pre>
<blockquote>
<p>请注意，为了能够获取完整的数据，需要确保 hrt_model_exec 执行结束前，perfetto 进程未退出。可以适当增加 ucp_system.cfg 中的 duration_ms，当前默认为 10000ms</p>
</blockquote>
<ol start="2">
<li>开启一个新终端，设置环境变量和运行程序</li>
</ol>
<pre><code class="hljs language-Plain" lang="Plain">export HB_UCP_PERFETTO_CONFIG_PATH=ucp_system.json
export HB_UCP_ENABLE_PERFETTO=true
</code></pre>
<ol start="3">
<li>运行程序，比如运行 hrt_model_exec 命令，并将获取到的 ucp.pftrace 解析：
<img src="http://openwrite.cn/uploads/19742/58988/82e3cef7-8fa9-4c09-8c49-ac2957c60e25.png" alt="38.png" loading="lazy"/></li>
</ol>
<h2 data-id="heading-41">7.视觉处理/高性能算子</h2>
<p>UCP 提供了视觉处理和高性能算子两大方向的多种接口：</p>
<ol>
<li>视觉处理主要针对视频编/解码，光流，AVM 拼接等常规视觉算法</li>
<li>高性能算子依赖于 DSP 的实现，主要用于 fft 和 ifft 的加速 更多信息可以参考用户手册《<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.oe.horizon.auto%2Fguide%2Fucp%2Fucp_overview.html" target="_blank" title="https://doc.oe.horizon.auto/guide/ucp/ucp_overview.html" ref="nofollow noopener noreferrer">统一计算平台</a>》的相关章节。</li>
</ol>
<h2 data-id="heading-42">8.DSP 使用</h2>
<p>征程 6 的 dsp 使用了 Cadence 的 Tensilica Vision Q8 DSP IP（征程 6B 为 Vision 130）。支持 int8/int16/int32/float32/double 的浮点计算。 当前 DSP 可以用于加速模型前后处理比如点云体素化，模型量化反量化等操作，模型中间的算子加速暂不支持。更详细的说明，请参照《[DSP 算子开发](https</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[GoWind Admin｜风行 — 开箱即用的企业级全栈中后台框架：数据权限体系设计与实现]]></title>    <link>https://juejin.cn/post/7599713126376013839</link>    <guid>https://juejin.cn/post/7599713126376013839</guid>    <pubDate>2026-01-27T03:47:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599713126376013839" data-draft-id="7599690133117845538" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="GoWind Admin｜风行 — 开箱即用的企业级全栈中后台框架：数据权限体系设计与实现"/> <meta itemprop="keywords" content="后端,Go,微服务"/> <meta itemprop="datePublished" content="2026-01-27T03:47:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="喵个咪"/> <meta itemprop="url" content="https://juejin.cn/user/1350630784901262"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            GoWind Admin｜风行 — 开箱即用的企业级全栈中后台框架：数据权限体系设计与实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1350630784901262/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    喵个咪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T03:47:06.000Z" title="Tue Jan 27 2026 03:47:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">GoWind Admin｜风行 — 开箱即用的企业级全栈中后台框架：数据权限体系设计与实现</h2>
<p>在企业级中后台应用的建设中，<strong>数据权限</strong>是保障信息安全、符合业务合规要求的核心能力，更是平衡系统安全性与业务灵活性的关键支点。它不仅要精准解决 “谁能看到什么数据” 的核心问题，更需兼顾系统的可维护性、可扩展性与用户体验。GoWind Admin（风行）作为开箱即用的企业级全栈中后台框架，内置<strong>多层次、细粒度、高可扩展的一体化数据权限体系</strong>，从租户全局隔离到动态策略维度全面覆盖，原生支持单租户 / 多租户 SaaS 部署，让企业级应用的权限管理从 “重复开发” 变为 “开箱即用”。</p>
<h3 data-id="heading-1">一、数据权限的五大核心粒度层级</h3>
<p>企业级业务的权限需求呈现多元化、精细化特征，GoWind Admin 基于海量企业级场景实践，将数据权限划分为<strong>五层递进的粒度层级</strong>（从顶层全局隔离到底层动态管控），租户隔离为所有权限的前置底线，各层级可独立使用也可组合叠加，完美适配单租户企业部署、多租户 SaaS 平台等全场景。</p>
<h4 data-id="heading-2">1. 租户级（Tenant-level・顶层全局隔离）</h4>
<p><strong>所有数据权限的前置基础</strong>，基于<code>tenant_id</code>实现租户间的全局数据隔离，是多租户 SaaS 架构的核心能力，也是企业级框架的必备基础。</p>
<ul>
<li><strong>粒度描述</strong>：以 “租户” 为单位进行全量数据的物理 / 逻辑隔离，不同租户的数据集完全独立，租户内的所有权限控制均在自身数据范围内生效，<strong>跨租户数据零泄露</strong>。</li>
<li><strong>典型场景</strong>：SaaS 型 CRM/ERP/OA 平台、多商户电商管理系统、集团型企业的子公司数据隔离、政务云的各单位数据隔离。</li>
<li><strong>实现方式</strong>：
<ul>
<li>框架要求<strong>所有业务表默认内置<code>tenant_id</code>字段</strong>，作为租户数据的唯一标识；</li>
<li>通过 ORM 层<strong>全局非侵入式拦截</strong>，所有 SQL 查询 / 写入操作<strong>自动强制注入<code>tenant_id = '当前租户ID'</code></strong>，开发者无需手动处理；</li>
<li>支持<strong>逻辑隔离（单库单表）</strong> 和 <strong>物理隔离（分库分表）</strong> 两种模式，可通过配置灵活切换，适配不同租户数据量与安全等级需求。</li>
</ul>
</li>
</ul>
<blockquote>
<p>✅ 核心优势：租户间数据绝对隔离，满足 SaaS 平台的核心合规要求；<code>tenant_id</code>全链路自动注入，无侵入式开发；单 / 多租户模式一键切换，适配企业从私有化部署到 SaaS 化运营的全生命周期。</p>
<p>⚠️ 关键设计：超级管理员可配置是否开启 “跨租户访问”，默认关闭，从源头杜绝租户间数据泄露。</p>
</blockquote>
<h4 data-id="heading-3">2. 业务单元级（粗粒度・主流首选）</h4>
<p>最基础且适用面最广的<strong>租户内权限控制</strong>方式，核心基于企业组织架构、业务部门或项目组等业务单元进行数据范围划分。</p>
<ul>
<li><strong>粒度描述</strong>：用户仅能访问<strong>本租户内</strong>其所属部门、子公司、项目组或业务线范围内的全量数据，数据按业务单元形成天然隔离。</li>
<li><strong>典型场景</strong>：OA 系统的部门公告与流程、CRM 系统的客户归属管理、ERP 系统的部门业绩数据统计。</li>
<li><strong>实现方式</strong>：框架通过非侵入式拦截，在 SQL 查询阶段自动注入业务单元过滤条件，如 <code>WHERE dept_id = '当前用户部门ID'</code>、<code>project_id = '当前用户所属项目ID'</code>，无需开发者手动处理。</li>
</ul>
<blockquote>
<p>✅ 核心优势：权限逻辑清晰易懂，用户易理解、管理员易配置；查询过滤性能高效，无额外性能损耗，适配 80% 以上的企业级中后台常规场景。</p>
</blockquote>
<h4 data-id="heading-4">3. 行级（Row-level・记录级管控）</h4>
<p>针对<strong>本租户内</strong>单条数据记录的归属权进行精细化管控，是企业级场景中 “最小数据单元” 的权限控制方式。</p>
<ul>
<li><strong>粒度描述</strong>：遵循 “谁创建谁查看”、“指定负责人可见” 原则，单条数据仅对其归属人、指定责任人开放访问权限。</li>
<li><strong>典型场景</strong>：个人工单与报销单、私有云资源申请记录、医疗电子病历、金融个人理财档案。</li>
<li><strong>实现方式</strong>：框架内置数据归属字段自动填充能力，每条记录默认携带<code>created_by</code>（创建人）、<code>assigned_to</code>（负责人）等归属字段，查询时强制校验当前用户身份并自动追加过滤条件。</li>
</ul>
<blockquote>
<p>⚠️ 关键注意：框架通过统一的 ORM 拦截机制确保数据写入时自动绑定归属人，从源头避免手动开发导致的归属字段缺失问题，彻底杜绝权限漏洞。</p>
</blockquote>
<h4 data-id="heading-5">4. 列级（Column-level・字段级脱敏 / 隐藏）</h4>
<p>对本租户内数据记录中的敏感字段实施差异化展示与访问控制，是满足数据隐私保护合规要求的核心能力。</p>
<ul>
<li><strong>粒度描述</strong>：基于用户角色 / 权限等级差异化展示字段内容，高权限角色可查看完整敏感信息（如薪资、手机号、银行卡号），普通角色仅查看脱敏内容（如<code>138****0000</code>）或直接隐藏字段。</li>
<li><strong>典型场景</strong>：人力资源系统的薪酬数据、财务系统的成本明细与回款金额、用户管理系统的隐私信息、政务系统的个人身份数据。</li>
<li><strong>实现方式</strong>：框架提供三层列级权限管控方案，支持按需选择：
<ol>
<li>API 响应层动态脱敏：基于权限配置对返回字段进行实时脱敏 / 过滤，无数据库层改造；</li>
<li>数据库视图层管控：为不同权限角色创建专属数据库视图，仅暴露可访问字段；</li>
<li>前后端协同管控：后端根据权限不返回敏感字段，前端根据权限不渲染对应组件，实现 “数据不传输、界面不展示”。</li>
</ol>
</li>
</ul>
<blockquote>
<p>🔒 核心合规价值：精准满足 GDPR、《中华人民共和国个人信息保护法》《数据安全法》等法规对敏感数据的 “最小必要披露” 要求，从技术层面保障企业数据合规。</p>
</blockquote>
<h4 data-id="heading-6">5. 操作级 / 状态级（最细粒度・动态上下文管控）</h4>
<p>基于<strong>本租户内</strong>业务场景上下文的动态权限判定，是高安全等级场景的核心权限控制方式，突破静态权限的限制。</p>
<ul>
<li><strong>粒度描述</strong>：结合<strong>数据状态、操作行为、访问环境</strong>等多维度上下文动态判定权限，例如：仅当订单处于 “待审核” 状态、访问时间为工作日工作时段、访问 IP 属于企业内网时，指定审核员才可查看订单敏感附件。</li>
<li><strong>典型场景</strong>：军工涉密系统、金融风控审批系统、银行核心业务系统、高密级科研项目管理系统。</li>
<li><strong>实现方式</strong>：原生集成<strong>ABAC（Attribute-Based Access Control，基于属性的访问控制）</strong> 模型，通过内置策略引擎实时评估<strong>用户属性、资源属性、环境属性、操作属性</strong>等多维信息，动态判定访问权限。</li>
</ul>
<blockquote>
<p>🧠 核心设计思想：权限不再是静态绑定到用户 / 角色的固定规则，而是由业务场景的 “上下文信息” 动态决定，适配高安全、高灵活度的业务需求。</p>
</blockquote>
<h3 data-id="heading-7">二、DataScope：行级数据权限的统一实现引擎</h3>
<p>行级数据权限是企业级中后台应用的核心权限需求，GoWind Admin 为解决行级权限开发繁琐、侵入性强、可维护性差的问题，设计了核心机制<strong>DataScope</strong>—— 行级数据权限的统一实现引擎。</p>
<p>DataScope 基于<strong>非侵入式 AOP 拦截</strong>与<strong>动态 SQL 注入</strong>技术，在 SQL 语句执行前<strong>先强制注入租户过滤条件</strong>，再根据当前用户权限注入对应的行级过滤条件，开发者无需手动拼接 WHERE 子句、无需修改原有业务 SQL，真正实现 “业务代码与权限代码解耦”，大幅降低开发成本。</p>
<p>DataScope 内置六大权限维度，覆盖从基础到复杂的全量行级权限需求，且各维度支持自由组合、无缝扩展：</p>
<h4 data-id="heading-8">1. 租户级基础过滤（全局前置・默认开启）</h4>
<p><strong>DataScope 的前置核心过滤维度</strong>，所有行级权限控制均在<strong>租户隔离</strong>的基础上生效，是框架默认开启的强制过滤规则。</p>
<ul>
<li><strong>核心能力</strong>：无需任何配置，框架自动为所有 SQL 查询注入<code>tenant_id = '当前租户ID'</code>，确保用户仅能访问本租户内的数据；</li>
<li><strong>租户管理员权限</strong>：租户内的管理员 / 超级管理员，其数据权限范围<strong>被强制限定在本租户内</strong>，无法访问其他租户数据；</li>
<li><strong>跨租户配置</strong>：仅系统级超级管理员可通过配置开启 “跨租户数据访问”，且需绑定专属权限，同时框架会记录所有跨租户操作日志，满足审计合规要求。</li>
</ul>
<blockquote>
<p>💡设计亮点：<code>tenant_id</code>的过滤优先级高于所有其他 DataScope 维度，即使配置了 “全部数据” 权限，用户也仅能查看<strong>本租户内</strong>的全量数据，从引擎层杜绝租户间数据泄露。</p>
</blockquote>
<h4 data-id="heading-9">2. 组织架构级（部门 / 机构・核心主流）</h4>
<p>基于企业树形组织架构的灵活数据范围管控，是 DataScope 最常用的权限维度，框架天然支持组织树的递归遍历与权限计算。</p>






























<table><thead><tr><th>权限类型</th><th>核心说明</th><th>适用角色</th></tr></thead><tbody><tr><td>全部数据</td><td>无任何数据过滤，可访问<strong>本租户内</strong>系统全量数据</td><td>租户内超级管理员、租户系统管理员</td></tr><tr><td>本部门数据</td><td>仅可查看<strong>本租户内</strong>当前用户所属直接部门的所有数据</td><td>部门普通员工、部门专员</td></tr><tr><td>本部门及子部门数据</td><td>可查看<strong>本租户内</strong>当前部门及其所有下级部门的全量数据（自动递归组织树）</td><td>部门经理、部门负责人</td></tr><tr><td>自定义部门数据</td><td>可手动配置<strong>本租户内</strong>任意一个或多个部门组合，仅访问指定部门数据</td><td>租户内公司高管、跨部门协调岗</td></tr></tbody></table>
<blockquote>
<p>💡 框架内置成熟的组织架构管理组件，支持部门的增删改查、树形展示、层级调整，同时提供高效的组织树遍历与权限计算算法，确保大数据量下的权限判定性能。</p>
</blockquote>
<h4 data-id="heading-10">3. 个人级（Owner-level・归属者管控）</h4>
<p>实现 “我的数据我做主” 的最小权限单元，精准适配本租户内强归属型数据的权限管控需求。</p>
<ul>
<li><strong>核心能力</strong>：根据数据归属关系自动追加过滤条件，如<code>user_id = ?</code>、<code>created_by = ?</code>，仅允许数据创建人、归属人访问。</li>
<li><strong>典型适用场景</strong>：个人工单、报销申请单、个人笔记、员工打卡记录、个人客户跟进记录等强个人归属型数据。</li>
<li><strong>开发优势</strong>：框架内置归属字段自动填充功能，数据写入时无需手动设置<code>created_by</code>等字段，由 ORM 框架统一拦截处理，从源头保证数据归属的准确性。</li>
</ul>
<h4 data-id="heading-11">4. 角色级（Role-based Scope・批量管控）</h4>
<p>将数据范围与角色深度绑定，实现<strong>本租户内</strong>数据权限的批量配置与管理，解耦用户与数据范围的直接关联。</p>
<ul>
<li><strong>核心规则</strong>：同一用户若拥有多个角色，系统默认取各角色数据权限的<strong>并集</strong>（支持配置为交集，满足特殊业务需求）；角色权限调整后，所属所有用户的 DataScope 自动同步，无需逐个修改。</li>
<li><strong>典型示例</strong>：角色 A 配置为 “可见<strong>本租户内</strong>销售一部数据”，角色 B 配置为 “可见<strong>本租户内</strong>市场部数据”，当用户同时拥有 A、B 两个角色时，可直接查看两个部门的全量数据。</li>
</ul>
<blockquote>
<p>✅ 核心优势：实现权限的 “批量管理、统一调整”，大幅降低管理员的权限维护成本，适配企业人员异动、组织架构调整等场景。</p>
</blockquote>
<h4 data-id="heading-12">5. 自定义 SQL 拼接级（高扩展・业务适配）</h4>
<p>DataScope 的底层基于动态 SQL 注入技术构建，具备极强的业务适配性，支持基于<strong>本租户内</strong>任意业务字段的个性化权限过滤。</p>
<ul>
<li><strong>核心能力</strong>：可基于企业任意业务字段进行数据范围过滤，如<code>project_id</code>（项目 ID）、<code>warehouse_id</code>（仓库 ID）、<code>region_id</code>（区域 ID）等；</li>
<li><strong>配置方式</strong>：通过<strong>注解 + 配置文件</strong>的方式声明权限规则，只需指定 “哪些表、哪些字段需要进行权限过滤”，框架自动完成 SQL 注入，无需修改原有业务查询代码；</li>
<li><strong>典型适用场景</strong>：多租户 SaaS 系统的租户数据隔离、项目制管理系统的项目数据隔离、跨区域运营系统的区域数据隔离等复杂业务模型。</li>
</ul>
<h4 data-id="heading-13">6. 动态属性级（ABAC 扩展・高安全场景）</h4>
<p>标准 DataScope 基于 RBAC（基于角色的访问控制）模型构建，同时框架为高安全、高灵活度场景预留了<strong>标准化的 ABAC 扩展接口</strong>，可无缝集成基于属性的访问控制能力。</p>
<ul>
<li><strong>核心能力</strong>：支持基于<strong>本租户内</strong>多维动态属性进行权限判定，包括用户属性（角色、职级、岗位）、资源属性（数据敏感等级、数据状态）、环境属性（访问时间、IP 地址、设备类型、网络环境）等；</li>
<li><strong>扩展方式</strong>：框架提供标准化的<code>PolicyEvaluator</code>（策略评估器）接口，开发者只需实现接口的核心评估方法，即可注入自定义的动态权限规则，实现 “运行时实时权限决策”；</li>
<li><strong>未来演进</strong>：框架将原生支持与 Open Policy Agent (OPA) 等主流外部策略引擎的集成，构建统一的零信任安全架构，适配超高级别的安全管控需求。</li>
</ul>
<h3 data-id="heading-14">三、框架级优势：让数据权限从 “开发负担” 变为 “核心能力”</h3>
<p>GoWind Admin 的数权限体系并非简单的功能堆砌，而是从企业级开发、运维、合规三大维度进行框架级设计，真正实现数据权限的 “开箱即用、低码开发、灵活扩展”：</p>
<ol>
<li><strong>租户隔离原生支持</strong>：内置<code>tenant_id</code>全链路自动注入机制，支持逻辑 / 物理两种隔离模式，单 / 多租户一键切换，完美适配私有化部署与 SaaS 平台建设；</li>
<li><strong>非侵入式开发</strong>：所有权限过滤均通过 AOP 拦截、动态 SQL 注入实现，业务代码与权限代码完全解耦，开发者无需关注权限细节，专注业务逻辑开发；</li>
<li><strong>全链路自动化</strong>：从数据写入时的<code>tenant_id</code>、归属字段自动填充，到查询时的租户 + 权限条件自动注入，再到权限变更时的实时同步，框架实现全链路自动化处理，减少手动操作，杜绝权限漏洞；</li>
<li><strong>一体化管控</strong>：数据权限（租户 + 部门 + 行 + 列）与功能权限、角色管理、组织架构深度融合，提供统一的权限管理界面，管理员可在一个平台完成所有权限的配置、调整、审计，降低运维成本；</li>
<li><strong>高可扩展架构</strong>：从基础的 RBAC 到高级的 ABAC，从内置的权限维度到自定义的业务规则，框架预留了标准化的扩展接口，支持企业根据业务需求逐步迭代权限体系，无需重构；</li>
<li><strong>性能与安全兼顾</strong>：所有权限判定与 SQL 过滤均在服务端完成，前端无敏感数据泄露风险；同时框架对组织树遍历、权限条件计算等核心逻辑进行性能优化，确保大数据量下的系统响应速度。</li>
</ol>
<h3 data-id="heading-15">结语</h3>
<blockquote>
<p>权限不是枷锁，而是秩序的基石。</p>
</blockquote>
<p>在企业数字化转型的过程中，数据安全与业务敏捷从来都不是对立面。GoWind Admin 通过框架级的、一体化的数据权限体系设计，<strong>以租户隔离为底线，以多层粒度为核心，以动态策略为延伸</strong>，让数据权限管理从企业级应用的 “开发负担” 变为 “核心能力”，既为企业构建起符合合规要求、保障信息安全的权限秩序，又能适配企业业务发展的灵活需求，助力开发者快速构建既安全又敏捷的企业级全栈中后台应用。</p>
<h3 data-id="heading-16">项目代码</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Ftx7do%2Fgo-wind-admin" target="_blank" title="https://gitee.com/tx7do/go-wind-admin" ref="nofollow noopener noreferrer">go-wind-admin Gitee</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftx7do%2Fgo-wind-admin" target="_blank" title="https://github.com/tx7do/go-wind-admin" ref="nofollow noopener noreferrer">go-wind-admin Github</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[GoWind Admin｜风行 — 开箱即用的企业级全栈中后台框架・内置微服务接口数据聚合能力]]></title>    <link>https://juejin.cn/post/7599598627008118836</link>    <guid>https://juejin.cn/post/7599598627008118836</guid>    <pubDate>2026-01-27T03:47:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599598627008118836" data-draft-id="7599703627788812328" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="GoWind Admin｜风行 — 开箱即用的企业级全栈中后台框架・内置微服务接口数据聚合能力"/> <meta itemprop="keywords" content="后端,Go,微服务"/> <meta itemprop="datePublished" content="2026-01-27T03:47:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="喵个咪"/> <meta itemprop="url" content="https://juejin.cn/user/1350630784901262"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            GoWind Admin｜风行 — 开箱即用的企业级全栈中后台框架・内置微服务接口数据聚合能力
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1350630784901262/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    喵个咪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T03:47:48.000Z" title="Tue Jan 27 2026 03:47:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">GoWind Admin｜风行 — 开箱即用的企业级全栈中后台框架・内置微服务接口数据聚合能力</h2>
<blockquote>
<p>让复杂归于简单，让聚合成为本能。</p>
</blockquote>
<p>在微服务架构盛行的今天，企业中后台系统正面临前所未有的开发与性能双重挑战：前端需从数十个独立服务中零散拉取数据，网络请求冗余、状态管理繁琐；后端逻辑分散、接口复用性差、N+1 查询问题泛滥，既拖累开发效率，也让系统性能持续承压。如何在坚守系统解耦原则的同时，高效组装业务视图、简化开发链路？<strong>GoWind Admin（风行）</strong> 应运而生——一款专为现代企业打造的全栈中后台框架，以“<strong>开箱即用 + 内置智能聚合</strong>”为核心理念，彻底破解微服务时代的数据拼装难题，让开发者从接口拼接的繁琐工作中解放出来。</p>
<h3 data-id="heading-1">一、为什么需要 GoWind Admin？</h3>
<p>传统中后台开发往往陷入“前端累、后端繁”的双重困境，难以兼顾效率与性能：</p>
<ul>
<li><strong>前端困境</strong>：一个常规业务页面，常常需要发起 5~10 次独立 API 调用，不仅带来高额网络延迟，更让错误处理、状态同步变得异常繁琐，严重影响用户体验与开发效率。</li>
<li><strong>后端困境</strong>：BFF（Backend For Frontend）层代码重复堆砌、逻辑臃肿冗余，每次新增业务字段或调整接口，都需联动修改多个服务的调用逻辑，维护成本极高。</li>
</ul>
<p>更关键的是，市面上多数中后台框架仅提供基础 UI 组件或简单 CRUD 封装，<strong>均未针对“跨服务数据聚合”这一核心痛点提供深度解决方案</strong>，开发者仍需手动编写大量聚合逻辑，无法从根本上提升开发效能。</p>
<p>GoWind Admin 给出的解决方案直击要害：<strong>将数据聚合能力内建于框架底层</strong>，通过一套声明式、类型安全、高性能的聚合引擎，让开发者无需关注底层调用细节，像操作单体数据库一样，轻松组合多服务数据、快速落地业务需求。</p>
<h3 data-id="heading-2">二、核心亮点：内置微服务接口数据聚合引擎</h3>
<p>GoWind Admin 最具差异化的创新，在于其内嵌的 <code>aggregator</code>模块——一款专为 Go 语言量身设计的高性能、强类型、可扩展的数据聚合器，内置重试、限流、容错等企业级特性，完美适配微服务场景的复杂需求。</p>
<h4 data-id="heading-3">✅ 1. 并发安全执行器 <code>ExecuteParallel</code></h4>
<p>针对多服务并发调用场景，提供开箱即用的并发调度能力，兼顾效率与稳定性：</p>
<ul>
<li>自动并发调度多个微服务接口调用，大幅缩短数据拉取耗时；</li>
<li>支持<strong>最大并发数限制</strong>，可灵活配置阈值，有效防止下游服务雪崩；</li>
<li>内置 <code>Context</code> 超时控制、指数退避重试机制，提升接口调用成功率；</li>
<li>自动捕获调用过程中的 <code>Panic</code> 异常，做好兜底处理，保障主流程稳定运行。</li>
</ul>
<pre><code class="hljs language-go" lang="go">err := aggregator.ExecuteParallel(ctx, []aggregator.ParallelFetcher{
    <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context)</span></span> <span class="hljs-type">error</span> { <span class="hljs-keyword">return</span> fetchUser(ctx, &amp;user) },
    <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context)</span></span> <span class="hljs-type">error</span> { <span class="hljs-keyword">return</span> fetchOrders(ctx, &amp;orders) },
    <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context)</span></span> <span class="hljs-type">error</span> { <span class="hljs-keyword">return</span> fetchPermissions(ctx, &amp;perms) },
}, aggregator.WithLimit(<span class="hljs-number">5</span>), aggregator.WithRetry(<span class="hljs-number">2</span>))
</code></pre>
<h4 data-id="heading-4">✅ 2. 智能数据回填（Populate）</h4>
<p>无需手动编写映射逻辑，自动将聚合后的多服务数据，精准回填至业务对象，适配各类数据关联场景：</p>
<ul>
<li>全面支持扁平列表、树形结构、一对多/多对多关联等各类业务场景；</li>
<li>通过简单的 <code>IDGetter</code> 与 <code>Setter</code> 声明，即可完成数据映射，代码简洁易维护；</li>
<li>支持<strong>递归树形结构</strong>（如组织架构、菜单权限、分类目录等），轻松处理无限层级数据回填。</li>
</ul>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 将用户ID映射为User对象，并自动填充到订单列表中</span>
aggregator.Populate(orders, userMap, 
    <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(o Order)</span></span> <span class="hljs-type">int64</span> { <span class="hljs-keyword">return</span> o.UserID },     <span class="hljs-comment">// 定义订单关联的用户ID获取逻辑</span>
    <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(o Order, u User)</span></span> { o.User = u },        <span class="hljs-comment">// 定义用户数据回填至订单的逻辑</span>
)
</code></pre>
<p>递归树形结构回填示例（如组织架构）：</p>
<pre><code class="hljs language-go" lang="go">aggregator.PopulateTree(orgUnits, userManagerMap, 
    idGetter, setter, childrenFunc)
</code></pre>
<h4 data-id="heading-5">✅ 3. 原生集成 DataLoader 模式</h4>
<p>无缝对接 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgraph-gophers%2Fdataloader" target="_blank" title="https://github.com/graph-gophers/dataloader" ref="nofollow noopener noreferrer">graph-gophers/dataloader</a> 开源组件，从根源上解决微服务场景中的 N+1 查询问题，提升接口性能：</p>
<ul>
<li>自动将多个单个查询请求合并为批量请求，减少网络交互次数；</li>
<li>内置参数去重、结果缓存机制，避免重复查询，提升响应速度；</li>
<li>与 <code>Populate</code> 能力深度联动，数据回填更高效、更简洁。</li>
</ul>
<pre><code class="hljs language-go" lang="go">loader := aggregator.NewLoaderFromFetch(fetchUsersBatch)
thunk := aggregator.ThunkGetterFromLoader(ctx, loader, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(item Item)</span></span> <span class="hljs-type">int64</span> { <span class="hljs-keyword">return</span> item.UserID })

aggregator.PopulateWithLoader(items, thunk, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i Item, u User)</span></span> { i.User = u })
</code></pre>
<blockquote>
<p>💡 实际效果：原本需要执行 100 次的单个用户查询，将被自动合并为 1 次批量请求，接口响应速度提升 10 倍以上。</p>
</blockquote>
<h3 data-id="heading-6">三、全栈一体化体验：从前端到部署，一站式搞定</h3>
<p>GoWind Admin 不止聚焦于数据聚合能力，更提供了从前端到后端、从开发到部署的全链路完整解决方案，实现真正的全栈一体化开发，让开发者无需跨技术栈选型、无需手动整合组件，开箱即可投入生产。</p>






























<table><thead><tr><th>层级</th><th>技术栈</th><th>特性</th></tr></thead><tbody><tr><td>前端</td><td>Vue 3 + TypeScript + Vite + Antdv + Vben</td><td>响应式布局、动态权限控制、主题定制、多语言 i18n、丰富 UI 组件库</td></tr><tr><td>后端</td><td>Go 1.23 + Kratos + GORM/Ent + Casbin</td><td>RESTful API 规范、JWT 身份鉴权、RBAC 权限模型、操作审计日志、数据校验</td></tr><tr><td>聚合层</td><td>内置 aggregator 引擎</td><td>微服务数据组装、BFF 逻辑简化、N+1 查询解决、高可用容错</td></tr><tr><td>部署</td><td>Docker + Shell Script</td><td>一键部署、弹性伸缩、健康检查、容器化运维、环境一致性保障</td></tr></tbody></table>
<h3 data-id="heading-7">四、典型应用场景：让聚合能力落地到每一个业务场景</h3>
<p>GoWind Admin 的聚合引擎的设计，完全贴合企业中后台的高频业务场景，无需复杂配置，即可快速解决数据拼装难题。</p>
<h4 data-id="heading-8">场景1：用户详情页（跨3个服务的数据聚合）</h4>
<p>一个用户详情页，需整合3个独立服务的数据：</p>
<ul>
<li>用户服务 → 用户基本信息、账号状态</li>
<li>订单服务 → 用户最近下单记录、订单统计</li>
<li>权限服务 → 用户可操作菜单、功能权限列表</li>
</ul>
<h5 data-id="heading-9">传统开发方式</h5>
<p>前端需依次发起3次独立 API 请求，手动组装数据、处理加载状态与错误；或后端需编写大量冗余代码，调用3个服务接口并手动聚合结果，开发效率低、维护成本高。</p>
<h5 data-id="heading-10">GoWind 方式</h5>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 一行代码完成3个服务并发拉取 + 数据自动填充，无需冗余编码</span>
aggregator.ExecuteParallel(ctx, []ParallelFetcher{fetchUser, fetchOrders, fetchMenus})
aggregator.Populate(user, orderMap, ..., ...)
</code></pre>
<h4 data-id="heading-11">场景2：组织架构树（递归层级 + 多对多关联）</h4>
<p>企业组织架构场景，需处理递归层级与多对多关联数据：</p>
<ul>
<li>部门树 → 无限层级的部门结构（父部门包含子部门）</li>
<li>负责人关联 → 每个部门关联多个负责人（多对多关系）</li>
<li>用户数据 → 负责人信息来自独立的用户服务</li>
</ul>
<h5 data-id="heading-12">GoWind 方式</h5>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 递归处理部门树，自动将多个负责人数据回填至对应部门</span>
aggregator.PopulateTreeMulti(depts, userMap, 
    <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(d Dept)</span></span> []<span class="hljs-type">int64</span> { <span class="hljs-keyword">return</span> d.ManagerIDs },  <span class="hljs-comment">// 获取部门关联的负责人ID列表</span>
    <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(d Dept, us []User)</span></span> { d.Managers = us },   <span class="hljs-comment">// 将负责人数据回填至部门</span>
    <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(d Dept)</span></span> []Dept { <span class="hljs-keyword">return</span> d.Children },     <span class="hljs-comment">// 定义部门树的子节点获取逻辑</span>
)
</code></pre>
<h3 data-id="heading-13">五、为什么选择 GoWind Admin？</h3>
<p>相较于市面上其他中后台框架，GoWind Admin 以“聚合能力”为核心差异化优势，同时兼顾开箱即用、生产就绪、中文友好等特性，完美适配国内企业的开发需求：</p>
<ul>
<li>✅ <strong>真正开箱即用</strong>：项目初始化后即内置用户管理、角色权限、操作日志、数据字典等企业级基础模块，无需从零搭建，节省90%的基础开发时间。</li>
<li>✅ <strong>聚合能力内建</strong>：无需额外引入 BFF 网关或第三方聚合组件，聚合逻辑可直接嵌入 Handler 层，简化架构复杂度，降低运维成本。</li>
<li>✅ <strong>全程类型安全</strong>：基于 Go 泛型特性开发，编译期即可杜绝字段错配、类型不兼容等问题，减少线上 bug，提升代码可维护性。</li>
<li>✅ <strong>生产环境就绪</strong>：内置熔断、限流、重试、超时控制、全链路日志追踪等稳定性保障机制，经过实际项目验证，可直接用于生产环境。</li>
<li>✅ <strong>中文友好适配</strong>：官方文档、代码注释、社区交流均为中文，降低国内开发者学习与使用成本，遇到问题可快速获取支持。</li>
</ul>
<h3 data-id="heading-14">结语</h3>
<p>在微服务拆分日益精细化的今天，“高效数据聚合”早已不再是可选项，而是支撑中后台系统高效迭代、稳定运行的必选项。过多的接口拼接、冗余的聚合逻辑，不仅拖累开发效率，更会导致系统性能瓶颈、维护成本高企。</p>
<p>GoWind Admin 以 Go 语言的简洁与高效为基底，将复杂的数据组装逻辑封装为几行声明式代码，让开发者摆脱重复劳动，回归业务本质、聚焦核心需求。</p>
<blockquote>
<p><strong>风起于微末，行稳致远。</strong></p>
<p>GoWind Admin —— 为企业中后台，注入聚合之力。</p>
</blockquote>
<p>立即体验，彻底告别 N+1 查询困扰，拥抱更高效、更简洁、更稳定的中后台开发模式！🚀</p>
<h3 data-id="heading-15">项目代码</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Ftx7do%2Fgo-wind-admin" target="_blank" title="https://gitee.com/tx7do/go-wind-admin" ref="nofollow noopener noreferrer">go-wind-admin Gitee</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftx7do%2Fgo-wind-admin" target="_blank" title="https://github.com/tx7do/go-wind-admin" ref="nofollow noopener noreferrer">go-wind-admin Github</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用bin-home定位全局npm cli命令的来源包]]></title>    <link>https://juejin.cn/post/7599601258640179238</link>    <guid>https://juejin.cn/post/7599601258640179238</guid>    <pubDate>2026-01-27T03:48:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599601258640179238" data-draft-id="7599640782569193499" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用bin-home定位全局npm cli命令的来源包"/> <meta itemprop="keywords" content="前端,JavaScript,Node.js"/> <meta itemprop="datePublished" content="2026-01-27T03:48:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="火车叼位"/> <meta itemprop="url" content="https://juejin.cn/user/1345457960792808"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用bin-home定位全局npm cli命令的来源包
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1345457960792808/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    火车叼位
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T03:48:53.000Z" title="Tue Jan 27 2026 03:48:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你是否曾经在终端里输入一个命令，然后疑惑它到底来自哪个 npm 包？</p>
<p>想象一下：你几个月前装了一个很好用的 CLI 工具，叫 <code>codex</code>。现在你想更新它，于是习惯性地输入：</p>
<pre><code class="hljs language-bash" lang="bash">npm i -g codex
</code></pre>
<p>结果却返回：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">npm</span> <span class="hljs-selector-tag">ERR</span>! <span class="hljs-selector-tag">code</span> <span class="hljs-selector-tag">E404</span>
<span class="hljs-selector-tag">npm</span> <span class="hljs-selector-tag">ERR</span>! <span class="hljs-number">404</span> <span class="hljs-selector-tag">Not</span> <span class="hljs-selector-tag">Found</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">GET</span> <span class="hljs-selector-tag">https</span>:<span class="hljs-comment">//registry.npmjs.org/codex</span>
</code></pre>
<p>等等，我明明之前安装过啊？于是你开始翻找 bash 历史、查看全局 node_modules，甚至怀疑自己是不是记错了命令名……</p>
<p>别担心，你并不孤单。这正是 <strong>bin-home</strong> 诞生的原因。</p>
<h2 data-id="heading-0">当命令名“背叛”了包名</h2>
<p>在 npm 的世界里，大多数情况下，包的名称和它提供的 CLI 命令名称是一致的。比如 <code>create-react-app</code> 这个包，它的命令也是 <code>create-react-app</code>。</p>
<p>但近年来，随着工具链的复杂化，出现了越来越多“名不副实”的情况：</p>
<ul>
<li><code>@openai/codex</code> 这个包，提供的命令是 <code>codex</code></li>
<li><code>@microsoft/opencode</code> 这个包，提供的命令可能是 <code>opencode</code></li>
</ul>
<p>这样一来，当你想更新一个全局安装的 CLI 工具时，就得先回答一个哲学问题：<strong>“我当初到底安装的是什么包？”</strong></p>
<h2 data-id="heading-1">引入 bin-home：你的全局命令侦探</h2>
<p><strong>bin-home</strong> 是一个轻量级 CLI 工具，专门解决这个痛点。它的工作很简单：告诉你某个命令来自哪个 npm 包。</p>
<h3 data-id="heading-2">快速上手</h3>
<p>安装只需一瞬间：</p>
<pre><code class="hljs language-bash" lang="bash">npm install -g bin-home
</code></pre>
<p>使用更是简单到令人发指：</p>
<pre><code class="hljs language-bash" lang="bash">bin-home &lt;命令名&gt;
</code></pre>
<h3 data-id="heading-3">实战演示</h3>
<p>让我们看看 bin-home 如何解决开头的难题：</p>
<pre><code class="hljs language-bash" lang="bash">bin-home codex
</code></pre>
<p>输出：</p>
<pre><code class="hljs language-text" lang="text">npm: @openai/codex
npm url: https://www.npmjs.com/package/@openai/codex
github: https://github.com/openai/codex
</code></pre>
<p>恍然大悟！原来 <code>codex</code> 命令来自 <code>@openai/codex</code> 这个包。现在你可以正确地更新它了：</p>
<pre><code class="hljs language-bash" lang="bash">npm i -g @openai/codex
</code></pre>
<p>再试一个：</p>
<pre><code class="hljs language-bash" lang="bash">bin-home opencode
</code></pre>
<p>输出可能类似于：</p>
<pre><code class="hljs language-text" lang="text">npm: @microsoft/opencode
npm url: https://www.npmjs.com/package/@microsoft/opencode
github: https://github.com/microsoft/opencode
</code></pre>
<h3 data-id="heading-4">高级技巧：一键直达</h3>
<p>如果你懒得复制链接，bin-home 还贴心地提供了 <code>--open</code> 选项：</p>
<pre><code class="hljs language-bash" lang="bash">bin-home codex --open
</code></pre>
<p>执行后，它会自动在浏览器中打开该包的 npm 页面，让你直接查看文档、版本信息或进行更新。</p>
<h2 data-id="heading-5">为什么 bin-home 如此有用？</h2>
<h3 data-id="heading-6">1. 拯救“金鱼记忆”开发者</h3>
<p>我们都会忘记几个月前安装的包名。bin-home 就像你的 CLI 记忆外置硬盘，随时提醒你“当初装的是什么”。</p>
<h3 data-id="heading-7">2. 统一团队工具链</h3>
<p>当团队成员使用不同的命令别名时，bin-home 可以帮助快速确认这些命令背后的实际包，减少沟通成本。</p>
<h3 data-id="heading-8">3. 探索新工具</h3>
<p>看到别人使用一个很酷的命令但不知道是什么工具？bin-home 帮你反向查找，快速找到工具源头。</p>
<h3 data-id="heading-9">4. 清理全局环境</h3>
<p>想知道 <code>node_modules/.bin/</code> 里那一堆命令都是什么来头？bin-home 帮你一一查明，方便做“大扫除”。</p>
<h2 data-id="heading-10">技术实现简介</h2>
<p>bin-home 的工作原理其实很直观：</p>
<ol>
<li><strong>定位命令</strong>：在系统的 PATH 环境变量中查找指定命令的实际位置</li>
<li><strong>追溯来源</strong>：通过符号链接（symlink）追溯到 npm 全局安装目录</li>
<li><strong>解析元数据</strong>：读取对应包的 package.json，提取包名、仓库等信息</li>
<li><strong>智能输出</strong>：格式化展示信息，并可选择打开相关页面</li>
</ol>
<p>整个过程快速、无副作用，不会影响你现有的任何环境配置。</p>
<h2 data-id="heading-11">现在就试试！</h2>
<p>告别“我记得命令但忘了包名”的尴尬时刻。安装 bin-home，让你对全局 CLI 工具了如指掌：</p>
<pre><code class="hljs language-bash" lang="bash">npm install -g bin-home
</code></pre>
<p>然后尝试检查你常用的命令：</p>
<pre><code class="hljs language-bash" lang="bash">bin-home eslint
bin-home prettier
bin-home yarn
</code></pre>
<p>你可能会发现一些意想不到的“真身”！</p>
<hr/>
<p><strong>bin-home</strong>：因为每个命令，都该有个清晰的“出身证明”。</p>
<p>GitHub 仓库：[你的仓库地址]<br/>
npm 包：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fbin-home" target="_blank" title="https://www.npmjs.com/package/bin-home" ref="nofollow noopener noreferrer">www.npmjs.com/package/bin…</a></p>
<p><em>问题反馈或功能建议？欢迎在 GitHub 上提交 Issue 或 PR！</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Elasticsearch 7.X DSL 入门教程]]></title>    <link>https://juejin.cn/post/7599652649550577664</link>    <guid>https://juejin.cn/post/7599652649550577664</guid>    <pubDate>2026-01-27T03:52:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599652649550577664" data-draft-id="7599528186587725834" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Elasticsearch 7.X DSL 入门教程"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-27T03:52:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="左Python右Java"/> <meta itemprop="url" content="https://juejin.cn/user/4107431173952525"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Elasticsearch 7.X DSL 入门教程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4107431173952525/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    左Python右Java
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T03:52:39.000Z" title="Tue Jan 27 2026 03:52:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Elasticsearch 7.X DSL 入门教程</h2>
<h3 data-id="heading-1">目录</h3>
<ol>
<li><a href="#%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5" title="#%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5">基础概念</a></li>
<li><a href="#%E7%B4%A2%E5%BC%95%E6%93%8D%E4%BD%9C" title="#%E7%B4%A2%E5%BC%95%E6%93%8D%E4%BD%9C">索引操作</a></li>
<li><a href="#%E6%96%87%E6%A1%A3%E6%93%8D%E4%BD%9C" title="#%E6%96%87%E6%A1%A3%E6%93%8D%E4%BD%9C">文档操作</a></li>
<li><a href="#%E5%9F%BA%E7%A1%80%E6%9F%A5%E8%AF%A2" title="#%E5%9F%BA%E7%A1%80%E6%9F%A5%E8%AF%A2">基础查询</a></li>
<li><a href="#%E5%A4%8D%E5%90%88%E6%9F%A5%E8%AF%A2" title="#%E5%A4%8D%E5%90%88%E6%9F%A5%E8%AF%A2">复合查询</a></li>
<li><a href="#%E8%81%9A%E5%90%88%E6%9F%A5%E8%AF%A2" title="#%E8%81%9A%E5%90%88%E6%9F%A5%E8%AF%A2">聚合查询</a></li>
<li><a href="#%E9%AB%98%E7%BA%A7%E5%8A%9F%E8%83%BD" title="#%E9%AB%98%E7%BA%A7%E5%8A%9F%E8%83%BD">高级功能</a></li>
<li><a href="#%E5%AE%9E%E6%88%98%E7%A4%BA%E4%BE%8B" title="#%E5%AE%9E%E6%88%98%E7%A4%BA%E4%BE%8B">实战示例</a></li>
</ol>
<hr/>
<h3 data-id="heading-2">基础概念</h3>
<h4 data-id="heading-3">什么是 DSL</h4>
<p>DSL (Domain Specific Language) 是 Elasticsearch 的查询语言，基于 JSON 格式，用于执行各种数据操作。</p>
<h4 data-id="heading-4">核心概念</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"index"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"索引名"</span><span class="hljs-punctuation">,</span>        <span class="hljs-comment">// 类似数据库</span>
  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"类型名"</span><span class="hljs-punctuation">,</span>         <span class="hljs-comment">// 7.x 已废弃，统一为 _doc</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"文档ID"</span><span class="hljs-punctuation">,</span>          <span class="hljs-comment">// 类似主键</span>
  <span class="hljs-attr">"document"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"文档内容"</span>   <span class="hljs-comment">// 类似记录</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h3 data-id="heading-5">索引操作</h3>
<h4 data-id="heading-6">创建索引</h4>
<pre><code class="hljs language-json" lang="json">PUT /products
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"settings"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"number_of_shards"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"number_of_replicas"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"mappings"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"properties"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"analyzer"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ik_max_word"</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"price"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"double"</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"category"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"keyword"</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"analyzer"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ik_max_word"</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"stock"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"integer"</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"created_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"date"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"format"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"is_active"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"boolean"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-7">查看索引</h4>
<pre><code class="hljs language-json" lang="json">GET /products
GET /products/_mapping
GET /_cat/indices?v
</code></pre>
<h4 data-id="heading-8">删除索引</h4>
<pre><code class="hljs language-json" lang="json">DELETE /products
</code></pre>
<hr/>
<h3 data-id="heading-9">文档操作</h3>
<h4 data-id="heading-10">创建文档</h4>
<pre><code class="hljs language-json" lang="json">POST /products/_doc
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"iPhone 15 Pro"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"price"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">7999</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"category"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"手机"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"苹果最新款智能手机"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"stock"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">100</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"created_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-01-15 10:00:00"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"is_active"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-11">创建指定 ID 文档</h4>
<pre><code class="hljs language-json" lang="json">PUT /products/_doc/<span class="hljs-number">1</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MacBook Pro"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"price"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">12999</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"category"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"电脑"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"苹果专业笔记本电脑"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"stock"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">50</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"created_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-01-15 11:00:00"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"is_active"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-12">批量创建文档</h4>
<pre><code class="hljs language-json" lang="json">POST /_bulk
<span class="hljs-punctuation">{</span> <span class="hljs-attr">"index"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"_index"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"products"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2"</span> <span class="hljs-punctuation">}</span> <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">{</span> <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"iPad Air"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"price"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">4399</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"category"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"平板"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"轻薄平板电脑"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"stock"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">80</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"created_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-01-15 12:00:00"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"is_active"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span> <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">{</span> <span class="hljs-attr">"index"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"_index"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"products"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"3"</span> <span class="hljs-punctuation">}</span> <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">{</span> <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"AirPods Pro"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"price"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1899</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"category"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"耳机"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"无线降噪耳机"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"stock"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">200</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"created_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-01-15 13:00:00"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"is_active"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span> <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">{</span> <span class="hljs-attr">"index"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"_index"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"products"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"4"</span> <span class="hljs-punctuation">}</span> <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">{</span> <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Apple Watch"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"price"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2999</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"category"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"手表"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"智能手表"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"stock"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">150</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"created_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-01-15 14:00:00"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"is_active"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span> <span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-13">查询文档</h4>
<pre><code class="hljs language-json" lang="json">GET /products/_doc/<span class="hljs-number">1</span>
</code></pre>
<h4 data-id="heading-14">更新文档</h4>
<pre><code class="hljs language-json" lang="json">POST /products/_update/<span class="hljs-number">1</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"doc"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"price"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">11999</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"stock"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">45</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-15">删除文档</h4>
<pre><code class="hljs language-json" lang="json">DELETE /products/_doc/<span class="hljs-number">1</span>
</code></pre>
<hr/>
<h3 data-id="heading-16">基础查询</h3>
<h4 data-id="heading-17">查询所有文档</h4>
<pre><code class="hljs language-json" lang="json">GET /products/_search
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"query"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"match_all"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-18">分页查询</h4>
<pre><code class="hljs language-json" lang="json">GET /products/_search
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"query"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"match_all"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"from"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"size"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">10</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-19">指定返回字段</h4>
<pre><code class="hljs language-json" lang="json">GET /products/_search
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"query"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"match_all"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"_source"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"name"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"price"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"category"</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-20">排序</h4>
<pre><code class="hljs language-json" lang="json">GET /products/_search
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"query"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"match_all"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"sort"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"price"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"order"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"desc"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h3 data-id="heading-21">查询类型详解</h3>
<h4 data-id="heading-22">1. Match Query（全文搜索）</h4>
<pre><code class="hljs language-json" lang="json">GET /products/_search
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"query"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"match"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"苹果 手机"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-23">2. Term Query（精确匹配）</h4>
<pre><code class="hljs language-json" lang="json">GET /products/_search
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"query"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"term"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"category"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"手机"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-24">3. Terms Query（多值精确匹配）</h4>
<pre><code class="hljs language-json" lang="json">GET /products/_search
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"query"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"terms"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"category"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"手机"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"电脑"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-25">4. Range Query（范围查询）</h4>
<pre><code class="hljs language-json" lang="json">GET /products/_search
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"query"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"range"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"price"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"gte"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1000</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"lte"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">10000</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>范围操作符：</p>
<ul>
<li><code>gt</code>: 大于</li>
<li><code>gte</code>: 大于等于</li>
<li><code>lt</code>: 小于</li>
<li><code>lte</code>: 小于等于</li>
</ul>
<h4 data-id="heading-26">5. Prefix Query（前缀匹配）</h4>
<pre><code class="hljs language-json" lang="json">GET /products/_search
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"query"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"prefix"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"iPh"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-27">6. Wildcard Query（通配符匹配）</h4>
<pre><code class="hljs language-json" lang="json">GET /products/_search
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"query"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"wildcard"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"*Pro*"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-28">7. Fuzzy Query（模糊查询）</h4>
<pre><code class="hljs language-json" lang="json">GET /products/_search
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"query"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"fuzzy"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"value"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"iPone"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"fuzziness"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-29">8. Bool Query（布尔查询）</h4>
<pre><code class="hljs language-json" lang="json">GET /products/_search
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"query"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"bool"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"must"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"match"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"苹果"</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"must_not"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"term"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"category"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"耳机"</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"should"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"range"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"price"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
              <span class="hljs-attr">"lte"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5000</span>
            <span class="hljs-punctuation">}</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"filter"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"term"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"is_active"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>Bool 子句说明：</p>
<ul>
<li><code>must</code>: 必须匹配（影响得分）</li>
<li><code>must_not</code>: 必须不匹配</li>
<li><code>should</code>: 应该匹配（影响得分）</li>
<li><code>filter</code>: 必须匹配（不影响得分）</li>
</ul>
<hr/>
<h3 data-id="heading-30">复合查询</h3>
<h4 data-id="heading-31">1. Multi Match Query（多字段搜索）</h4>
<pre><code class="hljs language-json" lang="json">GET /products/_search
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"query"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"multi_match"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"query"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"苹果"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"fields"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"name"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"description"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-32">2. Query String Query（查询字符串）</h4>
<pre><code class="hljs language-json" lang="json">GET /products/_search
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"query"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"query_string"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"fields"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"name"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"description"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"query"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"(苹果 AND 手机) OR (iPad)"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-33">3. Nested Bool Query（嵌套布尔查询）</h4>
<pre><code class="hljs language-json" lang="json">GET /products/_search
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"query"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"bool"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"must"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"bool"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"should"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
              <span class="hljs-punctuation">{</span>
                <span class="hljs-attr">"match"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
                  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"苹果"</span>
                <span class="hljs-punctuation">}</span>
              <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
              <span class="hljs-punctuation">{</span>
                <span class="hljs-attr">"match"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
                  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"苹果"</span>
                <span class="hljs-punctuation">}</span>
              <span class="hljs-punctuation">}</span>
            <span class="hljs-punctuation">]</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"range"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"price"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
              <span class="hljs-attr">"gte"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1000</span>
            <span class="hljs-punctuation">}</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h3 data-id="heading-34">聚合查询</h3>
<h4 data-id="heading-35">1. Terms Aggregation（词项聚合）</h4>
<pre><code class="hljs language-json" lang="json">GET /products/_search
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"size"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"aggs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"category_count"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"terms"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"field"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"category"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"size"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">10</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-36">2. Stats Aggregation（统计聚合）</h4>
<pre><code class="hljs language-json" lang="json">GET /products/_search
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"size"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"aggs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"price_stats"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"stats"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"field"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"price"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>返回：count、min、max、avg、sum</p>
<h4 data-id="heading-37">3. Range Aggregation（范围聚合）</h4>
<pre><code class="hljs language-json" lang="json">GET /products/_search
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"size"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"aggs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"price_ranges"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"range"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"field"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"price"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"ranges"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
          <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"to"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2000</span>
          <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
          <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"from"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2000</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"to"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5000</span>
          <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
          <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"from"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5000</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-38">4. Date Histogram Aggregation（日期直方图）</h4>
<pre><code class="hljs language-json" lang="json">GET /products/_search
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"size"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"aggs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"products_over_time"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"date_histogram"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"field"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"created_at"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"calendar_interval"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"day"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"format"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"yyyy-MM-dd"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-39">5. Bucket Aggregation + Metric Aggregation（桶聚合 + 指标聚合）</h4>
<pre><code class="hljs language-json" lang="json">GET /products/_search
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"size"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"aggs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"by_category"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"terms"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"field"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"category"</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"aggs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"average_price"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"avg"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"field"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"price"</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"max_price"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"max"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"field"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"price"</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-40">6. Filter Aggregation（过滤聚合）</h4>
<pre><code class="hljs language-json" lang="json">GET /products/_search
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"size"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"aggs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"active_products"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"filter"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"term"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"is_active"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"aggs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"avg_price"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"avg"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"field"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"price"</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h3 data-id="heading-41">高级功能</h3>
<h4 data-id="heading-42">1. Highlight（高亮显示）</h4>
<pre><code class="hljs language-json" lang="json">GET /products/_search
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"query"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"match"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"苹果"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"highlight"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"fields"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-43">2. Script Fields（脚本字段）</h4>
<pre><code class="hljs language-json" lang="json">GET /products/_search
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"query"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"match_all"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"script_fields"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"discount_price"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"script"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"source"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"doc['price'].value * 0.9"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-44">3. Source Filtering（源过滤）</h4>
<pre><code class="hljs language-json" lang="json">GET /products/_search
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"query"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"match_all"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"_source"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"includes"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"name"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"price"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"excludes"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"description"</span><span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-45">4. Explain（解释查询）</h4>
<pre><code class="hljs language-json" lang="json">GET /products/_search
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"query"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"match"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"苹果"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"explain"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-46">5. Profile（性能分析）</h4>
<pre><code class="hljs language-json" lang="json">GET /products/_search
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"profile"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"query"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"match"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"苹果"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h3 data-id="heading-47">实战示例</h3>
<h4 data-id="heading-48">示例 1: 电商商品搜索</h4>
<pre><code class="hljs language-json" lang="json">GET /products/_search
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"query"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"bool"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"must"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"multi_match"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"query"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"苹果"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"fields"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"name^2"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"description"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"best_fields"</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"filter"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"term"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"is_active"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"range"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"price"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
              <span class="hljs-attr">"gte"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1000</span><span class="hljs-punctuation">,</span>
              <span class="hljs-attr">"lte"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">15000</span>
            <span class="hljs-punctuation">}</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"aggs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"categories"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"terms"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"field"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"category"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"size"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">10</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"price_ranges"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"range"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"field"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"price"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"ranges"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
          <span class="hljs-punctuation">{</span> <span class="hljs-attr">"to"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2000</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"key"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"低价"</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
          <span class="hljs-punctuation">{</span> <span class="hljs-attr">"from"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2000</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"to"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5000</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"key"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"中价"</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
          <span class="hljs-punctuation">{</span> <span class="hljs-attr">"from"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5000</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"key"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"高价"</span> <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"sort"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"_score"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"order"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"desc"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"from"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"size"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">20</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"highlight"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"fields"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"pre_tags"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"&lt;em&gt;"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"post_tags"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"&lt;/em&gt;"</span><span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-49">示例 2: 日志分析</h4>
<pre><code class="hljs language-json" lang="json">GET /logs/_search
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"query"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"bool"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"must"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"range"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"@timestamp"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
              <span class="hljs-attr">"gte"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"now-24h"</span><span class="hljs-punctuation">,</span>
              <span class="hljs-attr">"lte"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"now"</span>
            <span class="hljs-punctuation">}</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"filter"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"term"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"level"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ERROR"</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"aggs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"errors_by_service"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"terms"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"field"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"service_name"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"size"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">20</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"aggs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"error_types"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"terms"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"field"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"error_type"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"size"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">10</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"timeline"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"date_histogram"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"field"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"@timestamp"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"calendar_interval"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1h"</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"sort"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"@timestamp"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"order"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"desc"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"size"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">100</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-50">示例 3: 用户行为分析</h4>
<pre><code class="hljs language-json" lang="json">GET /user_actions/_search
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"query"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"bool"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"must"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"range"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"timestamp"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
              <span class="hljs-attr">"gte"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"now-7d/d"</span><span class="hljs-punctuation">,</span>
              <span class="hljs-attr">"lte"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"now/d"</span>
            <span class="hljs-punctuation">}</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"aggs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"daily_stats"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"date_histogram"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"field"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"timestamp"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"calendar_interval"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"day"</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"aggs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"unique_users"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"cardinality"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"field"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"user_id"</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"action_types"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"terms"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"field"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"action_type"</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"top_users"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"terms"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"field"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"user_id"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"size"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">10</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"order"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"action_count"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"desc"</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"aggs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"action_count"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"value_count"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"field"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"_id"</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-51">示例 4: 复杂的多条件查询</h4>
<pre><code class="hljs language-json" lang="json">GET /products/_search
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"query"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"bool"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"must"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"bool"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"should"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
              <span class="hljs-punctuation">{</span>
                <span class="hljs-attr">"match"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
                  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"手机"</span>
                <span class="hljs-punctuation">}</span>
              <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
              <span class="hljs-punctuation">{</span>
                <span class="hljs-attr">"match"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
                  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"手机"</span>
                <span class="hljs-punctuation">}</span>
              <span class="hljs-punctuation">}</span>
            <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"minimum_should_match"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"must_not"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"term"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"category"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"配件"</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"should"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"range"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"price"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
              <span class="hljs-attr">"lte"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3000</span>
            <span class="hljs-punctuation">}</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"term"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"stock"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
              <span class="hljs-attr">"value"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span>
            <span class="hljs-punctuation">}</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"filter"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"term"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"is_active"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"range"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"created_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
              <span class="hljs-attr">"gte"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"now-30d"</span>
            <span class="hljs-punctuation">}</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"aggs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"category_stats"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"terms"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"field"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"category"</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"aggs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"price_stats"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"stats"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"field"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"price"</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"stock_stats"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"stats"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"field"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"stock"</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"sort"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"price"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"order"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"asc"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"_score"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"order"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"desc"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"from"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"size"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">20</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h3 data-id="heading-52">常用操作符和参数</h3>
<h4 data-id="heading-53">查询参数</h4>





























<table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td><code>from</code></td><td>起始位置</td></tr><tr><td><code>size</code></td><td>返回数量</td></tr><tr><td><code>timeout</code></td><td>超时时间</td></tr><tr><td><code>track_total_hits</code></td><td>跟踪总命中数</td></tr><tr><td><code>request_cache</code></td><td>请求缓存</td></tr></tbody></table>
<h4 data-id="heading-54">排序参数</h4>





















<table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td><code>order</code></td><td>排序方向（asc/desc）</td></tr><tr><td><code>mode</code></td><td>排序模式（min/max/sum/avg/median）</td></tr><tr><td><code>missing</code></td><td>缺失值处理（_last/_first）</td></tr></tbody></table>
<h4 data-id="heading-55">聚合参数</h4>





















<table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td><code>size</code></td><td>返回桶的数量</td></tr><tr><td><code>order</code></td><td>排序方式</td></tr><tr><td><code>min_doc_count</code></td><td>最小文档数</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-56">性能优化建议</h3>
<h4 data-id="heading-57">1. 使用 filter 而非 query</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// 不推荐</span>
GET /products/_search
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"query"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"term"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"is_active"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>

<span class="hljs-comment">// 推荐</span>
GET /products/_search
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"query"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"bool"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"filter"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"term"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"is_active"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-58">2. 限制返回字段</h4>
<pre><code class="hljs language-json" lang="json">GET /products/_search
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"_source"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"name"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"price"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"query"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"match_all"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-59">3. 使用 scroll 处理大量数据</h4>
<pre><code class="hljs language-json" lang="json">GET /products/_search
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"scroll"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1m"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"size"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1000</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"query"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"match_all"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-60">4. 避免深度分页</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// 使用 search_after 代替 from/size</span>
GET /products/_search
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"size"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">100</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"query"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"match_all"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"sort"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"asc"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"search_after"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"last_document_id"</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h3 data-id="heading-61">总结</h3>
<p>Elasticsearch DSL 的核心要点：</p>
<ol>
<li><strong>查询类型</strong>：match、term、range、bool 等</li>
<li><strong>复合查询</strong>：bool 查询的 must、must_not、should、filter</li>
<li><strong>聚合分析</strong>：terms、stats、range、date_histogram 等</li>
<li><strong>高级功能</strong>：highlight、script、explain、profile</li>
<li><strong>性能优化</strong>：使用 filter、限制字段、避免深度分页</li>
</ol>
<p>通过本教程，你应该能够：</p>
<ul>
<li>创建和管理索引</li>
<li>执行各种类型的查询</li>
<li>进行数据聚合分析</li>
<li>优化查询性能</li>
</ul>
<p>继续实践和探索，你会发现 Elasticsearch DSL 的强大之处！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我写过复杂的跨平台大前端，过节回家亲戚居然让我把他那台旧手机改成只有微信的机子]]></title>    <link>https://juejin.cn/post/7599690133117894690</link>    <guid>https://juejin.cn/post/7599690133117894690</guid>    <pubDate>2026-01-27T03:55:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599690133117894690" data-draft-id="7599703627788877864" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我写过复杂的跨平台大前端，过节回家亲戚居然让我把他那台旧手机改成只有微信的机子"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2026-01-27T03:55:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="狗头大军之江苏分军"/> <meta itemprop="url" content="https://juejin.cn/user/2955079655907879"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我写过复杂的跨平台大前端，过节回家亲戚居然让我把他那台旧手机改成只有微信的机子
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2955079655907879/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    狗头大军之江苏分军
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T03:55:27.000Z" title="Tue Jan 27 2026 03:55:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>说实话，我一直觉得自己还算个见过世面的人。毕竟在公司这几年，什么没折腾过？React 写后台，Flutter 搞跨平台，一套代码要跑在好几个端上，状态、路由、性能、兼容，天天都在跟这些东西打交道。项目出问题的时候，大家第一时间找我，我也确实能顶上。那种感觉很真实，你会觉得自己不是在敲页面，是在撑一个系统。直到过年回家，我才发现，这些东西在老家基本等于没发生过。</p>
<p>回家第一天，我还没来得及休息，我妈就把我叫起来，说你三舅手机套餐太贵了，你去看看。我心想这还行，改套餐、关增值业务，这些年也算是基本功。结果刚弄完，三舅一脸满意，顺嘴来一句：“你不是搞电脑的吗？正好，插排坏了你也看看。”我蹲地上把插排拆了，重新接了下线，居然还能用。那一刻我就知道，完了，定位已经变了。</p>
<p>接下来几天事情开始越来越离谱。先是帮亲戚调电视信号、删手机里的垃圾 App，后来连车子中控不亮都有人喊我过去看一眼。最经典的一幕是二姨父站在车旁边跟我说：“你们天天对着屏幕，这个屏幕不也是屏幕吗？”我张了张嘴，发现“前端工程师”和“修车屏幕”之间那一整套解释，在那个场景里毫无意义。</p>
<p>真正把我整不会的，是有个亲戚把一台旧安卓机塞到我手里，说想让我“改一下系统”。他的需求非常明确：这手机以后只能用微信，开机就是微信，别的什么都没有，设置最好也进不去，老人只负责点开聊天和发语音就行。我当时脑子里过了一遍：root、刷机、定制 ROM、设备管理、桌面锁定……这些东西不是不能做，是根本不该我做。我写的是前端，不是手机操作系统。</p>
<p>我试着跟他解释，说我在公司写的是应用层，是 React、Flutter 这种，不是系统底层。他听完点点头，然后回我一句：“反正你是搞这些的，应该差不多吧。”那一刻我突然明白了，在他们眼里，技术不是分层的，也没有边界。会写代码的人，就理应能解决所有“会亮、会动、会卡”的东西。最后我只能折中，把手机清干净，只留微信，开简单模式，关掉通知和入口，看起来像那么回事。亲戚很满意，我却第一次在过年这件事上，感受到一种非常具体的职业错位。</p>
<p>后来我想通了，其实不是他们离谱，是我们活在完全不同的世界里。我在公司解决的是系统复杂度，他们在生活里要解决的是“别点错”。我写跨平台大前端，是为了效率和复用；他们让我把手机变成微信机，是为了安心。你说哪个需求更真实？可能都很真实。只是每年一回家，这种错位都会提醒我一件事：不管你在外面写过多复杂的代码，回到家，你依然只是那个“会搞手机的年轻人”。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[9.BTC-比特币脚本-北大肖臻老师客堂笔记]]></title>    <link>https://juejin.cn/post/7599604510366302246</link>    <guid>https://juejin.cn/post/7599604510366302246</guid>    <pubDate>2026-01-27T04:00:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599604510366302246" data-draft-id="7599614131423117321" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="9.BTC-比特币脚本-北大肖臻老师客堂笔记"/> <meta itemprop="keywords" content="前端,区块链"/> <meta itemprop="datePublished" content="2026-01-27T04:00:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端涂涂"/> <meta itemprop="url" content="https://juejin.cn/user/3740972207312249"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            9.BTC-比特币脚本-北大肖臻老师客堂笔记
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3740972207312249/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端涂涂
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T04:00:29.000Z" title="Tue Jan 27 2026 04:00:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>北京大学肖臻老师《区块链技术与应用》公开课第 9 讲的主题是**“比特币的脚本”**。本课深入探讨了比特币交易的底层结构、输入输出的关联以及脚本执行的逻辑。</p>
<p>以下是根据视频内容及你提供的图片进行的详细总结：</p>
<h3 data-id="heading-0">一、 比特币交易的宏观结构</h3>
<p>比特币的交易并非简单的“ A 转账给 B ”，而是一个包含多个字段的复杂 JSON 对象。</p>
<ul>
<li><strong>基础元数据</strong>：包括交易 ID (<code>txid</code>)、版本号、大小 (<code>size</code>) 和锁定时间 (<code>locktime</code>)。</li>
<li><strong>确认数 (<code>confirmations</code>)</strong>：表示该交易所在区块之后已经产生了多少个区块，确认数越多，交易越不可篡改。</li>
<li><strong>输入 (<code>vin</code>) 与输出 (<code>vout</code>)</strong>：这是交易的核心，每一笔交易都是将之前的输出作为现在的输入，并产生新的输出。</li>
</ul>
<h3 data-id="heading-1">二、 交易的输入与输出细节</h3>
<p>比特币通过脚本系统实现了资金的转移和锁定。</p>
<h4 data-id="heading-2">1. 交易输入 (<code>vin</code>)</h4>
<ul>
<li><strong>引用来源</strong>：每个输入必须指明资金来源，即前一笔交易的 ID (<code>txid</code>) 和对应的输出索引 (<code>vout</code>)。</li>
<li><strong>解锁脚本 (<code>scriptSig</code>)</strong>：包含发送者的数字签名和公钥，用于证明对这笔资金的所有权。</li>
</ul>
<h4 data-id="heading-3">2. 交易输出 (<code>vout</code>)</h4>
<ul>
<li><strong>金额 (<code>value</code>)</strong>：该输出对应的比特币数量。</li>
<li><strong>锁定脚本 (<code>scriptPubKey</code>)</strong>：定义了花费这笔钱的条件，通常要求提供能与特定公钥哈希匹配的签名。</li>
<li><strong>地址 (<code>addresses</code>)</strong>：虽然代码中显示为地址，但本质上是公钥哈希的 Base58 编码。</li>
</ul>
<h3 data-id="heading-4">三、 脚本执行逻辑：P2PKH</h3>
<p>比特币最常见的交易类型是 <strong>P2PKH</strong> (Pay-to-Pubkey-Hash)。其验证过程是将当前交易的 <code>scriptSig</code> 和前一笔交易的 <code>scriptPubKey</code> 拼接在一起执行。</p>
<p><strong>执行步骤如下（基于栈的操作）：</strong></p>
<ol>
<li><strong>PUSHDATA(Sig)</strong>：将签名压入栈。</li>
<li><strong>PUSHDATA(PubKey)</strong>：将公钥压入栈。</li>
<li><strong>DUP</strong>：复制栈顶的公钥。</li>
<li><strong>HASH160</strong>：将栈顶公钥进行哈希处理。</li>
<li><strong>PUSHDATA(PubKeyHash)</strong>：将预期的公钥哈希（来自锁定脚本）压入栈。</li>
<li><strong>EQUALVERIFY</strong>：比较两个哈希值是否一致。如果不一致，脚本执行失败。</li>
<li><strong>CHECKSIG</strong>：利用栈中的公钥验证签名的有效性。如果验证通过，返回 <strong>TRUE</strong>，交易合法。</li>
</ol>
<h3 data-id="heading-5">四、 全节点在脚本系统中的角色</h3>
<p>全节点是脚本执行的实际操作者：</p>
<ul>
<li><strong>验证合法性</strong>：全节点通过执行上述脚本，验证网络上每一笔交易的输入是否真实引用了有效的 UTXO，以及签名是否正确。</li>
<li><strong>维护 UTXO 集合</strong>：为了提高验证效率，全节点在<strong>内存</strong>中维护 UTXO 集合，这样在收到新交易时，无需扫描整个硬盘账本即可确认资金是否已被花费。</li>
<li><strong>决定打包逻辑</strong>：全节点在验证脚本通过后，才会将交易放入交易池，并决定是否将其打包进下一个区块。</li>
</ul>
<h3 data-id="heading-6">五、 核心名词总结</h3>
<ul>
<li><strong>ScriptSig</strong>：解锁脚本，证明“我有权花这笔钱”。</li>
<li><strong>ScriptPubKey</strong>：锁定脚本，规定“谁能花这笔钱”。</li>
<li><strong>Stack-based Language</strong>：比特币脚本是一种简单的、非图灵完备的、基于栈的编程语言，这种设计是为了安全，防止死循环攻击。</li>
<li><strong>UTXO (Unspent Transaction Output)</strong>：尚未被花费的交易输出，是比特币账本的基本组成单位。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b7d48066f8f44a5ab67db857f41b907~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5raC5raC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770091232&amp;x-signature=N3BE5%2F9ROTTeJ9QUM0jVnCed76c%3D" alt="9.BTC-比特币脚本.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[运维生存指南：Linux文本处理四剑客实战心法]]></title>    <link>https://juejin.cn/post/7599690133117927458</link>    <guid>https://juejin.cn/post/7599690133117927458</guid>    <pubDate>2026-01-27T04:01:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599690133117927458" data-draft-id="7599703627788795944" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="运维生存指南：Linux文本处理四剑客实战心法"/> <meta itemprop="keywords" content="运维,自动化运维"/> <meta itemprop="datePublished" content="2026-01-27T04:01:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="lihouyi"/> <meta itemprop="url" content="https://juejin.cn/user/4365493763322599"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            运维生存指南：Linux文本处理四剑客实战心法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4365493763322599/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    lihouyi
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T04:01:41.000Z" title="Tue Jan 27 2026 04:01:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Linux四剑客心法</h2>
<h3 data-id="heading-1">前言：为什么要学这些“老古董”？</h3>
<blockquote>
<p><strong>这不是一篇让你死记硬背参数的手册</strong>，这是一份帮你摆脱 GUI 依赖，在黑漆漆的终端里也能运指如飞的生存指南</p>
</blockquote>
<p>在 Linux 也就是服务器的世界里，我们没有 Excel，没有 VS Code。当你面对一个 2GB 的日志文件，老板问你“昨天那个 Bug 到底触发了几次？”时，熟练掌握四剑客，你能 3 秒出结果；否则，你只能把文件下载到本地把自己电脑卡死</p>
<p>我们将通过这四个工具，解决开发运维最真实的痛点：</p>






























<table><thead><tr><th align="left">命令</th><th align="left">核心特点</th><th align="left">典型应用场景</th></tr></thead><tbody><tr><td align="left">find</td><td align="left">唯一直接操作文件系统 inode</td><td align="left">在系统中查找文件，结合<code>-exec</code>批量处理</td></tr><tr><td align="left">grep</td><td align="left">速度快，擅长正则搜索</td><td align="left">从海量日志中查找报错信息、关键字</td></tr><tr><td align="left">sed</td><td align="left">流式非交互编辑</td><td align="left">修改配置文件、文本内容的增删改查</td></tr><tr><td align="left">awk</td><td align="left">编程语言，擅长列处理</td><td align="left">格式化报表、统计计算、逻辑判断</td></tr></tbody></table>
<h3 data-id="heading-2">基本功：避开那些 Shell 的坑</h3>
<h4 data-id="heading-3">引号</h4>
<p>使用四剑客命令时（特别是写在脚本中），除非涉及 Shell 变量扩展（需要<code>$VAR</code>），否则请**一律使用单引号<code>''</code>**包裹处理逻辑</p>
<blockquote>
<p>说人话就是：别给自己找麻烦，**永远优先用单引号 **。只有明确知道需要 Shell 帮你把变量换成值的时候，再用双引号</p>
</blockquote>





















<table><thead><tr><th>引号</th><th>含义</th></tr></thead><tbody><tr><td>单引号</td><td>所见即所得，单引号里面内容原封不动输出，不进行任何解析</td></tr><tr><td>双引号</td><td>弱引用，允许进行<strong>变量替换</strong>和<strong>转义处理</strong> ，但不会执行命令替换，不解析{}和通配符</td></tr><tr><td>反引号</td><td><strong>优先执行</strong>，先执行反引号里面的命令，会进行<strong>命令替换</strong></td></tr></tbody></table>
<h4 data-id="heading-4">重定向</h4>
<blockquote>
<p>Unix/Linux中，进程启动时自带三个通道：<code>stdin(0)</code>、<code>stdout(1)</code>、<code>stderr(2)</code></p>
</blockquote>


















































<table><thead><tr><th align="left">符号</th><th align="left">描述</th><th align="left">典型用法</th></tr></thead><tbody><tr><td align="left"><code>&gt;</code> 或 <code>1&gt;</code></td><td align="left">标准输出覆盖</td><td align="left"><code>echo "ok" &gt; status.txt</code></td></tr><tr><td align="left"><code>&gt;&gt;</code> 或 <code>1&gt;&gt;</code></td><td align="left">标准输出追加</td><td align="left"><code>echo "log entry" &gt;&gt; app.log</code></td></tr><tr><td align="left"><code>2&gt;</code></td><td align="left">标准错误覆盖</td><td align="left"><code>ls non_exist_file 2&gt; error.log</code></td></tr><tr><td align="left"><code>2&gt;&gt;</code></td><td align="left">标准错误追加</td><td align="left"><code>ls non_exist_file 2&gt;&gt; error.log</code></td></tr><tr><td align="left"><code>2&gt;&amp;1</code></td><td align="left">错误重定向到标准输出</td><td align="left"><code>command &gt; all.log 2&gt;&amp;1</code></td></tr><tr><td align="left"><code>&amp;&gt;</code></td><td align="left">混合输出（Bash特有）</td><td align="left"><code>command &amp;&gt; all.log</code>（等同于上一行）</td></tr><tr><td align="left"><code>&lt;</code></td><td align="left">标准输入重定向</td><td align="left"><code>xargs &lt; file_list.txt</code></td></tr><tr><td align="left"><code>&lt;&lt;</code></td><td align="left">Here Document</td><td align="left">用于脚本中内联多行输入</td></tr></tbody></table>
<blockquote>
<p><strong><code>&amp;</code> 的作用就是“引用文件描述符”</strong>，而不是当作普通文件名</p>
</blockquote>
<p>常见使用</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 丢弃 stdout（只看报错）</span>
ping example.com &gt; /dev/null

<span class="hljs-comment"># 丢弃 stderr（屏蔽报错）</span>
<span class="hljs-built_in">rm</span> invalid_file 2&gt; /dev/null

<span class="hljs-comment"># 丢弃所有输出（世界清静了）</span>
<span class="hljs-built_in">command</span> &gt; /dev/null 2&gt;&amp;1

<span class="hljs-comment"># 既输出到屏幕，又写入文件</span>
<span class="hljs-built_in">command</span> 2&gt;&amp;1 | <span class="hljs-built_in">tee</span> -a file.log
</code></pre>
<h4 data-id="heading-5">通配符</h4>
<p>用于给 Linux 中大部分命令使用，用于批量找文件名（找文件）</p>



































<table><thead><tr><th>符号</th><th>含义</th><th>示例</th></tr></thead><tbody><tr><td><code>*</code></td><td>匹配任意长度字符</td><td><code>*.log</code>（所有 log 文件）</td></tr><tr><td><code>?</code></td><td>匹配任意<strong>一个</strong>字符</td><td><code>file?.txt</code>（匹配 file1.txt）</td></tr><tr><td><code>{}</code></td><td>输出序列，通常与echo、touch、mkdir配合使用</td><td><code>mkdir /data/{log,conf}</code>（创建两个目录）</td></tr><tr><td><code>[]</code></td><td>同正则用法，匹配括号内的任一字符</td><td><code>file[123].txt</code></td></tr><tr><td><code>[!]</code>、<code>[^]</code></td><td>取反</td><td/></tr></tbody></table>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 输出等宽的数字序列 01 02 03 10   001 002 ... 100</span>
<span class="hljs-built_in">echo</span> {01..10}
<span class="hljs-built_in">echo</span> {01..100}

<span class="hljs-comment"># 输出1 3 5 7 9</span>
<span class="hljs-built_in">echo</span> {1..10..2}

<span class="hljs-comment"># A AC AB</span>
<span class="hljs-built_in">echo</span> A{,C,B}

<span class="hljs-comment"># 找出/bin目录下面命令,命令仅有2个字符组成</span>
<span class="hljs-built_in">ls</span> -l /bin/??
</code></pre>
<h4 data-id="heading-6">Xargs 的前世今生</h4>
<p>你是否疑惑过：**为什么要用 xargs？**想象一下管道<code>|</code>是一根水管，流过来的是“水”（文本流）。但是 rm、mv 这些命令，它们不喝水，它们要的是“瓶装水”（一个个参数）</p>
<p><strong>Xargs 就是那个把水装进瓶子里的适配器</strong></p>
<ul>
<li>❌ 错误：<code>find . -name "*.log" | rm</code>（rm 不读水管里的字）</li>
<li>✅ 正确：<code>find . -name "*.log" | xargs rm</code>（xargs 把字喂到 rm 的参数位）</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">[输入源] | xargs [选项] [目标命令] [目标命令的选项]
</code></pre>

































<table><thead><tr><th>常用选项</th><th>含义</th></tr></thead><tbody><tr><td><code>-n&lt;数字&gt;</code></td><td>指定每次传递的参数个数</td></tr><tr><td>-I 占位符</td><td>定义占位符（通常用<code>{}</code>），用于需要将参数插入命令中间的场景</td></tr><tr><td>-0</td><td>配合 <code>find -print0</code> 使用，处理文件名中的空格或特殊字符</td></tr><tr><td><code>-p</code></td><td>交互式确认每次操作（输入y才会执行）</td></tr><tr><td><code>-t</code></td><td>打印要执行的命令（<strong>命令仍执行</strong>）</td></tr><tr><td>-d&lt;定界符&gt;</td><td/></tr></tbody></table>
<p><strong>实战案例</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查找所有.txt文件并删除</span>
find . -name <span class="hljs-string">'*.txt'</span> | xargs <span class="hljs-built_in">rm</span>

<span class="hljs-comment"># 将找到的.log文件移动到/backup目录</span>
find . -name <span class="hljs-string">'*.log'</span> | xargs -I {} <span class="hljs-built_in">mv</span> {} /backup

<span class="hljs-comment"># 批量重命名文件</span>
find . -name <span class="hljs-string">'*.jpg'</span> | xargs -I {} <span class="hljs-built_in">mv</span> {} {}.bak

<span class="hljs-comment"># 在所有.py文件中搜索"import numpy"</span>
find . -name <span class="hljs-string">'*.py'</span> | xargs grep <span class="hljs-string">'import numpy'</span>

<span class="hljs-comment"># 批量修改权限</span>
find /data -<span class="hljs-built_in">type</span> f | xargs <span class="hljs-built_in">chmod</span> 644

<span class="hljs-comment"># 处理文件名中的空格或特殊字符</span>
<span class="hljs-comment"># 文件名中可以包含空格、换行、制表符甚至 \n，而传统用换行分隔的方式会被这些特殊字符“欺骗”，导致文件名被错误拆分</span>
<span class="hljs-comment"># -print0：不会在每个文件名后加换行符（\n），而是用 空字符（null character, \0） 分隔每个文件名</span>
<span class="hljs-comment"># xargs -0：告诉 xargs 输入项是以空字符 \0 分隔的</span>
find . -name <span class="hljs-string">'*.mp3'</span> -print0 | xargs -0 <span class="hljs-built_in">rm</span>

<span class="hljs-comment"># 批量打包</span>
find /etc/ -<span class="hljs-built_in">type</span> f -name <span class="hljs-string">'*.conf'</span> | xargs tar zcf /backup/etc-conf-v2.tar.gz

<span class="hljs-comment"># 输出 name name name name</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">'nameXnameXnameXname'</span> | xargs -dX
</code></pre>
<h3 data-id="heading-7">Find</h3>
<p><code>find</code>是四剑客中唯一直接扫描<strong>文件系统 inode</strong>的重型武器。它不看内容，只看“户口本”（文件名、时间、权限、大小）</p>
<pre><code class="hljs language-bash" lang="bash">find [路径] [条件] [动作]
</code></pre>













































<table><thead><tr><th>维度</th><th>选项</th><th>作用</th></tr></thead><tbody><tr><td>名称</td><td>-name</td><td>指定文件名，默认精确匹配（加上*为模糊匹配）</td></tr><tr><td/><td>-iname</td><td>文件名不区分大小写</td></tr><tr><td>类型</td><td>-type [类型]</td><td>指定文件类型（f、d、l、s-套接字、b-块设备、c-字符设备）</td></tr><tr><td>大小</td><td>-size [+/-]N[单位]</td><td>指定文件大小范围，+10M -100k -10G</td></tr><tr><td>深度</td><td>-maxdepth</td><td>指定查找文件深度</td></tr><tr><td>时间</td><td>-mtime、-atime、-ctime</td><td>指定文件时间</td></tr><tr><td>权限</td><td>-perm [权限模式]</td><td>644 (精确匹配)、/u=s (包含 SUID)</td></tr></tbody></table>
<blockquote>
<p>尽量不要直接在<code>/</code>目录执行无条件的<code>find</code>，这会把磁盘 I/O 打满。一定要用<code>-maxdepth</code>或指定具体子目录！</p>
</blockquote>
<p><strong>实战案例</strong></p>
<ul>
<li>按文件名、文件类型、文件大小、用户/组、搜索深度</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 文件名</span>
find /path -name <span class="hljs-string">'file[0-9].txt'</span>       <span class="hljs-comment"># 查找file1.txt, file2.txt等</span>

<span class="hljs-comment"># 文件类型</span>
find /path -<span class="hljs-built_in">type</span> f -name <span class="hljs-string">'*.log'</span>       <span class="hljs-comment"># 查找/var/log下所有.log文件</span>

<span class="hljs-comment"># 文件大小</span>
find /path -size +5M -size -15M        <span class="hljs-comment"># 查找大于5M小于15M的文件</span>

<span class="hljs-comment"># 用户/组</span>
find /path -user root                  <span class="hljs-comment"># 查找属于root用户的文件</span>
find /path -group www-data             <span class="hljs-comment"># 查找属于www-data组的文件</span>

<span class="hljs-comment"># 搜索深度</span>
find /path -maxdepth 2 -name <span class="hljs-string">'*.conf'</span>  <span class="hljs-comment"># 仅搜索两层目录</span>
find /path -mindepth 3 -name <span class="hljs-string">'*.log'</span>   <span class="hljs-comment"># 从第三层目录开始搜索</span>
</code></pre>
<ul>
<li>按权限</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查找权限为644的文件</span>
find /path -perm 644

<span class="hljs-comment"># 查找SUID权限的文件</span>
find /path -perm /u=s

<span class="hljs-comment"># 查找组可写的文件</span>
find /path -perm /g=w
</code></pre>
<ul>
<li>按时间</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 找出 7 天前修改过的日志</span>
find /var/log -name <span class="hljs-string">'*.log'</span> -mtime +7

<span class="hljs-comment"># 找出 1 小时内被访问过的配置文件</span>
find /etc -name <span class="hljs-string">'*.conf'</span> -atime -60

<span class="hljs-comment"># 找出最近 24 小时内权限被修改的文件（安全审计！）</span>
find / -ctime -1440 -<span class="hljs-built_in">type</span> f
</code></pre>
<ul>
<li>组合条件</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 同时满足名称和类型条件</span>
find /path -name <span class="hljs-string">'*.log'</span> -<span class="hljs-built_in">type</span> f

<span class="hljs-comment"># 查找jpg或png文件</span>
find /path \( -name <span class="hljs-string">'*.jpg'</span> -o -name <span class="hljs-string">'*.png'</span> \)

<span class="hljs-comment"># 排除.tmp文件</span>
find /path ! -name <span class="hljs-string">'*.tmp'</span>
</code></pre>
<ul>
<li>
<p>与xargs连用（见上文）</p>
</li>
<li>
<p>与-exec连用:star::star::star::star::star:</p>
</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 对每个匹配的文件，单独调用一次命令</span>
find [路径] [条件] -<span class="hljs-built_in">exec</span> [命令] {} \;

<span class="hljs-comment"># 合并所有匹配的文件路径，一次性执行</span>
find [路径] [条件] -<span class="hljs-built_in">exec</span> [命令] {} +
</code></pre>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 批量压缩文件，相当于执行 gzip file1.log file2.log file3.log</span>
find /data -name <span class="hljs-string">"*.log"</span> -<span class="hljs-built_in">exec</span> gzip {} +
<span class="hljs-comment"># 批量打包文件</span>
find /data -name <span class="hljs-string">"*.log"</span> -<span class="hljs-built_in">type</span> f -<span class="hljs-built_in">exec</span> tar -cvf test.tar.gz {} +

<span class="hljs-comment"># 相当于对每个.tmp文件执行 rm file1.tmp; rm file2.tmp</span>
find /tmp -name <span class="hljs-string">"*.tmp"</span> -<span class="hljs-built_in">exec</span> <span class="hljs-built_in">rm</span> {} \;

<span class="hljs-comment"># 删除7天前的日志文件</span>
find /var/log -name <span class="hljs-string">"*.log"</span> -mtime +7 -<span class="hljs-built_in">exec</span> <span class="hljs-built_in">rm</span> {} \;

<span class="hljs-comment"># 将找到的.jpg文件备份到/backup</span>
find . -name <span class="hljs-string">"*.jpg"</span> -<span class="hljs-built_in">exec</span> <span class="hljs-built_in">cp</span> {} /backup \;

<span class="hljs-comment"># 对每个找到的.csv文件运行分析脚本</span>
find /reports -name <span class="hljs-string">"sales_*.csv"</span> -<span class="hljs-built_in">exec</span> ./analyze.sh {} \;

<span class="hljs-comment"># 先压缩文件，再删除原文件</span>
find . -name <span class="hljs-string">"*.txt"</span> -<span class="hljs-built_in">exec</span> gzip {} \; -<span class="hljs-built_in">exec</span> <span class="hljs-built_in">rm</span> {} \;

<span class="hljs-comment"># 默认已正确处理空格/特殊字符（无需像xargs那样用-print0）</span>
find . -name <span class="hljs-string">"*.doc"</span> -<span class="hljs-built_in">exec</span> <span class="hljs-built_in">mv</span> {} ~/Documents \;

<span class="hljs-comment"># 删除3.10之前的以.dbf结尾的文件</span>
find ./ -name <span class="hljs-string">"*.dbf"</span> ! -newermt <span class="hljs-string">"2025-03-10"</span> -<span class="hljs-built_in">exec</span> <span class="hljs-built_in">rm</span> {} \;
</code></pre>






























<table><thead><tr><th align="left">特性</th><th align="left"><code>xargs</code></th><th align="left"><code>find -exec</code></th></tr></thead><tbody><tr><td align="left">执行效率</td><td align="left">高（批量传递参数）</td><td align="left">低（逐行执行）</td></tr><tr><td align="left">参数长度限制</td><td align="left">自动分割参数</td><td align="left">受系统参数长度限制</td></tr><tr><td align="left">特殊字符处理</td><td align="left">需配合 <code>-print0</code> 和 <code>-0</code></td><td align="left">原生支持</td></tr><tr><td align="left">灵活性</td><td align="left">可结合其他命令（如 <code>grep</code>）</td><td align="left">仅限 <code>find</code> 找到的文件</td></tr></tbody></table>
<h3 data-id="heading-8">Grep</h3>
<p><code>grep</code>（Global Regular Expression Print）是一个强大的文本搜索命令，支持使用<strong>正则表达式</strong>在文件中查找匹配的行，并将其输出</p>
<p><code>grep</code>是查看日志、代码搜索最高频的工具，<strong>快</strong>是它的代名词</p>
<pre><code class="hljs language-bash" lang="bash">grep [option] pattern file
</code></pre>

































































<table><thead><tr><th>常用参数</th><th>含义</th></tr></thead><tbody><tr><td><code>-A n</code> / <code>-B n</code> / <code>-C n</code></td><td>显示匹配行后<code>n</code>行 / 前<code>n</code>行 / 前后各<code>n</code>行</td></tr><tr><td><code>-i</code></td><td>忽略大小写</td></tr><tr><td><code>-v</code></td><td><strong>反选</strong>，显示不匹配的行</td></tr><tr><td><code>-n</code></td><td>显示匹配行的<strong>行号</strong></td></tr><tr><td><code>-l</code></td><td>只列出匹配内容的<strong>文件名</strong>，不看具体内容</td></tr><tr><td>-c</td><td>仅输出匹配的<strong>行数</strong>，不显示内容</td></tr><tr><td>-w</td><td>精确匹配整个单词（避免匹配到包含该子串的词）</td></tr><tr><td>-o</td><td>仅输出匹配的<strong>字符串本身</strong>（每行一个匹配项）</td></tr><tr><td><code>-r/-R</code></td><td>递归搜索目录（<code>-R</code>会跟随符号链接）</td></tr><tr><td><code>-E</code></td><td>支持拓展正则，<strong>等同于egrep</strong></td></tr><tr><td>-P</td><td>开启 Perl 兼容正则（支持更高级正则，如零宽断言）</td></tr><tr><td>-q</td><td>静默模式，不输出任何信息</td></tr><tr><td>-e &lt;范本样式&gt;</td><td>指定字符串作为查找文件内容的范本样式</td></tr><tr><td><code>--color</code></td><td>高亮显示匹配内容（现代系统通常默认开启）</td></tr></tbody></table>
<p><strong>实战案例</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 在 去掉注释行和空行</span>
grep -Ev <span class="hljs-string">"^$|^#"</span> /etc/nginx/nginx.conf

<span class="hljs-comment"># 或者使用拓展正则</span>
egrep -v <span class="hljs-string">'^$|^#'</span> /etc/ssh/sshd_config

<span class="hljs-comment"># 查找 500 错误及其前 2 行和后 3 行上下文</span>
grep <span class="hljs-string">"500 Internal Server Error"</span> -B 2 -A 3 access.log

<span class="hljs-comment"># 统计 IP 地址出现的次数（提取 + 排序 + 统计）</span>
grep -oE <span class="hljs-string">"[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+"</span> access.log | <span class="hljs-built_in">sort</span> | <span class="hljs-built_in">uniq</span> -c | <span class="hljs-built_in">sort</span> -nr

<span class="hljs-comment"># 检测程序是否在运行 (排除 grep 进程自身)</span>
ps aux | grep nginx | grep -v grep

<span class="hljs-comment"># -r: 递归查找目录 (程序员找代码神器)</span>
grep -r <span class="hljs-string">"TODO"</span> ./src
</code></pre>
<h3 data-id="heading-9">Sed</h3>
<p>sed（Stream Editor）是流水线式的<strong>非交互编辑器</strong>，其工作模式如下：</p>
<ul>
<li>Read：读一行到内存（模式空间）</li>
<li>Execute：在内存里动刀子（改）</li>
<li>Print：改完扔回流水线（输出）</li>
<li>Repeat：清空模式空间，读下一行</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">sed [选项] <span class="hljs-string">'[地址范围]操作'</span> 文件
</code></pre>
<blockquote>
<p><strong>注意</strong>：Sed 默认不修改原文件，只有加上<code>-i</code>才会修改，最好是先预览确认没问题后再加上<code>-i</code>修改原文件</p>
</blockquote>





























<table><thead><tr><th>匹配范围（模式）</th><th>说明</th></tr></thead><tbody><tr><td>空地址</td><td>全文处理</td></tr><tr><td>单地址</td><td>指定文件某一行</td></tr><tr><td>/pattern/</td><td>被模式匹配到的每一行</td></tr><tr><td>范围区间</td><td><code>10,20</code>十到二十行<br/><code>10,+5</code>十向下五行<br/><code>1,$</code>一到末尾行<br/><code>/pattern1/,/pattern2/</code>限定范围区间</td></tr><tr><td>步长</td><td>1<del>2：表示奇数行，2</del>2：表示偶数行</td></tr></tbody></table>

































<table><thead><tr><th>常用选项</th><th>说明</th></tr></thead><tbody><tr><td><code>-n</code></td><td>只输出符合要求行，与p组合使用（默认全输出）</td></tr><tr><td><code>-r</code></td><td>开启<strong>扩展正则</strong></td></tr><tr><td><code>-i</code></td><td>直接修改文件内容（危险操作）<strong>只有使用该选项才会修改原文件</strong></td></tr><tr><td>-i.bak</td><td>在将处理的结果写入文件之前备份一份</td></tr><tr><td>-e&lt;script&gt;</td><td>以选项中指定的script来处理输入的文本文件</td></tr><tr><td>-f&lt;script&gt;</td><td>以选项中指定的script文件来处理输入的文本文件</td></tr></tbody></table>





































<table><thead><tr><th>内置命令字符（动作）</th><th>说明</th></tr></thead><tbody><tr><td><code>a</code>（append）</td><td>在指定行<strong>下面</strong>添加一/多行文本</td></tr><tr><td><code>i</code>（insert）</td><td>在指定行<strong>上面</strong>添加一/多行文本</td></tr><tr><td><code>c</code>（change）</td><td>替换指定整行</td></tr><tr><td><code>w</code>（write）</td><td>将找到的行保存到新的文件中</td></tr><tr><td><code>d</code>（delete）</td><td>删除匹配行</td></tr><tr><td><code>p</code>（print）</td><td>打印匹配行的内容（与-n连用）</td></tr><tr><td><code>s/正则/替换内容/g</code></td><td>匹配正则内容，然后替换，g为全局匹配。替换时可以加以下命令，实现大小写转换<br/>\l：把下个字符转换成小写<br/>\L：把replacement字母转换成小写，直到\U或\E出现<br/>\u：把下个字符转换成大写<br/>\U：把replacement字母转换成大写，直到\L或\E出现<br/>\E：停止以\L或\U开始的大小写转换</td></tr></tbody></table>
<p><strong>实战案例</strong></p>
<pre><code class="hljs language-bash" lang="bash">sed <span class="hljs-string">'模式 动作'</span> 文件
</code></pre>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cat</span> &gt; test.txt &lt;&lt;<span class="hljs-string">EOF
1. Linux is kernel.
2. Python is language.
3. Database is storage.
4. Nginx is web server.
EOF</span>
</code></pre>
<ul>
<li>查</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 打印第2行</span>
sed -n <span class="hljs-string">'2p'</span> test.txt

<span class="hljs-comment"># 打印2到3行</span>
sed -n <span class="hljs-string">'2,3p'</span> test.txt

<span class="hljs-comment"># 打印最后一行</span>
sed -n <span class="hljs-string">'$p'</span> test.txt

<span class="hljs-comment"># 打印包含 "Linux" 的行</span>
sed -n <span class="hljs-string">'/Linux/p'</span> test.txt

<span class="hljs-comment"># 范围匹配：从包含 Python 的行开始，到包含 Nginx 的行结束</span>
sed -n <span class="hljs-string">'/Python/,/Nginx/p'</span> test.txt
</code></pre>
<ul>
<li>删</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 删除空行</span>
sed <span class="hljs-string">'/^$/d'</span> test.txt

<span class="hljs-comment"># 删除第3行</span>
sed <span class="hljs-string">'3d'</span> test.txt

<span class="hljs-comment"># 删除包含 "Database" 的行</span>
sed <span class="hljs-string">'/Database/d'</span> test.txt
</code></pre>
<ul>
<li>改</li>
</ul>
<p>替换语法，支持很多分隔符：<code>@、#、/</code></p>
<pre><code class="hljs language-bash" lang="bash">s/正则/替换内容/g
</code></pre>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 将 is 替换为 WAS</span>
sed <span class="hljs-string">'s/is/WAS/g'</span> test.txt

<span class="hljs-comment"># 分隔符冲突时，可用 # 或 @ 替代 /</span>
sed <span class="hljs-string">'s#/bin/bash#/sbin/nologin#g'</span> /etc/passwd

<span class="hljs-comment"># 将 "hello world" 换成 "world hello"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"hello world"</span> | sed -r <span class="hljs-string">'s/(\w+) (\w+)/\2 \1/'</span>
</code></pre>
<ul>
<li>增</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 在第2行后面添加一行</span>
sed <span class="hljs-string">'2a New Line Here'</span> test.txt

<span class="hljs-comment"># 在最后一行添加</span>
sed <span class="hljs-string">'$a The End.'</span> test.txt

<span class="hljs-comment"># 2~4行数据写到new.txt</span>
sed <span class="hljs-string">'2,4w new.txt'</span> test.txt
</code></pre>
<h3 data-id="heading-10">awk</h3>
<p><code>awk</code>是一种处理文本文件的编程语言，文件的每行数据都被称为<code>记录</code>，每条记录被分成若干<code>字段</code>，每次从文件中读取一条记录</p>
<p><code>awk</code>由一系列<strong>条件</strong>和<strong>动作</strong>组成，可以包含多个动作，用<code>;</code>分隔。<strong>若没指定条件则匹配所有数据，没指定动作则默认为print</strong>，awk默认支持拓展正则表达式</p>
<pre><code class="hljs language-bash" lang="bash">awk [options] <span class="hljs-string">'BEGIN{...} Pattern{...} END{...}'</span> 文件
</code></pre>
<ul>
<li><code>BEGIN {}</code>：在读第一行之前执行（打印表头、定义变量）</li>
<li><code>Pattern {Action}</code>：每一行都执行一次。主处理逻辑</li>
<li><code>END {}</code>：全部行读完后执行（输出统计结果）</li>
</ul>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A["BEGIN{ ... }"] --&gt;|1.预处理: 设分隔符/打印表头| B("Loop: 读一行，切一刀")
    B --&gt;|2.主逻辑: 计算/判断/过滤| B
    B --&gt;|3.读完所有行| C["END{ ... }"]
    C --&gt;|4.最终汇总: 输出统计总数| End
</code></pre>
<blockquote>
<p>平时我们写的 <code>awk '{print $1}'</code>，其实就是中间的 <strong>Loop</strong> 部分。BEGIN 和 END 是可选的</p>
</blockquote>





















<table><thead><tr><th>选项</th><th>说明</th></tr></thead><tbody><tr><td>-F [分隔符]</td><td>指定分隔符，可以为字符串或正则表达式（默认为连续的空格或制表符）</td></tr><tr><td>-v var=value</td><td>赋值一个用户定义变量，将外部变量传递给awk</td></tr><tr><td>-f scriptfile</td><td>从脚本文件中读取awk</td></tr></tbody></table>

















































<table><thead><tr><th>内置变量</th><th>描述</th></tr></thead><tbody><tr><td>FILENAME</td><td>当前输入文档的名称</td></tr><tr><td>FNR</td><td>当前输入文档的当前行号，尤其当有多个输入文档时有用</td></tr><tr><td><code>NR</code>（Number of Record）</td><td><strong>当前行号</strong></td></tr><tr><td><code>$0</code></td><td>当前行全部数据</td></tr><tr><td><code>$n</code></td><td>当前行第n个字段内容（不要用<code>""</code>包裹）</td></tr><tr><td><code>NF</code>（Number of Fields）</td><td>当前记录（行）的字段个数，即<strong>列数</strong></td></tr><tr><td>FS（Field Separator）</td><td>字段分隔符，默认为空格或Tab制表符</td></tr><tr><td>OFS</td><td>输出字段分隔符，默认为空格</td></tr><tr><td>ORS</td><td>输出记录分隔符，默认为\n</td></tr><tr><td>RS</td><td>输入记录分隔符，默认为\n</td></tr></tbody></table>
<ul>
<li>取数据</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 按列输出</span>
<span class="hljs-built_in">df</span> -h | awk <span class="hljs-string">'{print $2}'</span>		    <span class="hljs-comment"># 逐行打印第2列</span>
<span class="hljs-built_in">df</span> -h | awk <span class="hljs-string">'{print NR}'</span>		    <span class="hljs-comment"># 输出行号</span>
<span class="hljs-built_in">df</span> -h | awk <span class="hljs-string">'{print NF}'</span>		    <span class="hljs-comment"># 输出每行数据的列数</span>
<span class="hljs-built_in">df</span> -h | awk <span class="hljs-string">'{print $NF}'</span> 	       <span class="hljs-comment"># 打印每行数据的最后一列</span>
<span class="hljs-built_in">df</span> -h | awk <span class="hljs-string">'{print $(NF-1)}'</span>      <span class="hljs-comment"># 打印每行倒数第二列</span>
<span class="hljs-built_in">df</span> -h | awk <span class="hljs-string">'{print $0}'</span>	        <span class="hljs-comment"># 打印每行全部内容</span>
<span class="hljs-built_in">df</span> -h | awk <span class="hljs-string">'{print $1 "\t" $2}'</span> | column -t  <span class="hljs-comment"># 使用制表符，需要添加双引号</span>

<span class="hljs-comment"># 按行输出</span>
<span class="hljs-built_in">df</span> -h | awk <span class="hljs-string">'NR&gt;=2 &amp;&amp; NR&lt;=5'</span>
<span class="hljs-built_in">df</span> -h | awk <span class="hljs-string">'NR==2'</span>
</code></pre>
<ul>
<li>做统计</li>
</ul>
<p>配合 sort 和 uniq，这是面试必考题</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 统计 Nginx 日志中访问最多的 5 个 IP</span>
<span class="hljs-comment"># $1 是 IP 列</span>
awk <span class="hljs-string">'{print $1}'</span> access.log | <span class="hljs-built_in">sort</span> | <span class="hljs-built_in">uniq</span> -c | <span class="hljs-built_in">sort</span> -nr | <span class="hljs-built_in">head</span> -5
</code></pre>
<ul>
<li>逻辑判断</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 过滤第四列以0或1开头行，输出第1，3列</span>
awk -F <span class="hljs-string">':'</span> <span class="hljs-string">'$4 ~ /^[01]/ {print $1,$3}'</span> /etc/passwd

<span class="hljs-comment"># 取第三列大于100的行</span>
awk -F<span class="hljs-string">':'</span> <span class="hljs-string">'$3&gt;=100{print $1,$3,$NF}'</span> /etc/passwd | column -t
</code></pre>
<ul>
<li>做计算</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 统计某个目录下所有文件的总大小</span>
<span class="hljs-comment"># ls -l 输出：-rw-r--r-- 1 root root  1024  Jan 1 filename</span>
<span class="hljs-built_in">ls</span> -l | awk <span class="hljs-string">'
{ sum += $5 } 
END { print "Total: " sum/1024 " KB" }'</span>
</code></pre>
<ul>
<li>模糊过滤</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 过滤出包含root或nobody的行</span>
awk <span class="hljs-string">'/root|nobody/'</span> /etc/passwd

<span class="hljs-comment"># 从包含root的行到包含nobody的行</span>
awk <span class="hljs-string">'/root/,/nobody/'</span> /etc/passwd
</code></pre>
<ul>
<li>自定义变量</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">awk -v x=<span class="hljs-string">"bob"</span> -v y=10 <span class="hljs-string">'{print x,y}'</span> /tmp/hosts

<span class="hljs-comment"># 直接调用系统变量</span>
awk -v shell=<span class="hljs-variable">$SHELL</span> <span class="hljs-string">'{print shell}'</span> /tmp/hosts
awk <span class="hljs-string">'{print "'</span><span class="hljs-variable">$SHELL</span><span class="hljs-string">'"}'</span> /tmp/hosts
</code></pre>
<h3 data-id="heading-11">结语</h3>
<p>不要试图一次性背下所有的参数，不需要也没必要</p>
<ul>
<li>找文件，用 find</li>
<li>搜内容，用 grep</li>
<li>改文件，用 sed</li>
<li>做统计，用 awk</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ESLint 批量抑制：技术债治理的正确打开方式]]></title>    <link>https://juejin.cn/post/7599652649549922304</link>    <guid>https://juejin.cn/post/7599652649549922304</guid>    <pubDate>2026-01-27T02:38:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599652649549922304" data-draft-id="7599598627007316020" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ESLint 批量抑制：技术债治理的正确打开方式"/> <meta itemprop="keywords" content="前端,JavaScript,React.js"/> <meta itemprop="datePublished" content="2026-01-27T02:38:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="百慕大三角"/> <meta itemprop="url" content="https://juejin.cn/user/1882827191748744"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ESLint 批量抑制：技术债治理的正确打开方式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1882827191748744/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    百慕大三角
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T02:38:02.000Z" title="Tue Jan 27 2026 02:38:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">ESLint 批量抑制：技术债治理的正确打开方式</h2>
<h3 data-id="heading-1">引子：一个技术 Leader 的困境</h3>
<p>作为技术 Leader，你可能遇到过这样的场景：</p>
<p>团队维护着一个两年前的 React 项目，20 万行代码，技术债堆积如山。你想推动代码质量提升，在团队会议上提议："我们开启 <code>@typescript-eslint/no-explicit-any</code> 规则吧，减少 <code>any</code> 的滥用。"</p>
<p>然后你在本地试运行了一下：</p>
<pre><code class="hljs language-bash" lang="bash">$ eslint .
✖ 1,247 problems (1,247 errors, 0 warnings)
</code></pre>
<p><strong>1,247 个错误</strong>。</p>
<p>你的第一反应可能是："算了，还是别开了。" 团队成员也松了一口气——毕竟谁也不想在 JIRA 里看到一个"修复 1,247 个 Lint 错误"的任务。</p>
<p>但问题是，如果现在不开启规则，新代码还会继续使用 <code>any</code>，技术债只会越滚越大。这就是典型的"<strong>存量问题拖累增量改进</strong>"的困境。</p>
<p>今天要介绍的 <strong>ESLint 批量抑制（Bulk Suppressions）</strong> 功能，就是为了解决这个问题而生的。</p>
<h3 data-id="heading-2">核心思路：既往不咎，严控增量</h3>
<p>批量抑制的核心理念可以用八个字概括：<strong>既往不咎，严控增量</strong>。</p>
<h4 data-id="heading-3">工作机制</h4>
<p>当你启用批量抑制后，ESLint 会做三件事：</p>
<ol>
<li><strong>记录现状</strong>：将当前所有违规记录到 <code>eslint-suppressions.json</code> 文件中</li>
<li><strong>暂时放行</strong>：对于已记录的旧代码违规，ESLint 暂时忽略，CI/CD 正常通过</li>
<li><strong>严格卡控</strong>：对于新增的代码，规则立即生效，任何新违规都会报错</li>
</ol>
<p>看一个实际的抑制文件示例：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"suppressions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"ruleId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"@typescript-eslint/no-explicit-any"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"file"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"src/components/UserProfile.tsx"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"count"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">12</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"ruleId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"@typescript-eslint/no-explicit-any"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"file"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"src/utils/request.ts"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"count"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">8</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>这个文件告诉 ESLint："UserProfile.tsx 文件里有 12 个 <code>any</code>，这是历史遗留问题，暂时放过。但如果出现第 13 个，立即报错。"</p>
<h4 data-id="heading-4">监控机制</h4>
<p>批量抑制不是"一抑了之"，而是有严格的监控：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/components/UserProfile.tsx</span>
<span class="hljs-comment">// 已记录 12 个 any，当前 12 个 →  通过</span>

<span class="hljs-comment">// 如果开发者新增了一个 any：</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleData</span>(<span class="hljs-params">data: <span class="hljs-built_in">any</span></span>) {  <span class="hljs-comment">// 这是第 13 个！</span>
  <span class="hljs-comment">// ...</span>
}

<span class="hljs-comment">// ESLint 会立即报告该文件的所有违规：</span>
<span class="hljs-comment">// ✖ 13 problems in src/components/UserProfile.tsx</span>
</code></pre>
<p>一旦违规数超标，ESLint 会暴露<strong>该文件的所有问题</strong>，倒逼开发者要么修复新问题，要么顺手把旧问题也一起解决。</p>
<h3 data-id="heading-5">实战：在 React + TypeScript 项目中落地</h3>
<h4 data-id="heading-6">场景设定</h4>
<p>假设你负责一个电商项目，技术栈是 React + TypeScript，团队 8 人，代码库现状：</p>
<ul>
<li>150+ 个组件文件</li>
<li>TypeScript 配置较宽松（<code>strict: false</code>）</li>
<li>大量使用 <code>any</code>、非空断言、隐式类型转换</li>
<li>团队对"突然冒出的几百个 Lint 错误"非常抵触</li>
</ul>
<p>你的目标是：<strong>在不影响现有开发节奏的前提下，逐步提升代码质量</strong>。</p>
<h4 data-id="heading-7">第一步：评估现状</h4>
<p>先看看如果直接开启严格规则会怎样：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// eslint.config.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> [
  {
    <span class="hljs-attr">files</span>: [<span class="hljs-string">"**/*.{ts,tsx}"</span>],
    <span class="hljs-attr">rules</span>: {
      <span class="hljs-string">"@typescript-eslint/no-explicit-any"</span>: <span class="hljs-string">"error"</span>,
      <span class="hljs-string">"@typescript-eslint/no-non-null-assertion"</span>: <span class="hljs-string">"error"</span>,
      <span class="hljs-string">"@typescript-eslint/strict-boolean-expressions"</span>: <span class="hljs-string">"error"</span>
    }
  }
];
</code></pre>
<p>运行检查：</p>
<pre><code class="hljs language-bash" lang="bash">$ eslint .

src/components/ProductList.tsx
  12:15  error  Unexpected any. Specify a different <span class="hljs-built_in">type</span>  @typescript-eslint/no-explicit-any
  23:8   error  Forbidden non-null assertion              @typescript-eslint/no-non-null-assertion
  ...

src/utils/formatPrice.ts
  5:22   error  Unexpected any. Specify a different <span class="hljs-built_in">type</span>  @typescript-eslint/no-explicit-any
  ...

✖ 847 problems (847 errors, 0 warnings)
</code></pre>
<p><strong>847 个错误</strong>。如果强行推进，结果可想而知：</p>
<ul>
<li>团队成员抱怨："又要加班修 Bug 了"</li>
<li>CI/CD 构建失败，阻塞所有人的开发</li>
<li>最后可能不得不回滚配置</li>
</ul>
<h4 data-id="heading-8">第二步：使用批量抑制</h4>
<p>冷静下来，换个思路——用批量抑制：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 开启规则并生成抑制文件</span>
$ eslint . --suppress-all --fix

<span class="hljs-comment"># 自动修复了 142 个问题</span>
<span class="hljs-comment"># 剩余 705 个问题记录到 eslint-suppressions.json</span>

✔ Suppressions written to eslint-suppressions.json
</code></pre>
<p>这个命令做了两件事：</p>
<ol>
<li><strong>自动修复</strong>：能自动修复的问题（比如添加类型注解）直接修复</li>
<li><strong>记录存量</strong>：无法自动修复的问题记录到抑制文件</li>
</ol>
<p>现在再运行 <code>eslint .</code>：</p>
<pre><code class="hljs language-bash" lang="bash">$ eslint .
✔ No problems found
</code></pre>
<p>完美通过！关键是，<strong>新代码必须符合规则</strong>。</p>
<h4 data-id="heading-9">第三步：验证增量卡控</h4>
<p>让我们验证一下，新代码是否真的会被拦截。</p>
<p>某个开发者在新功能中写了这样的代码：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/components/NewFeature.tsx (新文件)</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Props</span> {
  <span class="hljs-attr">data</span>: <span class="hljs-built_in">any</span>;  <span class="hljs-comment">// x 新代码使用 any</span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">NewFeature</span>(<span class="hljs-params">{ data }: Props</span>) {
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{data.name}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre>
<p>运行检查：</p>
<pre><code class="hljs language-bash" lang="bash">$ eslint src/components/NewFeature.tsx

src/components/NewFeature.tsx
  4:9  error  Unexpected any. Specify a different <span class="hljs-built_in">type</span>  @typescript-eslint/no-explicit-any

✖ 1 problem (1 error, 0 warnings)
</code></pre>
<p><strong>立即报错</strong>！因为这是新文件，不在抑制列表中。</p>
<p>开发者必须修复才能提交：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 修复后</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ProductData</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">price</span>: <span class="hljs-built_in">number</span>;
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Props</span> {
  <span class="hljs-attr">data</span>: <span class="hljs-title class_">ProductData</span>;  <span class="hljs-comment">//  使用明确的类型</span>
}
</code></pre>
<h4 data-id="heading-10">第四步：建立日常工作流</h4>
<p><strong>1. 定期清理已修复的抑制</strong></p>
<p>当团队修复了一些旧代码后，使用 <code>--prune-suppressions</code> 清理：</p>
<pre><code class="hljs language-bash" lang="bash">$ eslint . --prune-suppressions

✔ Removed 23 suppressions that are no longer needed
</code></pre>
<p>这个命令会：</p>
<ul>
<li>检查每个抑制项是否还存在对应的违规</li>
<li>如果违规已修复，从抑制文件中移除该记录</li>
</ul>
<p><strong>2. Code Review 关注点</strong></p>
<p>在代码评审时，增加一个检查项：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section">## Code Review Checklist</span>

<span class="hljs-bullet">-</span> [ ] 代码逻辑正确
<span class="hljs-bullet">-</span> [ ] 测试覆盖充分
<span class="hljs-bullet">-</span> [ ] <span class="hljs-strong">**技术债趋势**</span>：
<span class="hljs-bullet">  -</span> [ ] 没有新增 eslint-suppressions.json 中的抑制项
<span class="hljs-bullet">  -</span> [ ] 如果修改了旧文件，是否顺手修复了部分 Lint 问题
</code></pre>
<h3 data-id="heading-11">进阶技巧</h3>
<h4 data-id="heading-12">技巧 1: 按模块分批抑制</h4>
<p>如果你想先对核心模块严格要求，可以这样操作：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 先对 utils 和 hooks 目录开启严格模式</span>
$ eslint src/utils src/hooks --suppress-all --fix

<span class="hljs-comment"># 其他目录暂时不检查</span>
</code></pre>
<h4 data-id="heading-13">技巧 2: 结合 Git Hooks</h4>
<p>推荐使用 <code>lint-staged</code> 来精确控制只检查暂存区的文件，比手写脚本更稳健：</p>
<ol>
<li>
<p>安装依赖：</p>
<pre><code class="hljs language-bash" lang="bash">npm install --save-dev lint-staged husky
</code></pre>
</li>
<li>
<p>配置 <code>package.json</code>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"lint-staged"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"*.{ts,tsx}"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"eslint"</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
</li>
<li>
<p>在 <code>.husky/pre-commit</code> 中调用：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/sh</span>
npx lint-staged
</code></pre>
</li>
</ol>
<p>这样，每次提交时，ESLint 只会检查你修改的文件。如果有新增的违规（且未被抑制），提交将被拦截。</p>
<h4 data-id="heading-14">技巧 3: 制定“童子军规则”</h4>
<p>在团队中推行<strong>童子军规则</strong>（Boy Scout Rule）：</p>
<blockquote>
<p>"离开时，让代码比你来时更干净一点。"</p>
</blockquote>
<p>具体做法：</p>
<ul>
<li>如果你修改了某个旧文件，顺手修复 1-2 个 Lint 问题</li>
<li>在 Code Review 时，给予"技术债修复"额外的认可</li>
</ul>
<h3 data-id="heading-15">总结：技术债治理的三个原则</h3>
<p>通过 ESLint 批量抑制功能，我们学到的不仅是一个工具的使用，更是一种<strong>技术债治理的方法论</strong>：</p>
<h4 data-id="heading-16">原则 1: 不要让存量问题阻碍增量改进</h4>
<p>传统思维："要么全修，要么不修"。
批量抑制思维："存量暂时冻结，增量严格卡控"。</p>
<h4 data-id="heading-17">原则 2: 渐进式改进优于一次性重构</h4>
<p>一次性重构的风险：</p>
<ul>
<li>周期长，风险高</li>
<li>影响业务交付</li>
<li>团队抵触情绪大</li>
</ul>
<p>渐进式改进的优势：</p>
<ul>
<li>每次改进可见、可控</li>
<li>不影响正常迭代</li>
<li>团队负担小</li>
</ul>
<h4 data-id="heading-18">原则 3: 用工具和流程保障，而非靠自觉</h4>
<p>不要指望团队成员"自觉地"提升代码质量。应该：</p>
<ul>
<li><strong>工具拦截</strong>：ESLint 自动检查新代码</li>
<li><strong>CI 监控</strong>：自动检测技术债趋势</li>
<li><strong>流程保障</strong>：Code Review 检查清单</li>
</ul>
<hr/>
<h3 data-id="heading-19">参考资料</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Feslint.org%2Fblog%2F2025%2F04%2Fintroducing-bulk-suppressions%2F" target="_blank" title="https://eslint.org/blog/2025/04/introducing-bulk-suppressions/" ref="nofollow noopener noreferrer">ESLint 官方博客：Introducing Bulk Suppressions</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Feslint.org%2Fdocs%2Flatest%2F" target="_blank" title="https://eslint.org/docs/latest/" ref="nofollow noopener noreferrer">ESLint 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftypescript-eslint.io%2Frules%2F" target="_blank" title="https://typescript-eslint.io/rules/" ref="nofollow noopener noreferrer">TypeScript ESLint 规则参考</a></li>
</ul>
<hr/>
<blockquote>
<p>如果这篇文章对你有帮助，欢迎点赞收藏！也欢迎在评论区分享你在技术债治理方面的经验和困惑。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Open Claude Cowork：基于 Electron + React + ACP 的本地多 Agent 协作桌面应用]]></title>    <link>https://juejin.cn/post/7599581687357571122</link>    <guid>https://juejin.cn/post/7599581687357571122</guid>    <pubDate>2026-01-26T17:48:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599581687357571122" data-draft-id="7599530824426323978" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Open Claude Cowork：基于 Electron + React + ACP 的本地多 Agent 协作桌面应用"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2026-01-26T17:48:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="_鸡脚芝士_"/> <meta itemprop="url" content="https://juejin.cn/user/1732486058737917"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Open Claude Cowork：基于 Electron + React + ACP 的本地多 Agent 协作桌面应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1732486058737917/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    _鸡脚芝士_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T17:48:10.000Z" title="Mon Jan 26 2026 17:48:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github-gist">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#333}.hljs-comment,.hljs-meta{color:#969896}.hljs-emphasis,.hljs-quote,.hljs-strong,.hljs-template-variable,.hljs-variable{color:#df5000}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#d73a49}.hljs-attribute,.hljs-bullet,.hljs-literal,.hljs-symbol{color:#0086b3}.hljs-name,.hljs-section{color:#63a35c}.hljs-tag{color:#333}.hljs-attr,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-title{color:#6f42c1}.hljs-addition{color:#55a532;background-color:#eaffea}.hljs-deletion{color:#bd2c00;background-color:#ffecec}.hljs-link{text-decoration:underline}.hljs-number{color:#005cc5}.hljs-string{color:#032f62}</style><blockquote>
<p>面向“多任务、多 Agent、可本地执行”的 AI 协作场景，这个仓库提供了一个完整的桌面端实现：前端负责多任务与对话体验，主进程负责 ACP 连接、权限与
系统能力，SQLite 做本地持久化，整体可离线运行并适配多个 Agent CLI。</p>
</blockquote>
<h2 data-id="heading-0">1. 项目定位与核心价值</h2>
<p>Open Claude Cowork 的核心定位是：让多个 AI Agent 以统一协议（ACP）在桌面端被管理、对话与协作。
其特点可以概括为：</p>
<ul>
<li>任务为中心：每个任务绑定独立工作区与 Agent 会话，适合长期协作。</li>
<li>ACP 统一协议：通过 @agentclientprotocol/sdk 统一接入不同 Agent CLI。</li>
<li>可控权限与工具调用可视化：工具调用、权限请求会被 UI 捕获并可人工确认。</li>
<li>本地数据与隐私优先：任务与设置落在本地 SQLite 中。</li>
</ul>
<h2 data-id="heading-1">2. 技术栈与工程化选型</h2>
<p>从 package.json 和构建配置来看，该项目是一个标准的 Electron 桌面应用，技术关键点如下：</p>
<ul>
<li>主进程：Electron + Node.js（TypeScript）</li>
<li>渲染层：React + Ant Design + Tailwind CSS</li>
<li>构建工具：Rsbuild（分别构建 main 与 render）</li>
<li>数据库：better-sqlite3（WAL 模式）</li>
<li>协议：ACP（Agent Client Protocol）</li>
<li>打包：electron-builder + plop 执行构建流程</li>
</ul>
<p>相关路径参考：package.json, builder/rsbuild.*.ts, builder.js, plopfile.js。</p>
<h2 data-id="heading-2">3. 架构总览（Main/Renderer/ACP）</h2>
<p>整体架构可以简化为三层：</p>
<p>Renderer (React UI)
│  window.electron.invoke / on
▼
Main Process (Electron)
├─ IPC: env / db / agent / dialog
├─ ACP: AcpAgentManager → AcpAgent → AcpConnection
└─ SQLite: settings / tasks</p>
<ul>
<li>Renderer 通过 preload.ts 暴露的 window.electron 调用 IPC。</li>
<li>Main 负责 连接 Agent、权限处理、文件读写、持久化。</li>
<li>ACP 协议通过 @agentclientprotocol/sdk 驱动 JSON-RPC 流。</li>
</ul>
<p>核心入口文件：src/main/index.ts、src/main/preload.ts、src/render/index.tsx、src/render/AppNew.tsx。</p>
<h2 data-id="heading-3">4. 核心模块详解</h2>
<h3 data-id="heading-4">4.1 Main 进程与 IPC 桥接</h3>
<p>主进程入口在 src/main/index.ts，主要职责包括：</p>
<ul>
<li>初始化数据库（initDB()）</li>
<li>注册自定义协议 wallpaper://</li>
<li>创建窗口（BrowserWindow）并加载 URL</li>
<li>注册 IPC 模块：env, dialog, db, agent</li>
</ul>
<p>IPC handler 分布：</p>
<ul>
<li>环境与系统能力：src/main/ipc/env.ts</li>
<li>选择文件/目录：src/main/ipc/dialog.ts</li>
<li>数据库 CRUD：src/main/ipc/db.ts</li>
<li>Agent 管理：src/main/ipc/agent.ts</li>
</ul>
<p>src/main/preload.ts 则通过 contextBridge 暴露最小能力：</p>
<p>window.electron.send / invoke / on</p>
<p>这保证了渲染层与主进程通信的安全边界。</p>
<h3 data-id="heading-5">4.2 ACP 接入链路（核心）</h3>
<p>ACP 的接入由四个核心类构成：</p>
<ol>
<li>AcpDetector（src/main/acp/AcpDetector.ts）
<ul>
<li>扫描本地 CLI（如 qwen、gemini、npx）</li>
<li>返回可用 Agent 列表</li>
<li>检测命令来自 ACP_BACKENDS_ALL（src/types/acpTypes.ts）</li>
</ul>
</li>
<li>AcpAgentManager（src/main/acp/AcpAgentManager.ts）
<ul>
<li>管理当前 Agent 实例、复用连接</li>
<li>解析命令、处理本地 bin 与 Node 运行时逻辑</li>
<li>提供 connect/send/stop/newSession/loadSession 等入口</li>
</ul>
</li>
<li>AcpAgent（src/main/acp/AcpAgent.ts）
<ul>
<li>会话级别控制，负责 initialize → newSession → prompt</li>
<li>支持 @file 文本扩展（读取工作区文件并拼入 prompt）</li>
<li>将 ACP 原始更新转为 UI 可用消息</li>
</ul>
</li>
<li>AcpConnection（src/main/acp/AcpConnection.ts）
<ul>
<li>spawn 子进程，并通过 ndJsonStream 建立 JSON-RPC 流</li>
<li>支持权限请求、文件读写、runShellCommand 扩展</li>
<li>具备 prompt 超时与暂停/恢复机制</li>
</ul>
</li>
</ol>
<p>这种分层使 ACP 逻辑清晰：连接、会话、消息适配、UI 通知各自隔离。</p>
<h3 data-id="heading-6">4.3 本地数据模型</h3>
<p>数据库在 src/main/db/store.ts 初始化：</p>
<ul>
<li>settings：保存自定义路径、主题、壁纸等</li>
<li>tasks：任务维度记录
<ul>
<li>id/title/workspace</li>
<li>agent_command/agent_env</li>
<li>messages/session_id/model_id/token_usage</li>
<li>created_at/updated_at/last_active_at</li>
</ul>
</li>
</ul>
<p>任务数据在 Renderer 内通过 IPC 持久化（db:create-task, db:update-task）。</p>
<h3 data-id="heading-7">4.4 渲染层交互与消息模型</h3>
<p>核心 UI 在 src/render/AppNew.tsx，特征包括：</p>
<ul>
<li>多任务状态管理：任务列表、当前任务、任务级连接状态</li>
<li>消息流与合并：
<ul>
<li>MessageComposer 合并流式文本与 tool_call 更新</li>
<li>messageTransformer 在 ACP 消息与 UI 消息之间转换</li>
</ul>
</li>
<li>环境检测与引导：EnvironmentSetup.tsx</li>
<li>设置与 Agent 配置：SettingsModal.tsx</li>
</ul>
<p>消息合并策略（src/render/utils/messageComposer.ts）体现为：</p>
<ul>
<li>msg_id 复用 → 文本流式拼接</li>
<li>toolCallId 对应 → tool call 状态更新合并</li>
<li>thought 单独拼接</li>
</ul>
<p>这保证了对话体验可连续显示，同时保留工具调用信息。</p>
<h3 data-id="heading-8">4.5 权限与工具调用展示</h3>
<p>ACP 支持权限请求与工具调用。
在本项目中：</p>
<ul>
<li>Main 在 AcpConnection.requestPermission 时会挂起 prompt 超时</li>
<li>Renderer 收到 permission_request 后展示 UI</li>
<li>用户反馈通过 agent:permission-response 返还给主进程</li>
<li>tool call 日志以 tool_call/tool_call_update 形式进入消息流</li>
</ul>
<h3 data-id="heading-9">4.6 环境与 Node 运行时管理</h3>
<p>为了支持本地 CLI Agent，需要 Node + npm：</p>
<ul>
<li>env:check 检测 Node/npm 版本</li>
<li>env:set-node-runtime 支持 custom Node 路径</li>
<li>env:run-install-command 支持一键安装（mac/linux nvm，Windows choco）</li>
</ul>
<p>对应 UI 在 EnvironmentSetup.tsx，会进行引导并展示执行日志。</p>
<h2 data-id="heading-10">5. 关键流程拆解</h2>
<h3 data-id="heading-11">5.1 应用启动流程</h3>
<ol>
<li>main/index.ts 初始化 DB</li>
<li>注册 wallpaper:// 协议</li>
<li>创建窗口并加载 Renderer</li>
<li>注册 IPC handlers</li>
<li>初始化 ACP CLI 检测器</li>
</ol>
<h3 data-id="heading-12">5.2 会话与消息流（关键）</h3>
<p>Renderer (SendBox)
→ ipc invoke agent:connect
→ AcpAgentManager.connect()
→ AcpAgent.connect()
→ AcpConnection.spawn + initialize
→ session/new
→ session/update (streaming)
→ MessageTransformer → UI</p>
<h3 data-id="heading-13">5.3 任务与会话持久化</h3>
<ul>
<li>创建任务时写入 SQLite</li>
<li>切换任务时同步 agentCommand/workspace</li>
<li>sessionId 与 modelId 会写回任务表</li>
</ul>
<p>这使得任务在重启后仍能恢复状态。</p>
<h2 data-id="heading-14">6. 构建与发布链路</h2>
<p>构建逻辑集中在 plopfile.js 与 builder.js：</p>
<ul>
<li>pnpm run dev → Rsbuild render + nodemon main</li>
<li>pnpm run build → build main + render + electron-builder</li>
<li>BUILD_PLATFORM 支持 darwin/win/linux</li>
</ul>
<p>打包配置：</p>
<ul>
<li>mac：dmg、签名、MAS 配置</li>
<li>win：nsis 安装包</li>
<li>linux：deb/rpm</li>
</ul>
<p>输出目录：release/app//。</p>
<h2 data-id="heading-15">7. 扩展点与可演进空间</h2>
<p>当前扩展方式主要集中在：</p>
<ul>
<li>ACP Agent 列表：ACP_BACKENDS_ALL + registry</li>
<li>自定义命令与 env：UI 允许输入 Agent command/env</li>
<li>runShellCommand 权限机制：可继续做细粒度策略</li>
</ul>
<p>可进一步演进为：</p>
<ul>
<li>MCP/其他协议并行接入</li>
<li>agent 管理与版本锁定</li>
<li>工作区文件权限白名单</li>
</ul>
<h2 data-id="heading-16">8. 截图</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74f55ba5df504268b78432d7244e2c0b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-m4oeiEmuiKneWjq18=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770054492&amp;x-signature=W5JzulQTbO5ZzwFWjQIffuDaozc%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0c7f4b6c54a4415ae45e8077dd26fb6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-m4oeiEmuiKneWjq18=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770054492&amp;x-signature=0MypDL%2B9cLrtZASjkaTVKISyg5M%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/687ba2e5ba734eeca662c4c2346953df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-m4oeiEmuiKneWjq18=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770054492&amp;x-signature=5hbNyigGoynsPpxk2wxj97GeUns%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5894648ac866449895bbf7247cd46109~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-m4oeiEmuiKneWjq18=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770054492&amp;x-signature=01jdjqSHCtzQFkZOg4UnirjzC%2Fg%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4afcb6db37ce48fcb70403d571e358f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-m4oeiEmuiKneWjq18=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770054492&amp;x-signature=odAd8%2F0TQXk5RMtaxBP38KzMPm8%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/00894e88c3c643289c97370e8b66184b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-m4oeiEmuiKneWjq18=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770054492&amp;x-signature=Maw0rXXzlIdDfdy2KKgPxtf4z4Q%3D" alt="image.png" loading="lazy"/></p>
<p>Gtihub 地址 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FMaidang1%2Fopen-claude-cowork" target="_blank" title="https://github.com/Maidang1/open-claude-cowork" ref="nofollow noopener noreferrer">github.com/Maidang1/op…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[『n8n』读写本地文件]]></title>    <link>https://juejin.cn/post/7599585289946087487</link>    <guid>https://juejin.cn/post/7599585289946087487</guid>    <pubDate>2026-01-27T00:56:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599585289946087487" data-draft-id="7599585289946071103" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="『n8n』读写本地文件"/> <meta itemprop="keywords" content="LLM,DeepSeek,AIGC"/> <meta itemprop="datePublished" content="2026-01-27T00:56:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="德育处主任"/> <meta itemprop="url" content="https://juejin.cn/user/2673620576140030"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            『n8n』读写本地文件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2673620576140030/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    德育处主任
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T00:56:27.000Z" title="Tue Jan 27 2026 00:56:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>点赞 + 关注 + 收藏 = 学会了</strong></p>
<blockquote>
<p>整理了一个n8n小专栏，有兴趣的工友可以关注一下 👉 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fappmsgalbum%3F__biz%3DMzAwMjU3ODU5Ng%3D%3D%26action%3Dgetalbum%26album_id%3D4337364695070801925%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzAwMjU3ODU5Ng==&amp;action=getalbum&amp;album_id=4337364695070801925#wechat_redirect" ref="nofollow noopener noreferrer">《n8n修炼手册》</a></p>
</blockquote>
<p>在使用 n8n 搭建自动化工作流时，读写本地文件是最基础也最常用的操作。</p>
<p>比如在互联网上拉了一些数据回来需要保存到本地。</p>
<p>比如上游同事把文件发你，你要将其加载到 n8n 里做一些处理。</p>
<p>如果你使用 Docker 部署 n8n，读写本地文件的配置请参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FPyzSMK95vkXRHBUL1CrhRw" target="_blank" title="https://mp.weixin.qq.com/s/PyzSMK95vkXRHBUL1CrhRw" ref="nofollow noopener noreferrer">《『n8n』一招解决“无法读写本地文件”》</a></p>
<h2 data-id="heading-0">写入文件</h2>
<p>我用一个例子讲讲如何将数据保存到本地。</p>
<ol start="0">
<li>使用「HTTP节点」从接口把数据请求回来。</li>
<li>将数据存到到电脑。</li>
</ol>
<p>要实现这两步，在 n8n 中的工作流长这样子⬇️</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc69068742a946d8b5c72dc4454e43b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b636IKy5aSE5Li75Lu7:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770080187&amp;x-signature=2nl7RQM38HUnST%2B8fxdEm722zfI%3D" alt="01.png" loading="lazy"/></p>
<pre><code class="hljs language-rust" lang="rust">鼠标点击 <span class="hljs-punctuation">-&gt;</span> HTTP请求数据 <span class="hljs-punctuation">-&gt;</span> 将数据格式化（Convert） <span class="hljs-punctuation">-&gt;</span> 保存到本地（Write Files from Disk）
</code></pre>
<p>先看看「Convert to File」的配置。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe2a6cf7322142d08bc8bada3df974b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b636IKy5aSE5Li75Lu7:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770080187&amp;x-signature=qk1w6SFm0xO%2BzLoudqqHDL%2BsBho%3D" alt="02.png" loading="lazy"/></p>
<p>我将「HTTP 节点」请求回来的数据转成 Excel 文件，并将输出的对象放到一个 <code>data</code> 字段里。</p>
<p>「Write Files from Disk」节点将上个节点传入的数据保存到我指定的位置：</p>
<p><code>/home/node/.n8n-files/rw-test/posts.xlsx</code></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f8b1b607c834fc0a4eacac9267d3eab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b636IKy5aSE5Li75Lu7:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770080187&amp;x-signature=RFXkdL8K%2FpIgb5cQtGKkfBmFQ10%3D" alt="03.png" loading="lazy"/></p>
<p>注意，<code>posts.xlsx</code> 是我保存的文件名和后缀格式。</p>
<p>保存成功后就可以在指定位置找到它了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0342cca4cf74ec096fc325560b5e121~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b636IKy5aSE5Li75Lu7:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770080187&amp;x-signature=ealjiyMHS%2FF3VZacijAK6bAVA%2Fc%3D" alt="04.png" loading="lazy"/></p>
<h2 data-id="heading-1">读取文件</h2>
<p>读取文件的思路就反过来了。</p>
<p>首先找到文件，然后再将内容解析出来，让其他节点可以看得懂这个文件的内容。</p>
<p>所以工作流长这样⬇️</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb1ebdcff43b40c0af74c8575a561d88~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b636IKy5aSE5Li75Lu7:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770080187&amp;x-signature=eNeh9I4jQ83ZlsizJ6vLDB%2FPcks%3D" alt="05.png" loading="lazy"/></p>
<p>其实读取文件和写入文件都是用同一个节点（Read/Write Files from Disk），只是 <code>Operation</code> 属性不一样而已。</p>
<p>在这个工作流中，「Read Files from Disk」的 <code>Operation</code> 选择 <code>Read File(s) From Disk</code>，再指定一个文件路径就行了。</p>
<p>可以看到它输出了一个 <code>data</code> 。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55a1d0c98b274741ace3ca4ce05183f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b636IKy5aSE5Li75Lu7:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770080187&amp;x-signature=GC1tOM7XMI9u7b1Xx%2Fgpsjp8rgQ%3D" alt="06.png" loading="lazy"/></p>
<p>要让其他工作流读懂这个 <code>data</code> 里面写了什么内容，需要用到「Extract from File 节点」。</p>
<p>在「Extract from File 节点」里，我们要正确设置 <code>Operation</code> 的值，这个参数指的是现在读取到的文件对象它原本是什么格式（比如我这个是 Excel 文件，就用 <code>Extract From XLSX</code>，其他格式就用其他类型）。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f77b8993d224c65a977a1ba6eb688d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b636IKy5aSE5Li75Lu7:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770080187&amp;x-signature=ui8UREmv80BxTCwOmAmwU8iaoKc%3D" alt="07.png" loading="lazy"/></p>
<p>读取成功后，「Extract from File 节点」就会将内容输出给下一个节点。右侧面板就是读取到的内容。</p>
<hr/>
<p>以上就是本文的全部内容啦，想了解更多n8n玩法欢迎关注<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fappmsgalbum%3F__biz%3DMzAwMjU3ODU5Ng%3D%3D%26action%3Dgetalbum%26album_id%3D4337364695070801925%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzAwMjU3ODU5Ng==&amp;action=getalbum&amp;album_id=4337364695070801925#wechat_redirect" ref="nofollow noopener noreferrer">《n8n修炼手册》</a>👏</p>
<p>如果你有 NAS，我非常建议你在 NAS 上部署一套 n8n，搞搞副业也好，帮你完成工作任务也好 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FppIWKP8StiFn2k2IW0ZpNQ" target="_blank" title="https://mp.weixin.qq.com/s/ppIWKP8StiFn2k2IW0ZpNQ" ref="nofollow noopener noreferrer">《『NAS』不止娱乐，NAS也是生产力，在绿联部署AI工作流工具-n8n》</a></p>
<p><strong>点赞 + 关注 + 收藏 = 学会了</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何让同一个 Guard、Interceptor、Exception Filter 在不同类型的服务里复用？]]></title>    <link>https://juejin.cn/post/7599581204860682266</link>    <guid>https://juejin.cn/post/7599581204860682266</guid>    <pubDate>2026-01-27T02:49:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599581204860682266" data-draft-id="7599094262593536010" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何让同一个 Guard、Interceptor、Exception Filter 在不同类型的服务里复用？"/> <meta itemprop="keywords" content="前端,NestJS,Node.js"/> <meta itemprop="datePublished" content="2026-01-27T02:49:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端付豪"/> <meta itemprop="url" content="https://juejin.cn/user/1741228277763278"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何让同一个 Guard、Interceptor、Exception Filter 在不同类型的服务里复用？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1741228277763278/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端付豪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T02:49:31.000Z" title="Tue Jan 27 2026 02:49:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Nest 可以创建 HTTP 、WebSocket ，还有基于 TCP 服务</p>
<p>这都支持 Guard、Interceptor、Exception Filter 功能</p>
<p>问题是不同服务拿到的参数不同，比如 http 服务可以拿到 request、response 对象，而 websocket 没有。</p>
<p>那如何让同一个 Guard、Interceptor、Exception Filter 在不同类型的服务里复用？</p>
<p>使用 ArgumentHost 这个类</p>
<p>新建项目试试看</p>
<pre><code class="hljs language-arduino" lang="arduino">nest <span class="hljs-keyword">new</span> argument-host

</code></pre>
<p>新建 filter</p>
<pre><code class="hljs language-css" lang="css">nest g <span class="hljs-attribute">filter</span> aaa <span class="hljs-attr">--flat</span> <span class="hljs-attr">--no-spec</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3dcd65429f6140f1b361afffa1ca44b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770086970&amp;x-signature=0k8t89UuBvdsq23UtpOZZ%2FgSt9g%3D" alt="image.png" loading="lazy"/></p>
<p>Nest 会 catch 所有未捕获异常，如果是 Exception Filter 声明的异常，那就会调用 filter 来处理</p>
<p>创建一个自定义的异常类</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b70807f215614b1ca8d05f35b2968c21~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770086970&amp;x-signature=QxD247Nx3l6SkKSrF%2FBrDWAbIh8%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/04e6743f78264e328af139e703fdcbcc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770086970&amp;x-signature=NtrenCGZDPiiGPpJmOHYqiRvdWs%3D" alt="image.png" loading="lazy"/></p>
<p>使用</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e9b3d73febf4186887c08ad35bb756a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770086970&amp;x-signature=fFgkS1Zfn06NolSdYbP3vZgX9ag%3D" alt="image.png" loading="lazy"/></p>
<p>启动服务 可以看到打印</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1c5e2276c854de7ae6c0df46e5283e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770086970&amp;x-signature=7YV%2FpBrU%2FytbNRs4WJgBAM7YgKM%3D" alt="image.png" loading="lazy"/></p>
<p>filter 的第一个参数就是异常对象，第二个参数有这些方法</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2300880014a341918211cce68e3d617b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770086970&amp;x-signature=0xD10He9dljJYSjFyREtc0FrJL4%3D" alt="image.png" loading="lazy"/></p>
<p>.vscode/launch.json 添加调试看看</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"request"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"launch"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"debug nest"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"runtimeExecutable"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npm"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"run"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"start:dev"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"skipFiles"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"&lt;node_internals&gt;/**"</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"console"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"integratedTerminal"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>打断点</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/452e8222c45f4d93a39cdac19c55daa0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770086970&amp;x-signature=WH1Wo8AvKKWIIcgdwjz53%2FCVhH0%3D" alt="image.png" loading="lazy"/></p>
<p>启动</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c4ea6c8703844d0facaa6f7b1d87046d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770086970&amp;x-signature=TIXgpKPYdJb7eg9Vj9VbiQVFndA%3D" alt="image.png" loading="lazy"/></p>
<p>host.getArgs 拿到 reqeust、response、next 参数</p>
<p>host.getArgByIndex 下标取参数</p>
<p>调用 switchToHttp 切换到 http 上下文，然后再调用 getRequest、getResponse 方法</p>
<p>websocket、基于 tcp 的微服务等上下文，就分别调用 host.swtichToWs、host.switchToRpc 方法</p>
<p>这样，就可以在 filter 里处理多个上下文的逻辑，跨上下文复用 filter</p>
<p>类似这样</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ArgumentsHost</span>, <span class="hljs-title class_">Catch</span>, <span class="hljs-title class_">ExceptionFilter</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Response</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'express'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AaaException</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./AaaException'</span>;

<span class="hljs-meta">@Catch</span>(<span class="hljs-title class_">AaaException</span>)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AaaFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ExceptionFilter</span> {
  <span class="hljs-keyword">catch</span>(<span class="hljs-attr">exception</span>: <span class="hljs-title class_">AaaException</span>, <span class="hljs-attr">host</span>: <span class="hljs-title class_">ArgumentsHost</span>) {
    <span class="hljs-keyword">if</span>(host.<span class="hljs-title function_">getType</span>() === <span class="hljs-string">'http'</span>) {
      <span class="hljs-keyword">const</span> ctx = host.<span class="hljs-title function_">switchToHttp</span>();
      <span class="hljs-keyword">const</span> response = ctx.<span class="hljs-property">getResponse</span>&lt;<span class="hljs-title class_">Response</span>&gt;();
      <span class="hljs-keyword">const</span> request = ctx.<span class="hljs-property">getRequest</span>&lt;<span class="hljs-title class_">Request</span>&gt;();

      response
        .<span class="hljs-title function_">status</span>(<span class="hljs-number">500</span>)
        .<span class="hljs-title function_">json</span>({
          <span class="hljs-attr">value1</span>: exception.<span class="hljs-property">value1</span>,
          <span class="hljs-attr">value2</span>: exception.<span class="hljs-property">value2</span>
        });
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(host.<span class="hljs-title function_">getType</span>() === <span class="hljs-string">'ws'</span>) {

    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(host.<span class="hljs-title function_">getType</span>() === <span class="hljs-string">'rpc'</span>) {

    }
  }
}
</code></pre>
<p>启动</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f20fc23db3f416fa1ce8ceb5a44f826~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770086970&amp;x-signature=9pfQgMUQlF%2FL%2FRXIHP8zd0lwnJs%3D" alt="image.png" loading="lazy"/></p>
<p><strong>ArgumentHost 是用于切换 http、websocket、rpc 等上下文类型的，可以根据上下文类型取到对应的 argument，让 Exception Filter 等在不同的上下文中复用</strong></p>
<p>在 guard 和 interceptor 会是怎样 ？</p>
<pre><code class="hljs language-css" lang="css">nest g guard aaa <span class="hljs-attr">--no-spec</span> <span class="hljs-attr">--flat</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a099eb1f12c74cd99f6fdd5dab2f054c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770086970&amp;x-signature=4liNxyvzt4Xidx0An1wbWyIfSq0%3D" alt="image.png" loading="lazy"/></p>
<p>有这些方法  和上面看到的很类似</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d898dde3a5774756ab0db8707278a0dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770086970&amp;x-signature=LkGE3xzWWazBdhIFqlzYx15CIJM%3D" alt="image.png" loading="lazy"/></p>
<p>因为 ExecutionContext 是 ArgumentHost 的子类，扩展了 getClass、getHandler 方法</p>
<p>getClass、getHandler有啥作用？</p>
<p>再次调试看看</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ee1cd51fa1b452783dbf66397bd8e67~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770086970&amp;x-signature=PEnjpKjoK%2F0R411GDEbsscx2n5Y%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97783904526847c084c7816a7c9bc2a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770086970&amp;x-signature=8Psl7wYnFgqGXAWWce3dbWUUqK0%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0956d443073c4076bf58154aaf6a0855~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770086970&amp;x-signature=rHatd76RxhkLO4tnHIa6jMmx318%3D" alt="image.png" loading="lazy"/></p>
<p>作用分别是要调用的 controller 的 class 以及要调用的方法</p>
<p>为什么 ExecutionContext 里需要拿到目标 class 和 handler 呢？</p>
<p>因为 Guard、Interceptor 的逻辑可能要根据目标 class、handler 有没有某些装饰而决定怎么处理</p>
<p>比如权限校验例子</p>
<pre><code class="hljs language-css" lang="css">nest g decorator roles <span class="hljs-attr">--flat</span> <span class="hljs-attr">--no-spec</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a20598b973754b9389bbb685e058e4c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770086970&amp;x-signature=BWvgHpJMiLNcL8TaDlWvaiCpgLk%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89e98bafcb40484684062da36a9a299a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770086970&amp;x-signature=qO8N99h7n0cfBGvQSK0GtvPZ%2BZk%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/711e630bbd494278bab9cac4e532b65c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770086970&amp;x-signature=HTBr8GAfuVCOK%2BaswKX6xeAvaTo%3D" alt="image.png" loading="lazy"/></p>
<p>Guard 里通过 ExecutionContext 的 getHandler 方法拿到了目标 handler 方法。</p>
<p>然后通过 reflector 的 api 拿到它的 metadata。</p>
<p>判断如果没有 roles 的 metadata 就是需要权限，那就直接放行。</p>
<p>如果有，就是需要权限，从 user 的 roles中判断下又没有当前 roles，有的话就放行。</p>
<p>刷新页面，可以看到返回的是 403</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83f71e0a331e4538a78252feb45407a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770086970&amp;x-signature=BHbbEucU2Dh1U4apQ9UrdMTnOjk%3D" alt="image.png" loading="lazy"/></p>
<p>同理，在 interceptor 里也有这个</p>
<pre><code class="hljs language-css" lang="css"> nest g interceptor aaa <span class="hljs-attr">--no-spec</span> <span class="hljs-attr">--flat</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/084b4e86ea214c9484ebfc271506309e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770086970&amp;x-signature=kV3oayHMl4IKpOob%2FogZ5KodUmc%3D" alt="image.png" loading="lazy"/></p>
<p>自然也可以 通过 reflector 取出 class 或者 handler 上的 metdadata</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[面试复盘：0.1 + 0.2 === 0.3 结果是 ？附精准解决办法]]></title>    <link>https://juejin.cn/post/7599604510365909030</link>    <guid>https://juejin.cn/post/7599604510365909030</guid>    <pubDate>2026-01-27T02:56:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599604510365909030" data-draft-id="7599581687358849074" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="面试复盘：0.1 + 0.2 === 0.3 结果是 ？附精准解决办法"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-27T02:56:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="hypoy"/> <meta itemprop="url" content="https://juejin.cn/user/3074670624777223"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            面试复盘：0.1 + 0.2 === 0.3 结果是 ？附精准解决办法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3074670624777223/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    hypoy
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T02:56:08.000Z" title="Tue Jan 27 2026 02:56:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">面试复盘：0.1 + 0.2 === 0.3 结果是 ？附精准解决办法</h2>
<p>最近面试被问到一个超经典的 JS 问题：<code>0.1 + 0.2 === 0.3</code> 对不对？我马上说肯定不对，但面试官接着追问为啥返回 false，我只答得出 “浮点数精度问题” 这个表面原因，再往下说就卡壳了。今天就把这个问题掰开揉碎复盘，从根上的原理到实际能用的解决办法，一次性讲明白。</p>
<h3 data-id="heading-1">一、先看现象：反直觉的结果</h3>
<p>先执行一段简单的代码，验证这个反直觉的现象：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">0.1</span> + <span class="hljs-number">0.2</span>); <span class="hljs-comment">// 输出 0.30000000000000004</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">0.1</span> + <span class="hljs-number">0.2</span> === <span class="hljs-number">0.3</span>); <span class="hljs-comment">// 输出 false</span>
</code></pre>
<p>明明 0.1 加 0.2 数学上等于 0.3，为什么在 JS 里却不是？核心原因藏在 JavaScript 对数字的存储方式里。</p>
<h3 data-id="heading-2">二、底层原因：二进制浮点数的 “先天缺陷”</h3>
<p>JavaScript 遵循 <strong>IEEE 754 标准</strong>，所有数字（整数、小数）都以 64 位双精度浮点数（Double-precision floating-point format）存储。这个标准的设计本身，导致了部分十进制小数无法被二进制精确表示。</p>
<h4 data-id="heading-3">1. 十进制转二进制的 “无限循环”</h4>
<p>我们先回忆十进制转二进制小数的规则：乘 2 取整，直到小数部分为 0。以 0.1 为例：</p>
<pre><code class="hljs language-ini" lang="ini">0.1 × <span class="hljs-attr">2</span> = <span class="hljs-number">0.2</span> → 取整 <span class="hljs-number">0</span>
0.2 × <span class="hljs-attr">2</span> = <span class="hljs-number">0.4</span> → 取整 <span class="hljs-number">0</span>
0.4 × <span class="hljs-attr">2</span> = <span class="hljs-number">0.8</span> → 取整 <span class="hljs-number">0</span>
0.8 × <span class="hljs-attr">2</span> = <span class="hljs-number">1.6</span> → 取整 <span class="hljs-number">1</span>，剩余 <span class="hljs-number">0.6</span>
0.6 × <span class="hljs-attr">2</span> = <span class="hljs-number">1.2</span> → 取整 <span class="hljs-number">1</span>，剩余 <span class="hljs-number">0.2</span>
... 循环往复，永远无法得到 0
</code></pre>
<p>最终，0.1 的二进制是 <strong>无限循环小数</strong>：<code>0.0001100110011...(0011 循环)</code>。</p>
<p>同理，0.2 的二进制也是无限循环小数。而 64 位双精度浮点数的存储空间有限，只能截取前 52 位有效数字（尾数部分）进行存储，这就导致了 <strong>精度丢失</strong>。</p>
<h4 data-id="heading-4">2. 精度丢失后的计算</h4>
<p>0.1 和 0.2 存储时都被 “近似处理” 了，两者相加后，结果自然不是精确的 0.3，而是一个接近 0.3 的数（0.30000000000000004），因此 <code>===</code> 严格相等判断会返回 false。</p>
<p>简单总结：不是 JS 计算错了，而是十进制的 0.1 和 0.2 无法被二进制浮点数精确表示，存储和计算时的近似值导致了结果偏差。</p>
<h3 data-id="heading-5">三、解决方案：如何正确比较 0.1 + 0.2 和 0.3？</h3>
<p>知道了原因，我们需要对应的解决方案，核心思路是 “规避浮点数精度问题”，常见方案有 3 种：</p>
<h4 data-id="heading-6">方案 1：设置误差阈值（最常用）</h4>
<p>既然结果是近似值，我们可以允许一个极小的误差范围（通常用 <code>Number.EPSILON</code>，表示 JS 中能表示的最小精度差），只要两个数的差值小于这个阈值，就认为相等。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 封装通用的浮点数比较函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">isEqual</span>(<span class="hljs-params">a, b, epsilon = <span class="hljs-built_in">Number</span>.EPSILON</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(a - b) &lt; epsilon;
}
<span class="hljs-comment">// 测试</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">isEqual</span>(<span class="hljs-number">0.1</span> + <span class="hljs-number">0.2</span>, <span class="hljs-number">0.3</span>)); <span class="hljs-comment">// true</span>
</code></pre>
<p><code>Number.EPSILON</code> 的值约为 2.220446049250313e-16，是 JS 中两个可表示的浮点数之间的最小差值，完全满足日常精度需求。</p>
<h4 data-id="heading-7">方案 2：转整数计算（适合金融场景）</h4>
<p>浮点数精度问题在金额计算中尤为致命（比如 0.1 元 + 0.2 元），此时可以将小数转为整数（乘以 10 的 n 次方），计算后再转回来，从根源避免浮点数运算。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 0.1 + 0.2 转整数计算</span>
<span class="hljs-keyword">const</span> a = <span class="hljs-number">0.1</span>, b = <span class="hljs-number">0.2</span>;
<span class="hljs-keyword">const</span> sum = (a * <span class="hljs-number">10</span> + b * <span class="hljs-number">10</span>) / <span class="hljs-number">10</span>; <span class="hljs-comment">// (1 + 2)/10 = 0.3</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(sum === <span class="hljs-number">0.3</span>); <span class="hljs-comment">// true</span>

<span class="hljs-comment">// 金额计算示例：1.23 元 + 4.56 元</span>
<span class="hljs-keyword">const</span> price1 = <span class="hljs-number">1.23</span>, price2 = <span class="hljs-number">4.56</span>;
<span class="hljs-keyword">const</span> total = (price1 * <span class="hljs-number">100</span> + price2 * <span class="hljs-number">100</span>) / <span class="hljs-number">100</span>; <span class="hljs-comment">// 579 / 100 = 5.79</span>
</code></pre>
<h4 data-id="heading-8">方案 3：使用成熟的数学库（推荐复杂场景）</h4>
<p>如果是企业级金融、科学计算等高精度场景，手动处理容易出错，推荐使用成熟的库：</p>
<ul>
<li><strong>decimal.js</strong>：功能全面的高精度十进制运算库</li>
<li><strong>big.js</strong>：轻量、专注于高精度小数运算</li>
<li><strong>bignumber.js</strong>：兼容 IEEE 754 标准，适合金融场景</li>
</ul>
<p>以 <code>big.js</code> 为例：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 先安装：npm install big.js</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Big</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'big.js'</span>);

<span class="hljs-keyword">const</span> a = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Big</span>(<span class="hljs-number">0.1</span>);
<span class="hljs-keyword">const</span> b = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Big</span>(<span class="hljs-number">0.2</span>);
<span class="hljs-keyword">const</span> sum = a.<span class="hljs-title function_">plus</span>(b); <span class="hljs-comment">// 0.3</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(sum.<span class="hljs-title function_">eq</span>(<span class="hljs-number">0.3</span>)); <span class="hljs-comment">// true</span>
</code></pre>
<h3 data-id="heading-9">四、面试延伸：常见误区与补充</h3>
<ol>
<li><strong>误区</strong>：“只有 0.1 + 0.2 有问题”—— 其实所有无法被二进制精确表示的十进制小数运算都可能有精度问题，比如 0.7 + 0.1 = 0.7999999999999999。</li>
<li><strong>补充</strong>：整数运算为什么没问题？因为十进制整数可以被二进制精确表示（只要不超过 2^53，超过后也会丢失精度）。</li>
</ol>
<h3 data-id="heading-10">五、总结</h3>
<p>回到面试题，完整的回答应该包含 3 个核心点：</p>
<ol>
<li><strong>底层原因</strong>：JS 遵循 IEEE 754 标准，用 64 位双精度浮点数存储数字，0.1 和 0.2 的二进制是无限循环小数，存储时精度丢失；</li>
<li><strong>现象本质</strong>：精度丢失后的 0.1 + 0.2 结果是 0.30000000000000004，而非精确的 0.3，因此严格相等判断为 false；</li>
<li><strong>解决方案</strong>：日常场景用误差阈值（Number.EPSILON），金融场景转整数计算或使用 <code>decimal.js/big.js</code> 等库。</li>
</ol>
<p>这个问题看似简单，实则考察对 JS 数字存储底层的理解，记住 “现象 - 原因 - 解决方案” 的逻辑链，面试时就能从容应对了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Claude Code按量安装教程：低成本使用AI编程的方法]]></title>    <link>https://juejin.cn/post/7599483794658328617</link>    <guid>https://juejin.cn/post/7599483794658328617</guid>    <pubDate>2026-01-27T01:38:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599483794658328617" data-draft-id="7599483794658312233" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Claude Code按量安装教程：低成本使用AI编程的方法"/> <meta itemprop="keywords" content="Claude"/> <meta itemprop="datePublished" content="2026-01-27T01:38:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户815091607260"/> <meta itemprop="url" content="https://juejin.cn/user/2042264015120554"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Claude Code按量安装教程：低成本使用AI编程的方法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2042264015120554/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户815091607260
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T01:38:49.000Z" title="Tue Jan 27 2026 01:38:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>还在为 Claude Code 无法直连、API 配额受限而头疼吗？<br/>
Claude Code 作为当前最强的 AI 编程 CLI 工具之一，已经能真正做到“读懂整个项目、直接改代码、生成提交”。但很多人卡在第一步：官方 API 难用、网络受限、模型切换复杂。</p>
<p>本文将手把手教你 通过「神马中转 API」快速接入 Claude Code，从安装、环境变量配置，到模型切换与最小可用示例，5 分钟跑起来，10 分钟上生产，让 Claude Code 真正成为你的本地 AI 编程助手。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94aab4b3a2a14f4fba489d74f6f276b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODE1MDkxNjA3MjYw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770082729&amp;x-signature=sezNcn6XNALfz1EzvmVQNwVc8%2Bg%3D" alt="【2026最新】AI编程工具：Claude Code AI中转站按量安装使用教程" loading="lazy"/></p>
<h2 data-id="heading-0">Claude Code + API中转站的组合</h2>
<ul>
<li>
<p><strong>Claude Code</strong>：Anthropic 推出的命令行 AI 编程工具（能读懂项目上下文、按自然语言改代码、跑命令、生成测试等）。</p>
</li>
<li>
<p><strong>API 中转站（这里用：神马中转API）</strong>：用你在神马平台生成的 Token，把 Claude Code 的请求转发到可用模型上；核心就是配置两个东西：</p>
<ul>
<li>
<p>ANTHROPIC_AUTH_TOKEN（你的 sk-xxx）</p>
</li>
<li>
<p>ANTHROPIC_BASE_URL（指向神马中转的 BaseURL：<a href="https://link.juejin.cn?target=https%3A%2F%2Fapi.whatai.cc%25EF%25BC%2589" target="_blank" title="https://api.whatai.cc%EF%BC%89" ref="nofollow noopener noreferrer">api.whatai.cc）</a></p>
</li>
</ul>
</li>
</ul>
<h2 data-id="heading-1">安装前准备</h2>
<h3 data-id="heading-2">必备环境</h3>
<ul>
<li><strong>Node.js 18+（建议 LTS）</strong>：Claude Code 通过 npm 安装，Node 版本要够新。</li>
</ul>
<p>验证是否安装成功（任意系统都适用）：</p>
<pre><code class="hljs language-css" lang="css">node <span class="hljs-attr">--version</span>
npm <span class="hljs-attr">--version</span>
</code></pre>
<p>示例里提到 Node 版本通常会在 v18.x.x 以上。</p>
<h2 data-id="heading-3">安装Claude Code（通用）</h2>
<p>用 npm 全局安装：</p>
<pre><code class="hljs language-bash" lang="bash">npm install -g @anthropic-ai/claude-code
</code></pre>
<p>文档与文章都给的是这条命令。</p>
<h2 data-id="heading-4">配置：接入「神马中转 API」</h2>
<h3 data-id="heading-5">第一步：在神马平台生成 Token</h3>
<p>去神马中转平台后台创建/复制你的 <strong>sk- 开头</strong> Token（文章里也强调 Token 是 sk-xxx 这种格式）。</p>
<h3 data-id="heading-6">第二步：设置环境变量（关键）</h3>
<p>你需要设置两项（重点就是它俩）：</p>
<ul>
<li>
<p>ANTHROPIC_AUTH_TOKEN</p>
</li>
<li>
<p>ANTHROPIC_BASE_URL</p>
</li>
</ul>
<h3 data-id="heading-7">macOS / Linux（Bash 或 Zsh）</h3>
<p><strong>Bash：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">'export ANTHROPIC_AUTH_TOKEN="sk-xxx"'</span> &gt;&gt; ~/.bash_profile
<span class="hljs-built_in">echo</span> <span class="hljs-string">'export ANTHROPIC_BASE_URL="https://api.whatai.cc"'</span> &gt;&gt; ~/.bash_profile
<span class="hljs-built_in">source</span> ~/.bash_profile
</code></pre>
<p><strong>Zsh：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">'export ANTHROPIC_AUTH_TOKEN="sk-xxx"'</span> &gt;&gt; ~/.zshrc
<span class="hljs-built_in">echo</span> <span class="hljs-string">'export ANTHROPIC_BASE_URL="https://api.whatai.cc"'</span> &gt;&gt; ~/.zshrc
<span class="hljs-built_in">source</span> ~/.zshrc
</code></pre>
<blockquote>
<p>设置后如果不生效，重启终端</p>
</blockquote>
<h3 data-id="heading-8">Windows（推荐图形化 / PowerShell / CMD）</h3>
<p><strong>方法一：图形化（推荐、永久生效）</strong></p>
<p>系统环境变量里新增：</p>
<ul>
<li>
<p>ANTHROPIC_AUTH_TOKEN = sk-xxx</p>
</li>
<li>
<p>ANTHROPIC_BASE_URL = <a href="https://link.juejin.cn?target=https%3A%2F%2Fapi.whatai.cc" target="_blank" title="https://api.whatai.cc" ref="nofollow noopener noreferrer">api.whatai.cc</a></p>
</li>
</ul>
<p><strong>方法二：PowerShell（永久）</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[Environment]</span>::<span class="hljs-built_in">SetEnvironmentVariable</span>(<span class="hljs-string">"ANTHROPIC_AUTH_TOKEN"</span>, <span class="hljs-string">"sk-xxx"</span>, <span class="hljs-string">"User"</span>)
[Environment]::<span class="hljs-built_in">SetEnvironmentVariable</span>(<span class="hljs-string">"ANTHROPIC_BASE_URL"</span>, <span class="hljs-string">"https://api.whatai.cc"</span>, <span class="hljs-string">"User"</span>)
</code></pre>
<p><strong>方法三：CMD（永久）</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">setx ANTHROPIC_AUTH_TOKEN <span class="hljs-string">"sk-xxx"</span>
setx ANTHROPIC_BASE_URL <span class="hljs-string">"https://api.whatai.cc"</span>
</code></pre>
<h3 data-id="heading-9">Windows 进阶：用 settings.json 一次性写入（可带模型）</h3>
<p>如果你更喜欢“写配置文件”的方式，文档给了路径与示例结构：</p>
<p>C:\Users\{user}\.claude\settings.json</p>
<p>示例（你要把 token 改成自己的）：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"env"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"ANTHROPIC_MODEL"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"claude-sonnet-4-20250514"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"ANTHROPIC_SMALL_FAST_MODEL"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"claude-sonnet-4-20250514"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"ANTHROPIC_BASE_URL"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://api.whatai.cc"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"ANTHROPIC_AUTH_TOKEN"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sk-xxx"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-10">启动与最小可用验证</h2>
<p>进入你的项目目录，然后启动：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> your-project-folder
claude
</code></pre>
<p>文档就是这么启动的。</p>
<p>首次启动一般会引导你做一些初始化选择（主题、确认提示、信任目录等）。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d500507f768445e8b030f8f4c53f8c11~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODE1MDkxNjA3MjYw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770082729&amp;x-signature=3cDM2oZS3NNZIvaOsqwOOnyxsFE%3D" alt="【2026最新】AI编程工具：Claude Code AI中转站按量安装使用教程" loading="lazy"/></p>
<h2 data-id="heading-11">简单使用：3分钟上手</h2>
<h3 data-id="heading-12">常用命令（最常用的就这些）</h3>
<ul>
<li>
<p>claude：进入交互模式</p>
</li>
<li>
<p>claude "task"：跑一次性任务</p>
</li>
<li>
<p>claude commit：让它帮你生成/组织 Git 提交</p>
</li>
<li>
<p>/help：查看内置命令</p>
</li>
<li>
<p>/clear：清空对话上下文</p>
</li>
<li>
<p>/review：让它做代码审查</p>
</li>
</ul>
<h3 data-id="heading-13">最小示例：让它写个函数</h3>
<p>在 claude 交互模式里直接说人话，例如（文档示例）：</p>
<ul>
<li>“请帮我写一个 Python 函数，用于计算斐波那契数列”</li>
</ul>
<h3 data-id="heading-14">一句话做代码审查</h3>
<p>直接单次命令：</p>
<pre><code class="hljs language-arduino" lang="arduino">claude <span class="hljs-string">"review this code for potential bugs"</span>
</code></pre>
<p>这是文档给的示例之一。</p>
<h2 data-id="heading-15">切换模型（重点：/model）</h2>
<p>在 Claude Code 里用：</p>
<pre><code class="hljs language-bash" lang="bash">/model [model <span class="hljs-built_in">id</span>]
</code></pre>
<p>文档举例：默认 Sonnet 4，也可以切到 Opus 4：</p>
<pre><code class="hljs language-bash" lang="bash">/model opus
</code></pre>
<p>还给了类似 claude-3-7-sonnet-20250219 的切换示例，以及 Kimi K2 的示例（/model moonshotai/kimi-k2-instruct），并说明其他 LLM（OpenAI/Gemini/Qwen/Doubao 等）也能用。</p>
<blockquote>
<p>小提醒：不同中转站对“模型名/别名”的支持可能不完全一样</p>
</blockquote>
<h2 data-id="heading-16">常见坑位</h2>
<ol>
<li>
<p><strong>Token 要换成你自己的</strong>：别把示例 sk-xxx 当真。</p>
</li>
<li>
<p><strong>环境变量改完要重启终端</strong>（尤其 Windows / macOS）。</p>
</li>
<li>
<p><strong>建议在具体项目目录下用</strong>，Claude Code 才能更好读上下文。</p>
</li>
<li>
<p>文档提到：创建令牌时可考虑选择特定分组（示例里建议“企业分组 官转分组”）。</p>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Node.js 编程实战：部署 Node.js 应用 —— Nginx 反向代理]]></title>    <link>https://juejin.cn/post/7599581687358930994</link>    <guid>https://juejin.cn/post/7599581687358930994</guid>    <pubDate>2026-01-27T02:58:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599581687358930994" data-draft-id="7599604510365941798" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Node.js 编程实战：部署 Node.js 应用 —— Nginx 反向代理"/> <meta itemprop="keywords" content="前端,后端,Node.js"/> <meta itemprop="datePublished" content="2026-01-27T02:58:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员爱钓鱼"/> <meta itemprop="url" content="https://juejin.cn/user/2799775299157614"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Node.js 编程实战：部署 Node.js 应用 —— Nginx 反向代理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2799775299157614/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员爱钓鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T02:58:57.000Z" title="Tue Jan 27 2026 02:58:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>当 Node.js 应用部署到服务器之后，如果直接对外暴露应用端口（如 3000），在<strong>安全性、性能与可维护性</strong>方面都会存在明显不足。</p>
</blockquote>
<p>在生产环境中，几乎所有成熟系统都会在 Node.js 服务前增加一层 <strong>Nginx 反向代理</strong>，由 Nginx 统一对外提供访问入口，Node.js 只负责业务逻辑处理。</p>
<p>本文将从实战角度，系统讲解如何使用 Nginx 为 Node.js 应用配置反向代理，并介绍常见的部署模式与优化建议。</p>
<hr/>
<h2 data-id="heading-0">一、为什么要使用 Nginx 反向代理</h2>
<p>在 Node.js 服务前增加 Nginx，主要可以解决以下问题：</p>
<ol>
<li>
<ol>
<li>统一访问入口<br/>
用户只访问 80 / 443 端口，不需要感知后端端口号。</li>
</ol>
</li>
<li>
<ol start="2">
<li>提高安全性<br/>
隐藏 Node.js 服务真实端口，减少被扫描和攻击的风险。</li>
</ol>
</li>
<li>
<ol start="3">
<li>支持 HTTPS<br/>
由 Nginx 终止 SSL 连接，Node.js 只处理 HTTP。</li>
</ol>
</li>
<li>
<ol start="4">
<li>静态资源加速<br/>
Nginx 高效处理图片、JS、CSS 等静态资源。</li>
</ol>
</li>
<li>
<ol start="5">
<li>负载均衡<br/>
可将请求分发到多个 Node.js 实例。</li>
</ol>
</li>
<li>
<ol start="6">
<li>平滑重启与容错<br/>
Node.js 重启时，Nginx 仍可提供基础服务。</li>
</ol>
</li>
</ol>
<hr/>
<h2 data-id="heading-1">二、基础部署架构</h2>
<p>一个典型的部署架构如下：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">用户浏览器</span>
     <span class="hljs-string">|</span>
     <span class="hljs-string">|</span> <span class="hljs-number">80</span> <span class="hljs-string">/</span> <span class="hljs-number">443</span>
     <span class="hljs-string">v</span>
   <span class="hljs-string">Nginx</span>
     <span class="hljs-string">|</span>
     <span class="hljs-string">|</span> <span class="hljs-number">3000</span>
     <span class="hljs-string">v</span>
 <span class="hljs-string">Node.js</span> <span class="hljs-string">应用（PM2</span> <span class="hljs-string">/</span> <span class="hljs-string">Docker）</span>
</code></pre>
<p>用户只访问 Nginx，所有请求由 Nginx 转发给 Node.js。</p>
<hr/>
<h2 data-id="heading-2">三、安装 Nginx</h2>
<p>在常见 Linux 系统中，可以直接通过包管理器安装。</p>
<h3 data-id="heading-3">Ubuntu / Debian</h3>
<pre><code class="hljs language-sql" lang="sql">sudo apt <span class="hljs-keyword">update</span>
sudo apt install nginx
</code></pre>
<h3 data-id="heading-4">CentOS / Rocky Linux</h3>
<pre><code class="hljs">sudo yum install nginx
</code></pre>
<p>安装完成后启动 Nginx：</p>
<pre><code class="hljs language-bash" lang="bash">sudo systemctl start nginx
sudo systemctl <span class="hljs-built_in">enable</span> nginx
</code></pre>
<p>访问服务器 IP，如果看到 Nginx 默认页面，说明安装成功。</p>
<hr/>
<h2 data-id="heading-5">四、最小可用反向代理配置</h2>
<p>假设 Node.js 服务监听在 <code>127.0.0.1:3000</code>。</p>
<h3 data-id="heading-6">1. 创建站点配置文件</h3>
<pre><code class="hljs language-bash" lang="bash">sudo nano /etc/nginx/conf.d/my-app.conf
</code></pre>
<h3 data-id="heading-7">2. 基本配置示例</h3>
<pre><code class="hljs language-ini" lang="ini">server {
    listen 80<span class="hljs-comment">;</span>
    server_name myapp.example.com<span class="hljs-comment">;</span>

    location / {
        proxy_pass http://127.0.0.1:3000<span class="hljs-comment">;</span>

        proxy_http_version 1.1<span class="hljs-comment">;</span>
        proxy_set_header Upgrade $http_upgrade<span class="hljs-comment">;</span>
        proxy_set_header Connection 'upgrade'<span class="hljs-comment">;</span>

        proxy_set_header Host $host<span class="hljs-comment">;</span>
        proxy_set_header X-Real-IP $remote_addr<span class="hljs-comment">;</span>
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for<span class="hljs-comment">;</span>
        proxy_set_header X-Forwarded-Proto $scheme<span class="hljs-comment">;</span>

        proxy_cache_bypass $http_upgrade<span class="hljs-comment">;</span>
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-8">3. 启用配置并重载</h3>
<pre><code class="hljs">sudo nginx -t
sudo systemctl reload nginx
</code></pre>
<p>此时访问 <code>http://myapp.example.com</code> 即可看到 Node.js 应用页面。</p>
<hr/>
<h2 data-id="heading-9">五、支持 WebSocket 转发</h2>
<p>如果你的 Node.js 应用使用了 WebSocket（如 Socket.IO），必须显式开启相关配置。</p>
<pre><code class="hljs language-bash" lang="bash">location /socket.io/ {
    proxy_pass http://127.0.0.1:3000/socket.io/;

    proxy_http_version 1.1;
    proxy_set_header Upgrade <span class="hljs-variable">$http_upgrade</span>;
    proxy_set_header Connection <span class="hljs-string">"Upgrade"</span>;

    proxy_set_header Host <span class="hljs-variable">$host</span>;
    proxy_set_header X-Real-IP <span class="hljs-variable">$remote_addr</span>;
    proxy_set_header X-Forwarded-For <span class="hljs-variable">$proxy_add_x_forwarded_for</span>;
}
</code></pre>
<p>否则 WebSocket 连接会在 Nginx 层被断开。</p>
<hr/>
<h2 data-id="heading-10">六、静态资源由 Nginx 直接托管</h2>
<p>为了减轻 Node.js 压力，建议将静态资源交给 Nginx 直接处理。</p>
<pre><code class="hljs language-csharp" lang="csharp">location /<span class="hljs-keyword">static</span>/ {
    <span class="hljs-keyword">alias</span> /<span class="hljs-keyword">var</span>/www/my-app/<span class="hljs-keyword">static</span>/;
    expires <span class="hljs-number">30</span>d;
    add_header Cache-Control <span class="hljs-string">"public"</span>;
}
</code></pre>
<p>Node.js 只负责 API 和动态页面请求。</p>
<hr/>
<h2 data-id="heading-11">七、多实例负载均衡</h2>
<p>如果你使用 PM2 cluster 或 Docker 多实例，可以在 Nginx 层做负载均衡。</p>
<pre><code class="hljs language-ini" lang="ini">upstream my_node_app {
    server 127.0.0.1:3000<span class="hljs-comment">;</span>
    server 127.0.0.1:3001<span class="hljs-comment">;</span>
    server 127.0.0.1:3002<span class="hljs-comment">;</span>
}

server {
    listen 80<span class="hljs-comment">;</span>
    server_name myapp.example.com<span class="hljs-comment">;</span>

    location / {
        proxy_pass http://my_node_app<span class="hljs-comment">;</span>

        proxy_http_version 1.1<span class="hljs-comment">;</span>
        proxy_set_header Upgrade $http_upgrade<span class="hljs-comment">;</span>
        proxy_set_header Connection 'upgrade'<span class="hljs-comment">;</span>

        proxy_set_header Host $host<span class="hljs-comment">;</span>
        proxy_set_header X-Real-IP $remote_addr<span class="hljs-comment">;</span>
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for<span class="hljs-comment">;</span>
    }
}
</code></pre>
<p>Nginx 会将请求轮询分发到多个 Node.js 实例，提高整体吞吐能力。</p>
<hr/>
<h2 data-id="heading-12">八、常见问题与排错思路</h2>
<h3 data-id="heading-13">1. 502 Bad Gateway</h3>
<p>常见原因：</p>
<ul>
<li>• Node.js 服务未启动</li>
<li>• 端口号配置错误</li>
<li>• 防火墙拦截本地端口</li>
</ul>
<p>检查步骤：</p>
<pre><code class="hljs language-arduino" lang="arduino">curl http:<span class="hljs-comment">//127.0.0.1:3000</span>
</code></pre>
<hr/>
<h3 data-id="heading-14">2. WebSocket 连接失败</h3>
<p>检查是否包含：</p>
<pre><code class="hljs language-bash" lang="bash">proxy_set_header Upgrade <span class="hljs-variable">$http_upgrade</span>;
proxy_set_header Connection <span class="hljs-string">"Upgrade"</span>;
</code></pre>
<hr/>
<h3 data-id="heading-15">3. 请求头丢失真实 IP</h3>
<p>确保设置：</p>
<pre><code class="hljs language-bash" lang="bash">proxy_set_header X-Real-IP <span class="hljs-variable">$remote_addr</span>;
proxy_set_header X-Forwarded-For <span class="hljs-variable">$proxy_add_x_forwarded_for</span>;
</code></pre>
<p>在 Node.js 中通过 <code>req.ip</code> 或 <code>x-forwarded-for</code> 读取真实客户端 IP。</p>
<hr/>
<h2 data-id="heading-16">九、生产环境优化建议</h2>
<ol>
<li>
<ol>
<li>启用 Gzip 压缩</li>
</ol>
</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">gzip on;
gzip_types text/plain text/css application/json application/javascript;
gzip_min_length 1024;
</code></pre>
<ol>
<li>
<ol start="2">
<li>设置合理的超时时间</li>
</ol>
</li>
</ol>
<pre><code class="hljs language-ini" lang="ini">proxy_connect_timeout 60s<span class="hljs-comment">;</span>
proxy_send_timeout 60s<span class="hljs-comment">;</span>
proxy_read_timeout 60s<span class="hljs-comment">;</span>
</code></pre>
<ol>
<li>
<ol start="3">
<li>配合 HTTPS 使用<br/>
将 SSL 证书部署在 Nginx 层，Node.js 只监听 HTTP。</li>
</ol>
</li>
<li>
<ol start="4">
<li>配合 PM2 / Docker<br/>
保证 Node.js 进程异常退出后自动拉起。</li>
</ol>
</li>
</ol>
<hr/>
<h2 data-id="heading-17">十、总结</h2>
<p>在 Node.js 应用部署架构中，<strong>Nginx 反向代理几乎是标准配置</strong>。它承担了对外入口、安全防护、静态资源加速、负载均衡等关键角色。</p>
<p>通过合理配置 Nginx，你可以获得：</p>
<ul>
<li>• 更高的安全性</li>
<li>• 更稳定的访问入口</li>
<li>• 更好的性能表现</li>
<li>• 更灵活的扩展能力</li>
</ul>
<p>在《Node.js 编程实战》系列中，Nginx 反向代理是继 PM2、Docker 之后迈向生产级部署的重要一步，为后续 HTTPS、负载均衡与高可用架构奠定了坚实基础。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[亲测有效！M4芯片Mac安装Node.js 14避坑指南，解决nvm install失败问题]]></title>    <link>https://juejin.cn/post/7599579865608044586</link>    <guid>https://juejin.cn/post/7599579865608044586</guid>    <pubDate>2026-01-27T02:59:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599579865608044586" data-draft-id="7599550337385332799" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="亲测有效！M4芯片Mac安装Node.js 14避坑指南，解决nvm install失败问题"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-27T02:59:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="maskie"/> <meta itemprop="url" content="https://juejin.cn/user/3532076760700055"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            亲测有效！M4芯片Mac安装Node.js 14避坑指南，解决nvm install失败问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3532076760700055/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    maskie
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T02:59:22.000Z" title="Tue Jan 27 2026 02:59:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">问题概述：当现代硬件遇见旧版软件</h2>
<p>刚从<code>Windows</code>切换到全新的<code>MacBook Pro（M4芯片）</code>，准备投入到熟悉的老项目维护中，一切似乎都很顺利——直到我需要运行那个依赖<code>Node.js 14</code>的项目。
在终端中输入 <code>nvm install 14 </code>后，等待我的不是成功的提示，而是一连串令人困惑的错误信息：<img src="https://i-blog.csdnimg.cn/direct/fa529ffa50824f8aa93eaecc892c1680.png" alt="[图片]" loading="lazy"/></p>
<h2 data-id="heading-1">为什么安装会失败？</h2>
<ol>
<li>架构差异的本质</li>
</ol>
<blockquote>
<ul>
<li>Node.js 14官方预编译包主要针对x86_64架构</li>
<li>M4芯片的ARM架构需要对应的ARM原生二进制文件</li>
<li>缺乏官方维护的低版本ARM原生包</li>
</ul>
</blockquote>
<p>2.依赖链断裂问题</p>
<blockquote>
<ul>
<li>部分Node.js 14依赖的本地模块（native addons）无ARM版本</li>
<li>npm包中的postinstall脚本可能包含不兼容的命令</li>
</ul>
</blockquote>
<h2 data-id="heading-2">解决方案：通过Rosetta 2架起兼容的桥梁</h2>
<p>经过多次尝试，Rosetta 2转译方案被证明是最稳定可靠的方法。以下是详细步骤：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 安装 Rosetta 2（如果还没有）</span>
softwareupdate --install-rosetta

<span class="hljs-comment"># 2. 在 Rosetta 2 终端中运行</span>
<span class="hljs-built_in">arch</span> -x86_64 zsh

<span class="hljs-comment"># 3. 在这个终端中安装 nvm（如果需要）</span>
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.5/install.sh | bash

<span class="hljs-comment"># 4. 安装 Node.js v14</span>
nvm install v14.21.3
</code></pre>
<p><strong>安装后，每次运行 Node v14 的项目时，需要在 Rosetta 终端中：</strong></p>
<pre><code class="hljs language-powershell" lang="powershell">arch -x86_64 zsh
nvm use v14
</code></pre>
<h2 data-id="heading-3">效果图</h2>
<p>正常下载并切换 node 14版本，安装 <code>node_modules</code>
<img src="https://i-blog.csdnimg.cn/direct/337afd81cab949f29477fcfa631efdea.png" alt="[图片]" loading="lazy"/></p>
<p>项目正常运行
<img src="https://i-blog.csdnimg.cn/direct/06ae187c7244461cbeb65dc6211270cc.png" alt="[图片]" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何在win11上本地部署qwen3-4b大模型]]></title>    <link>https://juejin.cn/post/7599600549764136995</link>    <guid>https://juejin.cn/post/7599600549764136995</guid>    <pubDate>2026-01-27T02:00:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599600549764136995" data-draft-id="7599586891084742690" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何在win11上本地部署qwen3-4b大模型"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-27T02:00:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="二福同志null"/> <meta itemprop="url" content="https://juejin.cn/user/3934498593972979"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何在win11上本地部署qwen3-4b大模型
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3934498593972979/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    二福同志null
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T02:00:32.000Z" title="Tue Jan 27 2026 02:00:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>笔者电脑配置如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed3339510b134fe0b0d4848e7f68a97e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqM56aP5ZCM5b-XbnVsbA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084032&amp;x-signature=mWTEiFROYW5bKCQsyruhevI4Vm0%3D" alt="" loading="lazy"/></p>
<p>注意必须先搭建python环境哈，并且要64位的。</p>
<p>我的显卡一般因此选择了qwen3-4b模型，模型的下载地址为：</p>
<pre><code class="hljs language-arduino" lang="arduino">https:<span class="hljs-comment">//www.modelscope.cn/collections</span>
</code></pre>
<p>如何下载大模型：</p>
<p>管理员身份启动cmd</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment">#输入命令</span>
pip install modelscope
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c2dabf240e7943979a3414f3d436d749~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqM56aP5ZCM5b-XbnVsbA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084032&amp;x-signature=6f%2BxPgV45NJ6M9h1uU29eSXjUpA%3D" alt="" loading="lazy"/></p>
<p>在你的电脑本地创建一个用于存放模型文件的文件夹，笔者是D:\Code\bigMod\qwen34b</p>
<pre><code class="hljs language-css" lang="css">modelscope download <span class="hljs-attr">--model</span> Qwen/Qwen3-<span class="hljs-number">4</span>B <span class="hljs-attr">--local_dir</span> "D:\Code\bigMod\qwen34b<span class="hljs-string">"
</span></code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90268c8ab24c4f24bb456a8b7bff7957~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqM56aP5ZCM5b-XbnVsbA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084032&amp;x-signature=8fBASg3waiJyWysB%2BGhVZxlRhGs%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b038d57c8ed4840bba64915d6e4221a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqM56aP5ZCM5b-XbnVsbA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084032&amp;x-signature=j%2Fa%2FiGaGQ63jogBOS0AfGgRisUo%3D" alt="" loading="lazy"/></p>
<p>然后使用pycharm将qwen34b文件夹当做项目文件打开</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/329306a500dd4ea5b070093a31ab4ddf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqM56aP5ZCM5b-XbnVsbA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084032&amp;x-signature=ZKgyJYm6BmoZnPF9yRyu4yR8r5A%3D" alt="" loading="lazy"/></p>
<p>然后在根目录新建一个py文件用于启动模型，我使用的是run_qwen.py</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/707b8e702a344e4682bbcb06aa608024~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqM56aP5ZCM5b-XbnVsbA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084032&amp;x-signature=FujAU9G7Yd1hLv5xVoGz60WgbTQ%3D" alt="" loading="lazy"/></p>
<p>在pycharm的终端里安装一下依赖</p>
<pre><code class="hljs language-bash" lang="bash">pip install transformers torch accelerate sentencepiece einops
pip install modelscope  <span class="hljs-comment"># 如果使用ModelScope加载</span>
pip install bitsandbytes  <span class="hljs-comment"># 用于4-bit量化</span>
</code></pre>
<p>注意选择Cuda还是cpu具体取决于你的电脑或者服务器，笔者的电脑显卡虽然不太行，但是勉强将就。如果你的电脑没有独显，那么推荐使用cpu来计算。并且cuda应该要单独装一个驱动。笔者早年装过这个驱动（不知道不装有没有影响），所以不在赘述</p>
<pre><code class="hljs language-ini" lang="ini">import torch
from transformers import AutoTokenizer, AutoModelForCausalLM

<span class="hljs-comment"># 配置参数</span>
<span class="hljs-attr">MODEL_PATH</span> = <span class="hljs-string">"D:/Code/bigMod/qwen34b"</span>  <span class="hljs-comment"># 你的模型路径</span>
<span class="hljs-attr">DEVICE</span> = <span class="hljs-string">"cuda"</span> if torch.cuda.is_available() else <span class="hljs-string">"cpu"</span>
<span class="hljs-attr">QUANTIZE</span> = <span class="hljs-literal">True</span>  <span class="hljs-comment"># 是否启用4-bit量化（RTX 3060强烈建议开启）</span>

print(f"正在加载模型，设备: {DEVICE}")
print(f"模型路径: {MODEL_PATH}")

try:
    <span class="hljs-comment"># 加载tokenizer</span>
    <span class="hljs-attr">tokenizer</span> = AutoTokenizer.from_pretrained(
        MODEL_PATH,
        <span class="hljs-attr">trust_remote_code</span>=<span class="hljs-literal">True</span>,
        <span class="hljs-attr">use_fast</span>=<span class="hljs-literal">False</span>
    )

    <span class="hljs-comment"># 加载模型</span>
    if QUANTIZE and <span class="hljs-attr">DEVICE</span> == <span class="hljs-string">"cuda"</span>:
        print("启用4-bit量化...")
        <span class="hljs-attr">model</span> = AutoModelForCausalLM.from_pretrained(
            MODEL_PATH,
            <span class="hljs-attr">device_map</span>=<span class="hljs-string">"auto"</span>,
            <span class="hljs-attr">trust_remote_code</span>=<span class="hljs-literal">True</span>,
            <span class="hljs-attr">load_in_4bit</span>=<span class="hljs-literal">True</span>,  <span class="hljs-comment"># 4-bit量化</span>
            <span class="hljs-attr">bnb_4bit_compute_dtype</span>=torch.float16,
            <span class="hljs-attr">bnb_4bit_quant_type</span>=<span class="hljs-string">"nf4"</span>,
            <span class="hljs-attr">bnb_4bit_use_double_quant</span>=<span class="hljs-literal">True</span>
        )
    else:
        print("加载完整精度模型...")
        <span class="hljs-attr">model</span> = AutoModelForCausalLM.from_pretrained(
            MODEL_PATH,
            <span class="hljs-attr">device_map</span>=<span class="hljs-string">"auto"</span>,
            <span class="hljs-attr">trust_remote_code</span>=<span class="hljs-literal">True</span>,
            <span class="hljs-attr">torch_dtype</span>=torch.float16 if DEVICE == <span class="hljs-string">"cuda"</span> else torch.float32
        )

    print("模型加载成功！")


    <span class="hljs-comment"># 测试推理</span>
    def chat_with_model(prompt):
        <span class="hljs-attr">messages</span> = [
            {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"你是一个有用的AI助手。"</span>},
            {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: prompt}
        ]

        <span class="hljs-comment"># 使用tokenizer的apply_chat_template方法（Qwen3支持）</span>
        <span class="hljs-attr">text</span> = tokenizer.apply_chat_template(
            messages,
            <span class="hljs-attr">tokenize</span>=<span class="hljs-literal">False</span>,
            <span class="hljs-attr">add_generation_prompt</span>=<span class="hljs-literal">True</span>
        )

        <span class="hljs-attr">model_inputs</span> = tokenizer([text], return_tensors=<span class="hljs-string">"pt"</span>).to(DEVICE)

        with torch.no_grad():
            <span class="hljs-attr">generated_ids</span> = model.generate(
                **model_inputs,
                <span class="hljs-attr">max_new_tokens</span>=<span class="hljs-number">512</span>,
                <span class="hljs-attr">do_sample</span>=<span class="hljs-literal">True</span>,
                <span class="hljs-attr">temperature</span>=<span class="hljs-number">0.6</span>,
                <span class="hljs-attr">top_p</span>=<span class="hljs-number">0.9</span>,
                <span class="hljs-attr">pad_token_id</span>=tokenizer.eos_token_id
            )

        <span class="hljs-comment"># 去除输入部分，只保留生成内容</span>
        <span class="hljs-attr">generated_ids</span> = [
            output_ids[len(input_ids):]
            for input_ids, output_ids in zip(model_inputs.input_ids, generated_ids)
        ]

        <span class="hljs-attr">response</span> = tokenizer.batch_decode(generated_ids, skip_special_tokens=<span class="hljs-literal">True</span>)[<span class="hljs-number">0</span>]
        return response


    <span class="hljs-comment"># 交互式对话</span>
    print("\n<span class="hljs-attr">" + "</span>=<span class="hljs-string">" * 50)
    print("</span>Qwen3-<span class="hljs-number">4</span>B 已启动！输入 <span class="hljs-string">'exit'</span> 退出对话。<span class="hljs-string">")
    print("</span>=<span class="hljs-string">" * 50 + "</span>\n<span class="hljs-string">")

    while True:
        user_input = input("</span>您: <span class="hljs-string">")
        if user_input.lower() in ['exit', 'quit', 'bye']:
            print("</span>再见！<span class="hljs-string">")
            break

        print("</span>AI: <span class="hljs-string">", end="</span><span class="hljs-string">", flush=True)
        response = chat_with_model(user_input)
        print(response)

except Exception as e:
    print(f"</span>加载模型时出错: {str(e)}<span class="hljs-string">")
    import traceback

    traceback.print_exc()
</span></code></pre>
<p>最后启动py文件，在控制台输入问题就好了</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a75a3a7891c48af92d5243e2e3278a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqM56aP5ZCM5b-XbnVsbA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084032&amp;x-signature=bFcloGFFzwdIvLWtP1g4ycq5Pn8%3D" alt="" loading="lazy"/></p>
<p>但是qwen3-4b真的有些笨，不推荐。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RAG 深度实践系列（三）：RAG 技术演变与核心架构的深度剖析]]></title>    <link>https://juejin.cn/post/7599586891084529698</link>    <guid>https://juejin.cn/post/7599586891084529698</guid>    <pubDate>2026-01-27T01:30:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599586891084529698" data-draft-id="7599586891084464162" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RAG 深度实践系列（三）：RAG 技术演变与核心架构的深度剖析"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-27T01:30:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="中杯可乐多加冰"/> <meta itemprop="url" content="https://juejin.cn/user/3435306702347432"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RAG 深度实践系列（三）：RAG 技术演变与核心架构的深度剖析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3435306702347432/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    中杯可乐多加冰
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T01:30:02.000Z" title="Tue Jan 27 2026 01:30:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读24分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、 RAG 范式演进：从知识搬运工到智能决策者</h2>
<p>检索增强生成（RAG）技术的发展史，是一部不断挑战大型语言模型（LLM）局限性、追求系统级智能的演进史。RAG 的演变并非简单的功能叠加，而是对“如何高效、可靠地将外部知识融入 LLM 推理过程”这一核心问题的持续探索。我们可以将 RAG 的演进脉络划分为四个清晰的阶段：<strong>Naive RAG</strong> 确立基本范式，<strong>Advanced RAG</strong> 聚焦精细化优化，<strong>Modular RAG</strong> 追求架构灵活性，最终 <strong>Agentic RAG</strong> 实现自主决策与智能化。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af1604d58a0640578521ec6192f57014~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770082202&amp;x-signature=PT4V2%2Fhph6oZBhO2haMu7ner1ys%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<hr/>
<p>在 RAG 的实践中，许多开发者在面对复杂场景时，常因缺乏对架构演进逻辑的深刻理解而陷入困境：如何将知识图谱（GraphRAG）融入向量检索？如何设计一个具备自我反思能力的 Agentic RAG 系统？如何平衡实时性与准确性？</p>
<p>为了帮你填补从懂原理到能落地的关键拼图，AI大学堂基于大量的业务实战经验，精心打磨课程，正式推出 <strong>RAG工程师认证</strong>。这份证书将是你系统化掌握 AI 落地核心能力的绝佳机会，认证现已开启，<strong>限时免费</strong>，点击文末<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aidaxue.com%2Fcourse%2F1190%3Fvideo_id%3D5212%26ch%3Dai_daxue_csdn" target="_blank" title="https://www.aidaxue.com/course/1190?video_id=5212&amp;ch=ai_daxue_csdn" ref="nofollow noopener noreferrer">🔗认证链接</a>开始学习！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e8f9a20ab57e40708dd69ba01c2a4b81~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770082202&amp;x-signature=0orq9xSe5Ny%2FVNvHBu%2FK15Pq9ZM%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-1"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1.1、 Naive RAG：范式的确立与固有局限</h3>
<p><strong>Naive RAG</strong>（朴素 RAG）是 RAG 技术的起点，其核心思想是“索引-检索-生成”的线性流程。它解决了 LLM 在特定领域知识上的“无知”问题，通过将文档分块、向量化，并使用单一的向量相似度检索来召回上下文。<br/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ade07eee44d4ce58c0601441b3f9a44~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770082202&amp;x-signature=XsXPwngYcUQy9w2ff9JrUL1N2Bk%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>然而，Naive RAG 的局限性是显而易见的，也是驱动后续演进的根本原因：</p>
<ol>
<li><strong>分块的语义破坏</strong>：固定大小的分块策略极易在语义边界处截断，导致单个块的语义信息不完整或被稀释，直接影响嵌入模型的编码质量。</li>
<li><strong>单一检索的盲区</strong>：仅依赖向量相似度检索，无法有效处理<strong>词汇不匹配</strong>（Lexical Gap）问题，对同义词、专业术语或需要精确关键词匹配的查询，召回率低下。</li>
<li><strong>缺乏查询优化</strong>：用户查询的模糊性、歧义性未被处理，直接影响了检索信号的质量。</li>
</ol>
<p>Naive RAG 就像一个被动的“知识搬运工”，它只能机械地执行预设的流程，缺乏对信息质量的判断和对查询意图的深度理解。</p>
<h3 data-id="heading-2"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1.2、 Advanced RAG：精细化优化与多阶段精炼</h3>
<p><strong>Advanced RAG</strong>（高级 RAG）是 RAG 走向工业级应用的关键一步，其核心在于在 Naive RAG 的基础上，引入了大量的<strong>预检索</strong>和<strong>后检索</strong>优化机制，将流程从线性转变为多阶段精炼。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2eeae31ab66e4547a9b403017e0d6a49~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770082202&amp;x-signature=U0uuHQLgDWhpzY9g2EQ1tbzzsGk%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h4 data-id="heading-3"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1.2.1、 预检索优化：增强查询信号的艺术</h4>
<p>预检索优化的目标是生成更强大的检索信号，以克服用户查询的局限性：</p>
<ul>
<li><strong>查询重写与扩展</strong>：利用 LLM 将原始查询改写成更清晰、更具体的版本，或生成多个变体查询以增加检索覆盖面。</li>
<li><strong>假设性文档嵌入（HyDE）</strong> ：这是最具创新性的技术之一。它利用 LLM 的生成能力，根据查询生成一个“假设性答案”，然后用这个假设性答案的向量去检索真实文档。由于假设性答案包含了更丰富的语义和更接近文档的词汇，它能显著提高检索的准确性，尤其是在处理抽象概念时。</li>
<li><strong>多查询生成</strong>：利用 LLM 生成多个子查询，并行执行检索，然后合并结果，以应对复杂查询和多角度信息需求。</li>
</ul>
<h4 data-id="heading-4"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1.2.2、 检索与后处理优化：从召回到准确率的飞跃</h4>
<p>Advanced RAG 在检索和后处理环节的优化，是其性能飞跃的关键：</p>
<ul>
<li><strong>混合检索（Hybrid Retrieval）</strong> ：将基于关键词的稀疏检索（如 BM25）与基于语义的稠密检索（向量检索）进行融合。这种融合的数学逻辑在于，通过 <strong>RRF（Reciprocal Rank Fusion）</strong>  等算法，将两种不同相关性度量（词频-逆文档频率与向量余弦相似度）的结果进行加权排序，实现优势互补，最大化召回率和准确率。</li>
<li><strong>语义分块策略</strong>：取代固定分块，采用基于句子、段落或标题的语义分块，确保每个块的语义完整性。更进一步的策略是<strong>父文档检索</strong>，即用小块进行检索，但返回包含该小块的更大“父文档”作为 LLM 的上下文，以平衡检索精度和上下文丰富度。</li>
<li><strong>Cross-Encoder 重排序</strong>：这是提升准确率（Precision）的利器。与 Bi-Encoder 独立编码查询和文档不同，Cross-Encoder 将查询和文档<strong>拼接</strong>后一起输入模型，从而捕捉两者之间细粒度的交互信息。虽然计算成本高，但其对相关性的判断更为精确，通常用于对 Bi-Encoder 召回的 Top-K 结果进行二次精排。</li>
<li><strong>上下文压缩与验证</strong>：通过 LLMLingua 等技术对检索结果进行压缩，减少 LLM 的输入 Token 数量，降低成本并提升效率。同时，引入额外的 LLM 或规则引擎对最终答案进行<strong>事实一致性验证</strong>，以降低幻觉风险。</li>
</ul>
<h2 data-id="heading-5"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>二、 Modular RAG 与 GraphRAG：架构的灵活性与知识的结构化</h2>
<p>Advanced RAG 解决了性能问题，但随着应用场景的复杂化，系统对<strong>灵活性</strong>和<strong>可扩展性</strong>提出了更高的要求，由此催生了 <strong>Modular RAG</strong>（模块化 RAG）。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3418802770314b6cbe9febffd4531e33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770082202&amp;x-signature=J%2Fzh6qFBUf2Tiy%2F6pmN7PsGZv5c%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-6"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2.1、 Modular RAG：解耦与定制化的架构哲学</h3>
<p>Modular RAG 的核心思想是<strong>解耦</strong>：将 RAG 流程中的各个功能（如查询重写、检索、重排序、验证）抽象为可插拔的独立模块。这种架构哲学使得 RAG 系统不再是一个固定的流水线，而是一个可以根据任务需求动态组装的“乐高积木”。</p>
<p>这种架构的优势在于：</p>
<ol>
<li><strong>定制化工作流</strong>：可以根据不同的业务场景（如法律问答、代码生成、财务分析）定制不同的模块组合和执行路径。</li>
<li><strong>独立优化与迭代</strong>：每个模块可以独立进行技术选型和优化（例如，针对法律文档使用专门微调的嵌入模型，针对代码使用基于 AST 的分块器），互不影响。</li>
<li><strong>支持复杂逻辑</strong>：通过模块的<strong>条件组合</strong>（根据查询类型选择不同检索器）和<strong>循环组合</strong>（实现多跳检索），能够处理 Advanced RAG 难以应对的复杂逻辑。</li>
</ol>
<p>在 Modular RAG 的实践中，<strong>DSP（Differentiable Search Path，可微搜索路径）</strong>  等框架提供了理论基础，它将 RAG 流程视为一个可优化的计算图，允许通过端到端的方式对整个流程进行微调，从而实现系统级的性能提升。</p>
<h3 data-id="heading-7"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2.2、 GraphRAG：从语义相似到逻辑推理的飞跃</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/123e9aefdfdc4b85bae9ab330c289cfa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770082202&amp;x-signature=v64cYsDNrz3W6jwGeiZsY0tDsZQ%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>在 Modular RAG 的范畴内，<strong>GraphRAG</strong>（基于知识图谱的 RAG）是解决复杂推理问题的关键技术。它解决了传统向量检索的根本缺陷：<strong>缺乏逻辑关联和因果推理能力</strong>。</p>
<p>GraphRAG 的工作原理是将知识库中的实体和关系构建成一个<strong>知识图谱（KG）</strong> 。检索过程不再仅仅是文本块的相似度匹配，而是：</p>
<ol>
<li><strong>实体与关系提取</strong>：利用 LLM 或 NLP 工具从查询和文档中提取关键实体和关系。</li>
<li><strong>图谱路径搜索</strong>：在 KG 中搜索连接查询实体和目标实体的路径。</li>
<li><strong>结构化上下文</strong>：将搜索到的图谱路径（即逻辑链条）作为结构化上下文提供给 LLM。</li>
</ol>
<p>这种方式使得 LLM 能够进行更复杂的<strong>多跳推理</strong>（Multi-hop Reasoning）。例如，要回答“A 公司的创始人 B 投资了哪些 C 领域的公司？”这样的问题，GraphRAG 可以沿着“A 公司 -&gt; 创始人 B -&gt; 投资关系 -&gt; C 领域公司”的路径进行精确搜索，并提供清晰的逻辑链条，极大地增强了答案的<strong>事实准确性</strong>和<strong>可解释性</strong>。GraphRAG 的引入，标志着 RAG 系统从“知识搬运工”正式进化为“逻辑推理者”。</p>
<h2 data-id="heading-8"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>三、 Agentic RAG：自主决策与自我反思的智能化巅峰</h2>
<p>RAG 技术的最新前沿是 <strong>Agentic RAG</strong>（智能体 RAG），它代表了 RAG 系统从被动执行到主动智能的最终形态。Agentic RAG 将 AI 智能体（Agent）技术与 RAG 深度融合，赋予系统<strong>自主决策、工具使用、任务规划和自我反思</strong>的能力。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56c26754a725457997a0a4cdf80bb183~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770082202&amp;x-signature=DkvRjP3lQt7jXBZBRDJnigz9zhA%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-9"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>3.1、 Agentic RAG 的核心机制：ReAct 与反思</h3>
<p>Agentic RAG 的核心在于其<strong>智能体框架</strong>，其中 <strong>ReAct（Reasoning and Acting）</strong>  框架是主流实现之一。ReAct 机制允许 LLM 在生成答案之前，进行<strong>推理（Reasoning）</strong>  和<strong>行动（Acting）</strong>  的交替循环：</p>
<ol>
<li><strong>推理（Reasoning）</strong> ：LLM 分析当前任务、已有的信息和下一步的目标，生成一个清晰的思考过程。</li>
<li><strong>行动（Acting）</strong> ：LLM 根据推理结果，决定调用哪个工具（如向量检索器、搜索引擎、代码解释器或 GraphRAG 模块），并执行相应的操作。</li>
</ol>
<p>这种机制使得 Agentic RAG 能够动态地规划复杂的任务。例如，在处理一个需要多步推理的法律查询时，Agent 会将问题分解为多个子任务，并动态选择工具：</p>
<ul>
<li><strong>步骤 1（推理）</strong> ：分析查询，判断需要检索法律条文和计算赔偿金。</li>
<li><strong>步骤 1（行动）</strong> ：调用 <strong>GraphRAG 模块</strong>检索最新的法律条文。</li>
<li><strong>步骤 2（推理）</strong> ：分析检索结果，确定计算公式，判断需要外部计算工具。</li>
<li><strong>步骤 2（行动）</strong> ：调用 <strong>代码解释器</strong>或 <strong>API 工具</strong>执行赔偿金计算。</li>
</ul>
<p>更高级的 Agentic RAG 引入了<strong>自我反思（Self-Reflection）</strong>  机制。在生成答案后，Agent 会利用另一个 LLM 或预设的评估指标（如 RAGAS 框架）对答案进行评估。如果评估结果不理想，Agent 会反思其推理过程和行动步骤，识别错误，并调整策略重新执行，形成一个完整的<strong>优化闭环</strong>。这种反思与优化能力，是 Agentic RAG 实现高度智能化和鲁棒性的重要保障。</p>
<h3 data-id="heading-10"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>3.2、 Agentic RAG 的应用与挑战</h3>
<p>Agentic RAG 的应用场景集中在对<strong>复杂性、准确性和智能化程度</strong>要求极高的领域：</p>
<ul>
<li><strong>智能法律助手</strong>：处理需要多跳推理、多工具协同（法律数据库、计算工具）的复杂法律查询。</li>
<li><strong>金融研究分析</strong>：自主规划数据检索、图表生成、趋势分析等一系列步骤，生成结构化的研究报告。</li>
<li><strong>复杂系统故障诊断</strong>：Agent 根据故障描述，自主调用日志检索工具、代码库、知识图谱，逐步缩小故障范围并提出解决方案。</li>
</ul>
<p>然而，Agentic RAG 也面临巨大的挑战：</p>
<ol>
<li><strong>成本与延迟</strong>：每一次推理和行动都需要 LLM 调用，导致成本和延迟显著增加。</li>
<li><strong>工具调用稳定性</strong>：Agent 对外部工具的调用必须高度稳定和可靠，否则一次失败的行动可能导致整个流程崩溃。</li>
<li><strong>可解释性</strong>：Agent 的决策过程虽然有 ReAct 的推理记录，但其复杂性使得最终的可解释性仍然是一个难题。</li>
</ol>
<h2 data-id="heading-11"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>四、 RAG 系统的未来趋势：多模态、实时化与可信 AI</h2>
<p>RAG 技术的演进仍在加速，未来的发展将聚焦于突破现有架构的边界，使其能够更好地适应真实世界的复杂性和动态性。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb3fd4dfb07c4b0a85c15529111a196f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770082202&amp;x-signature=tGn%2Ba6J0TRdkw7VxI0lfG4p2ixs%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-12"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>4.1、 多模态 RAG：重构语义空间</h3>
<p>当前 RAG 主要处理文本，但现实世界是多模态的。<strong>多模态 RAG</strong> 的目标是将文本、图像、音频、视频等不同模态的数据融入统一的 RAG 框架。这要求构建<strong>统一的多模态表示模型</strong>，将不同模态的信息映射到同一个语义空间中，实现跨模态的检索、理解和生成。例如，用户可以上传一张设备故障的图片和一段描述，系统能够从包含技术手册（文本）、维修视频（视频）的知识库中检索信息，并生成包含文本和图片标注的维修指南。</p>
<h3 data-id="heading-13"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>4.2、 实时 RAG 与增量索引：拥抱时效性</h3>
<p>在金融、新闻、实时监控等领域，信息的<strong>时效性</strong>至关重要。未来的 RAG 系统必须是<strong>实时 RAG</strong>，能够处理流式数据并进行<strong>增量索引更新</strong>。传统的 RAG 知识库是静态的，更新成本高昂。实时 RAG 需要采用先进的流处理技术和向量数据库的增量索引能力，确保 LLM 始终能够访问到最新、最准确的知识，从而避免生成过时或错误的信息。</p>
<h3 data-id="heading-14"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>4.3、 可信 RAG 与评估体系的深化</h3>
<p>随着 RAG 在关键领域的应用，<strong>可信 AI</strong> 成为核心要求。未来的 RAG 系统将更加注重：</p>
<ul>
<li><strong>可解释性</strong>：不仅提供答案，还要提供清晰的<strong>引用来源</strong>和 <strong>推理路径</strong>（尤其是 Agentic RAG 和 GraphRAG）。</li>
<li><strong>鲁棒性</strong>：能够抵御对抗性攻击和知识库中的恶意注入。</li>
<li><strong>评估体系深化</strong>：除了传统的召回率和准确率，<strong>RAGAS</strong> 等评估框架将更加普及，利用 LLM 自身的能力来量化答案的<strong>忠实度（Faithfulness）</strong>  和<strong>上下文相关性（Context Relevance）</strong> ，实现数据驱动的持续优化。</li>
</ul>
<p>RAG 的演进是一个从“能用”到“好用”，再到“智能”的螺旋式上升过程。它清晰地展示了 AI 系统如何通过架构创新，将 LLM 的生成能力与外部知识的可靠性完美结合，从而构建出更强大、更可靠的下一代智能应用。# 一、 RAG 范式演进：从知识搬运工到智能决策者</p>
<p>检索增强生成（RAG）技术的发展史，是一部不断挑战大型语言模型（LLM）局限性、追求系统级智能的演进史。RAG 的演变并非简单的功能叠加，而是对“如何高效、可靠地将外部知识融入 LLM 推理过程”这一核心问题的持续探索。我们可以将 RAG 的演进脉络划分为四个清晰的阶段：<strong>Naive RAG</strong> 确立基本范式，<strong>Advanced RAG</strong> 聚焦精细化优化，<strong>Modular RAG</strong> 追求架构灵活性，最终 <strong>Agentic RAG</strong> 实现自主决策与智能化。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9bedce0f0a654e428b8ecb635b348311~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770082202&amp;x-signature=tqepsfiZWmlxusOWQBzg3Uqez3w%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<hr/>
<p>在 RAG 的实践中，许多开发者在面对复杂场景时，常因缺乏对架构演进逻辑的深刻理解而陷入困境：如何将知识图谱（GraphRAG）融入向量检索？如何设计一个具备自我反思能力的 Agentic RAG 系统？如何平衡实时性与准确性？</p>
<p>为了帮你填补从懂原理到能落地的关键拼图，AI大学堂基于大量的业务实战经验，精心打磨课程，正式推出 <strong>RAG工程师认证</strong>。这份证书将是你系统化掌握 AI 落地核心能力的绝佳机会，认证现已开启，<strong>限时免费</strong>，点击文末<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aidaxue.com%2Fcourse%2F1190%3Fvideo_id%3D5212%26ch%3Dai_daxue_csdn" target="_blank" title="https://www.aidaxue.com/course/1190?video_id=5212&amp;ch=ai_daxue_csdn" ref="nofollow noopener noreferrer">🔗认证链接</a>开始学习！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a7106535e93464e844b2f990a0a1684~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770082202&amp;x-signature=x1wPbG23wvYKn%2FIPY%2B8OWc69TuY%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-15"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1.1、 Naive RAG：范式的确立与固有局限</h3>
<p><strong>Naive RAG</strong>（朴素 RAG）是 RAG 技术的起点，其核心思想是“索引-检索-生成”的线性流程。它解决了 LLM 在特定领域知识上的“无知”问题，通过将文档分块、向量化，并使用单一的向量相似度检索来召回上下文。<br/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a2b2014c1bda4bcebdf5b1c598dc9c5c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770082202&amp;x-signature=aonFfu81lLjaMXisi6yUgAgG5NA%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>然而，Naive RAG 的局限性是显而易见的，也是驱动后续演进的根本原因：</p>
<ol>
<li><strong>分块的语义破坏</strong>：固定大小的分块策略极易在语义边界处截断，导致单个块的语义信息不完整或被稀释，直接影响嵌入模型的编码质量。</li>
<li><strong>单一检索的盲区</strong>：仅依赖向量相似度检索，无法有效处理<strong>词汇不匹配</strong>（Lexical Gap）问题，对同义词、专业术语或需要精确关键词匹配的查询，召回率低下。</li>
<li><strong>缺乏查询优化</strong>：用户查询的模糊性、歧义性未被处理，直接影响了检索信号的质量。</li>
</ol>
<p>Naive RAG 就像一个被动的“知识搬运工”，它只能机械地执行预设的流程，缺乏对信息质量的判断和对查询意图的深度理解。</p>
<h3 data-id="heading-16"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1.2、 Advanced RAG：精细化优化与多阶段精炼</h3>
<p><strong>Advanced RAG</strong>（高级 RAG）是 RAG 走向工业级应用的关键一步，其核心在于在 Naive RAG 的基础上，引入了大量的<strong>预检索</strong>和<strong>后检索</strong>优化机制，将流程从线性转变为多阶段精炼。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d697c1603dd449f99c37bdf43cb80af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770082202&amp;x-signature=xfVYEvQT%2Fvw9BRIWmgb4IJcO2GM%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h4 data-id="heading-17"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1.2.1、 预检索优化：增强查询信号的艺术</h4>
<p>预检索优化的目标是生成更强大的检索信号，以克服用户查询的局限性：</p>
<ul>
<li><strong>查询重写与扩展</strong>：利用 LLM 将原始查询改写成更清晰、更具体的版本，或生成多个变体查询以增加检索覆盖面。</li>
<li><strong>假设性文档嵌入（HyDE）</strong> ：这是最具创新性的技术之一。它利用 LLM 的生成能力，根据查询生成一个“假设性答案”，然后用这个假设性答案的向量去检索真实文档。由于假设性答案包含了更丰富的语义和更接近文档的词汇，它能显著提高检索的准确性，尤其是在处理抽象概念时。</li>
<li><strong>多查询生成</strong>：利用 LLM 生成多个子查询，并行执行检索，然后合并结果，以应对复杂查询和多角度信息需求。</li>
</ul>
<h4 data-id="heading-18"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1.2.2、 检索与后处理优化：从召回到准确率的飞跃</h4>
<p>Advanced RAG 在检索和后处理环节的优化，是其性能飞跃的关键：</p>
<ul>
<li><strong>混合检索（Hybrid Retrieval）</strong> ：将基于关键词的稀疏检索（如 BM25）与基于语义的稠密检索（向量检索）进行融合。这种融合的数学逻辑在于，通过 <strong>RRF（Reciprocal Rank Fusion）</strong>  等算法，将两种不同相关性度量（词频-逆文档频率与向量余弦相似度）的结果进行加权排序，实现优势互补，最大化召回率和准确率。</li>
<li><strong>语义分块策略</strong>：取代固定分块，采用基于句子、段落或标题的语义分块，确保每个块的语义完整性。更进一步的策略是<strong>父文档检索</strong>，即用小块进行检索，但返回包含该小块的更大“父文档”作为 LLM 的上下文，以平衡检索精度和上下文丰富度。</li>
<li><strong>Cross-Encoder 重排序</strong>：这是提升准确率（Precision）的利器。与 Bi-Encoder 独立编码查询和文档不同，Cross-Encoder 将查询和文档<strong>拼接</strong>后一起输入模型，从而捕捉两者之间细粒度的交互信息。虽然计算成本高，但其对相关性的判断更为精确，通常用于对 Bi-Encoder 召回的 Top-K 结果进行二次精排。</li>
<li><strong>上下文压缩与验证</strong>：通过 LLMLingua 等技术对检索结果进行压缩，减少 LLM 的输入 Token 数量，降低成本并提升效率。同时，引入额外的 LLM 或规则引擎对最终答案进行<strong>事实一致性验证</strong>，以降低幻觉风险。</li>
</ul>
<h2 data-id="heading-19"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>二、 Modular RAG 与 GraphRAG：架构的灵活性与知识的结构化</h2>
<p>Advanced RAG 解决了性能问题，但随着应用场景的复杂化，系统对<strong>灵活性</strong>和<strong>可扩展性</strong>提出了更高的要求，由此催生了 <strong>Modular RAG</strong>（模块化 RAG）。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/09e91479cb1c436ea25577eeb796b9c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770082202&amp;x-signature=tR%2FT%2BiQvMvJ4cNodICx6V6bcIyM%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-20"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2.1、 Modular RAG：解耦与定制化的架构哲学</h3>
<p>Modular RAG 的核心思想是<strong>解耦</strong>：将 RAG 流程中的各个功能（如查询重写、检索、重排序、验证）抽象为可插拔的独立模块。这种架构哲学使得 RAG 系统不再是一个固定的流水线，而是一个可以根据任务需求动态组装的“乐高积木”。</p>
<p>这种架构的优势在于：</p>
<ol>
<li><strong>定制化工作流</strong>：可以根据不同的业务场景（如法律问答、代码生成、财务分析）定制不同的模块组合和执行路径。</li>
<li><strong>独立优化与迭代</strong>：每个模块可以独立进行技术选型和优化（例如，针对法律文档使用专门微调的嵌入模型，针对代码使用基于 AST 的分块器），互不影响。</li>
<li><strong>支持复杂逻辑</strong>：通过模块的<strong>条件组合</strong>（根据查询类型选择不同检索器）和<strong>循环组合</strong>（实现多跳检索），能够处理 Advanced RAG 难以应对的复杂逻辑。</li>
</ol>
<p>在 Modular RAG 的实践中，<strong>DSP（Differentiable Search Path，可微搜索路径）</strong>  等框架提供了理论基础，它将 RAG 流程视为一个可优化的计算图，允许通过端到端的方式对整个流程进行微调，从而实现系统级的性能提升。</p>
<h3 data-id="heading-21"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2.2、 GraphRAG：从语义相似到逻辑推理的飞跃</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db3cd9966c764addb0d8bb54d2703f8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770082202&amp;x-signature=bQEo6jAVZFJxiRnrXus7cADJhG4%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>在 Modular RAG 的范畴内，<strong>GraphRAG</strong>（基于知识图谱的 RAG）是解决复杂推理问题的关键技术。它解决了传统向量检索的根本缺陷：<strong>缺乏逻辑关联和因果推理能力</strong>。</p>
<p>GraphRAG 的工作原理是将知识库中的实体和关系构建成一个<strong>知识图谱（KG）</strong> 。检索过程不再仅仅是文本块的相似度匹配，而是：</p>
<ol>
<li><strong>实体与关系提取</strong>：利用 LLM 或 NLP 工具从查询和文档中提取关键实体和关系。</li>
<li><strong>图谱路径搜索</strong>：在 KG 中搜索连接查询实体和目标实体的路径。</li>
<li><strong>结构化上下文</strong>：将搜索到的图谱路径（即逻辑链条）作为结构化上下文提供给 LLM。</li>
</ol>
<p>这种方式使得 LLM 能够进行更复杂的<strong>多跳推理</strong>（Multi-hop Reasoning）。例如，要回答“A 公司的创始人 B 投资了哪些 C 领域的公司？”这样的问题，GraphRAG 可以沿着“A 公司 -&gt; 创始人 B -&gt; 投资关系 -&gt; C 领域公司”的路径进行精确搜索，并提供清晰的逻辑链条，极大地增强了答案的<strong>事实准确性</strong>和<strong>可解释性</strong>。GraphRAG 的引入，标志着 RAG 系统从“知识搬运工”正式进化为“逻辑推理者”。</p>
<h2 data-id="heading-22"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>三、 Agentic RAG：自主决策与自我反思的智能化巅峰</h2>
<p>RAG 技术的最新前沿是 <strong>Agentic RAG</strong>（智能体 RAG），它代表了 RAG 系统从被动执行到主动智能的最终形态。Agentic RAG 将 AI 智能体（Agent）技术与 RAG 深度融合，赋予系统<strong>自主决策、工具使用、任务规划和自我反思</strong>的能力。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8df5e0d13eb425faf76350c4a3f99d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770082202&amp;x-signature=3r9eT12efC8DQiXF7o76POfpGkg%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-23"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>3.1、 Agentic RAG 的核心机制：ReAct 与反思</h3>
<p>Agentic RAG 的核心在于其<strong>智能体框架</strong>，其中 <strong>ReAct（Reasoning and Acting）</strong>  框架是主流实现之一。ReAct 机制允许 LLM 在生成答案之前，进行<strong>推理（Reasoning）</strong>  和<strong>行动（Acting）</strong>  的交替循环：</p>
<ol>
<li><strong>推理（Reasoning）</strong> ：LLM 分析当前任务、已有的信息和下一步的目标，生成一个清晰的思考过程。</li>
<li><strong>行动（Acting）</strong> ：LLM 根据推理结果，决定调用哪个工具（如向量检索器、搜索引擎、代码解释器或 GraphRAG 模块），并执行相应的操作。</li>
</ol>
<p>这种机制使得 Agentic RAG 能够动态地规划复杂的任务。例如，在处理一个需要多步推理的法律查询时，Agent 会将问题分解为多个子任务，并动态选择工具：</p>
<ul>
<li><strong>步骤 1（推理）</strong> ：分析查询，判断需要检索法律条文和计算赔偿金。</li>
<li><strong>步骤 1（行动）</strong> ：调用 <strong>GraphRAG 模块</strong>检索最新的法律条文。</li>
<li><strong>步骤 2（推理）</strong> ：分析检索结果，确定计算公式，判断需要外部计算工具。</li>
<li><strong>步骤 2（行动）</strong> ：调用 <strong>代码解释器</strong>或 <strong>API 工具</strong>执行赔偿金计算。</li>
</ul>
<p>更高级的 Agentic RAG 引入了<strong>自我反思（Self-Reflection）</strong>  机制。在生成答案后，Agent 会利用另一个 LLM 或预设的评估指标（如 RAGAS 框架）对答案进行评估。如果评估结果不理想，Agent 会反思其推理过程和行动步骤，识别错误，并调整策略重新执行，形成一个完整的<strong>优化闭环</strong>。这种反思与优化能力，是 Agentic RAG 实现高度智能化和鲁棒性的重要保障。</p>
<h3 data-id="heading-24"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>3.2、 Agentic RAG 的应用与挑战</h3>
<p>Agentic RAG 的应用场景集中在对<strong>复杂性、准确性和智能化程度</strong>要求极高的领域：</p>
<ul>
<li><strong>智能法律助手</strong>：处理需要多跳推理、多工具协同（法律数据库、计算工具）的复杂法律查询。</li>
<li><strong>金融研究分析</strong>：自主规划数据检索、图表生成、趋势分析等一系列步骤，生成结构化的研究报告。</li>
<li><strong>复杂系统故障诊断</strong>：Agent 根据故障描述，自主调用日志检索工具、代码库、知识图谱，逐步缩小故障范围并提出解决方案。</li>
</ul>
<p>然而，Agentic RAG 也面临巨大的挑战：</p>
<ol>
<li><strong>成本与延迟</strong>：每一次推理和行动都需要 LLM 调用，导致成本和延迟显著增加。</li>
<li><strong>工具调用稳定性</strong>：Agent 对外部工具的调用必须高度稳定和可靠，否则一次失败的行动可能导致整个流程崩溃。</li>
<li><strong>可解释性</strong>：Agent 的决策过程虽然有 ReAct 的推理记录，但其复杂性使得最终的可解释性仍然是一个难题。</li>
</ol>
<h2 data-id="heading-25"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>四、 RAG 系统的未来趋势：多模态、实时化与可信 AI</h2>
<p>RAG 技术的演进仍在加速，未来的发展将聚焦于突破现有架构的边界，使其能够更好地适应真实世界的复杂性和动态性。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e6c4675d7954c53b304e20b524bab1c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770082202&amp;x-signature=MyFEv7ejjq85lEAjSOblHWh0UhM%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-26"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>4.1、 多模态 RAG：重构语义空间</h3>
<p>当前 RAG 主要处理文本，但现实世界是多模态的。<strong>多模态 RAG</strong> 的目标是将文本、图像、音频、视频等不同模态的数据融入统一的 RAG 框架。这要求构建<strong>统一的多模态表示模型</strong>，将不同模态的信息映射到同一个语义空间中，实现跨模态的检索、理解和生成。例如，用户可以上传一张设备故障的图片和一段描述，系统能够从包含技术手册（文本）、维修视频（视频）的知识库中检索信息，并生成包含文本和图片标注的维修指南。</p>
<h3 data-id="heading-27"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>4.2、 实时 RAG 与增量索引：拥抱时效性</h3>
<p>在金融、新闻、实时监控等领域，信息的<strong>时效性</strong>至关重要。未来的 RAG 系统必须是<strong>实时 RAG</strong>，能够处理流式数据并进行<strong>增量索引更新</strong>。传统的 RAG 知识库是静态的，更新成本高昂。实时 RAG 需要采用先进的流处理技术和向量数据库的增量索引能力，确保 LLM 始终能够访问到最新、最准确的知识，从而避免生成过时或错误的信息。</p>
<h3 data-id="heading-28"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>4.3、 可信 RAG 与评估体系的深化</h3>
<p>随着 RAG 在关键领域的应用，<strong>可信 AI</strong> 成为核心要求。未来的 RAG 系统将更加注重：</p>
<ul>
<li><strong>可解释性</strong>：不仅提供答案，还要提供清晰的<strong>引用来源</strong>和 <strong>推理路径</strong>（尤其是 Agentic RAG 和 GraphRAG）。</li>
<li><strong>鲁棒性</strong>：能够抵御对抗性攻击和知识库中的恶意注入。</li>
<li><strong>评估体系深化</strong>：除了传统的召回率和准确率，<strong>RAGAS</strong> 等评估框架将更加普及，利用 LLM 自身的能力来量化答案的<strong>忠实度（Faithfulness）</strong>  和<strong>上下文相关性（Context Relevance）</strong> ，实现数据驱动的持续优化。</li>
</ul>
<p>RAG 的演进是一个从“能用”到“好用”，再到“智能”的螺旋式上升过程。它清晰地展示了 AI 系统如何通过架构创新，将 LLM 的生成能力与外部知识的可靠性完美结合，从而构建出更强大、更可靠的下一代智能应用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangChain 文档转换器与文本分割器组件学习总结]]></title>    <link>https://juejin.cn/post/7599551824548495386</link>    <guid>https://juejin.cn/post/7599551824548495386</guid>    <pubDate>2026-01-27T02:01:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599551824548495386" data-draft-id="7599581204860223514" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LangChain 文档转换器与文本分割器组件学习总结"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-27T02:01:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="心在飞扬AI"/> <meta itemprop="url" content="https://juejin.cn/user/1556564194366823"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LangChain 文档转换器与文本分割器组件学习总结
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1556564194366823/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    心在飞扬AI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T02:01:58.000Z" title="Tue Jan 27 2026 02:01:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">LangChain 文档转换器与文本分割器组件学习总结</h2>
<h3 data-id="heading-1">目录</h3>
<ol>
<li><a href="#1-%E5%AD%97%E7%AC%A6%E6%96%87%E6%9C%AC%E5%88%86%E5%89%B2%E5%99%A8" title="#1-%E5%AD%97%E7%AC%A6%E6%96%87%E6%9C%AC%E5%88%86%E5%89%B2%E5%99%A8">字符文本分割器</a></li>
<li><a href="#2-%E9%80%92%E5%BD%92%E5%AD%97%E7%AC%A6%E6%96%87%E6%9C%AC%E5%88%86%E5%89%B2%E5%99%A8" title="#2-%E9%80%92%E5%BD%92%E5%AD%97%E7%AC%A6%E6%96%87%E6%9C%AC%E5%88%86%E5%89%B2%E5%99%A8">递归字符文本分割器</a></li>
<li><a href="#3-%E7%A8%8B%E5%BA%8F%E4%BB%A3%E7%A0%81%E9%80%92%E5%BD%92%E5%88%86%E5%89%B2%E5%99%A8" title="#3-%E7%A8%8B%E5%BA%8F%E4%BB%A3%E7%A0%81%E9%80%92%E5%BD%92%E5%88%86%E5%89%B2%E5%99%A8">程序代码递归分割器</a></li>
<li><a href="#4-%E8%AF%AD%E4%B9%89%E5%88%86%E5%89%B2%E5%99%A8" title="#4-%E8%AF%AD%E4%B9%89%E5%88%86%E5%89%B2%E5%99%A8">语义分割器</a></li>
<li><a href="#5-html%E6%A0%87%E9%A2%98%E5%88%86%E5%89%B2%E5%99%A8" title="#5-html%E6%A0%87%E9%A2%98%E5%88%86%E5%89%B2%E5%99%A8">HTML标题分割器</a></li>
<li><a href="#6-json%E5%88%86%E5%89%B2%E5%99%A8" title="#6-json%E5%88%86%E5%89%B2%E5%99%A8">JSON分割器</a></li>
<li><a href="#7-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%88%86%E5%89%B2%E5%99%A8" title="#7-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%88%86%E5%89%B2%E5%99%A8">自定义分割器</a></li>
<li><a href="#8-%E4%B8%AD%E8%8B%B1%E6%96%87%E6%B7%B7%E5%90%88%E6%96%87%E6%9C%AC%E5%88%86%E5%89%B2" title="#8-%E4%B8%AD%E8%8B%B1%E6%96%87%E6%B7%B7%E5%90%88%E6%96%87%E6%9C%AC%E5%88%86%E5%89%B2">中英文混合文本分割</a></li>
<li><a href="#-%E5%88%86%E5%89%B2%E5%99%A8%E9%80%89%E6%8B%A9%E6%8C%87%E5%8D%97" title="#-%E5%88%86%E5%89%B2%E5%99%A8%E9%80%89%E6%8B%A9%E6%8C%87%E5%8D%97">分割器选择指南</a></li>
<li><a href="#-%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5" title="#-%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5">核心概念</a></li>
</ol>
<hr/>
<h3 data-id="heading-2">1. 字符文本分割器</h3>
<h4 data-id="heading-3">是什么</h4>
<p>最基础的文本分割器，按照指定的分隔符将文本分割成块</p>
<h4 data-id="heading-4">有什么用</h4>
<ul>
<li>简单的文本分割场景</li>
<li>按固定分隔符（如换行符）切分文档</li>
</ul>
<h4 data-id="heading-5">核心类</h4>
<ul>
<li><code>CharacterTextSplitter</code> (from <code>langchain_text_splitters</code>)</li>
</ul>
<h4 data-id="heading-6">核心参数</h4>
<pre><code class="hljs language-python" lang="python">CharacterTextSplitter(
    separator=<span class="hljs-string">"\n\n"</span>,          <span class="hljs-comment"># 分隔符</span>
    chunk_size=<span class="hljs-number">500</span>,            <span class="hljs-comment"># 每块大小</span>
    chunk_overlap=<span class="hljs-number">50</span>,          <span class="hljs-comment"># 块之间重叠大小</span>
    add_start_index=<span class="hljs-literal">True</span>       <span class="hljs-comment"># 添加起始索引</span>
)
</code></pre>
<h4 data-id="heading-7">示例代码</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_text_splitters <span class="hljs-keyword">import</span> CharacterTextSplitter
<span class="hljs-keyword">from</span> langchain_community.document_loaders <span class="hljs-keyword">import</span> UnstructuredMarkdownLoader

loader = UnstructuredMarkdownLoader(file_path)
documents = loader.load()

text_splitter = CharacterTextSplitter(
    separator=<span class="hljs-string">"\n\n"</span>,
    chunk_size=<span class="hljs-number">500</span>,
    chunk_overlap=<span class="hljs-number">50</span>,
    add_start_index=<span class="hljs-literal">True</span>,
)

chunks = text_splitter.split_documents(documents)

<span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> chunks:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"块大小:<span class="hljs-subst">{<span class="hljs-built_in">len</span>(chunk.page_content)}</span>, 元数据:<span class="hljs-subst">{chunk.metadata}</span>"</span>)
</code></pre>
<hr/>
<h3 data-id="heading-8">2. 递归字符文本分割器（推荐）</h3>
<h4 data-id="heading-9">是什么</h4>
<p>更智能的分割器，会按多个分隔符顺序尝试分割，直到满足块大小要求</p>
<h4 data-id="heading-10">有什么用</h4>
<ul>
<li>适用于大多数通用文本分割场景</li>
<li>能够保持段落的完整性，不会在句子中间切分</li>
<li>默认分隔符顺序：<code>["\n\n", "\n", " ", ""]</code></li>
</ul>
<h4 data-id="heading-11">核心类</h4>
<ul>
<li><code>RecursiveCharacterTextSplitter</code> (from <code>langchain_text_splitters</code>)</li>
</ul>
<h4 data-id="heading-12">核心参数</h4>
<pre><code class="hljs language-python" lang="python">RecursiveCharacterTextSplitter(
    chunk_size=<span class="hljs-number">500</span>,             <span class="hljs-comment"># 每块大小</span>
    chunk_overlap=<span class="hljs-number">50</span>,           <span class="hljs-comment"># 块之间重叠大小</span>
    add_start_index=<span class="hljs-literal">True</span>,       <span class="hljs-comment"># 添加起始索引</span>
    separators=[<span class="hljs-string">"\n\n"</span>, <span class="hljs-string">"\n"</span>, <span class="hljs-string">" "</span>, <span class="hljs-string">""</span>]  <span class="hljs-comment"># 可自定义分隔符列表</span>
)
</code></pre>
<h4 data-id="heading-13">示例代码</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_text_splitters <span class="hljs-keyword">import</span> RecursiveCharacterTextSplitter

text_splitter = RecursiveCharacterTextSplitter(
    chunk_size=<span class="hljs-number">500</span>,
    chunk_overlap=<span class="hljs-number">50</span>,
    add_start_index=<span class="hljs-literal">True</span>,
)

chunks = text_splitter.split_documents(documents)

<span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> chunks:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"块大小: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(chunk.page_content)}</span>, 元数据: <span class="hljs-subst">{chunk.metadata}</span>"</span>)
</code></pre>
<hr/>
<h3 data-id="heading-14">3. 程序代码递归分割器</h3>
<h4 data-id="heading-15">是什么</h4>
<p>专门用于编程代码的分割器，针对不同编程语言优化</p>
<h4 data-id="heading-16">有什么用</h4>
<ul>
<li>保留代码的完整性和语义</li>
<li>按函数、类等代码结构切分</li>
<li>避免在代码逻辑中间切分</li>
</ul>
<h4 data-id="heading-17">核心类</h4>
<ul>
<li><code>RecursiveCharacterTextSplitter.from_language()</code></li>
<li><code>Language</code> 枚举类</li>
</ul>
<h4 data-id="heading-18">支持的语言</h4>
<p>Python, JS, TypeScript, Java, C++, C, Go, PHP, Ruby, Rust, Swift, Markdown, LaTeX, HTML 等</p>
<h4 data-id="heading-19">示例代码</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_text_splitters <span class="hljs-keyword">import</span> RecursiveCharacterTextSplitter, Language

text_splitter = RecursiveCharacterTextSplitter.from_language(
    language=Language.PYTHON,
    chunk_size=<span class="hljs-number">500</span>,
    chunk_overlap=<span class="hljs-number">50</span>,
    add_start_index=<span class="hljs-literal">True</span>,
)

chunks = text_splitter.split_documents(documents)

<span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> chunks:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"块大小: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(chunk.page_content)}</span>, 元数据: <span class="hljs-subst">{chunk.metadata}</span>"</span>)

<span class="hljs-built_in">print</span>(chunks[<span class="hljs-number">2</span>].page_content)  <span class="hljs-comment"># 查看具体的代码块</span>
</code></pre>
<hr/>
<h3 data-id="heading-20">4. 语义分割器</h3>
<h4 data-id="heading-21">是什么</h4>
<p>基于语义相似度的分割器，使用embedding模型计算文本语义边界</p>
<h4 data-id="heading-22">有什么用</h4>
<ul>
<li>按语义相关性分割，保持语义连贯性</li>
<li>适合需要理解文本含义的场景</li>
<li>能够识别话题变化点</li>
</ul>
<h4 data-id="heading-23">核心类</h4>
<ul>
<li><code>SemanticChunker</code> (from <code>langchain_experimental.text_splitter</code>)</li>
</ul>
<h4 data-id="heading-24">核心参数</h4>
<pre><code class="hljs language-python" lang="python">SemanticChunker(
    embeddings=QianfanEmbeddingsEndpoint(),  <span class="hljs-comment"># 嵌入模型</span>
    number_of_chunks=<span class="hljs-number">10</span>,                      <span class="hljs-comment"># 分割块数</span>
    add_start_index=<span class="hljs-literal">True</span>,
    sentence_split_regex=<span class="hljs-string">r"(?&lt;=[。？！.?!])"</span>  <span class="hljs-comment"># 句子分割正则</span>
)
</code></pre>
<h4 data-id="heading-25">示例代码</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_experimental.text_splitter <span class="hljs-keyword">import</span> SemanticChunker
<span class="hljs-keyword">from</span> langchain_community.embeddings.baidu_qianfan_endpoint <span class="hljs-keyword">import</span> QianfanEmbeddingsEndpoint
<span class="hljs-keyword">import</span> dotenv

dotenv.load_dotenv()

text_splitter = SemanticChunker(
    embeddings=QianfanEmbeddingsEndpoint(),
    number_of_chunks=<span class="hljs-number">10</span>,
    add_start_index=<span class="hljs-literal">True</span>,
    sentence_split_regex=<span class="hljs-string">r"(?&lt;=[。？！.?!])"</span>
)

documents = loader.load()
chunks = text_splitter.split_documents(documents)

<span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> chunks:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"块大小: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(chunk.page_content)}</span>, 元数据: <span class="hljs-subst">{chunk.metadata}</span>"</span>)

<span class="hljs-built_in">print</span>(chunks[<span class="hljs-number">0</span>].page_content)
</code></pre>
<hr/>
<h3 data-id="heading-26">5. HTML标题分割器</h3>
<h4 data-id="heading-27">是什么</h4>
<p>专门用于HTML文档的分割器，按照HTML标题层级切分</p>
<h4 data-id="heading-28">有什么用</h4>
<ul>
<li>保留HTML文档的结构层次</li>
<li>适合处理网页、博客文章等HTML内容</li>
<li>自动保留标题元数据</li>
</ul>
<h4 data-id="heading-29">核心类</h4>
<ul>
<li><code>HTMLHeaderTextSplitter</code> (from <code>langchain_text_splitters</code>)</li>
</ul>
<h4 data-id="heading-30">核心参数</h4>
<pre><code class="hljs language-python" lang="python">headers_to_split_on = [
    (<span class="hljs-string">"h1"</span>, <span class="hljs-string">"一级标题"</span>),
    (<span class="hljs-string">"h2"</span>, <span class="hljs-string">"二级标题"</span>),
    (<span class="hljs-string">"h3"</span>, <span class="hljs-string">"三级标题"</span>),
]
</code></pre>
<h4 data-id="heading-31">示例代码</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_text_splitters <span class="hljs-keyword">import</span> HTMLHeaderTextSplitter

html_string = <span class="hljs-string">"""
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;body&gt;
    &lt;div&gt;
        &lt;h1&gt;标题1&lt;/h1&gt;
        &lt;p&gt;关于标题1的一些介绍文本。&lt;/p&gt;
        &lt;div&gt;
            &lt;h2&gt;子标题1&lt;/h2&gt;
            &lt;p&gt;关于子标题1的一些介绍文本。&lt;/p&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
"""</span>

headers_to_split_on = [
    (<span class="hljs-string">"h1"</span>, <span class="hljs-string">"一级标题"</span>),
    (<span class="hljs-string">"h2"</span>, <span class="hljs-string">"二级标题"</span>),
    (<span class="hljs-string">"h3"</span>, <span class="hljs-string">"三级标题"</span>),
]

text_splitter = HTMLHeaderTextSplitter(headers_to_split_on)
chunks = text_splitter.split_text(html_string)

<span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> chunks:
    <span class="hljs-built_in">print</span>(chunk)
</code></pre>
<hr/>
<h3 data-id="heading-32">6. JSON分割器</h3>
<h4 data-id="heading-33">是什么</h4>
<p>递归分割JSON数据的分割器，可以处理嵌套的JSON结构</p>
<h4 data-id="heading-34">有什么用</h4>
<ul>
<li>处理大型JSON文件或API响应</li>
<li>保留JSON的层次结构</li>
<li>避免破坏JSON数据的完整性</li>
</ul>
<h4 data-id="heading-35">核心类</h4>
<ul>
<li><code>RecursiveJsonSplitter</code> (from <code>langchain_text_splitters</code>)</li>
</ul>
<h4 data-id="heading-36">核心参数</h4>
<pre><code class="hljs language-python" lang="python">RecursiveJsonSplitter(max_chunk_size=<span class="hljs-number">300</span>)  <span class="hljs-comment"># 最大块大小</span>
</code></pre>
<h4 data-id="heading-37">示例代码</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_text_splitters <span class="hljs-keyword">import</span> RecursiveJsonSplitter
<span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> json

<span class="hljs-comment"># 获取JSON数据</span>
url = <span class="hljs-string">"https://api.smith.langchain.com/openapi.json"</span>
json_data = requests.get(url).json()
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"原始JSON大小: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(json.dumps(json_data))}</span>"</span>)

<span class="hljs-comment"># 创建分割器</span>
text_splitter = RecursiveJsonSplitter(max_chunk_size=<span class="hljs-number">300</span>)

<span class="hljs-comment"># 分割JSON数据</span>
json_chunks = text_splitter.split_json(json_data)
chunks = text_splitter.create_documents(json_chunks)

<span class="hljs-comment"># 输出结果</span>
total_size = <span class="hljs-built_in">sum</span>(<span class="hljs-built_in">len</span>(chunk.page_content) <span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> chunks)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"分割后总大小: <span class="hljs-subst">{total_size}</span>"</span>)
</code></pre>
<hr/>
<h3 data-id="heading-38">7. 自定义分割器</h3>
<h4 data-id="heading-39">是什么</h4>
<p>继承<code>TextSplitter</code>基类，实现自定义的分割逻辑</p>
<h4 data-id="heading-40">有什么用</h4>
<ul>
<li>特殊需求场景</li>
<li>结合jieba等工具实现中文关键词提取等定制功能</li>
<li>实现特定业务逻辑的文本处理</li>
</ul>
<h4 data-id="heading-41">核心类</h4>
<ul>
<li><code>TextSplitter</code> (基类)</li>
</ul>
<h4 data-id="heading-42">关键方法</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">split_text</span>(<span class="hljs-params">self, text: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]:
    <span class="hljs-comment"># 必须实现此方法</span>
    <span class="hljs-keyword">pass</span>
</code></pre>
<h4 data-id="heading-43">示例代码</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>
<span class="hljs-keyword">from</span> langchain_text_splitters <span class="hljs-keyword">import</span> TextSplitter
<span class="hljs-keyword">import</span> jieba.analyse

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomTextSplitter</span>(<span class="hljs-title class_ inherited__">TextSplitter</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, separator: <span class="hljs-built_in">str</span> = <span class="hljs-string">"\n\n"</span>, top_k: <span class="hljs-built_in">int</span> = <span class="hljs-number">10</span>, **kwargs</span>):
        <span class="hljs-built_in">super</span>().__init__(**kwargs)
        self.separator = separator
        self.top_k = top_k

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">split_text</span>(<span class="hljs-params">self, text: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]:
        <span class="hljs-comment"># 按分隔符切分</span>
        split_texts = text.split(self.separator)
        text_keywords = []

        <span class="hljs-comment"># 对每段提取关键词</span>
        <span class="hljs-keyword">for</span> split_text <span class="hljs-keyword">in</span> split_texts:
            keywords = jieba.analyse.extract_tags(split_text, topK=self.top_k)
            text_keywords.append(keywords)

        <span class="hljs-comment"># 返回关键词字符串</span>
        <span class="hljs-keyword">return</span> [<span class="hljs-string">' '</span>.join(keywords) <span class="hljs-keyword">for</span> keywords <span class="hljs-keyword">in</span> text_keywords]

<span class="hljs-comment"># 使用自定义分割器</span>
loader = UnstructuredFileLoader(file_path)
text_splitter = CustomTextSplitter(<span class="hljs-string">"\n\n"</span>, <span class="hljs-number">10</span>)

documents = loader.load()
chunks = text_splitter.split_documents(documents)

<span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> chunks:
    <span class="hljs-built_in">print</span>(chunk.page_content)
</code></pre>
<hr/>
<h3 data-id="heading-44">8. 中英文混合文本分割</h3>
<h4 data-id="heading-45">是什么</h4>
<p>配置多个分隔符来处理中英文混合场景</p>
<h4 data-id="heading-46">有什么用</h4>
<ul>
<li>处理中英文混合文档</li>
<li>适配不同语言的标点符号</li>
<li>保证分割后的文本块语义完整</li>
</ul>
<h4 data-id="heading-47">分隔符配置示例</h4>
<pre><code class="hljs language-python" lang="python">separators = [
    <span class="hljs-string">"\n\n"</span>,                <span class="hljs-comment"># 段落分隔</span>
    <span class="hljs-string">"\n"</span>,                  <span class="hljs-comment"># 行分隔</span>
    <span class="hljs-string">"。|！|？"</span>,            <span class="hljs-comment"># 中文句号</span>
    <span class="hljs-string">"\.\s|\!\s|\?\s"</span>,      <span class="hljs-comment"># 英文标点+空格</span>
    <span class="hljs-string">"；|;\s"</span>,              <span class="hljs-comment"># 分号</span>
    <span class="hljs-string">"，|,\s"</span>,              <span class="hljs-comment"># 逗号</span>
    <span class="hljs-string">" "</span>,                   <span class="hljs-comment"># 空格</span>
    <span class="hljs-string">""</span>                     <span class="hljs-comment"># 字符级别（最后手段）</span>
]
</code></pre>
<h4 data-id="heading-48">示例代码</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_text_splitters <span class="hljs-keyword">import</span> RecursiveCharacterTextSplitter

separators = [
    <span class="hljs-string">"\n\n"</span>,
    <span class="hljs-string">"\n"</span>,
    <span class="hljs-string">"。|！|？"</span>,
    <span class="hljs-string">"\.\s|\!\s|\?\s"</span>,  <span class="hljs-comment"># 英文标点符号后面通常需要加空格</span>
    <span class="hljs-string">"；|;\s"</span>,
    <span class="hljs-string">"，|,\s"</span>,
    <span class="hljs-string">" "</span>,
    <span class="hljs-string">""</span>
]

text_splitter = RecursiveCharacterTextSplitter(
    separators=separators,
    is_separator_regex=<span class="hljs-literal">True</span>,  <span class="hljs-comment"># 启用正则表达式</span>
    chunk_size=<span class="hljs-number">500</span>,
    chunk_overlap=<span class="hljs-number">50</span>,
    add_start_index=<span class="hljs-literal">True</span>,
)

documents = loader.load()
chunks = text_splitter.split_documents(documents)

<span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> chunks:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"块大小: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(chunk.page_content)}</span>, 元数据: <span class="hljs-subst">{chunk.metadata}</span>"</span>)
</code></pre>
<hr/>
<h3 data-id="heading-49">分割器选择指南</h3>


















































<table><thead><tr><th>场景</th><th>推荐分割器</th><th>说明</th></tr></thead><tbody><tr><td>通用文本</td><td><code>RecursiveCharacterTextSplitter</code></td><td>最常用的选择，智能分割</td></tr><tr><td>代码文件</td><td><code>RecursiveCharacterTextSplitter.from_language()</code></td><td>保留代码结构</td></tr><tr><td>语义分割</td><td><code>SemanticChunker</code></td><td>基于语义相似度，需要embedding模型</td></tr><tr><td>HTML文档</td><td><code>HTMLHeaderTextSplitter</code></td><td>按标题层级分割</td></tr><tr><td>JSON数据</td><td><code>RecursiveJsonSplitter</code></td><td>处理嵌套JSON</td></tr><tr><td>简单分割</td><td><code>CharacterTextSplitter</code></td><td>基础固定分隔符</td></tr><tr><td>特殊需求</td><td>自定义 <code>TextSplitter</code></td><td>实现特定逻辑</td></tr><tr><td>中英文混合</td><td><code>RecursiveCharacterTextSplitter</code> + 自定义separators</td><td>配合正则表达式</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-50">核心概念</h3>
<h4 data-id="heading-51">通用参数说明</h4>








































<table><thead><tr><th>参数</th><th>说明</th><th>推荐值</th></tr></thead><tbody><tr><td><code>chunk_size</code></td><td>每个文本块的目标字符数</td><td>500-1000</td></tr><tr><td><code>chunk_overlap</code></td><td>相邻块之间的重叠字符数</td><td>50-200</td></tr><tr><td><code>separator</code></td><td>用于分割的分隔符</td><td><code>"\n\n"</code>, <code>"\n"</code> 等</td></tr><tr><td><code>separators</code></td><td>分隔符列表（按优先级）</td><td>见上方配置</td></tr><tr><td><code>add_start_index</code></td><td>是否在元数据中记录起始位置</td><td><code>True</code></td></tr><tr><td><code>is_separator_regex</code></td><td>是否将分隔符作为正则表达式</td><td><code>True</code>/<code>False</code></td></tr></tbody></table>
<h4 data-id="heading-52">chunk_overlap 的作用</h4>
<ul>
<li><strong>保持上下文连贯</strong>：避免关键信息被分割到两个块的边界</li>
<li><strong>提高检索质量</strong>：重叠部分可以作为检索的冗余信息</li>
<li><strong>推荐设置</strong>：一般为 <code>chunk_size</code> 的 10%-20%</li>
</ul>
<h4 data-id="heading-53">chunk_size 的选择</h4>
<ul>
<li><strong>太小</strong>：上下文不足，语义不完整</li>
<li><strong>太大</strong>：超出模型上下文窗口，检索精度下降</li>
<li><strong>推荐</strong>：
<ul>
<li>短文本：200-500</li>
<li>中等文本：500-1000</li>
<li>长文本：1000-2000</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-54">最佳实践</h3>
<h4 data-id="heading-55">1. 优先使用递归分割器</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 推荐</span>
RecursiveCharacterTextSplitter(chunk_size=<span class="hljs-number">500</span>, chunk_overlap=<span class="hljs-number">50</span>)

<span class="hljs-comment"># 不推荐（容易在句子中间切分）</span>
CharacterTextSplitter(separator=<span class="hljs-string">"\n"</span>, chunk_size=<span class="hljs-number">500</span>)
</code></pre>
<h4 data-id="heading-56">2. 根据文档类型选择</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 代码文档</span>
RecursiveCharacterTextSplitter.from_language(
    language=Language.PYTHON,
    chunk_size=<span class="hljs-number">1000</span>
)

<span class="hljs-comment"># HTML文档</span>
HTMLHeaderTextSplitter(headers_to_split_on)

<span class="hljs-comment"># API响应</span>
RecursiveJsonSplitter(max_chunk_size=<span class="hljs-number">300</span>)
</code></pre>
<h4 data-id="heading-57">3. 中英文场景处理</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 使用正则表达式分隔符</span>
separators = [
    <span class="hljs-string">"\n\n"</span>,
    <span class="hljs-string">"\n"</span>,
    <span class="hljs-string">"。|！|？"</span>,
    <span class="hljs-string">"\.\s|\!\s|\?\s"</span>,
]
text_splitter = RecursiveCharacterTextSplitter(
    separators=separators,
    is_separator_regex=<span class="hljs-literal">True</span>
)
</code></pre>
<h4 data-id="heading-58">4. 保留元数据</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 始终添加起始索引</span>
text_splitter = RecursiveCharacterTextSplitter(
    add_start_index=<span class="hljs-literal">True</span>  <span class="hljs-comment"># 便于追溯原文位置</span>
)
</code></pre>
<hr/>
<h3 data-id="heading-59">相关资源</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fpython.langchain.com%2Fdocs%2Fmodules%2Fdata_connection%2Fdocument_transformers%2F" target="_blank" title="https://python.langchain.com/docs/modules/data_connection/document_transformers/" ref="nofollow noopener noreferrer">LangChain Text Splitters 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=..%2F25%2520langchain%2520%25E5%2586%2585%25E7%25BD%25AE%25E7%25BB%2584%25E4%25BB%25B6%25E5%2592%258C%25E6%2596%2587%25E6%25A1%25A3%25E5%258A%25A0%25E8%25BD%25BD%25E5%2599%25A8%2F%25E5%25AD%25A6%25E4%25B9%25A0%25E6%2580%25BB%25E7%25BB%2593.md" target="_blank" title="../25%20langchain%20%E5%86%85%E7%BD%AE%E7%BB%84%E4%BB%B6%E5%92%8C%E6%96%87%E6%A1%A3%E5%8A%A0%E8%BD%BD%E5%99%A8/%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93.md" ref="nofollow noopener noreferrer">Document Loader 学习总结</a></li>
<li><a href="https://link.juejin.cn?target=..%2F27%2520Blob%25E4%25B8%258EBlobParser%25E4%25BA%2592%25E6%2596%2587%25E6%259C%25AC%2F%25E5%25AD%25A6%25E4%25B9%25A0%25E6%2580%25BB%25E7%25BB%2593.md" target="_blank" title="../27%20Blob%E4%B8%8EBlobParser%E4%BA%92%E6%96%87%E6%9C%AC/%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93.md" ref="nofollow noopener noreferrer">Blob 与 BlobParser 学习总结</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[升级版js实现图片拖拽、根据鼠标位置放大、缩小功能]]></title>    <link>https://juejin.cn/post/7599579865608011818</link>    <guid>https://juejin.cn/post/7599579865608011818</guid>    <pubDate>2026-01-27T02:58:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599579865608011818" data-draft-id="7599585289947250751" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="升级版js实现图片拖拽、根据鼠标位置放大、缩小功能"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-27T02:58:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户1567703855869"/> <meta itemprop="url" content="https://juejin.cn/user/2313815481135598"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            升级版js实现图片拖拽、根据鼠标位置放大、缩小功能
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2313815481135598/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户1567703855869
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T02:58:33.000Z" title="Tue Jan 27 2026 02:58:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">canvasImage</span> = function (path, annotations) {
    let <span class="hljs-attr">imageUrl</span> = <span class="hljs-string">''</span><span class="hljs-comment">;</span>
    <span class="hljs-attr">imageUrl</span> = path<span class="hljs-comment">;</span>
    let <span class="hljs-attr">initState</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
    let <span class="hljs-attr">scale</span> = <span class="hljs-number">1</span><span class="hljs-comment">; let originX = 0; let originY = 0; let isDragging = false; let lastX; let lastY;</span>
    const <span class="hljs-attr">canvas</span> = document.getElementById(<span class="hljs-string">'annotationCanvas'</span>)<span class="hljs-comment">;</span>

    // 清空画布内容和标注信息
    <span class="hljs-attr">canvas.innerHTML</span> = <span class="hljs-string">''</span><span class="hljs-comment">;</span>

    <span class="hljs-attr">canvas.style.display</span> = <span class="hljs-string">'block'</span><span class="hljs-comment">;</span>
    const <span class="hljs-attr">ctx</span> = canvas.getContext(<span class="hljs-string">'2d'</span>)<span class="hljs-comment">;</span>
    const <span class="hljs-attr">image</span> = new Image()<span class="hljs-comment">;</span>
    function resizeCanvas() {
      <span class="hljs-attr">canvas.width</span> = window.innerWidth<span class="hljs-comment">;</span>
      <span class="hljs-attr">canvas.height</span> = window.innerHeight<span class="hljs-comment">;</span>
      draw()<span class="hljs-comment">;</span>
    }
    // 添加关闭按钮
    const <span class="hljs-attr">closeButton</span> = document.createElement(<span class="hljs-string">'button'</span>)<span class="hljs-comment">;</span>
    <span class="hljs-attr">closeButton.innerHTML</span> = <span class="hljs-string">'X'</span><span class="hljs-comment">;</span>
    <span class="hljs-attr">closeButton.title</span> = <span class="hljs-string">'关闭预览'</span><span class="hljs-comment">;</span>
    <span class="hljs-attr">closeButton.className</span> = <span class="hljs-string">'canvasCloseButton'</span><span class="hljs-comment">;</span>
    document.body.appendChild(closeButton)<span class="hljs-comment">;</span>

    closeButton.addEventListener('click', function () {
      <span class="hljs-attr">imageUrl</span> = <span class="hljs-string">''</span><span class="hljs-comment">;</span>
      <span class="hljs-attr">canvas.style.display</span> = <span class="hljs-string">'none'</span><span class="hljs-comment">;</span>
      document.body.removeChild(closeButton)<span class="hljs-comment">;</span>
    })<span class="hljs-comment">;</span>
    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height)<span class="hljs-comment">;</span>
      ctx.save()<span class="hljs-comment">;</span>
      ctx.translate(originX, originY)<span class="hljs-comment">;</span>
      ctx.scale(scale, scale)<span class="hljs-comment">;</span>

      if (annotations.length) {
        ctx.drawImage(image, 0, 0)<span class="hljs-comment">;</span>
      } else {
        // 获取 canvas 的宽度和高度
        const <span class="hljs-attr">canvasWidth</span> = canvas.width<span class="hljs-comment">;</span>
        const <span class="hljs-attr">canvasHeight</span> = canvas.height<span class="hljs-comment">;</span>
        // 获取图片的宽度和高度
        const <span class="hljs-attr">imageWidth</span> = image.width<span class="hljs-comment">;</span>
        const <span class="hljs-attr">imageHeight</span> = image.height<span class="hljs-comment">;</span>
        // 计算图片在画布上的位置
        const <span class="hljs-attr">x</span> = (canvasWidth - imageWidth) / <span class="hljs-number">2</span><span class="hljs-comment">;</span>
        const <span class="hljs-attr">y</span> = (canvasHeight - imageHeight) / <span class="hljs-number">2</span><span class="hljs-comment">;</span>
        ctx.drawImage(image, x, y)<span class="hljs-comment">;</span>
        <span class="hljs-attr">initState</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
      }
      if (annotations.length) {
        annotations.forEach((item) =&gt; {
          if (item.range) {
            <span class="hljs-attr">ctx.lineWidth</span> = <span class="hljs-number">10</span><span class="hljs-comment">;</span>
            ctx.beginPath()<span class="hljs-comment">;</span>
            <span class="hljs-attr">ctx.strokeStyle</span> = <span class="hljs-string">'red'</span><span class="hljs-comment">;</span>
            ctx.strokeRect(
              item.range.x - 10,
              item.range.y - 10,
              item.range.width + 20,
              item.range.height + 20
            )<span class="hljs-comment">;</span>
          }
          <span class="hljs-attr">ctx.fillStyle</span> = <span class="hljs-string">'yellow'</span><span class="hljs-comment">;</span>
          <span class="hljs-attr">ctx.font</span> = <span class="hljs-string">'100px fangsong'</span><span class="hljs-comment">;</span>
          ctx.fillText(item.text, item.posX, item.posY - 50)<span class="hljs-comment">;</span>
          ctx.fill()<span class="hljs-comment">;</span>
          if (item.rect) {
            <span class="hljs-attr">ctx.lineWidth</span> = <span class="hljs-number">10</span><span class="hljs-comment">;</span>
            ctx.beginPath()<span class="hljs-comment">;</span>
            <span class="hljs-attr">ctx.strokeStyle</span> = <span class="hljs-string">'yellow'</span><span class="hljs-comment">;</span>
            ctx.strokeRect(
              item.rect.x - 5,
              item.rect.y - 5,
              item.rect.width + 10,
              item.rect.height + 10
            )<span class="hljs-comment">;</span>
          }
          if (initState) {
            <span class="hljs-attr">scale</span> = canvas.height / image.height<span class="hljs-comment">;</span>
            <span class="hljs-attr">originX</span> = (canvas.width - image.width * scale) / <span class="hljs-number">2</span><span class="hljs-comment">;</span>
            <span class="hljs-attr">initState</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
            draw()<span class="hljs-comment">;</span>
          }
        })<span class="hljs-comment">;</span>
        ctx.restore()<span class="hljs-comment">;</span>
      }
      ctx.restore()<span class="hljs-comment">;</span>
    }
    <span class="hljs-attr">image.src</span> = imageUrl<span class="hljs-comment">;</span>
    <span class="hljs-attr">image.onload</span> = resizeCanvas<span class="hljs-comment">;</span>
    window.addEventListener('resize', resizeCanvas)<span class="hljs-comment">;</span>
    <span class="hljs-section">['mousedown', 'mouseup', 'mouseout', 'mousemove', 'wheel']</span>.forEach(<span class="hljs-attr">eventName</span> =&gt; {
      canvas.addEventListener(eventName, (e) =&gt; {
        switch (eventName) {
          case 'mousedown':
            <span class="hljs-attr">isDragging</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
            <span class="hljs-attr">lastX</span> = e.<span class="hljs-literal">off</span>setX - originX<span class="hljs-comment">;</span>
            <span class="hljs-attr">lastY</span> = e.<span class="hljs-literal">off</span>setY - originY<span class="hljs-comment">;</span>
            break<span class="hljs-comment">;</span>
          case 'mouseup':
          case 'mouseout':
            <span class="hljs-attr">isDragging</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
            break<span class="hljs-comment">;</span>
          case 'mousemove':
            if (isDragging) {
              <span class="hljs-attr">originX</span> = e.<span class="hljs-literal">off</span>setX - lastX<span class="hljs-comment">;</span>
              <span class="hljs-attr">originY</span> = e.<span class="hljs-literal">off</span>setY - lastY<span class="hljs-comment">;</span>
              draw()<span class="hljs-comment">;</span>
            }
            break<span class="hljs-comment">;</span>
          case 'wheel':
            e.preventDefault()<span class="hljs-comment">;</span>
            var <span class="hljs-attr">mouseX</span> = e.<span class="hljs-literal">off</span>setX<span class="hljs-comment">;</span>
            var <span class="hljs-attr">mouseY</span> = e.<span class="hljs-literal">off</span>setY<span class="hljs-comment">;</span>
            var <span class="hljs-attr">wheel</span> = e.deltaY &lt; <span class="hljs-number">0</span> ? <span class="hljs-number">1.1</span> : <span class="hljs-number">0.9</span><span class="hljs-comment">;</span>
            var <span class="hljs-attr">newScale</span> = scale * wheel<span class="hljs-comment">;</span>
            draw()<span class="hljs-comment">;</span>
            if (newScale &lt; 0.1 || newScale &gt; 5) return<span class="hljs-comment">;</span>
            var <span class="hljs-attr">newOriginX</span> = mouseX - (mouseX - originX) * wheel<span class="hljs-comment">;</span>
            var <span class="hljs-attr">newOriginY</span> = mouseY - (mouseY - originY) * wheel<span class="hljs-comment">;</span>
            <span class="hljs-attr">scale</span> = newScale<span class="hljs-comment">;</span>
            <span class="hljs-attr">originX</span> = newOriginX<span class="hljs-comment">;</span>
            <span class="hljs-attr">originY</span> = newOriginY<span class="hljs-comment">;</span>

            break<span class="hljs-comment">;</span>
        }
      })<span class="hljs-comment">;</span>
    })<span class="hljs-comment">;</span>

    // 监听键盘事件
    window.addEventListener('keydown', (e) =&gt; {
      if (<span class="hljs-attr">e.keyCode</span> === <span class="hljs-number">27</span>) { // 检测到 esc 键被按下
        <span class="hljs-attr">imageUrl</span> = <span class="hljs-string">''</span><span class="hljs-comment">;</span>
        <span class="hljs-attr">canvas.style.display</span> = <span class="hljs-string">'none'</span><span class="hljs-comment">;</span>
        document.body.removeChild(closeButton)<span class="hljs-comment">;</span>
      }
    })<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[4 个本周优秀的 GitHub 开源项目。]]></title>    <link>https://juejin.cn/post/7599585289947316287</link>    <guid>https://juejin.cn/post/7599585289947316287</guid>    <pubDate>2026-01-27T03:01:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599585289947316287" data-draft-id="7599591405312786473" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="4 个本周优秀的 GitHub 开源项目。"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2026-01-27T03:01:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="逛逛GitHub"/> <meta itemprop="url" content="https://juejin.cn/user/1442202996186093"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            4 个本周优秀的 GitHub 开源项目。
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1442202996186093/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    逛逛GitHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T03:01:02.000Z" title="Tue Jan 27 2026 03:01:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>01</p>
<p><strong>编程的方式做视频</strong></p>
<p>Remotion 最近因为他们推出了 Skill 又火了一波。</p>
<p>Remotion 可以让你使用 React 来以代码的方式创建视频。不同于传统的视频剪辑软件，Remotion 将视频制作过程变成了编写代码的过程。</p>
<p>它利用 HTML、CSS、SVG、Canvas 和 WebGL 等标准的 Web 技术来生成视频画面，并通过编程逻辑，比如循环、变量、API 数据获取来控制动画和内容的生成。</p>
<p>亮点就是把视频生成可编程和可复用的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62bfb06b8ebc4b45a8d91d1352be28d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770087661&amp;x-signature=AEyOPUMsxq29FgsXBg1Qlbh%2BFKY%3D" alt="图片" loading="lazy"/></p>
<p>你可以像开发网页组件一样开发视频片段，还支持实时预览修改效果。</p>
<p>这个开源项目应该是目前 GitHub 上程序化视频生成最火的项目。它非常适合需要动态内容、批量生产或极其复杂的数学动画场景。</p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/remotion-dev/remotion</span>
</code></pre>
<p>02</p>
<p><strong>生成式 UI 的 SDK</strong></p>
<p>Tambo 是一个 SDK，专为 React 应用设计的 生成式 UI 开发工具包。</p>
<p>不再让用户去适应固定的界面流程，而是通过 AI 根据用户的自然语言对话，实时决定并渲染出最合适的 UI 组件。</p>
<p>简单来说，它让开发者可以在聊天界面中流式传输交互界面，而不仅仅是文本。</p>
<p>你需要在 Tambo 中注册自己应用内的 React 组件，比如图表、表单、购物车啥的，并定义好每个组件所需的属性模式。</p>
<p>在对话框中提出需求，比如显示上季度的销售数据时，Tambo 的 AI 引擎会解析意图，自动选择一个折线图组件，并填充正确的数据进行渲染，整个过程对用户是无感且自然的。</p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/tambo-ai/tambo</span>
</code></pre>
<p>03</p>
<p><strong>给终端 AI 配一个 UI</strong></p>
<p>AionUi 是一款开源的跨平台桌面 GUI 应用。</p>
<p>其实就是给命令行 AI 工具，比如 Google Gemini CLI、Claude Code 啥的提供图形化界面。</p>
<p>支持 Windows、macOS 和 Linux 系统，通过将原本仅能在终端中操作的指令转化为可视化的交互界面。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9998a2f3b37e4cc780eb93a1e7c7a585~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770087661&amp;x-signature=Slx20NJDjl0s4lbcQkGSZS5Em78%3D" alt="图片" loading="lazy"/></p>
<p>AionUi 不仅内置了对 Google Gemini CLI 的原生支持，还提供了多 Agent 模式，你可以集成 Claude Code、Qwen Code 等其他终端 AI  Agent。</p>
<p>你可以在一个统一的界面中切换使用不同的 AI 模型或工具。</p>
<p>而且所有的对话数据都存储在本地的 SQLite 数据库中，除非你主动配置云端服务，否则数据不会上传至外部服务器。</p>
<p>除了基础的聊天对话外，它还支持智能文件管理，比如批量重命名、自动整理文件夹、数据处理以及 Word、PPT 文档生成。</p>
<p>它还具备 AI 图像生成与编辑能力，并内置了多种格式的文件预览面板，让用户能即时查看 AI 处理后的结果。</p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/iOfficeAI/AionUi</span>
</code></pre>
<p>04</p>
<p><strong>多智能体协作平台</strong></p>
<p>Eigent 是一个开源多智能体（Multi-Agent）协作平台。底层基于 CAMEL 框架。</p>
<p>你用这个开源项目能在自己的电脑上创建多个 AI Agent 组成的虚拟团队。</p>
<p>与单一的 AI 聊天助手不同，Eigent 能够协调多个专注于不同领域的 Agent，比如搜索员、程序员、文档编写员来并行协作，解决复杂的长周期任务。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f3748a243fa40dba26ea4f4656f4c4d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770087661&amp;x-signature=B%2FtTDt8sqni%2FqFUqU%2BW1e%2FqLwJQ%3D" alt="图片" loading="lazy"/></p>
<p>Eigent  支持完全本地化部署，能够集成 vLLM 和 Ollama 等多种模型，确保数据隐私。</p>
<p>它预置了开发者、浏览器和文档处理等专用 Agent ，并支持 MCP 以扩展工具集成能力。</p>
<p>你不需要复杂配置即可使用，系统还包含人机协同机制，在任务执行中进行人工干预以保证准确性。</p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/eigent-ai/eigent</span>
</code></pre>
<p>05</p>
<p><strong>其它开源项目</strong></p>
<p>下面这个截图是本周最火的几个开源项目，有一些之前推荐过就没有详细介绍。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c3afe1d8b9542b3a5d67ca540c72ea3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770087661&amp;x-signature=yLlX83mtqeIpqwyjRhOeT%2FWvdKA%3D" alt="图片" loading="lazy"/></p>
<p>更多案例视频介绍请查看：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FsKcZ5MSccGUQaMTI4L4Rug" target="_blank" title="https://mp.weixin.qq.com/s/sKcZ5MSccGUQaMTI4L4Rug" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/sKcZ5MScc…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[非分割类型的文档转换器 - 学习总结]]></title>    <link>https://juejin.cn/post/7599581687358554162</link>    <guid>https://juejin.cn/post/7599581687358554162</guid>    <pubDate>2026-01-27T02:10:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599581687358554162" data-draft-id="7599551824548626458" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="非分割类型的文档转换器 - 学习总结"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-27T02:10:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="心在飞扬AI"/> <meta itemprop="url" content="https://juejin.cn/user/1556564194366823"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            非分割类型的文档转换器 - 学习总结
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1556564194366823/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    心在飞扬AI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T02:10:35.000Z" title="Tue Jan 27 2026 02:10:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">非分割类型的文档转换器 - 学习总结</h2>
<h3 data-id="heading-1">概述</h3>
<p>本目录展示了 LangChain 中不进行文档分割，而是对整个文档进行转换的处理器。这类转换器不会改变文档数量，而是对文档内容进行增强或转换。</p>
<h3 data-id="heading-2">核心概念</h3>
<h4 data-id="heading-3">非分割类型文档转换器的特点</h4>
<ol>
<li>不改变文档数量：输入 N 个文档，输出 N 个文档</li>
<li>内容增强/转换：
<ul>
<li>问答对提取（用于 RAG 检索增强）</li>
<li>翻译（多语言支持）</li>
<li>总结生成</li>
<li>信息提取</li>
</ul>
</li>
<li>保持结构：原文内容保留在 <code>page_content</code>，增强信息存储在 <code>metadata</code></li>
</ol>
<h4 data-id="heading-4">与分割器的区别</h4>























<table><thead><tr><th>类型</th><th>输入文档数</th><th>输出文档数</th><th>主要作用</th></tr></thead><tbody><tr><td>分割器 (TextSplitter)</td><td>1</td><td>多个</td><td>将长文档切分成小块</td></tr><tr><td>转换器 (Transformer)</td><td>N</td><td>N</td><td>对文档内容进行增强或转换</td></tr></tbody></table>
<h4 data-id="heading-5">实际应用架构</h4>
<pre><code class="hljs language-rust" lang="rust">原始文档 <span class="hljs-punctuation">-&gt;</span> 加载器 <span class="hljs-punctuation">-&gt;</span> 文档转换器（问答/翻译） <span class="hljs-punctuation">-&gt;</span> 向量化 <span class="hljs-punctuation">-&gt;</span> RAG 检索
</code></pre>
<hr/>
<h3 data-id="heading-6">文件详解</h3>
<h4 data-id="heading-7">1. 问答转换器示例.py</h4>
<p><strong>用途</strong>：使用 Doctran 库从文档中自动提取问答对</p>
<p><strong>核心功能</strong>：</p>
<ul>
<li>使用 <code>DoctranQATransformer</code> 从文档中提取关键信息</li>
<li>自动生成 3-5 个基于文档内容的问答对</li>
<li>问答对存储在文档的 <code>metadata</code> 中</li>
</ul>
<p><strong>示例代码</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_community.document_transformers <span class="hljs-keyword">import</span> DoctranQATransformer
<span class="hljs-keyword">from</span> langchain_core.documents <span class="hljs-keyword">import</span> Document

<span class="hljs-comment"># 构建转换器</span>
qa_transformer = DoctranQATransformer(openai_api_model=<span class="hljs-string">"moonshot-v1-8k"</span>)

<span class="hljs-comment"># 转换文档</span>
transformer_documents = qa_transformer.transform_documents(documents)

<span class="hljs-comment"># 获取问答对</span>
<span class="hljs-keyword">for</span> qa <span class="hljs-keyword">in</span> transformer_documents[<span class="hljs-number">0</span>].metadata.get(<span class="hljs-string">"questions_and_answers"</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"问答数据:"</span>, qa)
</code></pre>
<p><strong>使用场景</strong>：</p>
<ul>
<li>RAG 系统中增强文档检索</li>
<li>自动生成 FAQ</li>
<li>文档知识提取</li>
</ul>
<p><strong>注意事项</strong>：</p>
<ul>
<li>需要安装 doctran 库</li>
<li>依赖 Doctran 服务</li>
<li>可能存在网络连接问题</li>
</ul>
<hr/>
<h4 data-id="heading-8">2. 自定义问答转换器.py（推荐）</h4>
<p><strong>用途</strong>：使用 LangChain 原生功能实现自定义问答转换器（不依赖 Doctran）</p>
<p><strong>核心功能</strong>：</p>
<ul>
<li>使用 <code>ChatOpenAI</code> + <code>ChatPromptTemplate</code> 实现问答提取</li>
<li>支持多种 API（SiliconFlow、Moonshot、OpenAI）</li>
<li>自动根据 API_BASE 选择合适的模型</li>
<li>JSON 格式输出，易于解析</li>
<li>完善的错误处理</li>
</ul>
<p><strong>核心类结构</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomQATransformer</span>:
    <span class="hljs-string">"""自定义问答转换器，使用LLM从文档中提取问答对"""</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, openai_api_model: <span class="hljs-built_in">str</span> = <span class="hljs-string">"gpt-3.5-turbo"</span>, temperature: <span class="hljs-built_in">float</span> = <span class="hljs-number">0</span></span>)
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">transform_documents</span>(<span class="hljs-params">self, documents: <span class="hljs-built_in">list</span>[Document]</span>) -&gt; <span class="hljs-built_in">list</span>[Document]
</code></pre>
<p><strong>关键实现</strong>：</p>
<ol>
<li>提示模板设计：</li>
</ol>
<pre><code class="hljs language-python" lang="python">qa_extraction_prompt = ChatPromptTemplate.from_template(<span class="hljs-string">"""
你是一个专业的文档分析师。请从以下文档中提取3-5个最重要的问答对。

要求：
1. 的问题应该基于文档内容，能够帮助读者理解文档的核心信息
2. 答案应该简洁明了，直接来自文档内容
3. 问答对应该涵盖文档的主要话题

文档内容：
{document}

请以JSON格式返回，格式如下：
{{
    "questions_and_answers": [
        {{"question": "问题1", "answer": "答案1"}},
        {{"question": "问题2", "answer": "答案2"}}
    ]
}}
"""</span>)
</code></pre>
<ol start="2">
<li>自动模型选择逻辑：</li>
</ol>
<pre><code class="hljs language-python" lang="python">API_BASE = os.getenv(<span class="hljs-string">"OPENAI_API_BASE"</span>, <span class="hljs-string">""</span>)
<span class="hljs-keyword">if</span> <span class="hljs-string">"siliconflow"</span> <span class="hljs-keyword">in</span> API_BASE.lower():
    DEFAULT_MODEL = <span class="hljs-string">"Qwen/Qwen2.5-7B-Instruct"</span>
<span class="hljs-keyword">elif</span> <span class="hljs-string">"moonshot"</span> <span class="hljs-keyword">in</span> API_BASE.lower():
    DEFAULT_MODEL = <span class="hljs-string">"moonshot-v1-8k"</span>
<span class="hljs-keyword">else</span>:
    DEFAULT_MODEL = <span class="hljs-string">"gpt-3.5-turbo"</span>
</code></pre>
<ol start="3">
<li>JSON 解析处理：</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 处理可能包含代码标记的 JSON</span>
content = result.content.strip()
<span class="hljs-keyword">if</span> content.startswith(<span class="hljs-string">"```json"</span>):
    content = content[<span class="hljs-number">7</span>:]
<span class="hljs-keyword">if</span> content.startswith(<span class="hljs-string">"```"</span>):
    content = content[<span class="hljs-number">3</span>:]
<span class="hljs-keyword">if</span> content.endswith(<span class="hljs-string">"```"</span>):
    content = content[:-<span class="hljs-number">3</span>]
content = content.strip()
qa_data = json.loads(content)
</code></pre>
<p><strong>使用示例</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 创建转换器</span>
qa_transformer = CustomQATransformer(openai_api_model=<span class="hljs-string">"moonshot-v1-8k"</span>)

<span class="hljs-comment"># 执行转换</span>
transformer_documents = qa_transformer.transform_documents(documents)

<span class="hljs-comment"># 访问问答对</span>
<span class="hljs-keyword">for</span> qa <span class="hljs-keyword">in</span> transformer_documents[<span class="hljs-number">0</span>].metadata.get(<span class="hljs-string">"questions_and_answers"</span>, []):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"问题: <span class="hljs-subst">{qa[<span class="hljs-string">'question'</span>]}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"答案: <span class="hljs-subst">{qa[<span class="hljs-string">'answer'</span>]}</span>"</span>)
</code></pre>
<p><strong>优势</strong>：</p>
<ul>
<li>不依赖第三方 Doctran 库</li>
<li>更灵活的提示词控制</li>
<li>更好的错误处理</li>
<li>支持批量处理</li>
<li>适配多种 LLM API</li>
</ul>
<hr/>
<h4 data-id="heading-9">3. 2 翻译.py</h4>
<p><strong>用途</strong>：实现文档翻译功能，保持文档结构不变</p>
<p><strong>核心功能</strong>：</p>
<ul>
<li>使用 LLM 进行文档翻译</li>
<li>支持任意目标语言</li>
<li>保持原文格式和结构</li>
<li>返回翻译后的新文档</li>
</ul>
<p><strong>完整实现代码</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">translate_documents</span>(<span class="hljs-params">documents, target_language=<span class="hljs-string">"English"</span>, model=<span class="hljs-string">"moonshot-v1-8k"</span></span>):
    <span class="hljs-string">"""
    翻译文档内容到目标语言

    Args:
        documents: LangChain Document对象列表
        target_language: 目标语言
        model: 使用的模型名称
    """</span>
    <span class="hljs-comment"># 初始化LLM</span>
    llm = ChatOpenAI(model=model, temperature=<span class="hljs-number">0</span>)

    <span class="hljs-comment"># 创建翻译提示模板</span>
    prompt = ChatPromptTemplate.from_messages([
        (<span class="hljs-string">"system"</span>, <span class="hljs-string">"你是一个专业的翻译助手。请将以下文本翻译成{target_language}，保持原文的格式和结构。"</span>),
        (<span class="hljs-string">"human"</span>, <span class="hljs-string">"{text}"</span>)
    ])

    <span class="hljs-comment"># 创建翻译链</span>
    chain = prompt | llm

    translated_docs = []
    <span class="hljs-keyword">for</span> doc <span class="hljs-keyword">in</span> documents:
        <span class="hljs-comment"># 调用翻译</span>
        response = chain.invoke({
            <span class="hljs-string">"text"</span>: doc.page_content,
            <span class="hljs-string">"target_language"</span>: target_language
        })
        <span class="hljs-comment"># 创建新的翻译文档</span>
        translated_docs.append(Document(page_content=response.content))

    <span class="hljs-keyword">return</span> translated_docs
</code></pre>
<p><strong>使用示例</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 翻译为英文</span>
translator_documents = translate_documents(documents, target_language=<span class="hljs-string">"English"</span>)

<span class="hljs-comment"># 翻译为日文</span>
translator_documents = translate_documents(documents, target_language=<span class="hljs-string">"Japanese"</span>)

<span class="hljs-comment"># 翻译为法文</span>
translator_documents = translate_documents(documents, target_language=<span class="hljs-string">"French"</span>)
</code></pre>
<p><strong>使用场景</strong>：</p>
<ul>
<li>多语言文档处理</li>
<li>跨语言 RAG 系统</li>
<li>本地化文档生成</li>
<li>国际化支持</li>
</ul>
<hr/>
<h3 data-id="heading-10">应用场景</h3>
<h4 data-id="heading-11">1. RAG 系统增强</h4>
<p>在 RAG（检索增强生成）系统中使用问答转换器：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 原始文档</span>
documents = loader.load()

<span class="hljs-comment"># 提取问答对增强检索</span>
qa_transformer = CustomQATransformer()
enhanced_docs = qa_transformer.transform_documents(documents)

<span class="hljs-comment"># 向量化</span>
vectorstore.add_documents(enhanced_docs)

<span class="hljs-comment"># 检索时可以匹配问题，提高召回率</span>
</code></pre>
<h4 data-id="heading-12">2. 多语言知识库</h4>
<p>构建支持多语言的知识库：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 加载中文文档</span>
documents = loader.load()

<span class="hljs-comment"># 翻译为英文</span>
en_docs = translate_documents(documents, target_language=<span class="hljs-string">"English"</span>)

<span class="hljs-comment"># 合并中英文文档</span>
all_docs = documents + en_docs

<span class="hljs-comment"># 构建向量库</span>
vectorstore.add_documents(all_docs)
</code></pre>
<h4 data-id="heading-13">3. 文档预处理流水线</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.documents <span class="hljs-keyword">import</span> Document

<span class="hljs-comment"># 完整的文档处理流程</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">process_documents</span>(<span class="hljs-params">raw_documents</span>):
    <span class="hljs-comment"># 1. 提取问答对</span>
    qa_transformer = CustomQATransformer()
    docs_with_qa = qa_transformer.transform_documents(raw_documents)

    <span class="hljs-comment"># 2. 翻译为英文（可选）</span>
    en_docs = translate_documents(docs_with_qa, target_language=<span class="hljs-string">"English"</span>)

    <span class="hljs-comment"># 3. 合并所有文档</span>
    final_docs = docs_with_qa + en_docs

    <span class="hljs-keyword">return</span> final_docs
</code></pre>
<hr/>
<h3 data-id="heading-14">技术要点</h3>
<h4 data-id="heading-15">1. 文档转换器的设计模式</h4>
<p>所有文档转换器都应遵循相同的接口：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DocumentTransformer</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">transform_documents</span>(<span class="hljs-params">self, documents: <span class="hljs-built_in">list</span>[Document]</span>) -&gt; <span class="hljs-built_in">list</span>[Document]:
        <span class="hljs-string">"""转换文档列表，返回转换后的文档列表"""</span>
        <span class="hljs-keyword">pass</span>
</code></pre>
<h4 data-id="heading-16">2. Metadata 使用规范</h4>
<p>增强信息应存储在 metadata 中：</p>
<pre><code class="hljs language-python" lang="python">new_doc = Document(
    page_content=original_content,  <span class="hljs-comment"># 保持原文</span>
    metadata={
        **original_metadata,         <span class="hljs-comment"># 保留原有元数据</span>
        <span class="hljs-string">"questions_and_answers"</span>: [], <span class="hljs-comment"># 新增增强信息</span>
        <span class="hljs-string">"language"</span>: <span class="hljs-string">"en"</span>             <span class="hljs-comment"># 其他元数据</span>
    }
)
</code></pre>
<h4 data-id="heading-17">3. 错误处理策略</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">try</span>:
    <span class="hljs-comment"># 尝试解析和处理</span>
    result = process_document(doc)
<span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"处理失败: <span class="hljs-subst">{e}</span>"</span>)
    <span class="hljs-comment"># 返回原始文档，确保流程继续</span>
    <span class="hljs-keyword">return</span> doc
</code></pre>
<h4 data-id="heading-18">4. 批量处理优化</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 可以添加并发处理提高效率</span>
<span class="hljs-keyword">from</span> concurrent.futures <span class="hljs-keyword">import</span> ThreadPoolExecutor

<span class="hljs-keyword">def</span> <span class="hljs-title function_">transform_documents_parallel</span>(<span class="hljs-params">self, documents, max_workers=<span class="hljs-number">5</span></span>):
    <span class="hljs-keyword">with</span> ThreadPoolExecutor(max_workers=max_workers) <span class="hljs-keyword">as</span> executor:
        results = <span class="hljs-built_in">list</span>(executor.<span class="hljs-built_in">map</span>(self._transform_single, documents))
    <span class="hljs-keyword">return</span> results
</code></pre>
<hr/>
<h3 data-id="heading-19">依赖项</h3>
<h4 data-id="heading-20">核心依赖</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># LangChain 核心</span>
pip install langchain langchain-openai langchain-community

<span class="hljs-comment"># 环境变量管理</span>
pip install python-dotenv

<span class="hljs-comment"># 可选：Doctran（如果使用 DoctranQATransformer）</span>
pip install doctran
</code></pre>
<h4 data-id="heading-21">环境变量配置</h4>
<p>创建 <code>.env</code> 文件：</p>
<pre><code class="hljs language-env" lang="env"># OpenAI 兼容 API 配置
OPENAI_API_BASE=https://api.moonshot.cn/v1
OPENAI_API_KEY=your_api_key_here

# 或者使用 SiliconFlow
# OPENAI_API_BASE=https://api.siliconflow.cn/v1
# OPENAI_API_KEY=your_siliconflow_key
</code></pre>
<hr/>
<h3 data-id="heading-22">学习建议</h3>
<ol>
<li>理解转换器与分割器的区别</li>
<li>掌握自定义转换器的实现方法</li>
<li>学习如何在 RAG 系统中应用转换器</li>
<li>实践多语言文档处理</li>
<li>构建完整的文档处理流水线</li>
</ol>
<hr/>
<h3 data-id="heading-23">扩展阅读</h3>
<ul>
<li>LangChain 文档转换器文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpython.langchain.com%2Fdocs%2Fmodules%2Fdata_connection%2Fdocument_transformers%2F" target="_blank" title="https://python.langchain.com/docs/modules/data_connection/document_transformers/" ref="nofollow noopener noreferrer">python.langchain.com/docs/module…</a></li>
<li>RAG 系统最佳实践</li>
<li>提示工程技巧</li>
<li>JSON 解析与错误处理</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别按量付费：搭建一个无限免费的私人 TTS 服务]]></title>    <link>https://juejin.cn/post/7599572091075133482</link>    <guid>https://juejin.cn/post/7599572091075133482</guid>    <pubDate>2026-01-27T02:45:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599572091075133482" data-draft-id="7599502282603266111" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别按量付费：搭建一个无限免费的私人 TTS 服务"/> <meta itemprop="keywords" content="AIGC,OpenAI,AI编程"/> <meta itemprop="datePublished" content="2026-01-27T02:45:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一只会飞的旺旺"/> <meta itemprop="url" content="https://juejin.cn/user/1151943915355965"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别按量付费：搭建一个无限免费的私人 TTS 服务
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1151943915355965/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一只会飞的旺旺
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T02:45:48.000Z" title="Tue Jan 27 2026 02:45:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/adf43fa47df945e188599498f120eea4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5Y-q5Lya6aOe55qE5pe65pe6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770086752&amp;x-signature=ufOj8UYKtQXl%2BSRmREGwYtJqG4M%3D" alt="cover" loading="lazy"/></p>
<p>用自己的声音让 AI 读稿，我以前就有这个想法!</p>
<p>之前试过 ElevenLabs，效果确实好，但每个月 10 美元起步，用多了还得加钱。Azure 的 TTS 便宜点，但声音克隆要企业认证，个人用户压根申请不下来。开源方案倒是有，CosyVoice、FishSpeech 都不错，问题是我那台老笔记本只有 8GB 显存，跑这俩都费劲。</p>
<p>直到上周，阿里把 Qwen3-TTS 全家桶开源了。</p>
<h2 data-id="heading-0">0.6B 有多轻量？</h2>
<p><strong>0.6B 模型只需要 1.2GB 显存</strong>，没有独显的话，纯 CPU 也能跑。</p>
<p>这意味着什么？一台普通办公电脑，8GB 内存，集显，就能跑完整的语音合成模型。不用买云服务器，不用按量付费，模型下到本地，想用多少用多少。我特地用一台普通云电脑跑了下,慢是慢了点,但是能用!</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c8098e567d34df983dfbc7d7ac4a8ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5Y-q5Lya6aOe55qE5pe65pe6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770086752&amp;x-signature=e4Ge6mNlC4qJ75G1O75beKERVSs%3D" alt="image-20260126193437091" loading="lazy"/></p>
<p>Qwen3-TTS 这次开源了两个尺寸：</p>























<table><thead><tr><th>模型</th><th>参数量</th><th>显存需求</th><th>定位</th></tr></thead><tbody><tr><td>1.7B</td><td>17 亿</td><td>~3.4GB</td><td>极致音质</td></tr><tr><td><strong>0.6B</strong></td><td>6 亿</td><td><strong>~1.2GB</strong></td><td>均衡效率</td></tr></tbody></table>
<p>0.6B 虽然参数少，但该有的能力都有：10 种语言（中英日韩德法俄葡西意）、多种方言（粤语、四川话、闽南语等）、声音克隆、声音设计。对于个人用户来说，0.6B 已经够用了。</p>
<h2 data-id="heading-1">安装</h2>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FQwenLM%2FQwen3-TTS" target="_blank" title="https://github.com/QwenLM/Qwen3-TTS" ref="nofollow noopener noreferrer">github.com/QwenLM/Qwen…</a></p>
</blockquote>
<p>这块直接看官方文档吧! 或者让AI给你安装就行,留一份我的一键脚本,可以自己试试!</p>
<p>装完之后，第一次运行会自动下载模型权重，0.6B 大概 1.2GB，耐心等一下。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/usr/bin/env bash</span>
<span class="hljs-built_in">set</span> -euo pipefail


ROOT=<span class="hljs-string">"/wangwang/qwen"</span>
MODEL_ID=<span class="hljs-string">"Qwen/Qwen3-TTS-12Hz-0.6B-Base"</span>


<span class="hljs-built_in">mkdir</span> -p <span class="hljs-string">"<span class="hljs-variable">$ROOT</span>"</span>
<span class="hljs-built_in">cd</span> <span class="hljs-string">"<span class="hljs-variable">$ROOT</span>"</span>


<span class="hljs-built_in">echo</span> <span class="hljs-string">"[1/6] venv"</span>
python3 -m venv .venv
<span class="hljs-built_in">source</span> .venv/bin/activate
python -m pip install -U pip wheel setuptools


<span class="hljs-built_in">echo</span> <span class="hljs-string">"[2/6] HF mirror + cache"</span>
<span class="hljs-built_in">export</span> HF_ENDPOINT=<span class="hljs-string">"https://hf-mirror.com"</span>   <span class="hljs-comment"># huggingface 工具链会读取该变量走镜像 :contentReference[oaicite:2]{index=2}</span>
<span class="hljs-built_in">export</span> HF_HOME=<span class="hljs-string">"<span class="hljs-variable">$ROOT</span>/hf_home"</span>


<span class="hljs-built_in">echo</span> <span class="hljs-string">"[3/6] PyTorch (CPU wheel)"</span>
pip install -U torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu


<span class="hljs-built_in">echo</span> <span class="hljs-string">"[4/6] Runtime deps"</span>
pip install -U <span class="hljs-string">"qwen-tts"</span> <span class="hljs-string">"huggingface_hub[cli]"</span> soundfile requests numpy


<span class="hljs-built_in">echo</span> <span class="hljs-string">"[5/6] CPU performance knobs"</span>
<span class="hljs-comment"># 默认用最多 8 线程更稳（你可以在运行前 export THREADS=4 自定义）</span>
THREADS=<span class="hljs-string">"<span class="hljs-variable">${THREADS:-$(python - &lt;&lt;'PY'
import os
n=os.cpu_count() or 1
print(max(1, min(8, n)))
PY
)}</span>"</span>
<span class="hljs-built_in">export</span> OMP_NUM_THREADS=<span class="hljs-string">"<span class="hljs-variable">$THREADS</span>"</span>
<span class="hljs-built_in">export</span> MKL_NUM_THREADS=<span class="hljs-string">"<span class="hljs-variable">$THREADS</span>"</span>
<span class="hljs-built_in">export</span> OPENBLAS_NUM_THREADS=<span class="hljs-string">"<span class="hljs-variable">$THREADS</span>"</span>
<span class="hljs-built_in">export</span> NUMEXPR_NUM_THREADS=<span class="hljs-string">"<span class="hljs-variable">$THREADS</span>"</span>


<span class="hljs-built_in">echo</span> <span class="hljs-string">"THREADS=<span class="hljs-variable">$THREADS</span>"</span>


<span class="hljs-built_in">echo</span> <span class="hljs-string">"[6/6] Smoke test (voice clone -&gt; out/output_voice_clone.wav)"</span>
<span class="hljs-built_in">mkdir</span> -p out
python - &lt;&lt;<span class="hljs-string">'PY'</span>
import io, os, requests
import numpy as np
import torch
import soundfile as sf
from qwen_tts import Qwen3TTSModel


MODEL_ID=<span class="hljs-string">"Qwen/Qwen3-TTS-12Hz-0.6B-Base"</span>


threads = int(os.environ.get(<span class="hljs-string">"OMP_NUM_THREADS"</span>,<span class="hljs-string">"4"</span>))
torch.set_num_threads(threads)
torch.set_num_interop_threads(1)


<span class="hljs-built_in">print</span>(<span class="hljs-string">"torch:"</span>, torch.__version__)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"threads:"</span>, threads)


<span class="hljs-comment"># 下载参考音频（官方 demo 里 voice clone 需要 ref_audio，且在非 x-vector-only 时还需要 ref_text）:contentReference[oaicite:3]{index=3}</span>
ref_audio_url = <span class="hljs-string">"https://qianwen-res.oss-cn-beijing.aliyuncs.com/Qwen3-TTS-Repo/clone.wav"</span>
resp = requests.get(ref_audio_url, <span class="hljs-built_in">timeout</span>=60)
resp.raise_for_status()
wav, sr = sf.read(io.BytesIO(resp.content))
<span class="hljs-keyword">if</span> wav.ndim &gt; 1:
    wav = np.mean(wav, axis=1)
wav = wav.astype(np.float32)
ref_audio = (wav, int(sr))


<span class="hljs-comment"># 说明：如果你把 x_vector_only_mode=False，则需要提供 ref_text（HF demo 做了校验）:contentReference[oaicite:4]{index=4}</span>
ref_text = <span class="hljs-string">"Okay. Yeah. I resent you. I love you. I respect you. But you know what? You blew it! And thanks to you."</span>


tts = Qwen3TTSModel.from_pretrained(
    MODEL_ID,
    device_map=<span class="hljs-string">"cpu"</span>,
    dtype=torch.float32,
    <span class="hljs-comment"># CPU 用 eager 更稳；flash_attention_2 主要给 GPU :contentReference[oaicite:5]{index=5}</span>
    attn_implementation=<span class="hljs-string">"eager"</span>,
)


wavs, out_sr = tts.generate_voice_clone(
    text=<span class="hljs-string">"Hello! This is a CPU smoke test for Qwen3-TTS voice cloning."</span>,
    language=<span class="hljs-string">"English"</span>,
    ref_audio=ref_audio,
    ref_text=ref_text,
    x_vector_only_mode=False,  <span class="hljs-comment"># True 会更快一些，但通常更依赖参考音频质量/相似度</span>
    max_new_tokens=768,        <span class="hljs-comment"># CPU 建议先小一点，确保跑通</span>
)


sf.write(<span class="hljs-string">"out/output_voice_clone.wav"</span>, wavs[0], out_sr)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"Saved -&gt; out/output_voice_clone.wav | sr:"</span>, out_sr, <span class="hljs-string">"| sec:"</span>, len(wavs[0])/out_sr)
PY


<span class="hljs-built_in">echo</span> <span class="hljs-string">"DONE: <span class="hljs-variable">$ROOT</span>/out/output_voice_clone.wav"</span>
</code></pre>
<h2 data-id="heading-2">声音克隆：3 秒音频就够</h2>
<p>这是 Qwen3-TTS 最让我意外的功能。只需要一段 3-10 秒的音频，模型就能学会这个人的音色、语调、说话节奏，然后用这个声音读任何你给的文本。</p>
<p>代码也不复杂：</p>
<pre><code class="hljs language-ini" lang="ini">import torch
import soundfile as sf
from qwen_tts import Qwen3TTSModel


<span class="hljs-comment"># 加载 0.6B 模型</span>
<span class="hljs-attr">model</span> = Qwen3TTSModel.from_pretrained(
    "Qwen/Qwen3-TTS-12Hz-0.6B-Base",
    <span class="hljs-attr">device_map</span>=<span class="hljs-string">"cuda:0"</span>,  <span class="hljs-comment"># 没有显卡就用 "cpu"</span>
    <span class="hljs-attr">dtype</span>=torch.float16,
)


<span class="hljs-comment"># 克隆声音</span>
wavs, <span class="hljs-attr">sr</span> = model.generate_voice_clone(
    <span class="hljs-attr">text</span>=<span class="hljs-string">"今天天气不错，适合出去走走。"</span>,
    <span class="hljs-attr">language</span>=<span class="hljs-string">"Chinese"</span>,
    <span class="hljs-attr">ref_audio</span>=<span class="hljs-string">"my_voice.wav"</span>,      <span class="hljs-comment"># 你的参考音频</span>
    <span class="hljs-attr">ref_text</span>=<span class="hljs-string">"这是参考音频的文字内容。"</span>,  <span class="hljs-comment"># 参考音频说了什么</span>
)


sf.write("output.wav", wavs<span class="hljs-section">[0]</span>, sr)
</code></pre>
<p>我拿自己录的一段 5 秒音频试了试，效果出乎意料。音色还原度很高，连我说话时习惯性的尾音拖长都学到了。想效果更好的话可以换 1.7B，代价是显存占用翻倍。</p>
<p>有个坑：<code>ref_text</code> 参数是必须的，你得告诉模型参考音频里说了什么。懒得写的话可以开 <code>x_vector_only_mode</code>，只用音色特征不看文本，但音质会打折扣。</p>
<h2 data-id="heading-3">封装成 Claude Code Skill</h2>
<p>上面说的都是官方玩法，接下来是我自己折腾出来的骚操作。</p>
<p>既然 Qwen3-TTS 可以本地运行，那能不能封装成一个服务，随时调用？更进一步，能不能做成 Claude Code 的 Skill，让 AI 助手直接帮我把文字转成语音？</p>
<p>答案是可以的。而且一旦配好，就相当于有了一个<strong>无限免费的私人 TTS 服务</strong>。</p>
<h3 data-id="heading-4">为什么要这么做？</h3>
<p>每次用 TTS 都要手动跑 Python 脚本，麻烦。封装成 Skill 之后，直接在 Claude Code 里敲 <code>/qwen-tts 今天天气不错</code>，AI 就能帮你生成语音文件。写文章的时候想听听读起来顺不顺口？一句命令搞定。有需要的用户可以留言,我可以将自己的分享到github上!</p>
<blockquote>
<p>地址来啦: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwangwangit%2Fqwen3-tts" target="_blank" title="https://github.com/wangwangit/qwen3-tts" ref="nofollow noopener noreferrer">github.com/wangwangit/…</a></p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6489d424813b4738b4ccf6383b208498~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5Y-q5Lya6aOe55qE5pe65pe6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770086752&amp;x-signature=qA2HWgk4I0WYdCD87N%2F4VUmcNtA%3D" alt="image-20260126193850005" loading="lazy"/></p>
<p>然后修改 Skill，让它调用这个 API 而不是每次都加载模型。这样响应速度能从十几秒缩短到一两秒。</p>
<h2 data-id="heading-5">适合什么人用？</h2>
<ul>
<li><strong>内容创作者</strong>：写公众号、做视频，需要配音但不想花钱</li>
<li><strong>开发者</strong>：想在自己的应用里加入语音功能，不想被 API 账单吓到</li>
<li><strong>折腾党</strong>：就是想在本地跑个 AI 玩玩，不需要理由</li>
</ul>
<p>如果你追求极致音质，愿意等更长的生成时间，可以换成 1.7B 模型。如果你的电脑配置一般，或者更看重响应速度，0.6B 是更实际的选择。</p>
<h2 data-id="heading-6">最后</h2>
<p>阿里这次开源的 Qwen3-TTS，给了我一点惊喜。0.6B 这个尺寸，在保持可用性的前提下，把硬件门槛拉到了普通用户能接受的水平。声音克隆不再是云端大厂的专利，一台普通电脑就能玩。</p>
<p>更重要的是，它是 Apache 2.0 协议，商用也没问题。</p>
<p>GitHub 地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FQwenLM%2FQwen3-TTS" target="_blank" title="https://github.com/QwenLM/Qwen3-TTS" ref="nofollow noopener noreferrer">github.com/QwenLM/Qwen…</a></p>
<p>Hugging Face 在线体验：<a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fspaces%2FQwen%2FQwen3-TTS" target="_blank" title="https://huggingface.co/spaces/Qwen/Qwen3-TTS" ref="nofollow noopener noreferrer">huggingface.co/spaces/Qwen…</a></p>
<p>有兴趣的话，去试试用自己的声音做一个 AI 分身。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2fb8390d8faf44ac9fdc7dbdc540b06f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5Y-q5Lya6aOe55qE5pe65pe6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770086752&amp;x-signature=hSTgTmOfFn7NFiA9msg8MYfnlu0%3D" alt="image-20260126194126468" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[解锁昇腾算力：自定义训练循环与图模式加速指南]]></title>    <link>https://juejin.cn/post/7599580550296567843</link>    <guid>https://juejin.cn/post/7599580550296567843</guid>    <pubDate>2026-01-27T02:51:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599580550296567843" data-draft-id="7599600549764431907" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="解锁昇腾算力：自定义训练循环与图模式加速指南"/> <meta itemprop="keywords" content="后端,算法"/> <meta itemprop="datePublished" content="2026-01-27T02:51:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户867573478982"/> <meta itemprop="url" content="https://juejin.cn/user/924064924829272"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            解锁昇腾算力：自定义训练循环与图模式加速指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/924064924829272/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户867573478982
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T02:51:15.000Z" title="Tue Jan 27 2026 02:51:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<h3 data-id="heading-0">前言</h3>
<p>在深度学习的科研与工程落地中，我们既需要PyTorch式的灵活性（动态图调试），又渴望TensorFlow式的极致性能（静态图部署）。MindSpore作为全场景AI框架，通过PyNative模式和Graph模式的无缝切换解决了这一痛点。</p>
<p>但在实际开发中，很多从其他框架转来的开发者在使用MindSpore进行自定义训练循环（Custom Training Loop）时，往往因为没有正确利用JIT编译和函数式变换，导致无法完全释放昇腾NPU的算力。</p>
<p>本文将摒弃繁琐的理论，直接通过代码实战，带你构建一个高效、可微分、运行在Graph模式下的自定义训练流程。</p>
<h3 data-id="heading-1">核心概念：为何需要 value_and_grad和 @jit</h3>
<p>在MindSpore中，自动微分采用的是基于源码转换（Source Code Transformation, SCT）的机制。与PyTorch的<code>.backward()</code>累积梯度不同，MindSpore更推崇函数式编程。</p>
<ol>
<li>**<code>ops.value_and_grad</code>**：同时计算正向网络的输出（Loss）和关于权重的梯度。这是编写自定义训练步的核心。</li>
<li>**<code>@jit</code>(原 <code>@ms_function</code>)**：这是性能的关键。它将Python函数编译成静态计算图，并下沉到Ascend芯片上运行，大幅减少Host-Device交互开销。</li>
</ol>
<h3 data-id="heading-2">实战演练：构建高效训练步</h3>
<p>假设我们已经定义好了一个简单的网络（Net）和数据集（Dataset）。我们将重点放在如何手写一个高性能的训练步骤（Train Step）。</p>
<h4 data-id="heading-3">1. 环境准备与基础定义</h4>
<p>首先，确保上下文环境指向Ascend，并定义好网络与损失函数。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> mindspore <span class="hljs-keyword">as</span> ms
<span class="hljs-keyword">from</span> mindspore <span class="hljs-keyword">import</span> nn, ops, Tensor
<span class="hljs-keyword">from</span> mindspore <span class="hljs-keyword">import</span> dtype <span class="hljs-keyword">as</span> mstype

<span class="hljs-comment"># 设置运行环境为昇腾NPU，模式为PyNative以便于调试，最后我们会通过装饰器加速</span>
ms.set_context(mode=ms.PYNATIVE_MODE, device_target=<span class="hljs-string">"Ascend"</span>)

<span class="hljs-comment"># 模拟一个简单的线性网络</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleNet</span>(nn.Cell):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-built_in">super</span>(SimpleNet, self).__init__()
        self.fc = nn.Dense(<span class="hljs-number">10</span>, <span class="hljs-number">1</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">construct</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-keyword">return</span> self.fc(x)

<span class="hljs-comment"># 初始化</span>
net = SimpleNet()
loss_fn = nn.MSELoss()
optimizer = nn.Momentum(net.trainable_params(), learning_rate=<span class="hljs-number">0.01</span>, momentum=<span class="hljs-number">0.9</span>)
</code></pre>
<p><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/></p>
<h4 data-id="heading-4">2. 定义前向计算函数</h4>
<p>在MindSpore的函数式微分中，我们需要定义一个纯粹的前向计算函数，该函数输入数据和标签，输出Loss。</p>
<pre><code class="hljs language-ini" lang="ini">def forward_fn(data, label):
    <span class="hljs-comment"># 前向计算</span>
    <span class="hljs-attr">logits</span> = net(data)
    <span class="hljs-comment"># 计算损失</span>
    <span class="hljs-attr">loss</span> = loss_fn(logits, label)
    return loss, logits
</code></pre>
<p><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/></p>
<h4 data-id="heading-5">3. 获取梯度计算函数</h4>
<p>这是最关键的一步。我们使用 <code>ops.value_and_grad</code>来生成一个可以计算梯度的函数。</p>
<ul>
<li>
<p><code>fn</code>: 指定前向函数。</p>
</li>
<li>
<p><code>grad_position</code>: 指定对哪些输入求导（这里设为None，因为我们只对权重求导）。</p>
</li>
<li>
<p><code>weights</code>: 指定需要更新的权重参数（即网络的 <code>trainable_params</code>）。</p>
</li>
<li>
<p><code>has_aux</code>: 如果 <code>forward_fn</code>返回除loss外的其他输出（如上面的logits），需设为True。</p>
<h2 data-id="heading-6">定义梯度变换函数</h2>
<p>grad_fn = ops.value_and_grad(forward_fn, None, optimizer.parameters, has_aux=True)</p>
</li>
</ul>
<p><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/></p>
<h4 data-id="heading-7">4. 封装训练步并开启图模式加速</h4>
<p>现在，我们将前向计算、梯度计算、优化器更新封装在一个函数中。为了在Ascend NPU上获得最佳性能，我们必须在该函数上添加 <code>@jit</code>装饰器。</p>
<p>这个装饰器会触发MindSpore的编译器，将Python代码编译成可以在CANN层高效执行的静态图。</p>
<pre><code class="hljs language-ini" lang="ini">@ms.jit  <span class="hljs-comment"># &lt;--- 核心：开启图模式加速，算子下沉</span>
def train_step(data, label):
    <span class="hljs-comment"># 1. 计算Loss和梯度</span>
    (loss, _), <span class="hljs-attr">grads</span> = grad_fn(data, label)
  
    <span class="hljs-comment"># 2. 优化器更新权重</span>
    <span class="hljs-comment"># 注意：在函数式编程中，优化器通常作为算子使用</span>
    <span class="hljs-attr">loss</span> = ops.depend(loss, optimizer(grads))
  
    return loss
</code></pre>
<p><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/></p>
<blockquote>
<p>技术TIPS：<code>ops.depend</code>是一个控制依赖关系的算子。它保证了在返回 <code>loss</code>之前，<code>optimizer(grads)</code>这一步操作一定已经被执行。这在静态图优化中非常重要，防止编译器因为“输出不依赖于更新操作”而将更新步骤优化掉。</p>
</blockquote>
<h4 data-id="heading-8">5. 完整的训练循环</h4>
<p>最后，我们模拟数据输入，运行训练循环。</p>
<pre><code class="hljs language-scss" lang="scss">import numpy as np

# 模拟数据
def <span class="hljs-built_in">get_batch_data</span>():
    x = <span class="hljs-built_in">Tensor</span>(np.random.<span class="hljs-built_in">randn</span>(<span class="hljs-number">32</span>, <span class="hljs-number">10</span>).<span class="hljs-built_in">astype</span>(np.float32))
    y = <span class="hljs-built_in">Tensor</span>(np.random.<span class="hljs-built_in">randn</span>(<span class="hljs-number">32</span>, <span class="hljs-number">1</span>).<span class="hljs-built_in">astype</span>(np.float32))
    return x, y

# 开始训练
epochs = <span class="hljs-number">5</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"Start training on Ascend..."</span>)

for epoch in <span class="hljs-built_in">range</span>(epochs):
    x, y = <span class="hljs-built_in">get_batch_data</span>()
  
    # 执行编译后的静态图训练步
    loss = <span class="hljs-built_in">train_step</span>(x, y)
  
    <span class="hljs-built_in">print</span>(f<span class="hljs-string">"Epoch: {epoch+1}, Loss: {loss.asnumpy()}"</span>)
</code></pre>
<p><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/></p>
<h3 data-id="heading-9">进阶：静态图模式下的避坑指南</h3>
<p>虽然 <code>@jit</code>能带来巨大的性能提升，但它对Python语法的支持是有一定限制的（因为它需要将Python转译为中间表达IR）。在昇腾上开发时，请注意以下几点：</p>
<ol>
<li>避免使用第三方库的随机函数：在 <code>@jit</code>修饰的函数内部，尽量使用 <code>mindspore.ops</code>中的算子，避免使用 <code>numpy</code>或 <code>random</code>等库的操作，因为这些操作无法被编译进图，会导致回退到Host端执行，阻断流水线。</li>
<li>控制流的限制：虽然MindSpore支持控制流，但过于复杂的动态条件判断（依赖于Tensor值的if/else）可能会导致图编译变慢。尽量将逻辑向量化。</li>
<li>打印调试：在图模式下，直接 <code>print(tensor)</code>可能无法按预期打印每一步的值。如果需要调试，可以使用 <code>ops.Print()</code>算子。</li>
<li>Side Effects（副作用）：如果你的函数修改了全局变量或列表，这种副作用在图编译中可能不会生效。请坚持函数式的写法：输入 -&gt; 计算 -&gt; 返回。</li>
</ol>
<h3 data-id="heading-10">总结</h3>
<p>在昇腾社区进行MindSpore开发时，掌握 <code>ops.value_and_grad</code>配合 <code>@jit</code>是从入门走向进阶的分水岭。</p>
<ul>
<li>PyNative模式：适合调试网络结构、验证逻辑。</li>
<li>Graph模式（<code>@jit</code>）：适合生产环境、大规模训练，能充分利用Ascend 910/310的异构计算能力。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ClawdBot傻瓜式使用方法:手把手教你部署7×24替你用电脑干活的ClawdBot]]></title>    <link>https://juejin.cn/post/7599483314161860627</link>    <guid>https://juejin.cn/post/7599483314161860627</guid>    <pubDate>2026-01-27T02:20:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599483314161860627" data-draft-id="7599502282603053119" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ClawdBot傻瓜式使用方法:手把手教你部署7×24替你用电脑干活的ClawdBot"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2026-01-27T02:20:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="爱吃的小肥羊"/> <meta itemprop="url" content="https://juejin.cn/user/2637045249608064"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ClawdBot傻瓜式使用方法:手把手教你部署7×24替你用电脑干活的ClawdBot
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2637045249608064/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    爱吃的小肥羊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T02:20:28.000Z" title="Tue Jan 27 2026 02:20:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在刚刚过去的这个周末，整个社交媒体都被ClawdBot刷屏了，像病毒一样疯狂传播开来，铺天盖地！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d30e14a8e3d54d939cc1f4cb1b406ea1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD55qE5bCP6IKl576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770085231&amp;x-signature=uctYFOsfgjEJrSOGKegoqn2AsuI%3D" alt="" loading="lazy"/></p>
<p>从Reddit到Twitter，从Discord的tech社群到微博的AI话题，全是关于它的讨论，有人说用上它就像有了"可长期持续运行的AI助手"。</p>
<p>Creator Buddy创始人兼CEO Alex Finn也盛赞道：这就是Claude 希望 Claude Cowork 呈现的样子。</p>
<p>网红产品见过不少，但这一次或许真的不同。</p>
<p>有硅谷博主称其为，<strong>迄今为止最伟大的 AI 应用。</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02afc48f47e74188b62b0df260cd93ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD55qE5bCP6IKl576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770085231&amp;x-signature=xW6ryOeAUCATvL6HnZKR3tmnN40%3D" alt="" loading="lazy"/></p>
<p><strong>很多人看了很多文章和视频，还是搞不懂Clawdbot是什么？这里给大家简单介绍一下。</strong></p>
<p>它本质上是一个运行在你自己的电脑或服务器上的个人人工智能助手，你可以用它与即时通讯应用进行通信，处理各种任务。</p>
<p>我们平时用的ChatGPT或Claude，哪怕再聪明，也只能给你出主意，没法替你干活。</p>
<p>但Clawdbot不一样，<strong>它是一个运行在你本地电脑上的AI Agent（智能体），能帮你实现真正意义上的干活。</strong></p>
<p>给大家举几个例子就明白了。</p>
<p>有网友让ClawdBot定期提醒他，还自动发布推特内容。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4aed7504624944be95eb151dc02ac5ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD55qE5bCP6IKl576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770085231&amp;x-signature=o5qz0eNY3%2BEpQ9W57eEDzPyd%2Fn0%3D" alt="" loading="lazy"/></p>
<p>还有一位大佬使用Clawbot做各种各样的功能，比如查看邮箱并删除垃圾邮箱，订购东西等等。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9592581d228f40fb8bbfc6df42e654dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD55qE5bCP6IKl576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770085231&amp;x-signature=buVEsII%2BXoEnPdZquGhYGaWDyVU%3D" alt="" loading="lazy"/></p>
<p>甚至还有人大胆地用ClawdBot进行炒股操作，完全是把它当成一个不知疲倦的助手。</p>
<p>这些场景能实现，靠的就是ClawdBot的这几个核心能力：</p>
<ul>
<li><strong>接管电脑：</strong> 整理文件、发邮件、写代码、修Bug、跑脚本、甚至监控网页价格，它都能直接上手操作。</li>
<li><strong>全平台操控：</strong> 可以控制 WhatsApp、Telegram 甚至 iMessage 发个指令，家里的电脑就开始干活了。</li>
<li><strong>永久记忆：</strong> 无论是多久的记忆，它都能记住。</li>
<li><strong>自我进化：</strong> 丢给它一个新的API文档，它能自己写代码学会新技能，或者直接写Skill。</li>
<li><strong>拥有完整的系统访问权限：</strong> 可以执行终端命令、编写脚本、安装技能</li>
<li><strong>支持任意模型：</strong> 可使用任何 LLM 提供商（Claude、GPT、Gemini、DeepSeek、Perplexity）</li>
</ul>
<p>那要如何使用这个现象级的产品呢？</p>
<p>首先，进入Clawdbot的官网。</p>
<p>传送门：<a href="https://link.juejin.cn?target=https%3A%2F%2Fclawd.bot%2F" target="_blank" title="https://clawd.bot/" ref="nofollow noopener noreferrer">clawd.bot/</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/04002bd2b52840e4ab4822257ecf4e9e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD55qE5bCP6IKl576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770085231&amp;x-signature=D7gmwLN7zvfIUk3m482DzuJ1pic%3D" alt="" loading="lazy"/></p>
<p>里面有需要的安装命令行，这里以苹果电脑为例。</p>
<p>然后，打开你的终端（Terminal），输入以下命令把项目克隆下来，</p>
<p>脚本会自动处理大部分事情，你只需要跟着提示走就行。</p>
<pre><code class="hljs language-arduino" lang="arduino">
curl -fsSL https:<span class="hljs-comment">//clawd.bot/install.sh | bash</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd9cb5e950ca42228c3c74596284ff1d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD55qE5bCP6IKl576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770085231&amp;x-signature=6ELVITfUBcX0Jguq7VGdumDgCDw%3D" alt="" loading="lazy"/></p>
<p>安装完成后，会让你选择用哪个模型。是Claude、GPT还是其他的？根据你的需求选就行。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc52c14432724f44bd8cf93708d15597~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD55qE5bCP6IKl576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770085231&amp;x-signature=2bpClsdyLG4Xva0DaSmXQkuooZU%3D" alt="" loading="lazy"/></p>
<p>选择好模型后，会让你填入你的API Key，因为它适配任何模型，所以你只需要去申请一个API Key就行。</p>
<p>看我文章的朋友都知道，我经常使用0011.ai，这是个CC和Codex的中转，这里就不详细给大家介绍了，感兴趣的可以看我之前的文章。</p>
<p>传送门：<a href="https://link.juejin.cn?target=https%3A%2F%2F0011.ai%2Fi%2FAIG" target="_blank" title="https://0011.ai/i/AIG" ref="nofollow noopener noreferrer">0011.ai/i/AIG</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1992313721415046720" target="_blank" title="https://zhuanlan.zhihu.com/p/1992313721415046720" ref="nofollow noopener noreferrer">手把手教你在国内使用 Claude Code：不封号、不折腾、比官网更便宜</a><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe8a27664bb24e63b0d950d9836c983c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD55qE5bCP6IKl576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770085231&amp;x-signature=Ct2uqHy5xRP65Ih%2FCx3F1hWtVsI%3D" alt="" loading="lazy"/></p>
<p>这边我们将我们的API key直接贴进去。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/402a2a27928e45f984c1a86598c351b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD55qE5bCP6IKl576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770085231&amp;x-signature=s%2B91D0IkZRKANW9b3ybPWVo8P9U%3D" alt="" loading="lazy"/></p>
<p><strong>再连接聊天软件，</strong> 这是Clawdbot的灵魂！你需要配置 <strong>Gateway，也可以选择通过。</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ec4ae9a8f434b489350aaaee7ed8c65~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD55qE5bCP6IKl576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770085231&amp;x-signature=%2B1R%2BftD5hhEN0C4wp%2Bifm0qvA6Y%3D" alt="" loading="lazy"/></p>
<p>在配置文件中，填入你的Telegram Bot Token或者Twilio（用于WhatsApp）的凭证，这样你才能在手机上远程指挥它。</p>
<p>随后会让你选择Skills，比如"每天早上7点自动拉取新闻"或"监控某个网站价格"。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ae8467b0b5148da905d9fd59e6fb601~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD55qE5bCP6IKl576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770085231&amp;x-signature=vLsRS2Odv2ToxiPpda4HaKEFNt4%3D" alt="" loading="lazy"/></p>
<p>这一步是选择聊天方式，如果你是小白，建议选择第二个。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/11196790a7e140eda073b34ac8895e82~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD55qE5bCP6IKl576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770085231&amp;x-signature=PRSCg75DcWt8PPiuESUjEvWfbFM%3D" alt="" loading="lazy"/></p>
<p>最后，你就可以在这里和你的Bot聊天啦！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da32ff82bb45482ca0700b5686b57a5b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD55qE5bCP6IKl576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770085231&amp;x-signature=WP6erFzKuBR4K94Svai%2FBjlDdZI%3D" alt="" loading="lazy"/></p>
<p>这里有一个大家普遍都会担心的问题，就是Token消耗嘎嘎快，ClawdBot要一直运行、主动思考、保持对话历史。</p>
<p><strong>所以比普通chatbot费token很多</strong>，<strong>也就是说很费钱，</strong> 如果担心成本，可以在配置里调整刷新频率，或改用便宜点的模型。</p>
<p>另外一个担忧是数据安全。</p>
<p>前美国安全专家Chad Nelson称， Clawdbot读取的每一份文档、电子邮件和网页都可能成为攻击媒介，“这类工具的广泛应用，将彻底损害个人隐私与安全”。</p>
<p>SEO创企Letsrank创始人fmd 认为，“ <strong>Clawdbot正在引发一场灾难</strong>”。若在VPS实例上托管Clawdbot的趋势持续，加上人们不看文档、无认证开放端口，很快就会出现大规模凭证泄露，“后果不堪设想”。</p>
<p>欢迎在评论区一起讨论！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用 Claude Code 撰写技术文档并配图的基础教程]]></title>    <link>https://juejin.cn/post/7599496293174886419</link>    <guid>https://juejin.cn/post/7599496293174886419</guid>    <pubDate>2026-01-26T16:07:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599496293174886419" data-draft-id="7599511763987595318" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用 Claude Code 撰写技术文档并配图的基础教程"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-26T16:07:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="白小纯2025"/> <meta itemprop="url" content="https://juejin.cn/user/3861943706468039"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用 Claude Code 撰写技术文档并配图的基础教程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3861943706468039/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    白小纯2025
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T16:07:15.000Z" title="Mon Jan 26 2026 16:07:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">使用 Claude Code 撰写技术文档并配图的基础教程</h2>
<ul>
<li>前置学习教程<a href="https://juejin.cn/post/7596687697756127242" target="_blank" title="https://juejin.cn/post/7596687697756127242">cladue code</a></li>
<li>前置学习教程<a href="https://juejin.cn/post/7599531732337262626" target="_blank" title="https://juejin.cn/post/7599531732337262626">agent skills</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FJimLiu%2Fbaoyu-skills.git" target="_blank" title="https://github.com/JimLiu/baoyu-skills.git" ref="nofollow noopener noreferrer">skills工具链接</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FJimLiu%2Fbaoyu-skills%2Fblob%2Fmain%2FREADME.zh.md" target="_blank" title="https://github.com/JimLiu/baoyu-skills/blob/main/README.zh.md" ref="nofollow noopener noreferrer">安装教程</a></li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a928f2645a6841fbba3924fa1a1b884a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m95bCP57qvMjAyNQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770049949&amp;x-signature=1hy7hq9x7k%2Fv19ng9KyclQ092A4%3D" alt="01-scene-cover.png" loading="lazy"/></p>
<blockquote>
<p>本教程面向熟悉命令行和基本开发工具的开发者，介绍如何利用 Claude Code 高效撰写技术文档，并使用 <code>baoyu-article-illustrator</code> 技能为文章智能配图。</p>
</blockquote>
<h3 data-id="heading-1">前置准备</h3>
<p>确保你已经：</p>
<ul>
<li>安装并配置好 Claude Code CLI</li>
<li>拥有可用的 API 密钥</li>
<li>具备以下技能：
<ul>
<li><code>baoyu-article-illustrator</code>（文章配图技能）</li>
<li><code>baoyu-image-gen</code>（底层图片生成能力，被 article-illustrator 调用）</li>
</ul>
</li>
</ul>
<h3 data-id="heading-2">工具链关系</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b259aa0e23c48af9d4e42b011411ee1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m95bCP57qvMjAyNQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770049949&amp;x-signature=2yVUk21QGsHcD1buQjPttCwG%2F%2BE%3D" alt="02-framework-toolchain.png" loading="lazy"/></p>
<ul>
<li><strong>baoyu-article-illustrator</strong>：分析文章结构，识别需要配图的位置，决定图片类型和风格</li>
<li><strong>baoyu-image-gen</strong>：执行实际的图片生成任务</li>
</ul>
<h3 data-id="heading-3">第一部分：用 Claude Code 写技术文档</h3>
<h4 data-id="heading-4">1.1 基本工作流程</h4>
<p>Claude Code 写文档的核心优势在于它能够：</p>
<ul>
<li>直接读取代码库理解上下文</li>
<li>根据代码自动生成准确的文档</li>
<li>保持文档与代码的一致性</li>
</ul>
<p><strong>启动方式：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 在项目目录中启动 Claude Code</span>
<span class="hljs-built_in">cd</span> your-project
claude
</code></pre>
<h4 data-id="heading-5">1.2 常用文档撰写命令示例</h4>
<h5 data-id="heading-6">为代码生成文档</h5>
<pre><code class="hljs language-bash" lang="bash">请为 src/utils/auth.ts 文件生成 API 文档
</code></pre>
<h5 data-id="heading-7">创建项目 README</h5>
<pre><code class="hljs language-diff" lang="diff">分析当前项目结构，帮我撰写一份 README.md，包含：
<span class="hljs-deletion">- 项目简介</span>
<span class="hljs-deletion">- 安装步骤</span>
<span class="hljs-deletion">- 使用示例</span>
<span class="hljs-deletion">- 配置说明</span>
</code></pre>
<h5 data-id="heading-8">撰写教程类文档</h5>
<pre><code class="hljs language-css" lang="css">帮我写一篇关于 <span class="hljs-selector-attr">[主题]</span> 的技术教程，目标读者是 <span class="hljs-selector-attr">[描述]</span>，
重点讲解 <span class="hljs-selector-attr">[要点1]</span>、<span class="hljs-selector-attr">[要点2]</span>、<span class="hljs-selector-attr">[要点3]</span>
</code></pre>
<h4 data-id="heading-9">1.3 提升文档质量的技巧</h4>

























<table><thead><tr><th>技巧</th><th>说明</th></tr></thead><tbody><tr><td>提供上下文</td><td>告诉 Claude 目标读者是谁、技术水平如何</td></tr><tr><td>明确结构</td><td>预先说明你希望的文档结构（章节、格式）</td></tr><tr><td>迭代修改</td><td>生成后可以针对具体段落要求修改</td></tr><tr><td>结合代码</td><td>让 Claude 先读取相关代码再写文档</td></tr></tbody></table>
<h3 data-id="heading-10">第二部分：使用 baoyu-article-illustrator 智能配图</h3>
<h4 data-id="heading-11">2.1 技能简介</h4>
<p><code>baoyu-article-illustrator</code> 是一个智能文章配图技能，核心能力：</p>
<ul>
<li><strong>自动分析文章结构</strong>：识别标题、段落、关键概念</li>
<li><strong>智能识别配图位置</strong>：判断哪些地方需要视觉辅助</li>
<li><strong>Type × Style 二维配图法</strong>：根据内容类型和期望风格生成最合适的图片</li>
<li><strong>调用底层 baoyu-image-gen</strong>：实际图片生成由底层能力完成</li>
</ul>
<h4 data-id="heading-12">2.2 基本使用方法</h4>
<h5 data-id="heading-13">方式一：一键为文章配图（推荐）</h5>
<pre><code class="hljs language-bash" lang="bash">/baoyu-article-illustrator
</code></pre>
<p>或者用自然语言：</p>
<pre><code class="hljs language-css" lang="css">为文章配图
请给这篇文章添加插图
illustrate <span class="hljs-selector-tag">article</span>
</code></pre>
<h5 data-id="heading-14">方式二：指定文章路径</h5>
<pre><code class="hljs language-css" lang="css">/baoyu-<span class="hljs-selector-tag">article</span>-illustrator path/<span class="hljs-selector-tag">to</span>/your-<span class="hljs-selector-tag">article</span><span class="hljs-selector-class">.md</span>
</code></pre>
<h4 data-id="heading-15">2.3 Type × Style 二维配图法</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca7dcdbf01df45738e55679bd7a619e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m95bCP57qvMjAyNQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770049949&amp;x-signature=jHOBJhgudXV%2FOxHNKsI1wSMKFFs%3D" alt="03-framework-type-style.png" loading="lazy"/></p>
<p>这是 <code>baoyu-article-illustrator</code> 的核心方法论：</p>




















<table><thead><tr><th>维度</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><strong>Type（类型）</strong></td><td>图片要表达什么</td><td>概念图、流程图、场景图、对比图</td></tr><tr><td><strong>Style（风格）</strong></td><td>视觉呈现方式</td><td>扁平插画、3D渲染、手绘风、科技感</td></tr></tbody></table>
<p><strong>组合示例（以本教程为例）：</strong></p>





























<table><thead><tr><th>文章内容</th><th>Type</th><th>Style</th><th>配图效果</th></tr></thead><tbody><tr><td>工具链关系</td><td>架构图</td><td>扁平插画</td><td>展示两个工具的调用关系</td></tr><tr><td>Type × Style 方法</td><td>概念图</td><td>信息图表</td><td>二维矩阵示意图</td></tr><tr><td>完整工作流</td><td>流程图</td><td>科技感</td><td>写作→配图→迭代的流程</td></tr></tbody></table>
<h4 data-id="heading-16">2.4 文档配图的完整工作流（以本教程为例）</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3453261ba2643f4932ec08dd945650d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m95bCP57qvMjAyNQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770049949&amp;x-signature=Id4xoHVcsMgBqBudmpsA1F%2F%2F7vc%3D" alt="04-flowchart-workflow.png" loading="lazy"/></p>
<pre><code class="hljs language-makefile" lang="makefile">步骤 1: 撰写文档
────────────────────
<span class="hljs-section">你: 帮我写一篇用 Claude Code 写技术文档并配图的基础教程，</span>
    面向有基础的开发者

<span class="hljs-section">Claude: [生成本教程内容...]</span>

步骤 2: 智能配图（一条命令搞定）
────────────────────
<span class="hljs-section">你: /baoyu-article-illustrator</span>

<span class="hljs-section">Claude:</span>
  - 分析文章结构...
  - 识别到 4 处适合配图的位置：
    1. 开头：需要一张封面图（程序员与 AI 协作写作场景）
    2. <span class="hljs-string">"工具链关系"</span>：需要架构示意图
    3. <span class="hljs-string">"Type × Style 二维配图法"</span>：需要概念解释图
    4. <span class="hljs-string">"完整工作流"</span>：需要流程图
  - 调用 baoyu-image-gen 生成图片...
  - 将图片插入文档对应位置

步骤 3: 微调（可选）
────────────────────
<span class="hljs-section">你: 封面图换成更有科技感的风格</span>

<span class="hljs-section">Claude: [重新生成并替换...]</span>
</code></pre>
<h3 data-id="heading-17">第三部分：实战示例（以本教程为例）</h3>
<h4 data-id="heading-18">3.1 完整对话示例</h4>
<p>以下是创作本教程的实际对话流程：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">你:</span> <span class="hljs-string">帮我写一篇用</span> <span class="hljs-string">Claude</span> <span class="hljs-string">Code</span> <span class="hljs-string">写技术文档，然后使用</span> <span class="hljs-string">baoyu-article-illustrator</span>
    <span class="hljs-string">给文章配图的基础教程，面向有基础的开发者</span>

<span class="hljs-attr">Claude:</span> <span class="hljs-string">在开始写这篇教程之前，我想先确认几个问题...</span>
        [<span class="hljs-string">询问目标读者、输出形式等</span>]

<span class="hljs-string">你:</span> <span class="hljs-string">有基础的开发者，创建</span> <span class="hljs-string">Markdown</span> <span class="hljs-string">文件</span>

<span class="hljs-attr">Claude:</span> [<span class="hljs-string">生成教程内容，创建</span> <span class="hljs-string">claude-code-writing-tutorial.md</span>]

<span class="hljs-string">你:</span> <span class="hljs-string">/baoyu-article-illustrator</span>

<span class="hljs-attr">Claude:</span>
  <span class="hljs-string">分析文章结构完成，识别到以下配图位置：</span>

  <span class="hljs-number">1</span><span class="hljs-string">.</span> <span class="hljs-string">文章封面</span> <span class="hljs-bullet">-</span> <span class="hljs-attr">Type:</span> <span class="hljs-string">主题图</span> <span class="hljs-string">|</span> <span class="hljs-attr">Style:</span> <span class="hljs-string">科技感</span>
     <span class="hljs-string">描述：程序员在终端与</span> <span class="hljs-string">AI</span> <span class="hljs-string">协作撰写文档的场景</span>

  <span class="hljs-number">2</span><span class="hljs-string">.</span> <span class="hljs-string">"工具链关系"</span> <span class="hljs-bullet">-</span> <span class="hljs-attr">Type:</span> <span class="hljs-string">架构图</span> <span class="hljs-string">|</span> <span class="hljs-attr">Style:</span> <span class="hljs-string">扁平插画</span>
     <span class="hljs-string">描述：两个技能的调用关系示意图</span>

  <span class="hljs-number">3</span><span class="hljs-string">.</span> <span class="hljs-string">"Type × Style 二维配图法"</span> <span class="hljs-bullet">-</span> <span class="hljs-attr">Type:</span> <span class="hljs-string">概念图</span> <span class="hljs-string">|</span> <span class="hljs-attr">Style:</span> <span class="hljs-string">信息图表</span>
     <span class="hljs-string">描述：二维矩阵展示类型和风格的组合</span>

  <span class="hljs-number">4</span><span class="hljs-string">.</span> <span class="hljs-string">"完整工作流"</span> <span class="hljs-bullet">-</span> <span class="hljs-attr">Type:</span> <span class="hljs-string">流程图</span> <span class="hljs-string">|</span> <span class="hljs-attr">Style:</span> <span class="hljs-string">简洁现代</span>
     <span class="hljs-string">描述：写作→配图→迭代的三步流程</span>

  <span class="hljs-string">开始生成图片...</span>
  [<span class="hljs-string">调用</span> <span class="hljs-string">baoyu-image-gen</span> <span class="hljs-string">生成</span> <span class="hljs-number">4</span> <span class="hljs-string">张图片...</span>]

  <span class="hljs-string">配图完成，已插入文档。</span>

<span class="hljs-string">你:</span> <span class="hljs-string">封面图的背景换成深色科技风</span>

<span class="hljs-attr">Claude:</span> [<span class="hljs-string">重新生成封面图并替换...</span>]
</code></pre>
<h4 data-id="heading-19">3.2 配图类型参考</h4>






























<table><thead><tr><th>文章类型</th><th>推荐 Type</th><th>推荐 Style</th></tr></thead><tbody><tr><td>技术教程</td><td>流程图、步骤图</td><td>扁平插画、信息图表</td></tr><tr><td>概念解释</td><td>概念图、类比图</td><td>简洁图示、手绘风</td></tr><tr><td>产品介绍</td><td>场景图、功能图</td><td>3D渲染、产品风</td></tr><tr><td>最佳实践</td><td>对比图、清单图</td><td>专业商务、简约风</td></tr></tbody></table>
<h4 data-id="heading-20">3.3 过程图示</h4>
<ul>
<li>输入文章要求</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">claude <span class="hljs-string">"帮我写一篇用 Claude Code 写技术文档，然后使用 baoyu-article-illustrator给文章配图的基础教程，面向有基础的开发者"</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/12e5cedb033e4b8abbdf3ca687d4a7ab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m95bCP57qvMjAyNQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770049949&amp;x-signature=dghZZV2xKR%2BQFRc8%2FRKJzq2Rmqw%3D" alt="ab905d8016bf3f521a57ac7c9eec8c63.png" loading="lazy"/></p>
<ul>
<li>开始规划配图</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">/baoyu-article-illustrator /Users/zhangjian/works/workspace_vibe/skills_md/write_article_with_cc/claude-code-writing-tutorial.md
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ecb1afb9df44fac913995be0e9e5ceb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m95bCP57qvMjAyNQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770049949&amp;x-signature=l%2FPYuAFdDaesLiVhlGCXnj6ljIk%3D" alt="3b465947e002f580173b409e425da548.png" loading="lazy"/></p>
<ul>
<li>文生图国产模型配置</li>
</ul>
<p>注意原始的工具是不支持国产模型【默认支持OPENAI及GOOGLE的文生图模型】，这里我做了改造，增加了阿里云的【通义-文生图-Z-Image，单模型白嫖额度100张图片，如下图，还有其他模型，可以修改环境变量调整【~/.baoyu-skills/.env中增加DASHSCOPE_IMAGE_MODEL=z-image-turbo】】支持<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FJianJang2017%2Fbaoyu-skills.git" target="_blank" title="https://github.com/JianJang2017/baoyu-skills.git" ref="nofollow noopener noreferrer">改造后代码</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa5d419326064106819052191736c5c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m95bCP57qvMjAyNQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770049949&amp;x-signature=wFQiXH2SqzUkbeDKmZdGfmNNY70%3D" alt="image.png" loading="lazy"/></p>
<ol>
<li>替换生图技能【baoyu-image-gen】中的文件内容【这里也可以手动直接安装我fork过来的版本，修改内容已提交】
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02a49ca3a0cd4889a0319000d5bad039~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m95bCP57qvMjAyNQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770049949&amp;x-signature=4hD4J%2BvtHavs27QF1fX4a%2Bh3Oyw%3D" alt="image.png" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a1fa0882f5cc47c3a040dfc38296e2ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m95bCP57qvMjAyNQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770049949&amp;x-signature=4qsyYemFENb5ZfyURsMXQUet0UU%3D" alt="image.png" loading="lazy"/></li>
<li>新增阿里云模型配置apikey
创建用户环境变量</li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> ~/.baoyu-skills
</code></pre>
<p>增加apikey配置【在~/.baoyu-skills】目录下创建.env文件内容如下【对应的api key从阿里云百炼平台获取】：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment">#指定模型</span>
DASHSCOPE_IMAGE_MODEL=z-image-turbo
<span class="hljs-comment">#指定api key</span>
DASHSCOPE_API_KEY=sk-xxxxxxxxxxx
</code></pre>
<ol start="4">
<li>图片prompt生成</li>
</ol>
<p>baoyu-article-illustrator会根据文章内容进行分析然后生成插图规划，然后根据规划生成对应的文生图prompt
5. prompt生成后会调用baoyu-image-gen按照规划的图片prompt进行图片生成</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/36378d9550f34ada89c4419cb29a6f44~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m95bCP57qvMjAyNQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770049949&amp;x-signature=B9tqFLYwkwnd%2Bgm8QdA%2FFLDgv70%3D" alt="4e0c9afab11d9c2cba2ee7abc8ea2c00.png" loading="lazy"/>
6. 生产完成后会将图片插入预定的位置</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4659b224052c427a990cf1995875d30f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m95bCP57qvMjAyNQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770049949&amp;x-signature=4HT7IVnabmVMdbL5asuklPblr0k%3D" alt="dd3e992868d2f5c47be3fa012871a77e.png" loading="lazy"/></p>
<ol start="7">
<li>注意：有时候会未自动插入，干预提示一下即可，也可根据文件目录下的outline.md文件内容进行手动粘贴</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b4ff9eef6a0243ce899d713b87eb2f44~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m95bCP57qvMjAyNQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770049949&amp;x-signature=qdWciB2Q6uKNudeIQyHTJX%2Fq42M%3D" alt="image.png" loading="lazy"/>
8. 效果截图</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d084461e14d471c916a7b36743f26f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m95bCP57qvMjAyNQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770049949&amp;x-signature=ZNYNi1IuV6siHejO%2BZttZYdaS9E%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-21">常见问题</h3>
<h4 data-id="heading-22">Q: baoyu-article-illustrator 和 baoyu-image-gen 有什么区别？</h4>
<p>A: <code>baoyu-article-illustrator</code> 是面向用户的智能配图技能，会分析文章并决定在哪里配什么图；<code>baoyu-image-gen</code> 是底层的图片生成能力，被前者调用来实际生成图片。一般情况下，直接使用 <code>baoyu-article-illustrator</code> 即可。</p>
<h4 data-id="heading-23">Q: 生成的图片保存在哪里？</h4>
<p>A: 默认保存在当前工作目录或文章所在目录。</p>
<h4 data-id="heading-24">Q: 可以只为文章的某一部分配图吗？</h4>
<p>A: 可以，在调用时指定具体位置，如："只为'工具链关系'这一节配图"。</p>
<h4 data-id="heading-25">Q: 如何修改已生成的图片风格？</h4>
<p>A: 直接描述你的修改需求，如："把封面图换成 3D 风格"，Claude 会重新生成并替换。</p>
<h4 data-id="heading-26">Q: 支持哪些图片风格？</h4>
<p>A: 支持扁平插画、3D渲染、手绘风、科技感、简约风、信息图表等多种风格，可根据文章调性自由选择。</p>
<h3 data-id="heading-27">总结</h3>
<p>Claude Code + baoyu-article-illustrator 的组合让技术文档创作变得高效：</p>
<ol>
<li><strong>写作阶段</strong>：利用 Claude 对代码的理解能力，生成准确的技术文档</li>
<li><strong>配图阶段</strong>：一条命令智能分析 + 自动配图，无需手动指定每张图</li>
<li><strong>迭代优化</strong>：在对话中持续调整，直到满意为止</li>
</ol>
<p><strong>工具链优势：</strong></p>
<ul>
<li><code>baoyu-article-illustrator</code> 负责"思考"：分析文章、决定配图策略</li>
<li><code>baoyu-image-gen</code> 负责"执行"：生成高质量图片</li>
</ul>
<p>掌握这套工作流，可以大幅提升技术文档的创作效率和视觉质量。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Linux 实战】手把手写 Makefile：静态库 / 动态库一键编译（附可直接套用的计算器实战模板）]]></title>    <link>https://juejin.cn/post/7599581687357915186</link>    <guid>https://juejin.cn/post/7599581687357915186</guid>    <pubDate>2026-01-27T01:04:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599581687357915186" data-draft-id="7599538010725761051" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Linux 实战】手把手写 Makefile：静态库 / 动态库一键编译（附可直接套用的计算器实战模板）"/> <meta itemprop="keywords" content="后端,GitHub,Linux"/> <meta itemprop="datePublished" content="2026-01-27T01:04:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小杨同学66"/> <meta itemprop="url" content="https://juejin.cn/user/1189004976589664"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Linux 实战】手把手写 Makefile：静态库 / 动态库一键编译（附可直接套用的计算器实战模板）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1189004976589664/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小杨同学66
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T01:04:44.000Z" title="Tue Jan 27 2026 01:04:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">【Linux 实战】手把手写 Makefile：静态库 / 动态库一键编译（附可直接套用的计算器实战模板）</h2>
<p>大家好，我是专注嵌入式 Linux 开发的小杨同学。对于 Linux C/C++ 开发来说，Makefile 是绕不开的核心工具 —— 尤其是在构建包含静态库 / 动态库的项目时，一份好的 Makefile 能让你摆脱重复敲编译命令的繁琐，实现 “一键编译、一键清理、一键安装”。今天就以四则运算计算器项目为例，拆解两份实战型 Makefile（静态库版 + 动态库版），从变量定义到规则编写，每一行都讲透，新手也能直接套用！</p>
<h3 data-id="heading-1">一、先理清核心需求：计算器项目的 Makefile 要实现什么？</h3>
<p>我们的目标是基于标准化目录结构（1src/2include/3lib/0output），用 Makefile 完成：</p>
<ol>
<li>自动编译所有源文件为目标文件（.o）并放入 3lib 目录；</li>
<li>将目标文件打包为静态库（libcal.a）或动态库（libcal.so）；</li>
<li>链接库文件生成可执行文件，输出到 0output 目录；</li>
<li>提供清理、安装（动态库）等便捷指令，简化开发流程。</li>
</ol>
<h4 data-id="heading-2">项目目录回顾</h4>
<p>plaintext</p>
<pre><code class="hljs language-php" lang="php">calc_project/
├── <span class="hljs-number">0</span>output/       <span class="hljs-comment"># 可执行文件输出目录</span>
├── <span class="hljs-number">1</span>src/          <span class="hljs-comment"># 源代码目录（Add.c/mul.c/sub.c/div.c/utils.c/main.c）</span>
├── <span class="hljs-number">2</span><span class="hljs-keyword">include</span>/      <span class="hljs-comment"># 头文件目录（各模块.h文件）</span>
└── <span class="hljs-number">3</span>lib/          <span class="hljs-comment"># 库文件/目标文件目录</span>
</code></pre>
<h3 data-id="heading-3">二、实战 1：静态库版 Makefile（适合嵌入式资源受限场景）</h3>
<p>静态库的优势是可执行文件不依赖外部库，直接运行，非常适合嵌入式设备。以下是完整的静态库 Makefile，附带逐行解析：</p>
<h4 data-id="heading-4">完整静态库 Makefile 代码</h4>
<p>makefile</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-comment"># 核心编译参数：集中定义，便于统一修改</span>
CFLAGS = -Wall -g -O2 -I ./2include
<span class="hljs-comment"># 可执行文件名称</span>
calc_target = calculator          
<span class="hljs-comment"># 库模块源文件列表</span>
calc_srcs = 1src/Add.c 1src/mul.c 1src/sub.c 1src/div.c 1src/utils.c
<span class="hljs-comment"># 目标文件列表（对应3lib目录下的.o文件）</span>
calc_lib_objs = 3lib/Add.o 3lib/mul.o 3lib/sub.o 3lib/div.o 3lib/utils.o
<span class="hljs-comment"># 静态库名称</span>
calc_static_lib = 3lib/libcal.a 

<span class="hljs-comment"># 默认目标：执行make时优先编译计算器可执行文件</span>
<span class="hljs-section">all: <span class="hljs-variable">$(calc_target)</span></span>
	@echo <span class="hljs-string">"✅ 计算器编译完成！可执行文件：0output/calculator"</span>

<span class="hljs-comment"># 通用规则：将1src下的.c文件编译为3lib下的.o文件</span>
<span class="hljs-section">3lib/%.o: 1src/%.c</span>
	gcc <span class="hljs-variable">$(CFLAGS)</span> -c <span class="hljs-variable">$&lt;</span> -o <span class="hljs-variable">$@</span>

<span class="hljs-comment"># 编译静态库：先确保3lib目录存在，再打包所有.o文件</span>
<span class="hljs-variable">$(calc_static_lib)</span>: <span class="hljs-variable">$(calc_lib_objs)</span>
	mkdir -p 3lib  <span class="hljs-comment"># 若3lib目录不存在则创建</span>
	ar rcs <span class="hljs-variable">$@</span> <span class="hljs-variable">$^</span>   <span class="hljs-comment"># r=替换旧文件 c=创建库 s=生成索引</span>

<span class="hljs-comment"># 编译可执行文件：链接静态库，输出到0output目录</span>
<span class="hljs-variable">$(calc_target)</span>: <span class="hljs-variable">$(calc_static_lib)</span>
	mkdir -p 0output  <span class="hljs-comment"># 确保输出目录存在</span>
	gcc <span class="hljs-variable">$(CFLAGS)</span> 1src/main.c <span class="hljs-variable">$(calc_static_lib)</span> -o 0output/<span class="hljs-variable">$(calc_target)</span>

<span class="hljs-comment"># 清理规则：删除所有编译产物</span>
<span class="hljs-section">clean:</span>
	rm -rf 3lib/*.o 3lib/*.a 0output/*
	@echo <span class="hljs-string">"🗑️  计算器产物清理完成"</span>

<span class="hljs-comment"># 声明伪目标：避免与同名文件冲突</span>
<span class="hljs-meta"><span class="hljs-keyword">.PHONY</span>: all clean</span>
</code></pre>
<h4 data-id="heading-5">关键解析（新手必看）</h4>
<ol>
<li>
<p><strong>变量定义</strong>：把编译参数、文件名、路径都定义为变量，后续修改只需改变量值（比如换编译器、改库名），无需逐行改规则；</p>
<ul>
<li><code>CFLAGS</code>参数说明：<code>-Wall</code>显示所有警告、<code>-g</code>生成调试信息、<code>-O2</code>优化编译、<code>-I ./2include</code>指定头文件路径；</li>
</ul>
</li>
<li>
<p><strong>通用规则<code>3lib/%.o: 1src/%.c</code></strong>：</p>
<ul>
<li><code>%</code>是通配符，匹配任意文件名（比如 Add、mul）；</li>
<li><code>$&lt;</code>代表 “依赖项”（即 1src 下的.c 文件），<code>$@</code>代表 “目标项”（即 3lib 下的.o 文件）；</li>
<li>这条规则能自动匹配所有 1src 下的.c 文件，无需为每个文件写单独的编译规则；</li>
</ul>
</li>
<li>
<p><strong>静态库打包命令<code>ar rcs</code></strong>：嵌入式开发必备，<code>ar</code>是静态库打包工具，<code>rcs</code>组合参数能快速生成可用的静态库；</p>
</li>
<li>
<p><strong>伪目标<code>.PHONY</code></strong>：声明<code>all</code>和<code>clean</code>是 “伪目标”（不是实际文件），避免项目中存在同名文件时，Make 误判 “目标已更新”。</p>
</li>
</ol>
<h4 data-id="heading-6">静态库 Makefile 使用方法</h4>
<p>bash</p>
<p>运行</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 一键编译静态库+可执行文件</span>
make

<span class="hljs-comment"># 运行可执行文件</span>
./0output/calculator

<span class="hljs-comment"># 一键清理所有编译产物</span>
make clean
</code></pre>
<h3 data-id="heading-7">三、实战 2：动态库版 Makefile（支持系统级安装）</h3>
<p>动态库的优势是节省内存（多个程序共享一份库），适合需要灵活更新的场景。这份 Makefile 新增了 “安装动态库到系统目录” 的规则，解决动态库运行时路径问题：</p>
<h4 data-id="heading-8">完整动态库 Makefile 代码</h4>
<p>makefile</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-comment"># 核心编译参数</span>
CFLAGS = -Wall -g -O2 -I ./2include
<span class="hljs-comment"># 可执行文件名称</span>
calc_target = calculator          
<span class="hljs-comment"># 库模块源文件列表</span>
calc_srcs = 1src/Add.c 1src/mul.c 1src/sub.c 1src/div.c 1src/utils.c
<span class="hljs-comment"># 目标文件列表</span>
calc_lib_objs = 3lib/Add.o 3lib/mul.o 3lib/sub.o 3lib/div.o 3lib/utils.o
<span class="hljs-comment"># 动态库名称</span>
calc_dynamic_lib = 3lib/libcal.so
<span class="hljs-comment"># 系统库目录（动态库安装路径）</span>
sys_lib_dir = /usr/lib      
<span class="hljs-comment"># 链接库时的简写名称（-lcal 对应 libcal.so）</span>
lib_name = -lcal

<span class="hljs-comment"># 默认目标：先编译动态库，再编译可执行文件</span>
<span class="hljs-section">all: <span class="hljs-variable">$(calc_dynamic_lib)</span> <span class="hljs-variable">$(calc_target)</span></span>
	@echo <span class="hljs-string">"✅ 计算器编译完成！可执行文件：0output/calculator"</span>

<span class="hljs-comment"># 通用规则：编译3lib下的.o文件</span>
<span class="hljs-section">3lib/%.o: 1src/%.c</span>
	gcc <span class="hljs-variable">$(CFLAGS)</span> -c <span class="hljs-variable">$&lt;</span> -o <span class="hljs-variable">$@</span>

<span class="hljs-comment"># 编译动态库：-fPIC生成位置无关代码，-shared指定动态库</span>
<span class="hljs-variable">$(calc_dynamic_lib)</span>: <span class="hljs-variable">$(calc_lib_objs)</span>
	mkdir -p 3lib
	gcc <span class="hljs-variable">$(CFLAGS)</span> -fPIC -shared -o <span class="hljs-variable">$@</span> <span class="hljs-variable">$^</span>

<span class="hljs-comment"># 安装动态库到系统目录：解决运行时库路径问题</span>
<span class="hljs-section">install: <span class="hljs-variable">$(calc_dynamic_lib)</span></span>
	sudo cp <span class="hljs-variable">$(calc_dynamic_lib)</span> <span class="hljs-variable">$(sys_lib_dir)</span>
	sudo ldconfig  <span class="hljs-comment"># 刷新系统库缓存</span>
	@echo <span class="hljs-string">"✅ 动态库已安装到 <span class="hljs-variable">$(sys_lib_dir)</span>，系统已刷新缓存"</span>

<span class="hljs-comment"># 清除3lib目录所有文件（比clean更彻底）</span>
<span class="hljs-section">clear:</span>
	rm -rf 3lib/*
	@echo <span class="hljs-string">"🗑️  3lib目录下所有文件已清除！"</span>

<span class="hljs-comment"># 编译可执行文件：链接动态库</span>
<span class="hljs-variable">$(calc_target)</span>: <span class="hljs-variable">$(calc_dynamic_lib)</span>
	mkdir -p 0output
	gcc <span class="hljs-variable">$(CFLAGS)</span> 1src/main.c -L3lib <span class="hljs-variable">$(lib_name)</span> -o 0output/<span class="hljs-variable">$(calc_target)</span>

<span class="hljs-comment"># 清理规则：删除.o、.so和可执行文件</span>
<span class="hljs-section">clean:</span>
	rm -rf 3lib/*.o 3lib/*.so 0output/*
	@echo <span class="hljs-string">"🗑️  计算器产物清理完成"</span>

<span class="hljs-comment"># 声明伪目标</span>
<span class="hljs-meta"><span class="hljs-keyword">.PHONY</span>: all clean clear install</span>
</code></pre>
<h4 data-id="heading-9">动态库核心差异解析</h4>
<ol>
<li>
<p><strong>动态库编译参数</strong>：</p>
<ul>
<li><code>-fPIC</code>：生成位置无关代码（动态库必备，否则无法在内存任意地址加载）；</li>
<li><code>-shared</code>：告诉编译器生成动态库，而非可执行文件；</li>
</ul>
</li>
<li>
<p><strong>安装规则<code>install</code></strong>：</p>
<ul>
<li>将动态库复制到系统默认库目录<code>/usr/lib</code>，解决 “运行时找不到 libcal.so” 的问题；</li>
<li><code>ldconfig</code>：刷新系统库缓存，让系统识别新安装的动态库；</li>
</ul>
</li>
<li>
<p><strong>链接动态库</strong>：<code>-L3lib</code>指定库搜索路径，<code>-lcal</code>简写链接<code>libcal.so</code>（Make 自动补全<code>lib</code>前缀和<code>.so</code>后缀）；</p>
</li>
<li>
<p><strong>新增<code>clear</code>规则</strong>：彻底清空 3lib 目录，适合重新编译时使用。</p>
</li>
</ol>
<h4 data-id="heading-10">动态库 Makefile 使用方法</h4>
<p>bash</p>
<p>运行</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 一键编译动态库+可执行文件</span>
make

<span class="hljs-comment"># 安装动态库到系统（解决运行时依赖）</span>
make install

<span class="hljs-comment"># 运行可执行文件（无需手动配置LD_LIBRARY_PATH）</span>
./0output/calculator

<span class="hljs-comment"># 清理编译产物</span>
make clean

<span class="hljs-comment"># 彻底清空3lib目录</span>
make clear
</code></pre>
<h3 data-id="heading-11">四、避坑指南：Makefile 常见问题解决</h3>
<ol>
<li>
<p><strong>报错 “missing separator. Stop.”</strong> ：</p>
<ul>
<li>原因：规则后的命令行没有用 TAB 开头（用了空格）；</li>
<li>解决：将命令行前的空格替换为 TAB（编辑器需关闭 “TAB 转空格” 功能）；</li>
</ul>
</li>
<li>
<p><strong>动态库运行报错 “找不到 libcal.so”</strong> ：</p>
<ul>
<li>原因：系统未识别动态库路径；</li>
<li>解决：执行<code>make install</code>将库安装到系统目录，或临时配置环境变量<code>export LD_LIBRARY_PATH=./3lib:$LD_LIBRARY_PATH</code>；</li>
</ul>
</li>
<li>
<p><strong>编译时 “找不到头文件”</strong> ：</p>
<ul>
<li>原因：<code>CFLAGS</code>中<code>-I ./2include</code>路径错误；</li>
<li>解决：确认头文件目录路径，确保与项目结构匹配。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-12">五、总结：Makefile 的核心价值与复用技巧</h3>
<ol>
<li>
<p><strong>核心价值</strong>：</p>
<ul>
<li>自动化：替代重复的 gcc 命令，一键完成编译、打包、安装；</li>
<li>可维护：变量集中定义，修改参数无需改遍所有规则；</li>
<li>增量编译：Make 会自动对比文件修改时间，只重新编译变动的文件，提升效率；</li>
</ul>
</li>
<li>
<p><strong>复用技巧</strong>：</p>
<ul>
<li>保留通用规则（如<code>3lib/%.o: 1src/%.c</code>），只需修改变量（源文件、库名、路径）即可适配其他项目；</li>
<li>静态库 / 动态库的核心编译参数固定，可直接复制到其他嵌入式项目中；</li>
<li>新增<code>install</code>/<code>clear</code>等扩展规则，适配不同场景的便捷操作。</li>
</ul>
</li>
</ol>
<p>这份 Makefile 模板可以直接套用到你的 Linux C/C++ 项目中，无论是嵌入式计算器、串口驱动还是其他模块，只需修改变量部分就能快速适配。掌握这些规则后，你就能摆脱 “手动敲编译命令” 的低效模式，真正实现 Linux 开发的自动化！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何通过 Cloudflare Tunnel 更安全的访问 RustFS？]]></title>    <link>https://juejin.cn/post/7599585289946169407</link>    <guid>https://juejin.cn/post/7599585289946169407</guid>    <pubDate>2026-01-27T01:09:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599585289946169407" data-draft-id="7599502282602545215" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何通过 Cloudflare Tunnel 更安全的访问 RustFS？"/> <meta itemprop="keywords" content="Rust"/> <meta itemprop="datePublished" content="2026-01-27T01:09:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="RustFS"/> <meta itemprop="url" content="https://juejin.cn/user/511719423354121"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何通过 Cloudflare Tunnel 更安全的访问 RustFS？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/511719423354121/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    RustFS
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T01:09:50.000Z" title="Tue Jan 27 2026 01:09:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>RustFS 默认通过 <code>9001</code> 端口登录控制台，<code>9000</code> 端口使用 API，为了安全合规，通常采用**启用 HTTPS、反向代理（诸如 nginx、traefik、caddy 等）**的方式来更加安全的使用 RustFS。本文分享一种更加安全的方式，通过 Cloudflare tunnel 来访问你的 RustFS 实例。</p>
<h2 data-id="heading-0">安装 RustFS</h2>
<p>RustFS 支持二进制、Docker 以及 Helm Chart 的安装方式，详细方法可以查看<a href="https://link.juejin.cn?target=https%3A%2F%2Frustfs.com" target="_blank" title="https://rustfs.com" ref="nofollow noopener noreferrer">官网安装指南</a>。将如下内容写入 <code>docker-compose.yml</code> 文件：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">services:</span>
  <span class="hljs-attr">rustfs:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">rustfs/rustfs:latest</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">rustfs</span>
    <span class="hljs-attr">hostname:</span> <span class="hljs-string">rustfs</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">RUSTFS_VOLUMES=/data/rustfs{1...4}</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">RUSTFS_ADDRESS=0.0.0.0:9000</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">RUSTFS_CONSOLE_ENABLE=true</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">RUSTFS_CONSOLE_ADDRESS=0.0.0.0:9001</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">RUSTFS_ACCESS_KEY=rustfsadmin</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">RUSTFS_SECRET_KEY=rustfsadmin</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">RUSTFS_TLS_PATH=/opt/tls</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"9000:9000"</span>  <span class="hljs-comment"># API endpoint</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"9001:9001"</span>  <span class="hljs-comment"># Console</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">data1:/data/rustfs1</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">data2:/data/rustfs2</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">data3:/data/rustfs3</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">data4:/data/rustfs4</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./certs:/opt/tls</span>

    <span class="hljs-attr">networks:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">rustfs</span>

<span class="hljs-attr">networks:</span>
  <span class="hljs-attr">rustfs:</span>
    <span class="hljs-attr">driver:</span> <span class="hljs-string">bridge</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">rustfs</span>

<span class="hljs-attr">volumes:</span>
  <span class="hljs-attr">data1:</span>
  <span class="hljs-attr">data2:</span>
  <span class="hljs-attr">data3:</span>
  <span class="hljs-attr">data4:</span>
</code></pre>
<p>运行如下命令</p>
<pre><code class="hljs">docker compose up -d
</code></pre>
<p>即可安装好一个 RustFS 实例：</p>
<pre><code class="hljs language-bash" lang="bash">docker compose ps
NAME      IMAGE                          COMMAND                  SERVICE   CREATED          STATUS          PORTS
rustfs    rustfs/rustfs:1.0.0-alpha.81   <span class="hljs-string">"/entrypoint.sh rust…"</span>   rustfs    22 minutes ago   Up 22 minutes   0.0.0.0:9000-9001-&gt;9000-9001/tcp, [::]:9000-9001-&gt;9000-9001/tcp
</code></pre>
<h2 data-id="heading-1">配置 Cloudflare tunnel</h2>
<p>配置 Cloudflare tunnel 大体分为 <strong>域名配置</strong> 和 <strong>tunnel 配置</strong> 两部分。</p>
<h3 data-id="heading-2">域名配置</h3>
<p>域名配置是为了后期能够更方便的访问 RustFS。</p>
<ul>
<li>使用 Cloudflare 账号登录 Cloudflare Domain 界面；</li>
<li>在左侧导航栏，<strong>Account home</strong>，如果你已经有域名，则选择 <strong>Onboard a domain</strong>，否则可选择 <strong>Buy a domain</strong>。</li>
<li>如果选择 <strong>Onboard a domain</strong>，点击该选项后，在出现的界面中输入你的域名，然后继续往下走，直到在最后选择 <strong>Continue to activation</strong>。</li>
<li>如果一切顺利，可以在域名管理首页看到添加成功的域名，其 <strong>Status</strong> 会显示为 <strong>Active</strong>。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eeca92abe4fa4c31b912cf2714d9ee3e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUnVzdEZT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770080990&amp;x-signature=h4ibF3A7TLdOiixu2hAmrKBe9d8%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-3">tunnel 配置</h3>
<ul>
<li>
<p>使用 Cloudflare 账号登录 <a href="https://link.juejin.cn?target=https%3A%2F%2Fone.dash.cloudflare.com%2F" target="_blank" title="https://one.dash.cloudflare.com/" ref="nofollow noopener noreferrer">Cloudflare Dashboard</a>；</p>
</li>
<li>
<p>在左侧导航栏，选择 <strong>Networks -&gt; Connectors</strong>，在右侧界面点击 <strong>Create a tunnel</strong>；</p>
</li>
<li>
<p>在 tunnel 类型中，选择 <strong>Select Clouflared</strong>；</p>
</li>
<li>
<p>在 <strong>Install and run connectors</strong> 中，根据 RustFS 实例所在服务器的操作系统信息，选择相应的安装方式。安装完毕后，可以在服务器上查看 <code>cloudflared</code> 服务的状态。运行正常后点击 <strong>Next</strong>。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">systemctl</span> <span class="hljs-string">status</span> <span class="hljs-string">cloudflared</span>
<span class="hljs-string">●</span> <span class="hljs-string">cloudflared.service</span> <span class="hljs-bullet">-</span> <span class="hljs-string">cloudflared</span>
     <span class="hljs-attr">Loaded:</span> <span class="hljs-string">loaded</span> <span class="hljs-string">(/etc/systemd/system/cloudflared.service;</span> <span class="hljs-string">enabled;</span> <span class="hljs-attr">preset:</span> <span class="hljs-string">enabled)</span>
     <span class="hljs-attr">Active:</span> <span class="hljs-string">active</span> <span class="hljs-string">(running)</span> <span class="hljs-string">since</span> <span class="hljs-string">Fri</span> <span class="hljs-number">2026-01-16 21:18:53 </span><span class="hljs-string">CST;</span> <span class="hljs-number">6</span> <span class="hljs-string">days</span> <span class="hljs-string">ago</span>
   <span class="hljs-attr">Main PID:</span> <span class="hljs-number">2538004</span> <span class="hljs-string">(cloudflared)</span>
      <span class="hljs-attr">Tasks:</span> <span class="hljs-number">10</span> <span class="hljs-string">(limit:</span> <span class="hljs-number">4375</span><span class="hljs-string">)</span>
     <span class="hljs-attr">Memory:</span> <span class="hljs-number">31.</span><span class="hljs-string">3M</span> <span class="hljs-string">(peak:</span> <span class="hljs-attr">38.7M swap: 8.2M swap peak:</span> <span class="hljs-number">15.</span><span class="hljs-string">3M)</span>
        <span class="hljs-attr">CPU:</span> <span class="hljs-string">18min</span> <span class="hljs-number">16.</span><span class="hljs-string">159s</span>
     <span class="hljs-attr">CGroup:</span> <span class="hljs-string">/system.slice/cloudflared.service</span>
</code></pre>
</li>
<li>
<p>在 <strong>Route Traffic</strong> 中，配置 <strong>Hostname</strong> 和 <strong>Service</strong> 信息。</p>
<ul>
<li>Hostname 中填写的域名可用于后续访问 RustFS 实例，可以在 <strong>Domain</strong> 字段中选择 <strong>域名配置</strong> 部分添加好的域名。如果想通过子域名访问，也可以在 <strong>Subdomain</strong> 字段中输入子域名名称。</li>
<li>Service 选择服务类型和 URL。对于上述安装的 RustFS 实例，Type 可以选择 HTTP/HTTPS（如果启用了 HTTPS，可选择 HTTPS，否则用 HTTP），URL 为 <code>localhost:9001</code>。</li>
</ul>
</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d13f6684fb9e477db24d92a8a483a478~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUnVzdEZT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770080990&amp;x-signature=sd%2FQ4VdrcOZrH5iKUS95T7FnmUE%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>点击 <strong>Complete setup</strong> 完成配置。</li>
</ul>
<p>上述配置结束后，可以在 Connectors 界面看到添加好的 tunnel，如果一切顺利，则可以看到 <strong>Status</strong> 为绿色的 <strong>HEALTHY</strong>。</p>
<blockquote>
<p>在 Hostname 和 Service 设置页面的 <strong>Additional application settings</strong> 部分，点击 <strong>HTTP Settings</strong>，在 <strong>HTTP Host Header</strong> 部分，输入访问 RustFS 的域名，这是为了避免后续使用出现签名错误。</p>
</blockquote>
<h2 data-id="heading-4">登录验证</h2>
<p>恭喜你，如果你顺利完成了上述两部分的配置后，那么现在你就可以通过你配置好的域名来访问 RustFS 实例了。本文配置的域名为 <code>rustfs.xiaomage.vip</code>，所以在浏览器中输入 <code>https://rustfs.xiaomage.vip</code> 即可访问 RustFS 实例：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10b1e5f2206d49949a41fed42f3eb214~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUnVzdEZT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770080990&amp;x-signature=GmOuS1Hkr8YjsEGWHm0ejLyFc7Y%3D" alt="image.png" loading="lazy"/></p>
<p>输入 <code>rustfsadmin/rustfsadmin</code> 即可登录。</p>
<p>接下来就可以通过多种方式来使用 RustFS 实例了，比如 <code>mc</code>、<code>rc</code> 以及 <code>rclone</code>。</p>
<h2 data-id="heading-5">通过 <code>mc</code> 使用 RustFS</h2>
<p><code>mc</code> 是 Minio 的专属客户端，由于 RustFS 是 S3 兼容的，而且是 Minio 的平替，所以可以用 <code>mc</code> 来操作 RustFS。</p>
<h3 data-id="heading-6">前提</h3>
<ul>
<li>根据 minio <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fminio%2Fmc" target="_blank" title="https://github.com/minio/mc" ref="nofollow noopener noreferrer">官网指南</a>安装好 <code>mc</code>。</li>
</ul>

<pre><code class="hljs language-sql" lang="sql">mc <span class="hljs-comment">--version</span>
mc version <span class="hljs-keyword">RELEASE</span><span class="hljs-number">.2025</span><span class="hljs-number">-08</span><span class="hljs-number">-29</span>T21<span class="hljs-number">-30</span><span class="hljs-number">-41</span>Z (<span class="hljs-keyword">commit</span><span class="hljs-operator">-</span>id<span class="hljs-operator">=</span>f7560841be167a94b7014bf8a504e0820843247f)
Runtime: go1<span class="hljs-number">.24</span><span class="hljs-number">.6</span> darwin<span class="hljs-operator">/</span>arm64
Copyright (c) <span class="hljs-number">2015</span><span class="hljs-number">-2025</span> MinIO, Inc.
MinIO Enterprise License
</code></pre>
<h3 data-id="heading-7">使用</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 添加 `alias`</span>
mc <span class="hljs-built_in">alias</span> <span class="hljs-built_in">set</span> rustfs https://rustfs.xiaomage.vip rustfsadmin rustfsadmin

<span class="hljs-comment"># 创建存储桶</span>
mc mb rustfs/hello

<span class="hljs-comment"># 列出存储桶</span>
mc <span class="hljs-built_in">ls</span> rustfs
[2026-01-23 21:39:36 CST]     0B hello/
[2026-01-23 20:12:59 CST]     0B <span class="hljs-built_in">test</span>/

<span class="hljs-comment"># 上传文件到存储桶</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"123456"</span> &gt; 1.txt
mc <span class="hljs-built_in">cp</span> 1.txt rustfs/hello
/tmp/1.txt:                         ██████████████████████████████████████████████████████████████████████████████████ 100.0% 7 B       1 B/s      

<span class="hljs-comment"># 查看上传的文件</span>
mc <span class="hljs-built_in">ls</span> rustfs/hello
[2026-01-23 21:40:44 CST]     7B STANDARD 1.txt
</code></pre>
<p>更多用法可自行探索。</p>
<h2 data-id="heading-8">通过 <code>rclone</code> 使用 RustFS</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Frclone.org%2F" target="_blank" title="https://rclone.org/" ref="nofollow noopener noreferrer"><code>rclone</code></a>是一个命令行工具，可以对不同云提供商上的文件和目录进行同步。</p>
<h3 data-id="heading-9">前提</h3>
<ul>
<li>
<p>根据 <a href="https://link.juejin.cn?target=https%3A%2F%2Fchatgpt.com%2F" target="_blank" title="https://chatgpt.com/" ref="nofollow noopener noreferrer"><code>rclone</code> 官网指南</a>安装好 <code>rclone</code> 命令行工具。</p>
<pre><code class="hljs language-bash" lang="bash">rclone --version
rclone v1.72.1
- os/version: ubuntu 24.04 (64 bit)
- os/kernel: 6.8.0-71-generic (x86_64)
- os/type: linux
- os/arch: amd64
- go/version: go1.25.5
- go/linking: static
- go/tags: none
</code></pre>
</li>
</ul>
<h3 data-id="heading-10">使用</h3>
<ul>
<li>配置 <code>rclone</code></li>
</ul>
<p>执行 <code>rclone config</code> 命令，根据 RustFS 实例信息，一步步进行配置。配置完成后，会生成一个 <code>~/.config/rclone/rclone.conf</code> 文件，一般内容如下：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[rustfs]</span>
<span class="hljs-attr">type</span> = s3
<span class="hljs-attr">provider</span> = Minio
<span class="hljs-attr">access_key_id</span> = rustfsadmin
<span class="hljs-attr">secret_access_key</span> = rustfsadmin
<span class="hljs-attr">endpoint</span> = https://rustfs.xiaomage.vip
<span class="hljs-attr">region</span> = us-east-<span class="hljs-number">1</span>
<span class="hljs-attr">force_path_style</span> = <span class="hljs-literal">true</span>
</code></pre>
<blockquote>
<p>由于目前 RustFS 还未向 rclone 官方提 PR 以增加 RustFS provider 信息，因此使用 Minio 作为 provider。</p>
</blockquote>
<ul>
<li>开始使用</li>
</ul>

<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 列出存储桶和对象</span>

rclone <span class="hljs-built_in">ls</span> rustfs: --s3-sign-accept-encoding=<span class="hljs-literal">false</span>
        7 hello/1.txt
    11792 <span class="hljs-built_in">test</span>/1.<span class="hljs-built_in">log</span>
   520512 <span class="hljs-built_in">test</span>/123.mp3
     7394 <span class="hljs-built_in">test</span>/2.<span class="hljs-built_in">log</span>
   147240 <span class="hljs-built_in">test</span>/321.mp3
   

<span class="hljs-comment"># 查看某个对象内容</span>
rclone <span class="hljs-built_in">cat</span> rustfs:hello/1.txt --s3-sign-accept-encoding=<span class="hljs-literal">false</span>
123456 
</code></pre>
<p>对于其他用法，可以通过 <code>rclone --help</code> 来自行探索。</p>
<p><strong>注意</strong>：添加 <code>--s3-sign-accept-encoding=false</code> 参数是因为 Cloudflare 会对 <code>Accept-Encoding</code> 参数进行修改，在 S3 协议中，这种变更会导致 <strong>SignatureDoesNotMatch</strong> 错误，详情可以查看 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frustfs%2Frustfs%2Fissues%2F1492" target="_blank" title="https://github.com/rustfs/rustfs/issues/1492" ref="nofollow noopener noreferrer">RustFS issue</a>。</p>
<h3 data-id="heading-11">通过 <code>rc</code> 使用 RustFS</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frustfs%2Fcli" target="_blank" title="https://github.com/rustfs/cli" ref="nofollow noopener noreferrer"><code>rc</code></a> 是 RustFS 的 Client，用来对 RustFS 进行操作。目前，刚发布 <code>0.1.1</code>。可以使用 <code>cargo</code> 或源码编译安装。</p>
<pre><code class="hljs language-css" lang="css">rc <span class="hljs-attr">--version</span>
rc <span class="hljs-number">0.1</span>.<span class="hljs-number">1</span>
</code></pre>
<p>目前提供 <code>alias</code>、<code>ls</code>、<code>mb</code>、<code>rb</code> 等多种常规命令。使用方式和 <code>mc</code> 类似。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 设置 alias</span>
rc <span class="hljs-built_in">alias</span> <span class="hljs-built_in">set</span> rustfs https://rustfs.xiaomage.vip rustfsadmin rustfsadmin
✓ Alias <span class="hljs-string">'rustfs'</span> configured successfully.

<span class="hljs-comment"># 列出存储桶</span>
rc <span class="hljs-built_in">ls</span> rustfs
[2026-01-23 13:39:36]         0B hello/
[2026-01-23 13:56:57]         0B rclone/
[2026-01-23 12:12:59]         0B <span class="hljs-built_in">test</span>/

<span class="hljs-comment"># 创建存储桶</span>
rc mb rustfs/client
✓ Bucket <span class="hljs-string">'rustfs/client'</span> created successfully.
</code></pre>
<p>更多用法，可以通过 <code>rc --help</code> 进行查看并自行探索，使用过程中有任何问题，可以在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frustfs%2Fcli%2Fissues" target="_blank" title="https://github.com/rustfs/cli/issues" ref="nofollow noopener noreferrer">GitHub Issue</a>中进行反馈。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[面积图的奇妙变形：流图与地平线图]]></title>    <link>https://juejin.cn/post/7599580550296141859</link>    <guid>https://juejin.cn/post/7599580550296141859</guid>    <pubDate>2026-01-27T01:50:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599580550296141859" data-draft-id="7599580550296125475" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="面积图的奇妙变形：流图与地平线图"/> <meta itemprop="keywords" content="Python,数据可视化,数据分析"/> <meta itemprop="datePublished" content="2026-01-27T01:50:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="databook"/> <meta itemprop="url" content="https://juejin.cn/user/3526889035006702"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            面积图的奇妙变形：流图与地平线图
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3526889035006702/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    databook
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T01:50:50.000Z" title="Tue Jan 27 2026 01:50:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>想象一下面积图就像一层层叠起来的彩色玻璃片，每一层代表一个类别，从下往上堆叠，形成整体的视觉冲击。</p>
<p>但有时我们需要更特别的方式来展示数据的变化：是像河流一样蜿蜒流淌，还是像地平线上的群山连绵起伏？</p>
<p>今天，本文将介绍两种创意<strong>面积图变体</strong>——<strong>流图</strong>和<strong>地平线图</strong>，它们能让你的时间序列数据讲述更生动的故事。</p>
<h2 data-id="heading-0">1. 流图：数据的河流</h2>
<p>如果把传统的堆叠面积图想象成一块块整齐堆叠的积木，那么<strong>流图</strong>就像一条蜿蜒流淌的河流，河道的宽窄变化自然流畅，波峰波谷过渡平滑。</p>
<p>它特别适合展示多个类别数据随时间的变化趋势，尤其是当你想强调整体流动感和各部分的相对比例变化时。</p>
<p><strong>流图</strong>的<strong>核心思想</strong>是将传统的堆叠面积图进行"平滑"处理。</p>
<p>在<code>matplotlib</code>中，我们可以使用<code>fill_between</code>函数结合样条插值来创建平滑的边缘。</p>
<p>关键在于将堆叠的数据进行累积，然后对累积边界进行平滑处理。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 数据准备</span>
x = np.linspace(<span class="hljs-number">0</span>, <span class="hljs-number">10</span>, <span class="hljs-number">100</span>)
<span class="hljs-comment"># 构造三组波浪数据</span>
y1 = <span class="hljs-number">2</span> + np.sin(x)            <span class="hljs-comment"># 基础波动</span>
y2 = <span class="hljs-number">2</span> + np.cos(x - <span class="hljs-number">1.5</span>)      <span class="hljs-comment"># 错位波动</span>
y3 = <span class="hljs-number">2</span> + np.sin(x + <span class="hljs-number">2</span>)        <span class="hljs-comment"># 再次错位</span>

<span class="hljs-comment"># 省略 ...</span>

<span class="hljs-comment"># 绘图设置</span>
fig, (ax1, ax2) = plt.subplots(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, figsize=(<span class="hljs-number">14</span>, <span class="hljs-number">6</span>))

<span class="hljs-comment"># --- 左图：普通堆叠面积图 (baseline='zero') ---</span>
ax1.stackplot(x, y_data, labels=labels, colors=colors, baseline=<span class="hljs-string">'zero'</span>, alpha=<span class="hljs-number">0.8</span>)
<span class="hljs-comment"># 省略 ...</span>

<span class="hljs-comment"># --- 右图：流图 (baseline='sym') ---</span>
<span class="hljs-comment"># 'sym' 表示对称中心布局</span>
ax2.stackplot(x, y_data, labels=labels, colors=colors, baseline=<span class="hljs-string">'sym'</span>, alpha=<span class="hljs-number">0.8</span>)
ax2.axhline(<span class="hljs-number">0</span>, color=<span class="hljs-string">'black'</span>, ls=<span class="hljs-string">'--'</span>, alpha=<span class="hljs-number">0.1</span>) <span class="hljs-comment"># 画一条中心参考线</span>
<span class="hljs-comment"># 省略 ...</span>

<span class="hljs-comment"># 去除右图边框，增加流动感</span>
<span class="hljs-keyword">for</span> spine <span class="hljs-keyword">in</span> ax2.spines.values():
    spine.set_visible(<span class="hljs-literal">False</span>)

plt.tight_layout()
plt.show()
</code></pre>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a95a90d8e4d49deba0549e04440a961~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770083449&amp;x-signature=dwb%2BDG%2Fop85OGfQvutC7SPsrjNI%3D" alt="" loading="lazy"/></p>
<p><strong>流图</strong>解决了一个视觉错觉问题：在普通<strong>堆叠面积图</strong>中，上面的数据层会因为下面数据层的起伏而被迫“扭曲”，很难看出它原本的形状。</p>
<p><strong>流图</strong>通过中心布局，减少了这种扭曲，非常适合展示随时间变化的趋势和不同类别权重的波动，这种有机的形态还能给读者带来极强的审美愉悦感。</p>
<h2 data-id="heading-1">2. 地平线图：数据的群山</h2>
<p>想象一下远处的地平线上有一排连绵的山脉，每座山的高度代表一个数据值。</p>
<p><strong>地平线图</strong>就是这样一种可视化技术，它将时间序列数据压缩在一个很小的垂直空间内，通过颜色和分层来展示数据的变化。</p>
<p>特别适合在有限空间内展示多个时间序列的对比。</p>
<p><strong>地平线图</strong>的<strong>核心思想</strong>是数据分层和颜色渐变。</p>
<p>它将数据值分成若干层（通常是2-3层），每层用一种颜色表示。当数据值超过一层时，就用更深的颜色或不同的颜色填充。这样可以在很小的垂直空间内展示很大的数据范围。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> timedelta

<span class="hljs-comment"># 生成模拟数据：过去10年五大科技公司的股价波动</span>
np.random.seed(<span class="hljs-number">42</span>)

<span class="hljs-comment"># 生成日期范围：过去10年，每月一个数据点</span>
dates = pd.date_range(<span class="hljs-string">"2013-01-01"</span>, <span class="hljs-string">"2023-01-01"</span>, freq=<span class="hljs-string">"ME"</span>)
companies = [<span class="hljs-string">"苹果"</span>, <span class="hljs-string">"谷歌"</span>, <span class="hljs-string">"微软"</span>, <span class="hljs-string">"亚马逊"</span>, <span class="hljs-string">"Meta"</span>]

<span class="hljs-comment"># 生成各公司的股价模拟数据（标准化到相似范围）</span>
data = {}
<span class="hljs-keyword">for</span> company <span class="hljs-keyword">in</span> companies:
    <span class="hljs-comment"># 基础趋势：每家公司有不同的增长趋势，但最终都在70-90范围内</span>
    <span class="hljs-comment"># 省略 ...</span>

<span class="hljs-comment"># 转换为DataFrame</span>
df = pd.DataFrame(data, index=dates)

<span class="hljs-comment"># 创建对比图表</span>
fig, axes = plt.subplots(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, figsize=(<span class="hljs-number">14</span>, <span class="hljs-number">10</span>))

<span class="hljs-comment"># ============ 传统堆叠面积图 ============</span>
colors = [<span class="hljs-string">"#FF6B6B"</span>, <span class="hljs-string">"#4ECDC4"</span>, <span class="hljs-string">"#45B7D1"</span>, <span class="hljs-string">"#FFD166"</span>, <span class="hljs-string">"#9B5DE5"</span>]

<span class="hljs-comment"># 为堆叠面积图重新归一化数据</span>
df_normalized = df.div(df.<span class="hljs-built_in">sum</span>(axis=<span class="hljs-number">1</span>), axis=<span class="hljs-number">0</span>) * <span class="hljs-number">100</span>
y_cumulative = np.zeros(<span class="hljs-built_in">len</span>(df))

<span class="hljs-keyword">for</span> i, company <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(companies):
    axes[<span class="hljs-number">0</span>].fill_between(
        df.index,
        y_cumulative,
        y_cumulative + df_normalized[company].values,
        color=colors[i],
        alpha=<span class="hljs-number">0.7</span>,
        label=company,
        edgecolor=<span class="hljs-string">"white"</span>,
        linewidth=<span class="hljs-number">0.5</span>,
    )
    y_cumulative += df_normalized[company].values

<span class="hljs-comment"># 省略 ...</span>

<span class="hljs-comment"># ============ 地平线图：股价波动对比 ============</span>
<span class="hljs-comment"># 生成股价变化百分比数据（更能体现波动对比）</span>
np.random.seed(<span class="hljs-number">42</span>)
price_changes = {}
<span class="hljs-keyword">for</span> company <span class="hljs-keyword">in</span> companies:
    <span class="hljs-comment"># 生成均值附近波动的变化数据</span>
    <span class="hljs-comment"># 省略 ...</span>

<span class="hljs-comment"># 关键参数：定义“波段”</span>
BAND_HEIGHT = <span class="hljs-number">3.0</span>  <span class="hljs-comment"># 每个颜色波段代表的变化率幅度 (%)</span>
NUM_BANDS = <span class="hljs-number">3</span>  <span class="hljs-comment"># 正负方向各使用的波段层数</span>

df = pd.DataFrame(price_changes, index=dates)

<span class="hljs-comment"># 为每家公司计算并绘制地平线</span>
<span class="hljs-keyword">for</span> i, company <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(companies):
    <span class="hljs-comment"># 公司的基准Y轴位置（水平线）</span>
    <span class="hljs-comment"># 省略 ...</span>

    <span class="hljs-comment"># 分层与绘制：从第1层到第NUM_BANDS层</span>
    <span class="hljs-keyword">for</span> band <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(NUM_BANDS):
        <span class="hljs-comment"># --- 处理正偏差（上涨）---</span>
        <span class="hljs-comment"># 计算当前层的数据：偏差值减去已绘制层的高度，并限制在本层高度内</span>
        <span class="hljs-comment"># 省略 ...</span>

        <span class="hljs-comment"># --- 处理负偏差（下跌）---</span>
        <span class="hljs-comment"># 对负值取绝对值，进行类似处理</span>
        <span class="hljs-comment"># 省略 ...</span>

<span class="hljs-comment"># 美化图表</span>
<span class="hljs-comment"># 省略 ...</span>

<span class="hljs-comment"># 6. 添加图例</span>
<span class="hljs-keyword">import</span> matplotlib.patches <span class="hljs-keyword">as</span> mpatches

legend_patches = []
<span class="hljs-comment"># 省略 ...</span>

plt.tight_layout(h_pad=<span class="hljs-number">5</span>)
plt.show()
</code></pre>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/396d9a8fd701488aa6e37db79120bcee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770083449&amp;x-signature=0ISHEtblp3IjjVCuC7i7GsPIhiI%3D" alt="" loading="lazy"/></p>
<p><strong>地平线图</strong>是空间利用大师。当你有 20 个股票或者 50 个城市的温度需要放在一张图里对比时，普通的面积图会挤成一团乱麻。</p>
<p><strong>地平线图</strong>可以将每个序列压缩成一个窄窄的横条，但在保持视觉分辨率的同时，还能让你看清极值（通过深颜色）。</p>
<h2 data-id="heading-2">3. 总结</h2>
<p>数据可视化不仅是科学，也是艺术。<strong>流图</strong>和<strong>地平线图</strong>这两种面积图变体，分别从**"流动之美"<strong>和</strong>"空间效率"**两个角度拓展了面积图的可能性。</p>
<p>它们证明了，通过对基础图表的创意改造，我们可以让数据讲述更丰富、更生动的故事。</p>
<p>下次当你面对时间序列数据时，不妨问问自己：我的数据像一条蜿蜒的河流，还是像地平线上的群山？选择适合的可视化方式，让你的数据真正"流动"起来或"层叠"起来。</p>
<p>记住，最好的可视化不是最复杂的，而是最能清晰传达信息、启发思考的那一个。</p>
<p>完整的代码共享在：<a href="https://link.juejin.cn?target=https%3A%2F%2Furl11.ctfile.com%2Ff%2F45455611-8635132430-f06d31%3Fp%3D6872" target="_blank" title="https://url11.ctfile.com/f/45455611-8635132430-f06d31?p=6872" ref="nofollow noopener noreferrer">面积图的2个变种.ipynb</a> (访问密码: 6872)</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[《从轮播图实现，学会如何观察页面的“渲染”与“合成”》（附 Performance 实测对比）》]]></title>    <link>https://juejin.cn/post/7599294170001178675</link>    <guid>https://juejin.cn/post/7599294170001178675</guid>    <pubDate>2026-01-26T11:28:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599294170001178675" data-draft-id="7598472744481652755" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="《从轮播图实现，学会如何观察页面的“渲染”与“合成”》（附 Performance 实测对比）》"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-26T11:28:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Flinton"/> <meta itemprop="url" content="https://juejin.cn/user/2225067266677640"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            《从轮播图实现，学会如何观察页面的“渲染”与“合成”》（附 Performance 实测对比）》
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2225067266677640/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Flinton
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T11:28:16.000Z" title="Mon Jan 26 2026 11:28:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>大家好，我是【小奇腾】，相信大家在前端的路上一定会遇到性能瓶颈的问题。可是谈了半天性能瓶颈，但是不知道怎么下手，也不知道从哪里开始。那么今天我和大家一起来探索这个奇妙的过程。也希望小伙伴一起支持加油下！！！</p>
</blockquote>
<p>本期详细的视频教程bilibili：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1dezvBWEm6%2F%3Fspm_id_from%3D333.1387.homepage.video_card.click%26vd_source%3D4213d38d889ea1581bbcae78a04cbd9d" target="_blank" title="https://www.bilibili.com/video/BV1dezvBWEm6/?spm_id_from=333.1387.homepage.video_card.click&amp;vd_source=4213d38d889ea1581bbcae78a04cbd9d" ref="nofollow noopener noreferrer">《从轮播图实现，学会如何观察页面的“渲染”与“合成”》（附 Performance 实测对比）》</a></p>
<h2 data-id="heading-0">一、 缘起：一个轮播图引发的思考</h2>













<table><thead><tr><th>需求</th><th>效果</th></tr></thead><tbody><tr><td>实现一个垂直轮播图，<br/>每隔 2 秒，图片向上滚动一次</td><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c821ad6444c42799d497f9e9ee7306b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmxpbnRvbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770031820&amp;x-signature=Tu5AawGe7ydHJaGEQs3xcFQtKyg%3D" width="100%" loading="lazy"/></td></tr></tbody></table>
<p>效果看起来差不多，但是性能却不一样,有两种实现方案：</p>
<ol>
<li><strong>直觉派</strong>：修改 <code>margin-top</code> 或者 <code>top</code> 属性，把图片“挤”上去。</li>
<li><strong>优化派</strong>：使用 CSS3 的 <code>transform: translateY</code>，把图片“移”上去。</li>
</ol>
<h2 data-id="heading-1">二、 选手入场：两种代码实现 (代码见 -&gt; 代码附录 最底部)</h2>
<p>为了控制变量，我准备了两个简单的 Demo，HTML 结构完全一致，唯独驱动动画的方式不同。</p>
<p><strong>方案 A：使用 Margin-top（低性能模拟）</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 修改 margin-top，触发文档流变化</span>
wrapper.<span class="hljs-property">style</span>.<span class="hljs-property">marginTop</span> = <span class="hljs-string">`<span class="hljs-subst">${offset}</span>px`</span>;
</code></pre>
<p><strong>方案 B：使用 Transform（高性能推荐）</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 修改 transform，开启硬件加速</span>
wrapper.<span class="hljs-property">style</span>.<span class="hljs-property">transform</span> = <span class="hljs-string">`translateY(<span class="hljs-subst">${offset}</span>px)`</span>;
</code></pre>
<p>接下来，我们用数据说话。</p>
<h2 data-id="heading-2">三、 第一关：视觉观测（Rendering 面板）</h2>
<p>Chrome 的开发者工具里隐藏着一个神器叫 <strong>Rendering（渲染）</strong> 。</p>
<blockquote>
<p><strong>如何打开</strong>：<code>F12</code> -&gt; <code>Cmd/Ctrl + Shift + P</code> -&gt; 输入 <code>Rendering</code> -&gt; 选择 <code>Show Rendering</code>。</p>
</blockquote>
<p>我勾选了 <strong>Paint flashing (突出显示绘制区域) / Enable automatic dark mode (暗黑模式)</strong> ，这个功能的作用是：<strong>只要页面上有像素被重绘，就闪烁绿色。</strong></p>













<table><thead><tr><th>设置</th><th>效果</th></tr></thead><tbody><tr><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2cbbeb8a49df4977b717287f24107b67~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmxpbnRvbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770031820&amp;x-signature=mNABdyaTqEkAR5QQxpNUKIzaK6A%3D" width="80%" loading="lazy"/></td><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d061de3e26aa4bb89391a08f4a8f72d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmxpbnRvbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770031820&amp;x-signature=GWsFzjuZ81kj9NkMkGRjx45r8s4%3D" width="100%" loading="lazy"/></td></tr></tbody></table>
<h3 data-id="heading-3">1. 观察 Margin-top 方案</h3>
<p>当图片滚动时，我被吓了一跳： <strong>（在此处插入你那张【有绿色大边框】的截图）</strong></p>
<p><strong>现象</strong>：每次轮播切换，整个容器甚至周边区域都疯狂闪烁绿光。</p>
<p><strong>结论</strong>：这说明浏览器在进行大面积的<strong>重绘 (Repaint)</strong> 。CPU 正在辛苦地重新计算每一个像素的颜色。</p>
<h3 data-id="heading-4">2. 观察 Transform 方案</h3>
<p>接着我切换到 Transform 写法： <strong>（在此处插入你那张【完全没有绿框】的截图）</strong></p>
<p><strong>现象</strong>：画面静如止水，图片在动，但没有绿光闪烁（或者只有极微小的区域）。</p>
<p><strong>结论</strong>：浏览器没有重绘！它偷懒了？不，它是变聪明了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d3df872392f49af8a390df3b9660e32~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmxpbnRvbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770031820&amp;x-signature=giGqriMxjS3gmlvY5U3nSVND368%3D" width="50%" loading="lazy"/> |</p>
<h3 data-id="heading-5">四、 第二关：深度扫描（Performance 面板）</h3>
<p>如果说绿光只是表象，那 Performance 面板就是“实锤”证据。我开启了 <strong>CPU 4x Slowdown</strong>（模拟低端设备），分别录制了两次滚动的过程。</p>
<h4 data-id="heading-6">1. 打开 CPU 4x slowdown</h4>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c76cf6fd46fa447c9dbd078ea104c73a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmxpbnRvbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770031820&amp;x-signature=EfcOnXhGQGhAVrxpCtqNG9jIztU%3D" width="100%" loading="lazy"/> 
<h4 data-id="heading-7">2. 打开 performance中的录制功能</h4>
<p>红色那个圆圈的就是录制按钮，录制7秒左右就可以了，然后点击stop，看结果</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6649f874f83434895afa0c023e4824c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmxpbnRvbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770031820&amp;x-signature=js0uiRSObgLIH67EUXlagwCTvFU%3D" width="100%" loading="lazy"/> 
<h4 data-id="heading-8">3. 关键看 Main 的部份</h4>
<ol>
<li>观察 Margin-top 方案</li>
</ol>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/69337f092b3a4a159ee83903abc4092e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmxpbnRvbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770031820&amp;x-signature=irPoLOEvsYuxcLpoLkJuPifwJn0%3D" width="100%" loading="lazy"/> 
<p>大家看上图的 <strong>Main (主线程)</strong> 区域：</p>
<ul>
<li>在Main的部份圈红色的 密密麻麻的“绿色波峰”是什么？鼠标放上去，全是 <strong>Layout (布局)</strong> / <strong>Update Layer Tree</strong> / <strong>Paint</strong>。</li>
<li>因为修改 <code>margin</code> 会改变元素的几何位置，浏览器必须重新计算布局（Reflow），这会阻塞主线程。</li>
</ul>
<ol start="2">
<li>观察 Transform 方案</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02d3336338b944a69dacf0d8bfad2202~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmxpbnRvbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770031820&amp;x-signature=eMhIicXBn%2FHQzhh3tnTlgd0Vrhg%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>Main 线程几乎是一条直线！</li>
<li>没有 Layout，没有 Paint，只有零星的动画帧触发。</li>
<li>这是因为 <code>transform</code> 将元素提升为了<strong>合成层 (Composite Layer)</strong> ，动画的平移工作直接交给了 <strong>GPU</strong> 处理，主线程完全解放了出来。</li>
</ul>
<p>关于性能更多内容(<code>顶部的视频链接</code>)有具体的演示.</p>
<h2 data-id="heading-9">五、 总结：为什么 Transform 性能更好？</h2>
<p>通过这次观测，我们验证了浏览器渲染流水线的核心差异：</p>



































<table><thead><tr><th><strong>维度</strong></th><th><strong>Margin-top / Top</strong></th><th><strong>Transform</strong></th></tr></thead><tbody><tr><td><strong>触发机制</strong></td><td>修改几何属性</td><td>修改合成属性</td></tr><tr><td><strong>重排 (Reflow)</strong></td><td>✅ <strong>触发</strong> (计算布局，最慢)</td><td>❌ <strong>不触发</strong></td></tr><tr><td><strong>重绘 (Repaint)</strong></td><td>✅ <strong>触发</strong> (重新画像素，慢)</td><td>❌ <strong>不触发</strong></td></tr><tr><td><strong>执行位置</strong></td><td>CPU (主线程)</td><td>GPU (合成线程)</td></tr><tr><td><strong>性能表现</strong></td><td>容易卡顿</td><td>丝滑流畅</td></tr></tbody></table>
<p><strong>简单理解</strong>：</p>
<ul>
<li>
<p><strong>Margin-top</strong> 就像是你要搬家，你把房子拆了（Reflow），然后再一块块砖砌到新位置（Repaint）。</p>
</li>
<li>
<p><strong>Transform</strong> 就像是你拍了一张房子的照片，然后用幻灯片把这张照片投影到新位置。房子没动，只是投影动了，所以极快。</p>
</li>
</ul>
<h2 data-id="heading-10">六、代码附录</h2>
<h3 data-id="heading-11">1. Margin-Top方案（低性能）</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>垂直轮播图演示 - Margin-Top方案（低性能）<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        * { <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>; <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>; <span class="hljs-attribute">box-sizing</span>: border-box; }
        <span class="hljs-selector-tag">body</span> { <span class="hljs-attribute">display</span>: flex; <span class="hljs-attribute">justify-content</span>: center; <span class="hljs-attribute">align-items</span>: center; <span class="hljs-attribute">height</span>: <span class="hljs-number">100vh</span>; <span class="hljs-attribute">background</span>: <span class="hljs-number">#f0f2f5</span>; }

        <span class="hljs-selector-class">.viewport</span> {
            <span class="hljs-attribute">width</span>: <span class="hljs-number">300px</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>;
            <span class="hljs-attribute">border</span>: <span class="hljs-number">5px</span> solid <span class="hljs-number">#333</span>;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">10px</span>;
            <span class="hljs-attribute">overflow</span>: hidden;
            <span class="hljs-attribute">position</span>: relative;
            <span class="hljs-attribute">background</span>: <span class="hljs-number">#fff</span>;
            <span class="hljs-comment">/* 注意：这里不需要 will-change 了，因为我们就是在模拟没有优化的情况 */</span>
        }

        <span class="hljs-selector-class">.wrapper</span> {
            <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
            <span class="hljs-comment">/* ❌ 性能杀手：这里我们要改变 margin-top */</span>
            <span class="hljs-comment">/* 浏览器必须重新计算布局，因为 margin 改变会影响文档流 */</span>
            <span class="hljs-attribute">transition</span>: margin-top <span class="hljs-number">0.5s</span> ease-in-out; 
        }

        <span class="hljs-selector-class">.slide</span> {
            <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>;
            <span class="hljs-attribute">display</span>: flex;
            <span class="hljs-attribute">justify-content</span>: center;
            <span class="hljs-attribute">align-items</span>: center;
            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">40px</span>;
            <span class="hljs-attribute">color</span>: white;
            <span class="hljs-attribute">font-weight</span>: bold;
        }

        <span class="hljs-selector-class">.slide</span><span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-number">1</span>) { <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#FF5733</span>; }
        <span class="hljs-selector-class">.slide</span><span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-number">2</span>) { <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#33FF57</span>; }
        <span class="hljs-selector-class">.slide</span><span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-number">3</span>) { <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#3357FF</span>; }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"viewport"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"wrapper"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"slide"</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"slide"</span>&gt;</span>2<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"slide"</span>&gt;</span>3<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">const</span> wrapper = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.wrapper'</span>);
        <span class="hljs-keyword">const</span> imgHeight = <span class="hljs-number">200</span>; 
        <span class="hljs-keyword">const</span> totalSlides = <span class="hljs-number">3</span>; 
        <span class="hljs-keyword">let</span> currentIndex = <span class="hljs-number">0</span>;

        <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
            currentIndex++;
            <span class="hljs-keyword">if</span> (currentIndex &gt;= totalSlides) {
                currentIndex = <span class="hljs-number">0</span>;
            }

            <span class="hljs-keyword">const</span> offset = -(currentIndex * imgHeight);

            <span class="hljs-comment">// ❌ 核心区别在这里：</span>
            <span class="hljs-comment">// 我们修改的是 marginTop，而不是 transform</span>
            <span class="hljs-comment">// 这会触发布局重排 (Reflow)</span>
            wrapper.<span class="hljs-property">style</span>.<span class="hljs-property">marginTop</span> = <span class="hljs-string">`<span class="hljs-subst">${offset}</span>px`</span>;

            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`当前使用 margin-top 偏移: <span class="hljs-subst">${offset}</span>px`</span>);

        }, <span class="hljs-number">2000</span>);
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h3 data-id="heading-12">2. Transform方案 (性能好)</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>垂直轮播图演示 - Transform方案<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        <span class="hljs-comment">/* 简单的重置 */</span>
        * { <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>; <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>; <span class="hljs-attribute">box-sizing</span>: border-box; }
        <span class="hljs-selector-tag">body</span> { <span class="hljs-attribute">display</span>: flex; <span class="hljs-attribute">justify-content</span>: center; <span class="hljs-attribute">align-items</span>: center; <span class="hljs-attribute">height</span>: <span class="hljs-number">100vh</span>; <span class="hljs-attribute">background</span>: <span class="hljs-number">#f0f2f5</span>; }

        <span class="hljs-comment">/* 1. 视口：固定高度，像一个相框 */</span>
        <span class="hljs-selector-class">.viewport</span> {
            <span class="hljs-attribute">width</span>: <span class="hljs-number">300px</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>; <span class="hljs-comment">/* 视口高度 */</span>
            <span class="hljs-attribute">border</span>: <span class="hljs-number">5px</span> solid <span class="hljs-number">#333</span>;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">10px</span>;
            <span class="hljs-attribute">overflow</span>: hidden; <span class="hljs-comment">/* 关键：把超出的部分切掉 */</span>
            <span class="hljs-attribute">position</span>: relative;
            <span class="hljs-attribute">background</span>: <span class="hljs-number">#fff</span>;
            <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">10px</span> <span class="hljs-number">20px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.1</span>);
        }

        <span class="hljs-comment">/* 2. 渲染层/包裹层：用来移动的长条 */</span>
        <span class="hljs-selector-class">.wrapper</span> {
            <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
            <span class="hljs-comment">/* 这里不需要设置高度，内容撑开即可 */</span>
            
            <span class="hljs-comment">/* 关键性能优化：过渡动画 */</span>
            <span class="hljs-attribute">transition</span>: transform <span class="hljs-number">0.5s</span> ease-in-out; 
            <span class="hljs-comment">/* 提示浏览器开启 GPU 加速 */</span>
            <span class="hljs-attribute">will-change</span>: transform;
        }

        <span class="hljs-comment">/* 3. 图片样式：为了演示方便，我用带颜色的div代替图片 */</span>
        <span class="hljs-selector-class">.slide</span> {
            <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>; <span class="hljs-comment">/* 必须和视口高度一致 */</span>
            <span class="hljs-attribute">display</span>: flex;
            <span class="hljs-attribute">justify-content</span>: center;
            <span class="hljs-attribute">align-items</span>: center;
            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">40px</span>;
            <span class="hljs-attribute">color</span>: white;
            <span class="hljs-attribute">font-weight</span>: bold;
        }

        <span class="hljs-selector-class">.slide</span><span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-number">1</span>) { <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#FF5733</span>; } <span class="hljs-comment">/* 红 */</span>
        <span class="hljs-selector-class">.slide</span><span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-number">2</span>) { <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#33FF57</span>; } <span class="hljs-comment">/* 绿 */</span>
        <span class="hljs-selector-class">.slide</span><span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-number">3</span>) { <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#3357FF</span>; } <span class="hljs-comment">/* 蓝 */</span>
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"viewport"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"wrapper"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"slide"</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"slide"</span>&gt;</span>2<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"slide"</span>&gt;</span>3<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">const</span> wrapper = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.wrapper'</span>);
        <span class="hljs-keyword">const</span> imgHeight = <span class="hljs-number">200</span>; <span class="hljs-comment">// 单张图片高度</span>
        <span class="hljs-keyword">const</span> totalSlides = <span class="hljs-number">3</span>; 
        <span class="hljs-keyword">let</span> currentIndex = <span class="hljs-number">0</span>;

        <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
            <span class="hljs-comment">// 1. 逻辑计算：下一次是第几张？</span>
            currentIndex++;
            
            <span class="hljs-comment">// 简单的回滚逻辑：如果到底了，就瞬间跳回第一张</span>
            <span class="hljs-keyword">if</span> (currentIndex &gt;= totalSlides) {
                currentIndex = <span class="hljs-number">0</span>;
            }

            <span class="hljs-comment">// 2. 核心计算：偏移量 = 索引 * 单张高度</span>
            <span class="hljs-comment">// 加上负号是因为由于坐标系原点在左上角，往上移动是负方向</span>
            <span class="hljs-keyword">const</span> offset = -(currentIndex * imgHeight);

            <span class="hljs-comment">// 3. 渲染：应用 Transform</span>
            <span class="hljs-comment">// 注意：这里完全没有用到 scrollTop，只用了数学计算</span>
            wrapper.<span class="hljs-property">style</span>.<span class="hljs-property">transform</span> = <span class="hljs-string">`translateY(<span class="hljs-subst">${offset}</span>px)`</span>;
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`当前索引: <span class="hljs-subst">${currentIndex}</span>, 偏移量: <span class="hljs-subst">${offset}</span>px`</span>);

        }, <span class="hljs-number">2000</span>);
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React useDeferredValue 详解：让你的应用丝滑流畅的秘密]]></title>    <link>https://juejin.cn/post/7599294170001326131</link>    <guid>https://juejin.cn/post/7599294170001326131</guid>    <pubDate>2026-01-26T11:59:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599294170001326131" data-draft-id="7599450177058193418" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React useDeferredValue 详解：让你的应用丝滑流畅的秘密"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2026-01-26T11:59:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="代码诗人卡尔"/> <meta itemprop="url" content="https://juejin.cn/user/2067500101533902"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React useDeferredValue 详解：让你的应用丝滑流畅的秘密
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2067500101533902/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    代码诗人卡尔
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T11:59:45.000Z" title="Mon Jan 26 2026 11:59:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、从一个常见的卡顿场景说起</h2>
<p>做前端的同学，肯定都遇到过这样的场景：一个搜索框，下面跟着一个长长的列表。用户在搜索框里每敲一个字，列表就根据输入的内容进行过滤。如果列表数据量不大，那还好说。但如果列表有成百上千条数据，那场面就有点尴尬了——用户每输入一个字，页面就卡一下，感觉就像在放慢动作的幻灯片。</p>
<p>这种体验，用户不爽，我们开发者看着也难受。问题出在哪儿呢？</p>
<p>很简单，因为每一次输入，都触发了 React 的重新渲染。而每一次重新渲染，都要遍历整个长列表，进行过滤和展示。浏览器扛不住这么高频率的计算，自然就卡了。</p>
<h2 data-id="heading-1">二、一个不那么完美的解决方案</h2>
<p>遇到这种问题，很多同学的第一反应是：用 <code>debounce</code>（防抖）或 <code>throttle</code>（节流）啊！</p>
<p>确实，这是一个很常见的优化手段。我们可以设置一个延迟，比如 200 毫秒，等用户停止输入 200 毫秒后，再进行列表的过滤和渲染。这样确实能减少渲染次数，缓解卡顿。</p>
<p>但这个方案并不完美。为什么呢？</p>
<ol>
<li><strong>延迟时间的设置很玄学</strong>：200 毫秒对于高性能的电脑来说，可能太长了，用户会感觉有明显的延迟；对于低性能的手机来说，可能又太短了，依然会卡顿。你很难找到一个适合所有设备的完美延迟时间。</li>
<li><strong>体验上还是有点怪</strong>：用户会发现，输入框里的文字已经变了，但下面的列表却没反应，要等一下才会更新。这种“脱节”的感觉，总让人觉得有点不自然。</li>
</ol>
<p>那么，有没有更好的办法呢？</p>
<h2 data-id="heading-2">三、主角登场：<code>useDeferredValue</code></h2>
<p>React 18 给我们带来了一个新式武器：<code>useDeferredValue</code>。这个 Hook 可以说是专门为了解决这类问题而生的。</p>
<p>它的核心思想很简单：<strong>允许我们把一个值的更新推迟（defer）到不那么紧急的时候再进行</strong>。</p>
<p>换句话说，它会给我们一个“延迟”版本的值。这个延迟版本的值，会在浏览器空闲的时候，才更新到最新状态。</p>
<p>让我们来看代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useState, useDeferredValue } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [query, setQuery] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>);
  <span class="hljs-keyword">const</span> deferredQuery = <span class="hljs-title function_">useDeferredValue</span>(query);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
        <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> 
        <span class="hljs-attr">value</span>=<span class="hljs-string">{query}</span> 
        <span class="hljs-attr">onChange</span>=<span class="hljs-string">{e</span> =&gt;</span> setQuery(e.target.value)} 
      /&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">SlowList</span> <span class="hljs-attr">text</span>=<span class="hljs-string">{deferredQuery}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>看到没，我们把 <code>query</code> 这个 state 传给了 <code>useDeferredValue</code>，得到了一个新的变量 <code>deferredQuery</code>。然后，我们把 <code>deferredQuery</code> 传给了那个很慢的列表组件 <code>&lt;SlowList&gt;</code>。</p>
<p>这里发生了什么神奇的事情呢？</p>
<ol>
<li>当用户在输入框里输入时，<code>query</code> 的值会立刻更新。</li>
<li><code>App</code> 组件会立刻重新渲染。</li>
<li>但是，<code>deferredQuery</code> 的值并不会立刻变成最新的 <code>query</code>。它会保持上一次的值。</li>
<li>React 会先用旧的 <code>deferredQuery</code> 渲染一次 <code>&lt;SlowList&gt;</code>。因为 props 没有变，如果 <code>&lt;SlowList&gt;</code> 被 <code>React.memo</code> 包裹了，它就不会重新渲染，UI 也就不会卡顿。</li>
<li>然后，React 会在后台启动一个低优先级的渲染，把 <code>deferredQuery</code> 更新到最新的 <code>query</code>。</li>
<li>如果在这个低优先级渲染完成之前，用户又输入了新的内容，React 就会中断这次渲染，重新开始一个新的高优先级渲染（只更新输入框），然后再安排一个新的低优先级渲染（更新列表）。</li>
</ol>
<p>这样一来，用户的输入操作永远是最高优先级的，输入框的响应会非常快，非常丝滑。而那个耗时的列表渲染，则被推迟到了浏览器不忙的时候再进行，不会阻塞用户的操作。</p>
<h2 data-id="heading-3">四、两个需要注意的地方</h2>
<h3 data-id="heading-4"><code>React.memo</code> 或 <code>useMemo</code></h3>
<p><code>useDeferredValue</code> 的威力，需要和 <code>React.memo</code> 或 <code>useMemo</code> 配合才能完全发挥出来。</p>
<p>如果你的慢组件没有用 <code>React.memo</code> 包裹，那即使 <code>deferredQuery</code> 还是旧的值，组件也还是会重新渲染，那就白搭了。</p>
<p><strong>方案一：使用 <code>React.memo</code></strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">SlowList</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">memo</span>(<span class="hljs-keyword">function</span> <span class="hljs-title function_">SlowList</span>(<span class="hljs-params">{ text }</span>) {
  <span class="hljs-comment">// ... 耗时的列表渲染逻辑</span>
});
</code></pre>
<p><strong>方案二：使用 <code>useMemo</code></strong></p>
<p>如果你不想单独抽离一个组件，也可以用 <code>useMemo</code> 来缓存渲染结果：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [query, setQuery] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>);
  <span class="hljs-keyword">const</span> deferredQuery = <span class="hljs-title function_">useDeferredValue</span>(query);

  <span class="hljs-keyword">const</span> slowList = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">SlowList</span> <span class="hljs-attr">text</span>=<span class="hljs-string">{deferredQuery}</span> /&gt;</span></span>;
  }, [deferredQuery]);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
        <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> 
        <span class="hljs-attr">value</span>=<span class="hljs-string">{query}</span> 
        <span class="hljs-attr">onChange</span>=<span class="hljs-string">{e</span> =&gt;</span> setQuery(e.target.value)} 
      /&gt;
      {slowList}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>这样，只有当 <code>deferredQuery</code> 变化时，<code>&lt;SlowList&gt;</code> 才会重新渲染。</p>
<h2 data-id="heading-5">五、给用户一个加载提示</h2>
<p><code>useDeferredValue</code> 还有一个很贴心的功能：我们可以通过比较原始值和延迟值是否相等，来判断那个慢的更新是否还在“路上”。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> isStale = query !== deferredQuery;

<span class="hljs-keyword">return</span> (
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
      <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> 
      <span class="hljs-attr">value</span>=<span class="hljs-string">{query}</span> 
      <span class="hljs-attr">onChange</span>=<span class="hljs-string">{e</span> =&gt;</span> setQuery(e.target.value)} 
    /&gt;
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">opacity:</span> <span class="hljs-attr">isStale</span> ? <span class="hljs-attr">0.5</span> <span class="hljs-attr">:</span> <span class="hljs-attr">1</span> }}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">SlowList</span> <span class="hljs-attr">text</span>=<span class="hljs-string">{deferredQuery}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
);
</code></pre>
<p>当 <code>query</code> 和 <code>deferredQuery</code> 不相等时，就说明列表的更新正在被延迟。这时候，我们可以给列表一个半透明的样式，或者显示一个 loading 图标，告诉用户：“别急，马上就来！”</p>
<h2 data-id="heading-6">六、总结一下</h2>
<p><code>useDeferredValue</code> 是一个非常强大的性能优化工具，它让我们能够优雅地处理那些“高优先级”和“低优先级”的渲染任务，让应用在各种设备上都能保持流畅的交互体验。</p>
<p>下次再遇到类似的卡顿问题时，不妨试试 <code>useDeferredValue</code>。它可能会给你带来意想不到的惊喜。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大文件分片上传实战：Vue3 + NestJS 实现秒传、断点续传、并发与失败重试（附完整代码）]]></title>    <link>https://juejin.cn/post/7599543345980637211</link>    <guid>https://juejin.cn/post/7599543345980637211</guid>    <pubDate>2026-01-26T12:14:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599543345980637211" data-draft-id="7599528186587054090" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大文件分片上传实战：Vue3 + NestJS 实现秒传、断点续传、并发与失败重试（附完整代码）"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2026-01-26T12:14:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="hypoy"/> <meta itemprop="url" content="https://juejin.cn/user/3074670624777223"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大文件分片上传实战：Vue3 + NestJS 实现秒传、断点续传、并发与失败重试（附完整代码）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3074670624777223/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    hypoy
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T12:14:38.000Z" title="Mon Jan 26 2026 12:14:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    18
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">大文件分片上传实战：Vue3 + NestJS 实现秒传、断点续传、并发与失败重试（附完整代码）</h2>
<p>最近在回顾项目里“大文件上传”相关的实现，顺手把大文件 <strong>分片上传</strong> 这一块重新整理了一遍。实际踩过坑之后会发现，上传并不是“选文件 → 发请求”这么简单：文件越大，越容易遇到网络抖动导致失败、页面刷新后进度丢失、失败后只能重传、重复上传浪费带宽，以及单请求上传速度慢且不可控等问题。</p>
<p>因此这次复盘里，把上传流程拆成了一条更可控的链路：先用 <strong>hash</strong> 作为文件唯一指纹，支持 <strong>秒传</strong> 与 <strong>断点续传</strong>；再把文件按固定大小进行 <strong>切片</strong>，配合 <strong>并发上传</strong> 提升吞吐，遇到失败则通过 <strong>指数退避重试</strong> 提高弱网场景下的成功率；最后由服务端按序 <strong>合并分片并清理临时文件</strong>，形成完整闭环。基于这套思路，实现了一套大文件分片上传方案，核心能力包括：</p>
<ul>
<li><strong>文件分片</strong>：默认 5MB（可配置）</li>
<li><strong>Hash 指纹</strong>：使用 SparkMD5，并放到 Web Worker 里计算，避免阻塞 UI</li>
<li><strong>并发上传</strong>：默认 3 并发</li>
<li><strong>失败重试</strong>：默认 3 次，指数退避</li>
<li><strong>断点续传</strong>：服务端返回已上传分片列表，前端跳过已完成分片</li>
<li><strong>秒传</strong>：服务端已存在相同 hash 的文件时直接返回成功</li>
<li><strong>安全合并</strong>：服务端按序合并并清理临时分片目录</li>
</ul>
<p>技术栈：</p>
<ul>
<li>前端：Vue 3 + TypeScript + Vite</li>
<li>后端：NestJS + TypeScript</li>
<li>Hash：SparkMD5（Web Worker）</li>
</ul>
<hr/>
<h3 data-id="heading-1">1. 整体流程与接口设计</h3>
<p>整个系统围绕四个接口构建：</p>






























<table><thead><tr><th>端点</th><th>方法</th><th>功能</th></tr></thead><tbody><tr><td><code>/upload/check</code></td><td>POST</td><td>秒传检测：是否已存在同 hash 文件</td></tr><tr><td><code>/upload/chunks</code></td><td>GET</td><td>查询已上传分片：断点续传的基础</td></tr><tr><td><code>/upload/chunk</code></td><td>POST</td><td>上传单个分片</td></tr><tr><td><code>/upload/merge</code></td><td>POST</td><td>合并分片并返回最终文件 URL</td></tr></tbody></table>
<p>上传时序：</p>
<ol>
<li>选择文件</li>
<li>Web Worker 计算文件 hash</li>
<li>秒传检测：命中则直接成功</li>
<li>查询已上传分片：断点续传</li>
<li>5MB 切片</li>
<li>并发上传未完成分片（默认 3）</li>
<li>请求合并</li>
<li>返回文件访问地址</li>
</ol>
<hr/>
<h3 data-id="heading-2">2. 前端：API 封装（api.ts）</h3>
<h4 data-id="heading-3">2.1 环境配置：开发直连、生产走反代</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">BASE_URL</span> = <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">PROD</span> ? <span class="hljs-string">''</span> : <span class="hljs-string">'http://localhost:3000'</span>;
</code></pre>
<ul>
<li>开发环境直接请求后端 <code>3000</code></li>
<li>生产环境使用相对路径，交给 Nginx 反向代理转发</li>
</ul>
<h4 data-id="heading-4">2.2 秒传检测：checkFile</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">checkFile</span>(<span class="hljs-params">hash: <span class="hljs-built_in">string</span>, filename: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`<span class="hljs-subst">${BASE_URL}</span>/upload/check`</span>, {
    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
    <span class="hljs-attr">headers</span>: { <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span> },
    <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ hash, filename }),
  });
  <span class="hljs-keyword">return</span> response.<span class="hljs-title function_">json</span>();
}
</code></pre>
<p>服务端如果已有同 hash 文件，会返回 <code>{ exists: true, url }</code>，前端可以直接结束上传流程。</p>
<h4 data-id="heading-5">2.3 断点续传：getUploadedChunks</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getUploadedChunks</span>(<span class="hljs-params">hash: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`<span class="hljs-subst">${BASE_URL}</span>/upload/chunks?hash=<span class="hljs-subst">${hash}</span>`</span>);
  <span class="hljs-keyword">return</span> response.<span class="hljs-title function_">json</span>();
}
</code></pre>
<p>该接口返回已上传的分片索引数组，前端据此跳过已完成分片，继续上传剩余部分。</p>
<h4 data-id="heading-6">2.4 分片上传：uploadChunk（XHR 支持进度）</h4>
<p>为了拿到上传进度，分片上传使用 <code>XMLHttpRequest</code>：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">uploadChunk</span>(<span class="hljs-params">hash, chunkIndex, chunk, filename, onProgress?</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> formData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormData</span>();
    formData.<span class="hljs-title function_">append</span>(<span class="hljs-string">'hash'</span>, hash);
    formData.<span class="hljs-title function_">append</span>(<span class="hljs-string">'chunkIndex'</span>, <span class="hljs-title class_">String</span>(chunkIndex));
    formData.<span class="hljs-title function_">append</span>(<span class="hljs-string">'filename'</span>, filename);
    formData.<span class="hljs-title function_">append</span>(<span class="hljs-string">'file'</span>, chunk);

    <span class="hljs-keyword">const</span> xhr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();
    xhr.<span class="hljs-title function_">open</span>(<span class="hljs-string">'POST'</span>, <span class="hljs-string">`<span class="hljs-subst">${BASE_URL}</span>/upload/chunk`</span>);

    xhr.<span class="hljs-property">upload</span>.<span class="hljs-property">onprogress</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (event.<span class="hljs-property">lengthComputable</span> &amp;&amp; onProgress) {
        <span class="hljs-title function_">onProgress</span>(event.<span class="hljs-property">loaded</span>, event.<span class="hljs-property">total</span>);
      }
    };

    xhr.<span class="hljs-property">onload</span> = <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">if</span> (xhr.<span class="hljs-property">status</span> &gt;= <span class="hljs-number">200</span> &amp;&amp; xhr.<span class="hljs-property">status</span> &lt; <span class="hljs-number">300</span>) {
        <span class="hljs-title function_">resolve</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(xhr.<span class="hljs-property">responseText</span>));
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Upload failed with status <span class="hljs-subst">${xhr.status}</span>`</span>));
      }
    };

    xhr.<span class="hljs-property">onerror</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Network error'</span>));
    xhr.<span class="hljs-title function_">send</span>(formData);
  });
}
</code></pre>
<h4 data-id="heading-7">2.5 合并分片：mergeChunks</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">mergeChunks</span>(<span class="hljs-params">hash: <span class="hljs-built_in">string</span>, filename: <span class="hljs-built_in">string</span>, totalChunks: <span class="hljs-built_in">number</span></span>) {
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`<span class="hljs-subst">${BASE_URL}</span>/upload/merge`</span>, {
    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
    <span class="hljs-attr">headers</span>: { <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span> },
    <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ hash, filename, totalChunks }),
  });
  <span class="hljs-keyword">return</span> response.<span class="hljs-title function_">json</span>();
}
</code></pre>
<hr/>
<h3 data-id="heading-8">3. 前端：Worker 计算 Hash（hash-worker.ts）</h3>
<p>大文件 MD5 的计算如果放在主线程，会造成明显卡顿。为了解决这个问题，采用 Web Worker 在后台分块读取文件并计算 SparkMD5。</p>
<p>Worker 内部按 2MB 分块计算：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> <span class="hljs-title class_">SparkMD5</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'spark-md5'</span>;

self.<span class="hljs-property">onmessage</span> = <span class="hljs-keyword">async</span> (<span class="hljs-attr">e</span>: <span class="hljs-title class_">MessageEvent</span>&lt;<span class="hljs-title class_">File</span>&gt;) =&gt; {
  <span class="hljs-keyword">const</span> file = e.<span class="hljs-property">data</span>;
  <span class="hljs-keyword">const</span> chunkSize = <span class="hljs-number">2</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;
  <span class="hljs-keyword">const</span> chunks = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">ceil</span>(file.<span class="hljs-property">size</span> / chunkSize);
  <span class="hljs-keyword">const</span> spark = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SparkMD5</span>.<span class="hljs-title class_">ArrayBuffer</span>();

  <span class="hljs-keyword">let</span> currentChunk = <span class="hljs-number">0</span>;

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">loadNext</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> start = currentChunk * chunkSize;
    <span class="hljs-keyword">const</span> end = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(start + chunkSize, file.<span class="hljs-property">size</span>);
    <span class="hljs-keyword">const</span> reader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileReader</span>();

    reader.<span class="hljs-property">onload</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (event.<span class="hljs-property">target</span>?.<span class="hljs-property">result</span>) {
        spark.<span class="hljs-title function_">append</span>(event.<span class="hljs-property">target</span>.<span class="hljs-property">result</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">ArrayBuffer</span>);
      }
      currentChunk++;

      self.<span class="hljs-title function_">postMessage</span>({
        <span class="hljs-attr">type</span>: <span class="hljs-string">'progress'</span>,
        <span class="hljs-attr">progress</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>((currentChunk / chunks) * <span class="hljs-number">100</span>),
      });

      <span class="hljs-keyword">if</span> (currentChunk &lt; chunks) {
        <span class="hljs-title function_">loadNext</span>();
      } <span class="hljs-keyword">else</span> {
        self.<span class="hljs-title function_">postMessage</span>({
          <span class="hljs-attr">type</span>: <span class="hljs-string">'complete'</span>,
          <span class="hljs-attr">hash</span>: spark.<span class="hljs-title function_">end</span>(),
        });
      }
    };

    reader.<span class="hljs-property">onerror</span> = <span class="hljs-function">() =&gt;</span> {
      self.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'error'</span>, <span class="hljs-attr">error</span>: <span class="hljs-string">'Failed to read file'</span> });
    };

    reader.<span class="hljs-title function_">readAsArrayBuffer</span>(file.<span class="hljs-title function_">slice</span>(start, end));
  };

  <span class="hljs-title function_">loadNext</span>();
};

<span class="hljs-keyword">export</span> {};
</code></pre>
<p>主线程侧通过 <code>calculateHash()</code> 监听 <code>progress / complete / error</code> 三种消息，实现 hash 进度展示与结果回传。</p>
<hr/>
<h3 data-id="heading-9">4. 前端：上传引擎（uploader.ts）</h3>
<p>上传引擎负责把“hash → 秒传 → 断点 → 并发 → 重试 → 合并”的全流程串起来，同时以统一的 <code>UploadProgress</code> 对外输出进度。</p>
<h4 data-id="heading-10">4.1 进度结构：UploadProgress</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-attr">status</span>: <span class="hljs-string">'hashing'</span> | <span class="hljs-string">'checking'</span> | <span class="hljs-string">'uploading'</span> | <span class="hljs-string">'merging'</span> | <span class="hljs-string">'success'</span> | <span class="hljs-string">'error'</span>
percentage, uploadedChunks, totalChunks, uploadedBytes, totalBytes, message
</code></pre>
<p>组件只需要订阅 <code>onProgress</code>，无需关心内部实现细节。</p>
<h4 data-id="heading-11">4.2 文件分片：sliceFile</h4>
<p>默认分片大小为 5MB（可配置）：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DEFAULT_CHUNK_SIZE</span> = <span class="hljs-number">5</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;
</code></pre>
<p>分片函数：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> <span class="hljs-title function_">sliceFile</span>(<span class="hljs-params">file: File, chunkSize: <span class="hljs-built_in">number</span></span>): <span class="hljs-title class_">Blob</span>[] {
  <span class="hljs-keyword">const</span> <span class="hljs-attr">chunks</span>: <span class="hljs-title class_">Blob</span>[] = [];
  <span class="hljs-keyword">let</span> start = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">while</span> (start &lt; file.<span class="hljs-property">size</span>) {
    <span class="hljs-keyword">const</span> end = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(start + chunkSize, file.<span class="hljs-property">size</span>);
    chunks.<span class="hljs-title function_">push</span>(file.<span class="hljs-title function_">slice</span>(start, end));
    start = end;
  }
  <span class="hljs-keyword">return</span> chunks;
}
</code></pre>
<h4 data-id="heading-12">4.3 单分片失败重试：指数退避</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">uploadChunkWithRetry</span>(<span class="hljs-params">hash, chunkIndex, chunk, filename, maxRetries</span>) {
  <span class="hljs-keyword">let</span> <span class="hljs-attr">lastError</span>: <span class="hljs-title class_">Error</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> attempt = <span class="hljs-number">0</span>; attempt &lt;= maxRetries; attempt++) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">uploadChunk</span>(hash, chunkIndex, chunk, filename);
      <span class="hljs-keyword">return</span>;
    } <span class="hljs-keyword">catch</span> (error) {
      lastError = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">Error</span>;
      <span class="hljs-keyword">if</span> (attempt &lt; maxRetries) {
        <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(<span class="hljs-number">2</span>, attempt) * <span class="hljs-number">1000</span>));
      }
    }
  }
  <span class="hljs-keyword">throw</span> lastError;
}
</code></pre>
<h4 data-id="heading-13">4.4 并发上传：runConcurrent</h4>
<p>并发控制默认 3：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DEFAULT_CONCURRENCY</span> = <span class="hljs-number">3</span>;
</code></pre>
<p>并发调度逻辑按任务队列执行，同时限制最大并行数。</p>
<h4 data-id="heading-14">4.5 主流程：uploadFile</h4>
<p>上传入口 <code>uploadFile()</code> 按照以下顺序执行：</p>
<ol>
<li>计算 hash（Worker）</li>
<li>秒传检测（存在则直接返回）</li>
<li>获取已上传分片列表（断点续传）</li>
<li>切片并过滤掉已存在分片</li>
<li>并发上传剩余分片（失败自动重试）</li>
<li>合并分片</li>
<li>返回最终文件 URL</li>
</ol>
<p>此外，已上传的字节数会根据已存在分片提前累加，让断点续传的进度展示更准确。</p>
<hr/>
<h3 data-id="heading-15">5. 前端 UI：Hy-Upload.vue</h3>
<p>组件层提供了较完整的上传体验：</p>
<ul>
<li>点击选择文件 / 拖拽上传</li>
<li>自动上传（autoUpload）</li>
<li>上传状态图标与提示文案</li>
<li>进度条与百分比展示</li>
<li>上传成功展示 URL</li>
<li>失败后支持一键重置重新上传</li>
</ul>
<p>组件内部不关心上传细节，只需要调用 <code>uploadFile()</code> 并把进度回传即可。</p>
<hr/>
<h3 data-id="heading-16">6. 后端：NestJS 分片存储与合并</h3>
<p>后端使用 <code>UploadController</code> + <code>UploadService</code> 实现分片落盘、断点查询、最终合并与清理。</p>
<h4 data-id="heading-17">6.1 接收分片：/upload/chunk</h4>
<p>使用 multer 先存入临时目录：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-meta">@UseInterceptors</span>(<span class="hljs-title class_">FileInterceptor</span>(<span class="hljs-string">'file'</span>, { <span class="hljs-attr">dest</span>: <span class="hljs-string">'uploads/temp'</span> }))
</code></pre>
<p>然后移动到分片目录：</p>
<pre><code class="hljs language-bash" lang="bash">uploads/chunks/{<span class="hljs-built_in">hash</span>}/{chunkIndex}
</code></pre>
<h4 data-id="heading-18">6.2 秒传：/upload/check</h4>
<p>最终文件路径采用 <code>hash + ext</code> 的方式生成：</p>
<pre><code class="hljs language-bash" lang="bash">uploads/{<span class="hljs-built_in">hash</span>}{ext}
</code></pre>
<p>如果文件存在，返回可访问 URL：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">return</span> { <span class="hljs-attr">exists</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">url</span>: <span class="hljs-string">`/uploads/<span class="hljs-subst">${hash}</span><span class="hljs-subst">${ext}</span>`</span> };
</code></pre>
<h4 data-id="heading-19">6.3 断点续传：/upload/chunks</h4>
<p>读取 <code>uploads/chunks/{hash}</code> 目录下已有分片文件名，转成 index 数组返回，供前端跳过已完成分片。</p>
<h4 data-id="heading-20">6.4 合并：/upload/merge</h4>
<p>合并前会校验：</p>
<ul>
<li>分片数量是否完整</li>
<li>是否缺少某个分片（0..totalChunks-1）</li>
</ul>
<p>合并成功后清理 chunk 目录，返回最终 URL。</p>
<hr/>
<h3 data-id="heading-21">8. 总结</h3>
<p>这套大文件分片上传方案的核心思路，是把“上传”拆成一条可控、可恢复的链路：以 <strong>hash</strong> 作为文件唯一指纹，让相同文件具备 <strong>秒传</strong> 能力，并且在页面刷新后通过查询已上传分片实现 <strong>断点续传</strong>；hash 计算放到 <strong>Web Worker</strong> 中执行，避免大文件指纹计算阻塞主线程；上传阶段通过 <strong>并发</strong> 提升吞吐，通过 <strong>失败重试（指数退避）</strong> 增强弱网场景下的成功率；最终由服务端 <strong>按序合并分片并清理临时目录</strong>，实现从上传到落盘的完整闭环。</p>
<p>受时间精力所限，一些更贴近生产环境的能力暂时还未补齐，不过后续的可扩展方向已经梳理清楚：合并阶段可以升级为 <strong>流式合并</strong>，降低内存峰值并提升并发稳定性；进度展示可以改为基于 <code>onprogress</code> 的 <strong>实时累计</strong>，让进度更平滑、更可信；同时加入 <strong>分片过期清理机制</strong>，避免中断上传后分片长期残留占用磁盘。等后续逐步把这些点落地，整体的稳定性、可维护性以及使用体验都会进一步提升。</p>
<h3 data-id="heading-22">项目地址</h3>
<p>完整代码已开源：</p>
<ul>
<li>GitHub: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTheproudcold%2Flarge-file-sharding-upload" target="_blank" title="https://github.com/Theproudcold/large-file-sharding-upload" ref="nofollow noopener noreferrer">github.com/Theproudcol…</a></li>
</ul>
<p>欢迎 Star / 提 Issue / PR，一起完善功能（例如流式合并、实时进度、分片过期清理等）。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【鸿蒙开发教程】手把手教你开发碰一碰加好友功能]]></title>    <link>https://juejin.cn/post/7599514071105060879</link>    <guid>https://juejin.cn/post/7599514071105060879</guid>    <pubDate>2026-01-26T12:13:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599514071105060879" data-draft-id="7599526246503284770" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【鸿蒙开发教程】手把手教你开发碰一碰加好友功能"/> <meta itemprop="keywords" content="HarmonyOS,前端"/> <meta itemprop="datePublished" content="2026-01-26T12:13:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="不喝水会渴"/> <meta itemprop="url" content="https://juejin.cn/user/1084533994686547"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【鸿蒙开发教程】手把手教你开发碰一碰加好友功能
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1084533994686547/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    不喝水会渴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T12:13:56.000Z" title="Mon Jan 26 2026 12:13:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">手把手教你开发鸿蒙碰一碰加好友功能：告别扫码，贴贴就加友！</h2>
<p>还在为加好友扫半天二维码、输一串数字抓狂？鸿蒙的“碰一碰”功能直接把加好友简化到“贴贴就行”！不用搜、不用输，两台手机轻轻一碰，好友信息自动飞过去，主打一个“近在咫尺，一键加友”。今天就手把手带你把这个神仙功能搬进自己的App，以喵屿App的碰一碰加宠物好友为例，从原理到实战，包教包会～</p>
<h3 data-id="heading-1">● 碰一碰功能介绍</h3>
<p>碰一碰分享本质上是鸿蒙Share Kit的“隐藏彩蛋”，支持用户通过设备轻碰发起跨端分享，不管是传图片、共享Wi-Fi，还是咱今天要搞的加好友，都能搞定。更爽的是：只要你的应用支持系统分享，理论上不用额外魔改，就能解锁碰一碰能力，简直是懒人开发者的福音！</p>
<p><strong>流程说明：</strong>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48110f763be24a4185cba3aae51ad5dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5Zad5rC05Lya5ri0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770034436&amp;x-signature=ARu9tKfk%2B6o6lbJs5Xb24AODUrs%3D" alt="Alt" loading="lazy"/></p>
<ol>
<li>先给自家应用“注册”碰一碰分享事件，然后让两部亮屏解锁的手机来个“贴贴”（就像朋友握手一样）；</li>
<li>应用发现“贴贴”触发后，会调用碰一碰分享回调，咱在回调里把要分享的好友数据打包发出去；</li>
<li>对方手机接住数据，乖乖处理；</li>
<li>事儿办完了，记得解除注册，别让应用“占着茅坑不拉屎”～</li>
</ol>
<p><strong>使用约束（划重点！不然贴贴也白贴）</strong>
想让俩手机顺利贴贴传好友，得满足几个小条件：双端设备都得亮屏、解锁（总不能黑屏贴贴吧，手机也得“醒着”才知道要干活），而且华为分享服务得开着（系统默认开的，除非你手欠手动关了）。贴的时候得用手机顶部碰，不是随便怼哪里都管用哈～如果华为分享关了，碰的时候系统会贴心提醒你打开，不用慌。</p>
<p>链接: <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-guides%2Fknock-share-between-phones-overview" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/knock-share-between-phones-overview" ref="nofollow noopener noreferrer">碰一碰功能介绍</a></p>
<h3 data-id="heading-2">● 简单的碰一碰实现</h3>
<p>先从最简单的图片分享入手，带你尝尝碰一碰的甜头！其实鸿蒙的碰一碰超友好，只要你的应用支持系统分享，几乎不用额外折腾，几行代码就能搞定，看</p>
<pre><code class="hljs language-javascript" lang="javascript"> private <span class="hljs-keyword">async</span> <span class="hljs-title function_">handelShare</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt; {
    <span class="hljs-keyword">const</span> <span class="hljs-attr">uiContext</span>: <span class="hljs-title class_">UIContext</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>();
    <span class="hljs-comment">//需设置本地图片链接</span>
    <span class="hljs-keyword">let</span> filePath = <span class="hljs-variable language_">this</span>.<span class="hljs-property">ImgData</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">curIndex</span>];
    <span class="hljs-keyword">let</span> utdTypeId = utd.<span class="hljs-title function_">getUniformDataTypeByFilenameExtension</span>(<span class="hljs-string">'.png'</span>, utd.<span class="hljs-property">UniformDataType</span>.<span class="hljs-property">IMAGE</span>);
    <span class="hljs-keyword">let</span> <span class="hljs-attr">shareData</span>: systemShare.<span class="hljs-property">SharedData</span> = <span class="hljs-keyword">new</span> systemShare.<span class="hljs-title class_">SharedData</span>({
      <span class="hljs-attr">utd</span>: utdTypeId,
      <span class="hljs-attr">uri</span>: fileUri.<span class="hljs-title function_">getUriFromPath</span>(filePath),
      <span class="hljs-attr">title</span>: <span class="hljs-string">'喵屿图片分享'</span>,
    });
    <span class="hljs-keyword">let</span> <span class="hljs-attr">controller</span>: systemShare.<span class="hljs-property">ShareController</span> = <span class="hljs-keyword">new</span> systemShare.<span class="hljs-title class_">ShareController</span>(shareData);
    <span class="hljs-keyword">const</span> <span class="hljs-attr">context</span>: common.<span class="hljs-property">UIAbilityContext</span> = uiContext.<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;
    controller.<span class="hljs-title function_">show</span>(context, {
      <span class="hljs-attr">previewMode</span>: systemShare.<span class="hljs-property">SharePreviewMode</span>.<span class="hljs-property">DETAIL</span>,
      <span class="hljs-attr">selectionMode</span>: systemShare.<span class="hljs-property">SelectionMode</span>.<span class="hljs-property">BATCH</span>,
    }).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
      logger.<span class="hljs-title function_">info</span>(<span class="hljs-string">'HuaweiShare_ show'</span>);
    }).<span class="hljs-keyword">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {
      logger.<span class="hljs-title function_">error</span>(<span class="hljs-string">`HuaweiShare_ show error. Code: <span class="hljs-subst">${error?.code}</span>, message: <span class="hljs-subst">${error?.message}</span>`</span>);
    });
  }
</code></pre>
<p>就这么几行，把本地图片路径填好，调用系统分享Kit，分享界面里就自带碰一碰功能了，是不是比凑半天二维码轻松多了？</p>
<h3 data-id="heading-3">● 碰一碰拉起指定应用（Deeplink的使用）</h3>
<p>但是问题来了：默认分享的图片、文本这些，会被图库、浏览器这些“路人甲”应用打开，咱要的是直接拉起自己的App加好友啊！总不能让用户碰完，结果跳去浏览器，那也太掉链子了。</p>
<p>系统早就想到这点了，给了俩解决方案：一是分享Applinking/Deeplink形式的链接，二是指定应用直达（6.0.0(20) Beta3新功能，咱今天先不唠这个）。Applinking和Deeplink的区别简单说：Applinking如果对方没装你家App，会跳浏览器或应用市场，Deeplink只会告诉你没有对应应用；Deeplink的配置更简单，咱今天就拿捏它！</p>
<p>想用Deeplink让分享内容精准跳自家App，第一步得给App“贴标签”——在module.json5里配置skills标签，相当于给系统说：“这个链接只能我家App接，别乱分给别人！”示例如下：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-comment">// ···</span>
    <span class="hljs-attr">"abilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-comment">// ···</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-comment">// ···</span>
        <span class="hljs-attr">"skills"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
          <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"entities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
              <span class="hljs-string">"entity.system.home"</span>
            <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"actions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
              <span class="hljs-string">"ohos.want.action.home"</span>
            <span class="hljs-punctuation">]</span>
          <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
          <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"actions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
              <span class="hljs-comment">// actions不能为空，actions为空会造成目标方匹配失败。</span>
              <span class="hljs-string">"ohos.want.action.viewData"</span>
            <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"uris"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
              <span class="hljs-punctuation">{</span>
                <span class="hljs-comment">// scheme必选，可以自定义，以link为例，需要替换为实际的scheme</span>
                <span class="hljs-attr">"scheme"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"link"</span><span class="hljs-punctuation">,</span>
                <span class="hljs-attr">"host"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"www.example.com"</span>
              <span class="hljs-punctuation">}</span>
            <span class="hljs-punctuation">]</span>
          <span class="hljs-punctuation">}</span> <span class="hljs-comment">// 新增一个skill对象，用于跳转场景。如果存在多个跳转场景，需配置多个skill对象。</span>
        <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-comment">// ···</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-comment">// ···</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>配置完标签，还得让App知道“接了链接该干啥”——在目标应用的UIAbility的onCreate()或者onNewWant()里解析链接参数，比如拿到好友信息后，就可以触发加好友逻辑了：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 以DeepAbility.ets为例</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AbilityConstant</span>, <span class="hljs-title class_">UIAbility</span>, <span class="hljs-title class_">Want</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;
<span class="hljs-keyword">import</span> { url } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DOMAIN</span> = <span class="hljs-number">0x0000</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DeepAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {
  <span class="hljs-title function_">onCreate</span>(<span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span>, <span class="hljs-attr">launchParam</span>: <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">LaunchParam</span>): <span class="hljs-keyword">void</span> {
    <span class="hljs-comment">// 从want中获取传入的链接信息。</span>
    <span class="hljs-comment">// 如传入的url为：link://www.example.com/programs?action=showall</span>
    <span class="hljs-keyword">let</span> uri = want?.<span class="hljs-property">uri</span>;
    <span class="hljs-keyword">if</span> (uri) {
      <span class="hljs-comment">// 从链接中解析query参数，拿到参数后，开发者可根据自己的业务需求进行后续的处理。</span>
      <span class="hljs-keyword">let</span> urlObject = url.<span class="hljs-property">URL</span>.<span class="hljs-title function_">parseURL</span>(want?.<span class="hljs-property">uri</span>);
      <span class="hljs-keyword">let</span> action = urlObject.<span class="hljs-property">params</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'action'</span>);
      <span class="hljs-comment">// 例如，当action为showall时，展示所有的节目。</span>
      <span class="hljs-keyword">if</span> (action === <span class="hljs-string">'showall'</span>) {
        <span class="hljs-comment">// ···</span>
      }
    }
  }
<span class="hljs-comment">// ···</span>
}
</code></pre>
<p>说白了，想让碰一碰拉起指定App干指定事，只要分享的时候把Deeplink链接发出去就行，系统会自动帮你找对App。不过上面都是靠系统分享界面实现的，有没有更“私密”的玩法，不用走系统界面？必须有！直接注册'knockShare'监听，就能自己掌控碰一碰的全过程，看官方代码👇</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { uniformTypeDescriptor <span class="hljs-keyword">as</span> utd } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkData'</span>;
<span class="hljs-keyword">import</span> { systemShare, harmonyShare } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ShareKit'</span>;
<span class="hljs-keyword">import</span> { fileUri } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;

@<span class="hljs-title class_">Component</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> struct <span class="hljs-title class_">Index</span> {
  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-keyword">void</span> {
    <span class="hljs-keyword">let</span> <span class="hljs-attr">capabilityRegistry</span>: harmonyShare.<span class="hljs-property">SendCapabilityRegistry</span> = {
      <span class="hljs-attr">windowId</span>: <span class="hljs-number">999</span>, <span class="hljs-comment">// 此值仅为示例 实际使用时请替换正确的windowId</span>
    }
    harmonyShare.<span class="hljs-title function_">on</span>(<span class="hljs-string">'knockShare'</span>, capabilityRegistry, <span class="hljs-function">(<span class="hljs-params">sharableTarget: harmonyShare.SharableTarget</span>) =&gt;</span> {
      <span class="hljs-keyword">let</span> <span class="hljs-attr">shareData</span>: systemShare.<span class="hljs-property">SharedData</span> = <span class="hljs-keyword">new</span> systemShare.<span class="hljs-title class_">SharedData</span>({
        <span class="hljs-attr">utd</span>: utd.<span class="hljs-property">UniformDataType</span>.<span class="hljs-property">HYPERLINK</span>,
        <span class="hljs-attr">content</span>: <span class="hljs-string">'https://sharekitdemo.drcn.agconnect.link/ZB3p'</span>,
        <span class="hljs-comment">// 根据title,description,thumbnailUri会生成不同的卡片模板，具体可参考设置配套的卡片样式。</span>
        <span class="hljs-attr">title</span>: <span class="hljs-string">'碰一碰分享卡片标题'</span>,
        <span class="hljs-attr">description</span>: <span class="hljs-string">'碰一碰分享卡片描述'</span>
      });
      <span class="hljs-comment">// 若云端预览图无法及时下载 可先发送数据</span>
      sharableTarget.<span class="hljs-title function_">share</span>(shareData);

      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-comment">// 待预览图下载完成后 补充更新预览图</span>
        <span class="hljs-keyword">let</span> <span class="hljs-attr">uiContext</span>: <span class="hljs-title class_">UIContext</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>();
        <span class="hljs-keyword">let</span> <span class="hljs-attr">contextFaker</span>: <span class="hljs-title class_">Context</span> = uiContext.<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> <span class="hljs-title class_">Context</span>;
        <span class="hljs-keyword">let</span> filePath = contextFaker.<span class="hljs-property">filesDir</span> + <span class="hljs-string">'/exampleKnock1.jpg'</span>; <span class="hljs-comment">// 仅为示例 请替换正确的文件路径</span>
        sharableTarget.<span class="hljs-title function_">updateShareData</span>({
          <span class="hljs-attr">thumbnailUri</span>: fileUri.<span class="hljs-title function_">getUriFromPath</span>(filePath)
        });
      }, <span class="hljs-number">5000</span>);
    });
  }

  <span class="hljs-title function_">aboutToDisappear</span>(): <span class="hljs-keyword">void</span> {
    <span class="hljs-keyword">let</span> <span class="hljs-attr">capabilityRegistry</span>: harmonyShare.<span class="hljs-property">SendCapabilityRegistry</span> = {
      <span class="hljs-attr">windowId</span>: <span class="hljs-number">999</span>, <span class="hljs-comment">// 此值仅为示例 实际使用时请替换正确的windowId</span>
    }
    <span class="hljs-comment">// 解除碰一碰分享'knockShare'监听事件</span>
    harmonyShare.<span class="hljs-title function_">off</span>(<span class="hljs-string">'knockShare'</span>, capabilityRegistry);
  }

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
  }
}
</code></pre>
<h3 data-id="heading-4">● 碰一碰加好友功能实战</h3>
<p>光说不练假把式，接下来咱就拿“喵屿App”的碰一碰加宠物好友为例，手把手带你把这个功能落地，让养宠党贴贴手机就能互加宠物好友，再也不用手动输宠物信息啦！</p>
<h4 data-id="heading-5">碰一碰接收端处理</h4>
<p>想让碰一碰跳自家App加好友，第一步得给App“办个身份证”——在module.json5里配置skills标签，告诉系统：“这个链接是我的，别给别人！”</p>
<pre><code class="hljs language-javascript" lang="javascript">   <span class="hljs-string">"abilities"</span>: [
    {
        <span class="hljs-string">"name"</span>: <span class="hljs-string">"EntryAbility"</span>,
        <span class="hljs-string">"srcEntry"</span>: <span class="hljs-string">"./ets/entryability/EntryAbility.ets"</span>,
        <span class="hljs-string">"description"</span>: <span class="hljs-string">"$string:EntryAbility_desc"</span>,
        <span class="hljs-string">"icon"</span>: <span class="hljs-string">"$media:layered_image"</span>,
        <span class="hljs-string">"label"</span>: <span class="hljs-string">"$string:EntryAbility_label"</span>,
        <span class="hljs-string">"startWindowIcon"</span> : <span class="hljs-string">"$media:layered_image"</span>,
        <span class="hljs-string">"startWindowBackground"</span> : <span class="hljs-string">"$color:start_window_background"</span>
          ,
        <span class="hljs-string">"exported"</span>: <span class="hljs-literal">true</span>
          ,
        <span class="hljs-string">"skills"</span>: [
          {
            <span class="hljs-string">"entities"</span>: [
              <span class="hljs-string">"entity.system.home"</span>
            ],
            <span class="hljs-string">"actions"</span>: [
              <span class="hljs-string">"ohos.want.action.home"</span>
            ]
          },
          {
            <span class="hljs-string">"actions"</span>: [<span class="hljs-string">"action.system.viewData"</span>],
            <span class="hljs-string">"entities"</span>: [<span class="hljs-string">"entity.system.browser"</span>],
            <span class="hljs-string">"uris"</span>: [
              {
                <span class="hljs-comment">// scheme必选，可以自定义，以catIsland为例，需要替换为实际的scheme</span>
                <span class="hljs-string">"scheme"</span>: <span class="hljs-string">"catIsland"</span>,
                <span class="hljs-string">"host"</span>: <span class="hljs-string">"catIsland.sx.com"</span>
              }
            ]
          } <span class="hljs-comment">// 新增一个skill对象，用于跳转场景。如果存在多个跳转场景，需配置多个skill对象。</span>
        ]
      }]
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c865d7ab1694e63a916c19ec21dd381~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5Zad5rC05Lya5ri0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770034436&amp;x-signature=jRPndb6eY2ofcRQESTZhrCKWGbs%3D" alt="碰一碰然后选择接收数据会走到onCreate()或者onNewWant()生命周期" loading="lazy"/>
<strong>划重点：</strong> 碰一碰接收数据后，App会走onCreate()或onNewWant()生命周期，俩都得处理，不然会漏数据！</p>
<p>然后就得让App“读懂”链接里的好友信息了——在EntryAbility的onCreate()和onNewWant()里解析链接参数，把宠物姓名、性别、生日这些信息抠出来，存到AppStorage里，等着后续处理：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {
  <span class="hljs-title function_">onCreate</span>(<span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span>, <span class="hljs-attr">launchParam</span>: <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">LaunchParam</span>): <span class="hljs-keyword">void</span> {
    <span class="hljs-comment">// 从want中获取传入的链接信息。</span>
    <span class="hljs-comment">// 如传入的url为：catIsland://catIsland.sx.com/share/?name=${info.name}&amp;sex=${info.sex}&amp;birth=${info.birth}&amp;breed=${info.breed}</span>
    <span class="hljs-keyword">let</span> uri = want?.<span class="hljs-property">uri</span>;
    <span class="hljs-keyword">if</span> (uri) {
      <span class="hljs-comment">// 从链接中解析query参数，拿到参数后，开发者可根据自己的业务需求进行后续的处理。</span>
      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onCreate'</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(uri));
      <span class="hljs-keyword">const</span> urlObject = url.<span class="hljs-property">URL</span>.<span class="hljs-title function_">parseURL</span>(want?.<span class="hljs-property">uri</span>);
      <span class="hljs-keyword">const</span> name = urlObject.<span class="hljs-property">params</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'name'</span>);
      <span class="hljs-keyword">const</span> sex = urlObject.<span class="hljs-property">params</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'sex'</span>) ;
      <span class="hljs-keyword">const</span> birth = urlObject.<span class="hljs-property">params</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'birth'</span>);
      <span class="hljs-keyword">const</span> breed = urlObject.<span class="hljs-property">params</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'breed'</span>);
      <span class="hljs-keyword">if</span>(name){
        <span class="hljs-keyword">let</span> baseInfo = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BaseInfo</span>(name)
        baseInfo.<span class="hljs-property">sex</span> = <span class="hljs-title class_">Number</span>(sex)
        baseInfo.<span class="hljs-property">birth</span> = birth
        baseInfo.<span class="hljs-property">breed</span> = breed
        <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'newFriend'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(baseInfo)); <span class="hljs-comment">//数据保存起来</span>
      }
    }

			...
  }

  <span class="hljs-title function_">onNewWant</span>(<span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span>, <span class="hljs-attr">launchParam</span>: <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">LaunchParam</span>): <span class="hljs-keyword">void</span> {
    <span class="hljs-comment">// 从want中获取传入的链接信息。</span>
    <span class="hljs-comment">// 如传入的url为：catIsland://catIsland.sx.com/share/?name=${info.name}&amp;sex=${info.sex}&amp;birth=${info.birth}&amp;breed=${info.breed}</span>
    <span class="hljs-keyword">let</span> uri = want?.<span class="hljs-property">uri</span>;
    <span class="hljs-keyword">if</span> (uri) {
      <span class="hljs-comment">// 从链接中解析query参数，拿到参数后，开发者可根据自己的业务需求进行后续的处理。</span>
      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onCreate'</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(uri));
       <span class="hljs-keyword">const</span> urlObject = url.<span class="hljs-property">URL</span>.<span class="hljs-title function_">parseURL</span>(want?.<span class="hljs-property">uri</span>);
      <span class="hljs-keyword">const</span> name = urlObject.<span class="hljs-property">params</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'name'</span>);
      <span class="hljs-keyword">const</span> sex = urlObject.<span class="hljs-property">params</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'sex'</span>) ;
      <span class="hljs-keyword">const</span> birth = urlObject.<span class="hljs-property">params</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'birth'</span>);
      <span class="hljs-keyword">const</span> breed = urlObject.<span class="hljs-property">params</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'breed'</span>);
      <span class="hljs-keyword">if</span>(name){
        <span class="hljs-keyword">let</span> baseInfo = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BaseInfo</span>(name)
        baseInfo.<span class="hljs-property">sex</span> = <span class="hljs-title class_">Number</span>(sex)
        baseInfo.<span class="hljs-property">birth</span> = birth
        baseInfo.<span class="hljs-property">breed</span> = breed
        <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'newFriend'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(baseInfo));<span class="hljs-comment">//数据保存起来</span>
        emitter.<span class="hljs-title function_">emit</span>(<span class="hljs-title class_">BaseConstants</span>.<span class="hljs-property">NEW_FRIEND</span>) <span class="hljs-comment">//通知有新朋友数据</span>
      }
    }
  }
  ...
</code></pre>
<p>为啥俩生命周期都要解析？简单说：App冷启动（第一次打开）走onCreate()，如果App已经开着，Deeplink拉它就只走onNewWant()。俩都处理，不管App是开是关，都能稳稳接住好友数据，主打一个“不漏网之鱼”！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0fd2ead4fdad4dada02abd33240ea74a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5Zad5rC05Lya5ri0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770034436&amp;x-signature=JcsAE%2BpXSKoRvoaZILuG2nSglsU%3D" alt="在这里插入图片描述" loading="lazy"/>
<strong>MainPage弹窗选择是否保存好友数据</strong></p>
<p>数据存好了，总得让用户知道吧？在App首页MainPage.ets里监听好友数据，只要有新数据，就弹个窗让用户选“加好友”还是“拒绝”，体验直接拉满：</p>
<pre><code class="hljs language-javascript" lang="javascript"> onNewFriend = <span class="hljs-function">()=&gt;</span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'newFriend'</span>) != <span class="hljs-literal">undefined</span>){
      <span class="hljs-keyword">let</span> newFriend = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'newFriend'</span>)!!) <span class="hljs-keyword">as</span> <span class="hljs-title class_">BaseInfo</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'testTag'</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(newFriend))
      <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">'newFriend'</span>,  <span class="hljs-literal">undefined</span>)
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">friendDialog</span> = <span class="hljs-title class_">DialogHub</span>.<span class="hljs-title function_">getCustomDialog</span>()<span class="hljs-comment">//好友数据弹窗可以选择接受或者拒绝</span>
        .<span class="hljs-title function_">setOperableContent</span>(<span class="hljs-title function_">wrapBuilder</span>(<span class="hljs-title class_">NewFriendDialogBuilder</span>), <span class="hljs-function">(<span class="hljs-params">action: DialogAction</span>) =&gt;</span> {
          <span class="hljs-keyword">let</span> para = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PetDialogParams</span>(newFriend, action, <span class="hljs-variable language_">this</span>.<span class="hljs-property">promptAction</span>,  <span class="hljs-number">0</span>);
          <span class="hljs-keyword">return</span> para;
        })
        .<span class="hljs-title function_">setConfig</span>({ <span class="hljs-attr">dialogBehavior</span>: { <span class="hljs-attr">isModal</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">autoDismiss</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">passThroughGesture</span>: <span class="hljs-literal">false</span> } })
        .<span class="hljs-title function_">setAnimation</span>({ <span class="hljs-attr">dialogAnimation</span>: <span class="hljs-title class_">AnimationType</span>.<span class="hljs-property">BOTTOM_UP</span> })
        .<span class="hljs-title function_">setStyle</span>({
          <span class="hljs-attr">radius</span>: <span class="hljs-number">32</span>,
          <span class="hljs-attr">backgroundColor</span>: <span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>,
          <span class="hljs-attr">maskBackgroundEffect</span>: { <span class="hljs-attr">blurOptions</span>: { <span class="hljs-attr">grayscale</span>: [<span class="hljs-number">50</span>, <span class="hljs-number">50</span>] }, <span class="hljs-attr">radius</span>: <span class="hljs-number">10</span> }
        })
        .<span class="hljs-title function_">build</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">friendDialog</span>.<span class="hljs-title function_">show</span>();
    }
  }

 <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt; {
    emitter.<span class="hljs-title function_">on</span>(<span class="hljs-title class_">BaseConstants</span>.<span class="hljs-property">NEW_FRIEND</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">onNewFriend</span>) <span class="hljs-comment">//注册好友申请的监听</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onNewFriend</span>()
    ...
 }
 ...
 <span class="hljs-title function_">aboutToDisappear</span>(): <span class="hljs-keyword">void</span> {
    emitter.<span class="hljs-title function_">off</span>(<span class="hljs-title class_">BaseConstants</span>.<span class="hljs-property">NEW_FRIEND</span>.<span class="hljs-property">eventId</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">onNewFriend</span>)
  }
</code></pre>
<p>App启动后打开MainPage，先注册好友申请监听，确保主页在的时候能实时收到通知；然后立刻检查有没有待处理的好友数据，有就弹窗，不让用户等，主打一个“贴心”！</p>
<h4 data-id="heading-6">碰一碰发送端处理</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c00d7bbdcdc46469b8eec4533e73c24~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5Zad5rC05Lya5ri0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770034436&amp;x-signature=yNm60DKyo5yDjCxryF7tGyTK8SU%3D" alt="宠物信息界面设置碰一碰监听" loading="lazy"/>
<strong>宠物信息界面设置碰一碰监听</strong>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4fbdbc6ffdd44e7b1e1f0c104cc7deb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5Zad5rC05Lya5ri0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770034436&amp;x-signature=6v5bsQRkvIl4b3LXFDUwLeW5SRg%3D" alt="碰一碰后触发的分享界面" loading="lazy"/>
<strong>碰一碰后触发的分享界面</strong></p>
<p>最后一步，让碰一碰“活”起来！在宠物信息界面注册碰一碰监听，只要检测到两台手机贴贴，就把当前宠物的信息打包进Deeplink，注意要和前面moudule.json5中定义的<strong>scheme和host</strong>要匹配， 对方接住后就能按上面的流程处理好友申请了：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">showID</span>(<span class="hljs-params">info: BaseInfo, index: number = <span class="hljs-number">0</span></span>) {
    harmonyShare.<span class="hljs-title function_">on</span>(<span class="hljs-string">'knockShare'</span>, <span class="hljs-function">(<span class="hljs-params">sharableTarget: harmonyShare.SharableTarget</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> filePath = info.<span class="hljs-property">icon</span>; <span class="hljs-comment">// 仅为示例 请替换正确的文件路径</span>
      <span class="hljs-keyword">let</span> <span class="hljs-attr">shareData</span>: systemShare.<span class="hljs-property">SharedData</span> = <span class="hljs-keyword">new</span> systemShare.<span class="hljs-title class_">SharedData</span>({
        <span class="hljs-attr">utd</span>: utd.<span class="hljs-property">UniformDataType</span>.<span class="hljs-property">HYPERLINK</span>,
        <span class="hljs-attr">content</span>: <span class="hljs-string">`catIsland://catIsland.sx.com/share/?name=<span class="hljs-subst">${info.name}</span>&amp;sex=<span class="hljs-subst">${info.sex}</span>&amp;birth=<span class="hljs-subst">${info.birth}</span>&amp;breed=<span class="hljs-subst">${info.breed}</span>`</span>,
        <span class="hljs-comment">// 根据title,description,thumbnailUri会生成不同的卡片模板。</span>
        <span class="hljs-attr">thumbnailUri</span>: fileUri.<span class="hljs-title function_">getUriFromPath</span>(filePath),
        <span class="hljs-attr">title</span>: <span class="hljs-string">`分享<span class="hljs-subst">${info.name}</span>给好友`</span>,
        <span class="hljs-attr">description</span>: <span class="hljs-string">'碰一碰即可将宠物信息分享给好友'</span>
      });
      sharableTarget.<span class="hljs-title function_">share</span>(shareData);
    });

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">IDDialog</span> = <span class="hljs-title class_">DialogHub</span>.<span class="hljs-title function_">getCustomDialog</span>()
      .<span class="hljs-title function_">setOperableContent</span>(<span class="hljs-title function_">wrapBuilder</span>(<span class="hljs-title class_">PetIDDialogBuilder</span>), <span class="hljs-function">(<span class="hljs-params">action: DialogAction</span>) =&gt;</span> {
        <span class="hljs-keyword">let</span> para = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PetDialogParams</span>(info, action, <span class="hljs-variable language_">this</span>.<span class="hljs-property">promptAction</span>,  index);
        <span class="hljs-keyword">return</span> para;
      })
      .<span class="hljs-title function_">setConfig</span>({ <span class="hljs-attr">dialogBehavior</span>: { <span class="hljs-attr">isModal</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">autoDismiss</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">passThroughGesture</span>: <span class="hljs-literal">false</span> } })
      .<span class="hljs-title function_">setAnimation</span>({ <span class="hljs-attr">dialogAnimation</span>: <span class="hljs-title class_">AnimationType</span>.<span class="hljs-property">BOTTOM_UP</span> })
      .<span class="hljs-title function_">setStyle</span>({
        <span class="hljs-attr">radius</span>: <span class="hljs-number">32</span>,
        <span class="hljs-attr">backgroundColor</span>: <span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>,
        <span class="hljs-attr">maskBackgroundEffect</span>: { <span class="hljs-attr">blurOptions</span>: { <span class="hljs-attr">grayscale</span>: [<span class="hljs-number">50</span>, <span class="hljs-number">50</span>] }, <span class="hljs-attr">radius</span>: <span class="hljs-number">10</span> }
      })
      .<span class="hljs-title function_">build</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">IDDialog</span>.<span class="hljs-title function_">show</span>();
  }
}
</code></pre>
<p>这里踩个坑提醒各位老铁：博主最开始傻乎乎跟着官方新API写，用了6.0.0(20)新增的带capability参数的on方法，结果发现5.0版本的设备直接不兼容，主打一个“新是新，用不了”！最后只能乖乖换回5.0.0(12)的低版本API（不用传capability）。大家用的时候可别踩这个坑——新API虽香，但得看你的用户设备支不支持啊！</p>
<pre><code class="hljs language-javascript" lang="javascript">	<span class="hljs-comment">//注册设备轻贴的事件监听。</span>
	<span class="hljs-comment">//起始版本：6.0.0(20)</span>
	<span class="hljs-title function_">on</span>(<span class="hljs-attr">event</span>: <span class="hljs-string">'knockShare'</span>, <span class="hljs-attr">capability</span>: <span class="hljs-title class_">SendCapabilityRegistry</span>, <span class="hljs-attr">callback</span>: <span class="hljs-title class_">Callback</span>&lt;<span class="hljs-title class_">SharableTarget</span>&gt;): <span class="hljs-keyword">void</span>
	<span class="hljs-comment">//起始版本：5.0.0(12)</span>
	<span class="hljs-title function_">on</span>(<span class="hljs-attr">event</span>: <span class="hljs-string">'knockShare'</span>, <span class="hljs-attr">callback</span>: <span class="hljs-title class_">Callback</span>&lt;<span class="hljs-title class_">SharableTarget</span>&gt;): <span class="hljs-keyword">void</span>
</code></pre>
<p>实际效果演示可自行下载APP碰一碰试一试： <a href="https://link.juejin.cn?target=https%3A%2F%2Fappgallery.huawei.com%2Fapp%2Fdetail%3Fid%3Dcom.sx.catIsland%26channelId%3DSHARE%26source%3Dappshare" target="_blank" title="https://appgallery.huawei.com/app/detail?id=com.sx.catIsland&amp;channelId=SHARE&amp;source=appshare" ref="nofollow noopener noreferrer">喵屿下载链接</a></p>
<h3 data-id="heading-7">总结</h3>
<p>怎么样，是不是发现鸿蒙碰一碰加好友功能一点都不复杂？从配置Deeplink让链接精准跳自家App，到解析冷/热启动的参数不漏数据，再到监听碰一碰事件分享好友信息，一套流程走下来，你的App也能拥有“贴贴加好友”的神仙能力！</p>
<p>相比传统的扫码、输码加好友，碰一碰直接把操作简化到“贴一下”，用户体验直接拉满。而且整个开发过程几乎不用造轮子，依托鸿蒙Share Kit就能搞定，唯一要注意的就是API版本兼容问题，别像博主一样踩坑就行。</p>
<p>现在就把这些代码搬去你的项目里试试吧，不管是做宠物社交、熟人社交还是其他场景，碰一碰加好友都能让你的App多一个“让人眼前一亮”的小功能。要是开发过程中踩了啥新坑，或者有更酷的玩法，评论区唠唠～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>